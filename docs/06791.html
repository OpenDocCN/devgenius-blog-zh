<html>
<head>
<title>How to enable replica set in embedded mongo with Spring Boot</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用 Spring Boot 在嵌入式 mongo 中启用副本集</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/how-to-enable-replica-set-in-embbedded-mongo-with-spring-boot-ddeaa079c1c8?source=collection_archive---------0-----------------------#2022-02-04">https://blog.devgenius.io/how-to-enable-replica-set-in-embbedded-mongo-with-spring-boot-ddeaa079c1c8?source=collection_archive---------0-----------------------#2022-02-04</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="eed1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果您有一个使用 MongoDb 数据库事务的应用程序，那么您需要一个 MongoDb 副本集来运行它。当您为使用嵌入式 mongo 的应用程序编写单元测试时，问题就来了，因为 spring boot 不配置嵌入式 mongo 来启动开箱即用的副本集。如果我们运行测试，我们会得到以下错误:</p><pre class="ki kj kk kl gt km kn ko kp aw kq bi"><span id="7ae3" class="kr ks in kn b gy kt ku l kv kw">com.mongodb.MongoClientException: Sessions are not supported by the MongoDB cluster to which this client is connected</span></pre><p id="ee57" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我去过那里，花了几天时间试图为几个生产应用程序解决这个问题。阅读这篇文章，了解如何轻松解决这个问题。</p><p id="198d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">一个演示项目可以在我的<a class="ae kx" href="https://github.com/divyanshshekhar/springboot-embedded-mongo-replset-demo" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到。</p><p id="10ac" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果你觉得这个教程有帮助，请跟我来。</p></div><div class="ab cl ky kz hr la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ig ih ii ij ik"><h1 id="7980" class="lf ks in bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated"><strong class="ak">Tl；博士</strong></h1><h2 id="bc42" class="kr ks in bd lg mc md dn lk me mf dp lo jv mg mh ls jz mi mj lw kd mk ml ma mm bi translated">1.以 MB 为单位定义副本集名称和操作日志大小</h2><p id="7579" class="pw-post-body-paragraph jk jl in jm b jn mn jp jq jr mo jt ju jv mp jx jy jz mq kb kc kd mr kf kg kh ig bi translated">在您的<em class="ms">测试/资源</em>目录中定义一个<em class="ms">应用程序.属性</em>文件，并添加以下属性:</p><pre class="ki kj kk kl gt km kn ko kp aw kq bi"><span id="1810" class="kr ks in kn b gy kt ku l kv kw"><em class="ms">spring.mongodb.embedded.storage.repl-set-name: “rs0”<br/>spring.mongodb.embedded.storage.oplog: 10<br/>spring.mongodb.embedded.version: "5.0.5"</em></span></pre><p id="a048" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">您可以使用任何您喜欢的 MongoDB 版本，但它应该高于 4.4，否则将需要额外的配置。如果您想使用最新的 mongodb 版本，请将您的嵌入式 mongo 库和 spring boot 升级到最新版本。</p><h2 id="a9ab" class="kr ks in bd lg mc md dn lk me mf dp lo jv mg mh ls jz mi mj lw kd mk ml ma mm bi translated">2.定义自定义 MongodConfig bean 以启用日志记录</h2><p id="d2d6" class="pw-post-body-paragraph jk jl in jm b jn mn jp jq jr mo jt ju jv mp jx jy jz mq kb kc kd mr kf kg kh ig bi translated">我们需要定义自己的<code class="fe mt mu mv kn b">MongodConfig </code> bean 来在嵌入式 mongo 实例中启用日志功能。添加以下配置类来覆盖默认的 MongodConfig:</p><figure class="ki kj kk kl gt mw"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="c6a6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">可以看到，大部分代码都是抄袭 Spring Boot 的<code class="fe mt mu mv kn b"><em class="ms">EmbeddedMongoAutoConfiguration.java</em></code> <em class="ms">。</em>只有以下方法被重写，以便在启动 mongod 进程时启用日志选项。</p><pre class="ki kj kk kl gt km kn ko kp aw kq bi"><span id="358b" class="kr ks in kn b gy kt ku l kv kw">public MongodConfig embeddedMongoConfiguration(EmbeddedMongoProperties embeddedProperties)</span></pre><h2 id="5686" class="kr ks in bd lg mc md dn lk me mf dp lo jv mg mh ls jz mi mj lw kd mk ml ma mm bi translated">3.Mongod 进程启动后启动副本集</h2><p id="d712" class="pw-post-body-paragraph jk jl in jm b jn mn jp jq jr mo jt ju jv mp jx jy jz mq kb kc kd mr kf kg kh ig bi translated">我们需要在 mongod 进程启动后启动副本集。为此，将以下内容添加到单元测试配置类中。如果您还没有单元测试的配置类，请定义一个新的。</p><figure class="ki kj kk kl gt mw"><div class="bz fp l di"><div class="mx my l"/></div></figure></div><div class="ab cl ky kz hr la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ig ih ii ij ik"><h1 id="8616" class="lf ks in bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">完整的解释</h1><p id="c7e5" class="pw-post-body-paragraph jk jl in jm b jn mn jp jq jr mo jt ju jv mp jx jy jz mq kb kc kd mr kf kg kh ig bi translated">Spring Boot 的自动配置提供了一种通过定义以下属性来定义副本集名称和操作日志大小的方法:</p><pre class="ki kj kk kl gt km kn ko kp aw kq bi"><span id="857b" class="kr ks in kn b gy kt ku l kv kw"><em class="ms">spring.mongodb.embedded.storage.repl-set-name: “rs0”<br/>spring.mongodb.embedded.storage.oplog: 10</em></span></pre><p id="7768" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">还可以通过定义以下属性来定义您想要使用的 mongodb 版本:</p><pre class="ki kj kk kl gt km kn ko kp aw kq bi"><span id="1d79" class="kr ks in kn b gy kt ku l kv kw"><em class="ms">spring.mongodb.embedded.version: "5.0.5"</em></span></pre><p id="c099" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">您可以使用嵌入式 mongo 实现支持的任何 mongodb 版本，但是要确保它高于 4.4，否则需要更多的配置来设置副本集。</p><p id="0488" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我用的是 flapdoodle 的嵌入式 mongo 的(<a class="ae kx" href="https://mvnrepository.com/artifact/de.flapdoodle.embed/de.flapdoodle.embed.mongo" rel="noopener ugc nofollow" target="_blank">链接</a>)版本 3.3.1 和 Spring Boot 2.6.3。对于 flapdoodle，可以在以下文件中找到支持的版本列表:</p><pre class="ki kj kk kl gt km kn ko kp aw kq bi"><span id="6319" class="kr ks in kn b gy kt ku l kv kw">de.flapdoodle.embed.process.distribution.Version</span></pre><h2 id="e3c3" class="kr ks in bd lg mc md dn lk me mf dp lo jv mg mh ls jz mi mj lw kd mk ml ma mm bi translated">问题#1:默认情况下，日志功能是禁用的</h2><p id="cf77" class="pw-post-body-paragraph jk jl in jm b jn mn jp jq jr mo jt ju jv mp jx jy jz mq kb kc kd mr kf kg kh ig bi translated">当提供上述属性时，Spring Boot 的嵌入式 mongo 自动配置启用副本集，但不启用日志功能(必须启用日志功能副本集才能工作)，并且不提供直接的方法来这样做。因此，当我们运行测试时，它在启动嵌入式 mongod 进程时失败，并出现以下错误:</p><pre class="ki kj kk kl gt km kn ko kp aw kq bi"><span id="520d" class="kr ks in kn b gy kt ku l kv kw">Running wiredTiger without journaling in a replica set is not supported. Make sure you are not using — nojournal and that storage.journal.enabled is not set to ‘false’</span></pre><p id="55d4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这就是为什么我们需要定义我们自己的 MongodConfig bean，并确保它在<code class="fe mt mu mv kn b"><em class="ms">EmbeddedMongoAutoConfiguration </em></code>类启动嵌入式 mongod 进程之前得到定义。你可以找到上面定义的配置类(<code class="fe mt mu mv kn b">EmbeddedMongoConfigOverride</code>)，或者在<a class="ae kx" href="https://github.com/divyanshshekhar/springboot-embedded-mongo-replset-demo" rel="noopener ugc nofollow" target="_blank"> Github </a>的完整代码中。</p><h2 id="b064" class="kr ks in bd lg mc md dn lk me mf dp lo jv mg mh ls jz mi mj lw kd mk ml ma mm bi translated">问题 mongod 启动后需要初始化副本集</h2><p id="680b" class="pw-post-body-paragraph jk jl in jm b jn mn jp jq jr mo jt ju jv mp jx jy jz mq kb kc kd mr kf kg kh ig bi translated">现在，在 mongod 进程/节点使用副本集选项启动后，需要再次配置它来初始化副本集。为此，我们需要连接到我们的嵌入式单节点集群，并在<em class="ms">管理</em>数据库上运行<code class="fe mt mu mv kn b"><em class="ms">replSetInitiate </em></code>命令。为此，我在我的<code class="fe mt mu mv kn b"><em class="ms">UnitTestsConfig </em></code>类中添加了以下方法，以便在配置类初始化并且<code class="fe mt mu mv kn b"><em class="ms">mongoClient </em></code> bean 可用后自动运行。此方法启动 replicaset 并等待初始化完成，以便在它完全准备好之前不会触发任何查询。</p><figure class="ki kj kk kl gt mw"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="a76d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><code class="fe mt mu mv kn b"><em class="ms">isReplicaSetReady</em></code>方法定义如下，用于检查副本集是否完全初始化:</p><figure class="ki kj kk kl gt mw"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="a0a6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这就是您需要做的所有配置。现在，您可以愉快地在使用事务的方法上运行所有的单元测试了。检查我的 Github 项目的完整实现。</p><h1 id="0407" class="lf ks in bd lg lh mz lj lk ll na ln lo lp nb lr ls lt nc lv lw lx nd lz ma mb bi translated">演示项目</h1><p id="e85f" class="pw-post-body-paragraph jk jl in jm b jn mn jp jq jr mo jt ju jv mp jx jy jz mq kb kc kd mr kf kg kh ig bi translated">这个项目可以在我的 Github 上找到，网址是<a class="ae kx" href="https://github.com/divyanshshekhar/springboot-embedded-mongo-replset-demo" rel="noopener ugc nofollow" target="_blank">https://Github . com/divyanshekhar/spring boot-embedded-mongo-repl set-demo</a></p><p id="3cd4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">源代码应该容易理解。在需要的地方提供了必要的注释。git 提交被标记，这样您就可以跳转到实现的各个阶段，如上所述。git 标签按以下顺序排列:</p><ol class=""><li id="09fc" class="ne nf in jm b jn jo jr js jv ng jz nh kd ni kh nj nk nl nm bi translated"><strong class="jm io">带测试的基本服务</strong>:不使用 mongo 事务的基本服务实现(带 Junit 测试)。</li><li id="442c" class="ne nf in jm b jn nn jr no jv np jz nq kd nr kh nj nk nl nm bi translated"><strong class="jm io">mongo-txn-with-failed-tests</strong>:在服务中启用了 mongo 事务，但是现在由于在嵌入式 mongo 中缺少副本集，测试用例失败了</li><li id="cf90" class="ne nf in jm b jn nn jr no jv np jz nq kd nr kh nj nk nl nm bi translated"><strong class="jm io">没有日志记录的副本集</strong>:使用 spring 属性启用了副本集，但没有启用日志记录</li><li id="f64c" class="ne nf in jm b jn nn jr no jv np jz nq kd nr kh nj nk nl nm bi translated"><strong class="jm io">带日志功能的副本集</strong>:定义自定义<code class="fe mt mu mv kn b">MongodConfig</code>以启用日志功能</li><li id="ff9e" class="ne nf in jm b jn nn jr no jv np jz nq kd nr kh nj nk nl nm bi translated"><strong class="jm io">repl-set-initiate-and-wait-for-ready</strong>:在<code class="fe mt mu mv kn b">UnitTestConfig</code>中定义的方法，用于初始化副本集并等待它准备就绪</li><li id="1e24" class="ne nf in jm b jn nn jr no jv np jz nq kd nr kh nj nk nl nm bi translated"><strong class="jm io">清除不必要的代码</strong>:清除不必要的<code class="fe mt mu mv kn b">@AutoConfigureBefore</code>和日志级别后的项目最终版本。</li></ol></div></div>    
</body>
</html>