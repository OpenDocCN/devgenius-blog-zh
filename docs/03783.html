<html>
<head>
<title>Polymorphic plugins with proper architecting</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">具有适当架构的多态插件</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/polymorphic-plugins-with-proper-architecting-97239f19e428?source=collection_archive---------4-----------------------#2020-12-15">https://blog.devgenius.io/polymorphic-plugins-with-proper-architecting-97239f19e428?source=collection_archive---------4-----------------------#2020-12-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/5135d0a56a652ab3a0e4a4f6c1f26716.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*tymcDBAE19DyoCEe"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">由<a class="ae kc" href="https://unsplash.com/@lucabravo?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">卢卡·布拉沃</a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</figcaption></figure><p id="f741" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我喜欢 DVD。我知道，现在一切都数字化了，但我还是喜欢 DVD。为什么？因为我拥有很多视频游戏系统，当我想看 DVD 时，我所要做的就是把它插入其中一个系统，然后打开它。</p><p id="442e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它<em class="lb">刚刚工作。</em></p><p id="ed63" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为什么我们的插件不工作？为什么我需要下载一个不同的文件在 WordPress 上加载一个插件，而不是在 Joomla 上加载一个插件？还是 Drupal？如果我想在自己的网站上使用插件代码，但是我没有使用 CMS，该怎么办？</p><h2 id="e101" class="lc ld iq bd le lf lg dn lh li lj dp lk ko ll lm ln ks lo lp lq kw lr ls lt lu bi translated">“但是，特拉维斯，那是不可能的。那是完全不同的系统！”</h2><p id="8945" class="pw-post-body-paragraph kd ke iq kf b kg lv ki kj kk lw km kn ko lx kq kr ks ly ku kv kw lz ky kz la ij bi translated">是吗？</p><p id="8dbd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我不仅要说这不是不可能的，我还要证明给你看。当然，这并不容易，但是这是可行的，而且总体来说会产生更好的代码。</p><h1 id="5d6c" class="ma ld iq bd le mb mc md lh me mf mg lk mh mi mj ln mk ml mm lq mn mo mp lt mq bi translated">输入“你好，多莉”</h1><p id="a14b" class="pw-post-body-paragraph kd ke iq kf b kg lv ki kj kk lw km kn ko lx kq kr ks ly ku kv kw lz ky kz la ij bi translated">对于任何使用 WordPress 的人来说，Hello Dolly 是最容易识别的插件。这主要是因为它预装了 WordPress。</p><p id="547c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">客观地说，它也写得不好。当然没必要这样。插件本身只有几行，是安装最多的插件，也是卸载最多的插件。我没有数字来支持这种说法，我只是假设这是真的。</p><p id="d2d7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我不是来找你好多莉的茬的。马特·莫楞威格已经证明了自己是一个有能力的开发人员，所以我们不会侮辱他的技能，这不是本文的重点。</p><p id="57a1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">重点是:我把 Hello Dolly 改写成了多态插件。</p><h1 id="82c1" class="ma ld iq bd le mb mc md lh me mf mg lk mh mi mj ln mk ml mm lq mn mo mp lt mq bi translated">现在说什么？</h1><p id="1675" class="pw-post-body-paragraph kd ke iq kf b kg lv ki kj kk lw km kn ko lx kq kr ks ly ku kv kw lz ky kz la ij bi translated">你可以从我的 Hello Dolly (Redux)插件中取出 zip 文件，直接上传到 WordPress 和 Joomla！它会立即生效。开箱即用。Joomla 有一些设置步骤，但这只是 Joomla 的工作方式。</p><p id="f3f3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先，我们来看看原来的 Hello Dolly 插件。</p><figure class="mr ms mt mu gt jr"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="2fbb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">简单，100 行代码，3 个函数。我们将讨论一些问题，但是这个插件非常适合它的本来面目:一个预装的 WordPress 插件。</p><h1 id="e7c5" class="ma ld iq bd le mb mc md lh me mf mg lk mh mi mj ln mk ml mm lq mn mo mp lt mq bi translated">我们来分解一下</h1><p id="647e" class="pw-post-body-paragraph kd ke iq kf b kg lv ki kj kk lw km kn ko lx kq kr ks ly ku kv kw lz ky kz la ij bi translated">你在这个插件中注意到的第一件事是什么？对我来说，是 Hello Dolly 插件和 WordPress 核心之间的强耦合。这个插件立即知道它是一个 WordPress 插件，因为要运行它必须访问<code class="fe mx my mz na b">add_action</code>函数。</p><p id="c616" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">事实上，有四种不同的 WordPress 核心功能，add_action 是其中侵入性最小的。你能找到他们吗？在进一步阅读之前先看一看。</p><p id="5287" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你找到他们了吗？</p><p id="21c4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果没有，别担心，我会把它们列在这里:</p><ol class=""><li id="e79f" class="nb nc iq kf b kg kh kk kl ko nd ks ne kw nf la ng nh ni nj bi translated">添加 _ 操作</li><li id="6a5e" class="nb nc iq kf b kg nk kk nl ko nm ks nn kw no la ng nh ni nj bi translated">wptexturize</li><li id="5a53" class="nb nc iq kf b kg nk kk nl ko nm ks nn kw no la ng nh ni nj bi translated">获取 _ 用户 _ 区域设置</li><li id="1573" class="nb nc iq kf b kg nk kk nl ko nm ks nn kw no la ng nh ni nj bi">__</li></ol><p id="017e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">第四种可能是最难找到的。我第一次看代码的时候就错过了。</p><h1 id="e2d2" class="ma ld iq bd le mb mc md lh me mf mg lk mh mi mj ln mk ml mm lq mn mo mp lt mq bi translated">让我们退后一秒钟</h1><p id="8f1b" class="pw-post-body-paragraph kd ke iq kf b kg lv ki kj kk lw km kn ko lx kq kr ks ly ku kv kw lz ky kz la ij bi translated">什么甚至是<em class="lb"/>是一个多态插件？好吧，如果你之前没有收集它，我将在这里清楚地定义它:多态性是一个事物采取许多形式的能力。在面向对象编程中，我们用它来描述能够被当作其他类对待的类。</p><p id="367e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这个例子中，我使用多态来描述一个插件如何被多个内容管理系统使用。在这种情况下，它不是真正的多态性，因为必须添加一些方法才能使它工作，但是，我喜欢这个名字。</p><p id="4eb2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">告我吧。</p><h1 id="cfa3" class="ma ld iq bd le mb mc md lh me mf mg lk mh mi mj ln mk ml mm lq mn mo mp lt mq bi translated">回到重构！</h1><p id="c2b5" class="pw-post-body-paragraph kd ke iq kf b kg lv ki kj kk lw km kn ko lx kq kr ks ly ku kv kw lz ky kz la ij bi translated">我们需要做的第一件事是清理这些代码。首先，我们将函数转换成一个类，并给这个类命名空间 HelloDolly。</p><p id="670a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，真的没有必要把多行字符串转换成数组，只是为了得到一个随机的行。因此，我们将该文本块转换为一个数组，删除转换行，并使用<code class="fe mx my mz na b">array_rand</code>更新随机选择。</p><p id="4bd1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这仍然给我们留下了所有内置的 WordPress 核心功能，现在已经坏了。</p><p id="6b1d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们要做的是使用<a class="ae kc" href="https://en.wikipedia.org/wiki/Dependency_injection" rel="noopener ugc nofollow" target="_blank">依赖注入</a>来传递两个<a class="ae kc" href="https://www.php.net/manual/en/functions.anonymous.php" rel="noopener ugc nofollow" target="_blank">匿名函数</a>，它们将接受相同的参数，并运行 WordPress 核心函数。</p><p id="dd0d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所有这些函数都被转移到一个<code class="fe mx my mz na b">wp-loader.php</code>文件中，包括插件头注释，告诉 WordPress 哪个文件是插件的入口点。</p><p id="3228" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">完成后，我们的 hello.php 文件将如下所示:</p><figure class="mr ms mt mu gt jr"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="d4f5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="lb">注:现在来看，我真的应该用一个</em> <a class="ae kc" href="https://www.php.net/manual/en/class.closure.php" rel="noopener ugc nofollow" target="_blank"> <em class="lb">闭包</em> </a> <em class="lb">来代替两个匿名函数。使用闭包可以避免将匿名函数传递给局部变量来调用它们。</em></p><p id="9e3b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">既然我们已经将核心的 WordPress 方法分离出来，它们需要放在某个地方。那就是<code class="fe mx my mz na b">wp-loader.php</code>，看起来是这样的:</p><figure class="mr ms mt mu gt jr"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="cebd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先，我们检查以确保我们正在 WordPress 内部运行。常数<code class="fe mx my mz na b">WPINC</code>总是在 WordPress 中定义，所以这是一个很好的代理。</p><p id="27c8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在那里，我们创建我们的匿名函数，这些函数本质上是 WordPress 核心函数的代理，并将它们传递给新的 HelloDolly 类。</p><p id="d763" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">从那里，我们将 Hello Dolly 类作为参数传递给一个新的 WordPress DisplayDriver 类，并调用 register 方法。</p><p id="c6eb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">该类如下所示:</p><figure class="mr ms mt mu gt jr"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="0503" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="lb">注意:为了保持代码尽可能的独立，我避免使用 Composer 或自动加载。你可以很容易地添加一个自动加载程序，但是，摆脱所需的调用。</em></p><p id="73fe" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我并不真的需要在这里构建<code class="fe mx my mz na b">printProxy</code>方法，但是我想展示如何使用代理方法来调用需要更多参数的方法。</p><p id="e750" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这两个插件在功能上是相同的。所以何必呢？</p><p id="10e9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">嗯，这就是我们使插件多态的地方。</p><h1 id="2c38" class="ma ld iq bd le mb mc md lh me mf mg lk mh mi mj ln mk ml mm lq mn mo mp lt mq bi translated">准备 Joomla！</h1><p id="de3e" class="pw-post-body-paragraph kd ke iq kf b kg lv ki kj kk lw km kn ko lx kq kr ks ly ku kv kw lz ky kz la ij bi translated">在这个项目之前，我甚至从未安装过 Joomla，更不用说为它编写模块了。这就是为什么我花了整整 15 分钟的开发时间来编写这个 Joomla 模块。</p><p id="38cf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于 Joomla 模块，我们需要三样东西:</p><ol class=""><li id="5751" class="nb nc iq kf b kg kh kk kl ko nd ks ne kw nf la ng nh ni nj bi translated">模块 XML 配置文件</li><li id="cd9d" class="nb nc iq kf b kg nk kk nl ko nm ks nn kw no la ng nh ni nj bi translated">模块入口文件</li><li id="5a21" class="nb nc iq kf b kg nk kk nl ko nm ks nn kw no la ng nh ni nj bi translated">模板目录/文件</li></ol><p id="4200" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我不确定最后一个是不是必须的，但是在 Joomla 网站的教程里用过，所以我在这里用了一个。</p><p id="734b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先，XML 文件。</p><figure class="mr ms mt mu gt jr"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="6e06" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我不会试图解释每一项的确切含义，但我会指出文件块。这些文件中的每一个都需要准确地命名它在那里的位置。</p><p id="8b7c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们已经讨论了我们的核心插件代码，这里没有改变，所以让我们看看 mod_hellodolly.php 文件。</p><p id="aabd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是我们的 Joomla！相当于 wp-loader.php 文件。</p><figure class="mr ms mt mu gt jr"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="459f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">幸运的是，Joomla 有一个常量用来定义模块何时在 Joomla 内部直接运行。所以我们在这里使用它，其他的看起来几乎一样。</p><p id="696a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">唯一的区别是第 16 行，这里我们使用<code class="fe mx my mz na b">JModuleHelper::getLayoutPath</code>来加载默认布局到我们的<code class="fe mx my mz na b">tmpl</code>文件夹中。</p><p id="2ce6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">那个文件在这里<em class="lb">真的</em>没有必要。我们可以很容易地直接回显代码，但我想模拟一个完整的模块。</p><figure class="mr ms mt mu gt jr"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="42de" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如你所见，这里没什么事情。只需打印 CSS 和格式化的歌词，就大功告成了。</p><h1 id="ba8e" class="ma ld iq bd le mb mc md lh me mf mg lk mh mi mj ln mk ml mm lq mn mo mp lt mq bi translated">我们结束了</h1><p id="318d" class="pw-post-body-paragraph kd ke iq kf b kg lv ki kj kk lw km kn ko lx kq kr ks ly ku kv kw lz ky kz la ij bi translated">就是这样。这就是你创建一个插件所需要的一切，这个插件将在 Joomla 中安装这两个插件！还有 WordPress，直接。</p><p id="e650" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在 Joomla 上，如果您在安装后查看安装目录，您会注意到只有您的 XML 中列出的文件被实际保存到磁盘上。这意味着你可以上传带有整个 WordPress 插件的 Zip 文件，它将只安装 Joomla 代码所需的文件。</p><p id="0932" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">WordPress 会安装每个文件，但是不会使用 Joomla 部分。</p><p id="b688" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">尝试一下，看看我的示例库，压缩内容，上传到你的 WordPress 和 Joomla！网站。</p><div class="np nq gp gr nr ns"><a href="https://github.com/anubisthejackle/hello-dolly" rel="noopener  ugc nofollow" target="_blank"><div class="nt ab fo"><div class="nu ab nv cl cj nw"><h2 class="bd ir gy z fp nx fr fs ny fu fw ip bi translated">anubisthejackle/hello-dolly</h2><div class="nz l"><h3 class="bd b gy z fp nx fr fs ny fu fw dk translated">在我的中篇博文 GitHub 中，一个重构版的 Hello Dolly 是超过 5000 万开发者的家园…</h3></div><div class="oa l"><p class="bd b dl z fp nx fr fs ny fu fw dk translated">github.com</p></div></div><div class="ob l"><div class="oc l od oe of ob og jw ns"/></div></div></a></div><p id="5221" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当你完成后，继续创建多态插件。</p><p id="7639" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后<a class="ae kc" href="https://twitter.com/n00bJackleCity" rel="noopener ugc nofollow" target="_blank">在推特上给我打电话</a>，这样我就可以查看他们了。</p></div><div class="ab cl oh oi hu oj" role="separator"><span class="ok bw bk ol om on"/><span class="ok bw bk ol om on"/><span class="ok bw bk ol om"/></div><div class="ij ik il im in"><p id="3536" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你对这篇文章感兴趣，你会爱上我的 Twitter 上的技术意识流。 <a class="ae kc" href="https://twitter.com/n00bJackleCity" rel="noopener ugc nofollow" target="_blank"> <em class="lb">头那边，给我跟着</em> </a> <em class="lb">。你不会失望的。</em></p></div></div>    
</body>
</html>