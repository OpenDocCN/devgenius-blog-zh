# 干净代码的艺术——错误处理

> 原文：<https://blog.devgenius.io/art-of-clean-code-error-handling-7951587eac98?source=collection_archive---------2----------------------->

## 惊喜是必然的。尽早恰当地处理这些问题对客户和开发人员都有帮助。

![](img/b15514d1f81643735a11595ec273558d.png)

这是“干净代码的艺术”系列的第二篇文章。参考第一张 [*这里的*](https://medium.com/dev-genius/art-of-clean-code-b921142a05e9) *。*

错误处理是接受意外是不可避免的，并准备好优雅地管理任何意外，尽可能减少对客户的影响。

但是错误处理难道不是我们日常编码的一部分吗？我们使用 try/catch 并抛出错误。让我们试着理解错误处理中更多的是什么。

# 惊喜是不可避免的

早在 2005 年，我的任务是实现一个符合 BPEL 标准的工作流引擎，它可以在不降低性能的情况下同时处理大量请求。考虑高效的内存数据结构、灵活的状态机，最重要的是保持其通用性，以便可以随时扩展以添加更多节点、逻辑和接口，这是一项具有挑战性的任务。

一旦我们添加了“通用”单词，它就使系统的用户变得容易了，然而，代价是增加了系统本身的复杂性。这就是创建通用组件和实用程序的目的，以便将复杂性包含在一个地方。

我做了几个月的研究，实现了 POC，然后在接下来的 6 个月里用数百个测试案例开发了这个系统。工作流引擎已经准备好遵循 BPEL 规范和一个很好的 API。已经编写了数百个测试用例，并且全部成功通过。

我非常兴奋地展示了结果。很快，我就把它呈现给了我们的总建筑师。他全心全意地称赞它。接下来，他给我带来了一台多处理器机器，并要求确保在那上面的测试用例(多处理器机器在当时是一种奢侈品)。

我用新的 beast 运行了测试案例。令我编码生涯中最大的惊喜是，很多测试用例都失败了。我很惊讶，因为测试用例在我花了很多努力来保持实现强大的地方失败了，覆盖了所有我可以主动思考的案例。

我开始调试。我意识到线程的行为与我想象的完全不同。线程的抢占、上下文切换、睡眠时的复杂行为，以及当多个线程在执行器队列中等待轮到时的通知，与我在单处理器机器上测试时所假设的完全不同。

在那次探险中，我面临着一个又一个惊喜。在接下来的几周里，我们集体讨论了所有的错误案例，并修正了所有的边界案例。

在这整个事件中，错误处理、日志和测试用例是集体的救星。然而，错误处理是用正确的上下文信息在正确的点捕获错误的关键。错误处理是意外事件的救星，如果没有在正确的位置用所有正确的上下文信息捕获错误，意外事件可能会复杂得多。

注意错误处理中的“*上下文信息*”。这是错误处理的一个重要方面，收集并转储任何可能的信息，这些信息有助于理解、重新创建并在以后修复错误。如果没有这些信息，理解场景或重现案例可能会非常耗时且令人沮丧。这也会耗费很多精力。

*我们中的许多人可能已经见证了一个又一个补丁的生产。它通常发生在我们无法理解根本原因并试图修复表面错误以越过当前障碍的时候。最终，它消耗了比我们在适当的错误处理上投入的时间更多的时间来捕捉意外情况并记录所有可能的上下文信息以进行有效的修复。*

惊喜是必然的。然而，通过正确的错误处理水平，我们能够在上面的例子中很快找到根本原因。因此，

> 惊喜代码。

在编写代码时，我们可能不知道许多场景，随着系统的发展，会有更多的场景。我们越是接受它，越是为它编码，就越容易**更早地捕捉到惊喜，并利用正确的信息快速解决失败**。

> 正确的错误处理和断言是及时捕捉意外并构建不断发展的弹性系统的关键。

# 优雅地管理惊喜

接受“惊喜是不可避免的”，就是成功了一半。剩下的一半是管理这些，优雅地恢复。这是另一个关于这种经历的故事。

在 2011 年，我们为一个政府组织开发了一个财务管理应用程序。该应用程序的用户是财政部门的政府官员和全国各部门的收款员。用户群是他们领域的专家，但对计算机生态系统来说大多是新手。

每当系统中出现任何错误，用户都会被引导使用“ [Redmine](https://www.redmine.org/) ”开源工具来记录票证。用户尽最大努力记录他们对系统错误和期望的理解，但作为非技术用户，大多数时候信息不完整，无法理解问题。很多时候，用户不习惯于获取所有相关信息并记录问题。

我们试图创建文档和记录问题的步骤，但由于用户群、语言和难以到达的培训区域的多样性，仍然存在许多挑战。

保持系统正常运行的压力很大，因为这可能会影响政府收税和其他付款的时间表。

## 以下是我们为管理它所做的工作

1.  确保每个错误都记录了来自错误代码块的所有可能的上下文信息，包括用户操作、系统状态、预期状态、会话状态的快照以及任何相关的数据库信息等。
2.  确保错误被正确地传播到控制器层，在那里系统可以根据系统状态做出更好的决定来记录或指导用户(大多数情况下使用未检查的异常模型)
3.  为 Redmine 创建了一个插件( [redmine-jconnector](https://github.com/mohitkgupta/redmine-jconnector) )，它可以帮助使用 Redmine rest API 执行问题创建和列表操作。此插件用于在 UI 中添加“报告问题”功能，用户可以简单地点击该功能来报告任何问题(如果没有异常，它将简单地记录所有当前系统状态和用户描述)
4.  当用户点击这个动作来报告错误时，系统在后台使用已经使用上述第 1 点和第 2 点捕获的所有上下文信息，并在 Redmine 中记录用户描述(删除任何敏感信息)作为票证。
5.  这消除了用户收集和记录错误消息、错误代码、系统状态等的依赖性。
6.  开发人员拥有所有正确的用户和系统信息来快速调试问题。修复变得更快。我们能够非常频繁地推出针对任何阻塞问题的修复程序。
7.  我们还增强了屏幕上的错误消息，用当地语言俚语提供了许多以用户为中心的细节，有时甚至建议一些常见情况的解决方法，这可以暂时解除对用户的阻止。例如，偏远地区的互联网连接不好。因此，我们启用了一些连接测试，并向用户提供相关信息来处理这个问题。

错误处理不仅仅是在代码中放入正确的构造来捕获错误，记录错误，用正确的 throwable 包装错误，然后抛出错误。但是还有更多，

*   使用这些信息来恰当地处理故障
*   使用收集到的信息以对用户最有帮助的方式设计系统和用户界面，这样他们可以很容易地理解情况，甚至可以帮助工程团队解决问题。
*   使用此信息向用户呈现失败信息和可能的解决方法，如果可能的话，解除阻止。
*   重要的是，以一种有效的方式向开发人员展示所有相关信息，以便他们能够迅速采取行动解决问题。

调试错误很多时候是有压力的，需要付出很多努力。如果所有相关的系统信息都可用，这将使整个练习变得容易得多。

在上面的例子中，我们甚至在应用程序中启用了一些开发模式。如果启用，可以在屏幕上向开发人员或管理员显示所有系统状态信息。

这意味着任何开发人员或 QA 或产品所有者或经理都可以轻松查看详细信息，而无需深入多个服务器和数据库。任何了解背景的人都可以帮助解决问题，甚至可以提出解决方案。

> 这是让系统用户参与解决方案的最有效方式之一。

这种向团队展示所有正确信息的简单行为为解决问题和快速推出修复带来了倍增效应。

它还有助于让客户了解系统状态，甚至就问题对他们进行教育，这反过来有助于让客户更开心(以及更开心的工程团队)。

# 摘要

我们不包括实现错误处理的技巧，即是否使用检查或未检查的异常、错误代码或扩展异常等。有很多关于这些话题的博客。

然而，为了用户和工程团队的利益，这个故事的重点是强调主动计划的重要性，以很好地管理意外。

最终，错误处理是为了帮助系统的用户，尽可能地保持系统在意外情况下可用，或者至少优雅地处理错误，并向用户提供所有相关信息，以避免受挫。

反过来，它有助于使开发人员的生活也很容易，节省周末和晚上的生产问题。

在软件系统中，意外是不可避免的。接受这一事实并主动为惊喜编码可以给客户体验和产品可用性带来巨大的积极变化。

所以下一次，当你做错误处理的时候，想想‘我怎样才能最好地向用户和工程团队展示所有可能的相关信息’。

> 这种主动(和移情)的行为可以避免很多挫折和更多的问题。

# 然后

参考下面给出的其他文章。

干净代码的艺术。 [这里指](https://medium.com/dev-genius/art-of-clean-code-b921142a05e9)**。**

**干净代码的艺术——文档。这里的* *参见* [*。*](https://medium.com/dev-genius/art-of-clean-code-documentation-177b62a8320)*

**干净代码的艺术——日志。* [*这里指*](https://medium.com/dev-genius/art-of-clean-code-logging-d760b0918603) *。**

**更多系统设计和工程博客。* [这里指](https://medium.com/@matrixexplorer)**。***

***喜欢看这个，请分享，鼓掌，关注类似的故事！***

***如有任何建议，请随时通过****Linkedin****:*[*Mohit Gupta*](https://www.linkedin.com/in/mohitkgupta/)联系我**