<html>
<head>
<title>Elasticsearch in Action: Explanation of the Scores</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">行动中的弹性研究:分数的解释</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/explanation-8-8-3-5f23badf7590?source=collection_archive---------7-----------------------#2022-11-04">https://blog.devgenius.io/explanation-8-8-3-5f23badf7590?source=collection_archive---------7-----------------------#2022-11-04</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div class="gh gi jk"><img src="../Images/95a3991b60dc7d79ed2993deb247df4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*nVXtNoFBzDjIvnz-Use6yg.png"/></div><figcaption class="jr js gj gh gi jt ju bd b be z dk translated">节选自我即将出版的书:弹性搜索在行动</figcaption></figure><p id="4a55" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在接下来的几个月里，我会将这些短小精悍的文章以迷你系列的形式呈现在大家面前。节选自我的书<a class="ae ku" href="https://www.manning.com/books/elasticsearch-in-action-second-edition?utm_source=mkonda&amp;utm_medium=affiliate&amp;utm_campaign=book_konda_elasticsearch_7_23_21&amp;a_aid=mkonda&amp;a_bid=edbc50d4" rel="noopener ugc nofollow" target="_blank"><em class="kt">elastic search in Action，第二版</em> </a> <em class="kt">。代码在我的</em><a class="ae ku" href="https://github.com/madhusudhankonda" rel="noopener ugc nofollow" target="_blank"><em class="kt">GitHub</em></a><em class="kt">库中。您可以在存储库中找到可执行的 Kibana 脚本，这样您就可以直接在 Kibana 中运行命令。所有代码都根据 Elasticsearch 8.4 版本进行了测试。</em></p></div><div class="ab cl kv kw hr kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="ig ih ii ij ik"><p id="902d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">Elasticsearch 提供了一种了解相关性分数构成的机制。这个机制告诉我们引擎是如何计算分数的。这是通过在搜索端点上使用一个<code class="fe lc ld le lf b">explain</code>标志或一个<code class="fe lc ld le lf b">explain</code> API 来实现的。<code class="fe lc ld le lf b">explain</code> API 也用于找出文档与查询匹配或不匹配的原因。在本文中，我们将研究这两种方法，以了解它们的共性和细微差异。</p><h1 id="0fe7" class="lg lh in bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">解释标志</h1><p id="6112" class="pw-post-body-paragraph jv jw in jx b jy me ka kb kc mf ke kf kg mg ki kj kk mh km kn ko mi kq kr ks ig bi translated">您可能已经注意到前面一些查询的结果中有一个正数(相关性得分值)。虽然我们知道该值是由引擎计算和设置的，但我们不知道它是如何计算的。如果我们对计算感到好奇，我们在查询中将<code class="fe lc ld le lf b">explain</code>属性设置为<code class="fe lc ld le lf b">true</code>。然后，Elasticsearch 返回结果，并详细说明它是如何得出这个分数的。换句话说，它为我们提供了一个关于引擎在幕后执行的逻辑和计算的解释。</p><p id="47de" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">下面给出的清单中的查询显示了一个<code class="fe lc ld le lf b">match</code>查询。因为我们想获得分数是如何计算的细节，所以我们将<code class="fe lc ld le lf b">explain</code>设置为<code class="fe lc ld le lf b">true</code>。</p><h2 id="13ac" class="mj lh in bd li mk ml dn lm mm mn dp lq kg mo mp lu kk mq mr ly ko ms mt mc mu bi translated">清单:要求引擎解释分数</h2><pre class="mv mw mx my gt mz lf na nb aw nc bi"><span id="214b" class="mj lh in lf b gy nd ne l nf ng">GET movies/_search<br/>{<br/> <strong class="lf io">"explain": true,<br/> </strong>"_source": false,<br/>  "query": {<br/>   "match": {<br/>    "title": "Lord"<br/>  }<br/> }<br/>}</span></pre><p id="7533" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><code class="fe lc ld le lf b">explain</code>属性设置在与查询对象相同的级别。这个查询的结果很有趣，如下图所示。</p><figure class="mv mw mx my gt jo gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/9fd5c37c440d7f6ad9b50df44cf1559b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1040/format:webp/1*oJKcOwmdmJsf74KIDWKDzg.png"/></div><figcaption class="jr js gj gh gi jt ju bd b be z dk translated"><strong class="bd li">图:Elasticsearch 如何计算相关性得分的说明</strong></figcaption></figure><p id="33b9" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如图所示，通过将三个部分相乘来计算相关性分数:逆文档频率(<em class="kt"> idf </em>)、术语频率(<em class="kt"> tf </em>)和提升因子。Elasticsearch 详细介绍了它是如何评估和衡量这些组成部分的。例如，<em class="kt"> idf </em>计算如下</p><pre class="mv mw mx my gt mz lf na nb aw nc bi"><span id="fef6" class="mj lh in lf b gy nd ne l nf ng">log(1 + (N — n + 0.5) / (n + 0.5))</span></pre><p id="fe5f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在哪里</p><ul class=""><li id="b51d" class="ni nj in jx b jy jz kc kd kg nk kk nl ko nm ks nn no np nq bi translated"><em class="kt"> n </em>是包含该术语的文档总数(图中有 3 篇文档包含<em class="kt">主</em>字样)。</li><li id="23cc" class="ni nj in jx b jy nr kc ns kg nt kk nu ko nv ks nn no np nq bi translated"><em class="kt"> N </em>是文档的总数(上面给出的数字显示了我们的索引中的 25 个文档)。</li></ul><p id="15ae" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">你可以通过查看返回响应中的描述字段来了解<em class="kt"> idf </em>是由什么组成的(见上图)。</p><p id="b185" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">类似地，术语频率(<em class="kt"> tf </em>)使用以下公式计算</p><pre class="mv mw mx my gt mz lf na nb aw nc bi"><span id="b778" class="mj lh in lf b gy nd ne l nf ng">freq / (freq + k1 * (1 — b + b * dl / avgdl))</span></pre><p id="9650" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我建议您看一下这一部分，以检查引擎生成分数的公式的应用。</p><h1 id="f7f5" class="lg lh in bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">解释 API</h1><p id="c0cc" class="pw-post-body-paragraph jv jw in jx b jy me ka kb kc mf ke kf kg mg ki kj kk mh km kn ko mi kq kr ks ig bi translated">虽然我们使用<code class="fe lc ld le lf b">explain</code>属性来理解相关性评分的机制，但是除了提供评分计算之外，还有一个<code class="fe lc ld le lf b">explain</code> API 来提供对文档匹配(或不匹配)原因的洞察。下面清单中的查询使用一个带有文档 ID 的<code class="fe lc ld le lf b">_explain</code>端点作为参数来演示这种方法。</p><pre class="mv mw mx my gt mz lf na nb aw nc bi"><span id="3f06" class="mj lh in lf b gy nd ne l nf ng">GET movies/_explain/14<br/>{<br/> "query":{<br/>  "match": {<br/>   "title": "Lord"<br/>  }<br/> }<br/>}</span></pre><p id="fee5" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这个查询与清单 8.20 中的查询相同，但是这一次，我们调用了<code class="fe lc ld le lf b">_explain</code>端点，而不是在<code class="fe lc ld le lf b">_search</code>端点上设置<code class="fe lc ld le lf b">explain</code>标志。前面清单中的结果提供了关于分数的解释。</p><p id="29bf" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">最后，让我们在上面的清单中搜索<em class="kt">领主</em>(而不是<em class="kt">领主</em>)并重新运行查询。如下面的代码片段所示，Elasticsearch 提供了一个线索，说明为什么我们没有得到相同的结果</p><pre class="mv mw mx my gt mz lf na nb aw nc bi"><span id="76a4" class="mj lh in lf b gy nd ne l nf ng">{<br/> "_index" : "movies",<br/> "_type" : "_doc",<br/> "_id" : "14",<br/> "matched" : false,<br/> "explanation" : {<br/>  "value" : 0.0,<br/>  <strong class="lf io">"description" : "no matching term",<br/>  </strong>"details" : [ ]<br/> } <br/>}</span></pre><p id="f72d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如解释对象的<code class="fe lc ld le lf b">description</code>所说，<em class="kt"> Lords </em>与索引数据不匹配。了解匹配(或不匹配)的原因有助于我们对查询的状态进行故障诊断(例如，在前面的示例中，我们知道匹配的术语不存在于我们的索引中)。</p><blockquote class="nw nx ny"><p id="b9bf" class="jv jw kt jx b jy jz ka kb kc kd ke kf nz kh ki kj oa kl km kn ob kp kq kr ks ig bi translated">使用<code class="fe lc ld le lf b">_search</code> API 上的<code class="fe lc ld le lf b">explain</code>标志构建的搜索查询可以产生很多结果。在我看来，在查询级别要求对所有文档的分数进行解释纯粹是浪费计算资源。相反，选择一个文档并使用<code class="fe lc ld le lf b">_explain</code> API 请求解释</p></blockquote><p id="8795" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这是对<code class="fe lc ld le lf b">_explain</code>和<code class="fe lc ld le lf b">explain</code>标志的简单解释！</p><p id="d5aa" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">别忘了<a class="ae ku" href="https://mkonda007.medium.com" rel="noopener">跟着</a>我，如果你喜欢就鼓掌:)</p></div><div class="ab cl kv kw hr kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="ig ih ii ij ik"><figure class="mv mw mx my gt jo gh gi paragraph-image"><div class="gh gi jk"><img src="../Images/95a3991b60dc7d79ed2993deb247df4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*nVXtNoFBzDjIvnz-Use6yg.png"/></div><figcaption class="jr js gj gh gi jt ju bd b be z dk translated">行动中的弹性研究</figcaption></figure></div></div>    
</body>
</html>