<html>
<head>
<title>Map Rendering using React with d3.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 React with d3.js 进行地图渲染</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/map-rendering-using-react-with-d3-js-76e12f77eb2c?source=collection_archive---------7-----------------------#2022-02-07">https://blog.devgenius.io/map-rendering-using-react-with-d3-js-76e12f77eb2c?source=collection_archive---------7-----------------------#2022-02-07</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="9673" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">d3.js 是一个强大的数据可视化库，用于制作漂亮的东西，如图形、图表和地图。在 Bootcamp 的最终项目中，我们的团队开发了一个疫情跟踪系统，显示安大略省 34 个公共卫生地区的 covid 统计数据。开发一个交互式地图是我们设计的核心特征，所以我们使用 d3.js 来创建它。我们是使用这个软件包的新手，所以我们在互联网上搜索，试图找到如何开始的教程。这是一个痛苦，因为我们的技术栈使用 React 作为状态管理和 DOM 操作的前端。大多数教程是为普通 JS 编写的。因此，我写这篇文章是为了提供一个教程，帮助初学者集成 d3 地图和 react 组件。</p><p id="5028" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我还在这里创建了一个<a class="ae ki" href="https://github.com/xihai01/d3-mapping-with-react" rel="noopener ugc nofollow" target="_blank"> <strong class="jm io"> github repo </strong> </a>，你可以使用它来跟随。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/3b650422c18b1cbf43037da6f762f214.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*mYmHjx7PSEqzuH4mlaG92w.gif"/></div></div><figcaption class="kv kw gj gh gi kx ky bd b be z dk translated">演示</figcaption></figure></div><div class="ab cl kz la hr lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="ig ih ii ij ik"><h1 id="7a21" class="lg lh in bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated"><strong class="ak">安装包</strong></h1><p id="1677" class="pw-post-body-paragraph jk jl in jm b jn me jp jq jr mf jt ju jv mg jx jy jz mh kb kc kd mi kf kg kh ig bi translated">首先，安装软件包并将其导入到您的项目中，如下所示:</p><pre class="kk kl km kn gt mj mk ml mm aw mn bi"><span id="0f89" class="mo lh in mk b gy mp mq l mr ms">import * as d3 from “d3”;</span></pre><p id="86ed" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">通配符*导入所有 d3 包。</p></div><div class="ab cl kz la hr lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="ig ih ii ij ik"><h1 id="c89e" class="lg lh in bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated"><strong class="ak">加载数据</strong></h1><p id="7118" class="pw-post-body-paragraph jk jl in jm b jn me jp jq jr mf jt ju jv mg jx jy jz mh kb kc kd mi kf kg kh ig bi translated">我创建了一个名为 useMapTools 的自定义钩子来加载我从安大略省公共卫生部网站下载的 geoJSON 文件中的地图数据，并将其托管在 Github 页面上。如果您有 topoJSON 文件，请将其转换为 d3 要求的 geoJSON 格式。好的包装是<a class="ae ki" href="https://github.com/topojson/topojson" rel="noopener ugc nofollow" target="_blank"> topojson </a>。</p><p id="bea9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在 useMapTools 中，mapData 状态将保存成功加载的 geoJSON 数据和布尔变量 Loading，以表示数据是否已成功提取。</p><p id="d850" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们还将一个 div 元素附加到主体上作为工具提示，并将其不透明度设置为 0(稍后将详细介绍)。</p><p id="da59" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果不清楚的话，useEffect 钩子有一个空的依赖数组，因为我们只想取一次数据。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi mt"><img src="../Images/a69031b5f37921a163a5ea3e664cb549.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4pX44vcfOzAASbQ5bKyq-A.png"/></div></div><figcaption class="kv kw gj gh gi kx ky bd b be z dk translated">useMapTools.js</figcaption></figure></div><div class="ab cl kz la hr lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="ig ih ii ij ik"><h1 id="d867" class="lg lh in bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated"><strong class="ak">绘制地图</strong></h1><p id="1027" class="pw-post-body-paragraph jk jl in jm b jn me jp jq jr mf jt ju jv mg jx jy jz mh kb kc kd mi kf kg kh ig bi translated">有两个组件负责绘制地图。</p><ul class=""><li id="bd6c" class="mu mv in jm b jn jo jr js jv mw jz mx kd my kh mz na nb nc bi translated">健康区域列表</li><li id="6dc2" class="mu mv in jm b jn nd jr ne jv nf jz ng kd nh kh mz na nb nc bi translated">健康区域</li></ul><p id="7397" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">HealthRegionList 设置用于渲染的画布区域，解析 geoJSON 数据并计算 HealthRegion 的等效 SVG 路径。因此，每个 HealthRegion 组件将直观地表示 34 个健康区域中的一个。</p><p id="25e8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在 HealthRegionList 中，mapData 状态下的 loading 属性用于检查 geoJSON 数据是否已加载。如果还没有加载，则返回一个简单的 h1 标记“正在加载…”。否则，使用 d3.geoPath()计算路径函数并设置其投影，以便地图不失真并适合画布区域。</p><p id="5d52" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">接下来，映射 geoJSON 对象中包含的 features 数组，并返回一个 HealthRegion 组件，该组件具有唯一的键 id 和计算出的路径。</p><p id="a0c5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">HealthRegion 将返回一个带有 d 属性的简单路径元素。path 函数将 features 数组中的每个坐标转换为等效的路径字符串，d 属性可以使用该字符串绘制区域形状。我还提取了工具提示的区域名称。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi ni"><img src="../Images/c4d904693e01d7c0e1bdc6f5d1f98cf8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xIBAfX3KhC5L2gauGYD-ug.png"/></div></div><figcaption class="kv kw gj gh gi kx ky bd b be z dk translated">HealthRegionList.js</figcaption></figure><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/d3ac8c63463d63d2ac100ee27526aac4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1238/format:webp/1*A4VgdV-slI_V2ILmDbuoeQ.png"/></div><figcaption class="kv kw gj gh gi kx ky bd b be z dk translated">健康区域. js</figcaption></figure></div><div class="ab cl kz la hr lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="ig ih ii ij ik"><h1 id="e4ad" class="lg lh in bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated"><strong class="ak"> setMapProjection </strong></h1><p id="e69f" class="pw-post-body-paragraph jk jl in jm b jn me jp jq jr mf jt ju jv mg jx jy jz mh kb kc kd mi kf kg kh ig bi translated">这个辅助函数帮助调整 path 函数，以确保我们的 mapData 适合画布区域。d3 带有许多类型的投影，如 geoAlbers、墨卡托等。选择 geoAlbers 投影是因为只显示了一个省。</p><p id="6f98" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">精度方法通过使用 d3 称为<a class="ae ki" href="https://bl.ocks.org/mbostock/3795544" rel="noopener ugc nofollow" target="_blank">“自适应重采样”</a>的方法来定义区域线的精度。通过将其设置为 0，可以关闭自适应重采样，这样可以提高缩放或平移地图时的性能。</p><p id="4e0a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">rotate 方法采用两个或三个元素的数字数组[lambda，phi，gamma],指定围绕每个球面轴的旋转角度(以度为单位)。(这些对应于偏航、俯仰和滚转。).在找到最好的一个之前，你可能需要调整这些数字。对我来说，最初的地图旋转了大约 90 度，所以我必须在投影上指定一个旋转来抵消它。</p><p id="b786" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">fitExtent 方法将投影映射到边界框。在这种情况下，边界框是画布区域的宽度和高度。画布区域设置为 960 像素乘 480 像素。基本上，这确保了原始 geoJSON 坐标被限制在您的画布中。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/657227b81332ff1b3d5a036dfcc1d787.png" data-original-src="https://miro.medium.com/v2/resize:fit:1174/format:webp/1*3gfMGhaCHtf25S6o38bVNg.png"/></div><figcaption class="kv kw gj gh gi kx ky bd b be z dk translated">setMapProjection.js</figcaption></figure></div><div class="ab cl kz la hr lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="ig ih ii ij ik"><h1 id="a2bf" class="lg lh in bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated"><strong class="ak">工具提示</strong></h1><p id="23a8" class="pw-post-body-paragraph jk jl in jm b jn me jp jq jr mf jt ju jv mg jx jy jz mh kb kc kd mi kf kg kh ig bi translated">最初，我们创建了一个空的 div 并附加到主体上，作为工具提示。在 HealthRegion 中，事件侦听器被添加到路径中以显示工具提示。</p><p id="b968" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在 handleTooltip 中，定义了以下三个回调函数，</p><ul class=""><li id="f0d1" class="mu mv in jm b jn jo jr js jv mw jz mx kd my kh mz na nb nc bi translated">handleMouseOver:当光标在一个区域上时，用 burlywood 颜色显示工具提示</li><li id="4aa8" class="mu mv in jm b jn nd jr ne jv nf jz ng kd nh kh mz na nb nc bi translated">handleMouseOut:当鼠标离开某个区域时隐藏工具提示</li><li id="6472" class="mu mv in jm b jn nd jr ne jv nf jz ng kd nh kh mz na nb nc bi translated">handleMouseMove:动画显示工具提示的位置以跟随光标</li></ul><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/c69d1ad0b4628b92129a83bcc2fafd27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1230/format:webp/1*davY6x96aBpxuz1JVC-AHA.png"/></div><figcaption class="kv kw gj gh gi kx ky bd b be z dk translated">handleTooltip.js</figcaption></figure><h1 id="036e" class="lg lh in bd li lj nm ll lm ln nn lp lq lr no lt lu lv np lx ly lz nq mb mc md bi translated"><strong class="ak">结论</strong></h1><p id="c029" class="pw-post-body-paragraph jk jl in jm b jn me jp jq jr mf jt ju jv mg jx jy jz mh kb kc kd mi kf kg kh ig bi translated">我只是使用 react 组件在 d3.js 中绘制了一些基本的地图，但是我希望这篇教程可以帮助你开始使用 d3 探索无限的可能性。请随意使用回购，并以此为基础进行建设。</p><ul class=""><li id="fb48" class="mu mv in jm b jn jo jr js jv mw jz mx kd my kh mz na nb nc bi translated">回购链接:<a class="ae ki" href="https://github.com/xihai01/d3-mapping-with-react" rel="noopener ugc nofollow" target="_blank">https://github.com/xihai01/d3-mapping-with-react</a></li><li id="aa94" class="mu mv in jm b jn nd jr ne jv nf jz ng kd nh kh mz na nb nc bi translated">下面是很棒的资源:</li></ul><figure class="kk kl km kn gt ko"><div class="bz fp l di"><div class="nr ns l"/></div></figure></div></div>    
</body>
</html>