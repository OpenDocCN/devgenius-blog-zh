<html>
<head>
<title>HAProxy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">HAProxy</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/haproxy-e5d39ca64a07?source=collection_archive---------4-----------------------#2022-10-01">https://blog.devgenius.io/haproxy-e5d39ca64a07?source=collection_archive---------4-----------------------#2022-10-01</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/0ded1062ff543c03cfb8d467f1492470.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Oh8VJsX25V8Q9BaupXPmbg.png"/></div></div></figure><p id="a872" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io"> HAProxy </strong>代表高可用性代理。这是一个免费的<a class="ae kt" href="https://github.com/haproxy/haproxy" rel="noopener ugc nofollow" target="_blank">开源</a>软件，在多个服务器之间提供高可用性负载平衡器，并为 TCP(第 4 层)和 HTTP(第 7 层)提供反向代理。它是用 C 语言(一种低级语言)编写的，因此在处理和 RAM 使用方面是高效的。</p><p id="dc7c" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">令人着迷的是，haproxy 同时支持<strong class="jx io"> tcp </strong>和<strong class="jx io"> http </strong> <strong class="jx io">协议</strong>，这意味着你可以为整个网站建立后端集群/服务器，或者根据客户端请求的内容指定不同的后端。</p><p id="7fe3" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">一些与 haproxy 类似的软件如 nginx，Gearman，pound，…等。</p></div><div class="ab cl ku kv hr kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="ig ih ii ij ik"><p id="5531" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">那么如果 haproxy 是“高可用”的，那么如何控制流量呢？</p><p id="231c" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">haproxy 拥有控制服务器之间流量分配的算法，这些算法包括:</p><p id="e264" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">1-循环赛:就像 Sia 在吊灯之歌(123)中说的那样，简单地一个一个地浏览服务器列表..123 喝… 123..123 喝)🕺🏻。</p><p id="df57" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">2-最少连接:新请求被分配给当前连接请求最少的服务器。</p><p id="359a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">3-源:新请求被分配给先前响应同一客户机的服务器。</p></div><div class="ab cl ku kv hr kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="ig ih ii ij ik"><p id="2fcb" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">事不宜迟，让我们动手干吧</p><p id="45f5" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">让我们创建一个简单的具有 3 个端点的 spring boot web 应用程序</p><figure class="lb lc ld le gt jo"><div class="bz fp l di"><div class="lf lg l"/></div></figure><p id="c2d5" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">创建 3 个端点后，创建一个 dockerfile，以便在两个容器上部署应用程序，就好像它们在不同的服务器上一样。</p><figure class="lb lc ld le gt jo"><div class="bz fp l di"><div class="lf lg l"/></div></figure><p id="71c0" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">建立 docker 形象</p><pre class="lb lc ld le gt lh li lj lk aw ll bi"><span id="976b" class="lm ln in li b gy lo lp l lq lr">docker build -t demo-haproxy .</span></pre><p id="ca74" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">将镜像部署到第一个容器<strong class="jx io">中，并使其监听端口<strong class="jx io"> 8081 </strong></strong></p><pre class="lb lc ld le gt lh li lj lk aw ll bi"><span id="8d8a" class="lm ln in li b gy lo lp l lq lr">docker run -d -e SERVER_PORT=8081 -p 8081:8081 demo-haproxy</span></pre><p id="8bff" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">将镜像部署到第二个容器<strong class="jx io">中，并使其监听端口<strong class="jx io"> 8082 </strong></strong></p><pre class="lb lc ld le gt lh li lj lk aw ll bi"><span id="1a8f" class="lm ln in li b gy lo lp l lq lr">docker run -d -e SERVER_PORT=8082 -p 8082:8082 demo-haproxy</span></pre><figure class="lb lc ld le gt jo gh gi paragraph-image"><div class="gh gi ls"><img src="../Images/73b74e4800c271e0daa22938b6b4e3e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1080/format:webp/1*ZDLqAU4HMfUk2ogUJo1_sw.png"/></div></figure><figure class="lb lc ld le gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi lt"><img src="../Images/6ad5ef7edf52beb21b3c0813de155330.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0LDGxT5aH8_1Nf2ILoMl9g.png"/></div></div></figure><figure class="lb lc ld le gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi lu"><img src="../Images/ee24720d9ec36c5f5640279cad155e0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MX1QODb3FxN1i3am-2TYVw.png"/></div></div></figure><p id="ec6a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在，我们已经确保了我们的容器运行正常，页面得到了预期的服务，我们可以开始 haproxy 部分了。</p></div><div class="ab cl ku kv hr kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="ig ih ii ij ik"><p id="1058" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在你的机器上安装 haproxy</p><pre class="lb lc ld le gt lh li lj lk aw ll bi"><span id="8d95" class="lm ln in li b gy lo lp l lq lr">brew install haproxy</span></pre><p id="3187" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">为 haproxy 创建一个配置文件，指定绑定和后端的前端(入口点)。</p><figure class="lb lc ld le gt jo"><div class="bz fp l di"><div class="lf lg l"/></div></figure><p id="3b98" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在配置文件中，我们将前端名称指定为 http，因为我们将在第 7 层进行负载平衡。你可以选择任何你喜欢的名字，只要让它有意义。</p><p id="b1c8" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在 fronend 中，您将指定您将监听的 ip 和端口，以及超时客户端，这是针对 haproxy 客户端而不是后端服务器的超时。haproxy 的默认算法是<strong class="jx io">循环调度</strong>，但是由于浏览器是<strong class="jx io">有状态的</strong>，它将使用<strong class="jx io">之前的会话连接</strong>，并且不会让 Sia 的(123，123 饮料)歌曲发生，所以我们将使<strong class="jx io">模式 http </strong>让它知道我们不想使用之前的会话，而是创建一个新的会话。最后，默认后端只是一个指向您在配置文件中定义的后端的指针。</p><p id="e36c" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">为了介绍您的服务器，您需要创建<strong class="jx io">后端</strong>部分，在这里我们创建了一个默认的，将包含所有<strong class="jx io">服务器/容器</strong>。</p><p id="b6f0" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">服务器<strong class="jx io"> app1 </strong>会将流量路由到监听<strong class="jx io"> 8081 </strong>的容器。</p><p id="4df5" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">服务器<strong class="jx io"> app2 </strong>会将流量路由到监听<strong class="jx io"> 8082 </strong>的容器。</p><p id="7798" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">让我们点燃它，^_^</p><pre class="lb lc ld le gt lh li lj lk aw ll bi"><span id="afcd" class="lm ln in li b gy lo lp l lq lr">haproxy -f haproxy.cfg</span></pre><p id="9397" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">转到你的浏览器(http:127.0.0.1:80/)并不断刷新页面，haproxy 将在两个容器之间分别<strong class="jx io">循环</strong>你。</p><p id="d5a5" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">初次尝试:</p><figure class="lb lc ld le gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi lv"><img src="../Images/8bbd104397fe4b32c195ba8c1219e6b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JBWiutYkSLzrr9pwM4aDFQ.png"/></div></div></figure><p id="a7f4" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">第二次尝试:</p><figure class="lb lc ld le gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi lw"><img src="../Images/3651455d29143a3de39e7e81783e3ae6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ExZqL6catudzLxPGrnDgCw.png"/></div></div></figure><p id="d16e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">正如您看到的，我们设法在两个服务器/容器之间取得了平衡，但是让我们回忆一下这个应用程序。它有 3 个端点:欢迎端点、app1 端点和 app2 端点。</p><p id="3814" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们将使<strong class="jx io">欢迎端点</strong>路由到<strong class="jx io">两个服务器</strong>，并将<strong class="jx io"> app1 端点</strong>的流量路由到监听<strong class="jx io">端口 8081 </strong>的容器，并将<strong class="jx io"> app2 </strong> b 的流量路由到监听<strong class="jx io">端口 8082 </strong>的容器。</p><p id="1f1e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">为此，首先让我们为配置文件创建一些新的后端。</p><figure class="lb lc ld le gt jo"><div class="bz fp l di"><div class="lf lg l"/></div></figure><p id="6fa3" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">创建后端后，让我们在前端创建一个访问控制列表 ACL，以基于 url 路径路由流量。</p><figure class="lb lc ld le gt jo"><div class="bz fp l di"><div class="lf lg l"/></div></figure><p id="a68c" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在让我们启动它并检查一下</p><pre class="lb lc ld le gt lh li lj lk aw ll bi"><span id="bdf5" class="lm ln in li b gy lo lp l lq lr">haproxy -f haproxy.cfg</span></pre><figure class="lb lc ld le gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi lx"><img src="../Images/c7e659b3f9492a6ad7163253b32186b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NOGP6EBET4Jt-zQ8fV7wBA.png"/></div></div></figure><figure class="lb lc ld le gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ly"><img src="../Images/c395d6af1583bfdbc06a4f0a6a6ae8f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FryZQ5ISxL9C9r49-18IBg.png"/></div></div></figure><p id="fc8a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">要查看源代码(spring boot app+docker file+ha proxy 配置文件)请访问 github repo:<a class="ae kt" href="https://github.com/lamoboos223/spring-boot-haproxy" rel="noopener ugc nofollow" target="_blank">https://github.com/lamoboos223/spring-boot-haproxy</a></p><p id="e7a4" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这都是^_^</p><p id="34a2" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">非常感谢你阅读这个故事，让我们在 linkedin 上联系:<a class="ae kt" href="https://www.linkedin.com/in/lama-alosaimi/" rel="noopener ugc nofollow" target="_blank">https://www.linkedin.com/in/lama-alosaimi/</a></p></div></div>    
</body>
</html>