<html>
<head>
<title>How to build Prefect for Work Orchestration</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何建立完美的工作流程</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/how-to-build-prefect-for-work-orchestration-1d824bd7893f?source=collection_archive---------5-----------------------#2022-11-16">https://blog.devgenius.io/how-to-build-prefect-for-work-orchestration-1d824bd7893f?source=collection_archive---------5-----------------------#2022-11-16</a></blockquote><div><div class="fc ic id ie if ig"/><div class="ih ii ij ik il"><div class=""/><p id="dfd7" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated">这是 101 教程，适用于想使用以下规格的人。GCP <br/> 2。提督 2.6.5 <br/> 3。dbt 1.3.9</p><p id="6cd1" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated">我发现 GCP+Prefect2.0 教程比较少。因此，我想在这里写下指导方针。请访问<a class="ae kj" href="https://github.com/dacozai/demo-gcp-prefect-dbt" rel="noopener ugc nofollow" target="_blank"> GithubRepo </a></p><p id="f147" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated"><strong class="jn ip">请用 GCP 提供的 300 美元免费试用创建一个谷歌账户。然后，你就不需要担心收到账单了。</strong>是的，我正在使用这个免费层来调查这一基础架构。这就是本教程的目的。</p><blockquote class="kk kl km"><p id="eb7f" class="jl jm kn jn b jo jp jq jr js jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh ki ih bi translated"><strong class="jn ip"> <em class="io">目标:帮助人们将本教程用于他们的 GCP 概念验证，以决定他们是否应该使用提督</em> </strong></p></blockquote><h1 id="6b2d" class="kr ks io bd kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo bi translated">步骤 1 创建完美的工作空间并登录</h1><p id="3cc4" class="pw-post-body-paragraph jl jm io jn b jo lp jq jr js lq ju jv jw lr jy jz ka ls kc kd ke lt kg kh ki ih bi translated">请在这里登录提督云<a class="ae kj" href="https://app.prefect.cloud/" rel="noopener ugc nofollow" target="_blank"/><br/><strong class="jn ip">由于提督</strong> <a class="ae kj" href="https://medium.com/the-prefect-blog/modular-data-stack-build-a-data-platform-with-prefect-dbt-and-snowflake-part-2-cf753708a19e" rel="noopener"> <strong class="jn ip">许诺</strong> </a> <strong class="jn ip">，我们不需要在这里设置信用卡。</strong>因此，这里没有账单。看完教程，相信你会明白如何自己搭建猎户座。但是，我不会演示这一部分。</p><ol class=""><li id="1b43" class="lu lv io jn b jo jp js jt jw lw ka lx ke ly ki lz ma mb mc bi translated">创建名为<code class="fe md me mf mg b">demo</code>的工作区</li><li id="ca0e" class="lu lv io jn b jo mh js mi jw mj ka mk ke ml ki lz ma mb mc bi translated">然后，填写下面的命令，然后复制粘贴并输入🙌</li></ol><pre class="mm mn mo mp gu mq mg mr bn ms mt bi"><span id="37b0" class="mu ks io mg b be mv mw l mx my">API_KEY=[please_fill_your_api_token]<br/>YOUR_ACCOUNT=[please_fill_your_account]<br/>WORKSPACE=demo<br/># EXAMPLE<br/># API_KEY=pnu_AAq8ZJvEfzXIspHxsYha1hn6BJTXKc1DX75q [No worries it is deprecated]<br/># YOUR_ACCOUNT=edenhiveventuresio<br/># WORKSPACE=demo<br/><br/>prefect profile create demo<br/>prefect profile use demo<br/>prefect config set PREFECT_LOGGING_LEVEL=DEBUG<br/>prefect config set PREFECT_API_KEY=$API_KEY<br/>prefect cloud workspace set --workspace "${YOUR_ACCOUNT}/${WORKSPACE}"</span></pre><p id="f827" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated"><strong class="jn ip">检查点</strong> <br/>请执行<code class="fe md me mf mg b">hello.py</code>查看设置是否正确。<br/>有两个地方可以检查它是否工作。<br/> 1。你的终端。你应该能看到👋在你的终端上<br/> 2。点击<code class="fe md me mf mg b">Flow Runs</code>可以看到<code class="fe md me mf mg b">foo/xxxxx</code> <strong class="jn ip">完成</strong></p><h1 id="fe2a" class="kr ks io bd kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo bi translated">步骤 2 创建 GKE 集群</h1><h2 id="7577" class="mz ks io bd kt na nb dn kx nc nd dp lb jw ne nf lf ka ng nh lj ke ni nj ln nk bi translated">创建服务帐户</h2><p id="b823" class="pw-post-body-paragraph jl jm io jn b jo lp jq jr js lq ju jv jw lr jy jz ka ls kc kd ke lt kg kh ki ih bi translated">我创建一个名为<code class="fe md me mf mg b">prefect-demo</code> <br/>的服务账号授予以下权限。<br/> 1。工作负荷标识用户<br/> 2。BigQuery Admin <br/> 3。存储管理员<br/>注意。<strong class="jn ip"> 2 和 3 是非常危险的设置</strong>。我将服务帐户设置为管理员级别，因为这样更容易编写 101 教程。否则，这将花费我更多的时间在这个教程上😫请<code class="fe md me mf mg b">DO</code>在演示后修改它们，以遵循<strong class="jn ip">此处</strong>提到的<a class="ae kj" href="https://cloud.google.com/iam/docs/using-iam-securely#least_privilege" rel="noopener ugc nofollow" target="_blank">最小特权(PoLP)</a>原则。</p><h2 id="fb0b" class="mz ks io bd kt na nb dn kx nc nd dp lb jw ne nf lf ka ng nh lj ke ni nj ln nk bi translated">创建 GKE 集群</h2><p id="9e8f" class="pw-post-body-paragraph jl jm io jn b jo lp jq jr js lq ju jv jw lr jy jz ka ls kc kd ke lt kg kh ki ih bi translated">1.选择标准[如果你愿意，你可以使用自动驾驶仪。只是费用的问题😅] -&gt;点击<code class="fe md me mf mg b">configure</code> <br/> 2。使用名称— <code class="fe md me mf mg b">demo</code> <br/> 3。点击左侧<code class="fe md me mf mg b">default-pool</code>-&gt;-<code class="fe md me mf mg b">nodes</code>-&gt;选择 n1-standard-1 作为机器类型。<br/> 4。<code class="fe md me mf mg b">cluster/ecurity</code>-&gt;-<strong class="jn ip">启用工作量标识</strong></p><pre class="mm mn mo mp gu mq mg mr bn ms mt bi"><span id="f68d" class="mu ks io mg b be mv mw l mx my"># Please fill your information below<br/>CLUSTER_NAME=demo<br/>COMPUTE_REGION=us-central1-c<br/>PROJECT_ID=[======== YOUR_PROJECT_ID ========] <br/># ex. PROJECT_ID=abcd-1234567<br/>NODEPOOL_NAME=default-pool<br/>SVC_ACCOUNT_NAME=prefect-demo<br/>NAMESPACE=example<br/><br/># IF YOU FORGET to enable workload identity, PLEASE use the commands below<br/># Please stick with me!<br/># <br/># # setup workload identity and its pool<br/># gcloud container clusters update $CLUSTER_NAME \<br/>#     --region=$COMPUTE_REGION \<br/>#     --workload-pool=$PROJECT_ID.svc.id.goog<br/># # GKE metadata for the node pool<br/># gcloud container node-pools update $NODEPOOL_NAME \<br/>#     --cluster=$CLUSTER_NAME \<br/>#     --region=$COMPUTE_REGION \<br/>#     --workload-metadata=GKE_METADATA<br/><br/>gcloud iam service-accounts add-iam-policy-binding \<br/> $SVC_ACCOUNT_NAME@$PROJECT_ID.iam.gserviceaccount.com \<br/> --role roles/iam.workloadIdentityUser \<br/> --member "serviceAccount:${PROJECT_ID}.svc.id.goog[${NAMESPACE}/${SVC_ACCOUNT_NAME}]"<br/><br/># DON'T WORRY about k8s annotation<br/># This will be set while creating our deployment</span></pre><p id="b385" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated"><strong class="jn ip">检查点</strong></p><pre class="mm mn mo mp gu mq mg mr bn ms mt bi"><span id="38be" class="mu ks io mg b be mv mw l mx my"># first connect to your GKE cluster<br/>gcloud container clusters get-credentials $CLUSTER_NAME \<br/>  --zone $COMPUTE_REGION --project $PROJECT_ID<br/><br/>kubectl create ns example<br/>#&gt;&gt;&gt; namespace/example created</span></pre><h1 id="0e0a" class="kr ks io bd kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo bi translated">步骤 3 为我们的 k8s 创建完美的代理</h1><p id="7a48" class="pw-post-body-paragraph jl jm io jn b jo lp jq jr js lq ju jv jw lr jy jz ka ls kc kd ke lt kg kh ki ih bi translated">如果你想自己做这件事，请看看这里的<a class="ae kj" href="https://github.com/PrefectHQ/prefect-helm" rel="noopener ugc nofollow" target="_blank">提督赫尔姆。如果你想做 Kustomize，请跟我来。</a></p><pre class="mm mn mo mp gu mq mg mr bn ms mt bi"><span id="38c5" class="mu ks io mg b be mv mw l mx my">prefect kubernetes manifest agent</span></pre><p id="534e" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated">然后将<code class="fe md me mf mg b">deployment</code>输出复制粘贴到 deployment.yaml 中，如果你不了解 k8s，我建议你先了解 k8s。本教程假设人们至少知道如何操作 k8s。请记住，我们将在之前创建的名称空间<code class="fe md me mf mg b">example</code>中进行演示。然后在<code class="fe md me mf mg b">spec.template.spec.env</code>中填写从<code class="fe md me mf mg b">deployment.yaml</code>开始的以下命令行</p><h2 id="5a83" class="mz ks io bd kt na nb dn kx nc nd dp lb jw ne nf lf ka ng nh lj ke ni nj ln nk bi translated">可选择的</h2><pre class="mm mn mo mp gu mq mg mr bn ms mt bi"><span id="078f" class="mu ks io mg b be mv mw l mx my">PREFECT_API_URL=https://app.prefect.cloud/api/accounts/583890cb-6790-47ac-9989-1bc8edc6a0ba/workspace/d8f7d359-21bb-42f5-b3a1-215d4e03e531<br/>PREFECT_API_KEY=pnu_AAq8ZJvEfzXIspHxsYha1hn6BJTXKc1DX75q<br/>kubectl create secret generic mysecret \<br/>  --from-literal=PREFECT_API_URL=$PREFECT_API_URL \<br/>  --from-literal=PREFECT_API_KEY=$API_KEY \<br/>  -n example --dry-run=client -o yaml</span></pre><p id="c727" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated">😏请将输出直接复制粘贴到<code class="fe md me mf mg b">secret.yaml</code> <a class="ae kj" href="https://cloud.google.com/kubernetes-engine/docs/concepts/secret#using_a_secret" rel="noopener ugc nofollow" target="_blank">参考</a> <br/>注释中。这个演示在这里不会用到 secret。</p><p id="f306" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated"><strong class="jn ip"> CHECK_POINT </strong> <br/>现在是激动人心的部分。如果设置正确，您可以在提督的<code class="fe md me mf mg b">Work Queues</code>选项卡中看到<code class="fe md me mf mg b">kubernetes</code>。</p><h1 id="c857" class="kr ks io bd kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo bi translated">步骤 4 为容器注册创建一个映像</h1><p id="44fb" class="pw-post-body-paragraph jl jm io jn b jo lp jq jr js lq ju jv jw lr jy jz ka ls kc kd ke lt kg kh ki ih bi translated">请遵循此处的指南<a class="ae kj" href="https://cloud.google.com/container-registry/docs/quickstart#before-you-begin" rel="noopener ugc nofollow" target="_blank">进行先决条件。使用以下命令为 GCR 图像创建图像。</a></p><pre class="mm mn mo mp gu mq mg mr bn ms mt bi"><span id="d171" class="mu ks io mg b be mv mw l mx my">docker build -t gcr.io/$PROJECT_ID/prefect_gcp_demo .<br/>docker push gcr.io/$PROJECT_ID/prefect_gcp_demo</span></pre><p id="d100" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated">确保图像已被放入容器注册表选项卡</p><h1 id="9a13" class="kr ks io bd kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo bi translated">检查我们的员工</h1><p id="9846" class="pw-post-body-paragraph jl jm io jn b jo lp jq jr js lq ju jv jw lr jy jz ka ls kc kd ke lt kg kh ki ih bi translated">这是一个检查我们的工人是否能与完美云正常工作的部分。但是，从理论上讲，这应该是可行的。<br/> 1。是时候为运行我们的 worker 创建所需的块了😃请运行<code class="fe md me mf mg b">create_blocks.py</code> <br/> [ <strong class="jn ip">注意</strong> ]做任何你喜欢的改变，尤其是 GCS 桶名！！！<br/> 2。为代理创建要执行的部署</p><pre class="mm mn mo mp gu mq mg mr bn ms mt bi"><span id="b99c" class="mu ks io mg b be mv mw l mx my">prefect deployment build hello.py:foo -q kubernetes \<br/>  -n "demo-test" -sb gcs/demo -ib kubernetes-job/kk -a</span></pre><p id="b7f6" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated">转到部署面板，单击运行</p><figure class="mm mn mo mp gu nm gi gj paragraph-image"><div role="button" tabindex="0" class="nn no di np bf nq"><div class="gi gj nl"><img src="../Images/ce0cdca0efc8cd501a3c535f2cd280a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ftQNLWFL019EXLwrIygzXQ.png"/></div></div></figure><p id="660b" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated">然后，您可以看到作业是通过 website/k9s 或其他 k8s 监视器界面执行的。</p><h1 id="8236" class="kr ks io bd kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo bi translated">步骤 6 下载 dbt 演示报告— jaffle_shop</h1><p id="5890" class="pw-post-body-paragraph jl jm io jn b jo lp jq jr js lq ju jv jw lr jy jz ka ls kc kd ke lt kg kh ki ih bi translated">我把<code class="fe md me mf mg b">jaffle_shop</code> <em class="kn"> </em>直接放到 GitHub <a class="ae kj" href="https://github.com/dacozai/demo-gcp-prefect-dbt" rel="noopener ugc nofollow" target="_blank">库</a>里。我想最好还是了解一下<code class="fe md me mf mg b">dbt</code>如何设置<code class="fe md me mf mg b">profiles.yml</code> <br/>因此，请把<code class="fe md me mf mg b">project</code>换成你的<code class="fe md me mf mg b">PROJECT_ID</code></p><p id="9583" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated">要检查您的<code class="fe md me mf mg b">dbt</code>是否工作，请进入文件夹<strong class="jn ip">dbt-jaffle-shop</strong>place<code class="fe md me mf mg b">dbt seed</code>。如果 dbt 设置有效，您可以看到在 Bigquery 中创建了三个表</p><p id="8904" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated">在那之后，我们想要验证你的服务帐户是否能为长官和 GCP 工作。</p><pre class="mm mn mo mp gu mq mg mr bn ms mt bi"><span id="85b1" class="mu ks io mg b be mv mw l mx my">prefect deployment build dbt_build.py:dbt_build -q kubernetes \                                              ✔  data <br/>  -n "dbt-build-test" -sb gcs/demo -ib kubernetes-job/kk -a</span></pre><p id="49a0" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated">然后，转到部署以手动触发此流运行。</p><p id="d210" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated">如果是的话！！！恭喜你！！！和提督/dbt 以及我们的老朋友 GKE 玩得开心😄</p></div></div>    
</body>
</html>