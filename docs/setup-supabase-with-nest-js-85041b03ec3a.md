# ä½¿ç”¨ Nest.js è®¾ç½® Supabase

> åŸæ–‡ï¼š<https://blog.devgenius.io/setup-supabase-with-nest-js-85041b03ec3a?source=collection_archive---------7----------------------->

# å¦‚ä½•åœ¨ Nest.js åº”ç”¨ä¸­ä½¿ç”¨ Supabase çš„ Auth å’Œ Client

![](img/9495cee9e437ea0076d63ba4a3001a9a.png)

ä½¿ç”¨ Nest.js è®¾ç½® Supabase

# âš ï¸å…è´£å£°æ˜

è¿™ç¯‡æ–‡ç« æ˜¯ä¸º Supabase **v1** åˆ›å»ºçš„ï¼Œç”±äºæŸäº› **auth** æ–¹æ³•çš„è´¬å€¼ï¼Œä¼¼ä¹æ— æ³•ä¸ **v2** ä¸€èµ·å·¥ä½œã€‚æˆ‘å°†ä¸º **v2** åˆ›å»ºä¸€ç¯‡æ–°æ–‡ç« ï¼Œå¹¶æ”¾åœ¨è¿™é‡Œã€‚å¦‚æœä½ å·²ç»æ‰¾åˆ°äº†è§£å†³æ–¹æ¡ˆï¼Œè¯·åœ¨è¯„è®ºä¸­å‘Šè¯‰æˆ‘ï¼è°¢è°¢ï¼

## ğŸ¤“æˆ‘å¯¹ä½ çš„æœŸæœ›

*   ä½ çŸ¥é“ Supabase æ˜¯ä»€ä¹ˆå—
*   ä½ çŸ¥é“ Nest.js æ¡†æ¶
*   å¦‚æœéœ€è¦çš„è¯ï¼Œä½ å¯ä»¥è°·æ­Œä¸€ä¸‹æœ¬æ•™ç¨‹ä¹‹å¤–çš„å†…å®¹

# ğŸ¤”æˆ‘åœ¨ Nest.js ä¸­ä½¿ç”¨ Supabase çš„ç”¨ä¾‹

æˆ‘éœ€è¦ä¸€ä¸ªæ¯ 1 ç§’é’Ÿè¿è¡Œä¸€æ¬¡å¹¶æ‰§è¡Œä¸€äº›æ“ä½œçš„è½®è¯¢æœºåˆ¶ã€‚ä½œä¸º Auth å’Œ DBï¼Œæˆ‘é€‰æ‹©äº†ä½¿ç”¨ Supabaseï¼Œå› ä¸ºæˆ‘çœ‹åˆ°äº†ä¸€äº›æ•™ç¨‹ï¼Œæƒ³å°è¯•ä¸€ä¸‹ã€‚

èµ·åˆï¼Œæˆ‘æƒ³é€šè¿‡ Cron Jobs ä½¿ç”¨ Next.js å’Œå‡½æ•°æ¥å®Œæˆè¿™äº›æ“ä½œï¼Œä½†æ°å¥½ Github(ä½œä¸ºæœ€å®¹æ˜“è®¿é—®çš„ Cron æä¾›è€…)çš„ Cron Job çš„æœ€å°æ—¶é—´èŒƒå›´åªæœ‰æ¯ 5 åˆ†é’Ÿä¸€æ¬¡ã€‚

æ‰€ä»¥æˆ‘è½¬è€Œè€ƒè™‘ç”¨ Nest.js å¼€å‘ä¸€ä¸ªæœåŠ¡å™¨(å®Œæ•´)åº”ç”¨ç¨‹åº

# ğŸ§‘â€ğŸ’»å¦‚ä½•ä½¿ç”¨ Supabase å’Œ Nest.js

æœ‰ä¸€ä¸ªä¾‹å­å¯ä»¥è¯´æ˜å¦‚ä½•ä½¿ç”¨ Supabase ä½œä¸º Nest.js åº”ç”¨ç¨‹åºçš„èº«ä»½éªŒè¯åº“ï¼Œä½†æ˜¯:

*   å¯¹æˆ‘æ¥è¯´ï¼Œè¿™ä¼¼ä¹å¹¶ä¸ç®€å•(å®é™…å®ç°)ï¼Œæˆ‘ä¹Ÿä¸æƒ³ä½¿ç”¨å¤–éƒ¨åŒ…
*   å®ƒä¸åƒæˆ‘å¸Œæœ›çš„é‚£æ ·å·¥ä½œâ€”â€”å®ƒæ²¡æœ‰ä» lib ä¸­æš´éœ² Supabase å®¢æˆ·ç«¯

*å¦‚æœä½ ä»æœªä½¿ç”¨è¿‡ Passport å¹¶ä¸”éœ€è¦ä¸€ä¸ªä¾‹å­ï¼Œè¿™ä»ç„¶æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æ¡ç›®â€”â€”å®ƒå¸®åŠ©æˆ‘ç†è§£åœ¨æˆ‘çš„ä»£ç ä¸­åº”è¯¥åšä»€ä¹ˆï¼Œæ‰€ä»¥è°¢è°¢*hiro1107* :)

ğŸ“‘ä¾‹å­:[supabase.com/docs/guides/examples](https://supabase.com/docs/guides/examples)

ğŸ§‘â€ğŸ’»github:[github.com/hiro1107/nestjs-supabase-auth](https://github.com/hiro1107/nestjs-supabase-auth)

æ‰€ä»¥æˆ‘å†³å®šä¸º Auth å’Œ Client å®ç°æˆ‘çš„æ–¹æ³•ã€‚

## æˆ‘ä»¬å¯ä»¥åœ¨ Node.js åç«¯ä½¿ç”¨ Supabase å—ï¼Ÿ

ä¸€èˆ¬æ¥è¯´ï¼Œåƒ Firebase ä¸€æ ·ï¼ŒSupabase æ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯å·¥å…·ï¼Œå®ƒé€šè¿‡ä¸ºâ€œåŒ¿åâ€ç”¨æˆ·æä¾›è¡Œçº§å®‰å…¨ç­–ç•¥æ¥ä»å®¢æˆ·ç«¯å·¥ä½œï¼Œä½†å®ƒä¸ä¼šå¼ºè¿«æˆ‘ä»¬åªåœ¨å®¢æˆ·ç«¯ä½¿ç”¨ Supabaseã€‚

é€šè¿‡ä¸€äº›è§„åˆ™ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ Node.js æœåŠ¡å™¨ä¸­è‡ªç”±åœ°åˆ©ç”¨ Supabase çš„èƒ½åŠ›ã€‚

# ğŸ´Supabase åŸºæœ¬è®¾ç½®

åœ¨ç¼–å†™ä»£ç ä¹‹å‰ï¼Œæˆ‘æƒ³æåˆ°å‡ ä¸ªå…³é”®ç‚¹ã€‚

## RLS æ”¿ç­–

åˆ›å»ºè¡¨æ—¶å¯ç”¨å®ƒ

![](img/a1329b5a0964e538a7858c0a032f4eeb.png)

æˆ‘å»ºè®®é»˜è®¤åˆ›å»ºä¸¤ä¸ª:

ä¸ºäº†ä½¿æ‚¨çš„åº”ç”¨ç¨‹åºä¸ä»¥å‰çš„ç­–ç•¥ä¸€èµ·å·¥ä½œï¼Œä¸è¦å¿˜è®°åœ¨æ‚¨ä½¿ç”¨çš„æ¯ä¸ªè¡¨ä¸Šåˆ›å»º`user_id`åˆ—:å®ƒåº”è¯¥æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„`auth.uid()`å­—æ®µï¼Œæ‰€ä»¥è¿™æ ·ä¸€æ¥ï¼ŒSupabase å°†æ€»æ˜¯å°†æ­£ç¡®çš„ç”¨æˆ·è¿½åŠ åˆ°ä¸€è¡Œä¸­ã€‚

![](img/623a21a16dbbefec157772a8534774de.png)

å¦‚æœéœ€è¦ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æœåŠ¡å¯†é’¥ç»•è¿‡ RLSï¼Œä½†è¦å°å¿ƒã€‚

# ğŸ±Nest.js åº”ç”¨ç¨‹åº

## å®‰è£…

ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œé™¤äº† Supabase ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ·»åŠ ä¸€äº›åº“:

```
npm i passport passport-jwt @nestjs/passport @supabase/supabase-js
```

passportâ€”â€”å¤„ç†ä¸ Auth ç›¸å…³çš„æ‰€æœ‰äº‹æƒ…ï¼Œå®ƒæœ‰æ²¡æœ‰é­”åŠ›ï¼Œæˆ‘ä»¬ä¸éœ€è¦å…³å¿ƒ

passport-jwt-ä¸º jwt è®¤è¯æä¾›äº†ç°æˆçš„ç­–ç•¥

[@ nestjs](https://hashnode.com/@nestjs)/passportâ€”nest . js çš„ Passport çš„æ¨¡å—

## JWT è®¤è¯å¦‚ä½•ä¸æŠ¤ç…§

JWT Auth å¦‚ä½•å·¥ä½œè¶…å‡ºäº†æœ¬æ–‡çš„èŒƒå›´ï¼Œä½†æ˜¯åœ¨ Nest.js ä¸­ä½¿ç”¨ Passport å’Œ passport-jwt æœ‰å¾ˆå¤šè§£é‡Šï¼Œä½ å¯ä»¥ä»æ£€æŸ¥ Nest.js çš„[è®¤è¯](https://docs.nestjs.com/security/authentication)å¼€å§‹ã€‚

å¯¹äºæˆ‘ä»¬çš„æ¡ˆä¾‹ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“çš„æ˜¯:Supabase æ˜¯ä¸€ä¸ªåŸºäº JWT çš„æˆæƒæœºæ„ï¼Œè´Ÿè´£å¤„ç†å®ƒè¿™è¾¹çš„æ‰€æœ‰äº‹æƒ…ã€‚åœ¨æˆ‘ä»¬è¿™è¾¹ï¼Œæˆ‘ä»¬éœ€è¦æ­£ç¡®çš„`SUPABASE_JWT_SECRET`ï¼Œç”¨äºè§£ç  jwtã€‚(ä½äºè®¾ç½®- > API)

## è¶…çº§æ–‡ä»¶å¤¹

ğŸ”—[å°†](https://github.com/andriishupta/nestjs-supabase-setup/tree/main/src/common/supabase)é“¾æ¥åˆ°æ–‡ä»¶å¤¹

è¿™æ˜¯ä½ å¯ä»¥å¤åˆ¶åˆ°ä½ çš„ä»£ç åº“çš„ä¸»è¦ä»£ç ï¼Œå®ƒå°†ä¼šå·¥ä½œã€‚è¯¥æ¨¡å—æ˜¯ä¸€ä¸ªå¸¸è§„çš„ Nest.js æ¨¡å—ã€‚å…¶ä»–æ–‡ä»¶å€¼å¾—æ·±å…¥ç ”ç©¶ã€‚

## æˆ˜ç•¥

> *Passport æ‹¥æœ‰ä¸°å¯Œçš„æˆ˜ç•¥ç”Ÿæ€ç³»ç»Ÿï¼Œå¯å®ç°å„ç§èº«ä»½éªŒè¯æœºåˆ¶ã€‚è™½ç„¶åœ¨æ¦‚å¿µä¸Šå¾ˆç®€å•ï¼Œä½†ä½ å¯ä»¥é€‰æ‹©çš„æŠ¤ç…§ç­–ç•¥éå¸¸å¤šï¼Œè€Œä¸”ç§ç±»ç¹å¤š*

å¦‚ Supabase æ˜¯ JWTï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ç°æˆçš„ passport-jwt ç­–ç•¥ï¼Œä¸ºæˆ‘ä»¬åšæ‰€æœ‰çš„è§£ç å’Œå…¶ä»–äº‹æƒ…ã€‚

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬ç”¨ JWT ç­–ç•¥æ‰©å±•äº† PassportStrategyï¼Œå¹¶åœ¨`super`è°ƒç”¨ä¸­ä¼ é€’é…ç½®ã€‚

*å¥‡æ€ªçš„â€œæ‰©å±•â€* `*PassportStrategy(Strategy)*` *æ˜¯æ‰“å­—ç¨¿ Mixins*

ğŸ”—[æºä»£ç ](https://github.com/andriishupta/nestjs-supabase-setup/blob/main/src/common/supabase/supabase.strategy.ts)

![](img/623c6cd06616e5c9dfad7b83e87216c3.png)

## é˜²æŠ¤è£…ç½®

æœ‰äº†è¿™ä¸ªé˜²æŠ¤ï¼Œæˆ‘é€šè¿‡åœ¨ app.module.ts ä¸­æä¾›`APP_GUARD`æ¥ä¿æŠ¤æ•´ä¸ªåº”ç”¨ç¨‹åºâ€”â€”ä¸€ç§å…¨å±€é˜²æŠ¤æ–¹å¼ã€‚ä½ å¯ä»¥ä½¿ç”¨`UseGuard`æ¥ä¿æŠ¤é‚£äº›éœ€è¦ä¿æŠ¤çš„è·¯çº¿ã€‚

è¿™é‡Œï¼Œæˆ‘ä»¬ç”¨`jwt`ç­–ç•¥æ‰©å±•äº† AuthGuard(è¿™æ˜¯ passport-jwt å¦‚ä½•åœ¨å¹•åå‘½åç­–ç•¥çš„)ã€‚ç®€å•ã€‚

ğŸ”—[æºä»£ç ](https://github.com/andriishupta/nestjs-supabase-setup/blob/main/src/common/supabase/supabase.guard.ts)

![](img/4af6e73e88d74340bd7bd060fbb49510.png)

## æœåŠ¡:`Scope.REQUEST`

è¯¥æœåŠ¡å°†ä¸ºæ¯ä¸ªè¯·æ±‚æä¾›`createClient`å’Œ`setAuth`ï¼Œå› æ­¤æˆ‘ä»¬å°†åœ¨æ‰€æœ‰åç»­æœåŠ¡å‘¼å«ä¸­æ‹¥æœ‰æ­£ç¡®çš„ç”¨æˆ·ã€‚ä»£ç ä»¥â€œå•ä¾‹â€æ–¹å¼å®ç°ï¼Œå› æ­¤æˆ‘ä»¬å°†åœ¨åŒä¸€è¯·æ±‚çš„ä¸åŒä½ç½®è·å¾—ç›¸åŒçš„å®ä¾‹ã€‚

ğŸ”—[æºä»£ç ](https://github.com/andriishupta/nestjs-supabase-setup/blob/main/src/common/supabase/supabase.ts)

![](img/b242221d1086526c488080e4cc3f1797.png)

ä¸ºä»€ä¹ˆï¼Ÿ

è¿™é‡Œæœ‰ä¸€ä¸ªæœ‰è¶£çš„éƒ¨åˆ†ï¼Œå®ƒå‘ç”Ÿåœ¨ä¿å­˜å®¢æˆ·ç«¯çŠ¶æ€çš„ä¸åŒåº“ä¸Š:

å¦‚æœæˆ‘ä»¬åœ¨åƒ Next.js è¿™æ ·çš„æœåŠ¡å™¨æˆ– SSR åº”ç”¨ä¸Šä½¿ç”¨ä¿å­˜æ¯ä¸ªç”¨æˆ·çŠ¶æ€çš„å®¢æˆ·ç«¯åº“ï¼Œæˆ‘ä»¬éœ€è¦å°å¿ƒè¿™äº›ï¼Œä¾‹å¦‚å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåº“çš„å®ä¾‹æ—¶ï¼Œå®ƒå¯èƒ½å¯¹è°ƒç”¨æœåŠ¡å™¨/SSR åº”ç”¨çš„æ¯ä¸ªäººéƒ½å¯ç”¨ã€‚

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå¿…é¡»ä½¿ç”¨`@Injectable({ scope: Scope.REQUEST })`çš„åŸå› ï¼Œè¿™æ ·æˆ‘ä»¬çš„ Supabase `createClient`å°†æ ¹æ®è¯·æ±‚åˆ›å»ºï¼Œæˆ‘ä»¬å°†æ­£ç¡®è®¾ç½® authã€‚

å†æ¯”å¦‚: [Next.js &å¸¦ react-query çš„ SSR](https://react-query-v3.tanstack.com/guides/ssr#using-hydration)

![](img/e0ed359f69c952c5d0fa52915424e67f.png)

*å…è´£å£°æ˜:æˆ‘è¿˜æ²¡æœ‰å¯¹å¤šä¸ªç”¨æˆ·è¿›è¡Œæµ‹è¯•ï¼Œä½†æ˜¯æˆ‘å¾ˆç¡®å®šã€‚*æˆ‘è¿˜æ²¡æœ‰æ‰¾åˆ°é€šè¿‡ç›´æ¥å°†`access_token` - only `setAuth`é™„åŠ åˆ°å®¢æˆ·ç«¯æ¥ä¸æ–‡æ¡£ä¸­çš„ä¸€ä¸ªå®¢æˆ·ç«¯ä¼ é€’ Auth çš„å…¶ä»–æ–¹æ³•ã€‚

*å¯èƒ½çš„è§£å†³æ–¹æ¡ˆ* : Supabase å¯ä»¥è°ƒæ•´è®¤è¯æµç¨‹ï¼Œé€šè¿‡ç‹¬ç‰¹çš„è®¾ç½®ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ¯ä¸ªè¯·æ±‚ä¸­ä¼ é€’ç”¨æˆ·ã€‚æœ‰äº† Passportï¼Œæˆ‘ä»¬å°±æœ‰äº†`req.user`ä¸­çš„ç”¨æˆ·ï¼Œå¹¶ä¸”ä»ç„¶å¯ä»¥è®¿é—®`access_token`çš„æˆæƒå¤´ã€‚

# ğŸ“­é‚®é€’å‘˜æµ‹è¯•

ä¸€åˆ‡éƒ½ç»“æŸåï¼Œè®©æˆ‘ä»¬è¯•ç€ç»™æˆ‘ä»¬çš„æœåŠ¡å™¨æ‰“ç”µè¯ã€‚

![](img/279040b807b30b22e5d5793b9f423fed.png)

ä¸å‡ºæ‰€æ–™ï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ª 401 ä»£ç â€”â€”è¿™æ˜¯*æŠ¤ç…§ã€‚js* å®ƒåœ¨æˆ‘ä»¬çš„ **SupabaseGuard** ä¸­æ£€æŸ¥äº† JWT å—

ç°åœ¨è®©æˆ‘ä»¬å¾—åˆ°ä¸€ä¸ªæœ‰æ•ˆçš„`access_token`å¹¶é‡å¤è°ƒç”¨:

![](img/108a9d96a524bea396fad63323e11379.png)

ğŸ’ª ğŸ’ª ğŸ’ª

*ç”¨æˆ·ç™»å½•åå¯ç”¨çš„è®¿é—®ä»¤ç‰Œã€‚åœ¨æˆ‘çš„ä¾‹å­ä¸­ï¼Œæˆ‘åˆšåˆšå‘é€äº†â€œç¥å¥‡é“¾æ¥â€ï¼Œå¹¶ä» URL* ä¸­è·å¾—äº† `*acces_token*`

*![](img/d8735b5803f611bf49fabfa2b757631d.png)*

# *ğŸ“‹summaryâ€”TLï¼›DRï¼›*

*   *å®‰è£…æ‰€éœ€çš„ä¾èµ–é¡¹*
*   *å°† **supabase** æ–‡ä»¶å¤¹å¤åˆ¶åˆ°ä½ çš„é¡¹ç›®ä¸­*
*   *æ·»åŠ  3 ä¸ª SUPABASE_*å˜é‡åˆ°ã€‚åŒ…å°/åŒ…å›´ï¼ˆåŠ¨è¯ envelop çš„ç®€å†™ï¼‰*
*   *å¯¼å…¥*supabase . module*:in app . module/[@ Global](https://hashnode.com/@Global)()auth . module/ç­‰ã€‚*
*   *æä¾›å…¨å±€`APP_GUARD`æˆ–ä½¿ç”¨`UseGuard`åœ¨éœ€è¦çš„åœ°æ–¹ä½¿ç”¨å®ƒ*
*   *ä½¿ç”¨`this.supabase.getClient()`æä¾›çš„å…¶ä»–æœåŠ¡ä¸­çš„ *supabase.ts* è¿›è¡Œ supabase é€šè¯*

# *ğŸ”—é“¾æ¥*

*   *github:[github.com/andriishupta/nestjs-supabase-setup](https://github.com/andriishupta/nestjs-supabase-setup)*
*   *Nest.js çš„[è®¤è¯](https://docs.nestjs.com/security/authentication)ï¼ŒåŒ…æ‹¬å¸¦ Passport.js çš„ JWT*
*   *å¦‚ä½•åœ¨ Nest.js ä¸­ä½¿ç”¨[å®ˆå«](https://docs.nestjs.com/guards)*
*   *Supabase çš„ Auth [å¸¦æœ‰ Nest.js çš„ç¤ºä¾‹åº”ç”¨](https://github.com/hiro1107/nestjs-supabase-auth)*
*   *[Supabase çš„æ–‡ä»¶](https://supabase.com/docs/reference)*

*æ„Ÿè°¢é˜…è¯»ï¼*

**åŸè½½äº*[*https://blog . andriishupta . dev*](https://andriishupta.dev/setup-supabase-with-nestjs)*ã€‚**