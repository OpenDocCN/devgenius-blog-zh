<html>
<head>
<title>Improving Instagram Posts in React Using Cloud Functions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用云功能改进 React 中的 Instagram 帖子</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/improving-instagram-posts-in-react-cea3eec4dbaa?source=collection_archive---------14-----------------------#2022-11-06">https://blog.devgenius.io/improving-instagram-posts-in-react-cea3eec4dbaa?source=collection_archive---------14-----------------------#2022-11-06</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/fbae7ba11d486e68bedc0335d7e5d39c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7hbLlQz0HcsP84A0IsXQJA.png"/></div></div></figure><p id="e314" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我最近探索了一种在 React 中以 3x3 网格显示最新 Instagram 帖子的方法。在本文中，我的目标是用这种方法解决一些问题。在前一篇文章的基础上，我的<strong class="jx io">目标</strong>是:</p><ul class=""><li id="0eae" class="ku kv in jx b jy jz kc kd kg kw kk kx ko ky ks kz la lb lc bi translated">添加对<code class="fe ld le lf lg b">VIDEO</code>和<code class="fe ld le lf lg b">CAROUSEL_ALBUM</code>帖子类型的支持</li><li id="bcc7" class="ku kv in jx b jy lh kc li kg lj kk lk ko ll ks kz la lb lc bi translated">通过隐藏<code class="fe ld le lf lg b">access_token</code>和<code class="fe ld le lf lg b">user_id</code>变量来提高安全性</li></ul><h2 id="fc30" class="lm ln in bd lo lp lq dn lr ls lt dp lu kg lv lw lx kk ly lz ma ko mb mc md me bi translated">增加对<code class="fe ld le lf lg b">VIDEO</code>和<code class="fe ld le lf lg b">CAROUSEL_ALBUM</code>帖子类型的支持</h2><p id="9d6a" class="pw-post-body-paragraph jv jw in jx b jy mf ka kb kc mg ke kf kg mh ki kj kk mi km kn ko mj kq kr ks ig bi translated">首先，<code class="fe ld le lf lg b">InstaItem</code>接口需要更新。如<a class="ae kt" href="https://developers.facebook.com/docs/instagram-basic-display-api/reference/media#reading" rel="noopener ugc nofollow" target="_blank">文档</a>中所述，如果媒体项是<code class="fe ld le lf lg b">VIDEO</code>，则它可能有一个<code class="fe ld le lf lg b">thumbnail_url</code>字段。我向接口添加了<code class="fe ld le lf lg b">mediaType</code>和一个可选的<code class="fe ld le lf lg b">thumbnailUrl</code>，并定义了<code class="fe ld le lf lg b">MediaType</code>类型:</p><figure class="ml mm mn mo gt jo gh gi paragraph-image"><div class="gh gi mk"><img src="../Images/0b19a67fa453fe52ab3a886d6ada5d42.png" data-original-src="https://miro.medium.com/v2/resize:fit:954/format:webp/1*-igaxOpUXEwH--J1Qtlwdw.png"/></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">更新的界面</figcaption></figure><p id="b448" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">为了将 3x3 显示网格逻辑从实际的 post 逻辑中分离出来，我决定创建一个单独的<code class="fe ld le lf lg b">MediaItem</code>组件来接受一个<code class="fe ld le lf lg b">InstaItem</code>对象并显示它(不管它是<code class="fe ld le lf lg b">IMAGE</code>、<code class="fe ld le lf lg b">VIDEO</code>还是<code class="fe ld le lf lg b">CAROUSEL_ALBUM</code>类型)。这样，如果将来有任何更改(比如添加新的媒体类型)，更改将很容易进行，3x3 网格逻辑根本不需要更改。</p><figure class="ml mm mn mo gt jo gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/d884bcfc5e2a67df9ccd05c7869dd33f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1170/format:webp/1*lGutS2C2wkhKwYzCJcrxAw.png"/></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">MediaItem 组件</figcaption></figure><p id="63b8" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在这里，我还添加了一些图标，这些图标会出现在右上角，以表示帖子是<code class="fe ld le lf lg b">VIDEO</code>还是<code class="fe ld le lf lg b">CAROUSEL_ALBUM</code>，为此我使用了<a class="ae kt" href="https://mui.com/material-ui/material-icons/" rel="noopener ugc nofollow" target="_blank"> MUI 图标</a>。将所有内容放在一个<code class="fe ld le lf lg b">a</code>标签中允许用户点击文章，他们将被带到一个新的标签中。我把<code class="fe ld le lf lg b">iconStyle</code> <code class="fe ld le lf lg b">height</code>和<code class="fe ld le lf lg b">width</code>做成百分比，为了让它有求必应。</p><p id="98ad" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在要做的就是更新<code class="fe ld le lf lg b">InstaGrid</code>组件以使用<code class="fe ld le lf lg b">MediaItem</code>组件:</p><figure class="ml mm mn mo gt jo gh gi paragraph-image"><div class="gh gi mu"><img src="../Images/64a23ca43161422532190d46298fe759.png" data-original-src="https://miro.medium.com/v2/resize:fit:792/format:webp/1*JPAmrAmN94rAnZrsurGZ3g.png"/></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">更新的 InstaGrid 组件</figcaption></figure><p id="793e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在这里，我选择为网格本身使用<a class="ae kt" href="https://emotion.sh/docs/styled" rel="noopener ugc nofollow" target="_blank">情感风格的</a>组件。这是网格现在的样子:</p><figure class="ml mm mn mo gt jo gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/c22b0abe88ccd51208dd2b84f4829d78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1308/format:webp/1*0Wapjgk6y-EsaGj7gx--8w.png"/></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">增加了对视频和 CAROUSEL_ALBUM 媒体类型的支持</figcaption></figure><h2 id="340e" class="lm ln in bd lo lp lq dn lr ls lt dp lu kg lv lw lx kk ly lz ma ko mb mc md me bi translated">隐藏<code class="fe ld le lf lg b">access_token</code>和<code class="fe ld le lf lg b">user_id</code>变量</h2><p id="728c" class="pw-post-body-paragraph jv jw in jx b jy mf ka kb kc mg ke kf kg mh ki kj kk mi km kn ko mj kq kr ks ig bi translated">我看到了 Ania Kubow 的关于在 React 中安全隐藏 API 密钥的教程。她的方法非常巧妙，她构建了一个小型服务器应用程序来存储 API 键，并代表 React 应用程序使用这些键来查询给定的 API。</p><p id="1219" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我的好朋友维克多建议实现一个谷歌云功能来做到这一点。使用云功能可以省去我维护独立服务器的麻烦，所以我选择了这个选项。</p><p id="8c92" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">云函数获取我所有帖子的<code class="fe ld le lf lg b">media_id</code>列表，然后使用这些<code class="fe ld le lf lg b">id</code>值查询<code class="fe ld le lf lg b">media</code>端点。</p><p id="3e1d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">为此，我创建了第一代云函数，将其区域设置为离我当前位置最近的区域，并为其命名。<strong class="jx io">我允许未经授权的调用</strong>，这样我就可以从 React 应用程序中查询函数。</p><figure class="ml mm mn mo gt jo gh gi paragraph-image"><div class="gh gi mw"><img src="../Images/59062e9302692897867393ba28a5d60b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1068/format:webp/1*ppgwyo0pcypNCdaTvTnPkA.png"/></div></figure><p id="fdd9" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在<code class="fe ld le lf lg b">package.json</code>里面，我添加了<code class="fe ld le lf lg b">axios</code>依赖:</p><pre class="ml mm mn mo gt mx lg my mz aw na bi"><span id="4435" class="lm ln in lg b gy nb nc l nd ne">{<br/>  "name": "sample-http",<br/>  "version": "0.0.1",<br/>  "dependencies": {<br/>    "axios": "^1.1.3"<br/>  }<br/>}</span></pre><p id="71f4" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在<code class="fe ld le lf lg b">index.js</code>里面，我写了以下代码:</p><pre class="ml mm mn mo gt mx lg my mz aw na bi"><span id="2e58" class="lm ln in lg b gy nb nc l nd ne">const axios = require('axios');</span><span id="cdea" class="lm ln in lg b gy nf nc l nd ne">const accessToken = "IGQ..."; // paste your access_token<br/>const userId = "562..."; // paste your user_id</span><span id="da2d" class="lm ln in lg b gy nf nc l nd ne">const instaUrl = `https://graph.instagram.com/${userId}/media?access_token=${accessToken}`;</span><span id="fec9" class="lm ln in lg b gy nf nc l nd ne">exports.getInstaFeed = async (req, res) =&gt; {<br/>  res.set('Access-Control-Allow-Origin', "*")<br/>  res.set('Access-Control-Allow-Methods', 'GET');</span><span id="205e" class="lm ln in lg b gy nf nc l nd ne">  try {<br/>    const response = (await axios.get(instaUrl)).data;<br/>    const data = response.data;</span><span id="057f" class="lm ln in lg b gy nf nc l nd ne">    const medias = [];<br/>    for (let i = 0; i &lt; data.length &amp;&amp; i &lt; 9; i++) {<br/>      const item = data[i];<br/>      const id = item.id;<br/>  <br/>      const mediaUrl = `https://graph.instagram.com/${id}?access_token=${accessToken}&amp;fields=media_url,permalink,thumbnail_url,media_type`;</span><span id="ea20" class="lm ln in lg b gy nf nc l nd ne">      const mediaResponse = (await axios.get(mediaUrl)).data;<br/>      medias.push(mediaResponse);<br/>    }</span><span id="ba56" class="lm ln in lg b gy nf nc l nd ne">    res.status(200).send(medias);<br/>  } catch (error) {<br/>    console.log(error);<br/>    res.status(500).send({ error: error.message });<br/>  }<br/>};</span></pre><p id="85a7" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">获得<code class="fe ld le lf lg b">access_token</code>和<code class="fe ld le lf lg b">user_id</code>所需的步骤在之前的文章中<a class="ae kt" rel="noopener ugc nofollow" target="_blank" href="/how-add-your-instagram-posts-to-your-react-project-e8527d2a7187">有描述。</a></p><p id="226b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">此处<code class="fe ld le lf lg b">mediaUrl</code>字段参数为<code class="fe ld le lf lg b">media_url</code>、<code class="fe ld le lf lg b">permalink</code>、<code class="fe ld le lf lg b">thumbnail_url</code>和<code class="fe ld le lf lg b">media_type</code>，以匹配<code class="fe ld le lf lg b">InstaItem</code>界面。</p><p id="7a96" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">部署该功能后，在谷歌云平台的<code class="fe ld le lf lg b">Trigger</code>标签下，可以找到该功能的链接。现在剩下的就是更新<code class="fe ld le lf lg b">InstaFeed</code>容器组件:</p><figure class="ml mm mn mo gt jo gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/3fb8fee33a7ee2c67a68cb9bf7a4d27f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1128/format:webp/1*0Kvksdb6tVXxtiPf3F47KQ.png"/></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">更新的 InstaFeed 容器组件</figcaption></figure><p id="d4bd" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">就是这样！</p><h2 id="e47d" class="lm ln in bd lo lp lq dn lr ls lt dp lu kg lv lw lx kk ly lz ma ko mb mc md me bi translated">结论</h2><p id="6cfd" class="pw-post-body-paragraph jv jw in jx b jy mf ka kb kc mg ke kf kg mh ki kj kk mi km kn ko mj kq kr ks ig bi translated">现在，我们有了一个 3x3 的最新 Instagram 帖子网格，支持<code class="fe ld le lf lg b">VIDEO</code>和<code class="fe ld le lf lg b">CAROUSEL_ALBUM</code>媒体类型。它也更安全，因为它在一个云函数中隐藏了<code class="fe ld le lf lg b">access_token</code>和<code class="fe ld le lf lg b">user_id</code>。</p><p id="0d92" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在这种方法还有一个问题，Instagram 对访问他们的 API 有一个速率限制，这个速率相当低(每小时 200 个请求)。这个问题的一个潜在解决方案是缓存结果，只在用户上传新帖子时重新获取，或者只是偶尔轮询一次。</p></div></div>    
</body>
</html>