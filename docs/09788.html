<html>
<head>
<title>K8s Troubleshooting — Namespace Stuck in Terminating State</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">K8s 故障排除—命名空间卡在终止状态</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/k8s-troubleshooting-namespace-stuck-in-terminating-state-b91ab6fa8948?source=collection_archive---------0-----------------------#2022-09-13">https://blog.devgenius.io/k8s-troubleshooting-namespace-stuck-in-terminating-state-b91ab6fa8948?source=collection_archive---------0-----------------------#2022-09-13</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><div class=""/><div class=""><h2 id="bd7e" class="pw-subtitle-paragraph jo iq ir bd b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dk translated">K8s 故障排除手册</h2></div><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div class="gi gj kg"><img src="../Images/f452404373989ae60527cf35a01227b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1260/format:webp/0*fddruQCl6W-9J-7s.png"/></div></figure><blockquote class="ko kp kq"><p id="ac2c" class="kr ks kt ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">N <strong class="ku is"> <em class="ir">注，完整的“K8s 故障排除”思维导图可在:</em> </strong> <a class="ae lo" href="https://github.com/metaleapca/metaleap-k8s-troubleshooting/blob/main/metaleap-k8s-troubleshooting.pdf" rel="noopener ugc nofollow" target="_blank"> <strong class="ku is"> <em class="ir"> K8s 故障排除思维导图</em></strong></a><strong class="ku is"><em class="ir"/></strong></p></blockquote><p id="4788" class="pw-post-body-paragraph kr ks ir ku b kv kw js kx ky kz jv la lp lc ld le lq lg lh li lr lk ll lm ln ik bi translated">有时，当您尝试删除 K8s 集群中的一个<code class="fe ls lt lu lv b">namespace</code>时，它会卡在“终止”状态，如下所示:</p><pre class="kh ki kj kk gu lw lv lx ly aw lz bi"><span id="b47c" class="ma mb ir lv b gz mc md l me mf">$ kubectl get ns | grep -i "terminating"<br/>ingress-nginx2                Terminating   4h47m</span></pre><p id="a29c" class="pw-post-body-paragraph kr ks ir ku b kv kw js kx ky kz jv la lp lc ld le lq lg lh li lr lk ll lm ln ik bi translated">本文展示了您对停留在“终止”状态的<code class="fe ls lt lu lv b">namespace</code>的故障诊断步骤。</p><h1 id="64da" class="mg mb ir bd mh mi mj mk ml mm mn mo mp jx mq jy mr ka ms kb mt kd mu ke mv mw bi translated">第一步:理解为什么</h1><p id="1c81" class="pw-post-body-paragraph kr ks ir ku b kv mx js kx ky my jv la lp mz ld le lq na lh li lr nb ll lm ln ik bi translated">在进入任何其他步骤之前，你首先需要弄清楚为什么<code class="fe ls lt lu lv b">namespace</code>处于“心狠手辣”状态。</p><p id="82f4" class="pw-post-body-paragraph kr ks ir ku b kv kw js kx ky kz jv la lp lc ld le lq lg lh li lr lk ll lm ln ik bi translated">您可以运行<code class="fe ls lt lu lv b">kubectl get ns &lt;namespace_name&gt; -oyaml</code>来查看是否有任何错误信息:</p><pre class="kh ki kj kk gu lw lv lx ly aw lz bi"><span id="b4ad" class="ma mb ir lv b gz mc md l me mf">$ kubectl get ns ingress-nginx2 -oyaml<br/>apiVersion: v1<br/>kind: Namespace<br/>metadata:<br/>  creationTimestamp: "2022-09-02T14:55:32Z"<br/>  deletionTimestamp: "2022-09-02T15:00:07Z"<br/>...<br/>spec:<br/>  finalizers:<br/>  - kubernetes<br/>status:<br/>  <strong class="lv is">conditions:<br/>  - lastTransitionTime: "2022-09-02T15:00:12Z"<br/>    message: 'Discovery failed for some groups, 1 failing: unable to retrieve the<br/>      complete list of server APIs: metrics.k8s.io/v1beta1: an error on the server<br/>      ("Internal Server Error: \"/apis/metrics.k8s.io/v1beta1\": the server could<br/>      not find the requested resource") has prevented the request from succeeding'<br/>    reason: DiscoveryFailed<br/>    status: "True"</strong><br/>    type: NamespaceDeletionDiscoveryFailure<br/>  - lastTransitionTime: "2022-09-02T15:00:12Z"<br/>    message: All legacy kube types successfully parsed<br/>    reason: ParsedGroupVersions<br/>    status: "False"<br/>    type: NamespaceDeletionGroupVersionParsingFailure<br/>  - lastTransitionTime: "2022-09-02T15:00:12Z"<br/>    message: All content successfully deleted, may be waiting on finalization<br/>    reason: ContentDeleted<br/>    status: "False"<br/>    type: NamespaceDeletionContentFailure<br/>  - lastTransitionTime: "2022-09-02T15:00:20Z"<br/>    message: All content successfully removed<br/>    reason: ContentRemoved<br/>    status: "False"<br/>    type: NamespaceContentRemaining<br/>  - lastTransitionTime: "2022-09-02T15:00:12Z"<br/>    message: All content-preserving finalizers finished<br/>    reason: ContentHasNoFinalizers<br/>    status: "False"<br/>    type: NamespaceFinalizersRemaining<br/>  phase: Terminating</span></pre><p id="a095" class="pw-post-body-paragraph kr ks ir ku b kv kw js kx ky kz jv la lp lc ld le lq lg lh li lr lk ll lm ln ik bi translated">正如你所看到的，上面的例子在<code class="fe ls lt lu lv b">conditions</code>字段中显示了一个“NamespaceDeletionDiscoveryFailure ”,消息是“<strong class="ku is">/APIs/metrics . k8s . io/v1beta 1”</strong>服务器上找不到资源。</p><p id="7001" class="pw-post-body-paragraph kr ks ir ku b kv kw js kx ky kz jv la lp lc ld le lq lg lh li lr lk ll lm ln ik bi translated">其他可能的错误有:</p><pre class="kh ki kj kk gu lw lv lx ly aw lz bi"><span id="27eb" class="ma mb ir lv b gz mc md l me mf">spec:<br/>  finalizers:<br/>  - kubernetes<br/>...<br/>- lastTransitionTime: "2022-01-19T19:05:31Z"<br/> <strong class="lv is">message: 'Some content in the namespace has finalizers remaining: tackles.tackle.io/finalizer in 1 resource instances'<br/> reason: SomeFinalizersRemain<br/> </strong>status: "True"<br/> type: NamespaceFinalizersRemaining</span></pre><p id="7dff" class="pw-post-body-paragraph kr ks ir ku b kv kw js kx ky kz jv la lp lc ld le lq lg lh li lr lk ll lm ln ik bi translated">或者</p><pre class="kh ki kj kk gu lw lv lx ly aw lz bi"><span id="df23" class="ma mb ir lv b gz mc md l me mf">spec:<br/>  finalizers:<br/>  - kubernetes<br/>...<br/>- lastTransitionTime: "2022-01-19T19:05:31Z"<br/> <strong class="lv is">message: 'unable to retrieve the complete list of server APIs: custom.metrics.k8s.io/v1beta1: the server is currently unable to handle the request'<br/> reason: SomeFinalizersRemain<br/></strong> status: "True"<br/> type: NamespaceFinalizersRemaining</span></pre><p id="46d1" class="pw-post-body-paragraph kr ks ir ku b kv kw js kx ky kz jv la lp lc ld le lq lg lh li lr lk ll lm ln ik bi translated">注意，在上面的输出中，这些名称空间有一个在<code class="fe ls lt lu lv b">spec</code>下定义的<code class="fe ls lt lu lv b">finalizer</code>。在 K8s 中，<code class="fe ls lt lu lv b">finalizer</code>是一个特殊的元数据键，它告诉 K8s 在完全删除一个资源之前等待，直到满足特定的条件。</p><p id="6657" class="pw-post-body-paragraph kr ks ir ku b kv kw js kx ky kz jv la lp lc ld le lq lg lh li lr lk ll lm ln ik bi translated">因此，当您运行类似于<code class="fe ls lt lu lv b">kubectl delete namespace</code>的命令时，K8s 会检查<code class="fe ls lt lu lv b">metadata.finalizers</code>字段中的<code class="fe ls lt lu lv b">finalizer</code>。如果<code class="fe ls lt lu lv b">finalizer</code>中定义的资源由于某种原因无法删除，那么<code class="fe ls lt lu lv b">namespace</code>也不会被删除。这将<code class="fe ls lt lu lv b">namespace</code>置于终止状态，等待资源的移除，这永远不会发生。</p><h1 id="9aff" class="mg mb ir bd mh mi mj mk ml mm mn mo mp jx mq jy mr ka ms kb mt kd mu ke mv mw bi translated">第二步:识别未删除的资源</h1><p id="758e" class="pw-post-body-paragraph kr ks ir ku b kv mx js kx ky my jv la lp mz ld le lq na lh li lr nb ll lm ln ik bi translated">一旦您找到了<code class="fe ls lt lu lv b">namespace</code>未被删除的原因，您应该尝试解决该问题，以下是一些推荐步骤:</p><ul class=""><li id="2803" class="nc nd ir ku b kv kw ky kz lp ne lq nf lr ng ln nh ni nj nk bi translated">查找未删除的资源:</li></ul><pre class="kh ki kj kk gu lw lv lx ly aw lz bi"><span id="77ba" class="ma mb ir lv b gz mc md l me mf">$ kubectl api-resources --verbs=list --namespaced -o name | xargs -n 1 kubectl get --show-kind --ignore-not-found -n &lt;namespace-name&gt;</span></pre><ul class=""><li id="043f" class="nc nd ir ku b kv kw ky kz lp ne lq nf lr ng ln nh ni nj nk bi translated">如果之前的命令返回以下错误消息:<code class="fe ls lt lu lv b">unable to retrieve the complete list of server APIs: &lt;api-resource&gt;/&lt;version&gt;: the server is currently unable to handle the request</code>，请使用您收到的信息继续运行以下命令:</li></ul><pre class="kh ki kj kk gu lw lv lx ly aw lz bi"><span id="78d2" class="ma mb ir lv b gz mc md l me mf">$ kubectl get APIService &lt;version&gt;.&lt;api-resource&gt;</span></pre><ul class=""><li id="6d24" class="nc nd ir ku b kv kw ky kz lp ne lq nf lr ng ln nh ni nj nk bi translated">描述 API 服务以继续故障排除:</li></ul><pre class="kh ki kj kk gu lw lv lx ly aw lz bi"><span id="6ac0" class="ma mb ir lv b gz mc md l me mf">$ kubectl describe APIService &lt;version&gt;.&lt;api-resource&gt;</span></pre><ul class=""><li id="6dbe" class="nc nd ir ku b kv kw ky kz lp ne lq nf lr ng ln nh ni nj nk bi translated">确保问题得到解决，然后检查<code class="fe ls lt lu lv b">namespace</code>是否被删除。</li></ul><h1 id="5f59" class="mg mb ir bd mh mi mj mk ml mm mn mo mp jx mq jy mr ka ms kb mt kd mu ke mv mw bi translated">第三步:强制删除名称空间</h1><p id="89a1" class="pw-post-body-paragraph kr ks ir ku b kv mx js kx ky my jv la lp mz ld le lq na lh li lr nb ll lm ln ik bi translated">如果<code class="fe ls lt lu lv b">namespace</code>仍然处于“终止”状态或者无法解决 API 资源问题，可以尝试强制删除<code class="fe ls lt lu lv b">namespace</code>。</p><ul class=""><li id="4bb5" class="nc nd ir ku b kv kw ky kz lp ne lq nf lr ng ln nh ni nj nk bi translated">将命名空间的内容转储到临时 JSON 文件中:</li></ul><pre class="kh ki kj kk gu lw lv lx ly aw lz bi"><span id="8cca" class="ma mb ir lv b gz mc md l me mf">$ kubectl get namespace &lt;terminating-namespace&gt; -o json &gt; tmp.json</span><span id="36e9" class="ma mb ir lv b gz nl md l me mf">$ cat tmp.json<br/>{<br/>    "apiVersion": "v1",<br/>    "kind": "Namespace",<br/>    "metadata": {<br/>        ...<br/>    },<br/>    "spec": {<br/>        "finalizers": [<br/>            "kubernetes"<br/>        ]<br/>    },<br/>    "status": {<br/>        "conditions": [<br/>            {<br/>                "lastTransitionTime": "2022-09-02T15:00:12Z",<br/>                "message": "Discovery failed for some groups, 1 failing: unable to retrieve the complete list of server APIs: metrics.k8s.io/v1beta1: an error on the server (\"Internal Server Error: \\\"/apis/metrics.k8s.io/v1beta1\\\": the server could not find the requested resource\") has prevented the request from succeeding",<br/>                "reason": "DiscoveryFailed",<br/>                "status": "True",<br/>                "type": "NamespaceDeletionDiscoveryFailure"<br/>            }<br/>        ],<br/>        "phase": "Terminating"<br/>    }<br/>}</span></pre><ul class=""><li id="51d1" class="nc nd ir ku b kv kw ky kz lp ne lq nf lr ng ln nh ni nj nk bi translated">编辑您的<code class="fe ls lt lu lv b">tmp.json</code>文件。从<code class="fe ls lt lu lv b">finalizers</code>字段中删除<code class="fe ls lt lu lv b">kubernetes</code>值并保存文件。</li></ul><pre class="kh ki kj kk gu lw lv lx ly aw lz bi"><span id="da0e" class="ma mb ir lv b gz mc md l me mf">$ cat tmp.json<br/>{<br/>    "apiVersion": "v1",<br/>    "kind": "Namespace",<br/>    "metadata": {<br/>        ...<br/>    },<br/>    "spec": {<br/>        "finalizers": []<br/>    },<br/>    "status": {<br/>        "phase": "Terminating"<br/>    }<br/>}</span></pre><ul class=""><li id="e693" class="nc nd ir ku b kv kw ky kz lp ne lq nf lr ng ln nh ni nj nk bi translated">设置临时代理 IP 和端口，确保您的终端窗口保持打开，直到您删除卡住的名称空间:</li></ul><pre class="kh ki kj kk gu lw lv lx ly aw lz bi"><span id="0374" class="ma mb ir lv b gz mc md l me mf">$ kubectl proxy<br/>...<br/>Starting to serve on 127.0.0.1:8001</span></pre><ul class=""><li id="3721" class="nc nd ir ku b kv kw ky kz lp ne lq nf lr ng ln nh ni nj nk bi translated">打开一个新的终端窗口，运行以下命令:</li></ul><pre class="kh ki kj kk gu lw lv lx ly aw lz bi"><span id="790b" class="ma mb ir lv b gz mc md l me mf">$ curl -k -H "Content-Type: application/json" -X PUT --data-binary @tmp.json http://127.0.0.1:8001/api/v1/namespaces/&lt;namespace&gt;/finalize</span></pre><ul class=""><li id="9dfe" class="nc nd ir ku b kv kw ky kz lp ne lq nf lr ng ln nh ni nj nk bi translated">验证终止命名空间是否已删除:</li></ul><pre class="kh ki kj kk gu lw lv lx ly aw lz bi"><span id="0c1e" class="ma mb ir lv b gz mc md l me mf">$ <!-- -->kubectl get namespaces</span></pre><h2 id="dcfe" class="ma mb ir bd mh nm nn dn ml no np dp mp lp nq nr mr lq ns nt mt lr nu nv mv nw bi translated">单线版本</h2><p id="f2eb" class="pw-post-body-paragraph kr ks ir ku b kv mx js kx ky my jv la lp mz ld le lq na lh li lr nb ll lm ln ik bi translated">如果上面的<code class="fe ls lt lu lv b">tmp.json</code>文件不起作用，还有一个单行命令:</p><pre class="kh ki kj kk gu lw lv lx ly aw lz bi"><span id="6560" class="ma mb ir lv b gz mc md l me mf">$ <!-- -->kubectl patch ns &lt;Namespace_to_delete&gt; -p '{"metadata":{"finalizers":null}}'</span></pre><h1 id="b2a5" class="mg mb ir bd mh mi mj mk ml mm mn mo mp jx mq jy mr ka ms kb mt kd mu ke mv mw bi translated">结论</h1><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="ny nz di oa bf ob"><div class="gi gj nx"><img src="../Images/1cfac03ddd3d72a37f341cfb47dc99dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pPc0jv0a-ri_ow9Xxg76JQ.png"/></div></div></figure></div></div>    
</body>
</html>