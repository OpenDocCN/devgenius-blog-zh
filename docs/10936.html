<html>
<head>
<title>How to use DVC in Azure Blob Storage</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在 Azure Blob 存储中使用 DVC</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/how-to-use-dvc-in-azure-blob-storage-acdf130bab38?source=collection_archive---------5-----------------------#2022-12-08">https://blog.devgenius.io/how-to-use-dvc-in-azure-blob-storage-acdf130bab38?source=collection_archive---------5-----------------------#2022-12-08</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><blockquote class="jk jl jm"><p id="6576" class="jn jo jp jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ig bi translated"><strong class="jq io"> <em class="in">内容:</em>T3】</strong></p><p id="3d5c" class="jn jo jp jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ig bi translated"><strong class="jq io"> —一、简介</strong></p><p id="e580" class="jn jo jp jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ig bi translated"><strong class="jq io"> —二。使用 DVC 和 Azure Blob 存储进行数据版本控制</strong></p><p id="25c3" class="jn jo jp jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ig bi translated"><strong class="jq io"> — — — 1。设置 Azure Blob 存储</strong></p><p id="0dfc" class="jn jo jp jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ig bi translated"><strong class="jq io">————( 1)建立 Azure Blob 存储</strong></p><p id="7142" class="jn jo jp jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ig bi translated"><strong class="jq io">————( 2)创建一个 Azure 存储容器</strong></p><p id="1c42" class="jn jo jp jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ig bi translated"><strong class="jq io">————( 3)创建一个 SAS 令牌</strong></p><p id="f6bc" class="jn jo jp jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ig bi translated"><strong class="jq io">———( 4)设置账户和容器的访问控制</strong></p><p id="a99a" class="jn jo jp jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ig bi translated"><strong class="jq io"> — — — 2。设置项目</strong></p><p id="fee9" class="jn jo jp jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ig bi translated"><strong class="jq io"> — — — 3。DVC 与蓝色集装箱的互动</strong></p></blockquote></div><div class="ab cl km kn hr ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ig ih ii ij ik"><h1 id="2b46" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">一.导言</h1><p id="fcfe" class="pw-post-body-paragraph jn jo in jq b jr lr jt ju jv ls jx jy lt lu kb kc lv lw kf kg lx ly kj kk kl ig bi translated">数据版本控制(DVC)是一个数据版本控制工具。DVC 的想法是为数据创建一个类似 Git 的版本控制系统。</p><p id="7eeb" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy lt ka kb kc lv ke kf kg lx ki kj kk kl ig bi translated">DVC 对数据大小没有限制，因为它不在服务器上存储数据。相反，使用 DVC，您可以将数据存储在首选的存储单元中，如亚马逊 S3、Azure Blob 存储等。DVC 会自动保存一个很轻的文件，这样你就知道你的数据保存在哪里了。</p><p id="cb7d" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy lt ka kb kc lv ke kf kg lx ki kj kk kl ig bi translated">这篇博客旨在介绍使用 DVC 在 Microsoft Azure Blob 存储上对大型数据集进行版本化的完整过程。</p></div><div class="ab cl km kn hr ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ig ih ii ij ik"><h1 id="a1c8" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">二。使用 DVC 和 Azure Blob 存储进行数据版本控制</h1><h2 id="47cf" class="lz ku in bd kv ma mb dn kz mc md dp ld lt me mf lh lv mg mh ll lx mi mj lp mk bi translated">1.设置 Azure Blob 存储</h2><p id="c139" class="pw-post-body-paragraph jn jo in jq b jr lr jt ju jv ls jx jy lt lu kb kc lv lw kf kg lx ly kj kk kl ig bi translated"><strong class="jq io"> (1)创建一个 Azure 存储帐户</strong></p><p id="3fd1" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy lt ka kb kc lv ke kf kg lx ki kj kk kl ig bi translated">我们假设您已经有一个 Azure 帐户。像我，我创建一个免费账户一个月。</p><p id="b1b2" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy lt ka kb kc lv ke kf kg lx ki kj kk kl ig bi translated">登录 Azure 账号，选择<strong class="jq io">创建资源</strong> - &gt;搜索<strong class="jq io">存储账号</strong> - &gt;点击<strong class="jq io">创建</strong>按钮。</p><p id="256e" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy lt ka kb kc lv ke kf kg lx ki kj kk kl ig bi translated">用户界面会要求你在几个部分填写一些信息。在我的例子中，我将<strong class="jq io">资源组</strong>设置为<em class="jp">azure _ DVC _ demo _ Resource</em>，将<strong class="jq io">存储帐户名</strong>设置为<em class="jp"> azuredvcdemoaccount </em>，并将所有其他设置保留为默认设置。请查看下图，以供参考。</p><figure class="mm mn mo mp gt mq gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi ml"><img src="../Images/3fded5afb6c9414f8e72398f7a62cde6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FICFBJsfDSkTL0VBEnK2tw.png"/></div></div></figure><p id="da3e" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy lt ka kb kc lv ke kf kg lx ki kj kk kl ig bi translated">Azure 将检查所有设置并部署帐户。完成后，您将看到下面的消息，显示<strong class="jq io">您的部署已完成</strong>。接下来，单击<strong class="jq io">转到资源</strong>按钮创建一个容器。</p><figure class="mm mn mo mp gt mq gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi mx"><img src="../Images/ba31820e24c32e3d5323247c0e5585c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vfeCkmR1I59eBm7E_5ABGw.png"/></div></div></figure><p id="1e60" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy lt ka kb kc lv ke kf kg lx ki kj kk kl ig bi translated"><strong class="jq io"> (2)创建一个 Azure 存储容器</strong></p><p id="d1a4" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy lt ka kb kc lv ke kf kg lx ki kj kk kl ig bi translated">按照下图中的步骤 1–3 创建容器。</p><figure class="mm mn mo mp gt mq gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi my"><img src="../Images/bfe5cdfe456a697f42690aa80913d48b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IfSPjPzy7heA8W17gqkeGA.png"/></div></div></figure><p id="421a" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy lt ka kb kc lv ke kf kg lx ki kj kk kl ig bi translated">Azure 将检查设置并部署容器。然后，点击容器-&gt;点击<strong class="jq io">属性</strong> - &gt;复制<strong class="jq io">名称</strong>和<strong class="jq io"> URL </strong>以备后用。</p><figure class="mm mn mo mp gt mq gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi mz"><img src="../Images/8cf1b8ef95c8d6a0a8deb0fe39d21502.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-O2KFB7rC3NyXQdyw_adbQ.png"/></div></div></figure><p id="13cb" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy lt ka kb kc lv ke kf kg lx ki kj kk kl ig bi translated"><strong class="jq io"> (3)创建一个 SAS 令牌</strong></p><p id="3c1a" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy lt ka kb kc lv ke kf kg lx ki kj kk kl ig bi translated">a.进入 Azure 门户，导航<strong class="jq io">你的存储帐户</strong> - &gt; <strong class="jq io">容器</strong> - &gt; <strong class="jq io">你的容器</strong>。</p><p id="4db9" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy lt ka kb kc lv ke kf kg lx ki kj kk kl ig bi translated">b.在<strong class="jq io">签名方法</strong>部分选择<strong class="jq io">共享访问令牌</strong> - &gt;，<strong class="jq io">选择用户委托密钥</strong>。</p><p id="5aa0" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy lt ka kb kc lv ke kf kg lx ki kj kk kl ig bi translated">c.在<strong class="jq io">权限部分</strong> - &gt;选择<strong class="jq io">读取</strong>，<strong class="jq io">写入</strong>，<strong class="jq io">删除</strong>，<strong class="jq io">列出</strong>权限。</p><p id="7f47" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy lt ka kb kc lv ke kf kg lx ki kj kk kl ig bi translated">d.根据您的喜好指定签名密钥<strong class="jq io">开始</strong>和<strong class="jq io">到期</strong>的时间。</p><p id="cdfd" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy lt ka kb kc lv ke kf kg lx ki kj kk kl ig bi translated">e.将<strong class="jq io">允许的 IP 地址</strong>留空，因为这是可选的。</p><p id="059a" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy lt ka kb kc lv ke kf kg lx ki kj kk kl ig bi translated">f.<strong class="jq io">允许的协议</strong>也是可选的，我将其保留为默认设置。</p><p id="f2fa" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy lt ka kb kc lv ke kf kg lx ki kj kk kl ig bi translated">g.点击<strong class="jq io">生成 SAS 令牌和 URL </strong></p><p id="c87f" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy lt ka kb kc lv ke kf kg lx ki kj kk kl ig bi translated">h.将<strong class="jq io"> Blob SAS 令牌</strong>和<strong class="jq io"> Blob SAS URL </strong>值复制并粘贴到安全位置。</p><figure class="mm mn mo mp gt mq gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi na"><img src="../Images/ff325e9bb12a81fe19fee5d06f23b1b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z_1OGoNPbHBpnwPhqUA-xA.png"/></div></div></figure><p id="428b" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy lt ka kb kc lv ke kf kg lx ki kj kk kl ig bi translated">请阅读<a class="ae nb" href="https://learn.microsoft.com/en-us/azure/applied-ai-services/form-recognizer/create-sas-tokens?view=form-recog-3.0.0" rel="noopener ugc nofollow" target="_blank">官方文档</a>以供参考。</p><p id="53d5" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy lt ka kb kc lv ke kf kg lx ki kj kk kl ig bi translated"><strong class="jq io"> (4)设置访问控制</strong></p><p id="06fb" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy lt ka kb kc lv ke kf kg lx ki kj kk kl ig bi translated"><strong class="jq io"> ===为 Azure 帐户设置正确的角色</strong></p><p id="d9f8" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy lt ka kb kc lv ke kf kg lx ki kj kk kl ig bi translated">a.导航到您的帐户主页</p><p id="5c52" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy lt ka kb kc lv ke kf kg lx ki kj kk kl ig bi translated">b.点击<strong class="jq io">访问控制(IAM) </strong></p><p id="b6dc" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy lt ka kb kc lv ke kf kg lx ki kj kk kl ig bi translated">c.点击<strong class="jq io">添加</strong>-&gt;-<strong class="jq io">添加分配角色</strong></p><p id="a13c" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy lt ka kb kc lv ke kf kg lx ki kj kk kl ig bi translated">d.搜索<strong class="jq io"> Azure Blob 数据贡献者</strong>，点击下一个&gt;</p><p id="3489" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy lt ka kb kc lv ke kf kg lx ki kj kk kl ig bi translated">e.选择<strong class="jq io">用户、组或服务主体</strong>，点击<strong class="jq io">选择成员</strong></p><p id="38e2" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy lt ka kb kc lv ke kf kg lx ki kj kk kl ig bi translated">f.添加<strong class="jq io">会员邮箱</strong>，记得点击<strong class="jq io">选择</strong>。将向该成员发送一封邀请电子邮件，需要该成员接受。</p><p id="d458" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy lt ka kb kc lv ke kf kg lx ki kj kk kl ig bi translated">g.您可以通过点击<strong class="jq io">查看我的权限</strong>或<strong class="jq io">查看您成员的权限</strong>来查看权限。</p><p id="6446" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy lt ka kb kc lv ke kf kg lx ki kj kk kl ig bi translated">查看以下流程:</p><figure class="mm mn mo mp gt mq gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi nc"><img src="../Images/d50fc7db41577128ff00cdea5e4293c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WDWdUV4snf1Ze9d5v3-dOQ.png"/></div></div></figure><p id="0bd2" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy lt ka kb kc lv ke kf kg lx ki kj kk kl ig bi translated"><strong class="jq io"> ===为 Azure 容器设置正确的角色</strong></p><p id="40e6" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy lt ka kb kc lv ke kf kg lx ki kj kk kl ig bi translated">导航到您的容器主页，按照上述相同的步骤为您和您的成员选择合适的角色。</p><h2 id="9df2" class="lz ku in bd kv ma mb dn kz mc md dp ld lt me mf lh lv mg mh ll lx mi mj lp mk bi translated">2.设置项目</h2><p id="91f1" class="pw-post-body-paragraph jn jo in jq b jr lr jt ju jv ls jx jy lt lu kb kc lv lw kf kg lx ly kj kk kl ig bi translated">我<strong class="jq io">推荐</strong>你从头开始走一遍这些步骤，为此，你需要创建一个项目，其结构如下图所示。</p><p id="1703" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy lt ka kb kc lv ke kf kg lx ki kj kk kl ig bi translated">也可以克隆<a class="ae nb" href="https://github.com/purplebear-cai/azure_dvc" rel="noopener ugc nofollow" target="_blank">项目</a>；结构如下图所示。</p><figure class="mm mn mo mp gt mq gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi nd"><img src="../Images/a3fec6ff037dce455d805a4cbc2109ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IU7iM2FVIiteJPvw2XAGYg.png"/></div></div></figure><h2 id="d029" class="lz ku in bd kv ma mb dn kz mc md dp ld lt me mf lh lv mg mh ll lx mi mj lp mk bi translated">3.DVC 与 Azure 容器的互动</h2><p id="9884" class="pw-post-body-paragraph jn jo in jq b jr lr jt ju jv ls jx jy lt lu kb kc lv lw kf kg lx ly kj kk kl ig bi translated">然后按照下面的命令将数据上传到 Azure Blob 容器，并将项目提交到 GitHub。</p><p id="942d" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy lt ka kb kc lv ke kf kg lx ki kj kk kl ig bi translated">您可以定义环境变量以备将来使用。所需的环境包括:</p><ul class=""><li id="e463" class="ne nf in jq b jr js jv jw lt ng lv nh lx ni kl nj nk nl nm bi translated">导出帐户名称=您的 AZURE 帐户名称</li><li id="10d2" class="ne nf in jq b jr nn jv no lt np lv nq lx nr kl nj nk nl nm bi translated">导出容器名称=您的 AZURE 容器名称</li><li id="7445" class="ne nf in jq b jr nn jv no lt np lv nq lx nr kl nj nk nl nm bi translated">导出容器 URL =您的 AZURE 容器 URL</li><li id="8df3" class="ne nf in jq b jr nn jv no lt np lv nq lx nr kl nj nk nl nm bi translated">导出 BLOB_SAS_TOKEN =您的 BLOB _ SAS _ TOKEN</li></ul><p id="c7b4" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy lt ka kb kc lv ke kf kg lx ki kj kk kl ig bi translated">如果您使用 Mac，请在~/中定义环境变量。bash_profile，并且记得运行<em class="jp"> source ~/。bash_profile </em>。出口</p><p id="9d86" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy lt ka kb kc lv ke kf kg lx ki kj kk kl ig bi translated">a.初始化项目和数据版本</p><pre class="mm mn mo mp gt ns nt nu bn nv nw bi"><span id="1f61" class="nx ku in nt b be ny nz l oa ob">#=======================================<br/># Navigate to the project folder<br/>cd azure_dvc<br/><br/># Initialize git and dvc<br/>git init<br/>dvc init<br/>git commit -m "initialize repo"<br/><br/># Set up the DVC remote<br/>dvc remote add -d dvc-remote $CONTAINER_URL<br/>dvc remote modify dvc-remote url azure://$CONTAINER_NAME/<br/>dvc remote modify dvc-remote account_name $ACCOUNT_NAME<br/>dvc remote modify dvc-remote connection_string "AccountName=$ACCOUNT_NAME;SharedAccessSignature=$BLOB_SAS_TOKEN"<br/><br/># Data versioning with DVC<br/>dvc add data/wine-quality.csv<br/>git add data/.gitignore data/wine-quality.csv.dvc<br/>git commit -m "Track data"<br/>git tag -a "v1" -m "V1: raw data"<br/>git commit .dvc/config -m "configure remote storage"<br/><br/># Push and remove unnecessary files<br/>dvc push<br/>rm -rf data/wine-quality.csv<br/>rm -rf .dvc/cahce<br/><br/># Upload local project to github<br/>git remote add origin QUICK_SETUP_URL # if this is the first time you commit changes to the repository<br/>git push -u origin main</span></pre><p id="cb98" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy lt ka kb kc lv ke kf kg lx ki kj kk kl ig bi translated">b.更改数据并跟踪不同的版本</p><pre class="mm mn mo mp gt ns nt nu bn nv nw bi"><span id="94ec" class="nx ku in nt b be ny nz l oa ob"># Pull the original data<br/>dvc pull<br/><br/># Delete the first 1000 lines data from original CSV file<br/>sed '2,1001d' data/wine-quality.csv &gt; data/wine-quality-tmp.csv &amp;&amp; mv data/wine-quality-tmp.csv data/wine-quality.csv<br/><br/># Track the new data<br/>dvc add data/wine-quality.csv<br/>git add data/wine-quality.csv.dvc<br/>git commit -m "data: remove 1000 lines"<br/>git tag -a "v2" -m "remove 1000 lines"<br/>dvc push<br/>rm -rf data/wine-quality.csv<br/>rm -rf .dvc/cache</span></pre><p id="4740" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy lt ka kb kc lv ke kf kg lx ki kj kk kl ig bi translated">c.使用不同版本的数据训练模型，并使用 MLflow 进行实验跟踪</p><pre class="mm mn mo mp gt ns nt nu bn nv nw bi"><span id="2adb" class="nx ku in nt b be ny nz l oa ob"># Train a model with version v5 (you can specify the version with your preference)<br/>python train.py --path data/wine-quality.csv --repo YOUR_PROJECT_PATH --rev v5 --remote YOUR_CONTAINER_URL<br/><br/># Train a model with a different version v6<br/>python train.py --path data/wine-quality.csv --repo YOUR_PROJECT_PATH --rev v6 --remote YOUR_CONTAINER_URL<br/><br/># Run MLflow UI<br/>mlflow ui</span></pre><p id="f8b5" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy lt ka kb kc lv ke kf kg lx ki kj kk kl ig bi translated">如果你能毫无差错的完成整个过程，恭喜你！如果有什么问题或者改进建议，欢迎给我留言。感谢您的阅读！如果您对未来的更新感兴趣，请订阅。😄</p></div></div>    
</body>
</html>