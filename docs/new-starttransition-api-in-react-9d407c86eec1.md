# React ä¸­çš„æ–° startTransition API

> åŸæ–‡ï¼š<https://blog.devgenius.io/new-starttransition-api-in-react-9d407c86eec1?source=collection_archive---------11----------------------->

![](img/fa2519eb022af6a471273dec6c5c3468.png)

# ä»€ä¹ˆæ˜¯è¿‡æ¸¡ï¼Ÿ

è½¬æ¢æ˜¯ React ä¸­çš„ä¸€ä¸ªæ–°æ¦‚å¿µï¼Œç”¨äºåŒºåˆ†ç´§æ€¥æ›´æ–°å’Œéç´§æ€¥æ›´æ–°ã€‚

*   **ç´§æ€¥æ›´æ–°**åæ˜ ç›´æ¥äº¤äº’ï¼Œæ¯”å¦‚æ‰“å­—ã€ç‚¹å‡»ã€æŒ‰å‹ç­‰ç­‰ã€‚
*   **è½¬æ¢æ›´æ–°**å°†ç”¨æˆ·ç•Œé¢ä»ä¸€ä¸ªè§†å›¾è½¬æ¢åˆ°å¦ä¸€ä¸ªè§†å›¾ã€‚

åƒæ‰“å­—ã€ç‚¹å‡»ã€æŒ‰é”®è¿™æ ·çš„ç´§æ€¥æ›´æ–°éœ€è¦**å³æ—¶**å“åº”ï¼Œä»¥ç¬¦åˆæˆ‘ä»¬å¯¹ç‰©ç†å¯¹è±¡è¡Œä¸ºçš„ç›´è§‰ã€‚å¦åˆ™ä»–ä»¬ä¼šè§‰å¾—**ã€ä¸å¯¹ã€‘**ã€‚ç„¶è€Œï¼Œ**è½¬æ¢**æ˜¯ä¸åŒçš„ï¼Œå› ä¸ºç”¨æˆ·ä¸æœŸæœ›åœ¨å±å¹•ä¸Šçœ‹åˆ°æ¯ä¸ªä¸­é—´å€¼ã€‚

ä¾‹å¦‚ï¼Œå½“æ‚¨åœ¨æœç´¢æ¡†ä¸­é”®å…¥å†…å®¹æ—¶ï¼Œæ‚¨å¸Œæœ›è¾“å…¥å­—æ®µæœ¬èº«åšå‡ºå“åº”ï¼Œå¹¶åœ¨æ‚¨æŒ‰é”®æ—¶ç«‹å³æ˜¾ç¤ºé”®å…¥çš„å­—ç¬¦**ã€‚ç„¶è€Œï¼Œå®é™…ç»“æœå¯èƒ½ä¼šåˆ†åˆ«è¿‡æ¸¡åˆ°**å’Œ**ï¼Œé€šå¸¸ä¼šæœ‰å°çš„å»¶è¿Ÿã€‚å¦‚æœæ‚¨åœ¨ç»“æœæ¸²æŸ“å®Œæˆä¹‹å‰å†æ¬¡æ›´æ”¹æœç´¢è¯ï¼Œæ‚¨åªéœ€è¦æŸ¥çœ‹æœ€æ–°çš„**ç»“æœã€‚****

**åœ¨ React 18 ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`startTransition` API å°†ä»»ä½•çŠ¶æ€æ›´æ–°æ ‡è®°ä¸ºéç´§æ€¥ã€‚**

**åœ¨ä¸‹é¢çš„ä»£ç å—ä¸­ï¼Œæœ‰ä¸¤ä¸ªçŠ¶æ€æ›´æ–°â€”â€”ä¸€ä¸ªæ˜¯ç´§æ€¥çš„ï¼Œå¦ä¸€ä¸ªè¢«æ ‡è®°ä¸ºéç´§æ€¥çš„ï¼Œå› ä¸ºå®ƒè¢«åŒ…è£…åœ¨`startTransition`å›è°ƒä¸­:**

```
import {startTransition} from 'react';

// Urgent: Show what was typed
setInputValue(input);

// Mark any state updates inside as transitions (non-urgent)
startTransition(() => {
  // Transition: Show the results
  setResults(input);
});
```

**å¦‚æœæ›´ç´§æ€¥çš„æ›´æ–°ï¼Œå¦‚ç‚¹å‡»æˆ–æŒ‰é”®ï¼Œéç´§æ€¥æ›´æ–°å°†è¢«**ä¸­æ–­**ã€‚å¦‚æœä¸€ä¸ªè¿‡æ¸¡è¢«ç”¨æˆ·æ‰“æ–­(ä¾‹å¦‚ï¼Œåœ¨ä¸€è¡Œä¸­è¾“å…¥å¤šä¸ªå­—ç¬¦)ï¼ŒReact å°†ä¸¢å¼ƒæ²¡æœ‰å®Œæˆçš„**é™ˆæ—§çš„**æ¸²æŸ“å·¥ä½œï¼Œåªæ¸²æŸ“**æœ€æ–°çš„**æ›´æ–°ã€‚**

# **æ¼”ç¤ºåº”ç”¨ç¨‹åº:æœ‰æ—  startTransition çš„æ€§èƒ½**

**æˆ‘ä»¬æ„å»ºäº†ä¸€ä¸ªç®€å•çš„åº”ç”¨ç¨‹åºæ¥å±•ç¤ºæ–°çš„`startTransition` API çš„å¨åŠ›ã€‚**

**è¿™ä¸ªåº”ç”¨ç¨‹åºåŸºæœ¬ä¸Šæ˜¯ä¸€ä¸ªâ€œæ–‡æœ¬æœç´¢â€ç‰¹æ€§ï¼Œå®ƒä¸ºç”¨æˆ·æä¾›äº†åœ¨ä¸€ä¸ªå¾ˆé•¿çš„æ–‡æœ¬å—(åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­å¤§çº¦æœ‰ 60000 ä¸ªå­—ç¬¦)ä¸­æœç´¢ä¸€ä¸ªæœ¯è¯­çš„èƒ½åŠ›ã€‚**

**æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºéœ€è¦æä¾›ä¸¤ä¸ªç‰¹æ€§:**

*   **å‘ˆç°ä¸€ä¸ª**è¾“å…¥**ï¼Œå…è®¸ç”¨æˆ·é”®å…¥ä¸€ä¸ª**æœç´¢**é¡¹ã€‚**
*   **å¯¹**çªå‡ºæ˜¾ç¤º**ä»»ä½•ä¸è¾“å…¥çš„æœç´¢è¯åŒ¹é…(ä¸åŒºåˆ†å¤§å°å†™)çš„å­—ç¬¦ã€‚**

**æˆ‘ä»¬ç”¨æ¥è·å¾—åŒ¹é…é¡¹çš„ç®€å•ç®—æ³•æ˜¯:**

1.  **ä»**æœç´¢è¯**æ„å»ºä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼Œå®ƒå°†åŒ¹é…ä»»ä½•å­—ç¬¦(ä¸åŒºåˆ†å¤§å°å†™)ã€‚**
2.  **å°†`highlight`ç±»æ·»åŠ åˆ°åŒ¹é…å­—ç¬¦çš„æ‰€æœ‰*è·¨åº¦*ä¸­ã€‚**

**`applyFilter`åŠŸèƒ½çš„ä»£ç å¦‚ä¸‹æ‰€ç¤º:**

```
const applyFilter = (query, setFilteredNode) => {
  setFilteredNode(() => {
    if (!query || query.trim().length === 0) {
      return INITIAL_VALUE;
    }

    const regex = new RegExp(
      query.trim().replace(/[-[\]{}()*+?.,\\^$|#\s]/g, "\\$&"),
      "ig"
    );

    const node = TEXT.replaceAll(regex, (s) => `##${s}##`)
      .split("##")
      .map((s, i) => (
        <span key={i} className={i % 2 === 1 ? "highlight" : ""}>
          {s}
        </span>
      ));

    return node;
  });
};
```

**æ˜¾ç„¶ï¼Œæˆ‘ä»¬å¯ä»¥æå‡ºæ›´ä¼˜åŒ–çš„ç®—æ³•â€”â€”è¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼ä¸¥é‡å½±å“äº†æ€§èƒ½â€”â€”ä½†æ˜¯æˆ‘ä»¬åœ¨è¿™é‡Œçš„ä»»åŠ¡æ˜¯â€œåˆ›å»ºâ€ä¸€ä¸ªå¯¼è‡´å¤§é‡ React çŠ¶æ€æ›´æ–°çš„é«˜æˆæœ¬å‡½æ•°ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥çœ‹åˆ°`startTransition` API æ˜¯å¦ä¼šæ”¹å–„è¿™ç§æƒ…å†µã€‚**

****ä½ å¯ä»¥åœ¨è¿™é‡Œ** **æ‰¾åˆ° app** [**çš„æ‰€æœ‰ä»£ç ã€‚**](https://codesandbox.io/s/react-18-starttransition-demo-s2bvxy?file=/src/App.js)**

# **ç¬¬ä¸€æ¬¡å®æ–½:æœªä¼˜åŒ–ï¼Œæ²¡æœ‰å¼€å§‹è¿‡æ¸¡**

**æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªå®ç°æ˜¯ä¸€ä¸ªå…·æœ‰ä¸¤ä¸ªç®€å•çŠ¶æ€æ›´æ–°çš„ç»„ä»¶ï¼Œä¸€ä¸ªç”¨äºè¾“å…¥å€¼ï¼Œå¦ä¸€ä¸ªå°†åº”ç”¨è¿‡æ»¤åçš„ç»“æœã€‚æ¯å½“è¾“å…¥å€¼æ”¹å˜æ—¶ï¼Œå‡½æ•°`applyFilter`å°†è¢«è°ƒç”¨ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸¤ç§çŠ¶æ€æ›´æ–°éƒ½æ ‡è®°ä¸ºç´§æ€¥:**

```
import {useState} from 'react';

const Unoptimized = () => {
  const [query, setQuery] = useState("");
  const [filteredNode, setFilteredNode] = useState(INITIAL_VALUE);

  const onInputChange = (e) => setQuery(e.target.value);

  useEffect(() => {
    applyFilter(query, setFilteredNode);
  }, [query]);

  return (
    <>
      <div className="input">
        <input onChange={onInputChange} />
      </div>
      <div className="text">{filteredNode}</div>
    </>
  );
};
```

****æœªä¼˜åŒ–****

**æ‚¨å¯ä»¥çœ‹åˆ°å­—ç¬¦æ²¡æœ‰ç«‹å³æ˜¾ç¤ºåœ¨è¾“å…¥å­—æ®µä¸­ï¼Œç”¨æˆ·ç•Œé¢æ„Ÿè§‰æœ‰ç‚¹â€œæ…¢â€:**

**![](img/e274526fa1303d24999708c6bf04f0fe.png)**

****æœªä¼˜åŒ–ï¼ŒCPU é€Ÿåº¦é™ä½ 4 å€****

**æˆ‘ä»¬åº”ç”¨äº† 4 å€çš„ CPU å‡é€Ÿ(æ¥è‡ª Chrome dev tools)æ¥æ›´å¥½åœ°æ¨¡æ‹Ÿæ™®é€š CPU æˆ–ç§»åŠ¨è®¾å¤‡ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œç”¨æˆ·ç•Œé¢è‚¯å®šæ„Ÿè§‰å¾ˆæ…¢ï¼Œä¸€ç‚¹ä¹Ÿä¸æµç•…:**

**![](img/efd1ace0723630fc26014d18115e9a15.png)****![](img/ffc7aefd0cb1bbd97d749ef99fcddf3c.png)**

# **ç¬¬äºŒæ¬¡å®æ–½:ä½¿ç”¨ startTransition ä¼˜åŒ–**

**åœ¨æˆ‘ä»¬çš„ç¬¬äºŒä¸ªå®ç°ä¸­ï¼Œæˆ‘ä»¬åˆ©ç”¨äº†`startTransition` APIã€‚å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†è¿”å›ä¸€ä¸ª`pending`çŠ¶æ€çš„`useTransition`é’©å­â€”â€”æˆ‘ä»¬ä½¿ç”¨è¯¥çŠ¶æ€é€šè¿‡æ¨¡ç³Šå±å¹•å‘ç”¨æˆ·è¡¨æ˜ä¸€ä¸ªè½¬æ¢ä»åœ¨å¤„ç†ä¸­(æˆ‘ä»¬ä¹Ÿå¯ä»¥æ˜¾ç¤ºä¸€ä¸ªåŠ è½½ç¨‹åº)ã€‚**

**æˆ‘ä»¬é€šè¿‡å°†ç»“æœçš„çŠ¶æ€æ›´æ–°å°è£…åœ¨ä¸€ä¸ª`startTransition`å›è°ƒä¸­ï¼Œå°†å®ƒæ ‡è®°ä¸ºéç´§æ€¥:**

```
import {useState, useTransition} from 'react';

const Optimized = () => {
  const [query, setQuery] = useState("");
  const [filteredNode, setFilteredNode] = useState(INITIAL_VALUE);
  const [pending, startTransition] = useTransition();

  const onInputChange = (e) => setQuery(e.target.value);

  useEffect(() => {
    startTransition(() => {
      applyFilter(query, setFilteredNode);
    });
  }, [query, startTransition]);

  return (
    <>
      {pending && <div className="fade" />}
      <div className="input">
        <input onChange={onInputChange} />
      </div>
      <div className="text">{filteredNode}</div>
    </>
  );
};
```

****ä¼˜åŒ–åçš„****

**çœ‹çœ‹å­—ç¬¦åœ¨è¾“å…¥å±å¹•ä¸Šæ˜¾ç¤ºå¾—å¤šå¿«ï¼›å®ƒæ„Ÿè§‰è‡ªç„¶ã€å…‰æ»‘ï¼Œæ˜¯ç”¨æˆ·æ‰€æœŸæœ›çš„ã€‚å½“`pending`å˜é‡ä¸ºçœŸæ—¶ï¼Œæˆ‘ä»¬æ¨¡ç³Šå±å¹•ï¼Œä»¥å‘ç”¨æˆ·æŒ‡ç¤ºè½¬æ¢ä»åœ¨è¿›è¡Œä¸­ã€‚**

**![](img/9f8724508522ab0ebfa89ebecddfbdb7.png)**

****ä¼˜åŒ–äº† CPU 4x å‡é€Ÿ****

**æˆ‘ä»¬ç”šè‡³åº”ç”¨äº† 4 å€çš„ CPU å‡é€Ÿæ¥æ£€æŸ¥ UI å¦‚ä½•å“åº”ã€‚çœ‹èµ·æ¥**ä¸é”™**ï¼Œç”šè‡³åœ¨**é‚£ç§åœºæ™¯ä¸‹**ï¼**

**![](img/cb63645fc54f5e894e2acb99ae63f29c.png)**

# **React 18 ä¹‹å‰çš„æ›¿ä»£è§£å†³æ–¹æ¡ˆï¼Ÿ**

**åœ¨ React 18 ä¹‹å‰æˆ‘ä»¬æ²¡æœ‰`startTransition` APIï¼Œé‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•åœ¨æ—©æœŸ React ç‰ˆæœ¬ä¸­ä¿®å¤å®ƒå‘¢ï¼Ÿ**

**é¢å¯¹æ­¤ç±»é—®é¢˜å¹¶é¿å…å¤§é‡é‡å¤çŠ¶æ€æ›´æ–°çš„æœ€å¸¸è§è§£å†³æ–¹æ¡ˆæ˜¯åˆ©ç”¨**å»æŠ–**æˆ–**èŠ‚æµ**æŠ€æœ¯ã€‚**

**ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªæ£’æäº†çš„ [use-debounce](https://www.npmjs.com/package/use-debounce) åº“ï¼Œå°†ç»“æœçš„é‡çŠ¶æ€æ›´æ–°å°è£…åœ¨ä¸€ä¸ª**de bounce å›è°ƒ**ä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤º:**

```
import {useState} from 'react';
import {useDebouncedCallback} from 'use-debounce';

const Debounced = () => {
  const [query, setQuery] = useState("");
  const [filteredNode, setFilteredNode] = useState(INITIAL_VALUE);

  const onInputChange = (e) => setQuery(e.target.value);

  const debounced = useDebouncedCallback(
    (query, setFilteredNode) => {
       applyFilter(value, setFilteredNode);
    },
    100 // debounce 100 ms
  );  

  useEffect(() => {
    debounced(query, setFilteredNode);
  }, [query, startTransition]);

  return (
    <>
      {pending && <div className="loader" />}
      <div className="input">
        <input onChange={onInputChange} />
      </div>
      <div className="text">{filteredNode}</div>
    </>
  );
};
```

**ä½†æ˜¯è¿™ç§æ–¹æ³•ä»ç„¶æœ‰ä¸€äº›é—®é¢˜ã€‚**

**é¦–å…ˆï¼Œ`applyFilter`å‡½æ•°ä¸èƒ½åœ¨ç”¨æˆ·å®Œæˆè¾“å…¥åçš„ 100 æ¯«ç§’å†…è¢«è°ƒç”¨(æˆ–è€…ä½ é€‰æ‹©çš„ä»»ä½•æ—¶é—´)ã€‚å¦ä¸€æ–¹é¢ï¼Œé€šè¿‡ä½¿ç”¨`startTransition` APIï¼Œç»“æœçš„ç¹é‡å¤„ç†å°½å¿«å¼€å§‹**ï¼Œè€Œä¸å¿…ç­‰å¾…ä»»æ„é•¿çš„æ—¶é—´ã€‚****

****å…¶æ¬¡ï¼Œå³ä½¿æˆ‘ä»¬ä½¿ç”¨èŠ‚æµè€Œä¸æ˜¯å»æŠ–æ¥å°è¯•è§£å†³ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œå¤„ç†ç»“æœçš„å·¥ä½œä¹Ÿæ˜¯**ä¸å¯ä¸­æ–­çš„**ã€‚è¿™æ„å‘³ç€å¦‚æœåœ¨ç»“æœè¿˜åœ¨å¤„ç†çš„æ—¶å€™æœ‰æ–°çš„ç´§æ€¥æ›´æ–°è¿›æ¥(æ¯”å¦‚æŒ‰é”®), UI ä¸å¯é¿å…åœ°ä¼š**æ— å“åº”**ã€‚è€Œä½¿ç”¨`startTransition` APIï¼Œå½“ç´§æ€¥æ›´æ–°åˆ°æ¥æ—¶ï¼Œå¤„ç†å·¥ä½œå°†è¢«**ä¸­æ–­**ï¼Œä»¥è¿™ç§æ–¹å¼ä¿æŒè¾“å…¥åŸŸçš„å“åº”ã€‚****

# ****ç»“æŸäº†****

****æˆ‘å¸Œæœ›ä½ å‘ç°è¿™ç¯‡æ–‡ç« å†…å®¹ä¸°å¯Œã€‚****

****å›å¤´è§ã€‚ğŸ™‚****

*****åŸè½½äº*[*https://tasoskakour.com*](https://tasoskakour.com/blog/react-18-new-api-start-transition)*ã€‚*****