<html>
<head>
<title>Creating Asynchronous Web Requests with Python | Asyncio &amp; Aiohttp</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Python | Asyncio &amp; Aiohttp 创建异步 Web 请求</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/creating-asynchronous-web-requests-with-python-asyncio-aiohttp-d5469d37cc23?source=collection_archive---------6-----------------------#2022-04-25">https://blog.devgenius.io/creating-asynchronous-web-requests-with-python-asyncio-aiohttp-d5469d37cc23?source=collection_archive---------6-----------------------#2022-04-25</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/4895eb8db4137f140230f36f425550f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ighrllk4yFAtawVyEGk5Cg.png"/></div></div></figure><p id="ff91" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">因此，在我的<a class="ae kt" href="https://medium.com/@katchyemma/asyncio-101-writing-asynchronous-python-programs-61b732ca77b1" rel="noopener">上一篇文章</a>中，我谈到了异步是如何加速任务和减少执行时间的。今天，我们的手有点脏。<br/>我们将使用我最喜欢的 API 之一，<a class="ae kt" href="https://avatars.dicebear.com/docs" rel="noopener ugc nofollow" target="_blank"> DiceBear Avatar API </a>。它接受一个种子字符串(实际上是任何随机文本)，并返回一个带有随机特征的个人资料图片。有多种风格可供选择，我们可以微调我们想要看到的功能。<br/>使用<code class="fe ku kv kw kx b">curl</code>的示例用法如下:</p><pre class="ky kz la lb gt lc kx ld le aw lf bi"><span id="3af2" class="lg lh in kx b gy li lj l lk ll">curl -X GET <a class="ae kt" href="https://avatars.dicebear.com/api/big-smile/:seed.png" rel="noopener ugc nofollow" target="_blank">https://avatars.dicebear.com/api/big-smile/:seed.png</a> --output DiceBearAvatar.png</span></pre></div><div class="ab cl lm ln hr lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="ig ih ii ij ik"><p id="183e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们将创建一个 Python 程序来自动化这个过程，并异步生成尽可能多的个人资料图片。为了有一点背景知识，我们将创建该程序的同步版本。</p><p id="9ea8" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">首先，我们需要安装几个库:</p><pre class="ky kz la lb gt lc kx ld le aw lf bi"><span id="5deb" class="lg lh in kx b gy li lj l lk ll">pip install aiohttp requests</span></pre><p id="d0cc" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们将需要一些助手函数，我们将把它们放在<code class="fe ku kv kw kx b">utils.py</code>中。它们将处理像将图像数据写入文件、为 API 调用格式化 URL 以及为我们的程序生成随机字符串这样的事情。</p><pre class="ky kz la lb gt lc kx lt bn lu lv bi"><span id="fc61" class="lw lh in kx b be lx ly l lz ll"># ./utils.py<br/># --------------------------------<br/>import secrets<br/>from os import path<br/><br/>RANDOM_SEED_SIZE = 10<br/><br/>  <br/>def generate_random_seed():<br/> return secrets.token_urlsafe(RANDOM_SEED_SIZE)<br/><br/>def generate_api_url(seed, avatar_style, base_url, extension=".png"):<br/> url = base_url.format(avatar_style=avatar_style, seed=seed+extension)<br/> return url<br/><br/>  <br/>  <br/>def write_to_file(data: str, file_name: str, file_path: str = "my_profile_pics"):<br/> try:<br/>  with open(path.join(file_path, file_name+".png"), "wb") as file:<br/>   file.write(data)<br/><br/> except Exception as e:<br/>  print(f"\n{e}\n")</span></pre><p id="5c21" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">接下来将是实际的 HTTP 请求，我们现在将使用<code class="fe ku kv kw kx b">requests </code>库。</p><pre class="ky kz la lb gt lc kx lt bn lu lv bi"><span id="0d02" class="lw lh in kx b be lx ly l lz ll"># ./sync_api.py<br/># --------------------------------<br/>import requests<br/>import utils  <br/><br/><br/>def create_new_avatar(avatar_style:str, base_url:str):<br/> seed = utils.generate_random_seed()<br/> request_url = utils.generate_api_url(seed=seed, avatar_style=avatar_style, base_url=base_url)<br/> resp = requests.get(request_url)<br/> data = resp.content<br/> utils.write_to_file(data=data, file_name=seed, file_path=r"C:/Users/user/desktop/pp")</span></pre><p id="fbd3" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">只是标准的 HTTP 请求。我们使用我们的效用函数为 DiceBear 生成一个随机种子，并发出一个 GET 请求。然后，我们从结果响应对象中提取图像数据。<br/>将数据写入实际文件由另一个实用程序处理。如果你想改变文件的存储位置，你可以把<code class="fe ku kv kw kx b">C:/Users/user/desktop/pp</code>切换到你喜欢的位置。</p><p id="eddd" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">看起来已经很好了，我们差不多完成了。</p><p id="4733" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在为这个程序创建一个入口点，<code class="fe ku kv kw kx b">main.py</code>。</p><pre class="ky kz la lb gt lc kx lt bn lu lv bi"><span id="71d3" class="lw lh in kx b be lx ly l lz ll"># ./main.py<br/># ---------------------------<br/>import sync_api<br/>from timeit import default_timer as timer<br/><br/>BASE_URL = "https://avatars.dicebear.com/api/{avatar_style}/{seed}"<br/><br/>ALL_STYLES = [<br/><br/> "adventurer",<br/><br/> "adventurer-neutral",<br/><br/> "avataaars",<br/><br/> "big-ears",<br/><br/> "big-ears-neutral",<br/><br/> "big-smile",<br/><br/> "botts",<br/><br/> "croodles",<br/><br/> "micah"<br/><br/> ]<br/><br/>def generate_profile_pics(n):<br/> for _ in range(n):<br/>  sync_api.create_new_avatar(avatar_style="adventurer", base_url=BASE_URL)<br/><br/><br/>start = timer()<br/>generate_profile_pics(20)<br/>print(f"Time Elapsed: {timer()-start} seconds")</span></pre><p id="01ed" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">就是这样！我们已经设置为创建 20 张个人资料图片。</p><blockquote class="ma mb mc"><p id="688a" class="jv jw md jx b jy jz ka kb kc kd ke kf me kh ki kj mf kl km kn mg kp kq kr ks ig bi translated">注意:DiceBearAvatar API 是一个很好的免费资源，不应该被滥用。<strong class="jx io">负责任地使用！</strong></p></blockquote><p id="5d5c" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">您可以继续运行:</p><pre class="ky kz la lb gt lc kx ld le aw lf bi"><span id="d119" class="lg lh in kx b gy li lj l lk ll">python main.py</span></pre><p id="91b1" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">您应该在指定的目录中获得 20 个 PNG 图像。</p><p id="a2f5" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">好了，现在说点好的。我们有没有办法加快那段代码的速度？我们是否可以同时运行该任务的多个实例？进入异步库<code class="fe ku kv kw kx b">asyncio </code>和<code class="fe ku kv kw kx b">aiohttp</code>，这是我们用 Python 进行异步 web 请求的工具集。</p><p id="0fd5" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><code class="fe ku kv kw kx b">aiohttp</code>最适合用客户端会话来处理多个请求，所以我们将使用它(<code class="fe ku kv kw kx b">requests</code>也支持客户端会话，但它不是一个流行的范例)。</p><pre class="ky kz la lb gt lc kx lt bn lu lv bi"><span id="20d5" class="lw lh in kx b be lx ly l lz ll"># ./async_api.py<br/># ----------------------------<br/>import aiohttp<br/>import asyncio<br/>import utils<br/><br/>async  def aio_create_new_avatar(client_session:aiohttp.ClientSession, avatar_style:str, base_url:str):<br/> seed = utils.generate_random_seed()<br/> request_url = utils.generate_api_url(seed=seed, avatar_style=avatar_style, base_url=base_url)<br/><br/> async with client_session.get(request_url) as resp:<br/>  data = await resp.read()<br/> utils.write_to_file(data=data, file_name=seed, file_path=r"C:/Users/user/desktop/pp")</span></pre><p id="2110" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">好的。所以和<code class="fe ku kv kw kx b">sync_api.py</code>没太大区别。我们还有几个导入，然后我们在客户端会话中使用一个上下文管理器来发出 web 请求。如果<code class="fe ku kv kw kx b">async/await</code>语法对你来说是新的，你可以看看<a class="ae kt" href="https://medium.com/@katchyemma/asyncio-101-writing-asynchronous-python-programs-61b732ca77b1" rel="noopener">这篇文章</a>，它介绍了 Python 中异步的整个概念。</p><p id="04ae" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">接下来我们将修改<code class="fe ku kv kw kx b">main.py</code>来使用我们的新代码。我喜欢精彩的比赛，所以我们将跟踪异步和同步代码的执行时间。<br/>下面是更新后的<code class="fe ku kv kw kx b">main.py</code>:</p><pre class="ky kz la lb gt lc kx lt bn lu lv bi"><span id="688d" class="lw lh in kx b be lx ly l lz ll"># ./main.py<br/># -----------------------------------<br/># new imports<br/>import aiohttp<br/>import asyncio<br/>import async_api<br/><br/>import sync_api<br/><br/>from timeit import default_timer as timer<br/><br/>BASE_URL = "https://avatars.dicebear.com/api/{avatar_style}/{seed}"<br/><br/>ALL_STYLES = [<br/><br/> "adventurer",<br/><br/> "adventurer-neutral",<br/><br/> "avataaars",<br/><br/> "big-ears",<br/><br/> "big-ears-neutral",<br/><br/> "big-smile",<br/><br/> "botts",<br/><br/> "croodles",<br/><br/> "micah"<br/><br/> ]<br/><br/>def generate_profile_pics(n):<br/><br/> for _ in range(n):<br/>  sync_api.create_new_avatar(avatar_style="adventurer", base_url=BASE_URL)<br/><br/>  <br/>async def async_generate_profile_pics(n):<br/><br/> Client = aiohttp.ClientSession()<br/> Tasks = []<br/><br/> for _ in range(n):<br/><br/>  # Create a new profile pic<br/>  Tasks.append(<br/>    async_api.aio_create_new_avatar(<br/>       client_session=Client, <br/>       avatar_style="big-smile",<br/>       base_url=BASE_URL<br/>    )<br/>  )<br/><br/>  try:<br/>   await asyncio.gather(*Tasks)  <br/><br/>  except:<br/>   pass<br/><br/>  finally:<br/>   await Client.close()<br/><br/>  <br/>start = timer()<br/>generate_profile_pics(20)<br/>print(f"Time Elapsed: {timer()-start} seconds")<br/><br/># For Windows Users <br/>asyncio.set_event_loop_policy(asyncio.WindowsSelectorEventLoopPolicy())<br/><br/>start = timer()<br/>asyncio.run(async_generate_profile_pics(20))<br/>print(f"Time Elapsed: {timer()-start} seconds")</span></pre><p id="2abc" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">搞定了。如果我们运行它，我们应该在我们指定的目录中得到 40 多张个人资料图片。平均来说，同步代码在我的电脑上执行需要 16 秒，而异步代码只需要 1 秒！如果你问我，我会说是时间上的重大改进。所以在这种情况下，代码复杂性和代码优化之间的权衡得到了回报。</p><p id="a82f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这个项目对我特别有用。我用它来生成个人使用的显示照片，以及我使用的 web 应用程序的占位符显示照片。如果你想在商业上使用这些图片，请检查每种风格的<a class="ae kt" href="https://avatars.dicebear.com/licenses" rel="noopener ugc nofollow" target="_blank">许可</a>。</p><p id="8868" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这个项目的完整代码可以在这里找到<a class="ae kt" href="https://github.com/TobeTek/personal_pros/blob/master/start_async_py" rel="noopener ugc nofollow" target="_blank"/>。</p><div class="mh mi gp gr mj mk"><a href="https://github.com/TobeTek/personal_pros/tree/master/start_async_py" rel="noopener  ugc nofollow" target="_blank"><div class="ml ab fo"><div class="mm ab mn cl cj mo"><h2 class="bd io gy z fp mp fr fs mq fu fw im bi translated">master tobe tek/personal _ pros/start _ async _ py 上的 personal _ pros/personal _ pros</h2><div class="mr l"><h3 class="bd b gy z fp mp fr fs mq fu fw dk translated">个人项目。在 GitHub 上创建一个帐户，为 TobeTek/personal_pros 开发做贡献。</h3></div><div class="ms l"><p class="bd b dl z fp mp fr fs mq fu fw dk translated">github.com</p></div></div><div class="mt l"><div class="mu l mv mw mx mt my jt mk"/></div></div></a></div><div class="mh mi gp gr mj mk"><a href="https://avatars.dicebear.com/styles" rel="noopener  ugc nofollow" target="_blank"><div class="ml ab fo"><div class="mm ab mn cl cj mo"><h2 class="bd io gy z fp mp fr fs mq fu fw im bi translated">概述| DiceBear 头像</h2><div class="mr l"><h3 class="bd b gy z fp mp fr fs mq fu fw dk translated">你想创造男性、女性还是抽象的化身？你有几个可爱的设计头像之间的选择</h3></div><div class="ms l"><p class="bd b dl z fp mp fr fs mq fu fw dk translated">avatars.dicebear.com</p></div></div></div></a></div><div class="mh mi gp gr mj mk"><a href="https://medium.com/@katchyemma/asyncio-101-writing-asynchronous-python-programs-61b732ca77b1" rel="noopener follow" target="_blank"><div class="ml ab fo"><div class="mm ab mn cl cj mo"><h2 class="bd io gy z fp mp fr fs mq fu fw im bi translated">Asyncio 101 |编写异步 Python 程序</h2><div class="mr l"><h3 class="bd b gy z fp mp fr fs mq fu fw dk translated">异步代码是目前的一个大话题。这是一个相当宽泛的术语，有时可能意味着并发性…</h3></div><div class="ms l"><p class="bd b dl z fp mp fr fs mq fu fw dk translated">medium.com</p></div></div><div class="mt l"><div class="mz l mv mw mx mt my jt mk"/></div></div></a></div><div class="mh mi gp gr mj mk"><a href="https://docs.aiohttp.org/en/stable/client_quickstart.html" rel="noopener  ugc nofollow" target="_blank"><div class="ml ab fo"><div class="mm ab mn cl cj mo"><h2 class="bd io gy z fp mp fr fs mq fu fw im bi translated">aiohttp</h2><div class="mr l"><h3 class="bd b gy z fp mp fr fs mq fu fw dk translated">渴望开始吗？这个页面很好地介绍了如何开始使用 aiohttp 客户端 API。首先，制作…</h3></div><div class="ms l"><p class="bd b dl z fp mp fr fs mq fu fw dk translated">docs.aiohttp.org</p></div></div></div></a></div><p id="f342" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">感谢阅读！离别迷因🙃</p><figure class="ky kz la lb gt jo gh gi paragraph-image"><div class="gh gi na"><img src="../Images/9ff621140eaa050a7d0e0350591e40b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*at42nPxHqbaEUCNec9wd8w.jpeg"/></div></figure></div></div>    
</body>
</html>