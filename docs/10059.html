<html>
<head>
<title>K8s Operators — understanding</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">K8s 运算符—理解</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/k8s-operators-understanding-6137ff811efb?source=collection_archive---------2-----------------------#2022-10-04">https://blog.devgenius.io/k8s-operators-understanding-6137ff811efb?source=collection_archive---------2-----------------------#2022-10-04</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><figure class="im in gp gr io ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi il"><img src="../Images/b5c7c948255d62e57a1e769ec71552c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D-VKBG8kFXSHQm66nKDEew.jpeg"/></div></div><figcaption class="iw ix gj gh gi iy iz bd b be z dk translated">由<a class="ae ja" href="https://unsplash.com/@sharegrid?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> ShareGrid </a>在<a class="ae ja" href="https://unsplash.com/s/photos/operator?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><div class=""/><p id="d82a" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">操作符的基础知识以及如何用 python 编写操作符</p><p id="c033" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">操作符使我们能够将应用程序视为单个对象，该对象仅向用户公开特定于应用程序的配置，而不是 K8s 原语的集合(例如 pod、部署、服务或配置映射)。操作员的目标是将操作知识输入到软件中，因此这些操作员还执行第 0 天(安装、配置)、第 1 天(更新、备份)、第 2 天(故障转移和恢复)操作。这些主要用于有状态的应用。</p><blockquote class="ky"><p id="a924" class="kz la jd bd lb lc ld le lf lg lh kx dk translated"><em class="li">操作员是 Kubernetes API 的客户，充当定制资源的控制者。</em></p></blockquote><p id="55a5" class="pw-post-body-paragraph ka kb jd kc b kd lj kf kg kh lk kj kk kl ll kn ko kp lm kr ks kt ln kv kw kx ig bi translated">让我们举一个例子，我们想在 K8s 上部署一个高度可用的 MySQL 数据库。你可能会问为什么要在容器上运行 DB。</p><ul class=""><li id="f4f3" class="lo lp jd kc b kd ke kh ki kl lq kp lr kt ls kx lt lu lv lw bi translated">按需供应</li><li id="7f79" class="lo lp jd kc b kd lx kh ly kl lz kp ma kt mb kx lt lu lv lw bi translated">CI/CD 友好</li><li id="bce3" class="lo lp jd kc b kd lx kh ly kl lz kp ma kt mb kx lt lu lv lw bi translated">便携式(红外线不可知)</li><li id="2e52" class="lo lp jd kc b kd lx kh ly kl lz kp ma kt mb kx lt lu lv lw bi translated">成本效益</li></ul><p id="5e45" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在回到部署。为了实现这一点，我们需要声明服务、路由器、有状态集、PV、PV 声明和 sidecars。除此之外，我们还需要添加备份和故障转移逻辑。如果我们有一个 MySQL 操作符，所有这些设置都是抽象的。它会自动完成所有繁重的工作。</p><h1 id="2446" class="mc md jd bd me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz bi translated">经营者</h1><figure class="nb nc nd ne gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi na"><img src="../Images/1d058adfe838ddc2781dac0fbae46435.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qnQIvTDFbWx39AZI1jSGFA.png"/></div></div></figure><h2 id="82d9" class="nf md jd bd me ng nh dn mi ni nj dp mm kl nk nl mq kp nm nn mu kt no np my nq bi translated">自定义资源定义</h2><p id="92a5" class="pw-post-body-paragraph ka kb jd kc b kd nr kf kg kh ns kj kk kl nt kn ko kp nu kr ks kt nv kv kw kx ig bi translated">资源是 Kubernetes API 中的一个端点，它存储了某种 API 对象的集合。自定义资源是 Kubernetes API 的扩展。使用 CRD，我们可以扩展 K8s API。CRD 使用名称和指定的架构创建新的自定义资源。这是在 YAML 写的。</p><pre class="nb nc nd ne gt nw nx ny nz aw oa bi"><span id="3fad" class="nf md jd nx b gy ob oc l od oe"><strong class="nx je">apiVersion</strong>: apiextensions.k8s.io/v1<br/><strong class="nx je">kind</strong>: CustomResourceDefinition<br/><strong class="nx je">metadata</strong>:<br/>  <em class="of"># &lt;plural&gt;.&lt;group&gt;</em><br/>  <strong class="nx je">name</strong>: <!-- -->innodbclusters.mysql.oracle.com<br/><strong class="nx je">spec</strong>:<br/>  <em class="of"># group name to use for REST API: /apis/&lt;group&gt;/&lt;version&gt;</em><br/>  <strong class="nx je">group</strong>: <!-- -->mysql.oracle.com<br/>  <em class="of"># list of versions supported by this CustomResourceDefinition</em><br/>  <strong class="nx je">versions</strong>:<br/>    - <strong class="nx je">name</strong>: v1<br/>      <em class="of"># Each version can be enabled/disabled by Served flag.</em><br/>      <strong class="nx je">served</strong>: <strong class="nx je">true</strong><br/>      <em class="of"># only one version must be marked as the storage version.</em><br/>      <strong class="nx je">storage</strong>: <strong class="nx je">true</strong><br/>      <strong class="nx je">schema</strong>:<br/>        <strong class="nx je">openAPIV3Schema</strong>:<br/>          <strong class="nx je">type</strong>: object<br/>          <strong class="nx je">properties</strong>:<br/>            <strong class="nx je">spec</strong>:<br/>              <strong class="nx je">type</strong>: object<br/>              <!-- -->required: ["secretName"]              <br/>              properties:<br/>                secretName:<br/>                  type: string<br/>                  .<br/>                  .<br/>                  . <br/>       <strong class="nx je">subresources</strong>:<br/>         status: {}</span><span id="4e80" class="nf md jd nx b gy og oc l od oe">  <em class="of"># either Namespaced or Cluster</em><br/>  <strong class="nx je">scope</strong>: Namespaced<br/>  <strong class="nx je">names</strong>:<br/>    <em class="of"># plural name</em><br/>    <strong class="nx je">plural</strong>: <!-- -->innodbclusters<br/>    <em class="of"># singular name to be used as an alias</em><br/>    <strong class="nx je">singular</strong>: <!-- -->innodbcluster<br/>    <em class="of"># kind is normally the CamelCased singular type. </em><br/>    <strong class="nx je">kind</strong>: <!-- -->InnoDBCluster<br/>    <em class="of"># shorter string to match your resource on the CLI</em><br/>    <strong class="nx je">shortNames</strong>:<br/>    <!-- -->- ic<br/>    - ics</span></pre><h2 id="4d89" class="nf md jd bd me ng nh dn mi ni nj dp mm kl nk nl mq kp nm nn mu kt no np my nq bi translated">控制器</h2><figure class="nb nc nd ne gt ip gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/a860370d14288b3926a21e4044cead1a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1368/format:webp/1*3r9Coj9-mIPjkqLeJR_Mbg.png"/></div></figure><ul class=""><li id="b2cb" class="lo lp jd kc b kd ke kh ki kl lq kp lr kt ls kx lt lu lv lw bi translated">观察—状态</li><li id="4e82" class="lo lp jd kc b kd lx kh ly kl lz kp ma kt mb kx lt lu lv lw bi translated">差异—检查期望状态与当前状态</li><li id="197e" class="lo lp jd kc b kd lx kh ly kl lz kp ma kt mb kx lt lu lv lw bi translated">行动—将资源置于所需状态</li></ul><blockquote class="oi oj ok"><p id="953e" class="ka kb of kc b kd ke kf kg kh ki kj kk ol km kn ko om kq kr ks on ku kv kw kx ig bi translated">运算符组合了自定义资源和自定义控制器。</p></blockquote><p id="3295" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">操作者是一个控制器，它扩展 API 的功能并为用户管理应用程序的复杂实例。</p><h2 id="302c" class="nf md jd bd me ng nh dn mi ni nj dp mm kl nk nl mq kp nm nn mu kt no np my nq bi translated">经营者</h2><p id="028e" class="pw-post-body-paragraph ka kb jd kc b kd nr kf kg kh ns kj kk kl nt kn ko kp nu kr ks kt nv kv kw kx ig bi translated">操作员负责执行我们特定于应用程序的逻辑。它还创建了一个协调器(类似于上面的控制器)。该控制器处理资源的状态变化。运算符是为一种类型编写的，添加所有者引用，并监视状态更改事件。</p><p id="ab72" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">编写自定义运算符(用 python)</p><figure class="nb nc nd ne gt ip gh gi paragraph-image"><div class="gh gi oo"><img src="../Images/fdce2f91d7bfeba24a5321aab85f6c73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1196/format:webp/1*i9apVqHrHBkbdsIdWO21rA.png"/></div></figure><h2 id="959b" class="nf md jd bd me ng nh dn mi ni nj dp mm kl nk nl mq kp nm nn mu kt no np my nq bi translated">Kubernetes 算子 Pythonic 框架(Kopf)</h2><p id="29fe" class="pw-post-body-paragraph ka kb jd kc b kd nr kf kg kh ns kj kk kl nt kn ko kp nu kr ks kt nv kv kw kx ig bi translated">kopf 是一个使 Kubernetes 操作符开发更容易的框架和库，只需几行 Python 代码。它允许我们只使用两个文件构建一个全功能的操作符:一个<code class="fe op oq or nx b">Dockerfile</code> +一个 Python 文件(*)。</p><pre class="nb nc nd ne gt nw nx ny nz aw oa bi"><span id="5b27" class="nf md jd nx b gy ob oc l od oe">├───customoperator<br/>     └───Dockerfile<br/>     └───requirements.txt<br/>     └───src<br/>          └───operator.py</span></pre><p id="69d5" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Dockerfile 文件的内容</p><pre class="nb nc nd ne gt nw nx ny nz aw oa bi"><span id="b5ad" class="nf md jd nx b gy ob oc l od oe">FROM python:3.9<br/>COPY requirements.txt .<br/>RUN pip install -r requirements.txt <br/>ADD . /src<br/>CMD kopf run /src/operator.py --verbose</span></pre><p id="ac81" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">和 python 文件。</p><pre class="nb nc nd ne gt nw nx ny nz aw oa bi"><span id="7041" class="nf md jd nx b gy ob oc l od oe">import kopf<br/>import logging</span><span id="f1d4" class="nf md jd nx b gy og oc l od oe">@kopf.on.startup()<br/>def on_startup(kopf.OperatorSettings, logger, *args, **_):<br/>    // completet the function</span><span id="58c6" class="nf md jd nx b gy og oc l od oe">@kopf.on.create("&lt;group&gt;", "&lt;version&gt;", "&lt;plural&gt;")<br/>def create_fn(spec, **kwargs):<br/>    // complete the function</span><span id="b89e" class="nf md jd nx b gy og oc l od oe">@kopf.on.update("", "v1", "secrets"):<br/>def on_secret_update(name, namespace, logger, **kwargs):<br/>    // complete the function</span><span id="2769" class="nf md jd nx b gy og oc l od oe">@kopf.on.event("", "v1", "pods")<br/>def on_pod_event(event, body, logger, **kwargs):<br/>    // complete the function</span><span id="ab59" class="nf md jd nx b gy og oc l od oe">@kopf.on.delete("&lt;group&gt;", "&lt;version&gt;", "&lt;plural&gt;")<br/>def delete_fn(spec, **kwargs):<br/>    // complete the function</span><span id="e56d" class="nf md jd nx b gy og oc l od oe">@kopf.on.cleanup()<br/>def on_shutdown(Logger, *args, **kwargs):<br/>    // complete the function</span></pre><p id="0d52" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">一旦操作代码准备就绪，就需要部署它。为此，我们需要创建一个部署和先决条件 K8s 对象(服务帐户、集群角色绑定)。</p><pre class="nb nc nd ne gt nw nx ny nz aw oa bi"><span id="c71d" class="nf md jd nx b gy ob oc l od oe">├───kubernetes<br/>     └───crb.yaml<br/>     └───crd.yaml<br/>     └───operator.yaml<br/>     └───sa.yaml</span></pre><p id="b56d" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">operator.yaml 的内容</p><pre class="nb nc nd ne gt nw nx ny nz aw oa bi"><span id="027b" class="nf md jd nx b gy ob oc l od oe">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: mysql-operator<br/>  namespace: mysql-operator<br/>  labels:<br/>    version: "1.0"<br/>    app.kubernetes.io/name: mysql-operator<br/>    app.kubernetes.io/version: latset<br/>    app.kubernetes.io/component: controller<br/>    app.kubernetes.io/managed-by: mysql-operator<br/>    app.kubernetes.io/created-by: mysql-operator<br/>spec:<br/>  replicas: 1<br/>  selector:<br/>    matchLabels:<br/>      name: mysql-operator<br/>  template:<br/>    metadata:<br/>      labels:<br/>        name: mysql-operator<br/>    spec:<br/>      containers:<br/>        - name: mysql-operator<br/>          image: mysql-operator:latest<br/>          imagePullPolicy: IfNotPresent<br/>          securityContext:<br/>            runAsUser: 2<br/>            allowPrivilegeEscalation: false<br/>            privileged: false<br/>            readOnlyRootFilesystem: true<br/>      volumes:<br/>        - name: mysqlsh-home<br/>          emptyDir: {}<br/>        - name: tmpdir<br/>          emptyDir: {}<br/>      serviceAccountName: mysql-operator-sa</span></pre><p id="ee05" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在应用上面的清单时，我们将运行一个 pod，它将充当自定义控制器，并将监听特定资源类型的事件，然后按照代码库中的定义采取行动。</p><p id="2b65" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">部署群集:</p><pre class="nb nc nd ne gt nw nx ny nz aw oa bi"><span id="9269" class="nf md jd nx b gy ob oc l od oe">apiVersion: mysql.oracle.com/v1<br/>kind: InnoDBCluster<br/>metadata:<br/>  name: mycluster<br/>spec:<br/>  secretName: mypwds<br/>  tlsUseSelfSigned: true<br/>  instances: 3<br/>  router:<br/>    instances: 1</span></pre><h2 id="5bd2" class="nf md jd bd me ng nh dn mi ni nj dp mm kl nk nl mq kp nm nn mu kt no np my nq bi translated">运营商最佳实践</h2><ul class=""><li id="88ba" class="lo lp jd kc b kd nr kh ns kl os kp ot kt ou kx lt lu lv lw bi translated">除非你有迫切的需求，否则不要写操作符，没那么容易</li><li id="14b9" class="lo lp jd kc b kd lx kh ly kl lz kp ma kt mb kx lt lu lv lw bi translated">如果可能，使用社区中可用的操作符</li><li id="88e6" class="lo lp jd kc b kd lx kh ly kl lz kp ma kt mb kx lt lu lv lw bi translated">为每个应用开发一个操作员</li><li id="dbd0" class="lo lp jd kc b kd lx kh ly kl lz kp ma kt mb kx lt lu lv lw bi translated">运算符逻辑应该是无状态的，使用 CRD 来维护状态</li><li id="86db" class="lo lp jd kc b kd lx kh ly kl lz kp ma kt mb kx lt lu lv lw bi translated">运算符运算应该是幂等的</li><li id="1482" class="lo lp jd kc b kd lx kh ly kl lz kp ma kt mb kx lt lu lv lw bi translated">针对不同功能的不同控制器</li><li id="0bab" class="lo lp jd kc b kd lx kh ly kl lz kp ma kt mb kx lt lu lv lw bi translated">CRD 应该版本化并向后兼容</li><li id="471a" class="lo lp jd kc b kd lx kh ly kl lz kp ma kt mb kx lt lu lv lw bi translated">对操作员实施监控和记录</li></ul><h2 id="0367" class="nf md jd bd me ng nh dn mi ni nj dp mm kl nk nl mq kp nm nn mu kt no np my nq bi translated">编写/评估运算符时的安全考虑:</h2><ul class=""><li id="8af3" class="lo lp jd kc b kd nr kh ns kl os kp ot kt ou kx lt lu lv lw bi translated">仅授予服务帐户所需的权限</li><li id="97db" class="lo lp jd kc b kd lx kh ly kl lz kp ma kt mb kx lt lu lv lw bi translated">为操作者的容器配置适当的安全上下文</li><li id="d407" class="lo lp jd kc b kd lx kh ly kl lz kp ma kt mb kx lt lu lv lw bi translated">检查恶意操作员代码</li><li id="5efd" class="lo lp jd kc b kd lx kh ly kl lz kp ma kt mb kx lt lu lv lw bi translated">检查映像依赖关系的漏洞</li><li id="af28" class="lo lp jd kc b kd lx kh ly kl lz kp ma kt mb kx lt lu lv lw bi translated">限制资源范围</li></ul><figure class="nb nc nd ne gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi ov"><img src="../Images/43948e778b27d67ebe0666332480bc46.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pjUwA7H07jdHs8O9t79MEA.png"/></div></div><figcaption class="iw ix gj gh gi iy iz bd b be z dk translated"><a class="ae ja" href="https://github.com/controlplaneio/operator-threat-matrix" rel="noopener ugc nofollow" target="_blank">https://github.com/controlplaneio/operator-threat-matrix</a></figcaption></figure><h2 id="dbf5" class="nf md jd bd me ng nh dn mi ni nj dp mm kl nk nl mq kp nm nn mu kt no np my nq bi translated">一些著名的社区运营商:</h2><ul class=""><li id="8d31" class="lo lp jd kc b kd nr kh ns kl os kp ot kt ou kx lt lu lv lw bi translated">普罗米修斯</li><li id="47f0" class="lo lp jd kc b kd lx kh ly kl lz kp ma kt mb kx lt lu lv lw bi translated">ArgoCD</li><li id="38af" class="lo lp jd kc b kd lx kh ly kl lz kp ma kt mb kx lt lu lv lw bi translated">关系型数据库</li><li id="77e2" class="lo lp jd kc b kd lx kh ly kl lz kp ma kt mb kx lt lu lv lw bi translated">波特沃克斯</li><li id="2885" class="lo lp jd kc b kd lx kh ly kl lz kp ma kt mb kx lt lu lv lw bi translated">Mongodb</li></ul><p id="60d7" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">更多参考:【https://operatorhub.io/ T2】</p><p id="5ef5" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">关于 K8s 运营商的资源请参考此<a class="ae ja" href="https://github.com/calvin-puram/awesome-kubernetes-operator-resources" rel="noopener ugc nofollow" target="_blank"> GitHub repo</a></p><p id="c74f" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">文章中的所有代码都是从这个 repo <a class="ae ja" href="https://github.com/mysql/mysql-operator" rel="noopener ugc nofollow" target="_blank"> Mysql 操作符</a>中获得灵感或取得的。</p><p id="14e2" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">快乐阅读！！</p></div></div>    
</body>
</html>