<html>
<head>
<title>Snowflake — Cost Saving</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">雪花—节约成本</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/snowflake-cost-saving-9e6b05aee0bd?source=collection_archive---------3-----------------------#2022-07-02">https://blog.devgenius.io/snowflake-cost-saving-9e6b05aee0bd?source=collection_archive---------3-----------------------#2022-07-02</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><figure class="im in gp gr io ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi il"><img src="../Images/99edc0dabcbfc61498e14137f5e1d77c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zSh5v9qABH8qSl-CKYqOJw.jpeg"/></div></div><figcaption class="iw ix gj gh gi iy iz bd b be z dk translated">在<a class="ae ja" href="https://unsplash.com/s/photos/saving?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae ja" href="https://unsplash.com/@micheile?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> micheile dot com </a>拍摄的照片</figcaption></figure><div class=""/><p id="8b15" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">降低雪花成本的技巧</p><blockquote class="ky"><p id="e859" class="kz la jd bd lb lc ld le lf lg lh kx dk translated">我们的环境运行高效吗？</p></blockquote><p id="2af6" class="pw-post-body-paragraph ka kb jd kc b kd li kf kg kh lj kj kk kl lk kn ko kp ll kr ks kt lm kv kw kx ig bi translated">这是我们用雪花运行企业数据平台时经常遇到的一个问题。好消息是，雪花为我们提供了几个杠杆来最小化成本和最大化性能。</p><p id="d743" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">雪花费用分为以下几大类:</p><ul class=""><li id="e624" class="ln lo jd kc b kd ke kh ki kl lp kp lq kt lr kx ls lt lu lv bi translated">云服务(不太重要)</li><li id="13a7" class="ln lo jd kc b kd lw kh lx kl ly kp lz kt ma kx ls lt lu lv bi translated">仓库</li><li id="07f8" class="ln lo jd kc b kd lw kh lx kl ly kp lz kt ma kx ls lt lu lv bi translated">保管费用</li><li id="1d26" class="ln lo jd kc b kd lw kh lx kl ly kp lz kt ma kx ls lt lu lv bi translated">区域内数据传输费用(外部表)</li><li id="e634" class="ln lo jd kc b kd lw kh lx kl ly kp lz kt ma kx ls lt lu lv bi translated">雪管</li><li id="766a" class="ln lo jd kc b kd lw kh lx kl ly kp lz kt ma kx ls lt lu lv bi translated">数据库复制和保留</li><li id="c198" class="ln lo jd kc b kd lw kh lx kl ly kp lz kt ma kx ls lt lu lv bi translated">自动聚类</li><li id="2e71" class="ln lo jd kc b kd lw kh lx kl ly kp lz kt ma kx ls lt lu lv bi translated">物化视图维护</li><li id="4065" class="ln lo jd kc b kd lw kh lx kl ly kp lz kt ma kx ls lt lu lv bi translated">搜索优化服务</li><li id="e390" class="ln lo jd kc b kd lw kh lx kl ly kp lz kt ma kx ls lt lu lv bi translated">自动刷新外部表元数据</li></ul><p id="f1f2" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在这篇博客中，我们将讨论一些关于雪花节约成本的策略。</p><h2 id="3880" class="mb mc jd bd md me mf dn mg mh mi dp mj kl mk ml mm kp mn mo mp kt mq mr ms mt bi translated">正确加载数据</h2><ul class=""><li id="657e" class="ln lo jd kc b kd mu kh mv kl mw kp mx kt my kx ls lt lu lv bi translated">我们应该将大文件分成较小的文件，然后使用 copy 命令加载，这样可以利用并行性，从而缩短完成时间。估计的文件大小应该在 90-100 MB 范围内。</li><li id="d09d" class="ln lo jd kc b kd lw kh lx kl ly kp lz kt ma kx ls lt lu lv bi translated">我们应该按照我们希望使用的顺序加载数据。数据按照自然摄取顺序在雪花中自动分区。此外，从 s3 存储桶加载排序后的文件应该比使用 ORDER BY 子句插入要快得多。</li><li id="a12d" class="ln lo jd kc b kd lw kh lx kl ly kp lz kt ma kx ls lt lu lv bi translated">我们应该使用 COPY INTO 而不是 INSERT，因为它利用了更有效的大容量装载过程。</li><li id="ae89" class="ln lo jd kc b kd lw kh lx kl ly kp lz kt ma kx ls lt lu lv bi translated">对于外部表，我们应该加强与雪花帐户相同区域的数据文件。</li></ul><h2 id="8563" class="mb mc jd bd md me mf dn mg mh mi dp mj kl mk ml mm kp mn mo mp kt mq mr ms mt bi translated">合理确定仓库规模</h2><ul class=""><li id="fa64" class="ln lo jd kc b kd mu kh mv kl mw kp mx kt my kx ls lt lu lv bi translated">我们应该将相似的工作负载分组到同一个虚拟仓库中。</li><li id="ba6e" class="ln lo jd kc b kd lw kh lx kl ly kp lz kt ma kx ls lt lu lv bi translated">我们应该为 ETL 和查询操作建立独立的专用仓库，以优化它们的性能。</li><li id="6ca7" class="ln lo jd kc b kd lw kh lx kl ly kp lz kt ma kx ls lt lu lv bi translated">我们应该监控查询性能，如果我们在查询概要文件中发现溢出，那么我们应该考虑更大的仓库。</li><li id="f047" class="ln lo jd kc b kd lw kh lx kl ly kp lz kt ma kx ls lt lu lv bi translated">如果我们观察查询排队，这应该是一个指标，要么增加大小，要么有更多的集群(首选)。</li><li id="93c2" class="ln lo jd kc b kd lw kh lx kl ly kp lz kt ma kx ls lt lu lv bi translated">我们应该明确将仓库配置的控制权交给最终用户。他们应该没有更新 WH 配置的能力。</li></ul><p id="26d7" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">正如我提到的，扩展计算能力(更多的并发性)和扩展(更多的性能)我们需要在迭代函数中尝试这些来达到最佳效果。</p><h2 id="1708" class="mb mc jd bd md me mf dn mg mh mi dp mj kl mk ml mm kp mn mo mp kt mq mr ms mt bi translated">暂停虚拟仓库</h2><p id="41d7" class="pw-post-body-paragraph ka kb jd kc b kd mu kf kg kh mv kj kk kl mz kn ko kp na kr ks kt nb kv kw kx ig bi translated">雪花旨在对我们的计算需求做出动态反应，因此我们应该利用它。当没有长时间执行的查询时，我们不应该让虚拟仓库闲置，例如批处理作业。最好在空闲几分钟后自动挂起它们。</p><pre class="nc nd ne nf gt ng nh ni nj aw nk bi"><span id="3b5b" class="mb mc jd nh b gy nl nm l nn no">alter warehouse &lt;warehouse_name&gt; set auto_suspend = &lt;num_in_sec&gt;;</span></pre><p id="be0a" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">或者，对于报告应用程序，我们可以采用多集群方法，根据并发运行的查询数量自动添加和删除仓库。</p><h2 id="34a8" class="mb mc jd bd md me mf dn mg mh mi dp mj kl mk ml mm kp mn mo mp kt mq mr ms mt bi translated">利用缓存</h2><p id="d18d" class="pw-post-body-paragraph ka kb jd kc b kd mu kf kg kh mv kj kk kl mz kn ko kp na kr ks kt nb kv kw kx ig bi translated">虚拟仓库缓存表示为一些较旧的查询而复制到该仓库 VM 的微分区。这在 QA 环境中非常有用。我们可以只加载一次数据，然后对数据重复运行规则。</p><h2 id="3f0d" class="mb mc jd bd md me mf dn mg mh mi dp mj kl mk ml mm kp mn mo mp kt mq mr ms mt bi translated">为查询超时设置设置适当的非默认值</h2><p id="a6aa" class="pw-post-body-paragraph ka kb jd kc b kd mu kf kg kh mv kj kk kl mz kn ko kp na kr ks kt nb kv kw kx ig bi translated">暂停正在运行的查询的默认值是 2 天。我们应该根据工作量将其设置为更保守的值。对于大多数情况，4-6 小时应该足够了。</p><pre class="nc nd ne nf gt ng nh ni nj aw nk bi"><span id="0df9" class="mb mc jd nh b gy nl nm l nn no">STATEMENT_TIMEOUT_IN_SECONDS</span></pre><h2 id="000c" class="mb mc jd bd md me mf dn mg mh mi dp mj kl mk ml mm kp mn mo mp kt mq mr ms mt bi translated">在共享仓库中运行短期查询</h2><p id="e5de" class="pw-post-body-paragraph ka kb jd kc b kd mu kf kg kh mv kj kk kl mz kn ko kp na kr ks kt nb kv kw kx ig bi translated">如果我们有快速完成的查询(不到 1 分钟)，我们应该在共享仓库中运行这些查询，以提高仓库利用率。</p><h2 id="8e19" class="mb mc jd bd md me mf dn mg mh mi dp mj kl mk ml mm kp mn mo mp kt mq mr ms mt bi translated">监控<strong class="ak">读者账号</strong></h2><p id="a868" class="pw-post-body-paragraph ka kb jd kc b kd mu kf kg kh mv kj kk kl mz kn ko kp na kr ks kt nb kv kw kx ig bi translated">读者账户中共享数据的查询费用由提供商账户支付。因此，我们有必要监控共享数据的使用情况，并设置防护栏，以便它们不会因成本而失控。</p><h2 id="8584" class="mb mc jd bd md me mf dn mg mh mi dp mj kl mk ml mm kp mn mo mp kt mq mr ms mt bi translated"><strong class="ak">在生产、开发和 UAT 环境之间使用零拷贝克隆</strong></h2><p id="41e9" class="pw-post-body-paragraph ka kb jd kc b kd mu kf kg kh mv kj kk kl mz kn ko kp na kr ks kt nb kv kw kx ig bi translated">如果我们有进行数据质量/回归测试的用例，那么我们可以利用零拷贝特性跨 env 拷贝表并节省成本。</p><p id="5f75" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><em class="np">注意:当我们删除父/原始表时，存储所有权转移到克隆的表。因此，在删除父表时，要确保克隆的表在不使用时也被删除。</em></p><h2 id="49d2" class="mb mc jd bd md me mf dn mg mh mi dp mj kl mk ml mm kp mn mo mp kt mq mr ms mt bi translated">巧妙使用临时、暂时和外部表格来节省成本</h2><p id="2180" class="pw-post-body-paragraph ka kb jd kc b kd mu kf kg kh mv kj kk kl mz kn ko kp na kr ks kt nb kv kw kx ig bi translated">这些非永久表省略了故障安全和时间旅行，因此节省了存储成本。所以我们应该将它们用于管道中的中间表。</p><h2 id="815a" class="mb mc jd bd md me mf dn mg mh mi dp mj kl mk ml mm kp mn mo mp kt mq mr ms mt bi translated">弃用未使用的表/对象</h2><p id="84f2" class="pw-post-body-paragraph ka kb jd kc b kd mu kf kg kh mv kj kk kl mz kn ko kp na kr ks kt nb kv kw kx ig bi translated">这是显而易见的。如果我们长时间不使用某个表，那么将该表保存在雪花中是没有意义的。我们可以将其卸载到外部位置，然后删除该表。要找出未被支持的表，我们可以查看<code class="fe nq nr ns nh b">account_usage.access_history</code>。</p><p id="227f" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">此外，我们应该从内部阶段(用户、表和命名)中删除不再需要的文件。<code class="fe nq nr ns nh b">remove @mystage/path1/subpath;</code></p><p id="bb06" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如果我们使用 spark 加载数据到雪花，我们应该使用外部阶段(S3)。</p><h2 id="517e" class="mb mc jd bd md me mf dn mg mh mi dp mj kl mk ml mm kp mn mo mp kt mq mr ms mt bi translated">拥有正确的桌子设计</h2><p id="3b5f" class="pw-post-body-paragraph ka kb jd kc b kd mu kf kg kh mv kj kk kl mz kn ko kp na kr ks kt nb kv kw kx ig bi translated">我们应该尝试和测试表的性能，如果必要的话，在表的大小超过 1 TB 或者有大约 10 亿行的表中的字段上创建聚集键。</p><h2 id="3a0f" class="mb mc jd bd md me mf dn mg mh mi dp mj kl mk ml mm kp mn mo mp kt mq mr ms mt bi translated">微调我们的 SQL</h2><p id="4721" class="pw-post-body-paragraph ka kb jd kc b kd mu kf kg kh mv kj kk kl mz kn ko kp na kr ks kt nb kv kw kx ig bi translated">在这篇博客中，我想把讨论更多地放在节约成本的唾手可得的成果上。优化 SQL 是一个很大的话题，也很难控制。尽管如此，我们可以有一些明显的护栏。</p><ul class=""><li id="2123" class="ln lo jd kc b kd ke kh ki kl lp kp lq kt lr kx ls lt lu lv bi translated">避免选择*</li><li id="b941" class="ln lo jd kc b kd lw kh lx kl ly kp lz kt ma kx ls lt lu lv bi translated">使用 ANSI 连接</li><li id="5500" class="ln lo jd kc b kd lw kh lx kl ly kp lz kt ma kx ls lt lu lv bi translated">避免联合，排序依据</li><li id="f8d8" class="ln lo jd kc b kd lw kh lx kl ly kp lz kt ma kx ls lt lu lv bi translated">字符串上的日期或时间戳数据类型</li></ul><h2 id="ac6b" class="mb mc jd bd md me mf dn mg mh mi dp mj kl mk ml mm kp mn mo mp kt mq mr ms mt bi translated">设置每月信用消费阈值和警报</h2><p id="6626" class="pw-post-body-paragraph ka kb jd kc b kd mu kf kg kh mv kj kk kl mz kn ko kp na kr ks kt nb kv kw kx ig bi translated">我们应该经常检查当前的成本。每月预算的阈值和警报将有助于我们更快地做出成本决策，并防止成本进一步增加。使用资源监视器，我们还可以看到使用中的异常情况。我们应该使用查询配置文件、信息模式、帐户用法和读者帐户用法来了解性能和成本。在查询历史记录中查找扫描的列。类似地，我们应该检查频繁使用的列的聚类深度。</p><p id="5898" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们可以开发一个仪表板，将性能和成本管理交给关键决策者。当成本突然增加时，它会发出警报。它还应该自动推荐补救方法。在这方面，有许多第三方解决方案值得关注。</p><p id="30e0" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">不断重复这些过程，并将您自己的发现添加到您使用的知识库中。</p><p id="79fa" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">仓储快乐！！</p></div></div>    
</body>
</html>