<html>
<head>
<title>Docker container security</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">码头集装箱安全</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/docker-container-security-97543efc8703?source=collection_archive---------15-----------------------#2022-05-16">https://blog.devgenius.io/docker-container-security-97543efc8703?source=collection_archive---------15-----------------------#2022-05-16</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/bd92ce0a0916b6cbfd3e3e76a62e1cc9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*BCHpbxH0422E2z2-"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated"><a class="ae jz" href="https://unsplash.com/@arielbesagar?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Ariel </a>在<a class="ae jz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="07d7" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在构建 Docker 映像时，如何使用敏感信息？</p><p id="5868" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">安全，安全，安全…不要在 Dockerfile 中存储秘密。</p><p id="f0e6" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">让我告诉你为什么。</p></div><div class="ab cl ky kz hr la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ig ih ii ij ik"><h1 id="45c3" class="lf lg in bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">假定</h1><blockquote class="md me mf"><p id="03d9" class="ka kb mg kc b kd ke kf kg kh ki kj kk mh km kn ko mi kq kr ks mj ku kv kw kx ig bi translated">让我们假设我们将在构建 Docker 映像时将敏感信息放入文件中，并将在构建结束时删除该文件。因此，图像上可能不会存储任何敏感信息。</p></blockquote><p id="66c1" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">确实如此——最终图像上没有敏感信息。但是，这些信息是可以检索的。</p></div><div class="ab cl ky kz hr la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ig ih ii ij ik"><blockquote class="md me mf"><p id="675a" class="ka kb mg kc b kd ke kf kg kh ki kj kk mh km kn ko mi kq kr ks mj ku kv kw kx ig bi translated"><strong class="kc io"> <em class="in">点击关注再也不要错过我的另一篇文章。</em> </strong></p></blockquote><p id="b778" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">让我们看看如何检索 Docker 容器上存储的任何数据</p><ul class=""><li id="48eb" class="mk ml in kc b kd ke kh ki kl mm kp mn kt mo kx mp mq mr ms bi translated">创建 Dockerfile 文件</li></ul><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="d21e" class="nc lg in my b gy nd ne l nf ng">FROM alpine<br/>RUN echo “top-secret- sensitive-info” &gt; / sensitive.txt<br/>RUN rm /sensitive.txt</span></pre><ul class=""><li id="d88d" class="mk ml in kc b kd ke kh ki kl mm kp mn kt mo kx mp mq mr ms bi translated">创建一个名为“<em class="mg"> sensitive </em>”的图像</li></ul><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="3b71" class="nc lg in my b gy nd ne l nf ng">docker build -t sensitive .</span></pre><ul class=""><li id="c51c" class="mk ml in kc b kd ke kh ki kl mm kp mn kt mo kx mp mq mr ms bi translated">检查图像是否已创建</li></ul><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="21fe" class="nc lg in my b gy nd ne l nf ng">docker images | grep sensitive</span></pre><ul class=""><li id="fa09" class="mk ml in kc b kd ke kh ki kl mm kp mn kt mo kx mp mq mr ms bi translated">运行此命令以验证 sensitive.txt 文件是否存在于映像中</li></ul><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="e71b" class="nc lg in my b gy nd ne l nf ng">docker run --rm -it sensitive:latest  ls /sensitive.txt</span></pre><p id="a862" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">输出:</p><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="3d53" class="nc lg in my b gy nd ne l nf ng">ls: sensitive.txt: No such file or directory</span></pre></div><div class="ab cl ky kz hr la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ig ih ii ij ik"><blockquote class="md me mf"><p id="70ee" class="ka kb mg kc b kd ke kf kg kh ki kj kk mh km kn ko mi kq kr ks mj ku kv kw kx ig bi translated"><strong class="kc io"> <em class="in">点击关注再也不要错过我的另一篇文章。</em>T13】</strong></p></blockquote><p id="1e81" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">到目前为止一切顺利。</p><p id="9363" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这里有一个小技巧，将展示如何检索在 docker 映像构建期间使用的数据</p><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="43af" class="nc lg in my b gy nd ne l nf ng"><em class="mg">Docker Save</em> is used for image saving for Sharing purposes.</span></pre><ul class=""><li id="8de8" class="mk ml in kc b kd ke kh ki kl mm kp mn kt mo kx mp mq mr ms bi translated">奔跑</li></ul><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="b90c" class="nc lg in my b gy nd ne l nf ng">docker save sensitive &gt; sensitive.tar</span></pre><ul class=""><li id="809c" class="mk ml in kc b kd ke kh ki kl mm kp mn kt mo kx mp mq mr ms bi translated">让我们检查输出 tar 文件</li></ul><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="dc4b" class="nc lg in my b gy nd ne l nf ng">mkdir inspect  &amp;&amp; tar -xvf sensitive.tar -C inspect</span></pre><ul class=""><li id="a8bf" class="mk ml in kc b kd ke kh ki kl mm kp mn kt mo kx mp mq mr ms bi translated">输出</li></ul><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="bbee" class="nc lg in my b gy nd ne l nf ng">tree ./inspect</span><span id="74c9" class="nc lg in my b gy nh ne l nf ng">./inspect</span><span id="a57b" class="nc lg in my b gy nh ne l nf ng">├── 8792aa27a60beb94c658afc7fb54a4f1c427afe01b65cec0f2261c193ec3f495│   ├── VERSION<br/>│   ├── json<br/>│   └── layer.tar<br/>├── 92a2836ccb2847305b9de282c813b1c68c689cb0636fec109f28fe8f50450849.json<br/>├── a9b7d74c25fd61b40f8054523fea8d72e8823e62c6b8b9897b2535aec8c8bcfc<br/>│   ├── VERSION<br/>│   ├── json<br/>│   └── layer.tar<br/>├── dee1ed989fb3c3c2232feda1f0155e4bedb1e867a9243a84252b69ffc248b863<br/>│   ├── VERSION<br/>│   ├── json<br/>│   └── layer.tar<br/>├── manifest.json<br/>└── repositories</span></pre><ul class=""><li id="eb06" class="mk ml in kc b kd ke kh ki kl mm kp mn kt mo kx mp mq mr ms bi translated">让我们检查 docker 图像历史</li></ul><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="2ea0" class="nc lg in my b gy nd ne l nf ng">cat 92a2836ccb2847305b9de282c813b1c68c689cb0636fec109f28fe8f50450849.json | jq ‘.history’</span></pre><p id="ae6a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">输出</p><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="f8d4" class="nc lg in my b gy nd ne l nf ng">[</span><span id="d830" class="nc lg in my b gy nh ne l nf ng">{</span><span id="869a" class="nc lg in my b gy nh ne l nf ng">"created": "2022-04-05T00:19:59.790636867Z",</span><span id="f954" class="nc lg in my b gy nh ne l nf ng">"created_by": "/bin/sh -c #(nop) ADD file:5d673d25da3a14ce1f6cf66e4c7fd4f4b85a3759a9d93efb3fd9ff852b5b56e4 in / "</span><span id="3753" class="nc lg in my b gy nh ne l nf ng">},</span><span id="2762" class="nc lg in my b gy nh ne l nf ng">{</span><span id="94ff" class="nc lg in my b gy nh ne l nf ng">"created": "2022-04-05T00:19:59.912662499Z",</span><span id="d871" class="nc lg in my b gy nh ne l nf ng">"created_by": "/bin/sh -c #(nop)  CMD [\"/bin/sh\"]",</span><span id="01f2" class="nc lg in my b gy nh ne l nf ng">"empty_layer": true</span><span id="f276" class="nc lg in my b gy nh ne l nf ng">},</span><span id="054d" class="nc lg in my b gy nh ne l nf ng">{</span><span id="864a" class="nc lg in my b gy nh ne l nf ng">"created": "2022-04-28T16:36:52.83339Z",</span><span id="76a3" class="nc lg in my b gy nh ne l nf ng">"created_by": "RUN /bin/sh -c echo \" top-secret- sensitive-info \" &gt; / sensitive.txt # buildkit",</span><span id="cbb8" class="nc lg in my b gy nh ne l nf ng">"comment": "buildkit.dockerfile.v0"</span><span id="bdf0" class="nc lg in my b gy nh ne l nf ng">},</span><span id="9e75" class="nc lg in my b gy nh ne l nf ng">{</span><span id="b163" class="nc lg in my b gy nh ne l nf ng">"created": "2022-04-28T16:36:53.2796236Z",</span><span id="b673" class="nc lg in my b gy nh ne l nf ng">"created_by": "RUN /bin/sh -c rm /password.txt # buildkit",</span><span id="5921" class="nc lg in my b gy nh ne l nf ng">"comment": "buildkit.dockerfile.v0"</span><span id="bdd2" class="nc lg in my b gy nh ne l nf ng">}</span><span id="26ef" class="nc lg in my b gy nh ne l nf ng">]</span></pre><p id="dd80" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi ni translated"><span class="l nj nk nl bm nm nn no np nq di">所以</span>我们在这里:作为纯文本，您可以看到在这个映像构建期间写入的数据。</p></div><div class="ab cl ky kz hr la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ig ih ii ij ik"><p id="a17b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">另一种选择:您可以打印出<em class="mg"> sensitive.txt </em>的内容</p><ul class=""><li id="90aa" class="mk ml in kc b kd ke kh ki kl mm kp mn kt mo kx mp mq mr ms bi translated">解压缩 Docker 图像层文件</li></ul><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="ce3d" class="nc lg in my b gy nd ne l nf ng">tar -xvf dee1ed989fb3c3c2232feda1f0155e4bedb1e867a9243a84252b69ffc248b863/layer.tar</span></pre><p id="7ad5" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">输出:</p><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="5cb8" class="nc lg in my b gy nd ne l nf ng">x etc/<br/>x sensitive.txt</span></pre><ul class=""><li id="5788" class="mk ml in kc b kd ke kh ki kl mm kp mn kt mo kx mp mq mr ms bi translated"><em class="mg"> sensitive.txt </em>的打印输出内容</li></ul><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="cd28" class="nc lg in my b gy nd ne l nf ng">&gt; cat sensitive.txt<br/>top-secret- sensitive-info</span></pre><p id="763d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">因此，几个并不复杂的步骤向我们展示了如何检索 Dockerfile 中使用的所有内容。</p></div><div class="ab cl ky kz hr la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ig ih ii ij ik"><blockquote class="md me mf"><p id="b7e2" class="ka kb mg kc b kd ke kf kg kh ki kj kk mh km kn ko mi kq kr ks mj ku kv kw kx ig bi translated"><strong class="kc io"> <em class="in">点击关注，千万不要错过另一篇关于窍门和技巧、生活经验等的文章！</em> </strong></p></blockquote></div><div class="ab cl ky kz hr la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ig ih ii ij ik"><h1 id="c90c" class="lf lg in bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">漏洞修复</h1><p id="5eed" class="pw-post-body-paragraph ka kb in kc b kd nr kf kg kh ns kj kk kl nt kn ko kp nu kr ks kt nv kv kw kx ig bi translated">Docker 中的多阶段构建通常用于减少输出图像大小的最佳实践环境中。</p><p id="4094" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这是真的——多阶段构建的使用将减少图像的大小。多阶段构建还有另一个实际效果，它有助于防止我们之前展示的漏洞。</p><ul class=""><li id="00b9" class="mk ml in kc b kd ke kh ki kl mm kp mn kt mo kx mp mq mr ms bi translated">创建 Dockerfile 文件</li></ul><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="60db" class="nc lg in my b gy nd ne l nf ng">FROM alpine as first<br/>RUN mkdir -p /sens-demo<br/>RUN echo "top-secret" &gt; /sens-demo/sensitive.txt<br/>RUN rm /sens-demo/sensitive.txt<br/>RUN echo "not a secret" &gt; /sens-demo/public.txt<br/>FROM alpine<br/>COPY --from=first /sens-demo ./</span></pre><ul class=""><li id="e783" class="mk ml in kc b kd ke kh ki kl mm kp mn kt mo kx mp mq mr ms bi translated">构建图像</li></ul><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="b785" class="nc lg in my b gy nd ne l nf ng">docker build -f Dockerfile -t layers  .</span></pre><ul class=""><li id="2f99" class="mk ml in kc b kd ke kh ki kl mm kp mn kt mo kx mp mq mr ms bi translated">运行容器和打印输出目录和文件</li></ul><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="fc86" class="nc lg in my b gy nd ne l nf ng">docker run --rm -it layers:latest  ls -la</span></pre><p id="04f2" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">-&gt;找不到敏感的. txt 文件</p><p id="b926" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">下一步-让我们检查图像</p><ul class=""><li id="de90" class="mk ml in kc b kd ke kh ki kl mm kp mn kt mo kx mp mq mr ms bi translated">将图像保存为 tar</li></ul><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="3949" class="nc lg in my b gy nd ne l nf ng">docker save layers&gt; layers.tar</span></pre><ul class=""><li id="7cdd" class="mk ml in kc b kd ke kh ki kl mm kp mn kt mo kx mp mq mr ms bi translated">让我们检查输出 tar 文件</li></ul><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="ea90" class="nc lg in my b gy nd ne l nf ng">mkdir layers_inspect &amp;&amp; tar -xvf layers.tar -C layers_inspect<br/>cd ./layers_inspect<br/>tree .</span></pre><p id="c7a9" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">输出</p><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="91d8" class="nc lg in my b gy nd ne l nf ng">├── 60ff038954ee0fbe0fcbb9a21513ddb881f414e8974ae4eb6b896f3a7a0c0046.json<br/>├── 6e351c54860df6ca38e3d1cb49f253806ec2e42a5aa75a37daa2423a8daad330<br/>│   ├── VERSION<br/>│   ├── json<br/>│   └── layer.tar<br/>├── 8792aa27a60beb94c658afc7fb54a4f1c427afe01b65cec0f2261c193ec3f495<br/>│   ├── VERSION<br/>│   ├── json<br/>│   └── layer.tar<br/>├── manifest.json<br/>└── repositories</span></pre><ul class=""><li id="20d4" class="mk ml in kc b kd ke kh ki kl mm kp mn kt mo kx mp mq mr ms bi translated">让我们检查 docker 图像历史</li></ul><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="ebc6" class="nc lg in my b gy nd ne l nf ng">cat 60ff038954ee0fbe0fcbb9a21513ddb881f414e8974ae4eb6b896f3a7a0c0046.json | jq ‘.history’</span></pre><p id="1125" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">输出</p><pre class="mt mu mv mw gt mx my mz na aw nb bi"><span id="e47f" class="nc lg in my b gy nd ne l nf ng">[</span><span id="0eef" class="nc lg in my b gy nh ne l nf ng">{</span><span id="a0d8" class="nc lg in my b gy nh ne l nf ng">"created": "2022-04-05T00:19:59.790636867Z",</span><span id="7599" class="nc lg in my b gy nh ne l nf ng">"created_by": "/bin/sh -c #(nop) ADD file:5d673d25da3a14ce1f6cf66e4c7fd4f4b85a3759a9d93efb3fd9ff852b5b56e4 in / "</span><span id="4958" class="nc lg in my b gy nh ne l nf ng">},</span><span id="0036" class="nc lg in my b gy nh ne l nf ng">{</span><span id="11bc" class="nc lg in my b gy nh ne l nf ng">"created": "2022-04-05T00:19:59.912662499Z",</span><span id="a070" class="nc lg in my b gy nh ne l nf ng">"created_by": "/bin/sh -c #(nop)  CMD [\"/bin/sh\"]",</span><span id="ba46" class="nc lg in my b gy nh ne l nf ng">"empty_layer": true</span><span id="9d64" class="nc lg in my b gy nh ne l nf ng">},</span><span id="dfbd" class="nc lg in my b gy nh ne l nf ng">{</span><span id="0c84" class="nc lg in my b gy nh ne l nf ng">"created": "2022-04-30T12:08:39.2627571Z",</span><span id="0276" class="nc lg in my b gy nh ne l nf ng">"created_by": "COPY /sens-demo ./ # buildkit",</span><span id="12b6" class="nc lg in my b gy nh ne l nf ng">"comment": "buildkit.dockerfile.v0"</span><span id="7e20" class="nc lg in my b gy nh ne l nf ng">}</span><span id="6db8" class="nc lg in my b gy nh ne l nf ng">]</span></pre><p id="699a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在你可以看到，虽然使用多阶段 docker 映像构建漏洞并没有引入。</p><p id="a8b7" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">记住这个例子，下次构建 Docker 映像时需要使用敏感数据时，使用多阶段构建。</p><blockquote class="md me mf"><p id="b71d" class="ka kb mg kc b kd ke kf kg kh ki kj kk mh km kn ko mi kq kr ks mj ku kv kw kx ig bi translated"><strong class="kc io"> <em class="in">一定要点击关注，千万不要错过另一篇关于窍门和技巧、人生经验等的文章！</em>T3】</strong></p></blockquote><p id="9936" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">编码快乐！！！</p></div></div>    
</body>
</html>