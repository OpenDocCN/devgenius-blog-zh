<html>
<head>
<title>Creating a Safari App Extension</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">创建Safari应用程序扩展</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/creating-a-safari-app-extension-c17573d10270?source=collection_archive---------4-----------------------#2020-06-14">https://blog.devgenius.io/creating-a-safari-app-extension-c17573d10270?source=collection_archive---------4-----------------------#2020-06-14</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><figure class="im in gp gr io ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi il"><img src="../Images/df2a7c889d128a66cb0c8bc8ae635ee3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oEokv50CGWmjWp0xNKNLPw.png"/></div></div></figure><div class=""/><p id="2dc8" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在这篇文章中，我想分享一些从创建Safari应用程序扩展中学到的东西，它的codebase party也用在了一个完全用TypeScript编写的WebExtension中。</p><h2 id="dd8d" class="kt ku iy bd kv kw kx dn ky kz la dp lb kg lc ld le kk lf lg lh ko li lj lk ll bi translated">动机</h2><p id="8f18" class="pw-post-body-paragraph jv jw iy jx b jy lm ka kb kc ln ke kf kg lo ki kj kk lp km kn ko lq kq kr ks ig bi translated">浏览器扩展已经达到了一定的势头，因此谷歌宣布了一个<a class="ae lr" href="https://blog.chromium.org/2020/04/keeping-spam-off-chrome-web-store.html" rel="noopener ugc nofollow" target="_blank">更严格的审查过程</a>，并在2020年8月27日之前从商店中移除不符合这些新规则的扩展。</p><p id="55a9" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">有了基于<a class="ae lr" href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions" rel="noopener ugc nofollow" target="_blank"> Mozilla WebExtension API </a>的扩展，你可以针对所有基于<em class="ls"> Chromium </em>的浏览器，比如<em class="ls"> Chrome </em>、<em class="ls"> Opera </em>和<em class="ls"> Edge </em>以及<em class="ls"> FireFox </em>。为了同时面向Safari用户，您需要一个专用实现:Safari应用程序扩展。如果你还没有在苹果开发者生态系统中工作过，这是一个艰难的步骤，因为有许多障碍需要克服:</p><p id="0b61" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">你需要</p><ul class=""><li id="d148" class="lt lu iy jx b jy jz kc kd kg lv kk lw ko lx ks ly lz ma mb bi translated">用于开发的Mac和XCode，因为你必须提供的应用程序是编译好的代码，将通过苹果应用商店分发。</li><li id="1be0" class="lt lu iy jx b jy mc kc md kg me kk mf ko mg ks ly lz ma mb bi translated">用于签署代码的开发者证书(售价99欧元)。</li><li id="5c94" class="lt lu iy jx b jy mc kc md kg me kk mf ko mg ks ly lz ma mb bi translated">如果你不仅仅依赖内容脚本，重写你现有的扩展的一部分。</li></ul><p id="f337" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">为了获得一些基本的见解，我建议在开始使用自己的Safari应用程序扩展之前，先学习这两个教程:</p><ul class=""><li id="f1e5" class="lt lu iy jx b jy jz kc kd kg lv kk lw ko lx ks ly lz ma mb bi translated">苹果:<a class="ae lr" href="https://developer.apple.com/documentation/safariservices/safari_app_extensions/building_a_safari_app_extension" rel="noopener ugc nofollow" target="_blank">添加、构建并启用Safari应用扩展</a></li><li id="eed3" class="lt lu iy jx b jy mc kc md kg me kk mf ko mg ks ly lz ma mb bi translated">Ulrik Lyngs: <a class="ae lr" href="https://ulriklyngs.com/post/2018/11/02/how-to-build-safari-app-extensions/" rel="noopener ugc nofollow" target="_blank">如何构建Safari应用扩展</a></li></ul><h1 id="82dc" class="mh ku iy bd kv mi mj mk ky ml mm mn lb mo mp mq le mr ms mt lh mu mv mw lk mx bi translated">Mozilla和Safari架构在扩展方面的差异</h1><p id="56c0" class="pw-post-body-paragraph jv jw iy jx b jy lm ka kb kc ln ke kf kg lo ki kj kk lp km kn ko lq kq kr ks ig bi translated">在基于Mozilla API的浏览器扩展中，有不同的组件，你可能需要把它们移植到苹果的平台上。</p><ul class=""><li id="ea8c" class="lt lu iy jx b jy jz kc kd kg lv kk lw ko lx ks ly lz ma mb bi translated"><a class="ae lr" href="https://developer.chrome.com/extensions/content_scripts" rel="noopener ugc nofollow" target="_blank">内容脚本</a>:内容脚本几乎可以不加修改地使用。Safari也支持这些模块。但如果标准没有区别，那就不是苹果了。所以没有<em class="ls"> chrome </em>或者<em class="ls">浏览器</em>对象，而是<em class="ls"> safari </em>，略有不同。</li><li id="2930" class="lt lu iy jx b jy mc kc md kg me kk mf ko mg ks ly lz ma mb bi translated"><a class="ae lr" href="https://developer.chrome.com/extensions/background_pages#manifest" rel="noopener ugc nofollow" target="_blank">后台脚本</a>:坏消息是，你必须在Swift(或ObjC)中完全重写这个功能，因为这个功能需要成为原生组件的一部分。好的一面是，本地代码很快，易于测试，Swift通过XCode提供了很好的支持。后台脚本将被<a class="ae lr" href="https://developer.apple.com/documentation/safariservices/sfsafariextensionhandler" rel="noopener ugc nofollow" target="_blank">扩展处理程序</a>取代。</li><li id="4fdf" class="lt lu iy jx b jy mc kc md kg me kk mf ko mg ks ly lz ma mb bi translated"><a class="ae lr" href="https://developer.chrome.com/extensions/user_interface#popup" rel="noopener ugc nofollow" target="_blank">弹出</a>:是的，你可以在Safari中有弹出窗口，如果按下浏览器工具栏中的App图标，但也需要原生实现。(附故事板)。在苹果的世界里，正确的说法是<a class="ae lr" href="https://developer.apple.com/library/archive/documentation/Tools/Conceptual/SafariExtensionGuide/AddingPopovers/AddingPopovers.html#//apple_ref/doc/uid/TP40009977-CH21-SW1" rel="noopener ugc nofollow" target="_blank"> popover </a>。</li><li id="74a9" class="lt lu iy jx b jy mc kc md kg me kk mf ko mg ks ly lz ma mb bi translated"><a class="ae lr" href="https://developer.chrome.com/extensions/options#linking" rel="noopener ugc nofollow" target="_blank">选项页</a>:否，不支持。该功能要求您在单独模块中实现它，作为本机macOS应用程序的一部分。(包括故事板)</li></ul><h1 id="8eb6" class="mh ku iy bd kv mi mj mk ky ml mm mn lb mo mp mq le mr ms mt lh mu mv mw lk mx bi translated">我的学习</h1><h2 id="db34" class="kt ku iy bd kv kw kx dn ky kz la dp lb kg lc ld le kk lf lg lh ko li lj lk ll bi translated">公共代码库</h2><p id="6e2a" class="pw-post-body-paragraph jv jw iy jx b jy lm ka kb kc ln ke kf kg lo ki kj kk lp km kn ko lq kq kr ks ig bi translated">尽量保持Chrome和Safari之间的代码库在内容脚本上尽可能的相似。重构现有的内容脚本，将浏览器特定的功能放在单独的类/文件中。这主要与内容脚本和扩展处理程序之间的<a class="ae lr" href="https://developer.apple.com/library/archive/documentation/Tools/Conceptual/SafariExtensionGuide/MessagesandProxies/MessagesandProxies.html#//apple_ref/doc/uid/TP40009977-CH14-SW12" rel="noopener ugc nofollow" target="_blank">通信有关(Safari中没有)。</a></p><p id="32bc" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">为了确定你的内容脚本是在safari上运行还是在chrome环境中运行，你可以使用:</p><pre class="my mz na nb gt nc nd ne nf aw ng bi"><span id="a450" class="kt ku iy nd b gy nh ni l nj nk">if (typeof safari !== 'undefined') {<br/>    console.<em class="ls">log</em>("+++ Running on Safari +++");<br/>} else if (typeof chrome !== 'undefined') {<br/>    console.<em class="ls">log</em>("+++ Running on Chromium Platform +++")<br/>} else {<br/>    console.<em class="ls">log</em>("+++ Running on some other Platform +++")<br/>}</span></pre><h2 id="f16f" class="kt ku iy bd kv kw kx dn ky kz la dp lb kg lc ld le kk lf lg lh ko li lj lk ll bi translated">类型脚本支持</h2><p id="d90a" class="pw-post-body-paragraph jv jw iy jx b jy lm ka kb kc ln ke kf kg lo ki kj kk lp km kn ko lq kq kr ks ig bi translated">如果您正在使用TypeScript，那么会为<em class="ls"> safari </em>对象提供一个<a class="ae lr" href="https://www.npmjs.com/package/@types/safari-extension-content" rel="noopener ugc nofollow" target="_blank">类型定义</a>。不幸的是，它不包含<em class="ls"> safari.extension.* </em>的方法签名(但至少现在可以识别<em class="ls"> safari </em>)。</p><h2 id="2d6f" class="kt ku iy bd kv kw kx dn ky kz la dp lb kg lc ld le kk lf lg lh ko li lj lk ll bi translated">处理扩展处理程序</h2><p id="c3dd" class="pw-post-body-paragraph jv jw iy jx b jy lm ka kb kc ln ke kf kg lo ki kj kk lp km kn ko lq kq kr ks ig bi translated">如果您的内容脚本正在向扩展处理程序发送消息，该消息将触发方法<em class="ls"> messageReceived </em>，您可以在其中处理数据。对于每条消息，都将有一个新的扩展处理程序实例，因此您不能在扩展处理程序之间共享信息，除非您将变量设为静态。</p><h2 id="3a60" class="kt ku iy bd kv kw kx dn ky kz la dp lb kg lc ld le kk lf lg lh ko li lj lk ll bi translated">项目目标</h2><p id="64f8" class="pw-post-body-paragraph jv jw iy jx b jy lm ka kb kc ln ke kf kg lo ki kj kk lp km kn ko lq kq kr ks ig bi translated">Safari应用程序扩展的项目至少包含两个目标:</p><ul class=""><li id="fc2c" class="lt lu iy jx b jy jz kc kd kg lv kk lw ko lx ks ly lz ma mb bi translated">作为分发容器的本机macOS应用程序。</li><li id="0ae3" class="lt lu iy jx b jy mc kc md kg me kk mf ko mg ks ly lz ma mb bi translated">将与浏览器集成的Safari应用程序扩展。</li></ul><p id="ba18" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">不要移除其中一个。你的应用扩展既不会运行，也不会通过苹果的审查程序。</p><h2 id="c68e" class="kt ku iy bd kv kw kx dn ky kz la dp lb kg lc ld le kk lf lg lh ko li lj lk ll bi translated">清理本机macOS应用程序的生成代码</h2><p id="4647" class="pw-post-body-paragraph jv jw iy jx b jy lm ka kb kc ln ke kf kg lo ki kj kk lp km kn ko lq kq kr ks ig bi translated">如果你专注于Safari应用扩展，原生macOS应用将几乎没有任何功能。尽管如此，您可能还是想看一下应用程序，因为它在用户的应用程序文件夹中，当然这也是审核过程的一部分。</p><ul class=""><li id="8d8d" class="lt lu iy jx b jy jz kc kd kg lv kk lw ko lx ks ly lz ma mb bi translated">移除未使用的菜单项(自动生成的视图有一个“帮助”菜单，没有内容)</li><li id="1706" class="lt lu iy jx b jy mc kc md kg me kk mf ko mg ks ly lz ma mb bi translated">在macOS应用程序中，有一个在Safari中打开“应用程序扩展”标签的链接。确保它有效。(如果重构应用程序命名，可能会损坏)。</li><li id="290f" class="lt lu iy jx b jy mc kc md kg me kk mf ko mg ks ly lz ma mb bi translated">坚持界面指南(自动生成的视图没有标题栏)。</li></ul><h2 id="0ccf" class="kt ku iy bd kv kw kx dn ky kz la dp lb kg lc ld le kk lf lg lh ko li lj lk ll bi translated">从图像中移除标题，否则构建会中断</h2><p id="2149" class="pw-post-body-paragraph jv jw iy jx b jy lm ka kb kc ln ke kf kg lo ki kj kk lp km kn ko lq kq kr ks ig bi translated">您可以使用矢量图形(PDF)或位图(PNG)作为工具栏图标。如果你添加图像，你必须在命令行使用<strong class="jx iz"> xattr -cr </strong>来删除预览的标题。否则你将会以一个非零退出代码结束<strong class="jx iz">命令代码设计失败。</strong></p><pre class="my mz na nb gt nc nd ne nf aw ng bi"><span id="a4c3" class="kt ku iy nd b gy nh ni l nj nk">CodeSign xxx.app (in target ‘xxx’ from project ‘xxx’)</span><span id="1080" class="kt ku iy nd b gy nl ni l nj nk">cd xxx</span><span id="29ba" class="kt ku iy nd b gy nl ni l nj nk">export CODESIGN_ALLOCATE=/Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/codesign_allocate</span><span id="420f" class="kt ku iy nd b gy nl ni l nj nk">Signing Identity: “Apple Development: xy@gmx.at (xxxxxxxx)”</span><span id="09c3" class="kt ku iy nd b gy nl ni l nj nk">/usr/bin/codesign — force — sign F50F8AC5AE578F274F67697238501C192F618474 -o runtime — entitlements xxx — timestamp=none xxxx.app</span><span id="13a0" class="kt ku iy nd b gy nl ni l nj nk">xxx.app: resource fork, Finder information, or similar detritus not allowed</span><span id="46dc" class="kt ku iy nd b gy nl ni l nj nk"><strong class="nd iz">Command CodeSign failed with a nonzero exit code</strong></span></pre><p id="a589" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">附注:工具栏图标只有一种颜色和透明背景。</p><h2 id="390e" class="kt ku iy bd kv kw kx dn ky kz la dp lb kg lc ld le kk lf lg lh ko li lj lk ll bi translated">创建Popover</h2><p id="f839" class="pw-post-body-paragraph jv jw iy jx b jy lm ka kb kc ln ke kf kg lo ki kj kk lp km kn ko lq kq kr ks ig bi translated">创建弹出窗口需要四个步骤。</p><ul class=""><li id="4c52" class="lt lu iy jx b jy jz kc kd kg lv kk lw ko lx ks ly lz ma mb bi translated">在Info.plist中，在子树<em class="ls"> SFSafariToolbarItem </em>中将“Action”从“Command”改为“Popover”。</li></ul><figure class="my mz na nb gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi nm"><img src="../Images/a48ab4a507167f1e1e855b0eefda3677.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GjMFSSbkjVV_TDIDo7LfVw.png"/></div></div></figure><ul class=""><li id="1d29" class="lt lu iy jx b jy jz kc kd kg lv kk lw ko lx ks ly lz ma mb bi translated">在扩展的构建目标中，在“General”中选择主界面的XIB文件。</li></ul><figure class="my mz na nb gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi nm"><img src="../Images/38433163a84750cade4e0602ce1bd3a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cWUxOIWJwOSdIqYE_hf6ag.png"/></div></div></figure><ul class=""><li id="0f77" class="lt lu iy jx b jy jz kc kd kg lv kk lw ko lx ks ly lz ma mb bi translated">您需要控制器的相应实现；但是在生成的XCode项目中有一个标准的实现。</li></ul><pre class="my mz na nb gt nc nd ne nf aw ng bi"><span id="043c" class="kt ku iy nd b gy nh ni l nj nk">import SafariServices</span><span id="baea" class="kt ku iy nd b gy nl ni l nj nk">class SafariExtensionViewController: SFSafariExtensionViewController {<br/>   static let shared: SafariExtensionViewController = {<br/>   let shared = SafariExtensionViewController()<br/>   shared.preferredContentSize = NSSize(width:320, height:240)<br/>   return shared<br/>   }()<br/>}</span></pre><ul class=""><li id="e73a" class="lt lu iy jx b jy jz kc kd kg lv kk lw ko lx ks ly lz ma mb bi translated">在扩展处理程序中覆盖<em class="ls"> popoverViewController </em>方法:</li></ul><pre class="my mz na nb gt nc nd ne nf aw ng bi"><span id="084a" class="kt ku iy nd b gy nh ni l nj nk">override func popoverViewController() -&gt; SFSafariExtensionViewController {<br/>   return SafariExtensionViewController.shared<br/>}</span></pre><h2 id="ee82" class="kt ku iy bd kv kw kx dn ky kz la dp lb kg lc ld le kk lf lg lh ko li lj lk ll bi translated">AppStore评论</h2><p id="5e8a" class="pw-post-body-paragraph jv jw iy jx b jy lm ka kb kc ln ke kf kg lo ki kj kk lp km kn ko lq kq kr ks ig bi translated">带有英语音频解释的简短视图将有助于评论更好地理解您的扩展的功能。您只需将其上传到AppStore Connect即可。扩展的截图必须用Safari制作。</p><p id="db60" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我希望这些见解对你有所帮助。查看<a class="ae lr" href="https://www.minimal-consent.com" rel="noopener ugc nofollow" target="_blank">最小同意</a>以了解“行动”中的理论。</p></div></div>    
</body>
</html>