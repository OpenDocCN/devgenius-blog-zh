<html>
<head>
<title>Restructuring a Laravel controller using Form Request Validation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用表单请求验证重构 Laravel 控制器</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/restructuring-a-laravel-controller-using-form-request-validation-e546fe22c298?source=collection_archive---------7-----------------------#2022-05-29">https://blog.devgenius.io/restructuring-a-laravel-controller-using-form-request-validation-e546fe22c298?source=collection_archive---------7-----------------------#2022-05-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="beae" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">Laravel 重构——Laravel 从头开始创建管理面板——第 10 部分</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/193b1c3321086dbad2c2a94fa86f6b24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*AkYq86COQcT3SoFB"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">Julia Solonina 在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><h1 id="cfbe" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">代码重构</h1><p id="e62f" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated"><a class="ae kv" href="https://github.com/balajidharma/basic-laravel-admin-panel" rel="noopener ugc nofollow" target="_blank">基本 Laravel 管理面板</a>在最初发布时已经完成。在这一部分，我们将重组我们的控制器。</p><p id="9d94" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">代码重构是重构现有代码的重要过程。</p><blockquote class="mp mq mr"><p id="3e62" class="lo lp ms lq b lr mk jr lt lu ml ju lw mt mm lz ma mu mn md me mv mo mh mi mj ij bi translated">重构旨在改进应用程序的设计、结构和/或实现</p></blockquote><h1 id="24b6" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">控制器验证</h1><p id="0efd" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">Laravel 控制器从基本控制器扩展而来。这个基本控制器已经继承了<a class="ae kv" href="https://github.com/laravel/laravel/blob/master/app/Http/Controllers/Controller.php#L12" rel="noopener ugc nofollow" target="_blank"> ValidatesRequests 特征</a>。因此 ValidatesRequests 特征让您可以访问我们的控制器方法中的 validate 方法。</p><p id="704c" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们在下面的用户存储方法中使用验证方法</p><p id="dfc3" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated"><code class="fe mw mx my mz b">app/Http/Controllers/Admin/UserController.php</code></p><pre class="kg kh ki kj gt na mz nb bn nc nd bi"><span id="1b95" class="ne kx iq mz b be nf ng l nh ni">public function store(Request $request)<br/>{<br/>    $request-&gt;validate([<br/>        'name' =&gt; ['required', 'string', 'max:255'],<br/>        'email' =&gt; ['required', 'string', 'email', 'max:255', 'unique:users'],<br/>        'password' =&gt; ['required', 'confirmed', Rules\Password::defaults()],<br/>    ]);<br/>    $user = User::create([<br/>        'name' =&gt; $request-&gt;name,<br/>        'email' =&gt; $request-&gt;email,<br/>        'password' =&gt; Hash::make($request-&gt;password),<br/>    ]);<br/>    if(! empty($request-&gt;roles)) {<br/>        $user-&gt;assignRole($request-&gt;roles);<br/>    }<br/>    return redirect()-&gt;route('user.index')<br/>                    -&gt;with('message','User created successfully.');<br/>}</span></pre><h1 id="3aea" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">控制器重构</h1><p id="df04" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated"><code class="fe mw mx my mz b">serController</code>存储功能执行以下 4 个动作。</p><pre class="kg kh ki kj gt na mz nj nk aw nl bi"><span id="654a" class="nm kx iq mz b gy nn no l np ni">public function store(Request $request)<br/>{<br/>    // validate from request</span><span id="a0e7" class="nm kx iq mz b gy nq no l np ni">    // Create a user</span><span id="c005" class="nm kx iq mz b gy nq no l np ni">    // Assign role to user</span><span id="6711" class="nm kx iq mz b gy nq no l np ni">    // Redirect <br/>}</span></pre><blockquote class="mp mq mr"><p id="2ff3" class="lo lp ms lq b lr mk jr lt lu ml ju lw mt mm lz ma mu mn md me mv mo mh mi mj ij bi translated"><a class="ae kv" href="https://en.wikipedia.org/wiki/Single-responsibility_principle" rel="noopener ugc nofollow" target="_blank">单一责任原则</a> (SRP)类或函数应该对程序功能的单一部分负责，并且应该封装该部分。</p></blockquote><p id="0c8f" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">让我们在控制器中实现单一责任原则。首先，我们通过使用 Laravel <a class="ae kv" href="https://laravel.com/docs/validation#form-request-validation" rel="noopener ugc nofollow" target="_blank">表单请求验证</a>来分离我们的验证</p><h1 id="8cd2" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">表单请求验证</h1><p id="b521" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">Latavel 表单请求是定制的请求类，封装了它们自己的验证和授权逻辑。要创建表单请求类，使用 Artisan CLI <code class="fe mw mx my mz b">make:request</code>命令</p><pre class="kg kh ki kj gt na mz nj nk aw nl bi"><span id="caf6" class="nm kx iq mz b gy nn no l np ni">sail artisan make:request Admin/StoreUserRequest</span></pre><p id="3b00" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">Artisan CLI 创建了 StoreUserRequest 类。打开该类并复制验证规则</p><p id="cd53" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated"><code class="fe mw mx my mz b">app/Http/Requests/Admin/StoreUserRequest.php</code></p><pre class="kg kh ki kj gt na mz nb bn nc nd bi"><span id="8161" class="ne kx iq mz b be nf ng l nh ni">&lt;?php<br/>namespace App\Http\Requests\Admin;<br/>use Illuminate\Foundation\Http\FormRequest;<br/>use Illuminate\Validation\Rules;<br/>class StoreUserRequest extends FormRequest<br/>{<br/>    /**<br/>     * Determine if the user is authorized to make this request.<br/>     *<br/>     * @return bool<br/>     */<br/>    public function authorize()<br/>    {<br/>        return true;<br/>    }<br/>    /**<br/>     * Get the validation rules that apply to the request.<br/>     *<br/>     * @return array&lt;string, mixed&gt;<br/>     */<br/>    public function rules()<br/>    {<br/>        return [<br/>            'name' =&gt; ['required', 'string', 'max:255'],<br/>            'email' =&gt; ['required', 'string', 'email', 'max:255', 'unique:users'],<br/>            'password' =&gt; ['required', 'confirmed', Rules\Password::defaults()],<br/>        ];<br/>    }<br/>}</span></pre><p id="65c8" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">现在打开用户控制器，进行如下更改</p><pre class="kg kh ki kj gt na mz nb bn nc nd bi"><span id="5d31" class="ne kx iq mz b be nf ng l nh ni">+++ b/app/Http/Controllers/Admin/UserController.php<br/>@@ -3,6 +3,7 @@<br/> namespace App\Http\Controllers\Admin;<br/> use App\Http\Controllers\Controller;<br/>+use App\Http\Requests\Admin\StoreUserRequest;<br/> use App\Models\User;<br/> use App\Models\Role;<br/> use Illuminate\Http\Request;<br/>@@ -63,17 +64,11 @@ class UserController extends Controller<br/>     /**<br/>      * Store a newly created resource in storage.<br/>      *<br/>-     * @param  \Illuminate\Http\Request  $request<br/>+     * @param  \App\Http\Requests\Admin\StoreUserRequest  $request<br/>      * @return \Illuminate\Http\Response<br/>      */<br/>-    public function store(Request $request)<br/>+    public function store(StoreUserRequest  $request)<br/>     {<br/>-        $request-&gt;validate([<br/>-            'name' =&gt; ['required', 'string', 'max:255'],<br/>-            'email' =&gt; ['required', 'string', 'email', 'max:255', 'unique:users'],<br/>-            'password' =&gt; ['required', 'confirmed', Rules\Password::defaults()],<br/>-        ]);<br/>-<br/>         $user = User::create([<br/>             'name' =&gt; $request-&gt;name,<br/>             'email' =&gt; $request-&gt;email,</span></pre><p id="2ab2" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们可以对我们的用户更新方法做同样的事情</p><pre class="kg kh ki kj gt na mz nj nk aw nl bi"><span id="dec7" class="nm kx iq mz b gy nn no l np ni">sail artisan make:request Admin/UpdateUserRequest</span></pre><p id="06d2" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">将下面的代码复制到<code class="fe mw mx my mz b">UpdateUserRequest</code>上</p><p id="ea04" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated"><code class="fe mw mx my mz b">app/Http/Requests/Admin/UpdateUserRequest.php</code></p><pre class="kg kh ki kj gt na mz nb bn nc nd bi"><span id="d87e" class="ne kx iq mz b be nf ng l nh ni">&lt;?php<br/>namespace App\Http\Requests\Admin;<br/>use Illuminate\Foundation\Http\FormRequest;<br/>use Illuminate\Validation\Rules;<br/>class UpdateUserRequest extends FormRequest<br/>{<br/>    /**<br/>     * Determine if the user is authorized to make this request.<br/>     *<br/>     * @return bool<br/>     */<br/>    public function authorize()<br/>    {<br/>        return true;<br/>    }<br/>    /**<br/>     * Get the validation rules that apply to the request.<br/>     *<br/>     * @return array&lt;string, mixed&gt;<br/>     */<br/>    public function rules()<br/>    {<br/>        return [<br/>            'name' =&gt; ['required', 'string', 'max:255'],<br/>            'email' =&gt; ['required', 'string', 'email', 'max:255', 'unique:users,email,'.$this-&gt;user-&gt;id],<br/>            'password' =&gt; ['nullable','confirmed', Rules\Password::defaults()],<br/>        ];<br/>    }<br/>}</span></pre><p id="f48b" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">打开用户控制器，将 param 请求更新为<code class="fe mw mx my mz b">UpdateUserRequest</code>，然后取消对更新方法的验证。确保包括控制器顶部的<code class="fe mw mx my mz b">use App\Http\Requests\Admin\UpdateUserRequest;</code></p><p id="0e0b" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们最终的存储和更新方法是在使用表单请求重新构造验证之后。</p><pre class="kg kh ki kj gt na mz nb bn nc nd bi"><span id="53c4" class="ne kx iq mz b be nf ng l nh ni">public function store(StoreUserRequest  $request)<br/>{<br/>    $user = User::create([<br/>        'name' =&gt; $request-&gt;name,<br/>        'email' =&gt; $request-&gt;email,<br/>        'password' =&gt; Hash::make($request-&gt;password),<br/>    ]);<br/>    if(! empty($request-&gt;roles)) {<br/>        $user-&gt;assignRole($request-&gt;roles);<br/>    }<br/>    return redirect()-&gt;route('user.index')<br/>                    -&gt;with('message','User created successfully.');<br/>}<br/>public function update(UpdateUserRequest $request, User $user)<br/>{<br/>    $user-&gt;update([<br/>        'name' =&gt; $request-&gt;name,<br/>        'email' =&gt; $request-&gt;email,<br/>    ]);<br/>    if($request-&gt;password){<br/>        $user-&gt;update([<br/>            'password' =&gt; Hash::make($request-&gt;password),<br/>        ]);<br/>    }<br/>    $roles = $request-&gt;roles ?? [];<br/>    $user-&gt;assignRole($roles);<br/>    return redirect()-&gt;route('user.index')<br/>                    -&gt;with('message','User updated successfully.');<br/>}</span></pre><p id="6a4a" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">下一部分我们将做更多的重构。</p><div class="nr ns gp gr nt nu"><a rel="noopener  ugc nofollow" target="_blank" href="/how-to-enable-xdebug-on-laravel-sail-and-debugging-code-with-vs-code-872fd750b340"><div class="nv ab fo"><div class="nw ab nx cl cj ny"><h2 class="bd ir gy z fp nz fr fs oa fu fw ip bi translated">如何在 Laravel Sail 上启用 Xdebug 并用 VS 代码调试代码</h2><div class="ob l"><h3 class="bd b gy z fp nz fr fs oa fu fw dk translated">用 XDebug 和 Visual Studio 代码调试 Laravel</h3></div><div class="oc l"><p class="bd b dl z fp nz fr fs oa fu fw dk translated">blog.devgenius.io</p></div></div><div class="od l"><div class="oe l of og oh od oi kp nu"/></div></div></a></div><p id="cf18" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">Laravel 管理面板可在 https://github.com/balajidharma/basic-laravel-admin-panel 的<a class="ae kv" href="https://github.com/balajidharma/basic-laravel-admin-panel" rel="noopener ugc nofollow" target="_blank">获得。安装管理面板并分享您的反馈。</a></p><p id="857c" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">感谢您的阅读。</p><p id="7ca0" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">敬请关注更多内容！</p><p id="ca19" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">【balajidharma.medium.com】跟我来<a class="ae kv" href="https://balajidharma.medium.com/" rel="noopener"><strong class="lq ir"><em class="ms"/></strong></a>。</p></div><div class="ab cl oj ok hu ol" role="separator"><span class="om bw bk on oo op"/><span class="om bw bk on oo op"/><span class="om bw bk on oo"/></div><div class="ij ik il im in"><p id="459d" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">上一部分—第 9 部分:<a class="ae kv" href="https://medium.com/dev-genius/laravel-create-an-account-update-page-for-admin-users-e123cd88f24b" rel="noopener">为管理员用户创建帐户更新页面</a></p><p id="52d9" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">下一部分—第 11 部分:<a class="ae kv" rel="noopener ugc nofollow" target="_blank" href="/restructuring-a-laravel-controller-using-services-action-classes-288b802122b5">使用服务&amp;动作类</a>重构 Laravel 控制器</p></div></div>    
</body>
</html>