<html>
<head>
<title>Securing Secrets in EKS (Kubernetes)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">保护EKS的秘密(Kubernetes)</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/securing-secrets-in-eks-kubernetes-104956972f20?source=collection_archive---------2-----------------------#2021-01-05">https://blog.devgenius.io/securing-secrets-in-eks-kubernetes-104956972f20?source=collection_archive---------2-----------------------#2021-01-05</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/ee850eb9674702be75637cff00ac9a43.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ZTCkSWma79C7alU1"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">安妮·斯普拉特在<a class="ae jz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="fc11" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">每个人都有秘密。我们必须正确管理机密，因为它们通常包含证书和密钥等敏感信息。那么在Kubernetes (k8s)中应该如何处理秘密呢？</p><p id="6a25" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">默认情况下，k8s提供<a class="ae jz" href="https://kubernetes.io/docs/concepts/configuration/secret/" rel="noopener ugc nofollow" target="_blank"> Kubernetes Secrets </a>进行秘密管理。K8s secrets非常灵活，允许pods从控制平面请求机密，然后这些机密可以通过环境变量在容器中公开，或者作为卷装入容器的文件系统<a class="ae jz" href="https://kubernetes.io/docs/concepts/configuration/secret/#use-cases" rel="noopener ugc nofollow" target="_blank"> * </a>。当秘密被装载到容器的文件系统中时，当秘密被更新时，它也会自动更新<a class="ae jz" href="https://kubernetes.io/docs/concepts/configuration/secret/#mounted-secrets-are-updated-automatically" rel="noopener ugc nofollow" target="_blank"> * </a>。K8s secrets对象与pod分离，并且是独立创建的，因此您可以跨多个pod重用机密。</p><p id="357d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">K8s机密是处理k8s内部机密的强大方法，但是默认行为并不总是安全的，了解风险以及如何管理它们非常重要。</p></div><div class="ab cl ky kz hr la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ig ih ii ij ik"><h2 id="db4d" class="lf lg in bd lh li lj dn lk ll lm dp ln kl lo lp lq kp lr ls lt kt lu lv lw lx bi translated">静态加密</h2><p id="ca66" class="pw-post-body-paragraph ka kb in kc b kd ly kf kg kh lz kj kk kl ma kn ko kp mb kr ks kt mc kv kw kx ig bi translated">K8s secrets的工作原理是将秘密存储在控制平面的<a class="ae jz" href="https://github.com/etcd-io/etcd" rel="noopener ugc nofollow" target="_blank"> etcd </a>中。默认情况下，机密只是etcd中的base 64编码，这与纯文本基本相同。由于etcd位于控制平面，在EKS你无法直接访问它，这并不一定是一件坏事，但是EKS确实提供了一种进一步锁定它的方法。在集群创建过程中，您需要在EKS集群中打开<a class="ae jz" href="https://aws.amazon.com/about-aws/whats-new/2020/03/amazon-eks-adds-envelope-encryption-for-secrets-with-aws-kms/" rel="noopener ugc nofollow" target="_blank">信封加密</a>，以进一步保护您的静态秘密。请注意，这仅适用于集群创建(此时不能在集群创建后进行)。</p><h2 id="3e56" class="lf lg in bd lh li lj dn lk ll lm dp ln kl lo lp lq kp lr ls lt kt lu lv lw lx bi translated">命名空间</h2><p id="4113" class="pw-post-body-paragraph ka kb in kc b kd ly kf kg kh lz kj kk kl ma kn ko kp mb kr ks kt mc kv kw kx ig bi translated">机密被隔离在一个名称空间内，这意味着它们只能由在同一名称空间内运行的所有pod访问。为了保护您的秘密，您需要将您的应用程序隔离到单独的名称空间中，这样您的每个应用程序只能访问它需要的秘密，仅此而已。在应用程序被破坏的情况下，您还将减少爆炸半径，因为该应用程序只能访问其名称空间中的机密。</p><h2 id="61d5" class="lf lg in bd lh li lj dn lk ll lm dp ln kl lo lp lq kp lr ls lt kt lu lv lw lx bi translated">节点安全性</h2><p id="02c2" class="pw-post-body-paragraph ka kb in kc b kd ly kf kg kh lz kj kk kl ma kn ko kp mb kr ks kt mc kv kw kx ig bi translated">在每个节点上运行的kubelet负责从控制平面获取机密，并将机密卷安装到pod中。它还会定期检查装载的机密的新鲜度。这意味着kubelet非常强大，因为它可以访问所有的秘密，并且知道秘密何时更新。如果攻击者能够获得作为EKS集群一部分的ec2机器的超级用户访问权限，他们就可以冒充kubelet。我们可以做的一件事是锁定对机器的ssh访问，这样攻击者就很难通过从ec2的安全组中删除任何端口22入口来访问机器。为了将访问权还给用户，我们可以用<a class="ae jz" href="https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager.html" rel="noopener ugc nofollow" target="_blank"> AWS会话管理器</a>来代替它，这样只有经过身份验证的IAM角色或用户才能访问ec2机器的控制台。</p><p id="aeec" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们还需要防止恶意机器加入您的集群。与EKS位于同一VPC的工作者节点可以通过运行<a class="ae jz" href="https://github.com/awslabs/amazon-eks-ami/blob/master/files/bootstrap.sh" rel="noopener ugc nofollow" target="_blank"> bootstrap.sh </a>来加入EKS集群，只要工作者节点的实例角色被映射到<a class="ae jz" href="https://docs.aws.amazon.com/eks/latest/userguide/add-user-role.html" rel="noopener ugc nofollow" target="_blank"> aws-auth </a>配置图中的正确组和用户名。因此，这个配置图只能由集群管理员更新，这一点非常重要。</p><h2 id="c57a" class="lf lg in bd lh li lj dn lk ll lm dp ln kl lo lp lq kp lr ls lt kt lu lv lw lx bi translated">秘密的处理</h2><p id="0e74" class="pw-post-body-paragraph ka kb in kc b kd ly kf kg kh lz kj kk kl ma kn ko kp mb kr ks kt mc kv kw kx ig bi translated">根据您创建或生成秘密的方式，您需要一种方法来存储它们并将它们导入到您的集群中。有很多解决这个问题的开源项目。</p><p id="45db" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">第一个我想提到的是来自Bitnami的<a class="ae jz" href="https://github.com/bitnami-labs/sealed-secrets" rel="noopener ugc nofollow" target="_blank">密封的秘密</a>。这个项目试图通过让您将秘密安全地存储在git中来解决这个问题。您需要将Sealed Secrets控制器部署到您的集群上，然后当您创建您的秘密时，您调用您的集群上的控制器，您将需要访问您的k8s api，以便使用公钥对它进行加密。</p><p id="c7b4" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">示例:</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="fde8" class="lf lg in mi b gy mm mn l mo mp">apiVersion: bitnami.com/v1alpha1<br/>kind: SealedSecret<br/>metadata:<br/>  name: mysecret<br/>  namespace: mynamespace<br/>spec:<br/>  encryptedData:<br/>    foo: AgBy3i4OJSWK+PiTySYZZA9rO43cGDEq.....</span></pre><p id="bc13" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">然后，当您将SealedSecret部署到您的集群中时，Sealed secret将解密资源，然后在您的集群中创建一个普通的k8s secret。然后你的应用程序可以引用k8s秘密资源。因为SealedSecret是加密的，所以可以将它们提交给git存储库。有了密封的秘密，您可以确保您的整个秘密供应链受到保护。</p><p id="adba" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">另一种方法是利用GoDaddy的E <a class="ae jz" href="https://github.com/external-secrets/kubernetes-external-secrets" rel="noopener ugc nofollow" target="_blank">外部秘密</a>和<a class="ae jz" href="https://aws.amazon.com/secrets-manager/" rel="noopener ugc nofollow" target="_blank"> AWS秘密管理器</a>。External Secret使用控制器将数据从外部源引入k8s。通过这个设置，您将把您的秘密上传到AWS Secret Manager，并使用External Secret将其从Secret Manager导入k8s。类似于密封的秘密，您将需要创建一个自定义资源来指定秘密的来源。</p><p id="7e86" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">示例:</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="357f" class="lf lg in mi b gy mm mn l mo mp">apiVersion: 'kubernetes-client.io/v1'<br/>kind: ExternalSecret<br/>metadata:<br/>  name: hello-service<br/>spec:<br/>  backendType: secretsManager<br/>  # optional: specify role to assume when retrieving the data<br/>  roleArn: arn:aws:iam::123456789012:role/test-role<br/>  data:<br/>    - key: hello-service/password<br/>      name: password<br/>  # optional: specify a template with any additional markup you would like added to the downstream Secret resource.<br/>  # This template will be deep merged without mutating any existing fields. For example: you cannot override metadata.name.<br/>  template:<br/>    metadata:<br/>      annotations:<br/>        cat: cheese<br/>      labels:<br/>        dog: farfel</span></pre><p id="3af6" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这个资源将告诉控制器去从秘密管理器中获取秘密，然后它将在k8s中创建一个秘密资源。类似于密封的秘密，这允许我们安全地处理秘密直到集群。</p></div><div class="ab cl ky kz hr la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ig ih ii ij ik"><p id="c495" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这些只是我在EKS保护我们自己的k8s秘密时发现的一些技巧，希望它们能对你的EKS之旅有所帮助。</p></div></div>    
</body>
</html>