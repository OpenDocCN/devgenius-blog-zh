# 卡桑德拉墓碑简单地解释道

> 原文：<https://blog.devgenius.io/cassandra-tombstones-simply-explained-eba7ebb86d54?source=collection_archive---------2----------------------->

![](img/a991c35ee8938e2458bb82df76f644eb.png)

在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上由 [Ahmed Adly](https://unsplash.com/@ahmedadly?utm_source=medium&utm_medium=referral) 拍摄的照片

每当您删除一些数据时，Cassandra 中就会创建墓碑。简单地说，墓碑与您刚刚删除的数据行非常相似，只是增加了一个特殊的“删除”标记，告诉数据库数据已被删除。

假设您的表中有一行 A，您删除该行，就像删除关系或非关系数据库中的任何行一样。Cassandra 并没有立即删除这些数据，而是在这些数据上添加了一个“删除标记”,并告诉您这些数据已经被删除了。

“删除标记”包括关于删除操作本身的一些信息，例如删除了什么以及删除是何时发生的。

所以从技术上来说，假设你删除了一行 2MB 的数据。删除数据时，您应该会释放 2MB 空间。相反，Cassandra 创建了一些带有删除标记的新的元数据，增加了你的“已删除”数据在磁盘中所占的空间。

这很违反直觉。让我们看看卡珊德拉为什么这么做。

# 没有逻辑删除的删除

Cassandra 的分布式特性使得删除具有挑战性。Cassandra 存储数据的方式是跨多个节点复制相同的数据。因此，即使您认为您只有一行数据，在 Cassandra 的世界中，这一行数据会在多台单独的机器中复制。

当您发出 delete 命令时，Cassandra 从一台机器上“删除”数据(或者不管您的写入因素是什么),并确认删除成功。它不会等待确认数据在不同机器中的所有潜在副本都已被删除。如果这样的话，卡珊德拉的写作速度会慢得惊人。

因此，它会确认成功写入，并在后台让其他主机知道您删除了数据，以便所有主机都在同一页面上。

一会儿，让我们想象一下，卡珊德拉刚刚立即删除了数据。此外，让我们假设您的数据复制在 3 个不同的节点上。现在，假设在与其他节点通信时，这台机器删除了您的数据，通信失败。现在，一个节点删除了您的数据，而另外两个节点仍然有数据。

现在，假设您正在读取相同的数据，并且您将读取因子设置为 3。现在这种解读令人困惑！您的两个节点有数据，一个说没有数据。你是做什么的？Cassandra 总是假设正确的做法是返回数据，所以它最终会返回给你已经被删除的数据。这些被称为“僵尸”或“幽灵”数据。

墓碑是解决这个问题的一种方法。让我们看看怎么做。

# 墓碑是如何工作的

逻辑删除是与您刚删除的数据一起存储的特定数据。它包含有关删除操作的信息，例如执行删除的时间。

当你删除一些数据时，卡珊德拉所做的只是插入一个墓碑。然后它会告诉您删除成功。

现在，假设几分钟后您正在读取相同的数据。读取时，Cassandra 会从复制数据的所有节点请求数据。然后，它会将最近一次写入的结果返回给您。

在这种情况下，最后(最近)写入是删除的事件或逻辑删除。因此，Cassandra 知道，即使其他节点不知道数据已被删除，最近的写入是删除。因此，卡桑德拉不会归还任何东西给你。它会考虑删除。

# 墓碑保留多长时间

Cassandra 执行了一个名为压缩的预定操作，您可以将其视为维护操作。该操作整合了主机中相同数据的多个拷贝，并确保未来的读取操作更高效。

在维护/修复过程中，卡桑德拉还负责移除墓碑。多久进行一次是可配置的，你可以控制它。

但是，这并不像每隔几秒钟就运行一次操作来消除逻辑删除块那样简单，因为压缩是一个开销很大的过程，如果运行得太频繁，会影响 Cassandra 集群中的读/写性能。

# 墓碑的另一个被遗忘的来源

除了删除行和分区，还有一个非常奇怪的操作会导致墓碑。很容易忘记这件事。

删除特定的列值或将列值显式设置为 NULL 也可能导致逻辑删除。这些被称为细胞墓碑。

因此，您不希望以这样一种方式设计您的模式，即在一个非常写密集型的应用程序中，将 NULL 显式地写入不同的列。如果这样做，每次在列中写入显式空值的记录时，都会创建逻辑删除。

# 最后的想法

当你决定使用 Cassandra、设计你的表格或者甚至编写 API 来与 Cassandra 对话时，意识到墓碑是有好处的。

您可以运行 CQL 命令来了解数据库中有多少墓碑，并且可以手动运行修复过程来删除它们。如果您决定维护 Cassandra 集群，所有这些都是需要考虑的事情。