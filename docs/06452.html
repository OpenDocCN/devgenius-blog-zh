<html>
<head>
<title>Microservices on AKS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AKS 上的微服务</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/microservices-on-aks-8affc90d9bbd?source=collection_archive---------4-----------------------#2022-01-09">https://blog.devgenius.io/microservices-on-aks-8affc90d9bbd?source=collection_archive---------4-----------------------#2022-01-09</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/57b2fe91bddfec250ccac21937fd133c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pHwUDnuLSaTg5vqGzPb7Cg.png"/></div></div></figure><p id="d074" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">AKS 或 Azure Kubernetes 服务是在云中使用 Kubernetes 最简单快捷的方式。它有助于监控和管理容器化的微服务。在本文中，我们将看到如何在 AKS 上部署微服务，以及相同的好处。</p><p id="7b39" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">什么是 Azure Kubernetes 服务(AKS)？</strong></p><p id="94db" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">Kubernetes(K8S)是一个容器编排开源服务，允许开发者管理他们的容器。说到 K8S，有自管和云管两种。在自我管理的 Kubernetes 中，作为管理员，您完全负责从安装 Kubernetes 到集群创建、管理和安全的所有事情，其中像 Azure 这样的云服务提供商管理基于云的 K8S。从安装到安全，一切都由云提供商处理。</p><p id="42c0" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">所以，Azure Kubernetes Service(AKS)是微软 Azure 提供的容器编排服务，具有自动打补丁、自动伸缩、节点自我修复、与其他 Azure 服务平滑集成等功能。AKS 帮助我们轻松部署容器化的应用程序，具有强大的安全性和可伸缩性。Azure 还通过 Kubernetes 提供无服务器和 CI/CD 管道特性。</p><p id="8570" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">使用 Azure Kubernetes 服务(AKS)有什么特点和好处？</strong></p><p id="8992" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">●灵活的自动化、可扩展性和降低的管理成本。</p><p id="fb85" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">●通过 Azure Monitor 轻松监控集群。</p><p id="6948" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">●支持 GPU 的节点池。</p><p id="0f25" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">●可以使用 AKS 管理门户、AKS CLI 或 Azure 资源管理器来访问和操作 AKS。</p><p id="1207" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">● Azure AD 提供基于角色的对 AK 的访问，以实现安全性和监控。</p><p id="4c88" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">●用户还可以为 AK 创建自定义标签。</p><p id="7cf7" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">●负载平衡</p><p id="54fd" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">●接近零停机时间</p><p id="167a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io"> Azure Kubernetes 服务(AKS)费用</strong></p><p id="04f2" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">AKS 是一项免费服务，因此 Kubernetes 集群管理是免费的，但用户需要支付网络、其他集成资源和计算资源的费用。</p><p id="bd38" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">Kubernetes 的架构</strong></p><p id="a03a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在 Kubernetes 上部署微服务意味着将其部署到 Kubernetes 集群，集群是称为节点的虚拟机的集合。有一个父节点来管理集群，其他节点称为工作节点来运行实际的应用程序。Kubernetes pods 是一个集群的构建块，代表一个运行的进程。pod 被复制以处理更多的流量。</p><figure class="ku kv kw kx gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi kt"><img src="../Images/18db4ebc791d66f84e6939e83bb0e4bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*00jzwqZNaY6_r2UU.png"/></div></div></figure><p id="bbd0" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">在 AK 上部署您的微服务</strong></p><p id="3305" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在让我们看看如何在 Azure Kubernetes Service(AKS)上部署微服务。在我们进入部署部分之前，请确保您已经准备好了微服务的 docker 映像。另外，请下载并安装 Azure CLI。</p><p id="186c" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><a class="ae ky" href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli" rel="noopener ugc nofollow" target="_blank">https://docs . Microsoft . com/en-us/CLI/azure/install-azure-CLI</a></p><p id="9862" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><a class="ae ky" href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli-windows?tabs=azure-cli" rel="noopener ugc nofollow" target="_blank">https://docs . Microsoft . com/en-us/CLI/azure/install-azure-CLI-windows？tabs=azure-cli </a></p><p id="71a3" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">接下来，在本地计算机上安装 Kubernetes CLI 或 Kubectl，以便从本地计算机连接集群。在 Azure CLI 中使用以下命令安装 Kubectl。</p><p id="4245" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="kz"> az aks install-cli </em></p><p id="ddcd" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">此外，您将需要<a class="ae ky" href="https://docs.docker.com/install/" rel="noopener ugc nofollow" target="_blank"> Docker </a>来创建您的微服务的映像，并需要<a class="ae ky" href="https://azure.microsoft.com/en-us/pricing/purchase-options/pay-as-you-go/" rel="noopener ugc nofollow" target="_blank"> Azure 订阅</a>来部署 AKS。</p><p id="dfae" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们开始吧</p><p id="db6f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">创建资源组</strong></p><p id="7ea1" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在 Azure 中创建任何资源之前，首先创建一个资源组。它充当云中资源的逻辑组。可以通过 Azure 门户手动创建，也可以使用 Azure CLI 创建。</p><p id="4ae8" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">查看您的订阅中的可用地区列表:</p><p id="7692" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="kz"> az 账户列表-位置-o 表</em></p><p id="009c" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">您可以在此处查看 AKS <a class="ae ky" href="https://azure.microsoft.com/en-us/global-infrastructure/services/?products=kubernetes-service" rel="noopener ugc nofollow" target="_blank">供货的地区列表。</a></p><p id="4243" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">使用以下代码创建一个资源组，并根据您所在的地区更改[location]:</p><p id="2e10" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="kz">az group create-l[location]-n my resource group</em></p><p id="b7fa" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">创建 Azure 容器注册中心</strong></p><p id="a89d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">ACR 就像是容器映像的私有注册表，可以让您安全地构建和部署应用程序。要创建 Azure 容器注册表，请使用以下命令并用注册表的名称更改[registry-name]。</p><p id="f53a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="kz">az ACR create-g my resource group-n[注册表名称] — sku Basic — admin-enabled </em></p><p id="6c41" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">-n 选项用于指定注册表的名称，-g 用于指定资源组的名称。在输出中，您将看到您的注册中心的服务器，它将是这样的形式— <em class="kz">【注册中心名称】. azurecr.io </em></p><p id="d865" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">将容器图像推入注册表</strong></p><p id="c24d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">登录到您的 Azure 容器注册表，使用 Azure CLI 推送容器映像。</p><p id="ff55" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="kz"> az acr 登录名称</em></p><p id="6076" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">接下来，要将容器图像推入 ACR，我们需要标记它们。让我们假设您有两个名为 system 和 inventory 的容器映像。在本文中，我们不讨论创建容器图像的部分。因为我们的重点是了解映像部署。</p><p id="3033" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">用下面的命令标记您的容器映像，并用您的服务器名替换[registry-server]。</p><p id="8b0d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="kz"> docker 标签系统:1.0-快照【注册表-服务器】/系统:1.0-快照</em></p><p id="5619" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="kz"> docker 标签库存:1.0-快照【注册表-服务器】/库存:1.0-快照</em></p><p id="6333" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">把图像推给 ACR。</p><p id="880d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="kz"> docker 推送【注册表-服务器】/系统:1.0-快照</em></p><p id="0664" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="kz"> docker 推送【注册表-服务器】/库存:1.0-快照</em></p><p id="b2d1" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">在 AKS 上创建 Kubernetes 集群</strong></p><p id="1cec" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">要在 Azure 中创建集群，使用<em class="kz"> az aks create </em>命令。AKS 集群还需要一个服务主体来分配角色和权限，以便与其他资源和 API 进行交互。默认情况下，以下命令将创建一个主体。</p><p id="46d0" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="kz">az aks create-g my resource group-n my cluster</em></p><p id="3e25" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">该命令将在<em class="kz"> myResourceGroup </em>中创建一个名为<em class="kz"> myCluster </em>的集群。您还可以使用<em class="kz">–node-count-c</em>在池中添加特定数量的节点。否则，默认情况下将向节点池分配三个节点。</p><p id="7e14" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">将集群凭据合并到当前 K8S 配置中。</p><p id="19f1" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="kz">az aks get-credentials-g my resource group-n my cluster</em></p><p id="4f76" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">获取群集中正在运行的节点的状态。</p><p id="c85e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="kz"> Kubect1 获取节点</em></p><p id="1f7c" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">存储 Azure 容器注册表凭证</strong></p><p id="3ced" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">注册凭证必须通过一个秘密添加到您的服务中，以便从 ACR 中提取图像。</p><p id="3703" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">查看 ACR 的密码。</p><p id="6ae3" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="kz">az ACR credential show-n[registry-name]—查询“密码[0]”。值"-0 tsv</em></p><p id="9da1" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">创建一个密码来保存注册表的凭据。确保替换[]中所有必需的详细信息，并且[密码]是您的注册表密码。</p><p id="8204" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="kz"> kubectl 创建秘密 docker-registry guide secret \</em></p><p id="077e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="kz">—docker-server =[registry-server]\</em></p><p id="169d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="kz">—docker-username =[registry-name]\</em></p><p id="8d31" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="kz"> — docker-password=【密码】\ </em></p><p id="e64c" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="kz"> — docker-email=【电子邮件地址】</em></p><p id="7e61" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">将微服务部署到 AKS </strong></p><p id="2be6" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们已经创建了集群，我们的容器映像也准备好了。所以现在我们需要将微服务部署到 AKS。</p><p id="a085" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">K8S YAML 文件包含服务、部署等所有信息。我们需要更新它。将[registry-server]替换为您的服务器名称，并将映像名称替换为—<em class="kz">[registry-server]/inventory:1.0-SNAPSHOT</em>和<em class="kz">[registry-server]/system:1.0-SNAPSHOT</em>。部署<em class="kz"> kubernetes.yaml </em>文件的资源。</p><p id="142f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="kz">kube CTL create-f kubernetes . YAML</em></p><p id="5105" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">获取服务的外部 IP 地址来测试它。</p><p id="8817" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="kz"> kubectl 获取服务/系统服务</em></p><p id="8c44" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="kz"> kubectl 获取服务/库存-服务</em></p><p id="c35f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">因此，我们刚刚在 Azure Kubernetes Service(AKS)上部署了我们的微服务，我们可以使用外部 IP 地址来访问微服务。</p></div></div>    
</body>
</html>