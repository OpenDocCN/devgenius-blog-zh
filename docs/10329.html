<html>
<head>
<title>Ingesting Data Into Snowflake (1): Snowflake Stage</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将数据摄取到雪花中(1):雪花阶段</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/ingesting-data-into-snowflake-1-snowflake-stage-10a688cd5eed?source=collection_archive---------8-----------------------#2022-10-24">https://blog.devgenius.io/ingesting-data-into-snowflake-1-snowflake-stage-10a688cd5eed?source=collection_archive---------8-----------------------#2022-10-24</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><div class=""/><figure class="gm go jp jq jr js gi gj paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="gi gj jo"><img src="../Images/3516b2a1ad3f58905398347aa4cdaf45.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EVvqxPCep4dbfctE4YI03g.png"/></div></div><figcaption class="jz ka gk gi gj kb kc bd b be z dk translated">菊芋花在马卡姆，在。2022 年 10 月 2 日</figcaption></figure><p id="0278" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">(雪花存储阶段包括内部阶段，如用户阶段、表阶段、命名阶段和外部阶段。在本帖中，我们将讨论外部阶段。)</p><p id="ab33" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">雪花阶段是一个雪花对象，它定义了访问该桶所需的 AWS S3 桶 URL 和凭据。当然，stage 也支持 Azure 和 GCP 位置。例如:</p><pre class="lb lc ld le gu lf lg lh li aw lj bi"><span id="e331" class="lk ll ir lg b gz lm ln l lo lp">// Create aws_s3_stage object in given database/schema<br/>CREATE OR REPLACE STAGE MYDB.MYSCHEMA.aws_s3_stage<br/>    url='s3://&lt;bucketname&gt;'<br/>    credentials=(aws_key_id='access_key_xxxxxxxx' aws_secret_key='secret_key_yyyyyyyy');</span></pre><p id="fea0" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">创建阶段后，可以使用复制命令从阶段中复制数据。例如:</p><pre class="lb lc ld le gu lf lg lh li aw lj bi"><span id="3e64" class="lk ll ir lg b gz lm ln l lo lp">COPY INTO MYDB.MYSCHEMA.MYTABLE<br/>    FROM <a class="ae lq" href="http://twitter.com/MANAGE_DB" rel="noopener ugc nofollow" target="_blank">@</a>MYDB_MYSCHEMA.aws_s3_stage</span></pre><p id="ef24" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">请注意，需要提前创建表，以使列与 stage 指向的数据文件中的字段保持一致。</p><p id="d8f9" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">另请注意，stage 的范围跨越此雪花帐户中的所有数据库，您可以使用一个 stage 将数据复制到不同数据库的表中。其他用户需要在舞台上被授予“usage”权限，才能使用它来加载数据。</p><p id="898d" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">以下示例为 S3 位置创建数据库、方案和阶段。</p><pre class="lb lc ld le gu lf lg lh li aw lj bi"><span id="c79f" class="lk ll ir lg b gz lm ln l lo lp">use role sysadmin;<br/>create or replace database feng_database;<br/>create or replace schema feng_database.feng_schema;<br/>create or replace schema feng_database.feng_schema_for_stage;</span><span id="e6bb" class="lk ll ir lg b gz lr ln l lo lp">create or replace stage feng_database.feng_schema_for_stage.feng_aws_s3_stage<br/>   url='s3://fengdatafile/flight2015'<br/>   credentials=(aws_key_id='xxxxxxxx' aws_secret_key='yyyyyyyy');</span><span id="9e59" class="lk ll ir lg b gz lr ln l lo lp">show stages in database feng_database;<br/>desc stage feng_database.feng_schema_for_stage.feng_aws_s3_stage;</span><span id="e3d4" class="lk ll ir lg b gz lr ln l lo lp">list <a class="ae lq" href="http://twitter.com/feng_database" rel="noopener ugc nofollow" target="_blank">@feng_database</a>.feng_schema_for_stage.feng_aws_s3_stage;</span></pre><figure class="lb lc ld le gu js gi gj paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="gi gj ls"><img src="../Images/c6807c83ea720d67ad63764be7294ce0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kSqFs1GnfvuRghsbbN5XmQ.png"/></div></div></figure><p id="f437" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">然后我们将创建一个表并读入数据文件。(<a class="ae lq" href="https://github.com/databricks/Spark-The-Definitive-Guide/tree/master/data/flight-data/csv" rel="noopener ugc nofollow" target="_blank">原始数据文件</a></p><pre class="lb lc ld le gu lf lg lh li aw lj bi"><span id="ebf9" class="lk ll ir lg b gz lm ln l lo lp">Create or replace transient table feng_database.feng_schema.flight2015_staging (<br/>      DEST_COUNTRY_NAME varchar(64),<br/>      ORIGIN_COUNTRY_NAME varchar(64),<br/>      count int<br/>);</span><span id="b07f" class="lk ll ir lg b gz lr ln l lo lp">COPY into feng_database.feng_schema.flight2015_staging<br/>    from <a class="ae lq" href="http://twitter.com/feng_database" rel="noopener ugc nofollow" target="_blank">@feng_database</a>.feng_schema_for_stage.feng_aws_s3_stage<br/>    file_format=(type=csv field_delimiter=',' skip_header=1 FIELD_OPTIONALLY_ENCLOSED_BY = '"');</span><span id="b2de" class="lk ll ir lg b gz lr ln l lo lp">select * from feng_database.feng_schema.flight2015_staging;</span></pre><figure class="lb lc ld le gu js gi gj paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="gi gj lt"><img src="../Images/984c153c97871124ef5fd6467056fffe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Cte4ByzDApgUW0EucaFKog.png"/></div></div></figure><p id="86dc" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated"><strong class="kf is">虽然我们可以成功地从 S3 读取数据文件，但我们担心我们需要将我们的 AWS 凭据放在代码中。为了解决这个问题，我们可以在雪花阶段使用雪花存储集成对象来访问 S3。</strong></p><h1 id="97cc" class="lu ll ir bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">使用雪花存储集成对象</h1><p id="0452" class="pw-post-body-paragraph kd ke ir kf b kg mr ki kj kk ms km kn ko mt kq kr ks mu ku kv kw mv ky kz la ik bi translated">雪花存储集成对象使用 AWS 角色来访问 S3 位置。为了承担这个 AWS 角色，根据角色配置，需要一个受信任的实体和一个外部 ID。</p><p id="bf5e" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">因此，我们需要首先创建雪花存储集成对象，并将其实体和 ID 提供给 AWS，以便允许进一步的访问。</p><p id="f8e1" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">因此，我们希望创建如下所示的存储集成…但您会看到，我们需要提供 AWS 角色 ARN。在创建 AWS 角色时，我们必须提供可信的实体和 ID…这很难理解！AWS 和雪花在这里能做得更好吗？</p><pre class="lb lc ld le gu lf lg lh li aw lj bi"><span id="94be" class="lk ll ir lg b gz lm ln l lo lp">create or replace storage integration s3_integration<br/>  TYPE = EXTERNAL_STAGE<br/>  STORAGE_PROVIDER = S3<br/>  ENABLED = TRUE <br/><strong class="lg is">  STORAGE_AWS_ROLE_ARN = '????'<br/></strong>  STORAGE_ALLOWED_LOCATIONS = ('s3://fengdatafile/flight2015/')<br/>  COMMENT = 'To access S3 by assuming a role'</span></pre><p id="afd1" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">所以我们需要有点创意:</p><p id="c583" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">1 使用虚拟可信实体和 ID 创建 AWS 角色</p><p id="375b" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">2 使用上述 AWS 角色 ARN 创建雪花存储集成对象</p><p id="7e91" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">3 返回 AWS，使用上述雪花存储集成对象 ARN 作为真实可信实体和真实 ID 来更新角色。</p><h2 id="1ba5" class="lk ll ir bd lv mw mx dn lz my mz dp md ko na nb mh ks nc nd ml kw ne nf mp ng bi translated"><strong class="ak">首先创建 AWS 角色</strong></h2><p id="a777" class="pw-post-body-paragraph kd ke ir kf b kg mr ki kj kk ms km kn ko mt kq kr ks mu ku kv kw mv ky kz la ik bi translated">转到 IAM -&gt;角色-&gt;创建角色</p><figure class="lb lc ld le gu js gi gj paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="gi gj nh"><img src="../Images/5e4eddc1f850c15a2e36c4b009099d13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*agfxyxncqziUdpfcEBzSMg.png"/></div></div><figcaption class="jz ka gk gi gj kb kc bd b be z dk translated">为可信实体选择“AWS 帐户”</figcaption></figure><figure class="lb lc ld le gu js gi gj paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="gi gj ni"><img src="../Images/f6eb6ca114d02d1cba2d6842b975cada.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q8HnOLOFXuQmEKa3HzVYtA.png"/></div></div><figcaption class="jz ka gk gi gj kb kc bd b be z dk translated">暂时使用“此帐户”和“123456”作为可信实体和外部 ID</figcaption></figure><p id="ca29" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">然后选择“AmazonS3ReadOnlyAccess”权限，给角色名“雪花 _read_S3”来创建角色。请注意这个角色的 ARN。</p><h2 id="42c6" class="lk ll ir bd lv mw mx dn lz my mz dp md ko na nb mh ks nc nd ml kw ne nf mp ng bi translated">接下来，转到雪花创建存储集成对象</h2><pre class="lb lc ld le gu lf lg lh li aw lj bi"><span id="b02c" class="lk ll ir lg b gz lm ln l lo lp">create or replace storage integration s3_integration<br/> TYPE = EXTERNAL_STAGE<br/> STORAGE_PROVIDER = S3<br/> ENABLED = TRUE <br/><strong class="lg is"> STORAGE_AWS_ROLE_ARN = 'arn:aws:iam::xxxx:role/Snowflake_read_S3'<br/></strong> <strong class="lg is">STORAGE_ALLOWED_LOCATIONS </strong>= ('s3://fengdatafile/flight2015/')<br/> COMMENT = 'To access S3 by assuming a role';<br/> <br/>desc storage integration s3_integration;</span></pre><figure class="lb lc ld le gu js gi gj paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="gi gj nj"><img src="../Images/a9b66a2de32d394375226ce8f813f1fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BAiafxw689hoy-9mmGwykw.png"/></div></div></figure><p id="dc80" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">记录存储 AWS IAM 用户 ARN 和存储 AWS 外部 ID。</p><h2 id="41bd" class="lk ll ir bd lv mw mx dn lz my mz dp md ko na nb mh ks nc nd ml kw ne nf mp ng bi translated">并返回到 AWS 以修改具有上述 ARN 和外部 ID 的角色中的“信任策略”。</h2><figure class="lb lc ld le gu js gi gj paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="gi gj nk"><img src="../Images/f73d12494e44f98f1216fa3b36fdf493.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Syu89NmWiEhH_FawRPWtDQ.png"/></div></div><figcaption class="jz ka gk gi gj kb kc bd b be z dk translated">使用新创建的存储集成对象中的真实实体 ARN 和外部 ID 修改信任策略</figcaption></figure><h2 id="3913" class="lk ll ir bd lv mw mx dn lz my mz dp md ko na nb mh ks nc nd ml kw ne nf mp ng bi translated">最后，转到雪花创建一个使用这个存储集成对象访问 S3 的阶段。(在该阶段不提供您的 AWS 凭据。)</h2><pre class="lb lc ld le gu lf lg lh li aw lj bi"><span id="5118" class="lk ll ir lg b gz lm ln l lo lp">CREATE OR REPLACE stage feng_database.feng_schema_for_stage.feng_aws_s3_integration_stage<br/>   url='s3://fengdatafile/flight2015/'<br/>   STORAGE_INTEGRATION = s3_integration;</span><span id="f6e0" class="lk ll ir lg b gz lr ln l lo lp">list <a class="ae lq" href="http://twitter.com/feng_database" rel="noopener ugc nofollow" target="_blank">@feng_database</a>.feng_schema_for_stage.feng_aws_s3_integration_stage;</span></pre><figure class="lb lc ld le gu js gi gj paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="gi gj lt"><img src="../Images/af34cb5c9eae4875486acf2ec3a7c8e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Nqu7gnrFpOUXt7YeyEqdYQ.png"/></div></div></figure><p id="de53" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">正如我们所看到的，只有在创建阶段时指定存储集成对象，我们才能成功读取 S3，而无需提供凭据！</p><p id="dd1c" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated"><strong class="kf is">注意</strong>，stage 中的此“url”必须与存储集成定义中的 STORAGE_ALLOWED_LOCATIONS 相同:“url”为“s3://fengdatafile/flight2015”将不起作用，因为与 STORAGE_ALLOWED_LOCATIONS 相比，它在末尾缺少一个斜杠。也许这在将来可以改进。</p><p id="5be1" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">然后，您可以将数据文件“复制”到您的表中…</p><pre class="lb lc ld le gu lf lg lh li aw lj bi"><span id="b390" class="lk ll ir lg b gz lm ln l lo lp">Create or replace transient table feng_database.feng_schema.flight2015_staging_2 (<br/>      DEST_COUNTRY_NAME varchar(64),<br/>      ORIGIN_COUNTRY_NAME varchar(64),<br/>      count int<br/>);<br/>COPY into feng_database.feng_schema.flight2015_staging_2<br/>    from <a class="ae lq" href="http://twitter.com/feng_database" rel="noopener ugc nofollow" target="_blank">@feng_database</a>.feng_schema_for_stage.feng_aws_s3_integration_stage<br/>    file_format=(type=csv field_delimiter=',' skip_header=1 FIELD_OPTIONALLY_ENCLOSED_BY = '"');<br/>    <br/>select * from feng_database.feng_schema.flight2015_staging_2;</span></pre><p id="6186" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated"><strong class="kf is">注意</strong>，除了为 stage 创建存储集成，您还可以在创建 stage 时直接在“credentials”中指定 IAM 角色，如下所示。</p><pre class="lb lc ld le gu lf lg nl bn nm nn bi"><span id="ff5d" class="no ll ir lg b be np nq l nr lp">CREATE OR REPLACE STAGE MYDB.MYSCHEMA.aws_s3_stage<br/>    url='s3://&lt;bucketname&gt;'<br/>    credentials=(aws_role = 'arn:aws:iam::xxxx:role/Snowflake_read_S3');</span></pre><h1 id="5ed5" class="lu ll ir bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">附录</h1><p id="4203" class="pw-post-body-paragraph kd ke ir kf b kg mr ki kj kk ms km kn ko mt kq kr ks mu ku kv kw mv ky kz la ik bi translated">如果你想创建一个公共的只读 s3 bucket，你可以使用 ACL 规则从"你的 bucket 页-&gt;权限页签" :</p><figure class="lb lc ld le gu js gi gj paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="gi gj ns"><img src="../Images/d45d3dd60021fb3372c0d01677c24f20.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MY_lR5a9h4ZZip7303P6dw.png"/></div></div></figure><p id="5794" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">With bucket 策略设置如下:</p><pre class="lb lc ld le gu lf lg nl bn nm nn bi"><span id="cfac" class="no ll ir lg b be np nq l nr lp">{<br/>    "Version": "2012-10-17",<br/>    "Id": "S3 public access",<br/>    "Statement": [<br/>        {<br/>            "Sid": "Public Read Only",<br/>            "Effect": "Allow",<br/>            "Principal": "*",<br/>            "Action": "s3:getObject",<br/>            "Resource": "arn:aws:s3:::&lt;bucket_name&gt;/*"<br/>        }<br/>    ]<br/>}</span></pre><p id="4308" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">在这种情况下，每个人都可以通过创建如下阶段来阅读/列出您的存储桶:</p><pre class="lb lc ld le gu lf lg nl bn nm nn bi"><span id="9d84" class="no ll ir lg b be np nq l nr lp">CREATE OR REPLACE STAGE MYDB.MYSCHEMA.aws_s3_stage<br/>    url='s3://&lt;bucket_name&gt;'<br/><br/>list @MYDB.MYSCHEMA.aws_s3_stage;</span></pre><p id="563e" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">快乐阅读！</p><div class="nt nu gq gs nv nw"><a href="https://medium.com/@fengliplatform/membership" rel="noopener follow" target="_blank"><div class="nx ab fp"><div class="ny ab nz cl cj oa"><h2 class="bd is gz z fq ob fs ft oc fv fx iq bi translated">通过我的推荐链接-李冯加入媒体</h2><div class="od l"><h3 class="bd b gz z fq ob fs ft oc fv fx dk translated">写作帮助我们自己，分享帮助很多人。从我自己的学习笔记开始，没有要求完美的压力…</h3></div><div class="oe l"><p class="bd b dl z fq ob fs ft oc fv fx dk translated">medium.com</p></div></div><div class="of l"><div class="og l oh oi oj of ok jx nw"/></div></div></a></div></div></div>    
</body>
</html>