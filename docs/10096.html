<html>
<head>
<title>Crossplane finally GitOps for infrastructure!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Crossplane 终于停止了基础设施建设！</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/crossplane-finally-gitops-for-infrastructure-ab1d576cb2b9?source=collection_archive---------3-----------------------#2022-10-07">https://blog.devgenius.io/crossplane-finally-gitops-for-infrastructure-ab1d576cb2b9?source=collection_archive---------3-----------------------#2022-10-07</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/b594b3e04d2b129743ae0c2f53337cbc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FlHe-P0BeCH48vtXL5xy3A.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">【https://crossplane.io/】图片:<a class="ae ka" href="https://crossplane.io/" rel="noopener ugc nofollow" target="_blank"/><em class="jz">版权所有。</em></figcaption></figure><p id="03c4" class="pw-post-body-paragraph kb kc in kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">您可能正在阅读标题，并认为我已经有了一个针对云基础架构的 GitOps 模型。</p><p id="2acc" class="pw-post-body-paragraph kb kc in kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">我使用 Terraform，代码存储在 Git 存储库中。</p><p id="b524" class="pw-post-body-paragraph kb kc in kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">我使用基于拉式请求的自动化，例如<a class="ae ka" href="https://www.runatlantis.io/" rel="noopener ugc nofollow" target="_blank"> Atlantis </a>。</p><p id="6e0d" class="pw-post-body-paragraph kb kc in kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">但是状态存储在 Git 中吗？</p><p id="e1a3" class="pw-post-body-paragraph kb kc in kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">GitOps 模型的关键基础事实的来源应该存储在 Git 中。</p><p id="0331" class="pw-post-body-paragraph kb kc in kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">使用基础设施即代码(IAC)工具，如<a class="ae ka" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank"> Terraform </a>，状态通常存储在外部源中，如 AWS 中的 S3 存储桶。</p><p id="766f" class="pw-post-body-paragraph kb kc in kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">Terraform 仅在<code class="fe kz la lb lc b">terraform plan</code>或<code class="fe kz la lb lc b">terraform apply</code>被启动时获取/刷新状态。这可能会在部署到云的实际资源和 Terraform 在代码中声明的内容之间产生差异。</p><p id="d72d" class="pw-post-body-paragraph kb kc in kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">如果像 s3 buckets、ec2 实例或 RDS 数据库这样的云基础设施可以通过易于使用的 YAML 文件来声明，并将真实的来源存储在 Git 中，岂不是更好？</p><p id="0a02" class="pw-post-body-paragraph kb kc in kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">这类似于大多数用户在 Kubernetes 的应用程序级别上使用的部署模型。定义 Kubernetes 资源或舵图，以使用流行的 GitOps 控制器部署其应用程序，如<a class="ae ka" href="https://argo-cd.readthedocs.io/en/stable/" rel="noopener ugc nofollow" target="_blank"> ArgoCD </a>和<a class="ae ka" href="https://fluxcd.io/" rel="noopener ugc nofollow" target="_blank"> Flux </a>。</p><p id="64a9" class="pw-post-body-paragraph kb kc in kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">好吧，让我给你介绍一个叫做<a class="ae ka" href="https://crossplane.io/" rel="noopener ugc nofollow" target="_blank">交叉平面</a>的工具。</p><p id="32f3" class="pw-post-body-paragraph kb kc in kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">Crossplane 是建立在流行的 Kubernetes 生态系统之上的控制平面。它作为<a class="ae ka" href="https://developers.redhat.com/articles/2021/06/22/kubernetes-operators-101-part-2-how-operators-work#" rel="noopener ugc nofollow" target="_blank">运营商</a>(广泛使用的 Kubernetes 框架)部署在一个引导集群上，并使用第三方提供商与流行的公共云提供商的 API(AWS、Azure、GCP)进行交互，以供应云资源。</p><p id="9c72" class="pw-post-body-paragraph kb kc in kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">工作流程可能包括。</p><ul class=""><li id="3d28" class="ld le in kd b ke kf ki kj km lf kq lg ku lh ky li lj lk ll bi translated">创建一个有效的<a class="ae ka" href="https://www.redhat.com/en/topics/automation/what-is-yaml" rel="noopener ugc nofollow" target="_blank"> YAML </a>清单来声明一个或多个云资源，定义它们的期望状态。</li><li id="e520" class="ld le in kd b ke lm ki ln km lo kq lp ku lq ky li lj lk ll bi translated">将清单签入所需的 Git 存储库，并创建一个 pull 请求以合并到主分支。</li><li id="9c10" class="ld le in kd b ke lm ki ln km lo kq lp ku lq ky li lj lk ll bi translated">使用 GitOps 控制器，如<a class="ae ka" href="https://argo-cd.readthedocs.io/en/stable/" rel="noopener ugc nofollow" target="_blank"> ArgoCD </a>或<a class="ae ka" href="https://fluxcd.io/" rel="noopener ugc nofollow" target="_blank"> Flux </a>，从存储库的主分支自动应用到引导集群。然后，这些文件作为自定义资源定义文件(CRD)存储在集群上，可以使用<code class="fe kz la lb lc b">kubectl</code>命令行查看。</li><li id="13f8" class="ld le in kd b ke lm ki ln km lo kq lp ku lq ky li lj lk ll bi translated">然后，交叉平面操作员开始协调循环，资源被直接部署到您的云帐户。</li><li id="2743" class="ld le in kd b ke lm ki ln km lo kq lp ku lq ky li lj lk ll bi translated">对这些资源所做的任何更改，例如手动配置。Crossplane 将在下一个循环中修复这些更改，以达到清单的期望状态。</li><li id="36c5" class="ld le in kd b ke lm ki ln km lo kq lp ku lq ky li lj lk ll bi translated">如果不再需要某个资源，则创建一个 pull 请求，从存储库中删除清单，CRD 将与云基础架构一起被销毁。</li></ul><p id="fe76" class="pw-post-body-paragraph kb kc in kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">我提到最初需要一个引导集群，这是一个先有鸡还是先有蛋的场景。这可以在交叉平面工作流之外按照您喜欢的方式进行配置。</p><p id="6fee" class="pw-post-body-paragraph kb kc in kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">这可能是管理云基础架构部署的一种非常强大的方式。在这里，我们现在可以利用 GitOps 模型在存储库中定义我们的云环境的理想状态，作为清晰可读的代码。</p><p id="377a" class="pw-post-body-paragraph kb kc in kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">所以现在问题来了。</p><p id="81d7" class="pw-post-body-paragraph kb kc in kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">如果基础设施现在很容易使用 GitOps 方法部署，开发人员能不能不写清单？<br/>这会不会让所有平台和 DevOps 工程师失业？哎呀！</p><p id="e0e6" class="pw-post-body-paragraph kb kc in kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">不完全是，Crossplane 被设计成允许平台团队为资源生命周期管理创建抽象 API。因此，开发人员可以用他们选择的参数请求或创建资源，而不需要知道支撑资源的复杂配置。</p><p id="1fe3" class="pw-post-body-paragraph kb kc in kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">您可以通过创建以下资源来创建这种抽象和声明。</p><ul class=""><li id="ae89" class="ld le in kd b ke kf ki kj km lf kq lg ku lh ky li lj lk ll bi translated"><a class="ae ka" href="https://crossplane.io/docs/v1.9/concepts/terminology.html#composite-resource-definition" rel="noopener ugc nofollow" target="_blank">复合资源定义</a> (XRD)用于定义新类型的复合资源和声明。您可以在这里创建抽象来隐藏实现细节，只暴露您希望最终用户配置的变量。</li><li id="20ef" class="ld le in kd b ke lm ki ln km lo kq lp ku lq ky li lj lk ll bi translated"><a class="ae ka" href="https://crossplane.io/docs/v1.9/concepts/terminology.html#composite-resource-claim" rel="noopener ugc nofollow" target="_blank">复合资源声明</a> (XRC)一个声明对应一种复合资源。这是最终用户用来为资源定义所选变量的内容。</li></ul><p id="bb75" class="pw-post-body-paragraph kb kc in kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">我发现这可能有点难以理解，但是<a class="ae ka" href="https://crossplane.io/docs/v1.9/concepts/composition.html" rel="noopener ugc nofollow" target="_blank">文档</a>写得很好，也很详细。</p><p id="85fa" class="pw-post-body-paragraph kb kc in kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">开发人员申请数据库的复合资源声明 (XRC)通常如下所示。</p><pre class="lr ls lt lu gt lv lc lw lx aw ly bi"><span id="2036" class="lz ma in lc b gy mb mc l md me">apiVersion: database.example.org/v1alpha1<br/>kind: PostgreSQLInstance<br/>metadata:<br/>  name: my-db<br/>  namespace: default<br/>spec:<br/>  parameters:<br/>    storageGB: 20<br/>  compositionSelector:<br/>    matchLabels:<br/>      provider: aws<br/>      vpc: default<br/>  writeConnectionSecretToRef:<br/>    name: db-conn</span></pre><p id="edb5" class="pw-post-body-paragraph kb kc in kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">开发人员现在可以轻松地部署/请求他们希望应用程序使用的云基础架构。</p><p id="19f2" class="pw-post-body-paragraph kb kc in kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">平台团队现在仍然可以控制部署的内容，并定义可以使用的资源和可用的有效配置选项。</p><p id="652f" class="pw-post-body-paragraph kb kc in kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">赞成的意见</p><ul class=""><li id="6f15" class="ld le in kd b ke kf ki kj km lf kq lg ku lh ky li lj lk ll bi translated">面向云基础设施的 GitOps 部署。</li><li id="a4ec" class="ld le in kd b ke lm ki ln km lo kq lp ku lq ky li lj lk ll bi translated">基础设施代码和实际部署到云中的内容之间不再有差异。真实状态的来源是在 Git 中存储和声明的内容。</li><li id="0928" class="ld le in kd b ke lm ki ln km lo kq lp ku lq ky li lj lk ll bi translated">跨团队协作对于开发人员来说很容易采用和请求基础设施。平台团队仍然可以控制所需的配置选项。</li><li id="89f5" class="ld le in kd b ke lm ki ln km lo kq lp ku lq ky li lj lk ll bi translated">易于阅读的声明性 YAML 文件。</li><li id="e1fa" class="ld le in kd b ke lm ki ln km lo kq lp ku lq ky li lj lk ll bi translated">大型开源社区，是<a class="ae ka" href="https://landscape.cncf.io/" rel="noopener ugc nofollow" target="_blank"> CNCF </a>的孵化项目。</li></ul><p id="7775" class="pw-post-body-paragraph kb kc in kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">骗局</p><ul class=""><li id="9f2b" class="ld le in kd b ke kf ki kj km lf kq lg ku lh ky li lj lk ll bi translated">引导集群需要在交叉面板工作流之外进行配置和维护。</li><li id="e551" class="ld le in kd b ke lm ki ln km lo kq lp ku lq ky li lj lk ll bi translated">并非每个提供商都支持所有的云资源。如果有你需要的东西，你应该为社区做贡献。</li><li id="979e" class="ld le in kd b ke lm ki ln km lo kq lp ku lq ky li lj lk ll bi translated">严重依赖 Kuberenets 作为未来几年的实际部署方法。</li></ul><p id="66c5" class="pw-post-body-paragraph kb kc in kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">总之，如果您的团队选择采用交叉平面，您将使用尖端技术，这将带来一些挑战。作为回报，您将拥有一个使用日益流行的 GitOps 方法部署云资源的可靠方法。</p><p id="6a38" class="pw-post-body-paragraph kb kc in kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">这可能是基础设施即代码(IAC)的未来吗？<br/>时间会证明，在这个不断变化的 DevOps 环境中，任何工具都取决于适应率和社区参与。</p></div></div>    
</body>
</html>