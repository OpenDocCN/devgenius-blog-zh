<html>
<head>
<title>Create Homebrew Taps for Private GitHub Repos</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为私人 GitHub Repos 创建自制水龙头</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/create-homebrew-taps-for-private-github-repos-44daf2f4cff8?source=collection_archive---------8-----------------------#2022-10-03">https://blog.devgenius.io/create-homebrew-taps-for-private-github-repos-44daf2f4cff8?source=collection_archive---------8-----------------------#2022-10-03</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/56c80cfd785a8519c7f8f7d584a004cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*y9yvevcjBgkJtGBu"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated"><a class="ae jz" href="https://unsplash.com/@zacharykeimig?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">扎卡里·凯米格</a>在<a class="ae jz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="45c5" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我在 2022 年 7 月开始了一份新工作。虽然开发人员的经验很棒，但我在新工作中错过的一件事是用 CLI <em class="ky">来统治他们所有人</em>(就像我以前的工作一样)。我想构建一个易于扩展的 CLI 工具，我使用了<em class="ky"> go </em>和<a class="ae jz" href="https://github.com/spf13/cobra" rel="noopener ugc nofollow" target="_blank"> cobra </a>。为了处理对工程师的分配，我们决定同时使用<code class="fe kz la lb lc b">go install</code>和<a class="ae jz" href="https://brew.sh/" rel="noopener ugc nofollow" target="_blank"> <em class="ky">自制</em> </a>。</p><p id="bf03" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">自制程序是非常受 macOS 和 Linux 用户欢迎的包管理器。用户可以通过<code class="fe kz la lb lc b">brew install [PACKAGE]</code>轻松安装新的软件包。自制软件负责将软件包下载和安装到合适的目录中，然后创建到<code class="fe kz la lb lc b">/usr/local</code>的符号链接(在英特尔机器上)。</p><p id="fd01" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">为了创建一个自制软件包，我们创建了名为<em class="ky">公式</em>的 Ruby 类。公式如下所示:</p><pre class="ld le lf lg gt lh lc li lj aw lk bi"><span id="a08b" class="ll lm in lc b gy ln lo l lp lq">class Wget &lt; Formula<br/>  homepage "https://www.gnu.org/software/wget/"<br/>  url "https://ftp.gnu.org/gnu/wget/wget-1.15.tar.gz"<br/>  sha256 "52126be8cf1bddd7536886e74c053ad7d0ed2aa89b4b630f76785bac21695fcd"</span><span id="b3fe" class="ll lm in lc b gy lr lo l lp lq">  def install<br/>    system "./configure", "--prefix=#{prefix}"<br/>    system "make", "install"<br/>  end<br/>end</span></pre><p id="96ca" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">虽然添加一个开源包相当简单，但是对一个私有包做同样的事情需要一些黑客攻击。</p><h1 id="e8f4" class="ls lm in bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">第一步</h1><p id="4116" class="pw-post-body-paragraph ka kb in kc b kd mp kf kg kh mq kj kk kl mr kn ko kp ms kr ks kt mt kv kw kx ig bi translated">首先要做的是创建一个 Github 版本，如果你使用<em class="ky"> go </em>的话，我强烈建议使用<a class="ae jz" href="https://github.com/goreleaser/goreleaser" rel="noopener ugc nofollow" target="_blank"> <em class="ky">或者</em> </a>。我在这里写了一篇关于如何做到这一点的教程。它确实让<em class="ky">中的发布变得容易。如果你在使用另一种语言，你应该看看如何在 GitHub 中管理发布版本<a class="ae jz" href="https://docs.github.com/en/repositories/releasing-projects-on-github/managing-releases-in-a-repository" rel="noopener ugc nofollow" target="_blank">在这里</a>。</em></p><h1 id="1a68" class="ls lm in bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">创建自制水龙头</h1><p id="ff55" class="pw-post-body-paragraph ka kb in kc b kd mp kf kg kh mq kj kk kl mr kn ko kp ms kr ks kt mt kv kw kx ig bi translated">接下来要做的是创建一个<a class="ae jz" href="https://docs.brew.sh/Taps" rel="noopener ugc nofollow" target="_blank">自制 tap </a>。家酿 tap 是一个 GitHub 存储库，存放着我们的公式。要添加非自制核心 tap，我们需要使用<code class="fe kz la lb lc b">brew tap username/package</code>在本地将 tap 添加到自制。为了使用单参数形式的<code class="fe kz la lb lc b">brew tap</code>，我们需要遵循<a class="ae jz" href="https://docs.brew.sh/Taps#repository-naming-conventions-and-assumptions" rel="noopener ugc nofollow" target="_blank">命名约定</a>并将我们的 GitHub repo 命名为<code class="fe kz la lb lc b">homebrew-tap</code>，因为 GitHub repo 必须以<code class="fe kz la lb lc b">homebrew-</code>开头。</p><h1 id="d1a4" class="ls lm in bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">创建公式</h1><p id="08f9" class="pw-post-body-paragraph ka kb in kc b kd mp kf kg kh mq kj kk kl mr kn ko kp ms kr ks kt mt kv kw kx ig bi translated">如果 Github 中已经有一个版本，我们可以继续创建公式。在我们的<code class="fe kz la lb lc b">homebrew-tap</code> repo 中，我们将创建一个名为<code class="fe kz la lb lc b">Formula</code>的文件夹。在<code class="fe kz la lb lc b">Formula</code>目录中，我们将创建一个名为<code class="fe kz la lb lc b">mytool.rb</code>的文件。</p><p id="20b8" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在，在我们的<code class="fe kz la lb lc b">Formula</code>中，我们不能使用标准的方式下载软件包，因为我们的软件包托管在一个私有的回购协议中。为此，我们只需添加一个新的下载策略，如下所示:</p><pre class="ld le lf lg gt lh lc li lj aw lk bi"><span id="a61c" class="ll lm in lc b gy ln lo l lp lq">require "formula"<br/>require_relative "../custom_download_strategy.rb"</span><span id="e2e9" class="ll lm in lc b gy lr lo l lp lq">class Wget &lt; Formula<br/>  homepage "https://www.gnu.org/software/wget/"<br/>  url "https://ftp.gnu.org/gnu/wget/wget-1.15.tar.gz", :using =&gt; GitHubPrivateRepositoryReleaseDownloadStrategy <br/>  sha256 "52126be8cf1bddd7536886e74c053ad7d0ed2aa89b4b630f76785bac21695fcd"</span><span id="e7ed" class="ll lm in lc b gy lr lo l lp lq">  def install<br/>    system "./configure", "--prefix=#{prefix}"<br/>    system "make", "install"<br/>  end</span><span id="0ff0" class="ll lm in lc b gy lr lo l lp lq">  test do<br/>      system "#{bin}/wget --help"<br/>  end<br/>end</span></pre><p id="fbd1" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">注意在类的第三行增加了<code class="fe kz la lb lc b">, :using =&gt; GitHubPrivateRepositoryReleaseDownloadStrategy</code>。</p><p id="6990" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在<code class="fe kz la lb lc b">homebrew-tap</code>的根文件夹中，我们将创建一个名为<code class="fe kz la lb lc b">custom_download_strategy.rb</code>的新文件。这里，我们将添加一些代码来支持我们的下载策略。</p><pre class="ld le lf lg gt lh lc li lj aw lk bi"><span id="7b7a" class="ll lm in lc b gy ln lo l lp lq">require "download_strategy"</span><span id="71f2" class="ll lm in lc b gy lr lo l lp lq">class GitHubPrivateRepositoryDownloadStrategy &lt; CurlDownloadStrategy<br/>  require "utils/formatter"<br/>  require "utils/github"</span><span id="8c72" class="ll lm in lc b gy lr lo l lp lq">  def initialize(url, name, version, **meta)<br/>    super<br/>    parse_url_pattern<br/>    set_github_token<br/>  end</span><span id="6fd5" class="ll lm in lc b gy lr lo l lp lq">  def parse_url_pattern<br/>    unless match = url.match(%r{https://github.com/([^/]+)/([^/]+)/(\S+)})<br/>      raise CurlDownloadStrategyError, "Invalid url pattern for GitHub Repository."<br/>    end</span><span id="a663" class="ll lm in lc b gy lr lo l lp lq">    _, @owner, @repo, @filepath = *match<br/>  end</span><span id="1201" class="ll lm in lc b gy lr lo l lp lq">  def download_url<br/>    "https://#{@github_token}@github.com/#{@owner}/#{@repo}/#{@filepath}"<br/>  end</span><span id="632e" class="ll lm in lc b gy lr lo l lp lq">  private</span><span id="5de4" class="ll lm in lc b gy lr lo l lp lq">  def _fetch(url:, resolved_url:, timeout:)<br/>    curl_download download_url, to: temporary_path, timeout: timeout<br/>  end</span><span id="70de" class="ll lm in lc b gy lr lo l lp lq">  def set_github_token<br/>    @github_token = ENV["HOMEBREW_GITHUB_API_TOKEN"]<br/>    unless @github_token<br/>      raise CurlDownloadStrategyError, "Environmental variable HOMEBREW_GITHUB_API_TOKEN is required."<br/>    end</span><span id="7074" class="ll lm in lc b gy lr lo l lp lq">    validate_github_repository_access!<br/>  end</span><span id="cbbc" class="ll lm in lc b gy lr lo l lp lq">  def validate_github_repository_access!<br/>    # Test access to the repository<br/>    GitHub.repository(@owner, @repo)<br/>  rescue GitHub::HTTPNotFoundError<br/>    # We only handle HTTPNotFoundError here,<br/>    # becase AuthenticationFailedError is handled within util/github.<br/>    message = &lt;&lt;~EOS<br/>      HOMEBREW_GITHUB_API_TOKEN can not access the repository: #{@owner}/#{@repo}<br/>      This token may not have permission to access the repository or the url of formula may be incorrect.<br/>    EOS<br/>    raise CurlDownloadStrategyError, message<br/>  end<br/>end</span><span id="900a" class="ll lm in lc b gy lr lo l lp lq"># GitHubPrivateRepositoryReleaseDownloadStrategy downloads tarballs from GitHub<br/># Release assets. To use it, add<br/># `:using =&gt; GitHubPrivateRepositoryReleaseDownloadStrategy` to the URL section of<br/># your formula. This download strategy uses GitHub access tokens (in the<br/># environment variables HOMEBREW_GITHUB_API_TOKEN) to sign the request.<br/>class GitHubPrivateRepositoryReleaseDownloadStrategy &lt; GitHubPrivateRepositoryDownloadStrategy<br/>  def initialize(url, name, version, **meta)<br/>    super<br/>  end</span><span id="b8ee" class="ll lm in lc b gy lr lo l lp lq">  def parse_url_pattern<br/>    url_pattern = %r{https://github.com/([^/]+)/([^/]+)/releases/download/([^/]+)/(\S+)}<br/>    unless @url =~ url_pattern<br/>      raise CurlDownloadStrategyError, "Invalid url pattern for GitHub Release."<br/>    end</span><span id="5941" class="ll lm in lc b gy lr lo l lp lq">    _, @owner, @repo, @tag, @filename = *@url.match(url_pattern)<br/>  end</span><span id="21d1" class="ll lm in lc b gy lr lo l lp lq">  def download_url<br/>    "https://#{@github_token}@api.github.com/repos/#{@owner}/#{@repo}/releases/assets/#{asset_id}"<br/>  end</span><span id="bcd6" class="ll lm in lc b gy lr lo l lp lq">  private</span><span id="d781" class="ll lm in lc b gy lr lo l lp lq">  def _fetch(url:, resolved_url:, timeout:)<br/>    # HTTP request header `Accept: application/octet-stream` is required.<br/>    # Without this, the GitHub API will respond with metadata, not binary.<br/>    curl_download download_url, "--header", "Accept: application/octet-stream", to: temporary_path, timeout: timeout<br/>  end</span><span id="e795" class="ll lm in lc b gy lr lo l lp lq">  def asset_id<br/>    @asset_id ||= resolve_asset_id<br/>  end</span><span id="3b19" class="ll lm in lc b gy lr lo l lp lq">  def resolve_asset_id<br/>    release_metadata = fetch_release_metadata<br/>    assets = release_metadata["assets"].select { |a| a["name"] == @filename }<br/>    raise CurlDownloadStrategyError, "Asset file not found." if assets.empty?</span><span id="8181" class="ll lm in lc b gy lr lo l lp lq">    assets.first["id"]<br/>  end</span><span id="e3c2" class="ll lm in lc b gy lr lo l lp lq">  def fetch_release_metadata<br/>    GitHub.get_release(@owner, @repo, @tag)<br/>  end<br/>end</span></pre><p id="7c13" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们应该有以下文件夹结构:</p><pre class="ld le lf lg gt lh lc li lj aw lk bi"><span id="8a55" class="ll lm in lc b gy ln lo l lp lq">├── homebrew-tap<br/>│   ├── Formula<br/>│   │   ├── mytool.rb<br/>└── custom_download_strategy.rb</span></pre><h1 id="1a1a" class="ls lm in bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">使用</h1><p id="f2a6" class="pw-post-body-paragraph ka kb in kc b kd mp kf kg kh mq kj kk kl mr kn ko kp ms kr ks kt mt kv kw kx ig bi translated">我们快完成了。要通过家酿安装我们的工具，我们需要导出一个 Github 令牌，提供对我们的私有 repos 的访问。在这里可以创建一个新的令牌<a class="ae jz" href="https://github.com/settings/tokens" rel="noopener ugc nofollow" target="_blank"/>。令牌需要有<code class="fe kz la lb lc b">repo</code>权限。我们需要将令牌导出为<code class="fe kz la lb lc b">HOMEBREW_GITHUB_API_TOKEN</code>。要导出令牌，我们运行:</p><pre class="ld le lf lg gt lh lc li lj aw lk bi"><span id="1540" class="ll lm in lc b gy ln lo l lp lq">export HOMEBREW_GITHUB_API_TOKEN=&lt;GITHUB_TOKEN&gt;<br/># if you're using fish shell like me, run `set -x HOMEBREW_GITHUB_API_TOKEN &lt;GITHUB_TOKEN&gt;`</span></pre><p id="94f5" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">然后，我们可以运行命令:</p><pre class="ld le lf lg gt lh lc li lj aw lk bi"><span id="3c75" class="ll lm in lc b gy ln lo l lp lq">brew install username/homebrew-tap/mytool</span></pre><p id="b039" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这将自动添加自制水龙头，并安装我们的工具。</p><h1 id="a672" class="ls lm in bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">摘要</h1><ul class=""><li id="7fa8" class="mu mv in kc b kd mp kh mq kl mw kp mx kt my kx mz na nb nc bi translated">用二进制文件创建一个 GitHub 版本。在<em class="ky"> go </em>的情况下，这可以通过<em class="ky"> goreleaser </em>非常容易地完成。</li><li id="b885" class="mu mv in kc b kd nd kh ne kl nf kp ng kt nh kx mz na nb nc bi translated">创建一个名为<code class="fe kz la lb lc b">homebrew-tap</code>的 GitHub repo。这里的就是一个例子。</li><li id="8bfa" class="mu mv in kc b kd nd kh ne kl nf kp ng kt nh kx mz na nb nc bi translated">创建一个<code class="fe kz la lb lc b">Formula</code>文件夹。</li><li id="7cd5" class="mu mv in kc b kd nd kh ne kl nf kp ng kt nh kx mz na nb nc bi translated">在 repo 的根目录下，创建一个名为<code class="fe kz la lb lc b">custom_download_strategy.rb</code>的文件。内容如上所示</li><li id="80f4" class="mu mv in kc b kd nd kh ne kl nf kp ng kt nh kx mz na nb nc bi translated">在<code class="fe kz la lb lc b">Formula</code>文件夹中，创建一个 ruby 文件，用你的工具名命名，比如<code class="fe kz la lb lc b">mytool.rb</code></li><li id="5846" class="mu mv in kc b kd nd kh ne kl nf kp ng kt nh kx mz na nb nc bi translated">在这里创建一个 GitHub 令牌<a class="ae jz" href="https://github.com/settings/tokens" rel="noopener ugc nofollow" target="_blank">，并授予<code class="fe kz la lb lc b">repo</code>对该令牌的权限。</a></li><li id="cf5a" class="mu mv in kc b kd nd kh ne kl nf kp ng kt nh kx mz na nb nc bi translated">用<code class="fe kz la lb lc b">export HOMEBREW_GITHUB_API_TOKEN=&lt;GITHUB_TOKEN&gt;</code>导出令牌</li><li id="538c" class="mu mv in kc b kd nd kh ne kl nf kp ng kt nh kx mz na nb nc bi translated">使用<code class="fe kz la lb lc b">brew install username/homebrew-tap/mytool</code>安装带有 brew 的工具。</li></ul></div></div>    
</body>
</html>