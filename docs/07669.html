<html>
<head>
<title>China Merchants Bank’s Practice on Offline Installation with KubeVela</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">招商银行与 KubeVela 的线下安装实践</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/china-merchants-banks-practice-on-offline-installation-with-kubevela-4da0790dea73?source=collection_archive---------17-----------------------#2022-04-13">https://blog.devgenius.io/china-merchants-banks-practice-on-offline-installation-with-kubevela-4da0790dea73?source=collection_archive---------17-----------------------#2022-04-13</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="a25a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><em class="ki">马相伯(云平台开发团队)</em></p><p id="1eaf" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">招商银行的云平台开发团队自 2021 年以来一直在内部试用 KubeVela，旨在使用它来增强我们的主要应用交付和管理能力。由于金融保险行业的特殊安全考虑，网络控制措施相对严格，我们的内部网无法直接获取 Docker Hub 映像，也没有可用的 Helm 映像源。因此，为了在内部网中登陆 KubeVela，您必须执行完整的离线安装。</p><p id="85a3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">本文将以 KubeVela V1.2.5 版本为例，介绍离线安装实践，帮助其他用户在离线环境下更容易地完成 KubeVela 的部署。</p><h1 id="c32e" class="kj kk in bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">KubeVela 离线安装解决方案</h1><p id="7316" class="pw-post-body-paragraph jk jl in jm b jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc kd ll kf kg kh ig bi translated">我们把 KubeVela 的离线安装分为三个部分，分别是 Vela CLI、Vela Core、Addon 离线安装。每个部分主要涉及相关 Docker 映像和 Helm 的包的加载，这可以大大加快离线环境下的部署过程。</p><p id="ac1d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在此之前，请确保 Kubernetes 集群版本是<code class="fe lm ln lo lp b">&gt;= v1.19 &amp;&amp; &lt; v1.22</code>。KubeVela 作为控制平面的一种方式依赖于 Kubernetes，它可以放在任何产品或任何云提供商中。同时，也可以使用 Kind 或 Minikube 在本地部署 KubeVela。</p><h1 id="cce9" class="kj kk in bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">Vela CLI 离线安装</h1><p id="d0c8" class="pw-post-body-paragraph jk jl in jm b jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc kd ll kf kg kh ig bi translated">●首先，你需要通过查看 KubeVela <a class="ae lq" href="https://github.com/oam-dev/kubevela/releases" rel="noopener ugc nofollow" target="_blank">发布日志</a>下载你想要的<code class="fe lm ln lo lp b">vela</code>的二进制版本</p><p id="5ec3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">●解压缩二进制文件，并在<code class="fe lm ln lo lp b">$PATH</code>中配置适当的环境变量</p><p id="61df" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">○解压缩二进制文件</p><p id="8134" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">*<code class="fe lm ln lo lp b">tar -zxvf vela-v1.2.5-linux-amd64.tar.gz</code></p><p id="3b5d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">*<code class="fe lm ln lo lp b">mv ./linux-amd64/vela /usr/local/bin/vela</code></p><p id="b698" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">○设置环境变量</p><p id="36e4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">*<code class="fe lm ln lo lp b">vi /etc/profile</code></p><p id="2881" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">*<code class="fe lm ln lo lp b">export PATH="$PATH:/usr/local/bin"</code></p><p id="d4c7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">*<code class="fe lm ln lo lp b">source /etc/profile</code></p><p id="2f86" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">○通过<code class="fe lm ln lo lp b">vela version</code>验证 Vela CLI 的安装</p><pre class="lr ls lt lu gt lv lp lw lx aw ly bi"><span id="3668" class="lz kk in lp b gy ma mb l mc md">CLI VERSION: V1.2.5<br/>Core Version:<br/>GitRevision: git-ef80b66<br/>GOLANGVERSION: Go1.17.7</span></pre><p id="f646" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">●至此，Vela CLI 已经离线部署！</p><h1 id="0bb8" class="kj kk in bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">Vela 核心离线安装</h1><p id="65f5" class="pw-post-body-paragraph jk jl in jm b jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc kd ll kf kg kh ig bi translated">●在离线部署 Vela Core 之前，首先需要在离线环境下安装<a class="ae lq" href="https://helm.sh/docs/intro/install/" rel="noopener ugc nofollow" target="_blank"> Helm </a>，其版本需要满足<code class="fe lm ln lo lp b">v3.2.0+</code></p><p id="77bd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">●准备 Docker 图像。Vela Core 的部署主要涉及 5 个映像，您需要首先访问 extranet 中的 Docker Hub 下载相应的映像，然后加载到离线环境中</p><p id="43d7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">○从 Docker Hub 提取图像</p><p id="71ca" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">*<code class="fe lm ln lo lp b">docker pull oamdev/vela-core:v1.2.5</code></p><p id="1ee5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">*<code class="fe lm ln lo lp b">docker pull oamdev/cluster-gateway:v1.1.7</code></p><p id="adf6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">*<code class="fe lm ln lo lp b">docker pull oamdev/kube-webhook-certgen:v2.3</code></p><p id="9bd2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">*<code class="fe lm ln lo lp b">docker pull oamdev/alpine-k8s:1.18.2</code></p><p id="cf82" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">*<code class="fe lm ln lo lp b">docker pull oamdev/hello-world:v1</code></p><p id="7160" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">○将图像保存到本地磁盘</p><p id="1602" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">*<code class="fe lm ln lo lp b">docker save -o vela-core.tar oamdev/vela-core:v1.2.5</code></p><p id="abf8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">*<code class="fe lm ln lo lp b">docker save -o cluster-gateway.tar oamdev/cluster-gateway:v1.1.7</code></p><p id="ef28" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">*<code class="fe lm ln lo lp b">docker save -o kube-webhook-certgen.tar oamdev/kube-webhook-certgen:v2.3</code></p><p id="414f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">*<code class="fe lm ln lo lp b">docker save -o alpine-k8s.tar oamdev/alpine-k8s:1.18.2</code></p><p id="9b61" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">*<code class="fe lm ln lo lp b">docker save -o hello-world.tar oamdev/hello-world:v1</code></p><p id="b991" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">○在离线环境中重新加载映像</p><p id="8de4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">*<code class="fe lm ln lo lp b">docker load vela-core.tar</code></p><p id="eead" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">*<code class="fe lm ln lo lp b">docker load cluster-gateway.tar</code></p><p id="7f09" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">*<code class="fe lm ln lo lp b">docker load kube-webhook-certgen.tar</code></p><p id="c9d5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">*<code class="fe lm ln lo lp b">docker load alpine-k8s.tar</code></p><p id="b497" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">*<code class="fe lm ln lo lp b">docker load hello-world.tar</code></p><p id="e9a7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">●下载<a class="ae lq" href="https://github.com/oam-dev/KubeVela/releases" rel="noopener ugc nofollow" target="_blank"> KubeVela Core </a>，复制到离线环境，使用 Helm 重新打包</p><p id="c455" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">○重新打包 KubeVela 源代码，并将图表包离线安装到控制集群</p><p id="e062" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">*<code class="fe lm ln lo lp b">helm package kubevela/charts/vela-core --destination kubevela/charts</code></p><p id="29c0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">*<code class="fe lm ln lo lp b">helm install --create-namespace -n vela-system kubevela kubevela/charts/vela-core-0.1.0.tgz --wait</code></p><p id="51da" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">○检查输出</p><pre class="lr ls lt lu gt lv lp lw lx aw ly bi"><span id="e304" class="lz kk in lp b gy ma mb l mc md">KubeVela Control Plane Has Been successfully set up on your cluster.</span></pre><p id="efe5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">●至此，Vela Core 已经下线部署！</p><h1 id="9354" class="kj kk in bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">插件脱机安装</h1><p id="2d66" class="pw-post-body-paragraph jk jl in jm b jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc kd ll kf kg kh ig bi translated">●首先下载<a class="ae lq" href="https://github.com/oam-dev/catalog" rel="noopener ugc nofollow" target="_blank">目录源</a>并复制到离线环境</p><p id="4a39" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">●在这里，我们将以众多插件之一的 VelaUX 为例。首先准备它的 Docker 镜像，VelaUX 主要涉及 2 个镜像，你需要先访问 extranet 从 Docker Hub 下载相应的镜像，然后加载到离线环境</p><p id="a096" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">○从 Docker Hub 提取图像</p><p id="cdf3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">*<code class="fe lm ln lo lp b">docker pull oamdev/vela-apiserver:v1.2.5</code></p><p id="bc86" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">*<code class="fe lm ln lo lp b">docker pull oamdev/velaux:v1.2.5</code></p><p id="0da9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">○将图像保存到本地磁盘</p><p id="cb64" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">*<code class="fe lm ln lo lp b">docker save -o vela-apiserver.tar oamdev/vela-apiserver:v1.2.5</code></p><p id="3887" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">*<code class="fe lm ln lo lp b">docker save -o velaux.tar oamdev/velaux:v1.2.5</code></p><p id="bbcb" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">○在离线环境中重新加载映像</p><p id="16c3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">*<code class="fe lm ln lo lp b">docker load vela-apiserver.tar</code></p><p id="5cf4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">*<code class="fe lm ln lo lp b">docker load velaux.tar</code></p><p id="bf84" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">●安装 VelaUX</p><p id="2004" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">○通过 Vela CLI 安装 VelaUX</p><p id="6ea9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">*<code class="fe lm ln lo lp b">vela addon enable catalog-master/addons/velaux</code></p><p id="bc2c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">○检查输出</p><pre class="lr ls lt lu gt lv lp lw lx aw ly bi"><span id="282d" class="lz kk in lp b gy ma mb l mc md">Addon: velaux enabled Successfully.</span></pre><p id="edbe" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">●如果集群安装了路由控制器或 Nginx 入口控制器，并且还与可用域链接，您可以部署外部路由以使 VelaUX 可访问。这里以 Openshift 路由为例，如果您愿意，也可以选择 Ingress</p><pre class="lr ls lt lu gt lv lp lw lx aw ly bi"><span id="7ecb" class="lz kk in lp b gy ma mb l mc md">apiVersion: route.openshift.io/v1<br/>kind: Route<br/>metadata:<br/>name: velaux-route<br/>namespace: vela-system<br/>spec:<br/>host: velaux.xxx.xxx.cn<br/>port:<br/>  targetPort: 80<br/>to:<br/>  kind: Service<br/>  name: velaux<br/>  weight: 100<br/>wildcardPolicy: None</span></pre><p id="86e0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">●检查安装</p><pre class="lr ls lt lu gt lv lp lw lx aw ly bi"><span id="4934" class="lz kk in lp b gy ma mb l mc md">curl -I -m 10 -o /dev/null -s -w %{http_code} <a class="ae lq" href="http://velaux.xxx.xxx.cn/applications" rel="noopener ugc nofollow" target="_blank">http://velaux.xxx.xxx.cn/applications</a></span></pre><p id="8dfd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">●至此，VelaUX 已经下线部署！同时，对于其他类型的插件的离线部署，进入<a class="ae lq" href="https://github.com/oam-dev/catalog" rel="noopener ugc nofollow" target="_blank">目录源</a>的相应目录，重复上述步骤，就可以永久完成所有插件的离线部署。</p><h1 id="6717" class="kj kk in bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">总结</h1><p id="c4c7" class="pw-post-body-paragraph jk jl in jm b jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc kd ll kf kg kh ig bi translated">在离线部署期间，我们也试图保存在 extranet 中部署后生成为 YAML 文件的 Vela Core 和 Addon 的资源，并在离线环境中重新部署它们，但是由于涉及到各种不同的资源，并且需要解决许多其他授权问题，这种方式非常麻烦。</p><p id="e4dd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">通过 KubeVela 的离线部署实践，我们希望它能帮助您更快地在离线环境中构建一套完整的 KubeVela。离线安装对大多数开发者来说是一个很大的痛点，我们也看到 KubeVela 社区正在引入全新的<a class="ae lq" href="https://github.com/oam-dev/velad" rel="noopener ugc nofollow" target="_blank"> velad </a>，一个完全离线的、高度可靠的安装工具。Velad 可以通过将许多步骤合二为一来帮助自动完成，例如准备集群、下载和打包映像、安装等。此外，它还支持许多功能:在 Linux 机器(如阿里云 ECS)上，我们可以本地启动一个集群来安装 Vela-Core；当启动 KubeVela 控制平面时，不必担心它后面的机器意外关闭时，它的数据会丢失；Velad 可以将来自控制平面集群的所有数据存储到传统数据库中(如部署在另一个 ECS 上的 MySQL)。</p><p id="3fbc" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在即将到来的近期版本中，招行将加大在 KubeVela 开源社区的力度，积极建设:企业级能力、多集群上的增强、离线部署和应用级可观察性。我们还将为金融行业的用户场景和业务需求做出贡献，推动云原生生态实现更轻松高效的应用管理体验，最后但同样重要的是，欢迎您作为社区成员加入我们的旅程。</p></div></div>    
</body>
</html>