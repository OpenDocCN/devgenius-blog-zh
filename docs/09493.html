<html>
<head>
<title>Rust on the Teensy4.0 — Teensycore</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">青少年身上的铁锈 4.0 —青少年核心</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/rust-on-the-teensy4-0-teensycore-499c28175f54?source=collection_archive---------8-----------------------#2022-08-24">https://blog.devgenius.io/rust-on-the-teensy4-0-teensycore-499c28175f54?source=collection_archive---------8-----------------------#2022-08-24</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/3e8c43d8f1a7a8d254ad8de51c0918d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*FdIlJTzj7ee29-Kw"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">照片由<a class="ae jz" href="https://unsplash.com/@cdr6934?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">克里斯里德</a>在<a class="ae jz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="ebf1" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Rust 是跨平台编译的传奇。ARM 芯片组的变体也在列表中。不久前，我着手为用 rust 编写的 Teensy 4.0 创建一个裸机内核。我很快意识到将我的代码提取到一个可重用的平台中是相当简单的。这样，teensycore 就建成了，你也可以享受这个极其轻量级的内核！</p><p id="098f" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Teensycore 是完全开源的，欢迎投稿！</p><p id="e62d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">资源</strong></p><ul class=""><li id="5a5d" class="ky kz in kc b kd ke kh ki kl la kp lb kt lc kx ld le lf lg bi translated">Teensy 开发板:<a class="ae jz" href="https://www.pjrc.com/store/teensy40.html" rel="noopener ugc nofollow" target="_blank">https://www.pjrc.com/store/teensy40.html</a></li><li id="3f09" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx ld le lf lg bi translated">内核源代码:<a class="ae jz" href="http://github.com/SharpCoder/teensycore" rel="noopener ugc nofollow" target="_blank">github.com/SharpCoder/teensycore</a></li><li id="a115" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx ld le lf lg bi translated">crates . io:<a class="ae jz" href="https://crates.io/crates/teensycore" rel="noopener ugc nofollow" target="_blank">https://crates.io/crates/teensycore</a></li><li id="7924" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx ld le lf lg bi translated">文件:<a class="ae jz" href="https://docs.rs/teensycore/0.0.11/teensycore/" rel="noopener ugc nofollow" target="_blank">https://docs.rs/teensycore/0.0.11/teensycore/</a></li></ul><p id="ed02" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在本文中，我将解释 teensycore 内置的一些特性，并提供一些如何使用它的示例。首先，简单介绍一下功能。</p><h1 id="6d39" class="lm ln in bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated"><strong class="ak">功能</strong></h1><p id="6f23" class="pw-post-body-paragraph ka kb in kc b kd mk kf kg kh ml kj kk kl mm kn ko kp mn kr ks kt mo kv kw kx ig bi translated">在撰写本文时，teensycore 已经完全具备了以下特性:</p><ul class=""><li id="444c" class="ky kz in kc b kd ke kh ki kl la kp lb kt lc kx ld le lf lg bi translated">对所有 5 个 UART 外设的本机支持</li><li id="0bba" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx ld le lf lg bi translated">软件 i2c</li><li id="7960" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx ld le lf lg bi translated">定期计时器</li><li id="2d2d" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx ld le lf lg bi translated">基于引脚编号的 Gpio 寻址</li><li id="cdf2" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx ld le lf lg bi translated">全功能中断系统</li><li id="77f6" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx ld le lf lg bi translated">精确到纳秒<code class="fe mp mq mr ms b">wait()</code></li><li id="8782" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx ld le lf lg bi translated">132MHz 的优美时钟速度</li><li id="e421" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx ld le lf lg bi translated">硬件优化的浮点数学</li></ul><p id="9781" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">除了这些硬件级系统之外，teensycore 还拥有一个非常轻量级的“标准库”(质量可疑)，其中包括如下数据结构:</p><ul class=""><li id="f6f1" class="ky kz in kc b kd ke kh ki kl la kp lb kt lc kx ld le lf lg bi translated">链接列表</li><li id="1983" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx ld le lf lg bi translated">BTreeMap</li><li id="ad43" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx ld le lf lg bi translated">具有队列/堆栈操作的固定大小数组</li><li id="1f55" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx ld le lf lg bi translated">具有队列/堆栈操作的可变大小向量</li><li id="93dd" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx ld le lf lg bi translated">带有基本回收系统的分页内存</li><li id="39c4" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx ld le lf lg bi translated">堆栈支持的字符串</li><li id="10ff" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx ld le lf lg bi translated">还有更多！</li></ul><p id="580a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">teensycore 拥有这些东西的原因是因为它符合<code class="fe mp mq mr ms b">#![no_std]</code>。所以我们知道并喜爱的标准库是不可用的。</p><p id="3bfd" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在来看一个例子。来看看大家的最爱:blinky。</p><h1 id="c4e0" class="lm ln in bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">Blinky</h1><p id="8213" class="pw-post-body-paragraph ka kb in kc b kd mk kf kg kh ml kj kk kl mm kn ko kp mn kr ks kt mo kv kw kx ig bi translated">我们将闪烁内置的 LED。不需要电线！以下是从头开始一个新的 teensycore 项目的逐步指南。</p><p id="1ba2" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">编制项目</strong></p><p id="1261" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">首先，您需要安装一些构建工具。虽然我们使用<code class="fe mp mq mr ms b">cargo</code>来完成繁重的工作，但是有一点点<code class="fe mp mq mr ms b">c</code>，一些链接器动作，以及一堆货物标志发生在幕后。</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="468e" class="nb ln in ms b gy nc nd l ne nf">sudo apt install gcc-arm-none-eabi jq</span></pre><p id="fb5d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">接下来，您需要配置 rust，以便它能够利用适当的工具链。</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="4ff2" class="nb ln in ms b gy nc nd l ne nf">rustup default nightly<br/>rustup target add thumbv7em-none-eabi</span></pre><p id="3719" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">您现在已经准备好创建一个 teensycore 项目了。</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="b64e" class="nb ln in ms b gy nc nd l ne nf">cargo new blinky --lib<br/>cd blinky</span></pre><p id="de47" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">修改您的<code class="fe mp mq mr ms b">Cargo.toml</code>文件，使其包含这个 lib 部分，并在依赖项中包含 teensycore。</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="05e0" class="nb ln in ms b gy nc nd l ne nf">[package]<br/>name = "blinky"<br/>version = "0.1.0"<br/>edition = "2021"</span><span id="cfc4" class="nb ln in ms b gy ng nd l ne nf">[lib]<br/>crate-type = ["staticlib"]<br/>path = "src/lib.rs"</span><span id="6a6e" class="nb ln in ms b gy ng nd l ne nf">[dependencies]<br/>teensycore = "^0.0.11"</span></pre><p id="33ed" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">大部分都是标准的东西，但是构建本身有点奇怪。不幸的是，它目前是用 bash 编写的——所以它只能在 Linux/WSL/Mac 机器上工作。</p><p id="8158" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">下载构建文件。</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="da45" class="nb ln in ms b gy nc nd l ne nf">curl <a class="ae jz" href="https://raw.githubusercontent.com/SharpCoder/teensycore/main/build-template.sh" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/SharpCoder/teensycore/main/build-template.sh</a> &gt; build.sh</span><span id="9a54" class="nb ln in ms b gy ng nd l ne nf"># Add execute permission to the build <br/>chmod +x ./build.sh</span></pre><p id="9054" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">因为额外的链接步骤让我们的内核在文件中的正确位置，也因为那个讨厌的<code class="fe mp mq mr ms b">.c</code>文件——这个<code class="fe mp mq mr ms b">build.sh</code>脚本诞生了。它本质上是 cargo 构建你的 rust，然后使用<code class="fe mp mq mr ms b">arm-none-eabi-ld</code>来连接所有东西，使用<code class="fe mp mq mr ms b">objcopy</code>来发出一个十六进制文件。</p><p id="55ee" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">剩下的就是青少年中心的入口了。下面是你可以放入<code class="fe mp mq mr ms b">src/lib.rs</code>开始的代码。</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="1130" class="nb ln in ms b gy nc nd l ne nf">#![feature(lang_items)]<br/>#![no_std]</span><span id="e3d3" class="nb ln in ms b gy ng nd l ne nf">teensycore::main!({<br/>    pin_mode(13, Mode::Output);</span><span id="9c00" class="nb ln in ms b gy ng nd l ne nf">    loop {<br/>        pin_out(13, Power::High);<br/>        wait_ns(1 * S_TO_NANO);<br/>        pin_out(13, Power::Low);<br/>        wait_ns(1 * S_TO_NANO);<br/>    }<br/>});</span></pre><p id="4cc3" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><code class="fe mp mq mr ms b">teensycore::main!({ /* code here*/ })</code>宏包括一堆我的标准库，配置默认 UART，启动时钟外设，等等。</p><p id="4e3b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我的设计目标是让这个宏尽可能地接近一个空白的 Arduino 项目。不要想太多正在发生的事情，只要认真对待！</p><p id="363b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><code class="fe mp mq mr ms b">pin 13</code>是一个 gpio 引脚，teensy 4.0 中的内部 LED 通过该引脚连接。所以在 teensycore 每秒切换一次是很容易的。</p><p id="0a92" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">让我们探索一个更高级的项目。</p><h1 id="ce75" class="lm ln in bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">在 I2C 上空读/写数据</h1><p id="8a33" class="pw-post-body-paragraph ka kb in kc b kd mk kf kg kh ml kj kk kl mm kn ko kp mn kr ks kt mo kv kw kx ig bi translated">接下来，我们来探索 i2c 接口。我无耻地模仿 Arduino 接口，因为这很有意义。假设你有一个额外的 eeprom 芯片(在这个例子中，我使用的是<a class="ae jz" href="https://ww1.microchip.com/downloads/aemDocuments/documents/MPD/ProductDocuments/DataSheets/24AA512-24LC512-24FC512-512K-Bit-I2C-Serial-EEPROM-20001754Q.pdf" rel="noopener ugc nofollow" target="_blank"> <strong class="kc io"> 24LC512 </strong> </a>)。下面是如何从中读取和写入数据…</p><p id="e8e2" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">(注意:我有 SDA 线连接到引脚 18，SCL 线连接到引脚 19)</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="738b" class="nb ln in ms b gy nc nd l ne nf">#![feature(lang_items)]<br/>#![crate_type = "staticlib"]<br/>#![no_std]</span><span id="715a" class="nb ln in ms b gy ng nd l ne nf">teensycore::main!({<br/>    use teensycore::*;</span><span id="9af7" class="nb ln in ms b gy ng nd l ne nf">    let mut wire = I2C::begin(18, 19);<br/>    wire.set_speed(I2CSpeed::Fast400kHz);</span><span id="83b7" class="nb ln in ms b gy ng nd l ne nf">    wire.begin_transmission(0x50, true);<br/>    // First two bytes are memory address<br/>    wire.write(&amp;[0, 0]);<br/>    // Next is a sequential write of data<br/>    wire.write(b"EARTH");<br/>    wire.end_transmission();<br/>    <br/>    // Settle time for whole-page write. Per docs.<br/>    wait_ns(250 * MS_TO_NANO);</span><span id="e5f1" class="nb ln in ms b gy ng nd l ne nf">    // Select the address we wish to read<br/>    wire.begin_transmission(0x50, true);<br/>    wire.write(&amp;[0, 0]);<br/>    wire.end_transmission();</span><span id="22f7" class="nb ln in ms b gy ng nd l ne nf">    // Perform read request<br/>    wire.begin_transmission(0x50, false);<br/>    <br/>    // Use the `debug_str` functionality to output this data to the<br/>    // TX2 UART. Pin 8 on the teensy. For debugging purposes.<br/>    debug_str(&amp;[<br/>        // Send 'true' as the second parameter to include an ack<br/>        // This tells the chip we wish to do sequential reads<br/>        // with automatic addr incrementation.<br/>        wire.read(true),<br/>        wire.read(true),<br/>        wire.read(true),<br/>        wire.read(true),<br/>        wire.read(true),<br/>    ]);<br/>    wire.end_transmission();<br/>});</span></pre><p id="2bb8" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">当我最初编写这段代码时，我将一个实际的 arduino 连接到引脚 8 (TX2 ),并使用 Arduino 串行监视器来监视 eeprom 结果。这是对 UART 和 I2C 系统的一次很好的外部验证。</p><p id="6b2a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">让我们把它分解一下。</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="f3c5" class="nb ln in ms b gy nc nd l ne nf">let mut wire = I2C::begin(18, 19);<br/>wire.set_speed(I2CSpeed::Fast400kHz);</span></pre><p id="9483" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">根据 i2c 文档，Teensycore i2c 支持“快速模式”和正常模式。我的 i2c 库在普通 gpio 线上运行速度非常快。因此，您可以将它与任何可用的 GPIO 引脚配合使用，这非常简单。</p><p id="afc6" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">类似于 Arduino <code class="fe mp mq mr ms b">Wire</code>库完成一个事务。</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="c3be" class="nb ln in ms b gy nc nd l ne nf">wire.begin_transmission(0x50, true);<br/>wire.write(&amp;[0, 0]);<br/>wire.write(b"EARTH");<br/>wire.end_transmission();</span></pre><p id="8156" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">你<code class="fe mp mq mr ms b">begin_transmission( addr, write_mode )</code>，完成后再<code class="fe mp mq mr ms b">end_transmission()</code>。</p><p id="9ff9" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如果您为第二个参数指定<code class="fe mp mq mr ms b">false</code>，您将处于读取模式。并且抓取字节可以这样做:<code class="fe mp mq mr ms b">wire.read(true)</code>那个参数只是告诉是否发回 ack。</p><p id="8b18" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这就是 i2c 通信库的全部内容。</p><h1 id="381a" class="lm ln in bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">结论</h1><p id="53c6" class="pw-post-body-paragraph ka kb in kc b kd mk kf kg kh ml kj kk kl mm kn ko kp mn kr ks kt mo kv kw kx ig bi translated">我们已经介绍了从零开始启动一个新的 teensycore 项目以及利用各种子系统来闪烁灯光、通过 i2c 通信和发出调试串行信息的基础知识。随着时间的推移，我会添加到这个内核中，并写更多关于如何使用新老特性的文章。</p></div></div>    
</body>
</html>