<html>
<head>
<title>Upsert in MongoDB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">MongoDB 中的 Upsert</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/upsert-in-mongodb-42233e4cfcc9?source=collection_archive---------14-----------------------#2022-08-15">https://blog.devgenius.io/upsert-in-mongodb-42233e4cfcc9?source=collection_archive---------14-----------------------#2022-08-15</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="4c1e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在 MongoDB 中使用 upsert 的完整指南</p><p id="ad2e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">MongoDB update 命令修改集合中的文档。一个 update 命令可以包含多个 update 语句。要更新任何特定的文档，我们必须添加条件来选择特定的文档。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/97e59ea0177a0d2429d709ee472632aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*duhAACoapvy9WOfy"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae ky" href="https://unsplash.com/@writecodenow?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Boitumelo Phetla </a>拍摄的照片</figcaption></figure><p id="8d05" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">MongoDB 提供了另一个命令<em class="kz"> Upsert </em>，它也用于更新带有条件的任何特定文档。</p><p id="27b8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><em class="kz"> Upsert </em>是插入和更新的组合(UPdate + inSERT = upsert)。我们可以使用<em class="kz"> upsert </em>配合不同的更新方式，即<em class="kz"> update </em>、<em class="kz"> findAndModify </em>、<em class="kz"> updateOne、</em>和<em class="kz"> replaceOne </em>。</p><p id="e0dd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在 MongoDB 中，<em class="kz"> upsert </em>选项是一个布尔值。</p><ul class=""><li id="96f3" class="la lb in jm b jn jo jr js jv lc jz ld kd le kh lf lg lh li bi translated">如果该选项的值被设置为<em class="kz">真</em>并且找到匹配指定查询的一个或多个文档，那么更新操作将<em class="kz">更新</em>匹配的一个或多个文档。</li><li id="9245" class="la lb in jm b jn lj jr lk jv ll jz lm kd ln kh lf lg lh li bi translated">如果该选项的值设置为<em class="kz"> true </em>并且没有一个或多个文档匹配指定的文档，则该选项<em class="kz">在集合中插入</em>一个新文档，并且该新文档具有指示操作的字段。</li></ul><p id="6296" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">默认情况下，upsert 选项的值为<em class="kz">假</em>。如果分片集合中 upsert 的值为 true，那么您必须在过滤器中包含完整的分片键。</p><p id="1ee6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">up sert 命令的语法</strong></p><pre class="kj kk kl km gt lo lp lq lr aw ls bi"><span id="921f" class="lt lu in lp b gy lv lw l lx ly"><em class="kz">upsert: &lt;boolean&gt;</em></span></pre><p id="484e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><em class="kz">上插</em>选项的值为<em class="kz">真</em>或<em class="kz">假</em>。</p><p id="b41a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">MongoDB 中 upsert 的用途</strong></p><p id="1563" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">upsert 选项的主要目的是根据应用的过滤器更新现有文档，或者在过滤器不匹配时插入新文档。</p><p id="fd62" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">Upsert 在 MongoDB 中的使用</strong></p><p id="a8a5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们可以通过以下方式使用 upsert。</p><p id="8e2f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">(I)使用<em class="kz">更新()</em>方法进行 Upsert</p><p id="3fb8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">(二)使用<em class="kz"> findAndModify() </em>方法进行向上插入</p><p id="66b4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">(三)用<em class="kz"> replaceOne() </em>方法向上插入</p><p id="f096" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">(四)使用<em class="kz"> updateOne() </em>方法进行上插</p><p id="5be4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">(v)使用<em class="kz"> $set </em>和<em class="kz"> $setOnInsert </em>操作进行上插</p><p id="c87a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在讨论 upsert 在 MongoDB 中的用法之前，</p><p id="d164" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">考虑以下数据中的一个集合名<em class="kz"> Persons。</em></p><pre class="kj kk kl km gt lo lp lq lr aw ls bi"><span id="bd07" class="lt lu in lp b gy lv lw l lx ly">db.Persons.insert({ _id : "1", Name: "John", Age: 23, Income : 1000});<br/>db.Persons.insert({ _id : "2", Name: "Don", Age: 27, Income : 3000});<br/>db.Persons.insert({ _id : "3", Name: "Kumar", Age: 21, Income : 4500});<br/>db.Persons.insert({ _id : "4", Name: "Roky", Age: 18, Income : 5000});<br/>db.Persons.insert({ _id : "5", Name: "Smith", Age: 19, Income : 2000});<br/>db.Persons.insert({ _id : "6", Name: "Anik", Age: 35, Income : 1500});<br/>db.Persons.insert({ _id : "7", Name: "Rabi", Age: 32, Income : 2500});<br/>db.Persons.insert({ _id : "8", Name: "Akash", Age: 22, Income : 7000});</span></pre><p id="726e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> (i)用<em class="kz"> update() </em>方法</strong>进行 Upsert</p><p id="e827" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们可以使用<em class="kz"> upsert </em>选项和<em class="kz"> update() </em>方法。该选项的默认值为<em class="kz">假</em>。</p><p id="2487" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果我们想要更新个人收集中姓名为<em class="kz"> Pranta </em>年龄为<em class="kz">28</em>的人的信息，并且我们有一个要求，如果不存在，则插入该人。我们有以下的上插选项，</p><pre class="kj kk kl km gt lo lp lq lr aw ls bi"><span id="cd2e" class="lt lu in lp b gy lv lw l lx ly">db.Persons.update({Name:"Pranta"}, {$set: {Age: 28}},{upsert:true})</span></pre><p id="111d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">该命令的结果如下所示，</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi lz"><img src="../Images/c2c1338c4e992942e4c36118584f1835.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*5szyzr3YZWjfOvVMf5KMAA.png"/></div></figure><p id="9910" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们注意到插入了另一个文档，其 id 显示在控制台中。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ma"><img src="../Images/613db7d603530caf6d980ddac253138a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1338/format:webp/1*cF5hC0UvZFDZoetDrdZ0UA.png"/></div></figure><p id="a0cd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">由于 upsert 选项的值被设置为<em class="kz"> true </em>，并且没有文档匹配名称<em class="kz"> Pranta </em>和<em class="kz"> Age 28 </em>，因此 update()方法插入一个包含两个字段<em class="kz"> Name </em>和<em class="kz"> Age </em>的新文档。</p><p id="452c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> (ii)用<em class="kz"> findAndModify() </em>方法</strong>进行 Upsert</p><p id="8a78" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们也可以通过<em class="kz"> findAndModify </em>方法使用<em class="kz"> upsert </em>选项。</p><p id="cde8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果我们想要更新<em class="kz"> Person </em>集合中姓名为<em class="kz"> Nicolaus </em>收入为<em class="kz">5000</em>的人的信息，并且我们有一个要求，如果不存在，则插入该人。我们有以下的上插选项，</p><pre class="kj kk kl km gt lo lp lq lr aw ls bi"><span id="89bf" class="lt lu in lp b gy lv lw l lx ly">db.Persons.findAndModify({<br/>    query:<br/>      {Name:"Nicolaus"}, <br/>      update:{<br/>      $set:{Income:5000}<br/>     },<br/>     upsert:true<br/>   });</span></pre><p id="acc2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">该命令的结果如下所示，</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mb"><img src="../Images/47056cbaf229d64481c27fc1449f3576.png" data-original-src="https://miro.medium.com/v2/resize:fit:1184/format:webp/1*MwRri0v9eW6a_ZH8w3xhFw.png"/></div></figure><p id="082e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果我们找到结果，我们注意到另一个文档中插入了姓名为<em class="kz"> Nicolaus </em>和<em class="kz">收入 5000 </em>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mc"><img src="../Images/fecda5367b7147b871395b0e3380ccc4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Uq3Pn8oTkdhv4-1d7kFwPg.png"/></div></div></figure><p id="9ab3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> (iii)用<em class="kz"> replaceOne() </em>方法</strong>向上插入</p><p id="00e2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">MongoDB 的<em class="kz"> replaceOne </em>方法只是在条件匹配时替换集合中的单个文档。</p><pre class="kj kk kl km gt lo lp lq lr aw ls bi"><span id="0e77" class="lt lu in lp b gy lv lw l lx ly">db.Persons.replaceOne(<br/>   {<br/>    "Name":"Ratan"<br/>   },<br/>   {<br/>      "Name":"Ratan",<br/>    "Age" : 34,<br/>    "Income" : 8000,<br/>   },<br/>   {<br/>    "upsert":true<br/>   });</span></pre><p id="f4cb" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">该命令的结果如下所示，</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi md"><img src="../Images/51facd2691b0830f0aa9a251c93423b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2i8E2Jd91695RWP3hMCLFg.png"/></div></div></figure><p id="c441" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果我们找到结果，我们注意到另一个文档中插入了姓名<em class="kz"> Ratan，年龄 34 岁，收入 8000 </em>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi me"><img src="../Images/b0063120a2fab163dd7acb081272ab36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fCWT8r5f_jCT_12KEQEjdw.png"/></div></div></figure><p id="f71d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> (iv)用<em class="kz"> updateOne() </em>方法</strong>进行上插</p><p id="d5f1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">MongoDB 的<em class="kz"> updateOne </em>方法只是在条件匹配时替换集合中的单个文档，如果条件匹配不成功，则插入一个文档。</p><pre class="kj kk kl km gt lo lp lq lr aw ls bi"><span id="6146" class="lt lu in lp b gy lv lw l lx ly">db.Persons.updateOne(<br/>   {<br/>    "Name":"Simone"<br/>   },<br/>   {<br/>   $set: {<br/>      "Name":"Simone",<br/>      "Age" : 30,<br/>      "Income" : 7500,<br/>      }<br/>   },<br/>   {<br/>    "upsert":true<br/>   });</span></pre><p id="aa17" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">该命令的结果如下所示，</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi gj"><img src="../Images/2c181d7e78b01bcdb85bfbbb76eadd3c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ReHaSCxGtap5vNWzm6T7Zw.png"/></div></div></figure><p id="e732" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果我们找到结果，我们注意到另一个文档插入了名字<em class="kz"> Simone，年龄 30 岁，收入 7500 </em>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mf"><img src="../Images/0dfbfcce9babcf2759d27ed998a1b154.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GINBFx83rj-WCG_M51M3eQ.png"/></div></div></figure><p id="3e01" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> (v)上插<em class="kz">$设置</em>和<em class="kz">$设置插入</em>操作</strong></p><p id="8647" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果<em class="kz"> upsert </em>选项的值为<em class="kz"> true </em>并且没有文档匹配给定的过滤器，那么更新操作在给定的集合中插入一个新文档，并且在这个新文档中插入的字段是在查询和更新文档中指定的字段。</p><pre class="kj kk kl km gt lo lp lq lr aw ls bi"><span id="c04d" class="lt lu in lp b gy lv lw l lx ly">db.Persons.update({Name: "Mirko"}, <br/>                {$set: {Income: 9900}, <br/>                $setOnInsert: {Age: 27}},<br/>                {upsert: true})</span></pre><p id="48ec" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">该命令的结果如下所示，</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mg"><img src="../Images/effb1787b5f23ea77d34748cebfb2ae5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g5cAzN40rWcd4DOKyz9Ivg.png"/></div></div></figure><p id="ab10" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果我们找到结果，我们注意到另一个文档被插入了名字<em class="kz"> Mirko，年龄 27，收入 9900 </em>，因为它没有找到任何名字为<em class="kz"> Mirko </em>的文档。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mh"><img src="../Images/2ab1ee0ecbd657d921cbf6c1bbb7ce22.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NS_SGstzSuCY2_wYrIoZWA.png"/></div></div></figure><p id="b88b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">总结</strong></p><p id="8cc0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">MongoDB 有很多更新和插入集合文档的命令。其中，upsert 用于更新文档以及在不符合条件时插入文档。我们已经看到了如何使用 MongoDB 的各种更新方法执行<em class="kz"> upsert </em>操作。我们使用 mongo shell 实现 upsert 操作。</p><p id="08a1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">感谢阅读！</p></div></div>    
</body>
</html>