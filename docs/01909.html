<html>
<head>
<title>5 Experiments with WiFi using ESP32</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">5个使用ESP32的WiFi实验</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/5-experiments-with-wifi-using-esp32-8d40dddc538b?source=collection_archive---------2-----------------------#2020-07-14">https://blog.devgenius.io/5-experiments-with-wifi-using-esp32-8d40dddc538b?source=collection_archive---------2-----------------------#2020-07-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="721c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">大家好。</p><p id="8460" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">ESP32板之所以受欢迎，是因为其价格低廉、处理能力强(200 MHz CPU)、可同时用于MicroPython和Arduino IDE的多个SDK、外设(GPIO、SPI、I2C)和无线(WiFi、蓝牙)连接支持。今天，我们将看看如何在这样一个董事会在价格只有约12美元。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/7d8463352ddbfdccd30f9608dd609061.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*MLGR2OgjMJ-AwHiS.png"/></div></div></figure><p id="3e89" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我会考虑使用WiFi的不同选项，从简单的家庭网络连接到WiFi嗅探器。为了测试，我们将需要任何ESP32板(最好有一个有机发光二极管屏幕，如图)和Arduino IDE。</p><p id="3b3a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我不会描述如何将ESP32连接到Arduino IDE，任何人都可以在这里阅读。我只能指出，需要按住Boot按钮才能从Arduino IDE上载代码。除此之外，该板的用途与任何普通的Arduino相同。</p><p id="f39b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">本文中的所有代码示例都可以完全使用，您只需将它们复制并粘贴到Arduino IDE中。</p><p id="ca62" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们开始吧。</p><h1 id="f33f" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">1.连接到WiFi并获取NTP时间</h1><p id="350a" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">由于主板上有WiFi，我们最简单的做法就是连接到现有的WiFi网络。这是很容易的，甚至在旧的ESP8266董事会的工作。然而，只是连接和什么都不做是无趣的，我将展示如何通过NTP获得时间。使用下面的代码，就可以很容易地将我们的ESP板变成一个桌面(或为100lvl极客——手腕:)手表。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mb"><img src="../Images/667b2b2f42a2c7c61b587159ecd85571.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*r5p_y_woGdUsk8K8.png"/></div></div></figure><p id="023d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">代码相当简单，NTP支持已经内置在标准库中，不需要安装任何东西。为了让有机发光二极管屏工作，我们需要安装<a class="ae kx" href="https://github.com/ThingPulse/esp8266-oled-ssd1306" rel="noopener ugc nofollow" target="_blank"> SSD1306 </a>库。</p><p id="4766" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">SSID和密码字符串需要替换为真实接入点的参数，之后一切工作开箱即用。</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="4471" class="mh kz iq md b gy mi mj l mk ml">#include &lt;WiFi.h&gt;<br/>#include &lt;SSD1306Wire.h&gt;<br/>#include &lt;time.h&gt;<br/> <br/>const char* ssid     = "MYWIFI";     <br/>const char* password = "12345678";</span><span id="9ab9" class="mh kz iq md b gy mm mj l mk ml">const char* ntpServer = "pool.ntp.org";<br/>const long  gmtOffset_sec = 3600;<br/>const int   daylightOffset_sec = 3600;</span><span id="1b7e" class="mh kz iq md b gy mm mj l mk ml"><em class="mn">// OLED Display 128x64</em><br/>SSD1306Wire  display(0x3c, 5, 4);<br/> <br/>void setup() {<br/>  Serial.begin(115200);         <br/>  delay(10);<br/>  Serial.println('\n');</span><span id="6d67" class="mh kz iq md b gy mm mj l mk ml"><em class="mn">  // Connect to the network</em>  <br/>  WiFi.begin(ssid, password);             <br/>  while (WiFi.status() != WL_CONNECTED) <br/>  { <br/>    <em class="mn">// Wait for the Wi-Fi to connect</em><br/>    delay(500);<br/>    Serial.print('.');<br/>  }<br/>  Serial.println('\n');<br/>  Serial.println("Connection established");  <br/>  Serial.print("IP address:\t");<br/>  Serial.println(WiFi.localIP());</span><span id="cdf1" class="mh kz iq md b gy mm mj l mk ml"><em class="mn">  // Get the NTP time</em><br/>  configTime(gmtOffset_sec, daylightOffset_sec, ntpServer);</span><span id="99d8" class="mh kz iq md b gy mm mj l mk ml"><em class="mn">  // OLED display init</em><br/>  display.init();<br/>  display.clear();<br/>  display.setTextAlignment(TEXT_ALIGN_LEFT);<br/>  display.setFont(ArialMT_Plain_10);<br/>  display.drawString(0, 0, "Access Point connected");<br/>  display.drawString(0, 24, "AP IP address: ");<br/>  display.drawString(0, 36, WiFi.localIP().toString());<br/>  display.display();<br/>  delay(1000);<br/>}</span><span id="d30d" class="mh kz iq md b gy mm mj l mk ml">void draw_time(char *msg) {<br/>  display.clear();<br/>  display.setTextAlignment(TEXT_ALIGN_CENTER);<br/>  display.setFont(ArialMT_Plain_24);<br/>  display.drawString(display.getWidth()/2, 0, msg);<br/>  display.display();</span><span id="8b94" class="mh kz iq md b gy mm mj l mk ml">  Serial.println(msg);<br/>}<br/> <br/>void loop() { <br/>  struct tm timeinfo;<br/>  if (getLocalTime(&amp;timeinfo)) {<br/>      char time_str[16];<br/>      strftime(time_str, 16, "%H:%M:%S", &amp;timeinfo);</span><span id="6d8f" class="mh kz iq md b gy mm mj l mk ml">      draw_time(time_str);<br/>  }  <br/>  delay(500);<br/>}</span></pre><h1 id="a69b" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">2.WiFi接入点</h1><p id="19c2" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">当然，我们不仅可以连接到接入点，还可以创建自己的接入点。在这个例子中，我们将推出一个小型网络服务器，可以打开，例如，从智能手机。我想强调的是SYSTEM _ EVENT _ AP _ STACONNECTED事件的处理，它允许我们找出有多少客户端连接到我们的AP。</p><p id="c082" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">本代码基于<a class="ae kx" href="https://www.arduino.cc/en/Tutorial/Wifi101SimpleWebServerWiFi" rel="noopener ugc nofollow" target="_blank">本教程</a>。</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="09d4" class="mh kz iq md b gy mi mj l mk ml">#include &lt;WiFi.h&gt;<br/>#include &lt;DNSServer.h&gt;<br/>#include &lt;SSD1306Wire.h&gt;</span><span id="45de" class="mh kz iq md b gy mm mj l mk ml"><em class="mn">// Access Point credentials</em><br/>const char *ssid = "TEST-123";<br/>const char *password = NULL; <em class="mn">// "12345678";</em><br/>int connections = 0;</span><span id="1d38" class="mh kz iq md b gy mm mj l mk ml"><em class="mn">// Onboard WiFi server</em><br/>WiFiServer server(80);<br/>String responseHTML = "&lt;!DOCTYPE html&gt;&lt;html&gt;"<br/>                      "&lt;head&gt;&lt;meta name=\"viewport\" content=\"width=device-width, initial-scale=1\"&gt;"<br/>                      "&lt;style&gt;html { font-family: Helvetica; display: inline-block; margin: 0px auto; text-align: center;}"<br/>                      "&lt;/style&gt;&lt;/head&gt;"<br/>                      "&lt;body&gt;&lt;h1&gt;ESP32 Web Server&lt;/h1&gt;"<br/>                      "&lt;p&gt;Hello World&lt;/p&gt;"<br/>                      "&lt;/body&gt;&lt;/html&gt;";</span><span id="08b3" class="mh kz iq md b gy mm mj l mk ml"><em class="mn">// OLED Display 128x64</em><br/>SSD1306Wire  display(0x3c, 5, 4);</span><span id="f950" class="mh kz iq md b gy mm mj l mk ml">void WiFiStationConnected(WiFiEvent_t event, WiFiEventInfo_t info) {<br/>  connections += 1;<br/>  showConnectionsCount();<br/>}</span><span id="db73" class="mh kz iq md b gy mm mj l mk ml">void showConnectionsCount() {<br/>  char data[32];<br/>  sprintf(data, "Connections: %d", connections);<br/>  draw_message(data);<br/>}</span><span id="d49b" class="mh kz iq md b gy mm mj l mk ml">void setup() {<br/>  Serial.begin(115200);                   <br/>  Serial.println();<br/>  Serial.println("Configuring access point...");</span><span id="130b" class="mh kz iq md b gy mm mj l mk ml"><em class="mn">  // Start access point </em><br/>  WiFi.mode(WIFI_AP);                   <br/>  WiFi.softAP(ssid, password);<br/>  WiFi.onEvent(WiFiStationConnected, SYSTEM_EVENT_AP_STACONNECTED);</span><span id="448e" class="mh kz iq md b gy mm mj l mk ml"><em class="mn">  // IP Address of our access point<br/>  </em>IPAddress ip_address = WiFi.softAPIP();</span><span id="1758" class="mh kz iq md b gy mm mj l mk ml"><em class="mn">  // Start web server</em><br/>  server.begin();<br/>  <br/>  Serial.print("AP IP address: ");<br/>  Serial.println(ip_address);</span><span id="d2a5" class="mh kz iq md b gy mm mj l mk ml"><em class="mn">  // Oled display </em><br/>  display.init();<br/>  <em class="mn">// Draw info</em><br/>  display.clear();<br/>  display.setTextAlignment(TEXT_ALIGN_LEFT);<br/>  display.setFont(ArialMT_Plain_10);<br/>  display.drawString(0, 0, "Access Point started");<br/>  display.drawString(0, 12, ssid);<br/>  display.drawString(0, 24, "AP IP address: ");<br/>  display.drawString(0, 36, ip_address.toString());<br/>  display.display();</span><span id="b520" class="mh kz iq md b gy mm mj l mk ml"><em class="mn">  // Total number of connections</em><br/>  showConnectionsCount();<br/>}</span><span id="2f5d" class="mh kz iq md b gy mm mj l mk ml">void draw_message(char *msg) {<br/>  display.setColor(BLACK);<br/>  display.fillRect(0, 50, display.getWidth(), 12);<br/>  display.setColor(WHITE);<br/>  display.drawString(0, 50, msg);<br/>  display.display();</span><span id="2aa6" class="mh kz iq md b gy mm mj l mk ml">  Serial.println(msg);<br/>}</span><span id="4ae3" class="mh kz iq md b gy mm mj l mk ml">void loop() {<br/>  <em class="mn">// Listen for incoming clients<br/>  </em>WiFiClient client = server.available();  <br/>  if (client) { <br/>    <em class="mn">// A new client connects</em><br/>    draw_message("Client connected");<br/>    <br/>    String currentLine = "";   <br/>    while (client.connected()) {  <br/>      if (client.available()) {        <br/>        char c = client.read(); <em class="mn">// read a byte, then</em><br/>        Serial.write(c);        <em class="mn">// print it out the serial monitor</em><br/>        if (c == '\n') {        <em class="mn">// the byte is a newline character</em><br/>          <em class="mn">// if the current line is blank, you got <br/>          // two newline characters in a row.</em><br/>          <em class="mn">// that's the end of the client HTTP request, <br/>          // so send a response:</em><br/>          if (currentLine.length() == 0) {<br/>            <em class="mn">// Header</em><br/>            client.println("HTTP/1.1 200 OK");<br/>            client.println("Content-type:text/html");<br/>            client.println("Connection: close");<br/>            client.println();<br/>            <br/>            <em class="mn">// Display the HTML web page</em><br/>            client.println(responseHTML);            <br/>            <em class="mn">// The HTTP response ends with another blank line</em><br/>            client.println();<br/>            break;<br/>          } else { <br/>            <em class="mn">// if we got a newline, then clear currentLine</em><br/>            currentLine = "";<br/>          }<br/>        } else if (c != '\r') {  <br/>          <em class="mn">// if we got anything else but a CR character,<br/>          // add it to the end of the currentLine<br/></em>          currentLine += c;   <br/>        }<br/>      }<br/>    }<br/>    <em class="mn">// Close the connection</em><br/>    client.stop();<br/>    showConnectionsCount();<br/>  }<br/>}</span></pre><p id="53ce" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">程序启动时，屏幕将显示接入点名称和IP地址。从智能手机连接到接入点后，我们可以在浏览器中键入IP并查看网页内容。</p><p id="272c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">服务器也可以在没有有机发光二极管屏幕的情况下工作，在这种情况下，可以使用Arduino IDE中的Serial Monitor查看调试信息。</p><h1 id="bbe5" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">3.支持DNS的WiFi接入点</h1><p id="fa05" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">前面的例子可以通过使用板载DNS进行改进。在这种情况下，我们不必记住并输入IP地址，而是使用一个名称，例如，<a class="ae kx" href="http://www.myesp32.com." rel="noopener ugc nofollow" target="_blank">www.myesp32.com。</a></p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mo"><img src="../Images/4ac6e3497656114cfcbb986644757b8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Xe2HSCaYP2t4yONn.png"/></div></div></figure><p id="e661" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">源代码使用了<a class="ae kx" href="https://github.com/espressif/arduino-esp32/tree/master/libraries/WebServer" rel="noopener ugc nofollow" target="_blank"> WebServer </a>类，这使得代码变得更短。</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="62b1" class="mh kz iq md b gy mi mj l mk ml">#include &lt;WiFi.h&gt;<br/>#include &lt;DNSServer.h&gt;<br/>#include &lt;WebServer.h&gt;</span><span id="4ad0" class="mh kz iq md b gy mm mj l mk ml">WebServer webServer(80);</span><span id="6a1c" class="mh kz iq md b gy mm mj l mk ml">const char *ssid = "TEST-123";<br/>const char *password = NULL; <em class="mn">// "12345678";</em></span><span id="8fdc" class="mh kz iq md b gy mm mj l mk ml">IPAddress apIP(192, 168, 1, 4);<br/>DNSServer dnsServer;<br/><em class="mn">// Use "*" to all DNS requests<br/></em>const char *server_name = "www.myesp32.com";</span><span id="cb46" class="mh kz iq md b gy mm mj l mk ml">String responseHTML = "&lt;!DOCTYPE html&gt;&lt;html&gt;"<br/>                      "&lt;head&gt;&lt;meta name=\"viewport\" content=\"width=device-width, initial-scale=1\"&gt;"<br/>                      "&lt;style&gt;html { font-family: Helvetica; display: inline-block; margin: 0px auto; text-align: center;}"<br/>                      "&lt;/style&gt;&lt;/head&gt;"<br/>                      "&lt;body&gt;&lt;h1&gt;ESP32 Web Server&lt;/h1&gt;"<br/>                      "&lt;p&gt;Hello World&lt;/p&gt;"<br/>                      "&lt;/body&gt;&lt;/html&gt;";</span><span id="bfee" class="mh kz iq md b gy mm mj l mk ml">void setup() {<br/>  WiFi.mode(WIFI_AP);<br/>  WiFi.softAP(ssid, password);<br/>  delay(100);<br/>  <br/>  WiFi.softAPConfig(apIP, apIP, IPAddress(255, 255, 255, 0));</span><span id="075f" class="mh kz iq md b gy mm mj l mk ml">  const byte DNS_PORT = 53;<br/>  dnsServer.start(DNS_PORT, server_name, apIP);</span><span id="8605" class="mh kz iq md b gy mm mj l mk ml">  webServer.onNotFound([]() {<br/>    webServer.send(200, "text/html", responseHTML);<br/>  });<br/>  webServer.begin();<br/>}</span><span id="7132" class="mh kz iq md b gy mm mj l mk ml">void loop() {<br/>  dnsServer.processNextRequest();<br/>  webServer.handleClient();<br/>}</span></pre><h1 id="504e" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">4.WiFI嗅探器</h1><p id="93e3" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">另一个使用WiFi的有趣例子是在https://github.com/ESP-EOS/ESP32-WiFi-Sniffer的<a class="ae kx" href="https://github.com/ESP-EOS/ESP32-WiFi-Sniffer" rel="noopener ugc nofollow" target="_blank"/>。ESP32上的WiFi芯片可以切换到所谓的“混杂模式”，允许在不连接网络本身的情况下监控WiFi数据包。特别是，我们可以看到附近设备的MAC地址:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mp"><img src="../Images/5f34b2028b512c952e64ba06c0a75b40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*UU33gYAttmEy-8sx.png"/></div></div></figure><p id="f40d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这可能是有用的，例如，智能家居可以发现主人何时回家。一些公司使用设备的MAC地址来监控访问者，然后向他们显示有针对性的广告(我不确定这是否100%合法)。</p><p id="4ca9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">源代码可以从<a class="ae kx" href="https://github.com/ESP-EOS/ESP32-WiFi-Sniffer" rel="noopener ugc nofollow" target="_blank">https://github.com/ESP-EOS/ESP32-WiFi-Sniffer</a>页面下载。</p><h1 id="37e7" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">5.WiFi数据包监视器</h1><p id="e58a" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">使用混杂模式的另一个例子是通道活动的图形化监控。和前面的情况一样，不需要连接到网络本身。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mq"><img src="../Images/63e2fd3cb818f304197c5fcbc3d34454.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*L6T6MhOz84OpzCZE.png"/></div></div></figure><p id="d98b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">源代码是在这里<a class="ae kx" href="https://github.com/spacehuhn/PacketMonitor32" rel="noopener ugc nofollow" target="_blank">取的</a>，我去掉了SD卡支持(这块板上没有卡)，用图形库修复了一个bug。可以通过按下按钮(也不在板上:)或通过Arduino IDE中的串行监视器发送相应的数字来切换WiFi频道。</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="6263" class="mh kz iq md b gy mi mj l mk ml">#include &lt;esp_wifi.h&gt;<br/>#include &lt;esp_wifi_types.h&gt;<br/>#include &lt;esp_system.h&gt;<br/>#include &lt;esp_event.h&gt;<br/>#include &lt;esp_event_loop.h&gt;<br/>#include &lt;nvs_flash.h&gt;<br/>#include &lt;stdio.h&gt;<br/>#include &lt;string&gt;<br/>#include &lt;cstddef&gt;<br/>#include &lt;Wire.h&gt;<br/>#include &lt;Preferences.h&gt;<br/>using namespace std;</span><span id="bb6b" class="mh kz iq md b gy mm mj l mk ml">#define MAX_CH 14       // 1 - 14<br/>#define SNAP_LEN 2324   // max len of each recieved packet</span><span id="f3ec" class="mh kz iq md b gy mm mj l mk ml">#define BUTTON_PIN 5    // button to change the channel</span><span id="9b22" class="mh kz iq md b gy mm mj l mk ml">#define USE_DISPLAY     // comment out if you don't want to use OLED<br/>//#define FLIP_DISPLAY  // comment out if you don't like to flip it<br/>#define MAX_X 128<br/>#define MAX_Y 64</span><span id="5fdc" class="mh kz iq md b gy mm mj l mk ml">#if CONFIG_FREERTOS_UNICORE<br/>#define RUNNING_CORE 0<br/>#else<br/>#define RUNNING_CORE 1<br/>#endif</span><span id="60f6" class="mh kz iq md b gy mm mj l mk ml">#ifdef USE_DISPLAY<br/>#include &lt;SSD1306Wire.h&gt;<br/>#endif</span><span id="83ac" class="mh kz iq md b gy mm mj l mk ml">esp_err_t event_handler(void* ctx, system_event_t* event) {<br/>  return ESP_OK;<br/>}</span><span id="c836" class="mh kz iq md b gy mm mj l mk ml">// OLED Display 128x64<br/>#ifdef USE_DISPLAY<br/>SSD1306Wire  display(0x3c, 5, 4);<br/>#endif</span><span id="1b31" class="mh kz iq md b gy mm mj l mk ml">Preferences preferences;</span><span id="9828" class="mh kz iq md b gy mm mj l mk ml">bool useSD = false;<br/>bool buttonPressed = false;<br/>bool buttonEnabled = true;<br/>uint32_t lastDrawTime;<br/>uint32_t lastButtonTime;<br/>uint32_t tmpPacketCounter;<br/>uint32_t pkts[MAX_X];   // here the packets per second will be saved<br/>uint32_t deauths = 0;   // deauth frames per second<br/>unsigned int ch = 1;    // current 802.11 channel<br/>int rssiSum;</span><span id="a899" class="mh kz iq md b gy mm mj l mk ml">double getMultiplicator() {<br/>  uint32_t maxVal = 1;<br/>  for (int i = 0; i &lt; MAX_X; i++) {<br/>    if (pkts[i] &gt; maxVal) maxVal = pkts[i];<br/>  }<br/>  if (maxVal &gt; MAX_Y) return (double)MAX_Y / (double)maxVal;<br/>  else return 1;<br/>}</span><span id="b8ad" class="mh kz iq md b gy mm mj l mk ml">void setChannel(int newChannel) {<br/>  ch = newChannel;<br/>  if (ch &gt; MAX_CH || ch &lt; 1) ch = 1;</span><span id="b205" class="mh kz iq md b gy mm mj l mk ml">  preferences.begin("packetmonitor32", false);<br/>  preferences.putUInt("channel", ch);<br/>  preferences.end();</span><span id="7925" class="mh kz iq md b gy mm mj l mk ml">  esp_wifi_set_promiscuous(false);<br/>  esp_wifi_set_channel(ch, WIFI_SECOND_CHAN_NONE);<br/>  esp_wifi_set_promiscuous_rx_cb(&amp;wifi_promiscuous);<br/>  esp_wifi_set_promiscuous(true);<br/>}</span><span id="0ec4" class="mh kz iq md b gy mm mj l mk ml">void wifi_promiscuous(void* buf, wifi_promiscuous_pkt_type_t type) {<br/>  wifi_promiscuous_pkt_t* pkt = (wifi_promiscuous_pkt_t*)buf;<br/>  wifi_pkt_rx_ctrl_t ctrl = (wifi_pkt_rx_ctrl_t)pkt-&gt;rx_ctrl;</span><span id="0397" class="mh kz iq md b gy mm mj l mk ml">  if (type == WIFI_PKT_MGMT &amp;&amp; <br/>      (pkt-&gt;payload[0] == 0xA0 || pkt-&gt;payload[0] == 0xC0 )) <br/>    deauths++;</span><span id="db2d" class="mh kz iq md b gy mm mj l mk ml">  if (type == WIFI_PKT_MISC) return;         // wrong packet type<br/>  if (ctrl.sig_len &gt; SNAP_LEN) return;       // packet too long</span><span id="5285" class="mh kz iq md b gy mm mj l mk ml">  uint32_t packetLength = ctrl.sig_len;<br/>  if (type == WIFI_PKT_MGMT) <br/>    packetLength -= 4;  // fix for known bug in the IDF <a class="ae kx" href="https://github.com/espressif/esp-idf/issues/886" rel="noopener ugc nofollow" target="_blank">https://github.com/espressif/esp-idf/issues/886</a></span><span id="614e" class="mh kz iq md b gy mm mj l mk ml">  // Serial.print(".");<br/>  tmpPacketCounter++;<br/>  rssiSum += ctrl.rssi;<br/>}</span><span id="69bb" class="mh kz iq md b gy mm mj l mk ml">void draw() {<br/>#ifdef USE_DISPLAY<br/>  double multiplicator = getMultiplicator();<br/>  int len;<br/>  int rssi;</span><span id="5087" class="mh kz iq md b gy mm mj l mk ml">  if (pkts[MAX_X - 1] &gt; 0) <br/>    rssi = rssiSum / (int)pkts[MAX_X - 1];<br/>  else <br/>    rssi = rssiSum;</span><span id="4a27" class="mh kz iq md b gy mm mj l mk ml">  display.clear();</span><span id="10da" class="mh kz iq md b gy mm mj l mk ml">  display.setTextAlignment(TEXT_ALIGN_RIGHT);<br/>  display.drawString( 10, 0, (String)ch);<br/>  display.drawString( 14, 0, ("|"));<br/>  display.drawString( 30, 0, (String)rssi);<br/>  display.drawString( 34, 0, ("|"));<br/>  display.drawString( 82, 0, (String)tmpPacketCounter);<br/>  display.drawString( 87, 0, ("["));<br/>  display.drawString(106, 0, (String)deauths);<br/>  display.drawString(110, 0, ("]"));<br/>  display.drawString(114, 0, ("|"));<br/>  display.drawString(128, 0, (useSD ? "SD" : ""));<br/>  display.setTextAlignment(TEXT_ALIGN_LEFT);<br/>  display.drawString( 36,  0, ("Pkts:"));</span><span id="e8b5" class="mh kz iq md b gy mm mj l mk ml">  display.drawLine(0, 63 - MAX_Y, MAX_X, 63 - MAX_Y);<br/>  for (int i = 0; i &lt; MAX_X; i++) {<br/>    len = pkts[i] * multiplicator;<br/>    display.drawLine(i, 63, i, 63 - (len &gt; MAX_Y ? MAX_Y : len));<br/>    if (i &lt; MAX_X - 1) pkts[i] = pkts[i + 1];<br/>  }<br/>  display.display();<br/>#endif<br/>}</span><span id="b760" class="mh kz iq md b gy mm mj l mk ml">void setup() {<br/>  // Serial<br/>  Serial.begin(115200);</span><span id="78ce" class="mh kz iq md b gy mm mj l mk ml">  // Settings<br/>  preferences.begin("packetmonitor32", false);<br/>  ch = preferences.getUInt("channel", 1);<br/>  preferences.end();</span><span id="327f" class="mh kz iq md b gy mm mj l mk ml">  // System &amp; WiFi<br/>  nvs_flash_init();<br/>  tcpip_adapter_init();<br/>  wifi_init_config_t cfg = WIFI_INIT_CONFIG_DEFAULT();<br/>  ESP_ERROR_CHECK(esp_event_loop_init(event_handler, NULL));<br/>  ESP_ERROR_CHECK(esp_wifi_init(&amp;cfg));<br/>  //ESP_ERROR_CHECK(esp_wifi_set_country(WIFI_COUNTRY_EU));<br/>  ESP_ERROR_CHECK(esp_wifi_set_storage(WIFI_STORAGE_RAM));<br/>  ESP_ERROR_CHECK(esp_wifi_set_mode(WIFI_MODE_NULL));<br/>  ESP_ERROR_CHECK(esp_wifi_start());</span><span id="65ff" class="mh kz iq md b gy mm mj l mk ml">  esp_wifi_set_channel(ch, WIFI_SECOND_CHAN_NONE);</span><span id="04cd" class="mh kz iq md b gy mm mj l mk ml">  // I/O<br/>  pinMode(BUTTON_PIN, INPUT_PULLUP);</span><span id="1bac" class="mh kz iq md b gy mm mj l mk ml">  // display<br/>#ifdef USE_DISPLAY<br/>  display.init();<br/>#ifdef FLIP_DISPLAY<br/>  display.flipScreenVertically();<br/>#endif</span><span id="ffd9" class="mh kz iq md b gy mm mj l mk ml">  // show start screen<br/>  display.clear();<br/>  display.setFont(ArialMT_Plain_16);<br/>  display.drawString(6, 6, "PacketMonitor32");<br/>  display.setFont(ArialMT_Plain_10);<br/>  display.drawString(24, 34, "Made with &lt;3 by");<br/>  display.drawString(29, 44, "<a class="ae kx" href="http://twitter.com/Spacehuhn" rel="noopener ugc nofollow" target="_blank">@Spacehuhn</a>");<br/>  display.display();</span><span id="7298" class="mh kz iq md b gy mm mj l mk ml">  delay(1000);<br/>#endif</span><span id="64c1" class="mh kz iq md b gy mm mj l mk ml">  // second core<br/>  xTaskCreatePinnedToCore(<br/>    coreTask,               /* Function to implement the task */<br/>    "coreTask",             /* Name of the task */<br/>    2500,                   /* Stack size in words */<br/>    NULL,                   /* Task input parameter */<br/>    0,                      /* Priority of the task */<br/>    NULL,                   /* Task handle. */<br/>    RUNNING_CORE);          /* Core where the task should run */</span><span id="c4b6" class="mh kz iq md b gy mm mj l mk ml">  // start Wifi sniffer<br/>  esp_wifi_set_promiscuous_rx_cb(&amp;wifi_promiscuous);<br/>  esp_wifi_set_promiscuous(true);<br/>}</span><span id="7045" class="mh kz iq md b gy mm mj l mk ml">void loop() {<br/>  vTaskDelay(portMAX_DELAY);<br/>}</span><span id="26b1" class="mh kz iq md b gy mm mj l mk ml">void coreTask( void * p ) {<br/>  uint32_t currentTime;</span><span id="cd22" class="mh kz iq md b gy mm mj l mk ml">while(true) {<br/>    currentTime = millis();</span><span id="b990" class="mh kz iq md b gy mm mj l mk ml">    // check button<br/>    if (digitalRead(BUTTON_PIN) == LOW) {<br/>      if (buttonEnabled) {<br/>        if (!buttonPressed) {<br/>          buttonPressed = true;<br/>          lastButtonTime = currentTime;<br/>        } else if (currentTime - lastButtonTime &gt;= 2000) {<br/>          draw();<br/>          buttonPressed = false;<br/>          buttonEnabled = false;<br/>        }<br/>      }<br/>    } else {<br/>      if (buttonPressed) {<br/>        setChannel(ch + 1);<br/>        draw();<br/>      }<br/>      buttonPressed = false;<br/>      buttonEnabled = true;<br/>    }</span><span id="0c19" class="mh kz iq md b gy mm mj l mk ml">    // draw Display<br/>    if ( currentTime - lastDrawTime &gt; 1000 ) {<br/>      lastDrawTime = currentTime;<br/>      pkts[MAX_X - 1] = tmpPacketCounter;</span><span id="8ef2" class="mh kz iq md b gy mm mj l mk ml">    draw();</span><span id="6182" class="mh kz iq md b gy mm mj l mk ml">    Serial.println((String)pkts[MAX_X - 1]);</span><span id="0fd6" class="mh kz iq md b gy mm mj l mk ml">      tmpPacketCounter = 0;<br/>      deauths = 0;<br/>      rssiSum = 0;<br/>    }</span><span id="dddf" class="mh kz iq md b gy mm mj l mk ml">    // Serial input<br/>    if (Serial.available()) {<br/>        ch = Serial.readString().toInt();<br/>        if (ch &lt; 1 || ch &gt; 14) ch = 1;<br/>        setChannel(ch);<br/>    }<br/>  }<br/>}</span></pre><p id="7b18" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一个ESP32板只能监控一个通道，但这些板足够便宜，可以做到这一点:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mr"><img src="../Images/632f6100a8e0d1b6c80419a13032ba8c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*LnkzV-j3qoHXqNAV.png"/></div></div></figure><p id="659c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mn">图片来源:</em><a class="ae kx" href="https://github.com/spacehuhn/WiFiSatellite" rel="noopener ugc nofollow" target="_blank"><em class="mn">github.com/spacehuhn/WiFiSatellite</em></a></p><h1 id="2422" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">结论</h1><p id="ab43" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">正如我们所见，就功能和价格比而言，ESP32相当有趣，而且无论如何，比Arduino功能性强得多。用WiFi做实验也挺好玩的。在板上，我们不仅可以保留一个功能完整的web服务器(即使有WebSockets支持)，还可以更详细地研究WiFi和MAC功能。</p><p id="ee21" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一般来说，当Arduino功能不够时，ESP32模块是有趣的，但在Linux上使用Raspberry Pi仍然是多余的。顺便说一下，ESP32的计算能力甚至允许使用摄像头模块，因此该板可以用作无线视频门铃或家庭视频监控系统的原型。下一次，我将更详细地描述我在这块板上的实验:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi ms"><img src="../Images/746141512980f6f1e1270bce850e0de9.png" data-original-src="https://miro.medium.com/v2/resize:fit:948/format:webp/0*G4MY16vRhrc8vrbE.png"/></div></figure><p id="d702" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我祝愿所有的读者成功地进行ESP实验。</p></div></div>    
</body>
</html>