<html>
<head>
<title>Sign JWT Token using a PFX certificate — .Net 7.0</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 PFX 证书签署 JWT 令牌-。Net 7.0</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/sign-jwt-token-using-a-pfx-certificate-net-6-0-c9e07807e180?source=collection_archive---------4-----------------------#2022-12-23">https://blog.devgenius.io/sign-jwt-token-using-a-pfx-certificate-net-6-0-c9e07807e180?source=collection_archive---------4-----------------------#2022-12-23</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><div class=""/><figure class="gm go jp jq jr js gi gj paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="gi gj jo"><img src="../Images/be10ed504dfeb8f396b588d6bbf95ce0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*n4E1h5rYAzji95Jx"/></div></div><figcaption class="jz ka gk gi gj kb kc bd b be z dk translated">照片由<a class="ae kd" href="https://unsplash.com/es/@flyd2069?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">飞:D </a>在<a class="ae kd" href="https://unsplash.com/?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></figcaption></figure><p id="2221" class="pw-post-body-paragraph ke kf ir kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ik bi translated">上一篇文章介绍了使用 PFX 证书签署 JWT 令牌的理论概念。在本文中，我将使用。net 6.0 使用 pfx 证书和密码对 JWT 令牌进行签名。</p><p id="4da0" class="pw-post-body-paragraph ke kf ir kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ik bi translated">我不是 Visual Studio 的忠实粉丝，因为我觉得它太重了。因此，我将主要使用 CLI 工具集和 Visual Studio 代码。</p><h1 id="f984" class="lc ld ir bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">Dotnet 新控制台</h1><p id="4046" class="pw-post-body-paragraph ke kf ir kg b kh ma kj kk kl mb kn ko kp mc kr ks kt md kv kw kx me kz la lb ik bi translated">我们将创建一个控制台应用程序，它将打印一个 JWT 令牌作为输出。在 Visual Studio 代码中打开新的 PowerShell 终端。</p><figure class="mg mh mi mj gu js gi gj paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="gi gj mf"><img src="../Images/85a50bfc1edafbe2fa60a8b3cebc4bfa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pG_E3iVpJ7Uv3qiBSa-MXA.png"/></div></div></figure><p id="24b9" class="pw-post-body-paragraph ke kf ir kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ik bi translated">创建一个新文件夹来保存项目详细信息。我将把这个文件夹命名为 JwtTokenGenerator</p><pre class="mg mh mi mj gu mk ml mm bn mn mo bi"><span id="d542" class="mp ld ir ml b be mq mr l ms mt">mkdir JwtTokenGenerator</span></pre><p id="4910" class="pw-post-body-paragraph ke kf ir kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ik bi translated">从 JwtTokenGenerator 文件夹执行点新建命令</p><pre class="mg mh mi mj gu mk ml mm bn mn mo bi"><span id="763e" class="mp ld ir ml b be mq mr l ms mt">cd JwtTokenGenerator<br/>dotnet new console</span></pre><p id="d972" class="pw-post-body-paragraph ke kf ir kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ik bi translated">命令末尾的“console”关键字请求 dotnet 为此项目使用控制台应用程序模板。命令执行完毕后，我们将看到一个与文件夹 JwtTokenGenerator 同名的 csproj 文件。</p><figure class="mg mh mi mj gu js gi gj paragraph-image"><div class="gi gj mu"><img src="../Images/f1029b4319433216cc70f66caf0860d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/1*iqecKxmY2_Z3TO923PCgZQ.png"/></div></figure><h1 id="587f" class="lc ld ir bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">GetJwtToken()</h1><p id="6b82" class="pw-post-body-paragraph ke kf ir kg b kh ma kj kk kl mb kn ko kp mc kr ks kt md kv kw kx me kz la lb ik bi translated">我将在 Program.cs 中编写一个接受五个输入的函数</p><ol class=""><li id="d06a" class="mv mw ir kg b kh ki kl km kp mx kt my kx mz lb na nb nc nd bi translated">PFX 文件的完整路径—字符串</li><li id="62c2" class="mv mw ir kg b kh ne kl nf kp ng kt nh kx ni lb na nb nc nd bi translated">访问证书信息的密码—字符串</li><li id="fba4" class="mv mw ir kg b kh ne kl nf kp ng kt nh kx ni lb na nb nc nd bi translated">令牌的颁发者—字符串</li><li id="ac54" class="mv mw ir kg b kh ne kl nf kp ng kt nh kx ni lb na nb nc nd bi translated">令牌的受众—字符串</li><li id="2a1a" class="mv mw ir kg b kh ne kl nf kp ng kt nh kx ni lb na nb nc nd bi translated">以分钟为单位的到期持续时间— Int</li></ol><p id="996b" class="pw-post-body-paragraph ke kf ir kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ik bi translated">函数定义将如下所示:</p><pre class="mg mh mi mj gu mk ml mm bn mn mo bi"><span id="e125" class="mp ld ir ml b be mq mr l ms mt">string GetJwtToken(string pfxFilePath, string password, string issuer, string audience, int expiryInMinutes)</span></pre><p id="f158" class="pw-post-body-paragraph ke kf ir kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ik bi translated">要创建和签名 JWT 令牌，我们需要执行以下步骤:</p><h2 id="114a" class="nj ld ir bd le nk nl dn li nm nn dp lm kp no np lq kt nq nr lu kx ns nt ly nu bi translated">步骤 1 —创建 X509Certificate2Collection 类型的实例</h2><p id="9010" class="pw-post-body-paragraph ke kf ir kg b kh ma kj kk kl mb kn ko kp mc kr ks kt md kv kw kx me kz la lb ik bi translated">导入命名空间系统。Security . Cryptography.X509Certificates 证书</p><pre class="mg mh mi mj gu mk ml mm bn mn mo bi"><span id="6e6b" class="mp ld ir ml b be mq mr l ms mt">using System.Security.Cryptography.X509Certificates;</span></pre><p id="72a8" class="pw-post-body-paragraph ke kf ir kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ik bi translated">创建 X509Certificate2Collection 类型的实例。</p><blockquote class="nv"><p id="4f6f" class="nw nx ir bd ny nz oa ob oc od oe lb dk translated"><a class="ae kd" href="https://learn.microsoft.com/en-us/dotnet/api/system.security.cryptography.x509certificates.x509certificate2collection?view=net-7.0" rel="noopener ugc nofollow" target="_blank"> X509Certificate2Collection 代表 X509Certificate2 对象的集合。该类不能被继承。</a></p></blockquote><pre class="of og oh oi oj mk ml mm bn mn mo bi"><span id="d4cd" class="mp ld ir ml b be mq mr l ms mt">var collection = new X509Certificate2Collection();</span></pre><h2 id="bc11" class="nj ld ir bd le nk nl dn li nm nn dp lm kp no np lq kt nq nr lu kx ns nt ly nu bi translated">步骤 2-将 PFX 文件导入集合</h2><p id="1071" class="pw-post-body-paragraph ke kf ir kg b kh ma kj kk kl mb kn ko kp mc kr ks kt md kv kw kx me kz la lb ik bi translated">使用类 X509Certificate2Collection 的实例来<a class="ae kd" href="https://learn.microsoft.com/en-us/dotnet/api/system.security.cryptography.x509certificates.x509certificate2collection.import?view=net-7.0#system-security-cryptography-x509certificates-x509certificate2collection-import(system-string-system-readonlyspan((system-char))-system-security-cryptography-x509certificates-x509keystorageflags)" rel="noopener ugc nofollow" target="_blank">导入一个需要密码</a>才能查看证书细节的证书文件。</p><pre class="mg mh mi mj gu mk ml mm bn mn mo bi"><span id="6d40" class="mp ld ir ml b be mq mr l ms mt">collection.Import(certFilePath, certPassword, X509KeyStorageFlags.PersistKeySet);</span></pre><p id="aa63" class="pw-post-body-paragraph ke kf ir kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ik bi translated">使用参数 X509KeyStorageFlags 的原因。PersistKeySet 是为了避免下面的异常</p><pre class="mg mh mi mj gu mk ml mm bn mn mo bi"><span id="fb7f" class="mp ld ir ml b be mq mr l ms mt">System.Security.Cryptography.CryptographicException: Keyset does not exist. </span></pre><p id="d326" class="pw-post-body-paragraph ke kf ir kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ik bi translated">在这里阅读其背后的原因<a class="ae kd" href="https://learn.microsoft.com/en-us/troubleshoot/developer/dotnet/framework/general/install-pfx-file-using-x509certificate" rel="noopener ugc nofollow" target="_blank">。</a></p><h2 id="7f94" class="nj ld ir bd le nk nl dn li nm nn dp lm kp no np lq kt nq nr lu kx ns nt ly nu bi translated">步骤 3 —获取 X509Certificate2 的实例</h2><p id="d9f1" class="pw-post-body-paragraph ke kf ir kg b kh ma kj kk kl mb kn ko kp mc kr ks kt md kv kw kx me kz la lb ik bi translated">因为集合中只有一个证书，所以我们可以通过获取第一个条目来获得 X509 证书的实例。</p><pre class="mg mh mi mj gu mk ml mm bn mn mo bi"><span id="d343" class="mp ld ir ml b be mq mr l ms mt">var certificate = collection[0];</span></pre><h2 id="538c" class="nj ld ir bd le nk nl dn li nm nn dp lm kp no np lq kt nq nr lu kx ns nt ly nu bi translated">步骤 4 —创建系统的一个实例。Security.Cryptography.Rsa 类</h2><p id="d759" class="pw-post-body-paragraph ke kf ir kg b kh ma kj kk kl mb kn ko kp mc kr ks kt md kv kw kx me kz la lb ik bi translated">下一步是创建一个默认实现<a class="ae kd" href="https://learn.microsoft.com/en-us/dotnet/api/system.security.cryptography.rsa?view=net-7.0" rel="noopener ugc nofollow" target="_blank"> RSA </a>算法的实例。</p><blockquote class="nv"><p id="5e1d" class="nw nx ir bd ny nz oa ob oc od oe lb dk translated"><a class="ae kd" href="https://www.connect2id.com/products/nimbus-jose-jwt/examples/jwt-with-rsa-encryption#:~:text=RSA%20is%20a%20commonly%20used%20algorithm%20for%20asymmetric,the%20recipient%20must%20keep%20secure%20at%20all%20times." rel="noopener ugc nofollow" target="_blank"> RSA 是 40 多年前建立的一种流行的非对称(公钥)加密算法。为给定的接收者加密 JWT 需要他们的公开 RSA 密钥。解密使用相应的私有 RSA 密钥进行，接收方必须始终对该密钥保密。</a></p></blockquote><pre class="of og oh oi oj mk ml mm bn mn mo bi"><span id="ca77" class="mp ld ir ml b be mq mr l ms mt">var rsaPrivateKey = certificate.GetRSAPrivateKey();</span></pre><h2 id="3913" class="nj ld ir bd le nk nl dn li nm nn dp lm kp no np lq kt nq nr lu kx ns nt ly nu bi translated">步骤 5 —创建 RsaSecurityKey 类的实例</h2><p id="42d3" class="pw-post-body-paragraph ke kf ir kg b kh ma kj kk kl mb kn ko kp mc kr ks kt md kv kw kx me kz la lb ik bi translated"><a class="ae kd" href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.identitymodel.tokens.rsasecuritykey?view=azure-dotnet" rel="noopener ugc nofollow" target="_blank"> RsaSecurityKey </a>类代表一个 Rsa 安全密钥。我们需要一个 NuGet 包来导入命名空间 Microsoft.IdentityModel.Tokens。</p><pre class="mg mh mi mj gu mk ml mm bn mn mo bi"><span id="8edc" class="mp ld ir ml b be mq mr l ms mt">dotnet add package Microsoft.IdentityModel.Tokens — version 6.25.1</span></pre><p id="c327" class="pw-post-body-paragraph ke kf ir kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ik bi translated">安装成功后，导入名称空间 Microsoft。然后在 GetJwtToken()方法中添加以下代码。</p><pre class="mg mh mi mj gu mk ml mm bn mn mo bi"><span id="92a5" class="mp ld ir ml b be mq mr l ms mt">Var privateSecurityKey = new RsaSecurityKey(rsaPrivateKey);</span></pre><h2 id="2b36" class="nj ld ir bd le nk nl dn li nm nn dp lm kp no np lq kt nq nr lu kx ns nt ly nu bi translated">步骤 6 —向令牌添加属性</h2><p id="04a1" class="pw-post-body-paragraph ke kf ir kg b kh ma kj kk kl mb kn ko kp mc kr ks kt md kv kw kx me kz la lb ik bi translated">下一步是准备令牌的属性。</p><pre class="mg mh mi mj gu mk ml mm bn mn mo bi"><span id="5ab0" class="mp ld ir ml b be mq mr l ms mt">var descriptor = new SecurityTokenDescriptor<br/> {<br/>   Issuer = issuer,<br/>   Audience = audience,<br/>   IssuedAt = DateTime.UtcNow,<br/>   NotBefore = DateTime.UtcNow,<br/>   Expires = DateTime.UtcNow.AddMinutes(expiryInMinutes),<br/>   <br/>   //Import the namespace System.Security.Claims; for setting of claims along with the token.<br/>   Subject = new ClaimsIdentity(new List&lt;Claim&gt; { }),<br/>   <br/>   // SigningCredentials will sign the jwt token using RSA-SHA256 cryptographic algorithm<br/>   SigningCredentials = new SigningCredentials(privateSecurityKey, SecurityAlgorithms.RsaSha256Signature)<br/> };</span></pre><h2 id="a464" class="nj ld ir bd le nk nl dn li nm nn dp lm kp no np lq kt nq nr lu kx ns nt ly nu bi translated">步骤 7 —创建 JsonWebTokenHandler 的实例</h2><p id="d835" class="pw-post-body-paragraph ke kf ir kg b kh ma kj kk kl mb kn ko kp mc kr ks kt md kv kw kx me kz la lb ik bi translated"><a class="ae kd" href="https://learn.microsoft.com/en-us/previous-versions/visualstudio/dn464181(v=vs.114)" rel="noopener ugc nofollow" target="_blank"> JsonWebTokenHandler </a>是一个<a class="ae kd" href="https://msdn.microsoft.com/en-us/library/hh193414(v=vs.114)" rel="noopener ugc nofollow" target="_blank"> SecurityTokenHandler </a>用于创建和验证 JSON Web 令牌(JWT)。有关 JWT 规范的更多信息，请参见<a class="ae kd" href="http://tools.ietf.org/html/draft-ietf-oauth-json-web-token-07" rel="noopener ugc nofollow" target="_blank">http://tools . IETF . org/html/draft-IETF-oauth-JSON-we b-token-07</a>。</p><p id="c1ad" class="pw-post-body-paragraph ke kf ir kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ik bi translated">我们需要添加一个 nuget 包来创建类<a class="ae kd" href="https://learn.microsoft.com/en-us/previous-versions/visualstudio/dn464181(v=vs.114)" rel="noopener ugc nofollow" target="_blank"> JsonWebTokenHandler </a>的实例。在 PowerShell 窗口上运行以下命令。</p><pre class="mg mh mi mj gu mk ml mm bn mn mo bi"><span id="e9dd" class="mp ld ir ml b be mq mr l ms mt">dotnet add package Microsoft.IdentityModel.JsonWebTokens — version 6.25.1</span></pre><p id="1930" class="pw-post-body-paragraph ke kf ir kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ik bi translated">安装成功后，导入名称空间 Microsoft . identity model . jsonwebtokens</p><pre class="mg mh mi mj gu mk ml mm bn mn mo bi"><span id="a884" class="mp ld ir ml b be mq mr l ms mt">var handler = new JsonWebTokenHandler();</span></pre><h2 id="131e" class="nj ld ir bd le nk nl dn li nm nn dp lm kp no np lq kt nq nr lu kx ns nt ly nu bi translated">步骤 8-签署 JWT 令牌</h2><p id="9d0b" class="pw-post-body-paragraph ke kf ir kg b kh ma kj kk kl mb kn ko kp mc kr ks kt md kv kw kx me kz la lb ik bi translated">最后一步是通过调用 JsonWebTokenHandler 类上的 CreateToken 方法，使用 RSA 私有安全密钥进行签名来创建 JWT 令牌。</p><pre class="mg mh mi mj gu mk ml mm bn mn mo bi"><span id="a5c8" class="mp ld ir ml b be mq mr l ms mt">jwtToken = handler.CreateToken(descriptor);</span></pre></div><div class="ab cl ok ol hv om" role="separator"><span class="on bw bk oo op oq"/><span class="on bw bk oo op oq"/><span class="on bw bk oo op"/></div><div class="ik il im in io"><h1 id="3dca" class="lc ld ir bd le lf or lh li lj os ll lm ln ot lp lq lr ou lt lu lv ov lx ly lz bi translated">最终版</h1><p id="b445" class="pw-post-body-paragraph ke kf ir kg b kh ma kj kk kl mb kn ko kp mc kr ks kt md kv kw kx me kz la lb ik bi translated">GetJwtToken()方法的最终版本将如下所示:</p><figure class="mg mh mi mj gu js"><div class="bz fq l di"><div class="ow ox l"/></div></figure></div><div class="ab cl ok ol hv om" role="separator"><span class="on bw bk oo op oq"/><span class="on bw bk oo op oq"/><span class="on bw bk oo op"/></div><div class="ik il im in io"><p id="fae1" class="pw-post-body-paragraph ke kf ir kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ik bi translated">页（page 的缩写）s-Medium 是一个阅读、写作和向其他作者学习的绝佳平台。如果你想加入我的旅程，今天就加入<a class="ae kd" href="https://tarunbhatt9784.medium.com/membership" rel="noopener"> medium </a>。</p></div></div>    
</body>
</html>