<html>
<head>
<title>NEAR Protocol contract tutorial: donations alert</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">近似协议合同教程:捐赠预警</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/near-protocol-contract-tutorial-donations-alert-9f79a859c16b?source=collection_archive---------24-----------------------#2022-12-03">https://blog.devgenius.io/near-protocol-contract-tutorial-donations-alert-9f79a859c16b?source=collection_archive---------24-----------------------#2022-12-03</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><figure class="im in gp gr io ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi il"><img src="../Images/70d6de697f4b5ba1cd4e4d226cd0d833.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zGUxwTPzwn8z4SDXx9rMxg.png"/></div></div></figure><div class=""/><h1 id="3245" class="jv jw iy bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">项目描述</h1><p id="9a82" class="pw-post-body-paragraph kt ku iy kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">网络 3 捐款在附近与溪流警报。</p><h2 id="0c41" class="lr jw iy bd jx ls lt dn kb lu lv dp kf le lw lx kj li ly lz kn lm ma mb kr mc bi translated">特征</h2><ul class=""><li id="7674" class="md me iy kv b kw kx la lb le mf li mg lm mh lq mi mj mk ml bi translated">web3 应用程序</li><li id="6a53" class="md me iy kv b kw mm la mn le mo li mp lm mq lq mi mj mk ml bi translated">用邮件发送捐赠</li><li id="f22f" class="md me iy kv b kw mm la mn le mo li mp lm mq lq mi mj mk ml bi translated">捐赠统计</li><li id="fb84" class="md me iy kv b kw mm la mn le mo li mp lm mq lq mi mj mk ml bi translated">显示捐赠提醒</li></ul><h2 id="2d7e" class="lr jw iy bd jx ls lt dn kb lu lv dp kf le lw lx kj li ly lz kn lm ma mb kr mc bi translated">更多功能</h2><ul class=""><li id="3992" class="md me iy kv b kw kx la lb le mf li mg lm mh lq mi mj mk ml bi translated">警报页面的配置(字体、颜色、背景颜色、音乐等)</li><li id="5501" class="md me iy kv b kw mm la mn le mo li mp lm mq lq mi mj mk ml bi translated">为捐赠添加图像</li><li id="1fcb" class="md me iy kv b kw mm la mn le mo li mp lm mq lq mi mj mk ml bi translated">向电报发送警报</li><li id="b973" class="md me iy kv b kw mm la mn le mo li mp lm mq lq mi mj mk ml bi translated">保存图片的所有作者</li><li id="bea3" class="md me iy kv b kw mm la mn le mo li mp lm mq lq mi mj mk ml bi translated">标桩(标桩时给出一些标高)</li></ul></div><div class="ab cl mr ms hr mt" role="separator"><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw"/></div><div class="ig ih ii ij ik"><h2 id="3a3c" class="lr jw iy bd jx ls lt dn kb lu lv dp kf le lw lx kj li ly lz kn lm ma mb kr mc bi translated">创建新项目</h2><p id="d966" class="pw-post-body-paragraph kt ku iy kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">对于 rust 中的新人，你可以从近队开始阅读<a class="ae my" href="https://www.near-sdk.io/" rel="noopener ugc nofollow" target="_blank"><em class="mz"/></a>然后回到中队。</p><pre class="na nb nc nd gt ne nf ng nh aw ni bi"><span id="ef19" class="lr jw iy nf b gy nj nk l nl nm">// create new library project<br/># cargo new near-donations --lib</span></pre><p id="1763" class="pw-post-body-paragraph kt ku iy kv b kw nn ky kz la no lc ld le np lg lh li nq lk ll lm nr lo lp lq ig bi translated">添加到 cargo.toml</p><pre class="na nb nc nd gt ne nf ns bn nt nu bi"><span id="add6" class="nv jw iy nf b be nw nx l ny nm">[package]<br/>name = "near-donations"<br/>version = "0.1.0"<br/>authors = ["dkot &lt;https://medium.com/@tokd&gt;, dkot.near"]<br/>edition = "2021"<br/><br/>[lib]<br/>crate-type = ["cdylib"]<br/><br/>[dependencies]<br/>near-sdk = {version="4.1.1"}<br/><br/>[profile.release]<br/>codegen-units = 1<br/># Tell `rustc` to optimize for small code size.<br/>opt-level = "z"<br/>lto = true<br/>debug = false<br/>panic = "abort"<br/># Opt into extra safety checks on arithmetic operations https://stackoverflow.com/a/64136471/249801<br/>overflow-checks = true</span></pre><p id="613b" class="pw-post-body-paragraph kt ku iy kv b kw nn ky kz la no lc ld le np lg lh li nq lk ll lm nr lo lp lq ig bi translated">在 rust 上写任何代码的最好工具是<em class="mz"> cargo fmt </em>和<em class="mz"> cargo clippy。</em></p><p id="9a77" class="pw-post-body-paragraph kt ku iy kv b kw nn ky kz la no lc ld le np lg lh li nq lk ll lm nr lo lp lq ig bi translated">从任何合同的模板开始</p><pre class="na nb nc nd gt ne nf ns bn nt nu bi"><span id="5e66" class="nv jw iy nf b be nw nx l ny nm">use near_sdk::borsh::{self, BorshDeserialize, BorshSerialize};<br/>use near_sdk::{near_bindgen, PanicOnDefault};<br/><br/>#[near_bindgen]<br/>#[derive(BorshDeserialize, BorshSerialize, PanicOnDefault)]<br/>pub struct Contract {}<br/><br/>#[near_bindgen]<br/>impl Contract {<br/>    #[init]<br/>    pub fn new() -&gt; Self {<br/>        Self {}<br/>    }<br/>}</span></pre><p id="b358" class="pw-post-body-paragraph kt ku iy kv b kw nn ky kz la no lc ld le np lg lh li nq lk ll lm nr lo lp lq ig bi translated">为了更好地理解如何在合同中存储数据，请阅读关于<a class="ae my" href="https://www.near-sdk.io/contract-structure/collections" rel="noopener ugc nofollow" target="_blank"> <em class="mz">集合</em> </a></p><p id="f083" class="pw-post-body-paragraph kt ku iy kv b kw nn ky kz la no lc ld le np lg lh li nq lk ll lm nr lo lp lq ig bi translated">存储捐赠的结构:</p><pre class="na nb nc nd gt ne nf ns bn nt nu bi"><span id="ec6e" class="nv jw iy nf b be nw nx l ny nm">#[derive(Serialize, Deserialize, BorshDeserialize, BorshSerialize, Debug, PartialEq, Eq)]<br/>#[serde(crate = "near_sdk::serde")]<br/>pub struct Donation {<br/>    /// Donation account id<br/>    pub account_id: AccountId,<br/>    /// Donation sum<br/>    pub sum: U128,<br/>    /// Donation message<br/>    pub msg: String,<br/>}</span></pre><p id="8966" class="pw-post-body-paragraph kt ku iy kv b kw nn ky kz la no lc ld le np lg lh li nq lk ll lm nr lo lp lq ig bi translated">对于合同中的商店捐赠，如果我们希望支持迭代，请使用 LookupMap 或 TreeMap。其中 key —捐赠标识，value —捐赠。将商店添加到合同结构和捐赠序列中，以了解我们有多少捐赠:</p><pre class="na nb nc nd gt ne nf ns bn nt nu bi"><span id="86da" class="nv jw iy nf b be nw nx l ny nm">use near_sdk::json_types::U128;<br/>use near_sdk::store::LookupMap;<br/><br/>#[near_bindgen]<br/>#[derive(BorshDeserialize, BorshSerialize, PanicOnDefault)]<br/>pub struct Contract {<br/>    /// we can deploy contract to any other account on near and specify main account hear for all transfers<br/>    beneficiary: AccountId,<br/><br/>    /// storage for all donations<br/>    /// &lt;donation_id, Donation&gt;<br/>    donations: LookupMap&lt;U128, Donation&gt;,<br/>    /// sequence growing after insert donation<br/>    donations_sequence: u128,<br/>}</span></pre><p id="cbce" class="pw-post-body-paragraph kt ku iy kv b kw nn ky kz la no lc ld le np lg lh li nq lk ll lm nr lo lp lq ig bi translated">并将受益人字段添加到所有代币转移合同中。</p></div><div class="ab cl mr ms hr mt" role="separator"><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw"/></div><div class="ig ih ii ij ik"><p id="7994" class="pw-post-body-paragraph kt ku iy kv b kw nn ky kz la no lc ld le np lg lh li nq lk ll lm nr lo lp lq ig bi translated">现在我们可以实现我们的函数了。</p><h2 id="2546" class="lr jw iy bd jx ls lt dn kb lu lv dp kf le lw lx kj li ly lz kn lm ma mb kr mc bi translated">新功能</h2><p id="fffe" class="pw-post-body-paragraph kt ku iy kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">契约中的第一个函数必须在区块链上初始化它的状态。LookupMap 需要前缀，它可以只是 enum。</p><pre class="na nb nc nd gt ne nf ns bn nt nu bi"><span id="fc80" class="nv jw iy nf b be nw nx l ny nm">#[derive(BorshSerialize, BorshStorageKey)]<br/>enum StorageKey {<br/>    Donations,<br/>}<br/>#[init]<br/>pub fn new(beneficiary: AccountId) -&gt; Self {<br/>    Self {<br/>        beneficiary,<br/>        donations: LookupMap::new(StorageKey::Donations),<br/>        donations_sequence: 0<br/>    }<br/>}</span></pre><h2 id="763e" class="lr jw iy bd jx ls lt dn kb lu lv dp kf le lw lx kj li ly lz kn lm ma mb kr mc bi translated">捐赠功能</h2><p id="4c55" class="pw-post-body-paragraph kt ku iy kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">在我们使用近币的功能中需要使用#[应付款]属性来接受代币转账。只需通过键获取条目，如果存在则抛出异常，如果不存在则插入新记录。在增加序列和转移捐赠给受益人之后。</p><pre class="na nb nc nd gt ne nf ns bn nt nu bi"><span id="638f" class="nv jw iy nf b be nw nx l ny nm">use near_sdk::store::lookup_map::Entry;<br/><br/>#[payable]<br/>pub fn donate(&amp;mut self, msg: String) {<br/>    match self.donations.entry(U128::from(self.donations_sequence)) {<br/>        Entry::Occupied(_) =&gt; env::panic_str("donation id already exist"),<br/>        Entry::Vacant(e) =&gt; {<br/>            e.insert(Donation {<br/>                account_id: env::signer_account_id(),<br/>                sum: U128::from(env::attached_deposit()),<br/>                msg,<br/>            });<br/>        }<br/>    }<br/><br/>    self.donations_sequence += 1;<br/><br/>    Promise::new(self.beneficiary.clone()).transfer(env::attached_deposit());<br/>}</span></pre><h2 id="c979" class="lr jw iy bd jx ls lt dn kb lu lv dp kf le lw lx kj li ly lz kn lm ma mb kr mc bi translated">获取捐赠和捐赠序列</h2><p id="fb94" class="pw-post-body-paragraph kt ku iy kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">知道了序列号，我们可以请求任何捐赠记录。</p><pre class="na nb nc nd gt ne nf ns bn nt nu bi"><span id="d9f8" class="nv jw iy nf b be nw nx l ny nm">pub fn get_donation(&amp;self, donation_id: U128) -&gt; Option&lt;&amp;Donation&gt; {<br/>    self.donations.get(&amp;donation_id)<br/>}<br/><br/>pub fn donations_sequence(&amp;self) -&gt; U128 {<br/>    U128::from(self.donations_sequence)<br/>}</span></pre><p id="a001" class="pw-post-body-paragraph kt ku iy kv b kw nn ky kz la no lc ld le np lg lh li nq lk ll lm nr lo lp lq ig bi translated">现在我们已经准备好接受捐赠和阅读信息。但是从近命令行界面这样做并不舒服。让我们构建轻型前端，并将其部署到我们的 WEB3 合同中。</p><h2 id="5d8c" class="lr jw iy bd jx ls lt dn kb lu lv dp kf le lw lx kj li ly lz kn lm ma mb kr mc bi translated">构建和部署</h2><p id="ec2f" class="pw-post-body-paragraph kt ku iy kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">在文件夹中写入 build.sh:</p><pre class="na nb nc nd gt ne nf ns bn nt nu bi"><span id="094f" class="nv jw iy nf b be nw nx l ny nm">#!/bin/bash<br/>set -e<br/><br/>RUSTFLAGS='-C link-arg=-s' cargo build --target wasm32-unknown-unknown --release<br/>cp target/wasm32-unknown-unknown/release/*.wasm ./res/</span></pre><p id="3139" class="pw-post-body-paragraph kt ku iy kv b kw nn ky kz la no lc ld le np lg lh li nq lk ll lm nr lo lp lq ig bi translated">对于构建，只需运行。/build.sh 如果你想纠正检查代码，写<em class="mz">货物检查</em>。</p><p id="a8e3" class="pw-post-body-paragraph kt ku iy kv b kw nn ky kz la no lc ld le np lg lh li nq lk ll lm nr lo lp lq ig bi translated">为了部署您的合同，请在 cli 附近下载并安装<a class="ae my" href="https://github.com/near/near-cli#installation" rel="noopener ugc nofollow" target="_blank">并在构建后编写您想要在哪个帐户上部署的文件，不要在主帐户上部署它，请创建一些其他的类似 contributions-my account . near 的文件，因为现在 web4 只支持二级域。</a></p><p id="a0f1" class="pw-post-body-paragraph kt ku iy kv b kw nn ky kz la no lc ld le np lg lh li nq lk ll lm nr lo lp lq ig bi translated">并通过调用受益人的新方法来初始化您的合同。受益人可以是合同账户，也可以是您的其他账户。</p><pre class="na nb nc nd gt ne nf ns bn nt nu bi"><span id="4381" class="nv jw iy nf b be nw nx l ny nm">near deploy --wasmFile res/near-donations.wasm --accountId &lt;Contract Account ID&gt;<br/>near call &lt;Contract Account ID&gt; new '{"beneficiary":"&lt;Account ID&gt;"}' --accountId &lt;Contract Account ID&gt;</span></pre></div><div class="ab cl mr ms hr mt" role="separator"><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw"/></div><div class="ig ih ii ij ik"><h1 id="cf75" class="jv jw iy bd jx jy nz ka kb kc oa ke kf kg ob ki kj kk oc km kn ko od kq kr ks bi translated">网络 4(网络 3)</h1><p id="b577" class="pw-post-body-paragraph kt ku iy kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated"><a class="ae my" href="https://github.com/vgrichina/web4" rel="noopener ugc nofollow" target="_blank"> web4 项目</a>直接从合同中给一个免费的域名请求我们的前端。<a class="ae my" href="https://github.com/frol/near-web4-demo" rel="noopener ugc nofollow" target="_blank">这里是 rust 演示</a></p><p id="0e62" class="pw-post-body-paragraph kt ku iy kv b kw nn ky kz la no lc ld le np lg lh li nq lk ll lm nr lo lp lq ig bi translated">我们支持 web4 所需要的一切就是实现 web4_get 方法。指定页面的路径。</p><pre class="na nb nc nd gt ne nf ns bn nt nu bi"><span id="10a1" class="nv jw iy nf b be nw nx l ny nm">#[derive(Debug, Serialize, Deserialize)]<br/>#[serde(crate = "near_sdk::serde")]<br/>pub struct Web4Request {<br/>    #[serde(rename = "accountId")]<br/>    pub account_id: Option&lt;String&gt;,<br/>    pub path: String,<br/>    #[serde(default)]<br/>    pub params: std::collections::HashMap&lt;String, String&gt;,<br/>    #[serde(default)]<br/>    pub query: std::collections::HashMap&lt;String, Vec&lt;String&gt;&gt;,<br/>    pub preloads: Option&lt;std::collections::HashMap&lt;String, Web4Response&gt;&gt;,<br/>}<br/><br/>#[derive(Debug, Serialize, Deserialize)]<br/>#[serde(crate = "near_sdk::serde", untagged)]<br/>pub enum Web4Response {<br/>    Body {<br/>        #[serde(rename = "contentType")]<br/>        content_type: String,<br/>        body: near_sdk::json_types::Base64VecU8,<br/>    },<br/>    BodyUrl {<br/>        #[serde(rename = "bodyUrl")]<br/>        body_url: String,<br/>    },<br/>    PreloadUrls {<br/>        #[serde(rename = "preloadUrls")]<br/>        preload_urls: Vec&lt;String&gt;,<br/>    },<br/>}<br/><br/>#[near_bindgen]<br/>impl Contract {<br/>    /// Learn more about web4 here: https://web4.near.page<br/>    pub fn web4_get(&amp;self, request: Web4Request) -&gt; Web4Response {<br/>        if request.path == "/stats" {<br/>            return Web4Response::Body {<br/>                content_type: "text/html; charset=UTF-8".to_owned(),<br/>                body: include_str!("stats.html").as_bytes().to_owned().into(),<br/>            };<br/>        }<br/><br/>        if request.path == "/alerts" {<br/>            return Web4Response::Body {<br/>                content_type: "text/html; charset=UTF-8".to_owned(),<br/>                body: include_str!("alerts.html").as_bytes().to_owned().into(),<br/>            };<br/>        }<br/><br/>        Web4Response::Body {<br/>            content_type: "text/html; charset=UTF-8".to_owned(),<br/>            body: include_str!("donation.html").as_bytes().to_owned().into(),<br/>        }<br/>    }<br/>}</span></pre><p id="04ac" class="pw-post-body-paragraph kt ku iy kv b kw nn ky kz la no lc ld le np lg lh li nq lk ll lm nr lo lp lq ig bi translated">前端页面可以在<a class="ae my" href="https://github.com/dkotTech/near-donations/tree/main/near-contract/src" rel="noopener ugc nofollow" target="_blank"> github 页面</a>中找到。</p><h2 id="c0b3" class="lr jw iy bd jx ls lt dn kb lu lv dp kf le lw lx kj li ly lz kn lm ma mb kr mc bi translated">更多功能</h2><p id="e84f" class="pw-post-body-paragraph kt ku iy kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">其余的建议功能将在第二部分。你可以主动在 discord 中添加或更改列表，也可以通过 github 自己完成。</p><p id="46cc" class="pw-post-body-paragraph kt ku iy kv b kw nn ky kz la no lc ld le np lg lh li nq lk ll lm nr lo lp lq ig bi translated">Github 全代码【https://github.com/dkotTech/near-donations T2】</p><p id="0df2" class="pw-post-body-paragraph kt ku iy kv b kw nn ky kz la no lc ld le np lg lh li nq lk ll lm nr lo lp lq ig bi translated">不和谐问题服务器【https://discord.gg/aXTpQPTTxd T4】</p><p id="aa3e" class="pw-post-body-paragraph kt ku iy kv b kw nn ky kz la no lc ld le np lg lh li nq lk ll lm nr lo lp lq ig bi translated">感谢阅读。</p></div></div>    
</body>
</html>