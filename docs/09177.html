<html>
<head>
<title>Developing locally with HTTPS on Django using Traefik and Docker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Traefik 和 Docker 与 HTTPS 在 Django 进行本地开发</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/developing-locally-with-https-on-django-using-traefik-and-docker-3ae8092757d1?source=collection_archive---------1-----------------------#2022-08-04">https://blog.devgenius.io/developing-locally-with-https-on-django-using-traefik-and-docker-3ae8092757d1?source=collection_archive---------1-----------------------#2022-08-04</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/0139d54103f809b9e4899a10e9056c3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T72uRZL0Mk3KbBpfFbuRag.png"/></div></div></figure><p id="baa0" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">通过利用 HTTPS 反向代理和<a class="ae kt" href="https://github.com/FiloSottile/mkcert" rel="noopener ugc nofollow" target="_blank"> mkcert </a>，在本地使用 TLS/SSL 在 Docker 上为您的 Docker 化应用提供服务的解决方案。</p><p id="bb18" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我想说的是，没有很多教程会详细解释如何设置，相信我，我已经搜索过了。本教程是写关于小时研究的有效性，并已成功应用于一个项目。让我们开始吧。</p><h1 id="3ca4" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">目录</h1><ul class=""><li id="927c" class="ls lt in jx b jy lu kc lv kg lw kk lx ko ly ks lz ma mb mc bi translated"><strong class="jx io"> <em class="md">全局设置 MK cert</em></strong></li><li id="228d" class="ls lt in jx b jy me kc mf kg mg kk mh ko mi ks lz ma mb mc bi translated"><strong class="jx io"> <em class="md">本地设置 Traefik</em></strong></li><li id="579c" class="ls lt in jx b jy me kc mf kg mg kk mh ko mi ks lz ma mb mc bi translated"><strong class="jx io"> <em class="md">配置环境</em> </strong></li><li id="98a3" class="ls lt in jx b jy me kc mf kg mg kk mh ko mi ks lz ma mb mc bi translated"><strong class="jx io"> <em class="md">将容器化服务连接到 Traefik </em> </strong></li><li id="a8e4" class="ls lt in jx b jy me kc mf kg mg kk mh ko mi ks lz ma mb mc bi translated"><strong class="jx io"> <em class="md">配置在 Traefik 侧</em> </strong></li><li id="7045" class="ls lt in jx b jy me kc mf kg mg kk mh ko mi ks lz ma mb mc bi translated"><strong class="jx io"> <em class="md">服务端配置</em> </strong></li></ul><p id="bbba" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">越来越有必要在一个安全的环境中开发软件，以便在部署到生产环境中时只有很少的更改。最近，脸书改变了对使用脸书登录的应用程序/网站的政策，要求 OAuth 重定向 URL 使用 HTTPS URL。因此，如果您想将<code class="fe mj mk ml mm b">users</code>应用程序与 OAuth 提供商(如脸书)一起使用，那么保护您与本地开发环境的通信将是必要的。</p><h1 id="a981" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">全局设置 mkcert</h1><p id="08d0" class="pw-post-body-paragraph jv jw in jx b jy lu ka kb kc lv ke kf kg mn ki kj kk mo km kn ko mp kq kr ks ig bi translated">为了创建一个安全的环境，我们需要在 Docker 应用程序中安装一个可信的 SSL 证书。为此，我们将利用<a class="ae kt" href="https://github.com/FiloSottile/mkcert" rel="noopener ugc nofollow" target="_blank"> mkcert </a>。</p><p id="f33f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">该链接将带您到 GitHub repo，它将指导您如何在您的操作系统上安装 mkcert 来生成 SSL 证书。在本教程中，我将使用 windows 操作系统。你需要为 windows <a class="ae kt" href="https://chocolatey.org/instal" rel="noopener ugc nofollow" target="_blank">安装一个软件包管理器。</a></p><p id="3c95" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">一旦你以管理员的身份安装了 run <code class="fe mj mk ml mm b">choco install mkcert</code>,在这个过程完成后运行<code class="fe mj mk ml mm b">mkcert -install</code>,如果你没有得到任何错误，你就成功地设置了它。</p><h1 id="0c52" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">在本地设置 Traefik</h1><p id="d069" class="pw-post-body-paragraph jv jw in jx b jy lu ka kb kc lv ke kf kg mn ki kj kk mo km kn ko mp kq kr ks ig bi translated">我发现实施 HTTPS 流量的过程有点挑战性，需要比 Traefik 版本 1 更多的努力。现在，我们可以使用 HTTPS 只有一个本地开发的自签名证书，没有 HTTP。</p><p id="cc02" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">您可以为我开发的 Traefik 容器克隆 Github repo，以便在本地环境<a class="ae kt" href="https://github.com/Ocolus1/local_traefik" rel="noopener ugc nofollow" target="_blank">这里</a>上运行。</p><p id="3113" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><a class="ae kt" href="https://github.com/traefik/traefik" rel="noopener ugc nofollow" target="_blank"> Traefik </a>是开源的边缘路由器。您可以将它用作 docker 容器中服务和应用程序的反向代理。这是使用自签名 SSL 证书在 docker 中的本地计算机上运行 Traefik 的配置和使用指南。克隆存储库后，您需要配置您的环境。在您选择的文本编辑器中打开克隆的 repo，并导航到终端中的文件夹。</p><h1 id="0ce7" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">配置环境</h1><ul class=""><li id="eb1e" class="ls lt in jx b jy lu kc lv kg lw kk lx ko ly ks lz ma mb mc bi translated">创建一个名为<code class="fe mj mk ml mm b">proxy</code>的 docker 网络(网络名称可以是任意的，只要为所有服务保留即可)。该网络将为 Traefik 代理的所有服务和应用程序所共用(外部):</li></ul><pre class="mq mr ms mt gt mu mm mv mw aw mx bi"><span id="fd2d" class="my kv in mm b gy mz na l nb nc">docker network create proxy</span></pre><ul class=""><li id="4c06" class="ls lt in jx b jy jz kc kd kg nd kk ne ko nf ks lz ma mb mc bi translated">转到终端中的文件夹<code class="fe mj mk ml mm b">certs</code>，使用 mkcert 为 Traefik dashboard 生成一个自签名证书。在这个例子中，域名是<code class="fe mj mk ml mm b">traefik.local</code>。如果要使用另一个域名，还需要在<code class="fe mj mk ml mm b">docker-compose.yml</code>中的 Traefik 路由器主机规则中进行更改，并注意其他步骤中的域名。</li></ul><pre class="mq mr ms mt gt mu mm mv mw aw mx bi"><span id="efbd" class="my kv in mm b gy mz na l nb nc">mkcert --cert-file traefik.local.crt --key-file traefik.local.key traefik.local</span></pre><ul class=""><li id="8ba6" class="ls lt in jx b jy jz kc kd kg nd kk ne ko nf ks lz ma mb mc bi translated">将生成的证书和密钥路径添加到<code class="fe mj mk ml mm b">conf</code>文件夹下的动态配置文件<code class="fe mj mk ml mm b">tls_certificates.local.yml</code>中。如果您将域“traefik.local”用于自签名证书，则不需要做任何事情，因为这些路径已经在文件中。如果您使用另一个域名，您需要在<code class="fe mj mk ml mm b">tls_certificates.local.yml</code>文件中将<code class="fe mj mk ml mm b">traefik.local</code>更改为您的域名)</li><li id="0e90" class="ls lt in jx b jy me kc mf kg mg kk mh ko mi ks lz ma mb mc bi translated">将 Traefik 仪表板的域名(<code class="fe mj mk ml mm b">traefik.local</code>)添加到<code class="fe mj mk ml mm b">hosts</code>文件中(使用本地主机的 IP)</li></ul><h1 id="f069" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">为此:</h1><p id="1036" class="pw-post-body-paragraph jv jw in jx b jy lu ka kb kc lv ke kf kg mn ki kj kk mo km kn ko mp kq kr ks ig bi translated">1.以管理员权限打开记事本</p><figure class="mq mr ms mt gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ng"><img src="../Images/42c8a0157f068751f31765bb2cbc8835.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hd7FORTvC1UoBQub3oZZyA.png"/></div></div></figure><p id="c9c8" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">2.单击左上角的文件，然后单击打开。</p><figure class="mq mr ms mt gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nh"><img src="../Images/f01f4fc2031b4a6fb4d3d9ace7950202.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s9PVBT9cYBhMJZdluHb3-A.png"/></div></div></figure><p id="25b7" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">3.浏览到<strong class="jx io"> C:Windows &gt; System32 &gt;驱动程序&gt;等&gt;主机</strong></p><figure class="mq mr ms mt gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nh"><img src="../Images/b4235b193cf50ae05de7db58d9a88c95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yk50cGkrAOnizo6cZ9gfKw.png"/></div></div></figure><p id="aa5a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如果您以图形方式浏览文件夹，请记住将文件类型过滤器更改为“所有文件”,以便显示 hosts 文件。现在您已经准备好编辑文件了。如果您以前从未打开过 hosts 文件，您将会看到一小段描述其用途以及如何进行编辑的文本。简介提供了一个关于文件结构的有用概述，但是我们将在这里讨论基础知识。</p><p id="6953" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">hosts 文件是 IP 地址和主机名的简单映射。每个条目占据一个新行，首先是 IP 地址(数字地址)，然后是空格或制表符，最后是主机名(或域)。您可以通过在行首放置一个“#”字符来向文件添加注释，这将使 Windows 在读取文件时忽略该行。</p><p id="b941" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">因此，如果你想将“<a class="ae kt" href="https://microsoft.com/" rel="noopener ugc nofollow" target="_blank">microsoft.com</a>”指向 IP 1.2.3.4，你应该在新的一行上写“1 . 2 . 3 . 4<a class="ae kt" href="https://microsoft.com/" rel="noopener ugc nofollow" target="_blank">microsoft.com</a>”。每次你试图访问 microsoft.com T21，你都会发现自己在(不存在的)1.2.3.4 网站上。</p><p id="1d59" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">将<code class="fe mj mk ml mm b">127.0.0.1 traefik.local</code>添加到主机文件并保存。</p><h1 id="079c" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">运行本地 Traefik</h1><p id="f211" class="pw-post-body-paragraph jv jw in jx b jy lu ka kb kc lv ke kf kg mn ki kj kk mo km kn ko mp kq kr ks ig bi translated">完成配置步骤后，在 shell 中打开 local_traefik 存储库的根文件夹，并运行命令</p><pre class="mq mr ms mt gt mu mm mv mw aw mx bi"><span id="b280" class="my kv in mm b gy mz na l nb nc">docker-compose up --build -d</span></pre><p id="d716" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">之后，在浏览器中打开<code class="fe mj mk ml mm b">https://traefik.local</code>查看 Traefik 仪表盘。如果浏览器没有抱怨证书，那么一切都是正确的。确保在浏览器中包含完整的 URL，而不仅仅是域名。</p><h1 id="9b80" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">将集装箱服务连接到 Traefik</h1><p id="e27a" class="pw-post-body-paragraph jv jw in jx b jy lu ka kb kc lv ke kf kg mn ki kj kk mo km kn ko mp kq kr ks ig bi translated">在一个典型的场景中，我们有外部 docker 网络、包含 Traefik 的容器，以及几个包含服务和应用程序的容器。启动 Traefik 后，我们可以将客户端连接到它，而无需重新启动它。例如，我们想将域为<code class="fe mj mk ml mm b">testapp.local</code>的服务<code class="fe mj mk ml mm b">testapp</code>连接到我们的 local_traefik。为此，请执行以下步骤:</p><h1 id="05e9" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">操作系统端的配置</h1><p id="b48a" class="pw-post-body-paragraph jv jw in jx b jy lu ka kb kc lv ke kf kg mn ki kj kk mo km kn ko mp kq kr ks ig bi translated">像上一步一样，将服务的域名(在我们的例子中是<code class="fe mj mk ml mm b">testapp.local</code>)添加到<code class="fe mj mk ml mm b">hosts</code>文件中(使用本地主机的 IP ):</p><pre class="mq mr ms mt gt mu mm mv mw aw mx bi"><span id="45da" class="my kv in mm b gy mz na l nb nc">127.0.0.1 testapp.local</span></pre><h1 id="c1a3" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">Traefik 侧的配置</h1><ul class=""><li id="4e34" class="ls lt in jx b jy lu kc lv kg lw kk lx ko ly ks lz ma mb mc bi translated">转到 shell 中的文件夹<code class="fe mj mk ml mm b">certs</code>,用 mkcert 为<code class="fe mj mk ml mm b">testapp.local</code>域名生成一个自签名证书:</li></ul><pre class="mq mr ms mt gt mu mm mv mw aw mx bi"><span id="d7e6" class="my kv in mm b gy mz na l nb nc">mkcert --cert-file testapp.local.crt --key-file testapp.local.key testapp.local</span></pre><ul class=""><li id="de4d" class="ls lt in jx b jy jz kc kd kg nd kk ne ko nf ks lz ma mb mc bi translated">将生成的证书和密钥路径添加到<code class="fe mj mk ml mm b">conf</code>文件夹中的动态配置文件<code class="fe mj mk ml mm b">tls_certificates.local.yml</code>:</li></ul><pre class="mq mr ms mt gt mu mm mv mw aw mx bi"><span id="67e4" class="my kv in mm b gy mz na l nb nc">...        <br/>   -  certFile: "/etc/traefik/certs/testapp.local.crt"<br/>      keyFile: "/etc/traefik/certs/testapp.local.key"</span></pre><p id="6004" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">再说一次:在这些步骤之后，您不需要重新启动 local_traefik 容器，配置会动态应用。</p><h1 id="c66e" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">服务端的配置</h1><ul class=""><li id="8aa1" class="ls lt in jx b jy lu kc lv kg lw kk lx ko ly ks lz ma mb mc bi translated">在<code class="fe mj mk ml mm b">docker-compose.yml</code>文件中定义外部 docker 网络<code class="fe mj mk ml mm b">proxy</code>(与 traefik 通用):</li></ul><pre class="mq mr ms mt gt mu mm mv mw aw mx bi"><span id="b620" class="my kv in mm b gy mz na l nb nc">networks:<br/>  proxy:<br/>    external: true</span></pre><ul class=""><li id="212b" class="ls lt in jx b jy jz kc kd kg nd kk ne ko nf ks lz ma mb mc bi translated">在<code class="fe mj mk ml mm b">docker-compose.yml</code>文件中为服务配置设置网络<code class="fe mj mk ml mm b">proxy</code>:</li></ul><pre class="mq mr ms mt gt mu mm mv mw aw mx bi"><span id="5397" class="my kv in mm b gy mz na l nb nc">testapp:<br/>    networks:<br/>      - proxy<br/>    ...</span></pre><ul class=""><li id="69c3" class="ls lt in jx b jy jz kc kd kg nd kk ne ko nf ks lz ma mb mc bi translated">在<code class="fe mj mk ml mm b">docker-compose.yml</code>文件中添加服务配置的标签:</li></ul><pre class="mq mr ms mt gt mu mm mv mw aw mx bi"><span id="433c" class="my kv in mm b gy mz na l nb nc">labels:<br/>      - traefik.enable=true<br/>      - traefik.docker.network=proxy<br/>      - traefik.http.routers.{ROUTER_NAME}.entrypoints=websecure<br/>      - traefik.http.routers.{ROUTER_NAME}.rule=Host(`testapp.local`) <br/>      - traefik.http.routers.{ROUTER_NAME}.tls=true<br/>      - traefik.http.routers.{ROUTER_NAME}.service={SERVICE_NAME}<br/>      - traefik.http.services.{ROUTER_NAME}.loadbalancer.server.port=80</span></pre><p id="e3b6" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">整个<code class="fe mj mk ml mm b">docker-compose.yml</code>文件:</p><pre class="mq mr ms mt gt mu mm mv mw aw mx bi"><span id="cd6c" class="my kv in mm b gy mz na l nb nc">testapp:<br/>    networks:<br/>      - proxy<br/>    image: testapp<br/>    container_name: "local_testapp"<br/>    build:<br/>      context: .<br/>      dockerfile: TestApp/Dockerfile<br/>    env_file: <br/>      - .env<br/>    labels:<br/>      - traefik.enable=true<br/>      - traefik.docker.network=proxy<br/>      - traefik.http.routers.testapp-router.entrypoints=websecure<br/>      - traefik.http.routers.testapp-router.rule=Host(`testapp.local`) <br/>      - traefik.http.routers.testapp-router.tls=true<br/>      - traefik.http.routers.testapp-router.service=testapp-service<br/>      - traefik.http.services.testapp-router.loadbalancer.server.port=8000 <br/>networks:<br/>  proxy:<br/>    external: true</span></pre><p id="6885" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">为了使用 Django 进行配置，您的<code class="fe mj mk ml mm b">django</code>项目或容器应该有一个<code class="fe mj mk ml mm b">.env</code>文件与之连接。添加以下变量。你应该这样做，特别是当你和一个团队一起工作，并且你想把你的本地环境细节留给你自己的时候。</p><pre class="mq mr ms mt gt mu mm mv mw aw mx bi"><span id="3326" class="my kv in mm b gy mz na l nb nc"><em class="md"># HTTPS</em><br/><em class="md"># ------------------------------------------------------------------</em><br/>VIRTUAL_HOST=<!-- -->testapp.local<br/>VIRTUAL_PORT=8000</span></pre><p id="a9ba" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在您的设置配置中允许新的主机名</p><pre class="mq mr ms mt gt mu mm mv mw aw mx bi"><span id="bac9" class="my kv in mm b gy mz na l nb nc">ALLOWED_HOSTS = ["testapp.local"]</span></pre><p id="a433" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">重新构建您的<code class="fe mj mk ml mm b">docker</code>应用程序。</p><pre class="mq mr ms mt gt mu mm mv mw aw mx bi"><span id="c8a3" class="my kv in mm b gy mz na l nb nc">docker-compose up -d --build</span></pre><p id="bda1" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">进入你的浏览器，在你的地址栏输入<code class="fe mj mk ml mm b"><a class="ae kt" href="https://testapp.local" rel="noopener ugc nofollow" target="_blank">https://testapp.local</a></code></p><p id="3fd3" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这就是你在本地用 Traefik 和 Docker 设置 Django 应用程序的简单方法。</p><p id="9218" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">PS-你可以为其他应用程序使用相同的配置，你只需要为 Django 改变配置(例如端口-8000)。</p><p id="be46" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如果你喜欢这篇文章，请给它一两个掌声，如果你有任何问题或疑问，请在下面的评论中留下。</p></div></div>    
</body>
</html>