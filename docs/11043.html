<html>
<head>
<title>Cross cluster search:- Search your data living in multiple clusters in one shot</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">跨集群搜索:-搜索您的数据生活在多个集群在一杆</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/cross-cluster-search-search-your-data-living-in-multiple-clusters-in-one-shot-de42957df456?source=collection_archive---------18-----------------------#2022-12-14">https://blog.devgenius.io/cross-cluster-search-search-your-data-living-in-multiple-clusters-in-one-shot-de42957df456?source=collection_archive---------18-----------------------#2022-12-14</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div class="gh gi jk"><img src="../Images/66ab54dce23ee6f1ff3bbcb10b4700f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1018/format:webp/1*hFyW1n2x11BJIQeJ2C8kXA.png"/></div></figure><p id="784e" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated"><strong class="jt io"> <em class="kp">本博客重点介绍在弹性云上实现跨集群搜索(CCS)。</em>T3】</strong></p><p id="5f41" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">在典型的 Elastic 生产设置中，出于多种原因，您可能希望将数据索引到多个集群中，数据可靠性、可用性和灾难恢复是保持您的重要数据分布的主要原因。</p><p id="c459" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated"><strong class="jt io"> <em class="kp">为什么要用 CCS？</em> </strong></p><p id="5fb6" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">简单的答案是让用户能够对所有索引中的整个数据集进行分析，只需一个查询，而不必运行单独的查询，然后将它们合并成一个公共结果。在这方面，将日志文件保存在托管于不同数据中心的多个集群中，然后对它们进行分析和搜索是一个常见的场景。</p><p id="3353" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">本博客后面展示的演示的先决条件如下-</p><ol class=""><li id="be74" class="kq kr in jt b ju jv jy jz kc ks kg kt kk ku ko kv kw kx ky bi translated">您应该在弹性云上试用 14 天，以立即获得弹性部署，这里是登录的<a class="ae kz" href="https://cloud.elastic.co/login" rel="noopener ugc nofollow" target="_blank">链接</a>。</li><li id="53c6" class="kq kr in jt b ju la jy lb kc lc kg ld kk le ko kv kw kx ky bi translated">请检查<a class="ae kz" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-cross-cluster-search.html#ccs-supported-configurations" rel="noopener ugc nofollow" target="_blank">版本兼容性矩阵</a>，以确保作为其他集群的远程集群的各种连接集群具有彼此兼容的版本。为了便于演示，以下演示中的所有群集都保留在 8.5.0 的相同版本上。</li></ol><p id="23be" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated"><strong class="jt io">步骤 1- <em class="kp"> </em> </strong>创建两个集群，分别命名为<strong class="jt io"> <em class="kp"> cluster_1 </em> </strong>和<strong class="jt io"> <em class="kp"> cluster_2 </em> </strong>。“cluster_1”将用于查询分别存在于“cluster_1”和“cluster_2”两个集群中的数据。两个集群的硬件配置相同。</p><figure class="lg lh li lj gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi lf"><img src="../Images/d4eb27b4bab60efbaf8e4dffe8e5b711.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ECrdZKnWJNaYqQABMszs_g.png"/></div></div></figure><figure class="lg lh li lj gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi lf"><img src="../Images/63b11c48d5e830917175a6b861abe018.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QztnDKpdMMkf2gc9kx5k9A.png"/></div></div></figure><figure class="lg lh li lj gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi lo"><img src="../Images/0676fcbba32986edaf098aedefe09619.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*f_0POdBcRuWPQU7K7LjavA.png"/></div></div></figure><p id="affb" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated"><strong class="jt io">步骤 2- </strong>在 cluster_1 和 cluster_2 上分别创建两个名为 test1 和 test2 的索引。</p><p id="6988" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated"><strong class="jt io"> <em class="kp">步骤 2.1- </em> </strong>打开 cluster_1 进入开发工具，按顺序执行以下命令。</p><pre class="lg lh li lj gt lp lq lr bn ls lt bi"><span id="8bfd" class="lu lv in lq b be lw lx l ly lz"># Create an index in cluster_1 named test1<br/><br/>PUT test1 <br/>{<br/>  "settings": {<br/>    "number_of_replicas": 1<br/>  },<br/>  "mappings": {<br/>    "properties": {<br/>      "name": {<br/>        "type": "text"<br/>      },<br/>      "age": {<br/>        "type": "integer"<br/>      }<br/>    }<br/>  }<br/>}<br/><br/># Insert a dummy document in test1 index<br/>POST test1/_doc<br/>{<br/>  "name": "hari",<br/>  "age": 34<br/>}<br/><br/># Search for all documnents present inside test1 index<br/><br/>GET test1/_search</span></pre><p id="4820" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated"><strong class="jt io">步骤 2.2- </strong>打开 cluster_2，转到开发工具，按顺序执行以下命令-</p><pre class="lg lh li lj gt lp lq lr bn ls lt bi"><span id="3340" class="lu lv in lq b be lw lx l ly lz"># Create an index in cluster_2 named test2<br/><br/>PUT test2 <br/>{<br/>  "settings": {<br/>    "number_of_replicas": 1<br/>  },<br/>  "mappings": {<br/>    "properties": {<br/>      "name": {<br/>        "type": "text"<br/>      },<br/>      "age": {<br/>        "type": "integer"<br/>      }<br/>    }<br/>  }<br/>}<br/><br/># Insert a dummy document in test2 index<br/>POST test2/_doc<br/>{<br/>  "name": "sam",<br/>  "age": 10<br/>}<br/><br/># Serach for all documnents present inside test2 index<br/><br/>GET test2/_search<br/><br/></span></pre><figure class="lg lh li lj gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi ma"><img src="../Images/9b4d5f78f73a4ea4893604076926349b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*-sEsoDuvN_z-9WyJN0CVqA.gif"/></div></div><figcaption class="mb mc gj gh gi md me bd b be z dk translated">在 cluster_1 中创建了名为 test1 的索引</figcaption></figure><p id="1014" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated"><strong class="jt io">步骤 3- </strong>连接<strong class="jt io"> <em class="kp"> cluster_2 作为 cluster_1 内部的远程集群。</em> </strong></p><p id="0845" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated"><strong class="jt io"> <em class="kp">步骤 3.1- </em> </strong> <strong class="jt io"> <em class="kp">转到 cluster_2 </em> </strong>然后复制 Elasticsearch 端点它将在以后使用。您可以通过转到屏幕左上方的编辑部署来访问此信息。</p><figure class="lg lh li lj gt jo gh gi paragraph-image"><div class="gh gi mf"><img src="../Images/38e91840d4962cc951c4090614ef372d.png" data-original-src="https://miro.medium.com/v2/resize:fit:728/format:webp/1*jHsf8YxYHiKlXzOe22Bxqg.png"/></div></figure><figure class="lg lh li lj gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi mg"><img src="../Images/d2ba07381cd2aa781e717a790182887d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pxK15zMmxTWj9XCJZF1eQQ.png"/></div></div></figure><p id="72af" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated"><strong class="jt io"> <em class="kp">步骤 3.2——转到 cluster_1 </em> </strong>然后转到堆栈管理——&gt;远程集群，将 cluster_2 注册为其中的远程集群，名称为<strong class="jt io">“cluster _ two _ remote”。</strong></p><figure class="lg lh li lj gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi mh"><img src="../Images/0c031c42f0ba18f9ffda139a91620fb9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xabfGBGPYUZ4qsLCS84Vqg.png"/></div></div></figure><figure class="lg lh li lj gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi mi"><img src="../Images/a5a75f89c2f211292a74655d839115e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oJLew7grRx9Eku_tJy2ipg.png"/></div></div></figure><figure class="lg lh li lj gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi mj"><img src="../Images/c232a6350628bfd618d2630189c0fdaf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ttlLtLMxbzWOWdp7r6i4EQ.png"/></div></div></figure><p id="3edf" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated"><strong class="jt io"> <em class="kp">上述过程也可以通过 cluster_1 </em> </strong>内部的开发工具中的 API 调用来完成，请将以下命令粘贴到名为“cluster_1”的集群的开发工具内部。</p><pre class="lg lh li lj gt lp lq lr bn ls lt bi"><span id="fab1" class="lu lv in lq b be lw lx l ly lz">PUT _cluster/settings<br/>{<br/>  "persistent": {<br/>    "cluster": {<br/>      "remote": {<br/>        "cluster_two_remote": {<br/>          "skip_unavailable": false,<br/>          "mode": "proxy",<br/>          "proxy_address": "cluster-2.es.us-central1.gcp.cloud.es.io:9400",<br/>          "proxy_socket_connections": 18,<br/>          "server_name": "cluster-2.es.us-central1.gcp.cloud.es.io",<br/>          "seeds": null,<br/>          "node_connections": null<br/>        }<br/>      }<br/>    }<br/>  }<br/>}</span></pre><p id="5630" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated"><strong class="jt io">步骤 4- </strong>使用跨集群搜索，从名为“cluster_1”的集群的<strong class="jt io"> <em class="kp">开发工具中，搜索名为“cluster_2”的集群内名为“test2”的索引中存在的名称“sam”。</em>T15】</strong></p><p id="a613" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">下面给出了这样做的命令，<strong class="jt io"> <em class="kp">将命令复制粘贴到名为“cluster_1”的集群的开发工具中。</em>T19】</strong></p><pre class="lg lh li lj gt lp lq lr bn ls lt bi"><span id="f2db" class="lu lv in lq b be lw lx l ly lz"># Perform cross cluster search in cluster_1 to get documnets present in cluster_2<br/>GET test1,cluster_two_remote:test2/_search<br/>{<br/>  "query": {<br/>    "match": {<br/>      "name": "sam"<br/>    }<br/>  }<br/>}</span></pre><p id="d3b3" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">下面给出了上述代码的响应，从 hits 部分可以明显看出，结果返回了名为“sam”的文档。</p><pre class="lg lh li lj gt lp lq lr bn ls lt bi"><span id="0245" class="lu lv in lq b be lw lx l ly lz">{<br/>  "took": 17,<br/>  "timed_out": false,<br/>  "num_reduce_phases": 3,<br/>  "_shards": {<br/>    "total": 2,<br/>    "successful": 2,<br/>    "skipped": 0,<br/>    "failed": 0<br/>  },<br/>  "_clusters": {<br/>    "total": 2,<br/>    "successful": 2,<br/>    "skipped": 0<br/>  },<br/>  "hits": {<br/>    "total": {<br/>      "value": 1,<br/>      "relation": "eq"<br/>    },<br/>    "max_score": 0.2876821,<br/>    "hits": [<br/>      {<br/>        "_index": "cluster_two_remote:test2",<br/>        "_id": "rXNhD4UBRmdocJva5PCO",<br/>        "_score": 0.2876821,<br/>        "_source": {<br/>          "name": "sam",<br/>          "age": 10<br/>        }<br/>      }<br/>    ]<br/>  }<br/>}</span></pre><p id="1219" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">您刚刚看到了 CCS 如何为一个连接的远程集群工作，但是相同的演示可以扩展到需要从多个连接的远程集群中搜索数据的用例。</p><p id="79a5" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">根据 Elastic 最佳实践，为了确保您的集群始终支持 CCS，请使用一个专用集群，您打算在其中执行跨集群搜索，并将该特定集群保持在与您的 Elastic 设置中存在的所有其他集群相关的最新版本。</p><p id="bfd1" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">还建议在您的设置中保持集群版本的差异，使其只有一个次要版本。</p><p id="af0e" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">跨簇搜索官方弹性文档<a class="ae kz" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-cross-cluster-search.html#modules-cross-cluster-search" rel="noopener ugc nofollow" target="_blank">这里</a>，供你深入挖掘。</p><p id="7a97" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">如果你喜欢我的博客，请喜欢，分享和评论我的博客，并提供宝贵的反馈，不要忘记关注我，在弹性技术栈上获得更多这样令人兴奋的内容。</p><p id="5b08" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">谢谢大家！</p></div></div>    
</body>
</html>