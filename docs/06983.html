<html>
<head>
<title>Passing a Nested Array of Objects to a Controller to Update Associated Records in Rails</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将嵌套的对象数组传递给控制器，以更新 Rails 中的相关记录</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/passing-a-nested-array-of-objects-to-a-controller-to-update-associated-records-in-rails-38913ae01f6c?source=collection_archive---------2-----------------------#2022-02-16">https://blog.devgenius.io/passing-a-nested-array-of-objects-to-a-controller-to-update-associated-records-in-rails-38913ae01f6c?source=collection_archive---------2-----------------------#2022-02-16</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/9407d8b42232665b6163120b72e60156.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n6HAd7VSFPFGtptRnhndGw.png"/></div></div></figure><h1 id="e23e" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">介绍</h1><p id="a946" class="pw-post-body-paragraph kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">在熨斗学校的最后一个项目中，我为一所音乐学校写了一份申请。像任何学校一样，有班级，每个班级有一个老师和许多学生。我希望教师和管理员能够创建一个班级，并为其分配学生。我还希望他们能够编辑已经创建的类，包括添加和删除学生。</p><p id="3eda" class="pw-post-body-paragraph kt ku in kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">我将描述如何使用<code class="fe lx ly lz ma b">accepts_nested_attributes_for</code>从我的<code class="fe lx ly lz ma b">classForm</code>组件中接受一个嵌套的学生数组，并更新该班级的相关记录。</p><p id="0288" class="pw-post-body-paragraph kt ku in kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">这里有一个进入<code class="fe lx ly lz ma b">courses_controller.rb</code>的 JSON 数据的例子:</p><pre class="mb mc md me gt mf ma mg mh aw mi bi"><span id="9851" class="mj jw in ma b gy mk ml l mm mn">{<br/>  "course": {<br/>    "name": 0,<br/>    "meeting_day": 0,<br/>    "status": 0,<br/>    "setting": 0,<br/>    "start_date": "2022-02-11",<br/>    "start_time": "2022-02-15T19:00:00.000Z",<br/>    "level": 0,<br/>    "student_courses_attributes": [<br/>      {<br/>        //this adds a student to the class<br/>        <strong class="ma io">"student_id": 1</strong><br/>      },<br/>      {<br/>        //this removes a student from the class<br/>        //id is the id of the record in student_courses join table,  <br/>        //not the id of the student<br/>        <strong class="ma io">"id": 2,<br/>        "_destroy: "1"</strong><br/>      }<br/>    ]<br/>  }<br/>}</span></pre><h2 id="bde9" class="mj jw in bd jx mo mp dn kb mq mr dp kf le ms mt kj li mu mv kn lm mw mx kr my bi translated">表关系</h2><p id="5ab1" class="pw-post-body-paragraph kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">我的关系是:</p><figure class="mb mc md me gt jo gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/119e6bbf500f95c24177b19a4a852a0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1314/format:webp/1*HAZrIZXX0DhtxxJBwP4Aag.png"/></div></figure><p id="8031" class="pw-post-body-paragraph kt ku in kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">每一只<code class="fe lx ly lz ma b">course</code>都属于一只<code class="fe lx ly lz ma b">user</code>，它是<code class="fe lx ly lz ma b">course</code>的指导者。每个<code class="fe lx ly lz ma b">course</code>有很多<code class="fe lx ly lz ma b">student_courses</code>，它有很多<code class="fe lx ly lz ma b">students</code>到<code class="fe lx ly lz ma b">student_courses</code>。每个<code class="fe lx ly lz ma b">student</code>属于一个<code class="fe lx ly lz ma b">client_account</code>，每个<code class="fe lx ly lz ma b">role</code>等于客户端的<code class="fe lx ly lz ma b">user</code>都有一个<code class="fe lx ly lz ma b">client_account</code>。</p><h2 id="64a6" class="mj jw in bd jx mo mp dn kb mq mr dp kf le ms mt kj li mu mv kn lm mw mx kr my bi translated">接受 _ 嵌套 _ 属性 _for</h2><p id="1216" class="pw-post-body-paragraph kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">类方法<code class="fe lx ly lz ma b"><a class="ae lr" href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/NestedAttributes/ClassMethods.html" rel="noopener ugc nofollow" target="_blank">accepts_nested_attributes_for</a></code>允许您通过父类保存相关记录的属性，这在 Rails 中是默认关闭的。它允许您将嵌套属性传递到控制器操作中，这些操作可以创建、更新和删除相关记录。在我的项目中，它允许我在我的 POST 和 PATCH 请求中包含一系列学生，以便为课程添加、更新和删除学生。</p><p id="e485" class="pw-post-body-paragraph kt ku in kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated"><a class="ae lr" href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/NestedAttributes/ClassMethods.html" rel="noopener ugc nofollow" target="_blank">文档</a>很好地解释了如何在一对一和一对多关系中使用它，但是我需要在连接表中使用它。以下是我如何做到这一点。我强烈建议在开始之前阅读文档，它很短，会帮助你理解本教程。</p><h1 id="272e" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">配置模型</h1><p id="09c7" class="pw-post-body-paragraph kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">首先，我将模型配置为接受嵌套属性。我只包含了与本教程相关的每个模型中的信息，并省略了定义枚举和验证之类的内容。</p><h2 id="5520" class="mj jw in bd jx mo mp dn kb mq mr dp kf le ms mt kj li mu mv kn lm mw mx kr my bi translated">课程模型</h2><pre class="mb mc md me gt mf ma mg mh aw mi bi"><span id="7657" class="mj jw in ma b gy mk ml l mm mn">class Course &lt; ApplicationRecord</span><span id="c9f0" class="mj jw in ma b gy na ml l mm mn">  belongs_to :user<br/>  has_many :student_courses<br/>  has_many :students, through: :student_courses<br/>  <strong class="ma io">accepts_nested_attributes_for :student_courses, allow_destroy: true, reject_if: :reject_student_courses</strong></span><span id="8511" class="mj jw in ma b gy na ml l mm mn">  <strong class="ma io">def reject_student_courses(attributes)<br/>    attributes['student_id'].blank?<br/>  end</strong></span><span id="2d9d" class="mj jw in ma b gy na ml l mm mn">end</span></pre><p id="79b5" class="pw-post-body-paragraph kt ku in kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">在这个模型中:</p><ul class=""><li id="75d9" class="nb nc in kv b kw ls la lt le nd li ne lm nf lq ng nh ni nj bi translated"><code class="fe lx ly lz ma b">accepts_nested_attributes_for :student_courses</code>允许我嵌套<code class="fe lx ly lz ma b">student_courses</code>的属性</li><li id="ab04" class="nb nc in kv b kw nk la nl le nm li nn lm no lq ng nh ni nj bi translated"><code class="fe lx ly lz ma b">allow_destroy: true</code>允许我摧毁<code class="fe lx ly lz ma b">student_courses</code>的实例</li><li id="e12f" class="nb nc in kv b kw nk la nl le nm li nn lm no lq ng nh ni nj bi translated"><code class="fe lx ly lz ma b">reject_if: :reject_student_courses</code>允许我设置拒绝数据的标准，在这种情况下，如果它没有<code class="fe lx ly lz ma b">student_id</code>，我将拒绝它</li></ul><h2 id="e104" class="mj jw in bd jx mo mp dn kb mq mr dp kf le ms mt kj li mu mv kn lm mw mx kr my bi translated">学生课程模式</h2><pre class="mb mc md me gt mf ma mg mh aw mi bi"><span id="57b6" class="mj jw in ma b gy mk ml l mm mn">class StudentCourse &lt; ApplicationRecord<br/>  <br/>  belongs_to :student<br/>  belongs_to :course<br/>  accepts_nested_attributes_for :student</span><span id="0179" class="mj jw in ma b gy na ml l mm mn">end</span></pre><p id="84f7" class="pw-post-body-paragraph kt ku in kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">在这个模型中:</p><ul class=""><li id="4cbb" class="nb nc in kv b kw ls la lt le nd li ne lm nf lq ng nh ni nj bi translated"><code class="fe lx ly lz ma b">accepts_nested_attributes_for :student</code>允许我嵌套<code class="fe lx ly lz ma b">:student</code>的属性，我这样做是为了确保在创建时将关联提供给学生。</li></ul><h2 id="652e" class="mj jw in bd jx mo mp dn kb mq mr dp kf le ms mt kj li mu mv kn lm mw mx kr my bi translated">学生模型</h2><pre class="mb mc md me gt mf ma mg mh aw mi bi"><span id="9f64" class="mj jw in ma b gy mk ml l mm mn">class Student &lt; ApplicationRecord<br/>  belongs_to :client_account<br/>  has_many :student_courses<br/>  has_many :courses, through: :student_courses<br/>  has_many :instructors, through: :student_courses, source: :user<br/>end</span></pre><p id="d464" class="pw-post-body-paragraph kt ku in kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">在这里，我设置了<code class="fe lx ly lz ma b">has_many</code>和<code class="fe lx ly lz ma b">has_many, through:</code>关联来创建一个<code class="fe lx ly lz ma b">student</code>和一个<code class="fe lx ly lz ma b">course</code>之间的关系。</p><h1 id="96ff" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">在<code class="fe lx ly lz ma b">courses_controller</code>中设置创建和更新操作</h1><p id="73c1" class="pw-post-body-paragraph kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">我设置我的<code class="fe lx ly lz ma b">courses_controller.rb</code>文件来接受<code class="fe lx ly lz ma b">student_courses_attributes</code>。在我的控制器中，我也根据用户的角色以不同的方式处理动作，但是在这个例子中我将简化它。</p><pre class="mb mc md me gt mf ma mg mh aw mi bi"><span id="b04e" class="mj jw in ma b gy mk ml l mm mn">class CoursesController &lt; ApplicationController</span><span id="9cfc" class="mj jw in ma b gy na ml l mm mn">  before_action :set_course, only: [:show, :update, :destroy]</span><span id="ba28" class="mj jw in ma b gy na ml l mm mn">  def create<br/>    course = <strong class="ma io">current_user</strong>.courses.new(course_params)<br/>      if course.save<br/>        render json: course, status: :created<br/>      else<br/>        render json: course.errors.full_messages, <br/>        status: :unprocessable_entity<br/>      end<br/>  end</span><span id="3ecb" class="mj jw in ma b gy na ml l mm mn">  def update<br/>    if @course.update(course_params)<br/>      render json: @course<br/>    else<br/>      render json: @course.errors.full_messages, <br/>      status: :unprocessable_entity<br/>    end<br/>  end</span><span id="ea18" class="mj jw in ma b gy na ml l mm mn">  private</span><span id="1300" class="mj jw in ma b gy na ml l mm mn">  def course_params<br/>    params.require(:course).permit(<br/>      :name,<br/>      :meeting_day,<br/>      :start_date,<br/>      :start_time,<br/>      :status,<br/>      :setting,<br/>      :id,<br/>      :level,<br/>      :user_id,<br/>      <strong class="ma io">:student_courses_attributes =&gt; [:id, :student_id, :_destroy]</strong><br/>    )<br/>  end<br/>end</span></pre><p id="3362" class="pw-post-body-paragraph kt ku in kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">在该控制器中:</p><ul class=""><li id="be84" class="nb nc in kv b kw ls la lt le nd li ne lm nf lq ng nh ni nj bi translated"><code class="fe lx ly lz ma b">current_user</code>是用户登录时设置的，是课程的讲师。</li><li id="2099" class="nb nc in kv b kw nk la nl le nm li nn lm no lq ng nh ni nj bi translated"><code class="fe lx ly lz ma b">:student_courses_attributes</code>允许<code class="fe lx ly lz ma b">student_courses_attributes</code> hash 作为<a class="ae lr" href="https://api.rubyonrails.org/classes/ActionController/StrongParameters.html" rel="noopener ugc nofollow" target="_blank">强参数</a>。我需要将其命名为<code class="fe lx ly lz ma b">:student_courses_attributes</code>，因为我需要将它与我要保存属性的关联进行匹配，也就是<code class="fe lx ly lz ma b">student_courses</code>。</li><li id="5419" class="nb nc in kv b kw nk la nl le nm li nn lm no lq ng nh ni nj bi translated"><code class="fe lx ly lz ma b">=&gt; [:id, :student_id, :_destroy]</code>设置数组中的对象允许哪些键。<code class="fe lx ly lz ma b">:student_id</code>用于创建新的关联记录，<code class="fe lx ly lz ma b">:id</code>和<code class="fe lx ly lz ma b">:_destroy</code>用于销毁关联记录。</li></ul><h1 id="6fc6" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">格式化 JSON 数据</h1><p id="a936" class="pw-post-body-paragraph kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">这里有一个发送给<code class="fe lx ly lz ma b">courses_controller</code>的 JSON 数据的例子:</p><pre class="mb mc md me gt mf ma mg mh aw mi bi"><span id="40ea" class="mj jw in ma b gy mk ml l mm mn">{<br/>  "course": {<br/>    "name": 0,<br/>    "meeting_day": 0,<br/>    "status": 0,<br/>    "setting": 0,<br/>    "start_date": "2022-02-11",<br/>    "start_time": "2022-02-15T19:00:00.000Z",<br/>    "level": 0,<br/>    "student_courses_attributes": [<br/>      {<br/>        //this adds a student to the class<br/>        <strong class="ma io">"student_id": 1</strong><br/>      },<br/>      {<br/>        //this removes a student from the class<br/>        //id is the id of the record in student_courses join table,  <br/>        //not the id of the student<br/>        <strong class="ma io">"id": 2,<br/>        "_destroy: "1"</strong><br/>      }<br/>    ]<br/>  }<br/>}</span></pre><h2 id="c6c6" class="mj jw in bd jx mo mp dn kb mq mr dp kf le ms mt kj li mu mv kn lm mw mx kr my bi translated">向课程中添加学生</h2><p id="cc1a" class="pw-post-body-paragraph kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">为了将学生添加到课程中，我将一个对象传递到数组<code class="fe lx ly lz ma b">student_courses_attributes</code>中，该对象带有键<code class="fe lx ly lz ma b">student_id:</code>和我想要添加的学生的<code class="fe lx ly lz ma b">id</code>。连接表有一个键<code class="fe lx ly lz ma b">course_id</code>，但是我不需要添加它，因为我正在通过课程创建关联，所以它已经有了那个信息。</p><p id="bcd4" class="pw-post-body-paragraph kt ku in kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">下面是一个向班级添加两名学生的示例:</p><pre class="mb mc md me gt mf ma mg mh aw mi bi"><span id="e2be" class="mj jw in ma b gy mk ml l mm mn">"student_courses_attributes": [<br/>      {<br/>        //this adds a student to the course by creating a<br/>        //new student_course with a student whose id === 1<br/>        <strong class="ma io">"student_id": 1</strong><br/>      },<br/>      {<br/>        //this adds a student to the course by creating a<br/>        //new student_course with a student whose id === 4<br/>        <strong class="ma io">"student_id": 4</strong><br/>      },      <br/>    ]</span></pre><h2 id="fe78" class="mj jw in bd jx mo mp dn kb mq mr dp kf le ms mt kj li mu mv kn lm mw mx kr my bi translated">移除学生</h2><p id="1878" class="pw-post-body-paragraph kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">为了从课程中移除一个学生，我将一个对象传递到<code class="fe lx ly lz ma b">student_courses_attributes</code>数组中，该对象带有我想要销毁的<code class="fe lx ly lz ma b">student_course</code>的键<code class="fe lx ly lz ma b">id:</code>和<code class="fe lx ly lz ma b">id</code>。<strong class="kv io">我没有在这里传递学生的 id，</strong>因为我移除的是<code class="fe lx ly lz ma b">student_course</code>的实例，而不是<code class="fe lx ly lz ma b">student</code>的实例。我还传入了<code class="fe lx ly lz ma b">_destroy: '1'</code>，因为它是一个布尔值，1 将被解释为真。</p><p id="3d5d" class="pw-post-body-paragraph kt ku in kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">下面是一个移除两个学生的示例:</p><pre class="mb mc md me gt mf ma mg mh aw mi bi"><span id="81e3" class="mj jw in ma b gy mk ml l mm mn">"student_courses_attributes": [<br/>      {<br/>        //removes the student_course with and id === 2<br/>        <strong class="ma io">"id": 2,<br/>        "_destroy: "1"</strong><br/>      },<br/>      {<br/>        //removes the student_course with and id === 3<br/>        <strong class="ma io">"id": 3,<br/>        "_destroy: "1"</strong><br/>      },    <br/>    ]</span></pre><p id="7f3f" class="pw-post-body-paragraph kt ku in kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">使用这个配置，当我创建一个新的课程或更新一个当前的课程时，它将向课程中添加和删除包含在 JSON 数据的<code class="fe lx ly lz ma b">student_courses_attributes</code>键中的学生。希望这能帮助你简化类似情况下的逻辑！</p><p id="fa75" class="pw-post-body-paragraph kt ku in kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">很快，我将添加一段描述，说明我是如何创建允许我将多个学生添加到课程中的表单部分的，以及我是如何格式化受控制的表单数据以说明:</p><ul class=""><li id="4303" class="nb nc in kv b kw ls la lt le nd li ne lm nf lq ng nh ni nj bi translated">已经注册但没有被改变的学生。</li><li id="7f4e" class="nb nc in kv b kw nk la nl le nm li nn lm no lq ng nh ni nj bi translated">未注册的学生，已添加。</li><li id="e4f7" class="nb nc in kv b kw nk la nl le nm li nn lm no lq ng nh ni nj bi translated">被录取和除名的学生。</li><li id="8e6e" class="nb nc in kv b kw nk la nl le nm li nn lm no lq ng nh ni nj bi translated">注册的学生，然后删除并重新添加。</li></ul><p id="ded9" class="pw-post-body-paragraph kt ku in kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">我希望你喜欢，如果你喜欢，请关注我的博客并留下评论！</p></div></div>    
</body>
</html>