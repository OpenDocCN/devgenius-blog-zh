<html>
<head>
<title>A general troubleshooting idea</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">故障排除的一般思路</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/a-general-troubleshooting-idea-aa4b31c6aac1?source=collection_archive---------16-----------------------#2022-03-01">https://blog.devgenius.io/a-general-troubleshooting-idea-aa4b31c6aac1?source=collection_archive---------16-----------------------#2022-03-01</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="7220" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">从故障中快速恢复</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/3ddbf31653a716e29809d802cd1880e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jnI90rIHq45jt4jN"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@homajob?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">斯科特·格雷厄姆</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</figcaption></figure><p id="fb90" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">先来看一个真实案例:最近有客户反映交易系统经常出现处理超时。为了排查问题，运维人员开始努力。</p><p id="341c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">检查资源使用情况，检查服务是否正常，检查日志是否报错，检查交易量是否还在……时间在敲键盘、敲键盘、敲键盘中流逝，但原因尚未查明。</p><p id="aca5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在这个过程中，要花很长时间反复查询 SQL，查看交易量，写命令，检查系统资源。最后，定位了问题的原因，因为其中一个函数没有控制返回的次数，导致了内存泄漏。</p><p id="9388" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">针对此故障，如何快速解决故障，恢复服务？上面整个操作过程其实都是在浪费时间。在我看来，效率不高。有许多优化点:</p><ul class=""><li id="725f" class="kz la in jm b jn jo jr js jv lb jz lc kd ld kh le lf lg lh bi translated">优化故障诊断过程的时间，可以用鼠标而不是键盘来完成工作。</li><li id="989e" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">加强监控，提前发现故障“技术比业务更早发现问题，监控不仅是报警还辅助故障定位”。</li><li id="86b6" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">完善故障应急预案，预案应简单、清晰、准确。</li><li id="37e0" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">最终目的是实现故障的自愈能力。</li></ul><p id="53a7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">以下是我的一些经验分享。</p></div><div class="ab cl ln lo hr lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="ig ih ii ij ik"><p id="2a5c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">识别故障现象，初步判断问题的影响。</strong></p><p id="35c8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在处理故障之前，运维人员首先要了解故障现象。故障现象直接决定了故障应急预案的制定，这取决于运维人员需要对应用系统的整体功能有一定程度的熟悉。</p><p id="e604" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">确认故障现象后，可以指导运维人员初步判断故障的影响。</p><p id="1525" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">紧急恢复</strong></p><p id="f950" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">运维最基本的指标是系统可用性，应急恢复的及时性是系统可用性的关键指标。有了对上述故障现象和影响的判断，就可以制定故障应急操作。有许多故障紧急操作，例如:</p><ul class=""><li id="d6b3" class="kz la in jm b jn jo jr js jv lb jz lc kd ld kh le lf lg lh bi translated">如果服务的整体性能下降或异常，可以考虑重新启动服务。</li><li id="b09b" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">如果应用程序已经更改，您可以考虑是否需要切换回更改。</li><li id="346c" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">如果资源不足，可以考虑紧急扩容。</li><li id="b20b" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">对于应用程序性能问题，可以考虑调整应用程序参数和日志参数。</li><li id="af0b" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">数据库繁忙，可以考虑通过数据库快照分析优化 SQL。</li><li id="8df3" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">应用功能设计错误，可以考虑紧急关机功能菜单。</li></ul><p id="5737" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">另外需要补充的是，在故障出现之前，在一定条件下需要保存当前的系统场景。例如，在终止一个进程之前，可以先捕获一个核心文件或一个数据库快照文件。</p><p id="2126" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">迅速定位故障原因。</strong></p><p id="59d0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">1.是否具有偶发性和可复制性？</p><p id="92d2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">故障现象能否重现，对快速解决问题至关重要。可再现意味着总会有方法或工具来帮助我们定位问题的原因，可再现的故障通常可能是由异常的服务和变更引起的。</p><p id="ec63" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果故障是偶发性的，发生的概率非常小，那么排除故障就比较困难。这取决于系统在故障期间是否有足够的现场信息来确定是否能定位总因。</p><p id="c971" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">2.是否进行了相关的变更</p><p id="fd54" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">大多数故障都是由变化引起的。确定故障现象后，如果有相应的变化，有助于从变化的角度分析是否由变化引起，从而快速定位故障，做好切回等应急预案。</p><p id="2bef" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">3.有没有可能缩小范围？</p><p id="fd75" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">一方面，应用系统主张解耦，一个事务会流经不同的应用系统和模块；另一方面，故障可能是因为应用程序、系统软件、硬件、网络等环节出现了问题。排除故障原因时，应避免全面检查。建议在协调相关团队进行调查之前，将问题的范围缩小到某个程序。</p><p id="1224" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">对于牵头方来说，缩小范围后，需要有开放的态度来请求相关方配合定位，对于相关方来说，需要有积极配合的工作态度。</p><p id="26b4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">4.有足够的原木吗</p><p id="8e13" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">定位故障原因的最常用方法是分析应用程序日志。运维人员不仅要知道业务功能对应哪个业务流程，还要知道业务流程对应哪个应用日志，对应用日志能力异常错误有一些简单的判断。</p><p id="e31c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">以上是一般故障的常用方法。当发生重大故障或多方故障时，小范围的调查往往不利于快速解决，需要启动应急处理流程。建议考虑以下沟通方式:</p><ul class=""><li id="2e4e" class="kz la in jm b jn jo jr js jv lb jz lc kd ld kh le lf lg lh bi translated">召集相关人员</li><li id="870b" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">描述故障的状态</li><li id="13dc" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">解释正常的应用程序逻辑流程</li><li id="2d6a" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">语句更改</li><li id="cea7" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">检查进度并显示信息</li><li id="4c00" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">领导决策</li></ul><p id="d48b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">完美监控</strong></p><p id="571e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">1.改善监控可视化</p><p id="0d8e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">完善的监控策略需要统一的可视化操作界面。在制定了合理的监控策略后，故障处理程序需要能够快速查看相应的运行数据。</p><p id="9ed7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">比如可以看到一段时间的趋势，故障期间的数据表现，性能分析等数据，这些数据可以提前制定策略，直接将分析结果推送给故障处理人员，大大提高了故障的处理效率。</p><p id="5c13" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在上面的例子中，需要提前准备的数据:</p><ul class=""><li id="ff61" class="kz la in jm b jn jo jr js jv lb jz lc kd ld kh le lf lg lh bi translated">交易性能数据</li><li id="a743" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">重要交易指标数据</li><li id="5b92" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">交易异常数据</li><li id="5a90" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">按服务器分析交易数据</li></ul><p id="a0d0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">有了以上通过监控的一定频率的事务数据和统计，当出现故障时，运维人员可以点击鼠标查看故障是什么时候开始的，是系统内部的问题还是关联系统的问题，最突出的事务是哪一个，各个服务器的事务量是否均衡等。</p><p id="fd14" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">2.从监控的角度改进</p><p id="183f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">监控最基础的工作是实现对负载均衡设备、网络设备、服务器、存储设备、安全设备、数据库、中间件、应用软件等 IT 资源的全面监控和管理。</p><p id="4568" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在应用软件的监控中，不仅需要监控服务进程和端口，还需要监控业务层和事务层。</p><p id="9f75" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">全面的应用程序监控支持早期故障预警，并保存影响应用程序操作环境的数据，以减少故障处理时间。</p><p id="cdaa" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">3.通过监控警报进行改进</p><p id="0e6e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">完善的监控策略需要有明确的监控报警提示，值班人员可以根据监控报警制定简单的问题定位和应急处理方案，如添加邮件通知、短信通知等。</p><p id="960c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">4.改善监测和分析</p><p id="93c9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">完美的监控策略不仅需要实时数据警报，还需要针对聚合数据的分析警报。不用说，实时数据分析警报的重要性可用于从汇总和分析的数据中发现潜在风险。疾病帮助。</p><p id="485c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">5.从监控计划中改进</p><p id="6689" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">监控不仅仅是报警，它还可以做更多的事情，只要我们找到一种方法给它规则来主动解决事件，它就有能力为管理员处理故障。</p><p id="c13a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">应急计划</strong></p><p id="c141" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">提前制定故障应急预案是很有必要的，但是在日常工作过程中我们的应急预案遇到了一些问题:</p><ul class=""><li id="36a1" class="kz la in jm b jn jo jr js jv lb jz lc kd ld kh le lf lg lh bi translated">应急预案缺乏持续维护，缺乏演练，信息不及时准确。</li><li id="125a" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">应急预案过于庞大和全面，不利于阅读和使用。</li><li id="17d8" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">应急预案的形式大于实际使用效果，预案针对性不强。</li><li id="a3ed" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">只关注应急预案的内容，不关注运维人员对预案的理解。</li></ul><p id="9f3d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">很多人可能认为故障可以有多种形式，所以应急预案需要涵盖方方面面。</p><p id="a873" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">但是在实际的故障排除过程中，我们可以发现我们的应急措施往往会重复使用几个常见的步骤，所以我认为应急预案应该是重点。如果一个应急预案可以处理 80%的通常故障，那么这个应急手册应该是合格的。</p><p id="53c6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">过分追求影响应用系统各个方面的内容，会导致解决方案可读性差，最终改变一个应该检查的文档。</p><p id="12f3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">下面是我认为一个应用系统应急计划应该具备的内容:</p><ul class=""><li id="b023" class="kz la in jm b jn jo jr js jv lb jz lc kd ld kh le lf lg lh bi translated">了解当前应用系统在整个事务中的作用。当前系统出现问题或者上下游出现问题时，可以知道如何配合上下游分析问题，比如:上下游系统如何沟通，是否有唯一的沟通关键词，扩容，系统，网络参数等。</li><li id="2fd0" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">知道这个服务影响什么业务，服务涉及的日志、程序、配置文件在哪里，如何检查服务是否正常，如何重启服务，如何调整应用级参数等。</li><li id="19bc" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">能知道如何发现某个分支机构或某类交易出现问题，无论是大规模的、局部的还是偶发性的问题，能用数据说明对交易的影响，能定位交易错误信息。这里最常见的方法是使用数据库查询或工具。</li><li id="9aec" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">有时，需要使用一些工具或自动化工具来辅助分析和应急响应。这时候就需要如何使用辅助工具了。</li><li id="82ec" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">沟通计划涉及通讯录，包括上下游系统、第三方单位、业务部门、其他渠道。</li><li id="4bae" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">不管以上 5 点有多完整，相信这份应急手册可以解决 80%的故障恢复工作。</li></ul><p id="81a9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">有了应急预案，很难让运维人员持续更新。我觉得要解决这个困难，需要让运维人员经常使用这个手册。</p><p id="0264" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果手册没有场景可以使用，管理者需要为操作和维护人员创造使用手册的机会，比如应急演练。</p><p id="b237" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">一些运维人员认为应用运维人员不具备透彻理解应用系统本身内容的能力，因此应用运维人员在故障排除过程中的地位非常尴尬。怎么办。</p><p id="93a2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">对此，我同意应用运维人员不需要掌握应用系统的业务功能，但我认为应用运维人员对于应用系统本身需要具备以下基本能力:</p><ul class=""><li id="cd12" class="kz la in jm b jn jo jr js jv lb jz lc kd ld kh le lf lg lh bi translated">知道应用系统是做什么的，基础业务是什么。</li><li id="b173" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">了解应用架构部署和上下游系统之间的逻辑关系。</li><li id="1d81" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">了解应用下服务的作用，端口，服务级别的应急处理，以及如何查找定位日志等数据信息。</li><li id="ccd5" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">知道应用系统的重要时间点和任务，如开启、关闭、换日、定时任务，以及如何判断这些任务是否正确。</li><li id="e981" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">了解最重要的交易流程。</li><li id="5c41" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">了解常用的数据库表结构并能够使用它。</li></ul></div><div class="ab cl ln lo hr lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="ig ih ii ij ik"><p id="9ba7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">感谢您阅读本文，如果您认为文章写得很好，请关注我。</p><p id="374b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果发现本文有错误，欢迎留言讨论。</p><p id="eedd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">祝你愉快。</p></div></div>    
</body>
</html>