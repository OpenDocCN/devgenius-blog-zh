<html>
<head>
<title>Server-Side Development with Fastify — Middleware and Hooks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Fastify 进行服务器端开发——中间件和钩子</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/server-side-development-with-fastify-middleware-and-hooks-ca36fbcececa?source=collection_archive---------2-----------------------#2021-02-24">https://blog.devgenius.io/server-side-development-with-fastify-middleware-and-hooks-ca36fbcececa?source=collection_archive---------2-----------------------#2021-02-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/1234b1ecd8e20c546d723d095499ac45.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*lADRcPH5-gckp7l9"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">照片由<a class="ae kc" href="https://unsplash.com/@emileseguin?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">米勒·塞甘·🇨🇦</a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="49ae" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Fastify 是一个用于开发后端 web 应用程序的小型节点框架。</p><p id="af85" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将了解如何使用 Fastify 创建后端应用程序。</p><h1 id="bfe8" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">中间件</h1><p id="9d2b" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">从版本 3 开始，Fastify 框架就不再支持中间件了。</p><p id="c094" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果我们想增加对 Express 风格中间件的支持，我们需要安装<code class="fe me mf mg mh b">fastify-express</code>或<code class="fe me mf mg mh b">middle</code>插件。</p><p id="55a0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="03de" class="mq lc iq mh b gy mr ms l mt mu">const fastify = require('fastify')()</span><span id="163a" class="mq lc iq mh b gy mv ms l mt mu">const start = async () =&gt; {<br/>  try {<br/>    await fastify.register(require('fastify-express'))<br/>    fastify.use(require('cors')())</span><span id="838a" class="mq lc iq mh b gy mv ms l mt mu">    fastify.get('/', function (request, reply) {<br/>      reply.send({ hello: 'world' })<br/>    })</span><span id="7642" class="mq lc iq mh b gy mv ms l mt mu">    await fastify.listen(3000, '0.0.0.0')  <br/>  } catch (err) {<br/>    fastify.log.error(err)    <br/>    process.exit(1)<br/>  }<br/>}<br/>start()</span></pre><p id="5075" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们补充:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="c122" class="mq lc iq mh b gy mr ms l mt mu">await fastify.register(require('fastify-express'))<br/>fastify.use(require('cors')())</span></pre><p id="80c0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">用<code class="fe me mf mg mh b">cors</code>中间件添加<code class="fe me mf mg mh b">fastify-express</code>插件。</p><p id="be72" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了使用<code class="fe me mf mg mh b">middle</code>模块，我们编写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="03f4" class="mq lc iq mh b gy mr ms l mt mu">const fastify = require('fastify')()</span><span id="c0ac" class="mq lc iq mh b gy mv ms l mt mu">const start = async () =&gt; {<br/>  try {<br/>    await fastify.register(require('middie'))<br/>    fastify.use(require('cors')())</span><span id="fff5" class="mq lc iq mh b gy mv ms l mt mu">    fastify.get('/', function (request, reply) {<br/>      reply.send({ hello: 'world' })<br/>    })</span><span id="b3ba" class="mq lc iq mh b gy mv ms l mt mu">    await fastify.listen(3000, '0.0.0.0')  <br/>  } catch (err) {<br/>    fastify.log.error(err)    <br/>    process.exit(1)<br/>  }<br/>}<br/>start()</span></pre><p id="b10d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">添加中间件，添加<code class="fe me mf mg mh b">cors</code>中间件。</p><h1 id="e4c8" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">将中间件的执行限制在特定的路径上</h1><p id="0fcf" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以将中间件的执行限制在特定的路径上。</p><p id="5401" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="dde3" class="mq lc iq mh b gy mr ms l mt mu">const fastify = require('fastify')({})<br/>const path = require('path')</span><span id="7b22" class="mq lc iq mh b gy mv ms l mt mu">const start = async () =&gt; {<br/>  try {<br/>    await fastify.register(require('fastify-express'))<br/>    const serveStatic = require('serve-static')</span><span id="3223" class="mq lc iq mh b gy mv ms l mt mu">    fastify.use('/css', serveStatic(path.join(__dirname, '/assets')))<br/>    fastify.use('/css/(.*)', serveStatic(path.join(__dirname, '/assets')))<br/>    fastify.use(['/css', '/js'], serveStatic(path.join(__dirname, '/assets')))</span><span id="30e3" class="mq lc iq mh b gy mv ms l mt mu">    fastify.get('/', function (request, reply) {<br/>      reply.send({ hello: 'world' })<br/>    })</span><span id="fe26" class="mq lc iq mh b gy mv ms l mt mu">    await fastify.listen(3000, '0.0.0.0')  <br/>  } catch (err) {<br/>    fastify.log.error(err)    <br/>    process.exit(1)<br/>  }<br/>}<br/>start()</span></pre><p id="a4c6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们用中间件运行的路径作为第一个参数来调用<code class="fe me mf mg mh b">fastify.use</code>。</p><p id="5a34" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">第二个参数是我们想要运行的中间件。</p><p id="52d0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这不适用于带参数的路径。</p><p id="5aee" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Fastify 为最常用的中间件提供了一些替代方案，比如用<code class="fe me mf mg mh b"><a class="ae kc" href="https://github.com/fastify/fastify-helmet" rel="noopener ugc nofollow" target="_blank">fastify-helmet</a></code>代替<code class="fe me mf mg mh b"><a class="ae kc" href="https://github.com/helmetjs/helmet" rel="noopener ugc nofollow" target="_blank">helmet</a></code>，用<code class="fe me mf mg mh b"><a class="ae kc" href="https://github.com/fastify/fastify-cors" rel="noopener ugc nofollow" target="_blank">fastify-cors</a></code>代替<code class="fe me mf mg mh b"><a class="ae kc" href="https://github.com/expressjs/cors" rel="noopener ugc nofollow" target="_blank">cors</a></code>，用<code class="fe me mf mg mh b"><a class="ae kc" href="https://github.com/fastify/fastify-static" rel="noopener ugc nofollow" target="_blank">fastify-static</a></code>代替<code class="fe me mf mg mh b"><a class="ae kc" href="https://github.com/expressjs/serve-static" rel="noopener ugc nofollow" target="_blank">serve-static</a></code>。</p><h1 id="4830" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">钩住</h1><p id="4bca" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以用<code class="fe me mf mg mh b">fastify.addHook</code>方法注册钩子。</p><p id="1fa3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="7a87" class="mq lc iq mh b gy mr ms l mt mu">const fastify = require('fastify')({})<br/>const asyncMethod = () =&gt; Promise.resolve('foo')</span><span id="100d" class="mq lc iq mh b gy mv ms l mt mu">const start = async () =&gt; {<br/>  try {<br/>    fastify.addHook('onRequest', async (request, reply) =&gt; {<br/>      await asyncMethod()<br/>      return<br/>    })</span><span id="6fec" class="mq lc iq mh b gy mv ms l mt mu">    fastify.get('/', function (request, reply) {<br/>      reply.send({ hello: 'world' })<br/>    })</span><span id="47d4" class="mq lc iq mh b gy mv ms l mt mu">    await fastify.listen(3000, '0.0.0.0')  <br/>  } catch (err) {<br/>    fastify.log.error(err)    <br/>    process.exit(1)<br/>  }<br/>}<br/>start()</span></pre><p id="fe11" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为<code class="fe me mf mg mh b">onRequest</code>事件调用<code class="fe me mf mg mh b">addHook</code>。</p><p id="96d2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="e2a3" class="mq lc iq mh b gy mr ms l mt mu">const fastify = require('fastify')({})<br/>fastify.addHook('onRequest', (request, reply, done) =&gt; {<br/>  done()<br/>})<br/>const start = async () =&gt; {<br/>  try {<br/>    fastify.get('/', function (request, reply) {<br/>      reply.send({ hello: 'world' })<br/>    })</span><span id="b208" class="mq lc iq mh b gy mv ms l mt mu">    await fastify.listen(3000, '0.0.0.0')  <br/>  } catch (err) {<br/>    fastify.log.error(err)    <br/>    process.exit(1)<br/>  }<br/>}<br/>start()</span></pre><p id="ca0e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">做同样的事情。我们调用<code class="fe me mf mg mh b">done</code>来指示钩子已经完成运行。</p><h1 id="c323" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="1910" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以用 Fastify 添加 Express 中间件和钩子。</p></div></div>    
</body>
</html>