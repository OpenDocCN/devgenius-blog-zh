<html>
<head>
<title>The Astonishing World of SQL Triggers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">SQL 触发器的惊人世界</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/the-astonishing-world-of-triggers-6d1effe33357?source=collection_archive---------16-----------------------#2022-10-08">https://blog.devgenius.io/the-astonishing-world-of-triggers-6d1effe33357?source=collection_archive---------16-----------------------#2022-10-08</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="c7d7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在本文中，我们将深入探究触发器，了解它们是什么，我们为什么使用它们，以及如何使用它们。🫡</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/c335c7149eacd178151b70d64f823944.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4QQPQ-j6_Y72Y4VtbKtVzQ.png"/></div></div></figure><h1 id="00e1" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">🤨什么是触发器？</h1><p id="a5e6" class="pw-post-body-paragraph jk jl in jm b jn ls jp jq jr lt jt ju jv lu jx jy jz lv kb kc kd lw kf kg kh ig bi translated">触发器是唯一的存储过程，每当发生特定的数据库活动时都会自动运行。在特定的表上，触发器可以连接到插入、更新、截断和删除动作(或其任意组合)。</p><p id="434d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">触发器连接到特定的表，而存储过程只是存储的 SQL 语句。只有当向 Customers 表中添加一行时，才会激活与该表上的插入操作相关的触发器。类似于 Mobs 表，插入和更新操作的触发器只有在那些特定操作发生在该表上时才会被激活。</p><p id="3c5f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">触发器可以在执行指定操作的之前或之后<em class="lx">执行。</em></p><p id="8313" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">尽管 PostgreSQL 实现了 SQL 标准，但该数据库中的触发器包括以下独特的功能:</p><ol class=""><li id="70cc" class="ly lz in jm b jn jo jr js jv ma jz mb kd mc kh md me mf mg bi translated">[TRUNCATE]事件触发器由 PostgreSQL 触发。</li><li id="b7e8" class="ly lz in jm b jn mh jr mi jv mj jz mk kd ml kh md me mf mg bi translated">您可以在 PostgreSQL 中的视图上创建语句级触发器。</li><li id="a1b9" class="ly lz in jm b jn mh jr mi jv mj jz mk kd ml kh md me mf mg bi translated">虽然 SQL 标准允许您使用任何 SQL 命令作为触发器的动作，但 PostgreSQL 要求您编写一个用户定义的函数。</li></ol><h2 id="096d" class="mm kv in bd kw mn mo dn la mp mq dp le jv mr ms li jz mt mu lm kd mv mw lq mx bi translated"><strong class="ak">📝注意</strong> : <strong class="ak">约束比触发</strong>快</h2><p id="afb0" class="pw-post-body-paragraph jk jl in jm b jn ls jp jq jr lt jt ju jv lu jx jy jz lv kb kc kd lw kf kg kh ig bi translated">尽可能使用约束代替触发器，因为它们通常处理起来更快。</p></div><div class="ab cl my mz hr na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="ig ih ii ij ik"><h1 id="0f98" class="ku kv in bd kw kx nf kz la lb ng ld le lf nh lh li lj ni ll lm ln nj lp lq lr bi translated">⚔️触发器类型</h1><p id="a047" class="pw-post-body-paragraph jk jl in jm b jn ls jp jq jr lt jt ju jv lu jx jy jz lv kb kc kd lw kf kg kh ig bi translated">行和语句级触发器是 PostgreSQL 提供的两种基本类型的触发器。这两种类型触发触发器的频率和时间是不同的。</p><ol class=""><li id="c1a3" class="ly lz in jm b jn jo jr js jv ma jz mb kd mc kh md me mf mg bi translated">语句级触发器:无论更新多少行，对于每条语句，它只会调用一次触发器函数。</li><li id="6bca" class="ly lz in jm b jn mh jr mi jv mj jz mk kd ml kh md me mf mg bi translated">行级触发器:触发器函数将为被触发器事件修改的每一行调用。</li></ol></div><div class="ab cl my mz hr na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="ig ih ii ij ik"><h1 id="a615" class="ku kv in bd kw kx nf kz la lb ng ld le lf nh lh li lj ni ll lm ln nj lp lq lr bi translated">👨🏻‍💻触发器的使用</h1><ol class=""><li id="fd85" class="ly lz in jm b jn ls jr lt jv nk jz nl kd nm kh md me mf mg bi translated">执行额外的验证并撤销任何必要的数据更改，例如检查是否达到了客户的信用限额，如果达到了就停止插入。</li><li id="f704" class="ly lz in jm b jn mh jr mi jv mj jz mk kd ml kh md me mf mg bi translated">确保数据一致性，例如在插入或更新事务期间，将所有状态名改为大写。</li><li id="e578" class="ly lz in jm b jn mh jr mi jv mj jz mk kd ml kh md me mf mg bi translated">通过记录事件信息来跟踪表事务..</li><li id="65d4" class="ly lz in jm b jn mh jr mi jv mj jz mk kd ml kh md me mf mg bi translated">基于对一个表的更改，对其他表采取行动；例如，每次修改或删除一行时，将审计跟踪记录写入日志表。</li><li id="5979" class="ly lz in jm b jn mh jr mi jv mj jz mk kd ml kh md me mf mg bi translated">强制检查约束。</li></ol></div><div class="ab cl my mz hr na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="ig ih ii ij ik"><h1 id="458c" class="ku kv in bd kw kx nf kz la lb ng ld le lf nh lh li lj ni ll lm ln nj lp lq lr bi translated">🥸使用触发器</h1><p id="d045" class="pw-post-body-paragraph jk jl in jm b jn ls jp jq jr lt jt ju jv lu jx jy jz lv kb kc kd lw kf kg kh ig bi translated">为了建立新的触发器，必须先定义触发器函数，然后才能将其链接到表。触发器和用户定义函数的不同之处在于，当触发事件发生时，会自动调用触发器。</p><p id="e470" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><em class="lx">你可以在这个</em> <a class="ae nn" href="https://gist.github.com/LinuxDevil/4eeebb6c686fc84263e06ad34b3dcfd2" rel="noopener ugc nofollow" target="_blank"> <em class="lx">里看到代码要点</em> </a></p><p id="0370" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">创建触发器的语法如下:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/307f4f4e80dc0ee049415d50e13683bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cPSM4gSfGiL8DH1vY_3SkQ.png"/></div></div></figure><ul class=""><li id="4eaf" class="ly lz in jm b jn jo jr js jv ma jz mb kd mc kh np me mf mg bi translated"><strong class="jm io">名称:</strong>触发器的名字。同一表中的任何其他触发器都不会共享此名称。</li><li id="2f17" class="ly lz in jm b jn mh jr mi jv mj jz mk kd ml kh np me mf mg bi translated"><strong class="jm io"> Before: </strong>表示该函数在事件之前被调用。</li><li id="9837" class="ly lz in jm b jn mh jr mi jv mj jz mk kd ml kh np me mf mg bi translated"><strong class="jm io">之后:</strong>表示我们正在利用事后功能。</li><li id="81a1" class="ly lz in jm b jn mh jr mi jv mj jz mk kd ml kh np me mf mg bi translated"><strong class="jm io">而不是:</strong>表明我们使用函数而不是事件来进行调用。</li><li id="f73c" class="ly lz in jm b jn mh jr mi jv mj jz mk kd ml kh np me mf mg bi translated"><strong class="jm io">事件:</strong>触发器将被任何事件触发，包括插入、更新、删除和截断。</li><li id="385c" class="ly lz in jm b jn mh jr mi jv mj jz mk kd ml kh np me mf mg bi translated"><strong class="jm io">表格名称:</strong>表格<em class="lx">或<em class="lx">视图</em>的名称</em></li><li id="724b" class="ly lz in jm b jn mh jr mi jv mj jz mk kd ml kh np me mf mg bi translated"><strong class="jm io">引用的表名:</strong>这是与约束相关的其他表的名称。使用此选项只能定义约束触发器。</li><li id="2829" class="ly lz in jm b jn mh jr mi jv mj jz mk kd ml kh np me mf mg bi translated"><strong class="jm io">可延迟、不可延迟、初始立即和初始延迟:</strong>这是 PostgreSQL 触发器的默认时间。</li><li id="5412" class="ly lz in jm b jn mh jr mi jv mj jz mk kd ml kh np me mf mg bi translated"><strong class="jm io">对于每一行:</strong>将声明受触发事件影响的每一行将导致触发器的单次触发。</li><li id="9513" class="ly lz in jm b jn mh jr mi jv mj jz mk kd ml kh np me mf mg bi translated"><strong class="jm io"> For each statement: </strong>有了这个，就清楚了，对于受触发事件影响的每个语句，它只会被触发一次。</li><li id="1d13" class="ly lz in jm b jn mh jr mi jv mj jz mk kd ml kh np me mf mg bi translated"><strong class="jm io">条件:</strong>决定触发功能将被执行的布尔表达式。</li><li id="1289" class="ly lz in jm b jn mh jr mi jv mj jz mk kd ml kh np me mf mg bi translated"><strong class="jm io">功能名称:</strong>用户提供的功能。</li><li id="64d6" class="ly lz in jm b jn mh jr mi jv mj jz mk kd ml kh np me mf mg bi translated"><strong class="jm io"> Arguments: </strong>这是提供给函数的可选逗号分隔参数，然后触发器执行。</li><li id="ef3e" class="ly lz in jm b jn mh jr mi jv mj jz mk kd ml kh np me mf mg bi translated">该函数在以下兼容语言中定义:<br/> 1。PL/pgsql <br/> 2。PL/Python <br/> 3。Pl/ Java</li></ul><p id="0623" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">有关更详细的描述和可用选项，请查看<a class="ae nn" href="https://www.postgresql.org/docs/12/sql-createtrigger.html." rel="noopener ugc nofollow" target="_blank"> PostgreSQL 文档</a></p></div><div class="ab cl my mz hr na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="ig ih ii ij ik"><h2 id="ccc7" class="mm kv in bd kw mn mo dn la mp mq dp le jv mr ms li jz mt mu lm kd mv mw lq mx bi translated">📱插入触发器</h2><p id="d514" class="pw-post-body-paragraph jk jl in jm b jn ls jp jq jr lt jt ju jv lu jx jy jz lv kb kc kd lw kf kg kh ig bi translated">当使用 INSERT 语句向表中添加新记录时，将调用 INSERT 事件触发器。</p><p id="c4e9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让我们看一个创建新触发器的例子。在本例中，我们将创建一个名为“Customer”的新表，如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/15e952f0fd8df009dfbf3fc2d7a033e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jUqWy0YPgm6ZUiOBFHcitQ.png"/></div></div></figure><p id="7939" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">每当新的客户记录被添加到“客户”表中时，为了向“客户部门”表中添加一个条目，我们必须首先建立一个<em class="lx">触发器</em>。</p><p id="e6c9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">插入触发函数并创建触发命令:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/c41e3b4f8d7c0139d7c859abc1975868.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0kmC8gkddm1nN8dhTXawSg.png"/></div></div></figure></div><div class="ab cl my mz hr na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="ig ih ii ij ik"><h2 id="056c" class="mm kv in bd kw mn mo dn la mp mq dp le jv mr ms li jz mt mu lm kd mv mw lq mx bi translated">🗑删除触发器</h2><p id="cda8" class="pw-post-body-paragraph jk jl in jm b jn ls jp jq jr lt jt ju jv lu jx jy jz lv kb kc kd lw kf kg kh ig bi translated">删除事件触发器，可以添加到删除记录的事务中。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/3517552775bcd91d41e2b83eefbfa724.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zsYkGAEdkQ7rXL_QeXunDQ.png"/></div></div></figure></div><div class="ab cl my mz hr na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="ig ih ii ij ik"><h2 id="25ee" class="mm kv in bd kw mn mo dn la mp mq dp le jv mr ms li jz mt mu lm kd mv mw lq mx bi translated">🤖更新触发器</h2><p id="6259" class="pw-post-body-paragraph jk jl in jm b jn ls jp jq jr lt jt ju jv lu jx jy jz lv kb kc kd lw kf kg kh ig bi translated">UPDATE 事件触发器在 UPDATE 语句执行时被调用。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/4cd308a23ad209d3580bedb8e5e1c1fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QUF-idyL1HKwMdo29YeroQ.png"/></div></div></figure></div><div class="ab cl my mz hr na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="ig ih ii ij ik"><h2 id="6fa6" class="mm kv in bd kw mn mo dn la mp mq dp le jv mr ms li jz mt mu lm kd mv mw lq mx bi translated">🫳🏼掉落触发器</h2><p id="473e" class="pw-post-body-paragraph jk jl in jm b jn ls jp jq jr lt jt ju jv lu jx jy jz lv kb kc kd lw kf kg kh ig bi translated">DROP TRIGGER 用于删除触发器。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/d0c10042504be53e93384aec3416bcb5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vuJGX_kg7PHDueBmCnX9eQ.png"/></div></div></figure></div><div class="ab cl my mz hr na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="ig ih ii ij ik"><h2 id="5ebd" class="mm kv in bd kw mn mo dn la mp mq dp le jv mr ms li jz mt mu lm kd mv mw lq mx bi translated">🛒上市触发因素</h2><p id="75d6" class="pw-post-body-paragraph jk jl in jm b jn ls jp jq jr lt jt ju jv lu jx jy jz lv kb kc kd lw kf kg kh ig bi translated">您可以从<strong class="jm io"> pg_trigger </strong>表中列出当前数据库中的所有触发器，如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nq"><img src="../Images/fdcf3cab7240f8a273db9bf675d38b34.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7WktNaP0OsEWXRBhS1uCbw.png"/></div></div></figure><p id="2ac8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">上面给出的 PostgreSQL 语句将列出所有触发器。</p></div><div class="ab cl my mz hr na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="ig ih ii ij ik"><h2 id="9436" class="mm kv in bd kw mn mo dn la mp mq dp le jv mr ms li jz mt mu lm kd mv mw lq mx bi translated">⚠️需要记住的要点</h2><ol class=""><li id="b78b" class="ly lz in jm b jn ls jr lt jv nk jz nl kd nm kh md me mf mg bi translated">为了在表上建立触发器，用户需要对表具有 trigger 特权，对 TRIGGER 函数具有 EXECUTE 特权。</li><li id="388e" class="ly lz in jm b jn mh jr mi jv mj jz mk kd ml kh md me mf mg bi translated">您可以通过检查系统目录“pg trigger”来查找数据库的当前触发信息。</li><li id="3c89" class="ly lz in jm b jn mh jr mi jv mj jz mk kd ml kh md me mf mg bi translated">如果您创建了多个触发器，则针对同一事件的同一对象上的多个触发器将按名称列出的顺序触发。</li><li id="b7d5" class="ly lz in jm b jn mh jr mi jv mj jz mk kd ml kh md me mf mg bi translated">每当数据库对象(如表)上发生数据库事件时，就会激活一个称为 PostgreSQL 触发器的自动函数。</li><li id="112d" class="ly lz in jm b jn mh jr mi jv mj jz mk kd ml kh md me mf mg bi translated">触发器只在为其创建的数据库对象的生存期内存在，如果数据库对象被删除，触发器也将被删除。</li></ol></div><div class="ab cl my mz hr na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="ig ih ii ij ik"><blockquote class="nr"><p id="2c36" class="ns nt in bd nu nv nw nx ny nz oa kh dk translated">我希望你发现这篇文章有用和有趣的❤️</p></blockquote></div></div>    
</body>
</html>