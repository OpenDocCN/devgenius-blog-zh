<html>
<head>
<title>Making HTTP Requests with React Query — Query Retries</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 React Query 发出 HTTP 请求—查询重试</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/making-http-requests-with-react-query-query-retries-a138f91fbe10?source=collection_archive---------1-----------------------#2021-06-07">https://blog.devgenius.io/making-http-requests-with-react-query-query-retries-a138f91fbe10?source=collection_archive---------1-----------------------#2021-06-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/929c2315d080ba3a38637ceb8489c55a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*LKADoY1aJrsMTZeF"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">菲利帕·罗斯-泰特在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</figcaption></figure><p id="3ef8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">React 查询库让我们可以在 React 应用程序中轻松地发出 HTTP 请求。</p><p id="cda7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将了解如何使用 React Query 发出 HTTP 请求。</p><h1 id="33b0" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">查询重试次数</h1><p id="4f3d" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">如果请求失败，<code class="fe me mf mg mh b">useQuery</code>钩子将自动重试请求。</p><p id="953f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><p id="43ed" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">index.js</code></p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="244f" class="mq lc iq mh b gy mr ms l mt mu">import { StrictMode } from "react";<br/>import ReactDOM from "react-dom";<br/>import { QueryClient, QueryClientProvider } from "react-query";<br/>import App from "./App";</span><span id="3b80" class="mq lc iq mh b gy mv ms l mt mu">const queryClient = new QueryClient();</span><span id="b6ee" class="mq lc iq mh b gy mv ms l mt mu">const rootElement = document.getElementById("root");<br/>ReactDOM.render(<br/>  &lt;QueryClientProvider client={queryClient}&gt;<br/>    &lt;StrictMode&gt;<br/>      &lt;App /&gt;<br/>    &lt;/StrictMode&gt;<br/>  &lt;/QueryClientProvider&gt;,<br/>  rootElement<br/>);</span></pre><p id="9f28" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">App.js</code></p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="2b94" class="mq lc iq mh b gy mr ms l mt mu">import axios from "axios";<br/>import React from "react";<br/>import { useQuery } from "react-query";<br/>export default function App() {<br/>  const { data } = useQuery(<br/>    ["todo", 1],<br/>    ({ queryKey: [, id] }) =&gt; {<br/>      return axios(`https://jsonplaceholder.typicode.com/posts/${id}`);<br/>    },<br/>    { retry: 3 }<br/>  );</span><span id="ab30" class="mq lc iq mh b gy mv ms l mt mu">  return (<br/>    &lt;div&gt;<br/>      &lt;div&gt;{JSON.stringify(data)}&lt;/div&gt;<br/>    &lt;/div&gt;<br/>  );<br/>}</span></pre><p id="34c4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将<code class="fe me mf mg mh b">retry</code>设置为 3，如果请求失败，就重试 3 次。</p><p id="4656" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，我们可以将<code class="fe me mf mg mh b">retry</code>设置为<code class="fe me mf mg mh b">true</code>来重试无限次。</p><p id="38f7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">并且我们可以将<code class="fe me mf mg mh b">retry</code>设置为<code class="fe me mf mg mh b">false</code>永远不重试。</p><h1 id="e893" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">重试延迟</h1><p id="c781" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们还可以用<code class="fe me mf mg mh b">retryDelay</code>属性设置重试延迟。</p><p id="d7b5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">该值应以毫秒为单位。</p><p id="4794" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><p id="22f3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">index.js</code></p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="6270" class="mq lc iq mh b gy mr ms l mt mu">import { StrictMode } from "react";<br/>import ReactDOM from "react-dom";<br/>import { QueryClient, QueryClientProvider } from "react-query";<br/>import App from "./App";</span><span id="a552" class="mq lc iq mh b gy mv ms l mt mu">const queryClient = new QueryClient({<br/>  defaultOptions: {<br/>    queries: {<br/>      retryDelay: (attemptIndex) =&gt; Math.min(1000 * 2 ** attemptIndex, 30000)<br/>    }<br/>  }<br/>});</span><span id="4195" class="mq lc iq mh b gy mv ms l mt mu">const rootElement = document.getElementById("root");<br/>ReactDOM.render(<br/>  &lt;QueryClientProvider client={queryClient}&gt;<br/>    &lt;StrictMode&gt;<br/>      &lt;App /&gt;<br/>    &lt;/StrictMode&gt;<br/>  &lt;/QueryClientProvider&gt;,<br/>  rootElement<br/>);</span></pre><p id="f55d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">App.js</code></p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="b7fb" class="mq lc iq mh b gy mr ms l mt mu">import axios from "axios";<br/>import React from "react";<br/>import { useQuery } from "react-query";<br/>export default function App() {<br/>  const { data } = useQuery(["todo", 1], ({ queryKey: [, id] }) =&gt; {<br/>    return axios(`https://jsonplaceholder.typicode.com/posts/${id}`);<br/>  });</span><span id="0148" class="mq lc iq mh b gy mv ms l mt mu">  return (<br/>    &lt;div&gt;<br/>      &lt;div&gt;{JSON.stringify(data)}&lt;/div&gt;<br/>    &lt;/div&gt;<br/>  );<br/>}</span></pre><p id="4904" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在<code class="fe me mf mg mh b">index.js</code>中，我们有一个<code class="fe me mf mg mh b">retryDelay</code>方法，它接受的<code class="fe me mf mg mh b">attemptIndex</code>是尝试次数减 1。</p><p id="56b4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果请求失败，我们返回重试前的毫秒数。</p><p id="d9f1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，我们可以用传递给<code class="fe me mf mg mh b">useQuery</code>钩子的选项中的<code class="fe me mf mg mh b">retryDelay</code>属性覆盖单个请求的重试间隔:</p><p id="d300" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">index.js</code></p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="416e" class="mq lc iq mh b gy mr ms l mt mu">import { StrictMode } from "react";<br/>import ReactDOM from "react-dom";<br/>import { QueryClient, QueryClientProvider } from "react-query";<br/>import App from "./App";</span><span id="33f5" class="mq lc iq mh b gy mv ms l mt mu">const queryClient = new QueryClient();</span><span id="be1d" class="mq lc iq mh b gy mv ms l mt mu">const rootElement = document.getElementById("root");<br/>ReactDOM.render(<br/>  &lt;QueryClientProvider client={queryClient}&gt;<br/>    &lt;StrictMode&gt;<br/>      &lt;App /&gt;<br/>    &lt;/StrictMode&gt;<br/>  &lt;/QueryClientProvider&gt;,<br/>  rootElement<br/>);</span></pre><p id="72ce" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">App.js</code></p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="7650" class="mq lc iq mh b gy mr ms l mt mu">import axios from "axios";<br/>import React from "react";<br/>import { useQuery } from "react-query";<br/>export default function App() {<br/>  const { data } = useQuery(<br/>    ["todo", 1],<br/>    ({ queryKey: [, id] }) =&gt; {<br/>      return axios(`https://jsonplaceholder.typicode.com/posts/${id}`);<br/>    },<br/>    {<br/>      retryDelay: 1000<br/>    }<br/>  );</span><span id="5de7" class="mq lc iq mh b gy mv ms l mt mu">  return (<br/>    &lt;div&gt;<br/>      &lt;div&gt;{JSON.stringify(data)}&lt;/div&gt;<br/>    &lt;/div&gt;<br/>  );<br/>}</span></pre><h1 id="4372" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="4472" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以使用 React Query 轻松设置查询重试间隔。</p></div></div>    
</body>
</html>