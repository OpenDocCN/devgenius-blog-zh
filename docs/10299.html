<html>
<head>
<title>How to configure Apache Spark (Databricks) to send logs to Azure Log Analytics</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何配置 Apache Spark (Databricks)将日志发送到 Azure Log Analytics</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/how-to-configure-apache-spark-databricks-to-send-logs-to-azure-log-analytics-865050ccc147?source=collection_archive---------1-----------------------#2022-10-22">https://blog.devgenius.io/how-to-configure-apache-spark-databricks-to-send-logs-to-azure-log-analytics-865050ccc147?source=collection_archive---------1-----------------------#2022-10-22</a></blockquote><div><div class="fc ic id ie if ig"/><div class="ih ii ij ik il"><div class=""/><figure class="gm go jm jn jo jp gi gj paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="gi gj jl"><img src="../Images/7f48c11262e4bd6c7e1f595fcf1c0522.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D2Lf8AVZ2lwi5qpAhGZJ6g.png"/></div></div><figcaption class="jw jx gk gi gj jy jz bd b be z dk translated"><a class="ae ka" href="http://www.brilliantprogrammer.com" rel="noopener ugc nofollow" target="_blank"> brilliantprogrammer </a></figcaption></figure><p id="b579" class="pw-post-body-paragraph kb kc io kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ih bi translated">在本教程中，我们将配置 spark 集群，将日志发送到 Azure log analytics 工作区。如您所知，日志对于错误调试是必不可少的。</p><p id="c5bc" class="pw-post-body-paragraph kb kc io kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ih bi translated">让我们直接进入设置:</p><p id="984b" class="pw-post-body-paragraph kb kc io kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ih bi translated">在这里，我们使用<a class="ae ka" href="https://github.com/mspnp/spark-monitoring" rel="noopener ugc nofollow" target="_blank">这个</a>监控库。该库支持 Azure Databricks 10.x (Spark 3.2.x)及更早版本。</p><h1 id="0a92" class="kz la io bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">设置库的步骤:</h1><h2 id="8d43" class="lx la io bd lb ly lz dn lf ma mb dp lj km mc md ln kq me mf lr ku mg mh lv mi bi translated">步骤 1:克隆存储库[ <a class="ae ka" href="https://github.com/mspnp/spark-monitoring.git" rel="noopener ugc nofollow" target="_blank">链接</a>。</h2><figure class="mk ml mm mn gu jp gi gj paragraph-image"><div class="gi gj mj"><img src="../Images/e6a1d4a2a24deade92036ada644c424e.png" data-original-src="https://miro.medium.com/v2/resize:fit:658/0*cojli1TkAX7GZR1j"/></div></figure><h2 id="3913" class="lx la io bd lb ly lz dn lf ma mb dp lj km mc md ln kq me mf lr ku mg mh lv mi bi translated">第二步:设置你的 Azure <a class="ae ka" href="https://docs.microsoft.com/azure/azure-databricks/quickstart-create-databricks-workspace-portal" rel="noopener ugc nofollow" target="_blank">数据块工作空间</a>。</h2><h2 id="5505" class="lx la io bd lb ly lz dn lf ma mb dp lj km mc md ln kq me mf lr ku mg mh lv mi bi translated">步骤 3:安装 Azure Databricks CLI 并设置身份验证。</h2><ul class=""><li id="2164" class="mo mp io kd b ke mq ki mr km ms kq mt ku mu ky mv mw mx my bi translated">运行 bash 命令。</li></ul><blockquote class="mz"><p id="48e2" class="na nb io bd nc nd ne nf ng nh ni ky dk translated"><em class="nj">数据块配置—令牌</em></p></blockquote><ul class=""><li id="e2f6" class="mo mp io kd b ke nk ki nl km nm kq nn ku no ky mv mw mx my bi translated">然后它会询问您的数据块主机—输入您的数据块 URL https://adb- <workspace-id>。<random-number> .azuredatabricks.net</random-number></workspace-id></li></ul><p id="8ce8" class="pw-post-body-paragraph kb kc io kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ih bi translated">之后，输入您的 Databricks 工作空间的令牌。如果你不知道如何设置令牌，那么请阅读本博客。</p><h2 id="0864" class="lx la io bd lb ly lz dn lf ma mb dp lj km mc md ln kq me mf lr ku mg mh lv mi bi translated">步骤 4:安装</h2><ul class=""><li id="027b" class="mo mp io kd b ke mq ki mr km ms kq mt ku mu ky mv mw mx my bi translated"><strong class="kd ip"> Java 开发套件(JDK)1.8 版</strong></li></ul><p id="2b10" class="pw-post-body-paragraph kb kc io kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ih bi translated"><strong class="kd ip">安装 Java: </strong></p><figure class="mk ml mm mn gu jp"><div class="bz fq l di"><div class="np nq l"/></div></figure><ul class=""><li id="ae71" class="mo mp io kd b ke kf ki kj km nr kq ns ku nt ky mv mw mx my bi translated"><strong class="kd ip"> Scala 语言 SDK 2.12 </strong></li></ul><figure class="mk ml mm mn gu jp"><div class="bz fq l di"><div class="np nq l"/></div></figure><ul class=""><li id="3e71" class="mo mp io kd b ke kf ki kj km nr kq ns ku nt ky mv mw mx my bi translated">阿帕奇 Maven 3.6.3 </li><li id="2700" class="mo mp io kd b ke nu ki nv km nw kq nx ku ny ky mv mw mx my bi translated">从<a class="ae ka" href="https://maven.apache.org/download.cgi" rel="noopener ugc nofollow" target="_blank">网站</a>下载 Maven。</li></ul><figure class="mk ml mm mn gu jp gi gj paragraph-image"><div class="gi gj nz"><img src="../Images/0e736b8407329f14343a804936ea171b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/0*CWci_pft8ToFS0QB"/></div></figure><ul class=""><li id="a182" class="mo mp io kd b ke kf ki kj km nr kq ns ku nt ky mv mw mx my bi translated">解压缩 tar.gz 文件</li></ul><blockquote class="mz"><p id="835f" class="na nb io bd nc nd ne nf ng nh ni ky dk translated"><em class="nj"> tar -xf {name}.tar.gz </em></p></blockquote><ul class=""><li id="7be1" class="mo mp io kd b ke nk ki nl km nm kq nn ku no ky mv mw mx my bi translated">现在打开您解压文件的终端，并键入以下命令。</li></ul><figure class="mk ml mm mn gu jp"><div class="bz fq l di"><div class="np nq l"/></div></figure><h2 id="43a7" class="lx la io bd lb ly lz dn lf ma mb dp lj km mc md ln kq me mf lr ku mg mh lv mi bi translated"><strong class="ak">第五步:构建 Azure 数据块监控库</strong></h2><p id="447d" class="pw-post-body-paragraph kb kc io kd b ke mq kg kh ki mr kk kl km oa ko kp kq ob ks kt ku oc kw kx ky ih bi translated"><strong class="kd ip">使用 docker </strong></p><ul class=""><li id="1f5c" class="mo mp io kd b ke kf ki kj km nr kq ns ku nt ky mv mw mx my bi translated">打开终端并键入以下命令[首先将目录更改为/spark-monitoring]</li></ul><figure class="mk ml mm mn gu jp"><div class="bz fq l di"><div class="np nq l"/></div></figure><figure class="mk ml mm mn gu jp gi gj paragraph-image"><div class="gi gj od"><img src="../Images/21088ce51ee8dd77f7ac6a3a395c21c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1396/0*k9RkZLZGOiJ87Tif"/></div></figure><figure class="mk ml mm mn gu jp gi gj paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="gi gj oe"><img src="../Images/f72c22cdfc09dec966e386a5a05885b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*tGnCfxF2BStSefkX"/></div></div></figure><h2 id="0555" class="lx la io bd lb ly lz dn lf ma mb dp lj km mc md ln kq me mf lr ku mg mh lv mi bi translated">步骤 6:配置数据块工作区</h2><ul class=""><li id="b6d4" class="mo mp io kd b ke mq ki mr km ms kq mt ku mu ky mv mw mx my bi translated"><strong class="kd ip">创建目录</strong></li></ul><blockquote class="mz"><p id="2103" class="na nb io bd nc nd ne nf ng nh ni ky dk translated">dbfs mkdirs dbfs:/databricks/spark-monitoring</p></blockquote><ul class=""><li id="eeda" class="mo mp io kd b ke nk ki nl km nm kq nn ku no ky mv mw mx my bi translated">打开/src/spark-listeners/scripts/spark-monitoring . sh 文件，添加您的日志分析工作区密钥和 id。</li></ul><figure class="mk ml mm mn gu jp gi gj paragraph-image"><div class="gi gj of"><img src="../Images/68dd9322768efa6adf5bc1491303d1c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:564/0*e_I4598UL1eoR46q"/></div></figure><figure class="mk ml mm mn gu jp gi gj paragraph-image"><div class="gi gj og"><img src="../Images/6bbbd3a7110dae4e072e1a4511433847.png" data-original-src="https://miro.medium.com/v2/resize:fit:1092/0*SZFkQq2rUvfrbRxe"/></div></figure><p id="458e" class="pw-post-body-paragraph kb kc io kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ih bi translated">出于安全原因，您也可以在这里使用 azure key vault</p><ul class=""><li id="ac17" class="mo mp io kd b ke kf ki kj km nr kq ns ku nt ky mv mw mx my bi translated">现在输入您的 AZ_SUBSCRIPTION_ID，AZ _ RSRC _ 团体 _ 名称，AZ _ RSRC _ PROV _ 名称空间，AZ _ RSRC _ 类型，AZ _ RSRC _ 名称</li></ul><figure class="mk ml mm mn gu jp"><div class="bz fq l di"><div class="np nq l"/></div></figure><p id="c930" class="pw-post-body-paragraph kb kc io kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ih bi translated"><strong class="kd ip">设置日志分析工作区</strong></p><ul class=""><li id="aea6" class="mo mp io kd b ke kf ki kj km nr kq ns ku nt ky mv mw mx my bi translated">打开日志分析工作区</li></ul><figure class="mk ml mm mn gu jp gi gj paragraph-image"><div class="gi gj oh"><img src="../Images/2a16df3b72d3c87f3920ddccee6a1ad9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/0*uY4EslgUbsUnXwhl"/></div></figure><ul class=""><li id="68a0" class="mo mp io kd b ke kf ki kj km nr kq ns ku nt ky mv mw mx my bi translated">点击创建</li></ul><figure class="mk ml mm mn gu jp gi gj paragraph-image"><div class="gi gj oi"><img src="../Images/fae5856d324cbcaba5084eb1e04c928d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1178/0*7ZLdBz-Lj8sLYE_K"/></div></figure><ul class=""><li id="1992" class="mo mp io kd b ke kf ki kj km nr kq ns ku nt ky mv mw mx my bi translated">写下实例和资源组的名称，然后单击“查看和创建”</li></ul><figure class="mk ml mm mn gu jp gi gj paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="gi gj oj"><img src="../Images/d19dbc2c98a90243bef0e42e373b5cee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*skS_SNXJSjMdv49n"/></div></div></figure><ul class=""><li id="6cc3" class="mo mp io kd b ke kf ki kj km nr kq ns ku nt ky mv mw mx my bi translated">只需在 vault 中定义您的日志分析工作区机密。</li></ul><figure class="mk ml mm mn gu jp gi gj paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="gi gj ok"><img src="../Images/fedc41e4848900b6286f4aa6c9dc9974.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*B3jyKDXMbXTqF6c9"/></div></div></figure><ul class=""><li id="177a" class="mo mp io kd b ke kf ki kj km nr kq ns ku nt ky mv mw mx my bi translated">现在，在您的数据块笔记本中创建范围</li><li id="fcd5" class="mo mp io kd b ke nu ki nv km nw kq nx ku ny ky mv mw mx my bi translated">在数据块 url 的末尾追加机密/创建范围</li></ul><figure class="mk ml mm mn gu jp gi gj paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="gi gj ol"><img src="../Images/402b0825f2104dc9087a780496d5a2e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*QU10HoQwT1kfcsfR"/></div></div></figure><ul class=""><li id="ff47" class="mo mp io kd b ke kf ki kj km nr kq ns ku nt ky mv mw mx my bi translated">输入作用域名称，现在从 azure key vault 获取 azure key vault DNS 名称和密钥资源 ID</li></ul><p id="f612" class="pw-post-body-paragraph kb kc io kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ih bi translated">访问您存储日志分析工作区机密的 azure vault，复制 vault URI 并将其粘贴到资源 ID 的 DNS 名称和资源 ID 中。</p><figure class="mk ml mm mn gu jp gi gj paragraph-image"><div class="gi gj om"><img src="../Images/a48087579926fb0c8dc60bcec0d13543.png" data-original-src="https://miro.medium.com/v2/resize:fit:1312/0*T_ycOF3SyLOJ26wr"/></div></figure><ul class=""><li id="1141" class="mo mp io kd b ke kf ki kj km nr kq ns ku nt ky mv mw mx my bi translated">现在，点击创建</li></ul><figure class="mk ml mm mn gu jp gi gj paragraph-image"><div class="gi gj on"><img src="../Images/557302a8bc1a39ad4d0f3495106eec2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1138/0*18owu-huGLuLwygn"/></div></figure><h2 id="587b" class="lx la io bd lb ly lz dn lf ma mb dp lj km mc md ln kq me mf lr ku mg mh lv mi bi translated">步骤 7:现在，将 src/spark-listeners/scripts/spark-monitoring . sh 复制到步骤 6 中创建的目录中，并将所有 jar 文件复制到 src/target 中</h2><figure class="mk ml mm mn gu jp"><div class="bz fq l di"><div class="np nq l"/></div></figure><h2 id="ef36" class="lx la io bd lb ly lz dn lf ma mb dp lj km mc md ln kq me mf lr ku mg mh lv mi bi translated">步骤 8:现在在 databricks 工作区中创建集群并打开高级选项</h2><ul class=""><li id="9b99" class="mo mp io kd b ke mq ki mr km ms kq mt ku mu ky mv mw mx my bi translated">首先选择您的首选集群</li></ul><figure class="mk ml mm mn gu jp gi gj paragraph-image"><div class="gi gj oo"><img src="../Images/eb170815c7cc1652424eb1bf34a1ff03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1218/0*gCujr9nYwhNnD1CV"/></div></figure><ul class=""><li id="0017" class="mo mp io kd b ke kf ki kj km nr kq ns ku nt ky mv mw mx my bi translated">现在打开高级选项，像这样再添加两个环境变量</li></ul><p id="3a58" class="pw-post-body-paragraph kb kc io kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ih bi translated">格式:{ {机密/{您的作用域名}/{您在密钥库中的机密名称}}}</p><figure class="mk ml mm mn gu jp gi gj paragraph-image"><div class="gi gj op"><img src="../Images/9c95f3985c1c9d80b858994855a09db3.png" data-original-src="https://miro.medium.com/v2/resize:fit:976/0*mXEI8O4a_TEWRnK6"/></div></figure><ul class=""><li id="1fea" class="mo mp io kd b ke kf ki kj km nr kq ns ku nt ky mv mw mx my bi translated">此外，将该脚本添加到您的 Init 脚本中，如下所示</li></ul><figure class="mk ml mm mn gu jp gi gj paragraph-image"><div class="gi gj oq"><img src="../Images/b270752d52fdb8b591711e15d2eb5607.png" data-original-src="https://miro.medium.com/v2/resize:fit:1202/0*N-c4H6N9f66U6zRv"/></div></figure><p id="56a5" class="pw-post-body-paragraph kb kc io kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ih bi translated">现在点击创建集群</p><p id="4959" class="pw-post-body-paragraph kb kc io kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ih bi translated"><strong class="kd ip">通过向 azure logs analytics 发送日志进行测试</strong></p><ul class=""><li id="eb80" class="mo mp io kd b ke kf ki kj km nr kq ns ku nt ky mv mw mx my bi translated">在 azure databricks 中创建新笔记本</li></ul><figure class="mk ml mm mn gu jp gi gj paragraph-image"><div class="gi gj or"><img src="../Images/c571ef8cb50556067134e4396dfdc009.png" data-original-src="https://miro.medium.com/v2/resize:fit:938/0*q_eLOxTagPB9PI2x"/></div></figure><p id="d99c" class="pw-post-body-paragraph kb kc io kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ih bi translated">运行两个单元</p><ul class=""><li id="b0ae" class="mo mp io kd b ke kf ki kj km nr kq ns ku nt ky mv mw mx my bi translated">访问 Azure 日志分析工作区现在访问日志部分</li></ul><figure class="mk ml mm mn gu jp gi gj paragraph-image"><div class="gi gj os"><img src="../Images/388d05930d0ce077d817d69324e036b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:482/0*KAklDKD1lbmLzXeB"/></div></figure><ul class=""><li id="1c37" class="mo mp io kd b ke kf ki kj km nr kq ns ku nt ky mv mw mx my bi translated">现在，您会看到自定义日志[如果您没有看到，请重新启动您的集群并等待一段时间，否则您会错过教程的某些部分]</li></ul><figure class="mk ml mm mn gu jp gi gj paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="gi gj ot"><img src="../Images/0dd243cc4daaa9d154b51107b25e48f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jG5hNF28wHTxHzqD"/></div></div></figure><ul class=""><li id="6fdc" class="mo mp io kd b ke kf ki kj km nr kq ns ku nt ky mv mw mx my bi translated">写一个查询并点击运行，你可以看到你的日志</li></ul><figure class="mk ml mm mn gu jp"><div class="bz fq l di"><div class="np nq l"/></div></figure><figure class="mk ml mm mn gu jp gi gj paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="gi gj ou"><img src="../Images/ba0d3fd3ecee26ad65ff7815e2ff4a68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*orysMj7q_-rzu97q"/></div></div></figure><p id="8054" class="pw-post-body-paragraph kb kc io kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ih bi translated">恭喜你，你已经成功地配置了我们的 spark 集群来将日志发送到 Azure log analytics 工作区。如果你想要更多这样的数据工程的东西。</p><blockquote class="mz"><p id="0f16" class="na nb io bd nc nd ov ow ox oy oz ky dk translated">请跟我来，也为这篇文章鼓掌。</p></blockquote></div></div>    
</body>
</html>