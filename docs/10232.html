<html>
<head>
<title>K8s Networking — CNI Part 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">K8s 网络— CNI 第二部分</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/k8s-networking-cni-part-2-e3bde1b639ba?source=collection_archive---------6-----------------------#2022-10-17">https://blog.devgenius.io/k8s-networking-cni-part-2-e3bde1b639ba?source=collection_archive---------6-----------------------#2022-10-17</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><div class=""/><div class=""><h2 id="43bd" class="pw-subtitle-paragraph jo iq ir bd b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dk translated">K8s 容器网络接口介绍</h2></div><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div class="gi gj kg"><img src="../Images/6b65962079d4ce29984bc9451cec5227.png" data-original-src="https://miro.medium.com/v2/resize:fit:1134/format:webp/0*lzsh9f1fbU3ThhDU.png"/></div></figure><p id="8a0b" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">在我上一篇文章《<a class="ae lk" href="https://medium.com/geekculture/k8s-network-cni-introduction-b035d42ad68f" rel="noopener"> K8s CNI 简介</a>》中，我讲过什么是 CNI，它的工艺流程和主要部件。让我们继续我们的 K8s 网络之旅。</p><p id="f907" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">我们已经知道，CNI 为网络插件定义了一系列公共接口。只要开发人员遵循这个规范，他们就可以访问 K8s，为 pod 创建虚拟网卡，分配 IP 地址，设置路由规则，并最终实现“每个 pod 一个 IP”的网络模型。</p><p id="c812" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">然而，根据实现机制的不同，CNI 插件可以分为三种不同的类型:</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gi gj ll"><img src="../Images/b9f953f6aae6f6d79656211be644af88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JWSZKJgUZGY4edgeJFyqvg.png"/></div></div></figure><h1 id="7066" class="lq lr ir bd ls lt lu lv lw lx ly lz ma jx mb jy mc ka md kb me kd mf ke mg mh bi translated">覆盖网络</h1><p id="8345" class="pw-post-body-paragraph ko kp ir kq b kr mi js kt ku mj jv kw kx mk kz la lb ml ld le lf mm lh li lj ik bi translated"><code class="fe mn mo mp mq b">overlay</code>网络驱动程序在多个节点之间创建一个分布式网络。该网络位于(覆盖)特定于主机的网络之上，允许连接到它的容器在启用加密时安全地通信。</p><p id="5d14" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">K8s Pod 网络通常是主机上的私有网络。比如<code class="fe mn mo mp mq b">10.244.0.0/16</code>就是典型的私有 NAT 网络。跨主机连接私有 NAT 网络中的 pod 的最简单方法是简单路由。只有当主机本身位于同一子网时，这种方法才有效。</p><p id="c351" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">“<a class="ae lk" href="https://github.com/flannel-io/flannel/" rel="noopener ugc nofollow" target="_blank">法兰绒</a>是一个<code class="fe mn mo mp mq b">overlay</code>模式的 CNI 插件(VXLAN 模式中的<strong class="kq is">)。它最初是由 CoreOS 创建的，是为 K8s 配置第 3 层网络的一种非常简单的方法。它所做的很简单:它在主机网络之上创建一个平面网络，这就是所谓的<code class="fe mn mo mp mq b">overlay</code>网络。在这个<code class="fe mn mo mp mq b">overlay</code>网络中，所有的吊舱都将被分配一个 ip 地址，它们通过直接调用彼此的 ip 地址来相互通信。</strong></p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gi gj mr"><img src="../Images/553a4789a616a1a49ac43c581712a0a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*OX0cVTNw-bgEooGQ.png"/></div></div><figcaption class="ms mt gk gi gj mu mv bd b be z dk translated">来自<a class="ae lk" href="https://stackoverflow.com/questions/62145066/how-to-see-the-pod-and-veth-relationship-in-kubernetes" rel="noopener ugc nofollow" target="_blank">堆栈溢出</a>的图片</figcaption></figure><ul class=""><li id="6462" class="mw mx ir kq b kr ks ku kv kx my lb mz lf na lj nb nc nd ne bi translated">数据从源容器发出后，通过所在主机的<code class="fe mn mo mp mq b">docker0</code>虚拟网卡转发到<code class="fe mn mo mp mq b">flannel0</code>虚拟网卡。这是一个 P2P 虚拟网卡，<code class="fe mn mo mp mq b">flanneld</code>服务监听网卡的另一端</li><li id="7234" class="mw mx ir kq b kr nf ku ng kx nh lb ni lf nj lj nb nc nd ne bi translated">法兰绒直接使用 K8s API 或<code class="fe mn mo mp mq b">etcd</code>来存储网络配置、分配的子网和任何辅助数据</li><li id="3102" class="mw mx ir kq b kr nf ku ng kx nh lb ni lf nj lj nb nc nd ne bi translated"><strong class="kq is">源</strong>主机的<code class="fe mn mo mp mq b">flanneld</code>服务将原始数据内容封装在 UDP 中，并根据自己的路由表传递给<strong class="kq is">目的</strong>节点的<code class="fe mn mo mp mq b">flanneld</code>服务</li><li id="4a2d" class="mw mx ir kq b kr nf ku ng kx nh lb ni lf nj lj nb nc nd ne bi translated">数据到达后解包，然后直接进入目的节点的<code class="fe mn mo mp mq b">flannel0</code>虚拟网卡，再转发到目的主机的<code class="fe mn mo mp mq b">flanneld</code>服务，再到<code class="fe mn mo mp mq b">docker0</code>虚拟网卡，最后<code class="fe mn mo mp mq b">docker0</code>路由就像本地容器通信一样到达目的容器。</li></ul><h1 id="5f82" class="lq lr ir bd ls lt lu lv lw lx ly lz ma jx mb jy mc ka md kb me kd mf ke mg mh bi translated">路线网络</h1><p id="a6cc" class="pw-post-body-paragraph ko kp ir kq b kr mi js kt ku mj jv kw kx mk kz la lb ml ld le lf mm lh li lj ik bi translated"><code class="fe mn mo mp mq b">route</code>工作在底层网络之上，利用系统内置的路由功能实现 Pod 跨节点通信。它的优势是高性能，但是对底层网络有很强的依赖性。如果底层网络不支持，它将无法工作。</p><p id="2c1c" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated"><a class="ae lk" href="https://github.com/projectcalico/calico" rel="noopener ugc nofollow" target="_blank"> Calico </a>是路由模式下的网络插件。它使用 BGP 协议(边界网关协议)来维护路由信息。其性能优于法兰绒，支持多种网络策略。数据加密、安全隔离、流量整形等功能。</p><p id="598f" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">印花布建筑看起来像:</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div class="gi gj nk"><img src="../Images/d0d259e88efe035fcacda2910625e9cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*gLSOZPk-Of2p2Kyp.png"/></div><figcaption class="ms mt gk gi gj mu mv bd b be z dk translated">图片来自<a class="ae lk" href="https://projectcalico.docs.tigera.io/" rel="noopener ugc nofollow" target="_blank">https://projectcalico.docs.tigera.io/</a></figcaption></figure><p id="f32a" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">在 Calico 中，进出工作负载的 IP 数据包由 Linux 路由表和<code class="fe mn mo mp mq b">iptables</code>进行路由和<code class="fe mn mo mp mq b">firewalled</code>。对于数据包发送，Calico 确保主机始终作为下一跳 MAC 地址返回。对于数据包接收，最后一个 IP 跃点是从目标工作负载的主机到工作负载本身。</p><h1 id="72b6" class="lq lr ir bd ls lt lu lv lw lx ly lz ma jx mb jy mc ka md kb me kd mf ke mg mh bi translated">底层网络</h1><p id="a81b" class="pw-post-body-paragraph ko kp ir kq b kr mi js kt ku mj jv kw kx mk kz la lb ml ld le lf mm lh li lj ik bi translated"><code class="fe mn mo mp mq b">underlay</code>直接利用底层网络实现 CNI，也就是说，Pod 和主机在同一个网络中。它对底层硬件和网络的依赖是三种类型中最强的，所以不是很灵活，但性能是最高的。</p><p id="f619" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">顾名思义，网络设备基础设施(如交换机、路由器、<em class="nl"> DWDM </em>等)链接到物理网络拓扑，使用网络介质负责网络之间的数据包传输。</p><p id="857e" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">底层网络可以是第 2 层或第 3 层；第 2 层底层网络的典型例子是以太网，第 3 层底层网络的典型例子是因特网。</p><p id="8d9f" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">在法兰绒<em class="nl"> </em> <strong class="kq is"> host-gw </strong>模式下，每个节点需要在同一个二层网络中，节点作为路由器，通过路由表完成跨节点通信。这样，网络被建模为<strong class="kq is">底层网络</strong>。</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gi gj nm"><img src="../Images/bd0b5517d1819d75b912ef55bf5d5a29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*UcFHYspqWU0fH_JF.png"/></div></div><figcaption class="ms mt gk gi gj mu mv bd b be z dk translated">图片来自<a class="ae lk" href="https://www.sobyte.net/post/2022-08/k8s-network/" rel="noopener ugc nofollow" target="_blank"> sobyte </a></figcaption></figure><h1 id="7288" class="lq lr ir bd ls lt lu lv lw lx ly lz ma jx mb jy mc ka md kb me kd mf ke mg mh bi translated">纤毛</h1><p id="144f" class="pw-post-body-paragraph ko kp ir kq b kr mi js kt ku mj jv kw kx mk kz la lb ml ld le lf mm lh li lj ik bi translated"><a class="ae lk" href="https://github.com/cilium/cilium" rel="noopener ugc nofollow" target="_blank"> Cilium </a>是一个比较新的网络插件，同时支持<code class="fe mn mo mp mq b">Overlay</code>模式和<code class="fe mn mo mp mq b">Route</code>模式。其特点是深度使用 Linux eBPF 技术，在内核级操作网络数据，所以性能很高，可以灵活实现各种功能。2021 年，它作为一个孵化项目加入了 CNCF，并且是一个非常有前途的 CNI 插件。</p><p id="c245" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">Cilium 提供了一个简单的平面第 3 层网络，能够以本地路由或覆盖模式跨越多个集群。它支持 L7 协议，可以使用与网络寻址分离的基于身份的安全模型在 L3-L7 上实施网络策略。</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gi gj nn"><img src="../Images/a663780442de7ae3cc288b0f2730cacf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*G8gBf7jQDQaEauZH.png"/></div></div><figcaption class="ms mt gk gi gj mu mv bd b be z dk translated">图片来自<a class="ae lk" href="https://github.com/cilium/cilium" rel="noopener ugc nofollow" target="_blank">纤毛</a></figcaption></figure><h1 id="3bcc" class="lq lr ir bd ls lt lu lv lw lx ly lz ma jx mb jy mc ka md kb me kd mf ke mg mh bi translated">结论</h1><ul class=""><li id="4e08" class="mw mx ir kq b kr mi ku mj kx no lb np lf nq lj nb nc nd ne bi translated">K8s 采用“IP-per-pod”网络模型，每个 pod 都有一个唯一的 IP 地址，因此易于管理。</li><li id="fb5c" class="mw mx ir kq b kr nf ku ng kx nh lb ni lf nj lj nb nc nd ne bi translated">CNI 插件可以分为三种类型:“覆盖”、“路由”和“底层”。</li></ul><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gi gj nr"><img src="../Images/6ae95fe1d5fe3215ae1da70c30a9da61.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LOdtaPQCnAqUKP2ofweVkA.png"/></div></div></figure></div></div>    
</body>
</html>