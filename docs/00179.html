<html>
<head>
<title>Render thousands of items in react without impacting performance with virtualization</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在 react 中渲染数千个项目，而不影响虚拟化的性能</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/render-thousands-of-items-in-react-without-impacting-performance-with-virtualization-932572999a2f?source=collection_archive---------0-----------------------#2020-04-27">https://blog.devgenius.io/render-thousands-of-items-in-react-without-impacting-performance-with-virtualization-932572999a2f?source=collection_archive---------0-----------------------#2020-04-27</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="d67a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">虚拟化是一种窗口技术。通过虚拟化，我们只呈现视图中所有项目的子集。子集中的项目数量由列表/网格大小和项目大小决定。</p><p id="2c21" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">你有没有试过在 react 中渲染一个有上千个条目/组件的列表？如果是，你知道痛苦如果不是<a class="ae ki" href="https://github.com/theBstar/virtualized-demo" rel="noopener ugc nofollow" target="_blank">克隆并在本地运行这个回购</a>。它用 react 在列表中呈现 5000 个条目。尝试更改 App.jsx 上第 11 行的数字。我的网页在 20000 个条目时崩溃了。如果列表项更重/嵌套，页面甚至在 1000 项时也不会有响应。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi kj"><img src="../Images/bac435b6454f6fd837f5720ee3cb9f54.png" data-original-src="https://miro.medium.com/v2/resize:fit:1156/format:webp/1*_A86JMzW0GJbdwERPDy8lQ.jpeg"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">开窗技术。摘自<a class="ae ki" href="https://webdev.imgix.net/virtualize-long-lists-react-window/window-diagram.jpg" rel="noopener ugc nofollow" target="_blank">https://web dev . imgix . net/virtualize-long-lists-react-window/window-diagram . jpg</a></figcaption></figure><p id="23cf" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在，让我们看看这个窗口技术能为我们做什么。我们将使用<a class="ae ki" href="https://github.com/bvaughn/react-window" rel="noopener ugc nofollow" target="_blank"> react-window </a>包，它为我们提供了实现虚拟列表的能力。</p><p id="16f3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">以下是我在实施虚拟化之前的列表和 listItem。</p><p id="3613" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> List.jsx </strong></p><pre class="kk kl km kn gt kv kw kx ky aw kz bi"><span id="52c1" class="la lb in kw b gy lc ld l le lf">import React from 'react';</span><span id="413a" class="la lb in kw b gy lg ld l le lf">import ListItem from './ListItem';<br/></span><span id="e530" class="la lb in kw b gy lg ld l le lf">export default function NaiveList({ items }) {</span><span id="e7eb" class="la lb in kw b gy lg ld l le lf">return (</span><span id="8d20" class="la lb in kw b gy lg ld l le lf">&lt;div className="list-content"&gt;</span><span id="7df2" class="la lb in kw b gy lg ld l le lf">{items.map((item, index) =&gt; (</span><span id="6390" class="la lb in kw b gy lg ld l le lf">&lt;ListItem key={item.id} item={item} /&gt;</span><span id="a5b8" class="la lb in kw b gy lg ld l le lf">))}</span><span id="25d5" class="la lb in kw b gy lg ld l le lf">&lt;/div&gt;</span><span id="012a" class="la lb in kw b gy lg ld l le lf">);</span><span id="1bbb" class="la lb in kw b gy lg ld l le lf">}</span></pre><p id="de2c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> ListItem.jsx </strong></p><pre class="kk kl km kn gt kv kw kx ky aw kz bi"><span id="842f" class="la lb in kw b gy lc ld l le lf">import React, { memo } from "react";</span><span id="c998" class="la lb in kw b gy lg ld l le lf">import { colors } from './constants';</span><span id="1fa2" class="la lb in kw b gy lg ld l le lf">function ListItem({ item }) {</span><span id="6d64" class="la lb in kw b gy lg ld l le lf">const { title } = item;</span><span id="eb8e" class="la lb in kw b gy lg ld l le lf">const bg = colors[Math.floor(Math.random() * (colors.length - 1))];</span><span id="5f0a" class="la lb in kw b gy lg ld l le lf">return (</span><span id="1f2c" class="la lb in kw b gy lg ld l le lf">&lt;div className="list-item" style={{ background: bg }}&gt;</span><span id="43d1" class="la lb in kw b gy lg ld l le lf">&lt;p&gt;{title}&lt;/p&gt;</span><span id="fd62" class="la lb in kw b gy lg ld l le lf">&lt;div</span><span id="aac2" class="la lb in kw b gy lg ld l le lf">style={{</span><span id="f8ec" class="la lb in kw b gy lg ld l le lf">background: "black",</span><span id="00e5" class="la lb in kw b gy lg ld l le lf">color: "white",</span><span id="d472" class="la lb in kw b gy lg ld l le lf">padding: "16px"</span><span id="a04c" class="la lb in kw b gy lg ld l le lf">}}</span><span id="754c" class="la lb in kw b gy lg ld l le lf">&gt;</span><span id="1eef" class="la lb in kw b gy lg ld l le lf">&lt;span&gt;{bg}&lt;/span&gt;</span><span id="9dd6" class="la lb in kw b gy lg ld l le lf">&lt;/div&gt;</span><span id="f017" class="la lb in kw b gy lg ld l le lf">&lt;/div&gt;</span><span id="0cab" class="la lb in kw b gy lg ld l le lf">);</span><span id="4a7f" class="la lb in kw b gy lg ld l le lf">}</span><span id="c916" class="la lb in kw b gy lg ld l le lf">export default memo(ListItem);</span></pre><p id="6d6b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我正在遍历数据项并呈现 listItem。ListItem 显示从预定义的常量集中随机选择的标题和背景颜色。</p><p id="00e9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">该列表平均需要 380 毫秒来呈现 5000 个项目，并且在交互上有明显的滞后。</p></div><div class="ab cl lh li hr lj" role="separator"><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm"/></div><div class="ig ih ii ij ik"><p id="d919" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">虚拟化的时间到了</strong></p><p id="53b1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">从从“react-window”导入导入 FixedSizeList 开始。它需要一个呈现函数来呈现行。一些最常用的道具是:</p><pre class="kk kl km kn gt kv kw kx ky aw kz bi"><span id="343a" class="la lb in kw b gy lc ld l le lf">height: height of the list</span><span id="f13d" class="la lb in kw b gy lg ld l le lf">itemCount: total items in our data set</span><span id="4034" class="la lb in kw b gy lg ld l le lf">itemSize: size/height of individual rows</span><span id="96f4" class="la lb in kw b gy lg ld l le lf">layout: "horizontal" or "vertical"</span><span id="bc87" class="la lb in kw b gy lg ld l le lf">width: width of the list</span><span id="eac2" class="la lb in kw b gy lg ld l le lf">render function: A render function which will get index of the item in the list and style as props and returns an row/item Element. We need to apply these style to the root of the component returned from the function.<br/></span></pre><p id="570c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在我们已经熟悉了这些概念，是时候在我们的应用中实现虚拟化了</p><p id="616f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> List.jsx(已更新)</strong></p><pre class="kk kl km kn gt kv kw kx ky aw kz bi"><span id="5924" class="la lb in kw b gy lc ld l le lf">import React, { useCallback } from 'react';</span><span id="fdd1" class="la lb in kw b gy lg ld l le lf">import ListItem from './ListItem';</span><span id="cacf" class="la lb in kw b gy lg ld l le lf">import { FixedSizeList as List } from 'react-window';</span><span id="a46e" class="la lb in kw b gy lg ld l le lf">import AutoSizer from "react-virtualized-auto-sizer";</span><span id="ddcf" class="la lb in kw b gy lg ld l le lf">export default function VirtualList({ items }) {</span><span id="14b6" class="la lb in kw b gy lg ld l le lf"><br/>// new listItem function, this function is passed to the List from react-window as render prop<br/></span><span id="38d8" class="la lb in kw b gy lg ld l le lf">const listItem = useCallback(</span><span id="b47d" class="la lb in kw b gy lg ld l le lf">({ index, style }) =&gt; {</span><span id="ba8b" class="la lb in kw b gy lg ld l le lf">const item = items[index];</span><span id="2944" class="la lb in kw b gy lg ld l le lf">return (</span><span id="0770" class="la lb in kw b gy lg ld l le lf">&lt;ListItem key={item.id} item={item} style={style} /&gt;</span><span id="aad6" class="la lb in kw b gy lg ld l le lf">);</span><span id="dd5c" class="la lb in kw b gy lg ld l le lf">},</span><span id="eb1d" class="la lb in kw b gy lg ld l le lf">[items],</span><span id="2182" class="la lb in kw b gy lg ld l le lf">);</span><span id="a5b6" class="la lb in kw b gy lg ld l le lf">// this function is passed to the AutoSizer which calculates the available height and width and passes that as prop to render prop.<br/></span><span id="1ede" class="la lb in kw b gy lg ld l le lf">const listRender = useCallback(</span><span id="b25d" class="la lb in kw b gy lg ld l le lf">({ height, width }) =&gt; (</span><span id="2fd8" class="la lb in kw b gy lg ld l le lf">&lt;List</span><span id="e7a7" class="la lb in kw b gy lg ld l le lf">className="list-content"</span><span id="16cf" class="la lb in kw b gy lg ld l le lf">itemCount={items.length}</span><span id="1783" class="la lb in kw b gy lg ld l le lf">itemSize={150}</span><span id="2b50" class="la lb in kw b gy lg ld l le lf">height={height}</span><span id="d0ce" class="la lb in kw b gy lg ld l le lf">width={width}</span><span id="e712" class="la lb in kw b gy lg ld l le lf">&gt;</span><span id="207b" class="la lb in kw b gy lg ld l le lf">{listItem}</span><span id="31ac" class="la lb in kw b gy lg ld l le lf">&lt;/List&gt;</span><span id="0d0f" class="la lb in kw b gy lg ld l le lf">),</span><span id="fc95" class="la lb in kw b gy lg ld l le lf">[items],</span><span id="d0de" class="la lb in kw b gy lg ld l le lf">);</span><span id="a663" class="la lb in kw b gy lg ld l le lf">return (</span><span id="7542" class="la lb in kw b gy lg ld l le lf">&lt;AutoSizer style={{ height: '90vh' }} &gt;</span><span id="22b3" class="la lb in kw b gy lg ld l le lf">{listRender}</span><span id="4230" class="la lb in kw b gy lg ld l le lf">&lt;/AutoSizer&gt;</span><span id="663b" class="la lb in kw b gy lg ld l le lf">);</span><span id="6eb7" class="la lb in kw b gy lg ld l le lf">}</span></pre><p id="d655" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们已经用<code class="fe lo lp lq kw b"><a class="ae ki" href="https://npmjs.com/package/react-virtualized-auto-sizer" rel="noopener ugc nofollow" target="_blank">react-virtualized-auto-sizer</a></code>包装了我们的列表，这允许我们的列表占据整个可用空间。</p><p id="d0ae" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> ListItem.jsx(已更新)</strong></p><pre class="kk kl km kn gt kv kw kx ky aw kz bi"><span id="a8f0" class="la lb in kw b gy lc ld l le lf">import React, { memo, useMemo, useState, useEffect } from "react";</span><span id="b3ef" class="la lb in kw b gy lg ld l le lf">import { colors } from './constants';</span><span id="a4ba" class="la lb in kw b gy lg ld l le lf">function getBg() {</span><span id="a85b" class="la lb in kw b gy lg ld l le lf">return colors[Math.floor(Math.random() * (colors.length - 1))];</span><span id="caf3" class="la lb in kw b gy lg ld l le lf">}</span><span id="55d4" class="la lb in kw b gy lg ld l le lf">function ListItem({ item, style }) {</span><span id="6c14" class="la lb in kw b gy lg ld l le lf">const { title } = item;</span><span id="e1e2" class="la lb in kw b gy lg ld l le lf">const bg = useMemo(getBg, []);</span><span id="14b8" class="la lb in kw b gy lg ld l le lf">const [newStyle, setStyle] = useState(style ? style : {});</span><span id="cc9f" class="la lb in kw b gy lg ld l le lf">useEffect(() =&gt; {</span><span id="017a" class="la lb in kw b gy lg ld l le lf">setStyle(style ? style : {})</span><span id="15d1" class="la lb in kw b gy lg ld l le lf">}, [style]);</span><span id="51d3" class="la lb in kw b gy lg ld l le lf">return (</span><span id="76c1" class="la lb in kw b gy lg ld l le lf">&lt;div</span><span id="2fcc" class="la lb in kw b gy lg ld l le lf">className="list-item"</span><span id="87cd" class="la lb in kw b gy lg ld l le lf">style={{</span><span id="a53f" class="la lb in kw b gy lg ld l le lf">...newStyle,</span><span id="8161" class="la lb in kw b gy lg ld l le lf">background: bg,</span><span id="ee26" class="la lb in kw b gy lg ld l le lf">}}</span><span id="d83c" class="la lb in kw b gy lg ld l le lf">&gt;</span><span id="cb8a" class="la lb in kw b gy lg ld l le lf">&lt;p&gt;{title}&lt;/p&gt;</span><span id="22dd" class="la lb in kw b gy lg ld l le lf">&lt;div</span><span id="73d8" class="la lb in kw b gy lg ld l le lf">style={{</span><span id="58c2" class="la lb in kw b gy lg ld l le lf">background: "black",</span><span id="af99" class="la lb in kw b gy lg ld l le lf">color: "white",</span><span id="cecf" class="la lb in kw b gy lg ld l le lf">padding: "16px"</span><span id="8917" class="la lb in kw b gy lg ld l le lf">}}</span><span id="94de" class="la lb in kw b gy lg ld l le lf">&gt;</span><span id="e490" class="la lb in kw b gy lg ld l le lf">&lt;span&gt;{bg}&lt;/span&gt;</span><span id="2c1e" class="la lb in kw b gy lg ld l le lf">&lt;/div&gt;</span><span id="f6d2" class="la lb in kw b gy lg ld l le lf">&lt;/div&gt;</span><span id="f5af" class="la lb in kw b gy lg ld l le lf">);</span><span id="7d3d" class="la lb in kw b gy lg ld l le lf">}</span><span id="c84a" class="la lb in kw b gy lg ld l le lf">export default memo(ListItem);</span></pre><p id="395c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">现在列表在大约 5 毫秒内渲染，最棒的是我可以毫不费力地渲染成千上万倍的数据集。</strong></p><p id="39f8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在这个包中还有很多值得探索的东西。这里是 react-window  readme 的链接。你可以<a class="ae ki" href="https://react-window.now.sh/#/examples/list/fixed-size" rel="noopener ugc nofollow" target="_blank">去这里看用法示例。</a>we . dev .<a class="ae ki" href="https://web.dev/virtualize-long-lists-react-window/" rel="noopener ugc nofollow" target="_blank">上有一篇关于虚拟化的好文章，下面是链接</a>。</p><p id="db20" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果您有兴趣，您可以在这里阅读更多关于虚拟化的问题、概念和早期讨论。</p></div></div>    
</body>
</html>