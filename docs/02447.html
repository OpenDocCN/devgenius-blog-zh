<html>
<head>
<title>Setup Traefik v2 for HA on Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在 Kubernetes 上为 HA 设置 Traefik v2</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/setup-traefik-v2-for-ha-on-kubernetes-20311204fa6f?source=collection_archive---------0-----------------------#2020-08-05">https://blog.devgenius.io/setup-traefik-v2-for-ha-on-kubernetes-20311204fa6f?source=collection_archive---------0-----------------------#2020-08-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="c208" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用 cert-manager 管理加密 TLS 证书并运行 Traefik v2 的多个副本。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/f8b52c1c7063e521346f12d8116480aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*rH1Wdy_ASFuJ2R9u.png"/></div></div></figure><p id="7ee0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我的上一篇文章“Kubernetes 上 Traefik v2 的快速入门”中，我花了 5 分钟快速完成了 Traefik、Let's Encrypt 和 Cloudflare 的端到端设置，以处理 Kubernetes 上的 HTTPS 请求。虽然使用 Traefik CRDs 的设置便于通过 IngressRoute 定义自动创建和更新证书，但它是使用 Traefik 的单个实例运行的，这意味着它的可用性不高。换句话说，Traefik 成为所有进入集群的流量的单点故障。</p><p id="b62a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在 Traefik v1 中，有使用 k v 存储(例如 Consul、etcd 等)的集群/ HA 模式的<a class="ae kx" href="https://docs.traefik.io/v1.7/user-guide/cluster/" rel="noopener ugc nofollow" target="_blank">测试版支持。然而，Traefik v2 删除了对在 k v 存储中存储 ACME/Let 加密证书的支持，理由是 raft consensus 算法存在缺陷(</a><a class="ae kx" href="https://github.com/containous/traefik/issues/4851" rel="noopener ugc nofollow" target="_blank"> #4851 </a>、<a class="ae kx" href="https://github.com/containous/traefik/issues/3487" rel="noopener ugc nofollow" target="_blank"> #3487 </a>、<a class="ae kx" href="https://github.com/containous/traefik/issues/5047" rel="noopener ugc nofollow" target="_blank"> #5047 </a>、<a class="ae kx" href="https://github.com/containous/traefik/issues/3833" rel="noopener ugc nofollow" target="_blank"> #3833 </a>)。自动证书管理功能被转移到 TraefikEE，让开源用户要么运行非 HA 版本，要么实施定制的证书管理解决方案。</p><p id="926f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Traefik 文档建议使用<a class="ae kx" href="https://github.com/jetstack/cert-manager" rel="noopener ugc nofollow" target="_blank">证书管理器</a>作为证书控制器，并指出对入口路由 CRD 的有限支持:</p><blockquote class="ky kz la"><p id="5b48" class="jn jo lb jp b jq jr js jt ju jv jw jx lc jz ka kb ld kd ke kf le kh ki kj kk ij bi translated">当使用 Traefik Kubernetes CRD 提供商时，不幸的是 Cert-Manager 还不能直接与 CRDs 接口，但我们的团队正在努力解决这个问题。一种解决方法是启用 Kubernetes Ingress 提供程序，允许 Cert-Manager 创建 Ingress 对象来完成挑战。请注意，这仍然需要手动干预，以通过证书管理器创建证书，但一旦创建，证书管理器将保持证书更新。</p></blockquote><p id="2a4e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这篇文章介绍了如何绕过这个限制，在 Kubernetes 上以 HA 模式运行 Traefik v2。我将使用 Cloudflare 作为我的 DNS 提供商和 ACME challenge solver，但也可以随意使用任何其他受支持的提供商。</p><p id="5ce4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="lb">所有的代码也可以在 Github 上找到:</em></p><div class="lf lg gp gr lh li"><a href="https://github.com/Yitaek/traefik-v2-ha-demo" rel="noopener  ugc nofollow" target="_blank"><div class="lj ab fo"><div class="lk ab ll cl cj lm"><h2 class="bd ir gy z fp ln fr fs lo fu fw ip bi translated">Yitaek/traefik-v2-ha-demo</h2><div class="lp l"><h3 class="bd b gy z fp ln fr fs lo fu fw dk translated">Traefik v2 删除了对在 k v 存储中存储 ACME/Let 加密证书的支持，引用了 raft 的错误…</h3></div><div class="lq l"><p class="bd b dl z fp ln fr fs lo fu fw dk translated">github.com</p></div></div><div class="lr l"><div class="ls l lt lu lv lr lw kv li"/></div></div></a></div><h1 id="8db3" class="lx ly iq bd lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu bi translated">先决条件</h1><ul class=""><li id="b3fc" class="mv mw iq jp b jq mx ju my jy mz kc na kg nb kk nc nd ne nf bi translated">Kubernetes 集群(例如 GKE)</li><li id="0c0e" class="mv mw iq jp b jq ng ju nh jy ni kc nj kg nk kk nc nd ne nf bi translated">头盔 v3</li><li id="8667" class="mv mw iq jp b jq ng ju nh jy ni kc nj kg nk kk nc nd ne nf bi translated">DNS 提供商(例如 Cloudflare)</li></ul><h1 id="e7b0" class="lx ly iq bd lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu bi translated">安装 Traefik</h1><p id="bdae" class="pw-post-body-paragraph jn jo iq jp b jq mx js jt ju my jw jx jy nl ka kb kc nm ke kf kg nn ki kj kk ij bi translated">我们将把 Traefik 部署到<code class="fe no np nq nr b">traefik</code>名称空间:</p><pre class="km kn ko kp gt ns nr nt nu aw nv bi"><span id="55a8" class="nw ly iq nr b gy nx ny l nz oa">$ kubectl create namespace traefik</span></pre><p id="998c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在让我们用 3 个副本部署 Traefik。您可以在<code class="fe no np nq nr b">traefik/traefik-values.yaml</code>中看到这些值:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="ob oc l"/></div><figcaption class="od oe gj gh gi of og bd b be z dk translated">Traefik HA 设置的舵值</figcaption></figure><pre class="km kn ko kp gt ns nr nt nu aw nv bi"><span id="9a0d" class="nw ly iq nr b gy nx ny l nz oa">$ helm repo add traefik https://containous.github.io/traefik-helm-chart</span><span id="46ee" class="nw ly iq nr b gy oh ny l nz oa">$ helm install -n traefik traefik traefik/traefik -f traefik/traefik-values.yaml</span></pre><p id="7f35" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">等待部署开始，并记下负载平衡器 IP。</p><h1 id="12db" class="lx ly iq bd lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu bi translated">安装证书管理器</h1><p id="23c4" class="pw-post-body-paragraph jn jo iq jp b jq mx js jt ju my jw jx jy nl ka kb kc nm ke kf kg nn ki kj kk ij bi translated">Cert-manager 是一款开源工具，用于自动颁发和更新 TLS 证书:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi oi"><img src="../Images/624e576254d7a560b7bf2ba93733aa86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q9CJnBOD0GO_bCLQxDr54Q.png"/></div></div><figcaption class="od oe gj gh gi of og bd b be z dk translated">证书管理器图表—图像信用:<a class="ae kx" href="https://cert-manager.io/docs/" rel="noopener ugc nofollow" target="_blank">证书管理器文档</a></figcaption></figure><p id="edd2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将把它安装在名称空间<code class="fe no np nq nr b">cert-manager</code>中:</p><pre class="km kn ko kp gt ns nr nt nu aw nv bi"><span id="baa4" class="nw ly iq nr b gy nx ny l nz oa">$ kubectl create namespace cert-manager</span></pre><p id="f6c8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">添加<a class="ae kx" href="https://github.com/jetstack/cert-manager" rel="noopener ugc nofollow" target="_blank">喷气堆舵杆 repo </a>并安装 CRDs:</p><pre class="km kn ko kp gt ns nr nt nu aw nv bi"><span id="d25e" class="nw ly iq nr b gy nx ny l nz oa">$ helm install \<br/>  cert-manager jetstack/cert-manager \<br/>  --namespace cert-manager \<br/>  --version v0.16.0 \<br/>  --set installCRDs=true</span></pre><p id="9689" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">等待所有证书管理器盒启动:</p><pre class="km kn ko kp gt ns nr nt nu aw nv bi"><span id="8530" class="nw ly iq nr b gy nx ny l nz oa">$ kubectl get pods -n cert-manager -w</span></pre><h1 id="e4d4" class="lx ly iq bd lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu bi translated">部署应用程序</h1><p id="6cd8" class="pw-post-body-paragraph jn jo iq jp b jq mx js jt ju my jw jx jy nl ka kb kc nm ke kf kg nn ki kj kk ij bi translated">为了便于演示，我们将在<code class="fe no np nq nr b">default</code>名称空间中部署<code class="fe no np nq nr b">whoami</code>应用程序(参见<code class="fe no np nq nr b">whoami</code>目录下的部署、服务和入口文件)。您可以用您的应用程序或众所周知的舵图(例如 Grafana、Kibana 等)来替换它。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="ob oc l"/></div><figcaption class="od oe gj gh gi of og bd b be z dk translated">whoami 默认部署、服务、入口路由</figcaption></figure><p id="45df" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">用你的 FQDN 替换<code class="fe no np nq nr b">whoami.example.com</code>并展开:</p><pre class="km kn ko kp gt ns nr nt nu aw nv bi"><span id="693b" class="nw ly iq nr b gy nx ny l nz oa">$ kubectl apply -f whoami</span></pre><h1 id="a66d" class="lx ly iq bd lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu bi translated">创建证书</h1><p id="3e69" class="pw-post-body-paragraph jn jo iq jp b jq mx js jt ju my jw jx jy nl ka kb kc nm ke kf kg nn ki kj kk ij bi translated">为了颁发新的证书，我们需要首先定义一个颁发者。在本例中，我将使用 Cloudflare 作为 ACME Issuer 类型，使用 Let's Encrypt 的临时服务器。您还可以在文档中找到其他<a class="ae kx" href="https://cert-manager.io/docs/configuration/" rel="noopener ugc nofollow" target="_blank">支持的配置</a>(自签名、CA、Vault、Venafi 和外部发行者类型)。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="ob oc l"/></div><figcaption class="od oe gj gh gi of og bd b be z dk translated">证书管理器颁发者示例</figcaption></figure><p id="716a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">配置<code class="fe no np nq nr b">certs/issuer.yaml</code>中的<code class="fe no np nq nr b">email</code>和<code class="fe no np nq nr b">solvers</code>部分。要将 Cloudflare 用作<a class="ae kx" href="https://cert-manager.io/docs/configuration/acme/dns01/" rel="noopener ugc nofollow" target="_blank"> DNS01 </a>质询求解器，首先使用以下设置创建一个新的 API 令牌:</p><p id="a6a8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">权限</strong>:</p><ul class=""><li id="d7fa" class="mv mw iq jp b jq jr ju jv jy oj kc ok kg ol kk nc nd ne nf bi translated"><code class="fe no np nq nr b">Zone - DNS - Edit</code></li><li id="c788" class="mv mw iq jp b jq ng ju nh jy ni kc nj kg nk kk nc nd ne nf bi translated"><code class="fe no np nq nr b">Zone - Zone - Read</code></li></ul><p id="0c67" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">区域资源</strong>:</p><ul class=""><li id="6c19" class="mv mw iq jp b jq jr ju jv jy oj kc ok kg ol kk nc nd ne nf bi translated"><code class="fe no np nq nr b">Include - All Zones</code></li></ul><p id="280d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将令牌作为 Kubernetes 的秘密挂载:</p><pre class="km kn ko kp gt ns nr nt nu aw nv bi"><span id="8e42" class="nw ly iq nr b gy nx ny l nz oa">$ kubectl create secret generic cloudflare-token --from-literal=dns-token=&lt;my-api-token&gt;</span></pre><p id="aa95" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，配置证书(根据需要在<code class="fe no np nq nr b">certs/whoami-cert.yaml</code>中修改<code class="fe no np nq nr b">commonName</code>、<code class="fe no np nq nr b">secretName</code>和<code class="fe no np nq nr b">dnsNames</code>)并部署:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="ob oc l"/></div><figcaption class="od oe gj gh gi of og bd b be z dk translated">whoami 应用程序示例证书</figcaption></figure><pre class="km kn ko kp gt ns nr nt nu aw nv bi"><span id="bb5a" class="nw ly iq nr b gy nx ny l nz oa">$ kubectl apply -f certs</span></pre><h1 id="14e4" class="lx ly iq bd lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu bi translated">设置 DNS</h1><p id="d0e8" class="pw-post-body-paragraph jn jo iq jp b jq mx js jt ju my jw jx jy nl ka kb kc nm ke kf kg nn ki kj kk ij bi translated">检查证书是否已生成:</p><pre class="km kn ko kp gt ns nr nt nu aw nv bi"><span id="b2d0" class="nw ly iq nr b gy nx ny l nz oa">$ kubectl describe certificate whoami-cert</span></pre><p id="4b45" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您还可以查看 Traefik 的调试日志来观察证书的激活情况。</p><p id="368b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，将 DNS 记录指向负载平衡器的 IP 地址，以查看由 HA Traefik + cert-manager 支持的启用了 TLS 的站点。可选地，为了完整性，您可以部署 HTTPS 重定向中间件。</p><p id="2da6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，我们在 Kubernetes 上部署了高可用性 Traefik。使用 cert-manager 的缺点是用户现在必须记住在部署 IngressRoute 之前创建证书，但是实现 HA 在生产中更重要，以避免停机。</p></div></div>    
</body>
</html>