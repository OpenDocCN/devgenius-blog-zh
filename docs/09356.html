<html>
<head>
<title>Write Your Messages Directly From Cloud Pub/Sub to BigQuery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将您的消息直接从云发布/订阅写到 BigQuery</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/write-your-messages-directly-from-cloud-pub-sub-to-bigquery-ece76c2b676a?source=collection_archive---------5-----------------------#2022-08-16">https://blog.devgenius.io/write-your-messages-directly-from-cloud-pub-sub-to-bigquery-ece76c2b676a?source=collection_archive---------5-----------------------#2022-08-16</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="1218" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">最近，谷歌云宣布了新的云发布/订阅选项(新的交付类型)。通过这种方式，我们能够将流消息写入大查询，而不需要管道(但它仍然有其局限性)。</p><p id="c87e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果你有预加载转换或数据处理需求，谷歌仍然推荐数据流。</p><p id="0e61" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在开始这个项目之前，有件事我想提醒你。此交付类型目前支持两种数据类型。字符串和字节。所有目标 BigQuery 表都需要数据字段。您可以从<a class="ae ki" href="https://cloud.google.com/pubsub/docs/bigquery" rel="noopener ugc nofollow" target="_blank">【大查询订阅】</a>查看详情</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/9f4a7b0c8c052a1c4b0b49f1519daac5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o3mop0QRltcs3mleX221wg.png"/></div></div><figcaption class="kv kw gj gh gi kx ky bd b be z dk translated">到 BigQuery 的云发布/订阅</figcaption></figure><h1 id="6995" class="kz la in bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated"><strong class="ak">场景</strong></h1><p id="11ee" class="pw-post-body-paragraph jk jl in jm b jn lx jp jq jr ly jt ju jv lz jx jy jz ma kb kc kd mb kf kg kh ig bi translated">在这个项目中，我们有这样一幅图像。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi mc"><img src="../Images/166e9449e60c8dfc44455474bf425e8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:798/format:webp/1*_btXInuK92anpgwfd3knMg.png"/></div></figure><p id="cde4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们将转换图像 base64 格式，然后发布到发布/订阅主题。然后，我们将它直接登陆到 BigQuery，中间不使用任何其他服务。</p><p id="a649" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">稍后我们将到达 BigQuery 表，在查询数据和解码数据(图像的字节格式)之后，我们将到达原始图像。所以让我们更深入地研究一下。</p><h1 id="6fae" class="kz la in bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">启用发布/订阅服务</h1><p id="820d" class="pw-post-body-paragraph jk jl in jm b jn lx jp jq jr ly jt ju jv lz jx jy jz ma kb kc kd mb kf kg kh ig bi translated">首先，我们需要启用发布/订阅服务。您可以遵循此路径并启用发布/订阅服务。</p><p id="95d3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">API 和服务&gt;库&gt;搜索(发布/订阅) &gt;选择&gt;云发布/订阅 API</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi md"><img src="../Images/e6fe23a946cfd1a0cfb3196be6a62771.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L6KiyJRlVc8hO-f2NI3K8Q.png"/></div></div><figcaption class="kv kw gj gh gi kx ky bd b be z dk translated">启用发布/订阅服务</figcaption></figure><h1 id="84b5" class="kz la in bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">创建发布/订阅主题</h1><p id="96e3" class="pw-post-body-paragraph jk jl in jm b jn lx jp jq jr ly jt ju jv lz jx jy jz ma kb kc kd mb kf kg kh ig bi translated">我们这样创建发布/订阅主题。发布/订阅&gt;主题</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi me"><img src="../Images/0927e80da1b22d7225a678e4b85452f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JqzTBttF_NUVJOLg9jM9RQ.png"/></div></div><figcaption class="kv kw gj gh gi kx ky bd b be z dk translated">创建发布/订阅主题</figcaption></figure><h1 id="cee3" class="kz la in bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">创建订阅</h1><p id="0933" class="pw-post-body-paragraph jk jl in jm b jn lx jp jq jr ly jt ju jv lz jx jy jz ma kb kc kd mb kf kg kh ig bi translated">在上一步中，我们创建了一个订阅，在订阅中，我们收听我们创建的主题的传入消息。为此，我们将遵循以下步骤。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi mf"><img src="../Images/3dc3fd702365dd906ca61511016183c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*biYzYYSK4LhkLd1K-vHhag.png"/></div></div><figcaption class="kv kw gj gh gi kx ky bd b be z dk translated">创建订阅</figcaption></figure><p id="6236" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> <em class="mg">我们这里有个问题。</em> </strong>问题表示我们无法写入选定的 BigQuery 表。要解决这个问题，请遵循以下步骤。</p><h2 id="75d6" class="mh la in bd lb mi mj dn lf mk ml dp lj jv mm mn ln jz mo mp lr kd mq mr lv ms bi translated"><strong class="ak"> 1。选择数据集，然后点击共享</strong></h2><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/a7538cba182b34c5ec361972cd245795.png" data-original-src="https://miro.medium.com/v2/resize:fit:1194/format:webp/1*EzIkUmpWTYToUYN80gZTEw.png"/></div></figure><h2 id="58a6" class="mh la in bd lb mi mj dn lf mk ml dp lj jv mm mn ln jz mo mp lr kd mq mr lv ms bi translated">2.添加新主体</h2><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi mu"><img src="../Images/29c6d9068d2cb0139fd6d8a99c2b2001.png" data-original-src="https://miro.medium.com/v2/resize:fit:1380/format:webp/1*Le8ulq0Q6GtYyDEbERY8nA.png"/></div></figure><h2 id="a163" class="mh la in bd lb mi mj dn lf mk ml dp lj jv mm mn ln jz mo mp lr kd mq mr lv ms bi translated">3.添加我们想要访问的服务帐户。</h2><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi mv"><img src="../Images/17a57c6286c18fd054b123d96f538f2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cqWG_5kJsGoKxRfYadf0WA.png"/></div></div></figure><p id="e766" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这些设置现在对我们来说刚刚好，我们可以在这些步骤之后创建订阅。</p><h1 id="db3e" class="kz la in bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated"><strong class="ak">创建发布/订阅服务证书密钥</strong></h1><p id="3cc1" class="pw-post-body-paragraph jk jl in jm b jn lx jp jq jr ly jt ju jv lz jx jy jz ma kb kc kd mb kf kg kh ig bi translated">我们需要证书密钥来发布和访问发布/订阅主题。为此，请遵循以下步骤。</p><h2 id="6563" class="mh la in bd lb mi mj dn lf mk ml dp lj jv mm mn ln jz mo mp lr kd mq mr lv ms bi translated">正在创建服务帐户</h2><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi mw"><img src="../Images/cfda9cbe0602958eb18b2dcb54fa24ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OgBpRzI3StpwXlA7q-QVNg.png"/></div></div></figure><h2 id="905d" class="mh la in bd lb mi mj dn lf mk ml dp lj jv mm mn ln jz mo mp lr kd mq mr lv ms bi translated">设置服务帐户详细信息</h2><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi mx"><img src="../Images/3432cbcb2d22461fd01116ea6f69f309.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fs1oZPWxg8kBxnhAgQDuDQ.png"/></div></div></figure><h2 id="ce1c" class="mh la in bd lb mi mj dn lf mk ml dp lj jv mm mn ln jz mo mp lr kd mq mr lv ms bi translated">设置服务帐户权限</h2><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi my"><img src="../Images/caaa94881c1443e3246eeedd945b98e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ULKxWuouRvyJJXzmnGfbpw.png"/></div></div></figure><h2 id="a7c8" class="mh la in bd lb mi mj dn lf mk ml dp lj jv mm mn ln jz mo mp lr kd mq mr lv ms bi translated">最终访问凭证密钥</h2><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi mz"><img src="../Images/e330c05bed8effc181154b1f2aa5f8c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sVugBN7a3w7X1X_IWz9Cew.png"/></div></div></figure><h1 id="832c" class="kz la in bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">将消息发布到发布/订阅主题</h1><p id="2953" class="pw-post-body-paragraph jk jl in jm b jn lx jp jq jr ly jt ju jv lz jx jy jz ma kb kc kd mb kf kg kh ig bi translated">我有一个如下的 python 代码。这段代码为发布/订阅主题创建了一个发布者客户端。然后我们再将图片<strong class="jm io"> base64 </strong>格式(<strong class="jm io"> <em class="mg">编码</em> </strong>)。<br/>而且我们会发布 base64 格式的数据到题目里。</p><p id="ebca" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果一切正常，让我们运行代码。</p><figure class="kk kl km kn gt ko"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="3de2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">检查数据到达</strong></p><p id="6cd8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> <em class="mg"> TA-DAA！</em> </strong>。base64(编码)格式的数据已成功到达。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi nc"><img src="../Images/310d7575621a464e7eb3dfbbbbebed95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kN-JTwspfCtqq0lt593Cuw.png"/></div></div></figure><h2 id="02ce" class="mh la in bd lb mi mj dn lf mk ml dp lj jv mm mn ln jz mo mp lr kd mq mr lv ms bi translated">从 BigQuery 获取数据并访问图像</h2><p id="eef0" class="pw-post-body-paragraph jk jl in jm b jn lx jp jq jr ly jt ju jv lz jx jy jz ma kb kc kd mb kf kg kh ig bi translated">在从 BigQuery 获取数据之前，我们需要访问(<strong class="jm io">为 BigQuery 创建新凭证</strong>)我前面提到的 BigQuery 凭证(发布/订阅凭证)。</p><p id="aa2d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">下面我只展示角色分配部分，其余都一样。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi nd"><img src="../Images/252be7b7c023d6952f19356c49ceadde.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_TxU8AJ_jP1HKqnYR34zrg.png"/></div></div></figure><p id="579a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在这里的代码中，在我们创建了一个 BigQuery 客户端并查询了相关的表之后，我们再次<strong class="jm io"> <em class="mg">解码(将数据 base64 转换为原始图像)</em> </strong>查询到的数据。</p><p id="6c82" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">然后运行代码。</p><figure class="kk kl km kn gt ko"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="bbe0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">是的，我们成功地做到了。 <a class="ae ki" href="https://emojipedia.org/partying-face/" rel="noopener ugc nofollow" target="_blank"> 🥳 </a>🎉🎈</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi ne"><img src="../Images/0c79360c84ef0ebaa1349adcfa2a5b5a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*S8cta2_CTg4KBZm4WDfYQA.png"/></div></div></figure><p id="99a3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在其他疯狂的项目中再见。祝你今天开心！玩的开心！</p><h2 id="1dbd" class="mh la in bd lb mi mj dn lf mk ml dp lj jv mm mn ln jz mo mp lr kd mq mr lv ms bi translated">Github 资源库:</h2><div class="nf ng gp gr nh ni"><a href="https://github.com/TugrulGokce/Cloud-Pub-Sub-To-BigQuery" rel="noopener  ugc nofollow" target="_blank"><div class="nj ab fo"><div class="nk ab nl cl cj nm"><h2 class="bd io gy z fp nn fr fs no fu fw im bi translated">GitHub-TugrulGokce/Cloud-Pub-Sub-To-big query</h2><div class="np l"><h3 class="bd b gy z fp nn fr fs no fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="nq l"><p class="bd b dl z fp nn fr fs no fu fw dk translated">github.com</p></div></div><div class="nr l"><div class="ns l nt nu nv nr nw kt ni"/></div></div></a></div></div></div>    
</body>
</html>