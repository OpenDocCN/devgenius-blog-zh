<html>
<head>
<title>Using MongoDB with Mongoose — Populate Virtuals and Count</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用MongoDB和mongose——填充虚拟体并计数</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/using-mongodb-with-mongoose-populate-virtuals-and-count-68fafa799a3f?source=collection_archive---------3-----------------------#2021-01-27">https://blog.devgenius.io/using-mongodb-with-mongoose-populate-virtuals-and-count-68fafa799a3f?source=collection_archive---------3-----------------------#2021-01-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/0806646915697abc493c6490f392e496.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Sv0JfAmYVAPZif0s"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">安迪·霍姆斯在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="0e00" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了简化MongoDB数据库操作，我们可以使用mongose NPM包来简化MongoDB数据库的操作。</p><p id="0b19" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将了解如何使用Mongoose来操作我们的MongoDB数据库。</p><h1 id="9a89" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">填充虚拟:计数选项</h1><p id="8078" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">当我们创建一个populate virtual时，我们可以添加<code class="fe me mf mg mh b">count</code>选项来获得我们检索到的孩子的数量。</p><p id="37a0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="fef6" class="mq lc iq mh b gy mr ms l mt mu">async function run() {<br/>  const { createConnection, Types, Schema } = require('mongoose');<br/>  const db = createConnection('mongodb://localhost:27017/test');<br/>  const PersonSchema = new Schema({<br/>    name: String,<br/>    band: String<br/>  });</span><span id="e1aa" class="mq lc iq mh b gy mv ms l mt mu">  const BandSchema = new Schema({<br/>    name: String<br/>  }, { toJSON: { virtuals: true } });</span><span id="e8ca" class="mq lc iq mh b gy mv ms l mt mu">  BandSchema.virtual('numMembers', {<br/>    ref: 'Person',<br/>    localField: 'name',<br/>    foreignField: 'band',<br/>    count: true<br/>  });</span><span id="9f97" class="mq lc iq mh b gy mv ms l mt mu">  const Person = db.model('Person', PersonSchema);<br/>  const Band = db.model('Band', BandSchema);<br/>  const person = new Person({ name: 'james', band: 'superband' });<br/>  await person.save();<br/>  const band = new Band({ name: 'superband' });<br/>  await band.save();<br/>  const doc = await Band.findOne({ name: 'superband' })<br/>    .populate('numMembers');<br/>  console.log(doc.numMembers);<br/>}<br/>run();</span></pre><p id="f04b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们创建了<code class="fe me mf mg mh b">PersonSchema</code>和<code class="fe me mf mg mh b">BandSchema</code>模式对象。</p><p id="a1ca" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们用几个选项在<code class="fe me mf mg mh b">BandSchema</code>模式上调用<code class="fe me mf mg mh b">virtual</code>方法。</p><p id="6934" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">ref</code>属性是<code class="fe me mf mg mh b">Band</code>模型引用的模型。</p><p id="a049" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">localField</code>是<code class="fe me mf mg mh b">BandSchema</code>中我们希望与<code class="fe me mf mg mh b">PeronSchema</code>连接的字段。</p><p id="e7c8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">foreignField</code>是<code class="fe me mf mg mh b">ForeignSchema</code>中我们要与<code class="fe me mf mg mh b">PersonSchema</code>连接的字段。</p><p id="ad4a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">count</code>设置为<code class="fe me mf mg mh b">true</code>意味着我们得到了计数。<code class="fe me mf mg mh b">numMembers</code>是我们从中获取计数的字段名称。</p><p id="4b05" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们保存一个同名的<code class="fe me mf mg mh b">Person</code>和<code class="fe me mf mg mh b">Band</code>文档。</p><p id="4c7c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们用<code class="fe me mf mg mh b">numMembers</code>字段调用<code class="fe me mf mg mh b">populate</code>来获得成员的数量。</p><p id="121d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后，我们从检索到的结果中得到<code class="fe me mf mg mh b">numMembers</code>字段，从而得到<code class="fe me mf mg mh b">Band</code>中有多少个<code class="fe me mf mg mh b">Person</code>子条目。</p><h1 id="fa76" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">在中间件中填充</h1><p id="9b30" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以添加前置或后置挂钩来填充操作。</p><p id="4517" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="1e42" class="mq lc iq mh b gy mr ms l mt mu">async function run() {<br/>  const { createConnection, Types, Schema } = require('mongoose');<br/>  const db = createConnection('mongodb://localhost:27017/test');<br/>  const PersonSchema = new Schema({<br/>    name: String,<br/>    band: String<br/>  });</span><span id="e925" class="mq lc iq mh b gy mv ms l mt mu">  const BandSchema = new Schema({<br/>    name: String<br/>  }, { toJSON: { virtuals: true } });</span><span id="7c39" class="mq lc iq mh b gy mv ms l mt mu">  BandSchema.virtual('numMembers', {<br/>    ref: 'Person',<br/>    localField: 'name',<br/>    foreignField: 'band',<br/>    count: true<br/>  });</span><span id="fb62" class="mq lc iq mh b gy mv ms l mt mu">  BandSchema.pre('find', function () {<br/>   this.populate('person');<br/>  });</span><span id="e4a0" class="mq lc iq mh b gy mv ms l mt mu">  BandSchema.post('find', async (docs) =&gt; {<br/>    for (const doc of docs) {<br/>      await doc.populate('person').execPopulate();<br/>    }<br/>  });</span><span id="3ec1" class="mq lc iq mh b gy mv ms l mt mu">  const Person = db.model('Person', PersonSchema);<br/>  const Band = db.model('Band', BandSchema);<br/>  const person = new Person({ name: 'james', band: 'superband' });<br/>  await person.save();<br/>  const band = new Band({ name: 'superband' });<br/>  await band.save();<br/>  const doc = await Band.findOne({ name: 'superband' })<br/>    .populate('numMembers');<br/>  console.log(doc.numMembers);<br/>}<br/>run();</span></pre><p id="27ed" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">增加<code class="fe me mf mg mh b">pre</code>和<code class="fe me mf mg mh b">post</code>挂钩以监听<code class="fe me mf mg mh b">find</code>操作。</p><p id="04d0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们应该总是用给定的字段调用<code class="fe me mf mg mh b">populate</code>来做填充。</p><h1 id="8f35" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="78b0" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以添加<code class="fe me mf mg mh b">count</code>属性来增加计数，还可以在填充时为<code class="fe me mf mg mh b">find</code>操作添加前置和后置挂钩。</p></div></div>    
</body>
</html>