<html>
<head>
<title>D(Native Java-Like) programming on Android</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Android 上的 d(原生类 Java)编程</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/d-c-evolution-programming-on-android-9bdf9aa1b67d?source=collection_archive---------8-----------------------#2020-08-02">https://blog.devgenius.io/d-c-evolution-programming-on-android-9bdf9aa1b67d?source=collection_archive---------8-----------------------#2020-08-02</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/fb9b5cf066dd6ac5805502adbe5309e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*02BY3sOEhW5z0OZb.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">来自 dlang.org 的照片</figcaption></figure><h1 id="7ec6" class="jz ka in bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">Android 上的 D-Lang</h1><p id="c38d" class="pw-post-body-paragraph kx ky in kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu ig bi translated">创建这个库是因为在查看 D-Lang 官方维基时出现了信息不匹配，以<a class="ae lv" href="https://wiki.dlang.org/Build_D_for_Android" rel="noopener ugc nofollow" target="_blank">为 Android </a>构建 D</p><p id="07e2" class="pw-post-body-paragraph kx ky in kz b la lw lc ld le lx lg lh li ly lk ll lm lz lo lp lq ma ls lt lu ig bi translated">主要的区别是，我展示了如何为您的环境获得正式的 LDC 版本，如何在 Linux 上设置您的变量，并且我发现了一个问题，就是在 ldc2.conf 中的 lib-dirs 后面缺少了一个/lib</p><h1 id="7a12" class="jz ka in bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">安装 Android Studio 并获得 NDK</h1><p id="4a05" class="pw-post-body-paragraph kx ky in kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu ig bi translated">这是一个关于如何做的非常简单的教程，因为它有关于如何获得 android 的 NDK 的无数教程。在 https://developer.android.com/studio<a class="ae lv" href="https://developer.android.com/studio" rel="noopener ugc nofollow" target="_blank">获得 Android Studio</a>完成安装进入你的 Android Studio IDE(任务栏)的右上角并搜索<code class="fe mb mc md me b">SDK Manager</code>安装目标 SDK，目前最新的是 Android 10(Q)，它在“SDK 平台”旁边的“SDK 平台”选择中，它有“SDK 工具”，点击它并选择 NDK。 Android SDK Tools，Android SDK Platform-Tools，Android SDK Build-Tools 然后点击窗口顶部的 OK，上面有 SDK 所在的位置，你可以随时再查看一遍以供参考，记住你的 ndk 安装在哪里就行了</p><h2 id="e081" class="mf ka in bd kb mg mh dn kf mi mj dp kj li mk ml kn lm mm mn kr lq mo mp kv mq bi translated">在 Linux 上安装 LDC</h2><p id="8f1c" class="pw-post-body-paragraph kx ky in kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu ig bi translated">对于在 Linux 上安装 LDC，我不建议从仓库中获取，而是去 Dlang 官方安装网站:<a class="ae lv" href="https://dlang.org/install.html" rel="noopener ugc nofollow" target="_blank"> D-Lang 官方安装网站</a>然后获取 D-Lang 官方安装脚本(Install . sh)——&gt;直接链接<a class="ae lv" href="https://dlang.org/install.sh" rel="noopener ugc nofollow" target="_blank"> D-Lang 安装脚本</a>之后打开 Bash 并:</p><ul class=""><li id="5333" class="mr ms in kz b la lw le lx li mt lm mu lq mv lu mw mx my mz bi translated">chmod +x ./install.sh</li><li id="b8c4" class="mr ms in kz b la na le nb li nc lm nd lq ne lu mw mx my mz bi translated">。/install.sh ldc 执行这些命令会将它安装在您的/home/currentUser/dlang(~/dlang)中。如果您尝试执行 than ldc2(当前版本)，您会看到它不可用，安装脚本实际上附带了一个参数，该参数允许您“激活”(实际上将重要变量导出到您的路径中)，但由于某种原因，我的 Linux not exports 命令没有保存这些变量。所以我们要做的很简单:</li><li id="0e0e" class="mr ms in kz b la na le nb li nc lm nd lq ne lu mw mx my mz bi translated">前往~/dlang/ldc(当前版本)</li><li id="4a87" class="mr ms in kz b la na le nb li nc lm nd lq ne lu mw mx my mz bi translated">用你喜欢的文本编辑器打开激活</li><li id="8169" class="mr ms in kz b la na le nb li nc lm nd lq ne lu mw mx my mz bi translated">您将在文本编辑器中找到以下几行</li></ul><figure class="nf ng nh ni gt jo"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="fa88" class="pw-post-body-paragraph kx ky in kz b la lw lc ld le lx lg lh li ly lk ll lm lz lo lp lq ma ls lt lu ig bi translated">重要的行是那些在<code class="fe mb mc md me b">if [ -v _OLD_D_PATH ]</code>后面有<code class="fe mb mc md me b">export</code>的行，表示更容易理解:</p><figure class="nf ng nh ni gt jo"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="b57d" class="pw-post-body-paragraph kx ky in kz b la lw lc ld le lx lg lh li ly lk ll lm lz lo lp lq ma ls lt lu ig bi translated">用您当前的用户名更改/hipreme/</p><ul class=""><li id="f0ff" class="mr ms in kz b la lw le lx li mt lm mu lq mv lu mw mx my mz bi translated">去你的$家</li><li id="9669" class="mr ms in kz b la na le nb li nc lm nd lq ne lu mw mx my mz bi translated">编辑。bashrc(可以随便 sudo vim ~/。如果你愿意的话)</li><li id="6023" class="mr ms in kz b la na le nb li nc lm nd lq ne lu mw mx my mz bi translated">在导出的顶部，复制上面描述的每一行</li><li id="e508" class="mr ms in kz b la na le nb li nc lm nd lq ne lu mw mx my mz bi translated">现在你的电脑应该可以运行 ldc 了</li></ul><h2 id="ac18" class="mf ka in bd kb mg mh dn kf mi mj dp kj li mk ml kn lm mm mn kr lq mo mp kv mq bi translated">为 LDC 获取 Android 库</h2><p id="f762" class="pw-post-body-paragraph kx ky in kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu ig bi translated">现在你需要在你的 LDC 上包含一个 android 架构库，要做到这一点，进入<a class="ae lv" href="https://github.com/ldc-developers/ldc/" rel="noopener ugc nofollow" target="_blank"> LDC github 库</a>进入<a class="ae lv" href="https://github.com/ldc-developers/ldc/releases/" rel="noopener ugc nofollow" target="_blank">发布版</a>寻找一个与你的 LDC 版本匹配的发布版，在我写这篇文章的时候，我的版本是 1.22.0，所以，它会有前缀像<strong class="kz io">LDC 2–1 . 22 . 0-Android</strong>你要搜索的是 Android 架构 64 (aarch64)，所以我需要下载的版本是:<em class="nl"/></p><p id="073c" class="pw-post-body-paragraph kx ky in kz b la lw lc ld le lx lg lh li ly lk ll lm lz lo lp lq ma ls lt lu ig bi translated"><strong class="kz io">重要</strong></p><blockquote class="nm nn no"><p id="b735" class="kx ky nl kz b la lw lc ld le lx lg lh np ly lk ll nq lz lo lp nr ma ls lt lu ig bi translated">如果您的目标架构没有预构建的二进制文件(LDC 开发人员发布资产中的那些)，您将不得不<a class="ae lv" href="https://wiki.dlang.org/Building_LDC_runtime_libraries" rel="noopener ugc nofollow" target="_blank">自己构建 Phobos 和 DRuntime </a></p><p id="c479" class="kx ky nl kz b la lw lc ld le lx lg lh np ly lk ll nq lz lo lp nr ma ls lt lu ig bi translated">请注意，在您的架构目标文件夹中，您会看到有一个 lib/和其他 lib(通常与 32 位相关)，您可以使用它为另一个目标进行分发，在 aarch64 中有一个 x86_64，您可以设置一个针对它的配置，在-gcc 中的二进制文件中，搜索 x86_64</p></blockquote><p id="dfe8" class="pw-post-body-paragraph kx ky in kz b la lw lc ld le lx lg lh li ly lk ll lm lz lo lp lq ma ls lt lu ig bi translated">下载之后，是时候设置你的编译器来找到它的存在了。</p><h2 id="7307" class="mf ka in bd kb mg mh dn kf mi mj dp kj li mk ml kn lm mm mn kr lq mo mp kv mq bi translated">添加编译命令</h2><ul class=""><li id="2dd3" class="mr ms in kz b la lb le lf li ns lm nt lq nu lu mw mx my mz bi translated">前往~/dlang/ldc(yourVersionHere)</li><li id="c4ec" class="mr ms in kz b la na le nb li nc lm nd lq ne lu mw mx my mz bi translated">提取您新获得的文件</li><li id="9fb7" class="mr ms in kz b la na le nb li nc lm nd lq ne lu mw mx my mz bi translated">将其重命名为<code class="fe mb mc md me b">lib-android__aarch64</code></li><li id="ab42" class="mr ms in kz b la na le nb li nc lm nd lq ne lu mw mx my mz bi translated">前往~/dlang/LDC(your version here)/etc/</li><li id="2745" class="mr ms in kz b la na le nb li nc lm nd lq ne lu mw mx my mz bi translated">打开 ldc2.conf</li><li id="bb8d" class="mr ms in kz b la na le nb li nc lm nd lq ne lu mw mx my mz bi translated">将以下内容附加到文件末尾:</li></ul><pre class="nf ng nh ni gt nv me nw nx aw ny bi"><span id="38e8" class="mf ka in me b gy nz oa l ob oc">"aarch64-.*-linux-android":<br/>{<br/>    switches = [<br/>        "-defaultlib=phobos2-ldc,druntime-ldc",<br/>        "-link-defaultlib-shared=false",<br/>        "-gcc=/home/hipreme/Android/Sdk/ndk/21.3.6528147/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang",<br/>    ];<br/>    lib-dirs = [<br/>        "%%ldcbinarypath%%/../lib-android_aarch64/lib",<br/>    ];<br/>    rpath = "";<br/>};</span></pre><ul class=""><li id="57ad" class="mr ms in kz b la lw le lx li mt lm mu lq mv lu mw mx my mz bi translated">在<code class="fe mb mc md me b">-gcc=</code>一行，你应该放上你的安卓 NDK，我的在那个文件夹里，但是你应该搜索的是<code class="fe mb mc md me b">toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang</code></li></ul><blockquote class="nm nn no"><p id="5527" class="kx ky nl kz b la lw lc ld le lx lg lh np ly lk ll nq lz lo lp nr ma ls lt lu ig bi translated">如果你正在为 Windows 编译，你的路径可能类似于<code class="fe mb mc md me b">"-gcc=C:/Users/Hipreme/AppData/Local/Android/Sdk/ndk/21.3.6528147/toolchains/llvm/prebuilt/windows-x86_64/bin/aarch64-linux-android21-clang.cmd"</code></p></blockquote><p id="2d59" class="pw-post-body-paragraph kx ky in kz b la lw lc ld le lx lg lh li ly lk ll lm lz lo lp lq ma ls lt lu ig bi translated">之后，从官方 wiki 下载一个示例 d 程序:</p><figure class="nf ng nh ni gt jo"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="edf4" class="pw-post-body-paragraph kx ky in kz b la lw lc ld le lx lg lh li ly lk ll lm lz lo lp lq ma ls lt lu ig bi translated">如果它编译得好，您的 LDC 就被正确地配置为开始与 Android 一起工作。</p><p id="7884" class="pw-post-body-paragraph kx ky in kz b la lw lc ld le lx lg lh li ly lk ll lm lz lo lp lq ma ls lt lu ig bi translated">在进入本教程的下一部分之前，我想补充一点，这个架构是作为一个示例使用的，因为这是我的手机各自的架构，如果你想编译任何其他架构，看看<a class="ae lv" href="https://wiki.dlang.org/Cross-compiling_with_LDC" rel="noopener ugc nofollow" target="_blank">与 LDC 的交叉编译</a></p><h1 id="ff06" class="jz ka in bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">为 Android 准备您的 D 模块</h1><p id="9b15" class="pw-post-body-paragraph kx ky in kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu ig bi translated">在你第一次成功地将它编译到 Android 架构后，你实际上需要做三件事:</p><ol class=""><li id="f3ff" class="mr ms in kz b la lw le lx li mt lm mu lq mv lu od mx my mz bi translated">您需要在您的文件顶部导入 D 模块 JNI:<code class="fe mb mc md me b">import jni</code>。JNI 模块不是我做的，为了保持兼容性，这个库中的文件是对<a class="ae lv" href="https://github.com/Diewi/android" rel="noopener ugc nofollow" target="_blank">原始库</a>的引用</li><li id="280f" class="mr ms in kz b la na le nb li nc lm nd lq ne lu od mx my mz bi translated">创建一个您希望导出到 Android 的文件。您需要将您的函数作为<code class="fe mb mc md me b">extern(C)</code>导出，并按照与命名从 NDK Java _ package name _ class name _ method name(jniev * env，jclass clazz) sample.d 导出的 C 函数相同的约定命名它</li></ol><figure class="nf ng nh ni gt jo"><div class="bz fp l di"><div class="nj nk l"/></div></figure><ol class=""><li id="c286" class="mr ms in kz b la lw le lx li mt lm mu lq mv lu od mx my mz bi translated">将它编译成一个共享库，假设你的目标是 Arm64 架构，你需要调用:<code class="fe mb mc md me b">ldc2 -mtriple=aarch64--linux-android --shared sample.d</code>这将输出 libsample.so，这个文件将包含在你的 Android 项目中</li></ol><h1 id="f240" class="jz ka in bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">一句警告</h1><p id="4157" class="pw-post-body-paragraph kx ky in kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu ig bi translated">总是调用 rt_init，否则很可能会导致 sigsegfault(5)，使用 to！string 直到我调用 rt_init()才起作用；</p><h1 id="de92" class="jz ka in bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">创建 Android 项目</h1><p id="dfb0" class="pw-post-body-paragraph kx ky in kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu ig bi translated">在撰写本文时，在构建 android 的官方 D Wiki 中，记录了使用 Ant 生成 apk 的方法，但这已经过去很久了，几乎没有关于如何实际使用它的文档，而且它对今天的 Android 开发毫无用处，因为每个人都使用 gradle，在管理整个 Android 项目时对 Gradle 了解很少，它可以通过简单的命令添加许多库，所以我们将使用 Android Studio</p><ul class=""><li id="5c7a" class="mr ms in kz b la lw le lx li mt lm mu lq mv lu mw mx my mz bi translated">打开 Android Studio</li><li id="bdd1" class="mr ms in kz b la na le nb li nc lm nd lq ne lu mw mx my mz bi translated">进入“开始一个新的 Android 工作室项目”</li><li id="4962" class="mr ms in kz b la na le nb li nc lm nd lq ne lu mw mx my mz bi translated">选择“空活动”</li><li id="3566" class="mr ms in kz b la na le nb li nc lm nd lq ne lu mw mx my mz bi translated">命名您的项目(假设我将我的项目命名为 Test，并将包命名为 com.hipreme.test)</li><li id="27c8" class="mr ms in kz b la na le nb li nc lm nd lq ne lu mw mx my mz bi translated">配置并点击 Finish(我目前使用的是 min API 23)</li><li id="6d35" class="mr ms in kz b la na le nb li nc lm nd lq ne lu mw mx my mz bi translated">进入窗口左侧，将视图设置为“项目”。文件夹结构必须如下所示:</li></ul><pre class="nf ng nh ni gt nv me nw nx aw ny bi"><span id="c385" class="mf ka in me b gy nz oa l ob oc">Test<br/>|--.gradle<br/>|--.idea<br/>|--app<br/>|--|--build<br/>|--|--libs<br/>|--|--src<br/>|--|--|--androidTest<br/>|--|--|--main<br/>|--|--|--test<br/>|--|--|.gitignore<br/>|--|--app.iml<br/>|--|--build.gradle<br/>|--|--proguard-rules.pro<br/>|--gradle<br/>|--.gitignore<br/>|--buid.gradle<br/>|--gradle.properties<br/>|--gradlew<br/>|--gradlew.bat<br/>|--local.properties<br/>|--settings.gradle<br/>|--Test.iml</span></pre><p id="1a82" class="pw-post-body-paragraph kx ky in kz b la lw lc ld le lx lg lh li ly lk ll lm lz lo lp lq ma ls lt lu ig bi translated">最后还有:</p><pre class="nf ng nh ni gt nv me nw nx aw ny bi"><span id="ec31" class="mf ka in me b gy nz oa l ob oc">|&gt; External Libraries<br/>|&gt; Scratches and Consoles</span></pre><p id="d3fd" class="pw-post-body-paragraph kx ky in kz b la lw lc ld le lx lg lh li ly lk ll lm lz lo lp lq ma ls lt lu ig bi translated">打开 Test/app/src/main 文件夹，在 main 里面创建一个名为<code class="fe mb mc md me b">jniLibs</code>的文件夹，这个文件夹是<strong class="kz io">非常重要的</strong>，它是默认的文件夹，用来存放你的共享库和你的. apk 一起导入，如果你想用其他的名字，你需要改变你的 gradle 文件。为了将您的库放入该文件夹中，您实际上需要为目标体系结构创建目录，因此，在其中创建:</p><ul class=""><li id="1fc7" class="mr ms in kz b la lw le lx li mt lm mu lq mv lu mw mx my mz bi translated">armeabi-v7a(为此，常用的是 ldc2(版本)-android-armv7a/lib</li><li id="886a" class="mr ms in kz b la na le nb li nc lm nd lq ne lu mw mx my mz bi translated">arm64-v8a(这是我们现在的目标，ldc2(版本)-android-aarch64/lib)</li><li id="2ce1" class="mr ms in kz b la na le nb li nc lm nd lq ne lu mw mx my mz bi translated">x86(就是 armv7a 的 lib 32-&gt; LDC 2(版本)-android-armv7a/lib686</li><li id="1894" class="mr ms in kz b la na le nb li nc lm nd lq ne lu mw mx my mz bi translated">x86_64(是 aarch64 的 lib 32-&gt; LDC 2(版本)-android-aarch64/lib-x86_64 参考，查看 android 官方网站 ndk abi 指南:<a class="ae lv" href="https://developer.android.com/ndk/guides/abis" rel="noopener ugc nofollow" target="_blank"> Android ABI 指南</a>你的新主结构必须是:</li></ul><pre class="nf ng nh ni gt nv me nw nx aw ny bi"><span id="f0f6" class="mf ka in me b gy nz oa l ob oc">main<br/>|--java<br/>|--jniLibs<br/>|--|--armeabi-v7a<br/>|--|--arm64-v8a<br/>|--|--x86<br/>|--|--x86_64<br/>|--res<br/>|--AndroidManifest.xml</span></pre><p id="bc09" class="pw-post-body-paragraph kx ky in kz b la lw lc ld le lx lg lh li ly lk ll lm lz lo lp lq ma ls lt lu ig bi translated">创建这些文件夹后，你可以将你的共享库移动到其中一个文件夹中，正如我们用 aarch64 展示的，你应该将你的 libsample.so 移动到 arm64-v8a 中。这样，你现在应该能够通过调用你的 java 代码将你的库导入 Android Studio，所以，在 main/ảva/your/long/package/name，创建一个新的。java 文件，我将创建一个 Sample.java 文件:</p><figure class="nf ng nh ni gt jo"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="91ce" class="pw-post-body-paragraph kx ky in kz b la lw lc ld le lx lg lh li ly lk ll lm lz lo lp lq ma ls lt lu ig bi translated">现在，你可以从代码中的任何地方调用<code class="fe mb mc md me b">Sample.methodname("hello")</code>, D 将被调用</p><h2 id="b8ed" class="mf ka in bd kb mg mh dn kf mi mj dp kj li mk ml kn lm mm mn kr lq mo mp kv mq bi translated">一些有用的库</h2><ul class=""><li id="644e" class="mr ms in kz b la lb le lf li ns lm nt lq nu lu mw mx my mz bi translated">log 是一个调用 android 登录函数的库，例如:<code class="fe mb mc md me b">__android_log_vprint</code></li></ul><p id="5edd" class="pw-post-body-paragraph kx ky in kz b la lw lc ld le lx lg lh li ly lk ll lm lz lo lp lq ma ls lt lu ig bi translated">如果你想让 SDL 和 D 在一起，在某个地方提到我，我会把它贴在这里！</p></div></div>    
</body>
</html>