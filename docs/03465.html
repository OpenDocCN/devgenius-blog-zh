<html>
<head>
<title>How to analyze and improve the size of your docker images?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何分析和改善你的 docker 图片的尺寸？</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/how-to-analyze-and-improve-the-size-of-your-docker-images-54effa56f488?source=collection_archive---------0-----------------------#2020-11-08">https://blog.devgenius.io/how-to-analyze-and-improve-the-size-of-your-docker-images-54effa56f488?source=collection_archive---------0-----------------------#2020-11-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="c71b" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">了解如何提高 Docker 图像的大小，以便在您的组织内获得更好的体验并节省成本。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/67e05c17538abf520e3e27eb0b6d7903.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3oWr1k2Kg_Sox2l-"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">查尔斯·德鲁维奥在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="fb62" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">集装箱化是新的常态。我们都知道这一点。公司软件的所有新版本和所有开源项目都包含了使用 docker 映像运行软件的选项。</p><p id="c3dc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">或许你已经在基于你自己构建的 docker 映像进行测试，甚至在生产工作负载中运行了。如果是这样的话，你可能知道当你在做这种工作时最大的挑战之一:<em class="ls">如何优化你生成的图像的尺寸？</em></p><p id="efb0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">docker 图像如此之大的主要原因之一是因为它们是按照分层概念构建的。这意味着每个图像都是作为层的添加而创建的，每个层都与 docker 文件中的不同命令相关联。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi lt"><img src="../Images/00d9455f736c36fbda2cf722734a7731.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tHqHBDRUbKe-b1ETbz-drw.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">Docker 图像如何合成的图形说明。</figcaption></figure><h1 id="fba8" class="lu lv iq bd lw lx ly lz ma mb mc md me jw mf jx mg jz mh ka mi kc mj kd mk ml bi translated">使用 dive 分析图像的大小</h1><p id="e840" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated"><a class="ae kv" href="https://github.com/wagoodman/dive" rel="noopener ugc nofollow" target="_blank"> <em class="ls"> dive </em> </a>是一个开源项目，它提供了 docker 图像组成的详细视图。它是一个命令行界面应用程序，可以很好地查看图层的内容，如下图所示:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mr"><img src="../Images/78c037311bb5ac85557e345136636a67.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m3S4aW6NczgW9_0WrAMDeQ.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">BusinessWorks 容器版映像的执行</figcaption></figure><p id="9cc7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">该工具遵循 n-curses 接口(如果你还记得在图形用户界面出现之前工具是怎样的；看起来应该很熟悉)并且具有以下主要特征:</p><ul class=""><li id="b0bf" class="ms mt iq ky b kz la lc ld lf mu lj mv ln mw lr mx my mz na bi translated">该工具将在屏幕的左上角提供图层列表以及与每个图层相关的大小。</li><li id="92a3" class="ms mt iq ky b kz nb lc nc lf nd lj ne ln nf lr mx my mz na bi translated">提供有关图像效率(百分比值)的常规统计数据、浪费大小的潜在视图以及图像的总大小。</li><li id="0d7a" class="ms mt iq ky b kz nb lc nc lf nd lj ne ln nf lr mx my mz na bi translated">对于所选的每个层，您可以在文件系统上获得该视图的视图，其中包含每个文件夹大小的数据。</li><li id="77d4" class="ms mt iq ky b kz nb lc nc lf nd lj ne ln nf lr mx my mz na bi translated">此外，还要查看更大的元素以及这些对象的复制数量。</li></ul><p id="768b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，您有了一个工具，它将首先帮助您了解映像是如何构建的，并获得您为改进该大小所做的每项调整的性能数据。所以，我们先从招数说起。</p><h1 id="cb0b" class="lu lv iq bd lw lx ly lz ma mb mc md me jw mf jx mg jz mh ka mi kc mj kd mk ml bi translated">1.-清洁你的形象！</h1><p id="c480" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">这是显而易见的，但这并不意味着它不重要。通常，当您创建 Docker 映像时，您遵循相同的模式:</p><ul class=""><li id="8698" class="ms mt iq ky b kz la lc ld lf mu lj mv ln mw lr mx my mz na bi translated">您声明了一个可以利用的基本映像。</li><li id="bed3" class="ms mt iq ky b kz nb lc nc lf nd lj ne ln nf lr mx my mz na bi translated">您添加资源来完成一些工作。</li><li id="7965" class="ms mt iq ky b kz nb lc nc lf nd lj ne ln nf lr mx my mz na bi translated">你做一些工作。</li></ul><p id="e8cb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">通常，我们会忘记一个额外的步骤:当不再需要时，清理添加的资源！因此，确保删除我们不再需要的每个文件是很重要的。</p><p id="e5df" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这也适用于其他组件，如 apt 缓存，当我们安装我们需要的新包或任何临时文件夹时，我们需要执行安装或构建映像的一些工作。</p><h1 id="551b" class="lu lv iq bd lw lx ly lz ma mb mc md me jw mf jx mg jz mh ka mi kc mj kd mk ml bi translated">2.-注意创建 docker 文件的方式</h1><p id="ff5f" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">正如我们已经提到的，我们在 docker 文件中声明的每个命令都会生成一个新层。因此，非常小心 docker 文件中的行是很重要的。即使这是对 docker 文件可读性的一种折衷，尝试在同一个 RUN 原语中合并命令以确保我们不会创建额外的层也是很重要的。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ng"><img src="../Images/83b5281b46f703e1593f743e8e062322.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YnsrQCBi6KOcghbNAq5DBg.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">带有合并命令的 docker 文件示例</figcaption></figure><p id="4fe4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您还可以使用 Docker linters，如<a class="ae kv" href="https://github.com/hadolint/hadolint" rel="noopener ugc nofollow" target="_blank"> Hadolint </a>，这将有助于您解决这个问题以及其他在创建 Docker 文件时应该避免的反模式。</p><h1 id="f0a4" class="lu lv iq bd lw lx ly lz ma mb mc md me jw mf jx mg jz mh ka mi kc mj kd mk ml bi translated">3.-去码头建造-壁球</h1><p id="f455" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">Docker 引擎的最新版本提供了一个新的选项，当您构建映像时，可以使用中间层的最小尺寸<em class="ls">挤压</em>进行创建，这可以作为 Docker 文件创建过程的一部分来创建。</p><p id="ff82" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这很有效，当你在构建你的图像时提供了一个新的标志。所以，与其这样做:</p><pre class="kg kh ki kj gt nh ni nj nk aw nl bi"><span id="bd0e" class="nm lv iq ni b gy nn no l np nq">docker build -t &lt;your-image-name&gt;:&lt;tag&gt; &lt;Dockerfile location&gt;</span></pre><p id="afb3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您应该使用一个附加标志:</p><pre class="kg kh ki kj gt nh ni nj nk aw nl bi"><span id="a565" class="nm lv iq ni b gy nn no l np nq">docker build --squash -t &lt;your-image-name&gt;:&lt;tag&gt; &lt;Dockerfile location&gt;</span></pre><p id="6dff" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了能够使用这个选项，您应该在 Docker 引擎上启用实验特性。为此，您需要在 daemon.json 文件中启用它并重启引擎。如果您使用的是 Docker for Windows 或 Docker for Mac，您可以使用如下所示的用户界面:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nr"><img src="../Images/21408de62bef61b4637af2808e47c713.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yZW_g8eOh4FH95ZrZwZvEg.png"/></div></div></figure><h1 id="0d7f" class="lu lv iq bd lw lx ly lz ma mb mc md me jw mf jx mg jz mh ka mi kc mj kd mk ml bi translated">摘要</h1><p id="1b21" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">这些调整将帮助您使 Docker 图像更薄，推拉过程更愉快，同时，甚至在您选择的存储库中存储图像方面节省一些资金。不仅仅是对你，也是对其他许多可以利用你正在做的工作的人。所以想想你自己，也想想社区。</p></div></div>    
</body>
</html>