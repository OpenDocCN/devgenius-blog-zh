<html>
<head>
<title>PySpark — Setup Delta Lake</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">PySpark —设置三角洲湖</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/pyspark-setup-delta-lake-971e2e37330d?source=collection_archive---------3-----------------------#2022-11-14">https://blog.devgenius.io/pyspark-setup-delta-lake-971e2e37330d?source=collection_archive---------3-----------------------#2022-11-14</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="ed1d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">三角洲湖是目前围绕大数据领域的热门话题之一。它在数据湖的可靠性方面带来了很多改进。但是为什么它会获得如此多的关注呢？</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/403d163379a214973c07b5e59c5c3ab7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8S9-AtfyFrsnPnDKXLO2dg.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">代表图像(鸣谢:delta.io)</figcaption></figure><p id="bb91" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">根据 Delta IO 文档—“<em class="ky">Delta Lake 是一个开源项目，支持在数据湖之上构建湖屋架构。Delta Lake 提供 ACID 事务、可扩展的元数据处理，并在现有数据湖(如 S3、ADLS、GCS 和 HDFS </em>)的基础上统一流式和批量数据处理。</p><p id="2344" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">有这么多与三角洲湖相关的重要特征，查看下面的图片</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi kz"><img src="../Images/bc28d27f1832c24c83ce8a1a1bd25f60.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9hUBzHbPXXQLe8xCiuZ0Pg.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">主要功能(学分:delta.io)</figcaption></figure><p id="0b9e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">今天，我们将使用 PySpark 设置 delta lake，并为我们的 metastore 启用相同的功能。</p><p id="b94c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">为了让 PySpark 支持 Delta Lake，我们需要将 delta-core jar 导入 SparkSession 并正确设置配置。</p><pre class="kj kk kl km gt la lb lc bn ld le bi"><span id="feca" class="lf lg in lb b be lh li l lj lk"><strong class="lb io"># Create Spark Session with Delta JARS and conf</strong><br/><br/>from pyspark.sql import SparkSession<br/><br/>spark = SparkSession \<br/>    .builder \<br/>    .appName("Delta with PySpark") \<br/>    .config('spark.jars.packages', 'io.delta:delta-core_2.12:2.1.1') \<br/>    .config("spark.sql.extensions", "io.delta.sql.DeltaSparkSessionExtension") \<br/>    .config(<br/>        "spark.sql.catalog.spark_catalog",<br/>        "org.apache.spark.sql.delta.catalog.DeltaCatalog",<br/>    ) \<br/>    .config("spark.sql.warehouse.dir", "spark-warehouse") \<br/>    .master("local[*]") \<br/>    .enableHiveSupport() \<br/>    .getOrCreate()<br/><br/>spark</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ll"><img src="../Images/c4d8963748fe14156b3de9ad5a2a2b88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bEbKlO8HsUJ-NPu4QZJRmA.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">生成 SparkSession</figcaption></figure><blockquote class="lm ln lo"><p id="3a6c" class="jk jl ky jm b jn jo jp jq jr js jt ju lp jw jx jy lq ka kb kc lr ke kf kg kh ig bi translated">确保启用持久化 metastore。查看我以前的博客，在同一个——<a class="ae ls" href="https://urlit.me/blog/pyspark-implementing-persisting-metastore/" rel="noopener ugc nofollow" target="_blank">https://urlit . me/blog/py spark-implementing-persisting-metastore/</a></p></blockquote><p id="c8d9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在，我们准备与三角洲湖合作。为了创建我们的第一个增量表，让我们读取销售拼花数据。</p><pre class="kj kk kl km gt la lb lc bn ld le bi"><span id="90c3" class="lf lg in lb b be lh li l lj lk"><strong class="lb io"># Lets read our Sales dataset</strong><br/><br/>df_sales = spark.read.parquet("dataset/sales.parquet/*parquet")<br/>df_sales.printSchema()<br/>df_sales.show(10, False)</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lt"><img src="../Images/841d2fd4ef3e5381f34f4b11e0d894ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xM9dnLriMYShuQcJ1CLTMQ.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">销售数据集</figcaption></figure><p id="3bf9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在，我们将这些数据转换并写成增量表。</p><pre class="kj kk kl km gt la lb lc bn ld le bi"><span id="29d5" class="lf lg in lb b be lh li l lj lk"><strong class="lb io"># Lets create a sales managed delta table</strong><br/>from pyspark.sql.functions import to_timestamp, expr<br/><br/>df_formatted = (<br/>    df_sales<br/>    .withColumn("transacted_at", to_timestamp("transacted_at"))<br/>    .withColumn("amount", expr("CAST(amount as decimal(14,2))"))<br/>               )<br/>    <br/>df_formatted.write \<br/>    .format("delta") \<br/>    .mode("overwrite") \<br/>    .option("mergeSchema", True) \<br/>    .saveAsTable("sales_delta_managed")</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi lu"><img src="../Images/72fd63872131c06719a30b600d0f60d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1134/format:webp/1*cyXobLMgyRlldCczpw9SVQ.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">销售增量表</figcaption></figure><p id="2dfc" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">由于我们没有指定任何外部位置，默认情况下，它将是一个内部管理的增量表。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lv"><img src="../Images/bf35e8023d14c2a0dbda6ce39c3b9fef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AYftKgd1tG7RUnLNOZQ6rA.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">表格定义</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lw"><img src="../Images/fd5ee8d9bba88e8ec6a37aedb401019d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*st7pgDrbbMxfqKF2e8do6g.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">列表数据</figcaption></figure><p id="7e14" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">因为，增量表支持版本控制</p><pre class="kj kk kl km gt la lb lc bn ld le bi"><span id="72e0" class="lf lg in lb b be lh li l lj lk"><strong class="lb io"># Lets check the current version of the table</strong><br/><br/>from delta import DeltaTable<br/><br/>dt = DeltaTable.forName(spark, "sales_delta_managed")<br/>dt.history().select("version", "timestamp").show(truncate=False)</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi lx"><img src="../Images/d7960b21be03a44425da7a7d21c0130a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1130/format:webp/1*Mkli3ORWHfPhKr7z_DVxdw.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">增量表版本控制</figcaption></figure><p id="8880" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让我们更新一个记录来查看版本控制中的变化</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ly"><img src="../Images/55027581f13bb9f7fcab015675cf4aad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*leGqTN5Ei2wtlX2nEOoKUQ.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">ACID 事务支持</figcaption></figure><p id="a074" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">记录更新没有任何麻烦(<em class="ky">三角洲湖支持 DML 操作</em>)</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lw"><img src="../Images/ccec2aeb78cb6ae03a5f698db5dcee71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YaV1-QtlLxQlmBObvO2hMA.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">记录已更新</figcaption></figure><p id="545d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">版本控制的变化</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi lz"><img src="../Images/9a2f5bb7d29b35a189aa4c58fd51d398.png" data-original-src="https://miro.medium.com/v2/resize:fit:1120/format:webp/1*1PtI8tPLwJoODgbYPpmu7g.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">DML 操作后版本更新</figcaption></figure><p id="a528" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让我们验证给定的表位置是否是增量表</p><pre class="kj kk kl km gt la lb lc bn ld le bi"><span id="a966" class="lf lg in lb b be lh li l lj lk"><strong class="lb io"># Verify if a given table is Delta</strong><br/><br/>print(DeltaTable.isDeltaTable(spark, "spark-warehouse/sales_managed/"))<br/>print(DeltaTable.isDeltaTable(spark, "spark-warehouse/sales_delta_managed/"))</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ma"><img src="../Images/319db323974cf811e3a200af3e3e8467.png" data-original-src="https://miro.medium.com/v2/resize:fit:1322/format:webp/1*JNDZCx4bmcrp5jRNziq4pw.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">验证增量表</figcaption></figure><p id="ef41" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">奖励:将拼花数据转换为 delta 的快捷方式</strong></p><pre class="kj kk kl km gt la lb lc bn ld le bi"><span id="d7ca" class="lf lg in lb b be lh li l lj lk"><strong class="lb io"># Shortcut to create a Parquet location to delta table<br/># We will convert the sales_managed table to delta</strong><br/><br/>DeltaTable.convertToDelta(spark, "parquet.`spark-warehouse/sales_managed`")</span></pre><p id="37d5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">验证位置是否转换为增量</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mb"><img src="../Images/2d2a3f993533a83603cc29a8a3d21517.png" data-original-src="https://miro.medium.com/v2/resize:fit:1304/format:webp/1*mgKXc70awgVW_ZUgcq-zrQ.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">确认</figcaption></figure><p id="ed02" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">但是，如果我们检查 Catalog 中的元数据，它仍然是一个 hive 表。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lv"><img src="../Images/28658648159462a3a4435b4af5436db1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*agH8ChFcHW3S9YEnLZVzpw.png"/></div></div></figure><p id="9751" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">所以，也要转换元数据</p><pre class="kj kk kl km gt la lb lc bn ld le bi"><span id="2539" class="lf lg in lb b be lh li l mc lk">%%sparksql<br/><br/>CONVERT TO DELTA default.sales_managed;</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi md"><img src="../Images/21c3d038cab0adf09b890eaedabb8c4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G9f2K7s-I6LIlV1yuq4yPg.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">转换为增量的表格</figcaption></figure><p id="83a3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们将在接下来的博客中涉及更多的三角洲湖概念。</p><p id="199c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在 Github 上查看 iPython 笔记本—<a class="ae ls" href="https://github.com/subhamkharwal/ease-with-apache-spark/blob/master/27_delta_with_pyspark.ipynb" rel="noopener ugc nofollow" target="_blank">https://Github . com/subhamkharwal/ease-with-Apache-spark/blob/master/27 _ delta _ with _ py spark . ipynb</a></p><p id="16bb" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">查看我的个人博客—<a class="ae ls" href="https://urlit.me/blog/" rel="noopener ugc nofollow" target="_blank">https://urlit.me/blog/</a></p><p id="4244" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">查看 PySpark Medium 系列—<a class="ae ls" href="https://subhamkharwal.medium.com/learnbigdata101-spark-series-940160ff4d30" rel="noopener">https://subhamkharwal . Medium . com/learn bigdata 101-spark-Series-940160 ff4d 30</a></p></div></div>    
</body>
</html>