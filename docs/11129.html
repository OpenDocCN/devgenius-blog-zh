<html>
<head>
<title>FinOps — Use Kubecost to Quantify K8S Usage Cost</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">FinOps —使用 Kubecost 量化 K8S 使用成本</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/finops-use-kubecost-to-quantify-k8s-usage-cost-919699d12c4d?source=collection_archive---------5-----------------------#2022-12-20">https://blog.devgenius.io/finops-use-kubecost-to-quantify-k8s-usage-cost-919699d12c4d?source=collection_archive---------5-----------------------#2022-12-20</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><div class=""/><div class=""><h2 id="e79a" class="pw-subtitle-paragraph jo iq ir bd b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dk translated">监控和管理 K8s 集群成本</h2></div><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div class="gi gj kg"><img src="../Images/5e9d3de0d797fa708dbad5171ac7da56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1396/format:webp/1*gez5u-NHDq3La8PgQq0aEg.png"/></div></figure><p id="aac3" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">在云时代，我们已经看到 K8s 被广泛用作容器编排平台。随之而来的是操作 K8s 集群的不同方式。</p><p id="a61d" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">一些企业更喜欢有一个租户的集群(硬多租户)，而另一些企业更喜欢有多个租户的集群(软多租户)模型。</p><p id="ddbb" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">许多企业采用了多租户模式，因为它节省了大量运营工作。对于软多租户模型，明智地提供对成本分配租户的可见性非常重要，以便组织可以相应地收费。</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gi gj lk"><img src="../Images/412f5cbb7d9adab9af737f52f380b405.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*BWkm_6LrlKIvYDHf"/></div></div><figcaption class="lp lq gk gi gj lr ls bd b be z dk translated">图片来自 vamsitalkstech.com</figcaption></figure><h1 id="53a4" class="lu lv ir bd lw lx ly lz ma mb mc md me jx mf jy mg ka mh kb mi kd mj ke mk ml bi translated">Kubecost</h1><p id="e30a" class="pw-post-body-paragraph ko kp ir kq b kr mm js kt ku mn jv kw kx mo kz la lb mp ld le lf mq lh li lj ik bi translated"><a class="ae lt" href="https://www.kubecost.com/" rel="noopener ugc nofollow" target="_blank"> Kubecost </a>帮助您监控和管理 K8s 环境中的成本和容量。它为使用 Kubernetes 的团队提供实时成本可见性和洞察力，帮助您不断降低云成本。</p><p id="de32" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">Kubecost 既有开源产品，也有商业产品。这个商业产品有少量附加功能，如用户身份验证、报告保存、企业支持和更长的指标保留期。</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div class="gi gj mr"><img src="../Images/e218731dc40cf19155f352899e6b7772.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fgmFBSMmxGM3FablN3XcTg.png"/></div></figure><h1 id="b148" class="lu lv ir bd lw lx ly lz ma mb mc md me jx mf jy mg ka mh kb mi kd mj ke mk ml bi translated">Kubecost 功能</h1><p id="2eff" class="pw-post-body-paragraph ko kp ir kq b kr mm js kt ku mn jv kw kx mo kz la lb mp ld le lf mq lh li lj ik bi translated">Kubecost 标准版为使用 K8s 的团队提供实时成本可见性和洞察力，帮助您持续降低云成本。</p><ul class=""><li id="c14c" class="ms mt ir kq b kr ks ku kv kx mu lb mv lf mw lj mx my mz na bi translated"><strong class="kq is">成本分配:</strong>灵活、可定制的成本细分和资源分配，可实现准确的反馈、退款和持续监控</li><li id="dd63" class="ms mt ir kq b kr nb ku nc kx nd lb ne lf nf lj mx my mz na bi translated"><strong class="kq is">统一成本监控:</strong>通过全面的云服务计费集成，在一个地方查看您所有的 k8 和集群外支出</li><li id="a49a" class="ms mt ir kq b kr nb ku nc kx nd lb ne lf nf lj mx my mz na bi translated"><strong class="kq is">优化洞察:</strong>根据您自己的环境和行为模式获得定制建议</li><li id="7df4" class="ms mt ir kq b kr nb ku nc kx nd lb ne lf nf lj mx my mz na bi translated"><strong class="kq is">警报&amp;治理:</strong>通过可定制的警报、可配置的可用性层和实时更新，实现最高的应用性能并提高可靠性</li><li id="4fae" class="ms mt ir kq b kr nb ku nc kx nd lb ne lf nf lj mx my mz na bi translated"><strong class="kq is">专门为运行 K8s 的团队构建:</strong>在 Kubernetes 上运行容器需要一种可视化和优化花费的新方法。Kubecost 完全是为 Kubernetes 和云原生生态系统而设计的</li><li id="4921" class="ms mt ir kq b kr nb ku nc kx nd lb ne lf nf lj mx my mz na bi translated"><strong class="kq is">拥有&amp;控制您自己的所有数据:</strong> Kubecost 完全部署在您的基础设施中，我们不要求您将任何数据输出到远程服务。对我们来说，用户能够保留和控制对自己私人信息的访问非常重要，例如敏感的云支出数据。</li></ul><h1 id="ed55" class="lu lv ir bd lw lx ly lz ma mb mc md me jx mf jy mg ka mh kb mi kd mj ke mk ml bi translated">支持的云提供商</h1><h2 id="dfc8" class="ng lv ir bd lw nh ni dn ma nj nk dp me kx nl nm mg lb nn no mi lf np nq mk nr bi translated">自动警报系统</h2><ul class=""><li id="db99" class="ms mt ir kq b kr mm ku mn kx ns lb nt lf nu lj mx my mz na bi translated">支持所有地区，如<a class="ae lt" href="https://github.com/opencost/opencost/blob/0c2f063052723a65ca62a4c75be23392806b6fac/pkg/cloud/awsprovider.go#L111" rel="noopener ugc nofollow" target="_blank">open cost/pkg/cloud/AWS provider . go</a>所示</li><li id="4737" class="ms mt ir kq b kr nb ku nc kx nd lb ne lf nf lj mx my mz na bi translated">x86，ARM</li></ul><h2 id="e684" class="ng lv ir bd lw nh ni dn ma nj nk dp me kx nl nm mg lb nn no mi lf np nq mk nr bi translated">GCP</h2><ul class=""><li id="6402" class="ms mt ir kq b kr mm ku mn kx ns lb nt lf nu lj mx my mz na bi translated">支持所有地区，如<a class="ae lt" href="https://github.com/opencost/opencost/blob/0c2f063052723a65ca62a4c75be23392806b6fac/pkg/cloud/gcpprovider.go#L41" rel="noopener ugc nofollow" target="_blank">open cost/pkg/cloud/GCP provider . go</a>所示</li><li id="ba24" class="ms mt ir kq b kr nb ku nc kx nd lb ne lf nf lj mx my mz na bi translated">x86</li></ul><h2 id="bbf5" class="ng lv ir bd lw nh ni dn ma nj nk dp me kx nl nm mg lb nn no mi lf np nq mk nr bi translated">蔚蓝的</h2><ul class=""><li id="e389" class="ms mt ir kq b kr mm ku mn kx ns lb nt lf nu lj mx my mz na bi translated">支持所有地区，如<a class="ae lt" href="https://github.com/opencost/opencost/blob/0c2f063052723a65ca62a4c75be23392806b6fac/pkg/cloud/azureprovider.go#L82" rel="noopener ugc nofollow" target="_blank">open cost/pkg/cloud/azure provider . go</a>所示</li><li id="462f" class="ms mt ir kq b kr nb ku nc kx nd lb ne lf nf lj mx my mz na bi translated">x86</li></ul><h1 id="b97f" class="lu lv ir bd lw lx ly lz ma mb mc md me jx mf jy mg ka mh kb mi kd mj ke mk ml bi translated">Kubecost 装置</h1><h2 id="643c" class="ng lv ir bd lw nh ni dn ma nj nk dp me kx nl nm mg lb nn no mi lf np nq mk nr bi translated">先决条件</h2><ul class=""><li id="fbbb" class="ms mt ir kq b kr mm ku mn kx ns lb nt lf nu lj mx my mz na bi translated">K8s v1.22 及以上版本(官方支持 1.22 版本)</li><li id="12b7" class="ms mt ir kq b kr nb ku nc kx nd lb ne lf nf lj mx my mz na bi translated">Helm3</li></ul><p id="145a" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">您可以使用 HELM3 安装<code class="fe nv nw nx ny b">kubecost</code>:</p><pre class="kh ki kj kk gu nz ny oa bn ob oc bi"><span id="74bb" class="od lv ir ny b be oe of l og oh">$ helm repo add kubecost https://kubecost.github.io/cost-analyzer/<br/>$ helm upgrade --install kubecost kubecost/cost-analyzer --namespace kubecost --create-namespace</span></pre><p id="1a8e" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">注意，如果您使用的是<code class="fe nv nw nx ny b">k8sv1.22+</code>，您可能需要从清单文件中安装它:</p><pre class="kh ki kj kk gu nz ny oa bn ob oc bi"><span id="9476" class="od lv ir ny b be oe of l og oh">$ kubectl create namespace kubecost<br/>$ curl -O https://raw.githubusercontent.com/kubecost/cost-analyzer-helm-chart/master/kubecost.yaml<br/># Update the YAML file accordingly, then<br/>$ kubectl apply -f kubecost.yaml --namespace kubecost --address 0.0.0.0</span></pre><p id="e6aa" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">确保所有 pod 都在<code class="fe nv nw nx ny b">kubecost</code>名称空间中运行:</p><pre class="kh ki kj kk gu nz ny oa bn ob oc bi"><span id="b0c2" class="od lv ir ny b be oe of l og oh">$ kubectl get pods -n kubecost<br/>NAME                                           READY   STATUS    RESTARTS   AGE<br/>kubecost-cost-analyzer-6598596b75-blq98        2/2     Running   0          39m<br/>kubecost-grafana-6f95f79d95-b7jhc              2/2     Running   0          39m<br/>kubecost-kube-state-metrics-75df9fd84f-5q5dn   1/1     Running   0          39m<br/>kubecost-prometheus-node-exporter-bm5t7        1/1     Running   0          21m<br/>kubecost-prometheus-node-exporter-sbxv5        1/1     Running   0          39m<br/>kubecost-prometheus-server-7f745bf6f4-cwzvw    2/2     Running   0          39m<br/><br/>$ kubectl port-forward -n kubecost svc/kubecost-cost-analyzer 9090:9090</span></pre><p id="38ac" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">你现在可以打开你的浏览器，指向<code class="fe nv nw nx ny b">http://&lt;ip_address&gt;:9090</code>来打开<code class="fe nv nw nx ny b">Kubecost</code>界面。在<code class="fe nv nw nx ny b">Kubecost</code>界面，选择一个集群查看成本分配信息。</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gi gj oi"><img src="../Images/67e638997d6be2870b934df9fbb6da46.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dgHOSJhCiKzoBjWIszAdVg.png"/></div></div></figure><p id="4711" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">您还可以选择左侧的“分配”来深入查看资源的名称空间开销。分配显示了 CPU、内存、持久卷和网络的成本。<code class="fe nv nw nx ny b">Kubecost</code>从 Azure pricing 获取数据，但您也可以为资源设置自定义成本。</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gi gj oj"><img src="../Images/ba2a6ef60c5a9bdc77fe9c7ba4e38691.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vy0nJGHV84ZnIBWRmrAabg.png"/></div></div></figure><p id="8beb" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">您可以使用“日期范围”按日期过滤显示数据:</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gi gj ok"><img src="../Images/be9a393d2661f6a1b196476086ef9171.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-p_B86-J1a66frsZzHLqrA.png"/></div></div></figure><p id="c419" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">选择左侧的“节约”，深入了解未充分利用的资源的成本节约情况。Savings 提供关于未充分利用的节点、单元和放弃的资源的信息，并识别群集中过度调配的资源请求。下面的屏幕截图显示了一个示例节省概述:</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gi gj ol"><img src="../Images/b47177deb2004575a76dcdef021ef6c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9KATRWCVHmIH3-FVeZNkvQ.png"/></div></div></figure><p id="5477" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">选择左侧的“Health”查看集群运行状况:</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gi gj om"><img src="../Images/4e37fdb8e4f4433483fe7123ffa861c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CymBvmEdJWwpnECwgv6Tyg.png"/></div></div></figure><h1 id="5930" class="lu lv ir bd lw lx ly lz ma mb mc md me jx mf jy mg ka mh kb mi kd mj ke mk ml bi translated">结论</h1><p id="cc1e" class="pw-post-body-paragraph ko kp ir kq b kr mm js kt ku mn jv kw kx mo kz la lb mp ld le lf mq lh li lj ik bi translated">Kubecost 中还有许多其他功能尚未使用，我认为一篇文章无法涵盖所有功能。一些值得研究的特性，比如 Slack 上的通知和电子邮件。</p><p id="038b" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">您可以为名称空间设置成本阈值，并在任何名称空间超出预算时得到提醒。如果您使用 Spot 实例，您可以集成 Spot 配置文件以获得正确的定价详细信息。有关 Kubecost 的更多详细信息，请访问<a class="ae lt" href="https://www.kubecost.com/" rel="noopener ugc nofollow" target="_blank">https://www.kubecost.com/</a></p></div></div>    
</body>
</html>