<html>
<head>
<title>Server-Side Development with Fastify — Route Level Hooks and Decorators</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Fastify 进行服务器端开发——路由级挂钩和装饰器</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/server-side-development-with-fastify-route-level-hooks-and-decorators-226f283c64fb?source=collection_archive---------1-----------------------#2021-02-19">https://blog.devgenius.io/server-side-development-with-fastify-route-level-hooks-and-decorators-226f283c64fb?source=collection_archive---------1-----------------------#2021-02-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/eefa90f291265090de7f6f2c9bdb75c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*C94kdRl4RlyM_PHL"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">安德斯·吉尔登在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="81a2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Fastify 是一个用于开发后端 web 应用程序的小型节点框架。</p><p id="af85" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将了解如何使用 Fastify 创建后端应用程序。</p><h1 id="e326" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">路由级别挂钩</h1><p id="ddbe" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以在路由级别添加挂钩。</p><p id="f948" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为此，我们可以写:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="948c" class="mn lc iq mj b gy mo mp l mq mr">const fastify = require('fastify')({})</span><span id="9b6a" class="mn lc iq mj b gy ms mp l mq mr">fastify.route({<br/>  method: 'GET',<br/>  url: '/',<br/>  schema: { },<br/>  onRequest (request, reply, done) {<br/>    done()<br/>  },<br/>  onResponse (request, reply, done) {<br/>    done()<br/>  },<br/>  preParsing (request, reply, done) {<br/>    done()<br/>  },<br/>  preValidation (request, reply, done) {<br/>    done()<br/>  },<br/>  preHandler (request, reply, done) {<br/>    done()<br/>  },<br/>  preSerialization (request, reply, payload, done) {<br/>    done(null, payload)<br/>  },<br/>  handler (request, reply) {<br/>    reply.send({ hello: 'world' })<br/>  }<br/>})</span><span id="49da" class="mn lc iq mj b gy ms mp l mq mr">const start = async () =&gt; {<br/>  try {<br/>    await fastify.listen(3000, '0.0.0.0')<br/>  } catch (err) {<br/>    fastify.log.error(err)<br/>    process.exit(1)<br/>  }<br/>}<br/>start()</span></pre><p id="b5b6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">加上钩子。</p><p id="6eab" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">收到请求时运行<code class="fe mt mu mv mj b">onRequest</code>。</p><p id="c294" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">发送响应时运行<code class="fe mt mu mv mj b">onResponse</code>。</p><p id="6ccc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mt mu mv mj b">preParsing</code>在解析请求时运行。</p><p id="bfa8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mt mu mv mj b">preValidation</code>在对请求进行验证之前运行。</p><p id="46fa" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mt mu mv mj b">preHandler</code>是共享<code class="fe mt mu mv mj b">preHandler</code>钩子后运行的。</p><p id="8ca2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mt mu mv mj b">preSerialization</code>在共享的<code class="fe mt mu mv mj b">preSerialization</code>钩子之后运行，该钩子在响应被序列化之后运行。</p><p id="bb60" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mt mu mv mj b">handler</code>是路由处理程序方法。</p><h1 id="107d" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">装修工</h1><p id="efc9" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以使用 decorators 定制核心 Fastify 对象，比如请求和回复对象。</p><p id="3ebd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要添加一个并使用它们，我们可以写:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="b95e" class="mn lc iq mj b gy mo mp l mq mr">const fastify = require('fastify')({})</span><span id="1362" class="mn lc iq mj b gy ms mp l mq mr">fastify.decorateRequest('user', '')</span><span id="bdff" class="mn lc iq mj b gy ms mp l mq mr">fastify.addHook('preHandler', (req, reply, done) =&gt; {<br/>  req.user = 'jane smith'<br/>  done()<br/>})</span><span id="4bdd" class="mn lc iq mj b gy ms mp l mq mr">fastify.get('/', (req, reply) =&gt; {<br/>  reply.send(`Hello, ${req.user}!`)<br/>})<br/>const start = async () =&gt; {<br/>  try {<br/>    await fastify.listen(3000, '0.0.0.0')<br/>  } catch (err) {<br/>    fastify.log.error(err)<br/>    process.exit(1)<br/>  }<br/>}<br/>start()</span></pre><p id="e1e2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们调用<code class="fe mt mu mv mj b">fastify.decoratorRequest</code>方法来添加一个<code class="fe mt mu mv mj b">user</code>属性到<code class="fe mt mu mv mj b">req</code>对象。</p><p id="ca70" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们将<code class="fe mt mu mv mj b">preHandler</code>钩子中的<code class="fe mt mu mv mj b">req.user</code>属性设置为<code class="fe mt mu mv mj b">'jane smith'</code>。</p><p id="282b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后在我们的路由处理器中，我们可以访问这个值。</p><p id="ebfd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此，我们得到:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="5a68" class="mn lc iq mj b gy mo mp l mq mr">Hello, jane smith!</span></pre><p id="3b36" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">作为响应返回。</p><p id="284b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以使用<code class="fe mt mu mv mj b">fastify.decorate</code>方法来修饰 Fastify 服务器实例。</p><p id="49b8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="35ba" class="mn lc iq mj b gy mo mp l mq mr">const fastify = require('fastify')({})</span><span id="f35a" class="mn lc iq mj b gy ms mp l mq mr">fastify.decorate('conf', {<br/>  db: 'some.db',<br/>  port: 3000<br/>})</span><span id="3793" class="mn lc iq mj b gy ms mp l mq mr">fastify.get('/', (req, reply) =&gt; {  <br/>  reply.send(`Hello ${fastify.conf.db}`)<br/>})<br/>const start = async () =&gt; {<br/>  try {<br/>    await fastify.listen(3000, '0.0.0.0')<br/>  } catch (err) {<br/>    fastify.log.error(err)<br/>    process.exit(1)<br/>  }<br/>}<br/>start()</span></pre><p id="b7a6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">向<code class="fe mt mu mv mj b">fastify</code>对象添加数据。</p><p id="5ab5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们给它添加了<code class="fe mt mu mv mj b">conf</code>属性。</p><p id="4bf9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，我们可以在应用程序的任何地方访问该值。</p><p id="ba4d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所以我们应该得到:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="10d3" class="mn lc iq mj b gy mo mp l mq mr">Hello some.db</span></pre><p id="ac68" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">从回应来看。</p><p id="d086" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">修饰过的 Fastify 服务器也可以通过路由处理程序中的<code class="fe mt mu mv mj b">this</code>关键字来访问。</p><p id="334e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="d69b" class="mn lc iq mj b gy mo mp l mq mr">const fastify = require('fastify')({})</span><span id="2631" class="mn lc iq mj b gy ms mp l mq mr">fastify.decorate('conf', {<br/>  db: 'some.db',<br/>  port: 3000<br/>})</span><span id="fab1" class="mn lc iq mj b gy ms mp l mq mr">fastify.get('/', async function (request, reply) {<br/>  reply.send({hello: this.conf.db})<br/>})</span><span id="c233" class="mn lc iq mj b gy ms mp l mq mr">const start = async () =&gt; {<br/>  try {<br/>    await fastify.listen(3000, '0.0.0.0')<br/>  } catch (err) {<br/>    fastify.log.error(err)<br/>    process.exit(1)<br/>  }<br/>}<br/>start()</span></pre><p id="099e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们得到:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="dc5e" class="mn lc iq mj b gy mo mp l mq mr">{"hello":"some.db"}</span></pre><p id="2584" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">从回应来看。</p><h1 id="9c63" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="4ba2" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以用 Fastify decorators 向 Fastify 实例或请求添加数据。</p><p id="5fd3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，我们可以在路由级别添加挂钩。</p></div></div>    
</body>
</html>