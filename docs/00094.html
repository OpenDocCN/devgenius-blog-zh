<html>
<head>
<title>Demystifying PIVOT Command— SQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">揭开透视命令的神秘面纱— SQL</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/demystifying-pivot-command-sql-bed3ba1bdd02?source=collection_archive---------0-----------------------#2019-11-30">https://blog.devgenius.io/demystifying-pivot-command-sql-bed3ba1bdd02?source=collection_archive---------0-----------------------#2019-11-30</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><div class=""/><figure class="gm go jp jq jr js gi gj paragraph-image"><div class="gi gj jo"><img src="../Images/ddfac79e312d7dcbf42ace92efdf87f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:490/0*YPOfTHl7FZ-9-fqq.gif"/></div></figure><p id="9f94" class="pw-post-body-paragraph jv jw ir jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ik bi translated">尽管我已经写SQL查询好几年了，但是在我的SQL查询中使用PIVOT仍然是一件很痛苦的事情。在我的职业生涯中，还没有哪一次我能够在不花10-15分钟浏览不同样本的情况下编写一个数据透视表查询。“PIVOT”的概念很简单，但是它的查询结构让我很困惑。</p><p id="d123" class="pw-post-body-paragraph jv jw ir jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ik bi translated">是时候结束这种痛苦了。在本文中，我采用了一个用例，然后按照PIVOT查询的模板来分解每个部分。希望这能帮助那些和我有相似经历的人。</p><p id="42bb" class="pw-post-body-paragraph jv jw ir jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ik bi translated">在本例中，输入表由特定客户的交易历史组成。客户想要交易股票数量的简化视图。</p><figure class="ku kv kw kx gu js gi gj paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gi gj kt"><img src="../Images/830d1ba1515059ae9af290af9fb68063.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GgNTgkonNutdoHm4PMRajA.png"/></div></div></figure><p id="99b4" class="pw-post-body-paragraph jv jw ir jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ik bi translated">根据Microsoft文档，透视查询的语法如下:</p><pre class="ku kv kw kx gu lc ld le lf aw lg bi"><span id="6d33" class="lh li ir ld b gz lj lk l ll lm">SELECT &lt;non-pivoted column&gt;,  <br/>    [first pivoted column] AS &lt;column name&gt;,  <br/>    [second pivoted column] AS &lt;column name&gt;,  <br/>    ...  <br/>    [last pivoted column] AS &lt;column name&gt;  <br/>FROM  <br/>    (&lt;SELECT query that produces the data&gt;)   <br/>    AS &lt;alias for the source query&gt;  <br/>PIVOT  <br/>(  <br/>    &lt;aggregation function&gt;(&lt;column being aggregated&gt;)  <br/>FOR   <br/>[&lt;column that contains the values that will become column headers&gt;]   <br/>    IN ( [first pivoted column], [second pivoted column],  <br/>    ... [last pivoted column])  <br/>) AS &lt;alias for the pivot table&gt;  <br/>&lt;optional ORDER BY clause&gt;;</span></pre><p id="00b7" class="pw-post-body-paragraph jv jw ir jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ik bi translated">从上面的模板:让我们标记所有我们需要的不同值。</p><p id="a194" class="pw-post-body-paragraph jv jw ir jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ik bi translated"><strong class="jx is"> &lt;非透视列&gt; : </strong>交易类型</p><p id="7e95" class="pw-post-body-paragraph jv jw ir jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ik bi translated"><strong class="jx is">透视列:</strong>列StockName中的相关值。在我们的例子中，它将是all ([ABCD]、[DEFGH]、[IUSY]、[LISU])。因此[第一个旋转列]将是[ABCD]，[第二个旋转列]是[DEFG]，依此类推。</p><p id="e3ce" class="pw-post-body-paragraph jv jw ir jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ik bi translated"><strong class="jx is"> &lt;选择产生数据的查询&gt; : </strong>从#TransactionHistory中选择数量、库存名称、交易类型</p><p id="0d93" class="pw-post-body-paragraph jv jw ir jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ik bi translated"><strong class="jx is">聚合函数:</strong> SUM</p><p id="01a1" class="pw-post-body-paragraph jv jw ir jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ik bi translated"><strong class="jx is"> &lt;列被汇总&gt; : </strong>数量</p><p id="5845" class="pw-post-body-paragraph jv jw ir jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ik bi translated"><strong class="jx is"> &lt;包含将成为列标题的值的列&gt; : </strong>股票名称中的相关值</p><p id="a2e3" class="pw-post-body-paragraph jv jw ir jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ik bi translated">一旦确定了以下值，最终的查询将类似于</p><pre class="ku kv kw kx gu lc ld le lf aw lg bi"><span id="cce1" class="lh li ir ld b gz lj lk l ll lm">drop table #TransactionHistory</span><span id="b6f5" class="lh li ir ld b gz ln lk l ll lm">CREATE TABLE #TransactionHistory</span><span id="1393" class="lh li ir ld b gz ln lk l ll lm">(StockId int, StockName nvarchar(max), TransactionType nvarchar(max), Quantity int, CostPerUnit int)</span><span id="d3ad" class="lh li ir ld b gz ln lk l ll lm">;</span><span id="0bbb" class="lh li ir ld b gz ln lk l ll lm">INSERT INTO #TransactionHistory</span><span id="55c6" class="lh li ir ld b gz ln lk l ll lm">(StockId, StockName, TransactionType, Quantity, CostPerUnit)</span><span id="d1a0" class="lh li ir ld b gz ln lk l ll lm">VALUES</span><span id="65aa" class="lh li ir ld b gz ln lk l ll lm">(1, ‘ABCD’,’Buy’,12,25)</span><span id="f168" class="lh li ir ld b gz ln lk l ll lm">,(2,’DEFGH’, ‘Buy’,7,25)</span><span id="d6fb" class="lh li ir ld b gz ln lk l ll lm">,(3, ‘IUSY’,’Buy’,2,25)</span><span id="75bc" class="lh li ir ld b gz ln lk l ll lm">,(4, ‘LISU’,’Buy’,9,25)</span><span id="a397" class="lh li ir ld b gz ln lk l ll lm">,(1, ‘ABCD’, ‘Sell’,10,25)</span><span id="6b03" class="lh li ir ld b gz ln lk l ll lm">,(1, ‘ABCD’, ‘Buy’,76,25)</span><span id="073c" class="lh li ir ld b gz ln lk l ll lm">,(2,’DEFGH’, ‘Sell’,1,5)</span><span id="4fd0" class="lh li ir ld b gz ln lk l ll lm">,(3, ‘IUSY’,’Buy’,20,35)</span><span id="9d91" class="lh li ir ld b gz ln lk l ll lm">,(4, ‘LISU’,’Buy’,1,5)</span><span id="47b0" class="lh li ir ld b gz ln lk l ll lm">,(2, ‘DEFGH’,’Buy’,7,25)</span><span id="d67c" class="lh li ir ld b gz ln lk l ll lm">,(3, ‘IUSY’,’Sell’,2,95)</span><span id="1a36" class="lh li ir ld b gz ln lk l ll lm">,(4, ‘LISU’,’Buy’,9,25)</span><span id="1829" class="lh li ir ld b gz ln lk l ll lm">;</span><span id="7b89" class="lh li ir ld b gz ln lk l ll lm">select TransactionType, [ABCD],[DEFGH],[IUSY],[LISU] from (</span><span id="5c2d" class="lh li ir ld b gz ln lk l ll lm">select Quantity, StockName, TransactionType from #TransactionHistory) p</span><span id="6c30" class="lh li ir ld b gz ln lk l ll lm">pivot</span><span id="2df6" class="lh li ir ld b gz ln lk l ll lm">(</span><span id="ccc9" class="lh li ir ld b gz ln lk l ll lm">sum(Quantity)</span><span id="ec1f" class="lh li ir ld b gz ln lk l ll lm">for StockName in ([ABCD],[DEFGH],[IUSY],[LISU])</span><span id="69b9" class="lh li ir ld b gz ln lk l ll lm">) pp;</span></pre><p id="6947" class="pw-post-body-paragraph jv jw ir jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ik bi translated">希望这将结束我与PIVOT命令的斗争。如果没有，我把我的理解记录下来供参考。</p><p id="914f" class="pw-post-body-paragraph jv jw ir jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ik bi translated">谢谢</p><p id="1c71" class="pw-post-body-paragraph jv jw ir jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ik bi translated">塔伦</p></div><div class="ab cl lo lp hv lq" role="separator"><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt"/></div><div class="ik il im in io"><p id="d126" class="pw-post-body-paragraph jv jw ir jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ik bi translated">页（page的缩写）s-Medium是一个阅读、写作和向其他作者学习的绝佳平台。如果你想加入我的旅程，今天就加入<a class="ae lv" href="https://tarunbhatt9784.medium.com/membership" rel="noopener"> medium </a>。</p></div></div>    
</body>
</html>