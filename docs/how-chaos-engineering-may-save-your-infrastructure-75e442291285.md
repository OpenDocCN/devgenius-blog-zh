# 混沌工程如何拯救你的基础设施

> 原文：<https://blog.devgenius.io/how-chaos-engineering-may-save-your-infrastructure-75e442291285?source=collection_archive---------22----------------------->

## 一个小故事，关于你如何具体地把错误注入到一个正在运行的系统中——以及你将如何用它来改进你的系统。

![](img/a1dedf48812fcb790bc530c6f25be972.png)

肖恩·昂在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上的照片

Y 你可能已经开发了一个软件神器，你害怕后来被错误的开发者接触到。在你的项目或公司的整个系统中，可能有一个没人愿意支持或操作的组件。最有可能的是，你害怕你的系统会失败或失灵。你读书时点头了吗？然后坚持下去，阅读如何通过打破系统来建立更多的信心。

网飞、LinkedIn 和其他几十家公司已经做到了这一点:他们频繁而持续地破坏他们的系统，以使它们更有弹性。网飞的猿猴部队通过开发各种“猴子”向前迈进了一大步。你可以在网飞科技博客上读到。LinkedIn 还开发了几个工具，他们在各种文章中写道，例如在 infoQ journal 中。

![](img/9be667404a2baafe5a31f424c052da8c.png)

谈到混沌工程，网飞是一个真正的先驱。(照片由[自由库存](https://unsplash.com/@freestocks?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 拍摄)

当开发软件时，我们太害怕某些东西会坏掉。我们信任运营部门或专门负责架构、基础设施和日常运营的团队。那很好，团队会把它弄弯的。嗯，那就是它要爆炸的地方！

亚马逊网络服务公司的首席技术官沃纳·威格尔说得很恰当:**任何事情都会失败。如果我们看一下对我们系统的监控，我们就会明白他的意思:我们每天都在经历崩溃。豆荚在我们的 Kubernetes 集群中不断爆炸，但 Kubernetes 会小心翼翼地让它们再次启动，对吗？我们的数据库非常不稳定，我们会在每次有风险的交易之前对其进行完整的快照(这通常不是一件坏事)。就是这样，我们已经习惯了。**

> 现在是我们走出这种好天气发展的球池，并开始注意使我们的系统具有抵抗力的时候了！

进入混沌工程一点都不难。它的“hello world”就是简单地将一个组件推下悬崖。关机告诉我们系统的其余部分是否能够处理这种情况并继续正常运行。注意:我们所有的部件都是一次性的，我们不得不忍受它们的死亡。我们系统的其余部分必须优雅地处理它并继续运行——否则客户会跑掉。多年来，客户流失率一直牢牢地固定在我们的业务指标中，我们计算客户流失率，知道每一个流失的客户都会让我们波动。对于这样的失败来说，竞争实在太大了。

*如何让你的系统更加稳定？*首先，了解整个系统的当前状态。如果你已经有一个图形或类似的东西，这是相对容易的。如果没有，就做一个。你的团队、你的部门和所有相关人员都会感谢你的！在下一步中，您将列出哪些组件是关键的(第 1 层)，哪些是非关键的(第 2 层)。第 2 层组件将是我们首先试验的组件。你有测试环境吗？用它！你没有吗？戴上一个！没有人喜欢在生产环境中用沙坑铲砸城堡的人。

![](img/ca3a3badcfbf88aba3773fcc6abace05.png)

顺便说一下，这不是您希望您的代码看起来像什么。从来没有。永远不会。(照片由[马库斯·斯皮斯克](https://unsplash.com/@markusspiske?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄)

一旦你把你的沙箱放上，是时候开始考虑你想做什么测试了。我们已经在上面讨论了组件的简单关闭。以下是您应该挖掘的一些要点的简短列表:

关闭一个组件
暂停一个组件
导致网络延迟
导致通信丢包
CPU &内存过载
使系统时钟不同步
分叉炸弹

这些想法对你来说是不是听起来太简单了？想想你自己的实验。首先，您可以使用底部的实验描述模板。

顺便说一句，如果你不确定如何将错误注入到系统中，有一种补救方法。现在有大量的开源工具，例如“ **Chaos Toolkit** ”，使用它，您可以在本地系统上自动创建和进行实验，也可以在 Docker 和 Kubernetes 环境中进行。
还有很多其他工具，我个人喜欢用**【Pumba】**(基于 docker 的混沌)**【Kube-Monkey】**(基于 Kubernetes 的混沌)。但是不要让这阻止你写你自己的脚本。对于 CPU 压力和许多其他问题，有一些漂亮的 shell 脚本，您可以将其作为一个想法，注入到您的应用程序中。你有没有想过，如果你的数据库认为你的系统处于 *TZ 亚洲/平壤*时区，你的系统会有什么反应？:-)

最重要的是，为你的测试选择一个固定的目标是很重要的。无论是数据库、Docker 容器、虚拟机还是整个数据中心。这完全取决于你和你的要求。开始时，您应该将爆炸半径保持得非常小:确保组件故障不会造成伤害，不会导致数据丢失，并且易于重新滚动。(我有没有提到你不应该在开始的时候在 *prod* 上测试？)

认识到简单地破坏你的组件对任何人都没有帮助。如果你已经证明了他的服务是无用的和不稳定的，没有一个维护者会感谢你。因此，在实验过程中，从系统中分析一些有用的数据是很重要的。这些取决于你正在进行的实验，并不是每种类型的数据集都适合分析每个实验。

![](img/45a754539b1ed3e7425f3c2ef85c9dc9.png)

建立清晰易懂的监控。这可能是一些工作，但你的经理会感谢你的！(照片由[卢克·切瑟](https://unsplash.com/@lukechesser?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄)

在您确定了合适的系统和业务度量标准并可以监控它们之后，就该建立假设了。在实验过程中，我们可以期待系统会有什么样的表现？通常假设系统会继续正常运行。如果假设是系统崩溃或被自己绊倒，你对你的系统没有必要的信心。你预测假设中有错误吗？首先，在运行实验之前，注意不要出现这种错误。实验不是为了确认错误正在发生，而是为了确认系统能够处理错误。

一旦确定了目标，建立了假设，进行了实验，爆炸半径尽可能小，就该进行实验了。打开监控并执行操作。现场观看事件并记录出现的数据，它们将有助于以后的分析。

如果实验因结束、不得不取消或发生其他事件而结束，则分析开始。假设被证实了吗？如果没有，为什么没有？至少被测试组件的专家应该是团队初始分析的一部分。思考如何改进系统，以便在下一次运行中成功完成实验。这通常比预期的要容易。一个叉叉炸弹导致下面的 VM 说再见了吗？然后，您为组件定义一个它可以启动的固定数量的进程。该组件是否被证明是关键的，并且它一定不会因为系统不能再工作而崩溃吗？然后，您应该协商激活组件的高可用性，并采取其他预防措施。

现在你已经学会了如何识别你的目标，描述你的假设，执行一个行动，然后分析整个事情。你还在等什么？开始打破你的系统，让它更有弹性！

我有没有提到这里应该有一个混沌实验的小模板？

> **实验题目**
> 
> **1。简短描述**
> 
> **初始状态是什么？**
> 
> **正在采取什么行动？**
> 
> **这个动作的效果是什么？**
> 
> **2。假设**
> 
> **我们期望什么，系统将如何反应？**
> 
> **3。指标**
> 
> **我们从系统中提取什么数据来观察实验？**
> 
> **我们考虑哪些业务相关数据？**
> 
> **4。通知**
> 
> **在进行实验之前需要通知谁？**
> 
> **5。实施**
> 
> **我们如何开展行动？**
> 
> **实验需要多长时间？**
> 
> **6。分析**
> 
> **积累了哪些系统和业务数据？**
> 
> **我们从单个数据集中得出了什么结论？**
> 
> **7。缩放比例**
> 
> **我们如何更广泛地推广这项实验？**
> 
> **该实验还可以应用于其他哪些组件？**
> 
> **该实验已经应用于哪些其他组件？**
> 
> **8。自动化**
> 
> **实验如何实现自动化？**