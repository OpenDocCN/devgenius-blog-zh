<html>
<head>
<title>Terraform Resource Creation with dynamic variable in Azure DevOps</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在 Azure DevOps 中使用动态变量创建地形资源</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/terraform-resource-creation-with-dynamic-variable-in-azure-devops-dc23635e6653?source=collection_archive---------5-----------------------#2022-07-06">https://blog.devgenius.io/terraform-resource-creation-with-dynamic-variable-in-azure-devops-dc23635e6653?source=collection_archive---------5-----------------------#2022-07-06</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/785263a301ba62c7dd4c4fecaa14bcb7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*auvWlm9lZYEZR8uXY4LCJQ.jpeg"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">工作流程</figcaption></figure><p id="5344" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">在本文中，我将解释使用管道变量通过 Terraform 和 Azure DevOps 创建动态资源的过程。</p><p id="4768" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">我们将在 azure pipeline 中只创建一个阶段，使用特定于环境的变量为多个环境创建资源。</p><p id="3b71" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">先决条件:</strong></p><ol class=""><li id="29f4" class="kx ky in kb b kc kd kg kh kk kz ko la ks lb kw lc ld le lf bi translated">你有一个 Azure DevOps 项目</li><li id="5e45" class="kx ky in kb b kc lg kg lh kk li ko lj ks lk kw lc ld le lf bi translated">您拥有有效的 Azure 订阅</li><li id="09cc" class="kx ky in kb b kc lg kg lh kk li ko lj ks lk kw lc ld le lf bi translated">使用以下命令创建服务主体并保存信息</li></ol><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="873a" class="lu lv in lq b gy lw lx l ly lz">az ad sp create-for-rbac --name myServicePrincipalName --role Contributor --scopes /subscriptions/mySubscriptionID</span></pre><p id="24d2" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">4.创建用于存储状态文件的存储帐户</p><p id="2e9c" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">5.使用以下变量创建变量组</p><figure class="ll lm ln lo gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ma"><img src="../Images/20ffc9c9c17f34817463d50bf796fc82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i4mfRqE1HJ4El1m1c7hW5A.png"/></div></div></figure><p id="442c" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">6.为动态配置值创建另一个变量组，如下所示</p><figure class="ll lm ln lo gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mb"><img src="../Images/2d7adcb29bb09d6fabddb61592869451.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d0JOo8jk_5CELQ3bwUKA_Q.jpeg"/></div></div></figure><h1 id="5b50" class="mc lv in bd md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my bi translated"><strong class="ak">步骤</strong></h1><ol class=""><li id="9be8" class="kx ky in kb b kc mz kg na kk nb ko nc ks nd kw lc ld le lf bi translated">在 TF 目录下的 Azure Repo 中创建 terraform 配置文件</li></ol><figure class="ll lm ln lo gt jo gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/31461d26ce9b8e552df02b2def6666d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1078/format:webp/1*5OKg1MZjJxppbEWaScwTgg.jpeg"/></div></figure><p id="9f32" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">main.tf</p><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="3c67" class="lu lv in lq b gy lw lx l ly lz">resource "azurerm_resource_group" "example" {<br/>  name     = var.resource_group_name<br/>  location = var.location<br/>}</span><span id="d630" class="lu lv in lq b gy nf lx l ly lz">resource "random_string" "random" {<br/>  length           = 6<br/>  special          = false<br/>  numeric = false<br/>  upper = false<br/>  lower = true<br/>  <br/>}<br/>resource "azurerm_virtual_network" "example" {<br/>  name                = var.virtual_network_name<br/>  address_space       = ["10.0.0.0/16"]<br/>  location            = azurerm_resource_group.example.location<br/>  resource_group_name = azurerm_resource_group.example.name<br/>}</span><span id="01b5" class="lu lv in lq b gy nf lx l ly lz">resource "azurerm_subnet" "example" {<br/>  name                 = "subnetname"<br/>  resource_group_name  = azurerm_resource_group.example.name<br/>  virtual_network_name = azurerm_virtual_network.example.name<br/>  address_prefixes     = ["10.0.2.0/24"]<br/>  service_endpoints    = ["Microsoft.Sql", "Microsoft.Storage"]<br/>}</span><span id="784e" class="lu lv in lq b gy nf lx l ly lz">resource "azurerm_storage_account" "example" {<br/>  name                = "${var.storage_account_name}${random_string.random.id}"<br/>  resource_group_name = azurerm_resource_group.example.name</span><span id="deaf" class="lu lv in lq b gy nf lx l ly lz">location                 = azurerm_resource_group.example.location<br/>  account_tier             = "Standard"<br/>  account_replication_type = "LRS"</span><span id="07de" class="lu lv in lq b gy nf lx l ly lz">network_rules {<br/>    default_action             = "Deny"<br/>    ip_rules                   = ["100.0.0.1"]<br/>    virtual_network_subnet_ids = [azurerm_subnet.example.id]<br/>  }</span><span id="697f" class="lu lv in lq b gy nf lx l ly lz">tags = {<br/>    environment = "staging"<br/>  }<br/>}</span></pre><p id="c615" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">变量. tf</p><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="3668" class="lu lv in lq b gy lw lx l ly lz"># Input variable definitions<br/>variable "location" {<br/>  description = "The Azure Region in which all resources groups should be created."<br/>  type        = string<br/>  default = "eastus"<br/>}<br/>variable "resource_group_name" {<br/>  description = "The name of the resource group"<br/>  type        = string<br/>  default = "myrg"<br/>}<br/>variable "storage_account_name" {<br/>  description = "The name of the storage account"<br/>  type        = string<br/>  default = "abcstg"<br/>}<br/>variable "storage_account_tier" {<br/>  description = "Storage Account Tier"<br/>  type        = string<br/>  default = "Standard"<br/>}<br/>variable "virtual_network_name" {<br/>  description = "Virtual Network Name"<br/>  type        = string<br/>  default = "myvnet"<br/>}</span></pre><p id="57a2" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">providers.tf</p><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="7bf6" class="lu lv in lq b gy lw lx l ly lz">terraform {<br/>  required_providers {<br/>    azurerm = {<br/>      source = "hashicorp/azurerm"<br/>      version = "3.8.0"<br/>    }<br/>    random = {<br/>      source  = "hashicorp/random"<br/>      version = "~&gt; 3.0"<br/>    }<br/>  }<br/>  required_version = "&gt;= 1.0.0"<br/>  backend "azurerm" {<br/>    <br/>  }<br/>}</span><span id="693b" class="lu lv in lq b gy nf lx l ly lz">provider "azurerm" {<br/>  # Configuration options<br/>  features {<br/>    key_vault {<br/>      purge_soft_delete_on_destroy = true<br/>    }<br/>    resource_group {<br/>      prevent_deletion_if_contains_resources = false<br/>    }<br/>  }<br/>}</span></pre><p id="60cf" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">2.创建管道 yaml 文件</p><p id="75ea" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">变量</p><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="5cd0" class="lu lv in lq b gy lw lx l ly lz">variables:<br/>  - group: mygroup<br/>  - group: TerraformConfigurationVariable</span></pre><p id="e9cb" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">因素</p><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="63fc" class="lu lv in lq b gy lw lx l ly lz">parameters:<br/>  - name: ENVIRONMENT_NAME<br/>    default: DEV<br/>    values:<br/>      - DEV<br/>      - QA<br/>  - name: provisionType<br/>    type: string<br/>    default: Apply<br/>    values:<br/>      - Apply<br/>      - Destroy</span></pre><p id="0c6a" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">阶段</p><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="81f6" class="lu lv in lq b gy lw lx l ly lz">stages:<br/>  - stage: ${{ parameters.ENVIRONMENT_NAME }}<br/>    displayName: ${{ parameters.ENVIRONMENT_NAME }} Environment Provision<br/>    jobs:<br/>      - job: InfraCreation<br/>        displayName: Provision Infra in ${{ parameters.ENVIRONMENT_NAME }}<br/>        steps:<br/>          - task: Bash@3<br/>            inputs:<br/>              targetType: 'inline'<br/>              script: |<br/>                  wget -qO - terraform.gpg <a class="ae ng" href="https://apt.releases.hashicorp.com/gpg" rel="noopener ugc nofollow" target="_blank">https://apt.releases.hashicorp.com/gpg</a> | sudo gpg --dearmor -o /usr/share/keyrings/terraform-archive-keyring.gpg<br/>                  sudo echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/terraform-archive-keyring.gpg] <a class="ae ng" href="https://apt.releases.hashicorp.com" rel="noopener ugc nofollow" target="_blank">https://apt.releases.hashicorp.com</a> $(lsb_release -cs) main" &gt; /etc/apt/sources.list.d/terraform.list<br/>                  sudo apt update<br/>                  sudo apt install terraform<br/>                  terraform --version<br/>            displayName: Install Terraform<br/>          - bash: |<br/>                set -eux  # fail on error<br/>                az login --service-principal -u $ARM_CLIENT_ID -p $ARM_CLIENT_SECRET --tenant $ARM_TENANT_ID<br/>                subscriptionId=$(az account show --query id -o tsv)<br/>                terraform init \<br/>                  -backend-config=storage_account_name=$(TerraformBackendStorageAccount) \<br/>                  -backend-config=container_name=$(TerraformBackendStorageContainer) \<br/>                  -backend-config=key=${{ parameters.ENVIRONMENT_NAME }}.tfstate \<br/>                  -backend-config=resource_group_name=$(TerraformBackendResourceGroup) \<br/>                  -backend-config=subscription_id="$ARM_SUBSCRIPTION_ID" \<br/>                  -backend-config=tenant_id="$ARM_TENANT_ID" \<br/>                  -backend-config=client_id="$ARM_CLIENT_ID" \<br/>                  -backend-config=client_secret="$ARM_CLIENT_SECRET" <br/>            displayName: 'Terraform Init'<br/>            workingDirectory: $(System.DefaultWorkingDirectory)/TF<br/>            enabled: true<br/>            env:<br/>              ARM_CLIENT_ID: $(servicePrincipalId)<br/>              ARM_CLIENT_SECRET: $(servicePrincipalKey)<br/>              ARM_TENANT_ID: $(tenantId)<br/>              ARM_SUBSCRIPTION_ID: $(subscriptionId)<br/>              <br/>          - bash: |<br/>              az login --service-principal -u $ARM_CLIENT_ID -p $ARM_CLIENT_SECRET --tenant $ARM_TENANT_ID<br/>              terraform plan -out=plan.tfplan -input=false -var="location=$(${{ parameters.ENVIRONMENT_NAME }}_LOCATION)" -var="resource_group_name=$(${{ parameters.ENVIRONMENT_NAME }}_RESOURCE_GROUP_NAME)" -var="storage_account_name=$(${{ parameters.ENVIRONMENT_NAME }}_STORAGE_NAME)" -var="storage_account_tier=$(${{ parameters.ENVIRONMENT_NAME }}_STORAGE_TIER)" -var="virtual_network_name=$(${{ parameters.ENVIRONMENT_NAME }}_VNET_NAME)"<br/>              terraform apply -input=false -auto-approve plan.tfplan<br/>            displayName: 'Terraform Apply'<br/>            condition: eq('${{ parameters.provisionType }}', 'Apply')<br/>            workingDirectory: $(System.DefaultWorkingDirectory)/TF<br/>            env:<br/>              ARM_CLIENT_ID: $(servicePrincipalId)<br/>              ARM_CLIENT_SECRET: $(servicePrincipalKey)<br/>              ARM_TENANT_ID: $(tenantId)<br/>              ARM_SUBSCRIPTION_ID: $(subscriptionId)<br/>          - bash: |<br/>              az login --service-principal -u $ARM_CLIENT_ID -p $ARM_CLIENT_SECRET --tenant $ARM_TENANT_ID<br/>              terraform destroy -input=false -auto-approve<br/>            displayName: 'Terraform Destroy'<br/>            condition: eq('${{ parameters.provisionType }}', 'Destroy')<br/>            workingDirectory: $(System.DefaultWorkingDirectory)/TF<br/>            env:<br/>              ARM_CLIENT_ID: $(servicePrincipalId)<br/>              ARM_CLIENT_SECRET: $(servicePrincipalKey)<br/>              ARM_TENANT_ID: $(tenantId)<br/>              ARM_SUBSCRIPTION_ID: $(subscriptionId)</span></pre><p id="7bfd" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">完整的管道 yaml 配置</p><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="890d" class="lu lv in lq b gy lw lx l ly lz">trigger:<br/>- none</span><span id="2846" class="lu lv in lq b gy nf lx l ly lz">pool:<br/>  vmImage: ubuntu-latest</span><span id="dfa9" class="lu lv in lq b gy nf lx l ly lz">variables:<br/>  - group: mygroup<br/>  - group: TerraformConfigurationVariable<br/>parameters:<br/>  - name: ENVIRONMENT_NAME<br/>    default: DEV<br/>    values:<br/>      - DEV<br/>      - QA<br/>  - name: provisionType<br/>    type: string<br/>    default: Apply<br/>    values:<br/>      - Apply<br/>      - Destroy</span><span id="e136" class="lu lv in lq b gy nf lx l ly lz">stages:<br/>  - stage: ${{ parameters.ENVIRONMENT_NAME }}<br/>    displayName: ${{ parameters.ENVIRONMENT_NAME }} Environment Provision<br/>    jobs:<br/>      - job: InfraCreation<br/>        displayName: Provision Infra in ${{ parameters.ENVIRONMENT_NAME }}<br/>        steps:<br/>          - task: Bash@3<br/>            inputs:<br/>              targetType: 'inline'<br/>              script: |<br/>                  wget -qO - terraform.gpg <a class="ae ng" href="https://apt.releases.hashicorp.com/gpg" rel="noopener ugc nofollow" target="_blank">https://apt.releases.hashicorp.com/gpg</a> | sudo gpg --dearmor -o /usr/share/keyrings/terraform-archive-keyring.gpg<br/>                  sudo echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/terraform-archive-keyring.gpg] <a class="ae ng" href="https://apt.releases.hashicorp.com" rel="noopener ugc nofollow" target="_blank">https://apt.releases.hashicorp.com</a> $(lsb_release -cs) main" &gt; /etc/apt/sources.list.d/terraform.list<br/>                  sudo apt update<br/>                  sudo apt install terraform<br/>                  terraform --version<br/>            displayName: Install Terraform<br/>          - bash: |<br/>                set -eux  # fail on error<br/>                az login --service-principal -u $ARM_CLIENT_ID -p $ARM_CLIENT_SECRET --tenant $ARM_TENANT_ID<br/>                subscriptionId=$(az account show --query id -o tsv)<br/>                terraform init \<br/>                  -backend-config=storage_account_name=$(TerraformBackendStorageAccount) \<br/>                  -backend-config=container_name=$(TerraformBackendStorageContainer) \<br/>                  -backend-config=key=${{ parameters.ENVIRONMENT_NAME }}.tfstate \<br/>                  -backend-config=resource_group_name=$(TerraformBackendResourceGroup) \<br/>                  -backend-config=subscription_id="$ARM_SUBSCRIPTION_ID" \<br/>                  -backend-config=tenant_id="$ARM_TENANT_ID" \<br/>                  -backend-config=client_id="$ARM_CLIENT_ID" \<br/>                  -backend-config=client_secret="$ARM_CLIENT_SECRET" <br/>            displayName: 'Terraform Init'<br/>            workingDirectory: $(System.DefaultWorkingDirectory)/TF<br/>            enabled: true<br/>            env:<br/>              ARM_CLIENT_ID: $(servicePrincipalId)<br/>              ARM_CLIENT_SECRET: $(servicePrincipalKey)<br/>              ARM_TENANT_ID: $(tenantId)<br/>              ARM_SUBSCRIPTION_ID: $(subscriptionId)<br/>              <br/>          - bash: |<br/>              az login --service-principal -u $ARM_CLIENT_ID -p $ARM_CLIENT_SECRET --tenant $ARM_TENANT_ID<br/>              terraform plan -out=plan.tfplan -input=false -var="location=$(${{ parameters.ENVIRONMENT_NAME }}_LOCATION)" -var="resource_group_name=$(${{ parameters.ENVIRONMENT_NAME }}_RESOURCE_GROUP_NAME)" -var="storage_account_name=$(${{ parameters.ENVIRONMENT_NAME }}_STORAGE_NAME)" -var="storage_account_tier=$(${{ parameters.ENVIRONMENT_NAME }}_STORAGE_TIER)" -var="virtual_network_name=$(${{ parameters.ENVIRONMENT_NAME }}_VNET_NAME)"<br/>              terraform apply -input=false -auto-approve plan.tfplan<br/>            displayName: 'Terraform Apply'<br/>            condition: eq('${{ parameters.provisionType }}', 'Apply')<br/>            workingDirectory: $(System.DefaultWorkingDirectory)/TF<br/>            env:<br/>              ARM_CLIENT_ID: $(servicePrincipalId)<br/>              ARM_CLIENT_SECRET: $(servicePrincipalKey)<br/>              ARM_TENANT_ID: $(tenantId)<br/>              ARM_SUBSCRIPTION_ID: $(subscriptionId)<br/>          - bash: |<br/>              az login --service-principal -u $ARM_CLIENT_ID -p $ARM_CLIENT_SECRET --tenant $ARM_TENANT_ID<br/>              terraform destroy -input=false -auto-approve<br/>            displayName: 'Terraform Destroy'<br/>            condition: eq('${{ parameters.provisionType }}', 'Destroy')<br/>            workingDirectory: $(System.DefaultWorkingDirectory)/TF<br/>            env:<br/>              ARM_CLIENT_ID: $(servicePrincipalId)<br/>              ARM_CLIENT_SECRET: $(servicePrincipalKey)<br/>              ARM_TENANT_ID: $(tenantId)<br/>              ARM_SUBSCRIPTION_ID: $(subscriptionId)</span></pre><p id="18db" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">执行管道以提供资源</p><figure class="ll lm ln lo gt jo gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/e65cfa9a8f4bb620fe8b35b7b1c8969a.png" data-original-src="https://miro.medium.com/v2/resize:fit:966/format:webp/1*vdHZgHIgEL1wJXvVukI9DQ.jpeg"/></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">流水线执行</figcaption></figure><p id="af8f" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">Pipeline 将基于选定的环境创建资源。</p><figure class="ll lm ln lo gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ni"><img src="../Images/c826f0d2e3a1f2e78f8da5bec23c0a60.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eVro3BvWUYF8VKT2ZIhfvA.jpeg"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">摘要</figcaption></figure><p id="c2e0" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">我希望你喜欢阅读这篇文章，随时添加你的评论、想法或反馈，不要忘记在<a class="ae ng" href="https://www.linkedin.com/in/babulaparida/" rel="noopener ugc nofollow" target="_blank"> linkedin </a>上取得联系。</p></div></div>    
</body>
</html>