<html>
<head>
<title>AWS GuardDuty Exfiltration Bypass with VPC Endpoints</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带 VPC 端点的 AWS 守卫任务渗出旁路</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/aws-guardduty-exfiltration-bypass-4720f6ed16a4?source=collection_archive---------1-----------------------#2022-02-18">https://blog.devgenius.io/aws-guardduty-exfiltration-bypass-4720f6ed16a4?source=collection_archive---------1-----------------------#2022-02-18</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="e705" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">2022 年 1 月 20 日，<a class="ae ki" href="https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws" rel="noopener ugc nofollow" target="_blank">亚马逊 AWS 在 GuardDuty 中引入了</a>新的威胁检测规则。</p><p id="536b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><a class="ae ki" href="https://aws.amazon.com/guardduty/" rel="noopener ugc nofollow" target="_blank"> GuardDuty </a>是一项 AWS 服务(仅 30 天免费)，可以检测你的 AWS 账户中的可疑活动；例如，如果 EC2 实例(基本上是云中的一个虚拟机)正在 AWS IPs 上执行端口扫描，它会向您发出警报。</p><p id="24b5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">当 EC2 实例证书用于从一个 IP 地址调用 API 时，新的警报会通知您，该 IP 地址属于与运行相关 EC2 实例的 AWS 帐户不同的 AWS 帐户。</strong></p><p id="0397" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">新发现的名称是:</p><ul class=""><li id="0970" class="kj kk in jm b jn jo jr js jv kl jz km kd kn kh ko kp kq kr bi translated"><em class="ks">unauthorized access:iam user/instanceredentialexfiltration。内幕</em></li></ul><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi kt"><img src="../Images/42c535b224f58bc7a71bda447f29ec3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3Zf7Cr65boRzU4FOuXGwjg.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">AWS 内部凭证泄露<em class="lj">的新警戒</em></figcaption></figure><h1 id="9ef7" class="lk ll in bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">这是什么意思？</h1><p id="07b5" class="pw-post-body-paragraph jk jl in jm b jn mi jp jq jr mj jt ju jv mk jx jy jz ml kb kc kd mm kf kg kh ig bi translated">EC2 实例凭据是通过 EC2 元数据服务(端点:<a class="ae ki" href="http://169.254.169.254)" rel="noopener ugc nofollow" target="_blank"><em class="ks">http://169 . 254 . 169 . 254</em>)</a>提供的临时凭据，当 AWS 身份和访问管理(IAM)角色附加到某个实例时，该凭据可用于该实例上运行的任何应用程序。</p><p id="262a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">根据附加到实例的 IAM 角色中定义的权限，这些凭据可用于恶意调用 API。</p></div><div class="ab cl mn mo hr mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="ig ih ii ij ik"><p id="ca9a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果攻击者能够使用例如 RCE、XXE 或 SSRF 漏洞来访问 EC2 的元数据服务，则他可以扮演附加到实例的角色，并在 AWS 组织中执行横向移动或权限提升。</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi mu"><img src="../Images/b3ba5e5b8752a7c509fabcf3fc986892.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EMGEYCnohYUWmQwtDUXjbQ.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">从实例元数据服务转储 EC2-元宇宙角色的命令</figcaption></figure><h1 id="187f" class="lk ll in bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">以前怎么样？</h1><p id="3812" class="pw-post-body-paragraph jk jl in jm b jn mi jp jq jr mj jt ju jv mk jx jy jz ml kb kc kd mm kf kg kh ig bi translated">在 2022 年 1 月 20 日之前，如果凭证被盗，攻击者可以使用<strong class="jm io">任何</strong> AWS 帐户来绕过检测。</p><p id="17cf" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果攻击者试图在受危害的 AWS 主机(例如攻击者的笔记本电脑)之外使用这些凭据，将会触发警戒警报，并通过签名通知安全团队:<a class="ae ki" href="https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws" rel="noopener ugc nofollow" target="_blank"><em class="ks">unauthorized access:iam user/instanceredentialexfiltration。</em><strong class="jm io"><em class="ks"/></strong></a>。</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi mv"><img src="../Images/0798d0b4c07038c80699e75f8b197a73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*01lZU3aa4yUoQc61Wz5ncA.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated"><em class="lj"> AWS </em>外证件外漏警戒</figcaption></figure><p id="7bae" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">然而，攻击者可以使用 EC2 实例来绕过检测，因为警报只检测凭证是否在 AWS 的之外使用<strong class="jm io">，而不是受害者的特定 AWS 帐户。</strong></p><p id="5b36" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">绕过旧检测的步骤:</p><ul class=""><li id="94d0" class="kj kk in jm b jn jo jr js jv kl jz km kd kn kh ko kp kq kr bi translated">攻击者获得了对 EC2 实例的访问权</li><li id="72a4" class="kj kk in jm b jn mw jr mx jv my jz mz kd na kh ko kp kq kr bi translated">攻击者转储 EC2 附加的角色凭证</li><li id="b97d" class="kj kk in jm b jn mw jr mx jv my jz mz kd na kh ko kp kq kr bi translated">攻击者在自己的 AWS 帐户上生成一个云外壳或 EC2 实例</li><li id="e9fb" class="kj kk in jm b jn mw jr mx jv my jz mz kd na kh ko kp kq kr bi translated">攻击者在其云外壳或 EC2 实例中导入窃取的凭证</li></ul><h1 id="6399" class="lk ll in bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">VPC 端点</h1><p id="7780" class="pw-post-body-paragraph jk jl in jm b jn mi jp jq jr mj jt ju jv mk jx jy jz ml kb kc kd mm kf kg kh ig bi translated">对于新的威胁检测，无法执行上述步骤，因为 AWS 还会检测到<em class="ks">内部的</em>泄漏。这意味着 AWS 将检查执行 API 请求的 IP 是否与用于验证 API 调用的 IAM 角色的同一个 AWS 帐户相关联。</p><p id="2810" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">一旦亚马逊发布了新的检测渗透测试仪，<a class="ae ki" href="https://twitter.com/Frichette_n/status/1484314130626449417" rel="noopener ugc nofollow" target="_blank">尼克·弗里切特</a>，使用<a class="ae ki" href="https://docs.aws.amazon.com/vpc/latest/privatelink/vpc-endpoints.html" rel="noopener ugc nofollow" target="_blank"> VPC 端点</a>找到了一个旁路。</p><p id="fc41" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">请记住，VPC 终端并不是免费的，尽管它的成本很低。</p><p id="0215" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这意味着，如果攻击者能够从 EC2 实例窃取 IAM 凭据，他就可以使用配置为通过 VPC 端点路由流量的个人 EC2 实例中的凭据，因为它们不会使用公共 IP 来调用 AWS APIs。</p><p id="93ac" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">VPC 端点支持虚拟私有云(VPC)和支持服务之间的连接，而无需使用互联网网关:流量在内部路由到 AWS。</p><p id="e8d2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">有两种类型的 VPC 端点:</p><ul class=""><li id="7ff9" class="kj kk in jm b jn jo jr js jv kl jz km kd kn kh ko kp kq kr bi translated"><strong class="jm io">接口</strong>:子网内具有私有 IP 的网络接口，作为发往 AWS 服务的流量的入口点</li><li id="483f" class="kj kk in jm b jn mw jr mx jv my jz mz kd na kh ko kp kq kr bi translated"><strong class="jm io">网关</strong>:去往 S3 或 DynamoDB 服务的流量的路由目标</li></ul><p id="9b25" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">对于旁路，使用第一种类型。</p><p id="ecb4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">为了更快、更容易地实现设置过程的自动化，创建了<a class="ae ki" href="https://github.com/Frichetten/SneakyEndpoints" rel="noopener ugc nofollow" target="_blank"> SneakyEndpoints </a>(使用<a class="ae ki" href="https://github.com/notdodo/SneakyEndpoints" rel="noopener ugc nofollow" target="_blank">这个分支</a>进行基于 EU-的部署)。</p><p id="6bab" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">SneakyEndpoint 项目使用 Terraform 为攻击者构建了一个相当完整的环境:</p><ul class=""><li id="b38b" class="kj kk in jm b jn jo jr js jv kl jz km kd kn kh ko kp kq kr bi translated">在私有子网中创建一个 EC2 实例(没有互联网访问)</li><li id="a6fc" class="kj kk in jm b jn mw jr mx jv my jz mz kd na kh ko kp kq kr bi translated">创建多个 VPC 端点来与 S3、EC2、RDS、EBS、ECS、RedShift、CloudTrail、STS、CodePipeline、KMS、Lambda、SNS、SQS 服务进行通信</li></ul><p id="81b3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">要使用该项目:</p><ol class=""><li id="c1d5" class="kj kk in jm b jn jo jr js jv kl jz km kd kn kh nb kp kq kr bi translated"><code class="fe nc nd ne nf b">git clone <a class="ae ki" href="https://github.com/notdodo/SneakyEndpoints.git" rel="noopener ugc nofollow" target="_blank">https://github.com/notdodo/SneakyEndpoints.git</a></code></li><li id="0d3c" class="kj kk in jm b jn mw jr mx jv my jz mz kd na kh nb kp kq kr bi translated">用要使用的 AWS 配置文件编辑<code class="fe nc nd ne nf b">provider.tf</code>文件</li><li id="51fc" class="kj kk in jm b jn mw jr mx jv my jz mz kd na kh nb kp kq kr bi translated"><code class="fe nc nd ne nf b">terraform init</code></li><li id="e0e6" class="kj kk in jm b jn mw jr mx jv my jz mz kd na kh nb kp kq kr bi translated"><code class="fe nc nd ne nf b">terraform apply</code></li><li id="5fa2" class="kj kk in jm b jn mw jr mx jv my jz mz kd na kh nb kp kq kr bi translated">等待部署，然后使用 EC2 网页使用 SSM 连接到<code class="fe nc nd ne nf b">sneakyendpoints_host</code>实例</li></ol><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi ng"><img src="../Images/8f8cc862447b100bd19b20691c0983e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3Re6Do4XYBNutrIF3zLTpQ.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">使用 SSM 连接到 EC2</figcaption></figure><p id="e1f5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">进入 EC2 后，确认实例未连接到互联网。</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi nh"><img src="../Images/f8da69dd15f37410ac70c5cfcc3a71ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PnoyITsW3bgNt4_uTximhw.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">无法上网</figcaption></figure><p id="7065" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在在攻击者 EC2 实例中导入 exfiltrated 凭据。</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi ni"><img src="../Images/fd3531028280cd2571d2ce99d8109813.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U-ugN31lMwSBiLsRZPxzFA.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">凭据导入和 EC2 列表</figcaption></figure><p id="d485" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">继续攻击链，触发任何警戒。</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="gh gi nj"><img src="../Images/51ff8ebcbf9bbdd924f77e5e0493bba6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8BHhtNWZ2htGGv-E0NJNCA.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">无 GuardDuty 调查结果</figcaption></figure><blockquote class="nk nl nm"><p id="c496" class="jk jl ks jm b jn jo jp jq jr js jt ju nn jw jx jy no ka kb kc np ke kf kg kh ig bi translated">利润！</p></blockquote><p id="bb85" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><code class="fe nc nd ne nf b">terraform destroy</code>一旦攻击完成，不要忘记运行，以免面临无用的计费。</p><h1 id="2499" class="lk ll in bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">结论</h1><p id="59c2" class="pw-post-body-paragraph jk jl in jm b jn mi jp jq jr mj jt ju jv mk jx jy jz ml kb kc kd mm kf kg kh ig bi translated">没有新的 AWS GuardDuty 威胁检测，凭据导出更容易，因为它在任何 AWS 帐户中只需要一个 Cloud Shell 或一个 EC2。</p><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/72dd66c08e05b3b658c6423c2b904ff7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*6HQ21WYuWmSgbRso5TsPiQ.png"/></div></figure><p id="cf74" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这种新的检测方法，即使使用了 SneakyEndpoint 旁路，也不像以前那样简单，亚马逊在保护我们的云环境方面做了大量的工作。</p><h2 id="0f93" class="nr ll in bd lm ns nt dn lq nu nv dp lu jv nw nx ly jz ny nz mc kd oa ob mg oc bi translated">参考</h2><ul class=""><li id="41cf" class="kj kk in jm b jn mi jr mj jv od jz oe kd of kh ko kp kq kr bi translated"><a class="ae ki" href="https://aws.amazon.com/blogs/aws/amazon-guardduty-enhances-detection-of-ec2-instance-credential-exfiltration/" rel="noopener ugc nofollow" target="_blank">https://AWS . Amazon . com/blogs/AWS/Amazon-guard duty-enhancer-of-ec2-instance-credential-exfilling/</a></li><li id="e1ee" class="kj kk in jm b jn mw jr mx jv my jz mz kd na kh ko kp kq kr bi translated"><a class="ae ki" href="https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/guard duty/last/ug/guard duty _ find-types-iam . html # unauthorized access-iam-instance cecredentialysionsensideaws</a></li><li id="719a" class="kj kk in jm b jn mw jr mx jv my jz mz kd na kh ko kp kq kr bi translated"><a class="ae ki" href="https://docs.aws.amazon.com/vpc/latest/privatelink/vpc-endpoints.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/VPC/last/private link/VPC-endpoints . html</a></li><li id="0b38" class="kj kk in jm b jn mw jr mx jv my jz mz kd na kh ko kp kq kr bi translated"><a class="ae ki" href="https://twitter.com/Frichette_n/status/1484314130626449417" rel="noopener ugc nofollow" target="_blank">https://twitter.com/Frichette_n/status/1484314130626449417</a></li><li id="bd70" class="kj kk in jm b jn mw jr mx jv my jz mz kd na kh ko kp kq kr bi translated"><a class="ae ki" href="https://github.com/Frichetten/SneakyEndpoints" rel="noopener ugc nofollow" target="_blank">https://github.com/Frichetten/SneakyEndpoints</a></li></ul></div></div>    
</body>
</html>