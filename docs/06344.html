<html>
<head>
<title>PostgreSQL Row-level security and More…</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">PostgreSQL行级安全性及其他…</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/postgresql-row-level-security-and-more-2c8c108f9856?source=collection_archive---------4-----------------------#2022-01-01">https://blog.devgenius.io/postgresql-row-level-security-and-more-2c8c108f9856?source=collection_archive---------4-----------------------#2022-01-01</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="b3a7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在本文中，我们将了解作为PostgreSQL数据库功能的表级安全性的一部分的行级安全性，以及更多内容，因为本文将是基于实际场景的实践经验，这些场景适用于在应用程序设计中实现可扩展的基于多租户的体系结构，从而确保数据库端的数据隔离，而不是完全依赖于应用程序代码。</p><p id="89c5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们将使用docker演示本文档的内容，因此我们将在PostgreSQL docker容器中工作，如果您不熟悉docker，则基本上可以通过在本地计算机中安装PostgreSQL数据库服务器来继续。所以，让我们进入主题。</p><p id="e198" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">首先，让我们来看一下本次讲座中要介绍的内容:</p><p id="f958" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">与码头工人的先决步骤</strong></p><ol class=""><li id="bada" class="ki kj in jm b jn jo jr js jv kk jz kl kd km kh kn ko kp kq bi translated">拉PostgreSQL映像</li><li id="c6d4" class="ki kj in jm b jn kr jr ks jv kt jz ku kd kv kh kn ko kp kq bi translated">执行到docker容器中</li><li id="30b1" class="ki kj in jm b jn kr jr ks jv kt jz ku kd kv kh kn ko kp kq bi translated">通过登录数据库服务器检查连接</li></ol><p id="9892" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">实施行级安全</strong></p><ol class=""><li id="895b" class="ki kj in jm b jn jo jr js jv kk jz kl kd km kh kn ko kp kq bi translated">登录数据库服务器</li><li id="f7e9" class="ki kj in jm b jn kr jr ks jv kt jz ku kd kv kh kn ko kp kq bi translated">创建数据库</li><li id="5cb0" class="ki kj in jm b jn kr jr ks jv kt jz ku kd kv kh kn ko kp kq bi translated">使用已创建的数据库</li><li id="decf" class="ki kj in jm b jn kr jr ks jv kt jz ku kd kv kh kn ko kp kq bi translated">CREATE表</li><li id="6f76" class="ki kj in jm b jn kr jr ks jv kt jz ku kd kv kh kn ko kp kq bi translated">INSERT数据</li><li id="45db" class="ki kj in jm b jn kr jr ks jv kt jz ku kd kv kh kn ko kp kq bi translated">创造用户</li><li id="1544" class="ki kj in jm b jn kr jr ks jv kt jz ku kd kv kh kn ko kp kq bi translated">授予用户权限</li><li id="6d2a" class="ki kj in jm b jn kr jr ks jv kt jz ku kd kv kh kn ko kp kq bi translated">为表的RLS创建策略</li><li id="5600" class="ki kj in jm b jn kr jr ks jv kt jz ku kd kv kh kn ko kp kq bi translated">为该表启用RLS</li><li id="0b79" class="ki kj in jm b jn kr jr ks jv kt jz ku kd kv kh kn ko kp kq bi translated">更改当前用户等</li></ol><p id="2b10" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">所以，让我们开始先决条件的步骤。</p><p id="55a1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">首先，我们来看看码头工人是否在工作。将run命令检查到您命令行终端中。</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="5452" class="lf lg in lb b gy lh li l lj lk">$ docker ps</span><span id="d217" class="lf lg in lb b gy ll li l lj lk">CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS   NAMES</span></pre><p id="6219" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">，它将返回正在运行的容器列表，具体取决于它可以返回空列表的计算机，如果您有一个正在运行的现有容器，则不返回空列表。现在，是时候拉最新的形象和运行作为一个码头集装箱。所以，要做这个跑步——</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="337b" class="lf lg in lb b gy lh li l lj lk">$ docker run -e POSTGRES_PASSWORD=mysecretpassword -e POSTGRES_USER=postgres --name postgres_db postgres:14.1-alpine</span></pre><p id="4f9e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">它将在本地拉取映像(当前最新版本是14.1)，因此拉取需要几秒钟，并且将作为容器运行。由于它不是作为守护程序容器运行的，您需要打开另一个终端与该容器交互。一旦准备好，你可以通过<strong class="jm io"> <em class="lm"> </em> </strong>打开另一个码头运行<strong class="jm io"> <em class="lm">码头工人ps </em> </strong>，然后你会发现一个名为<strong class="jm io"> postgres_db </strong>的正在运行的码头工人集装箱。</p><figure class="kw kx ky kz gt ln"><div class="bz fp l di"><div class="lo lp l"/></div></figure><p id="9bbd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">因此，让我们执行到容器中，与PostgreSQL数据库服务器交互。奔跑</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="b711" class="lf lg in lb b gy lh li l lj lk">$ docker exec -it postgres_db /bin/bash</span></pre><p id="ab22" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">所以如果你能在码头看到<em class="lm">重击</em>，那你就在集装箱里了。好的，然后通过运行来检查连接</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="7f1d" class="lf lg in lb b gy lh li l lj lk">$ psql -U postgres</span></pre><p id="3937" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">所以，如果你能看到下面的输出，那么到目前为止一切都很好。</p><figure class="kw kx ky kz gt ln"><div class="bz fp l di"><div class="lo lp l"/></div></figure><p id="a54c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">您也可以通过运行下面的SQL来检查当前用户</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="802d" class="lf lg in lb b gy lh li l lj lk">postgres=# SELECT current_user;<br/> current_user <br/>--------------<br/> postgres<br/>(1 row)</span></pre><p id="d9b7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">恭喜！</strong></p><p id="0272" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们的第一组步骤已经完成，开始探索行级安全性aks RLS的后续步骤。</p><p id="7197" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">行级安全</strong></p><p id="6ffc" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">首先从行级安全性开始，让我们创建一个新的数据库，因为我们希望出于演示目的而执行它。</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="87e2" class="lf lg in lb b gy lh li l lj lk">postgres=# CREATE DATABASE test_rls_db;<br/>CREATE DATABASE<br/>postgres=#</span></pre><p id="a9ee" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">要检查所有已创建的数据库，可以运行</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="967c" class="lf lg in lb b gy lh li l lj lk">postgres=# \l</span></pre><p id="b208" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在，让我们连接到新创建的数据库one，对该数据库执行进一步的操作。</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="9011" class="lf lg in lb b gy lh li l lj lk">postgres=# \c test_rls_db;<br/>You are now connected to database "test_rls_db" as user "postgres".<br/>test_rls_db=#</span></pre><p id="4913" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让我们创建一个表，并将一些数据放入该表中。</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="fb1b" class="lf lg in lb b gy lh li l lj lk">test_rls_db=# CREATE TABLE users (  id serial PRIMARY KEY,  username VARCHAR (50) UNIQUE NOT NULL,  email VARCHAR (255) UNIQUE NOT NULL, role VARCHAR (20));</span><span id="be0f" class="lf lg in lb b gy ll li l lj lk">CREATE TABLE</span></pre><p id="b143" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">要检查创建的表，您可以运行</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="7b3a" class="lf lg in lb b gy lh li l lj lk">test_rls_db=# \dt<br/>         List of relations<br/> Schema | Name  | Type  |  Owner   <br/>--------+-------+-------+----------<br/> public | users | table | postgres<br/>(1 row)</span></pre><p id="0529" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">为了描述表的细节，运行</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="1f3a" class="lf lg in lb b gy lh li l lj lk">test_rls_db=# \d users;<br/>                                     Table "public.users"<br/>  Column  |          Type          | Collation | Nullable |              Default              <br/>----------+------------------------+-----------+----------+-----------------------------------<br/> id       | integer                |           | not null | nextval('users_id_seq'::regclass)<br/> username | character varying(50)  |           | not null | <br/> email    | character varying(255) |           | not null | <br/> role     | character varying(20)  |           |          | <br/>Indexes:<br/>    "users_pkey" PRIMARY KEY, btree (id)<br/>    "users_email_key" UNIQUE CONSTRAINT, btree (email)<br/>    "users_username_key" UNIQUE CONSTRAINT, btree (username)</span><span id="d0bd" class="lf lg in lb b gy ll li l lj lk">test_rls_db=#</span></pre><p id="34aa" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在让我们向表中插入一些数据。</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="eb13" class="lf lg in lb b gy lh li l lj lk">test_rls_db=# INSERT INTO users (id, username, email, role) VALUES (1, 'test_user_1', 'test_user_1<a class="ae lq" href="mailto:test.user.1@email.com" rel="noopener ugc nofollow" target="_blank">@email.com</a>', 'admin');<br/>INSERT 0 1<br/>test_rls_db=# INSERT INTO users (id, username, email, role) VALUES (2, 'test_user_2', 'test_user_<a class="ae lq" href="mailto:test.user.2@email.com" rel="noopener ugc nofollow" target="_blank">2@email.com</a>', 'manager');<br/>INSERT 0 1<br/>test_rls_db=# INSERT INTO users (id, username, email, role) VALUES (3, 'test_user_3', 'test_user_<a class="ae lq" href="mailto:test.user.3@email.com" rel="noopener ugc nofollow" target="_blank">3@email.com</a>', 'manager');<br/>INSERT 0 1<br/>test_rls_db=# INSERT INTO users (id, username, email, role) VALUES (4, 'test_user_4', 'test_user_<a class="ae lq" href="mailto:test.user.4@email.com" rel="noopener ugc nofollow" target="_blank">4@email.com</a>', 'app_user');<br/>INSERT 0 1<br/>test_rls_db=# INSERT INTO users (id, username, email, role) VALUES (5, 'test_user_5', 'test_user_<a class="ae lq" href="mailto:test.user.5@email.com" rel="noopener ugc nofollow" target="_blank">5@email.com</a>', 'app_user');<br/>INSERT 0 1</span></pre><p id="6135" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">要检查插入的所有数据，运行</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="35d0" class="lf lg in lb b gy lh li l lj lk">test_rls_db=# SELECT * FROM users;<br/> id |  username   |         email         |   role   <br/>----+-------------+-----------------------+----------<br/>  1 | test_user_1 | <a class="ae lq" href="mailto:test_user_1@email.com" rel="noopener ugc nofollow" target="_blank">test_user_1@email.com</a> | admin<br/>  2 | test_user_2 | <a class="ae lq" href="mailto:test_user_2@email.com" rel="noopener ugc nofollow" target="_blank">test_user_2@email.com</a> | manager<br/>  3 | test_user_3 | <a class="ae lq" href="mailto:test_user_3@email.com" rel="noopener ugc nofollow" target="_blank">test_user_3@email.com</a> | manager<br/>  4 | test_user_4 | <a class="ae lq" href="mailto:test_user_4@email.com" rel="noopener ugc nofollow" target="_blank">test_user_4@email.com</a> | app_user<br/>  5 | test_user_5 | <a class="ae lq" href="mailto:test_user_5@email.com" rel="noopener ugc nofollow" target="_blank">test_user_5@email.com</a> | app_user<br/>(5 rows)</span><span id="cca5" class="lf lg in lb b gy ll li l lj lk">test_rls_db=#</span></pre><p id="6179" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">事情是这样的，这个当前用户可以看到<em class="lm"> admin、manager和app_user </em>的所有用户数据，因为当前用户是这个表的所有者，但是我们希望限制这种行为，只有当前用户可以看到他的数据。</p><p id="d4d7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">要做到这一点，我们需要创建不同的用户，并对他们应用安全性。我们开始吧。</p><p id="f9bb" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">首先，创建与用户名相同的用户。</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="facc" class="lf lg in lb b gy lh li l lj lk">test_rls_db=# CREATE USER test_user_1;<br/>CREATE ROLE<br/>test_rls_db=# CREATE USER test_user_2;<br/>CREATE ROLE<br/>test_rls_db=# CREATE USER test_user_3;<br/>CREATE ROLE<br/>test_rls_db=# CREATE USER test_user_4;<br/>CREATE ROLE<br/>test_rls_db=# CREATE USER test_user_5;<br/>CREATE ROLE<br/>test_rls_db=#</span></pre><p id="bfef" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让我们把当前用户改为<strong class="jm io">测试_用户_1 </strong></p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="e949" class="lf lg in lb b gy lh li l lj lk">test_rls_db=# \c - test_user_1 ;<br/>You are now connected to database "test_rls_db" as user "test_user_1".<br/>test_rls_db=&gt;</span></pre><p id="b512" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">因此，现在尝试对表user运行SELECT查询。</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="49af" class="lf lg in lb b gy lh li l lj lk">test_rls_db=&gt; SELECT * FROM users;<br/>ERROR:  permission denied for table users<br/>test_rls_db=&gt;</span></pre><p id="d759" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">因此，您将得到拒绝的许可，因为用户在表上没有<strong class="jm io">选择</strong>授权。让我们<strong class="jm io">为表<strong class="jm io"> users </strong>中的用户授予SELECT </strong>语句。</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="9744" class="lf lg in lb b gy lh li l lj lk">test_rls_db=&gt; \c - postgres;<br/>You are now connected to database "test_rls_db" as user "postgres".<br/>test_rls_db=# GRANT SELECT ON users TO test_user_1;<br/>GRANT<br/>test_rls_db=# \c - test_user_1;<br/>You are now connected to database "test_rls_db" as user "test_user_1".<br/>test_rls_db=&gt; SELECT * FROM users;<br/> id |  username   |         email         |   role   <br/>----+-------------+-----------------------+----------<br/>  1 | test_user_1 | <a class="ae lq" href="mailto:test_user_1@email.com" rel="noopener ugc nofollow" target="_blank">test_user_1@email.com</a> | admin<br/>  2 | test_user_2 | <a class="ae lq" href="mailto:test_user_2@email.com" rel="noopener ugc nofollow" target="_blank">test_user_2@email.com</a> | manager<br/>  3 | test_user_3 | <a class="ae lq" href="mailto:test_user_3@email.com" rel="noopener ugc nofollow" target="_blank">test_user_3@email.com</a> | manager<br/>  4 | test_user_4 | <a class="ae lq" href="mailto:test_user_4@email.com" rel="noopener ugc nofollow" target="_blank">test_user_4@email.com</a> | app_user<br/>  5 | test_user_5 | <a class="ae lq" href="mailto:test_user_5@email.com" rel="noopener ugc nofollow" target="_blank">test_user_5@email.com</a> | app_user<br/>(5 rows)</span><span id="1f20" class="lf lg in lb b gy ll li l lj lk">test_rls_db=&gt;</span></pre><p id="e77f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在，您可以看到在授予用户权限后可以看到的所有用户信息，但这不是我们的目标，所以这里需要策略，要实现这一点，我们需要将策略应用到表中。让我们这样做</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="9428" class="lf lg in lb b gy lh li l lj lk">test_rls_db=&gt; \c - postgres;<br/>You are now connected to database "test_rls_db" as user "postgres".<br/>test_rls_db=# CREATE POLICY users_rls_policy ON users FOR ALL TO PUBLIC USING (username=current_user);<br/>CREATE POLICY<br/>test_rls_db=# \c - test_user_1;<br/>You are now connected to database "test_rls_db" as user "test_user_1".<br/>test_rls_db=&gt; SELECT * FROM users;<br/> id |  username   |         email         |   role   <br/>----+-------------+-----------------------+----------<br/>  1 | test_user_1 | <a class="ae lq" href="mailto:test_user_1@email.com" rel="noopener ugc nofollow" target="_blank">test_user_1@email.com</a> | admin<br/>  2 | test_user_2 | <a class="ae lq" href="mailto:test_user_2@email.com" rel="noopener ugc nofollow" target="_blank">test_user_2@email.com</a> | manager<br/>  3 | test_user_3 | <a class="ae lq" href="mailto:test_user_3@email.com" rel="noopener ugc nofollow" target="_blank">test_user_3@email.com</a> | manager<br/>  4 | test_user_4 | <a class="ae lq" href="mailto:test_user_4@email.com" rel="noopener ugc nofollow" target="_blank">test_user_4@email.com</a> | app_user<br/>  5 | test_user_5 | <a class="ae lq" href="mailto:test_user_5@email.com" rel="noopener ugc nofollow" target="_blank">test_user_5@email.com</a> | app_user<br/>(5 rows)</span><span id="bebe" class="lf lg in lb b gy ll li l lj lk">test_rls_db=&gt;</span></pre><p id="0e9f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">但是它不能正常工作！:D:是的，因为我们还必须显式地为表启用RLS。我们也这么做吧</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="15db" class="lf lg in lb b gy lh li l lj lk">test_rls_db=&gt; \c - postgres ;<br/>You are now connected to database "test_rls_db" as user "postgres".<br/>test_rls_db=# ALTER TABLE users ENABLE ROW LEVEL SECURITY;<br/>ALTER TABLE<br/>test_rls_db=# \c - test_user_1;<br/>You are now connected to database "test_rls_db" as user "test_user_1".<br/>test_rls_db=&gt; SELECT * FROM users;<br/> id |  username   |         email         | role  <br/>----+-------------+-----------------------+-------<br/>  1 | test_user_1 | <a class="ae lq" href="mailto:test_user_1@email.com" rel="noopener ugc nofollow" target="_blank">test_user_1@email.com</a> | admin<br/>(1 row)</span><span id="4a0b" class="lf lg in lb b gy ll li l lj lk">test_rls_db=&gt;</span></pre><p id="8a5b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">因此，以同样的方式，您可以为其他用户这样做。我将只为一个用户<strong class="jm io"> test_user_2 </strong>进行测试，但您可以为所有用户进行测试。</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="a86a" class="lf lg in lb b gy lh li l lj lk">test_rls_db=&gt; \c - postgres ;<br/>You are now connected to database "test_rls_db" as user "postgres".<br/>test_rls_db=# GRANT SELECT ON users TO test_user_2;<br/>GRANT<br/>test_rls_db=# \c - test_user_2;<br/>You are now connected to database "test_rls_db" as user "test_user_2".<br/>test_rls_db=&gt; SELECT * FROM users;<br/> id |  username   |         email         |  role   <br/>----+-------------+-----------------------+---------<br/>  2 | test_user_2 | <a class="ae lq" href="mailto:test_user_2@email.com" rel="noopener ugc nofollow" target="_blank">test_user_2@email.com</a> | manager<br/>(1 row)</span><span id="f2e1" class="lf lg in lb b gy ll li l lj lk">test_rls_db=&gt;</span></pre><p id="2815" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">恭喜你！</strong></p><p id="6230" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在，您已经成功地应用了行级安全性。</p><p id="e5b9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">但是，如果您知道我们在数据库中为表中的所有用户创建用户，这很难管理，那么在现实生活中，我们也希望通过使用角色来管理它。</p><p id="3d4d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让我们开始吧。因此，要做到这一点，我们需要稍微改变我们的策略，以便它可以将角色与某种提供的信息进行比较，在这种情况下，我们将使用<strong class="jm io"> current_setting </strong>。</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="225a" class="lf lg in lb b gy lh li l lj lk">test_rls_db=&gt; \c - postgres ;<br/>You are now connected to database "test_rls_db" as user "postgres".<br/>test_rls_db=# DROP POLICY users_rls_policy ON users;<br/>DROP POLICY<br/>test_rls_db=# CREATE POLICY users_rls_policy ON users FOR ALL TO PUBLIC USING (role=current_setting('rls.role'));<br/>CREATE POLICY<br/>test_rls_db=# \c - test_user_1;<br/>You are now connected to database "test_rls_db" as user "test_user_1".<br/>test_rls_db=&gt; SELECT * FROM users;<br/>ERROR:  unrecognized configuration parameter "rls.role"<br/>test_rls_db=&gt; SET rls.role='admin';<br/>SET<br/>test_rls_db=&gt; SELECT * FROM users;<br/> id |  username   |         email         | role  <br/>----+-------------+-----------------------+-------<br/>  1 | test_user_1 | <a class="ae lq" href="mailto:test_user_1@email.com" rel="noopener ugc nofollow" target="_blank">test_user_1@email.com</a> | admin<br/>(1 row)</span><span id="8c9b" class="lf lg in lb b gy ll li l lj lk">test_rls_db=&gt; SET rls.role='manager';<br/>SET<br/>test_rls_db=&gt; SELECT * FROM users;<br/> id |  username   |         email         |  role   <br/>----+-------------+-----------------------+---------<br/>  2 | test_user_2 | <a class="ae lq" href="mailto:test_user_2@email.com" rel="noopener ugc nofollow" target="_blank">test_user_2@email.com</a> | manager<br/>  3 | test_user_3 | <a class="ae lq" href="mailto:test_user_3@email.com" rel="noopener ugc nofollow" target="_blank">test_user_3@email.com</a> | manager<br/>(2 rows)</span><span id="f02c" class="lf lg in lb b gy ll li l lj lk">test_rls_db=&gt; SET rls.role='app_user';<br/>SET<br/>test_rls_db=&gt; SELECT * FROM users;<br/> id |  username   |         email         |   role   <br/>----+-------------+-----------------------+----------<br/>  4 | test_user_4 | <a class="ae lq" href="mailto:test_user_4@email.com" rel="noopener ugc nofollow" target="_blank">test_user_4@email.com</a> | app_user<br/>  5 | test_user_5 | <a class="ae lq" href="mailto:test_user_5@email.com" rel="noopener ugc nofollow" target="_blank">test_user_5@email.com</a> | app_user<br/>(2 rows)</span><span id="6f5f" class="lf lg in lb b gy ll li l lj lk">test_rls_db=&gt;</span></pre><p id="24b8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在这里，您可以看到我们使用了<strong class="jm io">role = current _ setting(' RLS . role ')</strong>，因此在每个查询中，将首先比较当前行的角色与<strong class="jm io">current _ setting(' RLS . role ')</strong>的值是否相同，并且我们需要在每个会话中设置<strong class="jm io">的值，否则您将会得到一个异常。</strong></p><p id="6a4f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">附加部分，</strong></p><p id="87f5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">因此，我们可以这样设置和比较，这是一个巨大的好处。但是我们可以有一个案例，我们希望与多个角色一起工作。因此，要做到这一点，我们可以做一些如下。</p><p id="2bf5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">首先，我们需要再次调整政策，以便我们能够实现它。</p><figure class="kw kx ky kz gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi lr"><img src="../Images/2628aa44a6f599962f535c23a7eb7e37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6LjjE-76WC-9LWfcNWFGWA.png"/></div></div></figure><p id="64ae" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">恭喜！</strong></p><p id="fb87" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在我们可以一次访问多个角色的数据。</p><p id="c66c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">接下来，我们还可以结合SQL条件，得到预期的输出。</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="000e" class="lf lg in lb b gy lh li l lj lk">test_rls_db=&gt; SELECT * FROM users WHERE username = 'test_user_2';<br/> id |  username   |         email         |  role   <br/>----+-------------+-----------------------+---------<br/>  2 | test_user_2 | <a class="ae lq" href="mailto:test_user_2@email.com" rel="noopener ugc nofollow" target="_blank">test_user_2@email.com</a> | manager<br/>(1 row)</span><span id="8db9" class="lf lg in lb b gy ll li l lj lk">test_rls_db=&gt; SELECT * FROM users WHERE username = 'test_user_1';<br/> id | username | email | role <br/>----+----------+-------+------<br/>(0 rows)</span><span id="619b" class="lf lg in lb b gy ll li l lj lk">test_rls_db=&gt;</span></pre><h1 id="561f" class="ly lg in bd lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu bi translated">行级安全性能</h1><p id="13bd" class="pw-post-body-paragraph jk jl in jm b jn mv jp jq jr mw jt ju jv mx jx jy jz my kb kc kd mz kf kg kh ig bi translated">在结束故事之前，现在让我们进入正题，如果我们仔细观察，我们可以看到RLS的含义是在每个查询中添加WHERE子句，该子句是由数据库系统本身添加的，而不是从应用程序管理它。其中每一行都必须满足这个条件才能通过策略。当然，这种额外的检查可能会对性能产生一些影响。</p><p id="4382" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">参考文献:</strong></p><ul class=""><li id="dc1b" class="ki kj in jm b jn jo jr js jv kk jz kl kd km kh na ko kp kq bi translated">https://www.postgresql.org/docs/9.5/ddl-rowsecurity.html<a class="ae lq" href="https://www.postgresql.org/docs/9.5/ddl-rowsecurity.html" rel="noopener ugc nofollow" target="_blank"/></li><li id="a59c" class="ki kj in jm b jn kr jr ks jv kt jz ku kd kv kh na ko kp kq bi translated"><a class="ae lq" href="https://www.enterprisedb.com/postgres-tutorials/how-implement-column-and-row-level-security-postgresql?fbclid=IwAR2Hewuo27VxpGWhNKSoDvXFaXZZcW4a83hPyNYFZmg1mz1nQ5-DvB-DEqg" rel="noopener ugc nofollow" target="_blank">https://www . enterprise db . com/postgres-tutorials/how-implement-column-and-row-level-security-PostgreSQL？FB clid = iwar 2 hewuo 27 vxpgwhnksodvxfaxzzcw 4a 83 hpynyfzmg 1 mz 1 NQ 5-dv b-DEqg</a></li></ul></div></div>    
</body>
</html>