<html>
<head>
<title>React Memory Leaks: what, why, and how to clean them up!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">反应内存泄漏:什么，为什么，以及如何清理它们！</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/react-memory-leaks-what-why-and-how-to-clean-them-up-93606a07de84?source=collection_archive---------0-----------------------#2022-08-29">https://blog.devgenius.io/react-memory-leaks-what-why-and-how-to-clean-them-up-93606a07de84?source=collection_archive---------0-----------------------#2022-08-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/79b445cbf6dcac5a4e419a59c222d77d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LeX7t4O10QRvWolSc_VxKA.jpeg"/></div></div></figure><h1 id="2a10" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated"><strong class="ak">简介</strong></h1><p id="b29d" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">所有的 React 开发者都应该优化他们的应用程序。电脑没有无限的资源，一些浏览器甚至为几个打开的标签页消耗了大量内存。比方说，如果你打开了 15 个标签页，通常你需要超过 8GB 的内存来支持这个庞大的浏览器。如果他们中的大多数有内存泄漏，那么它真的可以降低您的计算机。对于 React 开发人员来说，如果做得不好或者根本不做，优化可能会令人头疼。开发团队通常把优化放在最后。相信我，在一年的开发之后，为了优化而重构代码是一件非常头疼的事情。内存泄漏会破坏您的项目，耗费大量的金钱和时间。<strong class="ky ir">阅读这篇文章，了解为什么以及如何清理内存泄漏。</strong></p><h1 id="41ce" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated"><strong class="ak">什么是内存泄漏？</strong></h1><p id="3b29" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">在开发 React 应用程序时，内存泄漏是一个常见的问题。在 React 中，内存泄漏是当应用程序错误地管理内存分配时发生的一种资源泄漏。不再需要的内存不会被释放给其他进程使用。当一个对象存储在内存中，但不能被运行的代码访问时，也可能发生内存泄漏。</p><p id="77de" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">一旦出现内存泄漏，您将在控制台日志中看到类似的错误:</p><p id="8e08" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated"><em class="lz">警告:无法对卸载的组件执行反应状态更新。这是不可行的，但它表明您的应用程序中存在内存泄漏。要修复此问题，请取消 componentWillUnmount 方法中的所有订阅和异步任务。</em></p><h1 id="ad84" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated"><strong class="ak">为什么要清理内存泄漏？</strong></h1><p id="fd4d" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">内存泄漏是开发 React 应用程序时经常面临的问题。它会导致许多问题，包括:</p><ul class=""><li id="0868" class="ma mb iq ky b kz lu ld lv lh mc ll md lp me lt mf mg mh mi bi translated">通过减少可用内存量来影响项目的性能；</li><li id="fff4" class="ma mb iq ky b kz mj ld mk lh ml ll mm lp mn lt mf mg mh mi bi translated">降低应用程序的速度；</li><li id="8ecc" class="ma mb iq ky b kz mj ld mk lh ml ll mm lp mn lt mf mg mh mi bi translated">随机刷新页面；</li><li id="8e96" class="ma mb iq ky b kz mj ld mk lh ml ll mm lp mn lt mf mg mh mi bi translated">使系统崩溃；</li><li id="2967" class="ma mb iq ky b kz mj ld mk lh ml ll mm lp mn lt mf mg mh mi bi translated">用大量的查询使数据库过载；</li></ul><p id="a725" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">为什么应该修复内存泄漏的一个例子是:</p><p id="b04f" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">假设您正在使用数据库的<strong class="ky ir"> React </strong>和<strong class="ky ir"> Firebase </strong>构建一个应用程序。你创建了一个与 Firebase 互动频繁的网站。仅仅几个小时后，你就达到了一天 50k 的阅读极限。您检查了唯一的用户是您。这怎么可能呢？！现在你的网站关闭了，一天都不能工作，仅仅是因为你没有清理内存泄漏。</p><h1 id="009a" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated"><strong class="ak">什么导致了内存泄漏？</strong></h1><p id="ca06" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">如果 React 应用程序创建了在安装组件时进行的订阅，并且在卸载这些组件时没有取消订阅，则会出现内存泄漏。</p><p id="4e07" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">这些订阅可能是:</p><ul class=""><li id="c041" class="ma mb iq ky b kz lu ld lv lh mc ll md lp me lt mf mg mh mi bi translated">DOM 事件侦听器；</li><li id="c5a2" class="ma mb iq ky b kz mj ld mk lh ml ll mm lp mn lt mf mg mh mi bi translated">WebSocket 订阅；</li><li id="187d" class="ma mb iq ky b kz mj ld mk lh ml ll mm lp mn lt mf mg mh mi bi translated">对 API 的请求；</li></ul><p id="de7e" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">让我们看一个没有清除内存泄漏的组件的<strong class="ky ir">坏例子</strong>:</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="0452" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">在上面的代码片段中，我们有一个简单的组件<strong class="ky ir"> Cars </strong>，当它被挂载时，请求获取汽车信息的数据列表，并将汽车列表状态的值设置为从 API 获取的值。</p><p id="55b3" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">场景:</p><ol class=""><li id="0bf9" class="ma mb iq ky b kz lu ld lv lh mc ll md lp me lt mu mg mh mi bi translated">用户执行触发事件处理程序从 API 获取数据的操作。</li><li id="e637" class="ma mb iq ky b kz mj ld mk lh ml ll mm lp mn lt mu mg mh mi bi translated">之后，用户点击链接，导航到另一个页面。</li><li id="adda" class="ma mb iq ky b kz mj ld mk lh ml ll mm lp mn lt mu mg mh mi bi translated">即使用户已经不在最后一个页面上，也可以从 API 中检索数据并调用函数，更新现在不存在的<strong class="ky ir">列表</strong>状态。</li><li id="6003" class="ma mb iq ky b kz mj ld mk lh ml ll mm lp mn lt mu mg mh mi bi translated">从长远来看，这会累积并消耗您的 API 获取限制和用户的浏览器资源。</li></ol><h1 id="d22a" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated"><strong class="ak">如何清理内存泄漏？</strong></h1><p id="416a" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">现代编程语言和框架拥有清除不再需要的数据的技术。react 也不例外。</p><p id="d438" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">基本上，当组件卸载时，我们需要删除订阅。为此有三种方法:</p><p id="499e" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated"><strong class="ky ir"> 1。使用布尔标志</strong></p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="6ec5" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">useEffect 挂钩具有在组件被卸载后做一些事情的功能。我们简单地创建变量<strong class="ky ir"> isMounted </strong>并创建一个 if 子句来检查是否应该获取数据。由于组件已卸载，因此不再提取数据。</p><p id="27ec" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated"><strong class="ky ir"> 2。使用人工控制器</strong></p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="533a" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">Javascript 有<a class="ae mv" href="https://developer.mozilla.org/en-US/docs/Web/API/AbortController" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir">abort controller</strong></a>。AbortController 接口代表一个控制器对象，允许您根据需要中止一个或多个 Web 请求。</p><p id="ca69" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">现在，当用户导航到一个新页面时，AbortController 取消请求，内存泄漏被清除。</p><p id="0ba9" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated"><strong class="ky ir"> 3。使用安装后使用状态挂钩</strong></p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="d298" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">有一个很棒的库<a class="ae mv" href="https://www.npmjs.com/package/use-state-if-mounted" rel="noopener ugc nofollow" target="_blank"> use-state-if-mounted </a>。它的工作方式类似于 useState 钩子，但是它也在更新状态之前检查该组件是否被挂载。</p><p id="b304" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated"><strong class="ky ir"> 4。清算时间间隔</strong></p><p id="6f6d" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">您可以使用 setInterval 函数创建每秒左右重复的任务。这可能会导致内存泄漏错误，必须在卸载后清除。</p><figure class="mo mp mq mr gt jr"><div class="bz fp l di"><div class="ms mt l"/></div></figure><h1 id="33ec" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated"><strong class="ak">如何检测内存泄漏？</strong></h1><p id="fc91" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">在您从 react 得到错误之前，有一种方法可以检测内存泄漏。只需使用谷歌 chrome 的开发者工具。转到<strong class="ky ir">内存选项卡</strong>获取<strong class="ky ir">堆快照</strong>并比较采取行动前后的时间。</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mw"><img src="../Images/85b1cbc43902561949c328d02403a5c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:292/0*FaI4hTjdJSx3VO_j.gif"/></div></div></figure><h1 id="3276" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated"><strong class="ak">结论</strong></h1><p id="0d1e" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">在本文中，您会发现:</p><ul class=""><li id="12d9" class="ma mb iq ky b kz lu ld lv lh mc ll md lp me lt mf mg mh mi bi translated">什么是内存泄漏；</li><li id="0fd8" class="ma mb iq ky b kz mj ld mk lh ml ll mm lp mn lt mf mg mh mi bi translated">什么导致内存泄漏；</li><li id="cf9d" class="ma mb iq ky b kz mj ld mk lh ml ll mm lp mn lt mf mg mh mi bi translated">为什么修复内存泄漏很重要；</li><li id="8bdf" class="ma mb iq ky b kz mj ld mk lh ml ll mm lp mn lt mf mg mh mi bi translated">如何用四种方法修复那些内存泄漏；</li><li id="53c4" class="ma mb iq ky b kz mj ld mk lh ml ll mm lp mn lt mf mg mh mi bi translated">如何检测那些内存泄漏；</li></ul><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div class="gh gi mx"><img src="../Images/fd1deb38ed1b65a99b149d75ea660a58.png" data-original-src="https://miro.medium.com/v2/resize:fit:462/1*YXn6MNObRGd8IjqGhWpWKA.gif"/></div></figure></div></div>    
</body>
</html>