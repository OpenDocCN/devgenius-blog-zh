<html>
<head>
<title>Django Rest Knox Token Authentication</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Django Rest Knox 令牌认证</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/django-rest-knox-token-authentication-f134760a4a7b?source=collection_archive---------0-----------------------#2022-06-21">https://blog.devgenius.io/django-rest-knox-token-authentication-f134760a4a7b?source=collection_archive---------0-----------------------#2022-06-21</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jm jn jo jp gh gi paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="gh gi jl"><img src="../Images/d99b1890e18d7aa5b6aa04c18f3e68d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Zj8Asx1yMd8yIijEp6SGjw.jpeg"/></div></div></figure><p id="1ecc" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">大家好，本文将详细介绍如何使用名为“django-rest-knox”的第三方包作为生成 knox 令牌的认证模块。</p><p id="5277" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">Knox 认证是基于令牌的，与 DRF 内置的<code class="fe ku kv kw kx b">TokenAuthentication</code>非常相似。但是，它克服了默认实现中存在的一些问题。</p><p id="53e0" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">与 DRF 自带的默认<code class="fe ku kv kw kx b">TokenAuthentication</code>一样，令牌在数据库中是不加密的。如果我们的数据库遭到破坏，或者攻击者窃取了包括令牌在内的所有数据库数据，他们将能够使用窃取的凭证(令牌)登录。</p><p id="b370" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">我推荐 Knox 的主要原因是令牌加密。Knox 令牌身份验证使用 SHA-512 来散列数据库中的令牌，这意味着令牌是加密的。Knox 依靠<code class="fe ku kv kw kx b">cryptography</code>来提供对<code class="fe ku kv kw kx b">OpenSSL</code>的绑定，以生成令牌。这要求 OpenSSL 构建库可用。</p><p id="1900" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">DRF 令牌跟踪其创建时间，但没有内置的令牌过期机制。Knox 令牌可以在应用程序设置中配置到期时间(默认为 10 小时。)</p><h2 id="0cb2" class="kz la in bd lb lc ld dn le lf lg dp lh kh li lj lk kl ll lm ln kp lo lp lq lr bi translated">安装诺克斯</h2><p id="dfb8" class="pw-post-body-paragraph jw jx in jy b jz ls kb kc kd lt kf kg kh lu kj kk kl lv kn ko kp lw kr ks kt ig bi translated">诺克斯应该和皮普一起安装</p><pre class="lx ly lz ma gt mb kx mc bn md me bi"><span id="d0d3" class="mf la in kx b be mg mh l mi mj">pip install django-rest-knox</span></pre><h2 id="a8c9" class="kz la in bd lb lc ld dn le lf lg dp lh kh li lj lk kl ll lm ln kp lo lp lq lr bi translated">设置诺克斯</h2><ul class=""><li id="a1eb" class="mk ml in jy b jz ls kd lt kh mm kl mn kp mo kt mp mq mr ms bi translated">将<code class="fe ku kv kw kx b">rest_framework</code>和<code class="fe ku kv kw kx b">knox</code>添加到你的<code class="fe ku kv kw kx b">INSTALLED_APPS</code>中，如果你正在使用的话，移除<code class="fe ku kv kw kx b">rest_framework.authtoken</code>。</li><li id="28a9" class="mk ml in jy b jz mt kd mu kh mv kl mw kp mx kt mp mq mr ms bi translated">将 knox 的 TokenAuthentication 作为 django-rest-framework 的默认身份验证类:</li></ul><figure class="lx ly lz ma gt jp"><div class="bz fp l di"><div class="my mz l"/></div></figure><h2 id="06df" class="kz la in bd lb lc ld dn le lf lg dp lh kh li lj lk kl ll lm ln kp lo lp lq lr bi translated">设置(<code class="fe ku kv kw kx b">knox.settings)</code></h2><p id="098c" class="pw-post-body-paragraph jw jx in jy b jz ls kb kc kd lt kf kg kh lu kj kk kl lv kn ko kp lw kr ks kt ig bi translated">Knox 中的设置处理方式类似于 rest 框架设置。所有设置都在<code class="fe ku kv kw kx b">'REST_KNOX'</code>设置中命名。</p><figure class="lx ly lz ma gt jp"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="7d77" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">有了上面的设置，我们就拥有了对令牌的大部分控制权；如设置令牌长度、令牌到期(TTL 默认为 10 小时)、限制每个用户的令牌、令牌到期后自动刷新。在本例中，我将 TTL 设置为 45 分钟，因此令牌每 45 分钟到期一次。</p><h2 id="4a07" class="kz la in bd lb lc ld dn le lf lg dp lh kh li lj lk kl ll lm ln kp lo lp lq lr bi translated">API 的实现</h2><p id="dfbf" class="pw-post-body-paragraph jw jx in jy b jz ls kb kc kd lt kf kg kh lu kj kk kl lv kn ko kp lw kr ks kt ig bi translated">为我们的<em class="ky"> create_user </em>请求创建一个<em class="ky">序列化器</em>,然后创建一个处理该请求的视图，然后将其连接到一个允许我们访问 API 的 URL</p><figure class="lx ly lz ma gt jp"><div class="bz fp l di"><div class="my mz l"/></div></figure><blockquote class="na nb nc"><p id="e978" class="jw jx ky jy b jz ka kb kc kd ke kf kg nd ki kj kk ne km kn ko nf kq kr ks kt ig bi translated"><strong class="jy io"> <em class="in"> Imp 点记住</em> </strong>:如果 TokenAuthentication 是您在<code class="fe ku kv kw kx b">REST_FRAMEWORK["DEFAULT_AUTHENTICATION_CLASSES"]</code>中唯一的默认身份验证类，请记住覆盖 Knox 的 LoginView，否则它将不起作用，因为 login 视图将需要一个身份验证令牌来生成新令牌。</p></blockquote><p id="d1c6" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">由于我使用 TokenAuthentication 作为我唯一的身份验证类，因此我覆盖了 Knox 的登录视图:</p><figure class="lx ly lz ma gt jp"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="cfe1" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">写了一些意见的网址..</p><figure class="lx ly lz ma gt jp"><div class="bz fp l di"><div class="my mz l"/></div></figure><h2 id="b4bc" class="kz la in bd lb lc ld dn le lf lg dp lh kh li lj lk kl ll lm ln kp lo lp lq lr bi translated">测试 API</h2><p id="cb99" class="pw-post-body-paragraph jw jx in jy b jz ls kb kc kd lt kf kg kh lu kj kk kl lv kn ko kp lw kr ks kt ig bi translated">我们在 urls.py 中有五个端点。通过 Postman 测试每个端点。您可以随意使用任何您想要的 API 测试工具。</p><ol class=""><li id="c468" class="mk ml in jy b jz ka kd ke kh ng kl nh kp ni kt nj mq mr ms bi translated">在“<a class="ae nk" href="http://127.0.0.1:8000/api/create/" rel="noopener ugc nofollow" target="_blank"> <em class="ky">创建一个测试用户 http://127 . 0 . 0 . 1:8000/API/create/</em></a><em class="ky">”</em>，在 Body 部分提供用户名和密码字段。</li></ol><figure class="lx ly lz ma gt jp gh gi paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="gh gi nl"><img src="../Images/56c2b882358d22d99de577439256771a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jSnKVCxYbVOfkNYjrfcx5Q.png"/></div></div></figure><p id="2b7c" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">2.登录端点生成令牌(Knox 加密令牌):创建用户后，登录“<a class="ae nk" href="http://127.0.0.1:8000/api/login/" rel="noopener ugc nofollow" target="_blank"><em class="ky">http://127 . 0 . 0 . 1:8000/API/log in/</em></a>”查看令牌。</p><figure class="lx ly lz ma gt jp gh gi paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="gh gi nl"><img src="../Images/5c7012439bbf6b354fcc02fc9b62007d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BiU0MVBempnptAx3_ypTBg.png"/></div></div></figure><p id="0499" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">3.生成令牌后，将令牌复制并粘贴到标题部分，以授权管理用户配置文件。<a class="ae nk" href="http://127.0.0.1:8000/api/login/" rel="noopener ugc nofollow" target="_blank"><em class="ky">http://127 . 0 . 0 . 1:8000/API/profile/</em></a></p><figure class="lx ly lz ma gt jp gh gi paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="gh gi nm"><img src="../Images/a796271863eeb09999343ffb83550c78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oY6yEYUOhZM8AF4EKM0l9Q.png"/></div></div></figure><p id="0ec9" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">注销后，如果您使用以前的令牌重新登录，令牌将会失效，我们需要确保在令牌失效后将其删除。</p><p id="ca12" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">在管理面板上:</p><figure class="lx ly lz ma gt jp gh gi paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="gh gi nn"><img src="../Images/990419be70aa719712fe9d6eb4e5c972.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8vsx5HE3pK2SAF_9u3wMSg.png"/></div></div></figure><p id="bf83" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated"><strong class="jy io"> <em class="ky">总结</em></strong>:<a class="ae nk" href="https://github.com/James1345/django-rest-knox" rel="noopener ugc nofollow" target="_blank">Django-rest-Knox</a>库提供了模型和视图，以一种比内置 TokenAuthentication 方案更安全、更可扩展的方式处理基于令牌的身份验证——考虑到了单页面应用程序和移动客户端。</p><p id="ce32" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">它提供了每个客户端的令牌，以及在提供其他身份验证(通常是基本身份验证)时生成令牌、删除令牌(提供服务器强制注销)和删除所有令牌(注销用户登录的所有客户端)的视图。</p><p id="d9a7" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">对于这个项目的源代码，你可以看看</p><p id="5f7b" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated"><a class="ae nk" href="https://github.com/Rajesh25B/django-rest-knox" rel="noopener ugc nofollow" target="_blank">https://github.com/Rajesh25B/django-rest-knox</a></p><p id="7539" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">很多东西都参考了:</p><div class="no np gp gr nq nr"><a href="https://www.django-rest-framework.org/api-guide/authentication/" rel="noopener  ugc nofollow" target="_blank"><div class="ns ab fo"><div class="nt ab nu cl cj nv"><h2 class="bd io gy z fp nw fr fs nx fu fw im bi translated">证明</h2><div class="ny l"><h3 class="bd b gy z fp nw fr fs nx fu fw dk translated">Auth 需要可插拔。- Jacob Kaplan-Moss，“REST worst practices”身份验证是关联…</h3></div><div class="nz l"><p class="bd b dl z fp nw fr fs nx fu fw dk translated">www.django-rest-framework.org</p></div></div></div></a></div><div class="no np gp gr nq nr"><a href="https://james1345.github.io/django-rest-knox/" rel="noopener  ugc nofollow" target="_blank"><div class="ns ab fo"><div class="nt ab nu cl cj nv"><h2 class="bd io gy z fp nw fr fs nx fu fw im bi translated">姜戈-雷斯特-诺克斯</h2><div class="ny l"><h3 class="bd b gy z fp nw fr fs nx fu fw dk translated">没有人</h3></div><div class="nz l"><p class="bd b dl z fp nw fr fs nx fu fw dk translated">james1345.github.io</p></div></div></div></a></div></div></div>    
</body>
</html>