<html>
<head>
<title>A Deep Dive into Java ThreadLocal</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">深入探究 Java ThreadLocal</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/a-deep-dive-into-java-threadlocal-9d0c2591a72f?source=collection_archive---------3-----------------------#2022-09-13">https://blog.devgenius.io/a-deep-dive-into-java-threadlocal-9d0c2591a72f?source=collection_archive---------3-----------------------#2022-09-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/92766ce6e800249cabad283af2a96575.png" data-original-src="https://miro.medium.com/v2/resize:fit:1328/format:webp/1*jB6hIsDzQA0nrWM7yfnvzg.jpeg"/></div></figure><p id="fb7c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">ThreadLocal 是 Java 程序中常用的类之一。</p><p id="b7af" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">今天我刚刚遇到了一个用例，我的 workplace 代码库利用 ThreadLocal 来存储特定于线程的上下文。</p><p id="d318" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">但如果你当场让我在 ThreadLocal 上更深入地解释，我很可能回答不出来——这也是这篇文章产生的原因。</p><p id="aa5c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">对于那些参加面试的人，我希望这篇文章也能帮助你，以防这也是你的面试问题之一。</p><h1 id="c25d" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">什么是 ThreadLocal？</h1><p id="c5ae" class="pw-post-body-paragraph ju jv iq jw b jx lq jz ka kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr ij bi translated">从它的名字，我们可以知道它存储了线程的局部变量。这些变量被隔离在不同的线程之间，只能被自己的线程访问。</p><p id="e9ea" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">应用 ThreadLocal 的常见场景包括:</p><ol class=""><li id="a088" class="lv lw iq jw b jx jy kb kc kf lx kj ly kn lz kr ma mb mc md bi translated">线程间的数据隔离</li><li id="f292" class="lv lw iq jw b jx me kb mf kf mg kj mh kn mi kr ma mb mc md bi translated">数据库连接的会话管理</li><li id="67cc" class="lv lw iq jw b jx me kb mf kf mg kj mh kn mi kr ma mb mc md bi translated">线程的事务信息的存储</li></ol><h1 id="6808" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">如何使用 ThreadLocal？</h1><p id="00f3" class="pw-post-body-paragraph ju jv iq jw b jx lq jz ka kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr ij bi translated">让我们看一个简单的例子。</p><pre class="mj mk ml mm gt mn mo mp mq aw mr bi"><span id="41bb" class="ms kt iq mo b gy mt mu l mv mw">public static void main(String[] args) {</span><span id="3e8c" class="ms kt iq mo b gy mx mu l mv mw">    //Create a ThreadLocal<br/>    ThreadLocal&lt;String&gt; local = new ThreadLocal&lt;&gt;();</span><span id="faff" class="ms kt iq mo b gy mx mu l mv mw">    //Create a new Random class<br/>    Random random = new Random();</span><span id="cabc" class="ms kt iq mo b gy mx mu l mv mw">    //Create 5 threads<br/>    IntStream.<em class="my">range</em>(0, 5).forEach(a-&gt; new Thread(()-&gt; {</span><span id="1f05" class="ms kt iq mo b gy mx mu l mv mw">        //Set a local value for each of the threads<br/>        local.set(a+"  "+random.nextInt(100));<br/>        System.<em class="my">out</em>.println("Thread number and its local value  "+ local.get());</span><span id="13d6" class="ms kt iq mo b gy mx mu l mv mw">    }).start());<br/>}</span></pre><p id="3ac3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在上面的代码中，我们创建了一个 ThreadLocal 类，创建了 5 个线程，在每个线程中为 ThreadLocal 赋值并打印它们。</p><p id="2bd2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">下面是输出的内容:</p><figure class="mj mk ml mm gt jr gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/e47e5b23f35764ba81a0c73a9b376737.png" data-original-src="https://miro.medium.com/v2/resize:fit:744/format:webp/1*B5qCiEr71e4EpxI91yLLjw.png"/></div></figure><p id="18a4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">够简单吗？</p><h1 id="fa78" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">引擎盖下是什么？</h1><p id="c114" class="pw-post-body-paragraph ju jv iq jw b jx lq jz ka kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr ij bi translated">如果你仔细观察，你会发现上面的 ThreadLocal 中有两个重要的方法。</p><pre class="mj mk ml mm gt mn mo mp mq aw mr bi"><span id="9880" class="ms kt iq mo b gy mt mu l mv mw">1. public T get() {}<br/>2. public void set (T value) {}</span></pre><p id="abf1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们来看看 ThreadLocal 源代码中的 setter 方法:</p><pre class="mj mk ml mm gt mn mo mp mq aw mr bi"><span id="dddc" class="ms kt iq mo b gy mt mu l mv mw">public void set(T value) {<br/>        Thread t = Thread.currentThread();<br/>        ThreadLocalMap map = getMap(t);<br/>        if (map != null)<br/>            map.set(this, value);<br/>        else<br/>            createMap(t, value);<br/>}</span></pre><p id="13af" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">setter 方法首先获取当前线程，调用<em class="my"> getMap() </em>方法获取一个<em class="my"> ThreadLocalMap </em>类。如果映射存在，以当前线程<em class="my"> t </em>为 key，输入参数为 value，在映射中设置{key:value}对。如果没有，那么创建一个地图。</p><p id="a9e0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">您现在可能想知道— <strong class="jw ir">什么是 ThreadLocalMap？</strong></p><pre class="mj mk ml mm gt mn mo mp mq aw mr bi"><span id="c148" class="ms kt iq mo b gy mt mu l mv mw">static class ThreadLocalMap {<br/>   <em class="my">/**<br/>    * The entries in this hash map extend WeakReference, using<br/>    * its main ref field as the key (which is always a<br/>    * ThreadLocal object).  Note that null keys (i.e. entry.get()<br/>    * == null) mean that the key is no longer referenced, so the<br/>    * entry can be expunged from table.  Such entries are referred to<br/>    * as "stale entries" in the code that follows.<br/>    */</em></span><span id="d14e" class="ms kt iq mo b gy mx mu l mv mw">    static class Entry extends WeakReference&lt;ThreadLocal&lt;?&gt;&gt; {<br/>       <em class="my">/** The value associated with this ThreadLocal. */</em><br/>       Object value;<br/>       Entry(ThreadLocal&lt;?&gt; k, Object v) {<br/>           super(k);<br/>           value = v;<br/>       }<br/>    }<em class="my"><br/></em>}</span></pre><p id="b889" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="my"> ThreadLocalMap </em>是<em class="my"> ThreadLocal </em>中的内部静态类，定义了一个<em class="my"> Entry </em>类来存储数据。<em class="my">条目</em>使用<em class="my"> ThreadLocal </em>实例作为键，并设置我们传入的值。</p><p id="035a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果在这个阶段太混乱，只要记住是<em class="my"> ThreadLocalMap </em>中的<em class="my">条目</em>类在做实际的值存储。</p></div><div class="ab cl na nb hu nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ij ik il im in"><p id="5c92" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为了从<em class="my"> ThreadLocal </em>中检索数据，我们来看看 getter 方法:</p><pre class="mj mk ml mm gt mn mo mp mq aw mr bi"><span id="c49e" class="ms kt iq mo b gy mt mu l mv mw">public T get() {<br/>        Thread t = Thread.currentThread();<br/>        ThreadLocalMap map = getMap(t);<br/>        if (map != null) {<br/>            ThreadLocalMap.Entry e = map.getEntry(this);<br/>            if (e != null) {<br/>                @SuppressWarnings("unchecked")<br/>                T result = (T)e.value;<br/>                return result;<br/>            }<br/>        }<br/>        return setInitialValue();<br/>}</span></pre><p id="5894" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在 getter 方法中，我们将使用<em class="my"> currentThread </em>作为键来获取<em class="my"> ThreadLocalMap </em>。然后映射将基于<em class="my"> ThreadLocal </em>实例<em class="my"> getEntry() </em>并返回<em class="my"> Entry </em>实例和存储值。</p><p id="1686" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">感觉有点头晕？</strong></p><p id="3bb7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">也许图表会有所帮助:</p><figure class="mj mk ml mm gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ni nj di nk bf nl"><div class="gh gi nh"><img src="../Images/381c4b44d741a6243eac0c96d44c4f96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1236/format:webp/1*BnqGZawyVLsIXG3zJ2-yWg.png"/></div></div></figure><figure class="mj mk ml mm gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ni nj di nk bf nl"><div class="gh gi nm"><img src="../Images/59a1c28eeda9ac7b36478e818c561e83.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dkssr59yWFFmNgKHSQXvFw.png"/></div></div></figure><ol class=""><li id="a8ea" class="lv lw iq jw b jx jy kb kc kf lx kj ly kn lz kr ma mb mc md bi translated">每个<em class="my">线程</em>维护一个对<em class="my"> ThreadLocalMap </em>的引用</li><li id="7331" class="lv lw iq jw b jx me kb mf kf mg kj mh kn mi kr ma mb mc md bi translated"><em class="my"> ThreadLocalMap </em>是<em class="my"> ThreadLocal </em>的内部静态类，使用<em class="my"> Entry </em>类进行存储</li><li id="ee30" class="lv lw iq jw b jx me kb mf kf mg kj mh kn mi kr ma mb mc md bi translated"><em class="my"> ThreadLocalMap </em>键是<em class="my"> ThreadLocal </em>实例，可以有多个<em class="my"> ThreadLocal </em></li><li id="b7e7" class="lv lw iq jw b jx me kb mf kf mg kj mh kn mi kr ma mb mc md bi translated"><em class="my"> ThreadLocal </em>本身不存储值，但它是线程从<em class="my"> ThreadLocalMap </em>获取值的一个键</li></ol><blockquote class="nn no np"><p id="2615" class="ju jv my jw b jx jy jz ka kb kc kd ke nq kg kh ki nr kk kl km ns ko kp kq kr ij bi translated">请注意，最好删除 ThreadLocal，以避免由于 Entry 类中的弱引用而导致的 OOM(内存不足错误)。</p></blockquote></div><div class="ab cl na nb hu nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ij ik il im in"><p id="517c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我希望这篇文章对你有所帮助。</p><p id="1138" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我是后端软件工程师。如果你渴望了解技术，请关注我的频道，了解我在日常工作和生活中获得的灵感。</p><blockquote class="nn no np"><p id="f1d9" class="ju jv my jw b jx jy jz ka kb kc kd ke nq kg kh ki nr kk kl km ns ko kp kq kr ij bi translated"><strong class="jw ir"> <em class="iq">阅读更多:</em> </strong> <em class="iq"> <br/> </em> <a class="ae nt" rel="noopener ugc nofollow" target="_blank" href="/a-case-about-java-static-keyword-during-my-job-53cebb6af597"> <em class="iq">一个关于 Java 静态关键字在职期间的案例</em></a><em class="iq"><br/></em><a class="ae nt" rel="noopener ugc nofollow" target="_blank" href="/how-can-you-solve-this-java-multithreading-interview-problem-8e6ec53fab27"><em class="iq">如何解决这个 Java 多线程面试问题？</em> </a></p><p id="1ee4" class="ju jv my jw b jx jy jz ka kb kc kd ke nq kg kh ki nr kk kl km ns ko kp kq kr ij bi translated"><strong class="jw ir"> <em class="iq">获取连接:</em></strong><em class="iq"><br/></em><a class="ae nt" href="https://www.linkedin.com/in/daini-wang-5127b2182" rel="noopener ugc nofollow" target="_blank"><em class="iq">我的 LinkedIn </em> </a></p></blockquote></div></div>    
</body>
</html>