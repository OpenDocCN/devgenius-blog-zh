<html>
<head>
<title>Solving Data Consistency using Sagas</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Sagas 解决数据一致性问题</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/solving-data-consistency-using-sagas-80c00b311e45?source=collection_archive---------6-----------------------#2020-07-06">https://blog.devgenius.io/solving-data-consistency-using-sagas-80c00b311e45?source=collection_archive---------6-----------------------#2020-07-06</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/05274511b3686e0c905415beb12e1e23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ZdvpklwjtYy5JNui"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated"><a class="ae jz" href="https://unsplash.com/@campaign_creators?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">活动发起人</a>在<a class="ae jz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="f166" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">毫无疑问，微服务架构模式是这十年流行的模式之一。这种模式已经被许多大大小小的高效技术公司所接受。但是这种模式带来了一些新的挑战，这些挑战在构建整体应用程序时是不存在的。一个主要的挑战是在多个服务之间保持<strong class="kc io">数据的一致性</strong>。在我之前的<a class="ae jz" href="https://medium.com/dev-genius/data-consistency-in-a-microservice-architecture-e7d21b6ccdd1" rel="noopener">文章</a>中，我已经讨论了如何使用分布式事务来维护数据一致性，以及它的缺陷。在这篇文章中，我将描述如何使用<strong class="kc io">传奇来实现这一点。</strong></p><p id="aec8" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">传奇是一系列本地事务。每个本地事务局限于服务，并且符合 ACID。如果任何本地事务失败，saga 负责执行一系列补偿事务来回滚更改。让我们讨论一个例子来理解它是如何工作的。在这个例子中，我们讨论在网上咖啡店里点一杯咖啡。咖啡店有订单服务、付款服务、客户服务和厨房服务。下面的 UML 显示了下订单时所涉及的各种服务之间的各种交互。</p><figure class="kz la lb lc gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ky"><img src="../Images/fd96683401bdb6a94b84e2656350a8f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qVo1YxM6KkjMEJ5DWZ8B0w.png"/></div></div></figure><p id="2e4c" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">该系列包括以下 4 笔本地交易(T1、T2、T3、T4)</p><ol class=""><li id="2ded" class="ld le in kc b kd ke kh ki kl lf kp lg kt lh kx li lj lk ll bi translated">订单服务-订单服务接收新订单。它创建一个新订单，并将状态标记为待定。我们将该事务标记为 T1。</li><li id="c1e1" class="ld le in kc b kd lm kh ln kl lo kp lp kt lq kx li lj lk ll bi translated">客户服务——订单服务传递带有支付细节的客户信息。客户服务验证客户信息。我们将此交易标记为 T2。</li><li id="d431" class="ld le in kc b kd lm kh ln kl lo kp lp kt lq kx li lj lk ll bi translated">支付服务—使用客户的支付信息进行支付。这可能是为了授权客户的信用卡信息，也可能是为了从客户的 Paypal/Venmo 帐户中提款。我们将该事务标记为 T3。</li><li id="2101" class="ld le in kc b kd lm kh ln kl lo kp lp kt lq kx li lj lk ll bi translated">厨房服务——根据订单行项目创建票据。我们将此交易标记为 T4。</li><li id="43a1" class="ld le in kc b kd lm kh ln kl lo kp lp kt lq kx li lj lk ll bi translated">一旦 4 笔交易都成功，我们将订单状态标记为成功。</li></ol><p id="1c47" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">上面的序列显示了幸福的道路。但是，如果在一个本地事务中发生了事务失败，会发生什么呢？这是我们使用补偿事务回滚我们所做的更改的时候。<strong class="kc io"> Sagas 不保证酸性，但保证 ACD </strong>。应用应确保隔离。当我们实现它时，有各种各样的技术可以使用。</p><p id="32cd" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">什么是补偿交易？</strong></p><p id="e35c" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这些是撤销在传奇中执行的工作的那些事务。简单地用故事开始前的状态替换系统的当前状态是不容易的。需要特别注意不要覆盖应用程序的其他并发实例所做的更改。补偿事务应该能够理解并发实例所做的工作，并回滚仅由 saga 的原始事务所做的更改。下图显示了补偿事务是如何工作的。服务中的每个事务 T <em class="lr"> i </em>都有一个等价的补偿事务 C <em class="lr"> i </em>。C <em class="lr"> i </em>的职责是撤销 T <em class="lr"> i </em>所做的更改。在下面的场景中，让我们假设 T3 出现故障。这将触发补偿交易 C2。C3 随后触发了 C1。这就是回滚的实现方式。这确保了所有事务都被撤消。注意，并不是所有的事务都需要一个补偿事务。例如，在我们前面订购咖啡的例子中，客户信息(T2)的验证没有补偿事务，因为它没有对本地数据库进行任何更改。</p><figure class="kz la lb lc gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ls"><img src="../Images/0e1548e41b440fd581be6d5a8f48cc7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AFELiMKy0crqBaF4ElD2CA.png"/></div></div></figure><p id="f8fd" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">既然我们已经讨论了<strong class="kc io">补偿交易</strong>，让我们看一下同样的订购咖啡的例子，我们在支付服务中遇到了一个错误。在以下示例中，当订单到达厨房服务部时，它会因厨房关闭而拒绝订单。</p><ol class=""><li id="7f2f" class="ld le in kc b kd ke kh ki kl lf kp lg kt lh kx li lj lk ll bi translated">订单服务-订单服务接收新订单。它创建一个新订单，并将状态标记为待定。我们将该事务标记为 T1。</li><li id="3033" class="ld le in kc b kd lm kh ln kl lo kp lp kt lq kx li lj lk ll bi translated">客户服务——订单服务传递带有支付细节的客户信息。客户服务验证客户信息。我们将此交易标记为 T2。</li><li id="182b" class="ld le in kc b kd lm kh ln kl lo kp lp kt lq kx li lj lk ll bi translated">支付服务—使用客户的支付信息进行支付。它授权客户付款。我们将该事务标记为 T3。</li><li id="cd60" class="ld le in kc b kd lm kh ln kl lo kp lp kt lq kx li lj lk ll bi translated">厨房服务——由于厨房已经关门，它拒绝订单，并且无法创建与订单相对应的票据。此时，我们需要执行 2 次回滚。一个是作为 T3 一部分的客户付款。因此，我们将有一个 C3 来撤销 T3 的变化。另一个是创建订单 T1 的补偿事务，即 C1。在 C1，订单状态被标记为失败。</li></ol><p id="44ff" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在本文中，我们介绍了 saga 如何实现 ACD。我们仍然要讨论如何在传奇故事中处理隔离，这将在以后讨论。</p><p id="c9a8" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">参考</p><ol class=""><li id="ffe0" class="ld le in kc b kd ke kh ki kl lf kp lg kt lh kx li lj lk ll bi translated"><a class="ae jz" href="https://docs.microsoft.com/en-us/azure/architecture/patterns/compensating-transaction" rel="noopener ugc nofollow" target="_blank">https://docs . Microsoft . com/en-us/azure/architecture/patterns/compensating-transaction</a></li><li id="eb5e" class="ld le in kc b kd lm kh ln kl lo kp lp kt lq kx li lj lk ll bi translated">https://microservices.io/patterns/data/saga.html<a class="ae jz" href="https://microservices.io/patterns/data/saga.html" rel="noopener ugc nofollow" target="_blank"/></li><li id="98d9" class="ld le in kc b kd lm kh ln kl lo kp lp kt lq kx li lj lk ll bi translated">微服务模式— Chris Richardson</li></ol></div></div>    
</body>
</html>