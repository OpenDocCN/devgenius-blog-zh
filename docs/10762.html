<html>
<head>
<title>Kubernetes Deployment Strategy Explained</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes 部署策略解释</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/kubernetes-deployment-strategy-explained-bf27fea088e1?source=collection_archive---------11-----------------------#2022-11-27">https://blog.devgenius.io/kubernetes-deployment-strategy-explained-bf27fea088e1?source=collection_archive---------11-----------------------#2022-11-27</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/7bb87b14be0dbec773e867cffecba830.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*w_gNgoJ1JuvTbwWy"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">照片由<a class="ae jz" href="https://growtika.com/" rel="noopener ugc nofollow" target="_blank">格罗提卡</a>拍摄</figcaption></figure><p id="3c64" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi ky translated">ubernetes 部署是一种创建 pod 和副本集的声明式方法。您可以在部署 YAML 中定义期望的状态，Kubernetes 控制器会将实际状态与期望的状态相匹配。</p><p id="a663" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">部署策略控制如何创建复制集和单元。在 Kubernetes 部署文件中，您主要可以指定两种策略。</p><h2 id="b6a6" class="lh li in bd lj lk ll dn lm ln lo dp lp kl lq lr ls kp lt lu lv kt lw lx ly lz bi translated"><strong class="ak"> 2 种策略类型</strong></h2><ol class=""><li id="5590" class="ma mb in kc b kd mc kh md kl me kp mf kt mg kx mh mi mj mk bi translated"><strong class="kc io">再造</strong></li></ol><figure class="mm mn mo mp gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ml"><img src="../Images/45f5af92e5b6b52cf04c4260ac06a073.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s6JIiFaVmRh9xrq67NmiDw.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">使用重新创建部署 YAML</figcaption></figure><p id="2974" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在创建新的 pod 之前，所有现有的 pod 都将被终止。这种策略可能会导致应用程序停机，因为在删除所有旧的 pod 之前，不会创建新版本的 pod。</p><figure class="mm mn mo mp gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mq"><img src="../Images/b7e02ee3ccbc138c6f4e9e571a7f37d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K5VTBlvCuYnCzy95uWI5YQ.png"/></div></div></figure><p id="77c9" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们可以看到，当我们更新部署时，旧版本的所有 3 个 pod 在新版本部署之前首先终止<strong class="kc io">。</strong></p><p id="20ea" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io"> 2。RollingUpdate(默认)</strong></p><figure class="mm mn mo mp gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ml"><img src="../Images/6dcc722989ceeb873d04f71b6435fa04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NIlhqWk_fz_MVSn46HK1WQ.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">使用滚动更新部署 YAML</figcaption></figure><p id="4878" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">此策略将执行滚动更新，这将逐步用新版本替换旧版本的 pod。滚动更新不会给应用程序造成停机时间。</p><p id="d375" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">准备就绪探测用于确保在终止旧 pod 之前，新版本的 pod 已准备就绪。</p><div class="mr ms gp gr mt mu"><a href="https://guyzsarun.medium.com/kubernetes-liveness-readiness-probe-explained-352691dcccf1" rel="noopener follow" target="_blank"><div class="mv ab fo"><div class="mw ab mx cl cj my"><h2 class="bd io gy z fp mz fr fs na fu fw im bi translated">Kubernetes 活跃度，准备探测解释</h2><div class="nb l"><h3 class="bd b gy z fp mz fr fs na fu fw dk translated">在 Kubernetes 中，除了 restartPolicy 之外，默认情况下，当 pod 出现故障时，restart policy 会重新启动 pod。有活跃度和…</h3></div><div class="nc l"><p class="bd b dl z fp mz fr fs na fu fw dk translated">guyzsarun.medium.com</p></div></div><div class="nd l"><div class="ne l nf ng nh nd ni jt mu"/></div></div></a></div><figure class="mm mn mo mp gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mq"><img src="../Images/aa16599c4905e63e25400514224a8a2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Eh68kz_1CHUUEq3sRG8lXQ.png"/></div></div></figure><p id="7000" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">当我们使用 RollingUpdate 应用新版本的部署时。首先，创建新的 pod ( <code class="fe nj nk nl nm b">application-9f6f449b5-xm649</code>)。并且，当 Pod 状态为运行时，它会终止旧的 pod ( <code class="fe nj nk nl nm b">application-6946b895c8-j4lcq</code>)。重复该过程，直到所有窗格都被更新。</p></div><div class="ab cl nn no hr np" role="separator"><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns"/></div><div class="ig ih ii ij ik"><h2 id="7e9c" class="lh li in bd lj lk ll dn lm ln lo dp lp kl lq lr ls kp lt lu lv kt lw lx ly lz bi translated">滚动更新参数</h2><ul class=""><li id="d9c5" class="ma mb in kc b kd mc kh md kl me kp mf kt mg kx nu mi mj mk bi translated"><strong class="kc io">最大浪涌</strong></li></ul><p id="fe64" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">该字段指定在更新期间可以创建的超过所需数量的单元数量。该值可以是 pod 的绝对数量，也可以是向上舍入的百分比(例如 10%)。</p><p id="e39b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">默认值为<strong class="kc io"> 25% </strong></p><figure class="mm mn mo mp gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ml"><img src="../Images/9758ffb5302b513e7819ab46da143fbb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Qtf1tUPB-Z0VTBuXJz2BLA.png"/></div></div></figure><p id="0b38" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">例如，在上面的 YAML 中，我们设置<strong class="kc io"> maxSurge = 3 </strong></p><figure class="mm mn mo mp gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mq"><img src="../Images/3cdef16d713947fa99be8349c1fb883e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jBNkcEB-WRHhrAndHXbnMw.png"/></div></div></figure><p id="5521" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们目前有 3 个单元在集群中运行。</p><figure class="mm mn mo mp gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mq"><img src="../Images/86a7f859e328e29a000180a728aa2e8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4wJ9egtDaQ2cPbCGZAMWVA.png"/></div></div></figure><p id="b8dd" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">当我们更新部署时，3 个新的吊舱<code class="fe nj nk nl nm b">application-69bf477c75</code>同时被创建。</p><p id="597b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">转出时集群上的总 pod 为<strong class="kc io"> 6 </strong> ( <strong class="kc io">副本数量</strong> + <strong class="kc io">最大浪涌</strong>)</p><ul class=""><li id="1ce8" class="ma mb in kc b kd ke kh ki kl nv kp nw kt nx kx nu mi mj mk bi translated"><strong class="kc io">最大不可用</strong></li></ul><p id="1942" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在滚动更新过程中不可用的单元的最大数量。该值可以是 pod 的绝对数量，也可以是向下舍入的百分比(例如 10%)。</p><p id="adc1" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">默认值为<strong class="kc io"> 25% </strong></p><figure class="mm mn mo mp gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ml"><img src="../Images/a4ab19b9064211e53a6f7a592e4e3bcd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bc_M7ft_kFUC46jpqlfXKQ.png"/></div></div></figure><p id="8c5f" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">例如，在上面的 YAML 中，我们设置<strong class="kc io"> maxUnavailable = 2 </strong></p><figure class="mm mn mo mp gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mq"><img src="../Images/301aebf1c2532cbff0de24140cd3d162.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tYe_REvhJBo1EZF-hqxkZQ.png"/></div></div></figure><p id="bb58" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">当我们更新部署时，会同时创建 3 个新的 pod<code class="fe nj nk nl nm b">application-69bf477c75</code>。此外，2 个旧吊舱<code class="fe nj nk nl nm b">application-bf88b965f</code>被终止。</p><p id="ce98" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">总运行 pod 为 1 ( <strong class="kc io">副本数量</strong> — <strong class="kc io">最大不可用数量</strong>)</p></div><div class="ab cl nn no hr np" role="separator"><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns"/></div><div class="ig ih ii ij ik"><h2 id="9a15" class="lh li in bd lj lk ll dn lm ln lo dp lp kl lq lr ls kp lt lu lv kt lw lx ly lz bi translated">组合 maxSurge 和 maxUnavailable</h2><p id="62fb" class="pw-post-body-paragraph ka kb in kc b kd mc kf kg kh md kj kk kl ny kn ko kp nz kr ks kt oa kv kw kx ig bi translated">当我们结合 maxSurge 和 maxUnavailable 参数时，可以创建不同的部署策略</p><p id="36c7" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">这里有几个例子</strong></p><ul class=""><li id="881b" class="ma mb in kc b kd ke kh ki kl nv kp nw kt nx kx nu mi mj mk bi translated"><strong class="kc io">渐变</strong>——一次一个实例地缓慢推出新版本。</li></ul><pre class="mm mn mo mp gt ob nm oc bn od oe bi"><span id="5de7" class="of li in nm b be og oh l oi oj">  strategy:<br/>    type: RollingUpdate<br/>    rollingUpdate:<br/>      maxSurge: 1          # Add 1 pod at a time<br/>      maxUnavailable: 0    # Ensure the new pod is running before terminating old version</span></pre><ul class=""><li id="743a" class="ma mb in kc b kd ke kh ki kl nv kp nw kt nx kx nu mi mj mk bi translated"><strong class="kc io">蓝/绿— </strong>发布新版本和旧版本，然后使用服务、入口或服务网格交换流量。</li><li id="6a86" class="ma mb in kc b kd ok kh ol kl om kp on kt oo kx nu mi mj mk bi translated"><strong class="kc io"> Canary — </strong>在全面推广之前，向少量用户发布新版本，以测试新版本的功能。</li></ul><p id="a299" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">部署策略的更多示例可在本<a class="ae jz" href="https://github.com/ContainerSolutions/k8s-deployment-strategies\" rel="noopener ugc nofollow" target="_blank"> GitHub repo </a>中找到</p><div class="mr ms gp gr mt mu"><a href="https://github.com/ContainerSolutions/k8s-deployment-strategies" rel="noopener  ugc nofollow" target="_blank"><div class="mv ab fo"><div class="mw ab mx cl cj my"><h2 class="bd io gy z fp mz fr fs na fu fw im bi translated">GitHub-container solutions/k8s-deployment-strategies:Kubernetes 部署策略解释</h2><div class="nb l"><h3 class="bd b gy z fp mz fr fs na fu fw dk translated">在 Kubernetes 中，发布应用程序有几种不同的方式，你必须仔细选择正确的策略…</h3></div><div class="nc l"><p class="bd b dl z fp mz fr fs na fu fw dk translated">github.com</p></div></div><div class="nd l"><div class="op l nf ng nh nd ni jt mu"/></div></div></a></div></div></div>    
</body>
</html>