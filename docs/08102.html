<html>
<head>
<title>GraphQL for Node.js developers, pt. 3 — error handling</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">面向 Node.js 开发人员的 GraphQL，pt。3 —错误处理</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/graphql-for-node-js-developers-pt-3-error-handling-37f7e96f3608?source=collection_archive---------1-----------------------#2022-05-17">https://blog.devgenius.io/graphql-for-node-js-developers-pt-3-error-handling-37f7e96f3608?source=collection_archive---------1-----------------------#2022-05-17</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/8de2efe8e42c4b94655d466b1876ef13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vQ9bH86FE6glm17f"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">照片由<a class="ae jz" href="https://unsplash.com/@remyloz?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Remy_Loz </a>在<a class="ae jz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="f5e7" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们都会犯错。问题是，我们如何处理它们。这同样适用于我们的 API。肯定会有错误。我们必须做好应对的准备。所以在本教程中，我将教你如何处理 GraphQL APIs 中的错误。拿杯咖啡跟我来。</p></div><div class="ab cl ky kz hr la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ig ih ii ij ik"><p id="24dd" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">与 rest APIs 相比，GraphQL 中的错误处理方式有所不同。GraphQL 不依赖 HTTP 状态来通知错误。相反，响应主体中返回的值告诉我们是成功还是失败。那个身体里面有两把钥匙:<code class="fe lf lg lh li b">data</code>和<code class="fe lf lg lh li b">errors</code>。如果出现一个或多个错误，它们将出现在 errors 数组中。因此，从客户端的角度来看，要验证是否发生了不好的事情，您必须检查错误数组是否不为空。</p><p id="b268" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">所以，我们用实践来论证一下。首先，我从一个基本案例开始。假设查询中有一个错误。例如，我打错了<code class="fe lf lg lh li b">__typename</code>这个名字。那么 API 会返回什么呢？在这个场景中，apollo 服务器将返回一个从<code class="fe lf lg lh li b">ApolloError</code>类派生的错误，代码等于<code class="fe lf lg lh li b">GRAPHQL_VALIDATION_FAILED</code>，这是 apollo 服务器预定义的错误之一。</p><figure class="lk ll lm ln gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi lj"><img src="../Images/f9e71007866065b71edf7f276cac638c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nPT0JFtnTSufhCGrAbKfcg.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">阿波罗服务器错误</figcaption></figure><p id="3626" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">您可以在 apollo 文档中查看所有可能的错误代码:</p><div class="lo lp gp gr lq lr"><a href="https://www.apollographql.com/docs/apollo-server/data/errors/#error-codes" rel="noopener  ugc nofollow" target="_blank"><div class="ls ab fo"><div class="lt ab lu cl cj lv"><h2 class="bd io gy z fp lw fr fs lx fu fw im bi translated">错误处理</h2><div class="ly l"><h3 class="bd b gy z fp lw fr fs lx fu fw dk translated">每当 Apollo 服务器在处理 GraphQL 操作时遇到错误，它对客户机的响应包括一个…</h3></div><div class="lz l"><p class="bd b dl z fp lw fr fs lx fu fw dk translated">www.apollographql.com</p></div></div><div class="ma l"><div class="mb l mc md me ma mf jt lr"/></div></div></a></div><p id="e771" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">除了错误代码之外，error 对象还包含错误消息和堆栈跟踪。堆栈跟踪对于调试很有用，但是它不应该包含在生产环境中。要禁用错误消息中的堆栈跟踪，您必须将<code class="fe lf lg lh li b">NODE_ENV</code>变量设置为<code class="fe lf lg lh li b">production</code>或<code class="fe lf lg lh li b">test</code>。</p><figure class="lk ll lm ln gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mg"><img src="../Images/51cf88bff7077cc575cc7bc636a10b7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hp1Nz3tQPJqknJkmV75Dsw.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">设置 NODE_ENV</figcaption></figure><p id="83b8" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这样，堆栈跟踪就不会公开:</p><figure class="lk ll lm ln gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mh"><img src="../Images/ae4cfa39fa2d12bac20a4a8b5f5fe7c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZnGX5mHYf_i7E40HWDtclA.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">没有暴露堆栈跟踪的错误</figcaption></figure><p id="4522" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Apollo Server 会在适当的时候自动抛出大多数内置类型的错误。例如，每当传入的操作对服务器的模式无效时，它就会抛出一个<code class="fe lf lg lh li b">ValidationError</code>。有些情况下，您不想向客户端公开实际的错误。例如，错误消息可能包含机密信息，或者对客户端来说毫无意义。在这种情况下，最好覆盖最终的错误消息。为此，有一个简便的方法可以使用。apollo 服务器构造器可以将<code class="fe lf lg lh li b">formatError</code>回调作为输入参数。回调函数只接受一个参数，即错误。在回调返回错误之前，您可以随意处理它。</p><figure class="lk ll lm ln gt jo"><div class="bz fp l di"><div class="mi mj l"/></div></figure><p id="fea0" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">例如，让我们假设发生了一个数据库错误。首先，您必须捕捉错误，因为它包含一些特定于方案的细节，公开这些信息可能会很危险。然后你想返回一般的<code class="fe lf lg lh li b">Internal Server Error.</code>为此，让我们创建一个回调函数，把错误作为输入。首先，检查<code class="fe lf lg lh li b">typeof</code>错误是否是<code class="fe lf lg lh li b">DatabaseError</code>在回调。如果是，则返回一个包含一般消息的新错误；否则，返回错误，不做任何更改。现在将回调传递给 apollo 构造函数。必须添加到<code class="fe lf lg lh li b">formatError</code>键下。</p><figure class="lk ll lm ln gt jo"><div class="bz fp l di"><div class="mk mj l"/></div></figure><p id="f445" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">仅此而已。现在，这些特定的错误不会暴露给用户。到目前为止，一切顺利。但是有没有关于如何用 GraphQL 处理错误的最佳实践呢？当然，他们是。但是要做好这件事，我们必须从头开始。GraphQL 模式必须设计为支持良好的错误处理。它将基于接口和联合类型。在我之前的教程中，我为管理电影 API 创建了一些查询和变体。</p><div class="lo lp gp gr lq lr"><a rel="noopener  ugc nofollow" target="_blank" href="/graphql-for-node-js-developers-pt-2-unions-and-interfaces-772b7bbf761f"><div class="ls ab fo"><div class="lt ab lu cl cj lv"><h2 class="bd io gy z fp lw fr fs lx fu fw im bi translated">面向 Node.js 开发人员的 GraphQL，pt。2-联合和接口</h2><div class="ly l"><h3 class="bd b gy z fp lw fr fs lx fu fw dk translated">良好的模式设计对于创建最好的 GraphQL APIs 至关重要。为此，您必须了解所有可用的工具。在…</h3></div><div class="lz l"><p class="bd b dl z fp lw fr fs lx fu fw dk translated">blog.devgenius.io</p></div></div><div class="ma l"><div class="ml l mc md me ma mf jt lr"/></div></div></a></div><p id="fa8a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">让我们将这个例子扩展到另一个查询。让我们创建一个<code class="fe lf lg lh li b">getMovieById</code>查询。该查询可能返回一部电影或两种错误— <code class="fe lf lg lh li b">MovieNotFoundError</code>或<code class="fe lf lg lh li b">InvalidMovieIdError</code>。我将创建名为<code class="fe lf lg lh li b">BaseError</code>的接口，并将消息设置为必需的。接下来，我将添加接口的两个实现，并创建名为<code class="fe lf lg lh li b">GetMovieByidResult</code>的联合类型。Union 将返回<code class="fe lf lg lh li b">Movie</code>类型或<code class="fe lf lg lh li b">MovieNotFoundError</code>或<code class="fe lf lg lh li b">InvalidMovieIdError. </code>最后要做的事情是创建查询。在这里，您可以看到最终的查询定义:</p><figure class="lk ll lm ln gt jo"><div class="bz fp l di"><div class="mk mj l"/></div></figure><p id="309b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">让我们看看 union 的用法将如何影响解析器。<code class="fe lf lg lh li b">getMovieById</code>解析器功能检查 id 是否为<code class="fe lf lg lh li b">typeOf</code>号。如果没有，就有一个验证错误(<em class="mm">我知道这是一个愚蠢的例子，但是我想告诉你如何处理这个错误</em>😅。)接下来，它检查是否存在具有特定 id 的电影。如果否，则出现电影未找到错误。最后，如果有电影，该函数将返回电影。<strong class="kc io">这里重要的是你要使用</strong> <code class="fe lf lg lh li b">__typename</code> <strong class="kc io">变量并指定返回类型。</strong> Apollo 服务器必须知道解析器返回的是哪种类型。</p><figure class="lk ll lm ln gt jo"><div class="bz fp l di"><div class="mk mj l"/></div></figure><p id="6195" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">准备好解析器功能后，您可以在 apollo studio 中测试它。前端查询还必须区分返回的类型。同样，让我们使用<code class="fe lf lg lh li b">__typename</code>变量来实现。</p><figure class="lk ll lm ln gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mn"><img src="../Images/60a984f999a8a7da49e16b4ca72f02be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cZ_4RZoRylDD7W4vLxhlRQ.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">带有错误处理的 GraphQL 查询</figcaption></figure><p id="2ec4" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">那么，今天就到此为止。干得好！您已经学习了如何处理 GraphQL 的错误。现在，您可以区分实际数据中的错误，并且可以隐藏敏感信息。在文章的最后，我放置了今天课程的全部代码。可以复习一下，总结一下学到的东西。</p><p id="1078" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">请考虑关注我，以免错过下一篇文章。下一次我将讨论 GraphQL 解析器上下文对象。<strong class="kc io">祝您愉快！</strong></p><figure class="lk ll lm ln gt jo"><div class="bz fp l di"><div class="mk mj l"/></div></figure></div></div>    
</body>
</html>