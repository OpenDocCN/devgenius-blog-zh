<html>
<head>
<title>How to perform ETL with AWS lambda using Python?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用 Python 执行 AWS lambda 的 ETL？</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/how-to-perform-etl-with-aws-lambda-using-python-84c7e48ec109?source=collection_archive---------5-----------------------#2022-07-11">https://blog.devgenius.io/how-to-perform-etl-with-aws-lambda-using-python-84c7e48ec109?source=collection_archive---------5-----------------------#2022-07-11</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="fe2d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">使用 AWS Lambda，Python </strong></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/a2ed7d667d532b09f09b86aeafd8be59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V5657K9aMxlzOP8HsXsRSg.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">使用 AWS Lambda 的 ETL</figcaption></figure><p id="a3f5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">AWS Lambda 是一个事件驱动的无服务器计算平台，由 Amazon 作为 Amazon Web Services 的一部分提供。它是一种计算服务，运行代码以响应事件，并自动管理该代码所需的计算资源。AWS Lambda 功能有助于我们专注于核心产品和业务逻辑，而不是管理操作系统(OS)访问控制、供应、扩展等。</p><p id="aac4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">术语“无服务器”是用词不当。幕后的 lambda 服务提供来自云提供商的资源，即服务器。它根据需要扩展 ram、CPU 和其他资源。AWS 负责维护服务器并使其保持最佳状态。这样，我们可以专注于编写代码和为业务提供价值，而不必担心底层资源的供应。开发人员所要做的就是将他们的代码带到 AWS 并进行部署。</p><p id="9b95" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们将使用 Python 编写一个 lambda 函数，从 S3 读取数据，并将其加载到红移表中。我们将利用<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/develop-aws-glue-etl-pipeline-with-python-shell-fe6f66763e9d">上一次会议</a>的代码，这样我们就可以专注于构建 lambda 函数。</p><p id="9289" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">完整的代码可在<a class="ae ky" href="https://github.com/hnawaz007/pythondataanalysis/blob/main/AWS%20Lambda/etl.py" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上获得。代码演练可以在 YouTube 上找到。</p><p id="6756" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">AWS Lambda 使我们能够:</p><ul class=""><li id="5617" class="kz la in jm b jn jo jr js jv lb jz lc kd ld kh le lf lg lh bi translated">用我们最喜欢的语言构建结构良好的 ETL 管道</li><li id="e45e" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">Python 的易用性和预构建库的强大功能</li><li id="0b38" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">以 Python 代码形式创建和管理脚本化数据管道</li><li id="94de" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">基于事件触发您的工作流</li></ul><p id="4b19" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">用库创建 Zip 文件</strong></p><p id="b750" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">第一步是创建一个包含所需库的 zip 文件。通常，我们导入我们的库，如 pandas 或<em class="ln"> pysopg2 </em>来操作数据。因为我们不知道我们的代码将在哪个服务器上运行，所以我们需要确保为我们的函数提供了所需的库。因此，让我们用库创建一个 zip 文件。我有一个名为 python 的新文件夹，它是在命令提示符下打开的。我们将在这个文件夹中安装 python 库。因此，我们可以发出一个 pip install 命令，带有几个附加参数。</p><pre class="kj kk kl km gt lo lp lq lr aw ls bi"><span id="29d3" class="lt lu in lp b gy lv lw l lx ly">pip install --platform manylinux1_x86_64  --only-binary=:all: psycopg2-binary --target ./python psycopg2-binary</span></pre><p id="18d5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">完成后，我们可以将文件夹压缩成一个 zip 文件。</p><p id="1720" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在 AWS 中，我们推出了 lambda 服务。我们将创建一个层，并将一个 zip 文件上传到这个层。因为我们将体系结构设置为 Linux <em class="ln"> x86_64 </em>，所以请确保在这里选择相同的体系结构。对于兼容运行时，我们可以选择多达 15 个，但让我们选择最新的三个。一旦我们指定了所有这些选项，单击创建按钮。我们新创建的层位于层下。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lz"><img src="../Images/99c6410db45447d77bd88f784fd1e8fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RgZ52dsgN45FIybLmPZGrg.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">创建具有依赖关系的层</figcaption></figure><p id="d067" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在我们可以编写 lambda 函数来利用这一层。因此，在函数下，我们将创建一个新函数。我们将从头开始创作。为此函数提供一个名称。在运行时下，我们搜索并选择 python 3.9。默认的体系结构选项很好，让我们单击“创建”按钮。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ma"><img src="../Images/0e701949245703aa3859715f7db0ad7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*b1n7mdRFWC-0NQlUhrSkuw.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">创建 Lambda 函数</figcaption></figure><p id="1f4b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这将我们带到配置页面，在这里我们可以将一个层附加到此功能。让我们向下滚动到层选项，然后单击添加层。在这个屏幕上，我们将选择自定义层。在下拉列表中选择我们的层及其相关版本，并点击添加将该层附加到功能。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mb"><img src="../Images/b44d9d0e4f09e2fcaea2bb182ebbbaea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Rv_ubEpjy-mSjrYXqmCunA.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">将层附加到 Lambda 函数</figcaption></figure><p id="c4ee" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让我们测试一下是否可以导入所需的库。我们在函数中导入<em class="ln"> pyscopg2 </em>并部署更新后的代码。成功后，让我们测试我们的代码。我们创建一个测试事件并点击 test our code。它显示“hello from lambda message ”,表示它运行成功。</p><p id="b9a8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在函数中，让我们从环境变量中导入变量。我们将从环境变量中获取凭证和机密。我们在<em class="ln">配置</em>下定义环境变量。在<em class="ln">通用配置下</em>定位环境变量。使用<em class="ln"> os.environ['key'] </em>我们可以检索环境变量值。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mc"><img src="../Images/8eb6369f87338f693e9032888a5b5f7b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*94jfKUBofYEtlRptNwLE2Q.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">λ环境变量</figcaption></figure><p id="e379" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">使用 pysopg2 连接方法，我们建立了到红移数据库的连接。让我们在变量中定义一个复制命令。这与上一个会话相同，但是我们更改了表名和 S3 对象路径。利用<em class="ln"> f </em>字符串，我们传入局部变量，如 bucket name 和 role <em class="ln"> arn </em>。</p><pre class="kj kk kl km gt lo lp lq lr aw ls bi"><span id="bda1" class="lt lu in lp b gy lv lw l lx ly">#Obtaining the connection to RedShift<br/>    host = os.environ['host']<br/>    user = os.environ['user']<br/>    password = os.environ['password']<br/>    port = os.environ['port']<br/>    role = os.environ['role']<br/>    bucket = os.environ['bucket']<br/>    con=psycopg2.connect(dbname= 'dev', host=host, port=port, user=user, password=password)<br/>    <br/>    <br/>    #Copy Command as Variable<br/>    copy_command=f"""copy  src_dimsalesterritory (salesterritorykey, salesterritoryalternatekey, salesterritoryregion, salesterritorycountry, salesterritorygroup)<br/>    from 's3://{bucket}/public/DimSalesTerritory/RevisedDimSalesTerritory.csv' <br/>    iam_role '{role}'<br/>    DELIMITER ','<br/>    IGNOREHEADER 1;"""</span></pre><p id="9e69" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们从<em class="ln">连接</em>变量创建一个光标，并执行一个<em class="ln">截断表</em>命令和复制命令。在执行之后，我们将这些提交给数据库。像往常一样，不要忘记关闭光标和连接。让我们部署更新后的代码。</p><pre class="kj kk kl km gt lo lp lq lr aw ls bi"><span id="c717" class="lt lu in lp b gy lv lw l lx ly">#Opening a cursor and run copy query<br/>    cur = con.cursor()<br/>    cur.execute("truncate table src_dimsalesterritory;")<br/>    cur.execute(copy_command)<br/>    con.commit()<br/>    <br/>    #Close the cursor and the connection<br/>    cur.close()<br/>    con.close()</span></pre><p id="1161" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们的 lambda 函数准备好了。让我们单击 test 按钮来执行我们的功能。它正在执行并返回最终消息。所以函数执行是成功的。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi md"><img src="../Images/20f10429e4139938a42d314d5d8b4ca8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*auzMY66NRwnEowUPkt6nAQ.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">Lambda 部署和测试</figcaption></figure><p id="af28" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让我们查询这个表，看看这个表是否被填充了。查询成功执行我们在表中有数据。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi me"><img src="../Images/a05006ab4a8ed8c629aaff53e1858518.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5arEyq5YqYr7dwg5nQs8-g.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">红移表</figcaption></figure><p id="6bb2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">所以，这就是我们如何编写一个 lambda 函数来在 AWS 中的服务之间移动数据。我们可以在不同的事件上触发这个 lambda 函数。最常见的情况是，一旦我们在 S3 上有了一个新文件，就会触发 lambda 函数将数据移动到 Glue catalog 或 Redshift 数据库中。</p><p id="eaac" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">结论</strong></p><ul class=""><li id="c606" class="kz la in jm b jn jo jr js jv lb jz lc kd ld kh le lf lg lh bi translated">我们已经使用 Python 成功地在 AWS Lambda 中实现了 ETL。</li><li id="6c0b" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">我们展示了如何创建一个具有包依赖关系的 zip 文件。</li><li id="68b6" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">我们使用 Python 和 AWS Lambda 实现了 ETL(提取和加载)管道。</li><li id="099b" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">完整的代码可以在<a class="ae ky" href="https://github.com/hnawaz007/pythondataanalysis/blob/main/AWS%20Lambda/etl.py" rel="noopener ugc nofollow" target="_blank">这里</a>找到</li></ul></div></div>    
</body>
</html>