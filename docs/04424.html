<html>
<head>
<title>Start/Stop Your AWS Instances On Schedule</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">按计划启动/停止AWS实例</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/start-stop-your-aws-instances-on-schedule-e27f364c04a3?source=collection_archive---------0-----------------------#2021-03-16">https://blog.devgenius.io/start-stop-your-aws-instances-on-schedule-e27f364c04a3?source=collection_archive---------0-----------------------#2021-03-16</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="8028" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">您是否曾经希望EC2实例只在一天/一周或一个月的特定时间运行，或者发现很难定期手动打开/关闭许多EC2实例？接着往下读:)</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/b06df0e75f05f5ad3aee137e8c743e9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_v2BSJ4W1vJGHVPC-PWMqQ.png"/></div></div></figure><p id="ac45" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在许多情况下，您会真心希望有一个系统，能够以很少的投资自动管理实例的正常运行时间。这里有几个</p><ul class=""><li id="71ae" class="ku kv in jm b jn jo jr js jv kw jz kx kd ky kh kz la lb lc bi translated">通常，您公司的开发和测试云环境在周末或假日会闲置，但它最终会为这段时间的资源付费，因为AWS会按实例运行的小时数收费。</li><li id="f998" class="ku kv in jm b jn ld jr le jv lf jz lg kd lh kh kz la lb lc bi translated">充分了解员工心理健康和福利的重要性后，您希望通过管理虚拟机的正常运行时间来严格控制工作时间。</li><li id="e225" class="ku kv in jm b jn ld jr le jv lf jz lg kd lh kh kz la lb lc bi translated">你有几个个人项目正在运行，并且不想为你没有使用资源的所有时间付费。</li></ul><p id="9f9b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在本文中，让我们探索一种方法，允许我们使用无服务器计算服务(<a class="ae li" href="https://aws.amazon.com/lambda/" rel="noopener ugc nofollow" target="_blank"> AWS Lambda </a>)结合<a class="ae li" href="https://aws.amazon.com/eventbridge/" rel="noopener ugc nofollow" target="_blank">亚马逊</a> <a class="ae li" href="https://aws.amazon.com/eventbridge/" rel="noopener ugc nofollow" target="_blank"> CloudWatch </a>来按计划启动和停止各种AWS实例。</p><h2 id="b710" class="lj lk in bd ll lm ln dn lo lp lq dp lr jv ls lt lu jz lv lw lx kd ly lz ma mb bi translated">步骤1:创建IAM权限策略</h2><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mc"><img src="../Images/d35da08b34b2b143740f4c13d63ccfe8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M4I9tGAVnLx15TMJJ_B8HA.png"/></div></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">转到IAM -&gt;策略-&gt;单击创建策略</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mh"><img src="../Images/bba0216d13218ea194fbd632358cd440.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tnflM77vr4UJFN4aZTIxXQ.png"/></div></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">选择JSON</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mi"><img src="../Images/0e288afc1305dc4c08a672538ddaceb2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1sKFD8b9Jzukni1pbd-0bQ.png"/></div></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">粘贴以下JSON</figcaption></figure><pre class="kj kk kl km gt mj mk ml mm aw mn bi"><span id="f422" class="lj lk in mk b gy mo mp l mq mr">{<br/>    "Version": "2012-10-17",<br/>    "Statement": [<br/>        {<br/>            "Effect": "Allow",<br/>            "Action": [<br/>                "logs:CreateLogGroup",<br/>                "logs:CreateLogStream",<br/>                "logs:PutLogEvents"<br/>            ],<br/>            "Resource": "arn:aws:logs:*:*:*"<br/>        },<br/>        {<br/>            "Effect": "Allow",<br/>            "Action": [<br/>                "ec2:Start*",<br/>                "ec2:Stop*"<br/>            ],<br/>            "Resource": "*"<br/>        }<br/>    ]<br/>}</span></pre><p id="2e9b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这里我们创建了一个权限策略，它必须对EC2实例(仅限于开始/停止)和<a class="ae li" href="https://aws.amazon.com/eventbridge/" rel="noopener ugc nofollow" target="_blank"> Amazon CloudWatch </a>进行写访问。</p><h2 id="c97f" class="lj lk in bd ll lm ln dn lo lp lq dp lr jv ls lt lu jz lv lw lx kd ly lz ma mb bi translated">步骤2:创建一个角色并附加上述策略</h2><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ms"><img src="../Images/f3c43a104bb181fb5dd573c28c368f77.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yQQu291y99Xv5-mvFCtMZQ.png"/></div></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">创建角色</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mt"><img src="../Images/4d4701160a28723bee9398b3de0503ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9Id2x1JB1Rh4oUfudndrJg.png"/></div></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">选择λ</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mu"><img src="../Images/99e41a89bae7f0e3bacc141c43eedfc9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eoWxKMG9kZRIJg3kxKhcCw.png"/></div></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">搜索您创建的策略并选择</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mv"><img src="../Images/f407c736224174cdd38c1f5dd0b4686f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KOHILzaUTi80PsdAErz6uA.png"/></div></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">审核角色并创建</figcaption></figure><h2 id="56c5" class="lj lk in bd ll lm ln dn lo lp lq dp lr jv ls lt lu jz lv lw lx kd ly lz ma mb bi translated">步骤3:为启动/停止创建Lambda函数。</h2><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mw"><img src="../Images/48e4a119fb925db4ade3ec6097002be1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*alvL_8ss94aiANoSs3KZgw.png"/></div></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">搜索λ</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mx"><img src="../Images/f44f4a8abc38493ca38a9636e973f928.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*f-fPMtmuXrppeoxIq98DqQ.png"/></div></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">创建功能</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi my"><img src="../Images/6c73bcf343d8d5c3c4321dfb20730e43.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AhiVXtfTC5wmuHAJagFPWA.png"/></div></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">给出适当的信息并选择创建函数。</figcaption></figure><p id="19c6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在此过程中，我们可以为此功能分配一个执行角色。通过选择我们刚刚创建的角色，我们为我们的函数提供了启动/停止实例和向Amazon CloudWatch写入日志的权限。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mz"><img src="../Images/09a9e80468c32d4ce935347c906b91e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ehKp-ofLi1Jk64G0eEx0uQ.png"/></div></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">从下面复制代码</figcaption></figure><p id="5917" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">启动实例</p><pre class="kj kk kl km gt mj mk ml mm aw mn bi"><span id="0c35" class="lj lk in mk b gy mo mp l mq mr">import boto3</span><span id="6470" class="lj lk in mk b gy na mp l mq mr"># example: ap-south-1, us-east-1, ap-northeast-3<br/>region = 'region-name'</span><span id="f43a" class="lj lk in mk b gy na mp l mq mr"># provide IDs of your instances in a comma separated fashion.<br/>instances = ['i-03cec7ac7e4as32', 'i-03ccec42127e4a']</span><span id="ebc3" class="lj lk in mk b gy na mp l mq mr">ec2 = boto3.client('ec2', region_name=region)</span><span id="c8cf" class="lj lk in mk b gy na mp l mq mr">def lambda_handler(event, context):<br/>    ec2.start_instances(InstanceIds=instances)<br/>    print('started your instances: ' + str(instances))</span></pre><p id="fc2c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">类似地，创建另一个停止实例的函数。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mz"><img src="../Images/09a9e80468c32d4ce935347c906b91e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ehKp-ofLi1Jk64G0eEx0uQ.png"/></div></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">从下面复制代码</figcaption></figure><p id="adf1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">停止实例</p><pre class="kj kk kl km gt mj mk ml mm aw mn bi"><span id="abf9" class="lj lk in mk b gy mo mp l mq mr">import boto3</span><span id="3a30" class="lj lk in mk b gy na mp l mq mr"># region-name can be ap-south-1<br/>region = 'region-name'</span><span id="eef4" class="lj lk in mk b gy na mp l mq mr"># provide IDs of your instances in a comma separated fashion.<br/>instances = ['i-03cec7ac7e4as32', 'i-03ccec42127e4a']</span><span id="4ea6" class="lj lk in mk b gy na mp l mq mr">ec2 = boto3.client('ec2', region_name=region)</span><span id="c590" class="lj lk in mk b gy na mp l mq mr">def lambda_handler(event, context):<br/>    ec2.stop_instances(InstanceIds=instances)<br/>    print('stopped your instances: ' + str(instances))</span></pre><h2 id="77f8" class="lj lk in bd ll lm ln dn lo lp lq dp lr jv ls lt lu jz lv lw lx kd ly lz ma mb bi translated">步骤4:计划启动/停止Lambda函数的执行</h2><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nb"><img src="../Images/24f51eb249ff4f03c7a3747c390a9179.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fVS1S5BlKT8dTk04t0nFSA.png"/></div></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">前往云观察并创建一个规则</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nc"><img src="../Images/4bedcf5e798185a41432f76c4f15183b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u1wtuWBEkw-tA7jIdeCroQ.png"/></div></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">输入您的Cron表达式</figcaption></figure><p id="354f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">样本Cron表达式<a class="ae li" href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/events/ScheduledEvents.html#CronExpressions" rel="noopener ugc nofollow" target="_blank">此处</a>。如果您的表达式正确，您应该会看到接下来的10个触发日期。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nd"><img src="../Images/1984476bdc584585813f06daf3df1cba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2xndV4v4AUiLd_uL2mRS_w.png"/></div></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">附加lambda函数开始实例。</figcaption></figure><p id="43bd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">类似地创建另一个规则并附加stop实例lambda函数。</strong></p><h1 id="616b" class="ne lk in bd ll nf ng nh lo ni nj nk lr nl nm nn lu no np nq lx nr ns nt ma nu bi translated">日志</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nd"><img src="../Images/e02baf17899a591c9c68600d73871b57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KK9WvW1WBhlAXhI-EKtKdQ.png"/></div></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">访问CloudWatch下的日志组，查看自己的日志。</figcaption></figure><h1 id="87cd" class="ne lk in bd ll nf ng nh lo ni nj nk lr nl nm nn lu no np nq lx nr ns nt ma nu bi translated">摘要</h1><p id="7fba" class="pw-post-body-paragraph jk jl in jm b jn nv jp jq jr nw jt ju jv nx jx jy jz ny kb kc kd nz kf kg kh ig bi translated">总之，我们创建了启动/停止实例的lambda函数、以预定方式触发这些函数的CloudWatch规则、允许这些函数代表我们管理AWS资源的IAM策略和角色。</p><p id="543f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在我的例子中，我有几个脚本在一周的某一天运行，我注意到让机器一直运行是非常昂贵和浪费的。这让我做了一些研究，并提出了这个解决方案。如果你是一个小开发人员，你可以使用这种方法来控制EC2实例的正常运行时间，对于企业和其他人来说，AWS实例调度器似乎是最好的选择，尽管这是有代价的。</p></div></div>    
</body>
</html>