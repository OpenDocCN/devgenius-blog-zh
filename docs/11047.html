<html>
<head>
<title>Introduction to Cassandra DB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Cassandra DB 简介</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/introduction-to-cassandra-db-b49729c5789d?source=collection_archive---------22-----------------------#2022-12-14">https://blog.devgenius.io/introduction-to-cassandra-db-b49729c5789d?source=collection_archive---------22-----------------------#2022-12-14</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="3b33" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">Apache Cassandra，由脸书的 Avinash Lakshman 开发的 NoSQL 数据库，用于增强收件箱搜索。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/6c4ad48b4cfab2a2673378defe2c9923.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NDDohLESgr2pU4Bh"/></div></div></figure><p id="76d6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">Cassandra 是一个高性能和可靠的数据库，被一些大公司使用，如 Discord、网飞、Spotify、<a class="ae kv" href="https://cassandra.apache.org/_/case-studies.html" rel="noopener ugc nofollow" target="_blank">等</a>。Cassandra 的主要优势之一是，它可以跨商用服务器处理大量结构化数据，同时提供高数据可用性和无单点故障。与其他 NoSQL 数据库不同，Cassandra 以一种称为<a class="ae kv" href="https://db-engines.com/en/article/Wide+Column+Stores" rel="noopener ugc nofollow" target="_blank"> <strong class="jm io"> <em class="ki">宽列存储</em> </strong> </a>的面向<em class="ki">列的</em>方式存储数据，这是一种 NoSQL 数据库，它将数据存储在<em class="ki">列</em>而不是<em class="ki">行</em>中。宽列存储通常用于需要快速访问大量数据的应用，例如<em class="ki">实时分析</em>和<em class="ki">互联网规模的应用</em>。</p><p id="773f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">Cassandra 是一个分布式数据库，它在一个节点集群上均匀地存储数据。一个<a class="ae kv" href="https://databasemanagement.fandom.com/wiki/Distributed_Database_Management_System_(DDBMS)" rel="noopener ugc nofollow" target="_blank">分布式数据库</a>是一个数据库，其中的存储设备并不都连接到一个公共的 CPU。它可以存储在位于同一物理位置的多台计算机中，或者存储在互连系统的网络上。</p><h2 id="f644" class="kw kx in bd ky kz la dn lb lc ld dp le jv lf lg lh jz li lj lk kd ll lm ln lo bi translated">环形拓扑</h2><p id="5d42" class="pw-post-body-paragraph jk jl in jm b jn lp jp jq jr lq jt ju jv lr jx jy jz ls kb kc kd lt kf kg kh ig bi translated">一个<strong class="jm io"> <em class="ki">簇</em> </strong>在 Cassandra 架构中表示为一个<strong class="jm io"> <em class="ki">环</em> </strong>。下图显示了一个<em class="ki">环表示，</em>每个节点都有一个初始<strong class="jm io"> <em class="ki">令牌范围</em> </strong>，该范围决定了它在环中的位置以及它将存储的数据范围，每个节点都被分配了一个令牌，并负责从<strong class="jm io"> <em class="ki">前一个令牌(独占)到该节点的令牌(包含)</em> </strong>的令牌值。</p><p id="d6e9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果你读到这里感到困惑，我不怪你。看看下图，有六个节点，每个节点存储的值范围从-29 到 30。节点 4 将存储值在 1-10 范围内的记录，1 除外。类似地，节点 6 拥有从 21 到 30 的值。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi lu"><img src="../Images/c6b3a57d8daf95b5f9d6e3c9444c0bef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*wb7Wkp8Sk5SHMyzJ.png"/></div></div><figcaption class="lv lw gj gh gi lx ly bd b be z dk translated">簇的环表示</figcaption></figure><h2 id="d263" class="kw kx in bd ky kz la dn lb lc ld dp le jv lf lg lh jz li lj lk kd ll lm ln lo bi translated">八卦协议</h2><p id="47b1" class="pw-post-body-paragraph jk jl in jm b jn lp jp jq jr lq jt ju jv lr jx jy jz ls kb kc kd lt kf kg kh ig bi translated">Cassandra 使用一种名为<a class="ae kv" href="https://docs.datastax.com/en/cassandra-oss/3.x/cassandra/architecture/archGossipAbout.html" rel="noopener ugc nofollow" target="_blank"> <em class="ki">八卦</em> </a> <em class="ki">，</em>的协议，这是一种对等通信协议，其中节点定期交换关于它们自己和它们知道的其他节点的状态信息。这是在最多 3 个节点的情况下完成的，以避免网络过载，这也有助于检测<a class="ae kv" href="https://docs.datastax.com/en/cassandra-oss/3.x/cassandra/architecture/archDataDistributeFailDetect.html" rel="noopener ugc nofollow" target="_blank">节点故障</a>。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi lz"><img src="../Images/69723cead2c3e44e070ac1428b791b21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VkGhUNZbn505nZW3r2AawQ.png"/></div></div><figcaption class="lv lw gj gh gi lx ly bd b be z dk translated">协调员和八卦协议</figcaption></figure><p id="7d81" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">客户端可以连接到集群中的任何节点，因为 Cassandra 是一个对等网络。这使得所有节点都是平等的。连接的节点称为<code class="fe ma mb mc md b">coordinator</code>节点，它启动查询并识别哪些节点在该令牌范围内存储数据，并将查询转发给它们。在上图中，<em class="ki">客户端</em>向节点 5 <em class="ki">(协调器)</em>发出请求，节点 5<em class="ki">(协调器)<em class="ki"/>向三个节点发出请求，存储该散列值的节点将返回数据。</em></p><h2 id="cb5b" class="kw kx in bd ky kz la dn lb lc ld dp le jv lf lg lh jz li lj lk kd ll lm ln lo bi translated">分割</h2><p id="ea6d" class="pw-post-body-paragraph jk jl in jm b jn lp jp jq jr lq jt ju jv lr jx jy jz ls kb kc kd lt kf kg kh ig bi translated">令牌是称为<strong class="jm io"> <em class="ki">分区器</em> </strong>的散列函数的结果，它使用<strong class="jm io"> <em class="ki">行/分区键</em> </strong>来确定哪个节点存储哪个数据。划分器使用两个哈希函数，称为<strong class="jm io"><em class="ki">mur mur 3 partitioner</em></strong>和<strong class="jm io"><em class="ki">random partitioner</em></strong>，将数据均匀分布在整个环中。</p><p id="a8ad" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">默认情况下，Cassandra 使用<strong class="jm io"> <em class="ki"> Murmur3Partitioner。区分这些划分器的是它们的散列函数。<strong class="jm io"><em class="ki">random partitioner</em></strong>使用加密哈希函数<strong class="jm io"> </strong>和<strong class="jm io"><em class="ki">mur 3 partitioner</em></strong>使用非加密哈希函数<strong class="jm io">。</strong>一般来说，加密哈希函数是非性能的，需要较长的时间。</em></strong></p></div><div class="ab cl me mf hr mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="ig ih ii ij ik"><p id="545c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让我们通过一个例子来更好地理解这一点。让我们创建一个表来存储产品的用户评论和评级。</p><pre class="kk kl km kn gt ml md mm bn mn mo bi"><span id="4a4f" class="mp kx in md b be mq mr l ms mt">CREATE TABLE product_reviews(<br/>   orderId uuid(),<br/>   productId uuid(), <br/>   userId uuid(),<br/>   userRating float,<br/>   review text,<br/>   created_at timestamp  <br/>   PRIMARY KEY ((productId), userRating));</span></pre><p id="7868" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">上面的片段看起来很像 SQL，但它是 Cassandra 的一个略微修改的版本，叫做 CQL<a class="ae kv" href="https://cassandra.apache.org/doc/latest/cassandra/cql/" rel="noopener ugc nofollow" target="_blank"><strong class="jm io"><em class="ki">(Cassandra Query Langauge)</em></strong></a>。拥有一种类似 SQL 的查询语言使事情变得更容易，但只是表面上的。为了充分利用宽列概念的优势，您仍然需要理解深刻而基本的差异。</p><p id="9e75" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">对你来说最突出的事情是:</p><ol class=""><li id="bba7" class="mu mv in jm b jn jo jr js jv mw jz mx kd my kh mz na nb nc bi translated"><code class="fe ma mb mc md b">uuid()</code>是一个<a class="ae kv" href="https://docs.datastax.com/en/cql-oss/3.3/cql/cql_reference/cql_data_types_c.html#" rel="noopener ugc nofollow" target="_blank"> CQL 数据类型</a>，它生成一个随机的 4 型 UUID。</li><li id="9826" class="mu mv in jm b jn nd jr ne jv nf jz ng kd nh kh mz na nb nc bi translated"><code class="fe ma mb mc md b">PRIMARY KEY()</code>，一般在 SQL 中你只有一个 PK，Cassandra 允许你有多个列作为复合或复合主键。位置决定它是什么类型的列。第一列是<strong class="jm io"> <em class="ki">分区/行键</em> </strong>，后面的列称为<strong class="jm io"> <em class="ki">聚簇键</em> </strong>，用于对分区中的数据进行排序。</li></ol><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi ni"><img src="../Images/86774f3747b91e0746cfbb956ac3f6ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O-Mn0oUJtUbl6vF15EVwkA.png"/></div></div><figcaption class="lv lw gj gh gi lx ly bd b be z dk translated">对分区密钥进行哈希运算的分区程序</figcaption></figure><p id="9158" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">上面的图像显示了我们的<code class="fe ma mb mc md b">product_reviews</code>表。对分区键<em class="ki"> (productId) </em>进行哈希运算，使用簇键<em class="ki"> (userRating) </em>对表进行排序。</p><h2 id="cdd1" class="kw kx in bd ky kz la dn lb lc ld dp le jv lf lg lh jz li lj lk kd ll lm ln lo bi translated">分身术</h2><p id="31a5" class="pw-post-body-paragraph jk jl in jm b jn lp jp jq jr lq jt ju jv lr jx jy jz ls kb kc kd lt kf kg kh ig bi translated">Cassandra 促进了复制，以确保可靠性和容错性。复制策略决定放置副本的节点。Cassandra 在后台异步复制数据。</p><p id="0aec" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">集群中副本的数量称为<a class="ae kv" href="https://docs.datastax.com/en/cassandra-oss/3.0/cassandra/architecture/archDataDistributeReplication.html" rel="noopener ugc nofollow" target="_blank">复制因子</a> <em class="ki"> (RF) </em>。本质上，这是根据设置的因子来存储集群中每一行的副本。也就是说，RF 为 1 将导致只有一个副本，类似地，RF 为 2 将存储每行的两个副本，其中每个副本位于不同的节点上。</p><p id="ed7f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">所有的复制品都同样重要；没有主副本或主副本。一般来说，复制系数不应超过群集中的节点数。</p><p id="beac" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">因此，分区和复制使 Cassandra 成为一个高可用的数据存储库，具有<strong class="jm io"> <em class="ki">最终一致性</em> </strong>。</p><h2 id="c077" class="kw kx in bd ky kz la dn lb lc ld dp le jv lf lg lh jz li lj lk kd ll lm ln lo bi translated">一致性水平</h2><p id="8527" class="pw-post-body-paragraph jk jl in jm b jn lp jp jq jr lq jt ju jv lr jx jy jz ls kb kc kd lt kf kg kh ig bi translated">以上段落中的<em class="ki">“最终一致性”</em>是什么意思？复制要求所有副本中的数据同步。这被称为数据一致性。最终一致意味着所有更新最终到达所有副本<strong class="jm io"/>。</p><p id="85ec" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">默认情况下，Cassandra 将一致性设置为<strong class="jm io">1，</strong>这表示，“嘿，如果您在一个副本节点上写/读，就足够了”。这个水平总体上是令人满意的和有成效的。一致性是<a class="ae kv" href="https://docs.datastax.com/en/cassandra-oss/3.0/cassandra/dml/dmlConfigConsistency.html" rel="noopener ugc nofollow" target="_blank">可调的</a>在 Cassandra 中，有不同的级别来提供不同级别的一致性和性能。</p><h2 id="25e6" class="kw kx in bd ky kz la dn lb lc ld dp le jv lf lg lh jz li lj lk kd ll lm ln lo bi translated">经验法则</h2><p id="39f0" class="pw-post-body-paragraph jk jl in jm b jn lp jp jq jr lq jt ju jv lr jx jy jz ls kb kc kd lt kf kg kh ig bi translated">在 Cassandra 中建模数据库时需要记住的一些经验法则；</p><ul class=""><li id="7acf" class="mu mv in jm b jn jo jr js jv mw jz mx kd my kh nj na nb nc bi translated">Cassandra 不应该像关系数据库那样建模。</li><li id="d7cd" class="mu mv in jm b jn nd jr ne jv nf jz ng kd nh kh nj na nb nc bi translated">数据建模应该优先考虑查询，在 Cassandra 中，您只能使用主键进行查询，并且只能使用聚簇键进行范围搜索。</li><li id="681e" class="mu mv in jm b jn nd jr ne jv nf jz ng kd nh kh nj na nb nc bi translated">Cassandra 不支持<strong class="jm io">连接</strong>，也没有任何<strong class="jm io">参照完整性</strong>。您可以在其他表中包含记录的外键，但它们必须通过客户端连接来访问。</li><li id="a637" class="mu mv in jm b jn nd jr ne jv nf jz ng kd nh kh nj na nb nc bi translated">如上所述，没有连接，这意味着您必须<strong class="jm io">去规范化</strong>您的表。</li><li id="54f7" class="mu mv in jm b jn nd jr ne jv nf jz ng kd nh kh nj na nb nc bi translated">最小化一次查询读取的分区数量。如<a class="ae kv" href="#d263" rel="noopener ugc nofollow"> gossip 协议</a>中的图像所示，协调器接收查询，然后将其转发到其他节点，当客户端发送查询以读取多个分区时，这可能是昂贵的，因为每个分区都在自己的不同节点中。对于您请求的每个分区，协调器需要向单独的节点发出单独的命令。这增加了开销并增加了延迟的变化。</li><li id="dbe9" class="mu mv in jm b jn nd jr ne jv nf jz ng kd nh kh nj na nb nc bi translated">您的分区必须是均匀分布的，因此选择具有高基数的分区键来绕过热点，在这些热点中，一些节点处于高压力下，而其他节点处于空闲状态。</li></ul><p id="2ee4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">你可以在 Cassandra <a class="ae kv" href="https://www.instaclustr.com/blog/cassandra-data-modeling/" rel="noopener ugc nofollow" target="_blank">这里</a>阅读更多关于数据建模的内容。</p></div><div class="ab cl me mf hr mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="ig ih ii ij ik"><h1 id="fd38" class="nk kx in bd ky nl nm nn lb no np nq le nr ns nt lh nu nv nw lk nx ny nz ln oa bi translated">结论</h1><p id="a10d" class="pw-post-body-paragraph jk jl in jm b jn lp jp jq jr lq jt ju jv lr jx jy jz ls kb kc kd lt kf kg kh ig bi translated">随着越来越多的语言支持和它在行业中的声誉，Cassandra 已经一路攀升。Cassandra 具有专为性能而设计的特性，它也可以在商用服务器上运行。它的竞争对手绝不逊色。到目前为止，顶级的 NoSQL 数据库，如 MongoDB、PostgreSQL 或 Redis 不仅很受欢迎，而且受到许多开发人员的喜爱。它们有很好的文档记录，提供了 NoSQL 数据库的所有优点，并且有出色的语言支持。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi ob"><img src="../Images/9f399ea1393da28cbc7a11d98cf72ad1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*elYPT1jf0CbVyAChrFhbJQ.png"/></div></div><figcaption class="lv lw gj gh gi lx ly bd b be z dk translated"><a class="ae kv" href="https://db-engines.com/en/ranking_trend" rel="noopener ugc nofollow" target="_blank">2022 年 12 月 DB-发动机排名</a></figcaption></figure><p id="d1e3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">作为一名开发人员，我们关心的主要问题之一是数据存储和检索的性能，最终，一个应用程序的最佳数据库将取决于它的特定需求。</p></div></div>    
</body>
</html>