<html>
<head>
<title>Sharding in Golang with benchmarks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Golang ä¸­çš„åˆ†ç‰‡ä¸åŸºå‡†</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://blog.devgenius.io/sharding-in-golang-with-benchmarks-e72e1b061657?source=collection_archive---------8-----------------------#2022-05-14">https://blog.devgenius.io/sharding-in-golang-with-benchmarks-e72e1b061657?source=collection_archive---------8-----------------------#2022-05-14</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="dbe0" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">å…³äºæ•°æ®åº“åˆ†ç‰‡çš„å¿«é€Ÿå›å¿†</h2></div><p id="ed26" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">åˆ†ç‰‡æ•°æ®åº“æ˜¯ä¸€ç§æœºåˆ¶ï¼Œé€šè¿‡å°†æ•°æ®åº“åˆ†æˆå¤šä¸ªåˆ†åŒº(ç±»ä¼¼äºæ•°æ®åº“åˆ†åŒºæœºåˆ¶)å¹¶å°†å®ƒä»¬å­˜å‚¨åœ¨å‡ ä¸ªå®ä¾‹æˆ–æœåŠ¡å™¨ä¸­æ¥åŠ å¿«æŸ¥è¯¢æˆ–æ›´æ–°æ•°æ®åº“çš„æ—¶é—´ã€‚</p><p id="1dff" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">å»ºè®®åœ¨åº”ç”¨å®ƒä¹‹å‰æ€»æ˜¯å…ˆä»å…¶ä»–æ–¹æ³•å¼€å§‹ï¼Œå› ä¸ºå®ƒä¼šå¢åŠ ä½ çš„æ•°æ®åº“çš„å¤æ‚æ€§ï¼Œæ¯”å¦‚è¿æ¥æ€§ã€ä¸€è‡´æ€§å’Œå‘åå…¼å®¹æ€§ã€‚</p><p id="bfcc" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">ç¢ç‰‡å¯ä»¥æ˜¯é€»è¾‘çš„ä¹Ÿå¯ä»¥æ˜¯ç‰©ç†çš„ã€‚æˆ‘ç”»äº†ä¸‹å›¾æ¥æè¿°è¿™ä¸€ç‚¹</p><p id="8478" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">é€»è¾‘ç¢ç‰‡ä¸ç‰©ç†ç¢ç‰‡</p><p id="2fc1" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><a class="ae ky" href="https://viewer.diagrams.net/?border=0&amp;tags=%7B%7D&amp;highlight=0000ff&amp;edit=_blank&amp;layers=1&amp;nav=1&amp;title=Untitled%20Diagram.drawio&amp;open=Uhttps%3A%2F%2Fdrive.google.com%2Fuc%3Fid%3D1CXWCBxd0aQfT5GSx5waiOBHxwWSj2J36%26export%3Ddownload" rel="noopener ugc nofollow" target="_blank">https://viewer.diagrams.net/?border=0&amp;tags = % 7B % 7D&amp;highlight = 0000 ff&amp;edit = _ blank&amp;layers = 1&amp;nav = 1&amp;title = Untitled % 20 diagram . draw io&amp;open = Uhttps % 3A % 2F % 2f drive . Google . com % 2 fuc % 3 FID % 3 dcxwcbxd 0 aqft 5 gsx 5 waioobhxwwsj2j 36% 26 export % 3d ä¸‹è½½</a></p><p id="e817" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">ç”±äºå…¶å¤æ‚æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ä¾é ç¬¬ä¸‰æ–¹æ¥å¤„ç†ï¼Œå®ƒä½œä¸ºä¸€ä¸ªæ± è¿è¡Œï¼Œåº”ç”¨ç¨‹åºåªéœ€è¿æ¥åˆ°å®ƒï¼Œé€‰æ‹©ç¢ç‰‡çš„å†³å®šå¯ä»¥ç”±æ± å¤„ç†ã€‚æˆ‘ä»¬ç§°ä¹‹ä¸ºåŠ¨æ€åˆ†ç‰‡ã€‚</p><p id="5ce6" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">å¦ä¸€ç§æ–¹æ³•æ˜¯æˆ‘ä»¬å¯ä»¥è‡ªå·±å®ç°åˆ†ç‰‡ï¼Œä½¿ç”¨ä¸€äº›ç®—æ³•æ¥å†³å®šæ¯ä¸ªè¯·æ±‚åº”è¯¥åˆ°è¾¾å“ªä¸ªåˆ†ç‰‡ã€‚æˆ‘ä»¬ç§°ä¹‹ä¸ºç®—æ³•åˆ†ç‰‡ã€‚</p><p id="93c5" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">åŒæ ·ï¼Œè¯·æ³¨æ„ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿æ— è®ºæˆ‘ä»¬ä½¿ç”¨ä»€ä¹ˆæ–¹æ³•ï¼Œå®ƒéƒ½åº”è¯¥æ˜¯ä¸€è‡´çš„å’Œå‘åå…¼å®¹çš„ï¼Œå¦‚æœæ¯æ¬¡å¯¹äºç›¸åŒçš„è¯·æ±‚ï¼Œæˆ‘ä»¬éƒ½ä½¿ç”¨ä¸åŒçš„ç¢ç‰‡ï¼Œæˆ‘ä»¬å°±æ— æ³•å¾—åˆ°æƒ³è¦çš„ç»“æœã€‚ä¸ºäº†å‘åå…¼å®¹ï¼Œå½“æˆ‘ä»¬å†³å®šæ”¹å˜åˆ†ç‰‡ç®—æ³•æ—¶ï¼Œæ—§è®°å½•ä»ç„¶å¯ä»¥ä»¥æŸç§æ–¹å¼è®¿é—®ã€‚</p><p id="e387" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†ä½¿ç”¨åŒæ ·çš„åˆ†ç‰‡æ€æƒ³æ¥å®ç°ä¸€ä¸ªæ‰‹å·¥ç‰ˆæœ¬æ¥å½¢è±¡åŒ–è¿™ä¸ªæ€æƒ³ã€‚</p><h1 id="e6a6" class="kz la in bd lb lc ld le lf lg lh li lj jt lk ju ll jw lm jx ln jz lo ka lp lq bi translated">å®ç°ç¤ºä¾‹</h1><p id="4027" class="pw-post-body-paragraph kc kd in ke b kf lr jo kh ki ls jr kk kl lt kn ko kp lu kr ks kt lv kv kw kx ig bi translated">å®ç°åº”ç”¨äºè¯»å†™è¡¨å• map[key]å€¼çš„ç®—æ³•åˆ†ç‰‡ï¼Œä½ å¯ä»¥æŠŠå®ƒçœ‹ä½œä¸€ä¸ªé”®å€¼æ•°æ®åº“</p><p id="46c9" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="ke io">é—®é¢˜</strong>:</p><p id="c4b6" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">æˆ‘å¼•ç”¨äº† golang åšå®¢ä¸­çš„ä¸€äº›å»ºè®®:</p><blockquote class="lw lx ly"><p id="74e5" class="kc kd lz ke b kf kg jo kh ki kj jr kk ma km kn ko mb kq kr ks mc ku kv kw kx ig bi translated">â€œGo çš„å¹¶å‘åŸè¯­â€”â€”<strong class="ke io">Go routines å’Œ channels</strong>â€”â€”æä¾›äº†ä¸€ç§ä¼˜é›…è€Œç‹¬ç‰¹çš„æ„é€ å¹¶å‘è½¯ä»¶çš„æ–¹æ³•ã€‚Go é¼“åŠ±ä½¿ç”¨é€šé“åœ¨ goroutines ä¹‹é—´ä¼ é€’å¯¹æ•°æ®çš„å¼•ç”¨ï¼Œè€Œä¸æ˜¯æ˜¾å¼åœ°ä½¿ç”¨é”æ¥åè°ƒå¯¹å…±äº«æ•°æ®çš„è®¿é—®ã€‚<a class="ae ky" href="https://go.dev/blog/codelab-share" rel="noopener ugc nofollow" target="_blank">ã€refã€‘</a></p></blockquote><p id="30ee" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">å’Œ</p><blockquote class="lw lx ly"><p id="b263" class="kc kd lz ke b kf kg jo kh ki kj jr kk ma km kn ko mb kq kr ks mc ku kv kw kx ig bi translated"><a class="ae ky" href="https://go.dev/doc/faq#atomic_maps" rel="noopener ugc nofollow" target="_blank">"åœ°å›¾å¹¶å‘ä½¿ç”¨ä¸å®‰å…¨</a>æ²¡æœ‰å®šä¹‰å½“ä½ åŒæ—¶è¯»å†™å®ƒä»¬æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆã€‚å¦‚æœæ‚¨éœ€è¦ä»å¹¶å‘æ‰§è¡Œçš„ goroutines ä¸­è¯»å–å’Œå†™å…¥æ˜ å°„ï¼Œé‚£ä¹ˆè¿™äº›è®¿é—®å¿…é¡»é€šè¿‡æŸç§åŒæ­¥æœºåˆ¶æ¥åè°ƒã€‚ä¿æŠ¤åœ°å›¾çš„ä¸€ä¸ªå¸¸è§æ–¹æ³•æ˜¯ä½¿ç”¨<a class="ae ky" href="https://go.dev/pkg/sync/#RWMutex" rel="noopener ugc nofollow" target="_blank">åŒæ­¥ã€‚rw mutex</a><a class="ae ky" href="https://go.dev/blog/maps" rel="noopener ugc nofollow" target="_blank">ã€refã€‘</a></p></blockquote><p id="5389" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">äº‹å®ä¸Šï¼Œå¹¶ä¸æ€»æ˜¯å¯ä»¥ä½¿ç”¨ goroutine å’Œ channelï¼Œmap å¯èƒ½å°±æ˜¯å…¶ä¸­ä¸€ç§æƒ…å†µã€‚</p><p id="1ea2" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">æˆ‘ä»¬çŸ¥é“åœ¨å¹¶å‘ä¸­ä½¿ç”¨ map æ—¶åº”è¯¥ä½¿ç”¨é”å®šæœºåˆ¶ã€‚</p><p id="d24a" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">è¿™ç§æ–¹æ³•éå¸¸æœ‰æ•ˆï¼Œä½†æ˜¯:</p><p id="7b87" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">ä½¿ç”¨ RWMutexï¼Œåªè¦æ²¡æœ‰å†™é”ï¼Œä»»ä½•è¿›ç¨‹éƒ½å¯ä»¥è·å–è¯»é”ï¼Œå¦ä¸€æ–¹é¢ï¼Œåªæœ‰å½“æ²¡æœ‰ä»»ä½•ç°æœ‰çš„æå‰è¯»å†™é”æ—¶ï¼Œæ‰å¯èƒ½è·å–å†™é”ï¼Œå¹¶ä¸”åœ¨ä»»ä½•æå‰é”è¢«é‡Šæ”¾ä¹‹å‰ï¼Œè·å–é¢å¤–é”çš„å°è¯•å°†è¢«é˜»æ­¢ã€‚</p><p id="161f" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">å½“å¤„ç†è¯¥èµ„æºçš„å¹¶å‘è¿›ç¨‹æ•°é‡æ€¥å‰§å¢åŠ æ—¶ï¼Œè·å–é”å¯èƒ½ä¼šæˆä¸ºç“¶é¢ˆã€‚</p><p id="84cf" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">å‚ç›´åˆ†ç‰‡å°†åº•å±‚æ•°æ®ç»“æ„(map)åˆ†æˆå¤šä¸ªå¯é”å®šçš„ mapï¼Œæœ‰åŠ©äºå‡å°‘é”äº‰ç”¨ã€‚</p><p id="e354" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="ke io">æƒ³æ³•</strong></p><p id="dca2" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">åˆ†å‰² map çš„æœºåˆ¶åº”è¯¥æ˜¯<strong class="ke io">ä¸€è‡´çš„ã€å‘åå…¼å®¹çš„å’Œé˜²å†²çªçš„ã€‚</strong></p><p id="601b" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">ä¸€ç§æ–¹æ³•å¯ä»¥æ˜¯æˆ‘ä»¬é‡‡ç”¨å¯†é’¥(æ ¡éªŒå’Œ)è¾“å…¥çš„<strong class="ke io">æ•£åˆ—ï¼Œå¹¶æ ¹æ®ç¢ç‰‡çš„æ•°é‡è¿›è¡Œæ¨¡è¿ç®—ï¼Œä»¥å½¢æˆä¸€ä¸ªç¢ç‰‡å¯†é’¥ã€‚å¯¹äºæ¯ä¸€ä¸ªè¯·æ±‚ï¼Œæˆ‘ä»¬å°†è®¡ç®—å®ƒå¹¶å°†æ•°æ®å­˜å‚¨åˆ°ç›¸åº”çš„ shard ä¸­ã€‚</strong></p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="82ab" class="mm la in mi b gy mn mo l mp mq">hash := sha1.Sum([]byte(key))<br/>shard_key := hash[17] % numberOfShards // 17 is just an arbitrary number<br/>// Note that the size of checksum sha1 is 160 bits or 20 bytes, the arbitrary<br/>// should be lower than 20</span></pre><p id="6ce3" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="ke io">å®æ–½</strong></p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="8620" class="mm la in mi b gy mn mo l mp mq">// Define shard is a lockable map<br/>type Shard struct {<br/>	m map[string]interface{}<br/>	sync.RWMutex<br/>}<br/><br/>// ShardMap is a collection of shards, an abstraction for read/write data<br/>type ShardMap []*Shard<br/><br/>func makeShardMap(size int) ShardMap {<br/>	m := make([]*Shard, size)<br/>	for i := 0; i &lt; size; i++ {<br/>		s := Shard{m: make(map[string]interface{})}<br/>		m[i] = &amp;s<br/>	}<br/>	return m<br/>}<br/><br/>func (m ShardMap) getShardKey(key string) int {<br/>	hash := sha1.Sum([]byte(key))<br/>	return int(hash[17]) % len(m)<br/>}<br/><br/>func (m ShardMap) GetShard(key string) *Shard {<br/>	shard_key := m.getShardKey(key)<br/>	return m[shard_key]<br/>}<br/><br/>func (m ShardMap) Get(key string) (interface{}, bool) {<br/>	shard := m.GetShard(key)<br/>	shard.RLock()<br/>	defer shard.RUnlock()<br/>	v, ok := shard.m[key]<br/>	return v, ok<br/>}<br/><br/>func (m ShardMap) Set(key string, val interface{}) {<br/>	shard := m.GetShard(key)<br/>	shard.Lock()<br/>	defer shard.Unlock()<br/>	shard.m[key] = val<br/>}<br/><br/>func (m ShardMap) Delete(key string) {<br/>	shard := m.GetShard(key)<br/>	shard.Lock()<br/>	defer shard.Unlock()<br/>	if _, ok := shard.m[key]; ok {<br/>		delete(shard.m, key)<br/>	}<br/>}</span></pre><p id="aa9a" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">test_shard.go</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="3f61" class="mm la in mi b gy mn mo l mp mq">func TestGetSetShard(t *testing.T) {<br/>	in := make(map[string]int)<br/>	sm := makeShardMap(20)<br/>	for i := 0; i &lt; 1000; i += 1 {<br/>		k := randomStr(10)<br/>		v := randomInt(0, 1000000)<br/>		in[k] = v<br/>		fmt.Println("shard key: ", sm.getShardKey(k))<br/>		sm.Set(k, v)<br/>	}<br/><br/>	for k, v := range in {<br/>		r, ok := sm.Get(k)<br/>		require.Equal(t, true, ok)<br/>		require.Equal(t, v, r)<br/>	}<br/>}<br/><br/>// Note that init() will always be called automatically before calling main()<br/>func init() {<br/>	rand.Seed(time.Now().UnixNano())<br/>}<br/>func randomStr(size int) string {<br/>	//Random string of character in ASCII subrange ['A'...'z'] (including '/', '?'...)<br/>	//Start index : 0<br/>	//End index: 'z' - 'A'<br/>	var str strings.Builder<br/>	for size &gt; 0 {<br/>		idx := rand.Intn('z' - 'A')<br/>		str.WriteRune(rune(idx + 'A'))<br/>		size -= 1<br/>	}<br/>	return str.String()<br/>}<br/><br/>func randomInt(min, max int) int {<br/>	return min + rand.Intn(max-min) + 1<br/>}</span></pre><p id="084f" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">ä¸€åˆ‡é¡ºåˆ©ï¼Œ1000 æŠŠé’¥åŒ™æ²¡æœ‰å¤±è´¥ã€‚ä½†æ˜¯å®ƒçš„æ€§èƒ½å¦‚ä½•å‘¢ï¼Ÿ<br/>è®©æˆ‘ä»¬åˆ¶å®šä¸€äº›åŸºå‡†ã€‚</p><h1 id="4963" class="kz la in bd lb lc ld le lf lg lh li lj jt lk ju ll jw lm jx ln jz lo ka lp lq bi translated"><strong class="ak">åŸºå‡†</strong></h1><p id="740b" class="pw-post-body-paragraph kc kd in ke b kf lr jo kh ki ls jr kk kl lt kn ko kp lu kr ks kt lv kv kw kx ig bi translated">æˆ‘ä»¬å°†ç¼–å†™ä¸€ä¸ªç®€å•çš„ç¨‹åºï¼Œå°† 4000 ä¸ªé”®å’Œæ¯ä¸ªé”®å¤§çº¦ 4kB (4000 å­—èŠ‚)çš„æ•°æ®å¤§å°å†™å…¥å•ä¸ªæ˜ å°„ï¼Œè€Œä¸æ˜¯æ˜ å°„çš„ç¢ç‰‡ã€‚æˆ‘ä»¬å°†å…è®¸å¤šè¾¾ 8000 ä¸ª goroutines å¹¶å‘è¯»/å†™</p><p id="e71b" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">é¦–å…ˆï¼Œæˆ‘ä»¬ä½¿ç”¨å•ä¸€åœ°å›¾åˆ›å»ºä¸€ä¸ªç‰ˆæœ¬</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="c967" class="mm la in mi b gy mn mo l mp mq">var wg sync.WaitGroup<br/><br/>type SimpleMap struct {<br/>	m map[string]interface{}<br/>	sync.RWMutex<br/>	sem chan int<br/>	buf chan []byte<br/>}<br/><br/>func makeSimpleMap() *SimpleMap {<br/>	var sm SimpleMap<br/>	sm = SimpleMap{<br/>		m:   make(map[string]interface{}),<br/>		sem: make(chan int, concurrentGoroutineLimit),<br/>		buf: make(chan []byte, numberOfKeys),<br/>	}<br/>	return &amp;sm<br/>}<br/><br/>func (sm *SimpleMap) Write(k string) {<br/>	sm.Lock()<br/>	defer wg.Done()<br/>	defer sm.Unlock()<br/>	sm.sem &lt;- 1<br/>	sm.m[k] = randomBytes(dataSize)<br/>	&lt;-sm.sem<br/>}<br/><br/>func (sm *SimpleMap) Read(k string) {<br/>	sm.RLock()<br/>	defer wg.Done()<br/>	defer sm.RUnlock()<br/>	sm.sem &lt;- 1<br/>	if v, ok := sm.m[k]; ok {<br/>		sm.buf &lt;- v.([]byte)<br/>	} else {<br/>		sm.buf &lt;- make([]byte, dataSize)<br/>	}<br/>	&lt;-sm.sem<br/>}</span></pre><p id="985d" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">ä¸€äº›åŠ©æ‰‹éšæœºç”Ÿæˆå¯†é’¥å’Œç´¢å¼•ã€‚å®ƒéœ€è¦æ—¶é—´ã€‚ç°åœ¨()ã€‚UnixNano ä½œä¸ºç§å­</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="e0ca" class="mm la in mi b gy mn mo l mp mq">func randomString(size int) string {<br/>	return randomBuffer(size).String()<br/>}<br/><br/>func randomBytes(size int) []byte {<br/>	return randomBuffer(size).Bytes()<br/>}<br/><br/>func randomBuffer(size int) *bytes.Buffer {<br/>	var buf bytes.Buffer<br/>	for size &gt; 0 {<br/>		idx := rand.Intn('z' - 'A')<br/>		buf.WriteRune(rune(idx + 'A'))<br/>		size -= 1<br/>	}<br/>	return &amp;buf<br/>}</span></pre><p id="10f4" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">ç®€å•æ˜ å°„çš„æ‰§è¡ŒåŠŸèƒ½</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="db38" class="mm la in mi b gy mn mo l mp mq">func SimpleMapExecute(sm *SimpleMap) {<br/>	var keys [numberOfKeys]string<br/>	for i := 0; i &lt; numberOfKeys; i += 1 {<br/>		keys[i] = randomString(10)<br/>	}<br/>	start := time.Now()<br/>	for i := 0; i &lt; numberOfKeys; i += 1 {<br/>		wg.Add(2)<br/>		go func(key string) {<br/>			sm.Write(key)<br/>		}(keys[i])<br/><br/>		//Read from random key<br/>		idx := rand.Intn(numberOfKeys)<br/><br/>		go func(key string) {<br/>			sm.Read(key)<br/>		}(keys[idx])<br/>	}<br/>	wg.Wait()<br/>	elapsed := time.Since(start)<br/>	fmt.Println("Took: ", elapsed)<br/>}</span></pre><p id="2c8a" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">åœ°å›¾ç¢ç‰‡çš„æ‰§è¡ŒåŠŸèƒ½</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="be76" class="mm la in mi b gy mn mo l mp mq">func ShardMapExecute(sm *ShardMap) {<br/>	var keys [numberOfKeys]string<br/>	for i := 0; i &lt; numberOfKeys; i += 1 {<br/>		keys[i] = randomString(10)<br/>	}<br/>	start := time.Now()<br/>	for i := 0; i &lt; numberOfKeys; i += 1 {<br/>		wg.Add(2)<br/>		data := randomBytes(dataSize)<br/>		go func(key string) {<br/>			defer wg.Done()<br/>			sm.Set(key, data)<br/>		}(keys[rand.Intn(numberOfKeys)])<br/><br/>		go func(key string) {<br/>			defer wg.Done()<br/>			if v, ok := sm.Get(key); ok {<br/>				Buf &lt;- v.([]byte)<br/>			} else {<br/>				Buf &lt;- make([]byte, dataSize)<br/>			}<br/>		}(keys[rand.Intn(numberOfKeys)])<br/>	}<br/>	wg.Wait()<br/>	elapsed := time.Since(start)<br/>	fmt.Println("Took: ", elapsed)<br/>}</span></pre><p id="8eba" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">å‡†å¤‡è¿è¡Œå‚æ•°</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="a6b8" class="mm la in mi b gy mn mo l mp mq">const (<br/>	numberOfKeys             = 4000<br/>	concurrentGoroutineLimit = 8000<br/>	dataSize                 = 2000<br/>)</span></pre><p id="9869" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">æœ€åï¼Œä¸»è¦åŠŸèƒ½</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="9edd" class="mm la in mi b gy mn mo l mp mq">func main() {<br/>	simpleMode := flag.Bool("simple", false, "Run with simple map")<br/>	flag.Parse()<br/><br/>	if *simpleMode {<br/>		fmt.Println("Run with simple map")<br/>		sm := makeSimpleMap()<br/>		SimpleMapExecute(sm)<br/>	} else {<br/>		fmt.Println("Run with shard map")<br/>		shardMap := makeShardMap(20)<br/>		ShardMapExecute(&amp;shardMap)<br/>	}<br/><br/>}</span></pre><p id="0eb6" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">è®©æˆ‘ä»¬çœ‹çœ‹ç»“æœ:</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="31e3" class="mm la in mi b gy mn mo l mp mq">yenle@MacBook-Air-cua-Yen microservice_pattern % go run -race test2.go -simple<br/>Run with simple map<br/>Took:  9.01160475s<br/><br/>yenle@MacBook-Air-cua-Yen microservice_pattern % go run -race test2.go<br/>Run with shard map<br/>Took:  8.007320791s</span></pre><p id="037d" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">å“‡ï¼Œå¢å¼ºå¯ä»¥çœ‹åˆ°äº§åµğŸ˜Š</p><p id="6dce" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">ç°åœ¨å°è¯•ä¸€äº›å…¶ä»–æµ‹è¯•ï¼Œæˆ‘å°†è¿è¡Œ 12000 ä¸ªå¹¶å‘ goroutinesï¼Œå…¶ä¸­ 6000 ä¸ªç”¨äºå†™ï¼Œ6000 ä¸ªç”¨äºè¯»ã€‚(æ³¨æ„ï¼Œæˆ‘æ³¨é‡Šæ‰äº†ä¸Šé¢çš„ä¿¡å·é‡ï¼Œåˆ é™¤äº† 8000 çš„é™åˆ¶)ã€‚é”®çš„æ•°é‡å°†å‡å°‘åˆ° 3000 ä¸ªé”®ã€‚</p><p id="ce17" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">ç¨å¾®ä¿®æ”¹ä¸€ä¸‹æ‰§è¡ŒåŠŸèƒ½:</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="86bf" class="mm la in mi b gy mn mo l mp mq">func SimpleMapExecute(sm *SimpleMap) {<br/>	var keys [numberOfKeys]string<br/>	for i := 0; i &lt; numberOfKeys; i += 1 {<br/>		keys[i] = randomString(10)<br/>	}<br/>	start := time.Now()<br/>	for i := 0; i &lt; numberOfKeys; i += 1 {<br/>		wg.Add(4) //create 4 goroutines for each iteration<br/>		go func(key string) {<br/>			sm.Write(key)<br/>		}(keys[rand.Intn(numberOfKeys)])<br/>		<br/>		go func(key string) {<br/>			sm.Write(key)<br/>		}(keys[rand.Intn(numberOfKeys)])<br/><br/>		go func(key string) {<br/>			sm.Read(key)<br/>		}(keys[rand.Intn(numberOfKeys)])<br/>		<br/>		go func(key string) {<br/>			sm.Read(key)<br/>		}(keys[rand.Intn(numberOfKeys)])<br/>	}<br/>	wg.Wait()<br/>	elapsed := time.Since(start)<br/>	fmt.Println("Took: ", elapsed)<br/>}</span></pre><p id="277f" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">å’Œ</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="c136" class="mm la in mi b gy mn mo l mp mq">func ShardMapExecute(sm *ShardMap) {<br/>	var keys [numberOfKeys]string<br/>	for i := 0; i &lt; numberOfKeys; i += 1 {<br/>		keys[i] = randomString(10)<br/>	}<br/>	start := time.Now()<br/>	for i := 0; i &lt; numberOfKeys; i += 1 {<br/>		wg.Add(4)  //create 4 goroutines for each iteration<br/>		data := randomBytes(dataSize)<br/>		go func(key string) {<br/>			defer wg.Done()<br/>			sm.Set(key, data)<br/>		}(keys[rand.Intn(numberOfKeys)])<br/>		<br/>		go func(key string) {<br/>			defer wg.Done()<br/>			sm.Set(key, data)<br/>		}(keys[rand.Intn(numberOfKeys)])<br/><br/>		go func(key string) {<br/>			defer wg.Done()<br/>			if v, ok := sm.Get(key); ok {<br/>				Buf &lt;- v.([]byte)<br/>			} else {<br/>				Buf &lt;- make([]byte, dataSize)<br/>			}<br/>		}(keys[rand.Intn(numberOfKeys)])<br/>		<br/>		go func(key string) {<br/>			defer wg.Done()<br/>			if v, ok := sm.Get(key); ok {<br/>				Buf &lt;- v.([]byte)<br/>			} else {<br/>				Buf &lt;- make([]byte, dataSize)<br/>			}<br/>		}(keys[rand.Intn(numberOfKeys)])<br/>	}<br/>	wg.Wait()<br/>	elapsed := time.Since(start)<br/>	fmt.Println("Took: ", elapsed)<br/>}</span><span id="db91" class="mm la in mi b gy mr mo l mp mq">const (<br/>	numberOfKeys             = 3000<br/>	concurrentGoroutineLimit = 8000<br/>	dataSize                 = 4000<br/>)</span></pre><p id="2b98" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">å’Œç»“æœ:</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="dc0a" class="mm la in mi b gy mn mo l mp mq">yenle@MacBook-Air-cua-Yen microservice_pattern % go run -race test2.go -simple<br/>Run with simple map<br/>Took:  14.156822542s<br/>yenle@MacBook-Air-cua-Yen microservice_pattern % go run -race test2.go        <br/>Run with shard map<br/>Took:  5.989326334s</span></pre><p id="775d" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">ç§ï¼å·¨å¤§çš„ä¸åŒğŸ˜€</p><p id="de3c" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">å†ç”¨ 4000 æŠŠé’¥åŒ™è¯•è¯•</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="5b11" class="mm la in mi b gy mn mo l mp mq">yenle@MacBook-Air-cua-Yen microservice_pattern % go run -race test2.go -simple<br/>Run with simple map<br/>Took:  19.437610875s<br/>yenle@MacBook-Air-cua-Yen microservice_pattern % go run -race test2.go        <br/>Run with shard map<br/>Took:  8.30976475s</span></pre><p id="65cd" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">ä¸¤å€å¤šçš„é€Ÿåº¦ã€‚</p><p id="b7c0" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">å¥½äº†ï¼Œæœ€åä¸€å¥è¯ï¼Œå¦‚æœä½ è¯»åˆ°è¿™é‡Œï¼Œè°¢è°¢ğŸ˜„å¸–å­åˆ°ç°åœ¨éƒ½æŒºé•¿çš„ã€‚</p><p id="a5d7" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">ä½¿ç”¨åˆ†ç‰‡ä¹Ÿæ˜¯éå¸¸æœ‰è¶£å’Œæœ‰æ•ˆçš„ï¼Œå®ƒä¸ä»…é€‚ç”¨äºè¯»å–/æ›´æ–°åœ°å›¾ï¼Œè¿˜é€‚ç”¨äºä»»ä½•éœ€è¦å¤§é‡ goroutines å¹¶å‘è¿è¡Œçš„ä»»åŠ¡ï¼Œä½†ç¼ºç‚¹æ˜¯å¯èƒ½ä¼šå¢åŠ æ›´å¤šçš„å¤æ‚æ€§ï¼Œå¹¶å¯èƒ½ä»¥æŸç§æ–¹å¼å¯¼è‡´æ­»é”ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ä½¿ç”¨å‰ä»”ç»†æµ‹è¯•ã€‚</p><p id="ca36" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">å¸Œæœ›è¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰æ‰€å¸®åŠ©ã€‚ğŸ™Œ</p></div><div class="ab cl ms mt hr mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="ig ih ii ij ik"><p id="776c" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><em class="lz">æœ€åˆå‘è¡¨äº</em><a class="ae ky" href="https://gist.github.com/Yenle9/6612281c69c86876d824b0374311222a" rel="noopener ugc nofollow" target="_blank"><em class="lz">ã€http://github.comã€‘</em></a><em class="lz">ã€‚</em></p></div></div>    
</body>
</html>