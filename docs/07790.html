<html>
<head>
<title>Ingress in Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes 的入口</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/ingress-in-kubernetes-67a4b843ea4e?source=collection_archive---------6-----------------------#2022-04-23">https://blog.devgenius.io/ingress-in-kubernetes-67a4b843ea4e?source=collection_archive---------6-----------------------#2022-04-23</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/d1aba895ebd7b964ced35fd742503db7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HBorNWCVWDRbJTlJrbLWYg.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">图片来源:<a class="ae jz" href="https://matthewpalmer.net/" rel="noopener ugc nofollow" target="_blank">https://matthewpalmer.net/</a></figcaption></figure><h2 id="9622" class="ka kb in bd kc kd ke dn kf kg kh dp ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">在本地集群中没有入口时会发生什么</h2><blockquote class="kw kx ky"><p id="8268" class="kz la lb lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">初始要求:</p></blockquote><ul class=""><li id="e1a6" class="ly lz in lc b ld le lh li kj ma kn mb kr mc lx md me mf mg bi translated">建立和部署服装店</li><li id="166e" class="ly lz in lc b ld mh lh mi kj mj kn mk kr ml lx md me mf mg bi translated">应该可以在 www.my-apparelstore.com<a class="ae jz" href="http://www.my-apparelstore.com" rel="noopener ugc nofollow" target="_blank">的</a>买到</li></ul><blockquote class="kw kx ky"><p id="b892" class="kz la lb lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">步骤:</p></blockquote><ul class=""><li id="7e96" class="ly lz in lc b ld le lh li kj ma kn mb kr mc lx md me mf mg bi translated">构建应用程序 docker 映像</li><li id="95a8" class="ly lz in lc b ld mh lh mi kj mj kn mk kr ml lx md me mf mg bi translated">在 K8s 集群中部署它(应用 1)</li><li id="6e44" class="ly lz in lc b ld mh lh mi kj mj kn mk kr ml lx md me mf mg bi translated">部署一个数据库 pod (MySQL)</li><li id="20fb" class="ly lz in lc b ld mh lh mi kj mj kn mk kr ml lx md me mf mg bi translated">创建一个集群 ip 服务以使 DB pod 可访问。</li><li id="1152" class="ly lz in lc b ld mh lh mi kj mj kn mk kr ml lx md me mf mg bi translated">创建一个节点端口服务，使外部世界可以访问 app1。</li><li id="3e3a" class="ly lz in lc b ld mh lh mi kj mj kn mk kr ml lx md me mf mg bi translated">图中的节点端口服务是“app1-service ”,它监听 38080 端口。</li><li id="24ef" class="ly lz in lc b ld mh lh mi kj mj kn mk kr ml lx md me mf mg bi translated">应用程序现在可以在<a class="ae jz" href="http://node-ip:38080." rel="noopener ugc nofollow" target="_blank"> http://node-ip:38080 访问。</a></li><li id="2cf0" class="ly lz in lc b ld mh lh mi kj mj kn mk kr ml lx md me mf mg bi translated">创建一个域名为“my-apparel-store”的 DNS，映射到节点 ip。</li><li id="9673" class="ly lz in lc b ld mh lh mi kj mj kn mk kr ml lx md me mf mg bi translated">所以现在网址是<a class="ae jz" href="http://www.my-apparelstore:30080.com" rel="noopener ugc nofollow" target="_blank">www . my-apparelstore:30080 . com</a></li><li id="4079" class="ly lz in lc b ld mh lh mi kj mj kn mk kr ml lx md me mf mg bi translated">为了摆脱端口，创建一个代理服务器，公开端口 80 并重定向到节点的 38080。</li><li id="a02f" class="ly lz in lc b ld mh lh mi kj mj kn mk kr ml lx md me mf mg bi translated">请在 Node-IP 上将 DNS 映射改为 proxy-server-ip。</li><li id="e8f7" class="ly lz in lc b ld mh lh mi kj mj kn mk kr ml lx md me mf mg bi translated">所以现在的网址是<a class="ae jz" href="http://www.my-apparelstore.com" rel="noopener ugc nofollow" target="_blank">www.my-apparelstore.com</a></li></ul><figure class="mn mo mp mq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mm"><img src="../Images/4ead328225b21b92cc0b01b83c6858d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WRAiI1yeE3A9wvxvkpeOYg.png"/></div></div></figure><p id="3d5f" class="pw-post-body-paragraph kz la in lc b ld le lf lg lh li lj lk kj lm ln lo kn lq lr ls kr lu lv lw lx ig bi translated"><strong class="lc io">托管云中没有入口会发生什么</strong></p><blockquote class="kw kx ky"><p id="bc0f" class="kz la lb lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">一切都保持原样，除了几个:</p></blockquote><ul class=""><li id="92d9" class="ly lz in lc b ld le lh li kj ma kn mb kr mc lx md me mf mg bi translated">用负载平衡器服务替换节点端口服务。</li><li id="6bf0" class="ly lz in lc b ld mh lh mi kj mj kn mk kr ml lx md me mf mg bi translated">这将提供与节点端口相同的功能，但也会要求托管云平台提供 NLB。</li><li id="20ed" class="ly lz in lc b ld mh lh mi kj mj kn mk kr ml lx md me mf mg bi translated">所以现在不需要创建代理服务器。</li><li id="7c49" class="ly lz in lc b ld mh lh mi kj mj kn mk kr ml lx md me mf mg bi translated">DNS 指向 NLB ip，而不是以前的代理服务器。</li></ul><figure class="mn mo mp mq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mr"><img src="../Images/a8c08c254a7bd3d8498d42ff6c43aa91.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6vOQIYQebrj4aZzzclvKGA.png"/></div></div></figure><p id="eabd" class="pw-post-body-paragraph kz la in lc b ld le lf lg lh li lj lk kj lm ln lo kn lq lr ls kr lu lv lw lx ig bi translated"><strong class="lc io">如果引入了另一个应用程序，在没有入口的情况下会发生什么</strong></p><blockquote class="kw kx ky"><p id="fcfa" class="kz la lb lc b ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">如果您希望支持另一个应用程序，请更改:</p></blockquote><ul class=""><li id="6414" class="ly lz in lc b ld le lh li kj ma kn mb kr mc lx md me mf mg bi translated">使用类似的设置部署 app2:一个部署、一个负载平衡器服务，如果需要的话，一个单独的 DB pod，等等。</li><li id="cdf6" class="ly lz in lc b ld mh lh mi kj mj kn mk kr ml lx md me mf mg bi translated">此外，除了现有的 app1 的 NLB 和即将推出的 app2 的 NLB2 之外，还需要引入另一个负载平衡器。</li><li id="a84b" class="ly lz in lc b ld mh lh mi kj mj kn mk kr ml lx md me mf mg bi translated">该额外的负载平衡器将根据路由将流量重定向到下游 NLB。</li></ul><figure class="mn mo mp mq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ms"><img src="../Images/05fc60acf34cacb924bf4a2a0e07b24a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vKJkdS5gfGVOkXcHf_ARlQ.png"/></div></div></figure><p id="424c" class="pw-post-body-paragraph kz la in lc b ld le lf lg lh li lj lk kj lm ln lo kn lq lr ls kr lu lv lw lx ig bi translated"><strong class="lc io">挑战</strong></p><ul class=""><li id="c733" class="ly lz in lc b ld le lh li kj ma kn mb kr mc lx md me mf mg bi translated">要引入新的服务或应用程序，您必须重新配置顶级负载平衡器。</li><li id="9799" class="ly lz in lc b ld mh lh mi kj mj kn mk kr ml lx md me mf mg bi translated">如果需要启用 SSL，那么应该在哪里启用，因为可以在不同的级别上启用。</li><li id="1add" class="ly lz in lc b ld mh lh mi kj mj kn mk kr ml lx md me mf mg bi translated">随着应用的扩展，难以管理各种配置。</li></ul><p id="40c6" class="pw-post-body-paragraph kz la in lc b ld le lf lg lh li lj lk kj lm ln lo kn lq lr ls kr lu lv lw lx ig bi translated"><strong class="lc io">最好有:</strong></p><ul class=""><li id="eca9" class="ly lz in lc b ld le lh li kj ma kn mb kr mc lx md me mf mg bi translated">如果可以在集群中管理所有配置。</li><li id="ee5e" class="ly lz in lc b ld mh lh mi kj mj kn mk kr ml lx md me mf mg bi translated">作为 K8s 定义文件，就像在其他 K8s 对象中一样。</li></ul><p id="7936" class="pw-post-body-paragraph kz la in lc b ld le lf lg lh li lj lk kj lm ln lo kn lq lr ls kr lu lv lw lx ig bi translated"><strong class="lc io"> <em class="lb">进入救援。</em> </strong></p><p id="cf7c" class="pw-post-body-paragraph kz la in lc b ld le lf lg lh li lj lk kj lm ln lo kn lq lr ls kr lu lv lw lx ig bi translated"><strong class="lc io">上述配置如何通过入口得到简化</strong></p><figure class="mn mo mp mq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mt"><img src="../Images/aefeca2abd5cfe2ab6d3e6c66a0ead59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*myS9YkZOiZcvpSnte722PA.png"/></div></div></figure><p id="ddca" class="pw-post-body-paragraph kz la in lc b ld le lf lg lh li lj lk kj lm ln lo kn lq lr ls kr lu lv lw lx ig bi translated"><strong class="lc io">什么是入口</strong></p><p id="6b16" class="pw-post-body-paragraph kz la in lc b ld le lf lg lh li lj lk kj lm ln lo kn lq lr ls kr lu lv lw lx ig bi translated">它有两个部分:</p><ul class=""><li id="74cb" class="ly lz in lc b ld le lh li kj ma kn mb kr mc lx md me mf mg bi translated">入口控制器:对 nginx/HAPROXY/trafik/Istio 的抽象，这些基本上是负载平衡解决方案。虽然在创建集群时，默认情况下不会创建。</li><li id="5172" class="ly lz in lc b ld mh lh mi kj mj kn mk kr ml lx md me mf mg bi translated"><strong class="lc io">入口资源</strong>:定义 URL 路由、SSL 证书等一系列配置。</li></ul><p id="2ac1" class="pw-post-body-paragraph kz la in lc b ld le lf lg lh li lj lk kj lm ln lo kn lq lr ls kr lu lv lw lx ig bi translated"><strong class="lc io">入口如何工作</strong></p><ul class=""><li id="2c13" class="ly lz in lc b ld le lh li kj ma kn mb kr mc lx md me mf mg bi translated">比方说，集群中的入口控制器是基于 nginx 构建的。</li><li id="52dd" class="ly lz in lc b ld mh lh mi kj mj kn mk kr ml lx md me mf mg bi translated">入口控制器具有额外的智能来检测任何新的入口资源，挑选它们的配置并应用于 nginx。会议文件。</li><li id="90a8" class="ly lz in lc b ld mh lh mi kj mj kn mk kr ml lx md me mf mg bi translated">类似地，当资源被删除时，入口控制器也会对底层 nginx 配置文件进行更改。</li></ul><p id="0cd1" class="pw-post-body-paragraph kz la in lc b ld le lf lg lh li lj lk kj lm ln lo kn lq lr ls kr lu lv lw lx ig bi translated"><strong class="lc io">入口控制器配置</strong></p><p id="529e" class="pw-post-body-paragraph kz la in lc b ld le lf lg lh li lj lk kj lm ln lo kn lq lr ls kr lu lv lw lx ig bi translated">它是四个 K8s 对象的组合:</p><ul class=""><li id="d142" class="ly lz in lc b ld le lh li kj ma kn mb kr mc lx md me mf mg bi translated"><strong class="lc io">部署【nginx 映像的抽象。</strong></li></ul><pre class="mn mo mp mq gt mu mv mw mx aw my bi"><span id="0a99" class="ka kb in mv b gy mz na l nb nc">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>    name: nginx-ingress-controller<br/>spec:<br/>    replicas: 1<br/>    selector:<br/>        matchLabels:<br/>            name: nginx-ingress<br/>    template:<br/>        metadata:<br/>            labels:<br/>                name: nginx-ingress<br/>        spec:<br/>            containers:<br/>                - name: nginx-ingress-controller<br/>                  image: quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.21.0<br/>            args:<br/>                - /nginx-ingress-controller<br/>                - --configmap=$(POD_NAMESPACE)/nginx-configuration<br/>            env:<br/>                - name: POD_NAME<br/>                  valueFrom:<br/>                    fieldRef:<br/>                        fieldPath: metadata.name<br/>                - name: POD_NAMESPACE<br/>                  valueFrom:<br/>                    fieldRef:<br/>                        fieldPath: metadata.namespace<br/>            ports:<br/>                - name: http<br/>                  containerPort: 80<br/>                - name: https<br/>                  containerPort: 443</span></pre><ul class=""><li id="ff6d" class="ly lz in lc b ld le lh li kj ma kn mb kr mc lx md me mf mg bi translated"><strong class="lc io">服务</strong>:公开部署。</li></ul><pre class="mn mo mp mq gt mu mv mw mx aw my bi"><span id="4d8c" class="ka kb in mv b gy mz na l nb nc">apiVersion: v1<br/>kind: Service<br/>metadata:<br/>    name: nginx-ingress<br/>spec:<br/>    type: NodePort<br/>    ports:<br/>    - port: 80<br/>      targetPort: 80<br/>      protocol: TCP<br/>      name: http<br/>    - port: 443<br/>      targetPort: 443<br/>      protocol: TCP<br/>      name: https<br/>    selector:<br/>      name: nginx-ingress</span></pre><ul class=""><li id="8dbf" class="ly lz in lc b ld le lh li kj ma kn mb kr mc lx md me mf mg bi translated"><strong class="lc io"> ConfigMap </strong>:提供 nginx 配置数据，如 sslprotocol、logpath 等。</li></ul><pre class="mn mo mp mq gt mu mv mw mx aw my bi"><span id="cf54" class="ka kb in mv b gy mz na l nb nc">apiVersion: v1<br/>kind: ConfigMap<br/>metadata:<br/>    name: nginx-configuration</span></pre><ul class=""><li id="62e1" class="ly lz in lc b ld le lh li kj ma kn mb kr mc lx md me mf mg bi translated"><strong class="lc io"> ServiceAccount </strong>:应用入口资源配置。服务帐户必须配置正确的角色集、集群角色和角色绑定。</li></ul><pre class="mn mo mp mq gt mu mv mw mx aw my bi"><span id="7916" class="ka kb in mv b gy mz na l nb nc">apiVersion: v1<br/>kind: ServiceAccount<br/>metadata: <br/>    name: nginx-ingress-serviceaccount</span></pre><p id="e798" class="pw-post-body-paragraph kz la in lc b ld le lf lg lh li lj lk kj lm ln lo kn lq lr ls kr lu lv lw lx ig bi translated"><strong class="lc io">入口资源配置</strong></p><pre class="mn mo mp mq gt mu mv mw mx aw my bi"><span id="0e69" class="ka kb in mv b gy mz na l nb nc">apiVersion: extensions/v1beta1<br/>kind: Ingress<br/>metadata:<br/>    name: ingress-service<br/>spec:<br/>    rules:<br/>    - host: my-apparelstore.com<br/>      http:<br/>        paths:<br/>        - path: /app1<br/>          backend:<br/>            serviceName: app1<br/>            servicePort: 8080<br/>    - host: my-apparelstore.com<br/>      http:<br/>        paths: <br/>        - path: /app2<br/>          backend:<br/>            serviceName: app2<br/>            servicePort: 8080</span></pre></div></div>    
</body>
</html>