<html>
<head>
<title>Encrypt and store uploaded files using AWS S3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 AWS S3 加密和存储上传的文件</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/encrypt-and-store-uploaded-files-using-aws-s3-7f9def79d8df?source=collection_archive---------0-----------------------#2020-03-30">https://blog.devgenius.io/encrypt-and-store-uploaded-files-using-aws-s3-7f9def79d8df?source=collection_archive---------0-----------------------#2020-03-30</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/ea5ac3df6c14ba942c0dd302ffef26e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*G0HU0z4qgsjf_lqa"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">弗洛里安·克拉姆在<a class="ae jz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="c629" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">您是否曾经希望编写一个简单的 web 表单，允许用户上传各种敏感数据，而不必开发复杂的加密机制？</p><p id="e8cc" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这里有一个使用 Amazon Web Services 提供的简单存储服务的令人惊讶的简单解决方案。以下代码片段使用 JavaScriptNode 在后端，Angular 在前端，但是 AWS 文档包含了一系列现代技术的例子，包括 C#和 Java。</p><p id="59d2" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">请注意，本文包含了一些独立的代码片段来提供指导，但它并不是一个完整的指南，并假设您能够进行任何必要的更改和添加，以便将逻辑与您自己的 API 和前端集成。有几个关于如何在 Node 中创建 REST API 的优秀指南，比如 scotch.io 的<a class="ae jz" href="https://scotch.io/tutorials/build-a-restful-api-using-node-and-express-4" rel="noopener ugc nofollow" target="_blank">这个</a></p><p id="b092" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">步骤 1:创建并配置 s3 存储桶</p><p id="fb20" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">出于这篇简短文章的目的，我假设您已经安装了 AWS 控制台。下面是<a class="ae jz" href="http://docs.aws.amazon.com/gettingstarted/latest/awsgsg-intro/gsg-aws-intro.html" rel="noopener ugc nofollow" target="_blank">入门指南</a>。</p><p id="3995" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">登录到您的控制台并访问 s3。点击“创建存储桶”:</p><figure class="kz la lb lc gt jo gh gi paragraph-image"><div class="gh gi ky"><img src="../Images/a3ffa8b337c0a1d34701587cdf9acb34.png" data-original-src="https://miro.medium.com/v2/resize:fit:810/0*9pm067L5bhyy2830"/></div></figure><p id="133a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">将出现存储桶创建向导；选择一个名称，然后单击“创建”。</p><figure class="kz la lb lc gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ld"><img src="../Images/e6914ce826f0a1b2b4382f3a2e66aa1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vmkjsf7Y6K6-h4gF"/></div></div></figure><p id="a155" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">选择您的新 bucket 并打开“Permissions”选项卡。点击“存储桶策略”:</p><figure class="kz la lb lc gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi le"><img src="../Images/db25693d0143b304e4a0788ca094be12.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*gSGYIp8dhpv0YizO"/></div></div></figure><p id="9b65" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">粘贴以下示例策略以实施加密:</p><pre class="kz la lb lc gt lf lg lh li aw lj bi"><span id="7d7b" class="lk ll in lg b gy lm ln l lo lp">{<br/>    "Version": "2012-10-17",<br/>    "Id": "PutObjPolicy",<br/>    "Statement": [<br/>        {<br/>            "Sid": "DenyUnEncryptedObjectUploads",<br/>            "Effect": "Deny",<br/>            "Principal": "*",<br/>            "Action": "s3:PutObject",<br/>            "Resource": "arn:aws:s3:::my-bucket/*",<br/>            "Condition": {<br/>                "StringNotEquals": {<br/>                    "s3:x-amz-server-side-encryption": "aws:kms"<br/>                }<br/>            }<br/>        }<br/>    ]<br/>}</span></pre><p id="073a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在，要创建用户并授予他们访问存储桶的权限，请转到“我的安全凭据”&gt;“用户”和“添加用户”:</p><figure class="kz la lb lc gt jo gh gi paragraph-image"><div class="gh gi lq"><img src="../Images/73b87c9f321415078d3b99400a46f2ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1330/0*MNSLZXN6LLHE9bf4"/></div></figure><p id="9de1" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">给用户一个名称，勾选“编程访问”，然后单击“下一步”:</p><figure class="kz la lb lc gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi lr"><img src="../Images/07a84cbadc8bab84263ed4a8a3487bf3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*DAU-q0U3fq4Gwa7G"/></div></div></figure><p id="09aa" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">选择“直接附加现有策略”并选择 AmazonS3FullAccess:</p><figure class="kz la lb lc gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ls"><img src="../Images/d9f6bdb1ea72732b843f2e37f1ebcd2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hPMhQF7uObUcMudt"/></div></div></figure><p id="fd8d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">还要给他们“ProgrammaticUploadPermission”:</p><figure class="kz la lb lc gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi lt"><img src="../Images/5a041bb04c80ea2a31b608f7588a4f6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*o-HtVVJLf2Rx_SGH"/></div></div></figure><p id="962a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在，您应该可以看到将在代码中使用的访问密钥 ID 和秘密访问密钥—保存它们:</p><figure class="kz la lb lc gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi lu"><img src="../Images/2b3c5210b025b21e981cc9dafa9a986f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*FzIREgDiQQFZSqC4"/></div></div></figure><p id="7769" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">第二步:编写后端逻辑</p><p id="4b4c" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在节点 API 中，安装 AWS-SDK:</p><pre class="kz la lb lc gt lf lg lh li aw lj bi"><span id="8aab" class="lk ll in lg b gy lm ln l lo lp">npm install aws-sdk <em class="lv">--save</em></span></pre><p id="9651" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在你的 API 中编写上传方法:这里有一个通过 Babel 使用 ES6 的例子。同样，这只是一个指南，您的实现可能会有所不同！</p><pre class="kz la lb lc gt lf lg lh li aw lj bi"><span id="645a" class="lk ll in lg b gy lm ln l lo lp">import AWS from 'aws-sdk'<br/> <br/> const uploadFile = (file) =&gt; {<br/>     AWS.config.update({<br/>        'accessKeyId': mys3AccessKeyId,<br/>        'secretAccessKey': mys3SecretAccessKey<br/>     })<br/>     let s3 = new AWS.S3({"signatureVersion":"v4"})<br/>     let key = file.fileName + "." + file.fileExtension<br/>     s3.putObject({<br/>           'Bucket': 'my-bucket',<br/>           'Key': key,<br/>           'Body': new Buffer(file.base64Contents, 'base64'),<br/>           'ACL': 'public-read',<br/>           'ContentType': 'application/pdf',<br/>           'ServerSideEncryption': 'aws:kms'<br/>     }, (err, res) =&gt; {<br/>           return {<br/>                success: true,<br/>                fileUrl: 'https://s3-eu-west-1.amazonaws.com/my-bucket/' + key<br/>           }<br/>     }<br/>}</span></pre><p id="54eb" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">创建一个端点并进行测试。</p><p id="a96b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">第三步:编写前端逻辑</p><p id="9057" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">下面是一个 AngularJS 控制器将文件发布到 API 的示例——根据您的需要，您可以创建一个单独的文件上传服务或工厂来帮助实现可重用性:</p><pre class="kz la lb lc gt lf lg lh li aw lj bi"><span id="18d3" class="lk ll in lg b gy lm ln l lo lp">angular.module('my-app')<br/>.controller('fileUploadController', ['$scope', '$q',<br/>    function($scope, $q) {<br/> <br/>    var self = this;<br/> <br/>    self.getFileReader = function(deferred) {<br/>        var fileReader = new FileReader();<br/>        fileReader.onload = self.onLoad(fileReader, deferred);<br/>        fileReader.onerror = self.onError(fileReader, deferred);<br/>        return fileReader;<br/>    }<br/> <br/>    self.getBase64Contents = function(file) {<br/>        var deferred = $q.defer();<br/>        var fileReader = self.getFileReader(deferred);        <br/>        fileReader.readAsDataURL(file);<br/>        return deferred.promise;<br/>    }<br/> <br/>    $scope.upload = function ($event) {<br/>        var deferred = $q.defer();<br/>        var file = $event.target.files[0];<br/>        <em class="lv">// Implement your validation and error handling</em><br/>        if (!file.Valid) {<br/>            <em class="lv">// Do something</em><br/>        }      <br/>        else {<br/>            return self.getBase64Contents(file).then(function (base64) {<br/>                file.base64Contents = base64;<br/>                $http.post('https://my-endpoint.com/uploadFile', file).then(function(response) {                            <br/>                    deferred.resolve(response)        <br/>                    return deferred.promise;    <br/>                })                                        <br/>            })<br/>        }            <br/>    }<br/>}</span></pre><p id="90f4" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在 HTML 中:</p><pre class="kz la lb lc gt lf lg lh li aw lj bi"><span id="b135" class="lk ll in lg b gy lm ln l lo lp">&lt;input type="file" file-upload="processFile($event)" /&gt;</span></pre><p id="84f5" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">轻松点。</p><p id="628f" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">那么，什么时候应该加密上传的文件呢？</p><p id="71ed" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">任何时候，他们包括个人身份信息，包括用户的姓名，电子邮件地址，其他联系方式，出生日期等。或任何其他敏感信息，如事务日志或业务敏感数据。</p><p id="5e89" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">有关以编程方式访问 s3 bucket 对象的更多信息，请参见<a class="ae jz" href="http://docs.aws.amazon.com/AmazonS3/latest/API/RESTObjectPUT.html" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><p id="9ee0" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">有关桶安全策略的更多信息，请参见<a class="ae jz" href="http://docs.aws.amazon.com/AmazonS3/latest/dev/UsingServerSideEncryption.html" rel="noopener ugc nofollow" target="_blank">此处</a>。</p></div></div>    
</body>
</html>