<html>
<head>
<title>Javascript monkey patching, the art of spying</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Javascript 猴子补丁，间谍的艺术</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/javascript-monkey-patching-the-art-of-spying-cb78a117da91?source=collection_archive---------5-----------------------#2022-06-09">https://blog.devgenius.io/javascript-monkey-patching-the-art-of-spying-cb78a117da91?source=collection_archive---------5-----------------------#2022-06-09</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><figure class="im in gp gr io ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi il"><img src="../Images/28df08a1d00729130fb8c963a0f359b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-xM6u7ww9UKGfwChB1b_aA.png"/></div></div><figcaption class="iw ix gj gh gi iy iz bd b be z dk translated">代码检查</figcaption></figure><div class=""/><h1 id="d7b3" class="jz ka jc bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">什么是猴子打补丁？</h1><p id="c33b" class="pw-post-body-paragraph kx ky jc kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu ig bi translated"><strong class="kz jd">术语“猴子补丁”似乎来自一个更早的术语，游击补丁</strong>，它指的是在运行时偷偷改变代码，并且可能与其他此类补丁不兼容。</p><p id="69d1" class="pw-post-body-paragraph kx ky jc kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">事实上，monkey patching 是一种扩展或修改动态编程语言(如 javascript、python、ruby 等)运行时间的方法。</p><p id="229e" class="pw-post-body-paragraph kx ky jc kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">游击队这个词，几乎和大猩猩同音，为了让声音不那么吓人，变成了猴子。</p><h1 id="3d9e" class="jz ka jc bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">何时使用猴子补丁的用例</h1><p id="363b" class="pw-post-body-paragraph kx ky jc kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu ig bi translated">Monkey patching 更多的是一种调试、体验、修补或破解现有代码的方式，而不是一种针对代码库的长期解决方案，即使它可以在少数特定情况下作为自然解决方案使用。我主要使用猴子补丁来窥探浏览器中现有的应用程序代码库，以了解他们在内部做什么。事实上，偷偷获取一些关于其他开发人员如何想到潜在解决方案的有价值的知识是很方便的。</p><h1 id="ab31" class="jz ka jc bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">示例 1:窥探内置浏览器 API</h1><p id="34bd" class="pw-post-body-paragraph kx ky jc kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu ig bi translated">让我举一个最近的真实例子，猴子补丁帮助我解决了这个问题。</p><p id="a381" class="pw-post-body-paragraph kx ky jc kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">当时我在一家流媒体公司上班。我们在网上发布视频。然而，这很复杂，因为我们需要考虑许多标准，包括加密。</p><p id="909b" class="pw-post-body-paragraph kx ky jc kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">每个流媒体公司都在使用 EME 的 API T4。这是一个存在于浏览器中的 API，并不为广大公众所熟知，但对于与底层模块进行交互非常有用，这将有助于解密视频内容。</p><p id="4c4c" class="pw-post-body-paragraph kx ky jc kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">这将我们带到这个 API 的核心组件之一:<a class="ae ma" href="https://developer.mozilla.org/en-US/docs/Web/API/Navigator/requestMediaKeySystemAccess" rel="noopener ugc nofollow" target="_blank">requestMediaKeySystemAccess</a>。</p><p id="005f" class="pw-post-body-paragraph kx ky jc kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">我们想知道网飞调用那个 API 的理由是什么，以了解他们在新的微软 Edge 浏览器上使用了什么解密的内容模块。</p><p id="ab70" class="pw-post-body-paragraph kx ky jc kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">猴子补丁解决方案是显而易见的！</p><figure class="mc md me mf gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi mb"><img src="../Images/1269011f1cdb1fc345a00ec191953add.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a_dGXQnrs0CKDy5yHlNUMw.png"/></div></div><figcaption class="iw ix gj gh gi iy iz bd b be z dk translated">Monkey 修补 requestMediaKeySystemAccess 方法</figcaption></figure><p id="f44a" class="pw-post-body-paragraph kx ky jc kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">然后，我们可以插入任何调试语句，以便在调用该函数之前监视它的调用。</p><p id="f95e" class="pw-post-body-paragraph kx ky jc kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">在这里，我将描述它的功能:</p><ul class=""><li id="a308" class="mg mh jc kz b la lv le lw li mi lm mj lq mk lu ml mm mn mo bi translated">我们首先需要保存原来的方法<code class="fe mp mq mr ms b">requestMediaKeySystemAccess</code>。</li><li id="eae3" class="mg mh jc kz b la mt le mu li mv lm mw lq mx lu ml mm mn mo bi translated">然后，我们将通过改变方法所依赖的原型来改变方法的初始运行时间。</li><li id="7cb1" class="mg mh jc kz b la mt le mu li mv lm mw lq mx lu ml mm mn mo bi translated">最后，我们通过传递正确的参数并返回它们来使用方法的副本。</li></ul><p id="eded" class="pw-post-body-paragraph kx ky jc kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">我们可能会问的一个显而易见的问题是，为什么我们之前应该保存原始方法？</p><p id="b685" class="pw-post-body-paragraph kx ky jc kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">很好的问题！打开你的开发工具，尽量不要这样做。</p><p id="2335" class="pw-post-body-paragraph kx ky jc kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">当你一遍又一遍地重复调用你试图改变的方法时，它不会工作。它会导致无限循环。</p><p id="b28d" class="pw-post-body-paragraph kx ky jc kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">最后，记得在应用程序调用它之前调用它，否则什么都不会发生，因为应用程序将在设置补丁之前调用原始函数调用。</p><h1 id="9f73" class="jz ka jc bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">示例 2:修补外部库调用</h1><p id="ee91" class="pw-post-body-paragraph kx ky jc kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu ig bi translated">Monkey patching 还可以修补您将在应用程序中使用的外部库的一些方法调用。</p><p id="458f" class="pw-post-body-paragraph kx ky jc kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">让我们再举一个我过去遇到的真实世界的例子。</p><p id="0ed3" class="pw-post-body-paragraph kx ky jc kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">在我开发的应用中，我依赖于一个外部库，它忙于处理浏览器中的视频数据。这意味着一个视频块一个视频块地下载，并将这些视频块放入视频 HTML 元素的缓冲区中。</p><p id="d734" class="pw-post-body-paragraph kx ky jc kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">然而，我偶然发现了猴子补丁帮我解决的一个问题。事实上，我需要这个应用程序在 PS5 游戏机上运行。与视频元素相关的 API 的工作方式不符合传统规范。</p><p id="99c9" class="pw-post-body-paragraph kx ky jc kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">所以，我问自己的第一件事是，我们是否可以更新我正在使用的库，以考虑 PS5 的情况，但我们很快发现，库应该严格遵循规范，不能偏离它。因此，我们决定进行猴子补丁，所以我们只更新了需要在 PS5 上工作的应用程序。</p><figure class="mc md me mf gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi my"><img src="../Images/d7f09afad973e00d6942c7a2baecc756.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yrHFqSHX_Sk9QjzBbpxWLg.png"/></div></div><figcaption class="iw ix gj gh gi iy iz bd b be z dk translated">Monkey 修补 addSourceBuffer 方法</figcaption></figure><p id="39e0" class="pw-post-body-paragraph kx ky jc kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">如前所述，如果您想将 monkey 补丁发布到生产环境中，通常不应该使用 monkey 补丁，但是上面的例子是让它工作的唯一方法。</p><h1 id="2d93" class="jz ka jc bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">结论</h1><p id="49cc" class="pw-post-body-paragraph kx ky jc kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu ig bi translated">Monkey patching 可以用在动态编程语言中，这些语言大多数时候是高级语言。相比之下，大多数其他静态编程语言是在编译时而不是运行时完成的。</p><p id="460e" class="pw-post-body-paragraph kx ky jc kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">我还推荐<a class="ae ma" href="https://chrome.google.com/webstore/detail/tampermonkey/dhdgffkkebhmkfjojejmpbldmpobfkfo?hl=en" rel="noopener ugc nofollow" target="_blank"> TamperMonkey </a>，这是一个 chrome 扩展，允许你在浏览器中运行的页面/标签范围内运行额外的脚本。</p><p id="7442" class="pw-post-body-paragraph kx ky jc kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">像<a class="ae ma" href="https://github.com/pretenderjs/pretender/blob/a6d53af7d5d16c3b68670a00aa2b0706a09b6ae6/src/pretender.ts#L113" rel="noopener ugc nofollow" target="_blank">幻影</a>这样的一些项目使用猴子修补风格来修补任何<code class="fe mp mq mr ms b">fetch</code>或<code class="fe mp mq mr ms b">XMLHTTPRequest</code>来即时拦截任何请求并将其重定向到另一个逻辑。</p><p id="6147" class="pw-post-body-paragraph kx ky jc kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">我希望你喜欢那个帖子。</p><p id="47ca" class="pw-post-body-paragraph kx ky jc kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">感谢您的阅读，请不要犹豫提供任何反馈。</p><p id="d0ad" class="pw-post-body-paragraph kx ky jc kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">谢谢！</p><p id="b4e7" class="pw-post-body-paragraph kx ky jc kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">更多的故事可以在我的个人博客上找到:<a class="ae ma" href="https://me.paulrossethings.com/" rel="noopener ugc nofollow" target="_blank">https://me.paulrossethings.com/</a></p></div></div>    
</body>
</html>