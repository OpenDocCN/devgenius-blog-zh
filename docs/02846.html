<html>
<head>
<title>Eventing Feature in Glusterfs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Glusterfs中的事件功能</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/eventing-feature-in-glusterfs-e842d5f9bc5?source=collection_archive---------4-----------------------#2020-09-04">https://blog.devgenius.io/eventing-feature-in-glusterfs-e842d5f9bc5?source=collection_archive---------4-----------------------#2020-09-04</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="ff25" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这篇文章是关于glusterfs中被称为事件的特性之一。顾名思义，这与glusterfs中发生的任何事件相关，可能是卷创建、卷删除、地理代表事件、对等事件等等。</p><p id="6c99" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">问题是它是如何被捕获的？这就是这篇文章的内容…</p></div><div class="ab cl ki kj hr kk" role="separator"><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn"/></div><div class="ig ih ii ij ik"><h1 id="46f4" class="kp kq in bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">它是如何工作的</h1><p id="81d5" class="pw-post-body-paragraph jk jl in jm b jn ln jp jq jr lo jt ju jv lp jx jy jz lq kb kc kd lr kf kg kh ig bi translated">现在，如果你是一个已经探索过或者热衷于在引擎盖下寻找的人，那么你会注意到glusterfs代码中一个叫做gf_event的东西。(如果你还没有，你可以通过<a class="ae ls" href="https://github.com/gluster/glusterfs" rel="noopener ugc nofollow" target="_blank"> github/glusterfs </a>浏览github中的glusterfs，或者如果你很想开始使用这个功能，请转到下一部分)</p><figure class="lu lv lw lx gt ly gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi lt"><img src="../Images/51c98ee6a02d559509f39ac198fcd997.png" data-original-src="https://miro.medium.com/v2/resize:fit:1362/format:webp/1*DhV-MKlaM2JDI8BKgjsfVw.jpeg"/></div></div><figcaption class="mf mg gj gh gi mh mi bd b be z dk translated">事件流</figcaption></figure><p id="bc2f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在，我们可以将一个事件视为glusterfs中发生的一些重大变化，例如卷创建。</p><p id="b3d1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在，当用户通过cli触发卷创建时，请求将被推送到glusterd，卷创建所需的操作将完成，一旦成功完成，在cli显示成功消息之前，将调用gf_event函数，传递的参数是刚刚创建的卷信息。</p><p id="5730" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在，gf_event将在内部调用_gf_event函数，该函数创建UDP套接字并推送消息。</p><p id="9476" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在另一端，我们有一个名为glustereventsd的服务，它有一个UDP服务器监听任何传入的数据包。一旦它接收到数据包，它将被解析，然后最终被推送到所有已注册监听事件的web挂钩。</p><p id="c8ea" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我想我们现在可以进入命令了…让我们用事件弄脏我们的手吧！</p></div><div class="ab cl ki kj hr kk" role="separator"><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn"/></div><div class="ig ih ii ij ik"><h1 id="3640" class="kp kq in bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">使用事件</h1><p id="82f8" class="pw-post-body-paragraph jk jl in jm b jn ln jp jq jr lo jt ju jv lp jx jy jz lq kb kc kd lr kf kg kh ig bi translated">在继续这些步骤之前，让我先弄清楚我使用的是什么环境。我用的是Fedora 32 VM，Glusterfs的版本是9dev(主分支)。</p><p id="833c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让我们先从web-hook开始，也就是说，除了我们简单的API服务器，什么都没有。</p><p id="57d1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在我在这里使用一个简单的flask应用程序。您可以使用它，甚至可以使用glusterfs中events/tools/eventsdash.py上的flask应用程序。</p><figure class="lu lv lw lx gt ly"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="8c00" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这个简单的Flask程序有两条路径，都服务于POST方法。</p><ol class=""><li id="d74f" class="ml mm in jm b jn jo jr js jv mn jz mo kd mp kh mq mr ms mt bi translated">一条路线为<strong class="jm io">/</strong>。</li><li id="43f9" class="ml mm in jm b jn mu jr mv jv mw jz mx kd my kh mq mr ms mt bi translated"><strong class="jm io">【倾听】</strong>的一条路线。</li></ol><p id="f653" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">端口是9000，为了显示输出，我打开了调试模式。</p><p id="c5c3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">既然flask应用程序已经准备好了，让我们继续讨论glusterfs中的事件部分，这个部分必须打开。</p><p id="abf1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们需要启动glustereventsd服务，所以..</p><pre class="lu lv lw lx gt mz na nb nc aw nd bi"><span id="94a0" class="ne kq in na b gy nf ng l nh ni">[root@server1 ~]# systemctl start glustereventsd<br/>[root@server1 ~]# systemctl enable glustereventsd<br/>Synchronizing state of glustereventsd.service with SysV service script with /usr/lib/systemd/systemd-sysv-install.<br/>Executing: /usr/lib/systemd/systemd-sysv-install enable glustereventsd<br/>[root@server1 ~]#</span></pre><p id="9e67" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">一旦事件启动，我们需要启动flask应用程序并将其注册为webhook。</p><pre class="lu lv lw lx gt mz na nb nc aw nd bi"><span id="8134" class="ne kq in na b gy nf ng l nh ni">[root@server1 home]# python3 flask_client.py <br/> * Serving Flask app "flask_client" (lazy loading)<br/> * Environment: production<br/>   WARNING: This is a development server. Do not use it in a production deployment.<br/>   Use a production WSGI server instead.<br/> * Debug mode: on<br/> * Running on <a class="ae ls" href="http://0.0.0.0:9000/" rel="noopener ugc nofollow" target="_blank">http://0.0.0.0:9000/</a> (Press CTRL+C to quit)<br/> * Restarting with stat<br/> * Debugger is active!<br/> * Debugger PIN: 353-160-127</span></pre><p id="2355" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">下一步是注册webhook。为此，我们将使用命令gluster-eventsapi。检查状态，</p><pre class="lu lv lw lx gt mz na nb nc aw nd bi"><span id="d486" class="ne kq in na b gy nf ng l nh ni">[root@server1 ~]# gluster-eventsapi status<br/>Webhooks: None</span><span id="abbb" class="ne kq in na b gy nj ng l nh ni">+-----------+-------------+-----------------------+<br/>|    NODE   | NODE STATUS | GLUSTEREVENTSD STATUS |<br/>+-----------+-------------+-----------------------+<br/>| localhost |          UP |                    OK |<br/>+-----------+-------------+-----------------------+<br/>[root@server1 ~]#</span></pre><p id="5ff5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在注册之前，让我们检查一下我们是否能够与flask应用程序通信，</p><pre class="lu lv lw lx gt mz na nb nc aw nd bi"><span id="846c" class="ne kq in na b gy nf ng l nh ni">[root@server1 ~]# gluster-eventsapi webhook-test <a class="ae ls" href="http://0.0.0.0:9000/" rel="noopener ugc nofollow" target="_blank">http://0.0.0.0:9000/</a><br/>+-----------+-------------+----------------+<br/>|    NODE   | NODE STATUS | WEBHOOK STATUS |<br/>+-----------+-------------+----------------+<br/>| localhost |          UP |             OK |<br/>+-----------+-------------+----------------+<br/>[root@server1 ~]#</span></pre><p id="cd60" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">因此，节点和webhook都启动了。在检查烧瓶输出时，</p><pre class="lu lv lw lx gt mz na nb nc aw nd bi"><span id="3f03" class="ne kq in na b gy nf ng l nh ni">&lt;Request '<a class="ae ls" href="http://0.0.0.0:9000/'" rel="noopener ugc nofollow" target="_blank">http://0.0.0.0:9000/'</a> [POST]&gt;<br/>127.0.0.1 - - [04/Sep/2020 09:19:02] "POST / HTTP/1.1" 200 -</span></pre><p id="faa3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">下一步是注册webhook，</p><pre class="lu lv lw lx gt mz na nb nc aw nd bi"><span id="5818" class="ne kq in na b gy nf ng l nh ni">[root@server1 ~]# gluster-eventsapi webhook-add <a class="ae ls" href="http://0.0.0.0:9000/listen" rel="noopener ugc nofollow" target="_blank">http://0.0.0.0:9000/listen</a><br/>+-----------+-------------+-------------+<br/>|    NODE   | NODE STATUS | SYNC STATUS |<br/>+-----------+-------------+-------------+<br/>| localhost |          UP |          OK |<br/>+-----------+-------------+-------------+<br/>[root@server1 ~]# gluster-eventsapi status<br/>Webhooks: <br/><a class="ae ls" href="http://0.0.0.0:9000/listen" rel="noopener ugc nofollow" target="_blank">http://0.0.0.0:9000/listen</a></span><span id="120f" class="ne kq in na b gy nj ng l nh ni">+-----------+-------------+-----------------------+<br/>|    NODE   | NODE STATUS | GLUSTEREVENTSD STATUS |<br/>+-----------+-------------+-----------------------+<br/>| localhost |          UP |                    OK |<br/>+-----------+-------------+-----------------------+<br/>[root@server1 ~]#</span></pre><p id="b1f5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">正如我们所看到的，webhook被注册，glusterfs中的事件将被传递给webhook。</p><p id="515d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让我们创建一个gluster卷。然后，我们可以观察到事件被传递到webhook。创建卷时，</p><pre class="lu lv lw lx gt mz na nb nc aw nd bi"><span id="f07d" class="ne kq in na b gy nf ng l nh ni">[root@server1 /]# gluster vol create vol1 replica 3 server1:/data/brick/br1 server1:/data/brick/br2 server1:/data/brick/br3 force<br/>volume create: vol1: success: please start the volume to access data<br/>[root@server1 /]#</span></pre><p id="d583" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们在webhook中得到下面的响应，</p><pre class="lu lv lw lx gt mz na nb nc aw nd bi"><span id="1081" class="ne kq in na b gy nf ng l nh ni">{'event': 'VOLUME_CREATE', 'message': {'bricks': ' server1:/data/brick/br1 server1:/data/brick/br2 server1:/data/brick/br3', 'name': 'vol1'}, 'nodeid': 'c61dc1be-14b1-45b1-8a5a-9f401f6dcb22', 'ts': 1599193580}<br/>127.0.0.1 - - [04/Sep/2020 09:56:20] "POST /listen HTTP/1.1" 200 -</span></pre><p id="fbdb" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">删除卷时，</p><pre class="lu lv lw lx gt mz na nb nc aw nd bi"><span id="7078" class="ne kq in na b gy nf ng l nh ni">[root@server1 /]# gluster vol delete vol1<br/>Deleting volume will erase all information about the volume. Do you want to continue? (y/n) y<br/>volume delete: vol1: success<br/>[root@server1 /]#</span></pre><p id="b705" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们看到了回应，</p><pre class="lu lv lw lx gt mz na nb nc aw nd bi"><span id="a241" class="ne kq in na b gy nf ng l nh ni">{'event': 'VOLUME_DELETE', 'message': {'name': 'vol1'}, 'nodeid': 'c61dc1be-14b1-45b1-8a5a-9f401f6dcb22', 'ts': 1599193693}<br/>127.0.0.1 - - [04/Sep/2020 09:58:13] "POST /listen HTTP/1.1" 200 -</span></pre><p id="f6ed" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让我们更深入地看看响应JSON的内容，</p><pre class="lu lv lw lx gt mz na nb nc aw nd bi"><span id="7ce2" class="ne kq in na b gy nf ng l nh ni">{<br/>    'event' : 'VOLUME_DELETE',<br/>    'message' : {'name' : 'vol1'},<br/>    'nodeid' : 'c61dc1be-14b1-45b1-8a5a-9f401f6dcb22',<br/>    'ts' : 1599193693<br/>}</span></pre><p id="e77a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">因此，事件响应内部有四个组件，事件、对应于事件的消息、节点id和时间戳。使用这些信息，我们实际上可以创建一个webhook，然后它可以对正在使用的glusterfs集群的健康状况进行一些日志分析或事件预测分析。</p><p id="ac97" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">除了这些命令之外，要查看事件系统的配置，即日志模式以及用于将消息推送到Glustereventsd的UDP端口，可以使用<strong class="jm io"> config-get </strong>命令，</p><pre class="lu lv lw lx gt mz na nb nc aw nd bi"><span id="7d98" class="ne kq in na b gy nf ng l nh ni">[root@server1 glusterfs]# gluster-eventsapi config-get<br/>+--------------------+-------+<br/>|        NAME        | VALUE |<br/>+--------------------+-------+<br/>|     log-level      |  INFO |<br/>|        port        | 24009 |<br/>| disable-events-log | False |<br/>+--------------------+-------+<br/>[root@server1 glusterfs]#</span></pre><p id="d8ad" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">要设置配置，命令是config-set。例如，让我们将日志级别设置为DEBUG，</p><pre class="lu lv lw lx gt mz na nb nc aw nd bi"><span id="58ac" class="ne kq in na b gy nf ng l nh ni">[root@server1 glusterfs]# gluster-eventsapi config-set log-level DEBUG<br/>+-----------+-------------+-------------+<br/>|    NODE   | NODE STATUS | SYNC STATUS |<br/>+-----------+-------------+-------------+<br/>| localhost |          UP |          OK |<br/>+-----------+-------------+-------------+<br/>[root@server1 glusterfs]# gluster-eventsapi config-get<br/>+--------------------+-------+<br/>|        NAME        | VALUE |<br/>+--------------------+-------+<br/>|     log-level      | DEBUG |<br/>|        port        | 24009 |<br/>| disable-events-log | False |<br/>+--------------------+-------+<br/>[root@server1 glusterfs]#</span></pre><p id="7bea" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">另外，假设有人想要删除正在使用的webhook，他们可以使用命令，</p><pre class="lu lv lw lx gt mz na nb nc aw nd bi"><span id="fffa" class="ne kq in na b gy nf ng l nh ni">[root@server1 glusterfs]# gluster-eventsapi webhook-del <a class="ae ls" href="http://localhost:9000/listen" rel="noopener ugc nofollow" target="_blank">http://localhost:9000/listen</a><br/>+-----------+-------------+-------------+<br/>|    NODE   | NODE STATUS | SYNC STATUS |<br/>+-----------+-------------+-------------+<br/>| localhost |          UP |          OK |<br/>+-----------+-------------+-------------+<br/>[root@server1 glusterfs]# gluster-eventsapi status<br/>Webhooks: None</span><span id="e916" class="ne kq in na b gy nj ng l nh ni">+-----------+-------------+-----------------------+<br/>|    NODE   | NODE STATUS | GLUSTEREVENTSD STATUS |<br/>+-----------+-------------+-----------------------+<br/>| localhost |          UP |                    OK |<br/>+-----------+-------------+-----------------------+<br/>[root@server1 glusterfs]#</span></pre><p id="5cb4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">要获得更多信息，可以使用ehelp命令查看gluster-eventsapi支持哪些子命令。</p><p id="84e4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">来到日志记录部分，可以在<strong class="jm io">/var/log/glusterfs/events . log</strong>中找到正在进行的日志记录。</p></div><div class="ab cl ki kj hr kk" role="separator"><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn"/></div><div class="ig ih ii ij ik"><p id="5f80" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这是关于Glusterfs中事件的含义以及如何使用它的基本介绍。如果考虑这样的场景，这是一个有趣的特性，其中日志可以用于进一步的分析和预测。</p><p id="1a3a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">供思考的食物…</p></div></div>    
</body>
</html>