<html>
<head>
<title>Terraform And PagerDuty — Before You Try</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Terraform和page duty—在您尝试之前</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/terraform-pagerduty-before-you-try-dd5266420fcf?source=collection_archive---------11-----------------------#2020-07-19">https://blog.devgenius.io/terraform-pagerduty-before-you-try-dd5266420fcf?source=collection_archive---------11-----------------------#2020-07-19</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><figure class="im in gp gr io ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi il"><img src="../Images/3c8a23cd71895dd0b6e870c1ff371590.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*zm97NUBNtPsE0_qC"/></div></div><figcaption class="iw ix gj gh gi iy iz bd b be z dk translated"><a class="ae ja" href="https://unsplash.com/@kaip?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">凯·皮尔格</a>在<a class="ae ja" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><h2 id="4738" class="jb jc jd bd b dl je jf jg jh ji jj dk jk translated" aria-label="kicker paragraph">地形想法</h2><div class=""/><div class=""><h2 id="d18f" class="pw-subtitle-paragraph kj jm jd bd b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la dk translated">在开始编写PagerDuty基础设施代码之前，了解一些事实是值得的</h2></div><p id="b664" class="pw-post-body-paragraph lb lc jd ld b le lf kn lg lh li kq lj lk ll lm ln lo lp lq lr ls lt lu lv lw ig bi translated">Terraform因其丰富的供应商选择而闻名。其中，我们可以找到PagerDuty集成。如果您有很多服务、用户和团队，那么您应该考虑将这样的基础设施作为IaC来管理。</p><p id="7301" class="pw-post-body-paragraph lb lc jd ld b le lf kn lg lh li kq lj lk ll lm ln lo lp lq lr ls lt lu lv lw ig bi translated">随着你花越来越多的时间编写HCL代码，你会发现一些你可以容忍或者完全不能接受的事情。我不想说terraform PagerDuty提供商不好。其实我是用的，推荐的。但是让我们看看我在第一次尝试中发现了什么。</p><h2 id="7db0" class="lx ly jd bd lz ma mb dn mc md me dp mf lk mg mh mi lo mj mk ml ls mm mn mo jj bi translated">服务内部不支持EventRules</h2><figure class="mq mr ms mt gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi mp"><img src="../Images/bbba4efab234df12cc46541bbba7d3c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u2AGXr4Wpa0uD1-UqLspPw.png"/></div></div><figcaption class="iw ix gj gh gi iy iz bd b be z dk translated">摘自<a class="ae ja" href="https://community.pagerduty.com/forum/t/automation-of-service-event-rules/1507/2" rel="noopener ugc nofollow" target="_blank">https://community . page duty . com/forum/t/automation-of-service-event-rules/1507/2</a></figcaption></figure><p id="d5c2" class="pw-post-body-paragraph lb lc jd ld b le lf kn lg lh li kq lj lk ll lm ln lo lp lq lr ls lt lu lv lw ig bi translated">您无法使用terraform在服务内部部署EventRules。这个特性在API中其实根本不支持。为什么这对你很重要？在我的例子中，我想在terraform中管理规则集、规则集中的规则和服务中的事件规则。</p><ul class=""><li id="03cd" class="mu mv jd ld b le lf lh li lk mw lo mx ls my lw mz na nb nc bi translated">具有规则的规则集应仅基于服务而非警报(仅来自应用程序/组件警报的元数据)进行路由。应该只问一个问题:<em class="nd"> </em> <strong class="ld jn"> <em class="nd">警戒发生在哪里？</em>T11】</strong></li><li id="18ca" class="mu mv jd ld b le ne lh nf lk ng lo nh ls ni lw mz na nb nc bi translated">服务内部的EventRules应根据警报描述和名称设置事件行为/状态:<strong class="ld jn"> <em class="nd">发生了什么警报？</em>T15】</strong></li></ul><p id="1947" class="pw-post-body-paragraph lb lc jd ld b le lf kn lg lh li kq lj lk ll lm ln lo lp lq lr ls lt lu lv lw ig bi translated">如果您在集群中运行许多组件，并且每个组件都有自己的服务，那么这个设置非常重要，这样您就可以查看PagerDuty并立即判断出集群有什么问题。因为您划分了规则，所以您不必处理一个包含数百条规则的庞大规则集。</p><h2 id="b131" class="lx ly jd bd lz ma mb dn mc md me dp mf lk mg mh mi lo mj mk ml ls mm mn mo jj bi translated">规则决定随机性</h2><p id="eb14" class="pw-post-body-paragraph lb lc jd ld b le nj kn lg lh nk kq lj lk nl lm ln lo nm lq lr ls nn lu lv lw ig bi translated">PagerDuty中的规则被一个接一个地执行，直到它们满足预期的条件。然后，他们添加额外元数据并将事件路由到指定的服务。在地形规则中，位置目前是由字段<em class="nd">位置</em>实现的(你没想到吧？).</p><figure class="mq mr ms mt gt ip"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="f21f" class="pw-post-body-paragraph lb lc jd ld b le lf kn lg lh li kq lj lk ll lm ln lo lp lq lr ls lt lu lv lw ig bi translated">规则资源定义示例在使用<em class="nd"/><a class="ae ja" href="https://www.terraform.io/docs/configuration/resources.html#depends_on-explicit-resource-dependencies" rel="noopener ugc nofollow" target="_blank"><em class="nd">depends _ on</em></a>元变元按顺序应用位置规则之前(回到资源被命名为<a class="ae ja" href="https://www.terraform.io/docs/providers/pagerduty/r/event_rule.html" rel="noopener ugc nofollow" target="_blank"> EventRule </a>)。假设一周后你决定改变订单。然后你不得不每隔<em class="nd">依赖</em>再更新一次——这很麻烦也没什么效果。当然，您可以找到一些变通办法，并使用您出色的脚本技能，但这仍然只是变通办法。</p><p id="3197" class="pw-post-body-paragraph lb lc jd ld b le lf kn lg lh li kq lj lk ll lm ln lo lp lq lr ls lt lu lv lw ig bi translated">所以<em class="nd">位置</em>场就像是一种祝福。但是，即使在资源中，每次订单发生变化时，您都必须更新数字。您可以使用变量和索引函数来简化这一过程:</p><figure class="mq mr ms mt gt ip"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="841a" class="pw-post-body-paragraph lb lc jd ld b le lf kn lg lh li kq lj lk ll lm ln lo lp lq lr ls lt lu lv lw ig bi translated">现在要改变规则顺序，我只需要在<em class="nd"> variables.tf </em>中切换字符串顺序。在这一刻，一切都应该会突然发生。在<em class="nd">地形应用</em>后:</p><pre class="mq mr ms mt gt nq nr ns nt aw nu bi"><span id="164e" class="lx ly jd nr b gy nv nw l nx ny">Apply complete! Resources: 0 added, 2 changed, 0 destroyed.</span></pre><p id="ff66" class="pw-post-body-paragraph lb lc jd ld b le lf kn lg lh li kq lj lk ll lm ln lo lp lq lr ls lt lu lv lw ig bi translated">看起来很有希望。然后让我们运行<em class="nd">地形计划</em>以确保:</p><pre class="mq mr ms mt gt nq nr ns nt aw nu bi"><span id="819e" class="lx ly jd nr b gy nv nw l nx ny">Plan: 0 to add, 2 to change, 0 to destroy.</span></pre><p id="55e4" class="pw-post-body-paragraph lb lc jd ld b le lf kn lg lh li kq lj lk ll lm ln lo lp lq lr ls lt lu lv lw ig bi translated">它刚刚对我撒谎了吗？位置已更改的规则仍处于以前的位置。那我该怎么办？再次运行应用。第二轮之后，规则改变了。但是几天前我经历了在<strong class="ld jn">第7次</strong>运行后更改被正确应用的情况。</p><blockquote class="nz oa ob"><p id="5bf2" class="lb lc nd ld b le lf kn lg lh li kq lj oc ll lm ln od lp lq lr oe lt lu lv lw ig bi translated">这种缺陷的问题在于可重复性。我试了很多次，都没有达到预期的行为。几天后，在与团队一起工作时，突然出现了bug。此外，当试图将所有规则一次部署到空规则集中时，terraform无法以正确的顺序设置它们。</p></blockquote><p id="376b" class="pw-post-body-paragraph lb lc jd ld b le lf kn lg lh li kq lj lk ll lm ln lo lp lq lr ls lt lu lv lw ig bi translated">对我来说，在terraform中建立规则是一件非常痛苦的事情。我也总是在想最坏的情况，当有人应用了更改，却忘了检查订单是否正确。您可以设计一些管道来应用更改，直到订单正确为止，但这可能行不通——有一次，在第10次运行terraform后，我不得不在PagerDuty GUI中手动移动规则。</p><h2 id="8b21" class="lx ly jd bd lz ma mb dn mc md me dp mf lk mg mh mi lo mj mk ml ls mm mn mo jj bi translated">更少的手工工作——但是编写模块可能很难</h2><p id="7782" class="pw-post-body-paragraph lb lc jd ld b le nj kn lg lh nk kq lj lk nl lm ln lo nm lq lr ls nn lu lv lw ig bi translated">和许多IaC解决方案一样，这也减少了我们的点击量。一个命令，整个基础设施就建立起来了。在我的职责中，我决定保留这样的平台式回购结构:</p><figure class="mq mr ms mt gt ip"><div class="bz fp l di"><div class="no np l"/></div><figcaption class="iw ix gj gh gi iy iz bd b be z dk translated">我的地形结构</figcaption></figure><p id="edeb" class="pw-post-body-paragraph lb lc jd ld b le lf kn lg lh li kq lj lk ll lm ln lo lp lq lr ls lt lu lv lw ig bi translated">你应该问的第一个问题是为什么我没有写一个模块来覆盖文件冗余。答案很简单——在我的情况下，用PagerDuty编写模块不值得花时间。我们希望保留的集群之间的监控差异很小。</p><p id="516c" class="pw-post-body-paragraph lb lc jd ld b le lf kn lg lh li kq lj lk ll lm ln lo lp lq lr ls lt lu lv lw ig bi translated">假设我们需要一个模块来部署所有提到的资源。大多数情况下，您仍然需要传递规则的详细信息，对于一个模块来说，这可能很棘手。我也不喜欢我的团队不愿意使用难读的模块(你也必须维护它们)。他们喜欢简单。值得一提的是<em class="nd"> main.tf </em>，我们在其中保存了提供商信息和terraform数据源——对团队、用户、时间表、优先级和升级策略的引用。</p><h2 id="3d98" class="lx ly jd bd lz ma mb dn mc md me dp mf lk mg mh mi lo mj mk ml ls mm mn mo jj bi translated">你现在可以试试</h2><figure class="mq mr ms mt gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi of"><img src="../Images/0bb63884aa83771126e4b3dfea62a2c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*q69gkpQznWrIkuT5"/></div></div><figcaption class="iw ix gj gh gi iy iz bd b be z dk translated">由<a class="ae ja" href="https://unsplash.com/@basilsamuellade?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">巴兹尔·萨缪尔·雷德</a>在<a class="ae ja" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="0068" class="pw-post-body-paragraph lb lc jd ld b le lf kn lg lh li kq lj lk ll lm ln lo lp lq lr ls lt lu lv lw ig bi translated">用terraform设置PagerDuty有两个小的不便。尤其是部署全传呼机。无法使用EventRule资源也使得terraform缺乏体验。我不知道他们是否会对规则秩序做些什么，因为这不是一个常见的问题。现在我们有希望获得EventRules API。</p><p id="b2ed" class="pw-post-body-paragraph lb lc jd ld b le lf kn lg lh li kq lj lk ll lm ln lo lp lq lr ls lt lu lv lw ig bi translated">如果你计划使用terraform来完成你的页面任务，我可以向你推荐这个解决方案，但是请记住以下几点。你的要求可能比我的更高，知道上面提到的限制有一天可以帮你避免不必要的挫折。</p></div></div>    
</body>
</html>