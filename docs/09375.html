<html>
<head>
<title>How to integrate in PHP an external API through webhooks in a flexible way.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何灵活地通过 webhooks 在 PHP 中集成外部 API？</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/how-to-integrate-in-php-an-external-api-through-webhooks-in-a-flexible-way-2f632225a02c?source=collection_archive---------11-----------------------#2022-08-17">https://blog.devgenius.io/how-to-integrate-in-php-an-external-api-through-webhooks-in-a-flexible-way-2f632225a02c?source=collection_archive---------11-----------------------#2022-08-17</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="b4df" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在这篇文章中，我将与你分享一个 PHP 示例代码，我用它在一个 LARAVEL 项目中集成了 API webhooks。如果支付成功，API 会将 JSON 数据发送到包含支付交易详细信息的回调 URL。</p><p id="f8ab" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我使用的 API 来自于<a class="ae ki" href="https://fastspring.com" rel="noopener ugc nofollow" target="_blank"> Fastspring </a>支付网关。允许你自动管理数字产品的订购。</p><p id="48e8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">假设订阅创建成功的回调 URL 为:【https://website.com/webhooks/subscription-c】T2 已创建</p><p id="cb68" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">接收的数据采用 JSON 格式，如下所示:</p><pre class="kj kk kl km gt kn ko kp kq aw kr bi"><span id="f86c" class="ks kt in ko b gy ku kv l kw kx">{  <br/> "id": "nEdzdi5eSoO43fbnXE8DfA",   "quote":"QUOT2J52LKCFCHPOYSW6UTRMNZJA",   <br/> "subscription": "nEdzdi5eSoO43fbnXE8DfA",  <br/> "active": true,  <br/> "state": "active",  <br/> "changed": 1585930046426,   "changedValue": 1585930046426,   "changedInSeconds": 1585930046,   "changedDisplay": "4/3/20",   "live": false,   "currency": "USD", <br/>  "account": "gB_slATyQBqSpAxA7-1YAg", <br/>  "product": "example-subscription-annual",<br/>   "sku": null,   "display": "Example Subscription - Annual",   "quantity": 1,   "adhoc": false,   "autoRenew": true,   "price": 100,   "priceDisplay": "$100.00",   "priceInPayoutCurrency": 100,   "priceInPayoutCurrencyDisplay": "$100.00",   "discount": 0,   "discountDisplay": "$0.00",   "discountInPayoutCurrency": 0,   "discountInPayoutCurrencyDisplay": "$0.00",   "subtotal": 110,   "subtotalDisplay": "$110.00",   "subtotalInPayoutCurrency": 110,   "subtotalInPayoutCurrencyDisplay": "$110.00",   "next": 1617408000000,   "nextValue": 1617408000000,   "nextInSeconds": 1617408000,   "nextDisplay": "4/3/21",   "end": null,   "endValue": null,   "endInSeconds": null,   "endDisplay": null,   "canceledDate": null,   "canceledDateValue": null,   "canceledDateInSeconds": null,   "canceledDateDisplay": null,   "deactivationDate": null,   "deactivationDateValue": null,   "deactivationDateInSeconds": null,   "deactivationDateDisplay": null,   "sequence": 1,   "periods": null,   "remainingPeriods": null,   "begin": 1585872000000,   "beginValue": 1585872000000,   "beginInSeconds": 1585872000,   "beginDisplay": "4/3/20",   "intervalUnit": "year",   "intervalLength": 1,   "nextChargeCurrency": "USD",   "nextChargeDate": 1617408000000,   "nextChargeDateValue": 1617408000000,   "nextChargeDateInSeconds": 1617408000,   "nextChargeDateDisplay": "4/3/21",   "nextChargePreTax": 110,   "nextChargePreTaxDisplay": "$110.00",   "nextChargePreTaxInPayoutCurrency": 110,   "nextChargePreTaxInPayoutCurrencyDisplay": "$110.00",   "nextChargeTotal": 110,   "nextChargeTotalDisplay": "$110.00",   "nextChargeTotalInPayoutCurrency": 110,   "nextChargeTotalInPayoutCurrencyDisplay": "$110.00",   "nextNotificationType": "PAYMENT_REMINDER",   "nextNotificationDate": 1616803200000,   "nextNotificationDateValue": 1616803200000,   "nextNotificationDateInSeconds": 1616803200,   "nextNotificationDateDisplay": "3/27/21",   "paymentReminder": {     "intervalUnit": "week",     "intervalLength": 1   },   "paymentOverdue": {     "intervalUnit": "week",     "intervalLength": 1,     "total": 4,     "sent": 0   },   "cancellationSetting": {     "cancellation": "AFTER_LAST_NOTIFICATION",     "intervalUnit": "week",     "intervalLength": 1   },   "addons": [     {       "product": "example-product-1",       "sku": "skuex1",       "display": "Example Product 1",       "quantity": 1,       "price": 10,       "priceDisplay": "$10.00",       "priceInPayoutCurrency": 10,       "priceInPayoutCurrencyDisplay": "$10.00",       "discount": 0,       "discountDisplay": "$0.00",       "discountInPayoutCurrency": 0,       "discountInPayoutCurrencyDisplay": "$0.00",       "subtotal": 10,       "subtotalDisplay": "$10.00",       "subtotalInPayoutCurrency": 10,       "subtotalInPayoutCurrencyDisplay": "$10.00",       "discounts": []     }   ],   "setupFee": {     "price": {       "USD": 10     },     "title": {       "en": "One-time Setup Fee"     }   },   "fulfillments": {     "example-subscription-annual_file_1": [       {         "display": "example1.exe",         "size": 129,         "file": "https://yourexamplestore.onfastspring.com/account/file/YOU200403-5980-20157F",         "type": "file"       }     ]   },   "instructions": [     {       "product": "example-subscription-annual",       "type": "regular",       "periodStartDate": null,       "periodStartDateValue": null,       "periodStartDateInSeconds": null,       "periodStartDateDisplay": null,       "periodEndDate": null,       "periodEndDateValue": null,       "periodEndDateInSeconds": null,       "periodEndDateDisplay": null,       "intervalUnit": "year",       "intervalLength": 1,       "discountPercent": 0,       "discountPercentValue": 0,       "discountPercentDisplay": "0%",       "discountTotal": 0,       "discountTotalDisplay": "$0.00",       "discountTotalInPayoutCurrency": 0,       "discountTotalInPayoutCurrencyDisplay": "$0.00",       "unitDiscount": 0,       "unitDiscountDisplay": "$0.00",       "unitDiscountInPayoutCurrency": 0,       "unitDiscountInPayoutCurrencyDisplay": "$0.00",       "price": 100,       "priceDisplay": "$100.00",       "priceInPayoutCurrency": 100,       "priceInPayoutCurrencyDisplay": "$100.00",       "priceTotal": 100,       "priceTotalDisplay": "$100.00",       "priceTotalInPayoutCurrency": 100,       "priceTotalInPayoutCurrencyDisplay": "$100.00",       "unitPrice": 100,       "unitPriceDisplay": "$100.00",       "unitPriceInPayoutCurrency": 100,       "unitPriceInPayoutCurrencyDisplay": "$100.00",       "total": 100,       "totalDisplay": "$100.00",       "totalInPayoutCurrency": 100,       "totalInPayoutCurrencyDisplay": "$100.00"     }   ] }</span></pre><p id="f08b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如您所见，为了将相关数据存储在数据库中，需要解析大量 json 数据。最常见的方法是在 LARAVEL 控制器中使用类似以下代码的代码:</p><pre class="kj kk kl km gt kn ko kp kq aw kr bi"><span id="ccaf" class="ks kt in ko b gy ku kv l kw kx">public function subscription_created(Request $request){</span><span id="e750" class="ks kt in ko b gy ky kv l kw kx">$array_data=json_decode($reqyest-&gt;json_data,true);<br/>$relevant_data["subscription"]=$array_data["subscription"];<br/>$relevant_data["product"]=$array_data["items"][0]["product"];<br/>$relevant_data["price"]=$array_data["items"][0]["price"];</span><span id="c1f5" class="ks kt in ko b gy ky kv l kw kx">/** insert relevant_data in mysql database **/<br/>}</span></pre><p id="1b4a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">对于另一个挂钩，例如订阅更新，另一个动作被添加到控制器等等。</p><pre class="kj kk kl km gt kn ko kp kq aw kr bi"><span id="9d77" class="ks kt in ko b gy ku kv l kw kx">public function subscription_created(Request $request){$array_data=json_decode($request-&gt;json_data,true);<br/>$relevant_data["subscription"]=$array_data["subscription"];<br/>$relevant_data["product"]=$array_data["items"][0]["product"];<br/>$relevant_data["price"]=$array_data["items"][0]["price"];</span><span id="9506" class="ks kt in ko b gy ky kv l kw kx">/** insert relevant_data in mysql database **/<br/>}</span><span id="a559" class="ks kt in ko b gy ky kv l kw kx">public function subscription_renew(Request $request){$array_data=json_decode($request-&gt;json_data,true);<br/>$relevant_data["subscription"]=$array_data["subscription"];<br/>$relevant_data["product"]=$array_data["items"][0]["product"];<br/>$relevant_data["next"]=$array_data["schedule"]["next"];</span><span id="9c37" class="ks kt in ko b gy ky kv l kw kx">/** insert relevant_data in mysql database **/<br/>}</span></pre><p id="eb71" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">假设 API 响应中的一个字段更改了名称或顺序。例如<strong class="jm io">订阅</strong>字段变成<strong class="jm io">订阅 _id。</strong>在这种情况下，您应该在所有控制器代码中搜索该字段，并更改字段名。此外，这些代码是多余的，难以维护。</p><p id="e7d5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让我们首先尝试创建一个名为<strong class="jm io"><em class="kz">HookSubscriptionData</em></strong>的类，它包含常见的 API 响应字段。</p><pre class="kj kk kl km gt kn ko kp kq aw kr bi"><span id="0c0f" class="ks kt in ko b gy ku kv l kw kx"><strong class="ko io">class</strong> HookSubscriptionData {</span><span id="d732" class="ks kt in ko b gy ky kv l kw kx"><strong class="ko io">public</strong> $subscription;<br/><strong class="ko io">public</strong> $product;<br/>public $next;<br/>public $price;</span><span id="46f7" class="ks kt in ko b gy ky kv l kw kx"><strong class="ko io">public</strong> <strong class="ko io">function</strong> <strong class="ko io">__construct</strong>(Array $params)</span><span id="c6b8" class="ks kt in ko b gy ky kv l kw kx">{<br/>$this-&gt;subscription=$params['subscription']??"";<br/>$this-&gt;next=$params["nextInSeconds"]??"";<br/>$this-&gt;product=$params["items"][0]["product"]??"";<br/>$this-&gt;price=$params["items"][0]["price"]??0;<br/>}<br/>}</span></pre><p id="eeb1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">和<strong class="jm io"> <em class="kz"> JSONParser </em> </strong>类，解析传入的 JSON 数据并将其转换为数组。</p><pre class="kj kk kl km gt kn ko kp kq aw kr bi"><span id="d4aa" class="ks kt in ko b gy ku kv l kw kx"><strong class="ko io">class</strong> JSONParser {<br/><strong class="ko io">public</strong> <strong class="ko io">function</strong> parse($json_data) {<br/>$result= json_decode($json_data,<strong class="ko io">true</strong>);<br/><strong class="ko io">if</strong>(!is_array($result)){<br/><strong class="ko io">throw</strong> <strong class="ko io">new</strong> \Exception("Not valid Json Data");<br/>}<br/><strong class="ko io">return</strong> $result;<br/>}<br/>}</span></pre><p id="29cd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">最后处理订阅激活钩子的类叫做<strong class="jm io"><em class="kz">HookSubscriptionActivated。</em>T19】</strong></p><pre class="kj kk kl km gt kn ko kp kq aw kr bi"><span id="82c8" class="ks kt in ko b gy ku kv l kw kx"><strong class="ko io">class</strong> HookSubscriptionActivated{</span><span id="61a7" class="ks kt in ko b gy ky kv l kw kx"><strong class="ko io">public</strong> $hook_data;</span><span id="1b56" class="ks kt in ko b gy ky kv l kw kx"><strong class="ko io">public</strong> <strong class="ko io">function</strong> <strong class="ko io">__construct</strong>(HookSubscriptionConfig $hook_config)<br/>{<br/>$this-&gt;hook_data=$hook_config;<br/>}</span><span id="73b4" class="ks kt in ko b gy ky kv l kw kx"><strong class="ko io">public</strong> <strong class="ko io">function</strong> handle(Callable $callback){<br/> <strong class="ko io">if</strong>($callback!=<strong class="ko io">null</strong>){<br/>  $callback($this-&gt;hook_data);<br/>  }<br/>}<br/>}</span></pre><p id="c608" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在，在 controller 中，情况发生了变化。</p><pre class="kj kk kl km gt kn ko kp kq aw kr bi"><span id="9634" class="ks kt in ko b gy ku kv l kw kx">public function subscription_created(Request $request){<br/><strong class="ko io">try</strong>{<br/> $hook=<strong class="ko io">new</strong> HookSubscriptionActivated(<strong class="ko io">new</strong> hookSubscriptionData((new JSONParser())-&gt;parse($request-&gt;json_data)));<br/> $hook-&gt;handle(<strong class="ko io">array</strong>($this,"f_activated"));<br/>}<strong class="ko io">catch</strong>(\Exception $ex){}<br/>}</span><span id="29e2" class="ks kt in ko b gy ky kv l kw kx"><strong class="ko io">public</strong> <strong class="ko io">function</strong> f_activated($hook_data){ <br/>/** store data in databse **/<br/>}</span><span id="b2dd" class="ks kt in ko b gy ky kv l kw kx">public function subscription_renew(Request $request){<br/><strong class="ko io">try</strong>{<br/>$hook=<strong class="ko io">new</strong> HookSubscriptionRenew(<strong class="ko io">new</strong> hookSubscriptionData((new JSONParser())-&gt;parse($request-&gt;json_data)));<br/>$hook-&gt;handle(<strong class="ko io">function($hook_data){<br/> </strong>/** store data in databse **/<strong class="ko io"> <br/>}</strong>);<br/>}<strong class="ko io">catch</strong>(\Exception $ex){}<br/>}</span></pre><p id="cb06" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在这种情况下，如果一个字段名改变，它不会影响所有的代码。更改将在单个类<strong class="jm io"> <em class="kz">中完成。</em> </strong></p><pre class="kj kk kl km gt kn ko kp kq aw kr bi"><span id="89f8" class="ks kt in ko b gy ku kv l kw kx"><strong class="ko io">public</strong> <strong class="ko io">function</strong> <strong class="ko io">__construct</strong>(Array $params)</span><span id="962a" class="ks kt in ko b gy ky kv l kw kx">{<br/><strong class="ko io">$this-&gt;subscription=$params['subscription_id']??"";</strong><br/>$this-&gt;next=$params["nextInSeconds"]??"";<br/>$this-&gt;product=$params["items"][0]["product"]??"";<br/>$this-&gt;price=$params["items"][0]["price"]??0;<br/>}<br/>}</span></pre></div></div>    
</body>
</html>