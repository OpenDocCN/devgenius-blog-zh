# 如何在代码中添加重试逻辑，以及为什么这是最佳实践

> 原文：<https://blog.devgenius.io/how-to-add-retry-logic-to-your-code-and-why-it-is-a-best-practice-96f8c924dfce?source=collection_archive---------4----------------------->

## 重试服务呼叫的最佳实践

# 重试是最佳实践

你知道那句老话吗

> 如果你从马上掉下来，掸掉身上的灰尘，重新骑上

它实际上在设计和编写软件时有很多应用。有时，有些流程或工作流会失败。在这些情况下你会怎么做？一些程序员会简单地说

> “这不是我的错，我调用了此服务，但它让我失望了，所以我只是给用户一条错误消息，让他们重新启动工作流”

这是不可取的，即使服务在 99%的时间里都工作正常——当它失败时——对于您的客户或用户来说，这将是一个糟糕的用户体验。

对程序员来说，更好的答案是说

> 我调用的服务失败，所以让我再重试几次，并尝试得到我需要的结果来充分服务我的用户

这提供了一个更好的 UX，体现了*“重新上马”*的心态。

![](img/96eee32fc6f8dfe7e2523353415d0007.png)

…嗯，我的意思是至少多尝试一两次(由[史努比 FB](https://www.facebook.com/Snoopy/)

# 重试案例研究

## 问题陈述和解决方案

假设你需要一个不可靠的服务😬对于您的项目，失败率是 75%😱。你可能会认为这太可怕了！我如何使用这样的服务？！？！我的申请对❌的失败多于对✅.的成功在这种情况下，我们希望从重试包装器♻️.中调用服务

## 包括故障保护库

第一步是在你的项目中包含 Failsafe(或者你喜欢的任何其他重试库)

```
<dependency>
    <groupId>net.jodah</groupId>
    <artifactId>failsafe</artifactId>
    <version>2.4.0</version>
</dependency>
```

如果你想深入了解，这里有一个[故障保护文档](https://jodah.net/failsafe/)的链接。

## 我们称之为不可靠的服务

让我们创建我们蹩脚的服务💩它在 75%的情况下会失败，并且当它不可避免地失败时会抛出异常。

## 使用重试策略调用服务

现在我们有了不可靠的服务，是时候创建我们的重试逻辑来对抗这个来自地狱的函数调用了！😈

## 第 7–11 行创建重试策略

*   我们创建了一个重试策略，该策略期望我们使用的函数返回一个字符串
*   我们处理 **BadServiceException** 意味着我们只在看到这个异常时重试
*   当我们为了记录而重试时，我们**打印出一条消息**
*   我们设置了一个 **2 秒的延迟**,从我们得到异常到我们再次尝试
*   在我们放弃之前，我们最多允许 **2 次重试**

## **第 12–14 行使用重试策略调用服务**

最重要的(也可能是对你来说最陌生的)是第 13 行。在这一行中，我们使用我们创建的重试策略调用故障保护包装器中的 crappyService.callService()方法。您可以将其视为将调用打包到一个盒子中，该盒子将处理失败并仅在从 callService()获得成功返回后返回结果，否则我们将耗尽 2 次重试，在这种情况下，它将抛出 BadServiceException。

当您运行它时，您会看到它正在重试…有时会返回“数据”,而其他时候会在重试 2 次后失败。

```
retrying...
retrying...
data
```

![](img/bb9e04f1b1ad335e8753d02efcffc53d.png)

照片由[horsenation.com](https://www.horsenation.com/)拍摄

现在，你可以教你的代码掸掉身上的灰尘，跳回马鞍上，而不是坐在地上哭泣。