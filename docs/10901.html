<html>
<head>
<title>Scheduling with Rocketry</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">火箭计划</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/scheduling-with-rocketry-5aa5b1bed520?source=collection_archive---------9-----------------------#2022-12-06">https://blog.devgenius.io/scheduling-with-rocketry-5aa5b1bed520?source=collection_archive---------9-----------------------#2022-12-06</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><figure class="im in gp gr io ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi il"><img src="../Images/f6347349bbb8b21bbec91aaa5412e7ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iHDnPlqbeHeNLbe7s1JF1w.png"/></div></div></figure><div class=""/><p id="1bd9" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这是火箭学教程系列的第二部分。上次我做了一个关于火箭学的介绍性教程，你可以在这里找到它。如果对火箭学不熟悉，我建议先看一下。</p><p id="4aff" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在本教程中，我们讨论 Rocketry 的调度选项以及如何使用它们。我们还将介绍如何创建自定义条件。</p><h1 id="9367" class="ku kv iy bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">计划的基础</h1><p id="c06e" class="pw-post-body-paragraph jv jw iy jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">Rocketry 是一个基于语句的调度程序。这意味着任务的启动取决于一个可能为真或为假的陈述。这个语句实际上可以是任何内容，也可以是使用逻辑运算符的几个语句的组合。</p><p id="3be7" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">下面是一个简单的例子:</p><pre class="lx ly lz ma gt mb mc md bn me mf bi"><span id="099d" class="mg kv iy mc b be mh mi l mj mk">from rocketry import Rocketry<br/>from rocketry.conds import true, false<br/><br/>app = Rocketry()<br/><br/>@app.task(true)<br/>def do_constantly():<br/>    ...<br/><br/>@app.task(false)<br/>def do_never():<br/>    ...<br/><br/>if __name__ == "__main__":<br/>    app.run()</span></pre><p id="19a6" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">第一个任务将持续运行，因为它的启动条件总是<em class="ml">真</em>，而第二个任务将永远不会运行。通常情况下，您不希望任务在运行后立即再次运行。几个条件，如<em class="ml">每日</em>，依赖于任务运行历史，以确保当任务已经运行时它们不再为<em class="ml">真</em>。我们稍后将回到这些类型的条件，让我们回到基础。</p><p id="c463" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">因为条件只是布尔语句(真或假)，所以您还可以对它们使用逻辑运算符(AND、or、NOT):</p><pre class="lx ly lz ma gt mb mc md bn me mf bi"><span id="7712" class="mg kv iy mc b be mh mi l mj mk">@app.task(true &amp; (false | ~false))<br/>def do_constantly():<br/>    ...</span></pre><p id="024f" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">上述任务持续运行，因为结果条件仅仅是<em class="ml">真</em>。Rocketry 使用按位运算符作为逻辑运算符。以下是定义:</p><ul class=""><li id="fcb9" class="mm mn iy jx b jy jz kc kd kg mo kk mp ko mq ks mr ms mt mu bi translated">和运算符:a &amp; b</li><li id="040a" class="mm mn iy jx b jy mv kc mw kg mx kk my ko mz ks mr ms mt mu bi translated">OR 运算符:a | b</li><li id="58f7" class="mm mn iy jx b jy mv kc mw kg mx kk my ko mz ks mr ms mt mu bi translated">非运算符:~a</li></ul><p id="40f7" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">逻辑运算符使您能够扩展内置条件和自定义条件。您可以用它们创建非常复杂的调度策略。</p><h1 id="2c36" class="ku kv iy bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">调度选项</h1><p id="3307" class="pw-post-body-paragraph jv jw iy jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">Rocketry 有大量用于各种目的的内置调度条件。这些条件中的许多都有进一步约束它们的附加选项。这些条件可以分为几类:</p><ul class=""><li id="90a5" class="mm mn iy jx b jy jz kc kd kg mo kk mp ko mq ks mr ms mt mu bi translated">基于时间:每小时运行一次，当 10 秒钟过去时，等等。</li><li id="a08a" class="mm mn iy jx b jy mv kc mw kg mx kk my ko mz ks mr ms mt mu bi translated">任务相关:在另一个任务之后运行</li><li id="f4f3" class="mm mn iy jx b jy mv kc mw kg mx kk my ko mz ks mr ms mt mu bi translated">自定义:基于纯自定义逻辑运行</li><li id="1f2f" class="mm mn iy jx b jy mv kc mw kg mx kk my ko mz ks mr ms mt mu bi translated">以上的组合</li></ul><p id="5c83" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">此外，基于时间的调度可以分为两个部分:</p><ul class=""><li id="5bd4" class="mm mn iy jx b jy jz kc kd kg mo kk mp ko mq ks mr ms mt mu bi translated">固定时间(即。一天跑一次，一周跑一次等等。)</li><li id="4a15" class="mm mn iy jx b jy mv kc mw kg mx kk my ko mz ks mr ms mt mu bi translated">浮动时间(即。10 秒钟后运行)</li></ul><p id="41da" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">并且固定时间调度可以进一步分成两部分:</p><ul class=""><li id="e8f9" class="mm mn iy jx b jy jz kc kd kg mo kk mp ko mq ks mr ms mt mu bi translated">依赖于运行(任务是否已在给定时间段内运行)</li><li id="956b" class="mm mn iy jx b jy mv kc mw kg mx kk my ko mz ks mr ms mt mu bi translated">无状态(当前时间是否在给定时间段内)</li></ul><p id="7e52" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们会逐一查看。</p><h2 id="5ffd" class="na kv iy bd kw nb nc dn la nd ne dp le kg nf ng li kk nh ni lm ko nj nk lq nl bi translated">基于时间的调度</h2><p id="1aea" class="pw-post-body-paragraph jv jw iy jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">在其他框架中，cron 风格的调度通常用于基于时间的调度。Cron 是一种 UNIX 调度语言，用于在指定的时间间隔内运行任务。Rocketry 还支持 cron 风格的调度:</p><pre class="lx ly lz ma gt mb mc md bn me mf bi"><span id="802c" class="mg kv iy mc b be mh mi l mj mk">from rocketry.conds import cron<br/><br/>@app.task(cron("0 10 * * *"))<br/>def do_cron():<br/>    ...</span></pre><p id="1190" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这个特定的任务每天上午 10 点运行一次。您可以使用<a class="ae kt" href="https://crontab.guru/" rel="noopener ugc nofollow" target="_blank">https://crontab.guru/</a>对 cron 调度进行更多的修改。</p><p id="6466" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我个人觉得 cron 很难读懂，也经常很难维护。如果你像我一样，你可能更喜欢火箭技术的其他基于时间的条件:</p><pre class="lx ly lz ma gt mb mc md bn me mf bi"><span id="2f7d" class="mg kv iy mc b be mh mi l mj mk">from rocketry.conds import hourly, daily, weekly, monthly<br/><br/>@app.task(hourly)<br/>def do_hourly():<br/>    ... # Runs once an hour<br/><br/>@app.task(daily)<br/>def do_daily():<br/>    ... # Runs once a day<br/><br/>@app.task(weekly)<br/>def do_weekly():<br/>    ... # Runs once a week<br/><br/>@app.task(monthly)<br/>def do_monthly():<br/>    ... # Runs once a month</span></pre><p id="33c0" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">此外，这些条件也有额外的方法来约束它们为真时的时间段:之间的<em class="ml">、</em>处的<em class="ml">/</em>处的<em class="ml">、</em>之后的<em class="ml">、</em>之前的<em class="ml">以及从</em>开始的<em class="ml">:</em></p><pre class="lx ly lz ma gt mb mc md bn me mf bi"><span id="57f2" class="mg kv iy mc b be mh mi l mj mk">from rocketry.conds import daily<br/><br/>@app.task(daily.between("10:00", "13:00"))<br/>def do_between():<br/>    # Runs once when time is between 10 AM and 1 PM<br/>    ...<br/><br/>@app.task(daily.at("10:00"))<br/>def do_at():<br/>    # Runs once when time is between 10 AM and 11 AM<br/>    ...<br/><br/>@app.task(daily.after("10:00"))<br/>def do_after():<br/>    # Runs once when time is after 10 AM<br/>    ...<br/><br/>@app.task(daily.before("13:00"))<br/>def do_before():<br/>    # Runs once when time is before 1 PM<br/>    ...<br/><br/>@app.task(daily.starting("10:00"))<br/>def do_starting():<br/>    # Runs once a day but the day starts at 10 AM in <br/>    # this context<br/>    ...</span></pre><p id="3b9d" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">Rocketry 还支持浮动时间调度。例如，如果您希望在任务上次运行后经过特定时间后运行该任务:</p><pre class="lx ly lz ma gt mb mc md bn me mf bi"><span id="cdf5" class="mg kv iy mc b be mh mi l mj mk">from rocketry.conds import every<br/><br/>@app.task(every("2 hours 30 minutes"))<br/>def do_every():<br/>    ...</span></pre><h2 id="29fc" class="na kv iy bd kw nb nc dn la nd ne dp le kg nf ng li kk nh ni lm ko nj nk lq nl bi translated">无状态的基于时间的条件</h2><p id="1253" class="pw-post-body-paragraph jv jw iy jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">也有不依赖于任务的基于时间的条件。如果当前时间是给定的，则为真，否则为假。以下是一些例子:</p><pre class="lx ly lz ma gt mb mc md bn me mf bi"><span id="02a6" class="mg kv iy mc b be mh mi l mj mk">from rocketry.conds import time_of_hour, time_of_day, time_of_week, time_of_month<br/><br/>@app.task(time_of_hour.between("15:00", "45:00"))<br/>def do_between():<br/>    # Runs constantly when it is between 15 minutes past <br/>    # and 15 minutes to full hour<br/>    ...<br/><br/>@app.task(time_of_day.at("10:00"))<br/>def do_at():<br/>    # Runs constantly when time is between 10 AM and 11 AM<br/>    ...<br/><br/>@app.task(time_of_week.after("Monday"))<br/>def do_after():<br/>    # Runs constantly when the current week day is <br/>    # after Monday (including Monday)<br/>    ...<br/><br/>@app.task(time_of_month.before("20th"))<br/>def do_before():<br/>    # Runs constantly when current day of month is <br/>    # before 20th day<br/>    ...</span></pre><p id="3156" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这些条件在与其他条件结合时更有用。它们可用于进一步限制任务运行的时间。</p><h2 id="e93c" class="na kv iy bd kw nb nc dn la nd ne dp le kg nf ng li kk nh ni lm ko nj nk lq nl bi translated">任务相关性</h2><p id="b9d3" class="pw-post-body-paragraph jv jw iy jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">Rocketry 还支持设置任务依赖关系:一个任务将在另一个任务完成时运行。火箭学将它们直接应用到条件力学中:</p><pre class="lx ly lz ma gt mb mc md bn me mf bi"><span id="b5d4" class="mg kv iy mc b be mh mi l mj mk">from rocketry.conds import after_success<br/><br/>@app.task()<br/>def do_first():<br/>    ...<br/><br/>@app.task(after_success(do_first))<br/>def do_second():<br/>    ...</span></pre><p id="cad9" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">当任务<em class="ml"> do_first </em>成功时，任务<em class="ml"> do_second </em>将运行。还有<em class="ml"> after_failure </em>和<em class="ml"> after_finish </em>条件。</p><p id="9474" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如果您想在几个任务成功后运行您的任务，您可以使用这个条件和 OR 操作符，或者您可以使用<em class="ml"> after_all_success </em>来节省键入:</p><pre class="lx ly lz ma gt mb mc md bn me mf bi"><span id="52e0" class="mg kv iy mc b be mh mi l mj mk">from rocketry.conds import after_success<br/><br/>@app.task()<br/>def do_a():<br/>    ...<br/>@app.task()<br/>def do_b():<br/>    ...<br/>@app.task(after_all_success(do_a, do_b))<br/>def do_second():<br/>    ...</span></pre><p id="a512" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">此外，还有<em class="ml"> after_all_fail </em>和<em class="ml"> after_all_finish 以及所有这些选项的任何</em>变体(即<em class="ml"> after_any_fail </em>)。</p><h2 id="8fa3" class="na kv iy bd kw nb nc dn la nd ne dp le kg nf ng li kk nh ni lm ko nj nk lq nl bi translated">自定义条件</h2><p id="e124" class="pw-post-body-paragraph jv jw iy jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">在某些时候，你可能会意识到你无法从现有的调度条件中找到一个合适的。使用 Rocketry 创建自定义条件也很容易:</p><pre class="lx ly lz ma gt mb mc md bn me mf bi"><span id="2695" class="mg kv iy mc b be mh mi l mj mk">from pathlib import Path<br/><br/>@app.cond()<br/>def path_exists(file):<br/>    return Path(file).exists()<br/><br/>@app.task(path_exists("myfile.csv"))<br/>def do_with_file():<br/>    ...</span></pre><p id="df1d" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">上面我们创建了一个给定文件存在时为真的条件。然后我们创建了一个任务，当<em class="ml"> myfile.csv </em>存在时运行。请注意，该特定任务将不断重新运行，直到文件被删除。您可能希望将此与其他条件结合起来，例如每日<em class="ml"/>。</p><p id="25ad" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">您还可以使用任务本身、一些会话参数或调度程序本身来定义条件的逻辑。然而，这超出了本教程的范围，我们将在下一次讨论。</p><h1 id="4e95" class="ku kv iy bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">结论</h1><p id="b29c" class="pw-post-body-paragraph jv jw iy jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">现在我们已经知道了所有基本的条件类型，我将结合我们所学的内容，给大家留下一些复杂的例子:</p><pre class="lx ly lz ma gt mb mc md bn me mf bi"><span id="2e2c" class="mg kv iy mc b be mh mi l mj mk">from rocketry.conds import hourly, daily, weekly, time_of_day<br/><br/>@app.task(weekly.on("Monday") | weekly.on("Tuesday"))<br/>def do_twice_a_week():<br/>    ...<br/><br/>@app.task(hourly &amp; ~time_of_day.between("10:00", "12:00"))<br/>def do_hourly_but_not_on_lunch():<br/>    ...<br/><br/>@app.task(path_exists("myfile.csv") &amp; daily.after("10:00"))<br/>def do_daily_when_file_exists():<br/>    ... # The condition "path_exists" is from a previous example</span></pre><p id="93f8" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我希望你喜欢这个教程。如果你希望让我振作起来，帮助我专注于开发火箭技术并围绕它创造内容，你可以在 Github 上给我买一杯咖啡:<a class="ae kt" href="https://github.com/sponsors/Miksus" rel="noopener ugc nofollow" target="_blank">https://github.com/sponsors/Miksus</a>。</p><p id="1606" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">火箭学的链接:</p><ul class=""><li id="643d" class="mm mn iy jx b jy jz kc kd kg mo kk mp ko mq ks mr ms mt mu bi translated">文件:<a class="ae kt" href="https://rocketry.readthedocs.io/" rel="noopener ugc nofollow" target="_blank">https://rocketry.readthedocs.io/</a></li><li id="3b49" class="mm mn iy jx b jy mv kc mw kg mx kk my ko mz ks mr ms mt mu bi translated">来源: <a class="ae kt" href="https://github.com/Miksus/rocketry" rel="noopener ugc nofollow" target="_blank">https://github.com/Miksus/rocketry </a></li></ul></div></div>    
</body>
</html>