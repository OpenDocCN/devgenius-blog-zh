<html>
<head>
<title>PayPal Integration with Spring Boot</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">PayPal与Spring Boot的整合</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/paypal-integration-with-spring-boot-f1e297d76336?source=collection_archive---------0-----------------------#2021-06-10">https://blog.devgenius.io/paypal-integration-with-spring-boot-f1e297d76336?source=collection_archive---------0-----------------------#2021-06-10</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="0057" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如今，许多人都在使用其中一种支付网关进行支付。无论我们是通过网络购物还是支付账单，总会涉及到这样或那样的支付网关。作为全栈开发人员或后端开发人员，我们总是想知道如何将支付网关与我们的应用程序集成在一起。这篇文章将帮助你开始学习。</p><p id="3966" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">待办事项列表:</p><p id="1249" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">创建一个PayPal开发者帐户</p><p id="b806" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">创建测试应用程序</p><p id="1877" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">创建一些测试用户的电子邮件/密码，信用卡详细信息等，以测试支付。</p><p id="3a43" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">解释PayPal API的工作原理。</p><p id="6fd5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">创建Spring MVC应用程序</p><p id="52bd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">遵循XP技术来实现和测试集成。</p><p id="ee31" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">所以，不浪费任何时间，让我们开始吧。</p><h1 id="7078" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">创建PayPal开发者帐户:</h1><p id="6e6f" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">用PayPal创建一个开发者账户非常简单。我们只需要提供一个电子邮件和密码就可以开始了。访问<a class="ae ll" href="https://developer.paypal.com/" rel="noopener ugc nofollow" target="_blank"> PayPal开发者</a>网站，点击登录仪表板。你可以点击“注册”按钮。创建一个没有麻烦的开发者帐户的关键是不要把国家从“美国”改为“美国”,只需提供电子邮件和密码。</p><p id="6dac" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">使用新创建的凭据登录后，您将被重定向到开发人员控制面板。这是我们作为开发者可以尝试不同事物的领域。</p><figure class="ln lo lp lq gt lr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi lm"><img src="../Images/3392f2e802afa48baec2cc7ebea45c07.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BNdkEdCRCwGv9Aho83yxXA.png"/></div></div><figcaption class="ly lz gj gh gi ma mb bd b be z dk translated">开发者仪表板</figcaption></figure><p id="80af" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这是开发人员仪表板的一般外观。在主内容区，我们可以看到我们可以选择创建一个应用程序，可以与贝宝API互动。在左侧，我们可以看到我们有许多其他选项。重要的选项是“沙箱”-&gt;“帐户”部分，它让我们用自动生成的模拟数据创建测试用户。</p><p id="eafc" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">点击“创建应用程序”按钮创建应用程序。给出一个名称，并选择允许应用程序接受付款的商家选项。</p><figure class="ln lo lp lq gt lr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi mc"><img src="../Images/0fe5a4f1175c3b851e90e31b27828eac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x2LNA23Bf-3RoP3B879S3A.png"/></div></div></figure><p id="9aa9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">一旦应用程序被创建，你将会看到一个包含客户端id和客户端密码的页面。记下来。我们将使用这些凭证从我们的应用程序连接到PayPal。记住秘密是默认隐藏的。您必须点击显示链接，使客户端密码出现在页面上。一旦应用程序被创建，让我们创建一些测试用户开始付款。</p><h1 id="7c80" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">创建沙盒测试帐户</h1><p id="f516" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">让我们导航到<a class="ae ll" href="https://developer.paypal.com/developer/accounts/" rel="noopener ugc nofollow" target="_blank">“沙盒”——&gt;“账户”选项卡</a>。</p><figure class="ln lo lp lq gt lr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi md"><img src="../Images/1a8da4b7defaad78ef9458a0dd6fd63d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k4IwlhLFg0oVaoSgcLp97w.png"/></div></div><figcaption class="ly lz gj gh gi ma mb bd b be z dk translated">沙盒&gt;帐户</figcaption></figure><p id="a3bb" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这是我们可以用自动生成的模拟数据创建测试帐户的地方。这些帐户将像真正的用户一样通过你的应用程序进行支付。让我们单击“创建帐户”按钮，并选择帐户类型为“企业”。保留国家/地区不变，然后单击创建。</p><figure class="ln lo lp lq gt lr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi me"><img src="../Images/deb9a27eb96698b51a7c83f0241fb429.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lDBWObSZ8wc7sIqOJTVltg.png"/></div></div></figure><p id="0935" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">帐户创建后，您可以管理您的帐户。</p><p id="8ec6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">从“管理帐户”部分单击“查看/编辑帐户”选项。</p><figure class="ln lo lp lq gt lr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi mf"><img src="../Images/601d958ec16d19c4b6a1abfbac29a5f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o9tTw5PPC1MU_89gyr-azg.png"/></div></div></figure><p id="31d8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">您将获得创建的测试用户的详细信息，如名字和姓氏、电子邮件地址、系统生成的密码以及“个人资料”选项卡中的其他详细信息。您可以将选项卡切换到“Funding”来查找模拟信用卡的详细信息，该信息是与测试帐户余额一起为您生成的。记下我们将在测试中使用的用户凭据(通常是电子邮件和密码，但您也可以使用信用卡信息)。</p><p id="a0e7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这些都是我们将需要在我们的应用程序，以促进支付选项。是时候开始使用我们简单的Spring MVC应用程序了。</p></div><div class="ab cl mg mh hr mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ig ih ii ij ik"><p id="ff9a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在我们开始实际的应用程序之前，我想提醒一下，我们使用Rest APIs与PayPal服务器进行交互。因此，我们总是可以从头开始创建自己的实现并开始付款。但是这个过程太麻烦了，正因为如此，PayPal为我们提供了SDK来轻松快速地开始集成。PayPal SDK的使用让我们的生活变得更加轻松，所以我们会使用它。</p><h1 id="cea0" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">PayPal结账</h1><p id="ab51" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">PayPal提供了一个基于PayPal APIs的产品“PayPal Checkout ”,用于将他们的支付服务与您的应用程序集成。在我们开始实际编码之前，让我们看看PayPal结账工作流程在一个非常普通的情况下是怎样的:</p><p id="480f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">顾客下单:</strong>顾客点击<em class="mn">用PayPal结账</em>按钮。</p><p id="8804" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">客户被重定向至PayPal网站:</strong>客户被重定向至PayPal网站以完成交易。</p><p id="2bea" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">客户登录PayPal账户:</strong>客户必须登录PayPal账户才能完成交易。支付系统使用他们的PayPal账户中的账单和运输信息。</p><p id="426f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">顾客返回结账页面:</strong>顾客被重定向回商店的结账页面，以查看订单。</p><p id="621f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">客户下单:</strong>客户下单，订单信息提交给PayPal。</p><p id="6346" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> PayPal结算交易:</strong> PayPal接收订单并结算交易。</p><p id="9c34" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们需要执行两个主要步骤来完成支付。“创建订单”，然后“捕获订单”。“创建订单”步骤从客户下订单开始，到客户在PayPal上发起交易后被重定向回结账页面结束。创建订单后，最后一步是批准订单，这就是“捕获订单”的工作。“捕获命令”通常包括上述步骤中的最后两个步骤。以下是供你进一步阅读的参考资料。</p><p id="d638" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><a class="ae ll" href="https://developer.paypal.com/docs/business/checkout/" rel="noopener ugc nofollow" target="_blank">贝宝结账API</a></p><p id="47d3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><a class="ae ll" href="https://developer.paypal.com/docs/business/checkout/set-up-standard-payments/" rel="noopener ugc nofollow" target="_blank">用JavaScript设置结账流程</a></p><p id="8398" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><a class="ae ll" href="https://developer.paypal.com/docs/business/checkout/server-side-api-calls/create-order/" rel="noopener ugc nofollow" target="_blank">从服务器端创建订单API调用</a></p><p id="8282" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><a class="ae ll" href="https://developer.paypal.com/docs/business/checkout/server-side-api-calls/capture-order/" rel="noopener ugc nofollow" target="_blank">从服务器端捕获订单API调用</a></p><h1 id="4b91" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">PayPal SDK</h1><p id="0aff" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">PayPal SDK几乎出现在所有主要的编程语言中。对于本文，我将使用Java SDK。对于JavaScript SDK，PayPal更进一步，为我们提供了“<a class="ae ll" href="https://developer.paypal.com/docs/checkout/" rel="noopener ugc nofollow" target="_blank">智能按钮</a>”。这个按钮从我们这里提取了很多东西，如果你看一下PayPal文档中提供的图片，你会看到点击一个按钮就会发生很多事情。</p><figure class="ln lo lp lq gt lr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi mo"><img src="../Images/a0ce3b401f04999a59abe10ddef8ec06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*b-K7oYS5Nd2Li8akwZ25XA.png"/></div></div></figure><p id="acfd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在让我们创建一个自定义的普通按钮，并使用PayPal Java SDK来执行完全相同的任务。</p><h1 id="331b" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">创建Spring Boot应用程序</h1><p id="e44f" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">为了使用PayPal Java SDK，我们将使用maven依赖项，我们可以从这里找到<a class="ae ll" href="https://developer.paypal.com/docs/checkout/reference/server-integration/setup-sdk/" rel="noopener ugc nofollow" target="_blank"/>。</p><figure class="ln lo lp lq gt lr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi mp"><img src="../Images/a72b04dabf84b0aee2ec1ae628a4c644.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hapI4uAJqfnvmspXf6PAlQ.png"/></div></div></figure><p id="4a13" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让我们创建一个spring boot项目。因为简单，我将使用Mustache作为UI。</p><p id="d9cd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><a class="ae ll" href="https://github.com/NajeebArif/PayPal-Checkout-Spring-Boot" rel="noopener ugc nofollow" target="_blank">应用程序的Git存储库</a></p><p id="c811" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">首先让我们配置您的pom.xml或build.gradle文件</p><figure class="ln lo lp lq gt lr"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="6794" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们的应用程序将非常简单。我们将有一个索引页面，用户可以输入一个金额，并用贝宝支付，以启动贝宝结帐过程。<strong class="jm io">您可以在两个不同的步骤中打破“创建订单”&amp;“捕获订单”，但我将在一个请求中执行这两个请求。</strong></p><p id="54ce" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让我们创建一个<em class="mn">IndexControllerTest.java</em>并编写一个测试用例来检查当我们在“/”上执行GET时是否返回了视图命名索引。为了让它工作，我们将创建一个IndexController.java，用控制器和请求映射对其进行注释。让我们添加第一个测试用例:</p><figure class="ln lo lp lq gt lr"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="95b4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这个单元测试将会失败，因为我们还没有创建视图。(我会假设你熟悉像TDD这样的XP实践，所以我就不赘述了)。让我们在模板文件夹中创建一个“index.mustache ”,并在控制器中创建一个对应于GetMapping的方法。</p><figure class="ln lo lp lq gt lr"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="6baf" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">构建原始索引页面的时间到了。我将为它使用引导。</p><p id="2e8b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让我们创建一个表单来提交一个金额来模拟订单总值，我们将通过SDK将这个金额值发送到PayPal APIs来创建一个订单。</p><figure class="ln lo lp lq gt lr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi ms"><img src="../Images/b8a0c20f29898919cc1a97bbfa1c4a7d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vW-NJsEC5lqY-uv__JKkCA.png"/></div></div></figure><p id="a251" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">一旦我们准备好了表单，我们就可以在服务层上工作了。让我们创建一个支付服务接口(它碰巧也被命名为PaymentService.java ),并添加一个实现为PayPalPaymentService.java。</p><p id="5da2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们的界面应该能够接受需要发送到Paypal的总金额，以创建一个订单请求，它还应该发送一个url到Paypal，以便它可以重定向用户到我们的应用程序一旦订单被创建。一旦我们使用PayPal SDK执行创建订单请求，我们将从PayPal获得一个订单Id以及一组URL，这些URL可用于进一步对新创建的订单执行不同的操作。有关实际订单API的更多详细信息，请参考此链接。<a class="ae ll" href="https://developer.paypal.com/docs/api/orders/v2/" rel="noopener ugc nofollow" target="_blank">订购API码头V2 </a>。</p><p id="cac2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">一旦我们有了PayPal生成的订单id，我们就可以用它来捕捉订单并完成支付。</p><p id="e2ac" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在继续之前，了解订单的3个主要“状态”很重要。</p><p id="cf4e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">CREATED:订单创建时的第一个状态——“创建订单”操作的结果。</p><p id="5f4d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">已批准:订单一旦创建，需要在执行的最后阶段，即“抓取订单”之前进行批准</p><p id="bd71" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">已完成:一旦在“获取订单”阶段后处理了付款。</p><p id="66d1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">因此，当我们第一次创建订单时，它进入已创建状态，然后我们需要批准订单，然后才能使用“捕获订单”操作完成订单。不要担心，当我们第一次创建订单时，我们也会从PayPal获得一个批准订单的链接。我们可以使用该链接来批准订单。</p><p id="98a6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">订单还有其他状态，但是为了本文的目的，我们将坚持上面提到的三种状态。</p><h1 id="b55b" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">创建订单</h1><p id="617e" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">让我们从如何使用PayPal SDK创建订单开始。<a class="ae ll" href="https://github.com/paypal/Checkout-Java-SDK" rel="noopener ugc nofollow" target="_blank"> PayPal Java Checkout SDK </a>也提供了一些代码片段，告诉我们如何使用简单的Java代码来实现这一点。但是我们将利用Spring提供的特性。</p><p id="9013" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">首先，我们将编写一个简单的控制器方法，它将从我们的用户界面接受表单参数，并使用它来创建订单。我们还将把HttpServletRequest注入到我们的方法中，这样我们就可以构建一个返回url，一旦订单在订单创建后被批准，PayPal就可以将我们重定向到这个URL。</p><p id="9a01" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">因此，让我们创建一个有序控制器，并向它添加一些方法(现在我将跳过测试用例，但在实际项目中，请永远不要偏离XP实践)</p><figure class="ln lo lp lq gt lr"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="e7cf" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">是时候注入支付服务，并用两个参数——amount和return URL——将订单创建过程委托给它了。</p><figure class="ln lo lp lq gt lr"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="6923" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">CreatedOrder只是一个POJO:</p><figure class="ln lo lp lq gt lr"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="6cc2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">Aaarrrggghhh..我应该在这篇文章中使用Kotlin。好吧，我们继续。</p><p id="39bb" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们的支付界面现在看起来像这样:</p><figure class="ln lo lp lq gt lr"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="e18f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在是着手实施的时候了。</p><p id="4bd4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在使用PayPal SDK类进行实际的API调用之前，我们需要实例化PayPalHttpClient的一个实例。要做到这一点，我们将不得不使用在贝宝上创建的应用程序的客户端Id和秘密。让我们将它们添加到application.yml文件中。当然，我将只添加这些占位符，并在运行我的应用程序时提供实际的客户端id和密码。在现实世界中，您不应该在应用程序配置文件中硬编码任何敏感信息，而是应该从某种保险库中提取这些信息，并作为命令行参数提供给应用程序。注意:<em class="mn">如果你正在处理高度敏感的信息，那么将这些信息长时间保存在应用程序的内存中也被认为是一个安全漏洞，因此你应该避免将敏感信息长时间保存在内存中。</em>在application.yml中定义这些属性的时间</p><figure class="ln lo lp lq gt lr"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="1faf" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">请记住，现在你将必须提供应用程序的环境变量，以提供“paypal.clientId”和“paypal.secret”值。</p><p id="e3ab" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">是时候让我们的支付实现意识到这些属性了:</p><figure class="ln lo lp lq gt lr"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="9600" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这里，我们将application.yml文件中的值注入到这个类中，并使用它们来实例化PayPalHttpClient的一个实例。这个类稍后将为我们执行API调用。</p><p id="de3f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在事情从这里开始变得相当简单了。我们首先必须创建一个OrderRequest(如果您引用<a class="ae ll" href="https://developer.paypal.com/docs/api/orders/v2/" rel="noopener ugc nofollow" target="_blank"> Order API V2 </a>这一有效负载来创建订单)，用必需的参数填充它，例如<strong class="jm io"> intent </strong> <em class="mn">(这个请求的意图是什么)</em>、<strong class="jm io">购买单位</strong> <em class="mn">(用于指定必须扣除多少钱以及使用哪种货币)</em>和<strong class="jm io">应用程序上下文</strong> <em class="mn">(用于指定返回url)。</em></p><p id="153b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">一旦有效负载被公式化(<em class="mn">记住SDK为我们提供POJOs来公式化实际的有效负载</em>)，我们用创建的有效负载创建一个OrderCreateRequest，并使用我们的PayPal客户端执行“创建订单”流。从响应中，我们可以提取订单实体，并提取订单ID和批准链接，以便进一步处理。还记得订单状态吗？</p><figure class="ln lo lp lq gt lr"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="3715" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">一旦创建订单方法完成，我们就有了订单ID和批准订单的链接，这样我们就可以从“捕获订单”流程开始。回到我们的控制器，让我们将用户重定向到批准链接，以便订单获得批准。</p><figure class="ln lo lp lq gt lr"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="ceaf" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">一旦请求被重定向到批准URI，PayPal会识别该请求并批准与之相关的订单，然后将请求从PayPal服务器重定向到我们在创建订单请求时在应用程序上下文中设置的“返回URL”。在我的例子中，它将<a class="ae ll" href="http://localhost:8080/orders/capture" rel="noopener ugc nofollow" target="_blank"><em class="mn">http://localhost:8080/orders/capture</em></a><em class="mn"/>，spring将自动调用映射的控制器方法进行url映射。这里需要记住的一件重要事情是，当PayPal在订单被批准后将请求重定向到“返回URL”时，它会将订单id作为请求参数发送，其键名为<strong class="jm io">“token”</strong>，因此我们将在控制器方法中捕获该参数，并使用该订单id通过执行“捕获订单”流程来完成订单。</p><figure class="ln lo lp lq gt lr"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="5f73" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我在这里使用订单id将它放在模型中，以便它可以显示在订单页面中。</p><p id="0afc" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">转到captureOrder实现。没有比这更简单的了。</p><figure class="ln lo lp lq gt lr"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="7fc0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">是的，该方法是在付款接口中定义的。</p><p id="caa3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们通过将orderId传递给其构造函数来创建一个<strong class="jm io"> OrdersCaptureRequest </strong>，并使用我们的paypal客户端来执行请求。</p><p id="837d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在我们已经设置好了一切，让我们测试我们的应用程序。我们走吧。</p><h1 id="48e9" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">测试支付</h1><p id="4780" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">我们用500美元吧</p><figure class="ln lo lp lq gt lr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi ms"><img src="../Images/e3ed32ff55bfe782d011318943687366.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Kvw1WVIha4LBXdt4lnODrA.png"/></div></div></figure><p id="420f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">点击结账的时间:</p><figure class="ln lo lp lq gt lr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi mt"><img src="../Images/c0294b8d1826d003e710efd21651e3cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ldauzCTsqcKalTlMEBDYOQ.png"/></div></div></figure><p id="6ee0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让我们提供我们创建的测试用户的凭证(还记得John Doe吗，PayPal为我们创建的使用自动生成的一堆值。是啊，那家伙。)</p><p id="5fd8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">点击登录后，我们将被重定向到贝宝网页</p><figure class="ln lo lp lq gt lr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi mu"><img src="../Images/91f3faaba7bced98fc73a89180cfa407.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KpK-KR049ogQeYLgzekDNA.png"/></div></div></figure><p id="7720" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在此页面上，用户可以选择送货地址，也可以选择使用不同的支付方式，但我们会坚持使用贝宝余额，并将点击继续。</p><p id="b78a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">完成所有工作后，我们被重定向到订单页面以查看订单id</p><figure class="ln lo lp lq gt lr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi mv"><img src="../Images/6a6d56f3a194b5cc7de81e21e9972d33.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BfdH5PWOTufqqmVoWHX9Kg.png"/></div></div></figure><p id="1824" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">是的，你可以设计一个精彩的网页，但我只是想展示整个流程。<br/>出于审计目的，还建议将一些方面的日志订单细节写入某种后端存储中。</p><p id="e429" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">伙计们，就这样了。如果你需要学习如何将Paypal与单页应用程序集成，请告诉我。非常感谢您的反馈。如果你认为某件事可以改进。</p></div></div>    
</body>
</html>