<html>
<head>
<title>Node.js Tips — Router, Shutdown, File Name of Uploads, and etag</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Node.js提示—路由器、关机、上传的文件名和etag</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/node-js-tips-router-shutdown-file-name-of-uploads-and-etag-8b0e7a4c481a?source=collection_archive---------10-----------------------#2020-07-25">https://blog.devgenius.io/node-js-tips-router-shutdown-file-name-of-uploads-and-etag-8b0e7a4c481a?source=collection_archive---------10-----------------------#2020-07-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/02de982263653f588fe6f96fc0b9db1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*SazhhC2i-bta6UaR"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">照片由<a class="ae kc" href="https://unsplash.com/@edsonfotopet?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">埃德森·托雷斯</a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="e775" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">像任何类型的应用程序一样，当我们编写节点应用程序时，有一些困难的问题需要解决。</p><p id="96a1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将研究一些编写节点应用程序时常见问题的解决方案。</p><h1 id="d098" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">优雅关闭Express应用程序的简单方法</h1><p id="80f8" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">为了让优雅地关闭Express应用程序更加容易，我们可以使用<a class="ae kc" href="https://github.com/moebius-mlm/http-graceful-shutdown" rel="noopener ugc nofollow" target="_blank">@ moebius/http-graceful-shut down</a>模块来让关闭连接更加容易。</p><p id="cd41" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要安装它，我们运行:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="f8eb" class="mn lc iq mj b gy mo mp l mq mr">npm i -S @moebius/http-graceful-shutdown</span></pre><p id="310a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们可以写:“</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="fa65" class="mn lc iq mj b gy mo mp l mq mr">const express = require('express');<br/>const GracefulShutdownManager = require('@moebius/http-graceful-shutdown').GracefulShutdownManager;</span><span id="5d53" class="mn lc iq mj b gy ms mp l mq mr">const app = express();</span><span id="4c85" class="mn lc iq mj b gy ms mp l mq mr">const server = app.listen(8080);</span><span id="1ede" class="mn lc iq mj b gy ms mp l mq mr">const shutdownManager = new GracefulShutdownManager(server);</span><span id="81a6" class="mn lc iq mj b gy ms mp l mq mr">process.on('SIGTERM', () =&gt; {<br/>  shutdownManager.terminate(() =&gt; {<br/>    console.log('Server is terminated');<br/>  });<br/>});</span></pre><p id="c828" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们只是在Express服务器上使用包的<code class="fe mt mu mv mj b">GracefulShutdownManager</code>构造函数。</p><p id="d884" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们可以观察<code class="fe mt mu mv mj b">SIGTERM</code>信号，并对其调用<code class="fe mt mu mv mj b">terminate</code>方法。</p><p id="34a7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当终止完成时，将调用<code class="fe mt mu mv mj b">terminate</code>中的回调。</p><h1 id="fb31" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">错误:大多数中间件(如json)不再与Express捆绑在一起，必须单独安装。</h1><p id="0191" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">在Express 4中，我们必须安装大部分以前单独包含的软件包。</p><p id="297a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们必须安装像主体解析器和模板引擎这样的包。</p><p id="40f8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，为了安装body-parser，我们运行:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="d8b0" class="mn lc iq mj b gy mo mp l mq mr">npm i body-parser</span></pre><p id="d6bc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们可以通过写来使用它:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="fce7" class="mn lc iq mj b gy mo mp l mq mr">const http = require('http');<br/>const express = require('express');<br/>const bodyParser = require('body-parser');<br/>const mysql = require('mysql');<br/>const ejs = require('ejs');</span><span id="186a" class="mn lc iq mj b gy ms mp l mq mr">const app = express();</span><span id="4adc" class="mn lc iq mj b gy ms mp l mq mr">app.use(bodyParser.urlencoded({<br/>    extended: true<br/>}));</span><span id="081e" class="mn lc iq mj b gy ms mp l mq mr">app.use(bodyParser.json());</span></pre><h1 id="ab03" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">用Multer存储文件扩展名为的文件</h1><p id="97fb" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">要存储文件扩展名为Multer的文件，我们可以在文件名后添加扩展名。</p><p id="ced8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="a527" class="mn lc iq mj b gy mo mp l mq mr">const multer = require('multer');</span><span id="e9a9" class="mn lc iq mj b gy ms mp l mq mr">const storage = multer.diskStorage({<br/>  destination(req, file, cb) {<br/>    cb(null, 'uploads/')<br/>  },<br/>  filename(req, file, cb) {<br/>    cb(null, `${Date.now()}.png`)<br/>  }<br/>})</span><span id="2079" class="mn lc iq mj b gy ms mp l mq mr">const upload = multer({ storage });</span></pre><p id="445d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们用一个有几个方法的对象来调用<code class="fe mt mu mv mj b">multer.diskStorage</code>方法。</p><p id="97e0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mt mu mv mj b">destination</code>方法指定上传文件的文件夹。</p><p id="dfe7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在<code class="fe mt mu mv mj b">filename</code>方法中，我们用文件名和扩展名调用<code class="fe mt mu mv mj b">cb</code>回调。</p><p id="cc28" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们还可以在<code class="fe mt mu mv mj b">filename</code>方法中从MIME类型中获取扩展。</p><p id="9c30" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="74ad" class="mn lc iq mj b gy mo mp l mq mr">const multer = require('multer');<br/>import * as mime from 'mime-types';</span><span id="6e62" class="mn lc iq mj b gy ms mp l mq mr">const storage = multer.diskStorage({<br/>  destination(req, file, cb) {<br/>    cb(null, 'uploads/')<br/>  },<br/>  filename(req, file, cb) {<br/>    const ext = mime.extension(file.mimetype);<br/>    cb(null, `${Date.now()}.${ext}`);<br/>  }<br/>})</span><span id="8f4b" class="mn lc iq mj b gy ms mp l mq mr">const upload = multer({ storage });</span></pre><p id="23b6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们使用mime-types包来帮助我们获取上传文件的mime类型，我们将使用它作为扩展名。</p><p id="8c4f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mt mu mv mj b">mime.extension</code>让我们从MIME类型中获取扩展。</p><p id="f7a3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mt mu mv mj b">file</code>是文件对象。<code class="fe mt mu mv mj b">file.mimetype</code>是MIME-type。</p><p id="0e5b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，我们将扩展名插入回调中的文件名字符串。</p><h1 id="49b0" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">在Express中设置默认路径(路由前缀)</h1><p id="c76f" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以使用Express的<code class="fe mt mu mv mj b">Router</code>构造函数来创建一个路由器对象。</p><p id="e050" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是我们可以向路由添加路由前缀的地方。</p><p id="da33" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="252a" class="mn lc iq mj b gy mo mp l mq mr">const router = express.Router();<br/>router.use('/posts', post);</span><span id="d5f6" class="mn lc iq mj b gy ms mp l mq mr">app.use('/api/v1', router);</span></pre><p id="305a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先，我们通过调用<code class="fe mt mu mv mj b">express.Router()</code>来创建<code class="fe mt mu mv mj b">router</code>。</p><p id="4ab7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们调用<code class="fe mt mu mv mj b">router.use</code>来创建一条路径为<code class="fe mt mu mv mj b">posts</code>的路由。</p><p id="bfa7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们调用<code class="fe mt mu mv mj b">app.use</code>将<code class="fe mt mu mv mj b">router </code>作为第二个参数传递给它。</p><p id="7ba6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将前缀<code class="fe mt mu mv mj b">/api/v1</code>指定为<code class="fe mt mu mv mj b">app.use</code>的第一个参数。</p><p id="c408" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，我们可以通过编写以下内容将它们链接在一起:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="6499" class="mn lc iq mj b gy mo mp l mq mr">app.route('/post')<br/>  .get((req, res) =&gt; {<br/>    res.send('get post')<br/>  })<br/>  .post((req, res) =&gt; {<br/>    res.send('add post')<br/>  })<br/>  .put((req, res) =&gt; {<br/>    res.send('update post')<br/>  });</span></pre><p id="5fa7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们有GET、POST和PUT路由使用的<code class="fe mt mu mv mj b">post</code>路径。</p><h1 id="da6e" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">在Express中禁用etag标题</h1><p id="c974" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以通过调用<code class="fe mt mu mv mj b">app.set</code>禁用带有Express的<code class="fe mt mu mv mj b">etag</code>标题。</p><p id="3dc6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="fee3" class="mn lc iq mj b gy mo mp l mq mr">app.set('etag', false);</span></pre><p id="2165" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">关闭<code class="fe mt mu mv mj b">etag</code>割台。</p><p id="5c1f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们也可以写:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="e062" class="mn lc iq mj b gy mo mp l mq mr">app.disable('etag')</span></pre><p id="3696" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">做同样的事情。</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mw"><img src="../Images/498367b0f15202959c1c85950a14e0a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ICMIj-gYZBOX-JuN"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">照片由<a class="ae kc" href="https://unsplash.com/@dienyportinanni?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Dieny Portinanni </a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><h1 id="9afc" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="d56b" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以用一个包优雅地关闭一个Express服务器。</p><p id="162f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，我们必须安装以前包含在Express ourselves中的大多数中间件。</p><p id="1abc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以从上传的文件中获取扩展名，并将其附加到上传文件的文件名上。</p><p id="26cc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">快递的路由器是可以连锁的。</p><p id="6cb0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">可以禁用<code class="fe mt mu mv mj b">etag</code>割台。</p></div></div>    
</body>
</html>