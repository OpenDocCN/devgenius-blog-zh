<html>
<head>
<title>Kubernetes Installation on Openstack VM’s with Kubeadm</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Kubeadm 在 Openstack 虚拟机上安装 Kubernetes</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/kubernetes-installation-on-openstack-vms-with-kubeadm-fec5d96b1db8?source=collection_archive---------3-----------------------#2022-01-12">https://blog.devgenius.io/kubernetes-installation-on-openstack-vms-with-kubeadm-fec5d96b1db8?source=collection_archive---------3-----------------------#2022-01-12</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="8bfd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这篇文章演示了使用 kubeadm 在 Openstack 托管的 VM 上安装 kubernetes。</p><p id="1ca8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们假设为此安装创建一个空白的 Openstack 项目。</p><p id="14e1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">Debian 11 被用作虚拟机的操作系统。</p></div><div class="ab cl ki kj hr kk" role="separator"><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn"/></div><div class="ig ih ii ij ik"><h1 id="57d3" class="kp kq in bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated"><strong class="ak">步骤 1:创建专用网络</strong></h1><p id="d930" class="pw-post-body-paragraph jk jl in jm b jn ln jp jq jr lo jt ju jv lp jx jy jz lq kb kc kd lr kf kg kh ig bi translated">点击“网络-&gt;网络”菜单后的“创建网络”按钮。</p><p id="b12a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">写一个适合你个人喜好的网络名称。</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi ls"><img src="../Images/15a583614339a8f137721d21f3895a61.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LG2M6oswaDpWK9tyi-5EBw.png"/></div></div><figcaption class="me mf gj gh gi mg mh bd b be z dk translated">命名网络</figcaption></figure><p id="7539" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们应该为实例(未来的 Kubernetes 节点)的 IP 分配创建一个子网。</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi mi"><img src="../Images/87bb953cb02a82d3ac03f01d58696156.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k88KposdoFKgpzelDQ6JeA.png"/></div></div><figcaption class="me mf gj gh gi mg mh bd b be z dk translated">确定网络的子网</figcaption></figure><p id="b61f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">单击“下一步”并完成向导。</p></div><div class="ab cl ki kj hr kk" role="separator"><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn"/></div><div class="ig ih ii ij ik"><h1 id="c04b" class="kp kq in bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated"><strong class="ak">第二步:创建路由器</strong></h1><p id="71a4" class="pw-post-body-paragraph jk jl in jm b jn ln jp jq jr lo jt ju jv lp jx jy jz lq kb kc kd lr kf kg kh ig bi translated">为了从互联网访问实例，我们需要通过路由器将实例连接到公共网络。</p><p id="22c4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">沿着“网络-&gt;路由器”路径，点击“创建路由器”按钮。</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi mj"><img src="../Images/58840de176410481f77bd74d1015e799.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Be8tXKJhLtS38qJ9dnGXnQ.png"/></div></div><figcaption class="me mf gj gh gi mg mh bd b be z dk translated">创建路由器</figcaption></figure><p id="58d2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">命名路由器并从“外部网络”列表中选择公共网络，然后完成向导。</p><p id="f7d5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">创建路由器后，单击路由器名称。</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div class="gh gi mk"><img src="../Images/b898597bcf01c59590188e2339268db0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1348/format:webp/1*Jbwx2TLGwBUKneuNBN8p4g.png"/></div><figcaption class="me mf gj gh gi mg mh bd b be z dk translated">路由器详细信息</figcaption></figure><p id="aa09" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">单击“接口”选项卡，然后在打开的页面上单击“添加接口”按钮。</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi ml"><img src="../Images/536e5e481d752630601e2187b10ec9a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6DADPxexwxXp5hw4uCAE9g.png"/></div></div><figcaption class="me mf gj gh gi mg mh bd b be z dk translated">向路由器添加接口</figcaption></figure><p id="9f11" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">选择我们的实例使用的合适的专用子网，然后完成向导。</p><p id="a754" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在此过程之后，您应该会看到如下所示的路由器菜单。</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi mm"><img src="../Images/1e59c4940f70983f831d66eaf9cab533.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pMAMzx4MC0lbweQ5XhtRoA.png"/></div></div><figcaption class="me mf gj gh gi mg mh bd b be z dk translated">路由器菜单</figcaption></figure></div><div class="ab cl ki kj hr kk" role="separator"><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn"/></div><div class="ig ih ii ij ik"><h1 id="0b13" class="kp kq in bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated"><strong class="ak">第三步:创建实例</strong></h1><p id="4217" class="pw-post-body-paragraph jk jl in jm b jn ln jp jq jr lo jt ju jv lp jx jy jz lq kb kc kd lr kf kg kh ig bi translated">我们准备创建实例。</p><p id="35e0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">打开“实例”菜单，然后单击“启动实例”按钮。</p><p id="af0f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在开始屏幕上命名实例。</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi mn"><img src="../Images/79374a1dad3c3f901ec6a836ac7ee12c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LS-paiZmg4OB6jHZVm8s8w.png"/></div></div><figcaption class="me mf gj gh gi mg mh bd b be z dk translated">启动实例屏幕</figcaption></figure><p id="b112" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">选择口味。您应该选择一个具有超过 2g 内存的版本(Kubernetes 主节点推荐 4GB)。</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi mo"><img src="../Images/f4ae7e531d3c3111639422ecd04ca95a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UAlB3in0lx2qNKd3JfmcvA.png"/></div></div><figcaption class="me mf gj gh gi mg mh bd b be z dk translated">选择口味</figcaption></figure><p id="5c09" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">选择您创建的用作内部网络的网络。</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi mp"><img src="../Images/ecff6660b8ea7ad6ec1f7b157be55a66.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lZCPIu8keP2-ny7S5o_ZaQ.png"/></div></div><figcaption class="me mf gj gh gi mg mh bd b be z dk translated">选择网络</figcaption></figure><p id="77d8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">为连接实例附加密钥对。(你自己看吧)</p><p id="ae9a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果您计划单独安装主节点和工作节点，请分两次执行此过程。</p></div><div class="ab cl ki kj hr kk" role="separator"><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn"/></div><div class="ig ih ii ij ik"><h1 id="18a9" class="kp kq in bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated"><strong class="ak">第四步:分配和关联浮动 IP</strong></h1><p id="769a" class="pw-post-body-paragraph jk jl in jm b jn ln jp jq jr lo jt ju jv lp jx jy jz lq kb kc kd lr kf kg kh ig bi translated">我们需要为我们的实例分配和关联浮动 ip 地址，以便从网络外部访问它们。</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi mq"><img src="../Images/c830ba547f8ae30347941e39760166c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YxqJbh5BzVfpK5Y9TX-9lA.png"/></div></div><figcaption class="me mf gj gh gi mg mh bd b be z dk translated">实例屏幕</figcaption></figure><p id="7e23" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">单击位于实例右侧的下拉列表，然后选择“关联浮动 IP”</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi mr"><img src="../Images/31487ef36a15190a77acfb7358b5c3ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vajA5fyLCrpkoeTG33O3YA.png"/></div></div><figcaption class="me mf gj gh gi mg mh bd b be z dk translated">关联浮动 IP</figcaption></figure><p id="aa58" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果您之前创建了浮动 IP 地址，则可以选择一个现有地址并将其与选定的实例相关联。如果您没有任何浮动 IP，向导将帮助您创建一个浮动 IP，毕竟，您可以将此浮动 IP 关联到实例。</p><p id="d90f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">完成这个过程后，您应该会看到如下所示的屏幕。</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi ms"><img src="../Images/36404d7c9ddc2ab97b5f282e6019fbc5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3DYDrn5FSSC_nJfcbAMCTQ.png"/></div></div><figcaption class="me mf gj gh gi mg mh bd b be z dk translated">浮动 IP 关联实例</figcaption></figure></div><div class="ab cl ki kj hr kk" role="separator"><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn"/></div><div class="ig ih ii ij ik"><h1 id="e0dd" class="kp kq in bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated"><strong class="ak">步骤 5:修改安全组</strong></h1><p id="faf1" class="pw-post-body-paragraph jk jl in jm b jn ln jp jq jr lo jt ju jv lp jx jy jz lq kb kc kd lr kf kg kh ig bi translated">我们必须允许 ssh 流量通过使用安全组从外部访问实例。</p><p id="6ff8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">沿着“Network-&gt;Security Groups”路径，然后单击与我们的实例相关联的安全组上的“Manage Rules”按钮(如果您在它可能被命名为“default”之前没有进行任何更改)。</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi mt"><img src="../Images/b4918f461aa5920462cbfb846ec43de8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P1e6oRfLdqo0DFvyWj-RPQ.png"/></div></div><figcaption class="me mf gj gh gi mg mh bd b be z dk translated">安全组规则列表</figcaption></figure><p id="7208" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">从列表中选择 SSH 并完成向导。</p></div><div class="ab cl ki kj hr kk" role="separator"><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn"/></div><div class="ig ih ii ij ik"><h1 id="d870" class="kp kq in bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated"><strong class="ak">步骤 6:连接并准备实例</strong></h1><p id="490c" class="pw-post-body-paragraph jk jl in jm b jn ln jp jq jr lo jt ju jv lp jx jy jz lq kb kc kd lr kf kg kh ig bi translated">我们需要为 Kubernetes 安装准备创建的实例。</p><p id="f594" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> 1) </strong>为了让 iptables 看到桥接的流量，我们必须加载“<em class="mu"> br-netfilter </em>模块。这可以通过执行<code class="fe mv mw mx my b">sudo modprobe br_netfilter</code>来完成</p><p id="2728" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">成功安装模块后，您必须通过执行以下命令来添加参数，以正确查看桥接的流量。</p><pre class="lt lu lv lw gt mz my na nb aw nc bi"><span id="ed24" class="nd kq in my b gy ne nf l ng nh">$ cat &lt;&lt;EOF | sudo tee /etc/modules-load.d/k8s.conf<br/>br_netfilter<br/>EOF<br/><br/>$ cat &lt;&lt;EOF | sudo tee /etc/sysctl.d/k8s.conf<br/>net.bridge.bridge-nf-call-ip6tables = 1<br/>net.bridge.bridge-nf-call-iptables = 1<br/>EOF</span><span id="9afb" class="nd kq in my b gy ni nf l ng nh">$ sudo sysctl --system</span></pre><p id="9b6d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> 2) </strong>为了 Docker 的兼容性，在系统上禁用 cgroup 支持</p><p id="1d4c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们必须在实例上禁用 cgroup 支持，因为它们可能会产生兼容性错误。</p><p id="f495" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">您必须将以下内核命令行参数添加到<strong class="jm io"><em class="mu">"/etc/default/grub "</em></strong>文件中</p><pre class="lt lu lv lw gt mz my na nb aw nc bi"><span id="50a4" class="nd kq in my b gy ne nf l ng nh">systemd.unified_cgroup_hierarchy=0</span><span id="7bd5" class="nd kq in my b gy ni nf l ng nh">systemd.legacy_systemd_cgroup_controller=0</span></pre><p id="fd6e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">以下是 grub 文件示例。不建议换成你的。你应该手工添加这些参数。</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi nj"><img src="../Images/5708ed3fe558da5fb77d905a2806873b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wif7jb1xhjoaElWHD26UQA.png"/></div></div><figcaption class="me mf gj gh gi mg mh bd b be z dk translated">Grub 文件示例</figcaption></figure><p id="2a74" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在这一步之后，您必须使用以下命令来更新 grub。</p><pre class="lt lu lv lw gt mz my na nb aw nc bi"><span id="39c3" class="nd kq in my b gy ne nf l ng nh">$ sudo update-grub</span></pre><p id="9218" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">然后重新启动实例。</p><p id="04cb" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">重要提示:您必须为您的所有实例进行这种配置。</strong></p><p id="5d5d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们需要安装 Docker 环境作为将被 Kubernetes 使用的容器运行时。</p><p id="91d8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">a)安装要求:</p><pre class="lt lu lv lw gt mz my na nb aw nc bi"><span id="3bc3" class="nd kq in my b gy ne nf l ng nh">$ sudo apt-get update<br/><br/>$ sudo apt-get install \<br/>    ca-certificates \<br/>    curl \<br/>    gnupg \<br/>    lsb-release</span></pre><p id="7c46" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">b)获取并添加 Docker 存储库的 GPG 键:</p><pre class="lt lu lv lw gt mz my na nb aw nc bi"><span id="41d6" class="nd kq in my b gy ne nf l ng nh">$ curl -fsSL <a class="ae nk" href="https://download.docker.com/linux/debian/gpg" rel="noopener ugc nofollow" target="_blank">https://download.docker.com/linux/debian/gpg</a> | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg</span></pre><p id="f851" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">c)添加 Docker 存储库:</p><pre class="lt lu lv lw gt mz my na nb aw nc bi"><span id="10cf" class="nd kq in my b gy ne nf l ng nh">$ echo \<br/>  "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian \<br/>  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null</span></pre><p id="bb11" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">d)安装 Docker 环境:</p><pre class="lt lu lv lw gt mz my na nb aw nc bi"><span id="41bd" class="nd kq in my b gy ne nf l ng nh">$ sudo apt-get update<br/>$ sudo apt-get install docker-ce docker-ce-cli containerd.io</span></pre></div><div class="ab cl ki kj hr kk" role="separator"><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn"/></div><div class="ig ih ii ij ik"><h1 id="7388" class="kp kq in bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated"><strong class="ak">第七步:安装 Kubernetes </strong></h1><p id="0de7" class="pw-post-body-paragraph jk jl in jm b jn ln jp jq jr lo jt ju jv lp jx jy jz lq kb kc kd lr kf kg kh ig bi translated">如果在这一步之前您没有得到任何错误，那么您已经准备好安装 Kubernetes 了。</p><p id="1d1d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> 1) </strong>安装要求:</p><pre class="lt lu lv lw gt mz my na nb aw nc bi"><span id="e2a8" class="nd kq in my b gy ne nf l ng nh">$ sudo apt-get update<br/>$ sudo apt-get install -y apt-transport-https ca-certificates curl</span></pre><p id="316f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> 2) </strong>获取并添加谷歌云仓库的 GPG 密钥:</p><pre class="lt lu lv lw gt mz my na nb aw nc bi"><span id="3af2" class="nd kq in my b gy ne nf l ng nh">$ sudo curl -fsSLo /usr/share/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg</span></pre><p id="95a1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> 3) </strong>添加 Kubernetes <code class="fe mv mw mx my b">apt</code>库:</p><pre class="lt lu lv lw gt mz my na nb aw nc bi"><span id="211f" class="nd kq in my b gy ne nf l ng nh">$ echo "deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] <a class="ae nk" href="https://apt.kubernetes.io/" rel="noopener ugc nofollow" target="_blank">https://apt.kubernetes.io/</a> kubernetes-xenial main" | sudo tee /etc/apt/sources.list.d/kubernetes.list</span></pre><p id="8ab1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> 4) </strong>安装 kubelet、kubeadm 和 kubectl:</p><pre class="lt lu lv lw gt mz my na nb aw nc bi"><span id="596d" class="nd kq in my b gy ne nf l ng nh">$ sudo apt-get update<br/>$ sudo apt-get install -y kubelet kubeadm kubectl<br/>$ sudo apt-mark hold kubelet kubeadm kubectl</span></pre><p id="80b0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">重要提示:你必须在你的所有实例上做同样的过程。</p><p id="196e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> 5) </strong>创建 kubeadm-config.yaml:</p><p id="e3da" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们将使用 kubeadm-config.yaml 来配置我们的 Kubernetes 集群。您可以使用以下命令创建和编辑该文件。</p><pre class="lt lu lv lw gt mz my na nb aw nc bi"><span id="999a" class="nd kq in my b gy ne nf l ng nh">$ sudo nano kubeadm-config.yaml</span></pre><p id="b7d7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">下面是我们的 kubeadm-config.yaml 文件的内容。</p><pre class="lt lu lv lw gt mz my na nb aw nc bi"><span id="44f2" class="nd kq in my b gy ne nf l ng nh"># kubeadm-config.yaml</span><span id="6bdb" class="nd kq in my b gy ni nf l ng nh">kind: ClusterConfiguration</span><span id="e258" class="nd kq in my b gy ni nf l ng nh">apiVersion: kubeadm.k8s.io/v1beta3</span><span id="8c68" class="nd kq in my b gy ni nf l ng nh">kubernetesVersion: v1.23.1</span><span id="d238" class="nd kq in my b gy ni nf l ng nh">networking:</span><span id="5b42" class="nd kq in my b gy ni nf l ng nh">podSubnet: "10.244.0.0/16" # --pod-network-cidr for using with flannel</span><span id="3066" class="nd kq in my b gy ni nf l ng nh">---</span><span id="0a4d" class="nd kq in my b gy ni nf l ng nh">kind: KubeletConfiguration</span><span id="9c79" class="nd kq in my b gy ni nf l ng nh">apiVersion: kubelet.config.k8s.io/v1beta1</span><span id="715f" class="nd kq in my b gy ni nf l ng nh">cgroupDriver: cgroupfs</span></pre><p id="b6d7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">将更改写入文件并关闭编辑器。(按 F3-&gt;回车-&gt;F2)</p><p id="c435" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> 6) </strong>应用 kubeadm-config.yaml:</p><p id="2b80" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们准备配置 Kubernetes 主节点。您可以通过以下命令开始配置。</p><pre class="lt lu lv lw gt mz my na nb aw nc bi"><span id="131b" class="nd kq in my b gy ne nf l ng nh">$ kubeadm init --config kubeadm-config.yaml</span></pre><p id="3263" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">成功执行该命令后，kubeadm 工具将提示您一个如下所示的输出:</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/df66f13e12ede1f83e29f10452ad0ea8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1318/format:webp/1*S-DABAM0GfqO5Q7hwo0pdg.jpeg"/></div><figcaption class="me mf gj gh gi mg mh bd b be z dk translated">Kubeadm 输出</figcaption></figure><p id="2725" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">下面是 kubeadm 命令的输出模式示例:</p><pre class="lt lu lv lw gt mz my na nb aw nc bi"><span id="cdf7" class="nd kq in my b gy ne nf l ng nh">Your Kubernetes control-plane has initialized successfully!<br/><br/>To start using your cluster, you need to run the following as a regular user:<br/><br/>  mkdir -p $HOME/.kube<br/>  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config<br/>  sudo chown $(id -u):$(id -g) $HOME/.kube/config<br/><br/>You should now deploy a Pod network to the cluster.<br/>Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:<br/>  /docs/concepts/cluster-administration/addons/<br/><br/>You can now join any number of machines by running the following on each node<br/>as root:<br/><br/>  kubeadm join &lt;control-plane-host&gt;:&lt;control-plane-port&gt; --token &lt;token&gt; --discovery-token-ca-cert-hash sha256:&lt;hash&gt;</span></pre><p id="cfd3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">您必须存储该输出的最后一行，以便向集群添加工作节点。</p><pre class="lt lu lv lw gt mz my na nb aw nc bi"><span id="8184" class="nd kq in my b gy ne nf l ng nh">kubeadm join &lt;control-plane-host&gt;:&lt;control-plane-port&gt; --token &lt;token&gt; --discovery-token-ca-cert-hash sha256:&lt;hash&gt;</span></pre><p id="9142" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> 7) </strong>创建 Pod 网络:</p><p id="29b8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">Kubernetes 需要附加组件来确保 pod 之间的连接。这个附件被命名为 CNI 工具。我们打算用法兰绒做 CNI 工具。您可以使用以下命令将该工具添加到您的集群中:</p><pre class="lt lu lv lw gt mz my na nb aw nc bi"><span id="1634" class="nd kq in my b gy ne nf l ng nh">$ kubectl apply -f https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml</span></pre><p id="9e34" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> 8) </strong>向集群添加工作节点:</p><p id="158e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果您想将 worker 节点添加到您的集群中，您可以使用 worker nodes 命令，该命令建议存储在步骤 6 中。</p><pre class="lt lu lv lw gt mz my na nb aw nc bi"><span id="9a2c" class="nd kq in my b gy ne nf l ng nh">kubeadm join &lt;control-plane-host&gt;:&lt;control-plane-port&gt; --token &lt;token&gt; --discovery-token-ca-cert-hash sha256:&lt;hash&gt;</span></pre><p id="3b3d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">以下是该命令的输出示例:</p><pre class="lt lu lv lw gt mz my na nb aw nc bi"><span id="541e" class="nd kq in my b gy ne nf l ng nh">root@kubernetes-worker:/home/debian# kubeadm join 192.168.12.9:6443 --token ######## \<br/>        --discovery-token-ca-cert-hash sha256:##########<br/>[preflight] Running pre-flight checks<br/>[preflight] Reading configuration from the cluster...<br/>[preflight] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -o yaml'<br/>[kubelet-start] Writing kubelet configuration to file "/var/lib/kubelet/config.yaml"<br/>[kubelet-start] Writing kubelet environment file with flags to file "/var/lib/kubelet/kubeadm-flags.env"<br/>[kubelet-start] Starting the kubelet<br/>[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap...</span><span id="9c77" class="nd kq in my b gy ni nf l ng nh">This node has joined the cluster:<br/>* Certificate signing request was sent to apiserver and a response was received.<br/>* The Kubelet was informed of the new secure connection details.</span><span id="e52c" class="nd kq in my b gy ni nf l ng nh">Run 'kubectl get nodes' on the control-plane to see this node join the cluster.</span></pre><p id="6478" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">下面是“kubectl get nodes”的示例输出:</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/5408b761714df48cb8e4be7a65dc7afc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1362/format:webp/1*CEqLkXBIaZgFzWCL7SNlLA.png"/></div><figcaption class="me mf gj gh gi mg mh bd b be z dk translated">get 节点的示例输出</figcaption></figure><p id="59e5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">您可以使用以下命令查看 kube-system 窗格:</p><pre class="lt lu lv lw gt mz my na nb aw nc bi"><span id="2a17" class="nd kq in my b gy ne nf l ng nh">$ kubectl get pods --all-namespaces</span></pre><p id="7b97" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">以下是示例输出:</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi nn"><img src="../Images/8a86e485c8c9bed9d172131b8854b893.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Khg7Z94xPEGAyQkgAf1xCA.png"/></div></div><figcaption class="me mf gj gh gi mg mh bd b be z dk translated">Kubernetes 豆荚</figcaption></figure><p id="9785" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> 9) </strong>为普通用户复制 Kubernetes 配置:</p><pre class="lt lu lv lw gt mz my na nb aw nc bi"><span id="cc01" class="nd kq in my b gy ne nf l ng nh">$  mkdir -p $HOME/.kube<br/>$  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config<br/>$  sudo chown $(id -u):$(id -g) $HOME/.kube/config</span></pre><p id="fd28" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果您想从不同的位置访问和修改您的 Kubernetes 集群，您可以使用在您的控制面板计算机上创建的配置文件。</p><h1 id="127f" class="kp kq in bd kr ks no ku kv kw np ky kz la nq lc ld le nr lg lh li ns lk ll lm bi translated"><strong class="ak">恭喜</strong></h1><p id="af4f" class="pw-post-body-paragraph jk jl in jm b jn ln jp jq jr lo jt ju jv lp jx jy jz lq kb kc kd lr kf kg kh ig bi translated">您在由 Openstack 托管的虚拟机上安装了 Kubernetes。您现在可以尽情享受您的集群了:)</p></div></div>    
</body>
</html>