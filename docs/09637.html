<html>
<head>
<title>Python — Moto, Why You Should Use</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Python — Moto，为什么您应该使用</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/python-moto-why-you-should-use-8a8152209aec?source=collection_archive---------7-----------------------#2022-09-02">https://blog.devgenius.io/python-moto-why-you-should-use-8a8152209aec?source=collection_archive---------7-----------------------#2022-09-02</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><div class=""/><div class=""><h2 id="c00e" class="pw-subtitle-paragraph jo iq ir bd b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dk translated">如何使用 Moto 测试你的 boto3 代码</h2></div><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div class="gi gj kg"><img src="../Images/94f7f972a41b63c1d4b8207aae05e304.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PMlnKYPKH3sq0zAiTi-kOg.png"/></div></figure><p id="470b" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">当您使用 AWS SDK for Python ( <code class="fe lk ll lm ln b">boto3</code>)来创建、配置和管理 AWS 服务时，比如 AWS EC2、S3 桶、RDS 实例甚至 lambda 函数，您将面临的一个挑战就是测试。</p><p id="0adf" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">如果没有测试，您将不会对更改代码然后部署它感到舒服，因此最好设置测试来更好地理解代码行为，并以受控的方式更改代码。</p><h1 id="7651" class="lo lp ir bd lq lr ls lt lu lv lw lx ly jx lz jy ma ka mb kb mc kd md ke me mf bi translated">为什么 IAC 测试具有挑战性</h1><p id="9e59" class="pw-post-body-paragraph ko kp ir kq b kr mg js kt ku mh jv kw kx mi kz la lb mj ld le lf mk lh li lj ik bi translated">但是测试对于 IAC(基础设施即代码)开发来说并不容易。在 IAC 开发过程中，要么测试函数本身使用外部资源，要么它测试的代码部分使用外部资源，但不保证在执行时可用。</p><p id="6a52" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">即使你有一个测试环境，比方说一个团队测试 AWS 帐户，然后在测试设置中管理这些外部资源，等待资源变得可用的时间，以及为了节省成本而在测试后删除测试资源将是一个令人头痛的问题，并且使测试帐户的目的变得不现实和麻烦。</p><p id="1907" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">因此，当运行您的<code class="fe lk ll lm ln b">boto3</code>单元测试时，您希望确保它们不依赖于可用的 AWS 资源。实现这一点的常见做法是嘲讽。</p><h1 id="e8ef" class="lo lp ir bd lq lr ls lt lu lv lw lx ly jx lz jy ma ka mb kb mc kd md ke me mf bi translated">什么是 Moto</h1><p id="524b" class="pw-post-body-paragraph ko kp ir kq b kr mg js kt ku mh jv kw kx mi kz la lb mj ld le lf mk lh li lj ik bi translated">Moto(<a class="ae ml" href="https://github.com/spulec/moto" rel="noopener ugc nofollow" target="_blank">https://github.com/spulec/moto</a>)是一个开源的 Python 库，它为 Python 的内置单元测试模拟库提供了一种简单的抽象 AWS 资源的方法。</p><p id="3d88" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated"><strong class="kq is"> Moto </strong>支持丰富的 AWS 资源和功能，所以大多数场景下你都不需要重新发明轮子来创建自己的模拟对象。</p><p id="d449" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">在 Moto 中不需要依赖注入，你可以把代码放在适当的位置，然后直接测试它。你只需要启用<strong class="kq is"> Moto </strong>的嘲讽功能，并采取一些防范措施，就可以了。</p><h1 id="30a9" class="lo lp ir bd lq lr ls lt lu lv lw lx ly jx lz jy ma ka mb kb mc kd md ke me mf bi translated">Moto 是怎么工作的？</h1><p id="8338" class="pw-post-body-paragraph ko kp ir kq b kr mg js kt ku mh jv kw kx mi kz la lb mj ld le lf mk lh li lj ik bi translated">在进入细节之前，我们先了解一下<strong class="kq is"> Moto </strong>是如何工作的。<strong class="kq is"> Moto </strong>的主钩子是 botocore 中的“handlers”(名为<strong class="kq is">BUILTIN _ HANDLERS</strong>),<strong class="kq is">BUILTIN _ HANDLERS</strong>是<code class="fe lk ll lm ln b">boto3</code>的基础。这些处理程序在这个文件中定义:<a class="ae ml" href="https://github.com/boto/botocore/blob/master/botocore/handlers.py" rel="noopener ugc nofollow" target="_blank">https://github . com/boto/boto core/blob/master/boto core/handlers . py</a></p><p id="9427" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">代码片段如下所示:</p><pre class="kh ki kj kk gu mm ln mn mo aw mp bi"><span id="19e6" class="mq lp ir ln b gz mr ms l mt mu">BUILTIN_HANDLERS = [<br/>    ('choose-service-name', handle_service_name_alias),<br/>    (<br/>        'getattr.mturk.list_hi_ts_for_qualification_type',<br/>        ClientMethodAlias('list_hits_for_qualification_type'),<br/>    ),<br/>    (<br/>        'before-parameter-build.s3.UploadPart',<br/>        convert_body_to_file_like_object,<br/>        REGISTER_LAST,<br/>    ),<br/>    (<br/>        'before-parameter-build.s3.PutObject',<br/>        convert_body_to_file_like_object,<br/>        REGISTER_LAST,<br/>    ),<br/>    ('creating-client-class', add_generate_presigned_url),<br/>    ('creating-client-class.s3', add_generate_presigned_post),<br/>    ('creating-client-class.iot-data', check_openssl_supports_tls_version_1_2),<br/>...<br/>    #############<br/>    # RDS<br/>    #############<br/>    ('creating-client-class.rds', add_generate_db_auth_token),<br/>    ('before-call.rds.CopyDBClusterSnapshot', inject_presigned_url_rds),<br/>    ('before-call.rds.CreateDBCluster', inject_presigned_url_rds),<br/>...<br/>]<br/>_add_parameter_aliases(BUILTIN_HANDLERS)</span></pre><p id="2c1c" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">每次实例化一个 AWS 会话时，这个<code class="fe lk ll lm ln b">handlers.py</code>中定义的所有处理程序都会被注册。例如:</p><pre class="kh ki kj kk gu mm ln mn mo aw mp bi"><span id="72f9" class="mq lp ir ln b gz mr ms l mt mu">import boto3</span><span id="c52e" class="mq lp ir ln b gz mv ms l mt mu"># Using the default session<br/>sqs = boto3.client('sqs')<br/>s3 = boto3.resource('s3')</span></pre><p id="5109" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">以上代码创建了一个低级客户端或高级资源客户端。一旦发出内部事件，就会调用为该类事件注册的处理程序。</p><p id="57fe" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">在实际的<code class="fe lk ll lm ln b">http-request</code>被发送到 AWS 之前，<code class="fe lk ll lm ln b">before-send-handler</code>被执行。</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gi gj mw"><img src="../Images/78ad919e1e56c7fbc129f8ed4981f430.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*udosT9yjf3AzGxD0fRhCcQ.png"/></div></div></figure><p id="eada" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">如果一个<code class="fe lk ll lm ln b">before-send-handler</code>返回一个响应，它被用于进一步的处理，而<code class="fe lk ll lm ln b">http-request</code>本身被跳过。这正是<strong class="kq is"> Moto </strong>所做的，通过在自定义<code class="fe lk ll lm ln b">before-send-handler</code>中返回模拟响应，<strong class="kq is"> Moto </strong>允许你跳过对 AWS 服务的实际 http 请求。</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gi gj nb"><img src="../Images/21b543988a86936426322737777f8190.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ufSCfSEF45h3ZbPe1ET2fw.png"/></div></div></figure><p id="915b" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">比如下面的代码片段</p><pre class="kh ki kj kk gu mm ln mn mo aw mp bi"><span id="7382" class="mq lp ir ln b gz mr ms l mt mu">from botocore.awsrequest import AWSResponse<br/>from botocore.handlers import BUILTIN_HANDLERS<br/>from moto.core.models import MockRawResponse<br/> <br/>def test_custom_handler(request, event_name, **kwargs):<br/>    # event_name is sth like 'before-send.s3.GetObject'<br/>    return AWSResponse('', 200, {}, MockRawResponse(''))<br/> <br/>BUILTIN_HANDLERS.append(("before-send", test_custom_handler))</span></pre><p id="f2ad" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">在上面的代码片段中，<strong class="kq is"> Moto </strong>向<code class="fe lk ll lm ln b">botocore</code>的<strong class="kq is"> BUILTIN_HANDLERS </strong>追加了一个“发送前”处理程序。当您将<strong class="kq is"> Moto </strong>导入到您的测试代码中时，这是隐式发生的，并且可以通过使用<code class="fe lk ll lm ln b">moto-decorators</code>(或 Moto 的任何其他初始化)来实现嘲讽，这对于大多数 AWS 资源都是可用的。</p><p id="b151" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated"><code class="fe lk ll lm ln b">moto-decorator</code>为测试函数注册了一个模拟后端，并且只针对测试函数的范围。测试通过后，moto 会重置模拟后端和测试证书。</p><p id="2817" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">好了，概念够了，演示时间到了。</p><h1 id="9979" class="lo lp ir bd lq lr ls lt lu lv lw lx ly jx lz jy ma ka mb kb mc kd md ke me mf bi translated">Moto 演示</h1><h2 id="cdcf" class="mq lp ir bd lq nc nd dn lu ne nf dp ly kx ng nh ma lb ni nj mc lf nk nl me nm bi translated">安装 Moto</h2><p id="be12" class="pw-post-body-paragraph ko kp ir kq b kr mg js kt ku mh jv kw kx mi kz la lb mj ld le lf mk lh li lj ik bi translated">你可以通过使用<code class="fe lk ll lm ln b">pip</code>来安装<strong class="kq is"> Moto </strong>，就像任何其他 Python 包一样。</p><pre class="kh ki kj kk gu mm ln mn mo aw mp bi"><span id="f493" class="mq lp ir ln b gz mr ms l mt mu">pip install moto</span></pre><h2 id="8135" class="mq lp ir bd lq nc nd dn lu ne nf dp ly kx ng nh ma lb ni nj mc lf nk nl me nm bi translated"><strong class="ak">创建 S3 斗</strong></h2><p id="917b" class="pw-post-body-paragraph ko kp ir kq b kr mg js kt ku mh jv kw kx mi kz la lb mj ld le lf mk lh li lj ik bi translated">假设您想使用<code class="fe lk ll lm ln b">boto3</code>在 Python 项目中创建一个 AWS S3 桶，一种方法是:</p><pre class="kh ki kj kk gu mm ln mn mo aw mp bi"><span id="ac9e" class="mq lp ir ln b gz mr ms l mt mu">import boto3</span><span id="2b4e" class="mq lp ir ln b gz mv ms l mt mu">class Project:<br/>    """this class represents a project state"""</span><span id="7298" class="mq lp ir ln b gz mv ms l mt mu">    def __init__(<br/>        self,<br/>        project_name: str,<br/>        region_name: str,<br/>        aws_access_key: str,<br/>        aws_secret_key: str,<br/>    ) -&gt; None:<br/>        """initialize project and set resources<br/>        Args:<br/>            project_name (str): projects name for reference<br/>            region_name (str): AWS region name<br/>            s3_access_key (str): aws authentication access key<br/>            s3_secret_key (str): aws authentication secret key<br/>        """<br/>        self._project_name = project_name<br/>        self._bucket_name = f"{project_name}_bucket"<br/>        self._current_state = str(uuid.uuid4())<br/>        <br/>        # s3<br/>        boto3.resource("s3", region_name=region_name).create_bucket(<br/>            Bucket=self._bucket_name<br/>        )</span><span id="a2f2" class="mq lp ir ln b gz mv ms l mt mu">        self._s3_client = boto3.client(<br/>            "s3",<br/>            aws_access_key_id=aws_access_key,<br/>            aws_secret_access_key=aws_secret_key,<br/>            region_name=region_name,<br/>        )</span><span id="76fa" class="mq lp ir ln b gz mv ms l mt mu">    def save(self, body: str) -&gt; None:<br/>        """saves the state with message to s3 bucket"""<br/>        self._current_state = str(uuid.uuid4())<br/>        self._s3_client.put_object(<br/>            Bucket=self._bucket_name, Key=self._current_state, Body=body<br/>        )</span><span id="d8c6" class="mq lp ir ln b gz mv ms l mt mu">    def restore(self) -&gt; str:<br/>        """restores state from s3"""<br/>        value = (<br/>            self._s3_client.get_object(<br/>                Bucket=self._bucket_name, Key=self._current_state<br/>            )["Body"]<br/>            .read()<br/>            .decode("utf-8")<br/>        )</span></pre><h2 id="5fe8" class="mq lp ir bd lq nc nd dn lu ne nf dp ly kx ng nh ma lb ni nj mc lf nk nl me nm bi translated">使用 Moto 进行测试</h2><p id="9941" class="pw-post-body-paragraph ko kp ir kq b kr mg js kt ku mh jv kw kx mi kz la lb mj ld le lf mk lh li lj ik bi translated">现在让我们用<strong class="kq is"> Moto </strong>来测试我们的代码。</p><pre class="kh ki kj kk gu mm ln mn mo aw mp bi"><span id="a23b" class="mq lp ir ln b gz mr ms l mt mu">import unittest<br/>from unittest import TestCase</span><span id="fb1d" class="mq lp ir ln b gz mv ms l mt mu">import boto3<br/>from moto import mock_s3<br/>from project import Project</span><span id="6f1a" class="mq lp ir ln b gz mv ms l mt mu"><a class="ae ml" href="http://twitter.com/mock_s3" rel="noopener ugc nofollow" target="_blank">@mock_s3</a><br/>class TestMyProject(TestCase):<br/>    """container for test cases"""</span><span id="70e3" class="mq lp ir ln b gz mv ms l mt mu">    def test_project_creation(self):<br/>        """test project creation"""<br/>        region_name = "us-east-1"<br/>        project_name = "MyProject"<br/>        project = Project(<br/>            project_name=project_name,<br/>            region_name=region_name,<br/>            aws_access_key="someaccesskey",<br/>            aws_secret_key="somesecretkey",<br/>        )</span><span id="7c90" class="mq lp ir ln b gz mv ms l mt mu">        message = "Saved 1"<br/>        project.save(message)<br/>        body = project.restore()<br/>        self.assertEqual(body, message)</span><span id="78b8" class="mq lp ir ln b gz mv ms l mt mu">if __name__ == "__main__":<br/>    unittest.main()</span></pre><p id="ef96" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">首先，我们从 Moto 导入<code class="fe lk ll lm ln b">mock_s3</code>。这是一个 Python 装饰器，它可以装饰函数或类，在装饰的代码块中创建一个 AWS 资源处理调用的模拟。</p><p id="c8bc" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">在上面的代码中，我们用<code class="fe lk ll lm ln b">@mock_s3</code>来修饰我们的类<code class="fe lk ll lm ln b">TestMyProject</code>，所以在所有后续的代码块中，AWS 资源都会被嘲讽。</p><p id="755b" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">现在让我们进行测试:</p><pre class="kh ki kj kk gu mm ln mn mo aw mp bi"><span id="acce" class="mq lp ir ln b gz mr ms l mt mu">$ pytest test_project_moto.py -s</span></pre><p id="5489" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">输出看起来像这样:</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gi gj nn"><img src="../Images/697499b060a44994736c5fc7ce6dc719.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ouAd0dpGskPieljMVp8maw.png"/></div></div></figure><p id="de48" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">根本不需要 AWS 帐户和凭证，在测试期间，不再需要创建资源，因此您的代码没有外部依赖性，另外，您不需要实际创建资源，因此也节省了成本。</p><h1 id="93a4" class="lo lp ir bd lq lr ls lt lu lv lw lx ly jx lz jy ma ka mb kb mc kd md ke me mf bi translated">结论</h1><p id="2978" class="pw-post-body-paragraph ko kp ir kq b kr mg js kt ku mh jv kw kx mi kz la lb mj ld le lf mk lh li lj ik bi translated">在本文中，我介绍了如何使用 Moto——一个开源 Python 库，它为 Python 的内置单元测试模拟库提供了一种简单的抽象 AWS 资源的方法。</p><p id="7e87" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">首先我介绍了为什么你需要测试你的 IAC 代码，然后是 Moto 是什么，它是如何工作的。我还提供了一个简单的 AWS S3 测试示例来演示如何在实际代码中使用 Moto。我希望你喜欢这次阅读。</p></div></div>    
</body>
</html>