<html>
<head>
<title>Let’s Deploy Azure Stack (Hub) Development Kit</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">让我们部署Azure Stack (Hub)开发工具包</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/lets-deploy-azure-stack-hub-development-kit-3973f2f753e0?source=collection_archive---------2-----------------------#2021-01-21">https://blog.devgenius.io/lets-deploy-azure-stack-hub-development-kit-3973f2f753e0?source=collection_archive---------2-----------------------#2021-01-21</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="b44e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">Azure Stack Hub Development Kit(ASDK)是微软的Azure Stack Hub(以前只是“Azure Stack”)的“免费试用版”，你可以在自己的硬件上托管它。从高层次来说，它将Azure带到了您的内部环境中。</p><p id="fb31" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">ASDK是100%免费的，但根据微软的说法，不适合生产-但也许它对家庭实验室的使用足够好了。</p><h1 id="bb27" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">警告</h1><ul class=""><li id="33d3" class="lg lh in jm b jn li jr lj jv lk jz ll kd lm kh ln lo lp lq bi translated">ASDK部署无法更新-您必须从头开始重新部署！</li><li id="421c" class="lg lh in jm b jn lr jr ls jv lt jz lu kd lv kh ln lo lp lq bi translated">没有数据冗余(通过RAID、集群或其他方式)。</li><li id="a6b2" class="lg lh in jm b jn lr jr ls jv lt jz lu kd lv kh ln lo lp lq bi translated">ASDK需要Azure订阅(但不需要任何费用！)</li><li id="1efc" class="lg lh in jm b jn lr jr ls jv lt jz lu kd lv kh ln lo lp lq bi translated">并不是所有在Azure上能买到的东西在ASDK都能买到。Azure Stack缺少的值得注意的东西:Azure Service Bus、Azure SQL for Postgres和Azure Functions Runtime v2或v3(在撰写本文时仅支持v1，并且仅限于。NET Framework 4.x函数)。</li></ul><h1 id="092c" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">要求</h1><h2 id="232f" class="lx kj in bd kk ly lz dn ko ma mb dp ks jv mc md kw jz me mf la kd mg mh le mi bi translated">随机存取存储</h2><p id="3cb2" class="pw-post-body-paragraph jk jl in jm b jn li jp jq jr lj jt ju jv mj jx jy jz mk kb kc kd ml kf kg kh ig bi translated">微软会告诉你ASDK需要大量的内存(192GB)，但今天我只用128GB就够了。96GB是自动ASDK部署脚本中设置的最小容量。少于这个值，它们将在验证步骤抛出一个错误(脚本从一个配置文件中读取，其中96是硬编码的最小值，您可以更改这个值来安装小于96GB的ASDK)。一旦安装完毕，Windows Server上的ASDK会消耗84 GB的内存<strong class="jm io"/>、<strong class="jm io"> </strong>，所以你真的需要96GB或更多的内存来使用Azure Stack做任何事情。</p><h2 id="7790" class="lx kj in bd kk ly lz dn ko ma mb dp ks jv mc md kw jz me mf la kd mg mh le mi bi translated">CPU和磁盘</h2><p id="cb16" class="pw-post-body-paragraph jk jl in jm b jn li jp jq jr lj jt ju jv mj jx jy jz mk kb kc kd ml kf kg kh ig bi translated">如果你愿意限制你创建的Azure资源，CPU核心数是灵活的。安装ASDK后，CPU使用率接近空闲。然而，磁盘要求是不可协商的。还要注意，没有数据冗余。</p><p id="1013" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">按照微软的说法，硬盘应该是独立的磁盘，不涉及硬件或软件RAID。正确的做法是将服务器的RAID卡刷新为“IT模式”或“HBA模式”(实际上<a class="ae lw" href="https://www.reddit.com/r/DataHoarder/comments/6o3f6a/dell_hba_mode_vs_it_mode_what_is_the_difference/" rel="noopener ugc nofollow" target="_blank">与这里的</a>相同)。或者，如果主板上有足够的SATA端口，直接单独连接硬盘即可。如果这两个选项都没有，您可以将每个硬盘设置为自己的RAID 0阵列，这样它们就呈现为五个独立的磁盘。我已经这样做了，没有明显的缺点，但是有一些未知的IO性能损失。</p><p id="cd2b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果您使用配有Dell PERC 310或710 RAID卡的戴尔服务器，此处的<a class="ae lw" href="https://fohdeesha.com/docs/perc/" rel="noopener ugc nofollow" target="_blank">是一个关于闪存到IT模式的极好指南。</a></p><h2 id="b9e0" class="lx kj in bd kk ly lz dn ko ma mb dp ks jv mc md kw jz me mf la kd mg mh le mi bi translated">网卡(以太网适配器)</h2><p id="482b" class="pw-post-body-paragraph jk jl in jm b jn li jp jq jr lj jt ju jv mj jx jy jz mk kb kc kd ml kf kg kh ig bi translated">我一直在使用内置在我的Dell PowerEdge R720服务器中的Broadcom (QLogic now) NIC，但截至上个月，这似乎导致了ASDK部署的错误(“调用步骤60失败…未找到包…”)。将Broadcom网卡更换为Intel网卡后，部署成功，没有出现任何错误。</p><p id="750f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">请注意，如果ASDK检测到服务器上有多个网卡，它将拒绝部署。如果您的服务器有一个内置的、不可移动的网卡，并抛出“步骤60”错误，您可能需要获得一个英特尔PCIe网卡，并尝试在设备管理器中禁用内置网卡(如果可以，最简单的方法是物理移除网卡)。</p><h1 id="8efc" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">飞行前清单</h1><ul class=""><li id="f321" class="lg lh in jm b jn li jr lj jv lk jz ll kd lm kh ln lo lp lq bi translated">一台符合ASDK硬件要求的服务器，包括至少4个驱动器用于数据存储，1个驱动器用于运行ASDK的Windows Server</li><li id="9c62" class="lg lh in jm b jn lr jr ls jv lt jz lu kd lv kh ln lo lp lq bi translated">RAID卡被刷新到IT模式(可选)</li><li id="8dda" class="lg lh in jm b jn lr jr ls jv lt jz lu kd lv kh ln lo lp lq bi translated">带有Windows Server 2016或2019安装程序的USB驱动器</li><li id="6875" class="lg lh in jm b jn lr jr ls jv lt jz lu kd lv kh ln lo lp lq bi translated">来自<a class="ae lw" href="https://azure.microsoft.com/en-us/overview/azure-stack/development-kit/?v=try" rel="noopener ugc nofollow" target="_blank">微软</a>的AzureStackDownloader.exe</li><li id="73df" class="lg lh in jm b jn lr jr ls jv lt jz lu kd lv kh ln lo lp lq bi translated">来自<a class="ae lw" href="https://github.com/Azure/AzureStack-Tools" rel="noopener ugc nofollow" target="_blank"> GitHub </a>的Azure Stack工具</li><li id="f748" class="lg lh in jm b jn lr jr ls jv lt jz lu kd lv kh ln lo lp lq bi translated">英特尔网卡(可选，但推荐)</li></ul><h1 id="fce6" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">部署</h1><p id="130e" class="pw-post-body-paragraph jk jl in jm b jn li jp jq jr lj jt ju jv mj jx jy jz mk kb kc kd ml kf kg kh ig bi translated"><em class="mm">基于</em><a class="ae lw" href="https://docs.microsoft.com/en-us/azure-stack/asdk/asdk-prepare-host?view=azs-2008" rel="noopener ugc nofollow" target="_blank"><em class="mm">https://docs . Microsoft . com/en-us/azure-stack/asdk/asdk-prepare-host？view = AZS-2008</em>T9】</a></p><p id="27d1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在我的20核Ivy Bridge Xeon服务器上部署大约需要8个小时(大约2013年)。</p><p id="81c8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在部署和配置NIC的过程中，您可能会偶尔失去RDP连接，持续几秒钟。</p><ol class=""><li id="aa4f" class="lg lh in jm b jn jo jr js jv mn jz mo kd mp kh mq lo lp lq bi translated">在操作系统磁盘上安装Windows Server 2016或2019。</li><li id="f1af" class="lg lh in jm b jn lr jr ls jv lt jz lu kd lv kh mq lo lp lq bi translated">在Windows Server安装上启用RDP连接。</li><li id="3338" class="lg lh in jm b jn lr jr ls jv lt jz lu kd lv kh mq lo lp lq bi translated">将AzureStackDownloader.exe复制到服务器，并开始下载Azure Stack磁盘映像。下载速度上限为250Mbps，如果互联网连接速度至少达到这个速度，大约需要15分钟。</li><li id="1fc0" class="lg lh in jm b jn lr jr ls jv lt jz lu kd lv kh mq lo lp lq bi translated">在ASDK下载的同时，从GitHub下载Azure Stack工具，并复制到Windows Server实例。</li><li id="92f3" class="lg lh in jm b jn lr jr ls jv lt jz lu kd lv kh mq lo lp lq bi translated">下载ASDK磁盘映像后，按照出现的向导提取磁盘映像。这是单线程的，所以CPU越新，速度就越快。在常春藤桥上花了大约45分钟。</li><li id="2dcd" class="lg lh in jm b jn lr jr ls jv lt jz lu kd lv kh mq lo lp lq bi translated">从提升的PowerShell窗口执行“\ azure stack-Tools-master \ Deployment \ asdk-installer . PS1”。</li><li id="128b" class="lg lh in jm b jn lr jr ls jv lt jz lu kd lv kh mq lo lp lq bi translated">选择“准备环境”并按照向导进行操作！</li></ol><h2 id="bce8" class="lx kj in bd kk ly lz dn ko ma mb dp ks jv mc md kw jz me mf la kd mg mh le mi bi translated">第2部分:从CloudBuilder映像启动</h2><p id="ecda" class="pw-post-body-paragraph jk jl in jm b jn li jp jq jr lj jt ju jv mj jx jy jz mk kb kc kd ml kf kg kh ig bi translated"><em class="mm">基于</em><a class="ae lw" href="https://docs.microsoft.com/en-us/azure-stack/asdk/asdk-install?view=azs-2008" rel="noopener ugc nofollow" target="_blank">T13】https://docs . Microsoft . com/en-us/azure-stack/asdk/asdk-install？view = AZS-2008T15】</a></p><p id="3dcc" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在，当启动时，你应该看到两个Windows服务器的选项。我们想要名为“Azure Stack”的。</p><p id="8953" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我也喜欢在这个服务器上启用RDP，这样我就可以在没有服务器的情况下继续工作。看起来现在远程访问是默认启用的——多方便啊！</p><ol class=""><li id="0466" class="lg lh in jm b jn jo jr js jv mn jz mo kd mp kh mq lo lp lq bi translated">将Azure Stack工具复制到这个新的“Azure Stack”Windows服务器实例，或者导航到其他Windows服务器实例上的Azure Stack工具，您应该可以通过Azure Stack Windows服务器实例访问这些工具。</li><li id="ea5c" class="lg lh in jm b jn lr jr ls jv lt jz lu kd lv kh mq lo lp lq bi translated">从提升的PowerShell窗口运行asdk-installer.ps1。</li><li id="7e6d" class="lg lh in jm b jn lr jr ls jv lt jz lu kd lv kh mq lo lp lq bi translated">点击“安装”</li><li id="3af4" class="lg lh in jm b jn lr jr ls jv lt jz lu kd lv kh mq lo lp lq bi translated">好吧！我们需要一个AAD (Azure Active Directory)来指向这个ASDK安装。这很容易(而且100%免费)在Azure中创建。只需浏览到“Azure Active Directory”并创建一个具有“全局管理员”角色的新用户(或使用您现有的Azure用户/凭据)。对于ASDK安装程序窗口中的密码字段，您可以输入任何内容——这只是本地管理员密码。这并不是让你登录AAD账户(这是后面的内容！).</li><li id="525f" class="lg lh in jm b jn lr jr ls jv lt jz lu kd lv kh mq lo lp lq bi translated">对于时间服务器，你可以放在13.86.101.172(time.windows.com)</li><li id="1cdd" class="lg lh in jm b jn lr jr ls jv lt jz lu kd lv kh mq lo lp lq bi translated">部署开始！几分钟后，系统会提示您输入您提供的AAD的全局管理员用户的凭据。</li></ol><p id="3118" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">潜在错误:需要强认证</strong></p><p id="5d43" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">通常这意味着你试图用一个设置了MFA(双因素身份验证)的用户登录Azure。如果您(或您的组织)经历了设置它的麻烦，我不知道我是否会建议禁用它。理论上，你可以在Azure AD中创建一个新的“用户”,目的是将ASDK服务器链接到Azure。只要确保用户拥有<strong class="jm io">全局管理员</strong>角色即可！</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi mr"><img src="../Images/3781079eb07d7cc956bb31ee123dd817.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2RPG5D1aS9qEOC1mn2JH-w.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">Azure门户中的Azure Active Directory，显示了我的具有全局管理员角色的新用户(“Achilles Server”)。用于登录ASDK服务器上Azure的帐户必须具有全局管理员角色！</figcaption></figure><p id="01b4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">然而，这并没有解决错误。我得到了这个错误，即使我正在使用一个全新的Azure广告用户关闭了MFA。我假设Azure账户的最高层设置了一些东西，可能会强制MFA或者不允许来自“不安全应用”的登录，比如ASDK。最终，我不得不使用我的个人Azure账户中的一个用户(我正在使用我的雇主提供的Visual Studio订阅，以利用每月Azure点数)。</p><h2 id="4173" class="lx kj in bd kk ly lz dn ko ma mb dp ks jv mc md kw jz me mf la kd mg mh le mi bi translated">现在我们等待</h2><p id="fcfb" class="pw-post-body-paragraph jk jl in jm b jn li jp jq jr lj jt ju jv mj jx jy jz mk kb kc kd ml kf kg kh ig bi translated">现在我们等待Azure Stack的部署。这是几个小时观察PowerShell脚本的进展。对我来说，部署需要足够长的时间，以至于我把它留到晚上，到早上就完成了(假设没有错误)。</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi nh"><img src="../Images/d2370c1cebeb8e6dfb25443b5a3dfb5f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p-2RtMOvjPDmHCQHHHBC8g.png"/></div></div></figure><p id="f8d0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">最终，服务器将重启并自动恢复用户azurestack\AzureStackAdmin下的部署。如果您改为以管理员身份登录，您将无法监视部署进度，因为部署的PowerShell窗口正在AzureStackAdmin下运行。</p><p id="bcb6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果遇到错误，通过<strong class="jm io">CD C:\ cloud deployment \ Setup</strong>和<strong class="jm io">从中断的地方恢复部署。\ installazurestackpoc . PS1-重新运行</strong></p><h2 id="dfc8" class="lx kj in bd kk ly lz dn ko ma mb dp ks jv mc md kw jz me mf la kd mg mh le mi bi translated"><strong class="ak">以下是部署错误的一些常见原因以及如何解决它们</strong></h2><p id="0da6" class="pw-post-body-paragraph jk jl in jm b jn li jp jq jr lj jt ju jv mj jx jy jz mk kb kc kd ml kf kg kh ig bi translated"><strong class="jm io">关于在服务器上找不到4个以上的数据磁盘:</strong>确保这些驱动器出现在Windows Server实例的“计算机管理”中。它们不需要被格式化成NTFS格式并显示在这台电脑上，但是它们必须可以被Windows格式化。例如，作为硬件RAID配置成员的磁盘不可由Windows格式化。如果您将这些磁盘与RAID卡的普通RAID固件一起使用，请确保将这些驱动器配置为独立的RAID 0阵列，每个阵列一个磁盘。如果您将这些磁盘与IT模式或HBA模式RAID卡一起使用，请确保您已将驱动器格式化为任何格式(FAT、NTFS、EXT4等)。)以便它们不会被格式化为RAID成员。我使用带有Gparted的Ubuntu实时桌面映像来格式化驱动器。</p><p id="7a2b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">在安装过程中，我失去了与Windows Server实例的远程桌面(RDP)会话的连接:</strong>这是正常的。在整个安装过程中，您会暂时失去几次连接。</p><p id="c8c9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">调用步骤60失败:</strong>这通常是以下三种情况之一:1)服务器暂时失去与互联网的连接2)服务器上的时间不同步(例如，操作系统的时间完全错误)或3)安装在服务器上的网卡不受支持。我将首先尝试重新运行部署脚本(。\ installazurestackpoc . PS1-重新运行)。</p><p id="d792" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果您有任何其他问题，请在下面评论！我过去在部署Azure Stack时也遇到过其他问题，尽管这些问题通常与服务器配置不正确有关(例如，驱动器没有用RAID格式化)。</p><h1 id="2d11" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">部署完成！</h1><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi ni"><img src="../Images/ebc43cf8ba151aacc2f11332ce6d1051.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bHIuw9rbxRUb6wiNbLKuyg.png"/></div></div></figure><p id="da13" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">几个小时后，您应该会在PowerShell窗口的底部看到<strong class="jm io">完成:操作“部署”</strong></p><p id="d175" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">恭喜你。</p><p id="4ca5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">关于ASDK的一些笔记:</p><ul class=""><li id="f849" class="lg lh in jm b jn jo jr js jv mn jz mo kd mp kh ln lo lp lq bi translated">当服务器重新启动时，ASDK会自动启动，但需要几分钟时间。通常，当内存消耗达到大约84GB时，我可以判断它已经完全启动。</li></ul></div><div class="ab cl nj nk hr nl" role="separator"><span class="nm bw bk nn no np"/><span class="nm bw bk nn no np"/><span class="nm bw bk nn no"/></div><div class="ig ih ii ij ik"><p id="f7ad" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在我们开始配置它(向Azure注册，添加SQL Server、App Service等服务。).我可能不会为第2部分制作指南——它本质上是一个遵循微软官方指南的问题。</p></div></div>    
</body>
</html>