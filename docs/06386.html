<html>
<head>
<title>Create a simple Telegram E-Commerce with NodeJS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用NodeJS创建一个简单的电报电子商务</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/create-a-simple-telegram-e-commerce-with-nodejs-b43f5ac36dc4?source=collection_archive---------4-----------------------#2022-01-04">https://blog.devgenius.io/create-a-simple-telegram-e-commerce-with-nodejs-b43f5ac36dc4?source=collection_archive---------4-----------------------#2022-01-04</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/a1280ba414335a3ab7daf9be45696356.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nk0omnYxo35x-1rKleAmsw.jpeg"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">学分:pexels.com</figcaption></figure><p id="dd62" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">聊天机器人的兴起迅速让我们能够以创新的方式与用户互动。</p><p id="d6e5" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">事实证明，有了Telegram，我们甚至可以在聊天中直接销售商品！</p><p id="3f05" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">是不是<em class="kx">爽</em>？</strong></p><p id="aecf" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">那么，为什么不在Telegram上创建一个小店，让人们能够通过与机器人互动来购买我们的产品呢？</p><p id="e33f" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">注意:目前，电报支付仅在安卓系统上可用。希望iOS的情况会很快改变。</strong></p><p id="bd99" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">我们开始吧！</p><h1 id="e3d3" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">1.创造我们的机器人</h1><p id="7241" class="pw-post-body-paragraph jz ka in kb b kc lw ke kf kg lx ki kj kk ly km kn ko lz kq kr ks ma ku kv kw ig bi translated">打开Telegram找到@BotFather bot，然后发出<code class="fe mb mc md me b">/newbot</code>命令。</p><figure class="mg mh mi mj gt jo gh gi paragraph-image"><div class="gh gi mf"><img src="../Images/df47380fea9cbcb0139b16a0d901891b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1296/format:webp/1*WE1TOAG7FSPymeAeaW7D8w.png"/></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">创建新机器人</figcaption></figure><p id="b6af" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">选择你喜欢的名字和用户名并确认。BotFather会给你一个访问令牌，我们用它来调用电报API。</p><p id="02ad" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">让我们也通过调用@BotFather上的<code class="fe mb mc md me b">/mybots</code>命令来启用支付，选择您刚刚创建的bot并单击<strong class="kb io">支付</strong>。从列表中选择<strong class="kb io">条带</strong>，然后<strong class="kb io">连接条带测试。</strong></p><figure class="mg mh mi mj gt jo gh gi paragraph-image"><div class="gh gi mf"><img src="../Images/1ae421af4e8d985eed973c9e9e16c08a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1296/format:webp/1*g-MORGf0P_GjUpbO5eVUKA.png"/></div></figure><p id="e76d" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">此时，Telegram将在您的浏览器上打开一个页面，允许您连接Stripe。登录(如果您没有Stripe帐户，则注册)并确认操作。</p><p id="b1dc" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">现在我们有了一个连接到Stripe测试环境的电报机器人，我们将使用它来执行我们的测试。BotFather会回复一个支付令牌，留着以后用。</p><h1 id="7b3b" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">2.准备数据库</h1><p id="cb44" class="pw-post-body-paragraph jz ka in kb b kc lw ke kf kg lx ki kj kk ly km kn ko lz kq kr ks ma ku kv kw ig bi translated">我们将使用SQLite来保存我们想要销售的产品列表。所以让我们用一些虚拟产品初始化我们的数据库。创建一个文件夹<code class="fe mb mc md me b">db</code>，在里面打开一个名为<code class="fe mb mc md me b">schema.sql</code>的文件:</p><pre class="mg mh mi mj gt mk me ml mm aw mn bi"><span id="94d1" class="mo kz in me b gy mp mq l mr ms">CREATE TABLE items (<br/>  id INTEGER PRIMARY KEY AUTOINCREMENT,<br/>  name TEXT NOT NULL,<br/>  price INTEGER,<br/>  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP<br/>);</span></pre><p id="6393" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">现在，让我们用一些假冒产品播种它(文件<code class="fe mb mc md me b">db/seed.sql</code>):</p><pre class="mg mh mi mj gt mk me ml mm aw mn bi"><span id="7912" class="mo kz in me b gy mp mq l mr ms">INSERT INTO items (name, price)<br/>VALUES<br/>('Awesome Guitar', '500'),<br/>('Cheap Product', '12'),<br/>('Color TV', '800')</span></pre><p id="9d16" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">最后，应用模式并播种数据库:</p><pre class="mg mh mi mj gt mk me ml mm aw mn bi"><span id="4ab9" class="mo kz in me b gy mp mq l mr ms">cd db<br/>sqlite3 database.sqlite &lt; schema.sql<br/>sqlite3 database.sqlite &lt; seed.sql</span></pre><p id="6c0e" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">搞定了。</p><h1 id="0d04" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">2.机器人</h1><p id="6132" class="pw-post-body-paragraph jz ka in kb b kc lw ke kf kg lx ki kj kk ly km kn ko lz kq kr ks ma ku kv kw ig bi translated">我们现在可以创建我们的机器人。我们将主要使用三个NodeJS包:</p><ul class=""><li id="d4bd" class="mt mu in kb b kc kd kg kh kk mv ko mw ks mx kw my mz na nb bi translated">ExpressJS :创建我们的服务器来托管我们的机器人</li><li id="ce97" class="mt mu in kb b kc nd kg ne kk nf ko ng ks nh kw my mz na nb bi translated">节点-电报-机器人-应用编程接口:管理我们的机器人和响应购买</li><li id="bf24" class="mt mu in kb b kc nd kg ne kk nf ko ng ks nh kw my mz na nb bi translated">从我们的数据库中读取产品</li></ul><p id="ed15" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">因此，让我们首先初始化我们的项目并安装我们的依赖项:</p><pre class="mg mh mi mj gt mk me ml mm aw mn bi"><span id="4aba" class="mo kz in me b gy mp mq l mr ms">yarn init<br/>yarn add expressjs node-telegram-bot-api sqlite3</span></pre><p id="1ae0" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">在项目的根目录下创建一个<code class="fe mb mc md me b">index.js</code>文件，用您喜欢的JS编辑器打开它。</p><p id="c964" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">让我们启动并运行这些库:</p><pre class="mg mh mi mj gt mk me ml mm aw mn bi"><span id="1ff9" class="mo kz in me b gy mp mq l mr ms">const express = require('express')<br/>const sqlite3 = require('sqlite3')<br/>const TelegramBot = require('node-telegram-bot-api')</span><span id="6746" class="mo kz in me b gy ni mq l mr ms">const port = process.env.PORT || 3000</span><span id="4684" class="mo kz in me b gy ni mq l mr ms">// init express<br/>const app = express()</span><span id="cdb6" class="mo kz in me b gy ni mq l mr ms">// init bot<br/>const BOT_TOKEN = 'XXXXXXXXXX:XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX'<br/>const PAYMENT_TOKEN = 'XXXXXXXXX:TEST:XXXXXXXXXXXXXXXX'<br/>const telegramBot = new TelegramBot(BOT_TOKEN, { polling: true })</span><span id="c7fe" class="mo kz in me b gy ni mq l mr ms">// init db<br/>const db = new sqlite3.Database('./db/database.sqlite')</span></pre><p id="819a" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">这里很简单:我们简单地初始化了express、我们的电报机器人(提供令牌)和我们的数据库。</p><p id="6daf" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">让我们设置几个错误回调:</p><pre class="mg mh mi mj gt mk me ml mm aw mn bi"><span id="dd72" class="mo kz in me b gy mp mq l mr ms">// set error callbacks<br/>telegramBot.on('error', msg =&gt; console.log(`[bot] error:`, msg))<br/>telegramBot.on('polling_error', msg =&gt; console.log(`[bot] polling_error:`, msg))<br/>telegramBot.on('webhook_error', msg =&gt; console.log(`[bot] webhook_error:`, msg))</span></pre><p id="760f" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">我们现在指示我们的机器人响应<code class="fe mb mc md me b">/list</code>命令，以我们产品的完整列表作为响应:</p><pre class="mg mh mi mj gt mk me ml mm aw mn bi"><span id="a217" class="mo kz in me b gy mp mq l mr ms">// set command<br/>telegramBot.setMyCommands([{ command: 'list', description: 'Show all products' }])</span><span id="a771" class="mo kz in me b gy ni mq l mr ms">// product list<br/>telegramBot.onText(/\/list/, async (msg, match) =&gt; {<br/>  db.all('SELECT * FROM items', [], (err, items) =&gt; {<br/>    if (err) {<br/>      console.log('[bot] list items error:', err)<br/>      return<br/>    }</span><span id="793b" class="mo kz in me b gy ni mq l mr ms">    try {<br/>      telegramBot.sendMessage(msg.chat.id, 'Select a product', {<br/>        reply_markup: {<br/>          inline_keyboard: [<br/>            ...items.map(p =&gt; [{ text: p.name, callback_data: p.id }])<br/>          ]<br/>        }<br/>      })<br/>    } catch (err) {<br/>      telegramBot.sendMessage(msg.chat.id, 'Ops, there was an error!')<br/>    }<br/>  })<br/>})</span></pre><p id="a1f3" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">让我们来分解一下:</p><ul class=""><li id="a1ce" class="mt mu in kb b kc kd kg kh kk mv ko mw ks mx kw my mz na nb bi translated">我们首先调用<code class="fe mb mc md me b">setMyCommands</code>，以便Telegram可以显示一个漂亮的菜单，让您的客户可以轻松地发出<code class="fe mb mc md me b">/list</code>命令。</li><li id="98a7" class="mt mu in kb b kc nd kg ne kk nf ko ng ks nh kw my mz na nb bi translated">然后，我们指示我们的机器人对<code class="fe mb mc md me b">/list</code>命令做出反应，首先从数据库中检索所有产品，并用购买它们的按钮列表做出响应</li></ul><p id="5fa9" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">您的用户将会得到如下提示:</p><figure class="mg mh mi mj gt jo gh gi paragraph-image"><div class="gh gi mf"><img src="../Images/761b5e0f08186e845ef8244df94a0bb7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1296/format:webp/1*BRcbHxgZcaY0P4jpH_zU7w.png"/></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">产品列表</figcaption></figure><p id="7ba9" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">我们现在必须在用户选择他想要的产品后给用户发送一张发票:</p><pre class="mg mh mi mj gt mk me ml mm aw mn bi"><span id="d0b3" class="mo kz in me b gy mp mq l mr ms">// product selection<br/>telegramBot.on('callback_query', async (query) =&gt; {<br/>  console.log('[bot] query', query)</span><span id="bba2" class="mo kz in me b gy ni mq l mr ms">  // retrieve product<br/>  db.get(`SELECT * FROM items WHERE id = ${query.data}`, [], (err, item) =&gt; {<br/>    if (err) {<br/>      console.log('[bot] find item error:', err)<br/>      return<br/>    }</span><span id="3034" class="mo kz in me b gy ni mq l mr ms">telegramBot.sendInvoice(<br/>      query.message.chat.id,   // Telegram chat ID<br/>      item.name,               // item Name<br/>      'Awesome description',   // item description<br/>      'payload',               // payload (needed for internal processes, such as creating orders on our db)<br/>      PAYMENT_TOKEN,           // the payment token provided by BotFather after connecting Stripe<br/>      'purchase_deep_linking', // parameter for deep linking (not used in this tutorial)<br/>      'USD',                   // currency<br/>      [{ label: item.name, amount: item.price }], // label shown to the customer<br/>      { photo_url: '<a class="ae nc" href="https://placekitten.com/200/300'" rel="noopener ugc nofollow" target="_blank">https://placekitten.com/200/300'</a>, need_shipping_address: true }) // photo and require shipping info<br/>  })<br/>})</span></pre><p id="c7a4" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">如图所示，我们拦截了由用户项目选择触发的<code class="fe mb mc md me b">callback_query</code>函数(由我们的电报机器人调用)。我们只是通过<code class="fe mb mc md me b">sendInvoice</code>传递所有需要的信息来做出反应。</p><p id="a940" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">为了清楚起见，我描述了每一个参数，但是应该很简单。</p><p id="c4ff" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">Telegram APIs允许我们拦截预结帐阶段(万一我们需要在数据库中存储任何信息，或者我们需要检查产品的可用性)。在这种情况下，我们只需调用<code class="fe mb mc md me b">answerPreCheckoutQuery</code>函数来完成支付:</p><pre class="mg mh mi mj gt mk me ml mm aw mn bi"><span id="3eeb" class="mo kz in me b gy mp mq l mr ms">// payment callbacks<br/>telegramBot.on('pre_checkout_query', (query) =&gt; {<br/>  console.log(`[bot] pre checkout`)<br/>  console.log(query)</span><span id="0374" class="mo kz in me b gy ni mq l mr ms">telegramBot.answerPreCheckoutQuery(query.id, true)<br/>})</span></pre><p id="e716" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">我们现在可以通过感谢用户的购买来结束支付过程:</p><pre class="mg mh mi mj gt mk me ml mm aw mn bi"><span id="9c1e" class="mo kz in me b gy mp mq l mr ms">telegramBot.on('successful_payment', (msg) =&gt; {<br/>  console.log(`[bot] successful payment`)<br/>  console.log('Successful Payment', msg)</span><span id="3364" class="mo kz in me b gy ni mq l mr ms">telegramBot.sendMessage(msg.chat.id, 'Thank you for your purchase!')<br/>})</span></pre><p id="be64" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">最后但同样重要的是，让我们启动我们的Express服务器:</p><pre class="mg mh mi mj gt mk me ml mm aw mn bi"><span id="c7f2" class="mo kz in me b gy mp mq l mr ms">app.listen(port, () =&gt; console.log(`Telegram ShopBot listening at <a class="ae nc" href="http://localhost:${port}`" rel="noopener ugc nofollow" target="_blank">http://localhost:${port}`</a>))</span></pre><h1 id="19fe" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">4.测试！</h1><ol class=""><li id="d735" class="mt mu in kb b kc lw kg lx kk nj ko nk ks nl kw nm mz na nb bi translated">打开电报，通过搜索用户名找到你的机器人</li><li id="a44f" class="mt mu in kb b kc nd kg ne kk nf ko ng ks nh kw nm mz na nb bi translated">发出<code class="fe mb mc md me b">/list</code>命令显示产品列表</li><li id="cd48" class="mt mu in kb b kc nd kg ne kk nf ko ng ks nh kw nm mz na nb bi translated">选择您想要的订单(虚拟！)购买</li><li id="2366" class="mt mu in kb b kc nd kg ne kk nf ko ng ks nh kw nm mz na nb bi translated">提供4242 4242 4242 4242作为测试信用卡</li><li id="8aa1" class="mt mu in kb b kc nd kg ne kk nf ko ng ks nh kw nm mz na nb bi translated">插入你的(假的！)运输详情</li><li id="7ab9" class="mt mu in kb b kc nd kg ne kk nf ko ng ks nh kw nm mz na nb bi translated">确认(假的！)购买！</li></ol><p id="3256" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">您应该会得到如下提示:</p><figure class="mg mh mi mj gt jo gh gi paragraph-image"><div class="gh gi mf"><img src="../Images/57a1c927e64f63f431f80c088367d838.png" data-original-src="https://miro.medium.com/v2/resize:fit:1296/format:webp/1*Rr3k6MmZH_KORi6YbhatAA.png"/></div></figure><p id="dde6" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">你可以在我的<a class="ae nc" href="https://github.com/Mikepicker/blog_telegram_shop" rel="noopener ugc nofollow" target="_blank"> GitHub repo </a>上找到所有代码。</p><h1 id="e7d5" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">总结</h1><p id="05f3" class="pw-post-body-paragraph jz ka in kb b kc lw ke kf kg lx ki kj kk ly km kn ko lz kq kr ks ma ku kv kw ig bi translated">创建一个电报机器人不仅有用，而且有趣，非常简单！</p><p id="d629" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">您可以通过添加受保护的命令(例如，只能从您的Telegram用户名调用)来更新您的产品，或将其用作您的电子商务的附加组件，从而扩展本简易指南。</p><p id="bd5b" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">可能性几乎是无限的！</p><p id="6465" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">欢迎在评论区留下你的爱和反馈。</strong></p><h1 id="a2cb" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">谢谢大家！</h1></div></div>    
</body>
</html>