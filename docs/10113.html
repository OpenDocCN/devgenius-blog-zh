<html>
<head>
<title>Laravel-Excel — P8: Queued Import</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Laravel-Excel — P8:排队导入</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/laravel-excel-p8-queued-import-7d8e6aac2e8f?source=collection_archive---------3-----------------------#2022-10-08">https://blog.devgenius.io/laravel-excel-p8-queued-import-7d8e6aac2e8f?source=collection_archive---------3-----------------------#2022-10-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/3332e23edc79dcdd42189f40be64e60e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8yeHD8O-CeEBQTi_Gx9Eng.jpeg"/></div></div></figure><p id="1b35" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">是时候把这一切整合在一起了。我们在之前的文章基础上慢慢提高了速度。通过批量插入，我们可以批量插入 100 行(尽管您可以选择任意数量)。通过块读取，我们消除了将整个 excel 表加载到内存中的内存问题，取而代之的是加载 100 行数据(尽管我们可以根据需要增加或减少这个数字)。</p><p id="5a16" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是还有一个问题。如果文件太大以至于 PHP 超时了怎么办？如何导入一个需要 5 分钟才能导入的文件？即使 PHP 没有超时，您希望让用户在导入运行时等待吗？当然不是。这就是排队进口的亮点。</p><h1 id="0494" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">如何用队列导入？</h1><p id="fd73" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">首先要注意的是，排队导入只适用于块读取。这意味着<code class="fe lz ma mb mc b">WithChunkReading</code>关注点必须存在。在导入中实现了块读取之后，剩下的惟一需要实现的是<code class="fe lz ma mb mc b">ShouldQueue</code>。有这么简单吗？是的。</p><figure class="md me mf mg gt jr"><div class="bz fp l di"><div class="mh mi l"/></div></figure><p id="95bf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们创建我们的<code class="fe lz ma mb mc b">UserController</code>方法，并添加我们的路线和测试。我会稍微破坏它，它不会马上工作，除非你有一些运行。</p><figure class="md me mf mg gt jr"><div class="bz fp l di"><div class="mh mi l"/></div></figure><figure class="md me mf mg gt jr"><div class="bz fp l di"><div class="mh mi l"/></div></figure><p id="424d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们调用路线，看看会发生什么。嗯，成功了。导入成功，但它没有被发送到队列并在后台执行。到目前为止，它只是像其他东西一样输入。您可以看到，在导入完成之前，用户被锁定在屏幕上。</p><h2 id="3328" class="mj kx iq bd ky mk ml dn lc mm mn dp lg kj mo mp lk kn mq mr lo kr ms mt ls mu bi translated">为什么队列导入不起作用？</h2><p id="08c0" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">如果它不起作用，那是因为你配置 Laravel 的方式。打开您的<code class="fe lz ma mb mc b">.env</code>文件，您会注意到<code class="fe lz ma mb mc b">QUEUE_CONNECTION</code>被设置为<code class="fe lz ma mb mc b">sync</code>。我们需要准备 Laravel 来使用队列。让我们修改它，以便我们可以使用队列。运行以下命令:</p><pre class="md me mf mg gt mv mc mw mx aw my bi"><span id="5846" class="mj kx iq mc b gy mz na l nb nc">php artisan queue:table</span></pre><p id="8b92" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这将生成<code class="fe lz ma mb mc b">jobs</code>迁移，其中将插入作业。</p><pre class="md me mf mg gt mv mc mw mx aw my bi"><span id="3172" class="mj kx iq mc b gy mz na l nb nc">php artisan migrate</span></pre><p id="82e9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建<code class="fe lz ma mb mc b">jobs</code>表。剩下的就是将<code class="fe lz ma mb mc b">QUEUE_CONNECTION</code>修改为<code class="fe lz ma mb mc b">database</code>并清除配置。打开您的<code class="fe lz ma mb mc b">.env</code>文件，将<code class="fe lz ma mb mc b">QUEUE_CONNECTION</code>从<code class="fe lz ma mb mc b">sync</code>更改为<code class="fe lz ma mb mc b">database</code>。</p><pre class="md me mf mg gt mv mc mw mx aw my bi"><span id="c966" class="mj kx iq mc b gy mz na l nb nc">QUEUE_CONNECTION=database</span></pre><p id="510b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后清除配置缓存。</p><pre class="md me mf mg gt mv mc mw mx aw my bi"><span id="1266" class="mj kx iq mc b gy mz na l nb nc">php artisan config:clear</span></pre><p id="0c63" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们再次尝试我们的例子。你觉得这会有用吗？</p><p id="4fbe" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">嗯，这次快得像闪电一样。看起来好像创造了工作，但什么也没发生。进口在哪里？最后一步。我们需要确保我们的队列在工作。</p><pre class="md me mf mg gt mv mc mw mx aw my bi"><span id="a0f4" class="mj kx iq mc b gy mz na l nb nc">php artisan queue:work</span></pre><p id="6034" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">酷！当每个数据块完成时，我们甚至可以看到一个很棒的数据块消息显示，以及队列导入它花了多长时间。</p><pre class="md me mf mg gt mv mc mw mx aw my bi"><span id="7e9c" class="mj kx iq mc b gy mz na l nb nc">2022-10-08 18:10:58 Maatwebsite\Excel\Jobs\QueueImport ....................... 39.51ms DONE</span><span id="aee5" class="mj kx iq mc b gy nd na l nb nc">2022-10-08 18:10:58 Maatwebsite\Excel\Jobs\ReadChunk ....................... 989.82ms DONE</span><span id="31b7" class="mj kx iq mc b gy nd na l nb nc">2022-10-08 18:10:59 Maatwebsite\Excel\Jobs\ReadChunk ....................... 916.27ms DONE</span><span id="a2ea" class="mj kx iq mc b gy nd na l nb nc">2022-10-08 18:11:00 Maatwebsite\Excel\Jobs\ReadChunk ....................... 920.93ms DONE</span><span id="fae8" class="mj kx iq mc b gy nd na l nb nc">2022-10-08 18:11:01 Maatwebsite\Excel\Jobs\ReadChunk ....................... 920.62ms DONE</span><span id="3482" class="mj kx iq mc b gy nd na l nb nc">2022-10-08 18:11:02 Maatwebsite\Excel\Jobs\ReadChunk ....................... 914.32ms DONE</span><span id="8f4b" class="mj kx iq mc b gy nd na l nb nc">2022-10-08 18:11:03 Maatwebsite\Excel\Jobs\AfterImportJob ....................... 4.14ms DONE</span></pre><h1 id="0338" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">显式声明队列导入</h1><p id="d6ac" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">当在实现了<code class="fe lz ma mb mc b">ShouldQueue</code>关注的情况下调用<code class="fe lz ma mb mc b">Excel::import</code>时，队列被隐式调用。如果你想表达清楚，你可以用<code class="fe lz ma mb mc b">Excel::queueImport()</code>。无论哪种方式，总是需要<code class="fe lz ma mb mc b">ShouldQueue</code>关注。</p><h1 id="5184" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">修改排队导入</h1><p id="4923" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">如果您尝试修改排队导入类内部的细节，您会注意到这些更改并没有反映出来。每次修改导入时，您都需要重新启动队列。</p></div><div class="ab cl ne nf hu ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ij ik il im in"><figure class="md me mf mg gt jr gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/cccfb0db719a05d53e601cb6d6656422.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Kkvg16kNwfyb58kU.jpeg"/></div></figure><p id="8c7f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Dino Cajic 目前是<a class="ae nm" href="https://www.absolutebiotech.com/" rel="noopener ugc nofollow" target="_blank"> Absolute Biotech </a>的 IT 主管，该公司是<a class="ae nm" href="https://www.lsbio.com/" rel="noopener ugc nofollow" target="_blank"> LSBio(寿命生物科学公司)</a>、<a class="ae nm" href="https://absoluteantibody.com/" rel="noopener ugc nofollow" target="_blank"> Absolute 抗体</a>、<a class="ae nm" href="https://www.kerafast.com/" rel="noopener ugc nofollow" target="_blank"> Kerafast </a>、<a class="ae nm" href="https://everestbiotech.com/" rel="noopener ugc nofollow" target="_blank"> Everest BioTech </a>、<a class="ae nm" href="https://www.nordicmubio.com/" rel="noopener ugc nofollow" target="_blank"> Nordic MUbio </a>和<a class="ae nm" href="https://www.exalpha.com/" rel="noopener ugc nofollow" target="_blank"> Exalpha </a>的母公司。他还担任我的自动系统的首席执行官。他有十多年的软件工程经验。他拥有计算机科学学士学位，辅修生物学。他的背景包括创建企业级电子商务应用程序、执行基于研究的软件开发，以及通过写作促进知识的传播。</p><p id="2e4c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你可以在<a class="ae nm" href="https://www.linkedin.com/in/dinocajic/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上联系他，在<a class="ae nm" href="https://instagram.com/think.dino" rel="noopener ugc nofollow" target="_blank"> Instagram </a>上关注他，或者<a class="ae nm" href="https://dinocajic.medium.com/subscribe" rel="noopener">订阅他的媒体出版物</a>。</p><p id="b328" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">阅读 Dino Cajic(以及 Medium 上成千上万的其他作家)的每一个故事。你的会员费直接支持迪诺·卡吉克和你阅读的其他作家。你也可以在媒体上看到所有的故事。T29】</p></div></div>    
</body>
</html>