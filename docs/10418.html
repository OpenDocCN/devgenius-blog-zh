<html>
<head>
<title>How to design a custom model mixer in Lightwood</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在 Lightwood 中设计自定义模型混音器</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/introduction-e2f933c40f4c?source=collection_archive---------18-----------------------#2022-10-31">https://blog.devgenius.io/introduction-e2f933c40f4c?source=collection_archive---------18-----------------------#2022-10-31</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/c6e9ae9f6d9eba49a312ca5974421e47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*93KOKJHTsAb-h1Pm"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">致谢:<a class="ae jz" href="https://unsplash.com/photos/Wpnoqo2plFA?utm_source=63921&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">米卡·鲍梅斯特</a></figcaption></figure><h1 id="7e84" class="ka kb in bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">介绍</h1><p id="4ab0" class="pw-post-body-paragraph ky kz in la b lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv ig bi translated">混合器是 lightwood 的核心，负责学习编码特征和目标表示之间的映射。Lightwood 是一个 AutoML 框架，它使你能够使用名为 JSON-AI 的声明性语法来生成和定制机器学习管道。混音器学习映射编码表示，它们是 lightwood 的 AutoML 的核心。在本教程中，我们将尝试将 LightGBM 实现为处理分类目标和整数目标的混合器。</p><h1 id="c8a6" class="ka kb in bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">安装和设置</h1><p id="5250" class="pw-post-body-paragraph ky kz in la b lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv ig bi translated">您可以按如下方式安装 Lightwood:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="8499" class="mf kb in mb b gy mg mh l mi mj">pip install lightwood</span></pre><h1 id="5504" class="ka kb in bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">设置 VSCode 环境</h1><ul class=""><li id="3135" class="mk ml in la b lb lc lf lg lj mm ln mn lr mo lv mp mq mr ms bi translated">使用 GitHub 帐户安装并启用设置同步(如果您使用多台机器)</li><li id="d6aa" class="mk ml in la b lb mt lf mu lj mv ln mw lr mx lv mp mq mr ms bi translated">安装 pylance(用于类型),并确保禁用 pyright</li><li id="3a8e" class="mk ml in la b lb mt lf mu lj mv ln mw lr mx lv mp mq mr ms bi translated">转到<code class="fe my mz na mb b">Python &gt; Lint: Enabled</code>并禁用除薄片 8 之外的所有<em class="nb"/></li><li id="876e" class="mk ml in la b lb mt lf mu lj mv ln mw lr mx lv mp mq mr ms bi translated">将<code class="fe my mz na mb b">python.linting.flake8Path</code>设置为 flake8 的完整路径(哪个 flake8)</li><li id="52e6" class="mk ml in la b lb mt lf mu lj mv ln mw lr mx lv mp mq mr ms bi translated">将<code class="fe my mz na mb b">Python › Formatting: Provider</code>设置为 autopep8</li><li id="f2c9" class="mk ml in la b lb mt lf mu lj mv ln mw lr mx lv mp mq mr ms bi translated">将<code class="fe my mz na mb b">-global-config=&lt;path_to&gt;/lightwood/.flake8</code>和<code class="fe my mz na mb b">-experimental</code>添加到<code class="fe my mz na mb b">Python › Formatting: Autopep8 Args</code></li><li id="4008" class="mk ml in la b lb mt lf mu lj mv ln mw lr mx lv mp mq mr ms bi translated">安装实时共享和实时共享白板</li></ul><p id="62a3" class="pw-post-body-paragraph ky kz in la b lb nc ld le lf nd lh li lj ne ll lm ln nf lp lq lr ng lt lu lv ig bi translated"><strong class="la io">注意</strong>:在 python 3.8 或 3.9 版本的 python 虚拟环境中运行</p><h1 id="3687" class="ka kb in bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">步骤 1:混音器界面</h1><p id="de69" class="pw-post-body-paragraph ky kz in la b lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv ig bi translated">混音器接口由<code class="fe my mz na mb b">BaseMixer</code>类定义，混音器需要 4 个任务的方法:*拟合(<code class="fe my mz na mb b">fit</code> ) *预测(<code class="fe my mz na mb b">__call__</code> ) *构造(<code class="fe my mz na mb b">__init__</code> ) *部分拟合(<code class="fe my mz na mb b">partial_fit</code>)，尽管这个是可选的</p><h1 id="50e5" class="ka kb in bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">步骤 2:编写我们的混音器</h1><p id="7971" class="pw-post-body-paragraph ky kz in la b lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv ig bi translated">我将在我们的虚拟环境中创建一个名为<code class="fe my mz na mb b">lightgbm_mixer.py</code>的文件。在它里面，我们将用下面几行代码实现我们的混合器</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="1a0d" class="mf kb in mb b gy mg mh l mi mj">from lightwood.mixer import BaseMixer<br/>from lightwood.api.types import PredictionArguments<br/>from lightwood.data.encoded_ds import EncodedDs, ConcatedEncodedDs<br/>from lightwood import dtype<br/>from lightwood.encoder import BaseEncoder</span><span id="317e" class="mf kb in mb b gy nh mh l mi mj">import torch<br/>import pandas as pd<br/>import lightgbm</span><span id="bc41" class="mf kb in mb b gy nh mh l mi mj">class LightGBM(BaseMixer):<br/>    model: lightgbm.LGBMClassifier</span><span id="e5d0" class="mf kb in mb b gy nh mh l mi mj">    def __init__(self, stop_after: int, dtype_dict: dict, target: str, target_encoder: BaseEncoder):<br/>        super().__init__(stop_after)<br/>        self.target_encoder = target_encoder<br/># Throw in case someone tries to use this for a problem that's not classification, I'd fail anyway, but this way the error message is more intuitive<br/>        if dtype_dict[target] not in (dtype.categorical, dtype.integer):<br/>            raise Exception(f'This mixer can only be used for classification problems! Got target dtype {dtype_dict[target]} instead!')<br/>            # We could also initialize this in `fit` if some of the parameters depend on the input data, since `fit` is called exactly once<br/>        self.model = lightgbm.LGBMClassifier(max_depth=30)<br/>        def fit(self, train_data: EncodedDs, dev_data: EncodedDs) -&gt; None:<br/>            X, Y = [], []<br/>        # By default mixers get some train data and a bit of dev data on which to do early stopping or hyper parameter optimization. For this mixer, we don't need dev data, so we're going to concat the two in order to get more training data. Then, we're going to turn them into an sklearn friendly foramat.<br/>            for x, y in ConcatedEncodedDs([train_data, dev_data]):<br/>                X.append(x.tolist())<br/>                Y.append(y.tolist())<br/>            self.model.fit(X, Y)</span><span id="db7e" class="mf kb in mb b gy nh mh l mi mj">    def __call__(self, ds: EncodedDs,<br/>                 args: PredictionArguments = PredictionArguments()) -&gt; pd.DataFrame:<br/>        # Turn the data into an sklearn friendly format<br/>        X = []<br/>        for x, _ in ds:<br/>            X.append(x.tolist())</span><span id="ac22" class="mf kb in mb b gy nh mh l mi mj">        Yh = self.model.predict(X)</span><span id="1946" class="mf kb in mb b gy nh mh l mi mj">        # Lightwood encoders are meant to decode torch tensors, so we have to cast the predictions first<br/>        decoded_predictions = self.target_encoder.decode(torch.Tensor(Yh))</span><span id="3b34" class="mf kb in mb b gy nh mh l mi mj">        # Finally, turn the decoded predictions into a dataframe with a single column called `prediction`. This is the standard behaviour all lightwood mixers use<br/>        ydf = pd.DataFrame({'prediction': decoded_predictions})</span><span id="5367" class="mf kb in mb b gy nh mh l mi mj">        return ydf</span><span id="bab6" class="mf kb in mb b gy nh mh l mi mj">    # We'll skip implementing `partial_fit`, thus making this mixer unsuitable for online training tasks</span></pre><h1 id="6b80" class="ka kb in bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">第三步:使用我们的搅拌机</h1><p id="086f" class="pw-post-body-paragraph ky kz in la b lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv ig bi translated">我们将使用我们的混合器，根据所有五张牌的花色和级别来确定我们的扑克手牌实力:</p><p id="a7d4" class="pw-post-body-paragraph ky kz in la b lb nc ld le lf nd lh li lj ne ll lm ln nf lp lq lr ng lt lu lv ig bi translated"><a class="ae jz" href="https://raw.githubusercontent.com/Tes-program/lightwood_tutorial/main/poker-hand-training.csv" rel="noopener ugc nofollow" target="_blank">https://raw . githubusercontent . com/Tes-program/light wood _ tutorial/main/poker-hand-training . CSV</a></p><p id="b5f4" class="pw-post-body-paragraph ky kz in la b lb nc ld le lf nd lh li lj ne ll lm ln nf lp lq lr ng lt lu lv ig bi translated">首先，由于我们不想为这个数据集从头开始编写 Json AI，我们将让 lightwood 自动生成一个。</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="5137" class="mf kb in mb b gy mg mh l mi mj">from lightwood.api.high_level import ProblemDefinition, json_ai_from_problem, load_custom_module<br/>import pandas as pd<br/>import lightgbm_mixer</span><span id="d73f" class="mf kb in mb b gy nh mh l mi mj"># load the code<br/>load_custom_module('lightgbm_mixer.py')</span><span id="7b00" class="mf kb in mb b gy nh mh l mi mj"># read dataset<br/>df = pd.read_csv('&lt;https://raw.githubusercontent.com/Tes-program/lightwood_tutorial/main/poker-hand-training.csv&gt;')</span><span id="41af" class="mf kb in mb b gy nh mh l mi mj"># define the predictive task<br/>pdef = ProblemDefinition.from_dict({<br/>    'target': 'Poker_Hand', # column you want to predict<br/>})</span><span id="e541" class="mf kb in mb b gy nh mh l mi mj"># generate the Json AI intermediate representation from the data and its corresponding settings<br/>json_ai = json_ai_from_problem(df, problem_definition=pdef)</span><span id="4fcf" class="mf kb in mb b gy nh mh l mi mj"># Print it (you can also put it in a file and edit it there)<br/>print(json_ai.to_json())</span></pre><p id="4ce0" class="pw-post-body-paragraph ky kz in la b lb nc ld le lf nd lh li lj ne ll lm ln nf lp lq lr ng lt lu lv ig bi translated">预期产出将是:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="d89f" class="mf kb in mb b gy mg mh l mi mj">╰─ python predictor.py                                                       ─╯<br/>INFO:lightwood-17958:No torchvision detected, image helpers not supported.<br/>INFO:lightwood-17958:No torchvision/pillow detected, image encoder not supported<br/>/home/teslim/test/lib/python3.8/site-packages/gluonts/json.py:101: UserWarning: Using `json`-module for json-handling. Consider installing one of `orjson`, `ujson` to speed up serialization and deserialization.<br/>  warnings.warn(<br/>/home/teslim/test/lib/python3.8/site-packages/gluonts/model/deepar/__init__.py:18: FutureWarning: The module gluonts.model.deepar has been moved to gluonts.mx.model.deepar. In GluonTS v0.12 it will be no longer possible to use the old path. Try to use 'from gluonts.mx import DeepAREstimator'.<br/>  warnings.warn(<br/>INFO:lightwood-17958:Analyzing a sample of 11020<br/>INFO:lightwood-17958:from a total population of 25010, this is equivalent to 44.1% of your data.<br/>INFO:lightwood-17958:Using 3 processes to deduct types.<br/>INFO:lightwood-17958:Infering type for: Suit_of_Card_1<br/>INFO:lightwood-17958:Infering type for: Rank_of_Card_1<br/>INFO:lightwood-17958:Infering type for: Suit_of_Card_2<br/>INFO:lightwood-17958:Column Suit_of_Card_2 has data type categorical<br/>INFO:lightwood-17958:Infering type for: Rank_of_Card_2<br/>INFO:lightwood-17958:Column Suit_of_Card_1 has data type categorical<br/>INFO:lightwood-17958:Column Rank_of_Card_1 has data type integer<br/>INFO:lightwood-17958:Infering type for: Suit_of_Card_3<br/>INFO:lightwood-17958:Infering type for: Rank_of_Card_3<br/>INFO:lightwood-17958:Column Suit_of_Card_3 has data type categorical<br/>INFO:lightwood-17958:Infering type for: Suit_of_Card_4<br/>INFO:lightwood-17958:Column Rank_of_Card_2 has data type integer<br/>INFO:lightwood-17958:Infering type for: Rank_of_Card_4<br/>INFO:lightwood-17958:Column Rank_of_Card_3 has data type integer<br/>INFO:lightwood-17958:Infering type for: Suit_of_Card_5<br/>INFO:lightwood-17958:Column Suit_of_Card_4 has data type categorical<br/>INFO:lightwood-17958:Infering type for: Rank_of_Card_5<br/>INFO:lightwood-17958:Column Suit_of_Card_5 has data type categorical<br/>INFO:lightwood-17958:Infering type for: Poker_Hand<br/>INFO:lightwood-17958:Column Rank_of_Card_4 has data type integer<br/>INFO:lightwood-17958:Column Rank_of_Card_5 has data type integer<br/>INFO:lightwood-17958:Column Poker_Hand has data type integer<br/>INFO:lightwood-17958:Starting statistical analysis<br/>INFO:lightwood-17958:Finished statistical analysis<br/>{<br/>    "encoders": {<br/>        "Poker_Hand": {<br/>            "module": "NumericEncoder",<br/>            "args": {<br/>                "is_target": "True",<br/>                "positive_domain": "$statistical_analysis.positive_domain"<br/>            }<br/>        },<br/>        "Suit_of_Card_1": {<br/>            "module": "OneHotEncoder",<br/>            "args": {}<br/>        },<br/>        "Rank_of_Card_1": {<br/>            "module": "NumericEncoder",<br/>            "args": {}<br/>        },<br/>        "Suit_of_Card_2": {<br/>            "module": "OneHotEncoder",<br/>            "args": {}<br/>        },<br/>        "Rank_of_Card_2": {<br/>            "module": "NumericEncoder",<br/>            "args": {}<br/>        },<br/>        "Suit_of_Card_3": {<br/>            "module": "OneHotEncoder",<br/>            "args": {}<br/>        },<br/>        "Rank_of_Card_3": {<br/>            "module": "NumericEncoder",<br/>            "args": {}<br/>        },<br/>        "Suit_of_Card_4": {<br/>            "module": "OneHotEncoder",<br/>            "args": {}<br/>        },<br/>        "Rank_of_Card_4": {<br/>            "module": "NumericEncoder",<br/>            "args": {}<br/>        },<br/>        "Suit_of_Card_5": {<br/>            "module": "OneHotEncoder",<br/>            "args": {}<br/>        },<br/>        "Rank_of_Card_5": {<br/>            "module": "NumericEncoder",<br/>            "args": {}<br/>        }<br/>    },<br/>    "dtype_dict": {<br/>        "Suit_of_Card_1": "categorical",<br/>        "Rank_of_Card_1": "integer",<br/>        "Suit_of_Card_2": "categorical",<br/>        "Rank_of_Card_2": "integer",<br/>        "Suit_of_Card_3": "categorical",<br/>        "Rank_of_Card_3": "integer",<br/>        "Suit_of_Card_4": "categorical",<br/>        "Rank_of_Card_4": "integer",<br/>        "Suit_of_Card_5": "categorical",<br/>        "Rank_of_Card_5": "integer",<br/>        "Poker_Hand": "integer"<br/>    },<br/>    "dependency_dict": {},<br/>    "model": {<br/>        "module": "BestOf",<br/>        "args": {<br/>            "submodels": [<br/>                {<br/>                    "module": "Neural",<br/>                    "args": {<br/>                        "fit_on_dev": true,<br/>                        "stop_after": "$problem_definition.seconds_per_mixer",<br/>                        "search_hyperparameters": true<br/>                    }<br/>                },<br/>                {<br/>                    "module": "LightGBM",<br/>                    "args": {<br/>                        "stop_after": "$problem_definition.seconds_per_mixer",<br/>                        "fit_on_dev": true<br/>                    }<br/>                },<br/>                {<br/>                    "module": "Regression",<br/>                    "args": {<br/>                        "stop_after": "$problem_definition.seconds_per_mixer"<br/>                    }<br/>                },<br/>                {<br/>                    "module": "RandomForest",<br/>                    "args": {<br/>                        "stop_after": "$problem_definition.seconds_per_mixer",<br/>                        "fit_on_dev": true<br/>                    }<br/>                }<br/>            ]<br/>        }<br/>    },<br/>    "problem_definition": {<br/>        "target": "Poker_Hand",<br/>        "pct_invalid": 2,<br/>        "unbias_target": true,<br/>        "seconds_per_mixer": 42768.0,<br/>        "seconds_per_encoder": null,<br/>        "expected_additional_time": 2.305413007736206,<br/>        "time_aim": 259200,<br/>        "target_weights": null,<br/>        "positive_domain": false,<br/>        "timeseries_settings": {<br/>            "is_timeseries": false,<br/>            "order_by": null,<br/>            "window": null,<br/>            "group_by": null,<br/>            "use_previous_target": true,<br/>            "horizon": null,<br/>            "historical_columns": null,<br/>            "target_type": "",<br/>            "allow_incomplete_history": true,<br/>            "eval_incomplete": false,<br/>            "interval_periods": []<br/>        },<br/>        "anomaly_detection": false,<br/>        "use_default_analysis": true,<br/>        "ignore_features": [],<br/>        "fit_on_all": true,<br/>        "strict_mode": true,<br/>        "seed_nr": 1<br/>    },<br/>    "identifiers": {},<br/>    "imputers": [],<br/>    "accuracy_functions": [<br/>        "r2_score"<br/>    ]<br/>}</span></pre><p id="7f06" class="pw-post-body-paragraph ky kz in la b lb nc ld le lf nd lh li lj ne ll lm ln nf lp lq lr ng lt lu lv ig bi translated">现在我们必须编辑这个 JSON ai 的<code class="fe my mz na mb b">mixer's</code>键来告诉 lightwood 使用我们的定制混合器。我们可以和其他人一起使用它，也可以在最后和他们一起使用，或者单独使用。但是在这种情况下，我将用下面的语法替换所有现有的混合器</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="9752" class="mf kb in mb b gy mg mh l mi mj">json_ai.model['submodels'] = [{<br/>    'module': 'lightgbm',<br/>    <br/>}]</span></pre><p id="5dfa" class="pw-post-body-paragraph ky kz in la b lb nc ld le lf nd lh li lj ne ll lm ln nf lp lq lr ng lt lu lv ig bi translated">然后，我们将生成一些代码，最后，将这些代码转换成预测器对象，并使用以下语法将它应用于原始数据:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="d12f" class="mf kb in mb b gy mg mh l mi mj">from lightwood.api.high_level import code_from_json_ai, predictor_from_code</span><span id="f9c1" class="mf kb in mb b gy nh mh l mi mj">code = code_from_json_ai(json_ai)<br/>predictor = predictor_from_code(code)</span></pre><p id="2081" class="pw-post-body-paragraph ky kz in la b lb nc ld le lf nd lh li lj ne ll lm ln nf lp lq lr ng lt lu lv ig bi translated">预期的输出应该是:</p><figure class="lw lx ly lz gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ni"><img src="../Images/60aba745922dbe44352e92d35f77d24e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U7vI-UYekUebTz9K4M_z2A.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">预期终端输出</figcaption></figure><p id="3d37" class="pw-post-body-paragraph ky kz in la b lb nc ld le lf nd lh li lj ne ll lm ln nf lp lq lr ng lt lu lv ig bi translated">现在，让我们用以下内容来训练我们的预测模型:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="436e" class="mf kb in mb b gy mg mh l mi mj">predictor.learn(df)</span></pre><p id="ed1d" class="pw-post-body-paragraph ky kz in la b lb nc ld le lf nd lh li lj ne ll lm ln nf lp lq lr ng lt lu lv ig bi translated">您的预期输出应该是:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="84f3" class="mf kb in mb b gy mg mh l mi mj">INFO:lightwood-69350:No torchvision detected, image helpers not supported.<br/>INFO:lightwood-69350:No torchvision/pillow detected, image encoder not supported<br/>INFO:lightwood-69350:Analyzing a sample of 11020<br/>INFO:lightwood-69350:from a total population of 25010, this is equivalent to 44.1% of your data.<br/>INFO:lightwood-69350:Using 3 processes to deduct types.<br/>INFO:lightwood-69350:Infering type for: Suit_of_Card_1<br/>INFO:lightwood-69350:Infering type for: Rank_of_Card_1<br/>INFO:lightwood-69350:Infering type for: Suit_of_Card_2<br/>INFO:lightwood-69350:Column Suit_of_Card_1 has data type categorical<br/>INFO:lightwood-69350:Infering type for: Rank_of_Card_2<br/>INFO:lightwood-69350:Column Suit_of_Card_2 has data type categorical<br/>INFO:lightwood-69350:Column Rank_of_Card_1 has data type integer<br/>INFO:lightwood-69350:Infering type for: Suit_of_Card_3<br/>INFO:lightwood-69350:Infering type for: Rank_of_Card_3<br/>INFO:lightwood-69350:Column Suit_of_Card_3 has data type categorical<br/>INFO:lightwood-69350:Infering type for: Suit_of_Card_4<br/>INFO:lightwood-69350:Column Rank_of_Card_2 has data type integer<br/>INFO:lightwood-69350:Infering type for: Rank_of_Card_4<br/>INFO:lightwood-69350:Column Rank_of_Card_3 has data type integer<br/>INFO:lightwood-69350:Infering type for: Suit_of_Card_5<br/>INFO:lightwood-69350:Column Suit_of_Card_4 has data type categorical<br/>INFO:lightwood-69350:Infering type for: Rank_of_Card_5<br/>INFO:lightwood-69350:Column Rank_of_Card_4 has data type integer<br/>INFO:lightwood-69350:Infering type for: Poker_Hand<br/>INFO:lightwood-69350:Column Rank_of_Card_5 has data type integer<br/>INFO:lightwood-69350:Column Suit_of_Card_5 has data type categorical<br/>INFO:lightwood-69350:Column Poker_Hand has data type integer<br/>INFO:lightwood-69350:Starting statistical analysis<br/>INFO:lightwood-69350:Finished statistical analysis<br/>INFO:lightwood-69350:Unable to import black formatter, predictor code might be a bit ugly.<br/>INFO:lightwood-69350:[Learn phase 1/8] - Statistical analysis<br/>INFO:lightwood-69350:Starting statistical analysis<br/>INFO:lightwood-69350:Finished statistical analysis<br/>DEBUG:lightwood-69350: `analyze_data` runtime: 1.3 seconds<br/>INFO:lightwood-69350:[Learn phase 2/8] - Data preprocessing<br/>INFO:lightwood-69350:Cleaning the data<br/>DEBUG:lightwood-69350: `preprocess` runtime: 0.51 seconds<br/>INFO:lightwood-69350:[Learn phase 3/8] - Data splitting<br/>INFO:lightwood-69350:Splitting the data into train/test<br/>DEBUG:lightwood-69350: `split` runtime: 0.07 seconds<br/>INFO:lightwood-69350:[Learn phase 4/8] - Preparing encoders<br/>INFO:lightwood-69350:Encoding UNKNOWN categories as index 0<br/>INFO:lightwood-69350:Encoding UNKNOWN categories as index 0<br/>INFO:lightwood-69350:Done running for: Suit_of_Card_1<br/>INFO:lightwood-69350:Encoding UNKNOWN categories as index 0<br/>INFO:lightwood-69350:Done running for: Rank_of_Card_1<br/>INFO:lightwood-69350:Done running for: Suit_of_Card_2<br/>INFO:lightwood-69350:Encoding UNKNOWN categories as index 0<br/>INFO:lightwood-69350:Done running for: Rank_of_Card_2<br/>INFO:lightwood-69350:Done running for: Suit_of_Card_3<br/>INFO:lightwood-69350:Done running for: Rank_of_Card_3<br/>INFO:lightwood-69350:Done running for: Suit_of_Card_4<br/>INFO:lightwood-69350:Encoding UNKNOWN categories as index 0<br/>INFO:lightwood-69350:Done running for: Rank_of_Card_4<br/>INFO:lightwood-69350:Done running for: Suit_of_Card_5<br/>INFO:lightwood-69350:Done running for: Rank_of_Card_5<br/>DEBUG:lightwood-69350: `prepare` runtime: 0.76 seconds<br/>INFO:lightwood-69350:[Learn phase 5/8] - Feature generation<br/>INFO:lightwood-69350:Featurizing the data<br/>DEBUG:lightwood-69350: `featurize` runtime: 0.0 seconds<br/>INFO:lightwood-69350:[Learn phase 6/8] - Mixer training<br/>INFO:lightwood-69350:Training the mixers<br/>INFO:lightwood-69350:Loss of 66.96073913574219 with learning rate 0.0001<br/>INFO:lightwood-69350:Loss of 73.57966613769531 with learning rate 0.00014<br/>INFO:lightwood-69350:Found learning rate of: 0.0001<br/>INFO:lightwood-69350:Loss @ epoch 1: 69.4616584777832<br/>INFO:lightwood-69350:Loss @ epoch 2: 65.4459950373723<br/>INFO:lightwood-69350:Loss @ epoch 3: 60.80090155968299<br/>INFO:lightwood-69350:Loss @ epoch 4: 55.934378990760216<br/>INFO:lightwood-69350:Loss @ epoch 5: 51.119818467360275<br/>INFO:lightwood-69350:Loss @ epoch 6: 46.61281350942758<br/>INFO:lightwood-69350:Loss @ epoch 7: 42.459257272573616<br/>INFO:lightwood-69350:Loss @ epoch 8: 39.36399899996244<br/>INFO:lightwood-69350:Loss @ epoch 9: 37.174588423508865<br/>INFO:lightwood-69350:Loss @ epoch 10: 35.81990872896635<br/>INFO:lightwood-69350:Loss @ epoch 11: 35.092872913067154<br/>INFO:lightwood-69350:Loss @ epoch 12: 34.748955946702225<br/>INFO:lightwood-69350:Loss @ epoch 13: 34.594378838172325<br/>INFO:lightwood-69350:Loss @ epoch 14: 34.534512739915115<br/>INFO:lightwood-69350:Loss @ epoch 15: 34.50775733360877<br/>INFO:lightwood-69350:Loss @ epoch 16: 34.49432549109826<br/>INFO:lightwood-69350:Loss @ epoch 17: 34.48627471923828<br/>INFO:lightwood-69350:Loss @ epoch 18: 34.47985076904297<br/>INFO:lightwood-69350:Loss @ epoch 19: 34.473904829758865<br/>INFO:lightwood-69350:Loss @ epoch 20: 34.46845861581656<br/>INFO:lightwood-69350:Loss @ epoch 21: 34.46300271841196<br/>INFO:lightwood-69350:Loss @ epoch 22: 34.45746994018555<br/>INFO:lightwood-69350:Loss @ epoch 23: 34.45192072941707<br/>INFO:lightwood-69350:Loss @ epoch 24: 34.445784055269684<br/>INFO:lightwood-69350:Loss @ epoch 25: 34.43961539635291<br/>INFO:lightwood-69350:Loss @ epoch 26: 34.43367033738356<br/>INFO:lightwood-69350:Loss @ epoch 27: 34.427734375<br/>INFO:lightwood-69350:Loss @ epoch 28: 34.421786088209885<br/>INFO:lightwood-69350:Loss @ epoch 29: 34.41596603393555<br/>INFO:lightwood-69350:Loss @ epoch 30: 34.409483396089996<br/>INFO:lightwood-69350:Loss @ epoch 31: 34.403370490440956<br/>INFO:lightwood-69350:Loss @ epoch 32: 34.39738435011644<br/>INFO:lightwood-69350:Loss @ epoch 33: 34.39150678194486<br/>INFO:lightwood-69350:Loss @ epoch 34: 34.3857788672814<br/>INFO:lightwood-69350:Loss @ epoch 35: 34.380235818716194<br/>INFO:lightwood-69350:Loss @ epoch 36: 34.3740595304049<br/>INFO:lightwood-69350:Loss @ epoch 37: 34.36870927077074<br/>INFO:lightwood-69350:Loss @ epoch 38: 34.36332027728741<br/>INFO:lightwood-69350:Loss @ epoch 39: 34.358152829683746<br/>INFO:lightwood-69350:Loss @ epoch 40: 34.3531012901893<br/>INFO:lightwood-69350:Loss @ epoch 41: 34.34839307344877<br/>INFO:lightwood-69350:Loss @ epoch 42: 34.342967106745796<br/>INFO:lightwood-69350:Loss @ epoch 43: 34.338902106651894<br/>INFO:lightwood-69350:Loss @ epoch 44: 34.33445358276367<br/>INFO:lightwood-69350:Loss @ epoch 45: 34.33023922259991<br/>INFO:lightwood-69350:Loss @ epoch 46: 34.326259026160606<br/>INFO:lightwood-69350:Loss @ epoch 47: 34.32264416034405<br/>INFO:lightwood-69350:Loss @ epoch 48: 34.31824199969952<br/>INFO:lightwood-69350:Loss @ epoch 49: 34.31558961134691<br/>INFO:lightwood-69350:Loss @ epoch 50: 34.312175457294174<br/>INFO:lightwood-69350:Loss @ epoch 51: 34.30907880342924<br/>INFO:lightwood-69350:Loss @ epoch 52: 34.30618432851938<br/>INFO:lightwood-69350:Loss @ epoch 53: 34.30370506873498<br/>INFO:lightwood-69350:Loss @ epoch 54: 34.30031438974234<br/>INFO:lightwood-69350:Loss @ epoch 55: 34.29912596482497<br/>INFO:lightwood-69350:Loss @ epoch 56: 34.29673913808969<br/>INFO:lightwood-69350:Loss @ epoch 57: 34.294622274545524<br/>INFO:lightwood-69350:Loss @ epoch 58: 34.29275483351488<br/>INFO:lightwood-69350:Loss @ epoch 59: 34.291160583496094<br/>INFO:lightwood-69350:Loss @ epoch 60: 34.288580674391525<br/>INFO:lightwood-69350:Loss @ epoch 61: 34.288435422457184<br/>INFO:lightwood-69350:Loss @ epoch 62: 34.28676135723408<br/>INFO:lightwood-69350:Loss @ epoch 63: 34.28536576491136<br/>INFO:lightwood-69350:Loss @ epoch 64: 34.2841430077186<br/>INFO:lightwood-69350:Loss @ epoch 65: 34.283219850980316<br/>INFO:lightwood-69350:Loss @ epoch 66: 34.28125528188852<br/>INFO:lightwood-69350:Loss @ epoch 67: 34.281844505896935<br/>INFO:lightwood-69350:Loss @ epoch 68: 34.280723278339096<br/>INFO:lightwood-69350:Loss @ epoch 69: 34.279798654409554<br/>INFO:lightwood-69350:Loss @ epoch 70: 34.27906007033128<br/>INFO:lightwood-69350:Loss @ epoch 71: 34.27853628305289<br/>INFO:lightwood-69350:Loss @ epoch 72: 34.27686661940355<br/>INFO:lightwood-69350:Loss @ epoch 73: 34.27788866483248<br/>INFO:lightwood-69350:Loss @ epoch 74: 34.276988102839546<br/>INFO:lightwood-69350:Loss @ epoch 75: 34.27630556546725<br/>INFO:lightwood-69350:Loss @ epoch 76: 34.27573101337139<br/>INFO:lightwood-69350:Loss @ epoch 77: 34.275352478027344<br/>INFO:lightwood-69350:Loss @ epoch 78: 34.27378463745117<br/>INFO:lightwood-69350:Loss @ epoch 79: 34.27494137103741<br/>INFO:lightwood-69350:Loss @ epoch 1: 34.26769755146291<br/>INFO:lightwood-69350:Loss @ epoch 2: 34.247992751621965<br/>INFO:lightwood-69350:Loss @ epoch 3: 34.248576589150005<br/>INFO:lightwood-69350:Loss @ epoch 4: 34.24419905407594<br/>INFO:lightwood-69350:Loss @ epoch 5: 34.25551952701984<br/>DEBUG:lightwood-69350: `fit_mixer` runtime: 355.49 seconds<br/>INFO:lightwood-69350:Started fitting LGBM model<br/>INFO:lightwood-69350:A single GBM iteration takes 0.14085173606872559 seconds<br/>INFO:lightwood-69350:Training GBM (&lt;module 'optuna.integration.lightgbm' from '/home/teslim/test/lib/python3.8/site-packages/optuna/integration/lightgbm.py'&gt;) with 121450 iterations given 42766.44290494919 seconds constraint<br/>INFO:lightwood-69350:Lightgbm model contains 822 weak estimators<br/>INFO:lightwood-69350:Updating lightgbm model with 51.0 iterations<br/>INFO:lightwood-69350:Model now has a total of 823 weak estimators<br/>DEBUG:lightwood-69350: `fit_mixer` runtime: 134.86 seconds<br/>INFO:lightwood-69350:Fitting Linear Regression model<br/>INFO:lightwood-69350:Regression based correlation of: 0.3340088172833158<br/>DEBUG:lightwood-69350: `fit_mixer` runtime: 0.79 seconds<br/>INFO:lightwood-69350:Started fitting RandomForest model<br/>INFO:lightwood-69350:The number of trials (Optuna) is 20.<br/>INFO:lightwood-69350:RandomForest parameters of the best trial: {'num_estimators': 482, 'max_depth': 15, 'min_samples_split': 11, 'min_samples_leaf': 1, 'max_features': 0.7093681838916794}<br/>INFO:lightwood-69350:RandomForest based correlation of (train data): 0.3944169749039024<br/>INFO:lightwood-69350:RandomForest based correlation of (dev data): 0.3880994368278863<br/>DEBUG:lightwood-69350: `fit_mixer` runtime: 330.04 seconds<br/>INFO:lightwood-69350:Ensembling the mixer<br/>INFO:lightwood-69350:Mixer: Neural got accuracy: 0.0<br/>INFO:lightwood-69350:Mixer: LightGBM got accuracy: 0.55<br/>INFO:lightwood-69350:Mixer: Regression got accuracy: 0.0<br/>INFO:lightwood-69350:Mixer: RandomForest got accuracy: 0.0<br/>INFO:lightwood-69350:Picked best mixer: LightGBM<br/>DEBUG:lightwood-69350: `fit` runtime: 846.97 seconds<br/>INFO:lightwood-69350:[Learn phase 7/8] - Ensemble analysis<br/>INFO:lightwood-69350:Analyzing the ensemble of mixers<br/>INFO:lightwood-69350:The block ICP is now running its analyze() method<br/>INFO:lightwood-69350:The block ConfStats is now running its analyze() method<br/>INFO:lightwood-69350:The block AccStats is now running its analyze() method<br/>INFO:lightwood-69350:The block PermutationFeatureImportance is now running its analyze() method<br/>INFO:lightwood-69350:[PFI] Using a random sample (1000 rows out of 2501).<br/>INFO:lightwood-69350:[PFI] Set to consider first 10 columns out of 10: ['Suit_of_Card_1', 'Rank_of_Card_1', 'Suit_of_Card_2', 'Rank_of_Card_2', 'Suit_of_Card_3', 'Rank_of_Card_3', 'Suit_of_Card_4', 'Rank_of_Card_4', 'Suit_of_Card_5', 'Rank_of_Card_5'].<br/>DEBUG:lightwood-69350: `analyze_ensemble` runtime: 4.15 seconds<br/>INFO:lightwood-69350:[Learn phase 8/8] - Adjustment on validation requested<br/>INFO:lightwood-69350:Updating the mixers<br/>torch.cuda.amp.GradScaler is enabled, but CUDA is not available.  Disabling.<br/>INFO:lightwood-69350:Loss @ epoch 1: 34.25837150506214<br/>INFO:lightwood-69350:Loss @ epoch 2: 34.26038431488307<br/>INFO:lightwood-69350:Loss @ epoch 3: 34.259460753044195<br/>INFO:lightwood-69350:Loss @ epoch 4: 34.26046121647928<br/>INFO:lightwood-69350:Loss @ epoch 5: 34.260302923421946<br/>INFO:lightwood-69350:Model now has a total of 824 weak estimators<br/>INFO:lightwood-69350:Fitting Linear Regression model<br/>INFO:lightwood-69350:Regression based correlation of: 0.3338930435705283<br/>DEBUG:lightwood-69350: `adjust` runtime: 28.23 seconds<br/>DEBUG:lightwood-69350: `learn` runtime: 882.1 seconds</span></pre><p id="0142" class="pw-post-body-paragraph ky kz in la b lb nc ld le lf nd lh li lj ne ll lm ln nf lp lq lr ng lt lu lv ig bi translated">最后，我们可以使用经过训练的预测器进行一些预测:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="b24b" class="mf kb in mb b gy mg mh l mi mj">predictions = predictor.predict(pd.DataFrame({<br/>    'Suit_of_Card_1': [1, 2, 3],<br/>    'Rank_of_Card_1': [10, 11, 12],<br/>    'Suit_of_Card_2': [1, 2, 3],<br/>    'Rank_of_Card_2': [11, 13, 11],<br/>    'Suit_of_Card_3': [1, 2, 3],<br/>    'Rank_of_Card_3': [1, 2, 3],<br/>    'Suit_of_Card_4': [1, 2, 3],<br/>    'Rank_of_Card_4': [12, 12, 10],<br/>		'Suit_of_Card_5': [1, 2, 3],<br/>		'Rank_of_Card_5': [1, 1, 1]<br/>}))<br/>print(predictions)</span></pre><figure class="lw lx ly lz gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nj"><img src="../Images/7ca62fc713148107df55d71b1aee82a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-sedj0Q8NOPXCRMsACQM4g.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">使用定制模型混合器从我们的模型进行预测</figcaption></figure><p id="c8a3" class="pw-post-body-paragraph ky kz in la b lb nc ld le lf nd lh li lj ne ll lm ln nf lp lq lr ng lt lu lv ig bi translated">就是这样，使用您自己的定制混音器来解决 lightwood 的预测问题。</p><h1 id="df8b" class="ka kb in bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">下一步是什么？</h1><p id="852a" class="pw-post-body-paragraph ky kz in la b lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv ig bi translated">在自己尝试的同时享受乐趣！</p><ul class=""><li id="f84c" class="mk ml in la b lb nc lf nd lj nk ln nl lr nm lv mp mq mr ms bi translated">星<a class="ae jz" href="https://github.com/mindsdb/mindsdb" rel="noopener ugc nofollow" target="_blank"> <strong class="la io"> MindsDB 储存在 GitHub </strong> </a>上。</li><li id="41c0" class="mk ml in la b lb mt lf mu lj mv ln mw lr mx lv mp mq mr ms bi translated">注册一个<a class="ae jz" href="https://cloud.mindsdb.com/register?_ga=2.126448781.1875715573.1663498526-358045687.1658244666&amp;_gl=1*1us5k78*_ga*MzU4MDQ1Njg3LjE2NTgyNDQ2NjY.*_ga_7LGFPGV6XV*MTY2MzYwNjcxNi4zNi4xLjE2NjM2MDY3MzUuMC4wLjA" rel="noopener ugc nofollow" target="_blank"> <strong class="la io">免费 MindsDB 账户</strong> </a></li><li id="07a3" class="mk ml in la b lb mt lf mu lj mv ln mw lr mx lv mp mq mr ms bi translated">在<a class="ae jz" href="https://mindsdb.com/joincommunity?_ga=2.126448781.1875715573.1663498526-358045687.1658244666&amp;_gl=1*1us5k78*_ga*MzU4MDQ1Njg3LjE2NTgyNDQ2NjY.*_ga_7LGFPGV6XV*MTY2MzYwNjcxNi4zNi4xLjE2NjM2MDY3MzUuMC4wLjA" rel="noopener ugc nofollow" target="_blank"> <strong class="la io"> Slack </strong> </a>或<a class="ae jz" href="https://github.com/mindsdb/mindsdb/discussions" rel="noopener ugc nofollow" target="_blank"> <strong class="la io"> GitHub </strong> </a>上参与 MindsDB 社区，提出问题并分享您的想法和想法。</li></ul><p id="4b07" class="pw-post-body-paragraph ky kz in la b lb nc ld le lf nd lh li lj ne ll lm ln nf lp lq lr ng lt lu lv ig bi translated">如果本教程有帮助，请给个赞或评论</p></div></div>    
</body>
</html>