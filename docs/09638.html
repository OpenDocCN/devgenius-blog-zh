<html>
<head>
<title>Linux — What Happens When A Network Packet Arrives at Server</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Linux —当网络数据包到达服务器时会发生什么</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/linux-what-happens-when-a-network-packet-arrives-at-server-5139860b5466?source=collection_archive---------8-----------------------#2022-09-02">https://blog.devgenius.io/linux-what-happens-when-a-network-packet-arrives-at-server-5139860b5466?source=collection_archive---------8-----------------------#2022-09-02</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><div class=""/><div class=""><h2 id="8821" class="pw-subtitle-paragraph jo iq ir bd b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dk translated">Linux 如何处理到达网络的数据包</h2></div><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj kg"><img src="../Images/87cef08999345dc32281c9339749d46f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W8dBnJu56nCJPCJb8R2PLA.png"/></div></div></figure><p id="fc10" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">每天，我们通过不同的网络协议在服务器和外部互联网之间交换信息。但是你能解释当一个网络包到达你的服务器时会发生什么吗？让我们回顾一下本文中的过程。</p><p id="0f93" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">首先，MAC 报头将被取下，以查看该分组是否是给该服务器的。如果是，它将进一步取下 IP 报头。在获得目标 IP 后，它开始确定路由。</p><p id="b0bc" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">在路由判断之前，这个阶段叫做<strong class="ku is">预路由</strong>。如果发现该 IP 是服务器 IP，它会将数据包发送到较高的传输层。这个阶段叫做<strong class="ku is">输入</strong>。如果发现该 IP 不是服务器 IP，则需要转发该数据包。这个阶段叫做<strong class="ku is">前进</strong>。</p><p id="5c35" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">如果数据包属于服务器，上层处理完之后，一般会返回一个处理结果，这个处理结果会被发送出去。这个阶段叫做<strong class="ku is">输出</strong>。无论是<strong class="ku is">正向</strong>还是<strong class="ku is">输出</strong>，都发生在路由判断之后。最后一个阶段是<strong class="ku is">后路由</strong>。您可以在下图中看到整个过程:</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj lo"><img src="../Images/f3ada0e70060c98695ef8b16cad6632f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ec7XmtUw9NmS3w3VgZ-EzA.png"/></div></div></figure><p id="dc1c" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">乍一看，整个包加工流程还是和原来的流程一样，但是为什么要特别注意这五个阶段呢？</p><p id="6f81" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">是因为在 Linux 内核中，有一个框架叫做<strong class="ku is"> Netfilter </strong>。它可以在这些阶段插入钩子函数。这些功能可以拦截数据包并干预数据包。</p><p id="0e90" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">比如做一定的修改，然后决定是否交给 TCP/IP 协议栈处理；或者可以交回协议栈，也就是<strong class="ku is">接受</strong>；或者过滤后不再传输，也就是<strong class="ku is">掉线</strong>；和<strong class="ku is">队列</strong>，发送给某个用户态进程进行处理。</p><p id="a7f5" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">这是一个复杂的过程。常用于内部负载均衡，即进来的数据先传到目标地址 1，再传到目标地址 2，目标地址的数量和权重也可能发生变化。</p><p id="3b6a" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">协议栈往往无法处理如此复杂的逻辑，需要编写一个函数来接管数据并实现自己的逻辑。这就是<strong class="ku is"> Netfilter </strong>框架的作用，你可以随时干预 IP 转发的过程，只要你能实现这些钩子函数。</p><h1 id="fc1d" class="lp lq ir bd lr ls lt lu lv lw lx ly lz jx ma jy mb ka mc kb md kd me ke mf mg bi translated">iptables</h1><p id="6863" class="pw-post-body-paragraph ks kt ir ku b kv mh js kx ky mi jv la lb mj ld le lf mk lh li lj ml ll lm ln ik bi translated">一个众所周知的实现是内核模块<code class="fe mm mn mo mp b">ip_tables</code>。它在这五个阶段中嵌入了函数，以便根据规则处理数据包。</p><p id="6348" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">按功能可分为四类:连接跟踪(<code class="fe mm mn mo mp b">conntrack</code>)、包过滤(<code class="fe mm mn mo mp b">filter</code>)、网络地址转换(<code class="fe mm mn mo mp b">nat</code>)和包修改(<code class="fe mm mn mo mp b">mangle</code>)。其中，连接跟踪是基本功能，其他功能都依赖于它。另外三个可以实现包过滤、修改和网络地址转换。</p><p id="b35b" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">在用户模式下，还有一个你必须知道的客户端程序<code class="fe mm mn mo mp b">iptables</code>，它使用命令行来干扰内核的规则。</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj mq"><img src="../Images/d1fb7e6aaf896d4b8e8f08062e43626e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mlZeR9JYRaygK4pCUW2L7g.png"/></div></div></figure><p id="8add" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated"><code class="fe mm mn mo mp b">iptables</code>表有四种:<code class="fe mm mn mo mp b">raw</code> → <code class="fe mm mn mo mp b">mangle</code> → <code class="fe mm mn mo mp b">nat</code> → <code class="fe mm mn mo mp b">filter</code>。这四个优先级依次降低，raw 不常用，所以主要函数在另外三个表中实现。每个表可以设置多个链。</p><p id="8f4a" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated"><code class="fe mm mn mo mp b">iptables</code>有五种类型的链条:</p><ul class=""><li id="0360" class="mr ms ir ku b kv kw ky kz lb mt lf mu lj mv ln mw mx my mz bi translated"><code class="fe mm mn mo mp b">PREROUTING</code>:数据包进入路由前</li><li id="b85c" class="mr ms ir ku b kv na ky nb lb nc lf nd lj ne ln mw mx my mz bi translated"><code class="fe mm mn mo mp b">INPUT</code>:目的地址是这台电脑</li><li id="b8d4" class="mr ms ir ku b kv na ky nb lb nc lf nd lj ne ln mw mx my mz bi translated"><code class="fe mm mn mo mp b">FORWARD</code>:实施转发</li><li id="6905" class="mr ms ir ku b kv na ky nb lb nc lf nd lj ne ln mw mx my mz bi translated"><code class="fe mm mn mo mp b">OUTPUT</code>:原地址是本机，发出</li><li id="88e4" class="mr ms ir ku b kv na ky nb lb nc lf nd lj ne ln mw mx my mz bi translated"><code class="fe mm mn mo mp b">POSTROUTING</code>:发送到网卡前</li></ul><h2 id="1515" class="nf lq ir bd lr ng nh dn lv ni nj dp lz lb nk nl mb lf nm nn md lj no np mf nq bi translated">过滤器</h2><p id="5432" class="pw-post-body-paragraph ks kt ir ku b kv mh js kx ky mi jv la lb mj ld le lf mk lh li lj ml ll lm ln ik bi translated"><code class="fe mm mn mo mp b">filter</code>工作台处理过滤功能，主要由三个链组成:</p><ul class=""><li id="4b4a" class="mr ms ir ku b kv kw ky kz lb mt lf mu lj mv ln mw mx my mz bi translated">输入链:过滤所有目的地址为本地的数据包；</li><li id="9a3a" class="mr ms ir ku b kv na ky nb lb nc lf nd lj ne ln mw mx my mz bi translated">转发链:过滤所有通过机器的数据包；</li><li id="5aa3" class="mr ms ir ku b kv na ky nb lb nc lf nd lj ne ln mw mx my mz bi translated">输出链:过滤这台机器产生的所有数据包。</li></ul><h2 id="ffe5" class="nf lq ir bd lr ng nh dn lv ni nj dp lz lb nk nl mb lf nm nn md lj no np mf nq bi translated">精灵</h2><p id="16ca" class="pw-post-body-paragraph ks kt ir ku b kv mh js kx ky mi jv la lb mj ld le lf mk lh li lj ml ll lm ln ik bi translated"><code class="fe mm mn mo mp b">nat</code>表主要处理网络地址转换。它可以执行 Snat(改变数据包的源地址)和 Dnat(改变数据包的目的地址)，包括三个链:</p><ul class=""><li id="40a8" class="mr ms ir ku b kv kw ky kz lb mt lf mu lj mv ln mw mx my mz bi translated">预路由链:当数据包到达防火墙时，目的地址可以改变；</li><li id="1abb" class="mr ms ir ku b kv na ky nb lb nc lf nd lj ne ln mw mx my mz bi translated">输出链:可以改变本地生成的数据包的目的地址；</li><li id="022f" class="mr ms ir ku b kv na ky nb lb nc lf nd lj ne ln mw mx my mz bi translated">路由后链:当数据包离开防火墙时，改变它的源地址。</li></ul><h2 id="3e53" class="nf lq ir bd lr ng nh dn lv ni nj dp lz lb nk nl mb lf nm nn md lj no np mf nq bi translated">损坏</h2><p id="7eb9" class="pw-post-body-paragraph ks kt ir ku b kv mh js kx ky mi jv la lb mj ld le lf mk lh li lj ml ll lm ln ik bi translated">mangle 表主要是修改数据包，包括:</p><ul class=""><li id="63ae" class="mr ms ir ku b kv kw ky kz lb mt lf mu lj mv ln mw mx my mz bi translated">预路由链；</li><li id="507a" class="mr ms ir ku b kv na ky nb lb nc lf nd lj ne ln mw mx my mz bi translated">输入链；</li><li id="a0d0" class="mr ms ir ku b kv na ky nb lb nc lf nd lj ne ln mw mx my mz bi translated">正向链；</li><li id="e3e9" class="mr ms ir ku b kv na ky nb lb nc lf nd lj ne ln mw mx my mz bi translated">输出链；</li><li id="5998" class="mr ms ir ku b kv na ky nb lb nc lf nd lj ne ln mw mx my mz bi translated">路由后链。</li></ul><p id="c704" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">将 iptables 表和链添加到上面的流程图中，形成了下面的图和流程。</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj nr"><img src="../Images/02f0c3c6be1b07140d714a573ed5d743.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N1TwaR7nYzLVmOyXE7YF9A.png"/></div></div></figure><ul class=""><li id="5a5f" class="mr ms ir ku b kv kw ky kz lb mt lf mu lj mv ln mw mx my mz bi translated">当数据包进来时，使用<code class="fe mm mn mo mp b">mangle</code>表的预路由链。在这里你可以根据需要改变数据包头的内容，然后进入<code class="fe mm mn mo mp b">nat</code>表的 PREROUTING 链，在这里你可以根据需要做<code class="fe mm mn mo mp b">Dnat</code>，也就是目标地址翻译。</li><li id="7637" class="mr ms ir ku b kv na ky nb lb nc lf nd lj ne ln mw mx my mz bi translated">在进入路由判断时，需要确定是进入本地还是转发。</li><li id="a44b" class="mr ms ir ku b kv na ky nb lb nc lf nd lj ne ln mw mx my mz bi translated">如果是进入本地，进入<strong class="ku is">输入</strong>链，然后根据条件过滤器限制进入。</li><li id="aaf2" class="mr ms ir ku b kv na ky nb lb nc lf nd lj ne ln mw mx my mz bi translated">然后进入本地机，再进入<strong class="ku is">输出</strong>链，根据条件过滤掉，离开本地机。</li><li id="25dd" class="mr ms ir ku b kv na ky nb lb nc lf nd lj ne ln mw mx my mz bi translated">如果是转发，会进入<strong class="ku is">转发</strong>链，根据条件过滤限制转发。</li><li id="5505" class="mr ms ir ku b kv na ky nb lb nc lf nd lj ne ln mw mx my mz bi translated">然后进入<strong class="ku is"> POSTROUTING </strong>链，在这里可以做<code class="fe mm mn mo mp b">Snat</code>，离开网络接口。</li></ul><h1 id="2983" class="lp lq ir bd lr ls lt lu lv lw lx ly lz jx ma jy mb ka mc kb md kd me ke mf mg bi translated">处理数据包的四种方式</h1><ul class=""><li id="0c3c" class="mr ms ir ku b kv mh ky mi lb ns lf nt lj nu ln mw mx my mz bi translated"><strong class="ku is">接受</strong>允许数据包通过</li><li id="c60c" class="mr ms ir ku b kv na ky nb lb nc lf nd lj ne ln mw mx my mz bi translated"><strong class="ku is">丢弃</strong>直接丢弃数据包，不给出任何响应信息</li><li id="3365" class="mr ms ir ku b kv na ky nb lb nc lf nd lj ne ln mw mx my mz bi translated"><strong class="ku is">拒绝</strong>拒绝数据包通过，必要时会给数据发送方一个响应消息。</li><li id="3554" class="mr ms ir ku b kv na ky nb lb nc lf nd lj ne ln mw mx my mz bi translated"><strong class="ku is"> LOG </strong>在<code class="fe mm mn mo mp b">/var/log/messages</code>文件中记录日志消息，然后将数据包传递给下一个规则</li></ul></div></div>    
</body>
</html>