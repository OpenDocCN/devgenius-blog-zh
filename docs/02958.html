<html>
<head>
<title>Self-hosted send only Postfix SMTP server</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">自托管仅发送Postfix SMTP服务器</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/self-hosted-send-only-postfix-smtp-server-7c8c988677f6?source=collection_archive---------5-----------------------#2020-09-15">https://blog.devgenius.io/self-hosted-send-only-postfix-smtp-server-7c8c988677f6?source=collection_archive---------5-----------------------#2020-09-15</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/4a9d62cfdaf48c87baf932a44ae7d77a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ocOhQIqEiOAoQlc8-K_hOg.jpeg"/></div></div></figure><p id="99cd" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我需要为我的新项目发电子邮件。我首先探索了SaaS服务。他们提供的免费套餐有少量发送邮件。所以只要我是程序员，我就决定托管自己的发送邮件服务器。</p><p id="5aa1" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">经过一些研究，我决定继续使用Postfix只发送配置。继续阅读如何安装和配置SMTP服务器来发送电子邮件，而不是将它们发送到垃圾邮件文件夹。</p><h1 id="5cd4" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">先决条件</h1><p id="1d60" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">我用的是单核VPS和Ubuntu 18.04，每月只需2.5美元。我的主应用程序使用DB中的一个表作为电子邮件队列，所以我有两个NodeJS应用程序:一个处理队列，另一个获取交付状态并在主应用程序DB中更新它。如果你想看就告诉我。这里只是后缀部分。</p><p id="70d0" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我也有一个域名。让它在这里成为example.com。因为它将被用于一个网站，我用一个子域【email.example.com T2】作为邮件服务器。</p><h1 id="866b" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">后缀安装</h1><p id="7870" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">使用以下命令安装Postfix:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="f88e" class="mf ku in mb b gy mg mh l mi mj">sudo apt-get update<br/>sudo apt install mailutils</span></pre><p id="7be2" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">安装时，选择<strong class="jx io">网站</strong>选项进行邮件类型配置。作为<strong class="jx io">系统邮件名</strong>输入你的域名，例如example.com。<br/>稍后您可以使用以下命令查看域:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="e373" class="mf ku in mb b gy mg mh l mi mj">cat /etc/mailname</span></pre><h1 id="656f" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">服务器配置</h1><p id="4eef" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">用编辑器打开主配置文件:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="699e" class="mf ku in mb b gy mg mh l mi mj">sudo nano /etc/postfix/main.cf</span></pre><p id="91a6" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">找到<strong class="jx io"> inet_interfaces </strong>参数，将其更改为<strong class="jx io">仅环回</strong>。使用该参数，Postfix将不会侦听来自VPS外部的任何连接。</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="c6c8" class="mf ku in mb b gy mg mh l mi mj">inet_interfaces = loopback-only</span></pre><p id="b290" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在要更改的其他参数和值:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="768b" class="mf ku in mb b gy mg mh l mi mj">mydestination = $myhostname, localhost.$mydomain, localhost</span></pre><p id="783c" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">将您的邮件域设置为服务器主机名:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="7378" class="mf ku in mb b gy mg mh l mi mj">sudo hostnamectl set-hostname email.example.com</span></pre><p id="3473" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">使用命令检查主机名:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="d753" class="mf ku in mb b gy mg mh l mi mj">hostname --f</span></pre><p id="d4ed" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">编辑<strong class="jx io"> /etc/hosts </strong>文件，并使用您的远程IP地址添加该子域:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="7b39" class="mf ku in mb b gy mg mh l mi mj">1.2.3.4    email.example.com email</span></pre><p id="66e0" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">配置更改后重新启动Postfix的命令:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="52f6" class="mf ku in mb b gy mg mh l mi mj">sudo systemctl restart postfix</span></pre><p id="9d60" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">检查当前配置的命令:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="89ef" class="mf ku in mb b gy mg mh l mi mj">postconf -d</span></pre><h1 id="e875" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">创建DKIM签名</h1><p id="d52e" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">安装DKIM工具:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="0c15" class="mf ku in mb b gy mg mh l mi mj">sudo apt-get install opendkim opendkim-tools</span></pre><p id="6b2a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">将用户添加到组中:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="9402" class="mf ku in mb b gy mg mh l mi mj">sudo gpasswd -a postfix opendkim</span></pre><p id="4e40" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">打开配置文件/etc/opendkim.conf:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="6345" class="mf ku in mb b gy mg mh l mi mj">sudo nano /etc/opendkim.conf</span></pre><p id="7706" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">然后在配置文件中添加或更新以下参数:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="6c44" class="mf ku in mb b gy mg mh l mi mj">Socket              inet:8892@localhost<br/>Canonicalization    simple<br/>Mode                sv<br/>SubDomains          no<br/>AutoRestart         yes<br/>AutoRestartRate     10/1M<br/>Background          yes<br/>DNSTimeout          5<br/>SignatureAlgorithm  rsa-sha256<br/>UserID              opendkim<br/>KeyTable            refile:/etc/opendkim/key.table<br/>SigningTable        refile:/etc/opendkim/signing.table<br/>ExternalIgnoreList  /etc/opendkim/trusted.hosts<br/>InternalHosts       /etc/opendkim/trusted.hosts</span></pre><p id="8ffa" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">为DKIM密钥创建文件夹:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="84a5" class="mf ku in mb b gy mg mh l mi mj">sudo mkdir -p /etc/opendkim/keys</span></pre><p id="ea08" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">更改文件夹权限:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="66af" class="mf ku in mb b gy mg mh l mi mj">sudo chown -R opendkim:opendkim /etc/opendkim<br/>sudo chmod go-rw /etc/opendkim/keys</span></pre><p id="a315" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">创建opendkim签名表:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="76bf" class="mf ku in mb b gy mg mh l mi mj">sudo nano /etc/opendkim/signing.table</span></pre><p id="92d6" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">里面有内容:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="c8f0" class="mf ku in mb b gy mg mh l mi mj">*@example.com    default._domainkey.example.com</span></pre><p id="4b44" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">然后创建密钥表:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="0f03" class="mf ku in mb b gy mg mh l mi mj">sudo nano /etc/opendkim/key.table</span></pre><p id="a02d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">里面有内容:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="d898" class="mf ku in mb b gy mg mh l mi mj">default._domainkey.example.com     example.com:default:/etc/opendkim/keys/example.com/default.private</span></pre><p id="6e41" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">添加受信任的主机:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="449e" class="mf ku in mb b gy mg mh l mi mj">sudo nano /etc/opendkim/trusted.hosts</span></pre><p id="5747" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">里面有内容:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="7124" class="mf ku in mb b gy mg mh l mi mj">127.0.0.1<br/>localhost<br/>*.example.com</span></pre><p id="34fa" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">创建密钥文件夹:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="8ff7" class="mf ku in mb b gy mg mh l mi mj">sudo mkdir /etc/opendkim/keys/example.com</span></pre><p id="537e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">然后生成密钥:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="37ce" class="mf ku in mb b gy mg mh l mi mj">sudo opendkim-genkey -b 2048 -d example.com -D /etc/opendkim/keys/example.com -s default -v</span></pre><p id="ded5" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">更改私钥文件所有者:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="c765" class="mf ku in mb b gy mg mh l mi mj">sudo chown opendkim:opendkim /etc/opendkim/keys/example.com/default.private</span></pre><p id="3420" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">然后重新启动opendkim服务:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="372c" class="mf ku in mb b gy mg mh l mi mj">sudo service opendkim restart</span></pre><p id="65b3" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">检查密钥:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="b8fb" class="mf ku in mb b gy mg mh l mi mj">sudo opendkim-testkey -d example.com -s default -vvv</span></pre><p id="9466" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在在Postfix配置文件(/etc/postfix/main.cf)中添加或更新参数:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="2a1d" class="mf ku in mb b gy mg mh l mi mj">milter_default_action = accept<br/>milter_protocol = 2<br/>smtpd_milters = inet:localhost:8892<br/>non_smtpd_milters = inet:localhost:8892</span></pre><p id="5c97" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">然后重新启动Postfix:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="fd9b" class="mf ku in mb b gy mg mh l mi mj">sudo systemctl restart postfix</span></pre><h1 id="e8a0" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">DNS配置</h1><p id="6499" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">您需要配置一些DNS记录。通过这种配置，电子邮件服务不会将您的电子邮件视为垃圾邮件。</p><p id="30c4" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">为email.example.com添加记录:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="b3aa" class="mf ku in mb b gy mg mh l mi mj">Type: A<br/>Name: email.example.com<br/>Value: 1.2.3.4</span></pre><p id="80f2" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">添加SPF记录:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="563b" class="mf ku in mb b gy mg mh l mi mj">Type: TXT<br/>Name: example.com<br/>Value: v=spf1 mx ~all</span></pre><p id="da8a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">添加DMARC记录:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="76b7" class="mf ku in mb b gy mg mh l mi mj">Type: TXT<br/>Name: _dmarc<br/>Value: v=DMARC1; p=none</span></pre><p id="79bc" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">添加DKIM记录。使用以前生成的DKIM签名(/etc/open DKIM/keys/example . com/default . txt):</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="4a08" class="mf ku in mb b gy mg mh l mi mj">Type: TXT<br/>Name: default._domainkey<br/>Value: v=DKIM1; h=sha256; k=rsa; p=you-key-here-without-spaces</span></pre><p id="f644" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">设置PTR记录(rDNS)。你需要在你的主机提供商的控制面板中设置它。将email.example.com设置为主机名，将4.3.2.1.in-addr.arpa设置为IP地址。IP应该是相反的顺序。<br/>使用以下命令检查其设置是否正确:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="6a89" class="mf ku in mb b gy mg mh l mi mj">host 1.2.3.4</span></pre><h1 id="6413" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">电子邮件加密</h1><p id="c77f" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">安装证书机器人:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="129c" class="mf ku in mb b gy mg mh l mi mj">sudo apt install certbot</span></pre><p id="1f18" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">然后生成密钥:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="bc8a" class="mf ku in mb b gy mg mh l mi mj">sudo certbot certonly --standalone -d email.example.com</span></pre><p id="6592" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">配置Postfix以使用这些键。在/etc/postfix/main.cf中添加或编辑以下参数:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="7758" class="mf ku in mb b gy mg mh l mi mj">smtpd_tls_cert_file = /etc/letsencrypt/live/email.example.com/fullchain.pem<br/>smtpd_tls_key_file = /etc/letsencrypt/live/email.example.com/privkey.pem<br/>smtpd_tls_security_level=may<br/>smtp_tls_CApath=/etc/letsencrypt/live/email.example.com<br/>smtp_tls_security_level=may</span></pre><p id="27fc" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">然后重新启动Postfix:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="7f03" class="mf ku in mb b gy mg mh l mi mj">sudo service postfix restart</span></pre><h1 id="d26f" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">试验</h1><p id="5bd6" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">发送包含以下命令的测试电子邮件:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="e3fe" class="mf ku in mb b gy mg mh l mi mj">echo "This is the body of the email" | mail -r test@example.com -s "This is the subject" your_email@gmail.com</span></pre><p id="49b3" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">通过在线服务检查垃圾邮件分数，例如:【https://www.mail-tester.com/】T2(不是广告)。</p></div><div class="ab cl ml mm hr mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="ig ih ii ij ik"><p id="6b68" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="ms">原载于</em><a class="ae mk" href="https://bogomolov.tech/postfix-self-hosted-smtp/" rel="noopener ugc nofollow" target="_blank"><em class="ms">https://bogomolov . tech</em></a><em class="ms">。</em></p></div></div>    
</body>
</html>