<html>
<head>
<title>How to Customize Your Xcode Build Process</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何定制您的Xcode构建过程</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/how-to-customize-your-xcode-build-process-461749eacea4?source=collection_archive---------2-----------------------#2020-07-18">https://blog.devgenius.io/how-to-customize-your-xcode-build-process-461749eacea4?source=collection_archive---------2-----------------------#2020-07-18</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/fb79294d4da8f8a0549652f5bbe82f56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ft3HgOHLFehX8oFRZ8DZBA.jpeg"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">贾里德·阿兰戈在<a class="ae jz" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="0c26" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">当您点击<strong class="kc io"> ⌘B </strong>来构建您的项目时，Xcode会启动一个复杂的过程，从组成您的程序的一组文本文件、资源和配置文件开始，到生成一个可执行的应用程序结束。</p><p id="3dfa" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Xcode提供了使用<strong class="kc io">构建阶段</strong>部分中的<strong class="kc io">运行脚本阶段</strong>来运行用户定义的代码作为构建过程的一部分的可能性。构建阶段的可贵之处在于，您可以添加自己的阶段。</p><p id="9169" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">您可以添加一个<strong class="kc io">运行脚本阶段</strong>，它指示Xcode在构建的给定点运行命令行脚本，如Shell、Ruby或Python脚本。</p><p id="f6cc" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在本教程中，您将向项目中添加shell脚本，以:</p><ul class=""><li id="51c3" class="ky kz in kc b kd ke kh ki kl la kp lb kt lc kx ld le lf lg bi translated">确保所需的工具可用。</li><li id="29bc" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx ld le lf lg bi translated">使用版本、分支和提交哈希为您的应用程序图标添加水印。</li><li id="f747" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx ld le lf lg bi translated">将某些资源复制到特定的目标目录中。</li><li id="7e9d" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx ld le lf lg bi translated">如果预置描述文件即将过期，则发出警告。</li></ul><h1 id="d32c" class="lm ln in bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">确保所需工具可用</h1><p id="f146" class="pw-post-body-paragraph ka kb in kc b kd mk kf kg kh ml kj kk kl mm kn ko kp mn kr ks kt mo kv kw kx ig bi translated">运行脚本构建阶段的一个常见用途是将第三方工具集成到构建过程中。但是当开发人员的机器中没有这样的工具时会发生什么呢？</p><p id="13c0" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">让构建失败并通知您的新团队成员他们的设置未完成是一个好主意。</p><p id="707f" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如果没有安装<strong class="kc io"> Swiftlint </strong>，您的第一个脚本将显示一个警告或错误。</p><figure class="mq mr ms mt gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mp"><img src="../Images/027ef836a84d18d62d75190f9e6b5865.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*ESino6iAHCg5QtiDiK3GMg.gif"/></div></div></figure><p id="f496" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">您可以通过以下方式访问<strong class="kc io">构建阶段</strong>:</p><ol class=""><li id="fee3" class="ky kz in kc b kd ke kh ki kl la kp lb kt lc kx mu le lf lg bi translated">在主导航器窗格中选择您的应用程序。</li><li id="5994" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx mu le lf lg bi translated">选择主应用程序目标。</li><li id="900a" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx mu le lf lg bi translated">然后，从顶部的选项卡列表中选择<strong class="kc io">构建阶段</strong>。</li></ol><p id="d329" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">创建一个<strong class="kc io">新的运行脚本阶段</strong>及其下面的脚本。</p><figure class="mq mr ms mt gt jo"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="b3f9" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如果您喜欢警告而不是错误，请使用下面的脚本:</p><figure class="mq mr ms mt gt jo"><div class="bz fp l di"><div class="mv mw l"/></div></figure><h1 id="7fa1" class="lm ln in bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">修改您的应用程序图标</h1><p id="47ab" class="pw-post-body-paragraph ka kb in kc b kd mk kf kg kh ml kj kk kl mm kn ko kp mn kr ks kt mo kv kw kx ig bi translated">定制构建阶段的另一个有用的用途是用版本号、分支名称和提交散列向应用程序图标添加水印。</p><p id="c95a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">为此，添加一个<strong class="kc io">新的运行脚本阶段</strong>，在其中使用以下命令检索版本号、分支名称和提交散列:</p><figure class="mq mr ms mt gt jo"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="bc5a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">之后，您可以使用<strong class="kc io"> ImageMagick </strong>编辑应用图标。如需完整示例，请查看本文:<a class="ae jz" href="http://merowing.info/2013/03/overlaying-application-version-on-top-of-your-icon" rel="noopener ugc nofollow" target="_blank">http://Mero wing . info/2013/03/overlapping-application-version-on-top-of-your-icon</a></p><p id="eb0c" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">接下来，您将使用构建阶段将资源复制到特定的目标目录中。</p><h1 id="b9d2" class="lm ln in bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">管理您的应用资源</h1><p id="b731" class="pw-post-body-paragraph ka kb in kc b kd mk kf kg kh ml kj kk kl mm kn ko kp mn kr ks kt mo kv kw kx ig bi translated">想象一下，修复一个应用程序中的一个错误，该应用程序有一个很大的视频，每次启动该应用程序都会显示这个视频。😒很烦吧？！。</p><p id="c5b5" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">使用运行脚本，您可以根据当前活跃的配置控制Xcode将哪些文件拷贝到捆绑包，而无需创建新的目标。</p><p id="e0ca" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">为此，在您的根应用程序文件夹中创建<strong class="kc io"> RunScriptResources </strong>目录，并添加调试(短)和生产(长)splash视频，然后将下面的脚本添加到一个<strong class="kc io">新</strong> <strong class="kc io">运行脚本</strong> <strong class="kc io">阶段</strong>。</p><figure class="mq mr ms mt gt jo"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="f6e9" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">上面的脚本根据构建类型将特定的视频文件从您的<strong class="kc io"> RunScriptResources </strong>目录<strong class="kc io"> </strong>复制到app files目录。</p><p id="78b3" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">最后，在下一节中，您将使用<strong class="kc io">运行脚本阶段</strong>在您的配置文件即将到期时抛出警告。</p><h1 id="0d75" class="lm ln in bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">预置描述文件过期警告</h1><p id="c351" class="pw-post-body-paragraph ka kb in kc b kd mk kf kg kh ml kj kk kl mm kn ko kp mn kr ks kt mo kv kw kx ig bi translated">如果由于持续集成环境或任何其他原因，您没有使用Xcode的<strong class="kc io">自动管理签名</strong>功能和手动管理应用程序签名。</p><p id="fc27" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">运行脚本阶段</strong>定制Xcode构建过程并在预置描述文件过期前抛出警告或错误变得非常方便。</p><p id="20f3" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">重要的是要记住保持这些配置文件总是最新的，这样构建过程就不会在不适当的时候失败。</p><p id="01c5" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">例如，当您准备发布一个新的版本，但是由于预配概要文件过期而导致构建失败时。同时，您不能在远程构建机器上更新这个配置文件，因为管理员正在休假😩(这是我的亲身经历)。在这一点上，你开始重新思考你的签名过程🤔。</p><p id="c23a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">使用<strong class="kc io">自动管理签名</strong>功能总是更好，但是如果那不是一个选项，<strong class="kc io">运行脚本阶段</strong>是你的救星。</p><p id="338c" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">创建一个新的<strong class="kc io">运行脚本</strong> <strong class="kc io">阶段</strong>并添加以下脚本:</p><figure class="mq mr ms mt gt jo"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="2e17" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">下面是上述代码中每个带编号的注释所发生的情况:</p><ol class=""><li id="423b" class="ky kz in kc b kd ke kh ki kl la kp lb kt lc kx mu le lf lg bi translated">从预配描述文件plist中提取名称和到期日期。</li><li id="a957" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx mu le lf lg bi translated">将到期日期转换为YYYYMMDD格式。</li><li id="7f83" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx mu le lf lg bi translated">生成当前日期和当前日期+15天。</li><li id="875c" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx mu le lf lg bi translated">生成当前日期名称并检查是否不是周末(你不想在管理员空闲的时候打扰他们，对吗🤨？！).</li><li id="d048" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx mu le lf lg bi translated">如果今天+15天大于或等于描述文件到期日，Xcode将显示警告。</li></ol><p id="109a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">或者您可以告诉Xcode显示错误并停止构建过程。</p><figure class="mq mr ms mt gt jo"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="b1e9" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">真棒🥳，没有更多的建设将失败，由于配置文件。</p><p id="14da" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">接下来，您将学习一些创建和维护脚本的技巧😎。</p><h1 id="987f" class="lm ln in bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">运行脚本阶段提示</h1><p id="1b9b" class="pw-post-body-paragraph ka kb in kc b kd mk kf kg kh ml kj kk kl mm kn ko kp mn kr ks kt mo kv kw kx ig bi translated">与所有软件一样，运行脚本阶段通常不会在第一次尝试时就出现(<em class="mx">至少对我来说不是</em>)。这里有四个建议:</p><h2 id="ea70" class="my ln in bd lo mz na dn ls nb nc dp lw kl nd ne ma kp nf ng me kt nh ni mi nj bi translated">命名您的脚本</h2><p id="72d5" class="pw-post-body-paragraph ka kb in kc b kd mk kf kg kh ml kj kk kl mm kn ko kp mn kr ks kt mo kv kw kx ig bi translated">Xcode会将每个新的运行脚本阶段命名为<em class="mx">运行脚本</em>，但是当您有多个阶段时，这可能会很混乱。双击运行脚本标题以显示一个文本字段，您可以使用它来重命名您的阶段。</p><h2 id="6030" class="my ln in bd lo mz na dn ls nb nc dp lw kl nd ne ma kp nf ng me kt nh ni mi nj bi translated"><strong class="ak">提取脚本</strong></h2><p id="ae77" class="pw-post-body-paragraph ka kb in kc b kd mk kf kg kh ml kj kk kl mm kn ko kp mn kr ks kt mo kv kw kx ig bi translated">在这样大小的文本区域中编写和编辑脚本并不理想。</p><figure class="mq mr ms mt gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nk"><img src="../Images/ff1ec9d4993ebc54f6ac1e6dc7d242c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZUEFCMbMA8JpT1V7AKyOAQ.png"/></div></div></figure><p id="53b6" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">更糟糕的是Git跟踪项目文件中脚本的方式。当你或你的队友做出改变时，很难回顾它们。</p><figure class="mq mr ms mt gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nl"><img src="../Images/65231468a83c2abcf4bb17e429ad2a9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rNAJS6hcnsvULLnIKhybXA.png"/></div></div></figure><p id="4f76" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">要改进您的构建脚本，请将它们提取到外部文件中。</p><p id="69ab" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在项目的根目录下创建一个<strong class="kc io"> BuildPhases </strong>目录，然后创建<code class="fe nm nn no np b">check_provisioning_profile_script.sh</code>文件。从您之前创建的Xcode构建阶段编辑器中复制它的内容。</p><p id="244b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">然后，通过在终端中使用下面的命令<a class="ae jz" href="https://bash.cyberciti.biz/guide/Setting_up_permissions_on_a_script" rel="noopener ugc nofollow" target="_blank">改变它的权限</a>，使您的脚本可执行:</p><figure class="mq mr ms mt gt jo"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="9174" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">最后，您可以用执行脚本的命令替换Xcode构建阶段编辑器中的脚本内容:</p><p id="489e" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><code class="fe nm nn no np b">$SRCROOT/BuildPhases/check_provisioning_profile_script.sh</code></p><figure class="mq mr ms mt gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nq"><img src="../Images/4646f8103fd390f7ae64b6b7558569f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1lHiWUvb7lXEzJxfprvlgg.png"/></div></div></figure><p id="d784" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">太好了，现在你和你的队友将编辑脚本本身，而不是<code class="fe nm nn no np b">project.pbxproj.</code>阅读或审查脚本变得更加容易👍🏽。</p><h2 id="4ec5" class="my ln in bd lo mz na dn ls nb nc dp lw kl nd ne ma kp nf ng me kt nh ni mi nj bi translated">报告错误</h2><p id="2617" class="pw-post-body-paragraph ka kb in kc b kd mk kf kg kh ml kj kk kl mm kn ko kp mn kr ks kt mo kv kw kx ig bi translated">您可以使用<code class="fe nm nn no np b">echo "error: message"</code>和<code class="fe nm nn no np b">echo "warning: message"</code>来记录额外信息。这将帮助您调试脚本中的问题。</p><h2 id="adb3" class="my ln in bd lo mz na dn ls nb nc dp lw kl nd ne ma kp nf ng me kt nh ni mi nj bi translated">显示环境变量</h2><figure class="mq mr ms mt gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nq"><img src="../Images/f945340a4a614dd2bbae6e06296cbb2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U44nfXMEryIR443NZSJjfg.png"/></div></div></figure><p id="95dc" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">确保<strong class="kc io">在构建日志中显示环境变量</strong>复选框处于激活状态。如果构建失败，这将使Xcode打印所有环境变量的值，并且您将能够验证您对这些变量所做的假设是否正确。</p><h1 id="0842" class="lm ln in bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">从这里去哪里？</h1><p id="86c2" class="pw-post-body-paragraph ka kb in kc b kd mk kf kg kh ml kj kk kl mm kn ko kp mn kr ks kt mo kv kw kx ig bi translated"><strong class="kc io">运行脚本阶段</strong>是非常有用的Xcode工具。它帮助您自动化许多任务，提高代码库的质量，并使您的团队生活更轻松。</p><p id="bbcf" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">学习如何编写Bash脚本。Ryan的教程网站是一个学习它的好地方，它是一系列小而容易管理的步骤。</p><p id="a100" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我希望你喜欢这个教程。如果你有任何问题或意见，请写在这里🤗。</p></div></div>    
</body>
</html>