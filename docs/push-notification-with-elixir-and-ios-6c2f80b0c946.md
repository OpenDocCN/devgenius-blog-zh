# 使用 Elixir/Phoenix 和 iOS 推送通知

> 原文：<https://blog.devgenius.io/push-notification-with-elixir-and-ios-6c2f80b0c946?source=collection_archive---------0----------------------->

![](img/200db2ca2bf2e2e0cb748ef56d732ac8.png)

在过去的一周里，我正在尝试为 iOS 和 Android 实现推送通知。对于 android 来说，这真的很容易，但是为了在 iOS 中实现，这需要一点努力，并且对它使用的概念不太清楚。

我们将在原生 ios 应用中实现这一点。如果你想在 iOS 上设置 Firebase 云消息客户端应用程序，请遵循本教程。

> [https://www . impose . so/Push-Notification-with-Elixir-and-iOS-20 e 00 a1 ea 1914 e 919 a 10 f 92 c8 d0a 04 ff # d8e 828679 ba 34 e 5 fa 9a 366 EFC 9 ddf 467](https://www.notion.so/Push-Notification-with-Elixir-and-iOS-20e00a1ea1914e919a10f92c8d0a04ff#d8e828679ba34e5fa9a366efc9ddf467)

**什么是推送通知？**

推送通知是在移动设备上弹出的消息。App 发行商可以随时发送；用户不必在应用程序中或使用他们的设备来接收它们。他们可以做很多事情；例如，它们可以显示最新的体育比分，让用户采取任何行动，如下载优惠券，或让用户了解某个事件，如闪购。

推送通知看起来像短信和移动提醒，但它们只适用于安装了你的应用的用户。每个移动平台都支持推送通知——iOS、Android、Fire OS、Windows 和 BlackBerry 都有自己的服务。

**先决条件**

安装以下组件

*   Xcode

确保您的项目满足这些要求:

*   您的项目必须面向 iOS 8 或更高版本。

设置一个物理 iOS 设备来运行您的应用程序，并完成以下任务:

*   为您的[苹果开发者账户](https://developer.apple.com/account)获取一个苹果推送通知认证密钥。
*   在 XCode 中启用 **App >功能**下的推送通知。

**什么是 APNS？**

Apple 推送通知服务(APNs)是一种云服务，允许安装在 Apple 设备上的经批准的第三方应用程序通过安全连接从远程服务器向用户发送推送通知。

推送通知在移动设备上很受欢迎，因为它们可以节省电池寿命。对于拉式通知，移动应用程序需要不断轮询开发人员的服务器，每隔几分钟连接一次，以确定是否有新信息可用。然而，对于推送通知，云服务代表应用程序行事，仅在有新通知时连接到移动设备。如果设备已开机，但应用程序未运行，该服务仍会转发通知。如果发送通知时设备已关机，服务将保留该消息，稍后再试。

若要接收 APNs 推送通知，应用程序必须正确配置并注册到 Apple 推送通知服务(APNs)。

**配置 APN**

要通过 APN 发送推送通知，您需要:

*   Apple 开发者帐户的 Apple 推送通知鉴定密钥。
*   该应用程序 ID 的预置描述文件。

> *创建认证密钥*

本节介绍如何为启用推送通知的应用 ID 生成身份验证密钥。如果您有一个现有的密钥，您可以使用该密钥，而不是生成一个新的密钥。

> 要创建认证密钥，请执行以下操作:

1.  在你的开发者账户中，进入**证书，标识符&配置文件**，在**键**下，选择**全部**。
2.  点击右上角的**添加**按钮(+)。
3.  输入 APNs 身份验证密钥的描述
4.  在**关键服务**下，选中 APNs 复选框，点击**继续**。
5.  点击**确认**，然后**下载**。将您的密钥保存在安全的地方。这是一次性下载，以后无法检索密钥。

如果您想要验证您的 APNs 认证密钥是否设置正确并且被 APNs 接受，请尝试发送测试推送通知。

> *创建一个应用 ID，我们为什么需要它？*

应用 ID 是唯一标识应用的标识符。作为惯例，用一个反转的域来表示(例如`in.aplombtech`)。

如果您已经有一个想要使用的应用 ID，请确保它是一个显式的应用 ID(不包含通配符),并跳过此部分。

1.  导航到[苹果开发者会员中心](https://developer.apple.com/membercenter/index.action)并登录。
2.  导航到**证书、标识符和配置文件**。
3.  在左上角的下拉菜单中，选择 **iOS、tvOS、watchOS** 如果尚未选择，则导航至**标识符>应用 id**。
4.  点击 **+** 按钮，创建一个新的应用 ID。

请遵循以下原则:

```
[https://firebase.google.com/docs/cloud-messaging/ios/certs#create_an_app_id](https://firebase.google.com/docs/cloud-messaging/ios/certs#create_an_app_id)
```

为什么我们需要一个应用 ID？

应用 ID 是用于指定一个或一组应用的字符串。应用 ID 的主要用途是指定哪些应用被授权签名和启动。您可以配置应用程序 ID 以在应用程序之间共享数据，并使应用程序能够使用 Apple 推送通知服务(APNS)。

一个应用程序 ID 有两个部分:团队 ID，后跟捆绑包 ID 搜索字符串。球队 ID 是由 Apple 生成的 10 个字符的字符串。每个开发团队都分配有一个唯一的团队 ID，用于识别您的所有应用。团队 ID 允许您在应用程序之间共享钥匙串数据。具有相同团队 ID 的应用程序可以共享数据，如用户名和密码。束 ID 搜索字符串传统上是反向域名样式的字符串。它是您在 Xcode 中用作包 ID 的字符串。

![](img/9748a94a49581867ccffe2962be4d385.png)

这都是来自客户端。让我们也从服务器端讨论一些事情。

**凤凰 App**

让我们从在 Phoenix 中创建一个服务器端应用程序开始。这是命令

```
mix phx.new push_notification — no-webpack — no-html
```

这将创建一个基于 API 的应用程序和基本上更少的文件来编译。现在我们需要一个名为[鸽子](https://hexdocs.pm/pigeon/api-reference.html#content)的库。

Pigeon 是一个符合 HTTP2 的包装器，用于发送 iOS 和 Android 推送通知。

让我们将它添加到 mix.exs 文件中。

```
{:pigeon, “~> 1.5.1”}, {:kadabra, “~> 0.4.4”}
```

运行 mix deps.get，它将使用这两个额外的依赖项重新编译所有文件。

对 APNS 来说，鸽子有两种用途。在这里了解[。但是我们将使用基于令牌的认证。继续将它添加到您的配置中。](https://hexdocs.pm/pigeon/apns-apple-ios.html#content)

```
config :pigeon, :apns,
   apns_default: %{
    key: "AuthKey.p8",
    key_identifier: "ABC1234567",
    team_id: "DEF8901234",
    mode: :dev }
```

*   **:key** —通过你的开发者账号创建并下载。这将是您的身份验证密钥。
*   : **key_identifier** —当您下载密钥时，它看起来会像这样 *AuthKey_BKQZPQ9374.p8\.* 所以基本上 *BKQZPQ9374* 将是一个 key_identifier。
*   **:team_id** —您的 10 个字符的团队 id，从您的开发者帐户获得。如果你仍然对此感到困惑，请查看这里的。

当你得到认证密钥时，确保你已经像这样把它添加到你的`priv/cert/AuthKey_BKQZPQ9374.p8`中。之后，您可以在配置文件中给出您的密钥的路径。

这就是服务器端的情况。

现在，要发送通知，您只需要一个设备令牌。现在让我们创建一个设备令牌。不要将其与不同的身份验证密钥混淆。因此，要在客户端获得一个新令牌，你需要为 iOS 创建一个本地应用。

对于本教程，我使用的是 swift 版本 5.2.2。要检查您使用的版本，只需运行以下命令

```
xcrun swift — version
```

现在打开 Xcode 创建一个你想用的名字的应用程序。我的应用程序使用了 push_notification。

**请求设备令牌**

每次启动应用程序时，都应该执行两个步骤:从用户处获得通知权限，并向 APN 索要设备令牌。对于前一个请求，您可以通过 UIUserNotificationSettings 构造函数指定您需要对哪些通知拥有权限。简单补充一下。声音，。警报，和/或。徽章，如下例所示(省略您不感兴趣的类型)。如前所述，每次启动都调用这些请求似乎有些过分，尽管这是您的代码所期望的。根据 Apple 文档:

> **注册用户通知设置:**

*   如果您的应用程序显示提醒、播放声音或标记其图标，您必须在启动周期中调用此方法，以请求以这些方式提醒用户的权限。
*   你的应用程序第一次启动并调用这个方法时，系统会询问用户是否允许你的应用程序发送通知并存储响应。此后，系统使用存储的响应来确定您可能使用的实际通知类型。

> **注册通知:**

*   设备令牌可能会更改，因此您的应用程序每次启动时都需要重新注册。
*   如果您的应用程序之前已经注册，调用 registerForRemoteNotifications 会导致操作系统立即将设备令牌传递给委托，而不会产生额外的开销。

转到 AppDelegate.swift

设备令牌请求的成功和失败发生在 AppDelegate 中，然后调用***register for remotenotifications***

***didregisterforremotentificationswidevicetoken***是接收设备令牌并将其上传到应用程序服务的地方。还有一个例子展示了我如何将二进制设备令牌转换成 APN 所期望的字符串格式。

**接收推送通知**

根据手机/应用程序状态(假设用户已允许应用程序的通知，并且消息不是“静默/后台通知”)，用户不会看到静默通知，但会导致应用程序开始在后台运行自定义代码。非静默后台通知做同样的事情，但是警告显示给用户。

请确定您已经在 Xcode >签名和功能中添加了此内容

![](img/342f38019af280da3f614414c0b9eac0.png)

现在只需构建您的代码。您将获得一个设备令牌，我们将在服务器端使用它来发送通知。

> 让我们回到[鸽子](https://github.com/codedge-llc/pigeon)

现在，您有了一个来自客户端的设备令牌。此外，您还拥有我在上面展示的密钥、密钥标识符和团队 id。

现在让我们运行您的服务器

> iex -S mix phx.server

```
iex> n = Pigeon.APNS.Notification.new("siddhant singh", "your device token", "your push topic")
```

这里第一个参数是你想要发送的信息。您刚刚从客户端获得的设备令牌和第三个参数，您可以将您的捆绑包 id。

现在你必须传递信息

```
iex> Pigeon.APNS.push(n)
```

这将在服务器端给您这样的响应

如你所见，你在这里得到了成功的回应。如果你做错了什么，它会给你一些不同的错误。

最终，iOS 手机上的响应会是这样的。

![](img/3e20da02066ecf7fd3d84adc0a2d65ce.png)

就是它了！

这个特性自己实现的时候真的很有意思。试试吧，让我知道你觉得什么有趣:)