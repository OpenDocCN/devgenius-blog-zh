<html>
<head>
<title>URL Shortener System Design</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">网址缩写系统设计</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/url-shortener-system-design-eb2d246a7f96?source=collection_archive---------3-----------------------#2022-06-05">https://blog.devgenius.io/url-shortener-system-design-eb2d246a7f96?source=collection_archive---------3-----------------------#2022-06-05</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><blockquote class="jk jl jm"><p id="e47d" class="jn jo jp jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ig bi translated">功能需求</p></blockquote><ul class=""><li id="8cdb" class="km kn in jq b jr js jv jw ko kp kq kr ks kt kl ku kv kw kx bi translated">收到长 url 时获取短 URL。</li><li id="c79b" class="km kn in jq b jr ky jv kz ko la kq lb ks lc kl ku kv kw kx bi translated">收到短 url 时重定向/获取长 url。</li><li id="a129" class="km kn in jq b jr ky jv kz ko la kq lb ks lc kl ku kv kw kx bi translated">除域名外，URL 的长度应为 7。</li></ul><blockquote class="jk jl jm"><p id="e555" class="jn jo jp jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ig bi translated">非功能性需求</p></blockquote><ul class=""><li id="de03" class="km kn in jq b jr js jv jw ko kp kq kr ks kt kl ku kv kw kx bi translated">高度可用。</li><li id="cc6c" class="km kn in jq b jr ky jv kz ko la kq lb ks lc kl ku kv kw kx bi translated">超低延迟</li><li id="cddb" class="km kn in jq b jr ky jv kz ko la kq lb ks lc kl ku kv kw kx bi translated">此用例不考虑 TTL 支持。</li></ul><blockquote class="jk jl jm"><p id="defd" class="jn jo jp jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ig bi translated">规模</p></blockquote><p id="2954" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy ko ka kb kc kq ke kf kg ks ki kj kk kl ig bi translated">考虑到我们是为 twitter/linkedin 这样的平台设计的:</p><ul class=""><li id="eec1" class="km kn in jq b jr js jv jw ko kp kq kr ks kt kl ku kv kw kx bi translated">每月 3 亿活跃用户。</li><li id="4f34" class="km kn in jq b jr ky jv kz ko la kq lb ks lc kl ku kv kw kx bi translated">10%会使用该功能=每月 3000 万。</li><li id="3244" class="km kn in jq b jr ky jv kz ko la kq lb ks lc kl ku kv kw kx bi translated">每天 100 万。</li><li id="6a44" class="km kn in jq b jr ky jv kz ko la kq lb ks lc kl ku kv kw kx bi translated">每天支持 10 到 1000 万次的能力。</li></ul><blockquote class="jk jl jm"><p id="102a" class="jn jo jp jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ig bi translated">信息容量</p></blockquote><p id="ae72" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy ko ka kb kc kq ke kf kg ks ki kj kk kl ig bi translated">我们将存储:</p><ul class=""><li id="627f" class="km kn in jq b jr js jv jw ko kp kq kr ks kt kl ku kv kw kx bi translated">长 URL — 2 KB = 2048 个字符。</li><li id="f7dc" class="km kn in jq b jr ky jv kz ko la kq lb ks lc kl ku kv kw kx bi translated">短 URL — 17 B</li><li id="fdaf" class="km kn in jq b jr ky jv kz ko la kq lb ks lc kl ku kv kw kx bi translated">创建于公元前 7 世纪</li><li id="0087" class="km kn in jq b jr ky jv kz ko la kq lb ks lc kl ku kv kw kx bi translated">在— 7 B 到期</li></ul><p id="f2f8" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy ko ka kb kc kq ke kf kg ks ki kj kk kl ig bi translated">总计= 2.03 KB/条目</p><blockquote class="jk jl jm"><p id="1172" class="jn jo jp jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ig bi translated">端点</p></blockquote><h2 id="021f" class="ld le in bd lf lg lh dn li lj lk dp ll ko lm ln lo kq lp lq lr ks ls lt lu lv bi translated">公共端点</h2><ul class=""><li id="4e7a" class="km kn in jq b jr lw jv lx ko ly kq lz ks ma kl ku kv kw kx bi translated">/shorten_url <br/>输入:long_url <br/>输出:short_url，expires_at <br/> curl 命令:curl-X POST http://&lt;host&gt;:&lt;port&gt;/shorten _ URL-H " Content-Type:application/JSON "-d ' " long _ URL ":" https://a _ very _ log _ URL _ to _ be _ shorted _ 0311 . com " } '</li><li id="6251" class="km kn in jq b jr ky jv kz ko la kq lb ks lc kl ku kv kw kx bi translated">/fetch_original_url <br/>输入:short_url <br/>输出:long_url，状态<br/> curl 命令:curl-X GET http://&lt;host&gt;:&lt;port&gt;/fetch _ URL-H " Content-Type:application/JSON "-d ' " " short _ URL ":" https://bitly . com/868 dg85 " } '</li></ul><h2 id="b20b" class="ld le in bd lf lg lh dn li lj lk dp ll ko lm ln lo kq lp lq lr ks ls lt lu lv bi translated">内部端点[在 VPN 内]</h2><p id="3b7a" class="pw-post-body-paragraph jn jo in jq b jr lw jt ju jv lx jx jy ko mb kb kc kq mc kf kg ks md kj kk kl ig bi translated">目前没有</p><p id="a76a" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy ko ka kb kc kq ke kf kg ks ki kj kk kl ig bi translated">注意:这里似乎也不需要登录和注销端点。</p><blockquote class="jk jl jm"><p id="413b" class="jn jo jp jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ig bi translated">选择编码算法</p></blockquote><h2 id="ff71" class="ld le in bd lf lg lh dn li lj lk dp ll ko lm ln lo kq lp lq lr ks ls lt lu lv bi translated">MD5 哈希</h2><ul class=""><li id="1763" class="km kn in jq b jr lw jv lx ko ly kq lz ks ma kl ku kv kw kx bi translated">采用长 url 并生成 22–25 个字符长的随机字符串的函数。</li><li id="f7ac" class="km kn in jq b jr ky jv kz ko la kq lb ks lc kl ku kv kw kx bi translated">我们需要选择前 7 个字符来获得我们的短网址。</li><li id="ce83" class="km kn in jq b jr ky jv kz ko la kq lb ks lc kl ku kv kw kx bi translated">7 个字符，因为这就是我们的短 url 的长度。</li><li id="217f" class="km kn in jq b jr ky jv kz ko la kq lb ks lc kl ku kv kw kx bi translated">碰撞的几率很高。意味着不同的 URL 的前 7 个字符在很多情况下是相同的。</li></ul><h2 id="d8b6" class="ld le in bd lf lg lh dn li lj lk dp ll ko lm ln lo kq lp lq lr ks ls lt lu lv bi translated">Base 62 编码</h2><ul class=""><li id="6f2b" class="km kn in jq b jr lw jv lx ko ly kq lz ks ma kl ku kv kw kx bi translated">基数 62 基本上意味着 o/p 由 62 个字符组成:a-z、A-Z 和 0-9。</li><li id="e728" class="km kn in jq b jr ky jv kz ko la kq lb ks lc kl ku kv kw kx bi translated">这也是一个函数，它接受一个随机数并给出一个长度为 7 的 base 62 字符串。</li><li id="855e" class="km kn in jq b jr ky jv kz ko la kq lb ks lc kl ku kv kw kx bi translated">随机数需要大于 62⁷，以生成 7 个字符长的字符串。</li><li id="fe3e" class="km kn in jq b jr ky jv kz ko la kq lb ks lc kl ku kv kw kx bi translated">下面给出了 base 62 编码的实现。</li><li id="39eb" class="km kn in jq b jr ky jv kz ko la kq lb ks lc kl ku kv kw kx bi translated">碰撞是最小的，因为 2.5 万亿个组合是可能的。</li></ul><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi me"><img src="../Images/aabe2a47fd2d8d2fece6169a52de8653.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*81zyI9pv1wITIByXUsBOxg.png"/></div></div></figure><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mq"><img src="../Images/62e07a43f9e991c31d4673ef9c81fe59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CWyazSZmOryx0ZKR3Wicsw.png"/></div></div></figure><blockquote class="jk jl jm"><p id="b554" class="jn jo jp jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ig bi translated">数据库模式和数据库选择</p></blockquote><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mr"><img src="../Images/9623d1c5e657b4256d1a827f9000d554.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TR3PKpyB4ePEt8ta18MshA.png"/></div></div></figure><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi ms"><img src="../Images/2d4ed14e5d65c1d28c0fcd84d32ab402.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rVDiE-fiiSsaD_zVShY7nQ.png"/></div></div></figure><blockquote class="jk jl jm"><p id="ee49" class="jn jo jp jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ig bi translated">活动的时间表</p></blockquote><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mt"><img src="../Images/6b6056161a297930497d239d73335cfe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MgEprmreXpuVeTfvz6VvKA.png"/></div></div></figure><blockquote class="jk jl jm"><p id="c171" class="jn jo jp jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ig bi translated">问题</p></blockquote><h2 id="06ec" class="ld le in bd lf lg lh dn li lj lk dp ll ko lm ln lo kq lp lq lr ks ls lt lu lv bi translated">下面列出了可能出现的问题:</h2><ul class=""><li id="8e6f" class="km kn in jq b jr lw jv lx ko ly kq lz ks ma kl ku kv kw kx bi translated">如果为之前的请求生成了相同的随机数，则每个请求有多个 DB 调用。</li><li id="0f1b" class="km kn in jq b jr ky jv kz ko la kq lb ks lc kl ku kv kw kx bi translated">为了解决可伸缩性问题，我们将有多个 web 服务器，但是跨 web 服务器生成相同随机数的机会增加了。</li><li id="df93" class="km kn in jq b jr ky jv kz ko la kq lb ks lc kl ku kv kw kx bi translated">如果 DB 中的条目数量增加，检查是否已经生成短 URL 的查询将会变慢。</li><li id="4240" class="km kn in jq b jr ky jv kz ko la kq lb ks lc kl ku kv kw kx bi translated">如果数据库中的条目数量增加，为给定的短 URL 获取长 URL 的查询将会变慢。</li></ul><h2 id="f53f" class="ld le in bd lf lg lh dn li lj lk dp ll ko lm ln lo kq lp lq lr ks ls lt lu lv bi translated">有序解决方案</h2><ul class=""><li id="7a39" class="km kn in jq b jr lw jv lx ko ly kq lz ks ma kl ku kv kw kx bi translated">如果我们可以生成增量随机数，我们可以避免单个 web 服务器中的冲突，并且如果短 URL 已经被采用，我们也可以跳过检查 DB，因为我们知道它是一个增量随机数</li><li id="6ead" class="km kn in jq b jr ky jv kz ko la kq lb ks lc kl ku kv kw kx bi translated">如果我们能有一个集中的柜台服务，应要求提供随机数，我们就能避免网络服务器之间的冲突。</li><li id="9cf7" class="km kn in jq b jr ky jv kz ko la kq lb ks lc kl ku kv kw kx bi translated">我们可以有一个 redis 形式的键值存储，可以存储 long_url:short_url 和 short_url:long_url。TTL 将等于我们想要支持的持续时间。</li><li id="0b79" class="km kn in jq b jr ky jv kz ko la kq lb ks lc kl ku kv kw kx bi translated">前一点中的 redis 解决了这个问题。</li></ul><blockquote class="jk jl jm"><p id="63b4" class="jn jo jp jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ig bi translated">HLD —尝试 1</p></blockquote><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mu"><img src="../Images/e31bd6afe6259eddcc61b0c090f55a9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9iCyrRd4MLKNnUhQ93-23A.png"/></div></div></figure><p id="7c98" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy ko ka kb kc kq ke kf kg ks ki kj kk kl ig bi translated">这里的问题是，如果计数器服务关闭，那么它将成为一个 SPOF，而且由于它是一个内存中的服务，冲突问题将得到支持。</p><blockquote class="jk jl jm"><p id="7ac8" class="jn jo jp jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ig bi translated">HLD —尝试 2</p></blockquote><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mv"><img src="../Images/fc2dd1c882c4edcb463d6ecfcc405c7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Sdc40rRL6G6Apy6lD7FSGA.png"/></div></div></figure><p id="176f" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy ko ka kb kc kq ke kf kg ks ki kj kk kl ig bi translated">Zookeeper 是一个高度可用的组件，即使它的一个服务器关闭，它也会保留计数。</p><p id="0ca3" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy ko ka kb kc kq ke kf kg ks ki kj kk kl ig bi translated">它的工作方式与卡夫卡相似。</p><p id="1fea" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy ko ka kb kc kq ke kf kg ks ki kj kk kl ig bi translated">Zookeeper 将为每个服务器分配一个随机的数字范围，当用完时将分配一个不同的范围。</p><p id="4f1d" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy ko ka kb kc kq ke kf kg ks ki kj kk kl ig bi translated">所有的服务器都将成为动物园管理员的订户。</p><blockquote class="jk jl jm"><p id="5e82" class="jn jo jp jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ig bi translated">密码</p></blockquote><p id="47bf" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy ko ka kb kc kq ke kf kg ks ki kj kk kl ig bi translated">我试着写了同样的代码。</p><p id="9232" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy ko ka kb kc kq ke kf kg ks ki kj kk kl ig bi translated">这段代码目前只适用于单个服务器。</p><p id="2f97" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy ko ka kb kc kq ke kf kg ks ki kj kk kl ig bi translated">该代码也没有采用从外部服务策略获取随机数。</p><p id="e3eb" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy ko ka kb kc kq ke kf kg ks ki kj kk kl ig bi translated">链接到代码库(戈兰语):<a class="ae mw" href="https://github.com/HiteshRepo/URL-Shortener" rel="noopener ugc nofollow" target="_blank">https://github.com/HiteshRepo/URL-Shortener</a></p><p id="775f" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy ko ka kb kc kq ke kf kg ks ki kj kk kl ig bi translated">如果你喜欢代码，请留下一颗星。</p></div></div>    
</body>
</html>