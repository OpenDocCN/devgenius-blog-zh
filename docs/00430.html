<html>
<head>
<title>Writing a simple RBAC API (Python)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">编写一个简单的 RBAC API (Python)</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/writing-a-simple-rbac-api-python-56db9283a1af?source=collection_archive---------7-----------------------#2020-06-07">https://blog.devgenius.io/writing-a-simple-rbac-api-python-56db9283a1af?source=collection_archive---------7-----------------------#2020-06-07</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="966c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">使用 Flask 在 Python 中编写简单的基于角色的访问控制 API</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/063b3fd89361ede734cd9bb0110599de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*S2zjppu_0bWII-9vF5TKVg.jpeg"/></div></div></figure><p id="efde" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在这个演示中，我们将使用 Flask 用 Python 编写一个 API 服务。我们将使用 JSON 来存储用户信息；尽管人们也可以使用数据库。我们将首先编写一个不需要身份验证的简单端点。然后，我们将编写一个要求用户使用基本身份验证来调用端点的脚本。然后，我们将编写一个只允许选择用户。我们将通过为用户定义角色来控制这一点，“父”和“子”，其中“父”比“子”拥有更好的权限。</p><p id="3100" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> 1。设计 API 概要文件</strong>。以下是我如何设计我的。对于每个用户，我们有一个“用户 Id”、“用户名”、“密码哈希”、“角色”。稍后，我们定义一个动作字典，它显示哪些角色可以访问我们想要在受限访问下保护的每个端点。</p><pre class="kj kk kl km gt ku kv kw kx aw ky bi"><span id="9547" class="kz la in kv b gy lb lc l ld le">{<br/>   "Users":[<br/>      {<br/>         "UserId":"roy34",<br/>         "UserName":"Roy",<br/>         "PasswordHash":"$pbkdf2-sha256$29000$FALAeA.BsBZi7J2Tcq5Vyg$hMLsWa1lFOPVd4IJgTz6Ddef6b1n7YFWJIE5LP/I/wY",<br/>         "Role":"Parent"<br/>      },<br/>      {<br/>         "UserId":"eva41",<br/>         "UserName":"Eva",<br/>         "PasswordHash":"$pbkdf2-sha256$29000$/H8P4Ryj9B7DmNM6J.T8vw$grSInYIXaAOX7JN9DxoMidEjIDSDBFPSScmfNv5mUcE",<br/>         "Role":"Child"<br/>      }<br/>   ],<br/>   "Actions":{<br/>      "getUsers":[<br/>         "Parent"<br/>      ],<br/>      "getAppliance":[<br/>         "Parent",<br/>         "Child"<br/>      ]<br/>   }<br/>}</span></pre><p id="17d1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> 2。设置 flask 应用程序。我为这个项目制作了一个新的<a class="ae lf" href="https://docs.python.org/3/tutorial/venv.html" rel="noopener ugc nofollow" target="_blank">虚拟人</a>。这使得满足应用需求变得容易。(使用 pip 安装烧瓶)</strong></p><pre class="kj kk kl km gt ku kv kw kx aw ky bi"><span id="5216" class="kz la in kv b gy lb lc l ld le">import flask</span><span id="7448" class="kz la in kv b gy lg lc l ld le">app = flask.Flask(__name__)<br/>app.config["DEBUG"] = True #Shows errors in response.</span><span id="6dc5" class="kz la in kv b gy lg lc l ld le">@app.route('/', methods=['GET'])<br/>def home():<br/>    return "&lt;h1&gt;Welcome to the Home Controller&lt;/h1&gt;&lt;p&gt;Here is skeleton controller with RBAC to control your home&lt;/p&gt;"</span><span id="b0f0" class="kz la in kv b gy lg lc l ld le">app.run()</span></pre><p id="7be6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> 3。需要基本身份验证才能访问端点。</strong>我们使用模块<a class="ae lf" href="https://pypi.org/project/python-json-config/" rel="noopener ugc nofollow" target="_blank"><strong class="jm io">python _ JSON _ config</strong></a><strong class="jm io"/>来读取概要文件。这是我最喜欢的图书馆之一。它将 JSON 作为对象加载，并将值作为其成员。Flask 的 HTTPBasicAuth 可用于在端点上强制 Auth。为了提高安全性，我们使用 sha256 哈希算法进行密码验证，而不是将密码存储为纯文本。我们使用<strong class="jm io"> passlib.hash </strong>来实现这一点，它允许你散列和验证一个给定的密码。<strong class="jm io"> flask_httpauth </strong>允许您编写自己版本的 verify_password(用户名，密码),它应该返回一个 bool 来控制对端点的验证。</p><pre class="kj kk kl km gt ku kv kw kx aw ky bi"><span id="86ea" class="kz la in kv b gy lb lc l ld le">from flask_httpauth import HTTPBasicAuth<br/>from python_json_config import ConfigBuilder<br/>from passlib.hash import pbkdf2_sha256</span><span id="e8ef" class="kz la in kv b gy lg lc l ld le">auth = HTTPBasicAuth() #will hold values provided for auth</span><span id="a080" class="kz la in kv b gy lg lc l ld le">builder = ConfigBuilder()<br/>apiProfile = builder.parse_config('controller-profile.json')</span><span id="d779" class="kz la in kv b gy lg lc l ld le">@app.route('/api/v1/users', methods=['GET'])<br/>@auth.login_required<br/>def api_users():<br/>    return str(apiProfile.Users)</span><span id="9678" class="kz la in kv b gy lg lc l ld le">@auth.verify_password<br/>def verify_password(username, password):<br/>    user = getProfile(apiProfile.Users, username)<br/>    if(user == None):<br/>        return False<br/>    return(pbkdf2_sha256.verify(password, user["PasswordHash"]))</span><span id="374a" class="kz la in kv b gy lg lc l ld le">def getProfile(Users, username):<br/>    for user in Users:<br/>        if(username == user["UserId"]):<br/>            return user</span></pre><p id="c392" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> 4。要求对某些端点进行授权。</strong>这里我们定义一个端点来添加一个新用户。我们不希望每个人都能够添加新用户，只有少数经过授权的人才能添加。因此，我们定义了一个函数 authorizeUserforAction，该函数可用于验证发出调用的用户是否具有能够发出该调用的权限。</p><pre class="kj kk kl km gt ku kv kw kx aw ky bi"><span id="109f" class="kz la in kv b gy lb lc l ld le">from flask import request, jsonify, abort</span><span id="deea" class="kz la in kv b gy lg lc l ld le">@app.route('/api/v1/user', methods=['POST'])<br/>@auth.login_required<br/>def api_add_user():<br/>    authorized = authorizeUserforAction(username=auth.username(), roles = apiProfile.Actions.addUsers)<br/>    if not authorized:<br/>        abort(403)<br/>    payload = request.get_json()<br/>    try:<br/>        payload["PasswordHash"] = pbkdf2_sha256.hash(payload["Password"])<br/>        del payload["Password"]<br/>    except:<br/>        abort(400,"No Password present")<br/>    user = getProfile(apiProfile.Users, payload["UserId"])<br/>    if(user != None): abort(400, "User already exists, pick a different userID")<br/>    apiProfile.Users.append(payload)<br/>    configFile = open("controller-profile.json", "w")<br/>    configFile.write(apiProfile.to_json())<br/>    return "User created"</span><span id="7d01" class="kz la in kv b gy lg lc l ld le">def authorizeUserforAction(username, roles):<br/>    user = getProfile(apiProfile.Users, username)<br/>    if user["Role"] in roles:<br/>        return True<br/>    return False</span></pre></div></div>    
</body>
</html>