<html>
<head>
<title>How To Call MSSQL Stored Procedure, Pass and Get Multiple Parameters in Spark Using AWS Glue</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用 AWS Glue 调用 MSSQL 存储过程，在 Spark 中传递和获取多个参数</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/how-to-call-mssql-stored-procedure-pass-and-get-multiple-parameters-in-spark-using-aws-glue-f21b2f19657b?source=collection_archive---------1-----------------------#2022-07-18">https://blog.devgenius.io/how-to-call-mssql-stored-procedure-pass-and-get-multiple-parameters-in-spark-using-aws-glue-f21b2f19657b?source=collection_archive---------1-----------------------#2022-07-18</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/6df9d780216236ceedc5b235124d2dfb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-ZJ7Yu9TLjWx4GWmxK_Mfw.png"/></div></div></figure><h1 id="7bdf" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated"><strong class="ak">问题陈述</strong></h1><p id="5454" class="pw-post-body-paragraph kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">我们在 EC2 实例上用 MSSQL 编写了存储过程。这个存储过程中有一些输入和输出变量。输入变量应该从 Glue 传递，即 spark 代码，输出变量应该从存储过程再次返回到相同的代码。</p></div><div class="ab cl lr ls hr lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ig ih ii ij ik"><h1 id="eeb2" class="jv jw in bd jx jy ly ka kb kc lz ke kf kg ma ki kj kk mb km kn ko mc kq kr ks bi translated"><strong class="ak">概述</strong></h1><p id="d5df" class="pw-post-body-paragraph kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">要截断表或从 spark 中查询表，可以使用 spark read 函数或读取 dataframe 中的数据并对其使用 sparkSQL。</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="8a13" class="mm jw in mi b gy mn mo l mp mq">data_frame = glue_context.spark_session.read.format("jdbc")\<br/>.option("url", url)\<br/>.option("user", user_name)\<br/>.option("password", password)\<br/>.option("query", query)\<br/>.load()</span></pre><p id="e2f4" class="pw-post-body-paragraph kt ku in kv b kw mr ky kz la ms lc ld le mt lg lh li mu lk ll lm mv lo lp lq ig bi translated">调用存储过程在 pyspark 中有多种方法(或者使用 python): <br/> 1 .使用<a class="ae mw" href="https://github.com/mkleehammer/pyodbc/wiki" rel="noopener ugc nofollow" target="_blank"> <strong class="kv io"> PyODBC 库</strong> </a> <strong class="kv io"> <br/> </strong> 2。使用<a class="ae mw" href="https://kontext.tech/article/893/call-sql-server-procedure-in-python" rel="noopener ugc nofollow" target="_blank"><strong class="kv io">pymssql</strong></a><strong class="kv io"><br/></strong>3。使用<strong class="kv io">内置的 Java JDBC-Spark 上下文驱动</strong></p><p id="cddf" class="pw-post-body-paragraph kt ku in kv b kw mr ky kz la ms lc ld le mt lg lh li mu lk ll lm mv lo lp lq ig bi translated">在本文中，我们将继续讨论 Spark 上下文，因为已经添加了其他两种方法的链接。</p></div><div class="ab cl lr ls hr lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ig ih ii ij ik"><h1 id="0167" class="jv jw in bd jx jy ly ka kb kc lz ke kf kg ma ki kj kk mb km kn ko mc kq kr ks bi translated"><strong class="ak">简介</strong></h1><h2 id="4a49" class="mm jw in bd jx mx my dn kb mz na dp kf le nb nc kj li nd ne kn lm nf ng kr nh bi translated"><strong class="ak"> AWS 胶水</strong></h2><p id="67cf" class="pw-post-body-paragraph kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">AWS Glue 是一种无服务器的数据集成服务，可以轻松发现、准备和组合用于分析、机器学习和应用程序开发的数据。<br/> AWS Glue 是一种 ETL 服务，我们可以在其中对 ETL 管道进行编码或可视化，它可以很容易地与其他 AWS 服务和其他工具一起用于编排目的。使用 spark 和 python，或者使用 Glue 中的拖放式服务，可以很容易地编写代码。</p><h2 id="0bb5" class="mm jw in bd jx mx my dn kb mz na dp kf le nb nc kj li nd ne kn lm nf ng kr nh bi translated"><strong class="ak">火花</strong></h2><p id="a1de" class="pw-post-body-paragraph kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">PySpark 是 Apache Spark 的 Python API，是一个开源的分布式计算框架和一组用于实时、大规模数据处理的库。如果您已经熟悉 Python 和 Pandas 之类的库，那么 PySpark 是一种很好的语言，可以用来创建更具可伸缩性的分析和管道。</p><h2 id="e484" class="mm jw in bd jx mx my dn kb mz na dp kf le nb nc kj li nd ne kn lm nf ng kr nh bi translated"><strong class="ak"> MSSQL </strong></h2><p id="2084" class="pw-post-body-paragraph kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated"><strong class="kv io"> SQL Server 又称 MS SQL Server，是一种 RDBMS(关系数据库管理系统)</strong>。它是一个存储数据库数据并执行 SQL 命令和查询来操作关系数据库的应用程序。此外，它还管理和执行所有数据库操作</p></div><div class="ab cl lr ls hr lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ig ih ii ij ik"><h1 id="a898" class="jv jw in bd jx jy ly ka kb kc lz ke kf kg ma ki kj kk mb km kn ko mc kq kr ks bi translated">存储过程</h1><p id="14c7" class="pw-post-body-paragraph kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">我们已经编写了以下存储过程，并在托管于<a class="ae mw" href="https://aws.amazon.com/premiumsupport/knowledge-center/ec2-windows-launch-sql-server/#:~:text=Connect%20to%20the%20second%20node,the%20server%20to%20the%20FCI." rel="noopener ugc nofollow" target="_blank"> EC2 实例</a>上的 MSSQL 服务器中执行了相同的过程</p><p id="98b5" class="pw-post-body-paragraph kt ku in kv b kw mr ky kz la ms lc ld le mt lg lh li mu lk ll lm mv lo lp lq ig bi translated">在下面的 SP 中，您可以添加自己的语句。对于这个博客，我只添加了最初的 create 语句，以便理解如何<strong class="kv io">传递和获取参数</strong></p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="e691" class="mm jw in mi b gy mn mo l mp mq">CREATE or ALTER PROCEDURE [schema].[usp_stored_procedure_example]</span><span id="9f54" class="mm jw in mi b gy ni mo l mp mq">@master_id int,<br/>@parent_id int,<br/>@child_id int,<br/>@object_name varchar(30),<br/>@glue_job_run_id varchar(100),<br/>@o_main_id int output,<br/>@o_last_name varchar(100) output,<br/>@o_date varchar(100) output,<br/>@o_message nvarchar(max) output</span><span id="4cc3" class="mm jw in mi b gy ni mo l mp mq">AS</span><span id="3d17" class="mm jw in mi b gy ni mo l mp mq">BEGIN</span><span id="ee99" class="mm jw in mi b gy ni mo l mp mq">SET NOCOUNT ON;</span><span id="6fce" class="mm jw in mi b gy ni mo l mp mq">****<br/>****<br/>****</span><span id="7696" class="mm jw in mi b gy ni mo l mp mq">END</span><span id="7467" class="mm jw in mi b gy ni mo l mp mq">GO</span></pre><p id="2739" class="pw-post-body-paragraph kt ku in kv b kw mr ky kz la ms lc ld le mt lg lh li mu lk ll lm mv lo lp lq ig bi translated">在上面的存储过程中，我们从 Glue Job 传递 5 个参数，并获取 4 个输出参数，将它们存储在我们的脚本中。</p></div><div class="ab cl lr ls hr lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ig ih ii ij ik"><h1 id="30d7" class="jv jw in bd jx jy ly ka kb kc lz ke kf kg ma ki kj kk mb km kn ko mc kq kr ks bi translated">Glue/PySpark 脚本</h1><ul class=""><li id="3668" class="nj nk in kv b kw kx la lb le nl li nm lm nn lq no np nq nr bi translated">最初，我们需要获取数据库的相关信息来执行存储过程，比如 URL、用户名和密码。</li><li id="a22a" class="nj nk in kv b kw ns la nt le nu li nv lm nw lq no np nq nr bi translated">现在我们应该从 spark 会话中获取驱动程序管理器，并通过传递数据库凭证从<strong class="kv io">驱动程序管理器</strong>中创建连接对象</li></ul><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="49e9" class="mm jw in mi b gy mn mo l mp mq">driver_manager = spark._sc._gateway.jvm.java.sql.DriverManager</span><span id="757b" class="mm jw in mi b gy ni mo l mp mq">con = driver_manager.getConnection(url, username, password)</span></pre><ul class=""><li id="be99" class="nj nk in kv b kw mr la ms le nx li ny lm nz lq no np nq nr bi translated">通过传递所需的输入参数，创建需要执行的 SQL 语句</li><li id="7c28" class="nj nk in kv b kw ns la nt le nu li nv lm nw lq no np nq nr bi translated">对于每个预期的<strong class="kv io">输出参数，一个“？”</strong>必须添加到语句的末尾</li></ul><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="08f4" class="mm jw in mi b gy mn mo l mp mq">statement =f"""{{call {schema}.usp_stored_procedure_example({master_id}, {parent_id}, {child_id}, {table}, {job_run_id}, ?, ?, ?, ?)}}"""</span></pre><ul class=""><li id="fc0f" class="nj nk in kv b kw mr la ms le nx li ny lm nz lq no np nq nr bi translated">在我们创建的存储过程中，我们有 5 个输入参数和 4 个输出参数；因此，我们传递 5 个不同的值，通过提到“？”来获取输出值同样的</li><li id="54a1" class="nj nk in kv b kw ns la nt le nu li nv lm nw lq no np nq nr bi translated">可以使用<strong class="kv io"> <em class="oa"> "CALL" </em> </strong> <em class="oa"> </em>关键字来调用存储过程，也可以使用<strong class="kv io"> <em class="oa"> "EXEC "。</em> </strong>例如:<br/>这里，我们将一个输入作为“名称”传递，并期望一个输出参数</li></ul><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="bfab" class="mm jw in mi b gy mn mo l mp mq">statement = f"""EXEC dbo.SP_DummySP  '{name}', ?"""</span></pre><ul class=""><li id="3ca9" class="nj nk in kv b kw mr la ms le nx li ny lm nz lq no np nq nr bi translated">下一步是调用<strong class="kv io">可调用函数</strong></li></ul><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="7b0b" class="mm jw in mi b gy mn mo l mp mq">exec_statement = con.prepareCall(statement)</span></pre><ul class=""><li id="43ef" class="nj nk in kv b kw mr la ms le nx li ny lm nz lq no np nq nr bi translated">输出参数需要用可调用语句<strong class="kv io">注册</strong>。这必须通过提供问号的索引(从 1 开始)及其数据类型来完成。</li><li id="8a27" class="nj nk in kv b kw ns la nt le nu li nv lm nw lq no np nq nr bi translated">执行之后，需要使用正确的<strong class="kv io"> get-method </strong>根据它的(java) <strong class="kv io">数据类型</strong>获取输出参数。</li></ul><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="885d" class="mm jw in mi b gy mn mo l mp mq">driver_manager = spark._sc._gateway.jvm.java.sql.DriverManager</span><span id="447f" class="mm jw in mi b gy ni mo l mp mq">con = driver_manager.getConnection(url, user_name, password)</span><span id="a2d0" class="mm jw in mi b gy ni mo l mp mq">statement =f"""{{call {schema}.usp_stored_procedure_example({master_id}, {parent_id}, {child_id}, '{table}', '{job_run_id}', ?, ?, ?, ?)}}"""</span><span id="2877" class="mm jw in mi b gy ni mo l mp mq">exec_statement = con.prepareCall(statement)</span><span id="2735" class="mm jw in mi b gy ni mo l mp mq">exec_statement.registerOutParameter(1, spark._sc._gateway.jvm.java.sql.Types.INTEGER)</span><span id="a799" class="mm jw in mi b gy ni mo l mp mq">exec_statement.registerOutParameter(2, spark._sc._gateway.jvm.java.sql.Types.VARCHAR)</span><span id="84f6" class="mm jw in mi b gy ni mo l mp mq">exec_statement.registerOutParameter(3, spark._sc._gateway.jvm.java.sql.Types.VARCHAR)</span><span id="3fd4" class="mm jw in mi b gy ni mo l mp mq">exec_statement.registerOutParameter(4, spark._sc._gateway.jvm.java.sql.Types.VARCHAR)</span><span id="eb79" class="mm jw in mi b gy ni mo l mp mq">exec_statement.execute()</span><span id="d09f" class="mm jw in mi b gy ni mo l mp mq">res1 = exec_statement.getInt(1)</span><span id="e557" class="mm jw in mi b gy ni mo l mp mq">res2 = exec_statement.getString(2)</span><span id="0dee" class="mm jw in mi b gy ni mo l mp mq">res3 = exec_statement.getString(3)</span><span id="c0cf" class="mm jw in mi b gy ni mo l mp mq">res4 = exec_statement.getString(4)</span><span id="eee1" class="mm jw in mi b gy ni mo l mp mq">exec_statement.close()</span><span id="7023" class="mm jw in mi b gy ni mo l mp mq">con.close()</span></pre><ul class=""><li id="5e3b" class="nj nk in kv b kw mr la ms le nx li ny lm nz lq no np nq nr bi translated">注册输出参数时的索引应该在调用 Get-Method 时正确匹配</li><li id="bf37" class="nj nk in kv b kw ns la nt le nu li nv lm nw lq no np nq nr bi translated">我们也可以获取 getParameters 并使用 for 循环注册参数</li></ul></div><div class="ab cl lr ls hr lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ig ih ii ij ik"><h2 id="3d41" class="mm jw in bd jx mx my dn kb mz na dp kf le nb nc kj li nd ne kn lm nf ng kr nh bi translated">结论</h2><p id="2c92" class="pw-post-body-paragraph kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">所描述的使用内置 java JDBC 驱动程序的方法相当简单，但是不太为人所知。因为我们在 python 上下文中使用 java 对象，所以很难在线找到(正确的)信息。更多信息可以在 java 文档中找到。(例如，这篇关于执行存储过程的文章)</p><p id="4fc1" class="pw-post-body-paragraph kt ku in kv b kw mr ky kz la ms lc ld le mt lg lh li mu lk ll lm mv lo lp lq ig bi translated">我希望这对开发人员和数据工程师有所帮助。请让我知道你对此的想法和/或任何可能的优化。</p></div><div class="ab cl lr ls hr lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ig ih ii ij ik"><p id="45b3" class="pw-post-body-paragraph kt ku in kv b kw mr ky kz la ms lc ld le mt lg lh li mu lk ll lm mv lo lp lq ig bi translated"><strong class="kv io">参考文献:</strong> <br/> 1。<a class="ae mw" href="https://docs.microsoft.com/en-us/sql/connect/jdbc/reference/registeroutparameter-method-int-int?view=sql-server-ver16" rel="noopener ugc nofollow" target="_blank">https://docs . Microsoft . com/en-us/SQL/connect/JDBC/reference/registeroutparameter-method-int-int？view=sql-server-ver16 </a></p><p id="5de8" class="pw-post-body-paragraph kt ku in kv b kw mr ky kz la ms lc ld le mt lg lh li mu lk ll lm mv lo lp lq ig bi translated">2.https://docs . Oracle . com/javase/8/docs/API/Java/SQL/types . html #:~:text = VARBINARY-，The % 20 constant % 20 in % 20 The % 20 Java % 20 programming % 20 language % 2C % 20 something % 20 refered % 20 to，The % 20 generic % 20 SQL % 20 type % 20 VARBINARY % 20。&amp; text=VARCHAR-，The %20constant % 20in % 20the % 20Java 编程% 20 语言% 2C %有时% 20referred % 20to，The % 20 generic % 20 SQL % 20 type % 20 VARCHAR % 20。</p><p id="6a49" class="pw-post-body-paragraph kt ku in kv b kw mr ky kz la ms lc ld le mt lg lh li mu lk ll lm mv lo lp lq ig bi translated">3.https://github.com/mkleehammer/pyodbc/wiki<a class="ae mw" href="https://github.com/mkleehammer/pyodbc/wiki" rel="noopener ugc nofollow" target="_blank"/></p><p id="5d47" class="pw-post-body-paragraph kt ku in kv b kw mr ky kz la ms lc ld le mt lg lh li mu lk ll lm mv lo lp lq ig bi translated">4.<a class="ae mw" href="https://kontext.tech/article/893/call-sql-server-procedure-in-python" rel="noopener ugc nofollow" target="_blank">https://kontext . tech/article/893/call-SQL-server-procedure-in-python</a></p><p id="5507" class="pw-post-body-paragraph kt ku in kv b kw mr ky kz la ms lc ld le mt lg lh li mu lk ll lm mv lo lp lq ig bi translated">5.<a class="ae mw" href="https://aws.amazon.com/glue/?whats-new-cards.sort-by=item.additionalFields.postDateTime&amp;whats-new-cards.sort-order=desc" rel="noopener ugc nofollow" target="_blank">https://aws.amazon.com/glue/?whats-new-cards . sort-by = item . additional fields . post datetime&amp;whats-new-cards . sort-order = desc</a></p><p id="a202" class="pw-post-body-paragraph kt ku in kv b kw mr ky kz la ms lc ld le mt lg lh li mu lk ll lm mv lo lp lq ig bi translated">6.<a class="ae mw" href="https://aws.amazon.com/premiumsupport/knowledge-center/ec2-windows-launch-sql-server/#:~:text=Connect%20to%20the%20second%20node,the%20server%20to%20the%20FCI" rel="noopener ugc nofollow" target="_blank">https://AWS . Amazon . com/premium support/knowledge-center/ec2-windows-launch-SQL-server/#:~:text = Connect % 20 to % 20 the % 20 second % 20 node，the % 20 server % 20 to % 20 the % 20 fci</a>。</p><p id="dde1" class="pw-post-body-paragraph kt ku in kv b kw mr ky kz la ms lc ld le mt lg lh li mu lk ll lm mv lo lp lq ig bi translated">7.<a class="ae mw" href="https://docs.oracle.com/cd/E17952_01/connector-j-5.1-en/connector-j-usagenotes-statements-callable.html" rel="noopener ugc nofollow" target="_blank">https://docs . Oracle . com/CD/e 17952 _ 01/connector-j-5.1-en/connector-j-usagenotes-statements-callable . html</a></p><p id="03f7" class="pw-post-body-paragraph kt ku in kv b kw mr ky kz la ms lc ld le mt lg lh li mu lk ll lm mv lo lp lq ig bi translated">8.<a class="ae mw" href="https://medium.com/delaware-pro/executing-ddl-statements-stored-procedures-on-sql-server-using-pyspark-in-databricks-2b31d9276811" rel="noopener">https://medium . com/Delaware-pro/executing-DDL-statements-stored-procedures-on-SQL-server-using-py spark-in-databricks-2b31d 9276811</a></p></div></div>    
</body>
</html>