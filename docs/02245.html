<html>
<head>
<title>React Tips — Back Button, Stop Event Bubbling, Merging States</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">反应提示—后退按钮、停止事件冒泡、合并状态</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/react-tips-back-button-stop-event-bubbling-merging-states-5aca03bf50f9?source=collection_archive---------0-----------------------#2020-07-25">https://blog.devgenius.io/react-tips-back-button-stop-event-bubbling-merging-states-5aca03bf50f9?source=collection_archive---------0-----------------------#2020-07-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/f6517f0f9dd693487f7ec45e44e899dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Nhvg-gUPu4LLx0B0"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">由<a class="ae kc" href="https://unsplash.com/@pawel_czerwinski?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">paweczerwi ski</a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="e966" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">React是一个用于创建web应用程序和移动应用程序的流行库。</p><p id="f2a2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将了解一些编写更好的React应用程序的技巧。</p><h1 id="56b3" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">防止子级在父级上触发事件</h1><p id="5b09" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以通过调用<code class="fe me mf mg mh b">stopPropagation</code>方法来防止事件从子节点冒泡到父节点。</p><p id="71b9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="14ca" class="mq lc iq mh b gy mr ms l mt mu">class App extends Component {<br/>  constructor(){<br/>    super();<br/>  }</span><span id="1eb7" class="mq lc iq mh b gy mv ms l mt mu">  handleParentClick(e) { <br/>    console.log('parent clicked');<br/>  },</span><span id="f852" class="mq lc iq mh b gy mv ms l mt mu">  handleChildClick(e) {<br/>    e.stopPropagation();<br/>    console.log('child clicked');<br/>  },</span><span id="3788" class="mq lc iq mh b gy mv ms l mt mu">  render() {<br/>    return (<br/>      &lt;div&gt;<br/>        &lt;p onClick={this.handleParentClick}&gt;<br/>          &lt;span onClick={this.handleChildClick}&gt;Click&lt;/span&gt;<br/>        &lt;/p&gt;<br/>      &lt;/div&gt;<br/>    );<br/>  }<br/>}</span></pre><p id="88cd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们创建了一个包含父元素和子元素的组件。</p><p id="e084" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">span附带有<code class="fe me mf mg mh b">handleChildClick</code>处理程序。</p><p id="fd69" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">由于我们调用了<code class="fe me mf mg mh b">e.stopPropagation</code>，我们不会让孩子的事件冒泡到家长。</p><p id="749f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们还有一个附加到p元素的<code class="fe me mf mg mh b">handleParentClick</code>处理程序。</p><h1 id="61fb" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">在React中下载文件</h1><p id="c3a7" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以用几种方法创建文件下载链接。</p><p id="fd88" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一种方法是通过编写以下代码来使用React路由器的<code class="fe me mf mg mh b">Link</code>组件:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="98a8" class="mq lc iq mh b gy mr ms l mt mu">&lt;Link to="/files/file.pdf" target="_blank" download&gt;Download&lt;/Link&gt;</span></pre><p id="92fa" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们也可以创建一个链接并点击它来触发下载。</p><p id="599c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="3542" class="mq lc iq mh b gy mr ms l mt mu">const link = document.createElement('a');<br/>link.href = `file.pdf`;<br/>document.body.appendChild(link);<br/>link.click();<br/>document.body.removeChild(link);</span></pre><p id="851c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们也可以通过编写以下内容来使用锚标记:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="3798" class="mq lc iq mh b gy mr ms l mt mu">&lt;a href={uploadedFileLink} target="_blank" rel="noopener noreferrer"&gt;<br/>   download file<br/>&lt;/a&gt;</span></pre><p id="a41a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们有<code class="fe me mf mg mh b">rel=”noopener noreferrer”</code>属性，这样我们可以防止跨来源目的地的安全问题。</p><p id="2c83" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此属性将阻止外部域访问当前网站。</p><h1 id="ab8d" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">在React路由器中拦截或处理浏览器的后退按钮</h1><p id="82d1" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以通过运行后退按钮动作的<code class="fe me mf mg mh b">setRouteLeaveHook </code>事件来监听后退按钮动作。</p><p id="ef2e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="a8e5" class="mq lc iq mh b gy mr ms l mt mu">import {Component} from 'react';<br/>import {withRouter} from 'react-router';</span><span id="0b38" class="mq lc iq mh b gy mv ms l mt mu">class App extends Component {<br/>  componentDidMount() {<br/>    this.props.router.setRouteLeaveHook(this.props.route, this.onLeave);<br/>  }</span><span id="b018" class="mq lc iq mh b gy mv ms l mt mu">  onLeave(nextState) {<br/>    if (nextState.action === 'POP') {<br/>      //...<br/>    }<br/>  }</span><span id="8373" class="mq lc iq mh b gy mv ms l mt mu">  //...<br/>}</span><span id="9d5e" class="mq lc iq mh b gy mv ms l mt mu">export default withRouter(App);</span></pre><p id="8dd5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们调用<code class="fe me mf mg mh b">withRouter</code>来注入<code class="fe me mf mg mh b">router</code>对象，它有<code class="fe me mf mg mh b">setRouteLeaveHook</code>方法让我们监听<code class="fe me mf mg mh b">this.props.route</code>的变化。</p><p id="65ed" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们创建了自己的<code class="fe me mf mg mh b">onLeave</code>方法，作为第二个参数传入。</p><p id="52cd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它采用了<code class="fe me mf mg mh b">nextState</code>对象，该对象具有我们可以检查的<code class="fe me mf mg mh b">action</code>。</p><p id="4b47" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果是<code class="fe me mf mg mh b">'POP'</code>，则后退按钮被按下。</p><p id="2d7f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有了函数组件，我们可以监听<code class="fe me mf mg mh b">history</code>对象的变化。</p><p id="a9ae" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">history</code>具有<code class="fe me mf mg mh b">action</code>属性，该属性返回正在进行的操作。</p><p id="0a57" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果是<code class="fe me mf mg mh b">'POP'</code>，那么我们知道用户按了返回键。</p><p id="acf1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="42f4" class="mq lc iq mh b gy mr ms l mt mu">import { useHistory } from 'react-router-dom'</span><span id="2dc6" class="mq lc iq mh b gy mv ms l mt mu">const App = () =&gt; {<br/>  const { history } = useRouter();<br/>  <br/>  useEffect(() =&gt; {<br/>    return () =&gt; {<br/>      if (history.action === "POP") {<br/>        //...<br/>      }<br/>    };<br/>  }, [history])</span><span id="d533" class="mq lc iq mh b gy mv ms l mt mu">  //...<br/>}</span></pre><p id="5585" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将它放在我们在<code class="fe me mf mg mh b">useEffect</code>回调中返回的函数中，这样我们就可以检查组件何时被卸载。</p><p id="8fa8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">还有一个<code class="fe me mf mg mh b">history.listen</code>方法，让我们监听历史的变化。</p><p id="c5ae" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="eb48" class="mq lc iq mh b gy mr ms l mt mu">import { useHistory } from 'react-router-dom'</span><span id="df24" class="mq lc iq mh b gy mv ms l mt mu">const App = () =&gt; {<br/>  const history = useHistory();</span><span id="1fee" class="mq lc iq mh b gy mv ms l mt mu">  useEffect(() =&gt; {<br/>    return history.listen(location =&gt; {<br/>      if (history.action === 'POP') {<br/>        //...<br/>      }<br/>    })<br/>  }, [])</span><span id="79a3" class="mq lc iq mh b gy mv ms l mt mu">  //...<br/>}</span></pre><p id="16cb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以像前面的例子一样听<code class="fe me mf mg mh b">'POP'</code>动作。</p><h1 id="74e4" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">使用React useState()挂钩更新和合并状态对象</h1><p id="3672" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">为了用<code class="fe me mf mg mh b">useState</code>更新和合并状态对象，我们可以向状态改变函数传递一个回调。</p><p id="0707" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它将前一阶段的值作为参数，并返回我们想要的新状态值。</p><p id="582d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="9ac1" class="mq lc iq mh b gy mr ms l mt mu">setState(prevState =&gt; {<br/>  return { ...prevState, ...newValues };<br/>});</span></pre><p id="0ddd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们使用spread操作符来扩展新旧状态对象的所有属性。</p><p id="3f85" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">同样，我们可以使用<code class="fe me mf mg mh b">Object.assign</code>来做同样的事情。</p><p id="7fb8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="a6c8" class="mq lc iq mh b gy mr ms l mt mu">setState(prevState =&gt; {<br/>  return Object.assign({}, prevState, newValues);<br/>});</span></pre><p id="fe89" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">做同样的事情。</p><p id="d5e7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">或者，如果我们真的不关心当前的状态值，我们可以把它合并进来。</p><p id="6873" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="028a" class="mq lc iq mh b gy mr ms l mt mu">setState({<br/>  ...state,<br/>  foo: 'bar'<br/>});</span></pre><p id="52ec" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">state</code>的价值无法保证。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mw"><img src="../Images/54be918fbf534a0e4d064c72045d790c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*KCFbIXq8-xwvMqcT"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">由<a class="ae kc" href="https://unsplash.com/@davide_pietralunga?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Davide Pietralunga </a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><h1 id="0c4f" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="8da2" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">有许多方法可以合并旧状态和新状态。</p><p id="0d71" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以调用<code class="fe me mf mg mh b">stopPropagation</code>来停止传播事件。</p><p id="b4f9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有许多方法可以观察后退按钮的按下情况。</p></div></div>    
</body>
</html>