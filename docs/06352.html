<html>
<head>
<title>Creating S3 Upload Presigned URL with API Gateway and Lambda</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用API网关和Lambda创建S3上传预先设计的URL</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/creating-s3-upload-presigned-url-with-api-gateway-and-lambda-fd89c08bd1aa?source=collection_archive---------3-----------------------#2022-01-02">https://blog.devgenius.io/creating-s3-upload-presigned-url-with-api-gateway-and-lambda-fd89c08bd1aa?source=collection_archive---------3-----------------------#2022-01-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/94350956fa6208a9751e721ae27fbc31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YDQZjB-nDVfXE2QGsMwo0g.jpeg"/></div></div></figure><p id="992f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们使用API网关前端的Lambda创建一个S3上传预先设计的URL生成器。</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div class="gh gi kw"><img src="../Images/aa44f64fcabcbc072188922f9276cbc0.png" data-original-src="https://miro.medium.com/v2/resize:fit:928/format:webp/1*n6XeZpMXjrgASEqV1PtGKQ.png"/></div></figure><p id="f108" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于要上传文件到特定S3桶的用户，他/她首先向API网关发出请求，API网关将请求发送给lambda函数，lambda函数又与S3桶对话以获得预先签名的上传URL，然后该URL作为API网关的响应返回给用户。然后，用户将他/她的文件上传到带有URL的桶中。</p><p id="2a58" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Terraform用于实现上述架构。</p><h2 id="88c5" class="lb lc iq bd ld le lf dn lg lh li dp lj kj lk ll lm kn ln lo lp kr lq lr ls lt bi translated">λ函数</h2><p id="3c49" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">lambda函数是使用Golang实现的。</p><pre class="kx ky kz la gt lz ma mb mc aw md bi"><span id="bdd0" class="lb lc iq ma b gy me mf l mg mh">package main</span><span id="de48" class="lb lc iq ma b gy mi mf l mg mh">import (<br/> "context"<br/> "log"<br/> "os"</span><span id="f7ee" class="lb lc iq ma b gy mi mf l mg mh"> "github.com/aws/aws-lambda-go/events"<br/> "github.com/aws/aws-lambda-go/lambda"<br/> "github.com/aws/aws-sdk-go-v2/aws"<br/> "github.com/aws/aws-sdk-go-v2/config"<br/> "github.com/aws/aws-sdk-go-v2/service/s3"<br/>)<br/><strong class="ma ir">func handler(ctx context.Context, request events.APIGatewayProxyRequest) (events.APIGatewayProxyResponse, error)</strong> {<br/> cfg, err := config.LoadDefaultConfig(context.TODO())<br/> if err != nil {<br/>  log.Fatalf("Failed to load default config: %v", err)<br/> }</span><span id="bec0" class="lb lc iq ma b gy mi mf l mg mh"> client := s3.NewFromConfig(cfg)<br/> psClient := s3.NewPresignClient(client)</span><span id="d41d" class="lb lc iq ma b gy mi mf l mg mh"> bucket := os.Getenv("BUCKET")<br/> filename := request.QueryStringParameters["filename"]</span><span id="6095" class="lb lc iq ma b gy mi mf l mg mh"> #log.Printf("bucket: %s, filename: %s", bucket, filename)</span><span id="65f6" class="lb lc iq ma b gy mi mf l mg mh"> resp, err := psClient.PresignPutObject(context.TODO(), &amp;s3.PutObjectInput{<br/>  Bucket: aws.String(bucket),<br/>  Key:    aws.String(filename),<br/> })</span><span id="b4d7" class="lb lc iq ma b gy mi mf l mg mh"> if err != nil {<br/>  log.Fatalf("Failed to request for presign url: %v", err)<br/> }</span><span id="c5f8" class="lb lc iq ma b gy mi mf l mg mh"> return events.APIGatewayProxyResponse{Body: resp.URL, StatusCode: 200}, nil<br/>}</span><span id="c2bc" class="lb lc iq ma b gy mi mf l mg mh">func main() {<br/> lambda.Start(handler)<br/>}</span></pre><p id="8d69" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">注意在lambda处理程序中，函数参数是<code class="fe mj mk ml ma b">events.APIGatewayProxyRequest</code>。返回类型为<code class="fe mj mk ml ma b">events.APIGatewayProxyResponse</code>。我们可以从查询字符串中获取文件名，并将其用作S3的键。从环境变量中获取bucket。我们调用S3 API来创建一个PresignPutObject请求。预先指定的URL可以从S3响应中获得。</p><p id="7214" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在让我们用地形创建lambda。</p><pre class="kx ky kz la gt lz ma mb mc aw md bi"><span id="9f99" class="lb lc iq ma b gy me mf l mg mh">resource "aws_lambda_function" "s3-presigned-url" {<br/>  function_name = "s3-presigned-url"<br/>  filename      = "./lambda-code/src/s3-presigned-url.zip"<br/>  handler       = "s3-presigned-url.bin"<br/>  source_code_hash = filebase64sha256("./lambda-code/src/s3-presigned-url.zip")</span><span id="d674" class="lb lc iq ma b gy mi mf l mg mh">  role          = aws_iam_role.lambda-s3-role.arn<br/>  runtime       = "go1.x"</span><span id="786e" class="lb lc iq ma b gy mi mf l mg mh">  environment {<br/>    variables = {<br/>      BUCKET = aws_s3_bucket.my-bucket.bucket<br/>    }<br/>  }<br/>}</span></pre><p id="6e78" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">可执行文件被命名为<code class="fe mj mk ml ma b">s3-presigned-url.bin.</code>。zip文件仅由可执行文件创建。</p><p id="a679" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在环境部分，我们定义了一个名为BUCKET的变量，其值引用了S3 terraform资源。(<em class="mm">此处忽略s3资源的hcl来源</em>)。</p><p id="ff55" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要运行lambda，我们需要分配适当的IAM角色。这是通过以下方式实现的，</p><pre class="kx ky kz la gt lz ma mb mc aw md bi"><span id="7aaf" class="lb lc iq ma b gy me mf l mg mh">variable "lambda_assume_role_policy_document" {<br/>  type        = string<br/>  description = "assume role policy document"<br/>  default     = &lt;&lt;-EOF<br/>   {<br/>      "Version": "2012-10-17",<br/>      "Statement": [<br/>        {<br/>          "Action": "sts:AssumeRole",<br/>          "Principal": {<br/>            "Service": "lambda.amazonaws.com"<br/>          },<br/>          "Effect": "Allow"<br/>        }<br/>      ]<br/>   }<br/>  EOF<br/>}</span><span id="d3c5" class="lb lc iq ma b gy mi mf l mg mh">resource "aws_iam_policy" "my-lambda-iam-policy" {<br/>  name        = "my-lambda-iam-policy"<br/>  path        = "/"<br/>  description = "My lambda policy - base"</span><span id="c3ec" class="lb lc iq ma b gy mi mf l mg mh">  policy = &lt;&lt;-EOF<br/>    {<br/>      "Version": "2012-10-17",<br/>      "Statement": [<br/>        {<br/>          "Action": [<br/>            "logs:CreateLogGroup",<br/>            "logs:CreateLogStream",<br/>            "logs:PutLogEvents"<br/>          ],<br/>          "Effect": "Allow",<br/>          "Resource": "*"<br/>        }<br/>      ]<br/>    }<br/>  EOF<br/>}</span><span id="e0fe" class="lb lc iq ma b gy mi mf l mg mh">resource "aws_iam_role" "lambda-s3-role" {<br/>  name = "my_lambda_iam_s3_role"<br/>  assume_role_policy = var.lambda_assume_role_policy_document<br/>}</span><span id="6dca" class="lb lc iq ma b gy mi mf l mg mh">resource "aws_iam_role_policy_attachment" "base-role" {<br/>  role       = aws_iam_role.lambda-s3-role.name<br/>  policy_arn = aws_iam_policy.my-lambda-iam-policy.arn<br/>}</span><span id="82dd" class="lb lc iq ma b gy mi mf l mg mh">data "aws_iam_policy" "s3-admin-policy"{<br/>  name = "AmazonS3FullAccess" <br/>}</span><span id="20e5" class="lb lc iq ma b gy mi mf l mg mh">resource "aws_iam_role_policy_attachment" "s3-role" {<br/>  role       = aws_iam_role.lambda-s3-role.name<br/>  policy_arn = data.aws_iam_policy.s3-admin-policy.arn<br/>}</span></pre><p id="c02a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从定义承担角色策略的变量开始，我们创建aws_iam_role资源。lambda函数需要访问CloudWatch日志和S3服务。为CloudWatch创建新策略。通过将数据资源引用到AWS管理的策略来重用S3权限。然后调用“aws_iam_role_policy_attachment”两次，将策略附加到角色。(<em class="mm">当然，对于生产用途，我们可能希望将S3权限收紧到s3:putObject only </em></p><h2 id="5040" class="lb lc iq bd ld le lf dn lg lh li dp lj kj lk ll lm kn ln lo lp kr lq lr ls lt bi translated">API网关</h2><p id="804b" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">api网关由API、阶段、集成和路由创建。</p><pre class="kx ky kz la gt lz ma mb mc aw md bi"><span id="4e15" class="lb lc iq ma b gy me mf l mg mh">resource "aws_apigatewayv2_api" "s3upload" {<br/>  name          = "s3upload"<br/>  protocol_type = "HTTP"<br/>}</span><span id="c0a1" class="lb lc iq ma b gy mi mf l mg mh">resource "aws_apigatewayv2_stage" "v1" {<br/>  api_id      = aws_apigatewayv2_api.s3upload.id<br/>  name        = "v1"<br/>  auto_deploy = true<br/>}</span><span id="fba4" class="lb lc iq ma b gy mi mf l mg mh">resource "aws_apigatewayv2_integration" "s3upload" {<br/>  api_id           = aws_apigatewayv2_api.s3upload.id<br/>  integration_type = "AWS_PROXY"</span><span id="0a1f" class="lb lc iq ma b gy mi mf l mg mh">  connection_type           = "INTERNET"<br/>  description               = "s3upload presign url"<br/>  integration_method        = "POST"<br/>  integration_uri = aws_lambda_function.s3-presigned-url.invoke_arn<br/>}</span><span id="7b5a" class="lb lc iq ma b gy mi mf l mg mh">resource "aws_apigatewayv2_route" "s3upload" {<br/>  api_id    = aws_apigatewayv2_api.s3upload.id<br/>  operation_name = "s3upload"<br/>  route_key      = "GET /url"</span><span id="7752" class="lb lc iq ma b gy mi mf l mg mh">  target="integrations/${aws_apigatewayv2_integration.s3upload.id}"<br/>}</span></pre><p id="b178" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从定义HTTP API网关开始，stage资源将生成一个调用URL库来触发API。我们在这里使用“v1”而不是“$default”。集成指定了API网关如何将请求转发给Lambda函数。注意integration_type和integration_method的组合分别是AWS_PROXY和POST。似乎POST是API Gateway集成到lambda的唯一方法。路由资源通过目标属性连接API和集成。URL路径和HTTP方法在route_key属性中定义。有了这些设置，我们将期望完整的调用URL和路径如下所示，</p><p id="9b10" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mj mk ml ma b">https://{random string}.execute-api.us-east-1.amazonaws.com/v1/url</code></p><p id="e0a7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这还不够，我们需要允许API网关能够调用lambda函数。如果我们使用AWS web控制台，则有一个默认设置来启用权限。在Terraform的情况下，我们使用lambda资源策略启用权限，</p><pre class="kx ky kz la gt lz ma mb mc aw md bi"><span id="7f79" class="lb lc iq ma b gy me mf l mg mh">resource "aws_lambda_permission" "apigw-permission" {<br/>  statement_id  = "AllowAPIInvoke"<br/>  action        = "lambda:InvokeFunction"<br/>  function_name = "s3-presigned-url"<br/>  principal     = "apigateway.amazonaws.com"</span><span id="474b" class="lb lc iq ma b gy mi mf l mg mh">  # The /*/*/* part allows invocation from any stage, method and resource path<br/>  source_arn = "${aws_apigatewayv2_api.s3upload.execution_arn}/*/*/*"<br/>}</span></pre><p id="bc2b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">请注意，我们可以进一步收紧resource_arn属性中阶段、方法和路径组合的权限。</p><p id="5dbc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">应用所有的地形代码。我们可以获得API网关调用URL。</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mn"><img src="../Images/dc5a1b8235dd3798845f4f0f11951e53.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7tXEfWiqHHvSoMubmkZQCg.png"/></div></div></figure><h2 id="ceb2" class="lb lc iq bd ld le lf dn lg lh li dp lj kj lk ll lm kn ln lo lp kr lq lr ls lt bi translated">测试</h2><p id="82a9" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">假设我们想上传一个文件abc.txt到S3桶。</p><p id="752e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">运行以下curl命令从API网关获取预签名的url。</p><pre class="kx ky kz la gt lz ma mb mc aw md bi"><span id="083b" class="lb lc iq ma b gy me mf l mg mh">curl '<a class="ae mo" href="https://o2cfq73ski.execute-api.us-east-1.amazonaws.com/v1/url?filename=abc.txt'" rel="noopener ugc nofollow" target="_blank">https://o2cfq73ski.execute-api.us-east-1.amazonaws.com/v1/url?filename=abc.txt'</a></span></pre><p id="05ce" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">响应是S3上传预先签名的URL</p><pre class="kx ky kz la gt lz ma mb mc aw md bi"><span id="39d5" class="lb lc iq ma b gy me mf l mg mh"><a class="ae mo" href="https://my-bucket-1f8efb28-8ca0-af97-10ff-dc3c5c2c8255.s3.us-east-1.amazonaws.com/abc.txt?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=ASIA5GCH7TYAE664OJNK%2F20220102%2Fus-east-1%2Fs3%2Faws4_request&amp;X-Amz-Date=20220102T075911Z&amp;X-Amz-Expires=900&amp;X-Amz-Security-Token=IQoJb3JpZ2luX2VjEDgaCXVzLWVhc3QtMSJHMEUCICLRjrbmbvlLc2U0qGzypPKl5n7iqPF77gCecZc2xOWTAiEA33zFTKmIq%2Bm2IsAbA%2Bnl6cZSNikx%2BtZC3x8iudnvEHgqlQIIQRABGgw5MDYzODkwNjkzMTIiDCe3KrBmM2fAIPhDNCryAQ97ZTM5NBYvRmJRXsfKp%2BxaSzp4vfOJlkA8RGc98gd6FXXAHC5EIEWPGAs3SxilLgG%2BDi5FkofFsciCEoVxrfP2GISj1npUxhnyllmHGJ%2FlkJ7pnLhz3GBj4FDKD6GQTshqeCEuxJFNgW90SmKd6rk%2BFxaunkJ1EyU0QR9gBGXSG1J6DHnRGs18xHLNeoy1bxjmOLOvixAHDcqd%2BYwUg9oYBIfL9KIZRjulhbxcm0GGr5qXl%2BLLHVRwkBVZ0B%2FLeSKc%2FTZeXldSPcyPx5eFRzlysSpOfieXQZLKi4yuFTpwP1x9J6mtqkoqpRcMuWU71w0bMM%2B2xY4GOpoBuH%2FfgeGVkTyHn5p9TjFX6qJ6DHXotcDN8zKMGu3x1f%2FPcTA40gufOUMwApTYY%2B1YbwdJvnOmwZv7UjugzUQ1g49VAHmRmR%2BFMISgUNnCLvxoc3yKnvu0rJYFbsI5d50og%2B7dqSZC0cpmYFaI7vugsfjRhOFMVOiwNZEXi%2BkeAEzfh0jA5Ps4tqdjZM3xqfoK1CoLyT9eXdyRNg%3D%3D&amp;X-Amz-SignedHeaders=host&amp;x-id=PutObject&amp;X-Amz-Signature=b5c45ca93915b3268efe88be73403bc53bfe71e11f8e58f12e0a691adc4bd75" rel="noopener ugc nofollow" target="_blank">https://my-bucket-1f8efb28-8ca0-af97-10ff-dc3c5c2c8255.s3.us-east-1.amazonaws.com/abc.txt?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=ASIA5GCH7TYAE664OJNK%2F20220102%2Fus-east-1%2Fs3%2Faws4_request&amp;X-Amz-Date=20220102T075911Z&amp;X-Amz-Expires=900&amp;X-Amz-Security-Token=</a>...</span></pre><p id="2235" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">用VS代码启动Thunder客户端，用URL创建一个新的PUT请求，选择二进制文件作为主体。</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mp"><img src="../Images/cce97d0d6af59c4bcdafc501881a3bde.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CjVZZW5FedjCF7cuujcwtA.png"/></div></div></figure><p id="d88b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">请求成功了。我们现在看到文件abc.txt被上传到S3存储桶中。</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mq"><img src="../Images/8902235c64eec18c40df6ef45b796092.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kEJNxNa_XGi7-EqAngrbog.png"/></div></div></figure></div></div>    
</body>
</html>