<html>
<head>
<title>A Button Press Implementation for Bluetooth Devices in Android</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Android中蓝牙设备的按键实现</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/a-button-press-implementation-for-bluetooth-wireless-devices-in-android-d94fc0fd5bb6?source=collection_archive---------5-----------------------#2020-06-13">https://blog.devgenius.io/a-button-press-implementation-for-bluetooth-wireless-devices-in-android-d94fc0fd5bb6?source=collection_archive---------5-----------------------#2020-06-13</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="d8c9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">大家好！</p><p id="1212" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这是我第一篇关于Android和整个媒体页面开发的文章。</p><h1 id="ca78" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">简短的介绍</h1><p id="95d4" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">在Android项目中实现蓝牙的过程中，我花了很长时间和精力，在这个领域做了一些研究:如何在不使用<strong class="jm io">广播接收器</strong>中的这种<code class="fe ll lm ln lo b">Intent.ACTION_MEDIA_BUTTON</code>的情况下更好地实现一个“按钮按压”，这在我们的时代已经不再实际。</p><p id="0515" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">因为…</p><p id="17a9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">引自谷歌:</p><p id="2e67" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">作为Android 8.0 (API级别26)后台执行限制的一部分，针对API级别26或更高的应用程序不能再在其清单中注册隐式广播的广播接收器</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div class="gh gi lp"><img src="../Images/d0c22baa3555bfd5baeacf34f3f5c7f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:440/0*iKipqfM-qSfu58aN.gif"/></div></figure><p id="4664" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">好吧。那么在这种情况下我们该怎么做呢？</p><p id="c973" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我尝试创建了一个单独的服务，在后台自己创建的服务中拦截一个活动的<strong class="jm io">媒体按钮</strong>的按下。我在下一个例子中的做法是:</p><pre class="lq lr ls lt gt lx lo ly lz aw ma bi"><span id="0ae5" class="mb kj in lo b gy mc md l me mf">class BluetoothService : Service {</span><span id="7afe" class="mb kj in lo b gy mg md l me mf">override fun onBind(intent : Intent) : IBinder {<br/>     //Return the communication channel to the service.<br/>}</span><span id="4fc5" class="mb kj in lo b gy mg md l me mf">override fun onCreate() {<br/>     super.onCreate()<br/>}</span><span id="ed82" class="mb kj in lo b gy mg md l me mf">@Override<br/>override fun onStartCommand(intent : Intent, flags : Int, startId : Int) : Int{<br/>     ...<br/>     return super.onStartCommand(intent, flags, startId);<br/>}</span><span id="58b2" class="mb kj in lo b gy mg md l me mf"><br/>override fun onDestroy() {<br/>     super.onDestroy()<br/> }<br/>}</span></pre><p id="6543" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">因此，通过创建一个基本服务(当然是在Android 8之前),一切看起来都没问题，应该可以正常工作。在<strong class="jm io">onstart命令</strong>中。我们可以简单地实现本地类，比如BluetoothAdapter、BluetoothProfile等。</p><p id="0a4f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">但是…我们不能再以服务的方式这样做了。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div class="gh gi mh"><img src="../Images/387330a5380f588fe6b4bc071957f8e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/0*SWsR4IjiffWLsWlh.gif"/></div></figure><h1 id="7c32" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">通往巅峰的路还很长…</h1><p id="d329" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">花这么多时间在这上面，再加上谷歌最新最棒的更新，后台工作应该受到限制…我知道作为一个普通的开发人员，我试图使用一些技巧？让这项服务恢复正常。我不知道谷歌会不会在我的文章后把它删掉，但似乎只对Android中的BT功能没问题，所以我很怀疑。谁知道呢..</p><h2 id="9b20" class="mb kj in bd kk mi mj dn ko mk ml dp ks jv mm mn kw jz mo mp la kd mq mr le ms bi translated">首先。</h2><p id="7227" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">我们有一个很好的监听器，叫做ServiceListener，它位于一个本地BluetoothProfile类中，允许我们监听和处理BT的连接状态:</p><pre class="lq lr ls lt gt lx lo ly lz aw ma bi"><span id="90ef" class="mb kj in lo b gy mc md l me mf">bluetoothProfileListener = object : BluetoothProfile.ServiceListener(){</span><span id="f7c5" class="mb kj in lo b gy mg md l me mf">fun onServiceConnected(profile : Int, proxy: BluetoothProfile){</span><span id="fad4" class="mb kj in lo b gy mg md l me mf">}</span><span id="0da1" class="mb kj in lo b gy mg md l me mf">fun onServiceDisconnected(profile : Int){</span><span id="f7fd" class="mb kj in lo b gy mg md l me mf">}</span><span id="33ac" class="mb kj in lo b gy mg md l me mf">}</span></pre><p id="e90e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们需要创建一个MediaSession回调监听器来拦截我们在蓝牙设备上的按钮点击:</p><pre class="lq lr ls lt gt lx lo ly lz aw ma bi"><span id="2809" class="mb kj in lo b gy mc md l me mf">private val mediaSessionCallback: MediaSession.Callback = object :        MediaSession.Callback() {        <br/>override fun onMediaButtonEvent(mediaButtonIntent: Intent): Boolean {            <br/>          <br/>val mediaButtonAction = mediaButtonIntent.action   <br/>         <br/>if (Intent.ACTION_MEDIA_BUTTON == intentAction) {                <br/>val ev = mediaButtonAction.getParcelableExtra&lt;KeyEvent&gt;(Intent.EXTRA_KEY_EVENT)                <br/>if (event != null) {                    <br/>     val action = event.action                    <br/>          if (action == KeyEvent.ACTION_DOWN) {                                                                   <br/>          }                <br/>     }            <br/>}            <br/>     return super.onMediaButtonEvent(mediaButtonIntent)        <br/>     }    <br/>}</span></pre><p id="d640" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">..我们将用它来设置onServiceConnected 中的<strong class="jm io"> AudioSession的回调。有趣是吗？我通过简单地尝试使用我所拥有的东西找到了这种方法，而不喜欢基于前台的服务功能。</strong></p><pre class="lq lr ls lt gt lx lo ly lz aw ma bi"><span id="7dfa" class="mb kj in lo b gy mc md l me mf">val audioSession = MediaSession(context, "BLUETOOTH")                    mBluetoothHeadset = proxy as BluetoothHeadset                                     audioSession.isActive = true                    audioSession.setCallback(mCallback)</span></pre><p id="68b5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">正如我所说的，我们将在ServiceConnected的override方法中使用这段代码，这是我们几行之前在这里创建的。</p><p id="b6c3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">不要忘记在蓝牙完成工作后禁用它&amp;同时实现其他对象，这些在developers.android.com教程中有介绍</p><h1 id="4dad" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">摘要</h1><p id="7c7d" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">在谷歌Android开发者页面中，缺少如何正确使用这个东西的信息，也缺少初始化MediaSession的信息。回调在那里显示为一个外部对象。出于某些原因，这种实现可能不好，但至少它可以作为临时解决方案的一个小而有用的工具。</p><p id="30cd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">为我第一篇文章中的一些错误道歉。当然，你可以用你的建议来评论如何用另一种方式来做，或者我的建议如何升级。</p><p id="7484" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">感谢您的关注。</p><p id="6793" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">干杯！</p><p id="9bf0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">#科特林</p></div></div>    
</body>
</html>