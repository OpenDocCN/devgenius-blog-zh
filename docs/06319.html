<html>
<head>
<title>Tips and Tricks to using PostgreSQL Docker Image</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 PostgreSQL Docker 映像的提示和技巧</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/tips-and-tricks-to-using-postgresql-docker-image-1c799e4ee3b8?source=collection_archive---------4-----------------------#2021-12-30">https://blog.devgenius.io/tips-and-tricks-to-using-postgresql-docker-image-1c799e4ee3b8?source=collection_archive---------4-----------------------#2021-12-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="e8a1" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用初始化脚本</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/43cc58f13ec8ff7ab7d043cabc24ac42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iM7iy7s-pZQ8enYZPh8mXw.png"/></div></div></figure><p id="e29a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">本文是系列文章的第一部分</p><ul class=""><li id="950b" class="ln lo iq kt b ku kv kx ky la lp le lq li lr lm ls lt lu lv bi translated">在这里找到第二部分:<a class="ae lw" href="https://tony-oreglia.medium.com/tips-and-tricks-to-using-postgresql-docker-image-80047673c9a5" rel="noopener"> Docker 与 Flyway 组合</a></li></ul></div><div class="ab cl lx ly hu lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ij ik il im in"><h1 id="1bbb" class="me mf iq bd mg mh mi mj mk ml mm mn mo jw mp jx mq jz mr ka ms kc mt kd mu mv bi translated">PostgreSQL Docker 映像初始化脚本故障排除</h1><p id="d8e0" class="pw-post-body-paragraph kr ks iq kt b ku mw jr kw kx mx ju kz la my lc ld le mz lg lh li na lk ll lm ij bi translated">在本文中，我将描述一些与为官方<a class="ae lw" href="https://hub.docker.com/_/postgres" rel="noopener ugc nofollow" target="_blank"> Docker Postgres 映像</a>设置初始化脚本相关的故障排除。</p><h2 id="7c08" class="nb mf iq bd mg nc nd dn mk ne nf dp mo la ng nh mq le ni nj ms li nk nl mu nm bi translated">初始化脚本的用途是什么</h2><p id="d95d" class="pw-post-body-paragraph kr ks iq kt b ku mw jr kw kx mx ju kz la my lc ld le mz lg lh li na lk ll lm ij bi translated">初始化脚本可用于创建用户、创建表和设置权限。来自官方文档(<a class="ae lw" href="https://hub.docker.com/_/postgres" rel="noopener ugc nofollow" target="_blank">此处为</a>)“初始化脚本”部分—</p><blockquote class="nn no np"><p id="4ca4" class="kr ks nq kt b ku kv jr kw kx ky ju kz nr lb lc ld ns lf lg lh nt lj lk ll lm ij bi translated">如果您想在从此映像派生的映像中进行额外的初始化，请在<code class="fe nu nv nw nx b">/docker-entrypoint-initdb.d</code>下添加一个或多个<code class="fe nu nv nw nx b">*.sql</code>、<code class="fe nu nv nw nx b">*.sql.gz</code>或<code class="fe nu nv nw nx b">*.sh</code>脚本(如果需要，创建目录)。在入口点调用<code class="fe nu nv nw nx b">initdb</code>来创建默认的<code class="fe nu nv nw nx b">postgres</code>用户和数据库之后，它将运行任何<code class="fe nu nv nw nx b">*.sql</code>文件，运行任何可执行的<code class="fe nu nv nw nx b">*.sh</code>脚本，并在启动服务之前获取在该目录中找到的任何不可执行的<code class="fe nu nv nw nx b">*.sh</code>脚本来做进一步的初始化。</p></blockquote><h1 id="5375" class="me mf iq bd mg mh ny mj mk ml nz mn mo jw oa jx mq jz ob ka ms kc oc kd mu mv bi translated">设置正确的权限</h1><p id="d0f8" class="pw-post-body-paragraph kr ks iq kt b ku mw jr kw kx mx ju kz la my lc ld le mz lg lh li na lk ll lm ij bi translated">首先要注意的是，脚本必须在本地机器上设置了可执行权限。Docker 从本地文件系统复制权限。</p><p id="ac72" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">通过查看 docker PostGIS 容器日志，很容易确定您是否有此问题。为了跟踪 PostgreSQL 容器的日志，运行</p><p id="fe22" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><code class="fe nu nv nw nx b">docker-compose logs --follow postgis</code></p><p id="f24b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果您看到类似下面的内容，那么初始化脚本的权限应该更新为可执行:</p><pre class="kg kh ki kj gt od nx oe of aw og bi"><span id="faa3" class="nb mf iq nx b gy oh oi l oj ok">postgis    | /usr/local/bin/docker-entrypoint.sh: running /docker-entrypoint-initdb.d/init.sh<br/>postgis    | /usr/local/bin/docker-entrypoint.sh: /docker-entrypoint-initdb.d/init.sh: /bin/bash: bad interpreter: Permission denied</span></pre><p id="5c07" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">要使脚本可执行，使用<code class="fe nu nv nw nx b">chmod</code>命令:</p><pre class="kg kh ki kj gt od nx oe of aw og bi"><span id="c04f" class="nb mf iq nx b gy oh oi l oj ok">chmod +x migration/bin/init/init.sh</span></pre><h1 id="d964" class="me mf iq bd mg mh ny mj mk ml nz mn mo jw oa jx mq jz ob ka ms kc oc kd mu mv bi translated">在新的 Docker 映像上重新运行初始化脚本</h1><p id="fd8e" class="pw-post-body-paragraph kr ks iq kt b ku mw jr kw kx mx ju kz la my lc ld le mz lg lh li na lk ll lm ij bi translated">如果您正在创建一个新的 docker 映像并打算启动一个新的 DB，那么需要再次运行初始化脚本。但是，在这种情况下，为了让 Postgres 映像运行脚本，需要进行一些手动清理。</p><p id="42b1" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">该文档指定了触发初始化脚本的条件。</p><blockquote class="nn no np"><p id="289f" class="kr ks nq kt b ku kv jr kw kx ky ju kz nr lb lc ld ns lf lg lh nt lj lk ll lm ij bi translated"><strong class="kt ir">警告</strong>:只有当你用一个空的数据目录启动容器时，<code class="fe nu nv nw nx b">/docker-entrypoint-initdb.d</code>中的脚本才会运行；容器启动时，任何预先存在的数据库都将保持不变。一个常见的问题是，如果您的某个<code class="fe nu nv nw nx b">/docker-entrypoint-initdb.d</code>脚本失败(这将导致 entrypoint 脚本退出),并且您的 orchestrator 使用已经初始化的数据目录重新启动容器，那么它将无法继续运行您的脚本。</p></blockquote><p id="1e15" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">因此，如果要重新初始化数据库，删除任何现有的 Postgres 数据卷是很重要的。</p><p id="8fe2" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">通过运行以下命令查找现有的数据卷</p><pre class="kg kh ki kj gt od nx oe of aw og bi"><span id="a240" class="nb mf iq nx b gy oh oi l oj ok">docker volume ls -q</span></pre><p id="7ab9" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">按名称查找卷，在我的例子中是</p><pre class="kg kh ki kj gt od nx oe of aw og bi"><span id="d40d" class="nb mf iq nx b gy oh oi l oj ok">breadcrumbs_pg_data</span></pre><p id="b152" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果它存在，运行以下命令将其删除</p><pre class="kg kh ki kj gt od nx oe of aw og bi"><span id="aee7" class="nb mf iq nx b gy oh oi l oj ok">docker volume rm breadcrumbs_pg_data</span></pre><p id="25c2" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果出现错误:</p><pre class="kg kh ki kj gt od nx oe of aw og bi"><span id="d8b3" class="nb mf iq nx b gy oh oi l oj ok">Error response from daemon: remove breadcrumbs_pg_data: volume is in use - [d473cd3b40293fc1023f1108f2b09118a59df03950178fa24e1f55c636246da8]</span></pre><p id="d84b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">然后通过容器 ID 移除指示的容器。在这种情况下:</p><pre class="kg kh ki kj gt od nx oe of aw og bi"><span id="f144" class="nb mf iq nx b gy oh oi l oj ok">docker rm d473cd3b40293fc102</span></pre><p id="ecba" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">请注意，这将删除数据库数据。小心，让这是你打算做的。</p><p id="3a42" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在应该可以使用初始化脚本创建一个新的 Postgres 映像了。</p></div></div>    
</body>
</html>