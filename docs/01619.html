<html>
<head>
<title>Quickstart with Traefik v2 on Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes 上的 Traefik v2 快速入门</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/quickstart-with-traefik-v2-on-kubernetes-e6dff0d65216?source=collection_archive---------1-----------------------#2020-07-08">https://blog.devgenius.io/quickstart-with-traefik-v2-on-kubernetes-e6dff0d65216?source=collection_archive---------1-----------------------#2020-07-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="4f61" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Traefik、Let's Encrypt 和 Cloudflare 的 5 分钟设置</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/13f63d89d75971aee349af1411c7c43c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jz4R9QR_riQsBa2BqeX36w.png"/></div></div></figure><p id="6107" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kx" href="https://containo.us/blog/traefik-2-0-6531ec5196c2/" rel="noopener ugc nofollow" target="_blank"> Traefik 2.0 于 2019 年 9 月上市</a>，发布了一系列新功能，包括支持 SNI 路由的 TCP、中间件、金丝雀/流量镜像和 Ingres route Kubernetes CRD。虽然 Containous 的团队(Traefik 的创建者)在设计从 v1 到 v2 的<a class="ae kx" href="https://docs.traefik.io/migration/v1-to-v2/" rel="noopener ugc nofollow" target="_blank">迁移步骤</a>方面做得很好，但是目前 Kubernetes 的用户指南并不多。除了文档网站上的“<a class="ae kx" href="https://docs.traefik.io/user-guides/crd-acme/" rel="noopener ugc nofollow" target="_blank"> Traefik &amp; CRD &amp;让我们加密</a>”用户指南(使用<a class="ae kx" href="https://github.com/rancher/k3s" rel="noopener ugc nofollow" target="_blank"> k3s </a> docker 图像)，我发现自己参考了网络上更广泛的 docker 教程来应用于我的 Kubernetes 集群。这是一个快速的 5 分钟端到端设置，使用 Traefik、Let's Encrypt 和 Cloudflare 处理 Kubernetes 上的 HTTPS 请求。</p><p id="61a1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="ky">在我们开始之前，如果您需要复习 Kubernetes 入口控制器、Ingres route CRD，或者比较 Traefik 和其他流行的入口控制器，请查看:</em></p><div class="kz la gp gr lb lc"><a href="https://medium.com/swlh/kubernetes-ingress-controller-overview-81abbaca19ec" rel="noopener follow" target="_blank"><div class="ld ab fo"><div class="le ab lf cl cj lg"><h2 class="bd ir gy z fp lh fr fs li fu fw ip bi translated">Kubernetes 入口控制器概述</h2><div class="lj l"><h3 class="bd b gy z fp lh fr fs li fu fw dk translated">比较 Kubernetes 的流行入口控制器，并列出选择正确控制器的重要考虑因素…</h3></div><div class="lk l"><p class="bd b dl z fp lh fr fs li fu fw dk translated">medium.com</p></div></div><div class="ll l"><div class="lm l ln lo lp ll lq kv lc"/></div></div></a></div><h2 id="4088" class="lr ls iq bd lt lu lv dn lw lx ly dp lz jy ma mb mc kc md me mf kg mg mh mi mj bi translated">先决条件</h2><p id="c118" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">要学习本教程，您需要一个安装了<a class="ae kx" href="https://helm.sh/docs/intro/install/" rel="noopener ugc nofollow" target="_blank"> Helm 3.x </a>的 Kubernetes 集群(例如 minikube、GKE、EKS、AKS 或 k3s)。</p><p id="ba89" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将 Traefik 的图表存储库添加到 Helm:</p><pre class="km kn ko kp gt mp mq mr ms aw mt bi"><span id="bc35" class="lr ls iq mq b gy mu mv l mw mx">helm repo add traefik https://containous.github.io/traefik-helm-chart</span></pre><p id="953c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您不熟悉 Traefik，以下是基本概念的概述:</p><ul class=""><li id="9d8e" class="my mz iq jp b jq jr ju jv jy na kc nb kg nc kk nd ne nf ng bi translated"><strong class="jp ir">入口点</strong>:监听进入的流量</li><li id="228e" class="my mz iq jp b jq nh ju ni jy nj kc nk kg nl kk nd ne nf ng bi translated"><strong class="jp ir">路由器:</strong>分析传入的请求并连接到服务</li><li id="c30c" class="my mz iq jp b jq nh ju ni jy nj kc nk kg nl kk nd ne nf ng bi translated"><strong class="jp ir">中间件:</strong>修改/更新请求(例如速率限制、HTTPS 重定向)</li><li id="9c9c" class="my mz iq jp b jq nh ju ni jy nj kc nk kg nl kk nd ne nf ng bi translated"><strong class="jp ir">服务:</strong>将请求转发给相应的服务器/负载均衡器/应用</li></ul><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nm"><img src="../Images/e3486624f7a600b7a8ae3787c741eaef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*aBtYT_-qpWz7hvuS.png"/></div></div><figcaption class="nn no gj gh gi np nq bd b be z dk translated">图片来源:<a class="ae kx" href="https://docs.traefik.io/routing/overview/" rel="noopener ugc nofollow" target="_blank"> Traefik Docs </a></figcaption></figure><p id="c14e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，我将使用 Cloudflare 作为 DNS 提供者，但是您也可以使用任何受 Let's Encrypt <a class="ae kx" href="https://docs.traefik.io/https/acme/#providers" rel="noopener ugc nofollow" target="_blank">支持的提供者</a>来修改指南。</p><h1 id="ef7a" class="nr ls iq bd lt ns nt nu lw nv nw nx lz ny nz oa mc ob oc od mf oe of og mi oh bi translated">让我们加密设置</h1><p id="e00d" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated"><a class="ae kx" href="https://github.com/containous/traefik-helm-chart" rel="noopener ugc nofollow" target="_blank"> Traefik v2 舵图</a>引导三个入口点:</p><ul class=""><li id="e538" class="my mz iq jp b jq jr ju jv jy na kc nb kg nc kk nd ne nf ng bi translated"><strong class="jp ir">端口 9000 上的 traefik </strong>(用于就绪和活性探测)</li><li id="12b5" class="my mz iq jp b jq nh ju ni jy nj kc nk kg nl kk nd ne nf ng bi translated"><strong class="jp ir"> web </strong>端口 80 (http)</li><li id="f087" class="my mz iq jp b jq nh ju ni jy nj kc nk kg nl kk nd ne nf ng bi translated">端口 443 (https)上的 websecure </li></ul><p id="4f76" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">定义入口点后，我们可以扩展图表，将 Let's Encrypt 用作证书解析器，并自动为您的域生成和续订证书。</p><p id="6774" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们定义一个名为<code class="fe oi oj ok mq b">letsencrypt</code>的证书解析器。创建一个名为<code class="fe oi oj ok mq b">traefik-values.yaml</code>的新 YAML 文件，并添加以下部分:</p><pre class="km kn ko kp gt mp mq mr ms aw mt bi"><span id="1b79" class="lr ls iq mq b gy mu mv l mw mx">additionalArguments:<br/>  - "--certificatesresolvers.letsencrypt.acme.email=<strong class="mq ir">&lt;your-email-here&gt;</strong>"<br/>  - "--certificatesresolvers.letsencrypt.acme.storage=/data/acme.json"<br/>  - "--certificatesresolvers.letsencrypt.acme.caserver=<a class="ae kx" href="https://acme-v02.api.letsencrypt.org/directory" rel="noopener ugc nofollow" target="_blank">https://acme-v02.api.letsencrypt.org/directory</a>"<br/>  - "--certificatesResolvers.letsencrypt.acme.dnschallenge=true"<br/>  - "--certificatesResolvers.letsencrypt.acme.dnschallenge.provider=cloudflare"<br/>  - "--api.insecure=true"<br/>  - "--accesslog=true"<br/>  - "--log.level=INFO"</span></pre><p id="2385" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们使用 dnsChallenge 选项来生成 ACME 证书，但是您也可以选择使用 tlsChallenge 或 httpChallenge。</p><h1 id="cf41" class="nr ls iq bd lt ns nt nu lw nv nw nx lz ny nz oa mc ob oc od mf oe of og mi oh bi translated">Cloudflare 设置</h1><p id="14cd" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">为了让 Let's Encrypt 使用 Cloudflare，它需要一个带有<a class="ae kx" href="https://go-acme.github.io/lego/dns/cloudflare/" rel="noopener ugc nofollow" target="_blank"> DNS:Edit 权限</a>的 API 令牌。在您的域的 API 令牌部分下，单击<code class="fe oi oj ok mq b">Create Token</code>。使用<code class="fe oi oj ok mq b">Edit zone DNS</code>模板或自定义令牌，并授予以下权限:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ol"><img src="../Images/f56700bece5862f629f21d074bb20906.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xtS4fBolPRtdzWkDUo9OdA.png"/></div></div></figure><p id="dbee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦你有了令牌，状态应该是<code class="fe oi oj ok mq b">Active</code></p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi om"><img src="../Images/03aad569a8b2c12f786abc99329d13f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B7lcjmdpL5vK1mMdoqvbrg.png"/></div></div></figure><p id="a059" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在在 Kubernetes 上，让我们创建这个秘密，这样 Traefik 就可以把它作为一个环境变量:</p><pre class="km kn ko kp gt mp mq mr ms aw mt bi"><span id="6f8f" class="lr ls iq mq b gy mu mv l mw mx">$ kubectl create secret generic cloudflare --from-literal=dns-token=<strong class="mq ir">&lt;my-cloudflare-token-here&gt;</strong></span></pre><p id="1b47" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，将 env 部分添加到您的<code class="fe oi oj ok mq b">traefik-values.yaml</code>中</p><pre class="km kn ko kp gt mp mq mr ms aw mt bi"><span id="a6b2" class="lr ls iq mq b gy mu mv l mw mx">env:<br/>  - name: CF_DNS_API_TOKEN<br/>    valueFrom:<br/>      secretKeyRef:<br/>        name: cloudflare<br/>        key: dns-token</span></pre><h1 id="ccb8" class="nr ls iq bd lt ns nt nu lw nv nw nx lz ny nz oa mc ob oc od mf oe of og mi oh bi translated">安装 Traefik</h1><p id="7e69" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">现在，通过头盔安装 Traefik:</p><pre class="km kn ko kp gt mp mq mr ms aw mt bi"><span id="5b55" class="lr ls iq mq b gy mu mv l mw mx">$ helm install traefik traefik/traefik -f traefik/traefik-values.yaml</span></pre><p id="477f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦 pod 运行正常，您就可以通过端口转发来访问 Traefik 仪表板:</p><pre class="km kn ko kp gt mp mq mr ms aw mt bi"><span id="a6bc" class="lr ls iq mq b gy mu mv l mw mx">$ <!-- -->kubectl port-forward $(kubectl get pods --selector "app.kubernetes.io/name=traefik" --output=name) 9000:9000</span></pre><p id="6056" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Helm chart 还将创建一个负载平衡器，将流量路由到 Kubernetes。记下这个 IP 地址(或 AWS 上的 ELB DNS 名称),因为我们稍后将需要它来配置 DNS 条目。</p><h1 id="e1a0" class="nr ls iq bd lt ns nt nu lw nv nw nx lz ny nz oa mc ob oc od mf oe of og mi oh bi translated">添加 IngressRoutes</h1><p id="e7a8" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">最后，让我们添加一个 IngressRoute 来看看 Traefik 的运行情况。我将使用 Grafana 作为示例服务来公开 via HTTPS。</p><p id="e0e2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过头盔安装 Grafana:</p><pre class="km kn ko kp gt mp mq mr ms aw mt bi"><span id="8555" class="lr ls iq mq b gy mu mv l mw mx">$ helm install grafana stable/grafana</span></pre><p id="8d41" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一个名为<code class="fe oi oj ok mq b">grafana.yaml</code>的新文件</p><pre class="km kn ko kp gt mp mq mr ms aw mt bi"><span id="0acf" class="lr ls iq mq b gy mu mv l mw mx">apiVersion: traefik.containo.us/v1alpha1<br/>kind: IngressRoute<br/>metadata:<br/>  name: grafana-ingress<br/>spec:<br/>  entryPoints:<br/>    - websecure<br/>  routes:<br/>  - match: Host(`<strong class="mq ir">grafana.example.com</strong>`)<br/>    kind: Rule<br/>    services:<br/>    - name: grafana<br/>      port: 3000<br/>  tls:<br/>    certResolver: letsencrypt</span></pre><p id="dcad" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">确保根据您的“让我们加密”设置更改主机名，并应用更改:</p><pre class="km kn ko kp gt mp mq mr ms aw mt bi"><span id="ebe7" class="lr ls iq mq b gy mu mv l mw mx">$ kubectl apply -f grafana.yaml</span></pre><p id="ae4a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当 Traefik 创建新的路由逻辑并生成 Let's Encrypt 证书时，切换回 Cloudflare 并添加 A 记录(grafana ),该记录指向 Traefik 的负载平衡器的 IP 地址(或 ELB DNS 条目的 CNAME)。</p><p id="93af" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">导航到<code class="fe oi oj ok mq b">grafana.example.com</code>，您应该会看到一个支持 HTTPS 的 Grafana 仪表盘:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi on"><img src="../Images/0272821c8f6de410a15df14056bd6206.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ql2574SOcf2VXACQd92b7g.png"/></div></div></figure><h1 id="f6bc" class="nr ls iq bd lt ns nt nu lw nv nw nx lz ny nz oa mc ob oc od mf oe of og mi oh bi translated">包扎</h1><p id="dbc4" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">现在我们有了一个基本的示例设置，接下来看看通过中间件启用 HTTPS 重定向或实现 IP 白名单来保护对 Grafana 的访问。您可以在 YAML 文件中扩展附加参数，或者通过 Helm 挂载 config.toml。</p><p id="7514" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要了解更多关于 Traefik 的信息，请查看<a class="ae kx" href="https://docs.traefik.io/" rel="noopener ugc nofollow" target="_blank">官方文档</a>或在<a class="ae kx" href="https://community.containo.us/c/traefik/5" rel="noopener ugc nofollow" target="_blank"> Traefik 论坛</a>上寻找支持。</p></div></div>    
</body>
</html>