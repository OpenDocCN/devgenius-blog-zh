<html>
<head>
<title>Modern Data Orchestration Stack with Prefect 2.0, Airbyte and dbt</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">具有 Prefect 2.0、Airbyte 和 dbt 的现代数据编排堆栈</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/modern-data-orchestration-stack-with-prefect-2-0-airbyte-and-dbt-e7c0e9b27add?source=collection_archive---------2-----------------------#2022-08-26">https://blog.devgenius.io/modern-data-orchestration-stack-with-prefect-2-0-airbyte-and-dbt-e7c0e9b27add?source=collection_archive---------2-----------------------#2022-08-26</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="3658" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">使用公开的新冠肺炎数据。</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/f39a399b76b88fb163aadd43662f0d8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*v6fuR1HBL4oBpL1V"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk translated">特伦斯·伯克在<a class="ae ks" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="ccea" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">在上一篇文章中，我探索了一个包含 Airbyte、Snowflake 和 dbt 的现代数据集成堆栈。在本文中，我将通过引入<strong class="kv io">编排</strong>来进一步探索现代数据堆栈。在这个更高层次的抽象层中，我集成了<a class="ae ks" href="https://www.prefect.io/opensource/v2/" rel="noopener ugc nofollow" target="_blank">perfect 2.0</a>，来处理 ELT 管道的工作流。因为这篇文章是上一篇文章的延续，所以我使用了相同的数据，公开可用的来自 Google BigQuery 公共数据集项目的<a class="ae ks" href="https://console.cloud.google.com/marketplace/product/bigquery-public-datasets/covid19-public-data-program" rel="noopener ugc nofollow" target="_blank">新冠肺炎数据。</a></p><div class="lp lq gp gr lr ls"><a href="https://medium.com/@adebayoadejare/modern-data-integration-stack-with-airbyte-snowflake-and-dbt-795fdecf2035" rel="noopener follow" target="_blank"><div class="lt ab fo"><div class="lu ab lv cl cj lw"><h2 class="bd io gy z fp lx fr fs ly fu fw im bi translated">具有 Airbyte、Snowflake 和 dbt 的现代数据集成堆栈</h2><div class="lz l"><h3 class="bd b gy z fp lx fr fs ly fu fw dk translated">使用公开的新冠肺炎数据</h3></div><div class="ma l"><p class="bd b dl z fp lx fr fs ly fu fw dk translated">medium.com</p></div></div><div class="mb l"><div class="mc l md me mf mb mg km ls"/></div></div></a></div><p id="0ace" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><strong class="kv io">设置</strong></p><p id="0834" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">在进入<strong class="kv io">流程</strong>之前，我将描述整个编排的架构和设置。我使用<a class="ae ks" href="https://www.docker.com/" rel="noopener ugc nofollow" target="_blank"> Docker </a>容器来为 Prefect 和 dbt CLI 安装 Airbyte 和 python pip。我用雪花做数据仓库。我使用<a class="ae ks" href="https://docs.prefect.io/ui/overview/" rel="noopener ugc nofollow" target="_blank"> Prefect 2.0 Orion 用户界面</a>来监控流的状态并配置相关的通知。主流程包含一个空气字节<strong class="kv io">提取和加载</strong>增量同步子流程以及一个 dbt <strong class="kv io">转换</strong>子流程。一旦流进入完成状态，它将发送一个松弛通知。</p><ul class=""><li id="30a1" class="mh mi in kv b kw kx kz la lc mj lg mk lk ml lo mm mn mo mp bi translated">提督 2.0 版本 2 . 1 . 1；提督-air byte v 0 . 1 . 0；提督-dbt v0.2.0</li><li id="7b01" class="mh mi in kv b kw mq kz mr lc ms lg mt lk mu lo mm mn mo mp bi translated">Airbyte 版本 1.2.3</li><li id="067a" class="mh mi in kv b kw mq kz mr lc ms lg mt lk mu lo mm mn mo mp bi translated">dbt CLI:dbt core v 1 . 2 . 0；dbt-雪花 1.2.0 版</li></ul><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi mv"><img src="../Images/2533fa5fc4526ca7b8135d1197553382.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-Rt9Xcy9wQu72pF3TYyx3g.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk translated">作者图片</figcaption></figure><h2 id="4143" class="mw mx in bd my mz na dn nb nc nd dp ne lc nf ng nh lg ni nj nk lk nl nm nn no bi translated"><strong class="ak">编排</strong></h2><p id="97c1" class="pw-post-body-paragraph kt ku in kv b kw np jo ky kz nq jr lb lc nr le lf lg ns li lj lk nt lm ln lo ig bi translated">我将整合一个完美的流程与现有的 ELT 管道。完美的哲学是建立在最小化负面数据工程的基础上的。在工作流程中，这些都是失败的场景，通常是消耗主要“正面”数据工程目标的努力的意外事件。</p><blockquote class="nu"><p id="f651" class="nv nw in bd nx ny nz oa ob oc od lo dk translated">perfect Workflow Orchestration tool 是建立在提高数据工程生产力的基础上的，它可以更容易地减轻负面的工程失败场景。</p></blockquote><p id="11ed" class="pw-post-body-paragraph kt ku in kv b kw oe jo ky kz of jr lb lc og le lf lg oh li lj lk oi lm ln lo ig bi translated">这意味着使用 Prefect 工具实现防御性编程模式相对简单直接，通常采用单行代码或函数参数的形式。我实现的完美流将有两个子流，对于这两个子流，我都实现了完美集合。级长集合包含预定义的任务，通常由级长团队维护。</p><ol class=""><li id="ba5c" class="mh mi in kv b kw kx kz la lc mj lg mk lk ml lo oj mn mo mp bi translated">提取和加载:我使用<a class="ae ks" href="https://prefecthq.github.io/prefect-airbyte/" rel="noopener ugc nofollow" target="_blank"> Airbyte 集合</a>定义了一个子流。这个流程将触发数据集的手动增量同步任务，我从流行病学数据集开始，因为这个特定的同步容易失败，可以很容易地重写以包括其他数据集。我将该任务设置为失败时重试 3 次，重试延迟为 300 秒。我还为任务添加了一个“sync”标签，在配置通知时可能会用到这个标签。</li><li id="fd3f" class="mh mi in kv b kw mq kz mr lc ms lg mt lk mu lo oj mn mo mp bi translated">转换:我使用<a class="ae ks" href="https://prefecthq.github.io/prefect-dbt/" rel="noopener ugc nofollow" target="_blank"> dbt 集合</a>定义了一个子流程，从下面的预定义 repo 运行 dbt 转换项目。该任务同样配置了 2 次重试和 30 秒重试延迟，同样，我添加了“transform”标签。</li></ol><div class="lp lq gp gr lr ls"><a href="https://github.com/BayoAdejare/airbyte_dbt_covid19" rel="noopener  ugc nofollow" target="_blank"><div class="lt ab fo"><div class="lu ab lv cl cj lw"><h2 class="bd io gy z fp lx fr fs ly fu fw im bi translated">GitHub-BayoAdejare/airbyte _ dbt _ covid 19:雪花数据仓库的 dbt 转换。</h2><div class="lz l"><h3 class="bd b gy z fp lx fr fs ly fu fw dk translated">雪花数据仓库的 dbt 改造项目。对分段雪花数据执行基本转换…</h3></div><div class="ma l"><p class="bd b dl z fp lx fr fs ly fu fw dk translated">github.com</p></div></div><div class="mb l"><div class="ok l md me mf mb mg km ls"/></div></div></a></div><p id="f83b" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">对于自定义的 Slack 通知，这将发送复制和转换任务的结果，并将在 Prefect Orion UI 上配置。目前，我对运行、挂起或其他状态不感兴趣，只关心完成或失败时的通知。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ol"><img src="../Images/c07bd3db2612a4a4fd221e838d3f5a81.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PsfbIEfR2ZA29Rldue0NkA.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk translated">提督 2.0 任务状态(图片由提督提供)</figcaption></figure><h2 id="a9ff" class="mw mx in bd my mz na dn nb nc nd dp ne lc nf ng nh lg ni nj nk lk nl nm nn no bi translated">定义流程</h2><p id="616e" class="pw-post-body-paragraph kt ku in kv b kw np jo ky kz nq jr lb lc nr le lf lg ns li lj lk nt lm ln lo ig bi translated">由于工作流很简单，python 脚本将使用函数而不是类来编写。我创建了一个编排文件<code class="fe om on oo op b">elt_flow.py</code>来处理流配置和定义。在这个文件中，我定义了前面描述的两个子流函数，并将它们添加到主流函数中。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="oq or l"/></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk translated">编排 ELT 流程定义(按作者)</figcaption></figure><h2 id="10f2" class="mw mx in bd my mz na dn nb nc nd dp ne lc nf ng nh lg ni nj nk lk nl nm nn no bi translated">配置通知</h2><p id="1b1e" class="pw-post-body-paragraph kt ku in kv b kw np jo ky kz nq jr lb lc nr le lf lg ns li lj lk nt lm ln lo ig bi translated"><code class="fe om on oo op b">If a run of any flow with a sync or transform tag enters Completed or Failed state, send a notification to <strong class="kv io">Slack</strong></code></p><p id="4753" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">我将为上面的语句实现通知或类似的东西，为了让通知工作，我首先需要生成一个 Slack webhook。我为一个 Slack 应用程序这样做，我将它配置为一个 Slack bot，在一个特定的工作空间上使用，允许访问一个通道，我省略了这个细节，因为这不是本文的重点。</p><p id="a92c" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">我运行下面的命令<code class="fe om on oo op b">prefect orion start</code>来查看完整的仪表板 UI，从 UI 中，我能够导航到侧面板中的通知选项并配置 Slack 通知:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi os"><img src="../Images/fafdc93a61bf402fc0ae18ea16eedf95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*34RWsVHrZ2Xe6Duwi8wsig.gif"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk translated">从 Prefect Orion UI 添加松弛通知(按作者)</figcaption></figure><p id="0b02" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">我为 to Airbyte 复制和 dbt 转换流中的任务的<code class="fe om on oo op b">Completed</code>或<code class="fe om on oo op b">Failed</code>状态配置通知。这导致这些结果状态的以下松弛通信:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ot"><img src="../Images/2c95eaf3533047e3158563eab099277c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-P_fCMeUbZUn4UKslD41kw.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk translated">松弛频道中的完美服务通知(按作者)</figcaption></figure><p id="8fe3" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><strong class="kv io">总之</strong></p><p id="6d44" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">如图所示，Prefect 通过无缝轻松地实现负面工程模式节省了开发时间和精力。例如，我能够用 python decorators 在增量同步和转换任务上实现重试和延迟机制。此外，通过使用集合和标签，我能够轻松地从 Orion 的直观用户界面配置各种通知场景，从而最大限度地减少负面工程，让更多的资源专注于主要目标。</p><p id="70eb" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">注意:</p><ul class=""><li id="47dc" class="mh mi in kv b kw kx kz la lc mj lg mk lk ml lo mm mn mo mp bi translated">在<a class="ae ks" href="https://www.snowflake.com/news/starschema-brings-single-source-of-truth-for-covid-19-incidence-data-to-snowflake-data-exchange/" rel="noopener ugc nofollow" target="_blank">雪花数据交换这里</a>一个类似的<a class="ae ks" href="https://github.com/starschema/COVID-19-data" rel="noopener ugc nofollow" target="_blank">工作流编排与气流但是有更多公共数据源</a>的新冠肺炎案例由<a class="ae ks" href="https://starschema.com/" rel="noopener ugc nofollow" target="_blank"> Starschema </a>完成。</li><li id="b228" class="mh mi in kv b kw mq kz mr lc ms lg mt lk mu lo mm mn mo mp bi translated">如果您不熟悉完美编排，请查阅<a class="ae ks" href="https://www.prefect.io/guide/blog/introducing-prefect-2-0" rel="noopener ugc nofollow" target="_blank">完美文档</a>。</li><li id="8461" class="mh mi in kv b kw mq kz mr lc ms lg mt lk mu lo mm mn mo mp bi translated"><a class="ae ks" href="https://airbyte.com/tutorials/elt-pipeline-prefect-airbyte-dbt" rel="noopener ugc nofollow" target="_blank">示例教程</a>来自 Airbyte，具有类似的工作流程编排。</li><li id="f6b0" class="mh mi in kv b kw mq kz mr lc ms lg mt lk mu lo mm mn mo mp bi translated">完善关于<a class="ae ks" href="https://docs.prefect.io/ui/notifications/" rel="noopener ugc nofollow" target="_blank">通知</a>的文档。</li></ul><p id="d225" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><strong class="kv io"> <em class="ou">感谢</em> </strong> <em class="ou">的阅读！如果你想与我取得联系，请随时联系我在 adebayo.adejare@gmail.com 或我的</em> <a class="ae ks" href="https://www.linkedin.com/in/adebayoadejare/" rel="noopener ugc nofollow" target="_blank"> <em class="ou">领英简介</em> </a> <em class="ou">。也可以在我的</em><a class="ae ks" href="https://github.com/BayoAdejare" rel="noopener ugc nofollow" target="_blank"><em class="ou">Github</em></a><em class="ou">中查看部分代码。</em></p></div></div>    
</body>
</html>