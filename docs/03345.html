<html>
<head>
<title>Best of Modern JavaScript — Maps and WeakMaps</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">现代JavaScript的精华——地图和WeakMaps</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/best-of-modern-javascript-maps-and-weakmaps-15ae4a9c2632?source=collection_archive---------10-----------------------#2020-10-24">https://blog.devgenius.io/best-of-modern-javascript-maps-and-weakmaps-15ae4a9c2632?source=collection_archive---------10-----------------------#2020-10-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/3c1074bae59431d0114158e60a0e6a82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*X73NCdFq5SRpbbXs"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated"><a class="ae kc" href="https://unsplash.com/@kyllik?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">库利基图斯</a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</figcaption></figure><p id="66b6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">自2015年以来，JavaScript有了巨大的进步。</p><p id="c894" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在用起来比以前舒服多了。</p><p id="193a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这篇文章中，我们将看看地图和弱地图。</p><h1 id="9b92" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">迭代和循环遍历地图</h1><p id="91df" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以用各种方法迭代和循环遍历地图。</p><p id="0ca7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">Map.prototype.entries</code>返回一个iterable对象，为我们的映射的每一个条目提供键值对数组。</p><p id="4e78" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">Map.prototype.forEach</code>接受一个带有签名<code class="fe me mf mg mh b">(value, key, collection)</code>的回调，让我们遍历地图。</p><p id="6b62" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">value</code>有地图条目的值。</p><p id="e821" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">key</code>拥有地图入口的钥匙。</p><p id="7190" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">collection</code>有地图本身。</p><p id="5e4d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它的第二个参数是回调函数中<code class="fe me mf mg mh b">this</code>的值。</p><p id="56e2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">Map.prototype.keys</code>返回一个带有映射键的iterable。</p><p id="51df" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">Map.prototype.values</code>返回映射中所有值的iterable。</p><p id="f239" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">Map.prototype[Symbol.iterator]</code>是遍历地图的默认方法。</p><p id="a1b6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它返回一个带有键值对数组的iterable。</p><h1 id="6368" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">WeakMap</h1><p id="61c4" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">WeakMaps的工作方式很像地图。</p><p id="92ad" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">WeakMaps键是对象。他们很脆弱。</p><p id="886f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们无法用一张地图查看所有条目。</p><p id="ef4c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们无法清除地图。</p><p id="ab7f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们必须放入对象作为键，所以我们不能写。</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="d6cf" class="mq lc iq mh b gy mr ms l mt mu">const wm = new WeakMap()</span><span id="dd46" class="mq lc iq mh b gy mv ms l mt mu">wm.set('foo', 123);</span></pre><p id="1e37" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因为这样做我们会得到一个类型错误。</p><p id="23b9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但是我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="7ee9" class="mq lc iq mh b gy mr ms l mt mu">const wm = new WeakMap()</span><span id="796c" class="mq lc iq mh b gy mv ms l mt mu">wm.set({}, 123);</span></pre><p id="8998" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">WeakMap键握得不牢。</p><p id="8f1d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这意味着没有被任何对象或属性引用的对象可以被垃圾回收。</p><p id="4e90" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">除非它们被藏在某个地方，否则我们无法接近它们。</p><p id="db89" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦钥匙不见了，那么条目也就消失了。</p><p id="3508" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们无法得到一张地图的概貌。</p><p id="ab3e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是因为没有办法检查它的内部。</p><p id="55ed" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">获取WeakMap内容的唯一方法是通过密钥获取内容。</p><p id="a3ed" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">WeakMap的用例包括缓存、管理侦听器和保存私有数据。</p><p id="0d23" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用WeakMaps，我们可以用它缓存一个对象，因为我们只能有对象键。</p><p id="a275" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="8df3" class="mq lc iq mh b gy mr ms l mt mu">const cache = new WeakMap();</span><span id="9491" class="mq lc iq mh b gy mv ms l mt mu">function countOwnKeys(obj) {<br/>  if (cache.has(obj)) {<br/>    return cache.get(obj);<br/>  } else {<br/>    const num = Math.random();<br/>    cache.set(obj, num);<br/>    return num;<br/>  }<br/>}</span></pre><p id="36d9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创建一个WeakMap并获取条目(如果该键存在)</p><p id="ea55" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">否则，我们向WeakMap添加一个条目。</p><p id="88bc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们还可以使用它们将侦听器存储在WeakMap中。</p><p id="dab8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="817e" class="mq lc iq mh b gy mr ms l mt mu">const listeners = new WeakMap();</span><span id="e4e5" class="mq lc iq mh b gy mv ms l mt mu">function addListener(obj, listener) {<br/>  if (!listeners.has(obj)) {<br/>    listeners.set(obj, new Set());<br/>  }<br/>  listeners.get(obj).add(listener);<br/>}</span></pre><p id="3365" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们使用<code class="fe me mf mg mh b">addListener</code>函数将事件监听器添加到集合中，如果它还不存在的话。</p><p id="0653" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果<code class="fe me mf mg mh b">obj</code>不在WeakMap中，那么我们创建一个条目，将<code class="fe me mf mg mh b">obj</code>作为键，将set作为值。</p><p id="cf49" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它对于保存私有数据也很有用，因为我们需要引用key对象来获取条目。</p><p id="a98b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所以我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="949f" class="mq lc iq mh b gy mr ms l mt mu">const _counter = new WeakMap();</span><span id="4db4" class="mq lc iq mh b gy mv ms l mt mu">class Countdown {<br/>  constructor(counter) {<br/>    _counter.set(this, counter);<br/>  }</span><span id="5b28" class="mq lc iq mh b gy mv ms l mt mu">  increment() {<br/>    let counter = _counter.get(this);<br/>    if (counter &lt; 1) {<br/>      return;<br/>    }<br/>    counter++;<br/>    _counter.set(this, counter);<br/>  }<br/>}</span></pre><p id="f40a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">用构造函数中的<code class="fe me mf mg mh b">set</code>方法调用将<code class="fe me mf mg mh b">counter</code>存储在WeakMap中。</p><p id="27a7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在<code class="fe me mf mg mh b">increment</code>方法中，我们用<code class="fe me mf mg mh b">_counter.get</code>方法得到计数器。</p><p id="bb27" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们递增<code class="fe me mf mg mh b">counter</code>并用<code class="fe me mf mg mh b">set</code>设置新值。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mw"><img src="../Images/adf6d4f4cfcf30f38d4da0202901594c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*VnLzP0-PhxYmEkCI"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">照片由<a class="ae kc" href="https://unsplash.com/@iristimmermans?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">艾里斯·蒂默曼斯</a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><h1 id="5c79" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="bd76" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以用各种方法遍历地图。</p><p id="074a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，WeakMaps可以用于存储私有数据、缓存等等。</p></div></div>    
</body>
</html>