<html>
<head>
<title>How to bootstrap multi node Kubernetes cluster on Azure using Kubeadm</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Kubeadm在Azure上引导多节点Kubernetes集群</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/how-to-bootstrap-multi-node-kubernetes-cluster-on-azure-using-kubeadm-211726acaf3a?source=collection_archive---------11-----------------------#2021-12-15">https://blog.devgenius.io/how-to-bootstrap-multi-node-kubernetes-cluster-on-azure-using-kubeadm-211726acaf3a?source=collection_archive---------11-----------------------#2021-12-15</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div class="gh gi jk"><img src="../Images/c68f1ae86c3ab29c93dc0b2d00071bb0.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/0*T1OXeMevsBF-oE7J"/></div></figure><h1 id="7463" class="jr js in bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">背景</h1><p id="5eed" class="pw-post-body-paragraph kp kq in kr b ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">在之前的<a class="ae ln" href="https://www.handsonarchitect.com/2021/12/how-to-prepare-for-cka-certification.html" rel="noopener ugc nofollow" target="_blank">帖子</a>中，我分享了我准备和通过<strong class="kr io">认证Kubernetes管理员(CKA) </strong>的经历。目前，我正在准备<strong class="kr io">认证的Kubernetes应用开发者(CKAD) </strong>。为了准备这个认证，我需要一个可以练习的Kubernetes集群。我决定使用Kubeadm在Microsoft Azure上创建一个3节点Kubernetes集群。这篇文章是在Azure上用1.22版本创建Kubernetes集群的一步一步的过程。</p><h1 id="fb16" class="jr js in bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">使用kubeadm在Azure上引导k8s集群</h1><p id="d2a9" class="pw-post-body-paragraph kp kq in kr b ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">在撰写本文时，<a class="ae ln" href="https://www.cncf.io/certification/ckad/" rel="noopener ugc nofollow" target="_blank"> CKAD认证</a>基于Kubernetes 的<a class="ae ln" href="https://github.com/cncf/curriculum/blob/master/CKAD_Curriculum_v1.22.pdf" rel="noopener ugc nofollow" target="_blank"> 1.22版本。Kubernetes </a>最新稳定<a class="ae ln" href="https://kubernetes.io/releases/" rel="noopener ugc nofollow" target="_blank">版本为<strong class="kr io"> 1.23 </strong>。因此，我需要一种方法来为集群提供Kubernetes的早期版本，而不是最新版本。这就是为什么我决定在微软Azure上提供Ubuntu虚拟机，并用1.22 版本引导Kubernetes集群。</a></p><p id="f46e" class="pw-post-body-paragraph kp kq in kr b ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ls lk ll lm ig bi translated">以下是在Azure上设置全新集群所需的高级步骤:</p><ul class=""><li id="d845" class="lt lu in kr b ks lo kw lp la lv le lw li lx lm ly lz ma mb bi translated">调配3个Ubuntu虚拟机</li><li id="fa15" class="lt lu in kr b ks mc kw md la me le mf li mg lm ly lz ma mb bi translated">在每个节点上设置Docker、kubeadm、kubectl和Kubelet</li><li id="14ab" class="lt lu in kr b ks mc kw md la me le mf li mg lm ly lz ma mb bi translated">在主节点上安装控制平面组件</li><li id="3fdf" class="lt lu in kr b ks mc kw md la me le mf li mg lm ly lz ma mb bi translated">设置pod网络</li><li id="2637" class="lt lu in kr b ks mc kw md la me le mf li mg lm ly lz ma mb bi translated">将工作节点加入集群</li></ul><h1 id="da62" class="jr js in bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">在Azure上配置Ubuntu虚拟机</h1><p id="089a" class="pw-post-body-paragraph kp kq in kr b ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">有多种方式可以使用门户、Azure CLI、ARM模板等在Azure上配置虚拟机。我更喜欢使用Azure CLI命令来配置虚拟机。多年来，我使用了一些Powershell脚本来提供Azure资源。在这种情况下，我创建了一个小的Powershell脚本，为Azure上的3个Ubuntu虚拟机提供公共IP。你可以在<a class="ae ln" href="https://github.com/NileshGule/ckad-exam-prep" rel="noopener ugc nofollow" target="_blank"> Github库</a>中找到<a class="ae ln" href="https://github.com/NileshGule/ckad-exam-prep/blob/main/cluster-setup/k8s-azure.ps1" rel="noopener ugc nofollow" target="_blank">脚本</a>。还有一个附带的<a class="ae ln" href="https://github.com/NileshGule/ckad-exam-prep/blob/main/cluster-setup/cluster-setup.md" rel="noopener ugc nofollow" target="_blank"> markdown </a>文件，该文件介绍了设置集群的不同步骤。脚本是参数化的，在执行脚本时可以覆盖以下参数</p><ul class=""><li id="967d" class="lt lu in kr b ks lo kw lp la lv le lw li lx lm ly lz ma mb bi translated">订阅名称</li><li id="a491" class="lt lu in kr b ks mc kw md la me le mf li mg lm ly lz ma mb bi translated">资源组名称</li><li id="cdbb" class="lt lu in kr b ks mc kw md la me le mf li mg lm ly lz ma mb bi translated">资源组位置</li></ul><h1 id="a0c4" class="jr js in bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">在每个节点上设置Docker、kubeadm、kubectl和Kubelet</h1><p id="bff0" class="pw-post-body-paragraph kp kq in kr b ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">一旦配置了虚拟机，我们就需要在每个节点上设置Docker、Kubeadm、Kubectl和Kubelet。使用VM配置期间提供的RSA密钥，我通过ssh进入每个节点并设置这些先决条件。下面是一个如何登录到主节点的示例</p><p id="5e57" class="pw-post-body-paragraph kp kq in kr b ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ls lk ll lm ig bi translated"><strong class="kr io"> ssh -i ~/。ssh/id_rsa </strong> <a class="ae ln" href="https://www.handsonarchitect.com/cdn-cgi/l/email-protection" rel="noopener ugc nofollow" target="_blank"> <strong class="kr io">【邮件保护】</strong> </a></p><p id="13b7" class="pw-post-body-paragraph kp kq in kr b ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ls lk ll lm ig bi translated">您可以替换worker-1和worker-2的主机名，以分别登录到这些虚拟机。</p><p id="549a" class="pw-post-body-paragraph kp kq in kr b ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ls lk ll lm ig bi translated">安装Docker并启用守护进程，这样，如果虚拟机重新启动，Docker就会重新启动。</p><p id="9904" class="pw-post-body-paragraph kp kq in kr b ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ls lk ll lm ig bi translated"><strong class="kr io"> sudo安装docker . io-y</strong>T8】sudo系统ctl启用docker </p><p id="9f25" class="pw-post-body-paragraph kp kq in kr b ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ls lk ll lm ig bi translated">kubeadm、kubectl和kubelet的当前版本是1.23，但我们需要1.22。我们在安装命令中指定版本，如下所示</p><p id="b31c" class="pw-post-body-paragraph kp kq in kr b ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ls lk ll lm ig bi translated"><strong class="kr io">sudo apt install kube ADM = 1 . 22 . 0–00 kube CTL = 1 . 22 . 0–00 kube let = 1 . 22 . 0–00-y</strong></p><p id="369c" class="pw-post-body-paragraph kp kq in kr b ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ls lk ll lm ig bi translated">安装了这些先决条件之后，我们就可以安装Kubernetes集群了。</p><h1 id="4f6b" class="jr js in bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">在主节点上安装控制平面组件</h1><p id="2f6e" class="pw-post-body-paragraph kp kq in kr b ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">在使用Kubeadm init命令初始化控制平面组件之前，我们需要对Docker和Kubelet设置进行一些修改。这是为了将systemd设置为组驱动程序。这个设置必须与容器运行时和kubelet相匹配。更多详情请参考<a class="ae ln" href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/" rel="noopener ugc nofollow" target="_blank"> Kubernetes文档</a>。</p><p id="acb5" class="pw-post-body-paragraph kp kq in kr b ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ls lk ll lm ig bi translated">我们覆盖Docker守护进程的配置，如下所示</p><p id="1525" class="pw-post-body-paragraph kp kq in kr b ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ls lk ll lm ig bi translated"><strong class="kr io">cat&lt;&lt;EOF | sudo tee/etc/docker/daemon . JSON<strong class="kr io">{</strong><strong class="kr io">" exec-opts ":[" native . cgroupdriver = systemd "]，</strong><strong class="kr io">" log-driver ":" JSON-file "，</strong><strong class="kr io">" log-opts ":{</strong><strong class="kr io">" max-size ":" 100m "</strong><strong class="kr io">}，</strong></strong></p><p id="b52e" class="pw-post-body-paragraph kp kq in kr b ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ls lk ll lm ig bi translated">这需要在所有节点上完成。在主节点上，我们还覆盖了Kubelet的配置。你可以在repo中找到<a class="ae ln" href="https://github.com/NileshGule/ckad-exam-prep/blob/main/cluster-setup/kubeadm-config.yaml" rel="noopener ugc nofollow" target="_blank"> kubeadm config yaml文件</a>。我们将该文件作为被覆盖的配置与kubeadm init命令一起使用，如下所示</p><p id="227c" class="pw-post-body-paragraph kp kq in kr b ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ls lk ll lm ig bi translated"><strong class="kr io">sudo kube ADM init—config kube ADM-config . YAML</strong></p><p id="5c84" class="pw-post-body-paragraph kp kq in kr b ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ls lk ll lm ig bi translated">通过这些覆盖，我们应该已经配置了主节点。</p><h1 id="2192" class="jr js in bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">设置pod网络</h1><p id="1a8d" class="pw-post-body-paragraph kp kq in kr b ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">Kubernetes默认没有内置pod网络。我们需要建立自己的基于容器网络接口(CNI)的pod网络，以便pod可以相互通信。在此步骤完成之前，CoreDNS不会启动。我们将使用来自Weaveworks的<a class="ae ln" href="https://www.weave.works/oss/net/" rel="noopener ugc nofollow" target="_blank"> weavenet </a>。</p><p id="a113" class="pw-post-body-paragraph kp kq in kr b ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ls lk ll lm ig bi translated">【"https://cloud.weave.works/k8s/net】ku bectl apply-f？k8s-version = $(kubectl version | base64 | tr-d ' \ n ')"</p><p id="8da8" class="pw-post-body-paragraph kp kq in kr b ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ls lk ll lm ig bi translated">在应用上述清单文件后，确保主节点处于就绪状态。</p><h1 id="3789" class="jr js in bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">将工作节点加入集群</h1><p id="fef2" class="pw-post-body-paragraph kp kq in kr b ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">在worker节点上安装Docker、Kubeadm、Kubectl和Kubelet的步骤完全相同。不同之处在于Kubelet配置覆盖。我们不需要在worker节点上这样做。然而，我们仍然需要覆盖Docker守护进程的配置。</p><p id="09d6" class="pw-post-body-paragraph kp kq in kr b ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ls lk ll lm ig bi translated">最后一步是将工作节点加入集群。当控制平面在主节点上准备就绪时，join命令将与复制Kubeconfig文件的步骤一起输出。在每个节点上运行join命令，并验证所有3个节点都显示为就绪状态。</p><p id="94ea" class="pw-post-body-paragraph kp kq in kr b ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ls lk ll lm ig bi translated">请注意，在您的环境中，IP、令牌和ca-cert哈希的值会有所不同。</p><h1 id="fcfb" class="jr js in bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">Youtube视频</h1><p id="0592" class="pw-post-body-paragraph kp kq in kr b ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">Youtube视频演示了上面提到的所有步骤，以及其他细节，如设置bash概要文件和用测试部署测试集群。观看视频，了解它的实际应用。</p><figure class="mh mi mj mk gt jo"><div class="bz fp l di"><div class="ml mm l"/></div></figure><h1 id="b474" class="jr js in bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">结论</h1><p id="ae13" class="pw-post-body-paragraph kp kq in kr b ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">Kubernetes 1.22版本需要对Docker和Kubelet配置进行一些覆盖，以便使用Kubeadm进行引导。一旦准备好基于Ubuntu的虚拟机，这里演示的步骤可以在其他云提供商上使用，以建立类似的集群。希望这有助于您了解更多关于Kubernetes的信息。</p><p id="a8a9" class="pw-post-body-paragraph kp kq in kr b ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ls lk ll lm ig bi translated">直到下一次，激情编码，精益求精。</p></div><div class="ab cl mn mo hr mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="ig ih ii ij ik"><p id="54ed" class="pw-post-body-paragraph kp kq in kr b ks lo ku kv kw lp ky kz la lq lc ld le lr lg lh li ls lk ll lm ig bi translated"><em class="mu">原载于2021年12月15日</em><a class="ae ln" href="https://www.handsonarchitect.com/2021/12/how-to-bootstrap-multi-node-kubernetes.html" rel="noopener ugc nofollow" target="_blank"><em class="mu">https://www.handsonarchitect.com</em></a><em class="mu">。</em></p></div></div>    
</body>
</html>