<html>
<head>
<title>Custom WSL distros using Docker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Docker 定制 WSL 发行版</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/custom-wsl-distros-using-docker-1a326eedce46?source=collection_archive---------7-----------------------#2022-01-04">https://blog.devgenius.io/custom-wsl-distros-using-docker-1a326eedce46?source=collection_archive---------7-----------------------#2022-01-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="75f9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">关于如何创建可定制和可复制的 WSL 发行版的指南，该发行版可以在您的开发团队之间共享，以保持您的本地设置相同，这样我们就可以减少<em class="kl">“它在我的机器上工作…”的</em>时刻。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/4c85440236e98f9049e2c5a9f792ea9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rTf8Z7xwET3F_Q4v2c2NAw.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">WSL 自动设置正在运行。</figcaption></figure><h1 id="cf57" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">介绍</h1><p id="a980" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">在软件开发团队中工作有起有落。对我来说，开始时的一个大问题是每个团队成员设置开发机器的方式不一致。是的，我知道每个人都有不同的品味和偏好……但是有些不一致可以归结为没有固定的做事方式，或者人们尝试了一种不起作用的方式，所以他们找到了自己的解决方案。</p><p id="6b57" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">根据我自己的经验，这个问题是一个团队成员可能使用 VM 进行开发，而另一个成员使用 WSL、Git Bash 或 CMD。这导致在试图互相帮助解决常见问题或解释如何做某事时出现许多问题，因为每个不同的设置需要不同的程序或不同的工具，更不用说工具版本的不一致了。</p><h2 id="f5d1" class="mf ld iq bd le mg mh dn li mi mj dp lm jy mk ml lq kc mm mn lu kg mo mp ly mq bi translated">好吧，你已经表达了你的观点，你的解决方案是什么？</h2><p id="b6f3" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">当然，没有一个<strong class="jp ir"><em class="kl"/></strong>的方案可以解决上述问题。然而，我决定采用的解决方案是使用 WSL，但不是以通常的方式。为了确保任何使用该设置的人都能以几乎镜像的方式完成安装，我创建了一组脚本和一个 docker 文件来完成一些事情。</p><ul class=""><li id="c01a" class="mr ms iq jp b jq jr ju jv jy mt kc mu kg mv kk mw mx my mz bi translated">安装所有需要的工具… java，maven 等</li><li id="4b49" class="mr ms iq jp b jq na ju nb jy nc kc nd kg ne kk mw mx my mz bi translated">创建新用户(基于运行脚本的用户)</li><li id="ead8" class="mr ms iq jp b jq na ju nb jy nc kc nd kg ne kk mw mx my mz bi translated">复制默认的. bashrc 文件以获得一致的别名和函数</li></ul><blockquote class="nf ng nh"><p id="b043" class="jn jo kl jp b jq jr js jt ju jv jw jx ni jz ka kb nj kd ke kf nk kh ki kj kk ij bi translated">这里还可以做许多其他事情，比如为您的环境设置任何所需的网络。对于我自己的工作场所，这需要通过 VPN 连接到互联网，但我在这里没有提到它，因为它可能不会转移到其他用例。</p></blockquote></div><div class="ab cl nl nm hu nn" role="separator"><span class="no bw bk np nq nr"/><span class="no bw bk np nq nr"/><span class="no bw bk np nq"/></div><div class="ij ik il im in"><h1 id="64be" class="lc ld iq bd le lf ns lh li lj nt ll lm ln nu lp lq lr nv lt lu lv nw lx ly lz bi translated">我们开始吧</h1><h2 id="dfc8" class="mf ld iq bd le mg mh dn li mi mj dp lm jy mk ml lq kc mm mn lu kg mo mp ly mq bi translated">先决条件</h2><p id="c928" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">在进行安装之前，有几个要求，它们是:</p><ul class=""><li id="3229" class="mr ms iq jp b jq jr ju jv jy mt kc mu kg mv kk mw mx my mz bi translated">启用/安装 WSL2(它也可以用于版本 1)</li><li id="2503" class="mr ms iq jp b jq na ju nb jy nc kc nd kg ne kk mw mx my mz bi translated">Docker 桌面</li><li id="9e86" class="mr ms iq jp b jq na ju nb jy nc kc nd kg ne kk mw mx my mz bi translated">克隆/下载以下回购:<a class="ae nx" href="https://github.com/n-murray/wsl-automated-setup" rel="noopener ugc nofollow" target="_blank">https://github.com/n-murray/wsl-automated-setup</a></li></ul><p id="f7d9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦你安装并运行了以上程序，你就可以继续安装了。</p><p id="68b6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你不想下载回购，你可以自己重新创建。</p><blockquote class="nf ng nh"><p id="1aff" class="jn jo kl jp b jq jr js jt ju jv jw jx ni jz ka kb nj kd ke kf nk kh ki kj kk ij bi translated">仅供参考:根据您的 Git 安装和配置，它有时会将文件的行尾从 Linux (LF)格式更改为 Windows (CRLF)格式，这可能会导致像“wsl.conf”和“”这样的安装文件出现问题。bashrc”需要是 LF 才能被 Linux 正确读取。</p></blockquote><h2 id="6f3c" class="mf ld iq bd le mg mh dn li mi mj dp lm jy mk ml lq kc mm mn lu kg mo mp ly mq bi translated">装置</h2><p id="54c3" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">如果您查看 repo 内部，您会注意到它包含两个批处理文件和几个文件夹。最重要的部分是批处理文件，它们都顾名思义<em class="kl">构建</em>WSL 发行版并且<em class="kl">移除</em>它。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi ny"><img src="../Images/b3771fb28c0c7602406361032472ecc1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VJGEUQBnd8ger2iEQqJrkw.png"/></div></div></figure><p id="6870" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要构建环境，您只需在命令提示符或 PowerShell 窗口中打开文件夹，然后运行“build_environment.bat”。根据您的互联网连接，该过程可能需要一段时间才能完成，因为批处理文件正在构建 Docker 映像，并下载和安装 resources 文件夹中 Docker 文件中列出的所有要求。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi nz"><img src="../Images/dd837a0a560a41f83fd6f659c77ebfd3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xVvdwWVaY7QyzDTVYqJ0fQ.png"/></div></div></figure><p id="2d89" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦完成，您将能够通过运行下面的命令列出您的 WSL 发行版来检查结果。</p><pre class="kn ko kp kq gt oa ob oc od aw oe bi"><span id="d2e2" class="mf ld iq ob b gy of og l oh oi">wsl --list</span></pre><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi oj"><img src="../Images/e359a4238800b814ec11eeafaf29ea49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TjouAjlQpjnpZABN1BGywA.png"/></div></div></figure><p id="32b3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这应该会给你一个类似于上面的输出，新发行版的名称是“dev-env”。您还会注意到，新发行版已经被设置为您的默认发行版，因此您现在只需在 PowerShell 或 CMD 中运行“wsl”就可以访问它。</p><p id="6130" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要删除这个发行版，你可以运行“remove_environment.bat ”,这将从 WSL 中注销发行版并删除安装文件。使用这两个批处理文件的组合，您可以轻松地删除一个损坏的安装并重新安装一个新的副本。在更改了一些你不应该有的设置，也不记得是什么设置之后，这个就派上用场了。</p><p id="8aea" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">是的，这几乎是你需要做的全部工作…</p></div><div class="ab cl nl nm hu nn" role="separator"><span class="no bw bk np nq nr"/><span class="no bw bk np nq nr"/><span class="no bw bk np nq"/></div><div class="ij ik il im in"><h2 id="efd7" class="mf ld iq bd le mg mh dn li mi mj dp lm jy mk ml lq kc mm mn lu kg mo mp ly mq bi translated">刚刚发生了什么？</h2><p id="2365" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">让我对‘build _ environment . bat’实际上是做什么的做一个高层次的解释，没有太多。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="ok ol l"/></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">第一部分</figcaption></figure><p id="129a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以上命令是创建定制 Linux 发行版的第一步。</p><p id="7633" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第 1 行在 resources 文件夹中构建 Docker 文件，并将当前用户作为参数传递，以便在 Docker 映像中创建一个用户。</p><p id="6502" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第 2 行运行上面创建的映像，并将容器命名为“dev-env”，这个名称没有任何意义，只是为了在后续命令中调用它。</p><p id="dbb2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第 3 行<a class="ae nx" href="https://docs.docker.com/engine/reference/commandline/export/" rel="noopener ugc nofollow" target="_blank">将“dev-env”容器文件系统导出为一个名为“dev-env.tar.gz”的 tar 归档文件。</a></p><p id="81de" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第 4 行和第 5 行只是清理创建的容器和图像。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="ok ol l"/></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">第二部分</figcaption></figure><p id="0fcd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建 tar 文件后，下一步是<a class="ae nx" href="https://docs.microsoft.com/en-us/windows/wsl/use-custom-distro" rel="noopener ugc nofollow" target="_blank">将它作为新发行版导入 WSL </a>。这是使用上述代码片段中的命令完成的。</p><p id="782c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第 1 行将默认的 WSL 版本设置为 2，以防它还不是。</p><p id="20b1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第 2 行从之前创建的 tar 文件中实际导入发行版。它导入文件并将新发行版命名为“dev-env”(可以是任何名称)</p><p id="355f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第 3 行只是将新发行版设置为默认的 WSL 发行版，这有助于 Docker Desktop 自动与发行版集成。</p><p id="ddec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第 6 行也是通过删除不再需要的 tar 文件进行清理，如果需要，可以重新创建。</p></div><div class="ab cl nl nm hu nn" role="separator"><span class="no bw bk np nq nr"/><span class="no bw bk np nq nr"/><span class="no bw bk np nq"/></div><div class="ij ik il im in"><h1 id="e5f1" class="lc ld iq bd le lf ns lh li lj nt ll lm ln nu lp lq lr nv lt lu lv nw lx ly lz bi translated">包扎</h1><p id="b212" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">使用上面的脚本，你可以快速地创建一个新的 WSL 发行版，并同样快速地删除它，因为我们使用 docker 文件，你可以添加任何你需要的工具或者删除那些不再需要的工具。</p><p id="592d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最终目标是拥有多个 done 文件，可以用来为具有不同需求的不同项目快速创建一个新的发行版，这可以通过几种不同的方式来实现。创建 repo 的新分支或分叉可能是最简单的，但是在 resources 文件夹中有多个 docker 文件可以通过选择一个要安装的发行版并向批处理文件传递一个参数来实现。</p><p id="216c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我鼓励任何感兴趣的人对回购提出任何建议，因为我愿意合作，并为不同类型的发行版创建不同的分支。</p><p id="728f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，请随意对本文或其中概述的过程留下任何评论，因为我一直在寻找改进的方法。</p></div></div>    
</body>
</html>