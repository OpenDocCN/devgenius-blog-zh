<html>
<head>
<title>Python error handling in AWS Lambda</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS Lambda 中的 Python 错误处理</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/python-error-handling-in-aws-lamb-5b9b52e941a8?source=collection_archive---------2-----------------------#2021-10-06">https://blog.devgenius.io/python-error-handling-in-aws-lamb-5b9b52e941a8?source=collection_archive---------2-----------------------#2021-10-06</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="f578" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">大约 53%的 Lambda 函数使用 Python，它是最流行的无服务器语言。在本文中，您将了解在 AWS Lambda 中处理 Python 的<strong class="jm io">错误的须知。</strong></p><h1 id="8e50" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">故障类型</h1><p id="e208" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">在您的 Lambda 中，有许多不同的事情可能会出错，所以让我们逐一分析。</p><figure class="lm ln lo lp gt lq gh gi paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="gh gi ll"><img src="../Images/8233c4055e9bd69e0f85ac285b7ae1c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*KoyUdzDXWX45U7wM.png"/></div></div></figure><h1 id="4df5" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">语法错误</h1><p id="605a" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">语法错误，也称为<strong class="jm io">解析错误</strong>，可能是最常见的一种失败。它们会在任何程序命令执行之前被抛出。这是其中一个的样子:</p><pre class="lm ln lo lp gt lx ly lz ma aw mb bi"><span id="e686" class="mc kj in ly b gy md me l mf mg">&gt;&gt;&gt; while True print('Hello world')<br/>  File "&lt;stdin&gt;", line 1, in ?<br/>      while True print('Hello world')<br/>                     ^<br/>SyntaxError: invalid syntax</span></pre><h1 id="a4fb" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">例外</h1><p id="784d" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated"><strong class="jm io">异常</strong>如果一个语句或表达式在语法上是正确的，但在执行时出错，就会出现异常。作为开发人员，您可以处理异常，并使它们对您的程序不致命。但是，大多数异常都没有得到处理，并导致如下错误消息:</p><pre class="lm ln lo lp gt lx ly lz ma aw mb bi"><span id="69ed" class="mc kj in ly b gy md me l mf mg">&gt;&gt;&gt; 10 * (1/0)<br/>Traceback (most recent call last):<br/>  File "&lt;stdin&gt;", line 1, in ?<br/>ZeroDivisionError: division by zero<br/>&gt;&gt;&gt; 4 + spam*3<br/>Traceback (most recent call last):<br/>  File "&lt;stdin&gt;", line 1, in ?<br/>NameError: name 'spam' is not defined<br/>&gt;&gt;&gt; '2' + 2<br/>Traceback (most recent call last):<br/>  File "&lt;stdin&gt;", line 1, in ?<br/>TypeError: Can't convert 'int' object to str implicitly</span></pre><h1 id="8bab" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">无法导入模块</h1><p id="afa8" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">值得单独注意的是导入模块异常。本质上，这是一个异常，但在 Lambdas 中需要特别注意。<strong class="jm io">在执行到达函数处理程序</strong>之前引发，意味着它没有到达函数处理程序包装的执行。这通常可以防止错误警报代理报告这种类型的故障。</p><pre class="lm ln lo lp gt lx ly lz ma aw mb bi"><span id="0366" class="mc kj in ly b gy md me l mf mg">START RequestId: db1e9421-724a-11e7-a121-63fe49a029e8 Version: $LATEST</span><span id="e889" class="mc kj in ly b gy mh me l mf mg">Unable to import module 'lambda_funxction': No module named 'lambda_funxction'</span><span id="d010" class="mc kj in ly b gy mh me l mf mg">REPORT RequestId: db1e9421-724a-11e7-a121-63fe49a029e8  Duration: 15.11 ms Billed Duration: 100 ms  Memory Size: 128 MB  Max Memory Used: 18 MB</span></pre><p id="f88f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">阅读更多关于<a class="ae mi" href="https://docs.python.org/3.3/tutorial/errors.html" rel="noopener ugc nofollow" target="_blank">如何在 Python 中处理异常的内容。</a></p><h1 id="e593" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">AWS 误差</h1><h1 id="9034" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">资源限制:超时</h1><p id="a3cf" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">当您使用无服务器框架时，默认超时为 6 秒，但您可以将其配置为 5 分钟。下面是 CloudWatch 中超时错误的样子。</p><pre class="lm ln lo lp gt lx ly lz ma aw mb bi"><span id="efbe" class="mc kj in ly b gy md me l mf mg">REPORT RequestId: 41a10717-e9af-11e7-892c-5bb1a4054ed6  Duration: 300085.71 ms  Billed Duration: 300000 ms Memory Size: 128 MB Max Memory Used: 92 MB<br/>2017-12-25T20:12:38.950Z 41a10717-e9af-11e7-892c-5bb1a4054ed6 Task timed out after 300.09 seconds</span></pre><h1 id="59f1" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">资源限制:内存不足</h1><p id="6813" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">Lambda 执行可能会遇到内存限制。当报告行中的<code class="fe mj mk ml ly b">Max Memory Used</code>和<code class="fe mj mk ml ly b">Memory Size</code>值相同时，您可以识别故障。</p><p id="3c01" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">示例:</p><pre class="lm ln lo lp gt lx ly lz ma aw mb bi"><span id="61fd" class="mc kj in ly b gy md me l mf mg">START RequestId: b86c93c6-e1d0-11e7-955b-539d8b965ff9 Version: $LATEST</span><span id="4b15" class="mc kj in ly b gy mh me l mf mg">REPORT RequestId: b86c93c6-e1d0-11e7-955b-539d8b965ff9 Duration: 122204.28 ms Billed Duration: 122300 ms Memory Size: 256 MB Max Memory Used: 256 MB</span><span id="d430" class="mc kj in ly b gy mh me l mf mg">RequestId: b86c93c6-e1d0-11e7-955b-539d8b965ff9 Process exited before completing request</span></pre><h1 id="7495" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">配置失败</h1><p id="729d" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">在这种情况下，引用的 Lambda 函数处理程序不存在。</p><pre class="lm ln lo lp gt lx ly lz ma aw mb bi"><span id="bd71" class="mc kj in ly b gy md me l mf mg">START RequestId: db1e9421-724a-11e7-a121-63fe49a029e8 Version: $LATEST</span><span id="5e7e" class="mc kj in ly b gy mh me l mf mg">Handler 'lambda_handlerx' missing on module</span><span id="cef5" class="mc kj in ly b gy mh me l mf mg">REPORT RequestId: db1e9421-724a-11e7-a121-63fe49a029e8 Duration: 15.11 ms Billed Duration: 100 ms Memory Size: 128 MB Max Memory Used: 18 MB</span></pre><h1 id="a2ba" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">处理故障</h1><p id="5e8d" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">好了，现在我们知道什么会出错了。幸运的是，Lambda 有一些锦囊妙计，我们可以用来补救这种情况。</p><h1 id="5766" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">AWS 中的重试行为</h1><p id="dcb7" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated"><strong class="jm io">同步调用:</strong> (API Gateway，Amazon Alexa 等。)</p><p id="75cb" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在这种情况下，Lambda 向负责重试的调用应用程序返回 429 错误。一些同步事件源<strong class="jm io">可能有内置的重试逻辑</strong>，所以一定要检查 AWS 的<a class="ae mi" href="https://docs.aws.amazon.com/lambda/latest/dg/invoking-lambda-function.html" rel="noopener ugc nofollow" target="_blank">支持的事件源</a>。</p><p id="3fc6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">异步调用:</strong> (AWS SNS、AWS SES、AWS CloudWatch 等)</p><p id="1460" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这些事件在被调用之前被排队，如果执行失败，<strong class="jm io">它们被重试两次</strong>,调用之间有延迟。可选地，您可以为您的函数指定一个<a class="ae mi" href="https://docs.aws.amazon.com/lambda/latest/dg/dlq.html" rel="noopener ugc nofollow" target="_blank">死信队列</a>，并将失败的事件发送到 AWS SQS 或 SNS。但是，如果不指定 DLQ，则事件会在两次重试后被丢弃。</p><p id="67e5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">基于流的事件源</strong>(亚马逊 Kinesis 数据流和 DynamoDB 流):</p><p id="1b2e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在这种情况下，Lambda 轮询您的流并调用 Lambda 函数。如果调用失败，Lambda 将再次尝试处理批处理，直到数据过期。为了确保按顺序处理流事件，异常被阻塞，并且该函数不会读取任何新记录，直到失败的批处理被成功处理或过期。</p><h1 id="ba51" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">幂等函数</h1><p id="c53e" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">根据系统的流程，重试可能是有害的。例如，让我们设想一个负责向数据库添加用户行并发送欢迎电子邮件的函数。如果该函数在创建用户后失败并重试，您将在数据库中有一个重复的行。</p><p id="07c5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">克服这个问题的一个好方法是将你的函数设计成<a class="ae mi" href="http://www.restapitutorial.com/lessons/idempotency.html" rel="noopener ugc nofollow" target="_blank">等幂</a>。</p><p id="4417" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">幂等函数</strong>是具有单一任务的函数，该任务要么成功，要么可以重试，而不会对系统造成任何损害。您可以使用阶跃函数重新设计上述函数。首先是负责将用户添加到数据库的函数，第二步，另一个函数发送电子邮件。点击阅读更多关于步进函数<a class="ae mi" href="https://aws.amazon.com/step-functions/" rel="noopener ugc nofollow" target="_blank">的信息。</a></p><h1 id="dc72" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">改进日志记录</h1><p id="8111" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">为了便于以后的调试，我建议注销有用的信息，如<strong class="jm io">事件对象</strong>(注意不要注销密码等)。)、可疑的数据库和网络请求以及其他可能的故障点。此外，如果您处理了一个关键异常，请确保将跟踪记录下来。这使得基于日志的监控解决方案如<a class="ae mi" href="https://dashbird.io/" rel="noopener ugc nofollow" target="_blank"> Dashbird </a>能够捕捉和处理。</p><h1 id="d5f6" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">基于日志的监控和警报</h1><p id="5b2a" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">这里需要注意的是，大多数错误在默认情况下不会被报告。在最好的情况下，如果您碰巧打开了 CloudWatch metrics dashboard，您会注意到它们。此外，在程序执行之外发生的故障很难或不可能被代理发现，因为执行在到达处理程序或来自上层之前就停止了。解决这个问题的一个好方法是从 CloudWatch 日志中检测这些问题。使用<a class="ae mi" href="https://dashbird.io/" rel="noopener ugc nofollow" target="_blank">dash bird</a>——一种易于设置的无服务器监控工具——在此基础上，可以在一个地方超级简单快速地检测错误并排除故障。</p><p id="f474" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">使用 Dashbird，您将能够跟踪 Python 错误，同时获得应用程序状态的整体视图。一旦你设置好你的账户，你就可以看到每一个函数调用，实时跟踪，错误报告，费用明细等等。</p><p id="07f0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">Dashbird 的好处是，它对你的 Lambda 性能或 AWS 成本没有任何影响。它还与您的 Slack、Pagerduty(通过 webhooks)或电子邮件帐户相集成，为您的开发聊天带来了警报。</p><figure class="lm ln lo lp gt lq gh gi paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="gh gi mm"><img src="../Images/e6790e1825ec60ba1dea745b3ecc6120.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2h8kVt1fH3PsXHKA.gif"/></div></div></figure><h1 id="79cc" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">结论</h1><p id="dc44" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">这涵盖了您需要了解的关于 AWS Lambdas 中错误处理的大部分内容。在我们的<a class="ae mi" href="https://dashbird.io/event-library/" rel="noopener ugc nofollow" target="_blank">事件库</a>中了解更多关于 AWS Lambda 错误以及如何解决它们的信息。</p></div></div>    
</body>
</html>