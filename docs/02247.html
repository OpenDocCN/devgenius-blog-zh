<html>
<head>
<title>React State Update Memory Leak</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">反应状态更新内存泄漏</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/react-state-update-memory-leak-8e84a45e1695?source=collection_archive---------2-----------------------#2020-07-25">https://blog.devgenius.io/react-state-update-memory-leak-8e84a45e1695?source=collection_archive---------2-----------------------#2020-07-25</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="5b1e" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">使用 componentWillUnmount()停止已卸载组件的状态更新</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/1dfd714c977fa744c14a869a155a52a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*GyZ6-VMcBoiuO-a7"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk translated">由<a class="ae ks" href="https://unsplash.com/@luis_tosta?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Luis Tosta </a>在<a class="ae ks" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><h2 id="b917" class="kt ku in bd kv kw kx dn ky kz la dp lb lc ld le lf lg lh li lj lk ll lm ln lo bi translated">警告标志</h2><p id="4f24" class="pw-post-body-paragraph lp lq in lr b ls lt jo lu lv lw jr lx lc ly lz ma lg mb mc md lk me mf mg mh ig bi translated">即使你的应用程序看起来运行良好，你的 DevTools 控制台中也会显示大量警告。这些是有帮助的，留意这些警告以确保它们以后不会咬你总是一个好主意。如果您发现类似以下的警告，我有一个解决方案:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi mi"><img src="../Images/81e24e7b4cbc10c93f3c14e025eae2ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g5c9-WzvK8A2mgHs7-ke3w.png"/></div></div></figure><p id="6659" class="pw-post-body-paragraph lp lq in lr b ls mj jo lu lv mk jr lx lc ml lz ma lg mm mc md lk mn mf mg mh ig bi translated">我看到这个警告是因为我的异步获取请求试图在组件被卸载后改变组件的状态。幸运的是，这一失误并没有破坏任何东西，因为就像警告所说的那样，这是一次失败。No-op 是“no operation”的缩写，这实质上意味着程序忽略了更新未安装组件的状态。然而，我们最好注意这个问题，以确保我们未安装的组件不会不必要地使用任何宝贵的内存。</p><h2 id="445d" class="kt ku in bd kv kw kx dn ky kz la dp lb lc ld le lf lg lh li lj lk ll lm ln lo bi translated">警告背后的问题</h2><p id="46ce" class="pw-post-body-paragraph lp lq in lr b ls lt jo lu lv lw jr lx lc ly lz ma lg mb mc md lk me mf mg mh ig bi translated">检查上面的警告，我们得到了问题所在的线索。它建议检查的第一个组件是警告第 4 行的“FeedContainer”。FeedContainer 中发生了什么导致了内存泄漏？我们需要寻找某种异步任务。</p><p id="4384" class="pw-post-body-paragraph lp lq in lr b ls mj jo lu lv mk jr lx lc ml lz ma lg mm mc md lk mn mf mg mh ig bi translated">在我的 FeedContainer.js 文件中，我在 c <code class="fe mo mp mq mr b">omponentDidMount()</code>和<code class="fe mo mp mq mr b">componentDidUpdate()</code>生命周期中都有 fetch 请求。使用来自承诺的响应，我用<code class="fe mo mp mq mr b">setState()</code>方法更新组件的状态。由于这是异步的，组件等待获取的响应来更新状态。当组件在等待 fetch 的承诺实现时被卸载，当收到响应时，<code class="fe mo mp mq mr b">setState()</code>方法仍然试图在现在卸载的组件上执行。下面是<code class="fe mo mp mq mr b">componentDidMount()</code>中导致内存泄漏的获取请求:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ms"><img src="../Images/e37a7a95376bf529570d21813eb92adb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BsMewzrn8tZLXXz3dZPmEQ.png"/></div></div></figure><p id="dcb5" class="pw-post-body-paragraph lp lq in lr b ls mj jo lu lv mk jr lx lc ml lz ma lg mm mc md lk mn mf mg mh ig bi translated">那么少了什么呢？因为我在这个应用程序中使用了生命周期方法，所以我可以利用一个<code class="fe mo mp mq mr b">componentWillUnmount()</code>方法。</p><h2 id="0014" class="kt ku in bd kv kw kx dn ky kz la dp lb lc ld le lf lg lh li lj lk ll lm ln lo bi translated">修复</h2><p id="feb1" class="pw-post-body-paragraph lp lq in lr b ls lt jo lu lv lw jr lx lc ly lz ma lg mb mc md lk me mf mg mh ig bi translated">为了堵塞内存泄漏，我创建了一个名为<code class="fe mo mp mq mr b">_isMounted</code>的类变量，在 FeedContainer 组件中保存一个布尔值。此变量指示组件是否已安装。最初，我给这个变量赋了一个假值。在<code class="fe mo mp mq mr b">componentDidMount()</code>方法开始时，_isMounted 变量被赋予一个真值。那么任何异步状态更新都是有条件的，取决于 _isMounted 变量是否为真。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi mt"><img src="../Images/e66ec62e0f91381202af4f82b545a896.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AL_66jT0sYhtMTNeRiyQSg.png"/></div></div></figure><p id="d53b" class="pw-post-body-paragraph lp lq in lr b ls mj jo lu lv mk jr lx lc ml lz ma lg mm mc md lk mn mf mg mh ig bi translated">接下来我添加了一个<code class="fe mo mp mq mr b">componentWillUnmount()</code>方法，在这里我给<code class="fe mo mp mq mr b">_isMounted</code>赋值一个假值。如果在卸载组件后<strong class="lr io">实现了获取承诺，则条件为假，并且<code class="fe mo mp mq mr b">setState()</code>方法从不运行。</strong></p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi mu"><img src="../Images/7b7086bc55510de54540f1a3ae266640.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*ettwVCV1KM5nAfB51foHIw.png"/></div></figure></div><div class="ab cl mv mw hr mx" role="separator"><span class="my bw bk mz na nb"/><span class="my bw bk mz na nb"/><span class="my bw bk mz na"/></div><div class="ig ih ii ij ik"><p id="025c" class="pw-post-body-paragraph lp lq in lr b ls mj jo lu lv mk jr lx lc ml lz ma lg mm mc md lk mn mf mg mh ig bi translated">我已经概述了一个组件在被卸载后试图更新其状态的解决方案。如果您在类组件中使用生命周期方法，这是可行的。如果没有，你就得用钩子。下面的 stackoverflow 帖子概述了如何在您的解决方案中使用这两种方法。</p><div class="nc nd gp gr ne nf"><a href="https://stackoverflow.com/questions/53949393/cant-perform-a-react-state-update-on-an-unmounted-component" rel="noopener  ugc nofollow" target="_blank"><div class="ng ab fo"><div class="nh ab ni cl cj nj"><h2 class="bd io gy z fp nk fr fs nl fu fw im bi translated">无法对卸载的组件执行反应状态更新</h2><div class="nm l"><h3 class="bd b gy z fp nk fr fs nl fu fw dk translated">我正在 React 中编写一个应用程序，无法避免一个非常常见的缺陷，即调用 setState(...)…</h3></div><div class="nn l"><p class="bd b dl z fp nk fr fs nl fu fw dk translated">stackoverflow.com</p></div></div><div class="no l"><div class="np l nq nr ns no nt km nf"/></div></div></a></div></div></div>    
</body>
</html>