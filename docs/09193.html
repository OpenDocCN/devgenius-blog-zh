<html>
<head>
<title>Azure DevOps Yaml pipeline with TFVC Repository</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带有 TFVC 仓库的 Azure DevOps Yaml 管道</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/azure-devops-yaml-pipeline-with-tfvc-repository-d42f27b402a?source=collection_archive---------1-----------------------#2022-08-05">https://blog.devgenius.io/azure-devops-yaml-pipeline-with-tfvc-repository-d42f27b402a?source=collection_archive---------1-----------------------#2022-08-05</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/516619510f5e045d7aba0e1273a58f19.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XlX9459-X2bYqgx-cBaGJw.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">流动</figcaption></figure><p id="8ff7" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">在这篇文章中，我将解释为源代码托管的 Azure Repo-TFVC 创建 Azure DevOps yaml 管道的过程。</p><p id="3c86" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">要求:</strong></p><p id="eff1" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">在这一点上，Azure DevOps 不支持 TFVC 仓库中托管的代码的 yaml 管道。</p><figure class="ky kz la lb gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi kx"><img src="../Images/e17b47083d86bdb059abd71b2778ea61.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*saqSbLH2tjCDFr2Kh1TKPg.png"/></div></div></figure><p id="79c9" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">为了使用 yaml 管道体验，需要将代码迁移到支持 yaml 体验的存储库中。</p><p id="c76a" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">然而，由于各种原因，这可能并不适用于所有组织。</p><p id="de57" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">因此，本文将作为一种变通方法来减轻这一限制。</p><p id="616d" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">先决条件:</strong></p><ol class=""><li id="8ec8" class="lc ld in kb b kc kd kg kh kk le ko lf ks lg kw lh li lj lk bi translated">您有一个带有 TFVC 存储库的活动 Azure DevOps 项目</li></ol><p id="ed96" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">步骤:</strong></p><p id="14c9" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">作为实施的一部分，我们将执行以下活动</p><ul class=""><li id="d594" class="lc ld in kb b kc kd kg kh kk le ko lf ks lg kw ll li lj lk bi translated">创建一个 Git Repo 来托管我们的管道 yaml 配置</li><li id="39e1" class="lc ld in kb b kc lm kg ln kk lo ko lp ks lq kw ll li lj lk bi translated">为实际管道创建管道 yaml 定义</li></ul><ol class=""><li id="98ce" class="lc ld in kb b kc kd kg kh kk le ko lf ks lg kw lh li lj lk bi translated">创建 Git Repo</li></ol><p id="0e18" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">登录到您的 Azure DevOps 项目</p><p id="4ee2" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">转到 Repo → File 并创建一个新的 Git 存储库</p><figure class="ky kz la lb gt jo gh gi paragraph-image"><div class="gh gi lr"><img src="../Images/a491097e60dfde5007dce82301697f38.png" data-original-src="https://miro.medium.com/v2/resize:fit:958/format:webp/1*93m9Se-vX7Zry5kjBx0YpQ.png"/></div></figure><figure class="ky kz la lb gt jo gh gi paragraph-image"><div class="gh gi ls"><img src="../Images/90ed004e833f976180eee0f08f4118cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:964/format:webp/1*CDchQqSqRcBOQJtoSOjQDg.png"/></div></figure><p id="0537" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">2.创建管道定义</p><p id="72cb" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">转到管道→管道</p><p id="a57a" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">创建新管道</p><p id="fc13" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">选择“Azure Repos Git”</p><figure class="ky kz la lb gt jo gh gi paragraph-image"><div class="gh gi lt"><img src="../Images/550614268f54dab62fb0103199848b98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1376/format:webp/1*g-cpxVqmy1eFZu8VKyF5rg.png"/></div></figure><p id="339d" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">选择上面创建的存储库</p><p id="da76" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">选择起始管道</p><figure class="ky kz la lb gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi lu"><img src="../Images/a63662080218a6b286114e258fbd853e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RnNCDPSgKeMluZShHTB0kQ.png"/></div></div></figure><p id="ea48" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">使用下面的 yaml 配置</p><pre class="ky kz la lb gt lv lw lx ly aw lz bi"><span id="d886" class="ma mb in lw b gy mc md l me mf">trigger:<br/>- none</span><span id="7f9e" class="ma mb in lw b gy mg md l me mf">pool:<br/>  vmImage: windows-latest</span><span id="af8c" class="ma mb in lw b gy mg md l me mf">variables:<br/>  - name: scopePath<br/>    value: '$/AzureDevOps'<br/>steps:<br/>  - task: PowerShell@2<br/>    inputs:<br/>      targetType: 'inline'<br/>      script: |<br/>        $url = "$(System.TeamFoundationCollectionUri)$(System.TeamProject)/_apis/tfvc/items?scopePath=$(scopePath)&amp;download=true&amp;recursionLevel=full&amp;api-version=5.1"<br/>         $PAT= "$(System.AccessToken)"<br/>         $base64AuthInfo= [System.Convert]::ToBase64String([System.Text.Encoding]::ASCII.GetBytes(":$($PAT)"))<br/>         $result = Invoke-RestMethod -Uri $url -Method Get -Header @{Authorization = "Basic $base64AuthInfo"} <br/>        <br/>         $files= $result.value | where { !$_.isFolder} | select path, url<br/>        <br/>         foreach($file in $files){<br/>            $path = "$(System.DefaultWorkingDirectory)\TFVC\" + $file.path.Substring(2)<br/>            New-Item -Path  $path -ItemType File -Force<br/>            Invoke-RestMethod -Uri $file.url -Method get -Header @{Authorization = "Bearer $PAT"} -OutFile $path<br/>          }<br/>        <br/>  - task: PublishBuildArtifacts@1<br/>    inputs:<br/>      PathtoPublish: '$(System.DefaultWorkingDirectory)\TFVC\$(System.TeamProject)'<br/>      ArtifactName: 'drop'<br/>      publishLocation: 'Container'</span></pre><p id="d797" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">解释:</strong></p><p id="935f" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">我们使用 2 task 作为管道的一部分</p><p id="295f" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">任务 1:从 TFVC 回购下载代码</strong></p><blockquote class="mh mi mj"><p id="ab84" class="jz ka mk kb b kc kd ke kf kg kh ki kj ml kl km kn mm kp kq kr mn kt ku kv kw ig bi translated">我们使用 Azure DevOps Rest Api 和 PowerShell 来下载代码</p><p id="33de" class="jz ka mk kb b kc kd ke kf kg kh ki kj ml kl km kn mm kp kq kr mn kt ku kv kw ig bi translated">使用带有预定义变量$(System)的令牌进行认证。AccessToken)</p><p id="105f" class="jz ka mk kb b kc kd ke kf kg kh ki kj ml kl km kn mm kp kq kr mn kt ku kv kw ig bi translated">代码将被下载到一个名为作用域路径的新文件夹中</p></blockquote><pre class="ky kz la lb gt lv lw lx ly aw lz bi"><span id="235e" class="ma mb in lw b gy mc md l me mf">- task: PowerShell@2<br/>    displayName: Download Code<br/>    inputs:<br/>      targetType: 'inline'<br/>      script: |<br/>        $url = "$(System.TeamFoundationCollectionUri)$(System.TeamProject)/_apis/tfvc/items?scopePath=$(scopePath)&amp;download=true&amp;recursionLevel=full&amp;api-version=5.1"<br/>         $PAT= "$(System.AccessToken)"<br/>         $base64AuthInfo= [System.Convert]::ToBase64String([System.Text.Encoding]::ASCII.GetBytes(":$($PAT)"))<br/>         $result = Invoke-RestMethod -Uri $url -Method Get -Header @{Authorization = "Basic $base64AuthInfo"} <br/>        <br/>         $files= $result.value | where { !$_.isFolder} | select path, url<br/>        <br/>         foreach($file in $files){<br/>            $path = "$(System.DefaultWorkingDirectory)\TFVC\" + $file.path.Substring(2)<br/>            New-Item -Path  $path -ItemType File -Force<br/>            Invoke-RestMethod -Uri $file.url -Method get -Header @{Authorization = "Bearer $PAT"} -OutFile $path<br/>          }</span></pre><p id="c35e" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">任务 2:发布代码</strong></p><pre class="ky kz la lb gt lv lw lx ly aw lz bi"><span id="30e9" class="ma mb in lw b gy mc md l me mf">- task: PublishBuildArtifacts@1<br/>    displayName: Publish Artifact<br/>    inputs:<br/>      PathtoPublish: '$(System.DefaultWorkingDirectory)\TFVC\$(System.TeamProject)'<br/>      ArtifactName: 'drop'<br/>      publishLocation: 'Container'</span></pre></div><div class="ab cl mo mp hr mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="ig ih ii ij ik"><p id="1474" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">在本文中，我们简单地发布了下载的代码，然而在真实的场景中，可以使用额外的任务来用下载的代码创建构建/发布活动。</p><p id="5d3b" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">源代码</p><figure class="ky kz la lb gt jo gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/3efea32c57c618435bab0c8dbe03f111.png" data-original-src="https://miro.medium.com/v2/resize:fit:1054/format:webp/1*g2-HcsTx5csKpOj781LQtw.png"/></div></figure><p id="c9c1" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">流水线执行</p><figure class="ky kz la lb gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mw"><img src="../Images/9aa3af32111bad6d1eaa36cb0ce9d437.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*efl3_s9dziby1VZGyTnQYQ.png"/></div></div></figure><p id="315a" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">发布的工件</p><figure class="ky kz la lb gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mx"><img src="../Images/a5c1a3d45be596fbea883a78417929aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qWmrHXAvD2HGBv9kPWpfYg.png"/></div></div></figure></div><div class="ab cl mo mp hr mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="ig ih ii ij ik"><p id="a78f" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">对于跨项目回购，使用以下 yaml 文件</strong></p><blockquote class="mh mi mj"><p id="6f60" class="jz ka mk kb b kc kd ke kf kg kh ki kj ml kl km kn mm kp kq kr mn kt ku kv kw ig bi translated">对于不同的组织，请使用实际的 Azure DevOps 项目 URL</p><p id="ac72" class="jz ka mk kb b kc kd ke kf kg kh ki kj ml kl km kn mm kp kq kr mn kt ku kv kw ig bi translated">为不同的组织创建一个具有代码读取权限的 PAT 令牌，用生成的令牌更新$PAT 变量的值。</p></blockquote><pre class="ky kz la lb gt lv lw lx ly aw lz bi"><span id="31d1" class="ma mb in lw b gy mc md l me mf">trigger:<br/>- none</span><span id="7724" class="ma mb in lw b gy mg md l me mf">pool:<br/>  vmImage: windows-latest</span><span id="e082" class="ma mb in lw b gy mg md l me mf">variables:<br/>  - name: scopePath<br/>    value: '$/AzureDevOps'<br/>  - name: token<br/>    value: 'your PAT token'<br/># For Security purpose create a variable group and add the token as a secure variable and refer the variable group<br/>  - name: ProjectName<br/>    value: 'AzureDevOps'<br/>steps:<br/>  - task: PowerShell@2<br/>    inputs:<br/>      targetType: 'inline'<br/>      script: |<br/>        $url = "$(System.TeamFoundationCollectionUri)$(ProjectName)/_apis/tfvc/items?scopePath=$(scopePath)&amp;download=true&amp;recursionLevel=full&amp;api-version=5.1"<br/>         $PAT= "$(token)"<br/>         Write-Host "Printing Token"<br/>         Write-Host $PAT<br/>         $base64AuthInfo= [System.Convert]::ToBase64String([System.Text.Encoding]::ASCII.GetBytes(":$($PAT)"))<br/>         $result = Invoke-RestMethod -Uri $url -Method Get -Header @{Authorization = "Basic $base64AuthInfo"} <br/>        <br/>         $files= $result.value | where { !$_.isFolder} | select path, url<br/>        <br/>         foreach($file in $files){<br/>            $path = "$(System.DefaultWorkingDirectory)\TFVC\" + $file.path.Substring(2)<br/>            New-Item -Path  $path -ItemType File -Force<br/>            Invoke-RestMethod -Uri $file.url -Method get -Header @{Authorization = "Bearer $PAT"} -OutFile $path<br/>          }<br/>        <br/>  - task: PublishBuildArtifacts@1<br/>    inputs:<br/>      PathtoPublish: '$(System.DefaultWorkingDirectory)\TFVC\$(ProjectName)'<br/>      ArtifactName: 'drop'<br/>      publishLocation: 'Container'</span></pre></div><div class="ab cl mo mp hr mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="ig ih ii ij ik"><p id="dc00" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">其他资源:</strong></p><div class="my mz gp gr na nb"><a href="https://docs.microsoft.com/en-us/azure/devops/organizations/accounts/use-personal-access-tokens-to-authenticate?view=azure-devops&amp;tabs=Windows" rel="noopener  ugc nofollow" target="_blank"><div class="nc ab fo"><div class="nd ab ne cl cj nf"><h2 class="bd io gy z fp ng fr fs nh fu fw im bi translated">使用个人访问令牌- Azure DevOps</h2><div class="ni l"><h3 class="bd b gy z fp ng fr fs nh fu fw dk translated">您可以使用个人访问令牌(PAT)作为备用密码来验证 Azure DevOps。在本文中…</h3></div><div class="nj l"><p class="bd b dl z fp ng fr fs nh fu fw dk translated">docs.microsoft.com</p></div></div><div class="nk l"><div class="nl l nm nn no nk np jt nb"/></div></div></a></div><div class="my mz gp gr na nb"><a href="https://docs.microsoft.com/en-us/rest/api/azure/devops/tfvc/items/list?view=azure-devops-rest-6.0&amp;tabs=HTTP" rel="noopener  ugc nofollow" target="_blank"><div class="nc ab fo"><div class="nd ab ne cl cj nf"><h2 class="bd io gy z fp ng fr fs nh fu fw im bi translated">项目-列表- REST API (Azure DevOps Tfvc)</h2><div class="ni l"><h3 class="bd b gy z fp ng fr fs nh fu fw dk translated">了解有关 Tfvc 服务的更多信息-获取 Tfvc 项目列表</h3></div><div class="nj l"><p class="bd b dl z fp ng fr fs nh fu fw dk translated">docs.microsoft.com</p></div></div><div class="nk l"><div class="nq l nm nn no nk np jt nb"/></div></div></a></div></div><div class="ab cl mo mp hr mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="ig ih ii ij ik"><p id="5323" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">我希望你喜欢阅读这篇文章，随时添加你的评论、想法或反馈，不要忘记在 linkedin 上保持联系。</p></div></div>    
</body>
</html>