<html>
<head>
<title>Save 90% Disk Space By Compacting Your InfluxDB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过压缩您的InfluxDB节省90%的磁盘空间</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/save-90-disk-space-by-compacting-your-influxdb-838366cfa133?source=collection_archive---------0-----------------------#2020-09-11">https://blog.devgenius.io/save-90-disk-space-by-compacting-your-influxdb-838366cfa133?source=collection_archive---------0-----------------------#2020-09-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="68b9" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph">InfluxDB | Grafana |成本|监控|软件工程</h2><div class=""/><div class=""><h2 id="9ee5" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated">加快查询速度并降低存储需求。如何用Grafana监控InfluxDB本身？</h2></div><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi ko"><img src="../Images/3b0e789318c7e01ba81406442b9ef102.png" data-original-src="https://miro.medium.com/v2/resize:fit:876/format:webp/1*t4Z_NHVi47XXJxWD0gk8AQ.png"/></div><figcaption class="kw kx gj gh gi ky kz bd b be z dk translated">Grafana仪表插件。</figcaption></figure><h1 id="92bb" class="la lb iq bd lc ld le lf lg lh li lj lk kf ll kg lm ki ln kj lo kl lp km lq lr bi translated">是什么让查询变慢了</h1><p id="e046" class="pw-post-body-paragraph ls lt iq lu b lv lw ka lx ly lz kd ma mb mc md me mf mg mh mi mj mk ml mm mn ij bi translated">在我们优化查询之前，我们必须了解是什么使它们变得缓慢，哪些操作或查询是昂贵的，以及什么是您真正想要的。</p><h2 id="ca06" class="mo lb iq bd lc mp mq dn lg mr ms dp lk mb mt mu lm mf mv mw lo mj mx my lq iw bi translated">数据越多=越慢</h2><p id="d228" class="pw-post-body-paragraph ls lt iq lu b lv lw ka lx ly lz kd ma mb mc md me mf mg mh mi mj mk ml mm mn ij bi translated">这是显而易见的，对吗？查询需要浏览的数据越多，花费的时间就越长。所以我们必须大致了解数据是如何存储的。还有另一个导致查询变慢的主要因素:基数。更多信息请见下文。</p><p id="d495" class="pw-post-body-paragraph ls lt iq lu b lv mz ka lx ly na kd ma mb nb md me mf nc mh mi mj nd ml mm mn ij bi translated">InfluxDB是一个时间序列数据库，这意味着它记录一段时间内的数据。它可以处理纳秒精度，这意味着你可以输入每纳秒的度量。数据将以您“输入”的精度存储。</p><p id="bc14" class="pw-post-body-paragraph ls lt iq lu b lv mz ka lx ly na kd ma mb nb md me mf nc mh mi mj nd ml mm mn ij bi translated">例如:如果您每10秒收集并报告一个指标，它将“按原样”存储，因此您每分钟将有6个指标。这一年有310万个指标。现在乘以你正在收集的指标…这是巨大的。InfluxDB的默认<code class="fe ne nf ng nh b">RETENTION POLICY</code>是“forever ”,因此您将收集数百万条记录。</p><blockquote class="ni"><p id="ec6d" class="nj nk iq bd nl nm nn no np nq nr mn dk translated">如果您不汇总，您的指标将永远“原始”存储。</p></blockquote><p id="bcdb" class="pw-post-body-paragraph ls lt iq lu b lv ns ka lx ly nt kd ma mb nu md me mf nv mh mi mj nw ml mm mn ij bi translated">这很棒，对吧？您开始使用InfluxDB和输入数据，不会丢失任何东西。不错！然而，一段时间后，随着您添加更多指标，存储会不断增长。此外，你回顾半年后，对10秒粒度的指标感兴趣的次数是很少的，非常少。</p><h2 id="b602" class="mo lb iq bd lc mp mq dn lg mr ms dp lk mb mt mu lm mf mv mw lo mj mx my lq iw bi translated">检查你的数据库</h2><p id="abec" class="pw-post-body-paragraph ls lt iq lu b lv lw ka lx ly lz kd ma mb mc md me mf mg mh mi mj mk ml mm mn ij bi translated">现在让我们用您自己的数据库来检查我刚才所说的，假设您正在阅读这篇文章，因为您使用InfluxDB。</p><p id="3271" class="pw-post-body-paragraph ls lt iq lu b lv mz ka lx ly na kd ma mb nb md me mf nc mh mi mj nd ml mm mn ij bi translated">有两种方法可以检查InfluxDB的存储和基数。第一种简单，运行查询。</p><h2 id="d7ab" class="mo lb iq bd lc mp mq dn lg mr ms dp lk mb mt mu lm mf mv mw lo mj mx my lq iw bi translated">1.运行查询</h2><blockquote class="ni"><p id="272a" class="nj nk iq bd nl nm nn no np nq nr mn dk translated"><strong class="ak"> Tipp </strong>:使用Grafanas的“探索”页面运行单个查询，探索你的数据库。</p></blockquote><figure class="ny nz oa ob oc kt gh gi paragraph-image"><div role="button" tabindex="0" class="od oe di of bf og"><div class="gh gi nx"><img src="../Images/9c846dfd9b345723da2e31c400905710.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q_B9wrLw-wZulyCnrc1jmQ.png"/></div></div><figcaption class="kw kx gj gh gi ky kz bd b be z dk translated">检查测量的原始数据。</figcaption></figure><pre class="kp kq kr ks gt oh nh oi oj aw ok bi"><span id="b0e8" class="mo lb iq nh b gy ol om l on oo"># show raw data from your measurements (at any point in time)<br/>SELECT * FROM "cpu" WHERE time &lt; '2020-08-01 00:00:00' ORDER BY time DESC LIMIT 10</span></pre><h2 id="9ed7" class="mo lb iq bd lc mp mq dn lg mr ms dp lk mb mt mu lm mf mv mw lo mj mx my lq iw bi translated">检查数据的一些查询</h2><pre class="kp kq kr ks gt oh nh oi oj aw ok bi"><span id="8a97" class="mo lb iq nh b gy ol om l on oo"># show your measurements or how many you have<br/>SHOW MEASUREMENTS<br/>SHOW MEASUREMENT CARDINALITY</span><span id="21d0" class="mo lb iq nh b gy op om l on oo"># show how many tags keys you have, optionally per measurement<br/>SHOW TAG KEY CARDINALITY<br/>SHOW TAG KEY CARDINALITY FROM "cpu"<br/># show or count different values of the tag key "host"<br/>SHOW TAG VALUES CARDINALITY [FROM "cpu"] WITH KEY = "host"<br/>SHOW TAG VALUES FROM "cpu" WITH KEY = "host"</span><span id="bef3" class="mo lb iq nh b gy op om l on oo"># show how many fields you have in measurement "cpu"<br/>SHOW FIELD KEY CARDINALITY FROM "cpu"</span><span id="0bb0" class="mo lb iq nh b gy op om l on oo"># show how many series you have in a database<br/>SHOW SERIES CARDINALITY ON telegraf<br/># show or count different series in measurement "cpu"<br/>SHOW SERIES CARDINALITY ON telegraf FROM "cpu"<br/>SHOW SERIES ON telegraf FROM "cpu"</span></pre><h2 id="e88d" class="mo lb iq bd lc mp mq dn lg mr ms dp lk mb mt mu lm mf mv mw lo mj mx my lq iw bi translated">探索您的数据回收策略</h2><p id="5538" class="pw-post-body-paragraph ls lt iq lu b lv lw ka lx ly lz kd ma mb mc md me mf mg mh mi mj mk ml mm mn ij bi translated"><code class="fe ne nf ng nh b">RETENTION POLICY</code>定义了数据应该在数据库中保存多长时间。一个数据库中可以有多个保留策略。保留策略还定义了分片持续时间——基本上是一个数据分片应该包含的持续时间。</p><p id="5cda" class="pw-post-body-paragraph ls lt iq lu b lv mz ka lx ly na kd ma mb nb md me mf nc mh mi mj nd ml mm mn ij bi translated">默认保留策略的持续时间为0(永久)，碎片持续时间为168小时，即一周。简而言之，这意味着您的数据存储在碎片中7天，永远不会被驱逐。</p><pre class="kp kq kr ks gt oh nh oi oj aw ok bi"><span id="cd59" class="mo lb iq nh b gy ol om l on oo"># show how data is stored and evicted<br/>SHOW RETENTION POLICIES</span><span id="f8c5" class="mo lb iq nh b gy op om l on oo"># show storage shards and groups<br/>SHOW SHARDS<br/>SHOW SHARD GROUPS</span></pre><p id="d3e5" class="pw-post-body-paragraph ls lt iq lu b lv mz ka lx ly na kd ma mb nb md me mf nc mh mi mj nd ml mm mn ij bi translated">在这里，您可以找到InfluxDB存储在磁盘上的实际文件:</p><pre class="kp kq kr ks gt oh nh oi oj aw ok bi"><span id="d592" class="mo lb iq nh b gy ol om l on oo">ls -la /var/lib/influxdb/data/telegraf/[retention policy]/[shard]</span></pre><p id="96f5" class="pw-post-body-paragraph ls lt iq lu b lv mz ka lx ly na kd ma mb nb md me mf nc mh mi mj nd ml mm mn ij bi translated">更多关于<code class="fe ne nf ng nh b">SHARDS</code>和<code class="fe ne nf ng nh b">RETENTION POLICIES</code>的信息，请点击此处:</p><div class="oq or gp gr os ot"><a href="https://www.influxdata.com/blog/influxdb-shards-retention-policies/" rel="noopener  ugc nofollow" target="_blank"><div class="ou ab fo"><div class="ov ab ow cl cj ox"><h2 class="bd ja gy z fp oy fr fs oz fu fw iz bi translated">简化流入数据库:碎片和保留策略|流入数据</h2><div class="pa l"><h3 class="bd b gy z fp oy fr fs oz fu fw dk translated">InfluxData的开发者倡导者Margo Schaedel的博客文章:我最近做了一个关于InfluxDB介绍的网络研讨会…</h3></div><div class="pb l"><p class="bd b dl z fp oy fr fs oz fu fw dk translated">www.influxdata.com</p></div></div><div class="pc l"><div class="pd l pe pf pg pc ph ku ot"/></div></div></a></div><h2 id="4ca9" class="mo lb iq bd lc mp mq dn lg mr ms dp lk mb mt mu lm mf mv mw lo mj mx my lq iw bi translated">2.启用InfluxDB度量</h2><p id="f058" class="pw-post-body-paragraph ls lt iq lu b lv lw ka lx ly lz kd ma mb mc md me mf mg mh mi mj mk ml mm mn ij bi translated">检查InfluxDB的第二个选项是启用内部指标。</p><p id="caa2" class="pw-post-body-paragraph ls lt iq lu b lv mz ka lx ly na kd ma mb nb md me mf nc mh mi mj nd ml mm mn ij bi translated">在您的<code class="fe ne nf ng nh b">influxdb.conf</code>中启用<code class="fe ne nf ng nh b">monitor:</code></p><pre class="kp kq kr ks gt oh nh oi oj aw ok bi"><span id="eb20" class="mo lb iq nh b gy ol om l on oo">[monitor]<br/>  store-enabled = true<br/>  store-database = "_internal"<br/>  store-interval = "30s"</span></pre><div class="oq or gp gr os ot"><a href="https://docs.influxdata.com/platform/monitoring/influxdata-platform/tools/measurements-internal/" rel="noopener  ugc nofollow" target="_blank"><div class="ou ab fo"><div class="ov ab ow cl cj ox"><h2 class="bd ja gy z fp oy fr fs oz fu fw iz bi translated">InfluxDB _内部测量和字段| InfluxData文档</h2><div class="pa l"><h3 class="bd b gy z fp oy fr fs oz fu fw dk translated">默认情况下，InfluxDB生成内部指标并保存到_internal数据库。使用这些指标来监控…</h3></div><div class="pb l"><p class="bd b dl z fp oy fr fs oz fu fw dk translated">docs.influxdata.com</p></div></div><div class="pc l"><div class="pi l pe pf pg pc ph ku ot"/></div></div></a></div><p id="92dc" class="pw-post-body-paragraph ls lt iq lu b lv mz ka lx ly na kd ma mb nb md me mf nc mh mi mj nd ml mm mn ij bi translated">InfluxData提到此<strong class="lu ja">不应用于生产！</strong></p><p id="6823" class="pw-post-body-paragraph ls lt iq lu b lv mz ka lx ly na kd ma mb nb md me mf nc mh mi mj nd ml mm mn ij bi translated">当您打开内部指标时，您可以在Grafana仪表板中显示它们。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="od oe di of bf og"><div class="gh gi pj"><img src="../Images/5155c00bf2ccb75beb1cf5954a621493.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yA6funiiANkjrQoM1Uqxyg.png"/></div></div><figcaption class="kw kx gj gh gi ky kz bd b be z dk translated">具有内部InfluxDB指标的仪表板。</figcaption></figure><h1 id="fd54" class="la lb iq bd lc ld le lf lg lh li lj lk kf ll kg lm ki ln kj lo kl lp km lq lr bi translated">发现并解决问题</h1><p id="7117" class="pw-post-body-paragraph ls lt iq lu b lv lw ka lx ly lz kd ma mb mc md me mf mg mh mi mj mk ml mm mn ij bi translated">既然您已经检查了数据库，您可能已经找到了它可能变慢的一些原因。以下是修复方法。</p><h2 id="2f24" class="mo lb iq bd lc mp mq dn lg mr ms dp lk mb mt mu lm mf mv mw lo mj mx my lq iw bi translated">永久保存原始数据(磁盘空间和速度)</h2><p id="f56d" class="pw-post-body-paragraph ls lt iq lu b lv lw ka lx ly lz kd ma mb mc md me mf mg mh mi mj mk ml mm mn ij bi translated">这可能是最常见的问题，也是最耗时的问题，但是有了它，你可以<strong class="lu ja">重新获得高达90%的磁盘空间</strong>。检查您的保留策略，并对其进行调整，以便在您不再需要数据时将其丢弃。还要检查你的碎片的大小。正确的大小当然取决于运行InfluxDB实例的硬件，所以我不能给出任何建议，除了它们应该是可用RAM大小的一部分。</p><p id="b75e" class="pw-post-body-paragraph ls lt iq lu b lv mz ka lx ly na kd ma mb nb md me mf nc mh mi mj nd ml mm mn ij bi translated">大多数人希望将数据保存更长时间(我也是)。但是，当您回顾几周或几个月以前时，您不希望或不需要10秒的粒度。你需要汇总的数据。</p><p id="89f9" class="pw-post-body-paragraph ls lt iq lu b lv mz ka lx ly na kd ma mb nb md me mf nc mh mi mj nd ml mm mn ij bi translated">这似乎是一个简单的任务:只需运行一个查询，按照您想要的方式对数据进行分组，并将其插入另一个“长期”数据库。是的，本质上就是这样。但是，设置它，尤其是将它应用到现有的数据库是很繁琐的。</p><p id="7e7b" class="pw-post-body-paragraph ls lt iq lu b lv mz ka lx ly na kd ma mb nb md me mf nc mh mi mj nd ml mm mn ij bi translated">InfluxDB甚至支持一种简单的方法来聚合数据，同时保留所有标签:</p><pre class="kp kq kr ks gt oh nh oi oj aw ok bi"><span id="df0e" class="mo lb iq nh b gy ol om l on oo"># downsample the measurement to 5 minutes, keeping all tags<br/>SELECT max(field1) AS field1 FROM measurement GROUP BY time(5m), *</span></pre><p id="f06c" class="pw-post-body-paragraph ls lt iq lu b lv mz ka lx ly na kd ma mb nb md me mf nc mh mi mj nd ml mm mn ij bi translated">这里需要注意的一点是，您希望使用相同的仪表板和相同的查询来查询原始数据和聚合数据。这就是为什么您需要为每个聚合函数设置一个别名，并像原始字段一样命名它:<code class="fe ne nf ng nh b">max(field1) AS field1</code>。</p><p id="1ac9" class="pw-post-body-paragraph ls lt iq lu b lv mz ka lx ly na kd ma mb nb md me mf nc mh mi mj nd ml mm mn ij bi translated">接下来要注意的是使用正确的聚合函数。你对平均值还是最大值感兴趣？如果是字符串值，也许你希望<code class="fe ne nf ng nh b">last(field1)</code>作为聚合。下面举几个例子:<a class="ae pk" href="https://github.com/DrPsychick/ansible_influx_downsampling/blob/master/defaults/main.yml" rel="noopener ugc nofollow" target="_blank">https://github . com/DrPsychick/ansi ble _ inflow _ down sampling/blob/master/defaults/main . yml</a></p><p id="e8ea" class="pw-post-body-paragraph ls lt iq lu b lv mz ka lx ly na kd ma mb nb md me mf nc mh mi mj nd ml mm mn ij bi translated">最后，您可能希望使用聚合设置，通过只包含某些值或排除其他值来清理您的标记。如果不是不可能的话，从测量中删除标记值是昂贵的。</p><p id="0239" class="pw-post-body-paragraph ls lt iq lu b lv mz ka lx ly na kd ma mb nb md me mf nc mh mi mj nd ml mm mn ij bi translated">不久前，我写了一个ansible role，它可以帮助您设置聚合和压缩现有数据。如果你不想用ansible，它可能还是会给你一些如何自己设置的思路。在我的例子中，我能够将一个9.6GB的数据库压缩92%，同时在长期查询上获得巨大的速度。</p><div class="oq or gp gr os ot"><a href="https://github.com/DrPsychick/ansible_influx_downsampling" rel="noopener  ugc nofollow" target="_blank"><div class="ou ab fo"><div class="ov ab ow cl cj ox"><h2 class="bd ja gy z fp oy fr fs oz fu fw iz bi translated">DrPsychick/ansi ble _ inflow _ down sampling</h2><div class="pa l"><h3 class="bd b gy z fp oy fr fs oz fu fw dk translated">InfluxDB使用默认的保留策略，将数据永久保存在7天的碎片中——以原始格式(每10分钟数据点…</h3></div><div class="pb l"><p class="bd b dl z fp oy fr fs oz fu fw dk translated">github.com</p></div></div><div class="pc l"><div class="pl l pe pf pg pc ph ku ot"/></div></div></a></div><p id="a0c6" class="pw-post-body-paragraph ls lt iq lu b lv mz ka lx ly na kd ma mb nb md me mf nc mh mi mj nd ml mm mn ij bi translated">示例中描述了我的设置:<a class="ae pk" href="https://github.com/DrPsychick/ansible_influx_downsampling/tree/master/examples/full-5level-backfill-compact" rel="noopener ugc nofollow" target="_blank">https://github . com/DrPsychick/ansi ble _ inflow _ down sampling/tree/master/examples/full-5 level-回填-压缩</a></p><p id="6c39" class="pw-post-body-paragraph ls lt iq lu b lv mz ka lx ly na kd ma mb nb md me mf nc mh mi mj nd ml mm mn ij bi translated">该解决方案大量使用了InfluxDB的“连续查询”功能，文档如下:</p><div class="oq or gp gr os ot"><a href="https://docs.influxdata.com/influxdb/v1.8/query_language/continuous_queries/" rel="noopener  ugc nofollow" target="_blank"><div class="ou ab fo"><div class="ov ab ow cl cj ox"><h2 class="bd ja gy z fp oy fr fs oz fu fw iz bi translated">InfluxQL连续查询| InfluxData文档</h2><div class="pa l"><h3 class="bd b gy z fp oy fr fs oz fu fw dk translated">连续查询(CQ)是对实时数据和存储查询定期自动运行的InfluxQL查询…</h3></div><div class="pb l"><p class="bd b dl z fp oy fr fs oz fu fw dk translated">docs.influxdata.com</p></div></div><div class="pc l"><div class="pm l pe pf pg pc ph ku ot"/></div></div></a></div><p id="7e58" class="pw-post-body-paragraph ls lt iq lu b lv mz ka lx ly na kd ma mb nb md me mf nc mh mi mj nd ml mm mn ij bi translated">这里有一篇文章描述了如何使用连续查询将数据聚合到同一个数据库的不同保留策略中。那也很有效。我之所以使用不同的数据库，是因为在Grafana中用一个<code class="fe ne nf ng nh b">$database</code>变量更容易处理，如果需要的话，它还允许你更容易地将长期数据库转移到不同的服务器上。</p><div class="oq or gp gr os ot"><a href="https://towardsdatascience.com/influxdb-data-retention-f026496d708f" rel="noopener follow" target="_blank"><div class="ou ab fo"><div class="ov ab ow cl cj ox"><h2 class="bd ja gy z fp oy fr fs oz fu fw iz bi translated">InfluxDB数据保留</h2><div class="pa l"><h3 class="bd b gy z fp oy fr fs oz fu fw dk translated">如何对数据进行降采样并保存数年</h3></div><div class="pb l"><p class="bd b dl z fp oy fr fs oz fu fw dk translated">towardsdatascience.com</p></div></div><div class="pc l"><div class="pn l pe pf pg pc ph ku ot"/></div></div></a></div><h2 id="03c7" class="mo lb iq bd lc mp mq dn lg mr ms dp lk mb mt mu lm mf mv mw lo mj mx my lq iw bi translated">高系列基数(数据量和速度)</h2><p id="f79e" class="pw-post-body-paragraph ls lt iq lu b lv lw ka lx ly lz kd ma mb mc md me mf mg mh mi mj mk ml mm mn ij bi translated">如果您的调查显示您的测量具有非常高的系列基数(&gt; 2000)，那么您别无选择，只能减少/改变您正在收集的数据，或者坚持下去并为此付出代价。或者，您可以将指标分成多个测量值，以分散数据和负载。</p><pre class="kp kq kr ks gt oh nh oi oj aw ok bi"><span id="954e" class="mo lb iq nh b gy ol om l on oo">SHOW SERIES CARDINALITY ON telegraf<br/>SHOW SERIES CARDINALITY ON telegraf FROM "procstat"</span></pre><p id="3958" class="pw-post-body-paragraph ls lt iq lu b lv mz ka lx ly na kd ma mb nb md me mf nc mh mi mj nd ml mm mn ij bi translated">问题要么是标签太多，要么是标签有很多不同的值。两者都导致更大量的标签值的可能组合。而且每个组合基本形成一个系列。</p><p id="013b" class="pw-post-body-paragraph ls lt iq lu b lv mz ka lx ly na kd ma mb nb md me mf nc mh mi mj nd ml mm mn ij bi translated">举一个真实的例子:假设您正在监控一个应用程序及其处理的请求。每个请求针对一个特定的路径(网站或API ),大约有20个不同的路径。可以将它们作为标签添加到指标中，以查看每个端点的性能。假设某个业务部门的人要求您添加客户ID，这样他们就可以了解某个客户是否比其他人更容易受到响应缓慢的影响。您的公司有500个客户端，他们都使用终端。您将得到20*500 = 10000种可能的标记值组合。您会注意到，一旦引入了clientID标记，该图的查询会变得更慢。有一天，您的IT老板走过来，让您添加国家作为标签，因为“我们想知道有多少请求来自某个国家”。因此，取10000个组合，乘以你的客户来自的国家，比如说5 = 50000个可能的组合。</p><p id="0722" class="pw-post-body-paragraph ls lt iq lu b lv mz ka lx ly na kd ma mb nb md me mf nc mh mi mj nd ml mm mn ij bi translated">这里要问的正确问题是:你需要知道与clientID一起<strong class="lu ja">与clientID一起</strong>与国家一起的路径吗？大概不会。因此，一种解决方案是拆分指标，一个用于路径和国家，一个用于客户端。</p><p id="7a10" class="pw-post-body-paragraph ls lt iq lu b lv mz ka lx ly na kd ma mb nb md me mf nc mh mi mj nd ml mm mn ij bi translated">我想你明白了。这里没有放之四海而皆准的解决方案。这取决于您的数据以及您希望如何查询它。</p><h2 id="42d3" class="mo lb iq bd lc mp mq dn lg mr ms dp lk mb mt mu lm mf mv mw lo mj mx my lq iw bi translated">总是查询原始数据(负载和速度)</h2><p id="24ac" class="pw-post-body-paragraph ls lt iq lu b lv lw ka lx ly lz kd ma mb mc md me mf mg mh mi mj mk ml mm mn ij bi translated">很可能是最常见的“用户”问题。与InfluxDB相比，它与您如何设置Grafana仪表板更有关系。许多人要么在他们的查询中设置固定的粒度(按<code class="fe ne nf ng nh b">time(10s)</code>分组)，要么保存仪表板，选择<code class="fe ne nf ng nh b">10s</code>作为间隔。如果您随后查询更大的范围，如7天或30天，您会向InfluxDB请求大量数据，并且您的Grafana(您的浏览器)必须处理所有这些数据，这使得它非常慢。</p><p id="4e03" class="pw-post-body-paragraph ls lt iq lu b lv mz ka lx ly na kd ma mb nb md me mf nc mh mi mj nd ml mm mn ij bi translated">到目前为止，对我来说最好的选择是像这样设置仪表板:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="od oe di of bf og"><div class="gh gi po"><img src="../Images/d915ecf533d3c7326ece7834709c5e0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q-nzkAiUREdNXu2HwVk1-g.png"/></div></div><figcaption class="kw kx gj gh gi ky kz bd b be z dk translated">仪表板设置:变量</figcaption></figure><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="od oe di of bf og"><div class="gh gi pp"><img src="../Images/28d7de8a4810018e55e200166dc6a165.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Kher8-CLsvjkMizmr7oXxA.png"/></div></div><figcaption class="kw kx gj gh gi ky kz bd b be z dk translated">查询编辑器:查询选项</figcaption></figure><ul class=""><li id="3623" class="pq pr iq lu b lv mz ly na mb ps mf pt mj pu mn pv pw px py bi translated">创建一个名为<code class="fe ne nf ng nh b">interval</code>的区间变量。如果需要，您可以更改预定义的值。激活<code class="fe ne nf ng nh b">auto</code>选项。</li><li id="a632" class="pq pr iq lu b lv pz ly qa mb qb mf qc mj qd mn pv pw px py bi translated">编辑您的面板，并将查询选项中的“最小间隔”设置为<code class="fe ne nf ng nh b">$interval</code>。</li><li id="708d" class="pq pr iq lu b lv pz ly qa mb qb mf qc mj qd mn pv pw px py bi translated">在您的查询中，确保您有group by <code class="fe ne nf ng nh b">time($__interval)</code>。</li><li id="8056" class="pq pr iq lu b lv pz ly qa mb qb mf qc mj qd mn pv pw px py bi translated">当“间隔”设置为<code class="fe ne nf ng nh b">auto</code>时，保存您的仪表板<strong class="lu ja">包括变量</strong>。</li></ul><p id="2b69" class="pw-post-body-paragraph ls lt iq lu b lv mz ka lx ly na kd ma mb nb md me mf nc mh mi mj nd ml mm mn ij bi translated">现在，如果您使用interval变量，您将看到当您降低interval时，图形如何变化并变得更加“精确”,当您增加interval时，图形变得更加平坦。</p><p id="2973" class="pw-post-body-paragraph ls lt iq lu b lv mz ka lx ly na kd ma mb nb md me mf nc mh mi mj nd ml mm mn ij bi translated">为什么？因为:如果任何人使用你的仪表板想要“缩小”，他们可能会改变时间范围。如果你有一个固定的(或保存或选择！)间隔<code class="fe ne nf ng nh b">10s</code>和查询30天，会很慢，甚至可能会中止。如果您将间隔设置为<code class="fe ne nf ng nh b">auto</code>并查询30天，Grafana将通过<code class="fe ne nf ng nh b">$interval</code>变量自动调整分组。在变量设置中，您可以根据自己的喜好设置<code class="fe ne nf ng nh b">Step count</code>,默认显示更精确或更平滑的图形。</p><p id="3f08" class="pw-post-body-paragraph ls lt iq lu b lv mz ka lx ly na kd ma mb nb md me mf nc mh mi mj nd ml mm mn ij bi translated">为什么这么麻烦？它开箱即用！是的，它是。如果你没有做到以上几点，Grafana会自动计算出最小间隔(如上图截图所示)。我发现，如果我可以手动选择粒度，这将非常有用。有时我想看原始数据，所以我选择<code class="fe ne nf ng nh b">10s</code>区间。</p><h2 id="633a" class="mo lb iq bd lc mp mq dn lg mr ms dp lk mb mt mu lm mf mv mw lo mj mx my lq iw bi translated">始终显示所有图表(负载和速度)</h2><p id="69ef" class="pw-post-body-paragraph ls lt iq lu b lv lw ka lx ly lz kd ma mb mc md me mf mg mh mi mj mk ml mm mn ij bi translated">第二个最常见的“用户”问题导致控制面板运行缓慢和数据涌入。Grafana在您显示图表时运行查询。如果您将图表按行放置，并隐藏不总是需要的内容，那么您可以将大量查询保存到InfluxDB，并且您的仪表板加载速度会更快。</p><h2 id="5ebb" class="mo lb iq bd lc mp mq dn lg mr ms dp lk mb mt mu lm mf mv mw lo mj mx my lq iw bi translated">创建单独的警报仪表板(负载和速度)</h2><p id="bbe9" class="pw-post-body-paragraph ls lt iq lu b lv lw ka lx ly lz kd ma mb mc md me mf mg mh mi mj mk ml mm mn ij bi translated">这似乎是一件小事，而且由于公告板中的变量，您还不得不为警报规则创建静态查询。在Grafana中很容易设置警报，并且需要一个能够快速查询短时间和/或预定义时间范围的板。我强烈建议仅在专用于警报的仪表板上创建警报。如果您的仪表板上有许多警报被设置为默认的7天时间范围，那么您的InfluxDB将持续加载，基本上没有任何附加值。毕竟，你通常不希望在几个小时甚至几天后才被提醒。您还可以添加警报图表或指标的链接，这些图表或指标直接链接到相应服务的仪表板。</p><h1 id="44f8" class="la lb iq bd lc ld le lf lg lh li lj lk kf ll kg lm ki ln kj lo kl lp km lq lr bi translated">度量的基本规则</h1><p id="ab35" class="pw-post-body-paragraph ls lt iq lu b lv lw ka lx ly lz kd ma mb mc md me mf mg mh mi mj mk ml mm mn ij bi translated">综上所述，以下是度量的一些最佳实践:</p><ul class=""><li id="595a" class="pq pr iq lu b lv mz ly na mb ps mf pt mj pu mn pv pw px py bi translated"><strong class="lu ja">聚合您的数据以便长期存储</strong>并设置您的Grafana仪表盘以支持切换数据库<strong class="lu ja">。</strong>即使查询一年的时间范围，也能保持快速查询。</li><li id="42b1" class="pq pr iq lu b lv pz ly qa mb qb mf qc mj qd mn pv pw px py bi translated">以您需要的<strong class="lu ja">最粗略粒度收集数据</strong>。问问你自己，如果你更频繁地收集它，你会得到什么好处。从每分钟一次到每十秒钟一次已经让你的数据增加了6倍。</li><li id="8ea3" class="pq pr iq lu b lv pz ly qa mb qb mf qc mj qd mn pv pw px py bi translated">监控或定期检查您的数据库“负载”。<strong class="lu ja">小心爆炸系列</strong>，因为当有人向指标添加标签时，您通常不会得到通知<strong class="lu ja">。根据您需要查询的内容，将指标</strong>分割成单独的度量。</li><li id="02e8" class="pq pr iq lu b lv pz ly qa mb qb mf qc mj qd mn pv pw px py bi translated">构建和使用仪表板，这些仪表板<strong class="lu ja">只显示需要立即看到的内容</strong>，并基于<strong class="lu ja">动态间隔</strong>查询数据。</li></ul><h1 id="4a16" class="la lb iq bd lc ld le lf lg lh li lj lk kf ll kg lm ki ln kj lo kl lp km lq lr bi translated">感谢您的阅读！</h1><p id="350c" class="pw-post-body-paragraph ls lt iq lu b lv lw ka lx ly lz kd ma mb mc md me mf mg mh mi mj mk ml mm mn ij bi translated">我希望这有所帮助。我邀请您参与我的职责，或者提交有关改进或功能要求的问题。</p><h2 id="1ae7" class="mo lb iq bd lc mp mq dn lg mr ms dp lk mb mt mu lm mf mv mw lo mj mx my lq iw bi translated">我关于监控的其他文章</h2><div class="oq or gp gr os ot"><a href="https://medium.com/dev-genius/3-years-of-influxdb-with-aggregation-a-review-6d160a4281cf" rel="noopener follow" target="_blank"><div class="ou ab fo"><div class="ov ab ow cl cj ox"><h2 class="bd ja gy z fp oy fr fs oz fu fw iz bi translated">三年来的InfluxDB与聚合—回顾</h2><div class="pa l"><h3 class="bd b gy z fp oy fr fs oz fu fw dk translated">压缩数据是获得可维护的、响应迅速的系统的关键——但是这值得努力吗？</h3></div><div class="pb l"><p class="bd b dl z fp oy fr fs oz fu fw dk translated">medium.com</p></div></div><div class="pc l"><div class="qe l pe pf pg pc ph ku ot"/></div></div></a></div><div class="oq or gp gr os ot"><a href="https://medium.com/dev-genius/monitoring-your-machine-s-with-tig-a9ef39cd0eec" rel="noopener follow" target="_blank"><div class="ou ab fo"><div class="ov ab ow cl cj ox"><h2 class="bd ja gy z fp oy fr fs oz fu fw iz bi translated">使用TIG监控您的机器</h2><div class="pa l"><h3 class="bd b gy z fp oy fr fs oz fu fw dk translated">TIG = Telegraf，InfluxDB，Grafana。受众:开发人员、书呆子、devops初学者…</h3></div><div class="pb l"><p class="bd b dl z fp oy fr fs oz fu fw dk translated">medium.com</p></div></div><div class="pc l"><div class="qf l pe pf pg pc ph ku ot"/></div></div></a></div><div class="oq or gp gr os ot"><a href="https://medium.com/dev-genius/monitor-temperatures-with-telegraf-on-macos-4a0eae03549d" rel="noopener follow" target="_blank"><div class="ou ab fo"><div class="ov ab ow cl cj ox"><h2 class="bd ja gy z fp oy fr fs oz fu fw iz bi translated">在macOS上使用Telegraf监控温度</h2><div class="pa l"><h3 class="bd b gy z fp oy fr fs oz fu fw dk translated">在macOS上使用Telegraf可以监控的内容:适用于书呆子、开发人员和devops初学者…</h3></div><div class="pb l"><p class="bd b dl z fp oy fr fs oz fu fw dk translated">medium.com</p></div></div><div class="pc l"><div class="qg l pe pf pg pc ph ku ot"/></div></div></a></div><div class="oq or gp gr os ot"><a href="https://medium.com/the-innovation/monitor-nvidia-gpu-with-telegraf-on-windows-5acb73c91d20" rel="noopener follow" target="_blank"><div class="ou ab fo"><div class="ov ab ow cl cj ox"><h2 class="bd ja gy z fp oy fr fs oz fu fw iz bi translated">在Windows上使用Telegraf监控Nvidia GPU</h2><div class="pa l"><h3 class="bd b gy z fp oy fr fs oz fu fw dk translated">Telegraf通过SMI收集Nvidia指标并在Grafana中显示的5分钟设置:适用于书呆子、开发人员和…</h3></div><div class="pb l"><p class="bd b dl z fp oy fr fs oz fu fw dk translated">medium.com</p></div></div><div class="pc l"><div class="qh l pe pf pg pc ph ku ot"/></div></div></a></div><h2 id="c118" class="mo lb iq bd lc mp mq dn lg mr ms dp lk mb mt mu lm mf mv mw lo mj mx my lq iw bi translated">资源</h2><div class="oq or gp gr os ot"><a href="https://github.com/DrPsychick/ansible_influx_downsampling" rel="noopener  ugc nofollow" target="_blank"><div class="ou ab fo"><div class="ov ab ow cl cj ox"><h2 class="bd ja gy z fp oy fr fs oz fu fw iz bi translated">DrPsychick/ansi ble _ inflow _ down sampling</h2><div class="pa l"><h3 class="bd b gy z fp oy fr fs oz fu fw dk translated">InfluxDB使用默认的保留策略，以原始格式将数据永久保存在7天的碎片中(数据点每10…</h3></div><div class="pb l"><p class="bd b dl z fp oy fr fs oz fu fw dk translated">github.com</p></div></div><div class="pc l"><div class="pl l pe pf pg pc ph ku ot"/></div></div></a></div><div class="oq or gp gr os ot"><a href="https://docs.influxdata.com/influxdb/v1.8/query_language/continuous_queries/" rel="noopener  ugc nofollow" target="_blank"><div class="ou ab fo"><div class="ov ab ow cl cj ox"><h2 class="bd ja gy z fp oy fr fs oz fu fw iz bi translated">InfluxQL连续查询| InfluxData文档</h2><div class="pa l"><h3 class="bd b gy z fp oy fr fs oz fu fw dk translated">连续查询(CQ)是对实时数据和存储查询定期自动运行的InfluxQL查询…</h3></div><div class="pb l"><p class="bd b dl z fp oy fr fs oz fu fw dk translated">docs.influxdata.com</p></div></div><div class="pc l"><div class="pm l pe pf pg pc ph ku ot"/></div></div></a></div><div class="oq or gp gr os ot"><a href="https://docs.influxdata.com/platform/monitoring/influxdata-platform/tools/measurements-internal/" rel="noopener  ugc nofollow" target="_blank"><div class="ou ab fo"><div class="ov ab ow cl cj ox"><h2 class="bd ja gy z fp oy fr fs oz fu fw iz bi translated">InfluxDB _内部测量和字段| InfluxData文档</h2><div class="pa l"><h3 class="bd b gy z fp oy fr fs oz fu fw dk translated">默认情况下，InfluxDB生成内部指标并保存到_internal数据库。使用这些指标来监控…</h3></div><div class="pb l"><p class="bd b dl z fp oy fr fs oz fu fw dk translated">docs.influxdata.com</p></div></div><div class="pc l"><div class="pi l pe pf pg pc ph ku ot"/></div></div></a></div></div></div>    
</body>
</html>