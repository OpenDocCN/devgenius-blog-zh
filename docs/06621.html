<html>
<head>
<title>Viessmann Boiler Data to InfluxDB Cloud</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Viessmann锅炉数据流入数据库云</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/viessmann-boiler-data-to-influxdb-cloud-a9f66042663d?source=collection_archive---------8-----------------------#2022-01-20">https://blog.devgenius.io/viessmann-boiler-data-to-influxdb-cloud-a9f66042663d?source=collection_archive---------8-----------------------#2022-01-20</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><div class=""/><div class=""><h2 id="62ad" class="pw-subtitle-paragraph jo iq ir bd b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dk translated">如何获取Viessmann API数据，将其推送到InfluxDB云并创建仪表板</h2></div><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj kg"><img src="../Images/df413263160523e9e0a48b42dd9f74a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*zdbaJR6vVe5OyTpL"/></div></div><figcaption class="ks kt gk gi gj ku kv bd b be z dk translated">卢卡斯·布拉塞克在<a class="ae kw" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="dc8a" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">今年夏天，我搬进了新装修的房子。因为这是一个到处都是砖块和石头的非常古老的乡村房子，所以供暖系统是由地板下的供暖系统制成的，而不是墙壁散热器。热水器是一台<strong class="kz is"> Vitodens 200-W </strong>，一台燃气壁挂式冷凝锅炉，配有调制缸燃烧器，是Viessmann公司的旗舰产品。</p><p id="3b97" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">这款机型包括<strong class="kz is"> WiFi连接</strong>和一个配套应用程序，可以设置加热器热水温度，并检查按日、周、月和年分组的燃气和电力消耗历史。</p><p id="f03c" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">这太棒了，但在锅炉触摸屏上，我可以读取更多关于性能的实时细节:<strong class="kz is">输送温度，热水温度，火焰燃烧器调制，外部传感器温度，燃烧器小时数，燃烧器启动</strong>。为什么在app上看不到这个数据？为什么锅炉上连历史数据都没有？</p></div><div class="ab cl lt lu hv lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ik il im in io"><p id="6f3c" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">首先，我们必须在<a class="ae kw" href="https://developer.viessmann.com/en/doc/getting-started" rel="noopener ugc nofollow" target="_blank"> Viessmann开发人员门户</a>API上创建一个帐户，该帐户是免费的，每日调用限制为<strong class="kz is"> 1450次</strong>，可以用于除商业目的以外的任何用途。</p><p id="29db" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">然后我们将需要<a class="ae kw" href="https://github.com/somm15/PyViCare" rel="noopener ugc nofollow" target="_blank"> <strong class="kz is"> PyViCare </strong> </a>，一个Python库，通过官方API轻松访问Viessmann设备。</p><h1 id="8b7b" class="ma mb ir bd mc md me mf mg mh mi mj mk jx ml jy mm ka mn kb mo kd mp ke mq mr bi translated"><strong class="ak"> Viessmann API实现</strong></h1><p id="0eb8" class="pw-post-body-paragraph kx ky ir kz b la ms js lc ld mt jv lf lg mu li lj lk mv lm ln lo mw lq lr ls ik bi translated">打开<strong class="kz is">终端</strong>，运行以下命令:</p><pre class="kh ki kj kk gu mx my mz na aw nb bi"><span id="1f9b" class="nc mb ir my b gz nd ne l nf ng">sudo pip3 install PyViCare</span></pre><p id="751c" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">让我们导入这个库，在Viessmann开发人员门户上用API凭证创建一个新实例，并获得第一个可用的设备(如果您有多个设备，您必须更改这一部分)。</p><figure class="kh ki kj kk gu kl"><div class="bz fq l di"><div class="nh ni l"/></div></figure><p id="1533" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">现在，让我们来了解一下该设备的一些基本信息和一些有趣的统计数据。我们将获取并打印<strong class="kz is">设备型号、燃烧器启动、燃烧器状态标志、火焰调制、主加热器温度和热水温度</strong>，代码如下:</p><pre class="kh ki kj kk gu mx my mz na aw nb bi"><span id="ae0b" class="nc mb ir my b gz nd ne l nf ng">print(viDevice.getModel())<br/>print(viDevice.asGazBoiler().burners[0].getStarts())<br/>print(viDevice.asGazBoiler().burners[0].getActive())<br/>print(viDevice.asGazBoiler().burners[0].getModulation())<br/>print(viDevice.asGazBoiler().getBoilerCommonSupplyTemperature())<br/>print(viDevice.asGazBoiler().getDomesticHotWaterStorageTemperature())</span></pre><p id="fe68" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">这是我的案例的结果:</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj nj"><img src="../Images/919013812eb6c4bd9f04db9fa999dfc4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sCAkE91o2CoubaLgWRBZHw.png"/></div></div></figure><p id="ee36" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">我终于不用下楼就能在电脑上看到实时数据了，但这还不够。你还记得我也想要史料吗？那么我们需要一个数据库！</p><h1 id="05ca" class="ma mb ir bd mc md me mf mg mh mi mj mk jx ml jy mm ka mn kb mo kd mp ke mq mr bi translated">InfluxDB</h1><p id="1f53" class="pw-post-body-paragraph kx ky ir kz b la ms js lc ld mt jv lf lg mu li lj lk mv lm ln lo mw lq lr ls ik bi translated">来自维基百科:“<em class="nk"> InfluxDB是由InfluxData公司开发的开源时间序列数据库。它是用Go编程语言编写的，用于存储和检索运营监控、应用度量、物联网传感器数据和实时分析等领域的时间序列数据。</em></p><p id="0ebe" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">你可以通过下载<strong class="kz is"> docker镜像</strong>，从<a class="ae kw" href="https://portal.influxdata.com/downloads/" rel="noopener ugc nofollow" target="_blank">官方下载页面</a>获取，或者你可以选择新的<strong class="kz is">云解决方案</strong>来自行托管。</p><p id="8ab4" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">由于我不想在我可怜的Raspberry PI 4上安装另一个服务，并且<a class="ae kw" href="https://github.com/influxdata/influxdb" rel="noopener ugc nofollow" target="_blank"> <strong class="kz is">自由层</strong> </a>已经足够了，我将使用<strong class="kz is">第二个选项</strong>！</p></div><div class="ab cl lt lu hv lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ik il im in io"><p id="3e28" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">作为第一步，您必须在<a class="ae kw" href="https://www.influxdata.com/get-influxdb/" rel="noopener ugc nofollow" target="_blank"> InfluxDB Cloud </a>上创建一个新帐户。然后你需要在<strong class="kz is"> <em class="nk">入门</em> </strong>页面选择<strong class="kz is"> <em class="nk">加载你的数据</em> </strong>。</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj nl"><img src="../Images/917da2202f8d3a8cb589017fd3bd18bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WqlWD4FvNmhNY9F8ao9NYw.png"/></div></div></figure><p id="ce73" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">在搜索框中键入“<strong class="kz is"> <em class="nk"> Python </em> </strong>”，然后单击那里唯一可用的库:</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj nm"><img src="../Images/b8e3fb7c90555aeb4ffa7aa3d2e9b9eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Pv49ApHArQf29fPgcFsHRw.png"/></div></div></figure><p id="8b7c" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">在下一页，创建一个<strong class="kz is">新令牌</strong>(注意；您很快就会需要它)和一个专门针对此应用的新铲斗。</p></div><div class="ab cl lt lu hv lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ik il im in io"><p id="1dda" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">然后，打开<strong class="kz is">终端</strong>，运行以下命令安装所需的<strong class="kz is">库</strong>:</p><pre class="kh ki kj kk gu mx my mz na aw nb bi"><span id="4be0" class="nc mb ir my b gz nd ne l nf ng">sudo pip3 install influxdb_client</span></pre><p id="0528" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">回到代码，创建一个新文件(我将其命名为main.py ),复制并粘贴“<em class="nk">初始化客户端</em>”部分。在这里你会找到你的<strong class="kz is">令牌</strong>、<strong class="kz is">组织</strong>和<strong class="kz is">桶</strong>信息。</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj nn"><img src="../Images/ca32d7415bd1850279b0fa240e7a93ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nLjWQ5mGrTP3pPVcM-JgKA.png"/></div></div></figure><p id="0a57" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">现在是时候创建一个新的<strong class="kz is"><em class="nk">InfluxDBClient</em></strong>了，将令牌和org作为参数传递，并传递一个<strong class="kz is"> <em class="nk"> write_api </em> </strong>实例。</p><pre class="kh ki kj kk gu mx my mz na aw nb bi"><span id="f3bc" class="nc mb ir my b gz nd ne l nf ng">token = “YOURTOKEN”<br/>org = “YOURORGANIZATIONAME”<br/>bucket = “YOURBUCKETNAME”</span><span id="52b2" class="nc mb ir my b gz no ne l nf ng">client = InfluxDBClient(url=”https://us-east-1-1.aws.cloud2.influxdata.com", token=token, org=org)</span><span id="9024" class="nc mb ir my b gz no ne l nf ng">write_api = client.write_api()</span></pre><p id="22a9" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">我们现在可以创建一个<strong class="kz is"> <em class="nk">点</em></strong><em class="nk"/>的单个数据记录，类似于SQL数据库表中的一行。每个点都有一个<strong class="kz is">测量值</strong>，一个<strong class="kz is">标签集</strong>，一个<strong class="kz is">字段关键字</strong>，一个<strong class="kz is">字段值</strong>，一个<strong class="kz is">时间戳，</strong>以及唯一标识它的系列和时间戳。最后，我们可以将这个点发送到端点。</p><pre class="kh ki kj kk gu mx my mz na aw nb bi"><span id="ad2f" class="nc mb ir my b gz nd ne l nf ng">burnerStarts = viDevice.asGazBoiler().burners[0].getStarts()<br/>pBurnerStarts = Point(“Boiler”).tag(“host”, “host1”).field(“StartsNumber”, burnerStarts)</span><span id="71a0" class="nc mb ir my b gz no ne l nf ng">write_api.write(bucket=bucket,org=org,record=pBurnerStarts)</span></pre></div><div class="ab cl lt lu hv lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ik il im in io"><h1 id="e443" class="ma mb ir bd mc md np mf mg mh nq mj mk jx nr jy mm ka ns kb mo kd nt ke mq mr bi translated">运行并测试它</h1><p id="2017" class="pw-post-body-paragraph kx ky ir kz b la ms js lc ld mt jv lf lg mu li lj lk mv lm ln lo mw lq lr ls ik bi translated">是时候<strong class="kz is">运行脚本</strong>了！打开一个终端，移动到项目目录，并执行它:</p><pre class="kh ki kj kk gu mx my mz na aw nb bi"><span id="ecfa" class="nc mb ir my b gz nd ne l nf ng">python3 main.py</span></pre><p id="c03f" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">回到InfluxDB Cloud " <strong class="kz is"> <em class="nk">数据浏览器</em> </strong> <em class="nk"> " </em>页面，应该可以看到刚刚发送的数据，过滤为<strong class="kz is">度量</strong>、<strong class="kz is">字段</strong>，以及<strong class="kz is">主机</strong>。</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj nu"><img src="../Images/f2eeb6d76c1e831517719803afb493be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jxNA1RK6bmT3CF9WurOnXg.png"/></div></div></figure><p id="d776" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">下面你可以找到<strong class="kz is">完整代码</strong>和一些<strong class="kz is">附加字段</strong>，我发现它们对我的情况很有帮助:</p><figure class="kh ki kj kk gu kl"><div class="bz fq l di"><div class="nh ni l"/></div></figure><h1 id="6158" class="ma mb ir bd mc md me mf mg mh mi mj mk jx ml jy mm ka mn kb mo kd mp ke mq mr bi translated">仪表盘</h1><p id="5fc5" class="pw-post-body-paragraph kx ky ir kz b la ms js lc ld mt jv lf lg mu li lj lk mv lm ln lo mw lq lr ls ik bi translated">现在，您已经准备好创建一个仪表板，将所有这些统计数据作为一个<strong class="kz is">图表</strong>、<strong class="kz is">仪表</strong>、<strong class="kz is">热图</strong>、<strong class="kz is">直方图</strong>或<strong class="kz is">简单表格</strong>。</p><p id="dd68" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">这是最终的预期结果:</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj nv"><img src="../Images/7e2574a1b90379bc00dfd3f46bd80114.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zRVsTaooUJOfp9xy8kHG1Q.png"/></div></div></figure><h1 id="a00a" class="ma mb ir bd mc md me mf mg mh mi mj mk jx ml jy mm ka mn kb mo kd mp ke mq mr bi translated"><strong class="ak">最后一项改进</strong></h1><p id="cc63" class="pw-post-body-paragraph kx ky ir kz b la ms js lc ld mt jv lf lg mu li lj lk mv lm ln lo mw lq lr ls ik bi translated">当然，我不想每隔五分钟就手动运行这个脚本。这就是为什么我把这个脚本作为cronjob添加到我的Raspberry PI上！</p><p id="36a4" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">该命令将在编辑模式下打开<strong class="kz is"> cron调度程序</strong>文件:</p><pre class="kh ki kj kk gu mx my mz na aw nb bi"><span id="0930" class="nc mb ir my b gz nd ne l nf ng">crontab -e</span></pre><p id="1e89" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">并且通过这一行，它会每5分钟执行<em class="nk"> main.py </em>脚本<strong class="kz is">。如果你想要它更频繁/更不频繁，你可以<strong class="kz is">改变前五个星号</strong>，使用<a class="ae kw" href="https://crontab.guru/" rel="noopener ugc nofollow" target="_blank">这个站点</a>来生成正确的值。</strong></p><pre class="kh ki kj kk gu mx my mz na aw nb bi"><span id="8d5e" class="nc mb ir my b gz nd ne l nf ng">*/5 * * * * python3 /home/pi/main.py</span></pre></div><div class="ab cl lt lu hv lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ik il im in io"><figure class="kh ki kj kk gu kl gi gj paragraph-image"><a href="https://www.buymeacoffee.com/nicolidomenico"><div class="gi gj nw"><img src="../Images/7bd4b29a3f6dc8d1ba201f1dfee023d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*U_gaynRUOHK_hSMF.png"/></div></a></figure><h2 id="9bcb" class="nc mb ir bd mc nx ny dn mg nz oa dp mk lg ob oc mm lk od oe mo lo of og mq oh bi translated"><strong class="ak">感谢您的阅读！</strong></h2></div></div>    
</body>
</html>