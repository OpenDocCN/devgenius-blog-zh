# S3 è§¦å‘å™¨:æ— æœåŠ¡å™¨ CSV ä¸Šä¼ åˆ° DynamoDB

> åŸæ–‡ï¼š<https://blog.devgenius.io/s3-trigger-serverless-csv-upload-into-dynamodb-8877c770fb32?source=collection_archive---------4----------------------->

![](img/be0cdc18024a6c09047c677285b000d9.png)

ç±³å¡Â·é²æ¢…æ–¯ç‰¹åœ¨ [Unsplash](https://unsplash.com/s/photos/csv?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) ä¸Šçš„ç…§ç‰‡

æ‚¨å¯ä»¥åœ¨è®¸å¤šç”¨ä¾‹ä¸­ä½¿ç”¨ AWS Lambda è§¦å‘å™¨ã€‚è¿™ä¸€æ¬¡çš„è¯€çªæ˜¯é€šè¿‡å°† CSV æ–‡ä»¶çš„å†…å®¹ä¸Šä¼ åˆ° S3 å­˜å‚¨æ¡¶å¹¶è§¦å‘ Lambda å‡½æ•°å°†å®ƒä»¬å­˜å‚¨åœ¨ DynamoDB ä¸­ï¼Œä»è€Œå°†é™æ€æ•°æ®æ·»åŠ åˆ°æ•°æ®åº“ä¸­ã€‚å°½ç®¡ CSV çœ‹èµ·æ¥éå¸¸å¤è€ï¼Œä½†å®ƒä»ç„¶ç»å¸¸åœ¨ it é¡¹ç›®ä¸­ç”¨äºäº¤æ¢æ•°æ®æˆ–ä»ä¸€ä¸ªæ•°æ®å­˜å‚¨å¯¼å…¥åˆ°å¦ä¸€ä¸ªæ•°æ®å­˜å‚¨ã€‚

![](img/7a6fcf021f08b176497b4e0e2f7d0b59.png)

æ–¹æ³•:å°† CSV å¯¼å…¥ DynamoDB

æˆ‘ä»¬å°†åœ¨[ä¹‹å‰çš„æ•…äº‹](/how-to-build-a-serverless-rest-api-with-nestjs-and-dynamodb-7b58b5b59bf6)ä¸­è®¨è®ºåˆ›å»ºä¸€ä¸ªåœ¨çº¿å›¾ä¹¦é¦†æœåŠ¡ã€‚æˆ‘ä»¬å°†åˆ›å»ºä¸€ç§æ–¹æ³•ï¼Œä½¿ç”¨ CSV æ–‡ä»¶å°†å›¾ä¹¦ç±»åˆ«åŠ è½½åˆ° DynamoDB æ•°æ®åº“ä¸­ã€‚å›¾ä¹¦ç±»åˆ« CSV å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºã€‚ä½¿ç”¨å¸¦ DynamoDB çš„[å•è¡¨è®¾è®¡ç­–ç•¥](/how-to-do-single-table-design-with-dynamodb-db9101a43277)çš„åˆ†åŒºé”®(PK)å’Œæ’åºé”®(SK)ã€‚

![](img/faed4385a546806ac0eac100e9ea6d16.png)

å›¾ä¹¦ç±»åˆ«. csv

## ä½¿ç”¨ AWS Lambda çš„å¼‚æ­¥è°ƒç”¨

åœ¨æˆ‘ä»¬æ¥è§¦ä¸€äº›ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ Lambda æ˜¯å¦‚ä½•å¤„ç†æ¥è‡ª S3 çš„è§¦å‘å™¨çš„ã€‚ä¸€äº› AWS æœåŠ¡ï¼Œå¦‚äºšé©¬é€Š S3 å’Œäºšé©¬é€Šç¤¾äº¤ç½‘ç»œï¼Œå¼‚æ­¥è°ƒç”¨å‡½æ•°æ¥å¤„ç†æ¥è‡ªè§¦å‘å™¨çš„äº‹ä»¶ã€‚ä¸‹å›¾æ˜¾ç¤ºäº†å¼‚æ­¥è°ƒç”¨ Lambda å‡½æ•°çš„å®¢æˆ·ç«¯ã€‚

![](img/da9f2019cf4d53388db06334e2f1c0ec.png)

å›¾è¡¨:ä½¿ç”¨ AWS Lambda çš„å¼‚æ­¥è°ƒç”¨

å¯¹äºå¼‚æ­¥è°ƒç”¨ï¼ŒLambda å°†äº‹ä»¶æ”¾åœ¨ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œå¹¶è¿”å›ä¸€ä¸ªæˆåŠŸçš„å“åº”ï¼Œæ²¡æœ‰é™„åŠ ä¿¡æ¯ã€‚ä¸€ä¸ªå•ç‹¬çš„è¿›ç¨‹ä»é˜Ÿåˆ—ä¸­è¯»å–äº‹ä»¶ï¼Œå¹¶å°†å®ƒä»¬å‘é€åˆ°æ‚¨çš„å‡½æ•°ã€‚

Lambda ç®¡ç†å‡½æ•°çš„å¼‚æ­¥äº‹ä»¶é˜Ÿåˆ—ï¼Œå¹¶å°è¯•åœ¨å‡ºé”™æ—¶é‡è¯•ã€‚è¿™é‡Œéœ€è¦çŸ¥é“çš„é‡è¦ä¸€ç‚¹æ˜¯ï¼Œå³ä½¿ä½ çš„å‡½æ•°æ²¡æœ‰è¿”å›é”™è¯¯ï¼Œå®ƒä¹Ÿå¯ä»¥å¤šæ¬¡ä» Lambda æ¥æ”¶ç›¸åŒçš„äº‹ä»¶ï¼Œå› ä¸ºé˜Ÿåˆ—æœ¬èº«æœ€ç»ˆæ˜¯ä¸€è‡´çš„ã€‚ç¡®ä¿æ‚¨çš„å‡½æ•°ä»£ç *ä¼˜é›…åœ°å¤„ç†é‡å¤äº‹ä»¶*ï¼Œå¹¶ä¸”æ‚¨æœ‰è¶³å¤Ÿçš„å¹¶å‘æ€§æ¥å¤„ç†æ‰€æœ‰è°ƒç”¨ã€‚

## ç›®çš„åœ°

æ‚¨å¯ä»¥ä¸ºå‡½æ•°é…ç½®ç›®çš„åœ°ï¼Œä»¥ä¾¿å°†å¼‚æ­¥è°ƒç”¨çš„è®°å½•å‘é€åˆ°å¦ä¸€ä¸ªæœåŠ¡ã€‚æ‚¨å¯ä»¥ä¸ºå¤„ç†å¤±è´¥çš„äº‹ä»¶å’ŒæˆåŠŸå¤„ç†çš„äº‹ä»¶é…ç½®å•ç‹¬çš„ç›®æ ‡ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ AWS ä¸Šçš„[æ–‡æ¡£](https://docs.aws.amazon.com/lambda/latest/dg/invocation-async.html)ã€‚

![](img/f7aba0b90f74f6b78a38007624edad21.png)

å¼‚æ­¥è°ƒç”¨çš„ç›®æ ‡

## æ— æœåŠ¡å™¨è®¾ç½®

ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸€äº›å®é™…çš„ä»£ç ã€‚

æˆ‘ä»¬å°†ä½¿ç”¨[æ— æœåŠ¡å™¨æ¡†æ¶](https://www.serverless.com)å’Œä¸€ä¸ªæ¨¡æ¿æ¥ç”Ÿæˆä¸€ä¸ªç©ºç™½çš„ TypeScript é¡¹ç›®ï¼Œç”¨äºæ¥æ”¶ S3 ä¸Šä¼ äº‹ä»¶çš„è®°å½•ã€‚

> *æœ¬æ–‡çš„å®Œæ•´é¡¹ç›®å¯ä»¥åœ¨ Github*[*ã€https://github.com/cyberworkz/examples*](https://github.com/cyberworkz/examples)*çš„ bookcategory-upload æ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°ã€‚*

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼Œé€šè¿‡æ— æœåŠ¡å™¨ CLI åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®:

```
sls create --template-url [https://github.com/cyberworkz/serverless-templates/tree/main/aws-nodejs-typescript-s3](https://github.com/cyberworkz/serverless-templates/tree/main/aws-nodejs-typescript-s3) --path bookcategory-upload
```

è¿™å°†åˆ›å»ºä¸€ä¸ªæ—¨åœ¨ä» S3 æ¡¶ä¸­æ‹¾å–äº‹ä»¶çš„é¡¹ç›®ã€‚è®©æˆ‘ä»¬è¿›å…¥æ–‡ä»¶å¤¹ bookcategory-upload å¹¶æµè§ˆæ— æœåŠ¡å™¨é…ç½®æ–‡ä»¶(serverless.yml)ã€‚

å½“ä½¿ç”¨åç¼€. csv åˆ›å»ºå¯¹è±¡æ—¶ï¼Œlambda å‡½æ•°æ¥æ”¶å™¨ä½œç”¨äº S3 äº‹ä»¶ã€‚å­˜å‚¨æ¡¶åç§°è¢«è®¾ç½®ä¸ºè‡ªå®šä¹‰å˜é‡ã€‚æ›´å¤šå…³äºæ— æœåŠ¡å™¨æ¡†æ¶çš„å˜é‡å¯ä»¥åœ¨[è¿™é‡Œ](https://www.serverless.com/framework/docs/providers/aws/guide/variables)æ‰¾åˆ°ã€‚

```
events:      
      - s3:          
          bucket: ${self:custom.bucket}          
          event: s3:ObjectCreated:*
```

æ·»åŠ äº†ä¸€ä¸ª *iamRoleStatement* æ¥è·å–å‡½æ•°è¯»å–æ–‡ä»¶å’Œå†™å…¥ DynamoDB è¡¨çš„æƒé™ã€‚

```
iamRoleStatements:    
- Effect: Allow      
  Action:        
  - s3:*      
  Resource: "*"
- Effect: Allow
  Action:
    - dynamodb:PutItem
  Resource:
    - <dynamodb-arn>
```

## ä»£ç âŒ¨ï¸

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å®‰è£…ä¸€äº›é¢å¤–çš„ä¾èµ–é¡¹æ¥å®Œæˆç¹é‡çš„å·¥ä½œã€‚å®‰è£…ä»¥ä¸‹è½¯ä»¶åŒ…:

*   [ç±»å‹äºŒ](https://www.npmjs.com/package/typedi)
*   [@ fast-CSV/è§£æ](https://www.npmjs.com/package/@fast-csv/parse)

```
npm i @fast-csv/parse
npm i typedi
```

TypeDI å…è®¸åœ¨æ²¡æœ‰ç´§å¯†è€¦åˆçš„æƒ…å†µä¸‹å°†ä¾èµ–é¡¹æ³¨å…¥åˆ°ç±»ä¸­ã€‚Fast-csv æ˜¯ä¸€ä¸ªç”¨äºè§£æ csv æ–‡ä»¶çš„åº“ã€‚

ç°åœ¨è®©æˆ‘ä»¬è½¬å‘ä»£ç ã€‚bookcategory-upload ç›®å½•ç»“æ„åº”è¯¥å¦‚ä¸‹æ‰€ç¤º:

![](img/aa4edc58dca5258e5bacf53658184700.png)

å›¾ä¹¦ç±»åˆ«-ä¸Šä¼ ç›®å½•ç»“æ„

é‡è¦æ–‡ä»¶å¦‚ä¸‹:

> -**processor . ts**->-*å¤„ç† S3 äº‹ä»¶*
> 
> -**csv-record-import-service . ts**->*è¯»å–æµä½œä¸º CSV è®°å½•å¹¶è§£æè®°å½•*
> 
> -**data-repository . ts**->-*å°†è®°å½•å¯¼å…¥æ•°æ®å­˜å‚¨*

S3 äº‹ä»¶çš„å¤„ç†æ˜¯åœ¨ processor.ts æ–‡ä»¶ä¸­ç”¨ä¸‹é¢ä¸€è¡Œå®Œæˆçš„ã€‚

```
const processor: S3Handler = async (event: S3Event) => {
```

ä½¿ç”¨å¸¦æœ‰ä»£ç å®ŒæˆåŠŸèƒ½çš„ç¼–è¾‘å™¨ï¼Œæ‚¨å¯ä»¥ç ”ç©¶ S3Event çš„å¯èƒ½æ€§ã€‚

å¤„ç†å™¨. ts

ä»äº‹ä»¶ä¸­ï¼Œæˆ‘ä»¬å¾ªç¯åˆ°è®°å½•å¹¶æ£€ç´¢ S3 å­˜å‚¨æ¡¶å¯†é’¥ã€‚æˆ‘ä»¬ä»æ¡¶ä¸­æ£€ç´¢ä¸€ä¸ªæµï¼Œå¹¶å°†å…¶ä¼ é€’ç»™ CsvImportServiceã€‚

CSV-å¯¼å…¥-æœåŠ¡. ts

CsvImportService è§£ææµä¸­çš„æ¯ä¸€è¡Œï¼Œå¹¶å°†å…¶ä¼ é€’ç»™ DataRepository ç±»ã€‚

æ•°æ®ä»“åº“. ts

DataRepository æ£€æŸ¥ç±»åˆ«å‰ç¼€ï¼Œå¹¶åœ¨ç±»åˆ«ä¸å­˜åœ¨çš„æƒ…å†µä¸‹å°†å…¶æ”¾å…¥ DynamoDB è¡¨ä¸­ã€‚è¡¨åæ˜¯ä» Lambda æ‰§è¡Œçš„ç¯å¢ƒä¸­æå–çš„ã€‚

```
put({                  
      TableName: this.tableName,                  
      Item: item,                  
      ConditionExpression: 'attribute_not_exists(#name)',                      
      ExpressionAttributeNames: {                    
          '#name': 'code',                  
    },
```

## éƒ¨ç½²ğŸš€

ç°åœ¨æˆ‘ä»¬å·²ç»å‡†å¤‡å¥½éƒ¨ç½² Lambda å‡½æ•°äº†ã€‚ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å°†å…¶éƒ¨ç½²åˆ°æ‚¨çš„ AWS å¸æˆ·ã€‚

```
serverless deploy
```

æˆåŠŸåï¼Œä½ ä¼šåœ¨ä½ çš„ AWS Lambda é¡µé¢ä¸Šæ‰¾åˆ° *bookCategoryImporter* åŠŸèƒ½ã€‚å¯¼èˆªåˆ°å®ƒä¼šæ˜¾ç¤ºéƒ¨ç½²äº† Lambda å‡½æ•°çš„ S3 è§¦å‘äº‹ä»¶ã€‚

![](img/2db73443f76801837ee95a0e775141ee.png)

bookCategoryImporter å‡½æ•°

åœ¨ Serverless.yml æ–‡ä»¶ä¸­æŒ‡å®šçš„å­˜å‚¨æ¡¶ä¹Ÿå°†è¢«åˆ›å»ºã€‚æ‚¨å¯ä»¥é€šè¿‡ä¸Šä¼ ä»¥ä¸‹æ–‡ä»¶æ¥æµ‹è¯• AWS Lambda å‡½æ•°:

![](img/e050f400e8b1eac11d02dfd9e4abebdf.png)

å¦‚æœæ‚¨åˆ›å»ºäº†ä¸€ä¸ª DynamoDB å¹¶ä¸Šä¼ äº†ä¸€ä¸ªåŒ…å«ä¸Šè¿°å†…å®¹çš„ csv æ–‡ä»¶ï¼Œé‚£ä¹ˆæ‚¨åº”è¯¥åœ¨ DynamoDB ä¸­è·å¾—ä»¥ä¸‹é¡¹ç›®:

![](img/6ef6b3dc9382638a1b88f65ddae728d9.png)

## å®Œæˆçš„ğŸ™

æ‰€ä»¥ï¼Œè¿™å°±ç»“æŸäº†ã€‚æˆ‘å¸Œæœ›è¿™å¯¹ä½ çš„æ— æœåŠ¡å™¨ä¹‹æ—…æœ‰æ‰€å¸®åŠ©ã€‚åŒæ ·ï¼Œè¿™ä¸ªé¡¹ç›®çš„ä»£ç å¯ä»¥åœ¨ Github ä¸Šæ‰¾åˆ°ğŸ‘‡å›¾ä¹¦ç±»åˆ«-ä¸Šä¼ æ–‡ä»¶å¤¹ä¸­çš„ã€https://github.com/cyberworkz/examplesã€‘T2ã€‚

# æµ·ç§‘Â·èŒƒå¾·æ²™å¤«

*   ***å¦‚æœä½ å–œæ¬¢è¿™ä¸ªï¼Œè¯·*** [***è·Ÿéš Serverlesscorner.com ä¸Šä¸­***](https://serverlesscorner.com/about) ***ã€‚***
*   ***çˆ±æƒ…*** â¤ï¸ ***é˜…è¯»*** ***æˆ‘çš„æ•…äº‹å’Œå…¶ä»–å…³äºåª’ï¼Ÿ*** [***æˆä¸ºä¼šå‘˜***](https://serverlesscorner.com/membership) ***å¦‚æœä½ è¿˜æ²¡æœ‰æˆä¸ºä¼šå‘˜ã€‚***
*   ***æƒ³é˜…è¯»æ›´å¤šæ— æœåŠ¡å™¨ï¼ŸæŠ¥åå‚åŠ æˆ‘çš„*** [***æœˆåˆŠ***](https://serverlessconsulting.org/newsletter) ***ğŸ“¬å…³äºæ— æœåŠ¡å™¨æŠ€æœ¯å’Œä½¿ç”¨æ¡ˆä¾‹çš„å¯å‘æ€§å’Œæ·±åˆ»çš„æ•…äº‹ã€‚***