<html>
<head>
<title>Kubeflow deployment on Azure (AKS), the Proper Way</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubeflow 部署在 Azure 上(AKS)，正确的方式</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/kubeflow-deployment-on-azure-aks-the-proper-way-9a35d0f36f75?source=collection_archive---------6-----------------------#2021-12-29">https://blog.devgenius.io/kubeflow-deployment-on-azure-aks-the-proper-way-9a35d0f36f75?source=collection_archive---------6-----------------------#2021-12-29</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div class="gh gi jk"><img src="../Images/aa259200f4fcd3b6afaac7c8fa175ff2.png" data-original-src="https://miro.medium.com/v2/resize:fit:634/format:webp/1*mgyMtNujkAD0f6NQlY6Hnw.png"/></div></figure><p id="68a1" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">Kubeflow 正在成为构建和部署机器学习管道的标准。许多公司正在将他们的注意力转移到这一点上，因为这使得团队更容易在 Kubernetes 上部署 ML 工作流。然而，截至目前，2022 年(嗯差不多！)当我遵循官方指示时，我在 kubeflow 中发现了一个不起作用的管道特性。我做了大量的研究和实验，才有了我想要分享的完整工作流程。</p><p id="a486" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">本教程并不介绍 Kubeflow/kubernetes，而是重点介绍如何在 AKS 上正确部署 Kubeflow 并使管道处于工作状态。</p><h1 id="9edf" class="kp kq in bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">先决条件:</h1><p id="ea79" class="pw-post-body-paragraph jr js in jt b ju ln jw jx jy lo ka kb kc lp ke kf kg lq ki kj kk lr km kn ko ig bi translated">本教程假设如下:</p><ol class=""><li id="4b0c" class="ls lt in jt b ju jv jy jz kc lu kg lv kk lw ko lx ly lz ma bi translated"><strong class="jt io"> kubeflow </strong>、<strong class="jt io"> kubernetes </strong>等基础知识。</li><li id="b79f" class="ls lt in jt b ju mb jy mc kc md kg me kk mf ko lx ly lz ma bi translated">已经安装了以下几个包:<a class="ae mg" href="https://kubernetes.io/docs/tasks/tools/#install-kubectl-on-linux" rel="noopener ugc nofollow" target="_blank"> <strong class="jt io"> kubectl </strong> </a> <strong class="jt io">，</strong> <a class="ae mg" href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest" rel="noopener ugc nofollow" target="_blank"> <strong class="jt io"> Azure 命令行(Az) </strong> </a>。</li></ol><h1 id="2951" class="kp kq in bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">部署步骤:</h1><h1 id="6776" class="kp kq in bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">1.Azure 登录</h1><p id="fcf3" class="pw-post-body-paragraph jr js in jt b ju ln jw jx jy lo ka kb kc lp ke kf kg lq ki kj kk lr km kn ko ig bi translated">在 linux/mac 中打开终端，输入以下命令登录 Azure。请确保您使用了正确的套餐。</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="9c24" class="mq kq in mm b gy mr ms l mt mu">az login<br/>az account set --subscription id_of_my_subscription</span></pre><h1 id="bef5" class="kp kq in bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">2.创建资源组</h1><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="5a18" class="mq kq in mm b gy mr ms l mt mu">az group create -n kubeflowdep -l westeurope</span></pre><h1 id="4ae5" class="kp kq in bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">3.创建专门定义的集群</h1><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="4952" class="mq kq in mm b gy mr ms l mt mu">az aks create -g kubeflowdep -n KubeCluster -s Standard_D4s_v3 -c 2 -l westeurope --generate-ssh-keys</span></pre><h1 id="fdad" class="kp kq in bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">4.库伯流装置</h1><p id="e0c3" class="pw-post-body-paragraph jr js in jt b ju ln jw jx jy lo ka kb kc lp ke kf kg lq ki kj kk lr km kn ko ig bi translated">运行以下命令来设置和部署 Kubeflow。</p><ol class=""><li id="3ca9" class="ls lt in jt b ju jv jy jz kc lu kg lv kk lw ko lx ly lz ma bi translated">创建用户凭据。您只需要运行这个命令一次。</li></ol><p id="8983" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated"><code class="fe mv mw mx mm b">az aks get-credentials -n KubeCluster -g kubeflowdep</code></p><p id="49e8" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">2.从<a class="ae mg" href="https://github.com/kubeflow/kfctl/releases/tag/v1.2.0" rel="noopener ugc nofollow" target="_blank"> Kubeflow 发布页面</a>下载 kfctl v1.2.0 版本。</p><p id="c6a0" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">3.打开焦油球包装:</p><p id="fda0" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated"><code class="fe mv mw mx mm b">tar -xvf kfctl_v1.2.0_&lt;platform&gt;.tar.gz</code></p><h1 id="c5e6" class="kp kq in bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">5.库伯流部署</h1><p id="87d4" class="pw-post-body-paragraph jr js in jt b ju ln jw jx jy lo ka kb kc lp ke kf kg lq ki kj kk lr km kn ko ig bi translated">运行以下命令来设置和部署 Kubeflow。下面的代码包含一个可选命令，用于将二进制 kfctl 添加到您的路径中。如果没有将二进制文件添加到您的路径中，那么每次运行 kfctl 二进制文件时，您都必须使用它的完整路径。</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="071c" class="mq kq in mm b gy mr ms l mt mu"># The following command is optional. It adds the kfctl binary to your path.<br/># If you don't add kfctl to your path, you must use the full path<br/># each time you run kfctl.<br/># Use only alphanumeric characters or - in the directory name.<br/>export PATH=$PATH:"&lt;path-to-kfctl&gt;"<br/><br/># Set KF_NAME to the name of your Kubeflow deployment. You also use this<br/># value as directory name when creating your configuration directory.<br/># For example, your deployment name can be 'my-kubeflow' or 'kf-test'.<br/>export KF_NAME=&lt;your choice of name for the Kubeflow deployment&gt;<br/><br/># Set the path to the base directory where you want to store one or more <br/># Kubeflow deployments. For example, /opt/.<br/># Then set the Kubeflow application directory for this deployment.<br/>export BASE_DIR=&lt;path to a base directory&gt;<br/>export KF_DIR=${BASE_DIR}/${KF_NAME}<br/><br/># Set the configuration file to use when deploying Kubeflow.<br/># The following configuration installs Istio by default. Comment out <br/># the Istio components in the config file to skip Istio installation. <br/># See https://github.com/kubeflow/kubeflow/pull/3663<br/>export CONFIG_URI="https://raw.githubusercontent.com/kubeflow/manifests/v1.2-branch/kfdef/kfctl_k8s_istio.v1.2.0.yaml"<br/><br/>mkdir -p ${KF_DIR}<br/>cd ${KF_DIR}<br/>kfctl apply -V -f ${CONFIG_URI}</span></pre><ol class=""><li id="e297" class="ls lt in jt b ju jv jy jz kc lu kg lv kk lw ko lx ly lz ma bi translated">运行以下命令，检查资源是否已经正确部署在名称空间<code class="fe mv mw mx mm b">kubeflow</code>中:</li></ol><p id="7417" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated"><code class="fe mv mw mx mm b">kubectl get all -n kubeflow</code></p><p id="056a" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">2.打开 Kubeflow 仪表板。默认安装不会创建外部端点，但您可以使用端口转发来访问您的群集。运行以下命令:</p><p id="1267" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated"><code class="fe mv mw mx mm b">kubectl port-forward svc/istio-ingressgateway -n istio-system 8080:80</code></p><p id="8b56" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">3.接下来，在浏览器中打开<code class="fe mv mw mx mm b">http://localhost:8080</code>。</p><p id="f1fe" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">以上所有步骤都直接取自官方文档，只做了微小的修改。现在，当您在浏览器中看到 Kubeflow 仪表板并转到 pipelines 时，您会遇到一个错误，如下图所示。</p><figure class="mh mi mj mk gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi my"><img src="../Images/cdb783c5527a3047a1d51a3688ce85b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*honMO78fTm1BqEA-BC8jvg.png"/></div></div></figure><p id="81c7" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">这意味着 kubeflow 的管道部署不当。原因是 istio-pod 没有被注入到 kubeflow 中的 pod。</p><h1 id="70aa" class="kp kq in bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">6.解决方法:</h1><p id="7e6f" class="pw-post-body-paragraph jr js in jt b ju ln jw jx jy lo ka kb kc lp ke kf kg lq ki kj kk lr km kn ko ig bi translated">最简单的解决方法是禁用<strong class="jt io"> tls.mode </strong>，这可以通过修改<strong class="jt io"> ml-pipeline </strong>和<strong class="jt io"> ml-pipeline-ui </strong>的目标规则来实现。我们可以通过编辑<strong class="jt io"> ml-pipeline </strong>和<strong class="jt io"> ml-pipeline-ui </strong>并将<strong class="jt io"> tls.mode </strong>从<strong class="jt io"> ISTIO_MUTUAL </strong>更改为<strong class="jt io"> DISABLE </strong>来完成<strong class="jt io">和</strong>的操作。要编辑文件，请运行以下命令。</p><p id="6e53" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated"><code class="fe mv mw mx mm b">kubectl edit destinationrule -n kubeflow ml-pipeline</code></p><p id="3278" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated"><code class="fe mv mw mx mm b">kubectl edit destinationrule -n kubeflow ml-pipeline-ui</code></p><ul class=""><li id="1cf5" class="ls lt in jt b ju jv jy jz kc lu kg lv kk lw ko nd ly lz ma bi translated">如果您再次运行端口转发命令</li></ul><p id="4579" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated"><code class="fe mv mw mx mm b">kubectl port-forward svc/istio-ingressgateway -n istio-system 8080:80</code></p><ul class=""><li id="b06f" class="ls lt in jt b ju jv jy jz kc lu kg lv kk lw ko nd ly lz ma bi translated">访问<code class="fe mv mw mx mm b"><a class="ae mg" href="http://localhost:8080" rel="noopener ugc nofollow" target="_blank">http://localhost:8080</a></code>，你可以看到管道在 kubeflow UI 中工作。</li></ul><p id="11f0" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">第二种解决方法是显式启用 istio-injection。我们可以通过在应用部署之前修改部署步骤中的 yaml 文件来实现这一点。去链接<code class="fe mv mw mx mm b"><a class="ae mg" href="https://raw.githubusercontent.com/kubeflow/manifests/v1.2-branch/kfdef/kfctl_k8s_istio.v1.2.0.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/kubeflow/manifests/v1.2-branch/kfdef/kfctl_k8s_istio.v1.2.0.yaml</a></code>下载这个文件。通过明确提及下面定义的标签来修改该文件:</p><figure class="mh mi mj mk gt jo"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="9b2b" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated"><strong class="jt io">注意:您只需要添加标签，而不需要从您正在更新的 yaml 文件中删除任何资源。</strong></p><p id="7897" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">修改后，您需要再次重新部署所有资源:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="f487" class="mq kq in mm b gy mr ms l mt mu">kfctl apply -V -f path/to/file/<!-- -->kfctl_k8s_istio.v1.2.0.yaml</span></pre><p id="f437" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">以上两种解决方案都解决了 kubeflow 管道问题，但是当您尝试运行其中一个示例管道时，它会进入挂起状态。它不会在仪表板中显示任何错误日志，但是您可以通过以下方式查看 kubernetes 名称空间的日志:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="295c" class="mq kq in mm b gy mr ms l mt mu">kubectl get events -n kubeflow --sort-by='.metadata.creationTimestamp'</span></pre><p id="e8d8" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">如果查看日志，您会遇到以下错误:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="8887" class="mq kq in mm b gy mr ms l mt mu">Unable to mount volumes for pod "pod-name" timeout expired waiting for volumes to attach or mount for pod</span></pre><p id="314c" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">该错误显示 pod 无法装入卷。默认情况下，kubernetes 集群的运行时容器是 docker。由于 Kubeflow pipelines 构建在 Argo 之上，docker 的工作流执行器在 Argo 中<a class="ae mg" href="https://argoproj.github.io/argo-workflows/workflow-executors/" rel="noopener ugc nofollow" target="_blank">被弃用</a>，这导致了 Kubeflow 新版本中的问题不断增加。</p><p id="e87c" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">为了补救这种情况，我们可以将工作流执行器从 docker 切换到其他执行器。有很多选项可供选择，但我选择了<strong class="jt io">进程名称空间共享(pns) </strong>，因为它是可伸缩的、经过充分测试的、安全的。每个选项都有优点和缺点，但是基于比较，pns 似乎是一个可行的选项。这里可以看到对比:<a class="ae mg" href="https://argoproj.github.io/argo-workflows/workflow-executors/" rel="noopener ugc nofollow" target="_blank">https://argoproj . github . io/Argo-workflows/workflow-executors/</a>。要从 docker 切换到 pns 或任何其他工作流执行器，您必须通过输入以下命令来编辑<code class="fe mv mw mx mm b">workflow-controller-configmap</code>:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="eaaa" class="mq kq in mm b gy mr ms l mt mu">kubectl edit configmap workflow-controller-configmap -n kubeflow<!-- --> </span></pre><p id="fc5b" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">并将<code class="fe mv mw mx mm b">containerRuntimeExecutor:</code>从<strong class="jt io">对接</strong>改为<strong class="jt io"> pns </strong>。应用此更改后，您可以再次运行以下命令:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="7bcc" class="mq kq in mm b gy mr ms l mt mu">kubectl port-forward svc/istio-ingressgateway -n istio-system 8080:80<!-- --> </span></pre><p id="782d" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">如果您现在在浏览器中打开<code class="fe mv mw mx mm b">http://localhost:8080</code>,您可以尝试运行其中一个示例管道，它应该会像预期的那样工作。这是它的部署。我希望这篇文章能帮助某人将 kubeflow 部署到 AKS。</p></div><div class="ab cl ng nh hr ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="ig ih ii ij ik"><h1 id="62b9" class="kp kq in bd kr ks nn ku kv kw no ky kz la np lc ld le nq lg lh li nr lk ll lm bi translated">参考资料:</h1><div class="ns nt gp gr nu nv"><a href="https://www.kubeflow.org/docs/distributions/azure/deploy/install-kubeflow/" rel="noopener  ugc nofollow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd io gy z fp oa fr fs ob fu fw im bi translated">安装 Kubeflow</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">部署 Kubeflow 的说明本指南描述了如何使用 kfctl 二进制文件在 Azure 上部署 Kubeflow。你…</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">www.kubeflow.org</p></div></div></div></a></div><div class="ns nt gp gr nu nv"><a href="https://github.com/kubeflow/pipelines/issues/3407" rel="noopener  ugc nofollow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd io gy z fp oa fr fs ob fu fw im bi translated">管道箱失败安装问题# 3407 kube flow/管道</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">我尝试了 https://github . com/kube flow/examples/tree/master/pipelines/simple-notebook-pipeline 中的例子来测试…</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">github.com</p></div></div><div class="oe l"><div class="of l og oh oi oe oj jp nv"/></div></div></a></div><div class="ns nt gp gr nu nv"><a href="https://github.com/kubeflow/kubeflow/issues/5277" rel="noopener  ugc nofollow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd io gy z fp oa fr fs ob fu fw im bi translated">管道上游连接错误或在集管之前断开/重置。重置原因:连接…</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">github.com</p></div></div><div class="oe l"><div class="ok l og oh oi oe oj jp nv"/></div></div></a></div></div></div>    
</body>
</html>