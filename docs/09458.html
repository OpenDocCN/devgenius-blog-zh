<html>
<head>
<title>Time to migrate from Shared Preferences to DataStore</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从共享首选项迁移到数据存储的时间</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/time-to-migrate-from-shared-preferences-to-datastore-ef9e4ba352cc?source=collection_archive---------8-----------------------#2022-08-22">https://blog.devgenius.io/time-to-migrate-from-shared-preferences-to-datastore-ef9e4ba352cc?source=collection_archive---------8-----------------------#2022-08-22</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="881b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">安卓|科特林</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/3d4221d4433f71d2f77cd933da9d5b89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WFYiKMys2bfYF25DqRsF6w.png"/></div></div></figure><p id="2b3a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">谷歌在 Android Jetpack 中引入了一个名为 DataStore 的新功能。一个存储键值对的库，与共享首选项一样，但效率更高。Datastore 使用 Kotlin 协同例程和流来异步、一致和过渡地存储数据。</p><p id="8b9d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">数据存储是共享首选项的替代品，它避免了共享首选项带来的许多缺陷。</p><h2 id="2a45" class="ku kv in bd kw kx ky dn kz la lb dp lc jv ld le lf jz lg lh li kd lj lk ll lm bi translated">要点</h2><ol class=""><li id="ccf8" class="ln lo in jm b jn lp jr lq jv lr jz ls kd lt kh lu lv lw lx bi translated">共享首选项是同步的，在主线程上运行。但是 dataStore 是异步的，使用 Kotlin 协同程序，运行在一个单独的线程上，这使得它是线程安全的。(在 Dispatcher.io 下面)</li><li id="82bb" class="ln lo in jm b jn ly jr lz jv ma jz mb kd mc kh lu lv lw lx bi translated">用于存储和读取数据的异步 API。(流量)</li><li id="782d" class="ln lo in jm b jn ly jr lz jv ma jz mb kd mc kh lu lv lw lx bi translated">数据存储在数据解析期间也不会出现运行时异常。</li><li id="d047" class="ln lo in jm b jn ly jr lz jv ma jz mb kd mc kh lu lv lw lx bi translated">不提供任何类型安全。</li></ol><h2 id="64de" class="ku kv in bd kw kx ky dn kz la lb dp lc jv ld le lf jz lg lh li kd lj lk ll lm bi translated">有两种类型的数据存储</h2><ol class=""><li id="f759" class="ln lo in jm b jn lp jr lq jv lr jz ls kd lt kh lu lv lw lx bi translated"><strong class="jm io"> Preferences DataStore </strong> -使用密钥存储和访问数据。这种实现不需要预定义的架构，也不提供类型安全。</li><li id="4fe3" class="ln lo in jm b jn ly jr lz jv ma jz mb kd mc kh lu lv lw lx bi translated"><strong class="jm io">Proto DataStore</strong>——将数据存储为自定义数据类型的实例。这个实现要求你使用<a class="ae md" href="https://developers.google.com/protocol-buffers" rel="noopener ugc nofollow" target="_blank">协议缓冲区</a>定义一个模式，但是它提供了类型安全。</li></ol><h2 id="5d6c" class="ku kv in bd kw kx ky dn kz la lb dp lc jv ld le lf jz lg lh li kd lj lk ll lm bi translated">这是一个关于集成数据存储的视频。请看一看！</h2><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="me mf l"/></div></figure><blockquote class="mg"><p id="ab58" class="mh mi in bd mj mk ml mm mn mo mp kh dk translated">如果两者都冻结了，在水上行走和开发软件就容易了——匿名</p><p id="d27d" class="mh mi in bd mj mk mq mr ms mt mu kh dk translated">所以，永远保持进步的空间，远离你的舒适区！..现在让我们深入编码。</p></blockquote><h2 id="6b50" class="ku kv in bd kw kx mv dn kz la mw dp lc jv mx le lf jz my lh li kd mz lk ll lm bi translated">1.向应用程序添加数据存储</h2><p id="c395" class="pw-post-body-paragraph jk jl in jm b jn lp jp jq jr lq jt ju jv na jx jy jz nb kb kc kd nc kf kg kh ig bi translated">从数据存储开始，您需要首先将打开 app.gradle 文件的库添加到您的项目中，并添加以下依赖项。</p><pre class="kj kk kl km gt nd ne nf ng aw nh bi"><span id="049e" class="ku kv in ne b gy ni nj l nk nl"><em class="nm">//preference DataStore<br/></em>implementation "androidx.datastore:datastore-preferences:1.0.0-beta01"</span></pre><p id="f26f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">立即同步项目。</p><h2 id="8364" class="ku kv in bd kw kx ky dn kz la lb dp lc jv ld le lf jz lg lh li kd lj lk ll lm bi translated"><strong class="ak"> 2。创建数据存储实例，并将数据存储命名为</strong></h2><pre class="kj kk kl km gt nd ne nf ng aw nh bi"><span id="abe9" class="ku kv in ne b gy ni nj l nk nl">private val Context.<em class="nm">dataStore</em>: DataStore&lt;Preferences&gt; by <em class="nm">preferencesDataStore</em>(name = "user")</span></pre><p id="32a2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我已经使用委托创建了一个数据存储对象，并将其命名为“user”。</p><h2 id="3c37" class="ku kv in bd kw kx ky dn kz la lb dp lc jv ld le lf jz lg lh li kd lj lk ll lm bi translated">3.定义键</h2><p id="0c19" class="pw-post-body-paragraph jk jl in jm b jn lp jp jq jr lq jt ju jv na jx jy jz nb kb kc kd nc kf kg kh ig bi translated">我们现在定义将作为键值对存储的数据。用我们需要存储的数据类型来存储数据。在访问字符串的情况下，它将是<em class="nm"> stringPreferencesKey。</em></p><pre class="kj kk kl km gt nd ne nf ng aw nh bi"><span id="c813" class="ku kv in ne b gy ni nj l nk nl">companion object {<br/>    val NAME = <em class="nm">stringPreferencesKey</em>("NAME")<br/>    val PHONE_NUMBER = <em class="nm">stringPreferencesKey</em>("PHONE_NUMBER")<br/>    val ADDRESS = <em class="nm">stringPreferencesKey</em>("ADDRESS")<br/>}</span></pre><h2 id="d85d" class="ku kv in bd kw kx ky dn kz la lb dp lc jv ld le lf jz lg lh li kd lj lk ll lm bi translated">4.数据存储的保存功能</h2><p id="bb04" class="pw-post-body-paragraph jk jl in jm b jn lp jp jq jr lq jt ju jv na jx jy jz nb kb kc kd nc kf kg kh ig bi translated">首先，我们需要使用一个挂起函数来保存和检索数据。挂起函数只能从另一个挂起函数中的协程调用。</p><p id="d948" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在，我们需要使用从使用 dataStore 的活动传递来的上下文来调用 edit 函数，以便根据我们创建的数据存储数据。</p><pre class="kj kk kl km gt nd ne nf ng aw nh bi"><span id="117e" class="ku kv in ne b gy ni nj l nk nl">suspend fun savetoDataStore(user: User) {<br/>    context.<em class="nm">dataStore</em>.edit <strong class="ne io">{<br/>        it</strong>[NAME] = user.name<br/>        <strong class="ne io">it</strong>[PHONE_NUMBER] = user.phone<br/>        <strong class="ne io">it</strong>[ADDRESS] = user.address<br/>    <strong class="ne io">}<br/></strong>}</span></pre><h2 id="7651" class="ku kv in bd kw kx ky dn kz la lb dp lc jv ld le lf jz lg lh li kd lj lk ll lm bi translated">5.获取数据存储的函数</h2><p id="c543" class="pw-post-body-paragraph jk jl in jm b jn lp jp jq jr lq jt ju jv na jx jy jz nb kb kc kd nc kf kg kh ig bi translated">该函数有助于从数据存储中获取数据。它将数据存储中的所有键映射到我们已经创建的模型类。当需要时，我们可以在以后的任何活动或课程中检索它。</p><pre class="kj kk kl km gt nd ne nf ng aw nh bi"><span id="1c1b" class="ku kv in ne b gy ni nj l nk nl">suspend fun getFromDataStore() = context.<em class="nm">dataStore</em>.data.<em class="nm">map </em><strong class="ne io">{<br/>    </strong>User(<br/>        name = <strong class="ne io">it</strong>[NAME]?:"",<br/>        phone = <strong class="ne io">it</strong>[PHONE_NUMBER]?:"",<br/>        address = <strong class="ne io">it</strong>[ADDRESS]?:""<br/>    )<br/><strong class="ne io">}</strong></span></pre><h2 id="50c1" class="ku kv in bd kw kx ky dn kz la lb dp lc jv ld le lf jz lg lh li kd lj lk ll lm bi translated">6.正在初始化活动中的数据存储</h2><pre class="kj kk kl km gt nd ne nf ng aw nh bi"><span id="11f7" class="ku kv in ne b gy ni nj l nk nl">//Declaring DataStoreManager<br/>lateinit var dataStoreManager: DataStoreManager</span></pre><p id="c758" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">初始化 datastore manager——我们需要在 create 函数中初始化它。</p><pre class="kj kk kl km gt nd ne nf ng aw nh bi"><span id="fa24" class="ku kv in ne b gy ni nj l nk nl">dataStoreManager = DataStoreManager(this@MainActivity)</span></pre><h2 id="7413" class="ku kv in bd kw kx ky dn kz la lb dp lc jv ld le lf jz lg lh li kd lj lk ll lm bi translated">7.将数据保存到数据存储中</h2><p id="5329" class="pw-post-body-paragraph jk jl in jm b jn lp jp jq jr lq jt ju jv na jx jy jz nb kb kc kd nc kf kg kh ig bi translated">这是我们将数据存储到数据存储区的地方，我们需要创建一个 GlobalScope 对象来帮助我们调用挂起函数。我们需要添加 GlobalScope.launch(Dispatchers。IO)- cause dataStore 是一个协程，需要作为协程线程来访问。</p><pre class="kj kk kl km gt nd ne nf ng aw nh bi"><span id="6a13" class="ku kv in ne b gy ni nj l nk nl">GlobalScope.<em class="nm">launch</em>(Dispatchers.IO) <strong class="ne io">{<br/>     </strong>dataStoreManager.savetoDataStore(User("Sharon", "3526281", "Bangalore"))<br/><strong class="ne io">}</strong></span></pre><p id="4012" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">要从数据存储中获取存储的数据，我们需要使用同样的 GlobalScope 原因，这也是一个挂起函数。简单到只需使用 collect 函数获取数据。我只是在一个文本视图中显示它，例如它可以被添加到字符串中，并在需要的地方使用。</p><pre class="kj kk kl km gt nd ne nf ng aw nh bi"><span id="b237" class="ku kv in ne b gy ni nj l nk nl">GlobalScope.<em class="nm">launch</em>(Dispatchers.IO) <strong class="ne io">{<br/>    </strong>dataStoreManager.getFromDataStore().collect <strong class="ne io"><br/></strong>userDetailsText.setText(<strong class="ne io">it</strong>.name + " " + <strong class="ne io">it</strong>.phone +" "+ <strong class="ne io">it</strong>.address)<br/>    <strong class="ne io">}<br/>}</strong></span></pre><p id="e6dd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这就是关于数据存储的全部内容…</p><p id="415c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">android 官方文档中提到的最后一件事- <em class="nm"> DataStore 只是共享首选项的替代品，如果存储大量数据和进行复杂计算，它总是建议使用房间数据库。</em></p><p id="24d1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">为了更好的理解，我把所有的类都粘贴在这里。</p><h2 id="8469" class="ku kv in bd kw kx ky dn kz la lb dp lc jv ld le lf jz lg lh li kd lj lk ll lm bi translated">DataStoreManager:-</h2><pre class="kj kk kl km gt nd ne nf ng aw nh bi"><span id="0ce7" class="ku kv in ne b gy ni nj l nk nl">class DataStoreManager constructor(val context: Context) {<br/><br/>    private val Context.<em class="nm">dataStore</em>: DataStore&lt;Preferences&gt; by <em class="nm">preferencesDataStore</em>(name = "user")<br/><br/>    companion object {<br/>        val NAME = <em class="nm">stringPreferencesKey</em>("NAME")<br/>        val PHONE_NUMBER = <em class="nm">stringPreferencesKey</em>("PHONE_NUMBER")<br/>        val ADDRESS = <em class="nm">stringPreferencesKey</em>("ADDRESS")<br/>    }<br/><br/>    suspend fun savetoDataStore(phonebook: PhoneBook) {<br/>        context.<em class="nm">dataStore</em>.edit <strong class="ne io">{<br/>            it</strong>[NAME] = phonebook.name<br/>            <strong class="ne io">it</strong>[PHONE_NUMBER] = phonebook.phone<br/>            <strong class="ne io">it</strong>[ADDRESS] = phonebook.address<br/>        <strong class="ne io">}<br/>    </strong>}<br/><br/>    suspend fun getFromDataStore() = context.<em class="nm">dataStore</em>.data.<em class="nm">map </em><strong class="ne io">{<br/>        </strong>PhoneBook(<br/>            name = <strong class="ne io">it</strong>[NAME]?:"",<br/>            phone = <strong class="ne io">it</strong>[PHONE_NUMBER]?:"",<br/>            address = <strong class="ne io">it</strong>[ADDRESS]?:""<br/>        )<br/>    <strong class="ne io">}<br/></strong>}</span></pre><h2 id="9591" class="ku kv in bd kw kx ky dn kz la lb dp lc jv ld le lf jz lg lh li kd lj lk ll lm bi translated">主要活动:-</h2><pre class="kj kk kl km gt nd ne nf ng aw nh bi"><span id="3d94" class="ku kv in ne b gy ni nj l nk nl">class MainActivity: AppCompatActivity() {<br/><br/>    lateinit var dataStoreManager: DataStoreManager<br/><br/>    override fun onCreate(savedInstanceState: Bundle?) {<br/>        super.onCreate(savedInstanceState)<br/>        setContentView(R.layout.<em class="nm">activity_main</em>)<br/><br/>        dataStoreManager = DataStoreManager(this@MainActivity)<br/><br/>        GlobalScope.<em class="nm">launch</em>(Dispatchers.IO) <strong class="ne io">{<br/>            </strong>dataStoreManager.getFromDataStore().collect <strong class="ne io">{<br/>                </strong>dataStoreManager.savetoDataStore(PhoneBook("Sharon", "3526281", "Bangalore"))<br/>                phoneBookDetails.setText(<strong class="ne io">it</strong>.name + " " + <strong class="ne io">it</strong>.phone +" "+ <strong class="ne io">it</strong>.address)<br/>            <strong class="ne io">}<br/>        }<br/>    </strong>}<br/><br/>    override fun onDestroy() {<br/>        super.onDestroy()<br/>    }<br/>}</span></pre><h2 id="2039" class="ku kv in bd kw kx ky dn kz la lb dp lc jv ld le lf jz lg lh li kd lj lk ll lm bi translated">谢谢大家！..</h2></div></div>    
</body>
</html>