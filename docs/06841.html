<html>
<head>
<title>Auto Optimize Apache Spark on EMR AWS with the Spark Autotuner</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Spark Autotuner 自动优化 EMR AWS 上的 Apache Spark</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/apache-spark-cluster-autotuner-its-finally-here-b5af5440f522?source=collection_archive---------9-----------------------#2022-02-07">https://blog.devgenius.io/apache-spark-cluster-autotuner-its-finally-here-b5af5440f522?source=collection_archive---------9-----------------------#2022-02-07</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="a110" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">在 Duolingo 使用 Apache Spark Autotuner 对 AWS 上的 EMR 进行案例研究</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/1041079686f24f7d7edc44f5655262a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Gpguoyc_f63HCE63"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk translated">莉齐·萨斯曼在<a class="ae ks" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="0186" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">我们很高兴向您展示<a class="ae ks" href="http://www.synccomputing.com/autotuner" rel="noopener ugc nofollow" target="_blank">Sync Apache Spark Cluster auto tuner</a>解决方案，以及它是如何将 Duolingo 的 AWS EMR Spark 成本降低高达 55%的。包括数据科学家和数据工程师在内的数据专业人员通常没有时间为他们的 Spark 工作手动调整和优化他们的集群。此解决方案消除了猜测，提供了最佳的成本、性能和可靠性，而无需任何代码更改。</p><blockquote class="lp lq lr"><p id="064e" class="kt ku ls kv b kw kx jo ky kz la jr lb lt ld le lf lu lh li lj lv ll lm ln lo ig bi translated"><a class="ae ks" href="http://www.synccomputing.com/autotuner" rel="noopener ugc nofollow" target="_blank">亲自尝试 Apache Spark 的同步自动调优器</a></p></blockquote><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="lw lx l"/></div></figure><h2 id="4a38" class="ly lz in bd ma mb mc dn md me mf dp mg lc mh mi mj lg mk ml mm lk mn mo mp mq bi translated">Spark 基础设施的问题是</h2><p id="fb9f" class="pw-post-body-paragraph kt ku in kv b kw mr jo ky kz ms jr lb lc mt le lf lg mu li lj lk mv lm ln lo ig bi translated"><strong class="kv io">对于云开发人员来说，确定云基础设施设置以优化现代 Spark 作业的作业成本和速度既不实际也不可能。</strong>即使对一个作业进行了最佳设置，Spark 作业在代码库、数据大小和云现货定价方面每天都在变化，导致开发人员的成本/性能差异很大。大多数云用户依靠简单的经验法则或同事或过去工作的建议来选择设置。优化这些选择需要扫描实例类型、云设置和 spark 配置，没有一个忙碌的数据工程师有时间完成这项任务。</p><p id="14cf" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">如果不必实际重新运行作业就能探索硬件变化的影响，那会怎么样？在每次 Spark 运行的输出中，都埋藏着一个将它的性能与底层硬件联系起来的信息宝库。当与深度数学建模相结合时，这些数据可用于预测不同云硬件配置上的应用性能。这是 Sync 的第一个解决方案 Spark Cluster Autotuner 背后的核心思想。</p><h1 id="1948" class="mw lz in bd ma mx my mz md na nb nc mg jt nd ju mj jw ne jx mm jz nf ka mp ng bi translated">Sync Spark Cluster Autotuner 如何提供帮助。</h1><p id="5d70" class="pw-post-body-paragraph kt ku in kv b kw mr jo ky kz ms jr lb lc mt le lf lg mu li lj lk mv lm ln lo ig bi translated"><strong class="kv io"> Sync 的 spark 集群自动调优器消除了为您的重复性生产 Spark 应用选择正确的 AWS 集群硬件和 Spark 配置的负担。</strong>Cluster auto tuner 仅使用最新的 spark 事件日志及其相关的集群信息，为您的下一次运行返回最佳的集群和 Spark 配置。</p><p id="97b9" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">无论对您来说“最佳”是指最快、最便宜还是介于两者之间，集群自动调优器都会根据您的需要提供适当的设置，</p><h1 id="6ecf" class="mw lz in bd ma mx my mz md na nb nc mg jt nd ju mj jw ne jx mm jz nf ka mp ng bi translated">同步火花簇自动调谐器如何工作。</h1><p id="b6fa" class="pw-post-body-paragraph kt ku in kv b kw mr jo ky kz ms jr lb lc mt le lf lg mu li lj lk mv lm ln lo ig bi translated"><strong class="kv io">集群自动调优器的工作原理是对 spark 事件日志的任务级细节进行数学建模，并计算这些细节在不同硬件配置上的变化，从而估计每组硬件的运行时间。</strong></p><p id="53cf" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">运行时间估计值与最新的 AWS 定价和可靠性信息相结合，得出每种配置的性能估计值(运行时间和成本)。执行优化计算以搜索所有配置，为用户挑选最佳选项。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi nh"><img src="../Images/f79bef8f99bb63f36629c832680a6e7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4DbpkeWL0kNLqfN5Fo1K5Q.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk translated"><strong class="bd ma">图 2: </strong>火花预测器的基本工作流程</figcaption></figure><h1 id="ba50" class="mw lz in bd ma mx my mz md na nb nc mg jt nd ju mj jw ne jx mm jz nf ka mp ng bi translated">Duolingo 在 AWS EMR 上为 Apache Spark 使用同步自动调优器</h1><p id="501b" class="pw-post-body-paragraph kt ku in kv b kw mr jo ky kz ms jr lb lc mt le lf lg mu li lj lk mv lm ln lo ig bi translated"><strong class="kv io"> Duolingo 打造世界第一的语言学习应用，服务超过 5 亿用户。</strong>作为一家云原生公司，Duolingo 每天在云上处理数 TB 的数据，导致成本过高。高效利用云会直接影响公司的利润。</p><p id="cd47" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">在下一节中，我们将展示一个使用 Duolingo 的解决方案的案例研究。实验遵循图 2 所示的工作流程。</p><p id="8772" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">Duolingo 有许多在 AWS EMR 上运行的重复性 production Spark 作业，当这些作业每天运行甚至每天运行多次时，一年中会产生大量成本。他们的首要任务是降低成本，即使以运行时间为代价。自行找出最佳配置需要大量的手动测试和参数扫描，这是一项耗时的任务，没有工程师有足够的带宽来完成。</p><blockquote class="lp lq lr"><p id="30da" class="kt ku ls kv b kw kx jo ky kz la jr lb lt ld le lf lu lh li lj lv ll lm ln lo ig bi translated">Duolingo 的首要任务是降低成本，即使以运行时间为代价。自行找出最佳配置需要大量的手动测试和参数扫描，这是一项耗时的任务，没有工程师有足够的带宽来完成。</p></blockquote><p id="7e6d" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">Sync 向他们展示了 Spark Cluster Autotuner，这将摆脱手动实验，从而立即降低他们两项 ETL 工作的云成本。这些工作的基本信息如表 1 所示。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ni"><img src="../Images/afb5d0b4ac4a76fb0f8b9797ed752011.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QXBtAXc1Pag1fMZr8k37zA.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk translated">表 1。对 Duolingo 生产 Apache Spark 作业的高级描述</figcaption></figure><p id="3a9b" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">每个作业的最新事件日志通过集群自动调优器运行，产生较低集群开销的配置用于后续运行。该实验的结果如图 3 所示。对于这两项工作，同步优化配置导致成本大幅降低，无需接触任何代码，实现了简单且完全可逆的演示。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi nj"><img src="../Images/a8f48967806222cf88ffabcde2bcd4ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*19oU5p946xJXPRoFyGz7EQ.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk translated"><strong class="bd ma">图 3: </strong>使用 Sync Spark Cluster 自动调优器前后三个 Spark 作业的成本效率</figcaption></figure><p id="1b75" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><strong class="kv io">图 4 显示了使用 Duolingo 的 ETL-D 日志预测的子集。</strong>显示了三种实例类型，其中相应曲线上的每个点代表不同数量的工人。输入、预测和测量作业的性能估计值分别由红色、绿色和蓝色三角形表示。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi nk"><img src="../Images/dfb293d1fa25728143730b7d1b04f387.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6zSQMT4jTCQs7dbfRTGTWg.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk translated"><strong class="bd ma">图 4: </strong>对 ETL-D 作业的不同硬件配置的性能预测。三角形表示输入、预测和测量的性能点。</figcaption></figure><h1 id="8be8" class="mw lz in bd ma mx my mz md na nb nc mg jt nd ju mj jw ne jx mm jz nf ka mp ng bi translated">预测</h1><p id="e50b" class="pw-post-body-paragraph kt ku in kv b kw mr jo ky kz ms jr lb lc mt le lf lg mu li lj lk mv lm ln lo ig bi translated">在本例中，预测中的少量工人导致长期运行但成本低廉的工作。随着工作人员数量的增加，预计应用程序会更快，但成本也会更高。最初的投入配置处于集群规模收益递减的平台期。因此，建议减少工作人员的数量，以摆脱运行时平台。</p><p id="90a8" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">Cluster Autotuner 提供的关键洞察力来自于您对当前工作在性能曲线上所处位置的了解，以及您需要做出哪些改变才能到达该曲线上的另一个点。在 Duolingo 的案例中，成本是唯一相关的参数。另一方面，如果运行时间是一个关键参数，那么很容易在这条曲线上选择另一个点，它的运行速度几乎与原始作业一样快，但仍能显著节省成本。</p><p id="57d9" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">这种选择的灵活性是 Spark Cluster Autotuner 的主要用途。单词“optimal”对一组人来说意味着最便宜，对另一组人来说意味着最快，集群自动调优器根据每个用户的需求给出正确的配置。表 2 显示了该作业的输入和预测配置。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi nl"><img src="../Images/c2261d14064c4c75744a2252a9b8f5b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hKsaJ-9m4sSwem5HpNRxZw.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk translated"><strong class="bd ma">表 2: </strong>使用集群自动调优器执行 ETL-D 任务前后的硬件和 spark 配置。</figcaption></figure><h1 id="0daa" class="mw lz in bd ma mx my mz md na nb nc mg jt nd ju mj jw ne jx mm jz nf ka mp ng bi translated">测量</h1><p id="19b1" class="pw-post-body-paragraph kt ku in kv b kw mr jo ky kz ms jr lb lc mt le lf lg mu li lj lk mv lm ln lo ig bi translated"><strong class="kv io">当 Duolingo 在生产运行中实际运行这一预测配置时，他们立即看到了显著的成本节约</strong>——这正是他们的目标。</p><p id="314a" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">最大的成本节约来自集群规模的缩减(从 1，664 个 vcpu 减少到 384 个)。虽然集群大小减少了 4 倍，但运行时间仅从 17 分钟略微增加到 22 分钟，成本降低了 55%。</p><p id="c5e0" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">这些结果可以通过查看图 5 中的活动图表来理解。在输入日志中，活动内核的平均数量只有 Spark 可用内核的六分之一。这表明大部分作业没有得到很好的分配，并且大部分集群时间都没有做任何事情。优化后的结果减小了集群大小，使平均活动更接近可用容量，从而使作业更高效，因此成本更低。当然，那些分布良好的阶段现在需要更长的时间，导致运行时间稍微长一点。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi nm"><img src="../Images/89fa7ed088219e2ff5d0e74368381297.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VQWMXudMvNbtFDx5l_Q2Aw.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk translated"><strong class="bd ma">图 5: </strong>运行 Sync 的 Spark 集群自动调优器前后 ETL-D 作业的集群活动</figcaption></figure><p id="d1f9" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">乍一看，进一步减小集群大小似乎可以进一步提高利用率，从而降低成本。然而，在这种情况下，这是不正确的，因为增加运行时间也会增加驱动程序成本和 EBS 成本。集群自动调优器考虑了所有这些因素，以估计在不同集群规模下运行作业的总成本。</p><p id="dd79" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">下一个对作业影响最大的变化是驱动程序的大小，因为驱动程序的一个按需实例的成本相当于几个等效的 spot 实例。在分析输入日志后，集群自动调优器确定 m5.xlarge 有足够的内存来处理这项工作，从而将驱动程序成本降低了近 10 倍。最后，对 Spark 配置的更改在很大程度上是为了符合新的硬件配置，尽管这些设置对于应用程序在硬件上高效运行是必要的。</p><h1 id="5fc7" class="mw lz in bd ma mx my mz md na nb nc mg jt nd ju mj jw ne jx mm jz nf ka mp ng bi translated">结论</h1><p id="1be9" class="pw-post-body-paragraph kt ku in kv b kw mr jo ky kz ms jr lb lc mt le lf lg mu li lj lk mv lm ln lo ig bi translated"><strong class="kv io">这个演示只是 Spark Cluster 自动调优器内置复杂性的一个小例子。</strong>对硬件和 Spark 设置的更改会以许多微妙的方式影响作业的运行时间。正确考虑这些影响以准确预测运行时需要深入的数学建模和集群自动调优器的优化，这远远超出了简单的经验法则决策或局部优化技术的能力。但是不要相信我们的话，今天就在你的真实生产 Spark 工作中尝试下面链接中的我们的第一个解决方案——我们很喜欢你的反馈。</p><p id="0070" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">同步计算-在提交作业以获得最佳性能和价值之前，根据成本和时间为您的数据/ML 工作负载配置复杂的云基础架构。</p><h1 id="b9e3" class="mw lz in bd ma mx my mz md na nb nc mg jt nd ju mj jw ne jx mm jz nf ka mp ng bi translated">在几分钟内尝试一下</h1><p id="2bbf" class="pw-post-body-paragraph kt ku in kv b kw mr jo ky kz ms jr lb lc mt le lf lg mu li lj lk mv lm ln lo ig bi translated"><a class="ae ks" href="https://www.synccomputing.com/autotuner" rel="noopener ugc nofollow" target="_blank">Sync Apache Spark 自动调优器现已上市。</a></p><p id="8d7f" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">我们将会扩展 Autotuner 工作的平台，所以如果你现在还没有使用 EMR，请继续关注或者<a class="ae ks" href="mailto: info@synccomputing.com" rel="noopener ugc nofollow" target="_blank">发送消息</a>给我们任何其他请求！</p><p id="633a" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><em class="ls">这篇博文最初发布在</em> <a class="ae ks" href="https://synccomputing.com/case-studies/duolingo/" rel="noopener ugc nofollow" target="_blank"> <em class="ls"> Sync 的个人网站这里</em> </a> <em class="ls">。</em></p></div></div>    
</body>
</html>