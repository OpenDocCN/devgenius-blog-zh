<html>
<head>
<title>Manage Azure Blob Storage In NestJS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在 NestJS 中管理 Azure Blob 存储</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/manage-azure-blob-storage-in-nestjs-daf5cb5125d4?source=collection_archive---------6-----------------------#2022-07-11">https://blog.devgenius.io/manage-azure-blob-storage-in-nestjs-daf5cb5125d4?source=collection_archive---------6-----------------------#2022-07-11</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/30d4990be6ca99a5f0b511b8d72668a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qwN284m7Ymniz17IXATNKQ.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">在 NestJS 中管理 Azure Blob 存储</figcaption></figure><p id="67f2" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">大家好！😀</p><p id="38ba" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">在这篇文章中，我将讨论 azure blob 存储，以及我们如何一步一步地从 NestJS 应用程序上传、删除、读取和下载我们的文件/图像。</p><p id="ba7b" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">🚀让我们开始今天的内容吧</p><ul class=""><li id="9614" class="kx ky in kb b kc kd kg kh kk kz ko la ks lb kw lc ld le lf bi translated">什么是 Azure blob 存储</li><li id="5157" class="kx ky in kb b kc lg kg lh kk li ko lj ks lk kw lc ld le lf bi translated">创建存储帐户</li><li id="c5ae" class="kx ky in kb b kc lg kg lh kk li ko lj ks lk kw lc ld le lf bi translated">创建资源</li><li id="8156" class="kx ky in kb b kc lg kg lh kk li ko lj ks lk kw lc ld le lf bi translated">创建容器</li><li id="bd5a" class="kx ky in kb b kc lg kg lh kk li ko lj ks lk kw lc ld le lf bi translated">创建 NestJS 端点</li></ul><h1 id="44e4" class="ll lm in bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">什么是 Azure Blob 存储</h1><p id="8950" class="pw-post-body-paragraph jz ka in kb b kc mj ke kf kg mk ki kj kk ml km kn ko mm kq kr ks mn ku kv kw ig bi translated">嘿，你知道在构建应用程序时如何管理大量存储吗？🤔。我相信 Azure Blob 存储服务将是您的答案之一😋。</p><p id="1859" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">如果你不知道，不要着急！在接下来的几分钟里，你会了解到这一点。开始吧！😎</p><p id="b2fe" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">Azure 为我们提供了各种 web 服务，blob 存储就是其中之一。Azure Blob 存储是微软的云对象存储解决方案，它基本上是为存储大量非结构化数据而优化的。非结构化数据是不符合特定数据模型或定义的数据，如文本或二进制数据。Blob 存储可通过 azure storage、rest API、azure PowerShell、Azure CLI 或 Azure Storage 客户端库进行访问。</p><p id="4726" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">Azure blob 存储主要由三种类型的资源组成，即存储帐户、容器和 blob。下图显示了这三种资源之间的关系。</p><figure class="mp mq mr ms gt jo gh gi paragraph-image"><div class="gh gi mo"><img src="../Images/40befe2002b1be6f04d84da31bf0c06d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1316/format:webp/1*GmcHKR3cOW9W7WD7tTnCCg.png"/></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">Azure Blob 存储</figcaption></figure><h1 id="52fc" class="ll lm in bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">存储帐户</h1><p id="f341" class="pw-post-body-paragraph jz ka in kb b kc mj ke kf kg mk ki kj kk ml km kn ko mm kq kr ks mn ku kv kw ig bi translated">我们存储账户中的所有数据都在服务端自动加密。存储帐户在 Azure 中为我们的数据提供了唯一的名称空间😮。我们存储在 Azure 存储中的每个对象都有一个地址，其中包含我们唯一的帐户名。帐户名和 Azure 存储服务端点的组合构成了我们的存储帐户的端点。</p><p id="de56" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">例如，如果我们将我们的存储帐户命名为“myazurestorageaccount”，那么 blob 存储的默认端点是，</p><p id="e1ac" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><a class="ae mt" href="http://myazurestorageaccount.blob.core.windows.net" rel="noopener ugc nofollow" target="_blank"><em class="mu"/>http://myazurestorageaccount.blob.core.windows.net</a></p><p id="e262" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">在命名存储帐户时，我们应该考虑帐户名的字符长度。它的长度应该在 3 到 24 个字符之间。它只能包含数字和小写字母。另一件事是没有两个存储帐户可以有相同的名称。</p><h1 id="65b2" class="ll lm in bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">容器</h1><p id="aa73" class="pw-post-body-paragraph jz ka in kb b kc mj ke kf kg mk ki kj kk ml km kn ko mm kq kr ks mn ku kv kw ig bi translated">一个存储帐户可以有无限数量的容器，容器可以有无限数量的 blobs，当您决定容器名称时，请确保使用小写字母。😀</p><h1 id="ee73" class="ll lm in bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">一滴</h1><p id="ca4c" class="pw-post-body-paragraph jz ka in kb b kc mj ke kf kg mk ki kj kk ml km kn ko mm kq kr ks mn ku kv kw ig bi translated">有三种类型的斑点</p><ul class=""><li id="2047" class="kx ky in kb b kc kd kg kh kk kz ko la ks lb kw lc ld le lf bi translated">Block blobs 存储文本和二进制数据</li><li id="29b0" class="kx ky in kb b kc lg kg lh kk li ko lj ks lk kw lc ld le lf bi translated">追加 blobs 针对追加操作进行了优化</li><li id="734b" class="kx ky in kb b kc lg kg lh kk li ko lj ks lk kw lc ld le lf bi translated">页面 blobs</li></ul><p id="28fb" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">当我们命名容器和 blobs 时，我们必须遵循一些规则。您可以参考这些规则以及官方文档中关于 Blob 存储的更多信息👇。</p><p id="8060" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><a class="ae mt" href="https://docs.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction" rel="noopener ugc nofollow" target="_blank">https://docs . Microsoft . com/en-us/azure/storage/blobs/storage-blobs-简介</a></p><p id="ebc1" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">现在我们对 blob 存储有了一个简单的概念，让我们看看如何一步一步地创建 blob 存储😃。</p><h1 id="edb8" class="ll lm in bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">正在创建 Azure Blob 存储</h1><p id="2451" class="pw-post-body-paragraph jz ka in kb b kc mj ke kf kg mk ki kj kk ml km kn ko mm kq kr ks mn ku kv kw ig bi translated"><strong class="kb io">第一步</strong>:登录 Azure 门户后，可以看到下面的仪表盘。然后点击存储帐户选项。</p><figure class="mp mq mr ms gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mv"><img src="../Images/e1af8bf301bf2a0aed71796b37efff9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2nw73AuYGJFTq0DVYR3gfQ.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">创建 Azure Blob 存储步骤 01</figcaption></figure><p id="765a" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">如果您看不到这样的“存储帐户”，您可以在搜索栏上搜索并选择它。</p><p id="6e7a" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">第 2 步</strong>:在下一个窗口中，点击“创建存储账户”选项。</p><figure class="mp mq mr ms gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/15f0aaa9be830da0ca1a6dcfa4308f5b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VdOo0YVoe8_99PpQ31NxFA.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">创建 Azure Blob 存储步骤 02</figcaption></figure><p id="a9c0" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">第三步:填写表格并创建一个存储账户</p><p id="09e8" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">在此窗口中，我们需要填写订阅、资源组、存储帐户名、区域、性能和冗余。</p><ul class=""><li id="ea9e" class="kx ky in kb b kc kd kg kh kk kz ko la ks lb kw lc ld le lf bi translated">订阅:因为我是大学生，所以我有一个免费的 azure 学生订阅。因此，我在这里选择它，如果您没有订阅，您可以使用免费试用选项。</li><li id="0639" class="kx ky in kb b kc lg kg lh kk li ko lj ks lk kw lc ld le lf bi translated">资源组:在这个字段中，我将创建一个新的资源组，并将其命名为“azuretutorialresource”</li><li id="00f1" class="kx ky in kb b kc lg kg lh kk li ko lj ks lk kw lc ld le lf bi translated">存储帐户名称:在此输入一个唯一的名称，该名称将显示在基址上。</li><li id="4e32" class="kx ky in kb b kc lg kg lh kk li ko lj ks lk kw lc ld le lf bi translated">地区:您可以选择最近的地区或您喜欢的地区。这里我不打算改变它，我选择默认的。</li><li id="6f38" class="kx ky in kb b kc lg kg lh kk li ko lj ks lk kw lc ld le lf bi translated">性能:您可以选择 premium 或 standard subscription，但是如果您使用的是试用版，请选择 standard subscription。</li></ul><p id="e9d1" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">在这里你可以看到我填好的表格。</p><figure class="mp mq mr ms gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mw"><img src="../Images/63bed753e6257bae3d4f9f7577025c17.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pCXo7w-eOQN2qvcn4EesgA.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">创建 Azure Blob 存储步骤 03</figcaption></figure><p id="a924" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">完成表格后，您可以将其余选项设为默认值，或者通过单击“下一步:高级”按钮来更改这些选项。因此，您可以根据自己的喜好更改选项。但在这里，我不会更改其余选项，我将单击“查看+创建”按钮。</p><p id="dc8d" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">第四步:然后它会验证我们的选项。完成验证后，我们可以单击“创建”按钮来创建存储帐户。</p><figure class="mp mq mr ms gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mx"><img src="../Images/aac1239f36338283fa03c2e1f222d712.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fA894DKxLdLW-cuQn8igKg.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">创建 Azure Blob 存储步骤 04</figcaption></figure><p id="1115" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">完成该过程后，您将能够看到这种窗口。</p><figure class="mp mq mr ms gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/a6cdd293663f9997b2decc86d4d047b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DcJnrWehzyAl164bQo8yDQ.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">创建 Azure Blob 存储步骤 04</figcaption></figure><p id="9edb" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">第 5 步:</strong>然后按下“<strong class="kb io">转到资源”</strong>按钮，您将重定向到存储帐户控制面板。然后你可以看到一个左边栏，它有各种选项。从那里，选择位于<strong class="kb io">数据存储</strong>类别下的“<strong class="kb io">容器”</strong>选项</p><figure class="mp mq mr ms gt jo gh gi paragraph-image"><div class="gh gi my"><img src="../Images/2a426686a8d35e069698d0717b094350.png" data-original-src="https://miro.medium.com/v2/resize:fit:662/format:webp/1*n8beST56ix4YUi1DgaM4Fg.png"/></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">创建 Azure Blob 存储步骤 05</figcaption></figure><p id="01c1" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">第六步:</strong>现在点击创建资源按钮，右边会出现一个表单。填写表格，给出容器的<strong class="kb io">名称</strong>和<strong class="kb io">公共访问级别</strong>(您可以根据需要使用任何选项)。在这里，您可以在一个存储帐户下创建任意数量的容器。</p><figure class="mp mq mr ms gt jo gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/3f07e1473e06f8355952327f2b7972ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1066/format:webp/1*6D5m2y09XKlLiyNIIxqiGg.png"/></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">创建 Azure Blob 存储步骤 05</figcaption></figure><p id="2ae6" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">完成表格后，点击创建按钮。</p><p id="8df7" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">酷！😎我们已经设置了 Azure blob 存储，现在我们需要将我们的 NestJS 应用程序与 blob 存储连接起来。让我们这样做😁。</p><h1 id="18c3" class="ll lm in bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">创建 NestJS 应用程序</h1><p id="7507" class="pw-post-body-paragraph jz ka in kb b kc mj ke kf kg mk ki kj kk ml km kn ko mm kq kr ks mn ku kv kw ig bi translated">我希望您已经熟悉了 NestJS 并安装了 NestJS CLI。因此，您可以使用下面的 create 命令直接创建 NestJS 应用程序。如果您尚未安装 CLI，可以在创建应用程序之前安装 CLI。创建应用程序后，我们可以使用 run 命令运行应用程序。</p><h1 id="d511" class="ll lm in bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">安装 CLI 的命令:</h1><pre class="mp mq mr ms gt na nb nc nd aw ne bi"><span id="bde2" class="nf lm in nb b gy ng nh l ni nj"><strong class="nb io">$</strong> <strong class="nb io">npm i -g @nestjs/cli</strong></span></pre><h1 id="7549" class="ll lm in bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">创建 NestJS 应用程序的命令:</h1><pre class="mp mq mr ms gt na nb nc nd aw ne bi"><span id="4dbe" class="nf lm in nb b gy ng nh l ni nj"><strong class="nb io">$ nest new your_project_name</strong></span></pre><h1 id="78aa" class="ll lm in bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">在开发模式下运行应用程序的命令:</h1><pre class="mp mq mr ms gt na nb nc nd aw ne bi"><span id="b9bb" class="nf lm in nb b gy ng nh l ni nj"><strong class="nb io">$ npm run start:dev</strong></span></pre><h1 id="4359" class="ll lm in bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">为 Azure Blob 存储安装 npm 包</h1><pre class="mp mq mr ms gt na nb nc nd aw ne bi"><span id="fe9a" class="nf lm in nb b gy ng nh l ni nj"><strong class="nb io">$ npm install @azure/storage-blob</strong></span></pre><h1 id="3d38" class="ll lm in bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">安装 multer &amp; uuid npm 软件包</h1><p id="01ba" class="pw-post-body-paragraph jz ka in kb b kc mj ke kf kg mk ki kj kk ml km kn ko mm kq kr ks mn ku kv kw ig bi translated">这里，我们将使用 Multer 包来管理文件处理操作，UUID 用于为每个 blob 生成一个唯一的名称。</p><pre class="mp mq mr ms gt na nb nc nd aw ne bi"><span id="7425" class="nf lm in nb b gy ng nh l ni nj"><strong class="nb io">$ npm install --save @types/multer</strong></span><span id="3155" class="nf lm in nb b gy nk nh l ni nj"><strong class="nb io">$ npm install uuidv4</strong></span></pre><h1 id="8dce" class="ll lm in bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">从 Azure 门户复制凭据</h1><p id="ff9e" class="pw-post-body-paragraph jz ka in kb b kc mj ke kf kg mk ki kj kk ml km kn ko mm kq kr ks mn ku kv kw ig bi translated">当我们向 Azure storage 发送请求时，它们应该得到授权。为此，Azure 提供了两个密钥，每个密钥都有一个连接字符串。因此，现在我们需要将凭证作为连接字符串添加到 NestJS 应用程序中。</p><p id="a6ed" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">您可以从左侧菜单中的 Security + networking 类别下的 Access keys 部分复制一个连接字符串。</p><figure class="mp mq mr ms gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nl"><img src="../Images/e679f41aec630d05301fde69e78e14e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OdrtnvjrWJY2DmhpZ8iodw.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">从 Azure 门户复制凭据</figcaption></figure><p id="8238" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">然后选择 Show keys 选项并复制一个连接字符串值。现在我们需要将这个值赋给环境变量。我们可以在应用程序中直接使用这个凭证。但是不推荐。因为这些凭据是我们的存储帐户所独有的，如果这些凭据落入外人之手，他们就可以访问我们的数据😶。</p><p id="4351" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">在应用程序的根目录下创建一个. env 文件，并创建一个变量。然后分配从 Azure 门户复制的连接字符串。</p><figure class="mp mq mr ms gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nm"><img src="../Images/7649e3f23655ab4cdfbf04afa90bad2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZaDQBzhaPmrmZPOqx3EqrA.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">将连接字符串分配给环境变量</figcaption></figure><p id="2e2a" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">为了在我们的应用程序中使用这个变量，我们需要安装所需的依赖项。</p><pre class="mp mq mr ms gt na nb nc nd aw ne bi"><span id="08eb" class="nf lm in nb b gy ng nh l ni nj"><strong class="nb io">$ npm i --save @nestjs/config</strong></span></pre><p id="a882" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">由于这个@nestjs/config 包内部使用了 dotenv，所以我们不需要再次安装 dotenv 包。安装完成后，我们需要将 ConfigModule 导入到根 AppModule.ts 文件中。</p><figure class="mp mq mr ms gt jo gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/6ef549c440927f2537157c03ccd18f84.png" data-original-src="https://miro.medium.com/v2/resize:fit:1202/format:webp/1*dGmJbCnZyKIBPuJabS_Fbg.png"/></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">appmodule.ts 文件</figcaption></figure><h1 id="9bc7" class="ll lm in bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">创建 NestJS 端点</h1><p id="57d9" class="pw-post-body-paragraph jz ka in kb b kc mj ke kf kg mk ki kj kk ml km kn ko mm kq kr ks mn ku kv kw ig bi translated">首先，我将创建一个单独的服务来实现我们的文件操作逻辑，然后我将在需要时调用这个服务。</p><p id="84a1" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">在这里，您可以使用下面的命令创建一个服务，然后将在 src/目录下创建新的服务文件夹。</p><pre class="mp mq mr ms gt na nb nc nd aw ne bi"><span id="5eaa" class="nf lm in nb b gy ng nh l ni nj"><strong class="nb io">$ nest g service service-name</strong></span></pre><p id="b39c" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">在进入实现之前，我们应该了解 azure blob storage 提供的三个类。使用以下三个类，我们可以与 Azure 资源进行交互。</p><ol class=""><li id="f11c" class="kx ky in kb b kc kd kg kh kk kz ko la ks lb kw no ld le lf bi translated">BlobServiceClient——允许我们操作 azure 存储资源和 blob 容器。</li><li id="5376" class="kx ky in kb b kc lg kg lh kk li ko lj ks lk kw no ld le lf bi translated">container client——允许我们操作 azure 存储容器及其 blobs。</li><li id="c6bd" class="kx ky in kb b kc lg kg lh kk li ko lj ks lk kw no ld le lf bi translated">blobs client——允许我们操作 azure 存储 blob。</li></ol><p id="cbd1" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">现在让我们创建端点。</p><h1 id="b164" class="ll lm in bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">创建用于上载的端点</h1><p id="7559" class="pw-post-body-paragraph jz ka in kb b kc mj ke kf kg mk ki kj kk ml km kn ko mm kq kr ks mn ku kv kw ig bi translated">现在，我们将在之前创建的服务文件中实现文件上传逻辑。您可以在我们默认的 app.service 文件中实现这个逻辑。但是当我们的应用程序变得更复杂时，如果我们在一个服务文件中实现所有的东西，就很难操作了。这就是为什么我为这个过程创建了一个单独的服务。</p><p id="8043" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">src/azure-blob/azure-blob . service . ts</strong></p><figure class="mp mq mr ms gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/a7cf3feb85b2cc4a3ec6b3d22408a9a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wXJOkdShBgo_jFl12OHvvA.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">创建用于上载的端点</figcaption></figure><p id="c6e8" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">第 1 行:进口 UUID</p><p id="7173" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">第 3 行:从@azure/storage-blob 导入 BlobServiceClient 和 BlockBlobClient</p><p id="a3ae" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">第 6 行:分配 Azure 连接字符串。env 文件添加到名为 azureConnection 的类属性中。</p><p id="4c94" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">第 7 行:声明一个名为 containerName 的类属性来分配容器名，我们将从 getBlobClient 方法中访问这个变量。</p><p id="d0e4" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">第 9–14 行:这里 getBlobClient 方法从我们指定的“Blob”中返回“BlockBlobClient”(这里 Blob 表示我们要上传的文件)。</p><p id="78d7" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">第 10 行:将 azure 连接字符串配置到 BlobServiceClient 中</p><p id="1fee" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">第 11 行:配置容器。</p><p id="7339" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">第 12–13 行:配置要上传的 blob(文件)名称。这里，我将 UUID 和文件名连接起来。因为如果我们上传一个已经存在于容器中的同名文件，那么它将覆盖先前的记录。那么我们将丢失以前的文件。然后返回“BlockBlobClient”实例。“BlockBlobClient”现在包含所有配置，如连接、容器和文件名。</p><p id="2541" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">第 16–21 行:我们从控制器文件中调用这个方法，这个方法包含将文件上传到 azure blob 存储的逻辑。它有两个参数，第一个是 Multer 类型的文件。文件，第二个参数是容器名。</p><p id="0543" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">第 17 行:将传递的容器名赋给类属性 container name。</p><p id="d055" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">第 18 行:使用我们之前讨论过的 getBlobClient 方法获取“BlockBlobClient”实例。</p><p id="9bc5" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">第 19 行。从 BlockBlobClient 实例使用 uploadData 方法调用文件上载调用。uploadData 将文件缓冲区作为输入。</p><p id="e581" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">在<strong class="kb io"> app.controller.ts </strong>文件中，我将创建一个端点来上传图像。</p><figure class="mp mq mr ms gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/eac6a36d8243f6cc34d1c6db6113a206.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ffmxGDnX-2DRLX9pBymK-w.png"/></div></div></figure><p id="9156" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">第 6 行:将一个容器名分配给名为 container name 的类属性。</p><p id="c398" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">第 8 行:AzureBlobService(我们之前实现的)是通过类构造函数注入的。</p><p id="600f" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">第 11- 16 行:这里，我们创建了一个名为'/upload '的端点，它允许 HTTP Post 请求到这个端点。FIleInterceptor 从表单数据值(' myfile ')中读取所有文件流，@UploadedFile() decorator 抓取所有文件信息并赋给名为 file 的变量，其类型为 Express.Multer.File，最后将文件传递给 upload 方法，该方法位于 AzureBlobService 中。</p><p id="8267" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">呜哇！🤩我们已经实现了上传操作，现在我们需要通过 postman 或任何 API 测试工具来检查它。</p><figure class="mp mq mr ms gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/17b6277e530ebc7c7ccc990d9db1492f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zfQkIIVmPA_Egk0jHWN8iA.png"/></div></div></figure><p id="4ba2" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">然后转到 Azure 容器，检查我们上传的 blob 是否可用。如果您的代码不工作，请查看我的 GitHub 资源库，该资源库在本文末尾有链接。</p><figure class="mp mq mr ms gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/aefc77b203414c4bf348a5b3413ba7f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kiT-a_VJFsX9vibENsq8kw.png"/></div></div></figure><h1 id="ce88" class="ll lm in bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">创建一个读取端点</h1><p id="51dc" class="pw-post-body-paragraph jz ka in kb b kc mj ke kf kg mk ki kj kk ml km kn ko mm kq kr ks mn ku kv kw ig bi translated">在服务文件中，我正在创建另一个方法，通过使用 BlockBlobClient 实例的 download()方法从 Azure 存储中获取相关图像。这个方法也有两个参数，我们分别传递 filename 和 containerName。</p><p id="f333" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">src/azure-blob/azure-blob . service . ts</strong></p><figure class="mp mq mr ms gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi np"><img src="../Images/fe378e90dd94bbd92b8ee708edabea57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LCRuBAPcRd0i5DDrVC3Ihw.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">创建一个读取端点</figcaption></figure><p id="5e69" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">现在，让我们创建一个端点来检索 app.controller.ts 文件中的图像。</p><p id="91e1" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io"> src/app.controller.ts </strong></p><figure class="mp mq mr ms gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/29da149c9a17abb7c4d3bd0a66210e22.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HAoj4lrSKg7VjCmuOwwJNw.png"/></div></div></figure><p id="f592" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">@Header() decorator 用于指定“内容类型”,其值为“image/jpeg”。由于这个头值，图像流将在浏览器上呈现。@Res() decorator 是响应对象。@Query() decorator 用于捕获查询参数。在第 21 行，我们将文件名和容器名传递给 azureBlobService 中的 getfile 方法。从 Azure Blob 存储中获取文件流后，我们将该流刷新到响应对象中。</p><p id="d256" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">然后，您可以使用 postman 或 web 浏览器测试我们的端点。</p><figure class="mp mq mr ms gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/7523397756720181eb4691ddeee04107.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uVvVonBDfLgOpfodXtBG_w.png"/></div></div></figure><h1 id="2c23" class="ll lm in bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">创建要删除的端点</h1><p id="daa8" class="pw-post-body-paragraph jz ka in kb b kc mj ke kf kg mk ki kj kk ml km kn ko mm kq kr ks mn ku kv kw ig bi translated"><strong class="kb io"> src/app.controller.ts </strong></p><p id="acb9" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">这个新端点用于删除文件。当我们调用这个端点时，我们需要将文件名作为参数传递。在第 27 行，我们调用了位于 azure-blob.service.ts 文件中的 deletefile 方法，并传递了文件名和容器名。</p><figure class="mp mq mr ms gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/379cae79a25b11237e5d39dd90a1175b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nkavQuEIQSDu7PfTDp-RJA.png"/></div></div></figure><p id="7d5c" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">src/azure-blob/azure-blob . service . ts</strong></p><p id="94ce" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">deleteIfExists 方法将删除文件(如果 Azure blob 存储中存在)。</p><figure class="mp mq mr ms gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/4931f08f226caf3a1d00d371390bdc65.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UyYjX9CCMLg11usIqYZX0A.png"/></div></div></figure><p id="c861" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">同样，我们可以使用 postman 检查这个端点。</p><figure class="mp mq mr ms gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/65746f32482a467d60cfb040c76d3615.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4RXEETTFlnroc7JyHHpaqw.png"/></div></div></figure><h1 id="8e53" class="ll lm in bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">创建下载文件的端点</h1><p id="7faf" class="pw-post-body-paragraph jz ka in kb b kc mj ke kf kg mk ki kj kk ml km kn ko mm kq kr ks mn ku kv kw ig bi translated">如果您需要下载图像，您只需要创建另一个端点。为此，我们可以使用与读取 azure-blob.service.ts 中的文件相同的方法，因此，服务文件中没有什么需要更改的。</p><p id="8efd" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io"> src/app.controller.ts </strong></p><p id="336d" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">这个 downloadImage 方法类似于 readImage 方法，我们以前用来读取文件。唯一的区别是我们在这里使用了 Content-Disposition 头。Content-Disposition header 是一个标题，指示内容是否希望在浏览器中以内联方式显示，作为网页或网页的一部分，或者作为下载并本地保存的附件。</p><figure class="mp mq mr ms gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/b1bda47943a4b61a935a39f51a9bd858.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iVhaITKwVqO81E-6fPsk6w.png"/></div></div></figure><figure class="mp mq mr ms gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nq"><img src="../Images/2af6076d041269747d93480e6a84ded2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PieGqQio2iOh_DxRlVkIdw.jpeg"/></div></div></figure><p id="44f0" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">最后，我们使用 NestJS 完成了 Azure Blob 存储中的文件操作🤩。</p><h1 id="1b93" class="ll lm in bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">我们今天做了什么？⏳</h1><p id="28d7" class="pw-post-body-paragraph jz ka in kb b kc mj ke kf kg mk ki kj kk ml km kn ko mm kq kr ks mn ku kv kw ig bi translated">在这里，我们已经了解了 Azure Blob 存储，并且使用 NestJS 应用程序进行了创建、读取、删除和下载操作。我希望你能从这篇文章中学到一些重要和有趣的东西，我也很乐意听到你对这篇文章的反馈和建议。所以，别忘了在下面的评论区留下你的评论。</p><h1 id="c297" class="ll lm in bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">源代码:</h1><p id="4348" class="pw-post-body-paragraph jz ka in kb b kc mj ke kf kg mk ki kj kk ml km kn ko mm kq kr ks mn ku kv kw ig bi translated"><a class="ae mt" href="https://github.com/Wanuja97/azure-blob-storage-integration-nestjs" rel="noopener ugc nofollow" target="_blank">https://github . com/wan uja 97/azure-blob-storage-integration-nestjs</a></p><p id="450c" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">我会赶上你的，很快会有另一篇有趣的文章👋。</p><h1 id="cbb7" class="ll lm in bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">感谢阅读！❤️</h1><figure class="mp mq mr ms gt jo gh gi paragraph-image"><a href="https://www.buymeacoffee.com/wanuja18"><div class="gh gi nr"><img src="../Images/9acaec23525c99684c2aff97441d3091.png" data-original-src="https://miro.medium.com/v2/resize:fit:872/format:webp/1*Ao6zimYNe8zmoRex3w71VA.png"/></div></a><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">给我买杯咖啡</figcaption></figure></div></div>    
</body>
</html>