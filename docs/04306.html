<html>
<head>
<title>Server-Side Development with Fastify — Reply Serializer, Route Prefix, and Not Found Handler</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Fastify 的服务器端开发—回复序列化程序、路由前缀和未找到处理程序</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/server-side-development-with-fastify-reply-serializer-route-prefix-and-not-found-handler-b1910fe2a831?source=collection_archive---------3-----------------------#2021-02-24">https://blog.devgenius.io/server-side-development-with-fastify-reply-serializer-route-prefix-and-not-found-handler-b1910fe2a831?source=collection_archive---------3-----------------------#2021-02-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/eedac9df83dd387acfe705751729d156.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*dir9MtmiYLLGM11b"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">由<a class="ae kc" href="https://unsplash.com/@nexgenfx?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">卢卡·坎皮奥尼</a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="84b6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Fastify 是一个用于开发后端 web 应用程序的小型节点框架。</p><p id="af85" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将了解如何使用 Fastify 创建后端应用程序。</p><h1 id="5ce4" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">关闭服务器</h1><p id="d020" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以调用<code class="fe me mf mg mh b">fastify.close</code>来关闭服务器。</p><p id="9cd2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="1705" class="mq lc iq mh b gy mr ms l mt mu">const fastify = require('fastify')()</span><span id="9eb1" class="mq lc iq mh b gy mv ms l mt mu">fastify.get('/', (request, reply) =&gt; {  <br/>  reply.send('hello world')<br/>})</span><span id="7cb3" class="mq lc iq mh b gy mv ms l mt mu">fastify.ready(err =&gt; {<br/>  if (err) throw err<br/>})</span><span id="cab5" class="mq lc iq mh b gy mv ms l mt mu">const start = async () =&gt; {<br/>  try {<br/>    await fastify.listen(3000, '0.0.0.0')  <br/>  } catch (err) {<br/>    fastify.log.error(err)<br/>    await fastify.close()<br/>    process.exit(1)<br/>  }<br/>}<br/>start()</span></pre><p id="0ec4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">无争论地调用<code class="fe me mf mg mh b">fastify.close</code>，它将返回一个承诺。</p><h1 id="8168" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">路由前缀</h1><p id="99a1" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以通过<code class="fe me mf mg mh b">prefix</code>选项为我们的旅程添加一个路线前缀。</p><p id="d906" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="8e92" class="mq lc iq mh b gy mr ms l mt mu">const fastify = require('fastify')()</span><span id="2564" class="mq lc iq mh b gy mv ms l mt mu">fastify.register(function (instance, opts, done) {<br/>  instance.get('/foo', function (request, reply) {<br/>    request.log.info('prefix: %s', instance.prefix)<br/>    reply.send({ prefix: instance.prefix })<br/>  })</span><span id="aab4" class="mq lc iq mh b gy mv ms l mt mu">  instance.register(function (instance, opts, done) {<br/>    instance.get('/bar', function (request, reply) {<br/>      request.log.info('prefix: %s', instance.prefix)<br/>      reply.send({ prefix: instance.prefix })<br/>    })</span><span id="8820" class="mq lc iq mh b gy mv ms l mt mu">    done()<br/>  }, { prefix: '/v2' })</span><span id="433b" class="mq lc iq mh b gy mv ms l mt mu">  done()<br/>}, { prefix: '/v1' })</span><span id="4535" class="mq lc iq mh b gy mv ms l mt mu">const start = async () =&gt; {<br/>  try {<br/>    await fastify.listen(3000, '0.0.0.0')  <br/>  } catch (err) {<br/>    fastify.log.error(err)<br/>    process.exit(1)<br/>  }<br/>}<br/>start()</span></pre><p id="f464" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后当我们去<code class="fe me mf mg mh b">/v1/v2/bar</code>时，我们看到:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="708a" class="mq lc iq mh b gy mr ms l mt mu">{<br/>  "prefix": "/v1/v2"<br/>}</span></pre><p id="75e3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">已退回。如果我们去<code class="fe me mf mg mh b">/v1/foo</code>，我们会看到:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="2a2e" class="mq lc iq mh b gy mr ms l mt mu">{<br/>  "prefix": "/v1"<br/>}</span></pre><h1 id="64e9" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">设置回复序列化程序</h1><p id="9059" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以调用<code class="fe me mf mg mh b">setReplySerializer</code>方法为所有路由设置回复序列化程序。</p><p id="31cc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="c2d6" class="mq lc iq mh b gy mr ms l mt mu">const fastify = require('fastify')()</span><span id="912a" class="mq lc iq mh b gy mv ms l mt mu">fastify.setReplySerializer(function (payload, statusCode){<br/>  return `status: ${statusCode}, content: ${payload}`<br/>})</span><span id="361a" class="mq lc iq mh b gy mv ms l mt mu">fastify.get('/', async (request, reply) =&gt; {  <br/>  return 'hello world'<br/>})</span><span id="b9b7" class="mq lc iq mh b gy mv ms l mt mu">const start = async () =&gt; {<br/>  try {<br/>    await fastify.listen(3000, '0.0.0.0')  <br/>  } catch (err) {<br/>    fastify.log.error(err)<br/>    await fastify.close()<br/>    process.exit(1)<br/>  }<br/>}<br/>start()</span></pre><p id="b5bd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">将序列化程序添加到我们的应用程序中。</p><h1 id="d0fe" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">设置未找到处理程序</h1><p id="91ab" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以为处理器 404 错误设置一个处理器。</p><p id="52f9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="3e95" class="mq lc iq mh b gy mr ms l mt mu">const fastify = require('fastify')()</span><span id="aaae" class="mq lc iq mh b gy mv ms l mt mu">fastify.setNotFoundHandler({<br/>  preValidation: (req, reply, done) =&gt; {    <br/>    done()<br/>  },<br/>  preHandler: (req, reply, done) =&gt; {    <br/>    done()<br/>  }<br/>}, function (request, reply) {<br/>    reply.send('not found')<br/>})</span><span id="b9e1" class="mq lc iq mh b gy mv ms l mt mu">fastify.get('/', async (request, reply) =&gt; {  <br/>  return 'hello world'<br/>})</span><span id="dde5" class="mq lc iq mh b gy mv ms l mt mu">const start = async () =&gt; {<br/>  try {<br/>    await fastify.listen(3000, '0.0.0.0')  <br/>  } catch (err) {<br/>    fastify.log.error(err)<br/>    await fastify.close()<br/>    process.exit(1)<br/>  }<br/>}<br/>start()</span></pre><p id="e4ee" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在服务器实例上调用<code class="fe me mf mg mh b">setNotFoundHandler</code>。</p><p id="2aba" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们还可以在一组 URL 上设置 not found 处理程序。</p><p id="66ea" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="8ea0" class="mq lc iq mh b gy mr ms l mt mu">const fastify = require('fastify')()</span><span id="b8ef" class="mq lc iq mh b gy mv ms l mt mu">fastify.register(function (instance, options, done) {<br/>  instance.setNotFoundHandler(function (request, reply) {<br/>    return reply.send('not found')<br/>  })<br/>  done()<br/>}, { prefix: '/v1' })</span><span id="178e" class="mq lc iq mh b gy mv ms l mt mu">fastify.get('/', async (request, reply) =&gt; {  <br/>  return 'hello world'<br/>})</span><span id="7227" class="mq lc iq mh b gy mv ms l mt mu">const start = async () =&gt; {<br/>  try {<br/>    await fastify.listen(3000, '0.0.0.0')  <br/>  } catch (err) {<br/>    fastify.log.error(err)<br/>    await fastify.close()<br/>    process.exit(1)<br/>  }<br/>}<br/>start()</span></pre><p id="1cbf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为以<code class="fe me mf mg mh b">/v1</code>开头的路线添加一个未找到的处理程序。</p><h1 id="5739" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="2502" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以关闭服务器，设置路由前缀，设置 not found 处理程序，并使用 Fastify 设置回复序列化程序。</p></div></div>    
</body>
</html>