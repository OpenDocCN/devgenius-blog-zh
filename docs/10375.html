<html>
<head>
<title>Background Job Processing in Elixir with Oban</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带 Oban 的 Elixir 中的后台作业处理</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/background-job-processing-in-elixir-with-oban-fafb89a9ec21?source=collection_archive---------2-----------------------#2022-10-28">https://blog.devgenius.io/background-job-processing-in-elixir-with-oban-fafb89a9ec21?source=collection_archive---------2-----------------------#2022-10-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="074e" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">在本文中，我们将探讨如何使用 Oban，这是一个用于 Elixir 的健壮的后台作业处理系统。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/6c3357b6d25bda658209beee342255a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*uxsFdxZbVuoqM00Y"/></div></div></figure><p id="9eb8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">作为<a class="ae ln" href="https://www.erlang.org" rel="noopener ugc nofollow" target="_blank"> Erlang OTP </a>的一部分，<a class="ae ln" href="http://elixir-lang.org" rel="noopener ugc nofollow" target="_blank"> Elixir 语言</a>拥有<em class="lo">惊人的</em>对并发和执行异步任务的内置支持。这是真的:你通常可以将任务放在你的 Elixir 应用程序的后台，而不必过于担心并发性、性能、锁定等。</p><p id="9fbc" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这对于某些类型的任务很有效，但是对于其他任务，简单地将一个作业放到后台会有一些缺点:当一个作业失败时会发生什么？如果服务器崩溃会发生什么？如何监控和管理负载和并发性？</p><p id="feb4" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果这些场景对您的应用程序很重要，您将需要某种管理后台作业的系统。在本帖中，我们将探索<a class="ae ln" href="https://getoban.pro" rel="noopener ugc nofollow" target="_blank"> Oban 后台作业处理系统</a>。特别是，我们将涵盖:</p><ul class=""><li id="6f66" class="lp lq iq kt b ku kv kx ky la lr le ls li lt lm lu lv lw lx bi translated">什么是 Oban，为什么您可能需要它</li><li id="bf56" class="lp lq iq kt b ku ly kx lz la ma le mb li mc lm lu lv lw lx bi translated">如何在 Elixir 应用程序中设置和安装 Oban</li><li id="e7e0" class="lp lq iq kt b ku ly kx lz la ma le mb li mc lm lu lv lw lx bi translated">如何定义和排队后台作业</li><li id="e11a" class="lp lq iq kt b ku ly kx lz la ma le mb li mc lm lu lv lw lx bi translated">如何运行作业和管理队列</li></ul><p id="1c6b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们开始吧！</p><h1 id="ba31" class="md me iq bd mf mg mh mi mj mk ml mm mn jw mo jx mp jz mq ka mr kc ms kd mt mu bi translated">Oban 是什么？</h1><p id="4b91" class="pw-post-body-paragraph kr ks iq kt b ku mv jr kw kx mw ju kz la mx lc ld le my lg lh li mz lk ll lm ij bi translated">Oban 是一个用于 Elixir 语言的高性能后台作业处理系统。它让我们定义作业，将它们放入队列，并在我们的应用程序做其他工作时在后台处理它们。作业是持久的，所以如果服务器或进程崩溃，它不会丢失。Oban 将处理这些场景中的重试和失败逻辑。此外，它还允许我们监控和管理作业队列，这样我们就可以密切关注有多少作业正在被处理，作业是否失败等等。</p><p id="9e4f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">Oban 使用标准的<a class="ae ln" href="https://www.postgresql.org" rel="noopener ugc nofollow" target="_blank"> Postgres 数据库</a>来保存和管理作业。这与其他一些可能使用其他基础设施工具的作业处理系统形成对比，例如<a class="ae ln" href="https://redis.io" rel="noopener ugc nofollow" target="_blank"> Redis </a>或<a class="ae ln" href="https://www.rabbitmq.com/" rel="noopener ugc nofollow" target="_blank"> RabbitMQ </a>。在不深入这些不同工具之间的本质性能比较的情况下，可以肯定地说，向技术堆栈添加额外的服务会增加大量的复杂性，因此使用 Postgres 是一个很好的特性。</p><p id="df91" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果您已经将 Postgres 与<a class="ae ln" href="https://hexdocs.pm/ecto/Ecto.html" rel="noopener ugc nofollow" target="_blank"> Ecto </a>(这是 Phoenix 中的默认设置)一起使用，那么您可以使用现有的应用程序数据库，不过如果您愿意，也可以配置一个备用数据库。除非您的操作规模非常大，否则使用默认应用程序数据库通常是一个不错的起点。</p><p id="e1cd" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">虽然 Oban 可以与任何类型的 Elixir 应用程序一起工作，但它是用 Phoenix 框架构建的 web 应用程序的自然选择。Web 应用程序都是关于实时交互和快速响应的，所以在后台处理某些任务通常是有意义的。例如，如果一个应用程序在注册时向一个新用户发送了一封欢迎邮件，那么在 web 请求过程中等待邮件发送完成是没有意义的。更好的方法是立即呈现页面，并将电子邮件投递到后台队列中。</p><p id="20cf" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">虽然 Oban 是开源的，可以免费使用，但他们确实提供了可选的 Pro 功能，包括用于监控和管理作业队列的<a class="ae ln" href="https://getoban.pro/oban" rel="noopener ugc nofollow" target="_blank">极其流畅的 web 界面</a>以及其他功能。</p><h1 id="c28d" class="md me iq bd mf mg mh mi mj mk ml mm mn jw mo jx mp jz mq ka mr kc ms kd mt mu bi translated">使用 Oban 运行后台作业</h1><p id="c9a7" class="pw-post-body-paragraph kr ks iq kt b ku mv jr kw kx mw ju kz la mx lc ld le my lg lh li mz lk ll lm ij bi translated">现在我们有了关于 Oban 的<em class="lo">背景</em>(这是一个可怕的双关语)，让我们看看如何在我们的 Elixir 应用程序中安装和使用 Oban。</p><h2 id="00c4" class="na me iq bd mf nb nc dn mj nd ne dp mn la nf ng mp le nh ni mr li nj nk mt nl bi translated">安装 Oban</h2><p id="3ccf" class="pw-post-body-paragraph kr ks iq kt b ku mv jr kw kx mw ju kz la mx lc ld le my lg lh li mz lk ll lm ij bi translated">这一节的大部分内容是对 Oban 文档中所描述内容的回顾，但包含在这里是为了帮助您开始。请参阅完整的文档以了解更多有关其他配置选项的信息。</p><p id="7732" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">首先，您需要在您的应用程序中安装 Oban，方法是在您的<code class="fe nm nn no np b">mix.exs</code>文件中添加<code class="fe nm nn no np b">oban</code>并运行<code class="fe nm nn no np b">mix deps.get</code>:</p><pre class="kg kh ki kj gt nq np nr ns aw nt bi"><span id="ae0d" class="na me iq np b gy nu nv l nw nx"># mix.exs <br/>def deps do <br/>  [ {:oban, "~&gt; 2.13"} ] <br/>end</span></pre><p id="7ce2" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">Oban 将使用我们现有的 Ecto repo(通常是 Postgres)来持久化作业。我们需要创建一个迁移来创建和配置所需的表:</p><pre class="kg kh ki kj gt nq np nr ns aw nt bi"><span id="f671" class="na me iq np b gy nu nv l nw nx">mix ecto.gen.migration add_oban_jobs_table</span></pre><p id="ae04" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">然后，在生成的迁移中:</p><pre class="kg kh ki kj gt nq np nr ns aw nt bi"><span id="880f" class="na me iq np b gy nu nv l nw nx">defmodule MyApp.Repo.Migrations.AddObanJobsTable do<br/>  use Ecto.Migration </span><span id="a2b4" class="na me iq np b gy ny nv l nw nx">  def up do <br/>    Oban.Migrations.up(version: 11) <br/>  end </span><span id="e815" class="na me iq np b gy ny nv l nw nx">  def down do <br/>    Oban.Migrations.down(version: 1) <br/>  end <br/>end</span></pre><p id="2927" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">最后，我们将在我们的<code class="fe nm nn no np b">config/config.exs</code>中配置 Oban:</p><pre class="kg kh ki kj gt nq np nr ns aw nt bi"><span id="fb57" class="na me iq np b gy nu nv l nw nx">config :my_app, Oban, <br/>  repo: MyApp.Repo, <br/>  plugins: [Oban.Plugins.Pruner], <br/>  queues: [default: 10]</span></pre><p id="d7a0" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">为了让我们的后台作业在运行测试时立即执行，我们还将在<code class="fe nm nn no np b">config/test.exs</code>中添加配置:</p><pre class="kg kh ki kj gt nq np nr ns aw nt bi"><span id="f449" class="na me iq np b gy nu nv l nw nx"># config/test.exs <br/>config :my_app, Oban, testing: :inline</span></pre><p id="2a7e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">配置选项的完整列表可在<a class="ae ln" href="https://hexdocs.pm/oban/Oban.Config.html" rel="noopener ugc nofollow" target="_blank"> Oban 中找到。配置文件</a>。</p><h1 id="6e52" class="md me iq bd mf mg mh mi mj mk ml mm mn jw mo jx mp jz mq ka mr kc ms kd mt mu bi translated">定义工作</h1><p id="91ab" class="pw-post-body-paragraph kr ks iq kt b ku mv jr kw kx mw ju kz la mx lc ld le my lg lh li mz lk ll lm ij bi translated">用 Oban 定义我们的背景工作很简单。我们简单地创建一个使用<code class="fe nm nn no np b">Oban.Worker</code>的模块，指定一些选项，并定义一个<code class="fe nm nn no np b">perform</code>函数来执行:</p><pre class="kg kh ki kj gt nq np nr ns aw nt bi"><span id="5a47" class="na me iq np b gy nu nv l nw nx">defmodule MyApp.MyImportantJob do <br/>  use Oban.Worker, queue: :events </span><span id="a5c3" class="na me iq np b gy ny nv l nw nx">  @impl Oban.Worker <br/>  def perform(%Oban.Job{args: args}) do <br/>    IO.inspect(args) :ok <br/>  end <br/>end</span></pre><p id="0e15" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在上面的示例中，我们只指定了作业应该放在哪个队列中，但是也可以指定其他选项:</p><pre class="kg kh ki kj gt nq np nr ns aw nt bi"><span id="c417" class="na me iq np b gy nu nv l nw nx">use Oban.Worker, <br/>  queue: :events, <br/>  priority: 3, <br/>  max_attempts: 3, <br/>  tags: ["user"], <br/>  unique: [period: 30]</span></pre><p id="c72b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">参见<a class="ae ln" href="https://hexdocs.pm/oban/Oban.Worker.html" rel="noopener ugc nofollow" target="_blank">工人文档</a>了解可用选项的全部细节。</p><h1 id="4cec" class="md me iq bd mf mg mh mi mj mk ml mm mn jw mo jx mp jz mq ka mr kc ms kd mt mu bi translated">入队和执行</h1><p id="c3bb" class="pw-post-body-paragraph kr ks iq kt b ku mv jr kw kx mw ju kz la mx lc ld le my lg lh li mz lk ll lm ij bi translated">创建一个作业就像创建一个具有所需参数的作业，并调用<code class="fe nm nn no np b">Oban.Insert()</code>将其入队一样简单。</p><pre class="kg kh ki kj gt nq np nr ns aw nt bi"><span id="2634" class="na me iq np b gy nu nv l nw nx">MyApp.MyImportantJob.new(%{id: 1, params: []}) <br/>  |&gt; Oban.insert()</span></pre><p id="dcd7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在我们的作业已经入队——但是它还不会执行，因为我们还没有开始我们的队列。如果您很好奇，此时您可以暂停并检查 Postgres 数据库，以查看排队的作业。在我们的<code class="fe nm nn no np b">oban_jobs</code>表中，您应该可以找到我们刚刚在<code class="fe nm nn no np b">available</code>状态下排队的作业:</p><pre class="kg kh ki kj gt nq np nr ns aw nt bi"><span id="c787" class="na me iq np b gy nu nv l nw nx">1 | available | events | MyApp.MyImportantJob | {"x": 10} | ...</span></pre><p id="2bf5" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">当我们准备好运行我们的作业时，我们所要做的就是启动队列！我们通过调用带有队列名和并发限制的<code class="fe nm nn no np b">Oban.start_queue</code>来实现这一点:</p><pre class="kg kh ki kj gt nq np nr ns aw nt bi"><span id="b09b" class="na me iq np b gy nu nv l nw nx">Oban.start_queue(queue: :events, limit: 4)</span></pre><p id="887e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">注意，如果我们定义了多个队列，我们可以用不同的选项独立地启动和停止它们。</p><p id="297c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在这个简单的例子中，我们的作业只是检查所提供的<em class="lo">参数</em>的内容，所以当我们启动队列时，我们应该会看到输出到控制台的日志消息。在“真正的”工作中，我们可能会执行一些操作并将结果存储回数据库中。</p><h1 id="5fbf" class="md me iq bd mf mg mh mi mj mk ml mm mn jw mo jx mp jz mq ka mr kc ms kd mt mu bi translated">后续步骤</h1><p id="7c87" class="pw-post-body-paragraph kr ks iq kt b ku mv jr kw kx mw ju kz la mx lc ld le my lg lh li mz lk ll lm ij bi translated">既然我们已经介绍了 Oban 的基础知识，我们就有足够的知识开始在我们的 Elixir 应用程序中使用它来运行简单的后台作业——但是还有很多我们没有介绍的 Oban 可以做的事情，例如:</p><ul class=""><li id="b6d8" class="lp lq iq kt b ku kv kx ky la lr le ls li lt lm lu lv lw lx bi translated"><a class="ae ln" href="https://hexdocs.pm/oban/Oban.Plugins.Cron.html" rel="noopener ugc nofollow" target="_blank">预定任务</a>(类似于 cron)</li><li id="8d96" class="lp lq iq kt b ku ly kx lz la ma le mb li mc lm lu lv lw lx bi translated"><a class="ae ln" href="https://hexdocs.pm/oban/Oban.html#module-unique-jobs" rel="noopener ugc nofollow" target="_blank">重复数据删除</a></li><li id="d813" class="lp lq iq kt b ku ly kx lz la ma le mb li mc lm lu lv lw lx bi translated"><a class="ae ln" href="https://hexdocs.pm/oban/Oban.Peer.html" rel="noopener ugc nofollow" target="_blank">多任务处理器集群支持</a></li></ul><p id="8657" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">无论您正在构建哪种 Elixir 应用程序，使用 Oban 来管理后台作业都是对工具箱的一个很好的补充。</p><p id="b484" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果你想了解更多关于用 Elixir 和 Phoenix 构建应用程序的知识，请查看这些相关的帖子！</p><div class="nz oa gp gr ob oc"><a rel="noopener  ugc nofollow" target="_blank" href="/why-your-next-frontend-might-be-the-backend-b43ff1ca9720"><div class="od ab fo"><div class="oe ab of cl cj og"><h2 class="bd ir gy z fp oh fr fs oi fu fw ip bi translated">为什么你的下一个 Web 应用前端可能是后端</h2><div class="oj l"><h3 class="bd b gy z fp oh fr fs oi fu fw dk translated">LiveView 和其他实时服务器端渲染 HTML 技术如何改变前端的编写方式</h3></div><div class="ok l"><p class="bd b dl z fp oh fr fs oi fu fw dk translated">blog.devgenius.io</p></div></div><div class="ol l"><div class="om l on oo op ol oq kp oc"/></div></div></a></div><div class="nz oa gp gr ob oc"><a rel="noopener  ugc nofollow" target="_blank" href="/5-elixir-libraries-i-install-on-every-new-project-a76fae7241a1"><div class="od ab fo"><div class="oe ab of cl cj og"><h2 class="bd ir gy z fp oh fr fs oi fu fw ip bi translated">我在每个新项目上安装了 5 个 Elixir 库</h2><div class="oj l"><h3 class="bd b gy z fp oh fr fs oi fu fw dk translated">我的用 Elixir/Phoenix 构建的必不可少的工具和库列表</h3></div><div class="ok l"><p class="bd b dl z fp oh fr fs oi fu fw dk translated">blog.devgenius.io</p></div></div><div class="ol l"><div class="or l on oo op ol oq kp oc"/></div></div></a></div></div><div class="ab cl os ot hu ou" role="separator"><span class="ov bw bk ow ox oy"/><span class="ov bw bk ow ox oy"/><span class="ov bw bk ow ox"/></div><div class="ij ik il im in"><p id="bd94" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><em class="lo">原载于 2022 年 10 月 28 日 https://blixtdev.com</em><a class="ae ln" href="https://blixtdev.com/background-job-processing-in-elixir-with-oban/" rel="noopener ugc nofollow" target="_blank"><em class="lo"/></a><em class="lo">。</em></p><p id="7572" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">Jonathan 在大型和小型创业公司中拥有超过 20 年的工程领导经验。</p></div></div>    
</body>
</html>