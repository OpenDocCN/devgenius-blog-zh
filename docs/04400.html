<html>
<head>
<title>How to Deploy Keras Models to Production (Beginners Welcome!)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何将 Keras 模型部署到生产中(初学者欢迎！)</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/how-to-deploy-keras-models-to-production-beginners-welcome-1fbfab19d3f6?source=collection_archive---------1-----------------------#2021-03-12">https://blog.devgenius.io/how-to-deploy-keras-models-to-production-beginners-welcome-1fbfab19d3f6?source=collection_archive---------1-----------------------#2021-03-12</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/7136bb0c42fda2231a0ffbb1a99eaed7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*poXRRZdZAElrrP9C3ZQLoQ.jpeg"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">泰勒·维克在 Unsplash 上的照片</figcaption></figure><h1 id="eec9" class="ka kb in bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">部署神经网络的经验教训</h1><p id="d1e4" class="pw-post-body-paragraph ky kz in la b lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv ig bi translated">首先，我想说我有一份非常令人兴奋的工作——但这篇博客不会讲述令人兴奋的部分。</p><p id="eab1" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">我想和你谈谈你在部署在<a class="ae jz" href="https://www.tensorflow.org/api_docs/python/tf/keras/" rel="noopener ugc nofollow" target="_blank"> Keras </a>中实现的模型时可能面临的问题，Keras 是流行的深度学习开源框架。这是许多工程师(像我一样)一直在努力解决的问题，如果你是一个人，你可能会花上几个小时试图解决这个问题。不过我的目标是确保你不需要这么做，而且你会从这个博客中获得<strong class="la io"> 3 个学习成果:</strong></p><ol class=""><li id="094d" class="mb mc in la b lb lw lf lx lj md ln me lr mf lv mg mh mi mj bi translated">使用<a class="ae jz" href="https://flask-restplus.readthedocs.io/en/stable/\" rel="noopener ugc nofollow" target="_blank"> Flask-RESTPlus </a>框架，以 warp speed 为你的深度学习模型实现 RESTful API<em class="mk"/></li><li id="8dcc" class="mb mc in la b lb ml lf mm lj mn ln mo lr mp lv mg mh mi mj bi translated">使用用于 Python 的 AWS SDK 向 API 提供云存储的数据</li><li id="fcf4" class="mb mc in la b lb ml lf mm lj mn ln mo lr mp lv mg mh mi mj bi translated">解析来自 API 的 JSON 响应，以便可以在应用程序中使用它！</li></ol><p id="83ea" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">好消息是，如果我做好了我的工作，到最后你会发现它实际上非常平易近人。</p><h2 id="fb8b" class="mq kb in bd kc mr ms dn kg mt mu dp kk lj mv mw ko ln mx my ks lr mz na kw nb bi translated">第一课:将机器学习和 HTTP 路由分开</h2><p id="9ef8" class="pw-post-body-paragraph ky kz in la b lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv ig bi translated">当你读到这里的时候，<strong class="la io">我假设</strong>一些关于你深度学习项目的事情:</p><ol class=""><li id="7e57" class="mb mc in la b lb lw lf lx lj md ln me lr mf lv mg mh mi mj bi translated"><strong class="la io">您已经有了一个训练好的模型，</strong>并保存了它。<em class="mk">注意:本博客中的例子将使用 Hadoop (.h5)和 JSON(。json)文件，所以如果您使用不同的格式，请记住这一点。</em></li><li id="8761" class="mb mc in la b lb ml lf mm lj mn ln mo lr mp lv mg mh mi mj bi translated"><strong class="la io">您正在将模型部署到 web 服务器上。</strong>不幸的是，我不能保证这些概念会延续到移动或物联网设备(见<a class="ae jz" href="https://www.tensorflow.org/lite/" rel="noopener ugc nofollow" target="_blank"> TFLite </a>)或浏览器(见<a class="ae jz" href="https://www.tensorflow.org/js" rel="noopener ugc nofollow" target="_blank"> Tensorflow.js </a>)。</li></ol><p id="34c2" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">如果这两种说法都适用于你，那么我可以用 4 秒钟来总结这一课:</p><p id="25ba" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated"><strong class="la io"> <em class="mk">让别人去担心模型</em> </strong></p><p id="6999" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">乍一看，这似乎令人困惑，但是这一课实际上只是关于基础知识——有一个专用的 API 端点来运行推理，我保证部署过程会变得简单得多。</p><p id="ae57" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated"><strong class="la io">示例:用 Flask-RESTPlus 构建 RESTful API</strong></p><p id="3d42" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">如您所知，在 Keras 中加载保存的模型以在 web 服务器上使用的最简单方法是在本地计算机上提供相对文件路径<a class="ae jz" href="https://keras.io/guides/serialization_and_saving/" rel="noopener ugc nofollow" target="_blank"> [1] </a>。</p><p id="d65a" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">例如，让我们来看看 Plant Vision，这是我用 Flask-RESTPlus 构建的 RESTful API。存储库的代码是链接的<a class="ae jz" href="https://github.com/UPstartDeveloper/plantnet-api" rel="noopener ugc nofollow" target="_blank">(这里为</a>)，它已经有了一个保存的模型(用于图像分类)，所以你可以随意使用它。</p><p id="1ed4" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">就上下文而言，该 API 允许用户上传植物叶子的图像，并且模型(回旋神经网络)将它们识别为健康或不健康。</p><ol class=""><li id="5cba" class="mb mc in la b lb lw lf lx lj md ln me lr mf lv mg mh mi mj bi translated">我们首先导入我们需要的软件包，以便在 Flask 中对 web 服务器进行编程，使用 Flask-RESTPlus 构建 RESTful API，并使用带有 Tensorflow 后端的 Keras 处理我们的图像数据:</li></ol><pre class="nc nd ne nf gt ng nh ni nj aw nk bi"><span id="c6d2" class="mq kb in nh b gy nl nm l nn no"># Prevent ImportErrors w/ flask<br/>import werkzeug<br/>werkzeug.cached_property = werkzeug.utils.cached_property<br/>from werkzeug.datastructures import FileStorage<br/># ML/Data processing<br/>import tensorflow.keras as keras<br/># RESTful API packages<br/>from flask_restplus import Api, Resource<br/>from flask import Flask<br/># Local utility Functions<br/>from util import leaf</span></pre><p id="db24" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">2.我们当然需要为烧瓶初始化一个应用程序变量:</p><pre class="nc nd ne nf gt ng nh ni nj aw nk bi"><span id="41ac" class="mq kb in nh b gy nl nm l nn no">app = Flask(__name__)</span></pre><p id="b8df" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">3.下一步是构建 API，这就是 Flask-RESTPlus 的有用之处。在下一个片段中，我们将实例化一个 API 对象，并给它一个<code class="fe np nq nr nh b">namespace</code>——您将会看到我下面的意思:</p><pre class="nc nd ne nf gt ng nh ni nj aw nk bi"><span id="afc0" class="mq kb in nh b gy nl nm l nn no">api = Api(app, version="1.0", title="PlantNet API",<br/>description="Identifying Leaf Disease via Deep Learning")</span><span id="3e1b" class="mq kb in nh b gy ns nm l nn no">ns = api.namespace("Diagnosis", description="Represents the health states of a leaf understood by the AI."<br/>)</span></pre><p id="396e" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">您现在可以使用以下命令运行开发中的 Flask 服务器(这是上面链接的 repo 所特有的):</p><pre class="nc nd ne nf gt ng nh ni nj aw nk bi"><span id="8a0e" class="mq kb in nh b gy nl nm l nn no">export FLASK_ENV=development; export FLASK_APP=application; flask run</span></pre><p id="0c25" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">看看我们已经有东西给用户看了！</p><figure class="nc nd ne nf gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nt"><img src="../Images/1defb4cb660d916390dbac3495bcdb10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lTHFgcR9KqopBj-S5Awn4A.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">烧瓶自动生成的用户界面-RESTPlus API</figcaption></figure><p id="0c3d" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">回头看看前面的代码片段——注意到我们提供的关键字参数和上面截图中出现的文本之间的相似之处了吗？</p><p id="c993" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">通常在烧瓶中，我们需要制作单独的 HTML 模板来向用户显示用户界面。</p><p id="8844" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">但是因为你是一个聪明人，你现在知道了通过使用 Flask-RESTPlus，我们可以<em class="mk">仅仅基于我们提供给<code class="fe np nq nr nh b">Api</code>和<code class="fe np nq nr nh b">api.namespace</code>构造函数的<em class="mk">关键字参数</em>自动生成 UI </em>！</p><ul class=""><li id="3c5f" class="mb mc in la b lb lw lf lx lj md ln me lr mf lv nu mh mi mj bi translated">您提供的<code class="fe np nq nr nh b">version</code><code class="fe np nq nr nh b">Api</code>变成了那个小数字<code class="fe np nq nr nh b">1</code>；</li><li id="5e91" class="mb mc in la b lb ml lf mm lj mn ln mo lr mp lv nu mh mi mj bi translated">您提供的<code class="fe np nq nr nh b">title</code>也成为模板的表头；</li><li id="db9d" class="mb mc in la b lb ml lf mm lj mn ln mo lr mp lv nu mh mi mj bi translated">并且为<code class="fe np nq nr nh b">description</code>提供的参数为该页面添加了字幕</li></ul><p id="74a1" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">但是等一下——什么叫<strong class="la io">“规范中没有定义操作”？</strong>为什么命名空间中的任何内容都没有出现在模板上？</p><p id="2ee8" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">这让我们进入下一步:<strong class="la io">Flask-rest plus 中名称空间</strong>的目的是<strong class="la io">将您的 API 路由分组在一起。</strong></p><p id="daf7" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">因此，直到我们实际上为我们的模型添加了一条对图像进行分类的途径，在 UI 上真的不需要任何其他东西(因为我们还没有真正构建 API)。</p><p id="77ce" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">3.让我们现在解决这个问题——让我们<strong class="la io">创建一条路线，使用该模型来推断用户上传的叶子图像的健康状况。</strong>使用下面的代码片段将深度学习模型作为全局对象加载，并实现这条路线<strong class="la io"> : </strong></p><pre class="nc nd ne nf gt ng nh ni nj aw nk bi"><span id="ee98" class="mq kb in nh b gy nl nm l nn no"># Use Flask-RESTPlus argparser to process user-uploaded images<br/>arg_parser = api.parser()<br/>arg_parser.add_argument('image', location='files', <br/>                        type=FileStorage, required=True)</span><span id="f914" class="mq kb in nh b gy ns nm l nn no"># Model reconstruction - using retrained weights from Inception V3<br/>with open("./plantnet/inceptionModelArchitecture.json") as f:<br/>    model = keras.models.model_from_json(f.read())<br/>    model.load_weights("./plantnet/inception_model_weights.h5")</span><span id="1268" class="mq kb in nh b gy ns nm l nn no"># Add the route to run inference<br/>@ns.route("/prediction")<br/>class CNNPrediction(Resource):<br/>    """Takes in the image, to pass to the CNN"""<br/>    @api.doc(parser=arg_parser, <br/>             description="Let the AI predict if a leaf is healthy.")<br/>    def post(self):<br/>        # A: get the image<br/>        image = leaf.get_image(arg_parser)<br/>        # B: preprocess the image<br/>        final_image = leaf.preprocess_image(image)<br/>        # C: make the prediction<br/>        prediction = leaf.predict_leaf_health(model, final_image)<br/>        # return the classification<br/>        return prediction</span></pre><p id="249b" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">如果你想更详细地了解这个模型实际上是如何预处理图像并对它们进行预测的，可以绕道去库中的<a class="ae jz" href="https://github.com/UPstartDeveloper/plantnet-api/blob/main/util/leaf.py" rel="noopener ugc nofollow" target="_blank">实用函数。</a></p><p id="e692" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">现在，当您重新加载正在查看自动生成的 UI 的选项卡时，您应该看到 API 名称空间出现了:</p><figure class="nc nd ne nf gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nv"><img src="../Images/245f5827cfb32b9e812d82bdde8ab214.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JQ14L0UXH6XsnqR7lpV24w.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">一旦我们添加了路由，对它们进行分组的名称空间也会显示出来。</figcaption></figure><p id="9b76" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">事实上，您甚至可以下拉名称空间以显示调试器，这样您就可以测试我们创建的路由(例如，使用 repo 中的示例图像)，并检查以确保它像您预期的那样工作:</p><figure class="nc nd ne nf gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nv"><img src="../Images/d47847f24978ec77c7667c42cb92be5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hASvdYUqIHzrrfzl_tl95w.png"/></div></div></figure><p id="1fe3" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">让我们再次强调，这个路径的唯一目的是为一片叶子的一个图像提供一个标签——不多也不少。示例输入图像可能如下所示:</p><figure class="nc nd ne nf gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nw"><img src="../Images/0c870438af00d21c7ccfc49064373610.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gWXYqxP8CeLdlkhNbuZppw.jpeg"/></div></div></figure><p id="2e94" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">输出是一个 JSON 字符串，如下所示:</p><pre class="nc nd ne nf gt ng nh ni nj aw nk bi"><span id="102b" class="mq kb in nh b gy nl nm l nn no">{<strong class="nh io"><br/>  </strong>"label":<strong class="nh io"> </strong>"Grape_Black rot",<strong class="nh io"><br/>  </strong>"confidence":<strong class="nh io"> </strong>0.4162355065345764<strong class="nh io"><br/></strong>}</span></pre><p id="bb55" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated"><strong class="la io">关键要点</strong> <br/>在这个例子中，我们已经看到，通过将所有数据处理封装到一个 API 端点中(并使用 Flask-RESTPlus 这样的框架快速完成)，可以降低将深度学习模型部署到 web 的复杂性。</p><p id="e59b" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated"><strong class="la io">接下来的步骤<br/> </strong>现在，让我们超越调试 UI——真正的神奇之处在于使用我们在<strong class="la io">其他 web 应用</strong>的后端创建的 API 端点。所以现在让我们来看看，看看在自己的项目中使用深度学习是多么容易！</p><blockquote class="nx ny nz"><p id="1c1d" class="ky kz mk la b lb lw ld le lf lx lh li oa ly ll lm ob lz lp lq oc ma lt lu lv ig bi translated">"在每一个大程序里面都有一个小程序挣扎着要出来."<br/> ― <strong class="la io">东尼·霍尔<em class="in">、</em> </strong> 1980 年 ACM 图灵奖获得者</p></blockquote><h2 id="a6f7" class="mq kb in bd kc mr ms dn kg mt mu dp kk lj mv mw ko ln mx my ks lr mz na kw nb bi translated">第二课:不要让云存储阻止你</h2><p id="7dd5" class="pw-post-body-paragraph ky kz in la b lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv ig bi translated">老实说，你已经做了大量的工作，我的朋友。在使用我们的 API 时，还有一些事情会使我们出错——比如，<strong class="la io">如何在 HTTP 请求中以编程方式发送图像？</strong></p><p id="6526" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">同样，这个例子有一些假设:</p><ol class=""><li id="8091" class="mb mc in la b lb lw lf lx lj md ln me lr mf lv mg mh mi mj bi translated">如果你的应用程序<strong class="la io">将图片存储在云端</strong>(具体来说，存储在一个有<em class="mk">编程访问</em>的 AWS S3 桶中)[ <a class="ae jz" href="https://youtu.be/kt3ZtW9MXhw" rel="noopener ugc nofollow" target="_blank"> 3 </a>。</li><li id="f26a" class="mb mc in la b lb ml lf mm lj mn ln mo lr mp lv mg mh mi mj bi translated">你的应用后台是用<strong class="la io"> Python 写的。</strong></li></ol><p id="3e5c" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">如果这些假设确实适用，那么下一个例子就是为你准备的！</p><p id="ffe7" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated"><strong class="la io">示例:使用</strong> <code class="fe np nq nr nh b"><strong class="la io">boto3</strong></code> <br/>访问 S3 对象假设我们有一个供植物学家使用的网络应用程序，他们想上传他们研究的植物的叶子图像。我们希望我们的应用程序使用上述<a class="ae jz" href="https://plantvision.herokuapp.com/" rel="noopener ugc nofollow" target="_blank">植物视觉 API </a>，让他们知道叶子是否健康。</p><p id="2bb5" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">我们可以使用<code class="fe np nq nr nh b">boto3</code>，Python 的 AWS SDK，将我们的 S3 桶(通常称为 S3“对象”)中存储的图像输入到我们的程序中。</p><ol class=""><li id="85d6" class="mb mc in la b lb lw lf lx lj md ln me lr mf lv mg mh mi mj bi translated">首先，让我们在另一个应用程序的存储库中创建一个<code class="fe np nq nr nh b">.env</code>，并添加访问 S3 桶所需的 AWS 凭据:</li></ol><pre class="nc nd ne nf gt ng nh ni nj aw nk bi"><span id="da65" class="mq kb in nh b gy nl nm l nn no">AWS_ACCESS_KEY_ID=&lt;your_access_key&gt;<br/>AWS_SECRET_ACCESS_KEY=&lt;your_secret_key&gt;<br/>AWS_STORAGE_BUCKET_NAME=&lt;name_of_your_bucket&gt;</span></pre><p id="fa55" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">2.接下来，让我们确保可以在应用程序中使用这些环境变量。在 Python 中有几种方法可以做到这一点，对于这个例子，我们将使用<code class="fe np nq nr nh b">python-dotenv</code>包，通过 pip 安装:</p><pre class="nc nd ne nf gt ng nh ni nj aw nk bi"><span id="656c" class="mq kb in nh b gy nl nm l nn no">(env) python3 -m pip install python-dotenv</span></pre><p id="35b6" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">然后，我们可以将环境变量加载到 Python 模块中，如下所示:</p><pre class="nc nd ne nf gt ng nh ni nj aw nk bi"><span id="9f28" class="mq kb in nh b gy nl nm l nn no"># Python module<br/>from dotenv import load_dotenv<br/># Loads in environment variables from a .env file<br/>load_dotenv()<br/># Examples of Storing AWS information in Python variables<br/># AWS S3 Variables<br/>AWS_ACCESS_KEY_ID = os.getenv("AWS_ACCESS_KEY_ID", "")<br/>AWS_SECRET_ACCESS_KEY = os.getenv("AWS_SECRET_ACCESS_KEY", "")<br/>AWS_STORAGE_BUCKET_NAME = os.getenv("AWS_STORAGE_BUCKET_NAME", "")</span></pre><p id="f54d" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">3.现在，我们都准备好实际访问 S3 物体了！</p><p id="d8aa" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">我们从初始化 AWS 客户端开始—这将允许我们与我们的 S3 桶接口:</p><pre class="nc nd ne nf gt ng nh ni nj aw nk bi"><span id="3558" class="mq kb in nh b gy nl nm l nn no"># init AWS client<br/>import boto3<br/>s3 = boto3.resource('s3')<br/>bucket = s3.Bucket(settings.AWS_STORAGE_BUCKET_NAME)</span></pre><p id="7129" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">4.为了<strong class="la io">得到 S3 物体，我们现在需要它的<em class="mk">键</em> </strong>。这一步非常具有战术性，例如，假设存储桶中存储了一个图像，其结构如下:</p><pre class="nc nd ne nf gt ng nh ni nj aw nk bi"><span id="5cf6" class="mq kb in nh b gy nl nm l nn no">*** My S3 Bucket File Directory ***<br/>garden-images/<br/>|<br/>|<br/>|---plantA/<br/>    |<br/>    |<br/>    my-plant-img.jpg</span></pre><p id="e34a" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">那么<code class="fe np nq nr nh b">my-plant-img.jpg</code>的关键就是<code class="fe np nq nr nh b">garden-images/plantA/my-plant-img.jpg</code>。</p><p id="d76e" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">然而，你的应用程序的数据库可能只存储 S3 图像的 HTTPS 地址，所以有大量额外的信息会让<code class="fe np nq nr nh b">boto3</code>抛出错误！</p><p id="7857" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">为了解决这个问题，我们可以将你的图像的 URL 地址(可能是用 HTTPS)转换成 S3 的一个对象密钥，方法是将 URL 切片到<strong class="la io">只取桶的根目录，到查询字符串的开头:</strong></p><pre class="nc nd ne nf gt ng nh ni nj aw nk bi"><span id="df8f" class="mq kb in nh b gy nl nm l nn no"># get the key to the image on S3, leaving out the rest<br/>ROOT_BUCKET_DIR = "garden-images"<br/>start_path = img_url.find(ROOT_BUCKET_DIR)<br/>end_path = img_url.find("?")<br/>key = img_url[start_path:end_path]</span></pre><p id="cee3" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">请注意，在这个工作中，您的<code class="fe np nq nr nh b">img_url</code>应该以 URL 地址开始！您还需要研究您自己的 S3 桶的文件结构，找到您需要的<code class="fe np nq nr nh b">ROOT_BUCKET_DIR</code>。</p><p id="4d4e" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">4.我们现在可以通过以下方式获取存储在 S3 的图像数据:</p><pre class="nc nd ne nf gt ng nh ni nj aw nk bi"><span id="54e9" class="mq kb in nh b gy nl nm l nn no"># get the image data<br/>object = bucket.Object(key)<br/>response = object.get()['Body']</span></pre><p id="bc95" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">5.这样，您就可以通过使用 requests 模块，在 HTTP 请求中将这个图像发送给 API 了:</p><pre class="nc nd ne nf gt ng nh ni nj aw nk bi"><span id="aee7" class="mq kb in nh b gy nl nm l nn no"># convert the image to low-level binary data<br/>img_data = response.read()<br/>img_bytes = bytearray(img_data)<br/># data needed to make the request<br/>files = {'image': img_bytes}<br/>url = "https://plantvision.herokuapp.com/Diagnosis/prediction"\<br/># get the predictions from the Plant Vision API<br/>api_response = requests.post(url, files=files)</span></pre><p id="fd7f" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated"><strong class="la io">注释:</strong></p><ol class=""><li id="c1b4" class="mb mc in la b lb lw lf lx lj md ln me lr mf lv mg mh mi mj bi translated">您编写的<code class="fe np nq nr nh b">files</code>字典必须针对您使用的特定 API 进行结构化。我使用<code class="fe np nq nr nh b">‘image’</code>作为字典中的关键字的唯一原因是因为这是我们在 Flask-RESTPlus 中传递给<code class="fe np nq nr nh b">arg_parser</code>的参数(参见上一课中的示例)。</li><li id="a5e5" class="mb mc in la b lb ml lf mm lj mn ln mo lr mp lv mg mh mi mj bi translated">作为一名 Python 程序员，我们通常看不到<code class="fe np nq nr nh b">bytearray</code>数据结构——你可能会问，这是什么？它本质上是我们可以用来通过 TCP/IP 网络将图像信息传输到我们的 API 的东西，因为它需要是低级字节[ <a class="ae jz" href="https://python-reference.readthedocs.io/en/latest/docs/functions/bytearray.html" rel="noopener ugc nofollow" target="_blank"> 2 </a> ]。</li></ol><p id="1fde" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">6.最后但同样重要的是，我们需要确保我们确实使用了数据！现在我们的 API 返回一个字典，它在我们的<code class="fe np nq nr nh b">response.text</code>中。</p><p id="f172" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">我们可能不需要<code class="fe np nq nr nh b">response</code>变量中的所有数据。让我们使用<code class="fe np nq nr nh b">json</code>包来解析来自 API 的响应，将我们关心的值存储在它们自己的变量中以备将来使用:</p><pre class="nc nd ne nf gt ng nh ni nj aw nk bi"><span id="dcb7" class="mq kb in nh b gy nl nm l nn no">import json<br/># parse the response         <br/>label = json.loads(response.text)['label']<br/>confidence = json.loads(response.text)['confidence']</span></pre><p id="9681" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated"><strong class="la io">要点<br/> </strong>在本节中，我们看到了如何用 Python 向 RESTful API 发出涉及图像数据的请求。我们通过使用<code class="fe np nq nr nh b">boto3</code>和一点字符串解析克服了在 AWS 中访问图像的问题，并通过使用字典中的<code class="fe np nq nr nh b">bytearray</code>发出 HTTP 请求，最终传递给<code class="fe np nq nr nh b">requests.post</code>。</p><p id="7893" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">我意识到这一部分有更多的步骤，所以这里是我在代码片段中使用的另一个应用程序 GitHub 上的<a class="ae jz" href="https://github.com/Carbon0-Games/carbon0-web-app/blob/master/carbon0/garden/models/ml.py" rel="noopener ugc nofollow" target="_blank">代码的链接。</a></p><blockquote class="nx ny nz"><p id="0915" class="ky kz mk la b lb lw ld le lf lx lh li oa ly ll lm ob lz lp lq oc ma lt lu lv ig bi translated">“云是面向所有人的。云是一种民主。”–<strong class="la io">Marc Benioff，</strong>sales force 首席执行官</p></blockquote><h1 id="6370" class="ka kb in bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">结束语</h1><p id="4ca1" class="pw-post-body-paragraph ky kz in la b lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv ig bi translated">目前，我们已经从深度学习模型中获得了对我们应用程序的响应。然而，这是否足以真正为用户提供价值呢？</p><p id="9951" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">在<a class="ae jz" href="https://playcarbon0.com" rel="noopener ugc nofollow" target="_blank">carbon Games</a>上，我和我的团队相信，我们可以改进人类的思维、感受和行动，设计他们的生活来应对气候变化。如果深度学习可以帮助我们完成这项任务，那很好——然而这并不是故事的结尾。</p><p id="3276" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">如果你已经做到了这一步，我希望你也会尝试将深度学习作为一种积极变革的力量。打造你的用户可以信任的东西，帮助我们更多的人度过这个前所未有的时代——因为这是一份真正值得兴奋的工作。</p><h1 id="5ec4" class="ka kb in bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">参考资料和进一步阅读</h1><p id="5376" class="pw-post-body-paragraph ky kz in la b lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv ig bi translated">如果您想了解更多关于这里提到的一些主题的信息，请查阅以下资源:</p><p id="6f2b" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">[1]吴嘉星，弗朗索瓦·乔莱，<a class="ae jz" href="https://keras.io/guides/serialization_and_saving/" rel="noopener ugc nofollow" target="_blank">《连载与拯救》</a> (2020)，Keras.io</p><p id="fbf9" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">[2] Jakub Przywóski，<a class="ae jz" href="https://python-reference.readthedocs.io/en/latest/docs/functions/bytearray.html" rel="noopener ugc nofollow" target="_blank">“bytearray”</a>，(2015)，Python 参考(正确的方式)。</p><p id="2968" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">[3]科里·斯查费，<a class="ae jz" href="https://youtu.be/kt3ZtW9MXhw" rel="noopener ugc nofollow" target="_blank">《Python Django 教程:全功能 Web App 第 13 部分——使用 AWS S3 进行文件上传》</a> (2019)，YouTube。</p><p id="a7d5" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">最后，如果你想建立更强大的生产管道，我推荐<a class="ae jz" href="https://www.tensorflow.org/tfx/tutorials" rel="noopener ugc nofollow" target="_blank"> Tensorflow 服务文档</a>。或者，<a class="ae jz" href="https://aws.amazon.com/blogs/machine-learning/deploy-trained-keras-or-tensorflow-models-using-amazon-sagemaker/" rel="noopener ugc nofollow" target="_blank">亚马逊数据科学家的这篇博文</a>解释了如果你只想在云中运行模型推理，如何使用 AWS Sagemaker。</p></div></div>    
</body>
</html>