<html>
<head>
<title>Declarative Schema Overview in Magento 2 — Part 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Magento 2中的声明式模式概述—第2部分</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/how-to-use-declarative-schemas-in-magento-2-part-2-e4c09f5b6b6?source=collection_archive---------10-----------------------#2020-07-20">https://blog.devgenius.io/how-to-use-declarative-schemas-in-magento-2-part-2-e4c09f5b6b6?source=collection_archive---------10-----------------------#2020-07-20</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/51f78be737e930cfa63ee66962e4b881.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w34S8uAw3VF5XQjEj0S51g.jpeg"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">保罗·弗伦泽尔在<a class="ae jz" href="https://unsplash.com/" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="cea5" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在第一部分中，我们讨论了什么是声明式模式，为什么应该使用声明式模式而不是安装/升级脚本，如何创建、编辑并最终删除声明式模式。如果你还没有读过第一部分，我建议你花一点时间<a class="ae jz" href="https://medium.com/@rick.daalhuizen90/why-use-a-declarative-schema-over-install-scripts-in-magento-2-85092f9f85b9" rel="noopener">来读这第一个</a>。</p><p id="fed1" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">作为一个例子，我创建了一个简单的模块，包含一个看起来像这样的<a class="ae jz" href="https://www.mageplaza.com/magento-2-module-development/magento-2-how-to-create-sql-setup-script.html" rel="noopener ugc nofollow" target="_blank">InstallSchema.php</a>。</p><figure class="ky kz la lb gt jo"><div class="bz fp l di"><div class="lc ld l"/></div></figure><p id="9726" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">将安装/升级脚本迁移到声明性方案</strong></p><p id="413d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在也可以使用“模式监听器工具”将现有的安装/升级脚本转换为声明性方案。了解只能在开发人员模式下使用模式监听器工具是很有用的，因为它会对代码进行更改。此外，它没有考虑原始SQL数据，以及在<em class="le">\ Magento \ Framework \ DB \ Adapter \ Pdo \ Mysql</em>之外的自定义DDL操作。</p><p id="be7f" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">要执行迁移，请运行以下命令:</p><pre class="ky kz la lb gt lf lg lh li aw lj bi"><span id="f2d7" class="lk ll in lg b gy lm ln l lo lp">bin/magento s:up --convert-old-scripts=1</span></pre><blockquote class="lq lr ls"><p id="ee3f" class="ka kb le kc b kd ke kf kg kh ki kj kk lt km kn ko lu kq kr ks lv ku kv kw kx ig bi translated">对于低于2.4的Magento版本，请使用— convert_old_scripts标志</p></blockquote><p id="c841" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">请注意，这仅在模块安装或升级期间有效。如果在生成db_schema.xml时遇到问题，请尝试删除setup_module表中的模块条目，然后再次运行setup:upgrade。</p><p id="4efa" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这将在您的模块etc目录中生成一个db_schema.xml。</p><figure class="ky kz la lb gt jo"><div class="bz fp l di"><div class="lc ld l"/></div></figure><p id="5bd6" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">然后我们添加一些数据</p><pre class="ky kz la lb gt lf lg lh li aw lj bi"><span id="4309" class="lk ll in lg b gy lm ln l lo lp">INSERT INTO `magento`.`quote_item_file` (`entity_id`, `filename`, `location`, `quote_item_item_id`) VALUES ('1', 'examole.png', 'media/foo/bar/example.png', '1');</span></pre><p id="f453" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">什么是模式白名单，如何创建它们</strong></p><p id="476a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">方案白名单是为了向后兼容。这跟踪对声明性方案进行了哪些调整以防止数据丢失，而不知道这是何时发生的。当使用安装/升级脚本时，这通常可以在代码中找到。</p><p id="3a15" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">白名单在<module_vendor>/<module_name>/etc/db _ schema _ whitelist . JSON中生成，可以按如下方式创建:</module_name></module_vendor></p><pre class="ky kz la lb gt lf lg lh li aw lj bi"><span id="d416" class="lk ll in lg b gy lm ln l lo lp">bin/magento setup:db-declaration:generate-whitelist --module-name=&lt;Module_Name&gt;</span></pre><p id="a046" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">看起来像这样</p><pre class="ky kz la lb gt lf lg lh li aw lj bi"><span id="5495" class="lk ll in lg b gy lm ln l lo lp">{<br/>   "quote_item_file": {<br/>       "column": {<br/>           "entity_id": true,<br/>           "filename": true,<br/>           "location": true,<br/>           "quote_item_item_id": true<br/>       },<br/>       "constraint": {<br/>           "PRIMARY": true,<br/>           "QUOTE_ITEM_FILE_QUOTE_ITEM_ITEM_ID_QUOTE_ITEM_ITEM_ID": true<br/>       }<br/>   }<br/>}</span></pre><blockquote class="lq lr ls"><p id="d096" class="ka kb le kc b kd ke kf kg kh ki kj kk lt km kn ko lu kq kr ks lv ku kv kw kx ig bi translated">作为最佳实践，您应该为每个版本生成一个新的白名单文件。您必须为db_schema.xml文件中包含变更的任何版本生成白名单。</p></blockquote><p id="c81a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">利用试运行</strong></p><p id="0f19" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在我们已经创建了db_schema.xml，如果我们想以任何方式修改表，比如添加一列，我们可以使用预演。预演确保您不必担心脚本会破坏某些东西。在模拟运行期间，不会对数据库进行任何更改。</p><p id="5760" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">让我们删除其中一列</p><figure class="ky kz la lb gt jo"><div class="bz fp l di"><div class="lc ld l"/></div></figure><p id="fe71" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">运行以下命令以使用模拟运行:</p><pre class="ky kz la lb gt lf lg lh li aw lj bi"><span id="30c0" class="lk ll in lg b gy lm ln l lo lp">bin/magento s:up --dry-run=1</span></pre><p id="6cc4" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在您执行该操作后，将在<em class="le">&lt;Magento _ Root&gt;/var/log/dry-run-installation . log</em>中生成一个日志文件。该文件包含原始SQL语句，可用于在必要时优化或修改您的脚本。</p><pre class="ky kz la lb gt lf lg lh li aw lj bi"><span id="4d97" class="lk ll in lg b gy lm ln l lo lp">www-data@example-php-fpm:06:57 PM:/var/www/html$ cat var/log/dry-run-installation.log</span><span id="d47f" class="lk ll in lg b gy lw ln l lo lp">ALTER TABLE `quote_item_file` DROP COLUMN `location`</span></pre><p id="a825" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">如何执行回滚。</strong></p><p id="c5af" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如果在迁移过程中由于某种原因出现了问题，可以使用回滚。对于那些还不熟悉回滚的人来说，它确保了最近所做的更改可以被撤销。</p><p id="2a4c" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">每次对表或列进行破坏性操作时，使用安全模式选项都会创建一个CSV文件。</p><pre class="ky kz la lb gt lf lg lh li aw lj bi"><span id="2458" class="lk ll in lg b gy lm ln l lo lp">bin/magento s:up --safe-mode=1</span></pre><p id="ec78" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这将在以下位置之一创建一个csv文件:</p><ul class=""><li id="20d7" class="lx ly in kc b kd ke kh ki kl lz kp ma kt mb kx mc md me mf bi translated"><magento_root>/var/declarative _ dumps _ CSV/{ column _ name _ column _ type _ other _ dimensions }。战斗支援车</magento_root></li><li id="8bfa" class="lx ly in kc b kd mg kh mh kl mi kp mj kt mk kx mc md me mf bi translated"><magento_root>/var/declarative _ dumps _ CSV/{ table _ name }。战斗支援车</magento_root></li></ul><p id="4d6a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">csv文件包含来自数据库表、行、列和值的信息，这些信息已针对安装进行了修改。</p><p id="c820" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在我们的例子中，它看起来像这样</p><pre class="ky kz la lb gt lf lg lh li aw lj bi"><span id="888d" class="lk ll in lg b gy lm ln l lo lp">www-data@example-php-fpm:07:40 PM:/var/www/html$ cat var/declarative_dumps_csv/quote_item_file_column_location.csv<br/>entity_id,location<br/>1,media/foo/bar/example.png</span></pre><p id="1eae" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">验证一切正常后，我们可以从表中删除该列并运行:</p><pre class="ky kz la lb gt lf lg lh li aw lj bi"><span id="09ce" class="lk ll in lg b gy lm ln l lo lp">bin/magento s:up</span></pre><p id="54d9" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">要将一切恢复原样，我们只需将删除的列放回db_schema.xml中。</p><p id="be89" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">最后，我们运行以下命令来执行回滚。</p><pre class="ky kz la lb gt lf lg lh li aw lj bi"><span id="3894" class="lk ll in lg b gy lm ln l lo lp">bin/magento s:up --data-restore=1</span></pre><blockquote class="lq lr ls"><p id="91f5" class="ka kb le kc b kd ke kf kg kh ki kj kk lt km kn ko lu kq kr ks lv ku kv kw kx ig bi translated">— data-restore=1仅适用于setup: upgrade命令</p></blockquote><p id="1fc4" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">结论</strong></p><p id="4286" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我希望我已经向您介绍了Magento中的声明性模式以及如何使用它们。如果您想了解更多，我还建议您阅读Magento文档中关于“<a class="ae jz" href="https://devdocs.magento.com/guides/v2.4/extension-dev-guide/declarative-schema/migration-commands.html" rel="noopener ugc nofollow" target="_blank">将安装/升级脚本迁移到声明性模式</a>”的内容。如需反馈或意见，请在下方留言。</p><h1 id="a51c" class="ml ll in bd mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh bi translated">觉得这个帖子有用吗？请点击👏下面的按钮！:)</h1></div></div>    
</body>
</html>