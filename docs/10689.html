<html>
<head>
<title>Producing Message to Kafka Using CLI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 CLI 生成给 Kafka 的消息</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/producing-message-to-kafka-using-cli-6bd22fc51d5c?source=collection_archive---------6-----------------------#2022-11-22">https://blog.devgenius.io/producing-message-to-kafka-using-cli-6bd22fc51d5c?source=collection_archive---------6-----------------------#2022-11-22</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/d2f22b4bcd95c458af66e8ebf62caab7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*1nx6UZkMSyGto1b8.png"/></div></div></figure><h1 id="467f" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">先决条件</h1><ol class=""><li id="a718" class="kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">Kafka-installations-and-Kafka-topics:<a class="ae ll" href="https://medium.com/dev-genius/kafka-installtions-and-kafka-topics-f0b7c81754d8" rel="noopener">https://medium . com/dev-genius/Kafka-installations-and-Kafka-topics-f0b7c 81754 D8</a></li><li id="72ad" class="kt ku in kv b kw lm ky ln la lo lc lp le lq lg lh li lj lk bi translated">Kafka-with-python-fast-API:<a class="ae ll" href="https://medium.com/dev-genius/kafka-with-python-fast-api-b1622eb7f9d0" rel="noopener">https://medium . com/dev-genius/Kafka-with-python-fast-API-b 1622 EB 7 F9 d 0</a></li></ol><h1 id="3458" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">初始化卡夫卡</h1><pre class="lr ls lt lu gt lv lw lx bn ly lz bi"><span id="b31a" class="ma jw in lw b be mb mc l md me">docker-compose up -d</span></pre><h1 id="28b0" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">创建主题</h1><p id="9ccb" class="pw-post-body-paragraph mf mg in kv b kw kx mh mi ky kz mj mk la ml mm mn lc mo mp mq le mr ms mt lg ig bi translated">我们将创建一个名为<code class="fe mu mv mw lw b">people</code>的主题，包含 2 个分区和 1 个副本</p><pre class="lr ls lt lu gt lv lw lx bn ly lz bi"><span id="82e7" class="ma jw in lw b be mb mc l md me">docker exec -it cli-tools kafka-console-consumer --bootstrap-server broker0:29092 --topic people --from-beginning</span></pre><h1 id="84c8" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">创建生产者</h1><pre class="lr ls lt lu gt lv lw lx bn ly lz bi"><span id="8793" class="ma jw in lw b be mb mc l md me">docker exec -it cli-tools kafka-console-producer --broker-list broker0:29092 --topic people</span></pre><figure class="lr ls lt lu gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mx"><img src="../Images/206fa2b1a39975a3efd3f86ac31cd586.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Qdipc3iMmfTs0nqE.png"/></div></div></figure><h1 id="15cc" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">初始消费者</h1><p id="1857" class="pw-post-body-paragraph mf mg in kv b kw kx mh mi ky kz mj mk la ml mm mn lc mo mp mq le mr ms mt lg ig bi translated">初始化消费者，以便无论生产者何时产生消息，消费者都会使用该消息</p><pre class="lr ls lt lu gt lv lw lx bn ly lz bi"><span id="1d2c" class="ma jw in lw b be mb mc l md me">docker-compose exec broker kafka-console-consumer --bootstrap-server localhost:9092 --topic test --from-beginning</span></pre><h1 id="0e8b" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">生成消息</h1><pre class="lr ls lt lu gt lv lw lx bn ly lz bi"><span id="65ed" class="ma jw in lw b be mb mc l md me">{"name": "Sohaib", "age": 23}<br/>{"name": "Hassan", "age": 26}</span></pre><figure class="lr ls lt lu gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi my"><img src="../Images/5e458e94cdbc5b347023fecd03458617.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*dm0hilHqb5LIsp3Z.png"/></div></div></figure><h1 id="5c5a" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">消费信息</h1><pre class="lr ls lt lu gt lv lw lx bn ly lz bi"><span id="9d31" class="ma jw in lw b be mb mc l md me">{"name": "Sohaib", "age": 23}<br/>{"name": "Hassan", "age": 26}</span></pre><p id="6373" class="pw-post-body-paragraph mf mg in kv b kw mz mh mi ky na mj mk la nb mm mn lc nc mp mq le nd ms mt lg ig bi translated">因此，当我们使用生成器生成一条消息时，它将很快被消费者消费，并且我们可以在消费者那里看到该消息。</p><h1 id="21c5" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">现在让我们尝试使用 python 生成一条消息</h1><p id="c78b" class="pw-post-body-paragraph mf mg in kv b kw kx mh mi ky kz mj mk la ml mm mn lc mo mp mq le mr ms mt lg ig bi translated">首先，让我们创建一个 env 文件，它将帮助我们保持 Kafka 服务器设置</p><h1 id="6ff0" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">开始的步骤</h1><ol class=""><li id="2b2c" class="kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">创建虚拟环境</li></ol><pre class="lr ls lt lu gt lv lw lx bn ly lz bi"><span id="2f61" class="ma jw in lw b be mb mc l md me"># I am using conda so<br/>conda create -n kafka python=3.8</span></pre><ol class=""><li id="2db7" class="kt ku in kv b kw mz ky na la ne lc nf le ng lg lh li lj lk bi translated">安装需求</li></ol><pre class="lr ls lt lu gt lv lw lx bn ly lz bi"><span id="e2a3" class="ma jw in lw b be mb mc l md me"># kafka-python==2.0.2<br/># fastapi[all]== 0.75.1<br/># python-dotenv==0.20.0<br/># Faker==13.3.4<br/>pip install -r requirements.txt</span></pre><ol class=""><li id="702f" class="kt ku in kv b kw mz ky na la ne lc nf le ng lg lh li lj lk bi translated">创建一个<code class="fe mu mv mw lw b">.env</code>文件</li></ol><pre class="lr ls lt lu gt lv lw lx bn ly lz bi"><span id="149e" class="ma jw in lw b be mb mc l md me">BOOTSTRAP_SERVER="localhost:9092,localhost:9093,localhost:9094"<br/>TOPIC_NAME="people"<br/>TOPIC_PARTITION=3<br/>TOPIC_REPLICA=3</span></pre><ol class=""><li id="7b94" class="kt ku in kv b kw mz ky na la ne lc nf le ng lg lh li lj lk bi translated">使<code class="fe mu mv mw lw b">main.py</code>可执行</li></ol><pre class="lr ls lt lu gt lv lw lx bn ly lz bi"><span id="a099" class="ma jw in lw b be mb mc l md me"># Import Libraries<br/>import os<br/>import uuid<br/>from typing import List</span></pre><pre class="nh lv lw ni nj aw nk bi"><span id="9a8c" class="nl jw in lw b gy nm nn l no me">from dotenv import load_dotenv<br/>from fastapi import FastAPI<br/>from faker import Faker<br/>from kafka import KafkaAdminClient<br/>from kafka.admin import NewTopic<br/>from kafka.errors import TopicAlreadyExistsError<br/>from kafka.producer import KafkaProducer</span></pre><p id="2888" class="pw-post-body-paragraph mf mg in kv b kw mz mh mi ky na mj mk la nb mm mn lc nc mp mq le nd ms mt lg ig bi translated">创建启动功能</p><pre class="lr ls lt lu gt lv lw lx bn ly lz bi"><span id="22fa" class="ma jw in lw b be mb mc l md me"># Startup Function<br/>@app.on_event('startup')<br/>async def startup_event():<br/>  """_summary_: Create the topic if it doesn't exist<br/>  """<br/>  # Getting the boot strap servers from the environment<br/>  client = KafkaAdminClient(bootstrap_servers=os.environ['BOOTSTRAP_SERVER'])<br/>  try:<br/>    # Creating the topic<br/>    topic = NewTopic(name=os.environ['TOPIC_NAME'],<br/>                    num_partitions=int(os.environ['TOPIC_PARTITION']),<br/>                    replication_factor=int(os.environ['TOPIC_REPLICA']))<br/>    client.create_topics([topic])<br/>  except TopicAlreadyExistsError as e:<br/>    print(e)<br/>  finally:<br/>    client.close()</span></pre><p id="ddd1" class="pw-post-body-paragraph mf mg in kv b kw mz mh mi ky na mj mk la nb mm mn lc nc mp mq le nd ms mt lg ig bi translated">创建一个函数来生成一条消息</p><pre class="lr ls lt lu gt lv lw lx bn ly lz bi"><span id="b5e1" class="ma jw in lw b be mb mc l md me">def make_producer():<br/>  """_summary_: Create a Kafka producer<br/>  """<br/>  producer = KafkaProducer(bootstrap_servers=os.environ['BOOTSTRAP_SERVER'])<br/>  return producer</span></pre><p id="e061" class="pw-post-body-paragraph mf mg in kv b kw mz mh mi ky na mj mk la nb mm mn lc nc mp mq le nd ms mt lg ig bi translated">创建 API 以生成消息</p><pre class="lr ls lt lu gt lv lw lx bn ly lz bi"><span id="cfc2" class="ma jw in lw b be mb mc l md me">@app.post('/api/people', status_code=201, response_model=List[Person])<br/>async def create_people(cmd: CreatePeopleCommand):<br/>  """_summary_: Create a list of people<br/>  """<br/>  people: List[Person] = []<br/>  # Creating the Fake people<br/>  faker = Faker()<br/>  # Creating the producer<br/>  producer = make_producer()<br/>  # Creating the people and sending them to the topic<br/>  for _ in range(cmd.count):<br/>    person = Person(id=str(uuid.uuid4()), name=faker.name(), title=faker.job().title())<br/>    people.append(person)<br/>    producer.send(topic=os.environ['TOPIC_NAME'],<br/>                key=person.title.lower().replace(r's+', '-').encode('utf-8'),<br/>                value=person.json().encode('utf-8'))<br/>  # Closing the producer<br/>  producer.flush()</span></pre><pre class="nh lv lw ni nj aw nk bi"><span id="7cdd" class="nl jw in lw b gy nm nn l no me">  return people</span></pre><p id="0d29" class="pw-post-body-paragraph mf mg in kv b kw mz mh mi ky na mj mk la nb mm mn lc nc mp mq le nd ms mt lg ig bi translated">完成所有这些后，我们可以使用</p><pre class="lr ls lt lu gt lv lw lx bn ly lz bi"><span id="8f3a" class="ma jw in lw b be mb mc l md me">uvicorn main:app --reload</span></pre><p id="40d3" class="pw-post-body-paragraph mf mg in kv b kw mz mh mi ky na mj mk la nb mm mn lc nc mp mq le nd ms mt lg ig bi translated">现在我们可以使用 API 生成消息</p><pre class="lr ls lt lu gt lv lw lx bn ly lz bi"><span id="d9c7" class="ma jw in lw b be mb mc l md me">curl -X POST "http://localhost:8000/api/people" -H "accept: application/json" -H "Content-Type: application/json" -d "{\"count\": 3}"</span></pre><figure class="lr ls lt lu gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi np"><img src="../Images/c96e4960d6c301b0d5513781cd2a722b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*maFJmhHGfwurX96j.png"/></div></div></figure><p id="bea2" class="pw-post-body-paragraph mf mg in kv b kw mz mh mi ky na mj mk la nb mm mn lc nc mp mq le nd ms mt lg ig bi translated">现在，我们可以看到消费者传达的信息</p><figure class="lr ls lt lu gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi np"><img src="../Images/475c5c6b0858128014c7021e73afe6db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*yFIjafhoSvxqmI2c.png"/></div></div></figure><h1 id="9707" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">结论</h1><p id="c0c1" class="pw-post-body-paragraph mf mg in kv b kw kx mh mi ky kz mj mk la ml mm mn lc mo mp mq le mr ms mt lg ig bi translated">在这篇博客中，你已经学习了如何在 python 和终端的帮助下创建一个生产者，并使用消费者阅读消息。您还可以使用 API 生成消息，并使用消费者阅读新闻。您也可以在 GitHub repo 中查找代码。</p><h1 id="bf47" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">参考</h1><ol class=""><li id="8069" class="kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated"><a class="ae ll" href="https://kafka.apache.org/quickstart" rel="noopener ugc nofollow" target="_blank">https://kafka.apache.org/quickstart</a></li><li id="c798" class="kt ku in kv b kw lm ky ln la lo lc lp le lq lg lh li lj lk bi translated"><a class="ae ll" href="https://github.com/SohaibAnwaar/Produce-Messages-To-Kafka" rel="noopener ugc nofollow" target="_blank">https://github.com/SohaibAnwaar/Produce-Messages-To-Kafka</a></li></ol><h1 id="a59b" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">作者</h1><ul class=""><li id="a650" class="kt ku in kv b kw kx ky kz la lb lc ld le lf lg nq li lj lk bi translated">索海卜·安瓦尔:<a class="ae ll" href="https://www.sohaibanwaar.com/" rel="noopener ugc nofollow" target="_blank">https://www.sohaibanwaar.com</a></li><li id="34b3" class="kt ku in kv b kw lm ky ln la lo lc lp le lq lg nq li lj lk bi translated">Gmail:<a class="ae ll" href="mailto:sohaibanwaar36@gmail.com" rel="noopener ugc nofollow" target="_blank">sohaibanwaar36@gmail.com</a></li><li id="56c4" class="kt ku in kv b kw lm ky ln la lo lc lp le lq lg nq li lj lk bi translated">LinkedIn : <a class="ae ll" href="https://www.linkedin.com/in/sohaib-anwaar-4b7ba1187/" rel="noopener ugc nofollow" target="_blank">在这里做一些专业的谈话</a></li><li id="1841" class="kt ku in kv b kw lm ky ln la lo lc lp le lq lg nq li lj lk bi translated">堆栈溢出:<a class="ae ll" href="https://stackoverflow.com/users/7959545/sohaib-anwaar" rel="noopener ugc nofollow" target="_blank">在这里获得我的帮助</a></li><li id="def6" class="kt ku in kv b kw lm ky ln la lo lc lp le lq lg nq li lj lk bi translated">在这里查看我的杰作</li><li id="d3b3" class="kt ku in kv b kw lm ky ln la lo lc lp le lq lg nq li lj lk bi translated">GitHub : <a class="ae ll" href="https://github.com/SohaibAnwaar" rel="noopener ugc nofollow" target="_blank">在这里查看我的代码</a></li></ul></div></div>    
</body>
</html>