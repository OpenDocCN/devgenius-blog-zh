<html>
<head>
<title>Avoid N+1 problem using Eloquent ORM</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用雄辩的ORM避免N+1问题</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/avoid-n-1-problem-using-eloquent-orm-e74d27e7946d?source=collection_archive---------0-----------------------#2020-05-24">https://blog.devgenius.io/avoid-n-1-problem-using-eloquent-orm-e74d27e7946d?source=collection_archive---------0-----------------------#2020-05-24</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/69d75207ea89fa3aaa098e8ad3925f2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4zQxXb3KwLXSyJlwJcs6uQ.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">请求帖子及其作者时的N+1问题</figcaption></figure><p id="5c8b" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">正如你可能在你所有的<strong class="kb io"> Laravel </strong>项目中使用过<strong class="kb io">口才</strong>一样，你会感受到口才给你的生活带来的安慰。</p><p id="0f44" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">雄辩术节省了开发者大量的时间，但是如果你不注意查询，它可能会遇到问题。可能发生的问题之一被称为N+1问题。</p><h2 id="a3e0" class="kx ky in bd kz la lb dn lc ld le dp lf kk lg lh li ko lj lk ll ks lm ln lo lp bi translated">N+1问题是什么？</h2><p id="0517" class="pw-post-body-paragraph jz ka in kb b kc lq ke kf kg lr ki kj kk ls km kn ko lt kq kr ks lu ku kv kw ig bi translated">我们用实践来解释一下:</p><p id="779f" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">假设你有两个模型叫做<code class="fe lv lw lx ly b">User</code>和<code class="fe lv lw lx ly b">Post</code>。</p><figure class="ma mb mc md gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi lz"><img src="../Images/9340542ce5aa524c626dd18d33c493e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sZIy4ZwYUwSs_dYvXWG-Kw.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">发布模型</figcaption></figure><figure class="ma mb mc md gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi me"><img src="../Images/e782823d2c62a93beb701d105404ef25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Smz2499OSTZiO8Ba8N9mcA.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">用户模型</figcaption></figure><p id="2d3e" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">如你所见，一个用户可以有很多帖子，一个帖子是由一个用户(作者)写的。</p></div><div class="ab cl mf mg hr mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="ig ih ii ij ik"><p id="fac3" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">现在，我们将有一个所有帖子的列表，其作者的名字就在旁边。</p><ol class=""><li id="4b55" class="mm mn in kb b kc kd kg kh kk mo ko mp ks mq kw mr ms mt mu bi translated">我们应该有一个路径来查看页面:</li></ol><figure class="ma mb mc md gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mv"><img src="../Images/30be3d7414c938acc56aefeba9484fbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tTWIDA46679qIntrAjOCKw.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">routes/web.php文件</figcaption></figure><p id="1e89" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">2.在控制器中，我们必须从数据库中检索所有帖子:</p><figure class="ma mb mc md gt jo gh gi paragraph-image"><div class="gh gi mw"><img src="../Images/c4a3b48d3f32ed679fce3249acfb22b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1382/format:webp/1*-3OInMd_eT6CXqFvLiqXgA.png"/></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">PostController.php文件</figcaption></figure><p id="2cad" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">3.最后，我们将展示帖子及其作者:</p><figure class="ma mb mc md gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mx"><img src="../Images/31b679a30a3f512097d3b9d162798016.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IU-_PfwhYykUJKkMp0ClsA.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">resources/views/post . blade . PHP</figcaption></figure><p id="d6ba" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">这就是结果:</p><figure class="ma mb mc md gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi my"><img src="../Images/15f6eadb4be1293c074c9578008c1d0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U1Ev_5cSAuM2Cfj1Iouv1Q.png"/></div></div></figure><p id="993d" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">看起来一切都很好:)</p><p id="ad0d" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">不，这里有问题。</strong></p><figure class="ma mb mc md gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/74f2d5ada61b2363d0b5991ff1d5568b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Pk3Vd7TAjR0Tuqgd-3tbhA.png"/></div></div></figure><p id="48b7" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">如您所见，这里有太多的SQL查询。<strong class="kb io">这就是所谓的N+1问题。</strong></p></div><div class="ab cl mf mg hr mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="ig ih ii ij ik"><h2 id="7aa1" class="kx ky in bd kz la lb dn lc ld le dp lf kk lg lh li ko lj lk ll ks lm ln lo lp bi translated">N+1问题的解法是什么？</h2><p id="5506" class="pw-post-body-paragraph jz ka in kb b kc lq ke kf kg lr ki kj kk ls km kn ko lt kq kr ks lu ku kv kw ig bi translated">口才有<strong class="kb io">急切加载功能</strong>在这种情况下很有用。</p><p id="127c" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">让我们看看如何实现急切加载:</p><figure class="ma mb mc md gt jo gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/d386dfc204bad8c1c525f96f3eb17e8c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1366/format:webp/1*Wdg1P7KbDfSiZIjeN6x90A.png"/></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">PostController.php文件</figcaption></figure><p id="ba65" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">在PostController.php的文件中，我们将得到将<code class="fe lv lw lx ly b">with('author')</code>添加到查询中的帖子。<code class="fe lv lw lx ly b">author</code>实际上是在<code class="fe lv lw lx ly b">Post</code>模型中使用的关系方法的名称。</p><p id="dfdb" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">因此，使用这种方法，我们可以在一个查询中获得所有相关的用户，而不是N个查询(N =从DB中检索的帖子数)。</p><p id="a4a4" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">这就是结果:</p><figure class="ma mb mc md gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi na"><img src="../Images/b4d4705dc774b73dec964754403d14e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dAdP1HTHzEfBXu8-FUjwlQ.png"/></div></div></figure><p id="fe32" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">查询时间从<strong class="kb io"> 32.61 ms </strong>得到了<strong class="kb io"> 3.29 ms </strong>简直是疯了。😎</p><p id="7442" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">简而言之，要解决N+1问题，你应该使用急切加载。</strong></p></div></div>    
</body>
</html>