# åœ¨ Node.js ä¸­æ„å»ºä¸€ä¸ªåŠ¨æ€é…ç½®åŠ è½½å™¨

> åŸæ–‡ï¼š<https://blog.devgenius.io/build-a-dynamic-configuration-loader-in-node-js-2d4d2117d750?source=collection_archive---------0----------------------->

ğŸš€ [**æ‰“é€ åˆ†å±‚å¾®æœåŠ¡**](https://learnbackend.dev/books/build-layered-microservices) è¿™æœ¬ä¹¦å‡ºæ¥äº†ï¼ç°åœ¨å°±åœ¨ [learnbackend.dev](https://learnbackend.dev/books/build-layered-microservices) è´­ä¹°ä½ è‡ªå·±çš„å‰¯æœ¬ã€‚

![](img/efe984f8ea7af69887911a6f19a1fa9c.png)

åœ¨ç¼–ç¨‹ä¸­ï¼Œ*é…ç½®*æ˜¯ä¸€ä¸ªé”®å€¼å¯¹åˆ—è¡¨ï¼Œç”¨äºé…ç½®è®¡ç®—æœºç¨‹åºçš„å‚æ•°å’Œåˆå§‹è®¾ç½®ï¼Œä»¥å®šåˆ¶å®ƒä»¬çš„è¡Œä¸ºã€‚

åœ¨ Node.js ä¸­ï¼Œè¿™äº›å€¼é€šå¸¸åœ¨æµç¨‹çš„*ç¯å¢ƒ*ä¸­å®šä¹‰ï¼Œå¯ä»¥é€šè¿‡å…¨å±€`process.env`å¯¹è±¡è®¿é—®ã€‚

è™½ç„¶å®ç”¨ï¼Œä½†è¿™ç§æ–¹æ³•æœ‰ä¸¤ä¸ªç¼ºç‚¹:

1.  å®ƒè¿«ä½¿ç¨‹åºä¾èµ–äºç›®æ ‡æœºå™¨çš„æ³¢åŠ¨ç¯å¢ƒï¼Œå…¶å˜é‡å¯ä»¥è¢«å…¶ä»–å¼€å‘äººå‘˜æˆ–ç¨‹åºè¦†ç›–æˆ–åˆ é™¤ã€‚
2.  å®ƒè¿«ä½¿å¼€å‘äººå‘˜åœ¨æ¯æ¬¡æƒ³è¦æ”¹å˜åº”ç”¨ç¨‹åºçš„éƒ¨ç½²ç¯å¢ƒæ—¶è¦†ç›–è¿™äº›å€¼(`development`ã€`staging`ã€`production`ç­‰ç­‰)ã€‚

æ›´å¥½çš„æ–¹æ³•æ˜¯ä½¿ç”¨å‡ ä¸ªé…ç½®æ–‡ä»¶â€”â€”æ¯ä¸ªéƒ¨ç½²ç¯å¢ƒä¸€ä¸ªâ€”â€”å®ƒä»¬åœ¨æµç¨‹å¯åŠ¨æ—¶åŠ è½½ã€‚

# èŠ‚ç‚¹ç¯å¢ƒå˜é‡

`NODE_ENV`å˜é‡æ˜¯ç”± Express framework æ¨å¹¿çš„ç¯å¢ƒå˜é‡ï¼Œå®ƒæŒ‡å®šäº†åº”ç”¨ç¨‹åºè¿è¡Œçš„éƒ¨ç½²ç¯å¢ƒï¼Œå¦‚`development`æˆ–`staging`ã€‚

å°±åƒä»»ä½•å…¶ä»–ç¯å¢ƒå˜é‡ä¸€æ ·ï¼Œå®ƒå¯ä»¥é€šè¿‡å…¨å±€`process.env`å¯¹è±¡è®¿é—®ï¼Œå¹¶ä½¿ç”¨ä¸€ä¸ªé€‰é¡¹æ ‡å¿—æ¥è¿è¡Œä¸€æ®µç‰¹å®šçš„ä»£ç ï¼Œæˆ–è€…ä½œä¸ºä¸€ä¸ªåŠ¨æ€å‚æ•°æ¥æ”¹å˜åº”ç”¨ç¨‹åºçš„è¡Œä¸ºï¼Œä¾‹å¦‚æ‰“å¼€å’Œå…³é—­è°ƒè¯•ã€‚

è¿™ä¸ªå˜é‡å¯ä»¥é€šè¿‡åœ¨å‘½ä»¤ä¹‹å‰å£°æ˜æ¥æœ¬åœ°è®¾ç½®ï¼Œè¿™æ„å‘³ç€å®ƒåªå¯¹é‚£ä¸ªç¨‹åºå¯è§ã€‚

```
$ NODE_ENV=development node index.js
```

æˆ–è€…å…¨å±€ä½¿ç”¨å¯¼å‡ºå®ç”¨ç¨‹åºï¼Œè¿™æ„å‘³ç€å®ƒå°†å¯¹æ‰€æœ‰ç¨‹åºå¯è§ã€‚

```
$ export NODE_ENV=development
```

ä¸ºäº†è¯´æ˜è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªåä¸º`index.js`çš„è„šæœ¬ï¼Œå®ƒå°†ç®€å•åœ°è®°å½•è¿™ä¸ª`NODE_ENV`å˜é‡çš„å€¼ã€‚

```
// index.jsconsole.log(process.env.NODE_ENV);
```

å¹¶åœ¨æ–°çš„ç»ˆç«¯çª—å£ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤è¿›è¡Œæµ‹è¯•ã€‚

```
$ NODE_ENV=development node index.js
development
$ NODE_ENV=production node index.js
production
```

# dotenv åŒ…è£…

`dotenv`æ˜¯ä¸€ä¸ªé›¶ä¾èµ– Node.js åŒ…ï¼Œå®ƒå°†ç¯å¢ƒå˜é‡ä»ä¸€ä¸ªæ–‡ä»¶åŠ è½½åˆ°æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹çš„ç¯å¢ƒä¸­ã€‚

```
$ npm install dotenv
```

ç”±`dotenv`æ¨¡å—å…¬å¼€çš„`config()`å‡½æ•°å°†é»˜è®¤å°è¯•è§£æä½äºé¡¹ç›®é¡¶å±‚ç›®å½•ä¸­çš„`.env`æ–‡ä»¶çš„å†…å®¹ã€‚

```
var_1=123
var_2=hello
```

ç„¶åï¼Œå®ƒå°†æŠŠå®ƒçš„å€¼èµ‹ç»™å…¨å±€`process.env`å¯¹è±¡ï¼Œæˆ–è€…è¿”å›ä¸€ä¸ªåŒ…å«å¸¦æœ‰åŠ è½½å†…å®¹çš„`parsed`é”®çš„å¯¹è±¡ï¼Œæˆ–è€…è¿”å›ä¸€ä¸ª`error`é”®ã€‚

```
const { config } = require('dotenv');const env = config();if (env.error) {
  throw env.error;
}
console.log(env.parsed);
```

æˆ–è€…ï¼Œå¦‚æœæˆ‘ä»¬æƒ³ä»¥ä¸åŒçš„æ–¹å¼å‘½åæˆ‘ä»¬çš„é…ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å‘`config()`å‡½æ•°ä¼ é€’ä¸€ä¸ªå¸¦æœ‰`path`å±æ€§çš„å¯é€‰å¯¹è±¡æ¥å‘Šè¯‰`dotenv`åŠ è½½å“ªä¸ªæ–‡ä»¶ã€‚

```
const { config } = require('dotenv');const env = config({
  path: '/path/to/config'
});
```

[](https://learnbackend.dev/) [## æ„å»ºåˆ†å±‚å¾®æœåŠ¡|å­¦ä¹ åç«¯

### è¿™æ˜¯ä¸€ä¸ªå¾ªåºæ¸è¿›çš„å¤§å¸ˆç­ï¼Œé¢å‘åˆå­¦è€…å’Œåˆçº§å¼€å‘äººå‘˜ï¼Œè‡´åŠ›äº Node.js ä¸­çš„å®ç”¨ç¼–ç¨‹

learnbackend.dev](https://learnbackend.dev/) 

# é…ç½®åŠ è½½å™¨æ¨¡å—

æ­£å¦‚ç®€ä»‹ä¸­æåˆ°çš„ï¼Œç°å®ä¸–ç•Œä¸­çš„åº”ç”¨ç¨‹åºå¿…é¡»èƒ½å¤Ÿåœ¨å¤šä¸ªéƒ¨ç½²ç¯å¢ƒä¹‹é—´åˆ‡æ¢ï¼Œå› æ­¤å¯ä»¥æ ¹æ®ä¸Šä¸‹æ–‡åŠ è½½é€‚å½“çš„é…ç½®æ–‡ä»¶â€”â€”è¿™å¯ä»¥é€šè¿‡ä½¿ç”¨`NODE_ENV`ç¯å¢ƒå˜é‡å’Œ`dotenv`åŒ…çš„ç»„åˆæ¥è½»æ¾å®ç°ã€‚

è®©æˆ‘ä»¬ä»åˆ›å»ºä¸¤ä¸ªåä¸º`.env.development`å’Œ`.env.production`çš„é…ç½®æ–‡ä»¶å¼€å§‹ï¼Œè¿™ä¸¤ä¸ªæ–‡ä»¶å°†åŒ…å«ä¸€ä¸ªåä¸º`SERVER_PORT`çš„å˜é‡ï¼Œè¯¥å˜é‡è¡¨ç¤ºæœåŠ¡å™¨å°†ç›‘å¬ä¼ å…¥è¯·æ±‚çš„ç«¯å£å·ã€‚

```
$ echo "SERVER_PORT=3000" > .env.development
$ echo "SERVER_PORT=80" > .env.production
```

è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåä¸º`loadenv.js`çš„æ¨¡å—ï¼Œå®ƒå¯¼å‡ºä¸€ä¸ªå·¥å‚å‡½æ•°:

1.  ä½¿ç”¨`dotenv`åŒ…åŠ è½½ç”±ä»¥ä¸‹å­—ç¬¦ä¸²æ’å€¼å®šä¹‰çš„æŒ‡å®šæ–‡ä»¶ï¼›å¦‚æœ`NODE_ENV`å˜é‡ä¸º`undefined`ï¼Œåˆ™é»˜è®¤ä¸º`".env.development"`ã€‚
2.  å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨æˆ–ç”±äºæŸç§åŸå› æ— æ³•è®¿é—®ï¼Œå°†å¼•å‘é”™è¯¯ã€‚
3.  åŸºäºåˆ†æçš„æ•°æ®è¿”å›æ ¼å¼åŒ–çš„å¯¹è±¡ã€‚

```
// loadenv.jsconst { config } = require('dotenv');module.exports = () => {
  const env = config({  // (1)
    path: `./.env.${process.env.NODE_ENV || 'development'}`,
  }); if (env.error) {  // (2)
    throw env.error;
  } return {  // (3)
    server: {
      port: parseInt(env.parsed.SERVER_PORT, 10),
    },
  };
};
```

è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåä¸º`index.js`çš„è„šæœ¬ï¼Œå®ƒå¯¼å…¥é…ç½®åŠ è½½å™¨æ¨¡å—å¹¶è®°å½•è°ƒç”¨å®ƒæ—¶è¿”å›çš„å¯¹è±¡ã€‚

```
// index.jsconst Env = require('./loadenv');try {
  const env = Env();
  console.log(env);
} catch(error) {
  console.error(error);
  process.exit(1);
}
```

æœ€åï¼Œè®©æˆ‘ä»¬é€šè¿‡åœ¨ç»ˆç«¯çª—å£ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥æµ‹è¯•åŠ è½½å™¨æ¨¡å—ï¼Œè¿™å°†æ ¹æ®æŒ‰ç…§`NODE_ENV`ç¯å¢ƒå˜é‡å®šä¹‰çš„éƒ¨ç½²ç¯å¢ƒæ‰“å°å‡ºæ­£ç¡®çš„`SERVER_PORT`å€¼ã€‚

```
$ NODE_ENV=development node index.js
{ server: { port: 3000 } }
$ NODE_ENV=production node index.js
{ server: { port: 80 } }
$ node index.js
{ server: { port: 3000 } }
```

ç°åœ¨ï¼Œæ‚¨å¯ä»¥è½»æ¾åœ°å°†æ–°å˜é‡æ·»åŠ åˆ°é…ç½®æ–‡ä»¶ä¸­ã€‚

```
# .env.developmentSERVER_PORT=3000
DATABASE_NAME=project
DATABASE_USER=user
DATABASE_PASSWORD=password
```

å¹¶åœ¨ç”±é…ç½®åŠ è½½å™¨è¿”å›çš„å¯¹è±¡å†…çš„å…¬å…±å…³é”®å­—ä¸‹å¯¹å®ƒä»¬è¿›è¡Œé‡æ–°åˆ†ç»„ã€‚

```
// loadenv.js// ...
return {
  server: {
    port: parseInt(env.parsed.SERVER_PORT, 10),
  },
  database: {
    name: env.parsed.DATABASE_NAME,
    user: env.parsed.DATABASE_USER,
    password: env.parsed.DATABASE_PASSWORD,
  },
};
```

# ä¸‹ä¸€æ­¥æ˜¯ä»€ä¹ˆï¼Ÿ

ğŸ‘‰ä½ å–œæ¬¢è¿™ç§å†…å®¹ï¼Ÿè¯·æŸ¥çœ‹æœ¬ä¹¦ [***æ„å»ºåˆ†å±‚å¾®æœåŠ¡***](https://learnbackend.dev) ï¼Œç½‘å€ä¸º [https://learnbackend.dev](https://learnbackend.dev) äº†è§£å¦‚ä½•ä½¿ç”¨ Express framework æ„å»ºç”Ÿäº§å°±ç»ªçš„åˆ†å±‚è®¤è¯å¾®æœåŠ¡ï¼Œä»ç¬¬ä¸€è¡Œä»£ç åˆ°æœ€åä¸€è¡Œæ–‡æ¡£ï¼Œè¯¥æœåŠ¡åœ¨å¼€å‘å®è·µå’Œè½¯ä»¶æ¶æ„æ–¹é¢ç¬¦åˆè¡Œä¸šæ ‡å‡†ã€‚