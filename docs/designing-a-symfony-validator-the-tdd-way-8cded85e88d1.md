# 用 TDD 方法设计 Symfony 验证器

> 原文：<https://blog.devgenius.io/designing-a-symfony-validator-the-tdd-way-8cded85e88d1?source=collection_archive---------1----------------------->

## 如何在 PHP 中应用测试驱动开发技术的实例。

![](img/df428b90c6d01db9ee598c11c17f6e91.png)

你熟悉测试驱动开发吗？你们大多数人可能都是。著名的马丁·福勒在他的网站上对 *TDD* 方法[有一个很好的定义:](https://martinfowler.com/bliki/TestDrivenDevelopment.html)

> 测试驱动开发(TDD)是一种构建软件的技术，它通过编写测试来指导软件开发。它是由 Kent Beck 在 20 世纪 90 年代后期开发的，是极限编程的一部分。本质上，你重复遵循三个简单的步骤:
> 
> 1.为您想要添加的下一个功能编写一个测试。
> 2。编写功能代码，直到测试通过。
> 3。重构新旧代码，使其结构良好。

你可能会问，这种技术实际上有用吗？确实是！总之在某些情况下。当我要写一段包含了大量输入数学运算的代码时，我个人总是遵循这个策略。

一个完美的例子是任何种类的计算器。例如，增值税计算器。我们可以从一个测试开始:

为了正确应用 TDD，我们应该:

1.  执行测试并确保它没有通过，
2.  编写代码，让这个测试尽可能快地变绿
3.  最后，重构它，使代码美观且易于理解

真正的交易！让我们改变一下，写点有用的东西吧。我们的产品负责人将一项任务放在了待办事项中。他说我们公司页面的注册表格很糟糕，因为每当有人想要注册，而他已经注册了，就会显示一个令人讨厌的错误页面。他想阻止这一点，而是描绘了一个错误，即“电子邮件地址已被占用”。

由于用于注册的对象是一个表单使用的简单 DTO，我们将添加一个新的注释约束和一个伴随的验证器。让我们把这个约束叫做*EmailAddressNotRegistered*。

让我们从一系列的单元测试开始，然后我们希望发生什么。由于验证器需要访问数据库，我们将模拟用户存储库并注入一个假对象——用户存储库的内存实现。要求以下功能:

*   它不能允许已经注册的电子邮件地址
*   它也不能允许已经注册的地址的别名
*   它必须允许未注册的电子邮件
*   它必须允许软删除用户的注册电子邮件

编写以下单元测试是为了确保该类符合这些要求。我使用了 Symfony 的`ConstraintValidatorTestCase`,它允许简单的验证器测试:

我们执行了这个测试，结果失败了。果然，我们仍然没有约束和验证器:

```
PHPUnit 8.5.23 by Sebastian Bergmann and contributors.EEEE                                                                4 / 4 (100%)Time: 34 ms, Memory: 4.00 MB
```

我们需要约束:

和验证器来确保测试尽可能轻松地通过:

当我们现在运行测试套件时:

```
....                                                    4 / 4 (100%)Time: 34 ms, Memory: 4.00 MBOK (4 tests, 6 asto easily test a validator:sertions)
```

我们是绿色的！现在让我们也重构代码:

最终测试套件运行，以及…

```
....                                                   4 / 4 (100%)Time: 37 ms, Memory: 4.00 MBOK (4 tests, 6 assertions)
```

现在，我们可以在注册 DTO 上安全地使用此约束，并将任务标记为完成。

希望这能让我们的产品负责人感到高兴。

![](img/8e115c6f8dc32ff69b4dab4df0327198.png)

顺便说一下，代码发布在了 GitHub 的一个库上。如果你有 Docker，你可以立刻运行整个测试套件。编码快乐！

赞美诗我使用的编码技术在下面的出版物中有描述，请务必阅读:

[](/clean-code-tricks-in-php-everyone-should-follow-f9d7aa3abe44) [## PHP 中每个人都应该遵循的干净代码技巧

### 用这几个简单的技巧彻底改进你的代码。今天我想和你分享我的编码技术。

blog.devgenius.io](/clean-code-tricks-in-php-everyone-should-follow-f9d7aa3abe44) 

**快速提问:**这个故事*对你有价值吗*？请留下**的掌声**以示感谢，支持我的工作。谢谢你。