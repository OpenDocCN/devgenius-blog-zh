<html>
<head>
<title>Part Two : Security in React and WebApi in ASP.NET Core C# with authentication and authorization by KeyCloak</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">第二部分:React 中的安全性和 ASP.NET 核心 C#中的 WebApi，通过 KeyCloak 进行认证和授权</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/security-in-react-and-webapi-in-asp-net-core-c-with-authentification-and-authorization-by-keycloak-89ba14be7e5a?source=collection_archive---------0-----------------------#2022-05-29">https://blog.devgenius.io/security-in-react-and-webapi-in-asp-net-core-c-with-authentification-and-authorization-by-keycloak-89ba14be7e5a?source=collection_archive---------0-----------------------#2022-05-29</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="d70a" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated"><strong class="ak">第二部分:保护前端反应</strong>应用<br/> <strong class="ak">版本 1.0 <br/>日期 2022/05/29 <br/>作者 Nicolas Barlatier </strong></h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi kc"><img src="../Images/a3155cdd480ccdbb4046db674092c91a.png" data-original-src="https://miro.medium.com/v2/resize:fit:714/0*Pbv9yht8PVFsyKZs"/></div></figure><p id="0606" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">如果你错过了第一部分:<br/> <a class="ae lg" href="https://medium.com/p/1d076777a979" rel="noopener">第一部分:用 Docker 和 Administration 安装 key cloak</a></p><p id="392d" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">下一部分可用:<br/> <a class="ae lg" href="https://medium.com/@barlatiernicolas/security-in-react-and-webapi-in-asp-net-core-c-with-authentification-and-authorization-by-keycloak-f890d340d093" rel="noopener">第三部分:保护 ASP.NET 核心 C# REST Web </a></p><p id="4830" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">最后第四部分:<br/> <a class="ae lg" href="https://medium.com/@barlatiernicolas/part-four-security-in-react-and-webapi-in-asp-net-b6dffd3b7624" rel="noopener">第四部分:使用访问 JWT 令牌载体授权从 React SPA 调用受保护的 Web API</a></p><p id="879b" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">要在 Docker 中使用<strong class="km io">前端 React 应用程序，您可以阅读:</strong></p><p id="5da6" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated"><a class="ae lg" href="https://medium.com/@barlatiernicolas/dockerizing-the-typescript-react-app-with-nodejs-vs-nginx-with-wsl2-alpine-linux-on-windows-10-8dddd447f43a" rel="noopener">第一部分将 TypeScript React App 与 NodeJS 和 NGINX 与 Windows 10 上的 WSL2 Alpine Linux 进行对比</a></p></div><div class="ab cl lh li hr lj" role="separator"><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm"/></div><div class="ig ih ii ij ik"><p id="d81d" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">包含 React 和 Web API 项目的 GitHub 存储库</p><ul class=""><li id="8f04" class="lo lp in km b kn ko kq kr kt lq kx lr lb ls lf lt lu lv lw bi translated"><strong class="km io">React 18 . 1 . 0 版带打字稿</strong></li><li id="ad8d" class="lo lp in km b kn lx kq ly kt lz kx ma lb mb lf lt lu lv lw bi translated"><strong class="km io">采用 ASP.NET 核心 5.0 的网络应用编程接口</strong></li></ul><div class="mc md gp gr me mf"><a href="https://github.com/nicoclau/reactwebapiaspnetcorekeycloak" rel="noopener  ugc nofollow" target="_blank"><div class="mg ab fo"><div class="mh ab mi cl cj mj"><h2 class="bd io gy z fp mk fr fs ml fu fw im bi translated">GitHub—nicoclau/reactwebapiaspnetcorekeycloak:React 和 REST 受 keycloak 保护的 Web API 与…</h2><div class="mm l"><h3 class="bd b gy z fp mk fr fs ml fu fw dk translated">React 和 REST Web API 由带有授权代码流和 JWT 令牌的 Keycloak 保护— GitHub …</h3></div><div class="mn l"><p class="bd b dl z fp mk fr fs ml fu fw dk translated">github.com</p></div></div><div class="mo l"><div class="mp l mq mr ms mo mt ki mf"/></div></div></a></div><p id="d744" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">您有两个提交:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi mu"><img src="../Images/38a6e19aea67aef3f2d66e21b54cde1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1242/format:webp/1*j7erUTzcaMTRKGUaGI49-Q.png"/></div></figure><p id="25eb" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">第一次提交包含:</p><ul class=""><li id="a74a" class="lo lp in km b kn ko kq kr kt lq kx lr lb ls lf lt lu lv lw bi translated">由 keycloak 服务器保护的 React SPA</li><li id="2d3b" class="lo lp in km b kn lx kq ly kt lz kx ma lb mb lf lt lu lv lw bi translated">Web API 由访问令牌保护，使用来自 keycloak 服务器的公钥进行验证</li></ul><p id="3578" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">这两个应用程序还没有通信，它们只是受到保护。</p><p id="4b0e" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">第二次提交包含:</p><ul class=""><li id="991a" class="lo lp in km b kn ko kq kr kt lq kx lr lb ls lf lt lu lv lw bi translated">React SPA 使用 JWT 令牌与 Web API 通信，并处理 CORS 策略</li></ul></div><div class="ab cl lh li hr lj" role="separator"><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm"/></div><div class="ig ih ii ij ik"><h1 id="7445" class="mv mw in bd mx my mz na nb nc nd ne nf jt ng ju nh jw ni jx nj jz nk ka nl nm bi translated">介绍</h1><p id="4a6c" class="pw-post-body-paragraph kk kl in km b kn nn jo kp kq no jr ks kt np kv kw kx nq kz la lb nr ld le lf ig bi translated">本文将向您展示如何通过认证和授权来保护一个前端 React 单页面应用程序。</p><p id="543d" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">它将被分成<strong class="km io">三个主要部分:</strong></p><ul class=""><li id="969a" class="lo lp in km b kn ko kq kr kt lq kx lr lb ls lf lt lu lv lw bi translated"><strong class="km io">了解 OAuth 2.0 和 OpenID 连接协议的流程</strong>和<strong class="km io">什么流程最适合我们的 SPA React 应用</strong></li><li id="4456" class="lo lp in km b kn lx kq ly kt lz kx ma lb mb lf lt lu lv lw bi translated"><strong class="km io">通过<strong class="km io">在 React 中添加 Keycloak Javascript 适配器</strong>来保护我们的 SPA React 应用程序</strong></li><li id="e8ac" class="lo lp in km b kn lx kq ly kt lz kx ma lb mb lf lt lu lv lw bi translated">如何在带有自定义 KeyCloakService 的应用程序中正确使用 Keycloak Javascript 适配器</li></ul><p id="8f5c" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">第一步是<strong class="km io">在 keycloak </strong>中注册一个“客户端”,它代表我们要保护的应用程序(参见第一部分记住如何:<a class="ae lg" href="https://medium.com/p/1d076777a979" rel="noopener">第一部分:用 Docker 和 Administration </a>安装 keycloak)</p><p id="5085" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们可以在下面看到关于 keycloak 中“客户端”概念的详细部分:</p><div class="mc md gp gr me mf"><a href="https://www.keycloak.org/docs/latest/server_admin/index.html#assembly-managing-clients_server_administration_guide" rel="noopener  ugc nofollow" target="_blank"><div class="mg ab fo"><div class="mh ab mi cl cj mj"><h2 class="bd io gy z fp mk fr fs ml fu fw im bi translated">服务器管理指南</h2><div class="mm l"><h3 class="bd b gy z fp mk fr fs ml fu fw dk translated">用户用户是能够登录到您的系统的实体。它们可以有与自身相关的属性…</h3></div><div class="mn l"><p class="bd b dl z fp mk fr fs ml fu fw dk translated">www.keycloak.org</p></div></div><div class="mo l"><div class="ns l mq mr ms mo mt ki mf"/></div></div></a></div><p id="a13b" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们需要记住的是:</p><blockquote class="nt nu nv"><p id="8a26" class="kk kl nw km b kn ko jo kp kq kr jr ks nx ku kv kw ny ky kz la nz lc ld le lf ig bi translated"><strong class="km io">客户端是可以请求用户认证的实体。</strong></p></blockquote><p id="151c" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">当我们创建我们的<strong class="km io">客户端</strong>时，我们必须意识到<strong class="km io"> Keycloak </strong>自动将<strong class="km io">客户端</strong>与默认的<strong class="km io">流</strong>相关联，这将在稍后详述。</p><p id="6336" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">记得当我们创建客户端时，选择了协议<strong class="km io"> OpendId Connect </strong>。</p><h1 id="fc1d" class="mv mw in bd mx my oa na nb nc ob ne nf jt oc ju nh jw od jx nj jz oe ka nl nm bi translated">OAuth 2.0 和 OpendId 连接流</h1><p id="f95c" class="pw-post-body-paragraph kk kl in km b kn nn jo kp kq no jr ks kt np kv kw kx nq kz la lb nr ld le lf ig bi translated">因此，我们需要更好地理解不同的<strong class="km io">流程</strong>,包括:</p><ul class=""><li id="f4f4" class="lo lp in km b kn ko kq kr kt lq kx lr lb ls lf lt lu lv lw bi translated"><strong class="km io"> OAuth 2.0 </strong></li><li id="53c5" class="lo lp in km b kn lx kq ly kt lz kx ma lb mb lf lt lu lv lw bi translated">OpenId 连接。</li></ul><p id="6fbf" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们需要了解他们的目的是什么，这样我们才能选择适当的流程来保护我们的前端 React 应用程序，以及为什么它是最佳选择！</p><h1 id="01d6" class="mv mw in bd mx my oa na nb nc ob ne nf jt oc ju nh jw od jx nj jz oe ka nl nm bi translated"><strong class="ak"> <em class="of"> OAuth 流程</em> </strong></h1><p id="5a3c" class="pw-post-body-paragraph kk kl in km b kn nn jo kp kq no jr ks kt np kv kw kx nq kz la lb nr ld le lf ig bi translated">OAuth 2.0 协议中的流实际上被称为“授权类型”</p><ul class=""><li id="df06" class="lo lp in km b kn ko kq kr kt lq kx lr lb ls lf lt lu lv lw bi translated"><a class="ae lg" href="https://oauth.net/2/grant-types/authorization-code/" rel="noopener ugc nofollow" target="_blank">授权码</a>:授权码授予类型用于<strong class="km io">机密客户端和公共客户端</strong>将<strong class="km io">授权码</strong>兑换成<strong class="km io">访问令牌</strong>。在用户通过<strong class="km io">重定向 URL </strong>返回客户端后，应用程序将从 URL 获取<strong class="km io">授权码</strong>，并使用<strong class="km io">请求访问令牌</strong>。</li><li id="0632" class="lo lp in km b kn lx kq ly kt lz kx ma lb mb lf lt lu lv lw bi translated"><a class="ae lg" href="https://oauth.net/2/pkce/" rel="noopener ugc nofollow" target="_blank"> PKCE </a>:是<a class="ae lg" href="https://oauth.net/2/grant-types/authorization-code/" rel="noopener ugc nofollow" target="_blank">授权代码流</a>的扩展，防止<strong class="km io"> CSRF </strong>和<strong class="km io">授权代码注入攻击</strong>。</li><li id="bb68" class="lo lp in km b kn lx kq ly kt lz kx ma lb mb lf lt lu lv lw bi translated"><a class="ae lg" href="https://auth0.com/docs/get-started/authentication-and-authorization-flow#implicit-flow-with-form-post" rel="noopener ugc nofollow" target="_blank">带表单 Post </a>的隐式流程:用于<strong class="km io">公共客户端</strong>，或<strong class="km io">无法安全存储客户端机密的应用。</strong></li><li id="71c2" class="lo lp in km b kn lx kq ly kt lz kx ma lb mb lf lt lu lv lw bi translated"><a class="ae lg" href="https://oauth.net/2/grant-types/client-credentials/" rel="noopener ugc nofollow" target="_blank">客户端凭证</a>:被<strong class="km io">客户端</strong>用来获取用户上下文之外的<strong class="km io">访问令牌</strong>。这通常由客户端用来访问关于它们自己的资源，而不是访问用户的资源。== &gt;我们稍后会更好地解释这是什么意思。</li><li id="04c4" class="lo lp in km b kn lx kq ly kt lz kx ma lb mb lf lt lu lv lw bi translated"><a class="ae lg" href="https://oauth.net/2/grant-types/device-code/" rel="noopener ugc nofollow" target="_blank">设备代码</a>:由<a class="ae lg" href="https://oauth.net/2/device-flow/" rel="noopener ugc nofollow" target="_blank">设备流程</a>中的无浏览器或输入受限设备使用，用于将之前获得的设备代码交换为访问令牌。</li><li id="1115" class="lo lp in km b kn lx kq ly kt lz kx ma lb mb lf lt lu lv lw bi translated"><a class="ae lg" href="https://oauth.net/2/grant-types/refresh-token/" rel="noopener ugc nofollow" target="_blank">刷新令牌</a>:当访问令牌过期时，客户端使用刷新令牌交换访问令牌。这允许客户端继续拥有有效的访问令牌，而无需与用户进一步交互。</li></ul><p id="deb4" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated"><strong class="km io">如果我们没记错的话，我们实际上使用的是基于 OAuth 2.0 的 procotol OpenId Connect </strong>。</p><p id="e3a0" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">因此，我们需要查看可用的 OpenId 连接流。</p><h1 id="c590" class="mv mw in bd mx my oa na nb nc ob ne nf jt oc ju nh jw od jx nj jz oe ka nl nm bi translated"><strong class="ak"> <em class="of"> OpenId 连接流程</em> </strong></h1><p id="e39d" class="pw-post-body-paragraph kk kl in km b kn nn jo kp kq no jr ks kt np kv kw kx nq kz la lb nr ld le lf ig bi translated"><strong class="km io"><em class="nw">OpenId Connect</em></strong>定义了可用于认证用户的四个主要流程:</p><ul class=""><li id="f032" class="lo lp in km b kn ko kq kr kt lq kx lr lb ls lf lt lu lv lw bi translated"><strong class="km io">授权代码流</strong>对于基于浏览器的应用，如 SPAs(单页应用)或服务器端应用== &gt;我们将使用此选项</li><li id="c0aa" class="lo lp in km b kn lx kq ly kt lz kx ma lb mb lf lt lu lv lw bi translated"><strong class="km io">隐式流</strong>针对基于浏览器的应用，安全性不如上一个，OAuth 2.1 中不推荐和弃用；</li><li id="31c9" class="lo lp in km b kn lx kq ly kt lz kx ma lb mb lf lt lu lv lw bi translated">对于像 web 服务这样的 REST 客户端，它涉及到存储一个秘密，所以客户端应该是可信的；</li><li id="92ec" class="lo lp in km b kn lx kq ly kt lz kx ma lb mb lf lt lu lv lw bi translated"><strong class="km io">资源所有者密码凭证授权</strong>对于 REST 客户端，如与大型机的接口和其他不支持现代认证协议的遗留系统，它涉及到与另一个服务共享凭证，请注意。</li></ul><p id="b9ff" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">还记得我们创建客户端时，我们</p><ul class=""><li id="2c41" class="lo lp in km b kn ko kq kr kt lq kx lr lb ls lf lt lu lv lw bi translated">设置名称:MyApp</li><li id="1161" class="lo lp in km b kn lx kq ly kt lz kx ma lb mb lf lt lu lv lw bi translated"><strong class="km io">客户端协议:openid-connect，因此我们必须根据协议流进行推理</strong></li><li id="da13" class="lo lp in km b kn lx kq ly kt lz kx ma lb mb lf lt lu lv lw bi translated">根目录 UR:http://locah host:3000</li></ul><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi og"><img src="../Images/2b5a8cd9017e5af247018ae2347e7083.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BFaRr3Qyn9Edo4ixl6BNpw.png"/></div></div><figcaption class="ol om gj gh gi on oo bd b be z dk translated">创建新客户端</figcaption></figure><h2 id="ff45" class="op mw in bd mx oq or dn nb os ot dp nf kt ou ov nh kx ow ox nj lb oy oz nl pa bi translated">我们将看到下面的页面，<strong class="ak">我们将突出显示需要了解的 6 个重要部分。</strong></h2><h1 id="b343" class="mv mw in bd mx my oa na nb nc ob ne nf jt oc ju nh jw od jx nj jz oe ka nl nm bi translated">客户端管理和流程</h1><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi pb"><img src="../Images/69250d5c08a167ccff057e98c6715a8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sLG1z0q3KDNKcVwDyBIv8w.png"/></div></div><figcaption class="ol om gj gh gi on oo bd b be z dk translated">keycloak 自动设置的 6 个主要部分。我们必须掌握它们，这样我们才能知道幕后发生了什么。</figcaption></figure><p id="99fe" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">默认情况下，这些零件会显示键盘锁:</p><ul class=""><li id="0eae" class="lo lp in km b kn ko kq kr kt lq kx lr lb ls lf lt lu lv lw bi translated">第 1 部分) :将<strong class="km io">客户端设置为 Enabled </strong>:这样客户端就可以发起或不发起登录并取回<strong class="km io">访问令牌</strong></li><li id="edab" class="lo lp in km b kn lx kq ly kt lz kx ma lb mb lf lt lu lv lw bi translated">第二部分):将<strong class="km io">访问类型</strong>设置为<strong class="km io">“公共”</strong>，用于<strong class="km io">前端公共客户端无法安全存储秘密</strong>发起登录。<br/>例如，我们的 SPA react 应用程序是一个公共应用程序，因为 javascript 代码直接交付给用户的浏览器。我们很难认为将秘密存储在 js 文件中是安全的！</li></ul><blockquote class="nt nu nv"><p id="9392" class="kk kl nw km b kn ko jo kp kq kr jr ks nx ku kv kw ny ky kz la nz lc ld le lf ig bi translated">我们在谈论什么秘密？该秘密用于授权代码流，其中客户端通过在请求中发送带有<strong class="km io">秘密</strong>的授权代码来用<strong class="km io">授权代码</strong>交换<strong class="km io">访问令牌</strong>。在我们的例子中，这个秘密不会被使用，但是我们将使用<strong class="km io">valid Redirect URIs 来确保没有任何 SPA </strong>到达 Keycloak 服务器。</p></blockquote><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi pc"><img src="../Images/550f68def008a614215791c21b6d4054.png" data-original-src="https://miro.medium.com/v2/resize:fit:556/format:webp/1*tUkAlw6d-7uzammzaIpS8Q.png"/></div><figcaption class="ol om gj gh gi on oo bd b be z dk translated">访问类型:公共</figcaption></figure><p id="d5d4" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">如果我们将访问类型更改为“<strong class="km io">机密</strong>”，我们将获得以下红色的新字段</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi pd"><img src="../Images/591c3e7df81033fee2593e86236a7f70.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M37bDwCIg8yuom9r-4RiMg.png"/></div></div><figcaption class="ol om gj gh gi on oo bd b be z dk translated">新字段:服务帐户，OIDC·CIBA 授权，授权已启用</figcaption></figure><p id="59e7" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">只有<strong class="km io">服务账户</strong>是重要的:如果启用，我们实际上使用的是“<strong class="km io">客户端凭证授权</strong>”。<br/> <strong class="km io">服务账号对公共客户端不可用，因为没有可用的秘密。</strong></p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi pe"><img src="../Images/5e4939a07ad6f2660e3b2a7e9191c8c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:688/format:webp/1*rja5_Crol84jJg-Tf_t8kg.png"/></div><figcaption class="ol om gj gh gi on oo bd b be z dk translated">它允许我们使用"<strong class="bd mx">客户凭证 Gran </strong> t "</figcaption></figure><p id="e6c6" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">为了理解“授权码授权类型流”和“客户端凭证流”之间的区别，请参见图表:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi pf"><img src="../Images/6949ad259978688df65cb11e08180bea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nR_V4SS14CWJu4tIMqqc6g.png"/></div></div><figcaption class="ol om gj gh gi on oo bd b be z dk translated">授权码授予</figcaption></figure><p id="4c88" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">资源所有者访问应用程序，我们有 2 个步骤:</p><ul class=""><li id="d761" class="lo lp in km b kn ko kq kr kt lq kx lr lb ls lf lt lu lv lw bi translated">步骤 1:身份验证和授权，将授权代码返回给应用程序</li><li id="e15b" class="lo lp in km b kn lx kq ly kt lz kx ma lb mb lf lt lu lv lw bi translated">步骤 2:应用程序发送授权代码来获取访问令牌</li><li id="4156" class="lo lp in km b kn lx kq ly kt lz kx ma lb mb lf lt lu lv lw bi translated">当我们有一个资源所有者(用户)时使用它</li></ul><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi pg"><img src="../Images/44a471aa939149ec514ae71672661067.png" data-original-src="https://miro.medium.com/v2/resize:fit:1146/format:webp/1*hbeynGCDSmSLmiBlQ5F6Eg.png"/></div><figcaption class="ol om gj gh gi on oo bd b be z dk translated">客户端凭据流</figcaption></figure><p id="0c11" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">这里我们没有资源所有者，它是机器之间的直接通信，所以我们只有一个步骤:<strong class="km io">我们发送客户端 ID 和秘密</strong>，我们直接从授权服务器(这里是 Keycloak)取回<strong class="km io">访问令牌</strong></p><blockquote class="nt nu nv"><p id="c95d" class="kk kl nw km b kn ko jo kp kq kr jr ks nx ku kv kw ny ky kz la nz lc ld le lf ig bi translated">此客户端凭据流适用于可以请求访问令牌并自行访问资源的应用程序。这些应用通常使用在没有用户的情况下调用 API 的服务。</p></blockquote><p id="675e" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">当我们使用“机密”客户端类型并单击“保存”时，我们将在我们的客户端 MyApp 页面中获得一个名为“凭证”的新选项卡</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi ph"><img src="../Images/8fcdfb4860b03d34ada80357c2b43d1a.png" data-original-src="https://miro.medium.com/v2/resize:fit:328/format:webp/1*2mZHhb2do6nOqzwVbawjLQ.png"/></div></figure><p id="50d7" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们在这里得到了秘密</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi pi"><img src="../Images/c82b86cdab441fb70392af1160fdc3f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XaT2T-mb62ER8FDvw1QgOQ.png"/></div></div></figure><p id="84cc" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">所以当我们有一个应用程序可以在服务器上安全地保存<strong class="km io"> clientid </strong>和<strong class="km io"> secret </strong>时，我们可以使用“<strong class="km io">secret</strong>客户端，并在 A <strong class="km io">授权代码流</strong>中使用“<strong class="km io"> client id </strong>和“<strong class="km io"> secret </strong>”。</p><blockquote class="nt nu nv"><p id="9396" class="kk kl nw km b kn ko jo kp kq kr jr ks nx ku kv kw ny ky kz la nz lc ld le lf ig bi translated">这个秘密只有应用程序和授权服务器知道。这是应用程序自己的密码。</p></blockquote><p id="a2e7" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">基本上，当我们的用户需要公共应用程序的认证和授权时:我们使用<strong class="km io">授权代码</strong>流和<strong class="km io">登录/密码</strong>。该流程由第 3 部分的<strong class="km io">标准流程</strong>启用。</p><ul class=""><li id="2fb9" class="lo lp in km b kn ko kq kr kt lq kx lr lb ls lf lt lu lv lw bi translated">Part 3):启用<strong class="km io">“标准流程”</strong>:基于重定向的标准 OpenID Connect 认证，授权码<strong class="km io"/>。<br/>用于启用“授权代码流”,稍后将对其进行说明。<br/> <strong class="km io">正是这个授权流将用于保护我们的前端 React SPA。我们稍后会解释原因。</strong></li></ul><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi pj"><img src="../Images/cd1ffe62656f5a6cff05d84c8c17ba84.png" data-original-src="https://miro.medium.com/v2/resize:fit:650/format:webp/1*fPl0IwAYK8zsyEzBfndOwg.png"/></div><figcaption class="ol om gj gh gi on oo bd b be z dk translated">标准流程:使用<strong class="bd mx"> OpenID 连接协议</strong>启用<strong class="bd mx">授权流程</strong></figcaption></figure><ul class=""><li id="f387" class="lo lp in km b kn ko kq kr kt lq kx lr lb ls lf lt lu lv lw bi translated">第 4 部分):启用了<strong class="km io">“直接访问授权”</strong>，其中客户端(我们的应用程序)可以获取并使用用户 l <strong class="km io"> ogin/pwd </strong>直接从 Keycloak 获取<strong class="km io">访问令牌</strong>。在 OAuth 2.0 中，它类似于启用"<strong class="km io">资源所有者密码凭证授权</strong>"</li></ul><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi pk"><img src="../Images/e5c2aad23dafe2f8681a0a49b0a7785d.png" data-original-src="https://miro.medium.com/v2/resize:fit:882/format:webp/1*5BEiIdIkcCQnLTp5i1he-Q.png"/></div></figure><p id="087d" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">在我们完成这一部分后，我们将看到当我们禁用此流时会发生什么。</p><ul class=""><li id="c6d3" class="lo lp in km b kn ko kq kr kt lq kx lr lb ls lf lt lu lv lw bi translated">第 5 部分):添加了我们的带有通配符* <br/> <a class="ae lg" href="http://localhost:3000/*" rel="noopener ugc nofollow" target="_blank">的 SPA URL http://localhost:3000/*</a>为<strong class="km io">valid Redirect URIs</strong><br/>我们将看到保护我们的公共客户端确实非常重要。<br/>链接越精确，越安全。因为公共客户端不能存储授权代码流中使用的秘密，所以我们需要这种保护来避免另一个网站访问访问令牌！如果 url 与 keycloak 不匹配，将返回以下错误:</li></ul><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi pl"><img src="../Images/70fa86a595502721fa5e4281e42742a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OsYVsFAgBAPk3vhpxhIrIg.png"/></div></div><figcaption class="ol om gj gh gi on oo bd b be z dk translated">当未经授权的网站 url 试图连接到 keycloak 服务器时</figcaption></figure><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi pm"><img src="../Images/8d5f16424fe7d7a4b1409c4ad4c6174e.png" data-original-src="https://miro.medium.com/v2/resize:fit:746/format:webp/1*84pF0h_TSiVGyp96j6VJ1w.png"/></div></figure><p id="c7ce" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们可以在下面的链接中看到补充解释:</p><div class="mc md gp gr me mf"><a href="https://www.thomasvitale.com/keycloak-authentication-flow-sso-client/" rel="noopener  ugc nofollow" target="_blank"><div class="mg ab fo"><div class="mh ab mi cl cj mj"><h2 class="bd io gy z fp mk fr fs ml fu fw im bi translated">Keycloak 身份验证流程、SSO 协议和客户端配置</h2><div class="mm l"><h3 class="bd b gy z fp mk fr fs ml fu fw dk translated">在本文中，我将介绍认证流的概念。然后，我将简单地提一下…</h3></div><div class="mn l"><p class="bd b dl z fp mk fr fs ml fu fw dk translated">www.thomasvitale.com</p></div></div><div class="mo l"><div class="pn l mq mr ms mo mt ki mf"/></div></div></a></div><blockquote class="nt nu nv"><p id="5235" class="kk kl nw km b kn ko jo kp kq kr jr ks nx ku kv kw ny ky kz la nz lc ld le lf ig bi translated">由于对客户端的访问将是公开的，出于<a class="ae lg" href="http://www.keycloak.org/docs/latest/server_admin/index.html#_unspecific-redirect-uris" rel="noopener ugc nofollow" target="_blank">安全原因</a>，我们必须通过正确设置重定向 URIs 来限制它。Keycloak 从<em class="in">根 URL </em>自动生成它们，但是我们可以添加更多。我们越具体越好。</p></blockquote><ul class=""><li id="6c2b" class="lo lp in km b kn ko kq kr kt lq kx lr lb ls lf lt lu lv lw bi translated">第 6 部分):添加了应用程序的 URI。</li></ul><blockquote class="nt nu nv"><p id="e928" class="kk kl nw km b kn ko jo kp kq kr jr ks nx ku kv kw ny ky kz la nz lc ld le lf ig bi translated">该选项处理<a class="ae lg" href="https://fetch.spec.whatwg.org/" rel="noopener ugc nofollow" target="_blank">跨产地资源共享(CORS) </a>。如果浏览器 JavaScript 试图向服务器发出 AJAX HTTP 请求，而该服务器的域与 JavaScript 代码来自的域不同，则该请求必须使用 CORS。服务器必须处理 CORS 请求，否则浏览器不会显示或允许处理请求。该协议可以抵御 XSS、CSRF 和其他基于 JavaScript 的攻击。</p></blockquote><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi po"><img src="../Images/7ea2866e2e3489095a5ad7f359486220.png" data-original-src="https://miro.medium.com/v2/resize:fit:694/format:webp/1*CiS8E9NgkJ0tzJEwuOdTVQ.png"/></div></figure><p id="9ca1" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">所以基本上 keycloak 为我们提供了以下两个流程:</p><ul class=""><li id="dd96" class="lo lp in km b kn ko kq kr kt lq kx lr lb ls lf lt lu lv lw bi translated"><strong class="km io">授权代码流</strong>不使用 secret(公共客户端)<br/>我们将使用用户的登录名和密码。</li><li id="1f60" class="lo lp in km b kn lx kq ly kt lz kx ma lb mb lf lt lu lv lw bi translated"><strong class="km io">资源所有者密码凭证授予</strong></li></ul><p id="19a6" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">希望这一部分没有混淆，如果你需要更多的细节，请发邮件给我。</p><p id="3840" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">让我们看看如果禁用<strong class="km io">资源所有者密码凭证授权会发生什么。</strong></p><p id="97ee" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们可以看到，一旦 Keycloak 服务器验证了 login/pwd，就会直接颁发访问令牌。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi pp"><img src="../Images/7ef2f3c0ed512e935fa66a4c0cf37469.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*J5FROrxq3Ygcz7DK.png"/></div></div><figcaption class="ol om gj gh gi on oo bd b be z dk translated"><strong class="bd mx">资源所有者密码凭证授予图</strong></figcaption></figure><p id="fc76" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">让我们打开我们的 Insomia API 客户端应用程序并发送我们的请求:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi pq"><img src="../Images/140edc4f55d74c19674b58b93dbb37c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xZlAwzzHg4gSrMZalzqdDA.png"/></div></div><figcaption class="ol om gj gh gi on oo bd b be z dk translated">授予资源所有者口令身份证明</figcaption></figure><p id="943d" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们发出了请求</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi pr"><img src="../Images/ee33252b9dd24fd1e70e35f0cc27ab7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1392/format:webp/1*kYMT4B05_Vt1UeeA6l8ETQ.png"/></div></figure><p id="6d92" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们发送:</p><ul class=""><li id="8678" class="lo lp in km b kn ko kq kr kt lq kx lr lb ls lf lt lu lv lw bi translated">grant_type:应用授权类型(或流)是应用可以通过其获得<a class="ae lg" href="https://auth0.com/docs/secure/tokens/access-tokens" rel="noopener ugc nofollow" target="_blank">访问令牌</a>的方法</li></ul><p id="5190" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">以下是可能值的列表:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi ps"><img src="../Images/c24ff66ea24df1c0f9ce5678a2277b9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HGAY4DTcfGnzQqGKpxQWCA.png"/></div></div></figure><p id="0d9a" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们必须意识到，只有高度可信的应用程序才能使用资源所有者密码流。</p><p id="ee48" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">让我们在服务器上禁用这个流:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi pt"><img src="../Images/34ca48497d0f52b4472c7de2a1323e1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:926/format:webp/1*ecwQJuK2rV7p8gHebB1Kug.png"/></div><figcaption class="ol om gj gh gi on oo bd b be z dk translated">关闭直接访问授权</figcaption></figure><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi pu"><img src="../Images/8141957b356102a52c8fc9f1d066aed6.png" data-original-src="https://miro.medium.com/v2/resize:fit:986/format:webp/1*aS5QbljheY97CLdUgVAL2g.png"/></div><figcaption class="ol om gj gh gi on oo bd b be z dk translated">禁用并保存</figcaption></figure><p id="d7c2" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">如果我们再次尝试，我们会得到以下错误:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi pv"><img src="../Images/8fbbc3b6b36851eb98da171bad95631b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sNN1ucKQbywvGM2yb1DB7A.png"/></div></div><figcaption class="ol om gj gh gi on oo bd b be z dk translated">不允许客户端进行直接访问授权</figcaption></figure><p id="0dea" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">不再允许客户端 MyApp 使用此授权对自己进行身份验证和授权。它将不得不使用另一个授权:授权码授权。</p><p id="15a7" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们将使用授权码授权来保护我们的 React SPA 应用程序</p><h1 id="1cd2" class="mv mw in bd mx my oa na nb nc ob ne nf jt oc ju nh jw od jx nj jz oe ka nl nm bi translated">使用 OpenID Connect procotol 保护 React SPA 应用程序</h1><p id="081c" class="pw-post-body-paragraph kk kl in km b kn nn jo kp kq no jr ks kt np kv kw kx nq kz la lb nr ld le lf ig bi translated">什么是 React SPA 应用程序？</p><p id="06e0" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">它是一个前端应用程序，采用特殊调制的 HTML + CSS + Javascript，使其开发更快、更简单、更高效、更具可扩展性。</p><p id="5c65" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">所以我们的代码是<strong class="km io">客户端</strong>上的<strong class="km io"> Javascript </strong>。</p><p id="1df5" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">让我们看看 Keycloak 网站上有什么可以用<strong class="km io"> OpenID 连接协议</strong>来保护它。</p><div class="mc md gp gr me mf"><a href="https://www.keycloak.org/docs/latest/securing_apps/index.html" rel="noopener  ugc nofollow" target="_blank"><div class="mg ab fo"><div class="mh ab mi cl cj mj"><h2 class="bd io gy z fp mk fr fs ml fu fw im bi translated">保护应用程序和服务指南</h2><div class="mm l"><h3 class="bd b gy z fp mk fr fs ml fu fw dk translated">编辑描述</h3></div><div class="mn l"><p class="bd b dl z fp mk fr fs ml fu fw dk translated">www.keycloak.org</p></div></div></div></a></div><p id="5886" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">在这里，我们可以找到关于保护应用和服务的完整指南。</p><p id="b32b" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们将查看客户端应用程序，因此我们单击</p><div class="mc md gp gr me mf"><a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#client-adapters" rel="noopener  ugc nofollow" target="_blank"><div class="mg ab fo"><div class="mh ab mi cl cj mj"><h2 class="bd io gy z fp mk fr fs ml fu fw im bi translated">保护应用程序和服务指南</h2><div class="mm l"><h3 class="bd b gy z fp mk fr fs ml fu fw dk translated">编辑描述</h3></div><div class="mn l"><p class="bd b dl z fp mk fr fs ml fu fw dk translated">www.keycloak.org</p></div></div></div></a></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi pw"><img src="../Images/02fe2a9a050648b325f483acf2853b78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*38xKG30YWRTWFXziZnhvUQ.png"/></div></div><figcaption class="ol om gj gh gi on oo bd b be z dk translated">OpenID 连接客户端 Javascript 适配器</figcaption></figure><div class="mc md gp gr me mf"><a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_javascript_adapter" rel="noopener  ugc nofollow" target="_blank"><div class="mg ab fo"><div class="mh ab mi cl cj mj"><h2 class="bd io gy z fp mk fr fs ml fu fw im bi translated">保护应用程序和服务指南</h2><div class="mm l"><h3 class="bd b gy z fp mk fr fs ml fu fw dk translated">编辑描述</h3></div><div class="mn l"><p class="bd b dl z fp mk fr fs ml fu fw dk translated">www.keycloak.org</p></div></div></div></a></div><blockquote class="nt nu nv"><p id="791e" class="kk kl nw km b kn ko jo kp kq kr jr ks nx ku kv kw ny ky kz la nz lc ld le lf ig bi translated">Keycloak 自带客户端 JavaScript 库，可用于保护 HTML5/JavaScript 应用。</p><p id="ec97" class="kk kl nw km b kn ko jo kp kq kr jr ks nx ku kv kw ny ky kz la nz lc ld le lf ig bi translated">该库可以在<code class="fe px py pz qa b">/js/keycloak.js</code>直接从 Keycloak 服务器中检索</p></blockquote><p id="7e5c" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">让我们检查一下:</p><p id="b2bb" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们将 GET Http 方法请求发送到:</p><p id="1e1c" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated"><a class="ae lg" href="http://localhost:8080/js/keycloak.js" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/js/key cloak . js</a></p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi pq"><img src="../Images/fc8b5877f9253d6c25fe5c82815e38d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9oUy51MNntDpDq9K8vfh6A.png"/></div></div><figcaption class="ol om gj gh gi on oo bd b be z dk translated">Javascript Keycloak 适配器</figcaption></figure><p id="c5bd" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">这是一个 2405 行的大 js 文件，是我写这篇博客时最新版本 18.0.0 的服务器密匙锁:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi qb"><img src="../Images/a4c034b0a89f7afe0882f40873d83e21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yIMx1hm1PkljeiCkDPa8OA.png"/></div></div></figure><p id="c0db" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">现在我们知道可以使用这个文件来帮助我们保护任何使用 javascript 的前端 web 应用程序。</p><p id="3d75" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">但是我们如何在 React 应用程序中使用它呢？</p><p id="449b" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">首先我们需要一个文件:</p><ul class=""><li id="f1de" class="lo lp in km b kn ko kq kr kt lq kx lr lb ls lf lt lu lv lw bi translated">按照说明下载 keycloak.json:</li></ul><blockquote class="nt nu nv"><p id="f158" class="kk kl nw km b kn ko jo kp kq kr jr ks nx ku kv kw ny ky kz la nz lc ld le lf ig bi translated">点击<code class="fe px py pz qa b">Installation</code>选项卡选择<code class="fe px py pz qa b">Keycloak OIDC JSON</code>为<code class="fe px py pz qa b">Format Option</code>，然后点击<code class="fe px py pz qa b">Download</code>。下载的<code class="fe px py pz qa b">keycloak.json</code>文件应该放在你的 web 服务器上，和你的 HTML 页面放在同一个位置。</p></blockquote><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi qc"><img src="../Images/08aab0cc9e09d78658c3285cec2eacb6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kzTWtVlTahY-BL2kQ_3GNw.png"/></div></div></figure><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi qd"><img src="../Images/36d9d50fb1cdb37a87f0aeef33c895f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:568/format:webp/1*6JtVRI_pdNJsrNzBCSTacQ.png"/></div></figure><p id="214a" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">“安装”选项卡帮助我们获取配置文件。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi qe"><img src="../Images/e4e465066ef8382f2dc669ccb3e779fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XcaTgtoCbhR5dTbw8TbD4A.png"/></div></div><figcaption class="ol om gj gh gi on oo bd b be z dk translated">我们选择奇克劳 OIDC JSON</figcaption></figure><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi qf"><img src="../Images/728185b72f902f7f669a922a6f92dcca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ztSc2Yj8GbCOITF3HMGL8g.png"/></div></div><figcaption class="ol om gj gh gi on oo bd b be z dk translated">我们下载我们的配置文件</figcaption></figure><p id="c551" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们将 keycloak.json 添加到 React 项目的<strong class="km io"> public </strong>目录的根目录下。</p><p id="85bc" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">最后，我们得到以下项目结构:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi qg"><img src="../Images/033f17828b24217dabdf919b3a7690e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:722/format:webp/1*v6l47gLwnrNQMA7ApqFOjw.png"/></div><figcaption class="ol om gj gh gi on oo bd b be z dk translated">Keycloak.json 在<strong class="bd mx"> public </strong>目录中</figcaption></figure><p id="f205" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">现在我们准备编码了！</p><p id="aacb" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们将使用<strong class="km io">可视代码</strong>，但是您可以自由使用任何 IDE:</p><p id="77b1" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">让我们用可视代码打开终端</p><h1 id="5472" class="mv mw in bd mx my oa na nb nc ob ne nf jt oc ju nh jw od jx nj jz oe ka nl nm bi translated">在 React 中添加 Keycloak Javascript 适配器</h1><p id="9310" class="pw-post-body-paragraph kk kl in km b kn nn jo kp kq no jr ks kt np kv kw kx nq kz la lb nr ld le lf ig bi translated">我们需要在 React 项目中添加 Javascript Keycloak 适配器。</p><p id="37f8" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">为此，我们将使用国家预防机制。</p><p id="10e4" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">在谷歌上简单搜索一下就会得到:</p><p id="f873" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated"><a class="ae lg" href="https://www.npmjs.com/package/keycloak-js" rel="noopener ugc nofollow" target="_blank">https://www.npmjs.com/package/keycloak-js</a></p><p id="df52" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">在这里我们可以找到它，好消息是它还包含了内置的 typescript 声明，非常方便！</p><div class="mc md gp gr me mf"><a href="https://www.npmjs.com/package/keycloak-js" rel="noopener  ugc nofollow" target="_blank"><div class="mg ab fo"><div class="mh ab mi cl cj mj"><h2 class="bd io gy z fp mk fr fs ml fu fw im bi translated">keycloak-js</h2><div class="mm l"><h3 class="bd b gy z fp mk fr fs ml fu fw dk translated">键盘锁适配器。最新版本:18.0.0，最后发布时间:一个月前。通过以下方式开始在您的项目中使用 key cloak-js…</h3></div><div class="mn l"><p class="bd b dl z fp mk fr fs ml fu fw dk translated">www.npmjs.com</p></div></div><div class="mo l"><div class="qh l mq mr ms mo mt ki mf"/></div></div></a></div><p id="9cb2" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">此外，我们可以检查它是否与 Keycloak 服务器版本相匹配。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi qi"><img src="../Images/0b7ecad94a42093aac37acf6cbe814e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zMr5lMG9pDmzKuMkj-bIKA.png"/></div></div></figure><p id="1e3f" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">让我们用下面的命令安装它:</p><pre class="kd ke kf kg gt qj qa qk ql aw qm bi"><span id="c51c" class="op mw in qa b gy qn qo l qp qq">C:\DevRoot\myapp&gt;npm i keycloak-js@18.0.0 <br/>npm WARN <a class="ae lg" href="http://twitter.com/apideck/better-ajv-errors" rel="noopener ugc nofollow" target="_blank">@apideck/better-ajv-errors</a>@0.3.3 requires a peer of ajv@&gt;=8 but none is installed. You must install peer dependencies yourself.<br/>npm WARN optional SKIPPING OPTIONAL DEPENDENCY: fsevents@2.3.2 (node_modules\fsevents):<br/>npm WARN notsup SKIPPING OPTIONAL DEPENDENCY: Unsupported platform for fsevents@2.3.2: wanted {"os":"darwin","arch":"any"} (current: {"os":"win32","arch":"x64"})</span><span id="3874" class="op mw in qa b gy qr qo l qp qq">+ keycloak-js@18.0.0<br/>added 3 packages from 3 contributors and audited 1434 packages in 13.281s</span><span id="3ea3" class="op mw in qa b gy qr qo l qp qq">182 packages are looking for funding<br/>  run `npm fund` for details</span><span id="064f" class="op mw in qa b gy qr qo l qp qq">found 1 high severity vulnerability<br/>  run `npm audit fix` to fix them, or `npm audit` for details</span></pre><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi qs"><img src="../Images/c3e9c3e114609c1107d46ffa4f4bb188.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NgVVhKnoTCh5yc5r3kGKAw.png"/></div></div><figcaption class="ol om gj gh gi on oo bd b be z dk translated">keycloak-js</figcaption></figure><p id="359d" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">现在我们可以在应用程序中导入 keycloak js 适配器特性。为此，我们将通过创建带有接口的服务来享受 Typescript。</p><p id="8ea3" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">它将使在任何地方使用它和改变它的实现变得更加容易。</p><p id="b8fb" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">首先，让我们为 keycloak 服务创建一个名为“<strong class="km io"> security </strong>的文件夹，这个服务实例将使我们在 React 项目中的任何地方使用它变得更加容易。</p><p id="e446" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">让我们添加名为“KeycloakService.tsx”的 tsx 文件</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi qt"><img src="../Images/9225aa2825cf3c76ea6855f3cc4c988c.png" data-original-src="https://miro.medium.com/v2/resize:fit:728/format:webp/1*dNgFxQbs-4cJBWDbBGULiQ.png"/></div><figcaption class="ol om gj gh gi on oo bd b be z dk translated">KeyCloakService</figcaption></figure><p id="d61e" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们需要知道 Keycloak JS API，请去链接</p><div class="mc md gp gr me mf"><a href="https://github.com/keycloak/keycloak-documentation/blob/main/securing_apps/topics/oidc/javascript-adapter.adoc" rel="noopener  ugc nofollow" target="_blank"><div class="mg ab fo"><div class="mh ab mi cl cj mj"><h2 class="bd io gy z fp mk fr fs ml fu fw im bi translated">keycloak-documentation/JavaScript-adapter . adoc 位于主 keycloak/keycloak-documentation</h2><div class="mm l"><h3 class="bd b gy z fp mk fr fs ml fu fw dk translated">在 GitHub 上创建一个帐户，为 keycloak/keycloak 文档开发做贡献。</h3></div><div class="mn l"><p class="bd b dl z fp mk fr fs ml fu fw dk translated">github.com</p></div></div><div class="mo l"><div class="qu l mq mr ms mo mt ki mf"/></div></div></a></div><p id="0ec5" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们添加以下代码:</p><ul class=""><li id="dcd0" class="lo lp in km b kn ko kq kr kt lq kx lr lb ls lf lt lu lv lw bi translated">首先我们<strong class="km io">从 keycloak js 导入</strong>key cloak 类</li><li id="fff1" class="lo lp in km b kn lx kq ly kt lz kx ma lb mb lf lt lu lv lw bi translated">我们创建一个<strong class="km io">实例</strong> keycloakInstance</li><li id="fc9d" class="lo lp in km b kn lx kq ly kt lz kx ma lb mb lf lt lu lv lw bi translated">我们创建一个<strong class="km io">函数</strong>登录，如果用户通过了身份验证，就调用这个函数。这里，该函数将显示 React 应用程序的主要组件。<br/>要理解这一部分，请查阅链接<br/><a class="ae lg" href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_javascript_adapter" rel="noopener ugc nofollow" target="_blank">https://www . key cloak . org/docs/latest/securing _ apps/index . html # JavaScript _ adapter</a></li></ul><p id="2b77" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">非常重要的是要记住，文档说在<a class="ae lg" href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_javascript_implicit_flow" rel="noopener ugc nofollow" target="_blank">https://www . key cloak . org/docs/latest/securing _ apps/index . html # _ JavaScript _ implicit _ flow</a></p><blockquote class="nt nu nv"><p id="b642" class="kk kl nw km b kn ko jo kp kq kr jr ks nx ku kv kw ny ky kz la nz lc ld le lf ig bi translated">默认情况下，JavaScript 适配器使用<a class="ae lg" href="https://openid.net/specs/openid-connect-core-1_0.html#CodeFlowAuth" rel="noopener ugc nofollow" target="_blank">授权代码</a>流。</p></blockquote><p id="18b2" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated"><strong class="km io">因此，我们确保客户端可以通过使用授权代码流与服务器端通信，默认情况下，Keycloak Javascript 适配器使用我们在 Keycloak 服务器配置上为客户端“MyApp”启用的授权代码流</strong></p><p id="0985" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们不必对代码流做任何事情。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="qv qw l"/></div></figure><p id="8f88" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">现在我们已经准备好确保它能够工作:)在我们的 index.tsx 文件中</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi qx"><img src="../Images/246b1157d2a048df7ddbacb46de13906.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LhyqJEcy6Mio_DEx_zxbdQ.png"/></div></div><figcaption class="ol om gj gh gi on oo bd b be z dk translated">使用 Keycloak 服务保护 React 应用程序</figcaption></figure><p id="fea2" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们导入 KeyCloakService 并创建一个名为 renderApp 的函数。<br/> <strong class="km io">这个 renderApp 只有在用户通过认证的情况下才会被调用！</strong></p><p id="09be" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">因此，在 React 应用程序可以呈现之前，keycloak 服务将触发 CallLogin，我们将看到会发生什么。</p><p id="67e0" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">让我们用 VS 代码运行 React 应用程序。</p><p id="8746" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">让我们打开我们的<strong class="km io">包</strong></p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi qy"><img src="../Images/c2820ac532af3cdb43a1f0b594eee147.png" data-original-src="https://miro.medium.com/v2/resize:fit:1246/format:webp/1*IyJXZiWIZQTJROCRqlab3w.png"/></div><figcaption class="ol om gj gh gi on oo bd b be z dk translated">调试</figcaption></figure><p id="5b57" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们看到一个叫做“调试”的部分，里面有我们需要的所有脚本。</p><p id="27f9" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们将使用脚本/启动</p><p id="43b7" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">点击“调试”</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi qz"><img src="../Images/2336d5bcf59faf307866b5678c6b9a4d.png" data-original-src="https://miro.medium.com/v2/resize:fit:824/format:webp/1*4OFc3HVuF6M2-oxauNnvWw.png"/></div></figure><p id="d1ed" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">点击“开始”运行反应-脚本开始</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi ra"><img src="../Images/886c64a664cd3abe32ff926e5c20bdcc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-ZjMMdUIrwv0uZgZUYpjiA.png"/></div></div></figure><p id="309c" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">它将打开终端并运行</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi rb"><img src="../Images/d55b2c69bd8950116c994693e421faf2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1046/format:webp/1*Kp-m1K3I0rlG57YWIDuqHA.png"/></div></figure><p id="bc1e" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">最后，浏览器打开，终端返回:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi rc"><img src="../Images/1e6735f95a44c498c59d02824301fe61.png" data-original-src="https://miro.medium.com/v2/resize:fit:1296/format:webp/1*my_Kb6TY7fDDBNxUnKW1eQ.png"/></div></figure><p id="9831" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">你在浏览器中看到了什么？:)</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi rd"><img src="../Images/b5e4e088231b090aaa04d5ecbd1103e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YhKcg4HsXe7D4IcMMsIvhg.png"/></div></div><figcaption class="ol om gj gh gi on oo bd b be z dk translated">从 React 应用程序重定向到 Keycloak 登录表单</figcaption></figure><p id="435f" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们的 react 应用程序受到 keycloak 的保护。</p><p id="34a2" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">让我们看看网址</p><pre class="kd ke kf kg gt qj qa qk ql aw qm bi"><span id="d4a3" class="op mw in qa b gy qn qo l qp qq"><a class="ae lg" href="http://localhost:8080/realms/MyRealm/protocol/openid-connect/auth?client_id=MyApp&amp;redirect_uri=http%3A%2F%2Flocalhost%3A3000%2F&amp;state=39ebab78-b871-43ce-a30a-b01cce35b83d&amp;response_mode=fragment&amp;response_type=code&amp;scope=openid&amp;nonce=e8f025e1-c1fc-4551-8bb6-2c1239b01a79" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/realms/<strong class="qa io">MyRealm</strong>/<strong class="qa io">protocol</strong>/<strong class="qa io">openid-connect</strong>/<strong class="qa io">auth</strong>?<strong class="qa io">client_id</strong>=<strong class="qa io">MyApp</strong>&amp;<strong class="qa io">redirect_uri</strong>=http%3A%2F%2Flocalhost%3A3000%2F&amp;state=39ebab78-b871-43ce-a30a-b01cce35b83d&amp;response_mode=fragment&amp;<strong class="qa io">response_type=code</strong>&amp;<strong class="qa io">scope=openid</strong>&amp;nonce=e8f025e1-c1fc-4551-8bb6-2c1239b01a79</a></span></pre><p id="fe87" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">您可以看到领域“我的领域”，client_id 是我们在之前的博客中设置的 MyApp。</p><p id="9361" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">在 url 中，我们可以看到主要部分:</p><ul class=""><li id="2e45" class="lo lp in km b kn ko kq kr kt lq kx lr lb ls lf lt lu lv lw bi translated">Keycloak js 适配器调用 auth 端点对用户进行身份验证<a class="ae lg" href="http://localhost:8080/realms/MyRealm/protocol/openid-connect/auth" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/realms/my realm/protocol/OpenID-connect/auth</a>:端点用表单对用户进行身份验证</li><li id="ef81" class="lo lp in km b kn lx kq ly kt lz kx ma lb mb lf lt lu lv lw bi translated">协议是 openid-connect</li><li id="f246" class="lo lp in km b kn lx kq ly kt lz kx ma lb mb lf lt lu lv lw bi translated">客户端 id 是 MyApp</li><li id="671c" class="lo lp in km b kn lx kq ly kt lz kx ma lb mb lf lt lu lv lw bi translated">redirect_uri 是我们的 URI:<a class="ae lg" href="http://locahost:3000" rel="noopener ugc nofollow" target="_blank">http://loca host:3000</a></li><li id="c764" class="lo lp in km b kn lx kq ly kt lz kx ma lb mb lf lt lu lv lw bi translated">response_type = code 我们告诉服务器我们将使用授权码授权</li><li id="88d3" class="lo lp in km b kn lx kq ly kt lz kx ma lb mb lf lt lu lv lw bi translated">也就是说 keycloak 将返回 id 令牌和访问令牌。ID 令牌是 OAuth 2.0 协议上 OpenID Connect 协议的扩展。</li></ul><p id="38fd" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">在流程的最后，我们得到对授权代码流 POST 的最终请求的响应:<a class="ae lg" href="http://localhost:8080/realms/MyRealm/protocol/openid-connect/token" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/realms/my realm/protocol/OpenID-connect/token</a>，在这里我们通过与授权代码交换来请求令牌。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi re"><img src="../Images/33fe4f957277f45f09a9086fdd344f47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G6JlpyDyrUAa0btwxkdF2Q.png"/></div></div><figcaption class="ol om gj gh gi on oo bd b be z dk translated">ID 令牌和访问令牌</figcaption></figure><p id="353e" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们在邮件正文中发送了:</p><ul class=""><li id="da44" class="lo lp in km b kn ko kq kr kt lq kx lr lb ls lf lt lu lv lw bi translated">代码:授权代码的值</li><li id="c208" class="lo lp in km b kn lx kq ly kt lz kx ma lb mb lf lt lu lv lw bi translated">授权类型:授权代码流</li><li id="5e66" class="lo lp in km b kn lx kq ly kt lz kx ma lb mb lf lt lu lv lw bi translated">client_id: MyApp</li><li id="0f1c" class="lo lp in km b kn lx kq ly kt lz kx ma lb mb lf lt lu lv lw bi translated">redirect_uri:在用户通过身份验证后重定向到我们的应用程序</li></ul><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi rf"><img src="../Images/c93005bb707577541f4d2ed9c0315120.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n6R_mTR7AbPHA3O3bk22Nw.png"/></div></div></figure><p id="99c1" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">让我们看看小提琴手完整的舞蹈</p><p id="0ed0" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">步骤 1:用户未通过身份验证，重定向到 Keycloak 进行登录</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi rg"><img src="../Images/0aa5a65bdb45c9a7946c66a517007d2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D-G0irIf7_Xa1JRBvIDjhw.png"/></div></div></figure><p id="09c1" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">这里重要的请求/响应在第 13 行</p><p id="bb27" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">下面是前面已经研究过的带有预期查询参数的完整请求</p><pre class="kd ke kf kg gt qj qa qk ql aw qm bi"><span id="6f4e" class="op mw in qa b gy qn qo l qp qq">GET http://localhost:8080/realms/MyRealm/protocol/openid-connect/auth?client_id=MyApp&amp;redirect_uri=http%3A%2F%2Flocalhost%3A3000%2F&amp;state=be332dbe-e492-4133-b397-42fb385a0d9f&amp;response_mode=fragment&amp;response_type=code&amp;scope=openid&amp;nonce=c8fc1ae6-84eb-4332-91e1-9ebdf23447c9 HTTP/1.1</span><span id="a8e8" class="op mw in qa b gy qr qo l qp qq">Host: localhost:8080</span><span id="6ad5" class="op mw in qa b gy qr qo l qp qq">Connection: keep-alive</span><span id="9ba4" class="op mw in qa b gy qr qo l qp qq">sec-ch-ua: " Not A;Brand";v="99", "Chromium";v="101", "Google Chrome";v="101"</span><span id="885d" class="op mw in qa b gy qr qo l qp qq">sec-ch-ua-mobile: ?0</span><span id="ab0f" class="op mw in qa b gy qr qo l qp qq">sec-ch-ua-platform: "Windows"</span><span id="74fa" class="op mw in qa b gy qr qo l qp qq">Upgrade-Insecure-Requests: 1</span><span id="32b5" class="op mw in qa b gy qr qo l qp qq">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/101.0.4951.67 Safari/537.36</span><span id="7d3f" class="op mw in qa b gy qr qo l qp qq">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><span id="8d0b" class="op mw in qa b gy qr qo l qp qq">Sec-Fetch-Site: same-site</span><span id="f3a8" class="op mw in qa b gy qr qo l qp qq">Sec-Fetch-Mode: navigate</span><span id="8df5" class="op mw in qa b gy qr qo l qp qq">Sec-Fetch-Dest: document</span><span id="611c" class="op mw in qa b gy qr qo l qp qq">Referer: http://localhost:3000/</span><span id="a8d8" class="op mw in qa b gy qr qo l qp qq">Accept-Encoding: gzip, deflate, br</span><span id="9c23" class="op mw in qa b gy qr qo l qp qq">Accept-Language: en-US,en;q=0.9,es;q=0.8,fr;q=0.7,zh-CN;q=0.6,zh;q=0.5,nl;q=0.4</span><span id="74c3" class="op mw in qa b gy qr qo l qp qq">Cookie: AUTH_SESSION_ID=d1945748-e67b-448f-b204-a0b804da5740; AUTH_SESSION_ID_LEGACY=d1945748-e67b-448f-b204-a0b804da5740; KC_RESTART=eyJhbGciOiJIUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICIyMTllYzkwNi1hYjNlLTQ4YWItOTM2OS0yZDdjYTZhM2QwOWQifQ.eyJjaWQiOiJNeUFwcCIsInB0eSI6Im9wZW5pZC1jb25uZWN0IiwicnVyaSI6Imh0dHA6Ly9sb2NhbGhvc3Q6MzAwMC8iLCJhY3QiOiJBVVRIRU5USUNBVEUiLCJub3RlcyI6eyJzY29wZSI6Im9wZW5pZCIsImlzcyI6Imh0dHA6Ly9sb2NhbGhvc3Q6ODA4MC9yZWFsbXMvTXlSZWFsbSIsInJlc3BvbnNlX3R5cGUiOiJjb2RlIiwicmVkaXJlY3RfdXJpIjoiaHR0cDovL2xvY2FsaG9zdDozMDAwLyIsInN0YXRlIjoiMWUxZGVhZjItMmI0NC00ZWY5LTk1YTktMzcxYWNlNmVkNGNjIiwibm9uY2UiOiIyYjc3YjVlYy05MTNkLTQwMjEtODZkZi0zYTRmNzc5Mjg5MjgiLCJyZXNwb25zZV9tb2RlIjoiZnJhZ21lbnQifX0.0VclmSPhERNprcUZ9oAaknvuvW5UNFM9clJkO9fOZsA</span></pre><p id="e032" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们得到了表单的响应，这是小提琴手的主要预览</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi rh"><img src="../Images/eb74113e93d7016bbe12ea2b417bc82f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1354/format:webp/1*6cnY1jN6IzxPgFs6q-z2LA.png"/></div></div></figure><p id="83b5" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">在我们的浏览器中，我们得到:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi rd"><img src="../Images/012980b5b87dd72e6841800589459277.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y9dOizZJhO4QpytlgycWcw.png"/></div></div></figure><p id="6f81" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">让我们登录网站，跟随《与提琴手共舞》:</p><p id="4af0" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">步骤 2 和 3:授权码和令牌</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi ri"><img src="../Images/815c1d69aede0c5d009e86f3a53b96d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-Fo97dBy-aZ5GFnDzW2aAw.png"/></div></div></figure><p id="1194" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">步骤 2:让我们看一下第 26 行，我们在那里登录并调用端点身份验证。我们在 POST http 调用中发送了用户名和密码</p><pre class="kd ke kf kg gt qj qa qk ql aw qm bi"><span id="36e7" class="op mw in qa b gy qn qo l qp qq">POST http://localhost:8080/realms/MyRealm/login-actions/authenticate?session_code=XgIBUY1cPp8cxmlV90NMm_OvxpAzYqDgS1C5aEMFyZA&amp;execution=bcb665d5-bd68-4918-9aa3-25eb3f06f834&amp;client_id=MyApp&amp;tab_id=tTrW_5TE5yM HTTP/1.1</span><span id="fad1" class="op mw in qa b gy qr qo l qp qq">Host: localhost:8080</span><span id="2237" class="op mw in qa b gy qr qo l qp qq">Connection: keep-alive</span><span id="7b49" class="op mw in qa b gy qr qo l qp qq">Content-Length: 45</span><span id="06ad" class="op mw in qa b gy qr qo l qp qq">Cache-Control: max-age=0</span><span id="a0c8" class="op mw in qa b gy qr qo l qp qq">sec-ch-ua: " Not A;Brand";v="99", "Chromium";v="101", "Google Chrome";v="101"</span><span id="2346" class="op mw in qa b gy qr qo l qp qq">sec-ch-ua-mobile: ?0</span><span id="f3da" class="op mw in qa b gy qr qo l qp qq">sec-ch-ua-platform: "Windows"</span><span id="62f8" class="op mw in qa b gy qr qo l qp qq">Upgrade-Insecure-Requests: 1</span><span id="00a9" class="op mw in qa b gy qr qo l qp qq">Origin: null</span><span id="773b" class="op mw in qa b gy qr qo l qp qq">Content-Type: application/x-www-form-urlencoded</span><span id="b27f" class="op mw in qa b gy qr qo l qp qq">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/101.0.4951.67 Safari/537.36</span><span id="713f" class="op mw in qa b gy qr qo l qp qq">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><span id="6e63" class="op mw in qa b gy qr qo l qp qq">Sec-Fetch-Site: same-origin</span><span id="f5cd" class="op mw in qa b gy qr qo l qp qq">Sec-Fetch-Mode: navigate</span><span id="e6f3" class="op mw in qa b gy qr qo l qp qq">Sec-Fetch-User: ?1</span><span id="db58" class="op mw in qa b gy qr qo l qp qq">Sec-Fetch-Dest: document</span><span id="8780" class="op mw in qa b gy qr qo l qp qq">Accept-Encoding: gzip, deflate, br</span><span id="542b" class="op mw in qa b gy qr qo l qp qq">Accept-Language: en-US,en;q=0.9,es;q=0.8,fr;q=0.7,zh-CN;q=0.6,zh;q=0.5,nl;q=0.4</span><span id="62f5" class="op mw in qa b gy qr qo l qp qq">Cookie: AUTH_SESSION_ID=d1945748-e67b-448f-b204-a0b804da5740; AUTH_SESSION_ID_LEGACY=d1945748-e67b-448f-b204-a0b804da5740; KC_RESTART=eyJhbGciOiJIUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICIyMTllYzkwNi1hYjNlLTQ4YWItOTM2OS0yZDdjYTZhM2QwOWQifQ.eyJjaWQiOiJNeUFwcCIsInB0eSI6Im9wZW5pZC1jb25uZWN0IiwicnVyaSI6Imh0dHA6Ly9sb2NhbGhvc3Q6MzAwMC8iLCJhY3QiOiJBVVRIRU5USUNBVEUiLCJub3RlcyI6eyJzY29wZSI6Im9wZW5pZCIsImlzcyI6Imh0dHA6Ly9sb2NhbGhvc3Q6ODA4MC9yZWFsbXMvTXlSZWFsbSIsInJlc3BvbnNlX3R5cGUiOiJjb2RlIiwicmVkaXJlY3RfdXJpIjoiaHR0cDovL2xvY2FsaG9zdDozMDAwLyIsInN0YXRlIjoiYmUzMzJkYmUtZTQ5Mi00MTMzLWIzOTctNDJmYjM4NWEwZDlmIiwibm9uY2UiOiJjOGZjMWFlNi04NGViLTQzMzItOTFlMS05ZWJkZjIzNDQ3YzkiLCJyZXNwb25zZV9tb2RlIjoiZnJhZ21lbnQifX0.IwNPJ-OaVGtX-PgLxr1u849Q84LD4RPI87Bt4TzgcL0</span><span id="6cfb" class="op mw in qa b gy qr qo l qp qq">username=myuser&amp;password=myuser&amp;credentialId=</span></pre><p id="de33" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">一旦 keycloak 验证了登录/密码，我们就会得到响应</p><pre class="kd ke kf kg gt qj qa qk ql aw qm bi"><span id="5426" class="op mw in qa b gy qn qo l qp qq">HTTP/1.1 302 Found</span><span id="7a03" class="op mw in qa b gy qr qo l qp qq">Referrer-Policy: no-referrer</span><span id="2d97" class="op mw in qa b gy qr qo l qp qq">X-Frame-Options: SAMEORIGIN</span><span id="715f" class="op mw in qa b gy qr qo l qp qq">Strict-Transport-Security: max-age=31536000; includeSubDomains</span><span id="2f4c" class="op mw in qa b gy qr qo l qp qq">X-Robots-Tag: none</span><span id="6848" class="op mw in qa b gy qr qo l qp qq">Cache-Control: no-store, must-revalidate, max-age=0</span><span id="4351" class="op mw in qa b gy qr qo l qp qq">X-Content-Type-Options: nosniff</span><span id="8992" class="op mw in qa b gy qr qo l qp qq">Content-Security-Policy: frame-src 'self'; frame-ancestors 'self'; object-src 'none';</span><span id="dbf9" class="op mw in qa b gy qr qo l qp qq">Set-Cookie: KEYCLOAK_LOCALE=; Version=1; Comment=Expiring cookie; Expires=Thu, 01-Jan-1970 00:00:10 GMT; Max-Age=0; Path=/realms/MyRealm/; HttpOnly</span><span id="7802" class="op mw in qa b gy qr qo l qp qq">Set-Cookie: KC_RESTART=; Version=1; Expires=Thu, 01-Jan-1970 00:00:10 GMT; Max-Age=0; Path=/realms/MyRealm/; HttpOnly</span><span id="3fa8" class="op mw in qa b gy qr qo l qp qq">Set-Cookie: KEYCLOAK_IDENTITY=eyJhbGciOiJIUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICIyMTllYzkwNi1hYjNlLTQ4YWItOTM2OS0yZDdjYTZhM2QwOWQifQ.eyJleHAiOjE2NTM4NzkyODEsImlhdCI6MTY1Mzg0MzI4MSwianRpIjoiMTEyMjVmMjAtYWFjMC00NjJhLWFmODgtNjNiNDQ4ZWIxZTVjIiwiaXNzIjoiaHR0cDovL2xvY2FsaG9zdDo4MDgwL3JlYWxtcy9NeVJlYWxtIiwic3ViIjoiOGI1YTc4NjYtZTk2OC00YjIwLTkwMDEtNWZmNWFmNzVmZGNlIiwidHlwIjoiU2VyaWFsaXplZC1JRCIsInNlc3Npb25fc3RhdGUiOiJkMTk0NTc0OC1lNjdiLTQ0OGYtYjIwNC1hMGI4MDRkYTU3NDAiLCJzaWQiOiJkMTk0NTc0OC1lNjdiLTQ0OGYtYjIwNC1hMGI4MDRkYTU3NDAiLCJzdGF0ZV9jaGVja2VyIjoiZWJmbWZGbzFldHRnVU5ybDhjVjhKZjNsVko2SnQ0Tk9TbC1JWlg2YjRrcyJ9.tqPAjEiivavLO5I8JPl-62Sn66Dvvpd-95Ymsp7vHo0; Version=1; Path=/realms/MyRealm/; SameSite=None; Secure; HttpOnly</span><span id="740d" class="op mw in qa b gy qr qo l qp qq">Set-Cookie: KEYCLOAK_IDENTITY_LEGACY=eyJhbGciOiJIUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICIyMTllYzkwNi1hYjNlLTQ4YWItOTM2OS0yZDdjYTZhM2QwOWQifQ.eyJleHAiOjE2NTM4NzkyODEsImlhdCI6MTY1Mzg0MzI4MSwianRpIjoiMTEyMjVmMjAtYWFjMC00NjJhLWFmODgtNjNiNDQ4ZWIxZTVjIiwiaXNzIjoiaHR0cDovL2xvY2FsaG9zdDo4MDgwL3JlYWxtcy9NeVJlYWxtIiwic3ViIjoiOGI1YTc4NjYtZTk2OC00YjIwLTkwMDEtNWZmNWFmNzVmZGNlIiwidHlwIjoiU2VyaWFsaXplZC1JRCIsInNlc3Npb25fc3RhdGUiOiJkMTk0NTc0OC1lNjdiLTQ0OGYtYjIwNC1hMGI4MDRkYTU3NDAiLCJzaWQiOiJkMTk0NTc0OC1lNjdiLTQ0OGYtYjIwNC1hMGI4MDRkYTU3NDAiLCJzdGF0ZV9jaGVja2VyIjoiZWJmbWZGbzFldHRnVU5ybDhjVjhKZjNsVko2SnQ0Tk9TbC1JWlg2YjRrcyJ9.tqPAjEiivavLO5I8JPl-62Sn66Dvvpd-95Ymsp7vHo0; Version=1; Path=/realms/MyRealm/; HttpOnly</span><span id="b887" class="op mw in qa b gy qr qo l qp qq">Set-Cookie: KEYCLOAK_SESSION=MyRealm/8b5a7866-e968-4b20-9001-5ff5af75fdce/d1945748-e67b-448f-b204-a0b804da5740; Version=1; Expires=Mon, 30-May-2022 02:54:41 GMT; Max-Age=36000; Path=/realms/MyRealm/; SameSite=None; Secure</span><span id="3f1f" class="op mw in qa b gy qr qo l qp qq">Set-Cookie: KEYCLOAK_SESSION_LEGACY=MyRealm/8b5a7866-e968-4b20-9001-5ff5af75fdce/d1945748-e67b-448f-b204-a0b804da5740; Version=1; Expires=Mon, 30-May-2022 02:54:41 GMT; Max-Age=36000; Path=/realms/MyRealm/</span><span id="c7f0" class="op mw in qa b gy qr qo l qp qq">Set-Cookie: KEYCLOAK_REMEMBER_ME=; Version=1; Comment=Expiring cookie; Expires=Thu, 01-Jan-1970 00:00:10 GMT; Max-Age=0; Path=/realms/MyRealm/; HttpOnly</span><span id="4475" class="op mw in qa b gy qr qo l qp qq">P3P: CP="This is not a P3P policy!"</span><span id="ca57" class="op mw in qa b gy qr qo l qp qq">X-XSS-Protection: 1; mode=block</span><span id="36eb" class="op mw in qa b gy qr qo l qp qq">Location: http://localhost:3000/#state=be332dbe-e492-4133-b397-42fb385a0d9f&amp;session_state=d1945748-e67b-448f-b204-a0b804da5740&amp;code=618cefce-9582-4e5a-bd98-207b22e06a75.d1945748-e67b-448f-b204-a0b804da5740.c6015bba-a545-4114-841c-3a3425c001b2</span><span id="00ba" class="op mw in qa b gy qr qo l qp qq">content-length: 0</span></pre><p id="ebd2" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">它返回 HTTP 代码 302 重定向到<a class="ae lg" href="http://localhost:3000/#state=be332dbe-e492-4133-b397-42fb385a0d9f&amp;session_state=d1945748-e67b-448f-b204-a0b804da5740&amp;code=618cefce-9582-4e5a-bd98-207b22e06a75.d1945748-e67b-448f-b204-a0b804da5740.c6015bba-a545-4114-841c-3a3425c001b2" rel="noopener ugc nofollow" target="_blank">HTTP://localhost:3000/# state = be 332 DBE-e492-4133-b397-42fb 385 a0d 9 f&amp;session _ state = d 1945748-e67b-448 f-b204-a0b 804 da 5740&amp;code = 618 cef ce-9582-4e5a-bd98-207 B2</a></p><p id="96c3" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们可以在网址中看到<strong class="km io">授权码</strong>:<br/>c<a class="ae lg" href="http://localhost:3000/#state=be332dbe-e492-4133-b397-42fb385a0d9f&amp;session_state=d1945748-e67b-448f-b204-a0b804da5740&amp;code=618cefce-9582-4e5a-bd98-207b22e06a75.d1945748-e67b-448f-b204-a0b804da5740.c6015bba-a545-4114-841c-3a3425c001b2" rel="noopener ugc nofollow" target="_blank">ode = 618 cef ce-9582–4e5a-bd98–207 b 22 e 06 a 75 . d 1945748-e67b-448 f-b204-a0b 804 da 5740 . c 6015 BBA-a545–4114–841 c-3a 3425 c 001 b 2</a></p><p id="62cc" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">步骤 3:一旦我们回到我们的应用程序，Keycloak JS 继续发送/接收其他请求/响应，直到第 45 行，在那里我们得到授权代码流的最后步骤 3:如果 Keycloak 可以验证，交换授权代码以取回令牌作为响应。</p><pre class="kd ke kf kg gt qj qa qk ql aw qm bi"><span id="dea4" class="op mw in qa b gy qn qo l qp qq">POST http://localhost:8080/realms/MyRealm/protocol/openid-connect/token HTTP/1.1</span><span id="0f06" class="op mw in qa b gy qr qo l qp qq">Host: localhost:8080</span><span id="4cf2" class="op mw in qa b gy qr qo l qp qq">Connection: keep-alive</span><span id="1113" class="op mw in qa b gy qr qo l qp qq">Content-Length: 207</span><span id="7b98" class="op mw in qa b gy qr qo l qp qq">sec-ch-ua: " Not A;Brand";v="99", "Chromium";v="101", "Google Chrome";v="101"</span><span id="d233" class="op mw in qa b gy qr qo l qp qq">sec-ch-ua-mobile: ?0</span><span id="05d2" class="op mw in qa b gy qr qo l qp qq">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/101.0.4951.67 Safari/537.36</span><span id="88c6" class="op mw in qa b gy qr qo l qp qq">sec-ch-ua-platform: "Windows"</span><span id="8f47" class="op mw in qa b gy qr qo l qp qq">Content-type: application/x-www-form-urlencoded</span><span id="2838" class="op mw in qa b gy qr qo l qp qq">Accept: */*</span><span id="76d1" class="op mw in qa b gy qr qo l qp qq">Origin: http://localhost:3000</span><span id="8b5c" class="op mw in qa b gy qr qo l qp qq">Sec-Fetch-Site: same-site</span><span id="0f46" class="op mw in qa b gy qr qo l qp qq">Sec-Fetch-Mode: cors</span><span id="ced2" class="op mw in qa b gy qr qo l qp qq">Sec-Fetch-Dest: empty</span><span id="9f47" class="op mw in qa b gy qr qo l qp qq">Referer: http://localhost:3000/</span><span id="c7b0" class="op mw in qa b gy qr qo l qp qq">Accept-Encoding: gzip, deflate, br</span><span id="7cdc" class="op mw in qa b gy qr qo l qp qq">Accept-Language: en-US,en;q=0.9,es;q=0.8,fr;q=0.7,zh-CN;q=0.6,zh;q=0.5,nl;q=0.4</span><span id="c3fb" class="op mw in qa b gy qr qo l qp qq">Cookie: AUTH_SESSION_ID=d1945748-e67b-448f-b204-a0b804da5740; AUTH_SESSION_ID_LEGACY=d1945748-e67b-448f-b204-a0b804da5740; KEYCLOAK_IDENTITY=eyJhbGciOiJIUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICIyMTllYzkwNi1hYjNlLTQ4YWItOTM2OS0yZDdjYTZhM2QwOWQifQ.eyJleHAiOjE2NTM4NzkyODEsImlhdCI6MTY1Mzg0MzI4MSwianRpIjoiMTEyMjVmMjAtYWFjMC00NjJhLWFmODgtNjNiNDQ4ZWIxZTVjIiwiaXNzIjoiaHR0cDovL2xvY2FsaG9zdDo4MDgwL3JlYWxtcy9NeVJlYWxtIiwic3ViIjoiOGI1YTc4NjYtZTk2OC00YjIwLTkwMDEtNWZmNWFmNzVmZGNlIiwidHlwIjoiU2VyaWFsaXplZC1JRCIsInNlc3Npb25fc3RhdGUiOiJkMTk0NTc0OC1lNjdiLTQ0OGYtYjIwNC1hMGI4MDRkYTU3NDAiLCJzaWQiOiJkMTk0NTc0OC1lNjdiLTQ0OGYtYjIwNC1hMGI4MDRkYTU3NDAiLCJzdGF0ZV9jaGVja2VyIjoiZWJmbWZGbzFldHRnVU5ybDhjVjhKZjNsVko2SnQ0Tk9TbC1JWlg2YjRrcyJ9.tqPAjEiivavLO5I8JPl-62Sn66Dvvpd-95Ymsp7vHo0; KEYCLOAK_IDENTITY_LEGACY=eyJhbGciOiJIUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICIyMTllYzkwNi1hYjNlLTQ4YWItOTM2OS0yZDdjYTZhM2QwOWQifQ.eyJleHAiOjE2NTM4NzkyODEsImlhdCI6MTY1Mzg0MzI4MSwianRpIjoiMTEyMjVmMjAtYWFjMC00NjJhLWFmODgtNjNiNDQ4ZWIxZTVjIiwiaXNzIjoiaHR0cDovL2xvY2FsaG9zdDo4MDgwL3JlYWxtcy9NeVJlYWxtIiwic3ViIjoiOGI1YTc4NjYtZTk2OC00YjIwLTkwMDEtNWZmNWFmNzVmZGNlIiwidHlwIjoiU2VyaWFsaXplZC1JRCIsInNlc3Npb25fc3RhdGUiOiJkMTk0NTc0OC1lNjdiLTQ0OGYtYjIwNC1hMGI4MDRkYTU3NDAiLCJzaWQiOiJkMTk0NTc0OC1lNjdiLTQ0OGYtYjIwNC1hMGI4MDRkYTU3NDAiLCJzdGF0ZV9jaGVja2VyIjoiZWJmbWZGbzFldHRnVU5ybDhjVjhKZjNsVko2SnQ0Tk9TbC1JWlg2YjRrcyJ9.tqPAjEiivavLO5I8JPl-62Sn66Dvvpd-95Ymsp7vHo0; KEYCLOAK_SESSION=MyRealm/8b5a7866-e968-4b20-9001-5ff5af75fdce/d1945748-e67b-448f-b204-a0b804da5740; KEYCLOAK_SESSION_LEGACY=MyRealm/8b5a7866-e968-4b20-9001-5ff5af75fdce/d1945748-e67b-448f-b204-a0b804da5740</span><span id="62e9" class="op mw in qa b gy qr qo l qp qq">code=618cefce-9582-4e5a-bd98-207b22e06a75.d1945748-e67b-448f-b204-a0b804da5740.c6015bba-a545-4114-841c-3a3425c001b2&amp;grant_type=authorization_code&amp;client_id=MyApp&amp;redirect_uri=http%3A%2F%2Flocalhost%3A3000%2F</span></pre><p id="178a" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们调用端点<strong class="km io">令牌</strong>来将<strong class="km io">授权码交换给令牌</strong></p><p id="13ac" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们发送 POST HTTP 请求</p><ul class=""><li id="dba8" class="lo lp in km b kn ko kq kr kt lq kx lr lb ls lf lt lu lv lw bi translated"><strong class="km io">授权码</strong>code = 618 ce FCE-9582–4e5a-bd98–207 b 22 e 06 a 75 . d 1945748-e67b-448 f-b204-a0b 804 da 5740 . c 6015 BBA-a545–4114–841 c-3a 3425 c 001 b</li><li id="0017" class="lo lp in km b kn lx kq ly kt lz kx ma lb mb lf lt lu lv lw bi translated">授权类型=授权代码</li><li id="1809" class="lo lp in km b kn lx kq ly kt lz kx ma lb mb lf lt lu lv lw bi translated">client_id=MyApp</li><li id="7862" class="lo lp in km b kn lx kq ly kt lz kx ma lb mb lf lt lu lv lw bi translated">redirect_uri 我们的 React 应用程序 uri，在进入 keycloak 服务器之前，我们从这里被重定向</li></ul><p id="ca85" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">作为回应，我们得到:</p><pre class="kd ke kf kg gt qj qa qk ql aw qm bi"><span id="4b12" class="op mw in qa b gy qn qo l qp qq">HTTP/1.1 200 OK</span><span id="d675" class="op mw in qa b gy qr qo l qp qq">Referrer-Policy: no-referrer</span><span id="943a" class="op mw in qa b gy qr qo l qp qq">X-Frame-Options: SAMEORIGIN</span><span id="9c54" class="op mw in qa b gy qr qo l qp qq">Access-Control-Expose-Headers: Access-Control-Allow-Methods</span><span id="3f40" class="op mw in qa b gy qr qo l qp qq">Strict-Transport-Security: max-age=31536000; includeSubDomains</span><span id="4bf9" class="op mw in qa b gy qr qo l qp qq">Cache-Control: no-store</span><span id="762e" class="op mw in qa b gy qr qo l qp qq">Access-Control-Allow-Origin: http://localhost:3000</span><span id="001c" class="op mw in qa b gy qr qo l qp qq">Access-Control-Allow-Credentials: true</span><span id="6b11" class="op mw in qa b gy qr qo l qp qq">X-Content-Type-Options: nosniff</span><span id="7ecb" class="op mw in qa b gy qr qo l qp qq">Pragma: no-cache</span><span id="f707" class="op mw in qa b gy qr qo l qp qq">X-XSS-Protection: 1; mode=block</span><span id="35fd" class="op mw in qa b gy qr qo l qp qq">Content-Type: application/json</span><span id="5d6a" class="op mw in qa b gy qr qo l qp qq">content-length: 3426</span><span id="3dde" class="op mw in qa b gy qr qo l qp qq">{"access_token":"eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJFMUk0RHpMWHUzUTRqMm80ZHdSRFBSOVBGUzd6bEw2MjdOaGtiSUl5WkQ0In0.eyJleHAiOjE2NTM4NDM1ODYsImlhdCI6MTY1Mzg0MzI4NiwiYXV0aF90aW1lIjoxNjUzODQzMjgxLCJqdGkiOiI4MjI4NjM1OC1kZmVhLTQwMGMtOGVkNy05Yzg3NjFkMWU1YmQiLCJpc3MiOiJodHRwOi8vbG9jYWxob3N0OjgwODAvcmVhbG1zL015UmVhbG0iLCJhdWQiOiJhY2NvdW50Iiwic3ViIjoiOGI1YTc4NjYtZTk2OC00YjIwLTkwMDEtNWZmNWFmNzVmZGNlIiwidHlwIjoiQmVhcmVyIiwiYXpwIjoiTXlBcHAiLCJub25jZSI6ImM4ZmMxYWU2LTg0ZWItNDMzMi05MWUxLTllYmRmMjM0NDdjOSIsInNlc3Npb25fc3RhdGUiOiJkMTk0NTc0OC1lNjdiLTQ0OGYtYjIwNC1hMGI4MDRkYTU3NDAiLCJhY3IiOiIxIiwiYWxsb3dlZC1vcmlnaW5zIjpbImh0dHA6Ly9sb2NhbGhvc3Q6MzAwMCJdLCJyZWFsbV9hY2Nlc3MiOnsicm9sZXMiOlsiZGVmYXVsdC1yb2xlcy1teXJlYWxtIiwib2ZmbGluZV9hY2Nlc3MiLCJ1bWFfYXV0aG9yaXphdGlvbiJdfSwicmVzb3VyY2VfYWNjZXNzIjp7ImFjY291bnQiOnsicm9sZXMiOlsibWFuYWdlLWFjY291bnQiLCJtYW5hZ2UtYWNjb3VudC1saW5rcyIsInZpZXctcHJvZmlsZSJdfX0sInNjb3BlIjoib3BlbmlkIHByb2ZpbGUgZW1haWwiLCJzaWQiOiJkMTk0NTc0OC1lNjdiLTQ0OGYtYjIwNC1hMGI4MDRkYTU3NDAiLCJlbWFpbF92ZXJpZmllZCI6ZmFsc2UsInByZWZlcnJlZF91c2VybmFtZSI6Im15dXNlciJ9.B2F_-pSTh6phS7TZJeS6-ZUgT31uEYQPbtV9oxjVdIKVeQWadWCyV-P2H0gY5oo7VWUhvtcqib_IK3fm41TxDxatlHkysFX5FVsvUoilkIeRp1vQDEhz745NddspVIZzH5u87TdFVuKH5Abv3Vr410sYAQeugzuCi28sbcgIsXzleX_LuUpOmaewz71j5zrkDGTz2qM9xo3D1g74ZuUegXsm_XKjDLqDEKHkJTa8YJvUBaf_iMfM-ZXI91Z41l9zP4rFuYqwFgLxvu-FdgN7jsW4rUGohsqyaNBJ_GCb0F8HYZRGCKuIkgZj-Zn6zkgbQetB7oMoB0ueEAtJd8aO2A","expires_in":300,"refresh_expires_in":1800,"refresh_token":"eyJhbGciOiJIUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICIyMTllYzkwNi1hYjNlLTQ4YWItOTM2OS0yZDdjYTZhM2QwOWQifQ.eyJleHAiOjE2NTM4NDUwODYsImlhdCI6MTY1Mzg0MzI4NiwianRpIjoiMDg1ZTJmZWQtZDgxZi00OTcxLWE0ZWEtODQxMmJiNWY4MDgzIiwiaXNzIjoiaHR0cDovL2xvY2FsaG9zdDo4MDgwL3JlYWxtcy9NeVJlYWxtIiwiYXVkIjoiaHR0cDovL2xvY2FsaG9zdDo4MDgwL3JlYWxtcy9NeVJlYWxtIiwic3ViIjoiOGI1YTc4NjYtZTk2OC00YjIwLTkwMDEtNWZmNWFmNzVmZGNlIiwidHlwIjoiUmVmcmVzaCIsImF6cCI6Ik15QXBwIiwibm9uY2UiOiJjOGZjMWFlNi04NGViLTQzMzItOTFlMS05ZWJkZjIzNDQ3YzkiLCJzZXNzaW9uX3N0YXRlIjoiZDE5NDU3NDgtZTY3Yi00NDhmLWIyMDQtYTBiODA0ZGE1NzQwIiwic2NvcGUiOiJvcGVuaWQgcHJvZmlsZSBlbWFpbCIsInNpZCI6ImQxOTQ1NzQ4LWU2N2ItNDQ4Zi1iMjA0LWEwYjgwNGRhNTc0MCJ9.i1WadD6KDRmAcJAPV2s8aYLd6VXR6YWO0l-a-TVGP9c","token_type":"Bearer","id_token":"eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJFMUk0RHpMWHUzUTRqMm80ZHdSRFBSOVBGUzd6bEw2MjdOaGtiSUl5WkQ0In0.eyJleHAiOjE2NTM4NDM1ODYsImlhdCI6MTY1Mzg0MzI4NiwiYXV0aF90aW1lIjoxNjUzODQzMjgxLCJqdGkiOiI0OTRkZDc4YS04YTY5LTQzYzItOWQ3OS05MWFkNzU1ZmU5NjkiLCJpc3MiOiJodHRwOi8vbG9jYWxob3N0OjgwODAvcmVhbG1zL015UmVhbG0iLCJhdWQiOiJNeUFwcCIsInN1YiI6IjhiNWE3ODY2LWU5NjgtNGIyMC05MDAxLTVmZjVhZjc1ZmRjZSIsInR5cCI6IklEIiwiYXpwIjoiTXlBcHAiLCJub25jZSI6ImM4ZmMxYWU2LTg0ZWItNDMzMi05MWUxLTllYmRmMjM0NDdjOSIsInNlc3Npb25fc3RhdGUiOiJkMTk0NTc0OC1lNjdiLTQ0OGYtYjIwNC1hMGI4MDRkYTU3NDAiLCJhdF9oYXNoIjoiemlUM0NqeDI4WEQtSjVjbWFVV1k1ZyIsImFjciI6IjEiLCJzaWQiOiJkMTk0NTc0OC1lNjdiLTQ0OGYtYjIwNC1hMGI4MDRkYTU3NDAiLCJlbWFpbF92ZXJpZmllZCI6ZmFsc2UsInByZWZlcnJlZF91c2VybmFtZSI6Im15dXNlciJ9.V6ZJKLECBOlKF0qisF19Y8xX9kTf7CZgHLz0efxmr63ZOSRsyZQwLBnoWH00E-pFIGHkdK5ugRGNU36N7xX1tzDvf6sOUIAAj7IUokaAxeYZOtjQL5ZTFgS1qZqEH7kUi27NaCc-z2mOrxF3nD6fSVqZcJ2jx-Wd5-nNvRCMpyEx0j5UtrB4aQP9XJddaJI4P19QjWicNTf1XBeProRKSoFsZ8W3wF0PCaCTV0hsF5rHyyvEP2csAAn1PZ7_Sv9TS0dI2_KjcxiiDCsMuBQnJI53vjAQkpm289dT20BUq6DXnJwLjeYsvO3EGAmpieqUIRTGx6JZ6WvZ-XVQp5_ctA","not-before-policy":0,"session_state":"d1945748-e67b-448f-b204-a0b804da5740","scope":"openid profile email"}</span></pre><p id="9be1" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们可以看到 ID 和访问令牌</p><p id="9db2" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">视觉视图下方:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi rj"><img src="../Images/9f2c755f05e9a27911f84143e188417d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sNg8cX3miESnjlxUYNkTNQ.png"/></div></div></figure><p id="9785" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们还可以看到令牌的到期时间。</p><p id="3d86" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">所以使用 fiddler，我们可以确保使用了<strong class="km io">授权代码流</strong>。</p><p id="53ae" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">最后，我们可以进入 React 应用程序页面！</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi rk"><img src="../Images/2b5f4c3ec16cac87d34af50a41a2df11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zYCdBrREisD8d8c1U3dmDg.png"/></div></div><figcaption class="ol om gj gh gi on oo bd b be z dk translated">使用 Keycloak 验证用户身份后，访问 React 应用程序</figcaption></figure><h1 id="0bfd" class="mv mw in bd mx my oa na nb nc ob ne nf jt oc ju nh jw od jx nj jz oe ka nl nm bi translated">获取 React 应用程序的用户信息，注销和单点登录</h1><p id="bf28" class="pw-post-body-paragraph kk kl in km b kn nn jo kp kq no jr ks kt np kv kw kx nq kz la lb nr ld le lf ig bi translated">在第 2 部分的最后一部分，我们将向您展示如何显示:</p><ul class=""><li id="8773" class="lo lp in km b kn ko kq kr kt lq kx lr lb ls lf lt lu lv lw bi translated">用户名</li><li id="4c68" class="lo lp in km b kn lx kq ly kt lz kx ma lb mb lf lt lu lv lw bi translated">用户角色</li></ul><p id="3d6a" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">在我们的 React 应用上。</p><p id="069e" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们将向您展示如何从我们的 React 应用程序注销。</p><p id="f330" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">最后，我们将通过在我们的 React 应用程序之外注销来向您证明 SSO 是有效的。</p><p id="13a4" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">在我们的欢迎页面上，我们将:</p><ul class=""><li id="b419" class="lo lp in km b kn ko kq kr kt lq kx lr lb ls lf lt lu lv lw bi translated">添加用户名和角色</li><li id="1087" class="lo lp in km b kn lx kq ly kt lz kx ma lb mb lf lt lu lv lw bi translated">添加注销链接</li></ul><p id="c03a" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">记得在我们的 Keycloak 服务中，我们只添加了一个方法:CallLogin</p><p id="1bd5" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们将添加一个新方法 GetUserName 来获取我们的用户登录:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi rl"><img src="../Images/5c0fce9ba555864be709d38d42878f9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hhb9muE-_oLCHXR0zEv6Hw.png"/></div></div></figure><p id="501e" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">现在，让我们在应用程序组件的欢迎页面中使用它:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi rm"><img src="../Images/94a1b3ebb3825c4f9ea632f3a150ef72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sTiHTIitsi5mXY8C4vxhAw.png"/></div></div></figure><p id="2172" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们得到以下消息</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi rk"><img src="../Images/29a0902f41c874f9d950b5f67111dd0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K26FKc30n8tJFf8xf_qGfA.png"/></div></div></figure><p id="ff59" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">现在让我们看看角色</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi rn"><img src="../Images/0ab66a269a22284aa9b82c1671dbad4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Dbm6RxNNRohUTNcRJXe1Ww.png"/></div></div></figure><p id="1043" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">让我们使用它</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi ro"><img src="../Images/4acde050f4317a616a154a18ce5de07b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*11aGRukEcvf8bKAQ09Knkw.png"/></div></div></figure><p id="27bd" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们得到了结果</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi rk"><img src="../Images/e2c01a1825cf7fb1cfa449fcc6f9521d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HqRYNTUBt_wWq1i_bhXIJw.png"/></div></div></figure><p id="6a1c" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">所以我们可以看到获取所有用户信息是多么容易。<br/>角色由访问令牌返回，访问令牌由 Keycloak js 适配器解析并返回。</p><p id="dc51" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">最后，我们将添加一个按钮来注销用户，但首先我们需要在我们的 Keycloak 服务中添加方法:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi rp"><img src="../Images/34c296d052a109b73fd5d2cdbaf56712.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MNGTY-yfSXX3_4H79D4qxw.png"/></div></div></figure><p id="b1cd" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">让我们添加调用注销的按钮:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi rq"><img src="../Images/1299cdd672484d1ab05ab34e0a657b90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fiqssvsMvOcwPfmSibFEYw.png"/></div></div></figure><p id="3ba4" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们看到屏幕:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi rk"><img src="../Images/ffec244c8c2921b945dcb79163e6dc74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ubfxQjzHgez_HgX80qe9Ig.png"/></div></div></figure><p id="6a1e" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">当我们点击注销时，我们返回到</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi rk"><img src="../Images/7041f9261bc7ef61937e54c91f8d8cf7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F4X9kEUXgXJ2GEKNLWhg1w.png"/></div></div></figure><p id="e7d1" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">最后，让我们证明我们使用了单点登录。</p><p id="f731" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们通过点击“登录”再次登录</p><p id="e024" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们回到</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi rk"><img src="../Images/d3cfc7f2ec470efaca536b4325e2ca32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lDeXWEv_z8mnIK02uvJLcQ.png"/></div></div></figure><p id="502d" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">让我们转到 Keycloak 服务器:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi rk"><img src="../Images/e65f5e73466a27fb9c10b09b2971fe6c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mAB7qJo1Ee1NjK2cHwxu0A.png"/></div></div></figure><p id="017c" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">对于我们的应用程序 MyApp，我们可以看到会话的数量，也就是登录的用户数量。</p><p id="d759" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们可以点击 MyApp</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi rr"><img src="../Images/d0cc87256edc0549a393f3b42639e0a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1PeI-OicbGobKLfDG6husg.png"/></div></div></figure><p id="a30c" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们可以通过点击“显示会话”来查看所有会话</p><p id="cea5" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">如果我们单击会话中的“注销全部”，我们将使用户注销。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi rs"><img src="../Images/7658af222420aadebb68a4810dab7a14.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kVjhEZnDLqfA4BE_uT-jaQ.png"/></div></div></figure><p id="88fc" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">所有会话都将被删除。</p><p id="f22e" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">当我们回到我们的应用程序时，用户不再登录。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi rk"><img src="../Images/dbcb2a95c867c96c8d6204de7b7e2768.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LaE1wuscCLylLFEMRVi0dQ.png"/></div></div></figure><p id="7980" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">现在让我们做相反的事情，我们希望登录我们的用户，但是使用 KeyCloak:</p><p id="2a14" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们去<a class="ae lg" href="http://localhost:8080/realms/MyRealm/account/" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/realms/my realm/account/</a></p><p id="791a" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们得到页面:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi rk"><img src="../Images/1bcf0c7be2437022a2d506b47cefb403.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yWg8Z9cKgk1zwrS_bq9T6w.png"/></div></div></figure><p id="503d" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">让我们点击“登录”</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi rk"><img src="../Images/61f5fe1fa83dbfe61c55c01bf66313b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L0S5X2fcQsUkijpXkr4rsQ.png"/></div></div></figure><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi rt"><img src="../Images/8da07926a8d47e62eb18ecb70f3d12bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*520zZA-D7sDm4dACktVd4g.png"/></div></div></figure><p id="f438" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们登录后看到</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi rk"><img src="../Images/3590da6d0bdab583211e8506905a6c95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3pxaMCW6_Daa1wHuWPS0dg.png"/></div></div></figure><p id="e28f" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">现在，让我们看看进入我们的应用程序后会发生什么:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="oh oi di oj bf ok"><div class="gh gi rk"><img src="../Images/98dec67d337ce33fb8c4dd9ccf5c58e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cGfh8vHnz-6BspB9_iq8Ew.png"/></div></div></figure><p id="fcd9" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们的用户已经登录，因为这两个应用程序:<a class="ae lg" href="http://localhost:8080/admin/master/console/#/realms/MyRealm/clients/412f01ab-3297-47bd-8731-d40fd7344b2e" rel="noopener ugc nofollow" target="_blank">帐户</a>(<a class="ae lg" href="http://localhost:8080/realms/MyRealm/account/" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/realms/my Realm/account/</a>)和<a class="ae lg" href="http://localhost:8080/admin/master/console/#/realms/MyRealm/clients/c6015bba-a545-4114-841c-3a3425c001b2" rel="noopener ugc nofollow" target="_blank"> MyApp </a> <strong class="km io">在同一个领域 MyRealm </strong>，用户可以一次登录使用这两个应用程序！</p><p id="8e14" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">下一部分可用:<br/> <a class="ae lg" href="https://medium.com/@barlatiernicolas/security-in-react-and-webapi-in-asp-net-core-c-with-authentification-and-authorization-by-keycloak-f890d340d093" rel="noopener">第三部分:保护 ASP.NET 核心 C# REST Web </a></p><h1 id="7bca" class="mv mw in bd mx my oa na nb nc ob ne nf jt oc ju nh jw od jx nj jz oe ka nl nm bi translated"><strong class="ak"> <em class="of">参考文献</em> </strong></h1><div class="mc md gp gr me mf"><a href="https://blogs.infinitesquare.com/posts/web/open-id-connect-et-oauth-les-differents-flow-de-connexion" rel="noopener  ugc nofollow" target="_blank"><div class="mg ab fo"><div class="mh ab mi cl cj mj"><h2 class="bd io gy z fp mk fr fs ml fu fw im bi translated">OpenId Connect et OAuth:comment choisir son flow de connection？</h2><div class="mm l"><h3 class="bd b gy z fp mk fr fs ml fu fw dk translated">在总统的文章中，我们用一种开放的方式进行评论。在 cet 文章中，我看到了…</h3></div><div class="mn l"><p class="bd b dl z fp mk fr fs ml fu fw dk translated">blogs.infinitesquare.com</p></div></div><div class="mo l"><div class="ru l mq mr ms mo mt ki mf"/></div></div></a></div><div class="mc md gp gr me mf"><a href="https://www.oauth.com/oauth2-servers/single-page-apps" rel="noopener  ugc nofollow" target="_blank"><div class="mg ab fo"><div class="mh ab mi cl cj mj"><h2 class="bd io gy z fp mk fr fs ml fu fw im bi translated">单页应用程序- OAuth 2.0 简化版</h2><div class="mm l"><h3 class="bd b gy z fp mk fr fs ml fu fw dk translated">加载 JavaScript 和 HTML 后，单页应用程序(也称为基于浏览器的应用程序)完全在浏览器中运行…</h3></div><div class="mn l"><p class="bd b dl z fp mk fr fs ml fu fw dk translated">www.oauth.com</p></div></div><div class="mo l"><div class="rv l mq mr ms mo mt ki mf"/></div></div></a></div><div class="mc md gp gr me mf"><a href="https://www.keycloak.org/docs/latest/server_admin/index.html#_authentication-flows" rel="noopener  ugc nofollow" target="_blank"><div class="mg ab fo"><div class="mh ab mi cl cj mj"><h2 class="bd io gy z fp mk fr fs ml fu fw im bi translated">服务器管理指南</h2><div class="mm l"><h3 class="bd b gy z fp mk fr fs ml fu fw dk translated">用户用户是能够登录到您的系统的实体。它们可以有与自身相关的属性…</h3></div><div class="mn l"><p class="bd b dl z fp mk fr fs ml fu fw dk translated">www.keycloak.org</p></div></div><div class="mo l"><div class="rw l mq mr ms mo mt ki mf"/></div></div></a></div><div class="mc md gp gr me mf"><a href="https://docs.vmware.com/en/Single-Sign-On-for-VMware-Tanzu-Application-Service/1.14/sso/GUID-grant-types.html" rel="noopener  ugc nofollow" target="_blank"><div class="mg ab fo"><div class="mh ab mi cl cj mj"><h2 class="bd io gy z fp mk fr fs ml fu fw im bi translated">OAuth 2.0 授权类型</h2><div class="mm l"><h3 class="bd b gy z fp mk fr fs ml fu fw dk translated">本主题说明 OAuth 2.0 授权类型如何与不同的应用程序类型配合使用。授权码授权类型是…</h3></div><div class="mn l"><p class="bd b dl z fp mk fr fs ml fu fw dk translated">docs.vmware.com</p></div></div><div class="mo l"><div class="rx l mq mr ms mo mt ki mf"/></div></div></a></div><div class="mc md gp gr me mf"><a href="https://auth0.com/docs/get-started/applications/application-grant-types#available-grant-types" rel="noopener  ugc nofollow" target="_blank"><div class="mg ab fo"><div class="mh ab mi cl cj mj"><h2 class="bd io gy z fp mk fr fs ml fu fw im bi translated">申请授权类型</h2><div class="mm l"><h3 class="bd b gy z fp mk fr fs ml fu fw dk translated">应用程序授权类型(或流)是一些方法，应用程序可以通过这些方法获得访问令牌，并且您可以通过这些方法授予…</h3></div><div class="mn l"><p class="bd b dl z fp mk fr fs ml fu fw dk translated">auth0.com</p></div></div><div class="mo l"><div class="ry l mq mr ms mo mt ki mf"/></div></div></a></div><div class="mc md gp gr me mf"><a href="https://auth0.com/docs/get-started/authentication-and-authorization-flow/resource-owner-password-flow" rel="noopener  ugc nofollow" target="_blank"><div class="mg ab fo"><div class="mh ab mi cl cj mj"><h2 class="bd io gy z fp mk fr fs ml fu fw im bi translated">资源所有者密码流</h2><div class="mm l"><h3 class="bd b gy z fp mk fr fs ml fu fw dk translated">虽然我们不建议这样做，但是高度可信的应用程序可以使用资源所有者密码流(在 OAuth 中定义…</h3></div><div class="mn l"><p class="bd b dl z fp mk fr fs ml fu fw dk translated">auth0.com</p></div></div><div class="mo l"><div class="rz l mq mr ms mo mt ki mf"/></div></div></a></div><div class="mc md gp gr me mf"><a href="https://github.com/keycloak/keycloak-documentation/blob/main/securing_apps/topics/oidc/javascript-adapter.adoc" rel="noopener  ugc nofollow" target="_blank"><div class="mg ab fo"><div class="mh ab mi cl cj mj"><h2 class="bd io gy z fp mk fr fs ml fu fw im bi translated">keycloak-documentation/JavaScript-adapter . adoc 位于主 keycloak/keycloak-documentation</h2><div class="mm l"><h3 class="bd b gy z fp mk fr fs ml fu fw dk translated">在 GitHub 上创建一个帐户，为 keycloak/keycloak 文档开发做贡献。</h3></div><div class="mn l"><p class="bd b dl z fp mk fr fs ml fu fw dk translated">github.com</p></div></div><div class="mo l"><div class="qu l mq mr ms mo mt ki mf"/></div></div></a></div></div></div>    
</body>
</html>