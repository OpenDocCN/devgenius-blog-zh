# 反应内存泄漏:什么，为什么，以及如何清理它们！

> 原文：<https://blog.devgenius.io/react-memory-leaks-what-why-and-how-to-clean-them-up-93606a07de84?source=collection_archive---------0----------------------->

![](img/79b445cbf6dcac5a4e419a59c222d77d.png)

# **简介**

所有的 React 开发者都应该优化他们的应用程序。电脑没有无限的资源，一些浏览器甚至为几个打开的标签页消耗了大量内存。比方说，如果你打开了 15 个标签页，通常你需要超过 8GB 的内存来支持这个庞大的浏览器。如果他们中的大多数有内存泄漏，那么它真的可以降低您的计算机。对于 React 开发人员来说，如果做得不好或者根本不做，优化可能会令人头疼。开发团队通常把优化放在最后。相信我，在一年的开发之后，为了优化而重构代码是一件非常头疼的事情。内存泄漏会破坏您的项目，耗费大量的金钱和时间。**阅读这篇文章，了解为什么以及如何清理内存泄漏。**

# **什么是内存泄漏？**

在开发 React 应用程序时，内存泄漏是一个常见的问题。在 React 中，内存泄漏是当应用程序错误地管理内存分配时发生的一种资源泄漏。不再需要的内存不会被释放给其他进程使用。当一个对象存储在内存中，但不能被运行的代码访问时，也可能发生内存泄漏。

一旦出现内存泄漏，您将在控制台日志中看到类似的错误:

*警告:无法对卸载的组件执行反应状态更新。这是不可行的，但它表明您的应用程序中存在内存泄漏。要修复此问题，请取消 componentWillUnmount 方法中的所有订阅和异步任务。*

# **为什么要清理内存泄漏？**

内存泄漏是开发 React 应用程序时经常面临的问题。它会导致许多问题，包括:

*   通过减少可用内存量来影响项目的性能；
*   降低应用程序的速度；
*   随机刷新页面；
*   使系统崩溃；
*   用大量的查询使数据库过载；

为什么应该修复内存泄漏的一个例子是:

假设您正在使用数据库的 **React** 和 **Firebase** 构建一个应用程序。你创建了一个与 Firebase 互动频繁的网站。仅仅几个小时后，你就达到了一天 50k 的阅读极限。您检查了唯一的用户是您。这怎么可能呢？！现在你的网站关闭了，一天都不能工作，仅仅是因为你没有清理内存泄漏。

# **什么导致了内存泄漏？**

如果 React 应用程序创建了在安装组件时进行的订阅，并且在卸载这些组件时没有取消订阅，则会出现内存泄漏。

这些订阅可能是:

*   DOM 事件侦听器；
*   WebSocket 订阅；
*   对 API 的请求；

让我们看一个没有清除内存泄漏的组件的**坏例子**:

在上面的代码片段中，我们有一个简单的组件 **Cars** ，当它被挂载时，请求获取汽车信息的数据列表，并将汽车列表状态的值设置为从 API 获取的值。

场景:

1.  用户执行触发事件处理程序从 API 获取数据的操作。
2.  之后，用户点击链接，导航到另一个页面。
3.  即使用户已经不在最后一个页面上，也可以从 API 中检索数据并调用函数，更新现在不存在的**列表**状态。
4.  从长远来看，这会累积并消耗您的 API 获取限制和用户的浏览器资源。

# **如何清理内存泄漏？**

现代编程语言和框架拥有清除不再需要的数据的技术。react 也不例外。

基本上，当组件卸载时，我们需要删除订阅。为此有三种方法:

**1。使用布尔标志**

useEffect 挂钩具有在组件被卸载后做一些事情的功能。我们简单地创建变量 **isMounted** 并创建一个 if 子句来检查是否应该获取数据。由于组件已卸载，因此不再提取数据。

**2。使用人工控制器**

Javascript 有[**abort controller**](https://developer.mozilla.org/en-US/docs/Web/API/AbortController)。AbortController 接口代表一个控制器对象，允许您根据需要中止一个或多个 Web 请求。

现在，当用户导航到一个新页面时，AbortController 取消请求，内存泄漏被清除。

**3。使用安装后使用状态挂钩**

有一个很棒的库 [use-state-if-mounted](https://www.npmjs.com/package/use-state-if-mounted) 。它的工作方式类似于 useState 钩子，但是它也在更新状态之前检查该组件是否被挂载。

**4。清算时间间隔**

您可以使用 setInterval 函数创建每秒左右重复的任务。这可能会导致内存泄漏错误，必须在卸载后清除。

# **如何检测内存泄漏？**

在您从 react 得到错误之前，有一种方法可以检测内存泄漏。只需使用谷歌 chrome 的开发者工具。转到**内存选项卡**获取**堆快照**并比较采取行动前后的时间。

![](img/85b1cbc43902561949c328d02403a5c9.png)

# **结论**

在本文中，您会发现:

*   什么是内存泄漏；
*   什么导致内存泄漏；
*   为什么修复内存泄漏很重要；
*   如何用四种方法修复那些内存泄漏；
*   如何检测那些内存泄漏；

![](img/fd1deb38ed1b65a99b149d75ea660a58.png)