<html>
<head>
<title>Google Container Registry (GCR): Logging into a private registry from GKE, GCE, Docker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">谷歌容器注册(GCR):登录到一个私人注册从 GKE，GCE，Docker</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/google-container-registry-gcr-logging-into-a-private-registry-from-gke-gce-docker-e627643e47c5?source=collection_archive---------5-----------------------#2022-02-03">https://blog.devgenius.io/google-container-registry-gcr-logging-into-a-private-registry-from-gke-gce-docker-e627643e47c5?source=collection_archive---------5-----------------------#2022-02-03</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><h1 id="4193" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">文章章节</h1><ul class=""><li id="08e2" class="ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated"><a class="ae la" href="#9093" rel="noopener ugc nofollow">文章上下文</a></li><li id="8b34" class="ki kj in kk b kl lb kn lc kp ld kr le kt lf kv kw kx ky kz bi translated"><a class="ae la" href="#2a9a" rel="noopener ugc nofollow">先决条件</a></li><li id="9740" class="ki kj in kk b kl lb kn lc kp ld kr le kt lf kv kw kx ky kz bi translated"><a class="ae la" href="#69d6" rel="noopener ugc nofollow">创建 IAM 角色成员的服务帐户</a></li><li id="227a" class="ki kj in kk b kl lb kn lc kp ld kr le kt lf kv kw kx ky kz bi translated"><a class="ae la" href="#a001" rel="noopener ugc nofollow">服务账户凭证</a></li><li id="c7a3" class="ki kj in kk b kl lb kn lc kp ld kr le kt lf kv kw kx ky kz bi translated"><a class="ae la" href="#a841" rel="noopener ugc nofollow">通过 Docker </a>从计算资源登录</li><li id="3fbf" class="ki kj in kk b kl lb kn lc kp ld kr le kt lf kv kw kx ky kz bi translated"><a class="ae la" href="#3ef1" rel="noopener ugc nofollow">在 GKE 上拉动图像</a></li><li id="d7db" class="ki kj in kk b kl lb kn lc kp ld kr le kt lf kv kw kx ky kz bi translated"><a class="ae la" href="#8b83" rel="noopener ugc nofollow">结论</a></li></ul><h1 id="9093" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">语境</h1><p id="3c58" class="pw-post-body-paragraph lg lh in kk b kl km li lj kn ko lk ll kp lm ln lo kr lp lq lr kt ls lt lu kv ig bi translated">在最近将部分开发工具链迁移到 Google 云平台的过程中，我们的团队发现了一些配置上的细微差别，我们觉得与他人分享可能有助于解决一些令人头疼的问题。</p><p id="222f" class="pw-post-body-paragraph lg lh in kk b kl lv li lj kn lw lk ll kp lx ln lo kr ly lq lr kt lz lt lu kv ig bi translated">当通读 Google 文档时，乍一看，似乎我们所要做的就是创建一个服务帐户，并确保该服务帐户拥有访问容器存储桶的权限。所需的权限记录为<a class="ae la" href="https://cloud.google.com/container-registry/docs/access-control" rel="noopener ugc nofollow" target="_blank"> <em class="ma">角色/存储. objectViewer </em> </a>。看起来很简单，除了这在我们的例子中不起作用。</p><p id="5ebb" class="pw-post-body-paragraph lg lh in kk b kl lv li lj kn lw lk ll kp lx ln lo kr ly lq lr kt lz lt lu kv ig bi translated">本演练介绍如何配置从私有 GCR 注册中心提取图像的必要组件。我们将主要使用地形，但也有其他方法来实现这一点。</p><h1 id="2a9a" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">先决条件</h1><ul class=""><li id="d39a" class="ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">已启用容器注册表 API</li><li id="5a29" class="ki kj in kk b kl lb kn lc kp ld kr le kt lf kv kw kx ky kz bi translated">一张图片已经被推送到私人注册中心(<a class="ae la" href="https://github.com/terraform-google-modules/terraform-google-github-actions-runners/tree/v3.0.0/examples/gh-runner-gke-dind" rel="noopener ugc nofollow" target="_blank">这里有一个来自谷歌</a>的工作流程示例)</li><li id="e459" class="ki kj in kk b kl lb kn lc kp ld kr le kt lf kv kw kx ky kz bi translated">为您的项目安装/配置的 Terraform</li><li id="aaef" class="ki kj in kk b kl lb kn lc kp ld kr le kt lf kv kw kx ky kz bi translated">对地形的一般理解</li><li id="321e" class="ki kj in kk b kl lb kn lc kp ld kr le kt lf kv kw kx ky kz bi translated">为您的项目安装/配置的 gcloud SDK</li></ul><h1 id="69d6" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">创建具有 IAM 角色成员身份的服务帐户</h1><p id="4794" class="pw-post-body-paragraph lg lh in kk b kl km li lj kn ko lk ll kp lm ln lo kr lp lq lr kt ls lt lu kv ig bi translated">以下代码片段概述了完成服务帐户和必要角色的创建所需的 Terraform 代码。请注意，从私有 GCR 注册中心提取映像需要两个角色。</p><ul class=""><li id="4e3e" class="ki kj in kk b kl lv kn lw kp mb kr mc kt md kv kw kx ky kz bi translated">storage.objectViewer(查看和获取对象，即容器图像)</li><li id="9c61" class="ki kj in kk b kl lb kn lc kp ld kr le kt lf kv kw kx ky kz bi translated">artifactregistry.reader(查看和获取工件，即容器清单)</li></ul><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="79de" class="mn jl in mj b gy mo mp l mq mr">terraform {<br/>  ...<br/>}</span><span id="1449" class="mn jl in mj b gy ms mp l mq mr">resource “google_service_account” “gcr_pull” {<br/>  account_id = “service-account-gcr-pull”<br/>  display_name = “Service Account for Pulling images from GCR”<br/>}</span><span id="66f6" class="mn jl in mj b gy ms mp l mq mr">resource “google_project_iam_member” “storage_viewer” {<br/>  count = 1<br/>  project = var.project<br/>  role = “roles/storage.objectViewer”<br/>  member = “serviceAccount:${google_service_account.gcr_pull.email}”<br/>}</span><span id="a1c8" class="mn jl in mj b gy ms mp l mq mr">resource “google_project_iam_member” “artifact_reader” {<br/>  count = 1<br/>  project = var.project<br/>  role = “roles/artifactregistry.reader”<br/>  member = “serviceAccount:${google_service_account.gcr_pull.email}”<br/>}</span><span id="2cf9" class="mn jl in mj b gy ms mp l mq mr">output "service_account_email" {<br/>  description = "Service account email (for single use)."<br/>  value       = google_service_account.gcr_pull.email<br/>}</span></pre><h1 id="a001" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">服务帐户凭据</h1><p id="b75e" class="pw-post-body-paragraph lg lh in kk b kl km li lj kn ko lk ll kp lm ln lo kr lp lq lr kt ls lt lu kv ig bi translated">创建服务帐户后，我们需要生成私钥，以便作为服务帐户向 GCR 私有注册中心进行身份验证。这在 CI/CD 管道和其他自动化流程中非常有用。</p><p id="fc9a" class="pw-post-body-paragraph lg lh in kk b kl lv li lj kn lw lk ll kp lx ln lo kr ly lq lr kt lz lt lu kv ig bi translated">注意:您可以使用 Terraform 实现这一点，但是您应该知道，生成的 JSON 文件将以 Terraform 状态存储，这可能是一个安全问题。最安全的替代方法是从<a class="ae la" href="https://cloud.google.com/iam/docs/creating-managing-service-account-keys#console" rel="noopener ugc nofollow" target="_blank"> GCP 控制台</a>创建密钥，或者通过下面的代码片段用 gcloud 创建密钥。从控制台获取帐户电子邮件地址是最容易的，但是您也可以从前面的 Terraform 输出中获取。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="8e89" class="mn jl in mj b gy mo mp l mq mr">gcloud iam service-accounts keys create <strong class="mj io"><em class="ma">&lt;output_filename&gt;</em></strong> --iam-account=<strong class="mj io"><em class="ma">&lt;account_email&gt;</em></strong></span></pre><p id="3249" class="pw-post-body-paragraph lg lh in kk b kl lv li lj kn lw lk ll kp lx ln lo kr ly lq lr kt lz lt lu kv ig bi translated">一旦创建了 JSON 密钥，就可以将文件保存为 Google Secret、HashiCorp Vault Secret 或本地终端中的变量引用。出于测试目的，您可以将 JSON 内容保存到<strong class="kk io"><em class="ma">service _ account _ keys . JSON</em></strong>。</p><h1 id="a841" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">通过 Docker 从计算资源登录</h1><p id="9e4f" class="pw-post-body-paragraph lg lh in kk b kl km li lj kn ko lk ll kp lm ln lo kr lp lq lr kt ls lt lu kv ig bi translated">当您在本地文件中有可用的服务帐户密钥时，您可以通过从计算资源(当然安装了 Docker 引擎)登录 Docker 来验证访问和权限。</p><p id="39cb" class="pw-post-body-paragraph lg lh in kk b kl lv li lj kn lw lk ll kp lx ln lo kr ly lq lr kt lz lt lu kv ig bi translated">如果您要启动一个 GCE 实例，您应该确保先前创建的服务帐户与该实例相关联。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="6ef9" class="mn jl in mj b gy mo mp l mq mr">docker login -u _json_key --password-stdin <a class="ae la" href="https://gcr.io" rel="noopener ugc nofollow" target="_blank">https://gcr.io</a> &lt; service_account_keys.json</span></pre><p id="4f0c" class="pw-post-body-paragraph lg lh in kk b kl lv li lj kn lw lk ll kp lx ln lo kr ly lq lr kt lz lt lu kv ig bi translated">您应该会看到登录成功的响应！你现在可以从你的私人 GCR 注册表中提取图像。</p><h2 id="3d8a" class="mn jl in bd jm mt mu dn jq mv mw dp ju kp mx my jy kr mz na kc kt nb nc kg nd bi translated">这有什么用？</h2><ul class=""><li id="1ad6" class="ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">验证访问和权限</li><li id="1741" class="ki kj in kk b kl lb kn lc kp ld kr le kt lf kv kw kx ky kz bi translated">执行本地容器验证</li><li id="e5c1" class="ki kj in kk b kl lb kn lc kp ld kr le kt lf kv kw kx ky kz bi translated">对私有的 GitHub/GitLab 运行程序使用这种模式</li></ul><h1 id="3ef1" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">提取 GKE 的图像</h1><p id="8987" class="pw-post-body-paragraph lg lh in kk b kl km li lj kn ko lk ll kp lm ln lo kr lp lq lr kt ls lt lu kv ig bi translated">最后，我们如何将所有这些联系在一起，以便能够使用托管在我们的私人 GCR 注册中心的图像？</p><p id="e0aa" class="pw-post-body-paragraph lg lh in kk b kl lv li lj kn lw lk ll kp lx ln lo kr ly lq lr kt lz lt lu kv ig bi translated">很可能您的组织希望确保您能够控制您的生态系统的开发工具，这通常意味着管理您自己的容器映像骨干。这不仅确保了您对资源的控制，还加强了您的安全状况。</p><h2 id="5ef4" class="mn jl in bd jm mt mu dn jq mv mw dp ju kp mx my jy kr mz na kc kt nb nc kg nd bi translated">您希望确保解决以下配置问题:</h2><ul class=""><li id="28de" class="ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">群集节点使用以前创建的服务帐户</li><li id="c90b" class="ki kj in kk b kl lb kn lc kp ld kr le kt lf kv kw kx ky kz bi translated">您的 Kubernetes 资源利用服务帐户的拉取秘密</li></ul><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="5c75" class="mn jl in mj b gy mo mp l mq mr"><strong class="mj io"># Terraform GKE node pool; adding the service account to you nodes</strong></span><span id="ba16" class="mn jl in mj b gy ms mp l mq mr">resource "google_container_node_pool" "node_pool" {<br/>  <br/>  ...<br/>    <br/>    node_config {<br/>    machine_type = var.machine_type<br/>    image_type = var.image_type<br/>    disk_size_gb = var.disk_size_gb<br/>    disk_type = var.disk_type<br/>    preemptible = var.preemptible<br/>    <strong class="mj io"><em class="ma">service_account = var.service_account_email</em></strong><br/>  }<br/>}</span></pre><p id="41a0" class="pw-post-body-paragraph lg lh in kk b kl lv li lj kn lw lk ll kp lx ln lo kr ly lq lr kt lz lt lu kv ig bi translated">如果您已经配置了您的集群和节点池，您可以轻松地返回到您的 Terraform 配置并更新服务帐户，然后执行<strong class="kk io"> <em class="ma"> terraform apply </em> </strong>以进行更新。*这假定您保存了 tfstate 和缓存。</p><p id="891c" class="pw-post-body-paragraph lg lh in kk b kl lv li lj kn lw lk ll kp lx ln lo kr ly lq lr kt lz lt lu kv ig bi translated">为了从 GKE 资源的私有 GCR 注册表中提取图像，您需要首先设置<strong class="kk io"><em class="ma">service _ account _ key . JSON</em></strong>作为 Kubernetes 的秘密。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="0ae3" class="mn jl in mj b gy mo mp l mq mr">kubectl create secret docker-registry <strong class="mj io"><em class="ma">gcr-pull-secret</em></strong> \<br/>--namespace my-custom-app \<br/>--docker-server=https://gcr.io \<br/>--docker-username=_json_key \<br/>--docker-password="$(cat service_account_key.json)" \<br/>--docker-email='<strong class="mj io"><em class="ma">&lt;service_account_email&gt;</em></strong>'</span></pre><p id="53d8" class="pw-post-body-paragraph lg lh in kk b kl lv li lj kn lw lk ll kp lx ln lo kr ly lq lr kt lz lt lu kv ig bi translated">既然这个秘密在所提供的名称空间中是可用的(请密切注意名称空间，这有时会让人出错)，那么您可以设置一个 pod(例如)来使用新形成的秘密。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="9664" class="mn jl in mj b gy mo mp l mq mr"><strong class="mj io">apiVersion</strong>: v1<br/><strong class="mj io">kind</strong>: Pod<br/><strong class="mj io">metadata</strong>:<br/>  <strong class="mj io">name</strong>: test-private-registry<br/><strong class="mj io">spec</strong>:<br/>  <strong class="mj io">containers</strong>:<br/>  - <strong class="mj io">name</strong>: private-registry-container<br/>    <strong class="mj io">image</strong>: gcr.io/cool-project-123/my-app:4.5.6<br/>  <strong class="mj io">imagePullSecrets</strong>:<br/>  - <strong class="mj io">name</strong>: <strong class="mj io"><em class="ma">gcr-pull-secret</em></strong></span></pre><p id="2e40" class="pw-post-body-paragraph lg lh in kk b kl lv li lj kn lw lk ll kp lx ln lo kr ly lq lr kt lz lt lu kv ig bi translated">一旦您应用/部署了 pod，您应该不会有问题接收致命的“权限被拒绝”消息。</p><h1 id="8b83" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">结论</h1><p id="7d1c" class="pw-post-body-paragraph lg lh in kk b kl km li lj kn ko lk ll kp lm ln lo kr lp lq lr kt ls lt lu kv ig bi translated">希望这能帮到一些人。它确实帮助我写出了这篇文章，所以当我不可避免地忘记为什么我似乎不能从我的私人 GCR 注册表中获取图片以从我的 GKE 资源中提取时，我可以参考这篇文章。</p><p id="b4f3" class="pw-post-body-paragraph lg lh in kk b kl lv li lj kn lw lk ll kp lx ln lo kr ly lq lr kt lz lt lu kv ig bi translated"><em class="ma">编码快乐！</em></p></div></div>    
</body>
</html>