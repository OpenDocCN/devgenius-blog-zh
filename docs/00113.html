<html>
<head>
<title>Let's dive into setting up AWS Glue with an ETL job, then querying the data via AWS Athena</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">让我们深入研究如何设置带有 ETL 作业的 AWS Glue，然后通过 AWS Athena 查询数据</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/example-of-an-etl-job-in-aws-glue-and-query-in-aws-athena-383d9ec89400?source=collection_archive---------0-----------------------#2020-02-07">https://blog.devgenius.io/example-of-an-etl-job-in-aws-glue-and-query-in-aws-athena-383d9ec89400?source=collection_archive---------0-----------------------#2020-02-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/876b27d4818822367270674b0d4586d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Gt2RwdI2YFdKW2JQ.jpg"/></div></div></figure><p id="805a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们来看一个简单的端到端流程，使用 AWS Glue 将数据从一种格式转换为更容易查询的格式，然后使用 AWS Athena 查询它。我们将只通过控制台来研究这个问题，在以后的文章中，我们将更多地关注如何使用 terraform 来自动化这个问题。</p><p id="b722" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">本帖所有数据均来自 apache 日志，可从<a class="ae kw" href="https://github.com/elastic/examples/blob/master/Common%20Data%20Formats/apache_logs/apache_logs" rel="noopener ugc nofollow" target="_blank"> Github </a>下载。数据被分成 5 部分，以模拟日志是在 5 个不同的时间上传的。</p><p id="b1c8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你可以在这里下载拆分:<a class="ae kw" href="https://craig.goddenpayne.co.uk/assets/img/glue-athena-1/log1.log" rel="noopener ugc nofollow" target="_blank">日志 1 </a> <a class="ae kw" href="https://craig.goddenpayne.co.uk/assets/img/glue-athena-1/log2.log" rel="noopener ugc nofollow" target="_blank">日志 2 </a> <a class="ae kw" href="https://craig.goddenpayne.co.uk/assets/img/glue-athena-1/log3.log" rel="noopener ugc nofollow" target="_blank">日志 3 </a> <a class="ae kw" href="https://craig.goddenpayne.co.uk/assets/img/glue-athena-1/log4.log" rel="noopener ugc nofollow" target="_blank">日志 4 </a> <a class="ae kw" href="https://craig.goddenpayne.co.uk/assets/img/glue-athena-1/log5.log" rel="noopener ugc nofollow" target="_blank">日志 5 </a></p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><h1 id="f4f4" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">上传数据</h1><p id="6d91" class="pw-post-body-paragraph jy jz iq ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">为了在 AWS 中查询数据，您需要将数据文件上传到 S3 存储桶中，您可以使用上面的示例文件，或者只是一些随机的 apache 日志文件。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mh"><img src="../Images/07851debce5eb6ba9ddf9cee31d6e80c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*QGbRZAxn6z8Jhieg.png"/></div></div><figcaption class="mm mn gj gh gi mo mp bd b be z dk translated">S3 水桶</figcaption></figure></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><h1 id="0b45" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">设置 AWS 粘合作业</h1><p id="6ed8" class="pw-post-body-paragraph jy jz iq ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">在 AWS 控制台中，搜索 Glue。打开后，导航到数据库选项卡。创建一个新数据库，我创建了一个名为 craig-test 的数据库。该数据库用作数据目录，存储关于模式信息的信息，而不是实际数据。</p><div class="mq mr gp gr ms mt"><a href="https://www.datadriveninvestor.com/2020/03/29/microsoft-having-an-edge-over-chrome/" rel="noopener  ugc nofollow" target="_blank"><div class="mu ab fo"><div class="mv ab mw cl cj mx"><h2 class="bd ir gy z fp my fr fs mz fu fw ip bi translated">数据驱动的投资者|微软比 Chrome 有“优势”</h2><div class="na l"><h3 class="bd b gy z fp my fr fs mz fu fw dk translated">简史我从来不是浏览器的粉丝，确切地说，我只是一个浏览器的粉丝，Chrome。这是我的…</h3></div><div class="nb l"><p class="bd b dl z fp my fr fs mz fu fw dk translated">www.datadriveninvestor.com</p></div></div><div class="nc l"><div class="nd l ne nf ng nc nh jw mt"/></div></div></a></div><p id="1b86" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查 tables 部分，您将看到一条消息，表明在数据目录中没有定义表。接下来要做的是创建一个爬虫，它将收集关于数据的元数据。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ni"><img src="../Images/fe701efc424a77cc2f99b912422625f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*yZ9tCYFeYgUI7b1T.png"/></div></div><figcaption class="mm mn gj gh gi mo mp bd b be z dk translated">数据图表视图</figcaption></figure></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><h1 id="454f" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">创建爬虫</h1><p id="1d09" class="pw-post-body-paragraph jy jz iq ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">在胶水中，创造一个爬虫。</p><p id="b137" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让爬虫查看 S3 存储桶，并将其设置为写入之前创建的数据库数据目录。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nj"><img src="../Images/cfb4a19e8ac1cc0eb3869bd4cb1d8464.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*v47h3OsfNjXILP9v.png"/></div></div><figcaption class="mm mn gj gh gi mo mp bd b be z dk translated">添加爬网程序</figcaption></figure><p id="7ad8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您将 crawler 设置为按需，则需要在创建完 crawler 后运行它。</p><p id="7ce3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Glue 将非常快速地爬行并确定日志文件的格式。对于我的例子，它提到数据看起来像是 apache 格式，并且它详细描述了模式看起来像什么。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nk"><img src="../Images/4db1901d1c631defd34277d216ead6d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*pAC4NaLwFtato4HE.png"/></div></div><figcaption class="mm mn gj gh gi mo mp bd b be z dk translated">模式外观的示例</figcaption></figure><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/2ba3c13e6f6054c606b277c9c5f9a261.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*R7cwqNSD9riIW80c.png"/></div></div><figcaption class="mm mn gj gh gi mo mp bd b be z dk translated">模式的更多细节</figcaption></figure></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><h1 id="f760" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">创建 ETL 作业</h1><p id="93a0" class="pw-post-body-paragraph jy jz iq ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">下一步是创建一个 ETL 作业，它将获取日志，并将它们从 apache 日志格式转换成 parquet 格式的列数据。</p><p id="6b73" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在 Athena 中使用诸如 parquet 之类的格式进行查询要比每次都扫描整个数据更加高效和经济。</p><p id="3574" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建了 n Glue job，并添加了一个数据源，我使用了 craig-test bucket。设置目标桶，我使用 craig-test-processed 桶。</p><p id="9e65" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">选择您想要的拼花格式的目的地。点击 next，apache spark 代码将会自动生成，但是很容易阅读并在需要时进行修改。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nm"><img src="../Images/69e902ece3165886363f2b8bbe39403c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*o2jMga_XFGhzZLKU.png"/></div></div><figcaption class="mm mn gj gh gi mo mp bd b be z dk translated">自动生成的代码</figcaption></figure><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nn"><img src="../Images/fac0c9f9f29f941d938fa978a6b88b7b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Jg3JU_iBUq50U3K4.png"/></div></div><figcaption class="mm mn gj gh gi mo mp bd b be z dk translated">自动映射的列</figcaption></figure><p id="b22a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">完成创建作业后，运行该作业。几分钟后这项工作就完成了。</p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><h1 id="914f" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">问题或故障</h1><p id="2041" class="pw-post-body-paragraph jy jz iq ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">在我第一次运行时，我忘记了权限，但是如果您遇到任何问题，通过查看 Cloudwatch 很容易诊断出来。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi no"><img src="../Images/d6caee8d2588c99f30e71b4ecd00acc5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*LsH7K9O0Puy7sGvu.png"/></div></div><figcaption class="mm mn gj gh gi mo mp bd b be z dk translated">云观察</figcaption></figure><p id="5c28" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在我的情况下，这是由于 IAM 权限。我忘了允许 glue 角色访问我的输出桶。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi np"><img src="../Images/c9592f5b82c0e4a9595c221276e3332f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*WVqxrgj8oB7HAwF0.png"/></div></div><figcaption class="mm mn gj gh gi mo mp bd b be z dk translated">木桶策略</figcaption></figure><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nq"><img src="../Images/13381683851f9cec10a5601edfdf2595.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ID0V5Y1GbV9KxwaL.png"/></div></div><figcaption class="mm mn gj gh gi mo mp bd b be z dk translated">作业运行</figcaption></figure></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><h1 id="363b" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">重建模式</h1><p id="3b30" class="pw-post-body-paragraph jy jz iq ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">检查 s3 处理的存储桶，您应该会发现 parquet 文件已经准备好，可以让我使用 AWS Athena 进行查询。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nm"><img src="../Images/bf1e90796ddb7647b1e94241067601b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*AFQrM4k56hU7X7j9.png"/></div></div><figcaption class="mm mn gj gh gi mo mp bd b be z dk translated">S3 产量</figcaption></figure><p id="498e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您需要重新构建模式以包含新的数据集。在我的例子中，我更新了包括转换的柱状拼花地板格式。</p><p id="6fad" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这一次，创建一个新的爬行器，并爬行包含已处理文件的 S3 桶。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nr"><img src="../Images/fbfdc5ab92aede9ca1407db62cf838d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*B8SoGFr0K7PULaNa.png"/></div></div><figcaption class="mm mn gj gh gi mo mp bd b be z dk translated">添加爬网程序</figcaption></figure><p id="22d9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一旦运行了它，并且模式已经被添加到数据目录中，就该进行查询了。</p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><h1 id="9bf9" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">使用 AWS Athena 进行查询</h1><p id="02a9" class="pw-post-body-paragraph jy jz iq ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">一旦进入 Athena，您就可以从日志中查询数据。查询拼花地板日志既经济又快捷。而查询原始数据既昂贵又缓慢。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ns"><img src="../Images/6e99612bae862b72c15943fef0a7a15d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*c6M_1GvON0cvnUGp.png"/></div></div><figcaption class="mm mn gj gh gi mo mp bd b be z dk translated">AWS 雅典娜</figcaption></figure><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nt"><img src="../Images/6d4037e85761aac9a07315c9dc6c962c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*n6l1Rbdd8YXS0gT8.png"/></div></div><figcaption class="mm mn gj gh gi mo mp bd b be z dk translated">雅典娜查询</figcaption></figure><p id="08c0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这个简单查询的不同之处在于拼花地板数据。如果你看看处理的数据量，你会发现它会贵多少</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nm"><img src="../Images/dace84e9fd911b54b23ddc6eaa3f8ca4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*BSjgf-pdOf_fuyE1.png"/></div></div></figure><h1 id="9bb4" class="le lf iq bd lg lh nu lj lk ll nv ln lo lp nw lr ls lt nx lv lw lx ny lz ma mb bi translated">结论</h1><p id="9c66" class="pw-post-body-paragraph jy jz iq ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">尽可能以结构化格式查询数据</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="nz oa l"/></div></figure></div></div>    
</body>
</html>