# Rsync

> 原文：<https://blog.devgenius.io/rsync-5fd794e8c377?source=collection_archive---------20----------------------->

我一直在探索 glusterfs 的地理复制特性，偶然发现了一个叫做 rsync 的工具。什么是 rsync，它做什么？

![](img/30463a80de546dbf7ca6fbfa57492697.png)

由[德鲁·科夫曼](https://unsplash.com/@drewcoffman?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄的照片

想象一下你的个人图书馆。书架上整齐地堆放着书籍。你定期给它们掸去灰尘，在研究的时候参考它们，甚至是为了好玩，并且每当你增加一本新书时也扩大图书馆。这是一个快乐的场景。

你所有的书都在一个地方。听起来没那么糟。但是如果房子着火了，甚至图书馆由于某种原因被毁坏了，那该怎么办呢(发挥想象力)。现在，对于一个依赖这些短信进行日常活动的人来说，这将是一个巨大的损失。

让我们假设，你开始一个新的图书馆。这一次，你要确保你不会经历丢失书籍的痛苦和找回收藏的任务(当然这不会是一样的)。

所以，你为图书馆买的每本书，你都买了一本，然后把它藏在一个远离你日常接触的地方。你只是在创造一个你的图书馆的精确复制品，比如说你的避暑别墅。

即使您丢失了当前图书馆中的所有书籍，您仍然可以取回所有书籍，因为您在其他地方已经有了副本。

现在，让我们谈一点技术问题。书→数据。你有数据，也许你只是在管理一个数据库，并且担心如果当前的安排失败了会发生什么。通过当前的安排，我的意思是所有的服务器现在一起工作来托管你的数据库。

这将意味着数据和最终业务的完全丢失。有人可能会说，让我们只保留我们正在创建的数据的副本。听起来很正常。因此，不是一个单一的副本，而是在服务器中复制数据，这些服务器协同工作来托管数据库服务器。现在，如果不是一台服务器出现故障，而是整个基础架构因某种自然灾害而停止运行，会怎么样？

这就是地理复制派上用场的地方。数据不仅被复制，而且在从其中复制数据的系统中被移除，从而即使当前基础设施发生故障，在这种情况下复制的数据也是安全的，不会受到首先导致实际站点中的故障的任何因素的影响。

有很多软件，开放的和专有的，都可以为你正在处理的文件创建备份。也有一些软件可以定期备份你的整个文件系统。Glusterfs 是一个集群化的网络文件系统，人们了解地理复制的需求，因此 glusterfs 具有这个特性。

我们将在其他故事中使用 glusterfs 研究地理复制的整体机制，今天的重点是 Rsync。

注意:无论我从现在开始解释什么，都可能需要一个基于 nix 的系统来正确理解。

现在，问题是 rsync 做什么？

如果你遵循他们网站上给出的定义，它会说“rsync 是一个提供快速增量文件传输的开源工具”。这里没有提到地理复制，但我们确实有一些与快速增量文件传输相关的东西。

因此，使用 rsync，可以将文件从系统 A 传输到系统 B，它使用的是增量逻辑。也就是说，如果之前我们将系统 A 中目录 xyz 的内容复制到系统 B 中的目录 mno，在向目录 xyz 添加新文件之后，如果我们再次启动 rsync，则只会传输更改，而不会再次传输整个目录。

安装 rsync 非常简单。在 fedora/centos/rhel 的情况下，只需做一个简单的

```
# dnf install rsync
```

类似地，在 debian 和 ubuntu 的情况下，

```
# apt-get install rsync
```

在开始使用 rsync 之前。有人可能会问…一个人应该。问题是，我如何将文件从系统 A 传输到系统 b。它是否每次都要求我提供凭据？或者是自动完成的，也许是通过存储我的密码或密钥？

是的，我们必须使用命令创建一个公钥(如果它还不存在的话),

```
# ssh-keygen
```

这将提示用户询问将在其中创建私钥和公钥的文件的位置和名称。还有密码短语。现在，如果您的密钥被泄露，密码就像一层额外的安全层。在这种情况下，您可以只有一个空的密码短语。

我之前忽略的一点是，密钥的生成必须在原始系统中完成，也就是说，在您传输文件的系统中完成，因为正是从这个系统中，有人会尝试访问备份系统并告诉它接受文件。因此，这意味着系统 A 的公共凭证必须存在于系统 B 中，以便系统 B 验证系统 A 是否试图联系它。

因此，必须将创建的公钥复制到系统 b。现在 ssh 实用程序通过提供另一个命令行实用程序来处理这个问题，

```
# ssh-copy-id <system_b_user>@<system_b_hostname>
```

该命令将编辑服务器中的 authorized_keys 文件。然后创建一个. ssh 目录(如果它还不存在的话)。最后在那里添加密钥。

因此，我们有了密码 ssh 设置。人们可以直接跳过 rsync 并开始使用它。

让我们在系统 a 中创建一个目录 xyz。

```
[root@systemA Desktop]# mkdir xyz
```

和系统 b 中的 mno。

```
[root@systemB Desktop]# mkdir mno
```

完成后，让我们使用 touch 在 xyz 中创建 1K 左右的文件。

```
[root@systemA Desktop]# touch xyz/file{1..1000}
```

在清单中，可以看到在 xyz 目录中创建的 1K 文件。下一步是使用 rsync 将目录 xyz 中的文件与目录 mno 同步。

```
[root@systemA Desktop]# rsync -av xyz/ root@systemB:/home/sysB/mno
```

现在，在列出 mno 下的文件时，可以看到所有 1K 文件。

让我们看看这里使用的选项。

*   答:这很有用，原因如下:

1.递归复制文件和目录

2.将符号链接复制为符号链接

3.保留权限

4.保护者团体

5.保留修改时间

6.保留所有权

*   v:冗长

除了这些，我们还有其他选择。应该通过 rsync 的手册页来了解所有的选项。

现在，回到我们使用的命令。通用格式可以以这种方式考虑，

```
rsync -<options> <source directory/files> <destination>
```

现在，目的地可以是远程系统，甚至是同一系统中的某个其他目录。

现在，需要注意的一点是，在我们用来跨系统同步文件的命令中，我们提到了“xyz/”，而不是“xyz”。原因是我们只想将 xyz 内部的内容与远程系统同步，而不是与 xyz 目录本身同步。

假设，我们有一个场景，其中，我删除了目录 xyz 中的一个文件。假设我们只做下面的事情，

```
[root@systemA Desktop]# rm xyz/file1
[root@systemA Desktop]# rsync -av xyz/ root@systemB:/home/sysB/mno
```

这会同步文件吗？即删除 mno 中的文件 file1？

嗯，不。不是的。

为此，必须使用“—删除”标志。

```
[root@systemA Desktop]# rsync -av --delete xyz/ \
root@systemB:/home/sysB/mno
```

现在，如果检查目录 mno，可以看到文件已同步，文件 1 已删除。

我们还没有深入研究 rsync，也就是内部工作方式等等。原因是在互联网上已经有大量关于它的工作的可用资源。写这个故事是为了让 glustrfs 的用户或贡献者能够理解 rsync 在 glusterfs 工作中的重要性。

人们可能已经注意到 rsync 本身不能用于地理复制。它只是做增量文件传输。因此，在给定的文件系统平台中，地理复制的逻辑必须存在于围绕 rsync 的软件中。