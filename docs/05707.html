<html>
<head>
<title>Laravel Queued job, with API .</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Laravel排队作业，带API。</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/laravel-queued-job-with-api-d9f01ee7235a?source=collection_archive---------0-----------------------#2021-10-09">https://blog.devgenius.io/laravel-queued-job-with-api-d9f01ee7235a?source=collection_archive---------0-----------------------#2021-10-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/ab2a0b183fa2a475574b96f951ea3b52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*i0I6m4Kz9BARZYna"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">约翰·施诺布里奇在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="803a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> Laravel jobs : </strong>要理解为什么要在Laravel中创建一个job，一个简单的例子是，当一个新用户在webapp中创建(注册)时，我们想要向新用户发送一封欢迎电子邮件，所以在这种情况下，注册之后，新用户需要等待几秒钟才能将emil发送给他，然后将他重定向到他的Dashbord， 但这可能是无聊的等待，当新用户注册时，立即发送他到dashbord，并在后台发送电子邮件。</p><p id="d53f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Laravel允许您轻松创建可以在后台处理的队列作业。通过将时间密集型任务移动到队列中，您的应用程序可以以极快的速度响应web请求，并为您的客户提供更好的用户体验。</p><p id="f911" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi lb translated"><span class="l lc ld le bm lf lg lh li lj di"> T </span>何从本文目标:</p><p id="e565" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">了解我们如何在Laravel应用程序队列作业中发送http api请求(post request ),换句话说，以异步方式发送请求，其中主应用程序继续正常工作，对于一个实际的示例，您可能想要发送第三方api的发票，而无需让您的应用程序等待。</p><p id="62d4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于这个例子(为了简单起见)，我将使用<a class="ae kc" href="https://jsonplaceholder.typicode.com/" rel="noopener ugc nofollow" target="_blank"><strong class="kf ir"/></a>来发送一个带有标题和文章正文的新文章，已经有100篇文章了，所以当你发送新文章时，它将是101，并在<a class="ae kc" href="https://jsonplaceholder.typicode.com/posts" rel="noopener ugc nofollow" target="_blank"><strong class="kf ir"/></a>中获得id = 101的文章</p><ul class=""><li id="6291" class="lk ll iq kf b kg kh kk kl ko lm ks ln kw lo la lp lq lr ls bi translated"><strong class="kf ir">如何在Laravel中排队作业</strong></li></ul><p id="c3c2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">假设你已经有一些初始化Laravel应用程序的经验，并将其连接到数据库。</p><p id="6f90" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在<strong class="kf ir">中你必须做的一件重要的事情。env </strong>文件，是要修改的:</p><p id="db06" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">队列连接=同步</p><p id="64e0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">变成:</p><p id="2df0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">QUEUE _ CONNECTION =数据库</p><p id="b393" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这样就可以将队列连接到数据库。</p><p id="c1b1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我会立即跳转到artisan命令来执行排队的任务，我们把这个任务叫做<strong class="kf ir"> MakeApiRequest </strong>，但是你可以随便叫它什么。</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="0fca" class="mc md iq ly b gy me mf l mg mh">php artisan make:job MakeApiRequest </span></pre><p id="f63e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为数据库中的排队作业制作表格:</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="e18a" class="mc md iq ly b gy me mf l mg mh">php artisan queue:table<!-- --> </span></pre><p id="dcab" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在进行迁移，这样您就可以迁移您的Laravel应用程序表，包括新的作业表</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="e4f2" class="mc md iq ly b gy me mf l mg mh">php artisan migrate</span></pre><figure class="lt lu lv lw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mi"><img src="../Images/c7fed97a3fc1741a684cf4ab20477a7d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vR1RkkrE1JnAq5TR63dP1A.png"/></div></div></figure><p id="7d27" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你可以在上面的照片中看到，除了新的Laravel应用程序中已经存在的默认表之外，还有一个名为<strong class="kf ir"> job </strong>的新表。</p><p id="e0f0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可以在Laravel应用程序的代码中看到，有一个名为jobs的新文件夹，其中包含新的MakeApiRequest作业文件(或者您为其选择的任何名称)</p><figure class="lt lu lv lw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mj"><img src="../Images/a05306dfb71b7b498616027197067524.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZLr5-zCr7WjuijQYztZeFA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">app/jobs/MakeApiRequest.php</figcaption></figure><p id="4d92" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在制作一个控制器，我们在其中控制请求的行为。</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="0b59" class="mc md iq ly b gy me mf l mg mh">php artisan make:controller MakeApiRequestController</span></pre><p id="4f71" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在控制器中，我们将验证要发送给JSONplaceholder(或第三方API)的数据，并将这个经过验证的数据作为job类中的参数进行调度。</p><ul class=""><li id="0a8e" class="lk ll iq kf b kg kh kk kl ko lm ks ln kw lo la lp lq lr ls bi translated">在这个控制器中，我们将对想要发送的数据进行验证，这将发生在一个存储函数中</li></ul><figure class="lt lu lv lw gt jr"><div class="bz fp l di"><div class="mk ml l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">app/HTTP/controllers/makeapirequestcontroller . PHP</figcaption></figure><p id="f662" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可以看到，我们在控制器中导入了job类，并将validatedData作为参数发送到其中。</p><ul class=""><li id="bfa5" class="lk ll iq kf b kg kh kk kl ko lm ks ln kw lo la lp lq lr ls bi translated">在我们忘记之前，让我们为api文件中的post创建一个路径</li></ul><p id="ae05" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">添加以下代码，不要忘记导入控制器。</p><figure class="lt lu lv lw gt jr"><div class="bz fp l di"><div class="mk ml l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">routes/api.php</figcaption></figure><p id="71c6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们回到我们的作业类来添加一些代码</p><p id="402e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在创建一个受保护的变量$validatedData，并在job类的构造器中传递它，然后使用来自validatedData的合适的必需数据创建http post请求，或者我们可以说在验证数据之后。</p><figure class="lt lu lv lw gt jr"><div class="bz fp l di"><div class="mk ml l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">app/jobs/MakeApiRequest.php</figcaption></figure><ul class=""><li id="65e1" class="lk ll iq kf b kg kh kk kl ko lm ks ln kw lo la lp lq lr ls bi translated">检查工作的时间到了，我们将在邮递员中完成。</li></ul><p id="8f44" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先请不要忘记运行服务器:</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="93eb" class="mc md iq ly b gy me mf l mg mh">php artisan serve</span></pre><p id="7ce5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所以在postman中进行POST请求并添加链接:<a class="ae kc" href="http://127.0.0.1:8000/api/post" rel="noopener ugc nofollow" target="_blank">http://127 . 0 . 0 . 1:8000/API/POST</a></p><p id="dee6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在标题中添加:</p><p id="e7a6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Key: Content-Typ，带有值:application/json</p><p id="a514" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在正文中，检查行选择，并添加文章标题和正文，如下图所示:</p><figure class="lt lu lv lw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mm"><img src="../Images/f925110345bf836e02a013ab5933edd8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hNNm-_yZCx0AZxDOXeczgw.png"/></div></div></figure><p id="2a57" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可以看到有一个带有消息的响应:“post已被发送”。</p><p id="018a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果我们想检查验证是否有效，我们可能会遗漏主体中的某些内容，如下所示:</p><figure class="lt lu lv lw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mm"><img src="../Images/ee6c3192b30d94ed56d91c47644a3e74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SXfsLX0IZQHYu03ZuvhJ8g.png"/></div></div></figure><p id="d21b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所以要知道，当发送post http请求时，您只得到所需的响应，如果您查看数据库，您会在job表中看到一个带有uuid的新项目:</p><figure class="lt lu lv lw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mn"><img src="../Images/42e0a3f08dd4dfbb8840caca144407cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9q2h2W8j45FTs0fpvpaKCw.png"/></div></div></figure><p id="b7cc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这意味着您的任务仍然是stak，我们需要午餐队列工作来完成它，所以在一个新的终端中发出命令:</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="590c" class="mc md iq ly b gy me mf l mg mh">php artisan queue:work<br/>or   <br/>php artisan queue:listen</span></pre><p id="9e1a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可以在终端中看到该作业正在处理，并且正在处理。</p><figure class="lt lu lv lw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mj"><img src="../Images/ba9cf465fe8ca6c600fec43106e9bb3b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y_N1UjD5ebsQhxuF5HK2NQ.png"/></div></div></figure><p id="109b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在你可以说你已经成功地完成了你的队列任务。</p><p id="42a4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您检查数据库，您将再次发现作业表为空，除非如果有什么错误，那么这个作业将对failed_jobs执行，并显示一条消息解释它失败的原因。</p><ul class=""><li id="3cf0" class="lk ll iq kf b kg kh kk kl ko lm ks ln kw lo la lp lq lr ls bi translated"><strong class="kf ir">见派工流程:</strong></li></ul><p id="8ab2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，如果您想要检查作业类中发生了什么，或者您可能想要查看作业类中的响应本身，则更改:</p><p id="d04c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">MakeApiRequest::dispatch($ validatedData)；</p><p id="dfbf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">进入:调度同步</p><p id="bd7c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">MakeApiRequest::<strong class="kf ir">dispatch sync</strong>($ validatedData)；</p><p id="9865" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">并生成dd($response)或者更好地生成</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="80e9" class="mc md iq ly b gy me mf l mg mh">dd($response-&gt;getBody()-&gt;getContents())</span></pre><p id="b9f5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后你可以检查你的邮递员:</p><figure class="lt lu lv lw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mm"><img src="../Images/55ba5fd7776e89487fb4feada0815004.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IZ3Z2jlM2EoSQcXeEok3qA.png"/></div></div></figure><ul class=""><li id="aa8d" class="lk ll iq kf b kg kh kk kl ko lm ks ln kw lo la lp lq lr ls bi translated"><em class="mo">作为旁注:</em></li></ul><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="e044" class="mc md iq ly b gy me mf l mg mh">- you can send http request with token or any other type of headers - there is many configuration you can do it in the job class , like $tries, $timeout, $maxTries, and many others, I have already add some of it in the job class with some simple explaintion, but you can read more in the documention of Laravel queue.</span></pre><p id="8ba4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">感谢阅读。</p><p id="f77d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你有兴趣阅读更多关于不同主题的文章，请访问我的博客:<a class="ae kc" href="https://aalhommada.com/blog" rel="noopener ugc nofollow" target="_blank">https://aalhommada.com/blog</a></p></div></div>    
</body>
</html>