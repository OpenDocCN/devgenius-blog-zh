<html>
<head>
<title>Let’s Encrypt your site with NGINX</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">让我们用 NGINX 加密你的网站</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/lets-encrypt-your-site-with-nginx-d1bb049dda0f?source=collection_archive---------5-----------------------#2022-03-13">https://blog.devgenius.io/lets-encrypt-your-site-with-nginx-d1bb049dda0f?source=collection_archive---------5-----------------------#2022-03-13</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/95ae431247a0dc4e74ca88c970680de7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZsE3kNRUlNiK3xVeNISqXQ.jpeg"/></div></div></figure><p id="2a78" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">自从谷歌为使用 HTTPS 而不是 HTTP 的网站改变了排名系统，最终网站开始转向加密协议。但是，与其购买昂贵的证书，不如让加密以零成本为我们解决这个问题。</p><p id="0144" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">因此，我们将介绍如何设置 NGINX 服务器，并使用“让我们加密”来为我们生成证书，同时使用 certbot，以便我们可以在证书到期时自动获取新证书。</p><p id="424c" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这是一个较小的教程，实际上并不需要花费太多的时间和精力来启动它，但是我认为在这里尽可能清晰地分享启动和运行它的所有必要步骤可能是有用的。我还将分享一个 shell 脚本，如果我们需要从头开始，它将尽可能自动化这个过程。很容易再次运行脚本。</p><h1 id="d078" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">安装 NGINX 的设置脚本</h1><p id="6016" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">登录到您想要用来安装 NGINX 的虚拟机。为了运行这个脚本，我们需要两个文件，我们将在虚拟机上创建第一个名为<strong class="jx io"> install_nginx.sh </strong>的文件，并将以下代码放入其中:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="4ad6" class="mf ku in mb b gy mg mh l mi mj"><strong class="mb io">#!/bin/bash<br/></strong><em class="mk"># This script is intended to setup the environment for a NGINX Web Server with SSL certificate using Let's Encrypt.<br/><br/></em>clear<br/><br/>PROJECT_DIR="/etc/nginx/sites-enabled"<br/>CURRENT_DIR=$(pwd)<br/>DOMAIN="example.com"<br/>EMAIL="foo@bar.com"<br/><br/><em class="mk"># Get latest updates<br/></em>echo ""<br/>echo "UPDATING SYSTEM..."<br/>echo ""<br/>sudo apt update<br/><br/>echo ""<br/>echo "###### RUNNING NGINX SCRIPT ######"<br/>echo ""<br/><br/>function install_nginx<br/>{<br/> SOFTWARE="nginx"<br/> QUERY="$(sudo dpkg-query -l | grep ${SOFTWARE} | wc -l)"<br/><br/> if [ "$QUERY" -eq 0 ]; then<br/>  echo ""<br/>  echo "INSTALLING NGINX..."<br/>  echo ""<br/><br/>  sudo apt -y install nginx<br/><br/>  <em class="mk"># Setup configuration file<br/>  </em>sudo cp $CURRENT_DIR/$DOMAIN $PROJECT_DIR/$DOMAIN<br/><br/>  <em class="mk"># Setup and configure Certbot<br/>  </em>sudo apt -y install certbot python3-certbot-nginx<br/>  sudo certbot --nginx -d $DOMAIN --non-interactive --agree-tos -m $EMAIL<br/> else<br/>  echo "${SOFTWARE} is already installed. skipping..."<br/> fi<br/>}<br/><br/>install_nginx</span></pre><p id="7c4d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">让我们看一下第一个 shell 脚本，它是做什么的。</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="3e63" class="mf ku in mb b gy mg mh l mi mj">clear<br/><br/>PROJECT_DIR="/etc/nginx/sites-enabled"<br/>CURRENT_DIR=$(pwd)<br/>DOMAIN="example.com"<br/>EMAIL="foo@bar.com"</span></pre><p id="ed5c" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们从清空屏幕开始，以便在控制台上获得更多空间。然后我们添加四个常量，我们将<strong class="jx io">项目目录</strong>设置为配置文件所在的目录。然后我们获取当前所在的目录，并将其设置为<strong class="jx io"> CURRENT_DIR </strong>。我们设置我们的域常量和应该与获取证书相关联的电子邮件。</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="037a" class="mf ku in mb b gy mg mh l mi mj"><em class="mk"># Get latest updates<br/></em>echo ""<br/>echo "UPDATING SYSTEM..."<br/>echo ""<br/>sudo apt update</span></pre><p id="473f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">显然，我们在安装软件之前更新了系统的包列表。</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="90e8" class="mf ku in mb b gy mg mh l mi mj">function install_nginx<br/>{<br/> SOFTWARE="nginx"<br/> QUERY="$(sudo dpkg-query -l | grep ${SOFTWARE} | wc -l)"<br/><br/> if [ "$QUERY" -eq 0 ]; then<br/>  echo ""<br/>  echo "INSTALLING NGINX..."<br/>  echo ""<br/><br/>  sudo apt -y install $SOFTWARE<br/><br/>  <em class="mk"># Setup configuration file<br/>  </em>sudo cp $CURRENT_DIR/$DOMAIN $PROJECT_DIR/$DOMAIN<br/><br/>  <em class="mk"># Setup and configure Certbot<br/>  </em>sudo apt -y install certbot python3-certbot-nginx<br/>  sudo certbot --nginx -d $DOMAIN --non-interactive --agree-tos -m $EMAIL<br/> else<br/>  echo "${SOFTWARE} is already installed. skipping..."<br/> fi<br/>}</span></pre><p id="219c" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们现在创建了一个函数<strong class="jx io"> install_nginx </strong>。我们定义将要安装的软件，并在系统上进行查询，以查看我们是否已经安装了该软件，如果已经安装，我们只需打印出一条消息，说明该软件已经安装。</p><p id="4014" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">接下来，如果没有安装，我们安装软件并添加标志<strong class="jx io"> -y </strong>以避免必须手动输入是/否来安装 NGINX。然后，我们继续将我们创建的配置文件复制到 NGINX 配置的目标目录中。</p><p id="6388" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">然后我们安装<strong class="jx io"> python3-certbot-nginx </strong>，这样我们就可以有一个 bot 在新证书到期时自动检索它。</p><p id="d2b1" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们运行 certbot 并添加标志<strong class="jx io"> - nginx </strong>，因此我们告诉它将用于向 nginx 配置中插入 config，并指定应该使用带有<strong class="jx io"> -d </strong>标志的域，并且我们不希望它与<strong class="jx io"> -非交互</strong>标志以及<strong class="jx io"> - agree-tos </strong>交互以自动同意和<strong class="jx io"> -m </strong>用于应该使用的电子邮件。</p><p id="07a2" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如果您想添加<strong class="jx io"> www。</strong>同样添加到域中，只需添加另一个<strong class="jx io"> -d </strong>旗帜，添加<a class="ae ml" href="http://www.example.com" rel="noopener ugc nofollow" target="_blank">www.example.com</a>以及<strong class="jx io">example.com</strong>。在这个例子中，我们没有添加它。</p><h1 id="c589" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">配置 NGINX 配置</h1><p id="d286" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">然后我们创建另一个文件，该文件将保存名为<strong class="jx io">example.com</strong>的 NGINX 配置(将其切换到您自己的域):</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="422c" class="mf ku in mb b gy mg mh l mi mj">server {<br/>    root                /var/www/html;</span><span id="6d4b" class="mf ku in mb b gy mm mh l mi mj">    index               index.html index.htm index.nginx-debian.html;<br/>    server_name         example.com;<br/>    include             /etc/nginx/mime.types;<br/>}</span><span id="1306" class="mf ku in mb b gy mm mh l mi mj">server {<br/>    if ($host = example.com) {<br/>        return 301 <a class="ae ml" rel="noopener ugc nofollow" target="_blank" href="/$host$request_uri;">https://$host$request_uri;</a><br/>    }</span><span id="279f" class="mf ku in mb b gy mm mh l mi mj">    listen              80;<br/>    listen              [::]:80;<br/>    server_name         example.com;<br/>    return              404;<br/>}</span></pre><p id="325c" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">让我们把文件分解一下。首先，我们定义一个服务器块，我们将使用两个服务器块用于 HTTP 和 HTTPS。第一个是 HTTPS(443 号港口)。</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="15cd" class="mf ku in mb b gy mg mh l mi mj">root                /var/www/html;</span></pre><p id="a368" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这为 NGINX 服务器定义了根文件的位置。这是安装 NGINX 时的默认设置，我们将在本教程中使用。</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="af94" class="mf ku in mb b gy mg mh l mi mj">index               index.html index.htm index.nginx-debian.html;<br/>server_name         example.com;<br/>include             /etc/nginx/mime.types;</span></pre><p id="109b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在这里，我们定义从根目录加载什么索引文件。如果找不到我们要找的第一个 index.htm，我们就定义多个，以此类推。然后我们定义服务器的名称。在这里，我们将在运行脚本之前更改到我们想要的域。我们使用包含 nginx mime.types 作为默认设置。</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="3efb" class="mf ku in mb b gy mg mh l mi mj">server {<br/>    if ($host = example.com) {<br/>        return 301 https://$host$request_uri;<br/>    }<br/><br/>    listen              80;<br/>    listen              [::]:80;<br/>    server_name         example.com;<br/>    return              404;<br/>}</span></pre><p id="2ad1" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这里，我们定义了第二个服务器块，它将监听标准的 HTTP 端口 80。但是在这里，我们将添加一个 if 语句，该语句检查您是否尝试使用 HTTP，您将自动被重定向到为 HTTPS 服务的另一个服务器块。出于安全原因，我们不希望用户使用未加密的协议。</p><p id="ac87" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们可以通过以下方式检查配置是否有效:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="58af" class="mf ku in mb b gy mg mh l mi mj">nginx -c /etc/nginx/nginx.conf -t</span></pre><h1 id="3429" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">安装 NGINX</h1><p id="072b" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">现在，我们准备安装 NGINX 服务器。让我们为 shell 脚本设置权限并运行它！</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="0a2e" class="mf ku in mb b gy mg mh l mi mj">chmod +x install_nginx.sh<br/>./install_sh</span></pre><h1 id="561c" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">确认 NGINX 服务已启动并正在运行</h1><p id="ce31" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">我们可以通过运行以下命令来确认状态:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="4539" class="mf ku in mb b gy mg mh l mi mj">systemctl status nginx</span></pre><figure class="lw lx ly lz gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mn"><img src="../Images/1d88f98ef661124e180d85d2849544f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GIz2ri2q-gLk44CJi0C_pA.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">systemctl 状态 nginx</figcaption></figure><p id="9688" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们已经开始行动了。转到您的域网址，并尝试访问它，它应该显示在一个默认的 NGINX 网站使用 HTTPS。但有一个小细节我们需要解决。打开我们添加的配置文件:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="5cb5" class="mf ku in mb b gy mg mh l mi mj">sudo vim /etc/nginx/sites-enabled/example.com</span></pre><p id="67b7" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">然后删除包含在第一个服务器块中的端口为 80 的线路。然后运行:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="a214" class="mf ku in mb b gy mg mh l mi mj">sudo systemctl reload nginx<br/>sudo systemctl restart nginx</span></pre><h1 id="fb79" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">资源</h1><p id="35ec" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">链接到脚本所在的 git hub Gist:<a class="ae ml" href="https://gist.github.com/mjovanc/5efc10463a8e4662df4f713957f32991#file-example-com" rel="noopener ugc nofollow" target="_blank">https://git . git hub . com/mjovanc/5 EFC 10463 A8 e 4662 df 4f 713957 f 32991 #文件-示例-com </a></p></div></div>    
</body>
</html>