<html>
<head>
<title>Backup and Restore MongoDB database (.gz) with and without username / password authentication using C# .NET</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">备份和恢复 MongoDB 数据库(。gz)使用 C#进行用户名/密码验证和不验证。网</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/backup-and-restore-mongodb-database-gz-d4871b8f5059?source=collection_archive---------3-----------------------#2022-01-25">https://blog.devgenius.io/backup-and-restore-mongodb-database-gz-d4871b8f5059?source=collection_archive---------3-----------------------#2022-01-25</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><h1 id="33d0" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">介绍</h1><p id="8bad" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们将使用。NET 6 和 MongoDB 5.0.5。请参见下面的 GitHub 资源库，了解最新的评论和更多内容。</p><h1 id="3286" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">支持</h1><p id="f21e" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">为了备份 MongoDB 数据库，我们需要使用<a class="ae lg" href="https://docs.mongodb.com/database-tools/mongodump/#:~:text=mongodump%20is%20a%20utility%20for,line%2C%20not%20the%20mongo%20shell." rel="noopener ugc nofollow" target="_blank"> mongodump </a>，这是一个用于备份 MongoDB 数据库的命令行实用程序。我们可以使用下面的 C#。NET 方法和 appsettings.json 来完成。</p><figure class="lh li lj lk gt ll"><div class="bz fp l di"><div class="lm ln l"/></div></figure><figure class="lh li lj lk gt ll"><div class="bz fp l di"><div class="lm ln l"/></div></figure><p id="9494" class="pw-post-body-paragraph ki kj in kk b kl lo kn ko kp lp kr ks kt lq kv kw kx lr kz la lb ls ld le lf ig bi translated">使用身份验证时，我们需要设置 appsettings.json 中的三个属性</p><pre class="lh li lj lk gt lt lu lv lw aw lx bi"><span id="4dda" class="ly jl in lu b gy lz ma l mb mc">"MongoDBUser": "user",</span><span id="3115" class="ly jl in lu b gy md ma l mb mc">"MongoDBPassword": "password",</span><span id="46bd" class="ly jl in lu b gy md ma l mb mc">"MongoDBAuthenticationDatabase": "admin"</span></pre><p id="9b6a" class="pw-post-body-paragraph ki kj in kk b kl lo kn ko kp lp kr ks kt lq kv kw kx lr kz la lb ls ld le lf ig bi translated">方法签名本身看起来像这样</p><pre class="lh li lj lk gt lt lu lv lw aw lx bi"><span id="f3ac" class="ly jl in lu b gy lz ma l mb mc">public void BackupDatabase(string databaseName, string localDatabasePath, bool withAuthentication = false)</span></pre><p id="83e6" class="pw-post-body-paragraph ki kj in kk b kl lo kn ko kp lp kr ks kt lq kv kw kx lr kz la lb ls ld le lf ig bi translated">它接受一个数据库名和保存该数据库的路径，您还可以选择使用身份验证。</p><h1 id="a36e" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">未经认证</h1><p id="b7de" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">如果没有使用 mongodump 进行身份验证，最终的命令将如下所示。-d 指定备份哪个数据库，— gzip 告诉 mongodump 使用 gzip，而— archive 指定保存备份的位置。</p><pre class="lh li lj lk gt lt lu lv lw aw lx bi"><span id="32ec" class="ly jl in lu b gy lz ma l mb mc">mongodump -d database --gzip --archive=backup.gz</span></pre><h1 id="ebb8" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">带身份验证</h1><p id="ccc6" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">在 mongodump 中使用身份验证时，最后的命令将如下所示。这个与上面的非常相似，增加了—用户名和—认证数据库。</p><pre class="lh li lj lk gt lt lu lv lw aw lx bi"><span id="70d9" class="ly jl in lu b gy lz ma l mb mc">mongodump -d database --gzip --archive=backup.gz --username user --authenticationDatabase admin</span></pre><p id="bfd2" class="pw-post-body-paragraph ki kj in kk b kl lo kn ko kp lp kr ks kt lq kv kw kx lr kz la lb ls ld le lf ig bi translated">使用身份验证时，请确保您的 mongod.cfg 文件在#security: set 下具有以下值。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi me"><img src="../Images/719ab0accc8a2e62b0a5ce802d8066df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VLNhUmqnPUNHYCU-LlSPUA.png"/></div></div></figure><p id="3d19" class="pw-post-body-paragraph ki kj in kk b kl lo kn ko kp lp kr ks kt lq kv kw kx lr kz la lb ls ld le lf ig bi translated">mongod.cfg 在 Windows 上的默认位置如下(用您的版本替换 5.0)。</p><pre class="lh li lj lk gt lt lu lv lw aw lx bi"><span id="40e5" class="ly jl in lu b gy lz ma l mb mc">C:\Program Files\MongoDB\Server\5.0\bin</span></pre><p id="9add" class="pw-post-body-paragraph ki kj in kk b kl lo kn ko kp lp kr ks kt lq kv kw kx lr kz la lb ls ld le lf ig bi translated">在这种情况下，我们使用“admin”作为身份验证数据库。确保使用以下命令添加一个与上述 appsettings.json 文件中的值相匹配的用户，从命令行上的 mongo 开始。</p><p id="68ae" class="pw-post-body-paragraph ki kj in kk b kl lo kn ko kp lp kr ks kt lq kv kw kx lr kz la lb ls ld le lf ig bi translated">首先，使用 mongo 进行连接(首先通过省略或注释掉#security:下的值来禁用身份验证)</p><pre class="lh li lj lk gt lt lu lv lw aw lx bi"><span id="452c" class="ly jl in lu b gy lz ma l mb mc">mongo</span></pre><p id="fe53" class="pw-post-body-paragraph ki kj in kk b kl lo kn ko kp lp kr ks kt lq kv kw kx lr kz la lb ls ld le lf ig bi translated">通过以下命令使用管理数据库。</p><pre class="lh li lj lk gt lt lu lv lw aw lx bi"><span id="8a5c" class="ly jl in lu b gy lz ma l mb mc">use admin</span></pre><p id="c4b7" class="pw-post-body-paragraph ki kj in kk b kl lo kn ko kp lp kr ks kt lq kv kw kx lr kz la lb ls ld le lf ig bi translated">然后，使用下面的命令添加一个用户，指定您的用户名、密码和角色。完成后重新启动服务。</p><pre class="lh li lj lk gt lt lu lv lw aw lx bi"><span id="c11d" class="ly jl in lu b gy lz ma l mb mc">db.createUser(<br/> {<br/>  user: "admin", <br/>  pwd: "password", <br/>  roles: [<br/>   {<br/>    role: "userAdminAnyDatabase", <br/>    db: "admin" <br/>   }, <br/>   "readWriteAnyDatabase"<br/>  ]<br/> }<br/>)</span></pre><p id="01f2" class="pw-post-body-paragraph ki kj in kk b kl lo kn ko kp lp kr ks kt lq kv kw kx lr kz la lb ls ld le lf ig bi translated">mongodump 在运行 mongodb-backup-with-auth.bat 文件时会询问密码，所以我们确保用下面的 C#代码处理它。</p><pre class="lh li lj lk gt lt lu lv lw aw lx bi"><span id="92ac" class="ly jl in lu b gy lz ma l mb mc">if (withAuthentication)</span><span id="84fc" class="ly jl in lu b gy md ma l mb mc">{</span><span id="8e3e" class="ly jl in lu b gy md ma l mb mc">    arguments += $" {options.Value.MongoDBUser} {options.Value.MongoDBAuthenticationDatabase}";</span><span id="3c71" class="ly jl in lu b gy md ma l mb mc">    startInfo.RedirectStandardInput = true;</span><span id="a793" class="ly jl in lu b gy md ma l mb mc">}</span><span id="9206" class="ly jl in lu b gy md ma l mb mc">// ... <br/>// Execute the command and when it asks, if we're using authentication, give it the password</span><span id="9b42" class="ly jl in lu b gy md ma l mb mc">if (withAuthentication)</span><span id="1556" class="ly jl in lu b gy md ma l mb mc">{</span><span id="7b64" class="ly jl in lu b gy md ma l mb mc">    process.StandardInput.WriteLine(options.Value.MongoDBPassword);<br/>}</span></pre><h1 id="faf9" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">恢复</h1><p id="3734" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">为了恢复 MongoDB 数据库，我们需要使用<a class="ae lg" href="https://docs.mongodb.com/database-tools/mongorestore/" rel="noopener ugc nofollow" target="_blank"> mongorestore </a>，这是一个用于恢复 MongoDB 数据库的命令行实用程序。我们可以使用下面的 C#。NET 方法和 appsettings.json 文件来完成它。</p><figure class="lh li lj lk gt ll"><div class="bz fp l di"><div class="lm ln l"/></div></figure><p id="6d65" class="pw-post-body-paragraph ki kj in kk b kl lo kn ko kp lp kr ks kt lq kv kw kx lr kz la lb ls ld le lf ig bi translated">方法签名如下所示</p><pre class="lh li lj lk gt lt lu lv lw aw lx bi"><span id="4c2c" class="ly jl in lu b gy lz ma l mb mc">public void RestoreDatabase(string localDatabasePath, bool withAuthentication = false)</span></pre><p id="dd16" class="pw-post-body-paragraph ki kj in kk b kl lo kn ko kp lp kr ks kt lq kv kw kx lr kz la lb ls ld le lf ig bi translated">它接受到。我们正在恢复的 gz 备份文件，并且可以选择使用上述相同的方法进行身份验证。</p><h1 id="87bc" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">未经认证</h1><p id="17bd" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">如果没有使用 mongorestore 进行身份验证，最终的命令将如下所示。— drop 告诉 mongorestore 在恢复之前删除数据库，— gzip 告诉 mongorestore 使用 gzip，而— archive 指定本地。要恢复的 gz 数据库文件。我们正在恢复的数据库的名称(因此将被删除)是从。gz 文件。</p><pre class="lh li lj lk gt lt lu lv lw aw lx bi"><span id="cb2b" class="ly jl in lu b gy lz ma l mb mc">mongorestore --drop --gzip --archive=backup.gz</span></pre><h1 id="adba" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">带身份验证</h1><p id="7f06" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">使用 mongorestore 进行身份验证后，最终的命令将如下所示。这个命令与上面的命令非常相似，只是增加了— username 指定哪个用户，以及— authenticationDatabase 告诉 mongorestore 使用哪个身份验证数据库。确保这些值与上面备份下的身份验证说明相匹配。</p><pre class="lh li lj lk gt lt lu lv lw aw lx bi"><span id="f97e" class="ly jl in lu b gy lz ma l mb mc">mongorestore --drop --gzip --archive=backup.gz --username user --authenticationDatabase admin</span></pre><h1 id="1253" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">GitHub 知识库</h1><p id="a3a5" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">要查看整个项目、使用方法和示例，请点击下面的链接查看 GitHub 资源库。</p><p id="1cc8" class="pw-post-body-paragraph ki kj in kk b kl lo kn ko kp lp kr ks kt lq kv kw kx lr kz la lb ls ld le lf ig bi translated"><a class="ae lg" href="https://github.com/joemoceri/database-toolkit" rel="noopener ugc nofollow" target="_blank">https://github.com/joemoceri/database-toolkit</a></p></div></div>    
</body>
</html>