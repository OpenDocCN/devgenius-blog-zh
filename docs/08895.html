<html>
<head>
<title>Network Policy in K8s</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">K8s 中的网络策略</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/network-policy-in-k8s-14eeeb905bb?source=collection_archive---------5-----------------------#2022-07-17">https://blog.devgenius.io/network-policy-in-k8s-14eeeb905bb?source=collection_archive---------5-----------------------#2022-07-17</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/c3dca80f55c272582a1c3d153160462c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B_Hwa-0RvjUMIQPOEn0UdQ.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">图片来源:<a class="ae jz" href="https://banzaicloud.com/blog/network-policy/" rel="noopener ugc nofollow" target="_blank">https://banzaicloud.com/blog/network-policy/</a></figcaption></figure><blockquote class="ka kb kc"><p id="6fa6" class="kd ke kf kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ig bi translated">我们想要实现的设置</p></blockquote><figure class="ld le lf lg gt jo gh gi paragraph-image"><div class="gh gi lc"><img src="../Images/09cf125cad27c480966fecfbb0cd8431.png" data-original-src="https://miro.medium.com/v2/resize:fit:1284/format:webp/1*Czd1tMy-baH24gGismCsEQ.png"/></div></figure><ul class=""><li id="1db0" class="lh li in kg b kh ki kl km lj lk ll lm ln lo lb lp lq lr ls bi translated">所有的实线方向线可以认为是<strong class="kg io">入口</strong>规则，所有的虚线方向线可以认为是<strong class="kg io">出口</strong>规则。</li><li id="834f" class="lh li in kg b kh lt kl lu lj lv ll lw ln lx lb lp lq lr ls bi translated">对于 Web 服务器，我们希望允许端口 80 上的传入流量(传入)和“用户”的传出流量(传出)。</li><li id="e99b" class="lh li in kg b kh lt kl lu lj lv ll lw ln lx lb lp lq lr ls bi translated">对于应用服务器，我们希望允许端口 5000 上的传入流量(传入)和 DB 服务器“3306”上的传出流量(传出)。</li><li id="8215" class="lh li in kg b kh lt kl lu lj lv ll lw ln lx lb lp lq lr ls bi translated">对于数据库服务器，我们希望在端口 3306 上允许传入流量(入口),此时不允许传出流量(出口)。</li></ul><blockquote class="ka kb kc"><p id="6842" class="kd ke kf kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ig bi translated">Pod 配置</p></blockquote><p id="1943" class="pw-post-body-paragraph kd ke in kg b kh ki kj kk kl km kn ko lj kq kr ks ll ku kv kw ln ky kz la lb ig bi translated"><strong class="kg io">网络服务器 Pod </strong></p><pre class="ld le lf lg gt ly lz ma mb aw mc bi"><span id="0432" class="md me in lz b gy mf mg l mh mi">apiVersion: v1<br/>kind: Pod<br/>metadata:<br/>  name: web-pod<br/>  namespace: dev<br/>  labels:<br/>    role: web<br/>spec:<br/>  containers:<br/>    - name: web-pod<br/>      image: some-web-app<br/>      ports:<br/>        - containerPort: 80</span></pre><p id="5921" class="pw-post-body-paragraph kd ke in kg b kh ki kj kk kl km kn ko lj kq kr ks ll ku kv kw ln ky kz la lb ig bi translated"><strong class="kg io">应用服务器盒</strong></p><pre class="ld le lf lg gt ly lz ma mb aw mc bi"><span id="de85" class="md me in lz b gy mf mg l mh mi">apiVersion: v1<br/>kind: Pod<br/>metadata:<br/>  name: api-pod<br/>  namespace: dev<br/>  labels:<br/>    role: api<br/>spec:<br/>  containers:<br/>    - name: api-pod<br/>      image: some-api-app<br/>      ports:<br/>        - containerPort: 5000</span></pre><p id="183e" class="pw-post-body-paragraph kd ke in kg b kh ki kj kk kl km kn ko lj kq kr ks ll ku kv kw ln ky kz la lb ig bi translated">数据库服务器盒</p><pre class="ld le lf lg gt ly lz ma mb aw mc bi"><span id="9414" class="md me in lz b gy mf mg l mh mi">apiVersion: v1<br/>kind: Pod<br/>metadata:<br/>  name: db-pod<br/>  namespace: dev<br/>  labels:<br/>    role: db<br/>spec:<br/>  containers:<br/>    - name: db-pod<br/>      image: mysql<br/>      ports:<br/>        - containerPort: 3306</span></pre><blockquote class="ka kb kc"><p id="69cb" class="kd ke kf kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ig bi translated">网络策略:应用服务器</p></blockquote><pre class="ld le lf lg gt ly lz ma mb aw mc bi"><span id="209f" class="md me in lz b gy mf mg l mh mi">apiVersion: networking.k8s.io/v1<br/>kind: NetworkPolicy<br/>metadata:<br/>  name: api-policy<br/>spec:<br/>  podSelector:<br/>    matchLabels:<br/>      role: api<br/>  policyTypes:<br/>  - Ingress<br/>  - Egress<br/>  ingress:<br/>    - from:<br/>        - podSelector:<br/>            matchLabels:<br/>              name: web-pod<br/>          namespaceSelector:<br/>            matchLabels:<br/>              name: dev<br/>      ports:<br/>      - protocol: TCP<br/>        port: 5000<br/>  egress:<br/>    - to:<br/>        - podSelector:<br/>            matchLabels:<br/>              name: db-pod<br/>        - namespaceSelector:<br/>            matchLabels:<br/>              name: dev<br/>      ports:<br/>        - protocol: TCP<br/>          port: 3306</span></pre><ul class=""><li id="9dea" class="lh li in kg b kh ki kl km lj lk ll lm ln lo lb lp lq lr ls bi translated">像任何 k8s 对象一样,“网络策略”对象也有 4 个主要部分:apiVersion、kind、metadata 和 spec。</li><li id="235c" class="lh li in kg b kh lt kl lu lj lv ll lw ln lx lb lp lq lr ls bi translated">spec/podSelector/matchLabels 表示此网络策略需要映射到哪个 pod。如果您在元数据/标签处查看 db server pod 的 pod 配置，您会发现同样的情况。</li><li id="1b61" class="lh li in kg b kh lt kl lu lj lv ll lw ln lx lb lp lq lr ls bi translated">在 spec/policyTypes 下，我们指定将要配置的策略。仅入口、仅出口或两者都有。</li><li id="6905" class="lh li in kg b kh lt kl lu lj lv ll lw ln lx lb lp lq lr ls bi translated">然后我们定义入口和出口定义。</li><li id="5bba" class="lh li in kg b kh lt kl lu lj lv ll lw ln lx lb lp lq lr ls bi translated">这里入口定义说允许来自:<br/> 1 的输入流量。名为“web-pod”(入口/来源/pod 选择器/匹配标签)的 pod<br/>2。&amp;在命名空间“dev”(ingress/from/namespace selector/match labels)中<br/> 3。&amp;至端口‘5000’(入口/端口)</li><li id="812c" class="lh li in kg b kh lt kl lu lj lv ll lw ln lx lb lp lq lr ls bi translated">出口定义表示允许传出流量到:<br/> 1。名为' d b-pod '(egress/to/pod selector/matchLabels)的 pod<br/>2。&amp;在命名空间‘dev’(egress/to/namespace selector/match labels)中<br/> 3。&amp;至端口‘3306’(出口/端口)</li></ul><blockquote class="ka kb kc"><p id="941c" class="kd ke kf kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ig bi translated">网络策略:Web 服务器</p></blockquote><pre class="ld le lf lg gt ly lz ma mb aw mc bi"><span id="f999" class="md me in lz b gy mf mg l mh mi">apiVersion: networking.k8s.io/v1<br/>kind: NetworkPolicy<br/>metadata:<br/>  name: web-policy<br/>spec:<br/>  podSelector:<br/>    matchLabels:<br/>      role: web<br/>  policyTypes:<br/>  - Egress<br/>  egress:<br/>    - to:<br/>        - podSelector:<br/>            matchLabels:<br/>              name: api-pod<br/>        - namespaceSelector:<br/>            matchLabels:<br/>              name: dev<br/>      ports:<br/>        - protocol: TCP<br/>          port: 5000</span></pre><ul class=""><li id="c8f7" class="lh li in kg b kh ki kl km lj lk ll lm ln lo lb lp lq lr ls bi translated">这里我们没有入口策略类型/规则。因此默认情况下，它会允许所有流量通过端口 80 进入 web 服务器。但它可能受到负载平衡器或 VPN 的保护。</li><li id="fa18" class="lh li in kg b kh lt kl lu lj lv ll lw ln lx lb lp lq lr ls bi translated">spec/podSelector/matchLabels 表示此网络策略需要映射到哪个 pod。如果您在元数据/标签处查看 web 服务器 pod 的 pod 配置，您会发现同样的情况。</li><li id="f546" class="lh li in kg b kh lt kl lu lj lv ll lw ln lx lb lp lq lr ls bi translated">在 spec/policyTypes 下，我们指定将要配置的策略。仅入口、仅出口或两者都有。</li><li id="7e89" class="lh li in kg b kh lt kl lu lj lv ll lw ln lx lb lp lq lr ls bi translated">然后我们定义入口和出口定义。</li><li id="7735" class="lh li in kg b kh lt kl lu lj lv ll lw ln lx lb lp lq lr ls bi translated">这里的出口定义说允许流出的流量到:<br/> 1。名为' API-pod '(egress/to/pod selector/matchLabels)的 pod<br/>2。&amp;在命名空间“dev”(egress/to/namespace selector/match labels)中<br/> 3。&amp;至端口‘5000’(出口/端口)</li></ul><blockquote class="ka kb kc"><p id="9fc7" class="kd ke kf kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ig bi translated">网络策略:数据库服务器</p></blockquote><pre class="ld le lf lg gt ly lz ma mb aw mc bi"><span id="c49c" class="md me in lz b gy mf mg l mh mi">apiVersion: networking.k8s.io/v1<br/>kind: NetworkPolicy<br/>metadata:<br/>  name: db-policy<br/>spec:<br/>  podSelector:<br/>    matchLabels:<br/>      role: db<br/>  policyTypes:<br/>  - Ingress<br/>  - Egress<br/>  ingress:<br/>    - from:<br/>        - podSelector:<br/>            matchLabels:<br/>              name: api-pod<br/>          namespaceSelector:<br/>            matchLabels:<br/>              name: dev<br/>        - ipBlock:<br/>            cidr: 192.168.5.10/32<br/>      ports:<br/>      - protocol: TCP<br/>        port: 3306<br/>  egress:<br/>    - to:<br/>        - ipBlock:<br/>            cidr: 192.168.5.10/32<br/>      ports:<br/>        - protocol: TCP<br/>          port: 80</span></pre><ul class=""><li id="ff0e" class="lh li in kg b kh ki kl km lj lk ll lm ln lo lb lp lq lr ls bi translated">这里的情况有点不同，因为我们偏离了我们定义的设置。</li><li id="9728" class="lh li in kg b kh lt kl lu lj lv ll lw ln lx lb lp lq lr ls bi translated">稍微偏离的原因是为了展示一个场景。</li><li id="ff7f" class="lh li in kg b kh lt kl lu lj lv ll lw ln lx lb lp lq lr ls bi translated">这种情况下，如果我们想允许一些备份数据库服务器从一个特定的 IP/范围来访问我们的数据库服务器。同样，如果我们想访问特定 IP/范围的备份数据库服务器。</li><li id="54d1" class="lh li in kg b kh lt kl lu lj lv ll lw ln lx lb lp lq lr ls bi translated">spec/podSelector/matchLabels 表示此网络策略需要映射到哪个 pod。如果您在元数据/标签处查看 db server pod 的 pod 配置，您会发现同样的情况。</li><li id="1282" class="lh li in kg b kh lt kl lu lj lv ll lw ln lx lb lp lq lr ls bi translated">在 spec/policyTypes 下，我们指定将要配置的策略。仅入口、仅出口或两者都有。</li><li id="6af8" class="lh li in kg b kh lt kl lu lj lv ll lw ln lx lb lp lq lr ls bi translated">然后我们定义入口和出口定义。</li><li id="6ef4" class="lh li in kg b kh lt kl lu lj lv ll lw ln lx lb lp lq lr ls bi translated">这里入口定义说允许来自:<br/> 1 的输入流量。名为' API-pod '(ingress/from/pod selector/matchLabels)的 pod<br/>2。&amp;在命名空间‘dev’(入口/来自/命名空间选择器/匹配标签)<br/> 3。&amp;至端口‘3306’(入口/端口)<br/> 4。此外，它还允许来自特定 IP/范围(入口/来源/IP 块)的流量</li><li id="f8e4" class="lh li in kg b kh lt kl lu lj lv ll lw ln lx lb lp lq lr ls bi translated">这里的出口定义是允许输出流量到特定的 IP/范围(出口/到/IP 块)</li></ul><p id="9fff" class="pw-post-body-paragraph kd ke in kg b kh ki kj kk kl km kn ko lj kq kr ks ll ku kv kw ln ky kz la lb ig bi translated">朋友们，如果你喜欢我的内容，你会考虑关注我在 https://www.linkedin.com/in/hitesh-pattanayak-52290b160/<a class="ae jz" href="https://www.linkedin.com/in/hitesh-pattanayak-52290b160/" rel="noopener ugc nofollow" target="_blank">的链接吗</a></p></div></div>    
</body>
</html>