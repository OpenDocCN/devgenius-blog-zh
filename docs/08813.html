<html>
<head>
<title>How to implement Appointment Booking Slots using Redis</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用 Redis 实现预约时段</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/how-to-implement-appointment-booking-slots-using-redis-c941d50a50d6?source=collection_archive---------6-----------------------#2022-07-12">https://blog.devgenius.io/how-to-implement-appointment-booking-slots-using-redis-c941d50a50d6?source=collection_archive---------6-----------------------#2022-07-12</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="fe7a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在本文中，我们将了解如何使用以下 redis 服务/模块在医院中为各种类别(如<code class="fe ki kj kk kl b">Eye Checkup</code>、<code class="fe ki kj kk kl b">Full Body Checkup</code>、&amp;、<code class="fe ki kj kk kl b">Vaccine</code>)实施预约特定时间段的门户:</p><ul class=""><li id="b4bf" class="km kn in jm b jn jo jr js jv ko jz kp kd kq kh kr ks kt ku bi translated">雷迪森</li><li id="a6c5" class="km kn in jm b jn kv jr kw jv kx jz ky kd kz kh kr ks kt ku bi translated">再研究</li><li id="2a79" class="km kn in jm b jn kv jr kw jv kx jz ky kd kz kh kr ks kt ku bi translated">Redis 企业云</li></ul><h1 id="c89b" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">RedisJSON 是什么？</h1><p id="9e59" class="pw-post-body-paragraph jk jl in jm b jn ly jp jq jr lz jt ju jv ma jx jy jz mb kb kc kd mc kf kg kh ig bi translated">RedisJSON 是一个 Redis 模块，在 Redis 中启用 JSON 支持。它允许您像使用普通 JSON 一样执行各种操作，如插入、更新、获取和删除 JSON 值。此外，我们可以用 RediSearch 配置它，无缝地索引和查询 JSON 文档。</p><h1 id="65b4" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">什么是再研究？</h1><p id="4227" class="pw-post-body-paragraph jk jl in jm b jn ly jp jq jr lz jt ju jv ma jx jy jz mb kb kc kd mc kf kg kh ig bi translated">RediSearch 是一个全文搜索引擎，作为 Redis 的一个模块提供。我们可以使用 And / Or 和其他操作符查询模式，以便在最短的时间内获取结果。此外，它还提供了一些关键功能，如二级索引、多字段查询、聚合和数字过滤。</p><h1 id="52f6" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">什么是 Redis 企业云？</h1><p id="52a8" class="pw-post-body-paragraph jk jl in jm b jn ly jp jq jr lz jt ju jv ma jx jy jz mb kb kc kd mc kf kg kh ig bi translated">Redis 企业云是 Redis 提供的完全托管的云服务。它带有 Redis 的所有本机模块，即 RediSearch、RedisJSON、RedisGraph、RedisBloom、RedisTimeSeries。除此之外，它还提供访问控制管理功能来创建不同的用户角色，并限制读/写访问。</p><h1 id="bb88" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">步骤 1:先决条件</h1><ul class=""><li id="0ed9" class="km kn in jm b jn ly jr lz jv md jz me kd mf kh kr ks kt ku bi translated">节点 v14 或更高版本</li><li id="9cdc" class="km kn in jm b jn kv jr kw jv kx jz ky kd kz kh kr ks kt ku bi translated">nx cli — <code class="fe ki kj kk kl b">npm install -g nx</code></li><li id="ac59" class="km kn in jm b jn kv jr kw jv kx jz ky kd kz kh kr ks kt ku bi translated">创建您的免费<a class="ae mg" href="https://redis.com/try-free/" rel="noopener ugc nofollow" target="_blank"> Redis 企业云账户</a>，您可以使用 Redis 企业云创建的默认数据库或者<a class="ae mg" href="https://docs.redis.com/latest/rc/databases/create-database/" rel="noopener ugc nofollow" target="_blank">创建一个新数据库</a>。</li></ul><h1 id="4045" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">步骤 2:克隆存储库</h1><pre class="mh mi mj mk gt ml kl mm mn aw mo bi"><span id="716e" class="mp lb in kl b gy mq mr l ms mt">git clone &lt;https://github.com/sumitvekariya/book-appointment.git&gt;</span></pre><h1 id="ccd8" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">步骤 3:安装所需的依赖项</h1><pre class="mh mi mj mk gt ml kl mm mn aw mo bi"><span id="7a95" class="mp lb in kl b gy mq mr l ms mt">cd book-appointment<br/>npm i</span></pre><h1 id="faad" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">步骤 4:文件夹结构:</h1><p id="58f9" class="pw-post-body-paragraph jk jl in jm b jn ly jp jq jr lz jt ju jv ma jx jy jz mb kb kc kd mc kf kg kh ig bi translated">为了简单起见，我们使用 Nx 的前端和后端使用单回购结构。</p><ul class=""><li id="adc0" class="km kn in jm b jn jo jr js jv ko jz kp kd kq kh kr ks kt ku bi translated"><code class="fe ki kj kk kl b">apps/api</code>:将作为我们的 NestJS 后端。</li><li id="28dc" class="km kn in jm b jn kv jr kw jv kx jz ky kd kz kh kr ks kt ku bi translated"><code class="fe ki kj kk kl b">apps/book-appointment</code>:将作为我们的角前端。</li></ul><figure class="mh mi mj mk gt mv gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi mu"><img src="../Images/434d09a8c7c47721695f5ef8f947db02.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AWrE63vrPfczfUg3CPETBA.png"/></div></div><figcaption class="nc nd gj gh gi ne nf bd b be z dk translated">文件夹结构</figcaption></figure><h1 id="c3c7" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">步骤 5:配置数据库(可选)</h1><p id="0f2a" class="pw-post-body-paragraph jk jl in jm b jn ly jp jq jr lz jt ju jv ma jx jy jz mb kb kc kd mc kf kg kh ig bi translated">使用我们在先决条件部分创建的数据库的凭据在<a class="ae mg" href="https://redis.com/try-free/" rel="noopener ugc nofollow" target="_blank"> redis 企业云帐户</a>中创建 Redis 数据库</p><p id="991b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">文件</strong> : <code class="fe ki kj kk kl b">app/api/src/environments/environment.ts</code>(针对本地)</p><p id="4d5b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">文件</strong> : <code class="fe ki kj kk kl b">app/api/src/environments/environment.prod.ts</code>(生产用)</p><pre class="mh mi mj mk gt ml kl mm mn aw mo bi"><span id="67b5" class="mp lb in kl b gy mq mr l ms mt">export const environment = {<br/>  REDIS_HOST: "",<br/>  REDIS_USERNAME: "",<br/>  REDIS_PASSWORD: ""<br/>};</span></pre><h1 id="e864" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">步骤 6:如何连接 Redis 客户端:</h1><p id="63c1" class="pw-post-body-paragraph jk jl in jm b jn ly jp jq jr lz jt ju jv ma jx jy jz mb kb kc kd mc kf kg kh ig bi translated">我们已经创建了一个<code class="fe ki kj kk kl b">RedisClientService</code>,它负责处理连接并对 Redis 数据库执行操作。</p><pre class="mh mi mj mk gt ml kl mm mn aw mo bi"><span id="b7c8" class="mp lb in kl b gy mq mr l ms mt">import { Injectable } from '@nestjs/common';<br/>import { createClient } from 'redis';<br/>import { environment } from '../environments/environment';</span><span id="3d88" class="mp lb in kl b gy ng mr l ms mt">@Injectable()<br/>export class RedisClientService {<br/>  public client;<br/>  constructor() {<br/>    // Create connection instance with redis using database credentials stored in<br/>    // environment variables in step 5<br/>    this.client = createClient({<br/>      url: environment.REDIS_HOST,<br/>      username: environment.REDIS_USERNAME,<br/>      password: environment.REDIS_PASSWORD<br/>    });</span><span id="3843" class="mp lb in kl b gy ng mr l ms mt">    // Check error while connection.<br/>    this.client.on('error', (err) =&gt; console.log('Redis Client Error', err));</span><span id="2fc8" class="mp lb in kl b gy ng mr l ms mt">    // Establish a connection<br/>    this.client.connect();<br/>  }</span><span id="d95b" class="mp lb in kl b gy ng mr l ms mt">  getClient() {<br/>    return this.client;<br/>  }</span><span id="86af" class="mp lb in kl b gy ng mr l ms mt">  async generateIndex() {<br/>    ...<br/>  }<br/>}</span></pre><h1 id="890f" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">步骤 7:启动前端和后端</h1><p id="3e03" class="pw-post-body-paragraph jk jl in jm b jn ly jp jq jr lz jt ju jv ma jx jy jz mb kb kc kd mc kf kg kh ig bi translated">在不同的终端中运行以下两个命令。</p><pre class="mh mi mj mk gt ml kl mm mn aw mo bi"><span id="2479" class="mp lb in kl b gy mq mr l ms mt">npm run start:FE # for frontend<br/>npm run start:BE # for backend</span></pre><h1 id="3a4b" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">第八步:它是如何工作的？</h1><h1 id="a7ff" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">适用范围</h1><p id="6973" class="pw-post-body-paragraph jk jl in jm b jn ly jp jq jr lz jt ju jv ma jx jy jz mb kb kc kd mc kf kg kh ig bi translated">在应用程序中，有两种类型的用户</p><ul class=""><li id="656a" class="km kn in jm b jn jo jr js jv ko jz kp kd kq kh kr ks kt ku bi translated">患者—可以预约可用于预约的时段</li><li id="7fdb" class="km kn in jm b jn kv jr kw jv kx jz ky kd kz kh kr ks kt ku bi translated">管理员—可以根据约会的日期、电子邮件、名称和类别过滤和查看约会</li></ul><p id="f6a1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">有 3 种服务类别可以预约</p><ul class=""><li id="f061" class="km kn in jm b jn jo jr js jv ko jz kp kd kq kh kr ks kt ku bi translated">疫苗</li><li id="c776" class="km kn in jm b jn kv jr kw jv kx jz ky kd kz kh kr ks kt ku bi translated">全身检查</li><li id="27e7" class="km kn in jm b jn kv jr kw jv kx jz ky kd kz kh kr ks kt ku bi translated">眼睛检查</li></ul><h1 id="8b5e" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">患者端:</h1><figure class="mh mi mj mk gt mv gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi nh"><img src="../Images/19ad78b4bcebdb55cf5ac6bbcd514cc7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vRyz9SRM8kssm33HYM7WOQ.png"/></div></div></figure><h1 id="3810" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">如何创建类别？</h1><p id="846d" class="pw-post-body-paragraph jk jl in jm b jn ly jp jq jr lz jt ju jv ma jx jy jz mb kb kc kd mc kf kg kh ig bi translated">在运行后端时，我们需要创建可以预约的类别，所以我们创建了 3 个类别，并使用<code class="fe ki kj kk kl b">RedisJSON</code>将它们插入 redis 数据库。</p><p id="8d0b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">文件</strong> : <code class="fe ki kj kk kl b">apps/api/src/utils/redis.service.ts</code></p><pre class="mh mi mj mk gt ml kl mm mn aw mo bi"><span id="ce72" class="mp lb in kl b gy mq mr l ms mt">async setCategories() {<br/>  const categoryKey = `category`;<br/>  const categories = [<br/>    'Full Body Checkup',<br/>    'Vaccine',<br/>    'Eye Checkup'<br/>  ];</span><span id="9a6c" class="mp lb in kl b gy ng mr l ms mt">  // Check whether same key exist or not<br/>  const existingData = await this.client.json.get(categoryKey);<br/>  if (!existingData) {<br/>    this.client.json.set(categoryKey, '$', categories);<br/>  } else {<br/>    console.log("Categories are already there in Redis");<br/>  }<br/>}</span></pre><h1 id="b326" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">如何获取类别:</h1><p id="2f62" class="pw-post-body-paragraph jk jl in jm b jn ly jp jq jr lz jt ju jv ma jx jy jz mb kb kc kd mc kf kg kh ig bi translated"><strong class="jm io">文件</strong> : <code class="fe ki kj kk kl b">apps/api/src/app/app.service.ts</code></p><pre class="mh mi mj mk gt ml kl mm mn aw mo bi"><span id="b583" class="mp lb in kl b gy mq mr l ms mt">async getCategories() {<br/>  const categoryKey = `category`;<br/>  const categories = await this.client.json.get(categoryKey);<br/>  return categories;<br/>}</span></pre><h1 id="5131" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">槽是如何产生的？</h1><p id="9c63" class="pw-post-body-paragraph jk jl in jm b jn ly jp jq jr lz jt ju jv ma jx jy jz mb kb kc kd mc kf kg kh ig bi translated">在生成每个 20 分钟的时间段时，我们将午餐时间设置为 12:00PM-1:00PM。</p><p id="b1ee" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">然后我们从 Redis 数据库中获取给定日期的槽。</p><pre class="mh mi mj mk gt ml kl mm mn aw mo bi"><span id="c244" class="mp lb in kl b gy mq mr l ms mt">const bookedSlotsKeys = await this.client.keys(`booked:slots:${date}:*`);</span><span id="6a2f" class="mp lb in kl b gy ng mr l ms mt">if (bookedSlotsKeys?.length) {<br/>   // Fetch slots from the keys<br/>   let bookedSlotsDataInRedis = await this.client.json.mGet(bookedSlotsKeys, '$');<br/>   bookedSlots = [].concat(...bookedSlotsDataInRedis);<br/>}</span></pre><p id="14e1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">之后，它会将<code class="fe ki kj kk kl b">isBooked</code>标志分配给已经预订的时隙，并且还会根据时隙的时间分配<code class="fe ki kj kk kl b">isMorningSlot</code>、<code class="fe ki kj kk kl b">isNoonSlot</code> &amp; <code class="fe ki kj kk kl b">isEveningSlot</code>标志。</p><p id="e326" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">文件</strong> : <code class="fe ki kj kk kl b">apps/api/src/app/app.service.ts</code></p><pre class="mh mi mj mk gt ml kl mm mn aw mo bi"><span id="cda2" class="mp lb in kl b gy mq mr l ms mt">async generateSlots(date: string) {<br/>  const duration = 20; // Each slot wll be of 20 minutes<br/>  const startDateFormat = `${date}T10:00:00`;<br/>  const endDateFormat = `${date}T20:00:00`;</span><span id="6aa1" class="mp lb in kl b gy ng mr l ms mt">  const lunchStartDate = `${date}T12:00:00`;<br/>  const lunchEndDate = `${date}T13:00:00`;</span><span id="797c" class="mp lb in kl b gy ng mr l ms mt">  const noonEndTime = `${date}T16:00:00`;</span><span id="4e5b" class="mp lb in kl b gy ng mr l ms mt">  let currentDate = startDateFormat;<br/>  const slots = [];</span><span id="d8d0" class="mp lb in kl b gy ng mr l ms mt">  // get all booked slots<br/>  let bookedSlots = [];<br/>  // Fetch all the keys (of booked slots) for given date<br/>  const bookedSlotsKeys = await this.client.keys(`booked:slots:${date}:*`);<br/>  if (bookedSlotsKeys?.length) {<br/>      // Fetch slots from the keys<br/>      let bookedSlotsDataInRedis = await this.client.json.mGet(bookedSlotsKeys, '$');<br/>      bookedSlots = [].concat(...bookedSlotsDataInRedis);<br/>  }</span><span id="4291" class="mp lb in kl b gy ng mr l ms mt">  while(new Date(currentDate) &lt; new Date(endDateFormat)) {<br/>    const startTime = moment(currentDate).format('YYYY-MM-DDTHH:mm:ss');<br/>    const endTime = moment(currentDate).add(duration, 'minutes').format('YYYY-MM-DDTHH:mm:ss');</span><span id="8518" class="mp lb in kl b gy ng mr l ms mt">    let isBooked = 0;<br/>    if (bookedSlots?.length) {<br/>      // Check whether calculated slot is as same as booked slot. If yes then set isBooked flag as 1.<br/>      const foundSlot = bookedSlots.find(obj =&gt; obj.startTime === startTime &amp;&amp; obj.endTime === endTime);<br/>      if (foundSlot) {<br/>        isBooked = 1;<br/>      }  <br/>    }</span><span id="7b97" class="mp lb in kl b gy ng mr l ms mt">    const objToPush = {<br/>      startTime,<br/>      endTime,<br/>      isBooked<br/>    };</span><span id="882f" class="mp lb in kl b gy ng mr l ms mt">    // Assign morning slots<br/>    if (new Date(endTime) &lt;= new Date(lunchStartDate)) {<br/>      slots.push({ ...objToPush, isMorningSlot: 1 });<br/>    }<br/>    // Assign noon slots<br/>    else if (new Date(startTime) &gt;= new Date(lunchEndDate) &amp;&amp; new Date(endTime) &lt;= new Date(noonEndTime)) {<br/>      slots.push({ ...objToPush, isNoonSlot: 1 });<br/>    } <br/>    // Assign evening slots<br/>    else if (new Date(startTime) &gt;= new Date(noonEndTime)){<br/>      slots.push({ ...objToPush, isEveningSlot: 1 });<br/>    }<br/>    currentDate = endTime;<br/>  }<br/>  <br/>  return slots;<br/>}</span></pre><h1 id="aa8e" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">如何预约？</h1><p id="bb3a" class="pw-post-body-paragraph jk jl in jm b jn ly jp jq jr lz jt ju jv ma jx jy jz mb kb kc kd mc kf kg kh ig bi translated">为了预约一个时间段，我们将需要 slot<code class="fe ki kj kk kl b">startTime</code>&amp;<code class="fe ki kj kk kl b">endTime</code>包括日期，<code class="fe ki kj kk kl b">category</code> &amp; <code class="fe ki kj kk kl b">user</code>。</p><p id="cd88" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">之后，我们将获取在给定日期预订的所有时段，如果时段已经预订，我们将抛出一个错误来表明这一点。</p><p id="f5ff" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">否则，我们将用惟一键将 slot JSON 对象设置到 Redis 中，</p><pre class="mh mi mj mk gt ml kl mm mn aw mo bi"><span id="7b91" class="mp lb in kl b gy mq mr l ms mt">// Create JSON object with values to store into redis<br/>const obj = {<br/>  "name": userData.name,<br/>  "email": userData.email,<br/>  "date": date,<br/>  "timeStamp": unixTimeStamp,<br/>  "startTime": bookSlotDto.startTime,<br/>  "endTime": bookSlotDto.endTime,<br/>  "category": bookSlotDto.category<br/>}</span><span id="2a02" class="mp lb in kl b gy ng mr l ms mt">// Set JSON object in Redis<br/>await this.client.json.set(key, '$', obj);</span></pre><p id="8267" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这个函数的完整实现在这里，</p><p id="b20d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">文件</strong> : <code class="fe ki kj kk kl b">apps/api/src/app/app.service.ts</code></p><pre class="mh mi mj mk gt ml kl mm mn aw mo bi"><span id="bc72" class="mp lb in kl b gy mq mr l ms mt">async bookSlot(bookSlotDto: BookSlotDto, userData: Login) {<br/>  try {</span><span id="6c47" class="mp lb in kl b gy ng mr l ms mt">    const unixTimeStamp = new Date(new Date(bookSlotDto.startTime).setHours(0,0,0,0)).getTime();<br/>    const date = moment(bookSlotDto.startTime).format('YYYY-MM-DD');<br/>    const key = `booked:slots:${date}:${userData.email}`;</span><span id="4618" class="mp lb in kl b gy ng mr l ms mt">    // Fetch all the keys (of booked slots) for given date<br/>    const keysForIncomingdate = await this.client.keys(`booked:slots:${date}:*`);</span><span id="d1e4" class="mp lb in kl b gy ng mr l ms mt">    let result = []<br/>    if (keysForIncomingdate?.length) {<br/>      // Fetch slots from the keys<br/>      result = await this.client.json.mGet(keysForIncomingdate, '$');<br/>      result = [].concat(...result);<br/>    }</span><span id="e6be" class="mp lb in kl b gy ng mr l ms mt">    if (result?.length) {<br/>        // check that incoming is booked or not<br/>        const bookedSlot = result.find(obj =&gt; obj.startTime === bookSlotDto.startTime &amp;&amp; obj.endTime === bookSlotDto.endTime);<br/>        if (bookedSlot) {<br/>          throw new Error('This slot is already booked. Please choose another one.');<br/>        }<br/>    }</span><span id="90f7" class="mp lb in kl b gy ng mr l ms mt">    // Create JSON object with values to store into redis<br/>    const obj = {<br/>      "name": userData.name,<br/>      "email": userData.email,<br/>      "date": date,<br/>      "timeStamp": unixTimeStamp,<br/>      "startTime": bookSlotDto.startTime,<br/>      "endTime": bookSlotDto.endTime,<br/>      "category": bookSlotDto.category<br/>    }<br/>    <br/>    // Set JSON object in Redis<br/>    await this.client.json.set(key, '$', obj);</span><span id="35d2" class="mp lb in kl b gy ng mr l ms mt">    return true;<br/>    <br/>  } catch (err) {<br/>    console.log("ERRR", err);<br/>    throw err;<br/>  }<br/>}</span></pre><h1 id="71f9" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">管理端:</h1><figure class="mh mi mj mk gt mv gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi nh"><img src="../Images/0f634537ec8d68ea17b6b03d61e39bb4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i_HPyeYEqCuIkIQpn-Y85g.png"/></div></div></figure><p id="d0c2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">为了过滤已预约的预约，我们将使用<code class="fe ki kj kk kl b">RediSearch</code>模块。为了使用<code class="fe ki kj kk kl b">RediSearch</code>进行过滤，我们需要确定我们想要过滤的字段。</p><p id="38c8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">之后，我们需要创建组合这些字段的索引<em class="ni">。可以在<em class="ni">散列</em>或<em class="ni"> JSON 上创建索引。</em>我们已经使用了<code class="fe ki kj kk kl b">RedisJSON</code>，所以我们将在<em class="ni"> JSON </em>类型上创建索引。下面是创建索引的完整函数:</em></p><p id="d467" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">文件</strong> : <code class="fe ki kj kk kl b">apps/api/src/utils/redis.service.ts</code></p><pre class="mh mi mj mk gt ml kl mm mn aw mo bi"><span id="4f0e" class="mp lb in kl b gy mq mr l ms mt">// Here, we have used *NUMERIC* and *TEXT* type while defining schema fields. <br/>// Other types are *GEO*, *TAG* and *VECTOR.* We can use suitable type based on requirement.</span><span id="34b5" class="mp lb in kl b gy ng mr l ms mt">async generateIndex() {<br/>    // create index<br/>  try {<br/>    await this.client.ft.create('idx:slots', {<br/>      '$.timeStamp': {<br/>        type: SchemaFieldTypes.NUMERIC,<br/>        AS: 'timeStamp'<br/>      },<br/>      '$.email': {<br/>        type: SchemaFieldTypes.TEXT,<br/>        AS: 'email'<br/>      },<br/>      '$.name': {<br/>        type: SchemaFieldTypes.TEXT,<br/>        AS: 'name'<br/>      },<br/>      '$.category': {<br/>        type: SchemaFieldTypes.TEXT,<br/>        AS: 'category'<br/>      }<br/>    },<br/>    {<br/>      ON: 'JSON',<br/>      PREFIX: 'booked:slots'<br/>    });<br/>  } catch (err) {<br/>    console.log("Index already created")<br/>  }<br/>}</span></pre><p id="5560" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><a class="ae mg" href="https://github.com/sumitvekariya/book-appointmnet/blob/6dea9f37741ee06c5e96550db0ffebfd6a4bc00c/apps/api/src/utils/redis.service.ts#L21" rel="noopener ugc nofollow" target="_blank">创建索引</a></p><p id="312f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><code class="fe ki kj kk kl b">RediSearch</code>提供多字段搜索功能，</p><p id="2493" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><code class="fe ki kj kk kl b">*</code>在查询中用作前缀匹配，如果我们想要进行精确搜索，我们可以删除它。</p><p id="6883" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">包含所有值的完全搜索查询:</p><pre class="mh mi mj mk gt ml kl mm mn aw mo bi"><span id="4777" class="mp lb in kl b gy mq mr l ms mt">searchString = `@timeStamp:[${timeStamp} ${endTimeStamp}],@name:(${appointmentDto.name}*),@email:(${appointmentDto.name}*),@category:(${category}*)`</span></pre><p id="4ec5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">文件</strong> : <code class="fe ki kj kk kl b">apps/api/src/app/app.service.ts</code></p><pre class="mh mi mj mk gt ml kl mm mn aw mo bi"><span id="c7b8" class="mp lb in kl b gy mq mr l ms mt">async getAppointments(appointmentDto: GetAppointmentDto) {<br/>  try {</span><span id="fdb1" class="mp lb in kl b gy ng mr l ms mt">    let category = '';</span><span id="f58e" class="mp lb in kl b gy ng mr l ms mt">    const timeStamp = new Date(new Date(appointmentDto.date).setHours(0,0,0,0)).getTime();<br/>    // Query to filter appointments by given date range e.g. [startDate endDate]<br/>    let searchString = `@timeStamp:[${timeStamp} ${timeStamp}]`;<br/>    if (appointmentDto.endDate) {<br/>      const endTimeStamp = new Date(new Date(appointmentDto.endDate).setHours(0,0,0,0)).getTime();<br/>      searchString = `@timeStamp:[${timeStamp} ${endTimeStamp}]`<br/>    }</span><span id="e622" class="mp lb in kl b gy ng mr l ms mt">    // Query to filter appointments by given name. NOTE:: Here we search by the email as well.<br/>    if (appointmentDto.name) {<br/>      searchString += `,@name:(${appointmentDto.name}*),@email:(${appointmentDto.name}*)`<br/>    }</span><span id="9647" class="mp lb in kl b gy ng mr l ms mt">    // Query to filter appointments by given category.<br/>    if (appointmentDto.category) {<br/>      category = appointmentDto.category.trim()<br/>      searchString += `,@category:(${category}*)`<br/>    }</span><span id="955e" class="mp lb in kl b gy ng mr l ms mt">    // Search index based on query filter.<br/>    const bookSlots = await this.client.ft.search('idx:slots', `${searchString}`);<br/>    const response = [];</span><span id="a649" class="mp lb in kl b gy ng mr l ms mt">    if (bookSlots?.documents?.length) {<br/>      for (let obj of bookSlots?.documents) {<br/>        response.push(obj.value);<br/>      }<br/>      return response;<br/>    } else {<br/>      return [];<br/>    }<br/>  } catch (err) {<br/>    throw err;<br/>  }<br/>}</span></pre><h1 id="cff7" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">Redis Insight:</h1><p id="ff8b" class="pw-post-body-paragraph jk jl in jm b jn ly jp jq jr lz jt ju jv ma jx jy jz mb kb kc kd mc kf kg kh ig bi translated"><code class="fe ki kj kk kl b">RedisInsight</code>是 Redis 的免费 GUI，可用于所有平台。我们可以使用该工具进行各种操作，例如:</p><ul class=""><li id="3ec4" class="km kn in jm b jn jo jr js jv ko jz kp kd kq kh kr ks kt ku bi translated">查看存储的数据</li><li id="004c" class="km kn in jm b jn kv jr kw jv kx jz ky kd kz kh kr ks kt ku bi translated">管理 Redis 群集属性</li><li id="cd75" class="km kn in jm b jn kv jr kw jv kx jz ky kd kz kh kr ks kt ku bi translated">用 REPL 执行命令</li><li id="fe2d" class="km kn in jm b jn kv jr kw jv kx jz ky kd kz kh kr ks kt ku bi translated">编辑 Redis 实例的配置</li></ul><h1 id="2ec6" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">如何连接 Redis Insight？</h1><p id="a8ae" class="pw-post-body-paragraph jk jl in jm b jn ly jp jq jr lz jt ju jv ma jx jy jz mb kb kc kd mc kf kg kh ig bi translated">我们可以使用在先决条件部分创建的数据库的凭证来连接 redis 数据库。</p><figure class="mh mi mj mk gt mv gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi nh"><img src="../Images/a7eb0c8a2699a7af8470a5936acc65c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LE5nouXJQKPwslD0d0pSWw.png"/></div></div><figcaption class="nc nd gj gh gi ne nf bd b be z dk translated">Redis Insight 连接</figcaption></figure><figure class="mh mi mj mk gt mv gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi nh"><img src="../Images/b90c56d089605285d72fcd8dc9c9ffa2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WWGXSE3vLwP1W9LcStBppg.png"/></div></div><figcaption class="nc nd gj gh gi ne nf bd b be z dk translated">Redis 洞察更新 JSON</figcaption></figure><h1 id="c78d" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">演示:</h1><p id="afdd" class="pw-post-body-paragraph jk jl in jm b jn ly jp jq jr lz jt ju jv ma jx jy jz mb kb kc kd mc kf kg kh ig bi translated">你可以在这里查看现场演示:<a class="ae mg" href="https://redis-book-appointment-ui.herokuapp.com" rel="noopener ugc nofollow" target="_blank">https://redis-book-appointment-ui.herokuapp.com</a></p><p id="c974" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">完整源代码:<a class="ae mg" href="https://github.com/sumitvekariya/book-appointment" rel="noopener ugc nofollow" target="_blank">https://github.com/sumitvekariya/book-appointment</a></p><p id="a695" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">以下是可用于登录的登录凭据对</p><ul class=""><li id="871d" class="km kn in jm b jn jo jr js jv ko jz kp kd kq kh kr ks kt ku bi translated">病人</li><li id="34b3" class="km kn in jm b jn kv jr kw jv kx jz ky kd kz kh kr ks kt ku bi translated">patient1@gmail.com 患者 1</li><li id="ec09" class="km kn in jm b jn kv jr kw jv kx jz ky kd kz kh kr ks kt ku bi translated">patient2@gmail.com 患者 2</li><li id="3b27" class="km kn in jm b jn kv jr kw jv kx jz ky kd kz kh kr ks kt ku bi translated">patient3@gmail.com 患者 3</li><li id="5a1c" class="km kn in jm b jn kv jr kw jv kx jz ky kd kz kh kr ks kt ku bi translated">patient4@gmail.com—患者 4</li><li id="039d" class="km kn in jm b jn kv jr kw jv kx jz ky kd kz kh kr ks kt ku bi translated">管理</li><li id="c867" class="km kn in jm b jn kv jr kw jv kx jz ky kd kz kh kr ks kt ku bi translated">admin@gmail.com—行政</li></ul><h1 id="0372" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">参考资料:</h1><p id="7c94" class="pw-post-body-paragraph jk jl in jm b jn ly jp jq jr lz jt ju jv ma jx jy jz mb kb kc kd mc kf kg kh ig bi translated">这篇文章是与 Redis 合作的。</p><p id="6585" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">有关 redis 的更多详细信息，请参考以下链接:</p><ul class=""><li id="b67d" class="km kn in jm b jn jo jr js jv ko jz kp kd kq kh kr ks kt ku bi translated"><a class="ae mg" href="https://redis.com/try-free/?utm_campaign=write_for_redis" rel="noopener ugc nofollow" target="_blank">免费试用 Redis 云</a></li><li id="4924" class="km kn in jm b jn kv jr kw jv kx jz ky kd kz kh kr ks kt ku bi translated"><a class="ae mg" href="https://www.youtube.com/watch?v=vyxdC1qK4NE" rel="noopener ugc nofollow" target="_blank">观看此视频，了解 Redis 云相对于其他 Redis 提供商的优势</a></li><li id="887e" class="km kn in jm b jn kv jr kw jv kx jz ky kd kz kh kr ks kt ku bi translated"><a class="ae mg" href="https://developer.redis.com/?utm_campaign=write_for_redis" rel="noopener ugc nofollow" target="_blank"> Redis 开发者中心——关于 Redis 的工具、指南和教程</a></li><li id="c11a" class="km kn in jm b jn kv jr kw jv kx jz ky kd kz kh kr ks kt ku bi translated"><a class="ae mg" href="https://redis.io/docs/stack/insight/?utm_campaign=write_for_redis" rel="noopener ugc nofollow" target="_blank"> RedisInsight 桌面 GUI </a></li></ul></div></div>    
</body>
</html>