<html>
<head>
<title>Machine Learning Practice with KubeVela</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 KubeVela 进行机器学习实践</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/machine-learning-practice-with-kubevela-1f62a6dbafec?source=collection_archive---------11-----------------------#2022-04-12">https://blog.devgenius.io/machine-learning-practice-with-kubevela-1f62a6dbafec?source=collection_archive---------11-----------------------#2022-04-12</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="89f2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><em class="ki">由董天心在推特上@ fog _ 谷氨酰胺</em></p><p id="15a3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在机器学习病毒式传播的背景下，AI 工程师不仅需要训练和调试他们的模型，还需要在线部署它们，以验证它看起来如何(当然有时，这部分工作是由 AI 平台工程师完成的。).这是非常乏味和令人疲惫的人工智能工程师。</p><p id="ac88" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在云原生时代，我们的模型训练和模型服务通常也在云上进行。这样做不仅提高了可伸缩性，还提高了资源利用率。这对于消耗大量计算资源的机器学习场景非常有效。</p><p id="a83f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">但人工智能工程师通常很难使用云原生技术。随着时间的推移，原生云的概念变得越来越复杂。即使要在云原生架构上部署一个简单的模型，人工智能工程师可能也需要学习几个额外的概念:部署、服务、入口等。</p><p id="ccea" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">作为一个简单、易用、高度可扩展的云原生应用管理工具，KubeVela 使开发人员能够在 Kubernetes 上快速轻松地定义和交付应用，而无需了解底层云原生基础设施的任何细节。KubeVela 丰富的扩展性延伸到 AI 插件，并提供模型训练、模型服务、A/B 测试等功能，覆盖 AI 工程师的基本需求，帮助 AI 工程师在云原生环境下快速进行模型训练和模型服务。</p><p id="b4c1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">本文主要讨论如何使用 KubeVela 的 AI 插件来帮助工程师更容易地完成模型训练和模型服务。</p><h1 id="362b" class="kj kk in bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">库伯韦拉·艾·阿登</h1><p id="69a5" class="pw-post-body-paragraph jk jl in jm b jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc kd ll kf kg kh ig bi translated">KubeVela AI addon 分为两个:模特培训和模特服务。模型训练插件基于 KubeFlow 的 training-operator，可以支持不同框架中的分布式模型训练，如 TensorFlow、PyTorch 和 MXNet。模型服务插件(model serving addon)基于 Seldon Core，可以方便地使用模型启动模型服务，还支持流量分配、A/B 测试等高级功能。</p><figure class="ln lo lp lq gt lr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi lm"><img src="../Images/dc907fc6667246f49ac0bb8754e0b282.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*YURKFEbybBIOhK3z.png"/></div></div></figure><p id="17c0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">通过 KubeVela AI 插件，可以显著简化模型训练和服务任务的部署。同时，模型训练和服务的过程可以结合 KubeVela 自身的工作流、多集群等功能，完成生产级服务。</p><p id="9866" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">注意:你可以在<a class="ae ly" href="https://github.com/oam-dev/samples/tree/master/11.Machine_Learning_Demo" rel="noopener ugc nofollow" target="_blank"> KubeVela Samples </a>中找到所有的源代码和 YAML 文件。如果您想要使用在这个例子中预先训练的模型，文件夹中的<code class="fe lz ma mb mc b">style-model.yaml</code>和<code class="fe lz ma mb mc b">color-model.yaml</code>将会这样做并将模型复制到 PVC 中。</p><h1 id="85c9" class="kj kk in bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">模特培训</h1><p id="deb6" class="pw-post-body-paragraph jk jl in jm b jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc kd ll kf kg kh ig bi translated">首先启用模型训练和模型服务这两个插件。</p><pre class="ln lo lp lq gt md mc me mf aw mg bi"><span id="c0b9" class="mh kk in mc b gy mi mj l mk ml">vela addon enable model-training<br/>vela addon enable model-serving</span></pre><p id="1700" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">模特培训包括<code class="fe lz ma mb mc b">model-training</code>和<code class="fe lz ma mb mc b">jupyter-notebook</code>两种组件类型，模特服务包括<code class="fe lz ma mb mc b">model-serving</code>组件类型。这三个部件的具体参数可以通过<code class="fe lz ma mb mc b">vela show</code>命令查看。</p><p id="3a01" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">你也可以阅读<a class="ae ly" href="https://kubevela.io/en/docs/next/reference/addons/ai" rel="noopener ugc nofollow" target="_blank"> KubeVela AI Addon 文档</a>了解更多信息。</p><pre class="ln lo lp lq gt md mc me mf aw mg bi"><span id="c31d" class="mh kk in mc b gy mi mj l mk ml">vela show model-training<br/>vela show jupyter-notebook<br/>vela show model-serving</span></pre><p id="69d7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让我们使用 TensorFlow 框架训练一个简单的模型，将灰色图像转换为彩色图像。部署以下 YAML 文件:</p><p id="a568" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">注:模型训练的源代码来自:<a class="ae ly" href="https://github.com/emilwallner/Coloring-greyscale-images" rel="noopener ugc nofollow" target="_blank">emilwallner/着色-灰度-图像</a></p><pre class="ln lo lp lq gt md mc me mf aw mg bi"><span id="de80" class="mh kk in mc b gy mi mj l mk ml">apiVersion: core.oam.dev/v1beta1<br/>kind: Application<br/>metadata:<br/>  name: training-serving<br/>  namespace: default<br/>spec:<br/>  components:<br/>  # Train the model<br/>  - name: demo-training<br/>    type: model-training<br/>    properties:<br/>      # Mirror of the trained model<br/>      image: fogdong/train-color:v1<br/>      # A framework for model training<br/>      framework: tensorflow<br/>      # Declare storage to persist models. Here, the default storage class in the cluster will be used to create the PVC<br/>      storage:<br/>        - name: "my-pvc"<br/>          mountPath: "/model"</span></pre><p id="99e6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">此时，库比韦拉会拉起一辆<code class="fe lz ma mb mc b">TFJob</code>进行模特训练。</p><p id="7c62" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">仅仅通过训练模型很难看出是怎么回事。让我们修改这个 YAML 文件，将模型服务放在模型训练步骤之后。同时，由于模型服务会直接启动模型，而模型的输入输出并不直观(ndarray 或 Tensor)，因此，我们部署一个测试服务来调用服务，并将结果转换成图像。</p><p id="8b38" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">部署以下 YAML 文件:</p><pre class="ln lo lp lq gt md mc me mf aw mg bi"><span id="d179" class="mh kk in mc b gy mi mj l mk ml">apiVersion: core.oam.dev/v1beta1<br/>kind: Application<br/>metadata:<br/>  name: training-serving<br/>  namespace: default<br/>spec:<br/>  components:<br/>  # Train the model<br/>  - name: demo-training<br/>    type: model-training<br/>    properties:<br/>      image: fogdong/train-color:v1<br/>      framework: tensorflow<br/>      storage:<br/>        - name: "my-pvc"<br/>          mountPath: "/model"<br/>  <br/>  # Start the model serving<br/>  - name: demo-serving<br/>    type: model-serving<br/>    # The model serving will start after model training is complete<br/>    dependsOn:<br/>      - demo-training<br/>    properties:<br/>      # The protocol used to start the model serving can be left blank. By default, seldon's own protocol is used.<br/>      protocol: tensorflow<br/>      predictors:<br/>        - name: model<br/>          # The number of replicas for the model serving<br/>          replicas: 1<br/>          graph:<br/>            # model name<br/>            name: my-model<br/>            # model frame<br/>            implementation: tensorflow<br/>            # Model address, the previous step will save the trained model to the pvc of my-pvc, so specify the address of the model through pvc://my-pvc<br/>            modelUri: pvc://my-pvc</span><span id="ae87" class="mh kk in mc b gy mm mj l mk ml">  # test model serving<br/>  - name: demo-rest-serving<br/>    type: webservice<br/>    # The test service will start after model training is complete<br/>    dependsOn:<br/>      - demo-serving<br/>    properties:<br/>      image: fogdong/color-serving:v1<br/>      # Use LoadBalancer to expose external addresses for easy to access<br/>      exposeType: LoadBalancer<br/>      env:<br/>        - name: URL<br/>          # The address of the model serving<br/>          value: <a class="ae ly" href="http://ambassador.vela-system.svc.cluster.local/seldon/default/demo-serving/v1/models/my-model:predict" rel="noopener ugc nofollow" target="_blank">http://ambassador.vela-system.svc.cluster.local/seldon/default/demo-serving/v1/models/my-model:predict</a><br/>      ports:<br/>        # Test service port<br/>        - port: 3333<br/>          expose: true</span></pre><p id="c1b9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">部署后，使用<code class="fe lz ma mb mc b">vela ls</code>检查应用程序的状态:</p><pre class="ln lo lp lq gt md mc me mf aw mg bi"><span id="5ab8" class="mh kk in mc b gy mi mj l mk ml">$ vela ls</span><span id="7f25" class="mh kk in mc b gy mm mj l mk ml">training-serving      	demo-training      	model-training	       	running	healthy	Job Succeeded	2022-03-02 17:26:40 +0800 CST<br/>├─                  	demo-serving       	model-serving 	       	running	healthy	Available    	2022-03-02 17:26:40 +0800 CST<br/>└─                  	demo-rest-serving  	webservice    	       	running	healthy	Ready:1/1    	2022-03-02 17:26:40 +0800 CST</span></pre><p id="6a57" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如您所见，应用程序已经正常启动。使用<code class="fe lz ma mb mc b">vela status &lt;app-name&gt; --endpoint</code>查看应用程序的服务地址。</p><pre class="ln lo lp lq gt md mc me mf aw mg bi"><span id="263b" class="mh kk in mc b gy mi mj l mk ml">$ vela status training-serving --endpoint</span><span id="9cf6" class="mh kk in mc b gy mm mj l mk ml">+---------+-----------------------------------+---------------------------------------------------+<br/>| CLUSTER |     REF(KIND/NAMESPACE/NAME)      |                     ENDPOINT                      |<br/>+---------+-----------------------------------+---------------------------------------------------+<br/>|         | Service/default/demo-rest-serving | tcp://47.251.10.177:3333                          |<br/>|         | Service/vela-system/ambassador    | <a class="ae ly" href="http://47.251.36.228/seldon/default/demo-serving" rel="noopener ugc nofollow" target="_blank">http://47.251.36.228/seldon/default/demo-serving</a>  |<br/>|         | Service/vela-system/ambassador    | <a class="ae ly" href="https://47.251.36.228/seldon/default/demo-serving" rel="noopener ugc nofollow" target="_blank">https://47.251.36.228/seldon/default/demo-serving</a> |<br/>+---------+-----------------------------------+---------------------------------------------------+</span></pre><p id="b71c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">应用程序有三个服务地址，第一个是我们测试服务的地址，第二个和第三个是本地模型的地址。</p><p id="1eb3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们可以调用测试服务来看看模型的效果:测试服务会读取图片的内容，转换成一个<code class="fe lz ma mb mc b">Tensor</code>并请求模型服务，最后将模型服务返回的<code class="fe lz ma mb mc b">Tensor</code>转换成图片返回。</p><p id="72a0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们选择一张黑白女性图像作为输入:</p><figure class="ln lo lp lq gt lr gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/0d65e8c51ffde33bf4cc9bff5c7b9de6.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/0*uTg0vTnyhck7m2rZ.png"/></div></figure><p id="ee5b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">请求之后，您可以看到输出了一幅彩色图像:</p><figure class="ln lo lp lq gt lr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi mo"><img src="../Images/1b41322da5e87954f5535461e14ae0d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*r6yHnpORBHXQ83fj.png"/></div></div></figure><h1 id="108f" class="kj kk in bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">模型服务:金丝雀测试</h1><p id="4b1f" class="pw-post-body-paragraph jk jl in jm b jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc kd ll kf kg kh ig bi translated">除了直接启动模型服务，我们还可以在一个模型服务中使用模型的多个版本，并为它们分配不同的流量进行金丝雀测试。</p><p id="8862" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">部署以下 YAML，您可以看到模型的 v1 版本和模型的 v2 版本都设置为 50%流量。同样，我们在模型服务的背后部署了一个测试服务:</p><pre class="ln lo lp lq gt md mc me mf aw mg bi"><span id="f673" class="mh kk in mc b gy mi mj l mk ml">apiVersion: core.oam.dev/v1beta1<br/>kind: Application<br/>metadata:<br/>  name: color-serving<br/>  namespace: default<br/>spec:<br/>  components:<br/>  - name: color-model-serving<br/>    type: model-serving<br/>    properties:<br/>      protocol: tensorflow<br/>      predictors:<br/>        - name: model1<br/>          replicas: 1<br/>          # v1 version model traffic is 50<br/>          traffic: 50<br/>          graph:<br/>            name: my-model<br/>            implementation: tensorflow<br/>            # Model address, our v1 version model is stored under the /model/v1 path in the pvc of color-model, so specify the address of the model through pvc://color-model/model/v1<br/>            modelUri: pvc://color-model/model/v1<br/>        - name: model2<br/>          replicas: 1<br/>          # v2 version model traffic is 50<br/>          traffic: 50<br/>          graph:<br/>            name: my-model<br/>            implementation: tensorflow<br/>            # Model address, our v2 version model is stored under the /model/v2 path in the pvc of color-model, so specify the address of the model through pvc://color-model/model/v2<br/>            modelUri: pvc://color-model/model/v2<br/>  - name: color-rest-serving<br/>    type: webservice<br/>    dependsOn:<br/>      - color-model-serving<br/>    properties:<br/>      image: fogdong/color-serving:v1<br/>      exposeType: LoadBalancer<br/>      env:<br/>        - name: URL<br/>          value: <a class="ae ly" href="http://ambassador.vela-system.svc.cluster.local/seldon/default/color-model-serving/v1/models/my-model:predict" rel="noopener ugc nofollow" target="_blank">http://ambassador.vela-system.svc.cluster.local/seldon/default/color-model-serving/v1/models/my-model:predict</a><br/>      ports:<br/>        - port: 3333<br/>          expose: true</span></pre><p id="50b3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">模型部署完成后，使用<code class="fe lz ma mb mc b">vela status &lt;app-name&gt; --endpoint</code>查看模型服务的地址:</p><pre class="ln lo lp lq gt md mc me mf aw mg bi"><span id="65d3" class="mh kk in mc b gy mi mj l mk ml">$ vela status color-serving --endpoint</span><span id="47c0" class="mh kk in mc b gy mm mj l mk ml">+---------+------------------------------------+----------------------------------------------------------+<br/>| CLUSTER |      REF(KIND/NAMESPACE/NAME)      |                         ENDPOINT                         |<br/>+---------+------------------------------------+----------------------------------------------------------+<br/>|         | Service/vela-system/ambassador     | <a class="ae ly" href="http://47.251.36.228/seldon/default/color-model-serving" rel="noopener ugc nofollow" target="_blank">http://47.251.36.228/seldon/default/color-model-serving</a>  |<br/>|         | Service/vela-system/ambassador     | <a class="ae ly" href="https://47.251.36.228/seldon/default/color-model-serving" rel="noopener ugc nofollow" target="_blank">https://47.251.36.228/seldon/default/color-model-serving</a> |<br/>|         | Service/default/color-rest-serving | tcp://47.89.194.94:3333                                  |<br/>+---------+------------------------------------+----------------------------------------------------------+</span></pre><p id="d22c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">要求模特展示黑白城市形象:</p><figure class="ln lo lp lq gt lr gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/b3348da01c24435bde1fc3bdbaeb7672.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/0*5quKM8bFoCeDQY76.png"/></div></figure><p id="930b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如您所见，第一个请求的结果如下。天空和地面是彩色的，而城市本身是黑白的:</p><figure class="ln lo lp lq gt lr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi mp"><img src="../Images/281e80924daaccf5a37d87a30d38425a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*TEuwEg71eFYnv8v7.png"/></div></div></figure><p id="72cc" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">再次请求，您可以看到在这个请求的结果中，天空、地面和城市都用颜色进行了渲染:</p><figure class="ln lo lp lq gt lr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi mq"><img src="../Images/08155cb517c44093d14d3fbc54b7ccc6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ZBft6zM5zEEqh_Uj.png"/></div></div></figure><p id="c91b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">通过给模型的不同版本分配流量，可以帮助我们更好的判断模型结果。</p><h1 id="9e00" class="kj kk in bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">模型服务:A/B 测试</h1><p id="1e16" class="pw-post-body-paragraph jk jl in jm b jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc kd ll kf kg kh ig bi translated">对于一个黑白图像，我们可以通过模型把它变成彩色。或者换一种方式，我们可以通过上传另一个风格的图片来传递原图片的风格。</p><p id="96ae" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们的用户是更爱色彩鲜艳的图片还是更爱不同风格的图片？我们可以通过进行 A/B 测试来探讨这个问题。</p><p id="23f9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">部署下面的 YAML，通过设置<code class="fe lz ma mb mc b">customRouting</code>，将<code class="fe lz ma mb mc b">Header</code>中带有<code class="fe lz ma mb mc b">style: transfer</code>的请求转发给样式转移的模型。同时，使这个样式传递模型与彩色化的模型共享相同的地址。</p><p id="65b5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">注:风格传递的模型来自<a class="ae ly" href="https://tfhub.dev/google/magenta/arbitrary-image-stylization-v1-256/2" rel="noopener ugc nofollow" target="_blank"> TensorFlow Hub </a></p><pre class="ln lo lp lq gt md mc me mf aw mg bi"><span id="e1c4" class="mh kk in mc b gy mi mj l mk ml">apiVersion: core.oam.dev/v1beta1<br/>kind: Application<br/>metadata:<br/>  name: color-style-ab-serving<br/>  namespace: default<br/>spec:<br/>  components:<br/>  - name: color-ab-serving<br/>    type: model-serving<br/>    properties:<br/>      protocol: tensorflow<br/>      predictors:<br/>        - name: model1<br/>          replicas: 1<br/>          graph:<br/>            name: my-model<br/>            implementation: tensorflow<br/>            modelUri: pvc://color-model/model/v2<br/>  - name: style-ab-serving<br/>    type: model-serving<br/>    properties:<br/>      protocol: tensorflow<br/>      # The model of style migration takes a long time, set the timeout time so that the request will not be timed out<br/>      timeout: "10000"<br/>      customRouting:<br/>        # Specify custom Header<br/>        header: "style: transfer"<br/>        # Specify custom routes<br/>        serviceName: "color-ab-serving"<br/>      predictors:<br/>        - name: model2<br/>          replicas: 1<br/>          graph:<br/>            name: my-model<br/>            implementation: tensorflow<br/>            modelUri: pvc://style-model/model<br/>  - name: ab-rest-serving<br/>    type: webservice<br/>    dependsOn:<br/>      - color-ab-serving<br/>      - style-ab-serving<br/>    properties:<br/>      image: fogdong/style-serving:v1<br/>      exposeType: LoadBalancer<br/>      env:<br/>        - name: URL<br/>          value: <a class="ae ly" href="http://ambassador.vela-system.svc.cluster.local/seldon/default/color-ab-serving/v1/models/my-model:predict" rel="noopener ugc nofollow" target="_blank">http://ambassador.vela-system.svc.cluster.local/seldon/default/color-ab-serving/v1/models/my-model:predict</a><br/>      ports:<br/>        - port: 3333<br/>          expose: true</span></pre><p id="37de" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">部署成功后，通过<code class="fe lz ma mb mc b">vela status &lt;app-name&gt; --endpoint</code>查看模型服务的地址:</p><pre class="ln lo lp lq gt md mc me mf aw mg bi"><span id="fb54" class="mh kk in mc b gy mi mj l mk ml">$ vela status color-style-ab-serving --endpoint</span><span id="9283" class="mh kk in mc b gy mm mj l mk ml">+---------+---------------------------------+-------------------------------------------------------+<br/>| CLUSTER |    REF(KIND/NAMESPACE/NAME)     |                       ENDPOINT                        |<br/>+---------+---------------------------------+-------------------------------------------------------+<br/>|         | Service/vela-system/ambassador  | <a class="ae ly" href="http://47.251.36.228/seldon/default/color-ab-serving" rel="noopener ugc nofollow" target="_blank">http://47.251.36.228/seldon/default/color-ab-serving</a>  |<br/>|         | Service/vela-system/ambassador  | <a class="ae ly" href="https://47.251.36.228/seldon/default/color-ab-serving" rel="noopener ugc nofollow" target="_blank">https://47.251.36.228/seldon/default/color-ab-serving</a> |<br/>|         | Service/vela-system/ambassador  | <a class="ae ly" href="http://47.251.36.228/seldon/default/style-ab-serving" rel="noopener ugc nofollow" target="_blank">http://47.251.36.228/seldon/default/style-ab-serving</a>  |<br/>|         | Service/vela-system/ambassador  | <a class="ae ly" href="https://47.251.36.228/seldon/default/style-ab-serving" rel="noopener ugc nofollow" target="_blank">https://47.251.36.228/seldon/default/style-ab-serving</a> |<br/>|         | Service/default/ab-rest-serving | tcp://47.251.5.97:3333                                |<br/>+---------+---------------------------------+-------------------------------------------------------+</span></pre><p id="f7e4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在这个应用中，两个服务各有两个地址，但是第二个<code class="fe lz ma mb mc b">style-ab-serving</code>的模型服务地址无效，因为模型服务已经指向了<code class="fe lz ma mb mc b">color-ab-serving</code>的地址。同样，我们通过请求测试服务来了解它是如何工作的。</p><p id="4755" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">首先，没有页眉，图像从黑白变为彩色:</p><figure class="ln lo lp lq gt lr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi mp"><img src="../Images/e312e90f32bd2889cdf06cf899d79cf3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*fi6Znz5mjLkGxSbW.png"/></div></div></figure><p id="bee1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让我们添加一个海浪图像作为样式渲染:</p><figure class="ln lo lp lq gt lr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi mr"><img src="../Images/0254387752975a7d2fcb7ff1091733e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*GmBQRHgXAwnyU3mn.png"/></div></div></figure><p id="ece6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们将<code class="fe lz ma mb mc b">style: transfer</code>的头添加到这个请求中，您可以看到这个城市已经变成了一种波浪风格:</p><figure class="ln lo lp lq gt lr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi ms"><img src="../Images/161a61a7a5af5e0d5332d5a42c7ef7e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*fPkE6pRxoe5zzNNS.png"/></div></div></figure><p id="f0cf" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们还可以使用水墨画图像作为风格渲染:</p><figure class="ln lo lp lq gt lr gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/8e4180c29d2599cea977816ce91144bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/0*HenopASmsZUzMDr1.png"/></div></figure><p id="f461" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">可以看出，这个时候的城市已经变成了一种水墨画风格:</p><figure class="ln lo lp lq gt lr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi mu"><img src="../Images/0821c40f530eb43b5ad492a8589248ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*mxsJyPly67iJeanY.png"/></div></div></figure><h1 id="ca98" class="kj kk in bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">摘要</h1><p id="222e" class="pw-post-body-paragraph jk jl in jm b jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc kd ll kf kg kh ig bi translated">此外，与 KubeVela 一起，我们还可以通过 KubeVela 的多环境功能，将测试过的模型交付到不同的环境中，从而实现模型的灵活部署。</p></div></div>    
</body>
</html>