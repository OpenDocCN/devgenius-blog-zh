<html>
<head>
<title>Gzip compression with Node.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Node.js压缩Gzip</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/gzip-compression-with-node-js-cc3ed74196f9?source=collection_archive---------0-----------------------#2020-06-26">https://blog.devgenius.io/gzip-compression-with-node-js-cc3ed74196f9?source=collection_archive---------0-----------------------#2020-06-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/2504acbe5fec3ae2cd42cf8adb6545ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mSID8QuKF-c3qOsDO_nbnw.png"/></div></div></figure><p id="c996" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> Node.js </strong>和<strong class="ka ir"> Express.js </strong>中的<strong class="ka ir">压缩</strong>减少了网站或app的可下载数据量。通过使用这种压缩，我们可以<strong class="ka ir">提高Node.js应用程序的性能</strong>，因为我们的<strong class="ka ir">有效负载大小显著减少了70% </strong>。</p><h1 id="8d2f" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">介绍</h1><p id="16d3" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated"><strong class="ka ir">压缩</strong>一般指使用数据压缩算法修改过的代码。不像<strong class="ka ir">缩小</strong>最终提供完全有效的代码，压缩代码必须在使用前解压缩。</p><p id="22fa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于每个<strong class="ka ir"> HTTP请求/响应</strong>，浏览器和web服务器可以添加头部，以包含关于被搜索或接收的资产的附加信息。当浏览器在<strong class="ka ir">请求头</strong>中发送时，<strong class="ka ir">接受编码</strong>选项指定它支持哪些内容编码格式或压缩算法。</p><p id="501f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">文本压缩算法有很多，但是对于<strong class="ka ir"> HTTP请求:</strong>的压缩(和<strong class="ka ir">解压缩</strong>)只有<strong class="ka ir"> 3支持</strong> <strong class="ka ir">算法</strong></p><ul class=""><li id="42b3" class="lz ma iq ka b kb kc kf kg kj mb kn mc kr md kv me mf mg mh bi translated"><strong class="ka ir">放气</strong> ( <strong class="ka ir">放气</strong>):不常用。</li><li id="4adb" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv me mf mg mh bi translated"><strong class="ka ir"> Gzip </strong> ( <strong class="ka ir"> gzip </strong>):服务器和客户端交互使用最广泛的压缩格式。它基于<strong class="ka ir"> Deflate </strong>算法，兼容当前所有浏览器。</li><li id="94fb" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv me mf mg mh bi translated"><strong class="ka ir"> Brotli </strong> ( <strong class="ka ir"> br </strong>):一种更新的压缩算法，旨在进一步提高压缩率，这可以导致更快的页面加载。它兼容大多数浏览器的最新版本。</li></ul><p id="7bb3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">另外，重要的是说还有<strong class="ka ir"> 2种压缩方式</strong>:</p><ul class=""><li id="abd9" class="lz ma iq ka b kb kc kf kg kj mb kn mc kr md kv me mf mg mh bi translated"><strong class="ka ir">中间件</strong>:在这个方法中，我们直接在我们的<strong class="ka ir"> Node.js </strong>应用程序中调用它，使用压缩<strong class="ka ir">中间件</strong>调用<strong class="ka ir">压缩</strong>。</li><li id="a6c8" class="lz ma iq ka b kb mi kf mj kj mk kn ml kr mm kv me mf mg mh bi translated"><strong class="ka ir">代理</strong>:该方法通过<strong class="ka ir"> NGINX </strong>或<strong class="ka ir"> Apache </strong>在反向代理级别使用。</li></ul><p id="a6e3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在本教程中，我们将关注第一个，通过<strong class="ka ir">中间件</strong>在我们的<strong class="ka ir"> Node.js </strong>应用程序中直接调用它。</p><h1 id="9325" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">要求</h1><p id="8082" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">我们只需要之前安装的<strong class="ka ir"> Node.js </strong>，以及<strong class="ka ir"> npm </strong>包管理器来下载<strong class="ka ir">压缩</strong>包:</p><p id="0a2f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">节点</strong> &gt; = <strong class="ka ir"> 8.0 </strong>以上</p><pre class="mn mo mp mq gt mr ms mt mu aw mv bi"><span id="7ea1" class="mw kx iq ms b gy mx my l mz na">$ node --version</span></pre><p id="8fb7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> npm </strong> &gt; = <strong class="ka ir"> 5.0 </strong>以上</p><pre class="mn mo mp mq gt mr ms mt mu aw mv bi"><span id="5b7a" class="mw kx iq ms b gy mx my l mz na">$ npm --version</span></pre><h1 id="88b4" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">未压缩的示例</h1><p id="5d0f" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">首先，我们运行命令<strong class="ka ir"> npm init </strong>:</p><pre class="mn mo mp mq gt mr ms mt mu aw mv bi"><span id="6e31" class="mw kx iq ms b gy mx my l mz na">$ npm init</span></pre><p id="1da9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用<strong class="ka ir"> npm init </strong>命令，我们将生成名为<strong class="ka ir"> package.json </strong>的基本配置文件，从我们的教程开始，我们必须在终端中输入一些数据，另一种方法是创建<strong class="ka ir"> package.json </strong>文件，如下所示:</p><pre class="mn mo mp mq gt mr ms mt mu aw mv bi"><span id="9ade" class="mw kx iq ms b gy mx my l mz na">// package.json<br/>{<br/>  "name": "nodejs-compression",<br/>  "version": "0.0.1",<br/>  "description": "Gzip compression with Node.js",<br/>  "main": "server.js",<br/>  "scripts": {<br/>    "test": "echo \"Error: no test specified\" &amp;&amp; exit 1"<br/>  },<br/>  "author": "Víctor Valencia Rico",<br/>  "license": "ISC"<br/>}</span></pre><p id="87fc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，我们需要用<strong class="ka ir"> express </strong>包安装<strong class="ka ir"> Express.js </strong>:</p><pre class="mn mo mp mq gt mr ms mt mu aw mv bi"><span id="e7f6" class="mw kx iq ms b gy mx my l mz na">$ npm i express --save</span></pre><p id="7953" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来，我们将创建我们的<strong class="ka ir"> server.js </strong>文件，该文件将包含以下代码:</p><pre class="mn mo mp mq gt mr ms mt mu aw mv bi"><span id="501e" class="mw kx iq ms b gy mx my l mz na">// server.js<br/>const express = require('express');<br/>const app = express();</span><span id="ca6e" class="mw kx iq ms b gy nb my l mz na">app.get('/', (req, res) =&gt; {<br/>  const animal = 'elephant';<br/>  // It will repeatedly send the word 'elephant' in a <br/>  // 'text/html' format file<br/>  res.send(animal.repeat(1000));<br/>});</span><span id="acf3" class="mw kx iq ms b gy nb my l mz na">app.listen(3000, function () {<br/>  console.log('Example app listening on port 3000!');<br/>});</span></pre><p id="b90e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们运行我们的应用程序:</p><pre class="mn mo mp mq gt mr ms mt mu aw mv bi"><span id="c98c" class="mw kx iq ms b gy mx my l mz na">$ node server.js</span></pre><p id="8dd3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们在浏览器中打开<a class="ae nc" href="http://localhost:3000" rel="noopener ugc nofollow" target="_blank"> http://localhost:3000 </a>来查看我们的应用程序的结果。</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/34448218f83a5d1c042e3bb5cba248af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1352/format:webp/1*xJxj2lctNnE20mCqjMqicg.png"/></div></figure><p id="ebd9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在上面的例子中，我们调用了一个<strong class="ka ir"> GET </strong>操作，该操作将发送一个<strong class="ka ir"> text/html </strong>格式文件，其中的<strong class="ka ir"> word elephant打印了1000次</strong>。<strong class="ka ir">不压缩</strong>，服务器返回的响应大约为<strong class="ka ir"> 8 kB </strong>，如下图所示:</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/7e837a35bfa35ca0cb7ee8a2a503bdec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Hz1hCOX9yjRdV91oRo0txw.png"/></div></figure><h1 id="95e6" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">Gzip压缩示例</h1><p id="a904" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">要在您的<strong class="ka ir"> Node.js </strong>应用程序中开始使用<strong class="ka ir">压缩</strong>，您可以在您的<strong class="ka ir"> Node.js </strong>应用程序的主文件中使用压缩<strong class="ka ir">中间件</strong>。这将<strong class="ka ir">启用GZIP </strong>，它支持不同的压缩方案。这将<strong class="ka ir">使你的HTTP响应变小</strong>。</p><p id="c5ae" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们安装<strong class="ka ir">压缩</strong>包:</p><pre class="mn mo mp mq gt mr ms mt mu aw mv bi"><span id="562a" class="mw kx iq ms b gy mx my l mz na">$ npm i compression --save</span></pre><p id="9c27" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，在初始化应用程序的服务器后，我们可以在应用程序中使用该模块，如下例所示，我们修改了代码:</p><pre class="mn mo mp mq gt mr ms mt mu aw mv bi"><span id="fdb4" class="mw kx iq ms b gy mx my l mz na">// server.js<br/>const compression = require('compression');<br/>const express = require('express');<br/>const app = express();</span><span id="1622" class="mw kx iq ms b gy nb my l mz na">// Compress all HTTP responses<br/>app.use(compression());</span><span id="7da8" class="mw kx iq ms b gy nb my l mz na">app.get('/', (req, res) =&gt; {<br/>  const animal = 'elephant';<br/>  // It will repeatedly send the word 'elephant' in a <br/>  // 'text/html' format file<br/>  res.send(animal.repeat(1000));<br/>});</span><span id="ad2f" class="mw kx iq ms b gy nb my l mz na">app.listen(3000, function () {<br/>  console.log('Example app listening on port 3000!');<br/>});</span></pre><p id="6777" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们运行我们的应用程序:</p><pre class="mn mo mp mq gt mr ms mt mu aw mv bi"><span id="91df" class="mw kx iq ms b gy mx my l mz na">$ node server.js</span></pre><p id="2cac" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们在浏览器中打开<a class="ae nc" href="http://localhost:3000" rel="noopener ugc nofollow" target="_blank"> http://localhost:3000 </a>来查看我们的应用程序的结果。</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/34448218f83a5d1c042e3bb5cba248af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1352/format:webp/1*xJxj2lctNnE20mCqjMqicg.png"/></div></figure><p id="f730" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，如果打开了压缩，那么发送的响应带有一个<strong class="ka ir"> Content-Encoding: gzip </strong>头，仅重<strong class="ka ir"> 336 B </strong>。表示与没有压缩的示例相比，最终响应中的<strong class="ka ir"> 96% </strong> <strong class="ka ir">节省。</strong></p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/da14076ad4f9a719d63ece60c0a0beab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jiJKrIdzTZrN550e27MfKQ.png"/></div></figure><h1 id="3d4f" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">附加配置</h1><p id="c208" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">除了<strong class="ka ir">默认设置</strong>之外，您还可以定制您的压缩以满足您的需求。在options对象中可以使用几种不同的属性。要获得可供选择的完整属性列表，请参见文档<a class="ae nc" href="https://www.npmjs.com/package/compression" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><p id="6c45" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了给压缩添加选项，我们将代码修改如下:</p><pre class="mn mo mp mq gt mr ms mt mu aw mv bi"><span id="cdd8" class="mw kx iq ms b gy mx my l mz na">// server.js<br/>const compression = require('compression');<br/>const express = require('express');</span><span id="2f91" class="mw kx iq ms b gy nb my l mz na">const app = express();const shouldCompress = (req, res) =&gt; {<br/>  if (req.headers['x-no-compression']) {<br/>    // Will not compress responses, if this header is present<br/>    return false;<br/>  }<br/>  // Resort to standard compression<br/>  return compression.filter(req, res);<br/>};</span><span id="a396" class="mw kx iq ms b gy nb my l mz na">// Compress all HTTP responses<br/>app.use(compression({<br/>  // filter: Decide if the answer should be compressed or not,<br/>  // depending on the 'shouldCompress' function above<br/>  filter: shouldCompress,<br/>  // threshold: It is the byte threshold for the response <br/>  // body size before considering compression, the default is 1 kB<br/>  threshold: 0<br/>}));</span><span id="7241" class="mw kx iq ms b gy nb my l mz na">app.get('/', (req, res) =&gt; {<br/>  const animal = 'elephant';<br/>  // It will repeatedly send the word 'elephant' in a <br/>  // 'text/html' format file<br/>  res.send(animal.repeat(1000));<br/>});</span><span id="1c83" class="mw kx iq ms b gy nb my l mz na">app.listen(3000, function () {<br/>  console.log('Example app listening on port 3000!');<br/>});</span></pre><h1 id="c270" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">结论</h1><p id="ab0a" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated"><strong class="ka ir">压缩</strong>我们的请求肯定会提高我们的<strong class="ka ir"> Node.js </strong>应用程序的性能，将用户负载和等待减少<strong class="ka ir">超过70% </strong>。</p></div><div class="ab cl nf ng hu nh" role="separator"><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk"/></div><div class="ij ik il im in"><p id="48ed" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="nm">西班牙文原文发表于https://www.victorvr.com</em><a class="ae nc" href="https://www.victorvr.com/tutorial/compresion-gzip-con-nodejs" rel="noopener ugc nofollow" target="_blank"><em class="nm"/></a><em class="nm">。<br/>关注我:</em><a class="ae nc" href="https://medium.com/@victor.valencia.rico" rel="noopener"><em class="nm">https://medium.com/@victor.valencia.rico</em></a></p></div></div>    
</body>
</html>