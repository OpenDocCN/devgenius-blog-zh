<html>
<head>
<title>Mastering Kubernetes: How to validate Kubernetes YAML Files Part 3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">掌握 Kubernetes:如何验证 Kubernetes YAML 文件第 3 部分</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/mastering-kubernetes-how-to-validate-kubernetes-yaml-files-part-3-964ec40100a?source=collection_archive---------5-----------------------#2022-11-12">https://blog.devgenius.io/mastering-kubernetes-how-to-validate-kubernetes-yaml-files-part-3-964ec40100a?source=collection_archive---------5-----------------------#2022-11-12</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/49df3473fa77785c9a074be34cee3e9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*0PGKkOL-jwzkRUKh.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">库贝分数</figcaption></figure><h1 id="b569" class="jz ka in bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">介绍</h1><p id="f8d7" class="pw-post-body-paragraph kx ky in kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu ig bi translated">在使用我们的工具 Kubectl 发送我们的工作负载 YAML 文件之前，我们需要确保我们遵循了这些文件中的最佳设置和实践。</p><p id="6cfa" class="pw-post-body-paragraph kx ky in kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">我们需要一个工具来帮助我们检查和验证我们的 YAML 文件。</p><p id="6ff8" class="pw-post-body-paragraph kx ky in kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">今天我们将关注 kube-score，这是一个对 Kubernetes 对象定义执行静态代码分析的工具。正是我们需要的！</p><h1 id="9d28" class="jz ka in bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">Kube-Score 怎么用？</h1><p id="e358" class="pw-post-body-paragraph kx ky in kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu ig bi translated">像往常一样，我们有几个选项来安装工具</p><ul class=""><li id="4ad5" class="ma mb in kz b la lv le lw li mc lm md lq me lu mf mg mh mi bi translated">命令行工具</li><li id="7bbd" class="ma mb in kz b la mj le mk li ml lm mm lq mn lu mf mg mh mi bi translated">码头工人</li></ul><p id="1ba8" class="pw-post-body-paragraph kx ky in kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">我们将首先使用 Docker 选项，因为它非常简单:)</p><p id="be99" class="pw-post-body-paragraph kx ky in kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">我们可以在链接中找到 docker 图片</p><div class="mo mp gp gr mq mr"><a href="https://github.com/zegl/kube-score" rel="noopener  ugc nofollow" target="_blank"><div class="ms ab fo"><div class="mt ab mu cl cj mv"><h2 class="bd io gy z fp mw fr fs mx fu fw im bi translated">GitHub-zegl/kube-score:Kubernetes 对象分析，提供提高可靠性的建议…</h2><div class="my l"><h3 class="bd b gy z fp mw fr fs mx fu fw dk translated">kube-score 是一个对 Kubernetes 对象定义进行静态代码分析的工具。输出是一个列表…</h3></div><div class="mz l"><p class="bd b dl z fp mw fr fs mx fu fw dk translated">github.com</p></div></div><div class="na l"><div class="nb l nc nd ne na nf jt mr"/></div></div></a></div><div class="mo mp gp gr mq mr"><a href="https://hub.docker.com/r/zegl/kube-score/" rel="noopener  ugc nofollow" target="_blank"><div class="ms ab fo"><div class="mt ab mu cl cj mv"><h2 class="bd io gy z fp mw fr fs mx fu fw im bi translated">码头枢纽</h2><div class="my l"><h3 class="bd b gy z fp mw fr fs mx fu fw dk translated">编辑描述</h3></div><div class="mz l"><p class="bd b dl z fp mw fr fs mx fu fw dk translated">hub.docker.com</p></div></div></div></a></div><p id="52d7" class="pw-post-body-paragraph kx ky in kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">我们所需要的是拉码头形象与:</p><pre class="ng nh ni nj gt nk nl nm bn nn no bi"><span id="b39d" class="np ka in nl b be nq nr l ns nt">docker pull zegl/kube-score</span></pre><p id="abf6" class="pw-post-body-paragraph kx ky in kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">我们开始吧！</p><pre class="ng nh ni nj gt nk nl nm bn nn no bi"><span id="b053" class="np ka in nl b be nq nr l ns nt">λ docker pull zegl/kube-score<br/>Using default tag: latest<br/>latest: Pulling from zegl/kube-score<br/>1b9df04e6215: Pull complete<br/>3e6314b120ac: Pull complete<br/>Digest: sha256:df26b2d3978be960b41e8c09906a38f3e5ad7ef3c63b8770c693dc3405005299<br/>Status: Downloaded newer image for zegl/kube-score:latest<br/>docker.io/zegl/kube-score:latest</span></pre><p id="298c" class="pw-post-body-paragraph kx ky in kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">我们可以查看我们的本地回购:</p><pre class="ng nh ni nj gt nk nl nm bn nn no bi"><span id="c951" class="np ka in nl b be nq nr l ns nt">λ docker images                                                                              <br/>REPOSITORY                             TAG               IMAGE ID       CREATED        SIZE  <br/>zegl/kube-score                        latest            6afa21f585fe   8 months ago   18.8MB</span></pre><p id="af72" class="pw-post-body-paragraph kx ky in kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">我们可以看到它非常小。</p><p id="4c5d" class="pw-post-body-paragraph kx ky in kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">现在我们已经运行了 Minikube 集群，我们已经用 docker 安装了 YAML 文件验证器，我们如何创建我们的第一个工作负载 YAML 部署文件并验证它呢？</p><p id="b1de" class="pw-post-body-paragraph kx ky in kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">让我们看看！</p><h1 id="c67d" class="jz ka in bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">工作量 YAML 部署文件创建和验证</h1><p id="0955" class="pw-post-body-paragraph kx ky in kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu ig bi translated">为了方便地为 Kubernetes 创建一个简单的工作负载 YAML 部署文件，我们可以使用带有 create 命令的 Kubectl 工具。</p><pre class="ng nh ni nj gt nk nl nm bn nn no bi"><span id="592b" class="np ka in nl b be nq nr l ns nt"> kubectl create deployment mydeployment --image=myimage --dry-run=client -o yaml &gt; mydeployment.yaml </span></pre><p id="e4fc" class="pw-post-body-paragraph kx ky in kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">我们只是将部署 YAML 文件通过管道传输到一个名为 mydeployment.yaml 的文件中，其中有一个假的 docker 映像“myimage ”,这只是一个例子。</p><p id="a80c" class="pw-post-body-paragraph kx ky in kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">我们不会运行这个部署，我们只是用 kube-score 来验证它！</p><p id="d37d" class="pw-post-body-paragraph kx ky in kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">让我们看看 YAML 文件的内容:mydeployment.yaml</p><pre class="ng nh ni nj gt nk nl nm bn nn no bi"><span id="03fd" class="np ka in nl b be nq nr l ns nt">λ cat mydeployment.yaml<br/>apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  creationTimestamp: null<br/>  labels:<br/>    app: mydeployment<br/>  name: mydeployment<br/>spec:<br/>  replicas: 1<br/>  selector:<br/>    matchLabels:<br/>      app: mydeployment<br/>  strategy: {}<br/>  template:<br/>    metadata:<br/>      creationTimestamp: null<br/>      labels:<br/>        app: mydeployment<br/>    spec:<br/>      containers:<br/>      - image: myimage<br/>        name: myimage<br/>        resources: {}<br/>status: {}</span></pre><p id="470e" class="pw-post-body-paragraph kx ky in kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">我们可以看到虚拟 docker 图像:myimage，其余的都是标准的。</p><p id="a0ab" class="pw-post-body-paragraph kx ky in kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">让我们使用 docker 和 kube-score 来验证我们的 YAML 文件:</p><pre class="ng nh ni nj gt nk nl nm bn nn no bi"><span id="154a" class="np ka in nl b be nq nr l ns nt">λ docker run -v %cd%:/project zegl/kube-score:latest score mydeployment.yaml<br/>apps/v1/Deployment mydeployment                                               �<br/>    [CRITICAL] Container Resources<br/>        · myimage -&gt; CPU limit is not set<br/>            Resource limits are recommended to avoid resource DDOS. Set<br/>            resources.limits.cpu<br/>        · myimage -&gt; Memory limit is not set<br/>            Resource limits are recommended to avoid resource DDOS. Set<br/>            resources.limits.memory<br/>        · myimage -&gt; CPU request is not set<br/>            Resource requests are recommended to make sure that the application<br/>            can start and run without crashing. Set resources.requests.cpu<br/>        · myimage -&gt; Memory request is not set<br/>            Resource requests are recommended to make sure that the application<br/>            can start and run without crashing. Set resources.requests.memory<br/>    [CRITICAL] Container Image Tag<br/>        · myimage -&gt; Image with latest tag<br/>            Using a fixed tag is recommended to avoid accidental upgrades<br/>    [CRITICAL] Container Security Context ReadOnlyRootFilesystem<br/>        · myimage -&gt; Container has no configured security context<br/>            Set securityContext to run the container in a more secure context.<br/>    [CRITICAL] Container Ephemeral Storage Request and Limit<br/>        · myimage -&gt; Ephemeral Storage limit is not set<br/>            Resource limits are recommended to avoid resource DDOS. Set<br/>            resources.limits.ephemeral-storage<br/>    [CRITICAL] Pod NetworkPolicy<br/>        · The pod does not have a matching NetworkPolicy<br/>            Create a NetworkPolicy that targets this pod to control who/what<br/>            can communicate with this pod. Note, this feature needs to be<br/>            supported by the CNI implementation used in the Kubernetes cluster<br/>            to have an effect.<br/>    [CRITICAL] Container Security Context User Group ID<br/>        · myimage -&gt; Container has no configured security context<br/>            Set securityContext to run the container in a more secure context.</span></pre><p id="52bc" class="pw-post-body-paragraph kx ky in kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">让我们解释一下这个命令:</p><pre class="ng nh ni nj gt nk nl nm bn nn no bi"><span id="68a0" class="np ka in nl b be nq nr l ns nt">docker run -v %cd%:/project zegl/kube-score:latest score mydeployment.yaml</span></pre><p id="da6c" class="pw-post-body-paragraph kx ky in kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">我们在直接链接中找到了 docker 命令:<a class="ae nu" href="https://github.com/zegl/kube-score#example-with-docker" rel="noopener ugc nofollow" target="_blank">https://github.com/zegl/kube-score#example-with-docker</a></p><div class="mo mp gp gr mq mr"><a href="https://github.com/zegl/kube-score#example-with-docker" rel="noopener  ugc nofollow" target="_blank"><div class="ms ab fo"><div class="mt ab mu cl cj mv"><h2 class="bd io gy z fp mw fr fs mx fu fw im bi translated">GitHub-zegl/kube-score:Kubernetes 对象分析，提供提高可靠性的建议…</h2><div class="my l"><h3 class="bd b gy z fp mw fr fs mx fu fw dk translated">kube-score 是一个对 Kubernetes 对象定义进行静态代码分析的工具。输出是一个列表…</h3></div><div class="mz l"><p class="bd b dl z fp mw fr fs mx fu fw dk translated">github.com</p></div></div><div class="na l"><div class="nv l nc nd ne na nf jt mr"/></div></div></a></div><p id="8439" class="pw-post-body-paragraph kx ky in kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">据说是这样运行的，例如:</p><pre class="ng nh ni nj gt nk nl nm bn nn no bi"><span id="cafa" class="np ka in nl b be nq nr l ns nt">docker run -v $(pwd):/project zegl/kube-score:latest score my-app/*.yaml</span></pre><p id="1dfd" class="pw-post-body-paragraph kx ky in kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">Well $(pwd)确实能在 Linux/Mac 或 Powershell 上工作，如果你使用 Windows ms-dos 我们必须使用<strong class="kz io"> %cd% </strong>来代替。</p><p id="1e8f" class="pw-post-body-paragraph kx ky in kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">我们可以看到，我们需要一个卷来绑定到容器内的工作区<strong class="kz io">/项目</strong>，所以我们保留这个目录，以便 kube-score 可以找到我们的 YAML 文件。</p><p id="37f9" class="pw-post-body-paragraph kx ky in kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">我们可以用 docker 图像层检查这一点，我们可以看到<strong class="kz io">工作目录确实是:/project。</strong></p><figure class="ng nh ni nj gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nw"><img src="../Images/4c4f10f9764493585dc5ddd09cbeb4d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G9l7jrpa2bnoi2HJ7OtYuw.png"/></div></div></figure><p id="f47d" class="pw-post-body-paragraph kx ky in kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">我认为文档应该更好地强调这一点。我徒劳地尝试使用-v % CD %/usr/tmp，它说:</p><pre class="ng nh ni nj gt nk nl nm bn nn no bi"><span id="8ccd" class="np ka in nl b be nq nr l ns nt">Failed to score files: open mydeployment.yaml: no such file or directory</span></pre><p id="17b0" class="pw-post-body-paragraph kx ky in kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">记得去 docker hub 里看看，之前查过 docker 图片图层，很有用！</p><p id="dd3c" class="pw-post-body-paragraph kx ky in kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">然后我们通过参数<strong class="kz io"> score </strong>告诉 kube-score 给我们的 YAML 文件打分。</p><p id="6488" class="pw-post-body-paragraph kx ky in kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">我们可以看到我们的 YAML 文件是无效的，有许多关键点需要解决。</p><ul class=""><li id="be0e" class="ma mb in kz b la lv le lw li mc lm md lq me lu mf mg mh mi bi translated">我们应该首先对 CPU、内存提出请求/限制。</li><li id="92ff" class="ma mb in kz b la mj le mk li ml lm mm lq mn lu mf mg mh mi bi translated">然后，我们需要给 docker 图像添加一个标签，并避免使用“最新的”默认标签。</li><li id="ae04" class="ma mb in kz b la mj le mk li ml lm mm lq mn lu mf mg mh mi bi translated">必须设置容器安全上下文</li></ul><p id="7e9d" class="pw-post-body-paragraph kx ky in kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">我们应该阅读 Kube-Score 的文档以获得更多信息。</p><p id="52d9" class="pw-post-body-paragraph kx ky in kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">下面我们可以找到检查列表</p><div class="mo mp gp gr mq mr"><a href="https://github.com/zegl/kube-score/blob/master/README_CHECKS.md" rel="noopener  ugc nofollow" target="_blank"><div class="ms ab fo"><div class="mt ab mu cl cj mv"><h2 class="bd io gy z fp mw fr fs mx fu fw im bi translated">kube-score/README _ checks . MD at master zegl/kube-score</h2><div class="my l"><h3 class="bd b gy z fp mw fr fs mx fu fw dk translated">Kubernetes 对象分析及提高可靠性和安全性的建议- kube-score/README_CHECKS.md 位于…</h3></div><div class="mz l"><p class="bd b dl z fp mw fr fs mx fu fw dk translated">github.com</p></div></div><div class="na l"><div class="nx l nc nd ne na nf jt mr"/></div></div></a></div><p id="d2af" class="pw-post-body-paragraph kx ky in kz b la lv lc ld le lw lg lh li lx lk ll lm ly lo lp lq lz ls lt lu ig bi translated">或者我们可以运行:</p><pre class="ng nh ni nj gt nk nl nm bn nn no bi"><span id="4422" class="np ka in nl b be nq nr l ns nt">λ docker run zegl/kube-score:latest list<br/>ingress-targets-service,Ingress,Makes sure that the Ingress targets a Service,default<br/>cronjob-has-deadline,CronJob,Makes sure that all CronJobs has a configured deadline,default<br/>container-resources,Pod,Makes sure that all pods have resource limits and requests set. The --ignore-container-cpu-limit flag can be used to disable the requirement of having a CPU limit,default<br/>container-resource-requests-equal-limits,Pod,Makes sure that all pods have the same requests as limits on resources set.,optional<br/>container-cpu-requests-equal-limits,Pod,Makes sure that all pods have the same CPU requests as limits set.,optional<br/>container-memory-requests-equal-limits,Pod,Makes sure that all pods have the same memory requests as limits set.,optional<br/>container-image-tag,Pod,Makes sure that a explicit non-latest tag is used,default<br/>container-image-pull-policy,Pod,Makes sure that the pullPolicy is set to Always. This makes sure that imagePullSecrets are always validated.,default<br/>container-ephemeral-storage-request-and-limit,Pod,Makes sure all pods have ephemeral-storage requests and limits set,default<br/>container-ephemeral-storage-request-equals-limit,Pod,Make sure all pods have matching ephemeral-storage requests and limits,optional<br/>container-ports-check,Pod,Container Ports Checks,optional<br/>statefulset-has-poddisruptionbudget,StatefulSet,Makes sure that all StatefulSets are targeted by a PDB,default<br/>deployment-has-poddisruptionbudget,Deployment,Makes sure that all Deployments are targeted by a PDB,default<br/>poddisruptionbudget-has-policy,PodDisruptionBudget,Makes sure that PodDisruptionBudgets specify minAvailable or maxUnavailable,default<br/>pod-networkpolicy,Pod,Makes sure that all Pods are targeted by a NetworkPolicy,default<br/>networkpolicy-targets-pod,NetworkPolicy,Makes sure that all NetworkPolicies targets at least one Pod,default<br/>pod-probes,Pod,Makes sure that all Pods have safe probe configurations,default<br/>container-security-context-user-group-id,Pod,Makes sure that all pods have a security context with valid UID and GID set ,default<br/>container-security-context-privileged,Pod,Makes sure that all pods have a unprivileged security context set,default<br/>container-security-context-readonlyrootfilesystem,Pod,Makes sure that all pods have a security context with read only filesystem set,default<br/>container-seccomp-profile,Pod,Makes sure that all pods have at a seccomp policy configured.,optional<br/>service-targets-pod,Service,Makes sure that all Services targets a Pod,default<br/>service-type,Service,Makes sure that the Service type is not NodePort,default<br/>stable-version,all,Checks if the object is using a deprecated apiVersion,default<br/>deployment-has-host-podantiaffinity,Deployment,Makes sure that a podAntiAffinity has been set that prevents multiple pods from being scheduled on the same node. https://kubernetes.io/docs/concepts/configuration/assign-pod-node/,default<br/>statefulset-has-host-podantiaffinity,StatefulSet,Makes sure that a podAntiAffinity has been set that prevents multiple pods from being scheduled on the same node. https://kubernetes.io/docs/concepts/configuration/assign-pod-node/,default deployment-targeted-by-hpa-does-not-have-replicas-configured,Deployment,Makes sure that Deployments using a HorizontalPodAutoscaler doesn't have a statically configured replica count set,default<br/>statefulset-has-servicename,StatefulSet,Makes sure that StatefulSets have an existing headless serviceName.,default<br/>deployment-pod-selector-labels-match-template-metadata-labels,Deployment,Ensure the StatefulSet selector labels match the template metadata labels.,default<br/>statefulset-pod-selector-labels-match-template-metadata-labels,StatefulSet,Ensure the StatefulSet selector labels match the template metadata labels.,default<br/>label-values,all,Validates label values,default<br/>horizontalpodautoscaler-has-target,HorizontalPodAutoscaler,Makes sure that the HPA targets a valid object,default</span></pre><h1 id="d848" class="jz ka in bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">结论</h1><p id="a54a" class="pw-post-body-paragraph kx ky in kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu ig bi translated">例如，在我们的工作负载部署到集群之前，我们可以在 CI/CD 工具中使用这个 kube-score 和 docker。只要我们有临界点要解决，YAML 就不应该适用于我们的集群！</p></div></div>    
</body>
</html>