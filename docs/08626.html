<html>
<head>
<title>Using Terraform In Azure DevOps, Without Extensions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在 Azure DevOps 中使用 Terraform，不带扩展</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/using-terraform-in-azure-devops-without-extensions-a2a5f869aee7?source=collection_archive---------3-----------------------#2022-06-29">https://blog.devgenius.io/using-terraform-in-azure-devops-without-extensions-a2a5f869aee7?source=collection_archive---------3-----------------------#2022-06-29</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="84ca" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在本文中，我将演示如何在 Azure DevOps 管道中执行 terraform 操作，而不使用任何 terraform 扩展。</p><p id="b0f3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">先决条件:</strong></p><ol class=""><li id="be42" class="ki kj in jm b jn jo jr js jv kk jz kl kd km kh kn ko kp kq bi translated">您有一个带有 Terraform 代码的 Azure DevOps 项目用于扫描</li><li id="0955" class="ki kj in jm b jn kr jr ks jv kt jz ku kd kv kh kn ko kp kq bi translated">创建一个变量组来存储秘密，例如 mygroup</li></ol><figure class="kx ky kz la gt lb gh gi paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="gh gi kw"><img src="../Images/20ffc9c9c17f34817463d50bf796fc82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i4mfRqE1HJ4El1m1c7hW5A.png"/></div></div></figure><p id="4dfb" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">步骤:</strong></p><p id="4c74" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">通常，您需要向您的 YAML 管道文件添加 3 个任务，一个安装 terraform，另一个初始化 terraform 配置，最后一个任务是计划和应用配置。附加任务将用于根据参数选择破坏配置。</p><ol class=""><li id="5036" class="ki kj in jm b jn jo jr js jv kk jz kl kd km kh kn ko kp kq bi translated">声明参数和变量</li></ol><pre class="kx ky kz la gt li lj lk ll aw lm bi"><span id="ff33" class="ln lo in lj b gy lp lq l lr ls">parameters:<br/>  - name: provisionType<br/>    type: string<br/>    default: Apply<br/>    values:<br/>      - Apply<br/>      - Destroy</span><span id="8b00" class="ln lo in lj b gy lt lq l lr ls">variables:<br/>  - group: mygroup</span></pre><p id="e19b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">2.安装 Terraform</p><p id="160e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><em class="lu">注意:如果代理中已经安装了 terraform，则可以跳过该步骤。</em></p><pre class="kx ky kz la gt li lj lk ll aw lm bi"><span id="24f2" class="ln lo in lj b gy lp lq l lr ls">- task: Bash@3<br/>    displayName: Install Terraform<br/>    inputs:<br/>      targetType: 'inline'<br/>      script: |<br/>          wget -qO - terraform.gpg <a class="ae lv" href="https://apt.releases.hashicorp.com/gpg" rel="noopener ugc nofollow" target="_blank">https://apt.releases.hashicorp.com/gpg</a> | sudo gpg --dearmor -o /usr/share/keyrings/terraform-archive-keyring.gpg<br/>          sudo echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/terraform-archive-keyring.gpg] <a class="ae lv" href="https://apt.releases.hashicorp.com" rel="noopener ugc nofollow" target="_blank">https://apt.releases.hashicorp.com</a> $(lsb_release -cs) main" &gt; /etc/apt/sources.list.d/terraform.list<br/>          sudo apt update<br/>          sudo apt install terraform<br/>          terraform --version</span></pre><p id="5ef7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">3.Terraform Init</p><pre class="kx ky kz la gt li lj lk ll aw lm bi"><span id="e356" class="ln lo in lj b gy lp lq l lr ls">- bash: |<br/>        set -eux  # fail on error<br/>        az login --service-principal -u $ARM_CLIENT_ID -p $ARM_CLIENT_SECRET --tenant $ARM_TENANT_ID<br/>        subscriptionId=$(az account show --query id -o tsv)<br/>        terraform init \<br/>          -backend-config=storage_account_name=$(TerraformBackendStorageAccount) \<br/>          -backend-config=container_name=$(TerraformBackendStorageContainer) \<br/>          -backend-config=key=dev.tfstate \<br/>          -backend-config=resource_group_name=$(TerraformBackendResourceGroup) \<br/>          -backend-config=subscription_id="$ARM_SUBSCRIPTION_ID" \<br/>          -backend-config=tenant_id="$ARM_TENANT_ID" \<br/>          -backend-config=client_id="$ARM_CLIENT_ID" \<br/>          -backend-config=client_secret="$ARM_CLIENT_SECRET" <br/>    displayName: 'Terraform Init'<br/>    workingDirectory: $(System.DefaultWorkingDirectory)/TF<br/>    env:<br/>      ARM_CLIENT_ID: $(servicePrincipalId)<br/>      ARM_CLIENT_SECRET: $(servicePrincipalKey)<br/>      ARM_TENANT_ID: $(tenantId)<br/>      ARM_SUBSCRIPTION_ID: $(subscriptionId)</span></pre><p id="3818" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">4.地形规划和应用</p><pre class="kx ky kz la gt li lj lk ll aw lm bi"><span id="f737" class="ln lo in lj b gy lp lq l lr ls">- bash: |<br/>      az login --service-principal -u $ARM_CLIENT_ID -p $ARM_CLIENT_SECRET --tenant $ARM_TENANT_ID<br/>      terraform plan -out=plan.tfplan -input=false<br/>      terraform apply -input=false -auto-approve plan.tfplan<br/>    displayName: 'Terraform ${{ parameters.provisionType }}'<br/>    condition: eq('${{ parameters.provisionType }}', 'Apply')<br/>    workingDirectory: $(System.DefaultWorkingDirectory)/TF<br/>    env:<br/>      ARM_CLIENT_ID: $(servicePrincipalId)<br/>      ARM_CLIENT_SECRET: $(servicePrincipalKey)<br/>      ARM_TENANT_ID: $(tenantId)<br/>      ARM_SUBSCRIPTION_ID: $(subscriptionId)</span></pre><p id="75ef" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">5.地形破坏</p><pre class="kx ky kz la gt li lj lk ll aw lm bi"><span id="8ce8" class="ln lo in lj b gy lp lq l lr ls">- bash: |<br/>      az login --service-principal -u $ARM_CLIENT_ID -p $ARM_CLIENT_SECRET --tenant $ARM_TENANT_ID<br/>      terraform destroy -input=false -auto-approve <br/>    displayName: 'Terraform ${{ parameters.provisionType }}'<br/>    condition: eq('${{ parameters.provisionType }}', 'Destroy')<br/>    workingDirectory: $(System.DefaultWorkingDirectory)/TF<br/>    env:<br/>      ARM_CLIENT_ID: $(servicePrincipalId)<br/>      ARM_CLIENT_SECRET: $(servicePrincipalKey)<br/>      ARM_TENANT_ID: $(tenantId)<br/>      ARM_SUBSCRIPTION_ID: $(subscriptionId)</span></pre><h2 id="03be" class="ln lo in bd lw lx ly dn lz ma mb dp mc jv md me mf jz mg mh mi kd mj mk ml mm bi translated">完整管道 yaml</h2><pre class="kx ky kz la gt li lj lk ll aw lm bi"><span id="44cd" class="ln lo in lj b gy lp lq l lr ls">trigger: none</span><span id="6cf8" class="ln lo in lj b gy lt lq l lr ls">pool:<br/>  vmImage: ubuntu-latest<br/>parameters:<br/>  - name: provisionType<br/>    type: string<br/>    default: Apply<br/>    values:<br/>      - Apply<br/>      - Destroy</span><span id="3518" class="ln lo in lj b gy lt lq l lr ls">variables:<br/>  - group: mygroup</span><span id="e98c" class="ln lo in lj b gy lt lq l lr ls">steps:<br/>  - task: Bash@3<br/>    inputs:<br/>      targetType: 'inline'<br/>      script: |<br/>          wget -qO - terraform.gpg <a class="ae lv" href="https://apt.releases.hashicorp.com/gpg" rel="noopener ugc nofollow" target="_blank">https://apt.releases.hashicorp.com/gpg</a> | sudo gpg --dearmor -o /usr/share/keyrings/terraform-archive-keyring.gpg<br/>          sudo echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/terraform-archive-keyring.gpg] <a class="ae lv" href="https://apt.releases.hashicorp.com" rel="noopener ugc nofollow" target="_blank">https://apt.releases.hashicorp.com</a> $(lsb_release -cs) main" &gt; /etc/apt/sources.list.d/terraform.list<br/>          sudo apt update<br/>          sudo apt install terraform<br/>          terraform --version<br/>    displayName: Install Terraform<br/>  - bash: |<br/>        set -eux  # fail on error<br/>        az login --service-principal -u $ARM_CLIENT_ID -p $ARM_CLIENT_SECRET --tenant $ARM_TENANT_ID<br/>        subscriptionId=$(az account show --query id -o tsv)<br/>        terraform init \<br/>          -backend-config=storage_account_name=$(TerraformBackendStorageAccount) \<br/>          -backend-config=container_name=$(TerraformBackendStorageContainer) \<br/>          -backend-config=key=dev.tfstate \<br/>          -backend-config=resource_group_name=$(TerraformBackendResourceGroup) \<br/>          -backend-config=subscription_id="$ARM_SUBSCRIPTION_ID" \<br/>          -backend-config=tenant_id="$ARM_TENANT_ID" \<br/>          -backend-config=client_id="$ARM_CLIENT_ID" \<br/>          -backend-config=client_secret="$ARM_CLIENT_SECRET" <br/>    displayName: 'Terraform Init'<br/>    workingDirectory: $(System.DefaultWorkingDirectory)/TF<br/>    enabled: true<br/>    env:<br/>      ARM_CLIENT_ID: $(servicePrincipalId)<br/>      ARM_CLIENT_SECRET: $(servicePrincipalKey)<br/>      ARM_TENANT_ID: $(tenantId)<br/>      ARM_SUBSCRIPTION_ID: $(subscriptionId)<br/>      <br/>  - bash: |<br/>      az login --service-principal -u $ARM_CLIENT_ID -p $ARM_CLIENT_SECRET --tenant $ARM_TENANT_ID<br/>      terraform plan -out=plan.tfplan -input=false<br/>      terraform apply -input=false -auto-approve plan.tfplan<br/>    displayName: 'Terraform ${{ parameters.provisionType }}'<br/>    condition: eq('${{ parameters.provisionType }}', 'Apply')<br/>    workingDirectory: $(System.DefaultWorkingDirectory)/TF<br/>    env:<br/>      ARM_CLIENT_ID: $(servicePrincipalId)<br/>      ARM_CLIENT_SECRET: $(servicePrincipalKey)<br/>      ARM_TENANT_ID: $(tenantId)<br/>      ARM_SUBSCRIPTION_ID: $(subscriptionId)<br/>  - bash: |<br/>      az login --service-principal -u $ARM_CLIENT_ID -p $ARM_CLIENT_SECRET --tenant $ARM_TENANT_ID<br/>      terraform destroy -input=false -auto-approve <br/>    displayName: 'Terraform ${{ parameters.provisionType }}'<br/>    condition: eq('${{ parameters.provisionType }}', 'Destroy')<br/>    workingDirectory: $(System.DefaultWorkingDirectory)/TF<br/>    env:<br/>      ARM_CLIENT_ID: $(servicePrincipalId)<br/>      ARM_CLIENT_SECRET: $(servicePrincipalKey)<br/>      ARM_TENANT_ID: $(tenantId)<br/>      ARM_SUBSCRIPTION_ID: $(subscriptionId)</span></pre><h2 id="fa4b" class="ln lo in bd lw lx ly dn lz ma mb dp mc jv md me mf jz mg mh mi kd mj mk ml mm bi translated">运行管道以应用/销毁</h2><figure class="kx ky kz la gt lb gh gi paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="gh gi mn"><img src="../Images/e6edf3168dc9dd637a80218810278e15.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*us0ZakM7KoH7zQAgM_v4XQ.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">管道</figcaption></figure><p id="a622" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我希望你喜欢阅读这篇文章，随意添加你的评论、想法或反馈，不要忘记在<a class="ae lv" href="https://www.linkedin.com/in/babulaparida/" rel="noopener ugc nofollow" target="_blank"> linkedin </a>上联系。</p></div></div>    
</body>
</html>