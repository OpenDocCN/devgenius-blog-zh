# Docker 安全性:风险和最佳实践

> 原文：<https://blog.devgenius.io/docker-security-risks-and-best-practices-4f94bea451a5?source=collection_archive---------3----------------------->

![](img/0304efadf5669ad3f70e0960d6898fa5.png)

名为 Docker 的容器平台使用户能够开发、测试和部署程序。Docker Hub 上有超过 500 万用户和 600 万个存储库，大约每五台主机中就有一台使用 Docker。

考虑到它们很快被接受，处理这些系统时最好把安全性放在第一位。无论您是为自己的业务创建容器还是部署由其他团队制作的容器，了解如何强化这些部署都是至关重要的

事实是，默认情况下，容器**缺乏安全性。**他们的支持基础设施(操作系统和平台)、嵌入式软件组件和运行时配置完全负责其安全性。

在这篇文章中，我将讨论 Docker 安装变得易受攻击的 7 种情况，并讨论如何最小化这种威胁。

1.  **将守护程序绑定到网络接口**

**有什么风险？**

Docker 守护进程生成并管理 Docker 对象，如图像、容器、网络和卷，并监听 Docker API 请求。默认情况下，它由 root 用户拥有，并且比 root 用户拥有更高的权限。通过将守护进程连接到网络接口，您还可以使您的 Docker 容器可以从远处访问，但使其容易受到敌人的攻击。

如何减轻威胁？

将守护程序连接到网络接口时，请务必小心。使用 Docker 的加密 HTTP 套接字，该套接字启用身份验证，如果必须的话，使其可访问。另一件需要记住的事情是永远不要公开 Docker 正在监听的 UNIX 套接字

`/var/run/docker.sock`

这是 Docker API 的主要入口点。授予某人访问权限等同于授予您的主机完全 root 访问权限。切勿将其与其他容器接触

`-v /var/run/docker.sock://var/run/docker.sock`

2.**信息泄露**

**有什么风险？**

泄露敏感信息是主要担忧之一。为了正常工作，Docker 需要 SSH 密钥、凭证和 TLS 证书之类的东西。在 Docker 文件中暴露它们就像把你的房子钥匙给了你的敌人。

如何减轻威胁？

通过 Docker 文件泄露敏感信息会导致攻击者快速访问您的容器。像 Docker Swarm 这样的容器编排器具有秘密管理功能，可以解决使用 Docker 文件泄漏敏感信息的问题。

3.**开源图片**

**有什么风险？**

安装易受攻击的开源库。Docker Hub registry 拥有超过 100，000 个开源容器存储库，其中一些包含流行图像的修改版和非官方版。当您向 Docker Hub 部署新的 repo 时，您应该确保信任发布者，因为每个人都可以访问它。

如何减轻威胁？

利用具有最少组件的基础映像。即使已经安装了一些组件，您也有必要了解它们。因为这样做无疑会增加攻击面。为了防止引入漏洞和恶意代码，请远离未经测试或不受信任的版本。使用 Docker 认证包和 Docker 商店包是一个安全的选择。具有集成扫描功能的知名第三方注册表是另一种选择。

4.**系统命令**

**有什么风险？**

允许用户运行系统命令。在新设置的 Docker 容器上，您可以让用户运行系统命令。用户可以使用允许系统调用来增加他们的特权级别。

如何减轻威胁？

您可以决定是接受还是拒绝系统调用。此外，通过查看 bash 历史文件，您可以像在 Linux 中一样检查系统命令的运行方式。

5.**验证 Docker 图像的真实性**

**有什么风险？**

从不明来源下载的 Docker 图像可能是危险的。在任何组合的 DevOps 工作流中，将安全放在第一位为减少可能的危险定下了基调。

如何减轻威胁？

将基本映像更新为“瘦”或 Alpine Linux 容器映像是 Docker 映像强化过程。当容器映像中的系统文件或应用程序较少时，应用程序不太容易受到黑客攻击。这限制了攻击者横向移动网络的可能性。您应该始终倾向于使用可信的图像，最好是来自 [**Docker 官方图像**](https://docs.docker.com/docker-hub/official_repos/) ，以减少供应链攻击。如果你需要的话，Alpine Linux 被推荐作为一个基础发行版，因为它是目前最轻的发行版之一，可以保证攻击面最小化。

6 .**使用最低权限访问**

**有什么风险？**

最低特权访问应该位于任何安全最佳实践列表的顶端，Docker 安全也是如此。获取敏感系统数据和实施恶意代码是网络罪犯的两种选择。不要授予容器超过完成给定任务所必需的权限。

如何减轻威胁？

管理员还应该在开发过程中使用最低特权/非特权访问，以防止程序员因安全缺陷而被发布到生产环境中。

默认情况下，容器内的进程以 root 身份运行(id=0)。

为了实施最小特权原则，您应该设置一个默认用户。为此，您有两种选择:

1.  或者使用-u 选项指定一个运行容器中不存在的任意用户 ID:

`docker run -u 4000 <image>`

2.或者，通过在 docker 文件中添加一个默认用户来做准备。我们知道以特权访问权限运行 Docker 是有风险的。Docker 提供了一种“无根模式”。

```
docker context use rootlessdocker run –d –p 8080:80 nginx
```

要检查容器是否在特权模式下运行:

`docker inspect –format = ‘ ‘ [container_id]`

如果它返回 true，则它运行在特权模式下。如果它抛出一个错误，它不是。

7.**突破集装箱:**

**有什么风险？**

尽管集装箱突破并不常见，但也并非不可能。从受损的容器，攻击者应该无法访问主机或其他容器。默认情况下，用户没有名称空间，因此每当一个进程突破一个容器时，它会保留授予容器主机的特权。容器中的超级用户访问权限将成为主机上的超级用户访问权限，从而支持权限提升

如何减轻威胁？

测试应该是每个考虑安全性的开发项目的一部分。名为 Docker Bench 的工具使用互联网安全中心(CIS)的 Docker 基准扫描容器的缺陷。为了防范主机级攻击，CIS 建议管理员使用安全技术来强化他们的容器软件。CIS 基准测试的免费 PDF 版本现已推出，其中包括针对 Docker 和常见操作系统的深入安全测试。

这些是码头工人面临的最常见的安全风险。但是这些是在运行时突然出现的场景。如果我们在部署容器之前采取措施来避免任何不便，会怎么样呢？让我们来谈谈我在世界各地的专业开发人员使用的一些**最佳实践**。

# 码头集装箱安全最佳实践:

**测井**

默认情况下，记录级别设置为`INFO`，但是您可以使用以下选项选择另一个:

`— log-level=”debug”|”info”|”warn”|”error”|”fatal”`

如果您的容器化应用程序生成事件日志，您可以使用以下选项将`STDERR`和`STDOUT` 流重定向到外部日志服务进行解耦:

`— log-driver=<logging_driver>`

为了在使用外部服务时保持 Docker 对日志的访问，您还可以设置双重日志记录。如果您的应用程序使用任何专用文件(通常存储在`/var/log`下)，您仍然可以重新路由这些流。

**运行时保护**

为了保护正在运行的容器上的应用程序数据，了解容器和工作节点是至关重要的。来自容器和工作节点的实时活动和元数据应该被容器安全解决方案记录和证实。随着可见性的提高，可以防止犯罪活动，并且可以更快地调查集装箱事故。你不应该在 ENV 指令中明文包含敏感信息。它们并不是一个安全的地方来保存任何你不希望出现在最终层的数据。

```
ENV $VAR
RUN unset $VAR
```

要防止运行时读取访问，请使用单个 RUN 命令在单个层中设置和取消设置变量。

```
RUN export ADMIN_USER="admin" \
&& ... \
&& unset ADMIN_USER
```

利用 ARG 指令(一旦构建了映像，ARG 值就不可用)

**确保正确的配置管理**

开发人员需要完全了解容器的内容，包括任何潜在的安全漏洞。在这种情况下，有效的 Docker 映像配置管理有助于跟踪容器及其内容。开发人员需要排除未知的容器源。

**只允许对根文件系统的读访问**

容器应该主要是无状态的和短暂的。这就是为什么您可以经常将挂载的文件系统限制为只读。如果您使用 Kubernetes，并希望为 docker 安全性增加一层，您甚至可以阻止容器以 root 用户身份启动，并且可以明确地这样做。即使管理员试图手动拖动容器，这种方法也能工作。你所要做的就是在 [pod 安全策略](https://www.mend.io/resources/blog/kubernetes-pod-security-policy) `MustRunAsNonRoot`中添加一个指令，瞧，你的容器将永远不会有根访问。

**为非持久数据使用临时文件系统**

假设您正在使用一个非持久的环境；例如，您的应用程序允许作为来宾访问，但在会话结束后，所有数据都将被丢弃，为此类数据建立临时文件系统，以避免数据记录、空间不足、数据冗余等。要设置临时存储，您可以使用命令

`docker run — read-only — tmpfs /tmp:rw ,noexec,nosuid <image>`

**限制网络端口可访问性**

出于故障排除或调试的目的，开发人员可能会在创建容器时授予对其他网络端口的访问权限。这种方法是可行的，但是一旦在对公共互联网开放的情况下或在生产中使用映像，就要关闭对这些额外网络端口的访问。

当使用 Docker 命令行界面(CLI)时，可以使用-p 参数来设置主机到容器端口映射的严格限制。此命令中未指定的任何端口都将无法访问。

在 Dockerfile 构建过程中，经常会创建日志文件。要将这些文件排除在构建上下文之外，可以使用`.dockerignore`命令从构建过程中明确排除特定的文件或目录。这可以防止无意中泄露任何机密信息或凭据。

**结论**

码头工人的安全不是一件小事。即使是专业人员也总是在寻找安全漏洞并修补它们。最好的解决方案是聪明地思考，尽可能地记住多种场景，并致力于构建安全的容器环境。没有一个完美的码头安全布局或计划。您必须始终与新出现的威胁保持联系，找到解决方法，并不断为您的 Docker 容器添加安全层。

这是所有的乡亲。愿原力与你同在。