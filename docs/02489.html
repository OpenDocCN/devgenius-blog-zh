<html>
<head>
<title>Node.js Best Practices — Log, Test, and Lint</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Node.js最佳实践—日志、测试和Lint</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/node-js-best-practices-log-test-and-lint-279536228c15?source=collection_archive---------3-----------------------#2020-08-07">https://blog.devgenius.io/node-js-best-practices-log-test-and-lint-279536228c15?source=collection_archive---------3-----------------------#2020-08-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/b9069d92646911efe7b54ff7fba4d57a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NANIiWQrBn8Hdten"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">由<a class="ae kc" href="https://unsplash.com/@mysa21?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Mysaell Armendariz </a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="c81b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">像任何类型的应用程序一样，JavaScript应用程序也必须写得很好。</p><p id="9a1d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">否则，我们以后会遇到各种各样的问题。</p><p id="96a1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将看看在编写节点应用程序时应该遵循的一些最佳实践。</p><h1 id="d079" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">使用记录器来增加错误可见性</h1><p id="eebe" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们需要让错误可见，以便我们可以跟踪和修复它们。</p><p id="1773" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们的应用程序中有许多记录工具，如Pino或Winston来记录错误。</p><p id="55c0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="409d" class="mn lc iq mj b gy mo mp l mq mr">const logger = new winston.Logger({<br/>  level: 'info',<br/>  transports: [<br/>    new (winston.transports.Console)()<br/>  ]<br/>});</span><span id="5f0a" class="mn lc iq mj b gy ms mp l mq mr">logger.log('info', 'log %s', 'foo', { anything: 'some metadata' });</span></pre><p id="4b1c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mt mu mv mj b">logger.log</code>记录发生的错误。</p><h1 id="c1f6" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">使用测试框架测试错误流</h1><p id="541e" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">测试错误案例和测试非错误案例一样重要。</p><p id="d54d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果我们测试了错误，那么我们就可以知道我们是否返回了正确的错误。</p><p id="77cd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="ddf4" class="mn lc iq mj b gy mo mp l mq mr">it('creates an item', () =&gt; {<br/>  const invalidGroupInfo = {};<br/>  return httpRequest({<br/>    method: 'POST',<br/>    uri: '/item',<br/>    resolveWithFullResponse: true,<br/>    body: invalidGroupInfo,<br/>    json: true<br/>  }).then((response) =&gt; {<br/>    expect.fail('error')<br/>  }).catch((response) =&gt; {<br/>    expect(400).to.equal(response.statusCode);<br/>  });<br/>});</span></pre><p id="6538" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们测试了一个API，它在一些<code class="fe mt mu mv mj b">expect</code>函数调用中抛出了一个错误。</p><h1 id="fef1" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">使用APM产品发现错误和停机时间</h1><p id="148e" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以检查APM产品的性能问题。</p><p id="23dd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">他们检查缓慢的代码并列出缓慢的代码。</p><p id="c1f9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，我们可以观察是否有停机时间。</p><p id="2aee" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一些工具包括<a class="ae kc" href="https://www.pingdom.com/" rel="noopener ugc nofollow" target="_blank"> Pingdom </a>、<a class="ae kc" href="https://uptimerobot.com/" rel="noopener ugc nofollow" target="_blank"> Uptime Robot </a>和<a class="ae kc" href="https://newrelic.com/application-monitoring" rel="noopener ugc nofollow" target="_blank"> New Relic </a>。</p><p id="cddc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">他们让我们通过易于阅读的仪表板来检查问题。</p><h1 id="c8f9" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">捕捉未处理的承诺拒绝</h1><p id="3ee6" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">如果我们有一个未处理的承诺拒绝，那么我们应该通过捕捉它们来处理它们。</p><p id="bd55" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="536c" class="mn lc iq mj b gy mo mp l mq mr">Promise.reject('error').catch(() =&gt; {<br/>  throw new Error('error');<br/>});</span></pre><p id="4157" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们在<code class="fe mt mu mv mj b">Promise.reject</code>之后调用<code class="fe mt mu mv mj b">catch</code>来捕捉被拒绝的承诺。</p><p id="1c39" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们还可以捕捉<code class="fe mt mu mv mj b">ubhandledRejection</code>或<code class="fe mt mu mv mj b">uncaughtException</code>事件来捕捉错误。</p><p id="a570" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为此，我们可以写:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="f99d" class="mn lc iq mj b gy mo mp l mq mr">process.on('unhandledRejection', (reason, p) =&gt; {<br/>  throw reason;<br/>});<br/><br/>process.on('uncaughtException', (error) =&gt; {<br/>  handleError(error);<br/>  if (!isTrustedError(error))<br/>    process.exit(1);<br/>});</span></pre><p id="fe5d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以用<code class="fe mt mu mv mj b">process</code>模块监听这些事件，然后用我们的方式处理它们。</p><p id="2564" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mt mu mv mj b">reason</code>是拒绝承诺的原因。</p><p id="9416" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">第二次回调检查错误，然后针对某些错误重新启动。</p><h1 id="e039" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">使用专用库快速失败并验证参数</h1><p id="7e60" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们应该用一个专用的库来检查数据。</p><p id="d24d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="1db6" class="mn lc iq mj b gy mo mp l mq mr">const memberSchema = Joi.object().keys({<br/>  age: Joi.number().integer().min(0).max(200),<br/>  email: Joi.string().email()<br/>});</span><span id="7a10" class="mn lc iq mj b gy ms mp l mq mr">function addNewMember(newMember) {<br/>  Joi.assert(newMember, memberSchema); <br/>}</span></pre><p id="85e4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mt mu mv mj b">Joi</code>库让我们根据模式验证我们的对象。</p><p id="e499" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们验证<code class="fe mt mu mv mj b">age</code>是一个介于0和200之间的整数。</p><p id="b8c1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们检查一下电子邮件。</p><p id="936d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们调用<code class="fe mt mu mv mj b">Joi.assert</code>来做检查。</p><h1 id="c41d" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">使用ESLint</h1><p id="6299" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">ESLint让我们能够识别各种问题，包括格式、安全性和错误的构造。</p><p id="18dc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此，我们应该使用它来自动修复其中的许多问题。</p><p id="0d9c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">还有其他工具可以统一格式化代码，比如<a class="ae kc" href="https://www.npmjs.com/package/prettier" rel="noopener ugc nofollow" target="_blank">更漂亮的</a>和<a class="ae kc" href="https://www.npmjs.com/package/js-beautify" rel="noopener ugc nofollow" target="_blank">美化的</a>，它们有更强大的格式化选项。</p><h1 id="c004" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">Node.js特定插件</h1><p id="9a9d" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">ESLint附带了各种插件，我们可以添加这些插件来对节点应用程序进行更多的检查。</p><p id="228a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它们包括像<a class="ae kc" href="https://www.npmjs.com/package/eslint-plugin-node" rel="noopener ugc nofollow" target="_blank"> eslint-plugin-node </a>、<a class="ae kc" href="https://www.npmjs.com/package/eslint-plugin-mocha" rel="noopener ugc nofollow" target="_blank"> eslint-plugin-mocha </a>和<a class="ae kc" href="https://www.npmjs.com/package/eslint-plugin-security" rel="noopener ugc nofollow" target="_blank">eslint-plugin-node-security</a>这样的东西。</p><p id="4cf5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae kc" href="https://www.npmjs.com/package/eslint-plugin-node" rel="noopener ugc nofollow" target="_blank"> eslint-plugin-node </a>检查基本节点应用程序问题。</p><p id="6979" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">eslint-plugin-mocha 有基本的林挺摩卡代码。</p><p id="fbe5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae kc" href="https://www.npmjs.com/package/eslint-plugin-security" rel="noopener ugc nofollow" target="_blank">eslint-plugin-node-security</a>检查安全问题。</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mw"><img src="../Images/adb3291530df59a05eae21dab0a8e881.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*W7RKXefix8IFVbAe"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">劳拉·德维尔德在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><h1 id="bb11" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="3bae" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以通过日志、测试和lint来改进我们的节点应用。</p></div></div>    
</body>
</html>