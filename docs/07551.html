<html>
<head>
<title>How to Dockerize a Production-ready Django Application (Django + Nginx + uWSGI)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何对接一个生产就绪的 Django 应用程序(Django + Nginx + uWSGI)</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/how-to-dockerize-a-production-ready-django-application-django-nginx-uwsgi-a908d3e4d8f8?source=collection_archive---------0-----------------------#2022-04-05">https://blog.devgenius.io/how-to-dockerize-a-production-ready-django-application-django-nginx-uwsgi-a908d3e4d8f8?source=collection_archive---------0-----------------------#2022-04-05</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="b611" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">想象一下，将一个系统从 Python 的一个主要版本升级到另一个版本。有哪些挑战？我认为最大的挑战之一是减少维护期间的停机时间。如果出现问题，尽快恢复。我和不同的团队一起规划过许多项目的系统升级，经历过许多由配置和维护这些“移动部件”引起的问题和挫折。我尝试了不同的方法来使这个过程变得简单一点。我的最新方法是围绕 Docker 技术构建整个流程。在我之前的<a class="ae ki" href="https://medium.com/analytics-vidhya/how-to-deploy-django-application-on-aws-ubuntu-ec2-with-nginx-and-uwsgi-a-practical-guide-1c114cb5f6b6" rel="noopener">帖子</a>中，我们通过运行 Django + Nginx + uWSGI 的架构，搭建了一个直播网站。在本教程中，我们将对整个技术堆栈进行分类。</p><p id="f0d4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">下图展示了它的样子。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/6dd7fb3b4591935066df5ff5196dd224.png" data-original-src="https://miro.medium.com/v2/resize:fit:1386/format:webp/1*3zr0bH-FDWshGbmKmpVmTw.png"/></div></div></figure><h1 id="cbb9" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">属国</h1><ul class=""><li id="25bb" class="lt lu in jm b jn lv jr lw jv lx jz ly kd lz kh ma mb mc md bi translated">Docker 和 Docker 引擎(要安装它们，请参见<a class="ae ki" href="https://docs.docker.com/get-docker/" rel="noopener ugc nofollow" target="_blank">这里的</a>)</li><li id="b34e" class="lt lu in jm b jn me jr mf jv mg jz mh kd mi kh ma mb mc md bi translated">Docker compose(要安装它，请看这里的<a class="ae ki" href="https://docs.docker.com/compose/install/" rel="noopener ugc nofollow" target="_blank"/>)</li></ul><h1 id="84b2" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">第 1/5 步。组织代码库</h1><p id="a6b3" class="pw-post-body-paragraph jk jl in jm b jn lv jp jq jr lw jt ju jv mj jx jy jz mk kb kc kd ml kf kg kh ig bi translated">在前一篇文章中，我们的代码库如下所示。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi mm"><img src="../Images/ead89066210077105e6df4e4e220f04d.png" data-original-src="https://miro.medium.com/v2/resize:fit:522/format:webp/1*TOmXuNVUGjAZuc565k36Vw.png"/></div></figure><p id="3bbe" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让我们重新组织一下。创建一个<strong class="jm io"> web </strong>文件夹。将整个代码库移入其中。我们不需要<strong class="jm io">。gitignore </strong>文件。它应该看起来像下面的。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/e3b6276b4f162a9d4379ce81ccffd04e.png" data-original-src="https://miro.medium.com/v2/resize:fit:548/format:webp/1*Qj6X9rbQHLqQHoaZZ5TczA.png"/></div></figure><h1 id="f91e" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">第 2/5 步。Dockerize 代码库和 uWSGI</h1><p id="4d67" class="pw-post-body-paragraph jk jl in jm b jn lv jp jq jr lw jt ju jv mj jx jy jz mk kb kc kd ml kf kg kh ig bi translated">在<strong class="jm io"> web </strong>文件夹中创建一个<strong class="jm io"> Dockerfile </strong>文件。其内容如下。</p><pre class="kk kl km kn gt mo mp mq mr aw ms bi"><span id="760e" class="mt kw in mp b gy mu mv l mw mx">FROM python:3.7-alpine<br/>RUN mkdir /code<br/>WORKDIR /code<br/>COPY . /code</span><span id="b334" class="mt kw in mp b gy my mv l mw mx"># uwsgi setup<br/>RUN apk add python3-dev build-base linux-headers pcre-dev<br/>RUN pip install uwsgi<br/>RUN pip install -r requirements.txt</span><span id="718f" class="mt kw in mp b gy my mv l mw mx">CMD ["uwsgi", "--ini", "/code/mysite.uwsgi.ini"]</span></pre><p id="69dd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">注意到<strong class="jm io"> CMD </strong>使用 uWSGI 通过 uWSGI 配置文件启动 Django 应用程序，现在让我们创建它。在<strong class="jm io"> web </strong>文件夹中创建一个<strong class="jm io"> mysite.uwsgi.ini </strong>文件。内容如下所示。</p><pre class="kk kl km kn gt mo mp mq mr aw ms bi"><span id="6a4e" class="mt kw in mp b gy mu mv l mw mx">[uwsgi]</span><span id="4995" class="mt kw in mp b gy my mv l mw mx">socket = /tmp/uwsgi/mysite.sock<br/>module = mysite.wsgi<br/>master = true<br/>processes = 2<br/>chmod-socket = 666<br/>vacuum = true</span></pre><p id="0389" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们已经准备好开发一个 Docker 容器，包含 codebase 和 uWSGI。此时，文件结构应该如下所示。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/3993ebeb69e8f6dd936646ecf9931c01.png" data-original-src="https://miro.medium.com/v2/resize:fit:608/format:webp/1*WkZeuQritDSHd0EVxx3leA.png"/></div></figure><h1 id="505f" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">第 3/5 步。Dockerize Nginx</h1><p id="c93e" class="pw-post-body-paragraph jk jl in jm b jn lv jp jq jr lw jt ju jv mj jx jy jz mk kb kc kd ml kf kg kh ig bi translated">在根文件夹中创建一个<strong class="jm io"> nginx </strong>文件夹。然后创建一个<strong class="jm io"> nginx.conf </strong>文件。我们需要这个文件的主要原因是定制容器中的 Nginx 设置。内容如下所示。</p><pre class="kk kl km kn gt mo mp mq mr aw ms bi"><span id="ecf7" class="mt kw in mp b gy mu mv l mw mx">user  root;<br/>worker_processes  auto;</span><span id="fdb7" class="mt kw in mp b gy my mv l mw mx">error_log  /var/log/nginx/error.log notice;<br/>pid        /var/run/nginx.pid;</span><span id="0a68" class="mt kw in mp b gy my mv l mw mx">events {<br/>    worker_connections  1024;<br/>}</span><span id="faa3" class="mt kw in mp b gy my mv l mw mx">http {<br/>    include       /etc/nginx/mime.types;<br/>    default_type  application/octet-stream;</span><span id="5964" class="mt kw in mp b gy my mv l mw mx">log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '<br/>                      '$status $body_bytes_sent "$http_referer" '<br/>                      '"$http_user_agent" "$http_x_forwarded_for"';</span><span id="8784" class="mt kw in mp b gy my mv l mw mx">access_log  /var/log/nginx/access.log  main;</span><span id="2182" class="mt kw in mp b gy my mv l mw mx">sendfile        on;<br/>    #tcp_nopush     on;</span><span id="758a" class="mt kw in mp b gy my mv l mw mx">keepalive_timeout  65;</span><span id="b935" class="mt kw in mp b gy my mv l mw mx">#gzip  on;</span><span id="7f5e" class="mt kw in mp b gy my mv l mw mx">#include /etc/nginx/conf.d/*.conf;<br/>    include /etc/nginx/sites-enabled/*;<br/>}</span></pre><p id="6c1b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在<strong class="jm io"> nginx </strong>文件夹中创建一个<strong class="jm io"> mysite.nginx.conf </strong>文件。内容如下所示。</p><pre class="kk kl km kn gt mo mp mq mr aw ms bi"><span id="32ed" class="mt kw in mp b gy mu mv l mw mx">upstream uwsgi {<br/>    server unix:/tmp/uwsgi/mysite.sock;<br/>}</span><span id="b30b" class="mt kw in mp b gy my mv l mw mx">server {<br/>    listen      80;<br/>    server_name 127.0.0.1;<br/>    charset     utf-8;</span><span id="7dc7" class="mt kw in mp b gy my mv l mw mx">location /static {<br/>        alias /var/www/mysite/assets;<br/>    }</span><span id="309e" class="mt kw in mp b gy my mv l mw mx">location / {<br/>        uwsgi_pass  uwsgi;<br/>        include     /etc/nginx/uwsgi_params;<br/>    }<br/>}</span></pre><p id="3d88" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在<strong class="jm io"> nginx </strong>文件夹中创建一个<strong class="jm io"> Dockerfile </strong>。内容如下所示。</p><pre class="kk kl km kn gt mo mp mq mr aw ms bi"><span id="d480" class="mt kw in mp b gy mu mv l mw mx">FROM nginx:latest</span><span id="8326" class="mt kw in mp b gy my mv l mw mx">COPY nginx.conf /etc/nginx/nginx.conf<br/>COPY mysite.nginx.conf /etc/nginx/sites-available/mysite.nginx.conf<br/>RUN mkdir /etc/nginx/sites-enabled<br/>RUN ln -s /etc/nginx/sites-available/mysite.nginx.conf /etc/nginx/sites-enabled/</span><span id="919f" class="mt kw in mp b gy my mv l mw mx">CMD ["nginx", "-g", "daemon off;"]</span></pre><p id="1fec" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">至此，Nginx 的 Docker 容器全部设置完毕。文件结构应该如下所示。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi na"><img src="../Images/7a32efff0ef17b4b2f2830c2d3cd89da.png" data-original-src="https://miro.medium.com/v2/resize:fit:644/format:webp/1*gE2-NfqbeWGQmmIZtX1hJg.png"/></div></div></figure><h1 id="8cb1" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">第 4/5 步。开发 Docker 合成文件</h1><p id="f440" class="pw-post-body-paragraph jk jl in jm b jn lv jp jq jr lw jt ju jv mj jx jy jz mk kb kc kd ml kf kg kh ig bi translated">在根文件夹中创建一个<strong class="jm io"> docker-compose.yml </strong>。内容如下所示。</p><pre class="kk kl km kn gt mo mp mq mr aw ms bi"><span id="ce98" class="mt kw in mp b gy mu mv l mw mx">version: "3.9"<br/>services:</span><span id="8fc6" class="mt kw in mp b gy my mv l mw mx">nginx:<br/>    build: ./nginx/<br/>    restart: always<br/>    volumes:<br/>      - uwsgi_data:/tmp/uwsgi/<br/>      - web_static:/var/www/mysite/assets/:ro<br/>    ports:<br/>      - "8888:80"<br/>    depends_on: <br/>      - django</span><span id="37e0" class="mt kw in mp b gy my mv l mw mx">django:<br/>    build: ./web/<br/>    restart: always<br/>    command: &gt;<br/>      sh -c "python manage.py collectstatic --noinput <br/>      &amp;&amp; uwsgi --ini mysite.uwsgi.ini"<br/>    volumes:<br/>      - uwsgi_data:/tmp/uwsgi/<br/>      - web_static:/code/static/<br/>      - web_static:/var/www/mysite/assets/</span><span id="940b" class="mt kw in mp b gy my mv l mw mx">volumes:<br/>  uwsgi_data:<br/>  web_static:</span></pre><p id="4817" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">至此，我们都准备好了。文件结构应该如下所示。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi na"><img src="../Images/6a2dbe1a391e698b92aa79a2a648322d.png" data-original-src="https://miro.medium.com/v2/resize:fit:644/format:webp/1*W6zASB8-QM7fOFk79zXlxw.png"/></div></figure><h1 id="95bc" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">第五步。点燃码头集装箱</h1><p id="a76e" class="pw-post-body-paragraph jk jl in jm b jn lv jp jq jr lw jt ju jv mj jx jy jz mk kb kc kd ml kf kg kh ig bi translated">打开终端/PowerShell。转到该项目的根文件夹。然后键入以下命令。</p><pre class="kk kl km kn gt mo mp mq mr aw ms bi"><span id="95d3" class="mt kw in mp b gy mu mv l mw mx">docker compose build</span></pre><p id="d121" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们应该会看到很多如下的印刷品。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi nb"><img src="../Images/6e9f50efff174b2dbb38f936eb76b43b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wmHl-VNEOn4eQn6_oVXTSA.png"/></div></div></figure><p id="b2f9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">该过程完成后，键入以下命令以确保 Docker 映像已经成功构建。</p><pre class="kk kl km kn gt mo mp mq mr aw ms bi"><span id="66d1" class="mt kw in mp b gy mu mv l mw mx">docker images</span></pre><p id="3847" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们应该看到两个 Docker 图像，如下所示。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/71b954c0f29b1772fcbf1e1381162f9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1172/format:webp/1*Uy_C30KX1kqysC1AHA2krw.png"/></div></figure><p id="922b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">要启动容器，请键入以下命令。</p><pre class="kk kl km kn gt mo mp mq mr aw ms bi"><span id="ff29" class="mt kw in mp b gy mu mv l mw mx">docker compose up</span></pre><p id="ba7b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们应该会看到很多如下的印刷品。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi nd"><img src="../Images/b4bfb86d8e18a512f97bae7d0a0271f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Way663lHDJLfMXb9S3MwnQ.png"/></div></div></figure><p id="da3c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">打开浏览器。键入<a class="ae ki" href="http://127.0.0.1:8888/polls/" rel="noopener ugc nofollow" target="_blank">http://127 . 0 . 0 . 1:8888/polls/</a>。您应该会看到下面的页面。恭喜你！</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi ne"><img src="../Images/51d76a292b8f9eb82aa62413aaae5e53.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Yw5sNgmmV_xOpdIovCNRnQ.png"/></div></div></figure><h1 id="a240" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">结论</h1><p id="1c58" class="pw-post-body-paragraph jk jl in jm b jn lv jp jq jr lw jt ju jv mj jx jy jz mk kb kc kd ml kf kg kh ig bi translated">在本教程中，我们走过了从原始代码库到基于容器的架构的完整旅程。你可能会注意到只需要几秒钟就可以启动 Docker 容器。准备好不同版本的 docker-compose.yml 和 docker 映像后，我们可以自信地启动系统升级或“眨眼之间”将其恢复到以前的版本。希望本文能为您提供一些解决系统部署和升级问题的思路。你怎么想呢?留下评论让我知道你的想法。感谢阅读。</p><p id="e1d1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我想对<a class="ae ki" href="https://www.linkedin.com/in/sbmako/" rel="noopener ugc nofollow" target="_blank"> Carlos Sandoval </a>向我介绍 Docker technology 表示感谢。</p><p id="a00b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我已经把这个项目上传到了我的 Github 上。如果你有兴趣深入其中，请查看这里的<a class="ae ki" href="https://github.com/slow999/DjangoAndDocker" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="dbde" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果您对构建这个 Django 应用程序感兴趣，请在这里查看完整教程<a class="ae ki" href="https://medium.com/analytics-vidhya/how-to-use-adminlte-in-django-225359ce8c72" rel="noopener"/>。</p></div></div>    
</body>
</html>