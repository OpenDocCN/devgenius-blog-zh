<html>
<head>
<title>Event Driven Autoscaler for K8s</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">K8s 的事件驱动自动缩放器</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/event-driven-autoscaler-for-k8s-2e24ebfa62e?source=collection_archive---------12-----------------------#2022-10-08">https://blog.devgenius.io/event-driven-autoscaler-for-k8s-2e24ebfa62e?source=collection_archive---------12-----------------------#2022-10-08</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><figure class="im in gp gr io ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi il"><img src="../Images/f58557715a6aa1045030c0ea73bc9504.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R_hjRtMaaQFtpwFdIxSEUg.jpeg"/></div></div><figcaption class="iw ix gj gh gi iy iz bd b be z dk translated">在<a class="ae ja" href="https://unsplash.com/s/photos/reaction?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae ja" href="https://unsplash.com/@nadir_syzygy?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">纳迪尔·西吉</a>拍摄的照片</figcaption></figure><div class=""/><p id="2af6" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Kubernetes 对象的事件驱动激活</p><p id="d46f" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Kubernetes 附带了水平 Pod Autoscaler，用于根据某些指标(CPU 和内存)自动扩展 K8s 资源。当指标来自 K8s 本身时，HPA 工作得最好。它确实支持外部指标，但是它的设置很复杂，并且每个集群只支持一个指标服务器。这里我说的外部指标是指来自外部非集群对象(如 Cloudwatch)的指标。此外，HPA 不能将资源缩减到零。这意味着它只能在 1 到 n 之间调整资源。此外，它不能对外部指标采取行动。</p><p id="e76f" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">HPA 限制:</p><ul class=""><li id="0a61" class="ky kz jd kc b kd ke kh ki kl la kp lb kt lc kx ld le lf lg bi translated"><strong class="kc je">有限的外部指标支持</strong></li><li id="6901" class="ky kz jd kc b kd lh kh li kl lj kp lk kt ll kx ld le lf lg bi translated"><strong class="kc je">缩小到零是不可能的</strong></li></ul><p id="a5c9" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">为了克服这些限制，我们可以利用 KEDA。</p><h1 id="7e0d" class="lm ln jd bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">Kubernetes 事件驱动自动缩放器</h1><figure class="ml mm mn mo gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi mk"><img src="../Images/1fcfdadea5d77e31587c734327fb321e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p8uKhWKZrQt_UelfLgQ46Q.png"/></div></div></figure><p id="aa22" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">KEDA 是一个轻量级的开源组件，基于外部事件激活(从 0 到 1)和停用(从 1 到 0)资源。KEDA 与标准的 Kubernetes HPA 一起工作，并可以通过向其发送外部指标来扩展其功能。从 1 到 n 以及从 n 到 1 的缩放由 HPA 完成。KEDA 让我们在事件驱动的规模上明确地映射我们想要使用的应用程序，而其他应用程序继续照常运行。</p><blockquote class="mp"><p id="d840" class="mq mr jd bd ms mt mu mv mw mx my kx dk translated">1.KEDA →激活|向上扩展(0 → 1)</p><p id="967f" class="mq mr jd bd ms mt mu mv mw mx my kx dk translated">2.KEDA → HPA →向上/向下扩展</p><p id="cfdc" class="mq mr jd bd ms mt mu mv mw mx my kx dk translated">3.KEDA →停用|按比例缩小(1 → 0)</p></blockquote><h1 id="8534" class="lm ln jd bd lo lp lq lr ls lt lu lv lw lx mz lz ma mb na md me mf nb mh mi mj bi translated">KEDA 拓扑</h1><h2 id="1405" class="nc ln jd bd lo nd ne dn ls nf ng dp lw kl nh ni ma kp nj nk me kt nl nm mi nn bi translated">缩放器(事件源)</h2><p id="1717" class="pw-post-body-paragraph ka kb jd kc b kd no kf kg kh np kj kk kl nq kn ko kp nr kr ks kt ns kv kw kx ig bi translated">这些是外部源接口，允许我们连接到它们并从源获得定制的指标。</p><p id="5354" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><a class="ae ja" href="https://keda.sh/docs/2.8/scalers/" rel="noopener ugc nofollow" target="_blank">查看此链接，获取受支持事件源的完整列表。</a></p><h2 id="35a2" class="nc ln jd bd lo nd ne dn ls nf ng dp lw kl nh ni ma kp nj nk me kt nl nm mi nn bi translated">CRDs</h2><p id="4518" class="pw-post-body-paragraph ka kb jd kc b kd no kf kg kh np kj kk kl nq kn ko kp nr kr ks kt ns kv kw kx ig bi translated">CRD 定义了所需的/期望的缩放行为。</p><ul class=""><li id="9fd5" class="ky kz jd kc b kd ke kh ki kl la kp lb kt lc kx ld le lf lg bi translated"><strong class="kc je">scaled objects</strong>—scaler 和 K8s 工作负载(如部署、有状态集和其他 CRD)之间的关系。</li><li id="adb3" class="ky kz jd kc b kd lh kh li kl lj kp lk kt ll kx ld le lf lg bi translated"><strong class="kc je"> ScaledJobs </strong> —定标器和 K8s 作业的关系。</li></ul><blockquote class="nt nu nv"><p id="1b52" class="ka kb nw kc b kd ke kf kg kh ki kj kk nx km kn ko ny kq kr ks nz ku kv kw kx ig bi translated">部署<code class="fe oa ob oc od b">ScaledObject</code>也会创建 HPA 对象，但是，部署 ScaleJob 不会创建任何 HPA 对象。如果是规模化作业，所有的规模化作业均由 KDA 完成。</p></blockquote><p id="d03c" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc je"> KEDA 操作员:</strong> KEDA 操作员作为代理工作，能够根据配置的事件停用和激活 k8 部署。KEDA 操作符在 k8 集群中作为一个独立的容器运行。</p><p id="12af" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc je"> KEDA 度量适配器:</strong> KEDA 度量适配器将队列长度或流延迟等事件数据暴露给水平 Pod 自动缩放器，以驱动缩放。更简单地说，它<strong class="kc je"> </strong>将缩放器获得的指标转换成 HPA 可以使用的格式。</p><h2 id="e0c8" class="nc ln jd bd lo nd ne dn ls nf ng dp lw kl nh ni ma kp nj nk me kt nl nm mi nn bi translated">证明</h2><p id="3acf" class="pw-post-body-paragraph ka kb jd kc b kd no kf kg kh np kj kk kl nq kn ko kp nr kr ks kt ns kv kw kx ig bi translated">监控事件源的身份验证配置或秘密。这些定义了连接外部事件源所需的安全对象，如 API 密钥、secret 和 cert。有两种类型的身份验证对象:</p><ul class=""><li id="e69b" class="ky kz jd kc b kd ke kh ki kl la kp lb kt lc kx ld le lf lg bi translated">触发认证</li><li id="cbe2" class="ky kz jd kc b kd lh kh li kl lj kp lk kt ll kx ld le lf lg bi translated">ClusterTriggerAuthentication</li></ul><h2 id="e780" class="nc ln jd bd lo nd ne dn ls nf ng dp lw kl nh ni ma kp nj nk me kt nl nm mi nn bi translated">安装 KEDA 操作器:</h2><pre class="ml mm mn mo gt oe od of og aw oh bi"><span id="fb84" class="nc ln jd od b gy oi oj l ok ol">#Adding the Helm repo<br/>helm repo add kedacore <a class="ae ja" href="https://kedacore.github.io/charts" rel="noopener ugc nofollow" target="_blank">https://kedacore.github.io/charts</a><br/>helm repo update<br/>kubectl create namespace keda<br/>helm install keda kedacore/keda --namespace keda</span></pre><p id="ae5d" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">上述命令将注册 CRD 并启动两个 pod:</p><pre class="ml mm mn mo gt oe od of og aw oh bi"><span id="480c" class="nc ln jd od b gy oi oj l ok ol">keda-operator<br/>keda-operator-metrics-apiserver</span></pre><p id="0ce2" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">设置 KEDA 以监控 SQS 队列并扩展部署中的工作人员(my-sqs-consumer)。<a class="ae ja" href="https://keda.sh/docs/2.8/scalers/aws-sqs/" rel="noopener ugc nofollow" target="_blank">SQS 定标器的参考。</a></p><pre class="ml mm mn mo gt oe od of og aw oh bi"><span id="220d" class="nc ln jd od b gy oi oj l ok ol">apiVersion: v1<br/>kind: Secret<br/>metadata:<br/>  name: role-secrets<br/>  namespace: keda-demo<br/>data:<br/>  AWS_ROLE_ARN: &lt;encoded-iam-role-arn&gt;</span><span id="4e30" class="nc ln jd od b gy om oj l ok ol">---<br/>apiVersion: keda.sh/v1alpha1<br/>kind: TriggerAuthentication<br/>metadata:<br/>  name: keda-trigger-auth-aws-credentials<br/>  namespace: keda-demo<br/>spec:<br/>  secretTargetRef:<br/>  - parameter: awsRoleArn<br/>    name: role-secrets<br/>    key: AWS_ROLE_ARN<br/>---</span><span id="5e8b" class="nc ln jd od b gy om oj l ok ol">apiVersion: keda.sh/v1alpha1<br/>kind: ScaledObject<br/>metadata:<br/>  name: aws-sqs-queue-scaledobject<br/>  namespace: keda-demo<br/>spec:<br/>  scaleTargetRef:<br/>    apiVersion: apps/v1<br/>    kind: Deployment<br/>    name: my-sqs-consumer<br/>  pollingInterval: 5<br/>  cooldownPeriod: 10<br/>  idleReplicaCount: 0<br/>  minReplicaCount: 1<br/>  maxReplicaCount: 3 <br/>  fallback:<br/>    failureThreshold: 3<br/>    replicas: 2 <br/>  triggers:<br/>  - type: aws-sqs-queue<br/>    authenticationRef:<br/>      name: keda-trigger-auth-aws-credentials<br/>    metadata:<br/>      queueURL: &lt;my_queue_url&gt; <br/>      queueLength: 1<br/>      awsRegion: "us-east-1"<br/>      identityOwner: operator<br/></span></pre><p id="1648" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我跳过了这里的 IRSA 场景。在 EKS 和 AWS IAM 之间进行配置。</p><figure class="ml mm mn mo gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi on"><img src="../Images/a9112cc73ef5123e99326c953b47095c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mABgAyfPMgdDCqnm-8TmjA.png"/></div></div><figcaption class="iw ix gj gh gi iy iz bd b be z dk translated">KEDA 时间轴 w . r . t SQS 队列中的邮件数</figcaption></figure><p id="f626" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">上图描述了 KEDA 如何使用 SQS 队列。t1，t2..tn 代表各种事件时间。</p><blockquote class="nt nu nv"><p id="cdc4" class="ka kb nw kc b kd ke kf kg kh ki kj kk nx km kn ko ny kq kr ks nz ku kv kw kx ig bi translated">注意:要自动缩放自定义资源，对象的 CRD 必须定义<code class="fe oa ob oc od b">/scale</code>子资源。<br/> <code class="fe oa ob oc od b">subresources:<br/> scale:</code></p></blockquote><p id="1540" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">气流也支持 KEDA 的情况下，我们使用芹菜工人。这个自动缩放器根据处于<code class="fe oa ob oc od b">queued</code>或<code class="fe oa ob oc od b">running</code>状态的任务数量来调整活动的芹菜工人数量(从 0 到 n 或相反)。与 KEDA 一起运行气流带来了最好的两个世界。Kubernetes 的弹性通过 KEDA 和快速跟进、低开销优化 CeleryExecutor 和 workers 提供动力。</p><pre class="ml mm mn mo gt oe od of og aw oh bi"><span id="bd47" class="nc ln jd od b gy oi oj l ok ol">helm install airflow apache-airflow/airflow <strong class="od je">\</strong><br/>    --namespace airflow <strong class="od je">\</strong><br/>    <strong class="od je">--set executor=CeleryExecutor \<br/>    --set workers.keda.enabled=true</strong></span><span id="6b19" class="nc ln jd od b gy om oj l ok ol"># Metrics collection SQL</span><span id="3850" class="nc ln jd od b gy om oj l ok ol">SELECT<br/>    ceil(COUNT(*)::decimal / {{ .Values.config.celery.worker_concurrency }})<br/>FROM task_instance<br/>WHERE state='running' OR state='queued'</span></pre><p id="cc53" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><em class="nw">注意:用 KEDA 缩减长期运行的任务是一个公开的问题。所以，我不建议生产使用。</em></p><p id="42a9" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">感谢阅读！！</p></div></div>    
</body>
</html>