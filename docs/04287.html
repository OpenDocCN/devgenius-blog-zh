<html>
<head>
<title>Server-Side Development with Fastify — Custom Logging and Route Config</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Fastify 进行服务器端开发—自定义日志记录和路由配置</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/server-side-development-with-fastify-custom-logging-and-route-config-c052acef9432?source=collection_archive---------2-----------------------#2021-02-21">https://blog.devgenius.io/server-side-development-with-fastify-custom-logging-and-route-config-c052acef9432?source=collection_archive---------2-----------------------#2021-02-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/ef110dc85921249759eadf6c7472db36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PJyf7dsI0FH2-YIL"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">由<a class="ae kc" href="https://unsplash.com/@nexgenfx?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">卢卡·坎皮奥尼</a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="db44" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Fastify 是一个用于开发后端 web 应用程序的小型节点框架。</p><p id="af85" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将了解如何使用 Fastify 创建后端应用程序。</p><h1 id="5cf5" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">自定义日志级别</h1><p id="66c4" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以更改 Fastify 应用程序的日志级别。</p><p id="514a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><p id="20e6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">index.js</code></p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="68ab" class="mq lc iq mh b gy mr ms l mt mu">const fastify = require('fastify')({<br/>  logger: true <br/>})</span><span id="840d" class="mq lc iq mh b gy mv ms l mt mu">fastify.register(require('./routes/v1/users'), { prefix: '/v1' })<br/>fastify.register(require('./routes/v2/users'), { prefix: '/v2' })</span><span id="3753" class="mq lc iq mh b gy mv ms l mt mu">const start = async () =&gt; {<br/>  try {<br/>    await fastify.listen(3000, '0.0.0.0')  <br/>  } catch (err) {<br/>    fastify.log.error(err)    <br/>    process.exit(1)<br/>  }<br/>}<br/>start()</span></pre><p id="1eea" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">routes/v1/users.js</code></p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="43c1" class="mq lc iq mh b gy mr ms l mt mu">module.exports = function (fastify, opts, done) {<br/>  fastify.get('/user', async () =&gt; 'v1')<br/>  done()<br/>}</span></pre><p id="f7ae" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">routes/v2/user.js</code></p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="a5d3" class="mq lc iq mh b gy mr ms l mt mu">module.exports = function (fastify, opts, done) {<br/>  fastify.get('/user', async () =&gt; 'v2')<br/>  done()<br/>}</span></pre><p id="8194" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将<code class="fe me mf mg mh b">logger</code>设置为<code class="fe me mf mg mh b">true</code>来启用日志记录。</p><p id="f97d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们还可以为单个路由设置日志记录级别。</p><p id="d36f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="982a" class="mq lc iq mh b gy mr ms l mt mu">const fastify = require('fastify')()</span><span id="94eb" class="mq lc iq mh b gy mv ms l mt mu">fastify.get('/', { logLevel: 'warn' }, (request, reply) =&gt; {<br/>  reply.send({ hello: 'world' })<br/>})</span><span id="e8e8" class="mq lc iq mh b gy mv ms l mt mu">const start = async () =&gt; {<br/>  try {<br/>    await fastify.listen(3000, '0.0.0.0')  <br/>  } catch (err) {<br/>    fastify.log.error(err)    <br/>    process.exit(1)<br/>  }<br/>}<br/>start()</span></pre><p id="004f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们在<code class="fe me mf mg mh b">/</code>路线上设置<code class="fe me mf mg mh b">logLevel</code>到<code class="fe me mf mg mh b">'warn'</code>。</p><h1 id="2144" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">自定义日志序列化程序</h1><p id="3f32" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以定制日志序列化程序。</p><p id="63ec" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="a9d4" class="mq lc iq mh b gy mr ms l mt mu">const fastify = require('fastify')({<br/>  logger: {<br/>    level: 'info',<br/>    serializers: {<br/>      user (req) {<br/>        return {<br/>          method: req.method,<br/>          url: req.url,<br/>          headers: req.headers,<br/>          hostname: req.hostname,<br/>          remoteAddress: req.ip,<br/>          remotePort: req.socket.remotePort<br/>        }<br/>      }<br/>    }<br/>  }<br/>})</span><span id="74a8" class="mq lc iq mh b gy mv ms l mt mu">fastify.register(context1, {<br/>  logSerializers: {<br/>    user: value =&gt; `My serializer father - ${value}`<br/>  }<br/>})</span><span id="32cd" class="mq lc iq mh b gy mv ms l mt mu">async function context1 (fastify, opts) {<br/>  fastify.get('/', (req, reply) =&gt; {<br/>    req.log.info({ user: 'call father serializer', key: 'another key' })<br/>    reply.send({})<br/>  })<br/>}<br/>const start = async () =&gt; {<br/>  try {<br/>    await fastify.listen(3000, '0.0.0.0')  <br/>  } catch (err) {<br/>    fastify.log.error(err)    <br/>    process.exit(1)<br/>  }<br/>}<br/>start()</span></pre><p id="e62c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">添加<code class="fe me mf mg mh b">logSerializers</code>属性。</p><p id="df91" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当我们在第一行调用 Fastify 工厂函数时，我们配置了日志记录器。</p><p id="a59c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们设置<code class="fe me mf mg mh b">level</code>来设置日志级别。</p><p id="0193" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">serializers</code>有一个带有<code class="fe me mf mg mh b">user</code>函数的对象，它从请求中返回信息。</p><p id="8661" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们分别返回请求方法、URL、头、主机名、IP 和远程端口。</p><p id="2478" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，当我们发出请求时，我们会在控制台中看到输出。</p><h1 id="bb02" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">路线配置</h1><p id="123b" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以在定义路由时传入一个配置对象。</p><p id="c1dc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="3517" class="mq lc iq mh b gy mr ms l mt mu">const fastify = require('fastify')()</span><span id="7a02" class="mq lc iq mh b gy mv ms l mt mu">function handler (req, reply) {<br/>  reply.send(reply.context.config.output)<br/>}</span><span id="e417" class="mq lc iq mh b gy mv ms l mt mu">fastify.get('/en', { config: { output: 'hello world!' } }, handler)<br/>fastify.get('/fr', { config: { output: 'bonjour' } }, handler)</span><span id="08cd" class="mq lc iq mh b gy mv ms l mt mu">const start = async () =&gt; {<br/>  try {<br/>    await fastify.listen(3000, '0.0.0.0')  <br/>  } catch (err) {<br/>    fastify.log.error(err)    <br/>    process.exit(1)<br/>  }<br/>}<br/>start()</span></pre><p id="06f2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们在第二个参数中传入一个属性为<code class="fe me mf mg mh b">config</code>的对象。</p><p id="4899" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们可以从<code class="fe me mf mg mh b">reply.context</code>属性中获取该值。</p><h1 id="37c7" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="6639" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以使用 Fastify 设置自定义日志和路由配置。</p></div></div>    
</body>
</html>