<html>
<head>
<title>Securing REST API with Spring Security, JWT, and JPA</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Spring Security、JWT和JPA保护REST API</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/securing-spring-boot-rest-api-with-spring-security-jwt-and-jpa-64ec45fb25e0?source=collection_archive---------2-----------------------#2021-04-06">https://blog.devgenius.io/securing-spring-boot-rest-api-with-spring-security-jwt-and-jpa-64ec45fb25e0?source=collection_archive---------2-----------------------#2021-04-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="f3dc" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">Spring Security是一个强大且高度可定制的认证和访问控制框架。它是保护基于<strong class="ak"> Spring </strong>的应用程序的事实上的标准。<strong class="ak"> Spring Security </strong>是一个专注于为<strong class="ak"> Java </strong>应用程序提供认证和授权的框架。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/ce1eee80f26b8912858d985b0128fa06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*H9hMatskBttWo9w9"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">约翰·萨尔维诺在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="cb3a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">今天我们将讲述以下事情</strong></p><ol class=""><li id="5f41" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">API和应用程序安全性的重要性</li><li id="2dcf" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">术语认证和授权的详细信息</li><li id="4d77" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">春天安全的细节</li><li id="3ca5" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">JWT的细节</li><li id="9a6d" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">spring安全和JWT的实际实施</li><li id="9f25" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">源代码描述</li></ol><p id="afe3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">先决条件<br/> </strong>在开始本教程之前，你必须了解关于spring boot和JPA的细节。要了解这一点，你可以阅读我的贝娄媒体文章。<br/> Spring boot和JPA:为此，你可以阅读<a class="ae kv" href="https://mesukcse08.medium.com/spring-data-jpa-a-to-z-6c957ed17a66" rel="noopener"> <strong class="ky ir">本教程</strong> </a></p><ol class=""><li id="44e6" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated"><strong class="ky ir">API和应用安全的重要性</strong></li></ol><ul class=""><li id="4de8" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr mg ly lz ma bi translated">企业使用API来连接服务和传输数据，因此被黑客攻击的API会导致数据泄露。</li><li id="1895" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr mg ly lz ma bi translated">多种类型的数据可以通过不同的API进行传输。任何API安全性的实现都需要特定于您的API和正在传输的数据。</li><li id="ca18" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr mg ly lz ma bi translated">您需要适当的身份验证、授权、访问权限等，以确保只有被允许的客户端才能使用该接口，并且只能执行被允许的操作。</li><li id="e04d" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr mg ly lz ma bi translated">您需要确保您的应用程序端点(用于访问接口的URL)不容易受到通过接口或绕过接口的攻击。</li></ul><p id="b6f3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> 2。对资源的访问受到认证和授权的双重保护。如果你不能证明你的身份，你将不会被允许进入资源。即使您可以证明您的身份，如果您没有获得该资源的授权，您仍然会被拒绝访问。</strong></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mi"><img src="../Images/fb0c328130b9ac8c26141c85db3c4438.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*leT1YPLnEdLhAb_bl-J8ZA.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">图片来自<a class="ae kv" href="http://www.okta.com" rel="noopener ugc nofollow" target="_blank">www.okta.com</a></figcaption></figure><p id="2f0d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">认证</strong></p><ul class=""><li id="74ad" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr mg ly lz ma bi translated">密钥的形式，授予拥有适当凭证的用户</li><li id="ad2c" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr mg ly lz ma bi translated">要求用户验证凭据(例如，通过密码、安全问题答案或面部识别)</li><li id="d9ae" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr mg ly lz ma bi translated">通常在授权前完成。首先，我们验证用户，然后检查其他东西。</li><li id="df28" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr mg ly lz ma bi translated">例如，公司的员工在访问他们公司的电子邮件之前需要通过网络进行身份验证</li></ul><p id="47f5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">授权</strong></p><ul class=""><li id="1abe" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr mg ly lz ma bi translated">确定用户可以访问和不可以访问的内容</li><li id="da8b" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr mg ly lz ma bi translated">以权限的形式。在这个术语中，仅表示验证访问权限。</li><li id="c5da" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr mg ly lz ma bi translated">验证是否通过策略和规则允许访问</li><li id="e86f" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr mg ly lz ma bi translated">通常在成功认证后完成</li><li id="3fa9" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr mg ly lz ma bi translated">例如，一旦进入，该人可以进入酒店的客房。也可以被授权进入公共洗手间和看电视。如果没有适当的文件，这个人可能没有使用电梯进入房间的许可。</li></ul></div><div class="ab cl mj mk hu ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="ij ik il im in"><p id="d5cd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> 3。spring security的细节<br/> </strong> <em class="mh"> spring Security是一个框架，它使程序员能够通过JEE组件对基于Spring框架的Web应用程序施加安全限制。简而言之，它是一个可以使用的库，可以根据程序员的需要进行扩展和定制。因为是同一个Spring家族的成员，所以和Spring Web MVC的携手非常顺利。它的主要操作领域是在Web请求级别和方法调用级别处理身份验证和授权。也许吧。这个框架最大的优点是它功能强大，而且在实现中高度可定制。尽管它遵循Spring在配置方面的惯例，但程序员可以在默认条款或根据自己的需要定制条款之间进行选择。</em></p><p id="a0ee" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要启用spring安全和JWT，我们必须在build.gradle文件中使用bellow依赖项。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="e8f6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要配置spring安全性，我们必须编写一个配置类。下面给出了一个示例类</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="3252" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">批注<em class="mh"> @EnableWebSecurity </em>启用Web安全；否则，它默认保持禁用状态。我们扩展了<em class="mh">WebSecurityConfigurerAdapter</em>,这样扩展Adapter类的好处是，我们可以通过只覆盖我们感兴趣的部分来配置Web安全性，其他部分可以保持默认形式。<em class="mh"> PasswordEncoder </em>是Spring安全框架提供的一个服务接口，用于对密码进行编码。<br/>此外，我们添加了<em class="mh">AuthenticationManager</em>bean以供进一步使用。</p><p id="c7fd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这个配置类中，我们正在配置以下内容:<br/>a . HTTP Security<br/><strong class="ky ir">void configure(HTTP Security HTTP)</strong><br/>b . Web Security<br/><strong class="ky ir">configure(Web Security Web)</strong></p><p id="5d58" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这个简单的方法可以确保HTTP请求是安全的。</p><pre class="kg kh ki kj gt ms mt mu mv aw mw bi"><span id="3e1c" class="mx my iq mt b gy mz na l nb nc"><strong class="mt ir">protected void </strong>configure(HttpSecurity http) <strong class="mt ir">throws </strong>Exception {<br/><br/>    http.csrf().disable()<br/>    .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.<strong class="mt ir"><em class="mh">STATELESS</em></strong>);<br/><br/>    <em class="mh">// Entry points<br/>    </em>http.authorizeRequests()<br/>            .antMatchers(<strong class="mt ir">"/main/**/"</strong>).permitAll()<br/>            .antMatchers(<strong class="mt ir">"/customer/**/"</strong>).permitAll()<br/>            .antMatchers(<strong class="mt ir">"/secureUsers/public/**/"</strong>).permitAll()<br/>            .antMatchers(<strong class="mt ir">"/redisTest/**/"</strong>).permitAll()<br/>            .antMatchers(<strong class="mt ir">"/h2-console/**/**"</strong>).permitAll()<br/>            .anyRequest().authenticated();<br/><br/>    <em class="mh">// If a user try to access a resource without having enough permissions<br/>    </em>http.exceptionHandling().accessDeniedPage(<strong class="mt ir">"/accessDeniedPage"</strong>);<br/><br/>    <em class="mh">// Apply JWT<br/>    </em>http.apply(<strong class="mt ir">new </strong>JwtTokenFilterConfigurer(<strong class="mt ir">jwtTokenProviderService</strong>));<br/>}</span></pre><ul class=""><li id="3be8" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr mg ly lz ma bi translated">禁用csrf</li><li id="861d" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr mg ly lz ma bi translated">会话创建策略是无状态的</li><li id="35bc" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr mg ly lz ma bi translated">提供一些不安全的URL模式。这些URL不需要外部身份验证和授权。例如，我们可能需要公开<strong class="ky ir">注册</strong>和<strong class="ky ir">登录</strong> API。除了那些提到的API，其他的都需要认证。</li><li id="550a" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr mg ly lz ma bi translated">对于异常处理，如果用户对所请求的API没有足够的权限，则重定向到默认的拒绝访问页面</li><li id="eeea" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr mg ly lz ma bi translated">最后添加了安全配置过滤器JWT。我们将展示这方面的细节</li></ul><p id="ab3b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> b .网络安全<br/> </strong>在这一节中，我们提到了一些不需要通过安全层的URL。</p><pre class="kg kh ki kj gt ms mt mu mv aw mw bi"><span id="9dd0" class="mx my iq mt b gy mz na l nb nc"><strong class="mt ir">public void </strong>configure(WebSecurity web) <strong class="mt ir">throws </strong>Exception {<br/>    <em class="mh">// Allow swagger to be accessed without authentication<br/>    </em>web.ignoring().antMatchers(<strong class="mt ir">"/v2/api-docs"</strong>)<em class="mh">//<br/>            </em>.antMatchers(<strong class="mt ir">"/swagger-resources/**"</strong>)<em class="mh">//<br/>            </em>.antMatchers(<strong class="mt ir">"/swagger-ui.html"</strong>)<em class="mh">//<br/>            </em>.antMatchers(<strong class="mt ir">"/configuration/**"</strong>)<em class="mh">//<br/>            </em>.antMatchers(<strong class="mt ir">"/webjars/**"</strong>)<em class="mh">//<br/>            </em>.antMatchers(<strong class="mt ir">"/public"</strong>)<br/><br/>            <em class="mh">// Un-secure H2 Database (for testing purposes, H2 console shouldn't be unprotected in production)<br/>            </em>.and()<br/>            .ignoring()<br/>            .antMatchers(<strong class="mt ir">"/h2-console/**/**"</strong>);;<br/>}</span></pre><p id="8e32" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里，我们忽略了来自安全层的大摇大摆的URL和h2控制台UI。</p></div><div class="ab cl mj mk hu ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="ij ik il im in"><p id="e652" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在<strong class="ky ir"> Spring安全框架</strong>下面已经有了<strong class="ky ir"> <em class="mh"> UserDetails </em> </strong>投影类。它具有以下<strong class="ky ir">属性</strong></p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="745c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里重要的字段是<strong class="ky ir"> <em class="mh">用户名</em> </strong>和<strong class="ky ir"> <em class="mh">密码</em> </strong>。我们将使用这些字段来验证我们的用户。</p><p id="0d1f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在<strong class="ky ir"> spring安全框架</strong>也有了另一个名为<strong class="ky ir"><em class="mh">userdailsservice</em></strong><em class="mh"/>的接口/服务类，用于验证用户。它被给出如下</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="b7a6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">此<strong class="ky ir"><em class="mh">loaduserbysusername</em></strong>仓库<strong class="ky ir"> <em class="mh"> </em> </strong>方法通过用户名加载用户。<strong class="ky ir">这里两个类都是spring安全框架的默认方法</strong>。我们将在我们的系统中使用这些类。</p></div><div class="ab cl mj mk hu ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="ij ik il im in"><p id="5191" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们的域类是<strong class="ky ir"> <em class="mh">用户</em> </strong>，其代码如下</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="8668" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里，我们有基于Spring安全框架<strong class="ky ir"> <em class="mh"> UserDetails </em> </strong>类的<em class="mh">用户名</em>和<em class="mh">密码</em>字段。在注册过程中，我们将用户的数据存储到这个表中。现在，我们的用户域的存储库类如下所示:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="b83e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里，<strong class="ky ir"><em class="mh">SecureUserRepository</em></strong>是简单的JpaRepository，用于简单的查询用户。</p><p id="ef44" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> 4。详细介绍JWT <br/> </strong> <em class="mh"> JWT主要用于认证。用户登录到应用程序后，应用程序将创建一个JWT并发送给用户。用户的后续请求将包括JWT。令牌告诉服务器允许用户访问哪些路由、服务和资源。JWT可以轻松地跨多个域使用，因此它们通常用于单点登录。</em></p><p id="b629" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">重要提示:</strong>此部分为<strong class="ky ir">从官方<a class="ae kv" href="https://jwt.io/introduction#:~:text=The%20header%20typically%20consists%20of,as%20HMAC%20SHA256%20or%20RSA.&amp;text=Then%2C%20this%20JSON%20is%20Base64Url,first%20part%20of%20the%20JWT." rel="noopener ugc nofollow" target="_blank">抄袭</a></strong>T5】jwt . io链接T7】</p><h1 id="95e9" class="nd my iq bd ne nf ng nh ni nj nk nl nm jw nn jx no jz np ka nq kc nr kd ns nt bi translated">JWT结构</h1><p id="6815" class="pw-post-body-paragraph kw kx iq ky b kz nu jr lb lc nv ju le lf nw lh li lj nx ll lm ln ny lp lq lr ij bi translated">JWT令牌的样本如下</p><blockquote class="nz oa ob"><p id="7428" class="kw kx mh ky b kz la jr lb lc ld ju le oc lg lh li od lk ll lm oe lo lp lq lr ij bi translated">eyJhbGciOiJIUzI1NiJ9。<strong class="ky ir">eyjzdwiioijtzxn 1 ayisimf 1dg giolt 7 IMF 1 dghvcml 0 ESI 6 iljptevfqurnsu 4 if v0 simlhdci 6 mtyxnzm 1 mte 1 mswizzhwijoxnje 3 mzu 0 nzuxfq</strong>. lpqsdninetcwlyyvmcydsejzmprfuygil 7 xn 6 srnm</p></blockquote><p id="7655" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">它由三部分组成。<br/> <strong class="ky ir"> 1。标头:</strong>标头通常由两部分组成:令牌的类型(JWT)和使用的哈希算法(如HMAC SHA256或RSA)。例如</p><p id="66f1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">{ <br/> "alg": "HS256 "，<br/> "typ": "JWT" <br/> }</p><p id="0f5c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，这个JSON被Base64Url编码，形成JWT的第一部分。</p><p id="a2f8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> 2。Payload: <br/> </strong>令牌的第二部分是Payload，它包含声明。声明是关于实体(通常是用户)和附加数据的声明。债权有三种类型:<em class="mh">登记的</em>、<em class="mh">公开的</em>和<em class="mh">私人的</em>债权。</p><ul class=""><li id="6bb9" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr mg ly lz ma bi translated"><strong class="ky ir">注册声明</strong>:这是一组预定义的声明，不是强制性的，而是推荐性的，目的是提供一组有用的、可互操作的声明。其中有<strong class="ky ir"> iss </strong>(发行人)<strong class="ky ir"> exp </strong>(到期时间)<strong class="ky ir"> sub </strong>(主体)<strong class="ky ir"> aud </strong>(受众)，其他。</li></ul><blockquote class="nz oa ob"><p id="0bb6" class="kw kx mh ky b kz la jr lb lc ld ju le oc lg lh li od lk ll lm oe lo lp lq lr ij bi translated">请注意，索赔名称只有三个字符长，因为JWT是为了简洁。</p></blockquote><ul class=""><li id="8cc2" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr mg ly lz ma bi translated"><a class="ae kv" href="https://tools.ietf.org/html/rfc7519#section-4.2" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir">公开声明</strong> </a>:这些可以由使用jwt的人随意定义。但是为了避免冲突，应该在IANA JSON Web令牌注册中心中定义它们，或者将其定义为包含抗冲突名称空间的URI。</li><li id="e84d" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr mg ly lz ma bi translated"><a class="ae kv" href="https://tools.ietf.org/html/rfc7519#section-4.3" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir">私人声明</strong> </a>:这些是为在同意使用它们的各方之间共享信息而创建的自定义声明，既不是<em class="mh">注册的</em>也不是<em class="mh">公开的</em>声明。</li></ul><p id="9310" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">有效载荷的例子可以是:</p><pre class="kg kh ki kj gt ms mt mu mv aw mw bi"><span id="eb01" class="mx my iq mt b gy mz na l nb nc">{   "sub": "1234567890",   "name": "John Doe",   "admin": true }</span></pre><p id="093a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后对有效负载进行<strong class="ky ir"> Base64Url </strong>编码，形成JSON Web令牌的第二部分。</p><blockquote class="nz oa ob"><p id="e213" class="kw kx mh ky b kz la jr lb lc ld ju le oc lg lh li od lk ll lm oe lo lp lq lr ij bi translated"><em class="iq">请注意，对于已签名的令牌，此信息虽然受到保护，不会被篡改，但任何人都可以读取。除非加密，否则不要将机密信息放在JWT的有效载荷或报头元素中。</em></p></blockquote><p id="2d2e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> 3。签名<br/> </strong>为了创建签名部分，你必须接受编码的报头、编码的有效载荷、秘密、报头中指定的算法，并对其进行签名。</p><p id="a3c2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">例如，如果您想使用HMAC SHA256算法，签名将以如下方式创建:</p><pre class="kg kh ki kj gt ms mt mu mv aw mw bi"><span id="3950" class="mx my iq mt b gy mz na l nb nc">HMACSHA256(   base64UrlEncode(header) + "." +   base64UrlEncode(payload),   secret)</span></pre><p id="4403" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">签名用于验证消息在传输过程中未被更改，对于用私钥签名的令牌，它还可以验证JWT的发送者就是它所说的那个人。</p><h1 id="fe1d" class="nd my iq bd ne nf ng nh ni nj nk nl nm jw nn jx no jz np ka nq kc nr kd ns nt bi translated">把所有的放在一起</h1><p id="feb7" class="pw-post-body-paragraph kw kx iq ky b kz nu jr lb lc nv ju le lf nw lh li lj nx ll lm ln ny lp lq lr ij bi translated">输出是由点分隔的三个Base64-URL字符串，可以在HTML和HTTP环境中轻松传递，同时与SAML等基于XML的标准相比更加紧凑。</p><p id="e2fe" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下面显示了一个JWT，它编码了前一个报头和有效载荷，并且用一个秘密进行了签名。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi of"><img src="../Images/425f7cf3416d82c8b22c6ced3f265a5a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*IHj2MJa1mc17bJu9.png"/></div></div></figure><p id="f4b0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你想玩玩JWT，把这些概念付诸实践，你可以使用<a class="ae kv" href="https://jwt.io/#debugger-io" rel="noopener ugc nofollow" target="_blank"> jwt.io调试器</a>来解码、验证和生成jwt。</p><p id="e20a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">JSON Web令牌是如何工作的？<br/></strong>JWT的生命周期/工作流程如下</p><ol class=""><li id="e3ce" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">生成JWT <br/>成功登录后，我们生成JWT并将其作为响应发送回去。这个令牌有一定的有效期。超过该时间后，令牌将不起作用</li><li id="99ce" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">获得令牌后，客户端必须将其存储在安全存储中。并且在每个进一步的请求中，它们必须将其作为授权头发送</li><li id="ba8d" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">在服务器端对于受限API服务器必须检查基于业务的令牌。如果令牌有效并且他们有权限，那么他们将获得访问该资源的权限。</li></ol><p id="f2a8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">每当用户想要访问受保护的路由或资源时，用户代理应该发送JWT，通常在使用<strong class="ky ir">承载</strong>模式的<strong class="ky ir">授权</strong>报头中。标题的内容应该如下所示:</p><pre class="kg kh ki kj gt ms mt mu mv aw mw bi"><span id="104b" class="mx my iq mt b gy mz na l nb nc">Authorization: Bearer &lt;token&gt;</span></pre><p id="24eb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果令牌是在<code class="fe og oh oi mt b">Authorization</code>报头中发送的，跨源资源共享(CORS)不会成为问题，因为它不使用cookies。</p><p id="7c03" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> JWT令牌过滤器工作流程</strong></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oj"><img src="../Images/1926a3c5f80a412818b6992ad40d7cca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LmZqmEECsMxtsTF-8lHGzg.png"/></div></div></figure><p id="54b9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下面是每个请求的流程:</p><ol class=""><li id="baa3" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">解析请求中的令牌。如果失败，则抛出禁止访问</li><li id="f0ef" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">使用secretKey作为签名密钥和令牌作为声明来验证令牌。如果验证失败，则抛出</li><li id="c8fe" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">然后，我们从用户表中验证<em class="mh">用户</em>，并使用<em class="mh">用户名</em>验证<em class="mh">用户详细信息</em>投影。如果失败，那么抛出。</li><li id="4318" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">在这个阶段之后，我们通知spring安全上下文这个角色签名。</li></ol><p id="02c8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下面给出了相关的代码</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div></figure></div><div class="ab cl mj mk hu ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="ij ik il im in"><p id="7967" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> 5。spring security和JWT <br/> </strong>的实际实现在我们的实现中，我们添加了下面的API作为示例。在这里，您必须遵循以下步骤</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ok"><img src="../Images/d7537cefd2ce77f12dbe9aa09b24cb64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q_ZTpsGhCD1AU4I0jW4h2g.png"/></div></div></figure><ol class=""><li id="976e" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated"><strong class="ky ir">用户注册(公共API) </strong></li></ol><p id="7d05" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这里，通常你可以使用用户名、密码和电子邮件地址注册。在这里，您有两个角色:<strong class="ky ir"> <em class="mh">角色_管理员</em> </strong> <em class="mh">和</em> <strong class="ky ir"> <em class="mh">角色_客户端<br/> </em> </strong>请求和响应如下</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="59d4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> 2。会员登录(公共API) <br/> POST API <br/> </strong>正常情况下需要输入用户名和密码才能登录。作为回应，您将获得一个JWT令牌作为访问令牌。请求和响应如下所示</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="4792" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> 3。访问受保护的资源[受保护的] </strong></p><ul class=""><li id="d026" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr mg ly lz ma bi translated">两种特权API <br/> 在这里，我们的存储库中有一个管理员和客户端特权API。在这里，只有两个特权登录用户可以查看。未登录的用户将得到一个403错误。其请求和响应如下</li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div></figure><ul class=""><li id="4115" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr mg ly lz ma bi translated"><strong class="ky ir">管理员特权API <br/> </strong>这里，我们的存储库中有一个管理员特权API。在这里，只有管理员特权登录用户可以查看。非登录用户或非管理员特权用户将得到一个403错误。其请求和响应如下</li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div></figure></div><div class="ab cl mj mk hu ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="ij ik il im in"><p id="bc69" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">6。源代码描述<br/> 所有的源代码都在<a class="ae kv" href="https://github.com/mesuk/SpringReadyApp" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir">这个GitHub </strong> </a>库中。<br/> <strong class="ky ir">控制器名称</strong>:SecureUserController<br/><strong class="ky ir">服务名称</strong>:SecureUserService<br/><strong class="ky ir">仓库名称</strong> : SecureUserRepository，JwtTokenProviderService，MyUserDetailsService</p><p id="7741" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> Swagger网址</strong>:<a class="ae kv" href="http://localhost:8080/springreadyapp/swagger-ui.html#/" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir">http://localhost:8080/springreadyapp/Swagger-ui . html #/secureuser controller</strong></a></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ol"><img src="../Images/958f9460100e126adad6564c4445f739.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G-VCn3sMf2cFrffjOt7LxA.png"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi om"><img src="../Images/5a9415508215dcec4407479f7cf2d1f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xG-ckgVBuLXBHIVHgiLd7A.png"/></div></div></figure><p id="44d5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">提前感谢:)</p></div></div>    
</body>
</html>