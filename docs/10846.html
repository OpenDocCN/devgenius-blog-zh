<html>
<head>
<title>Multi Indexes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">多索引</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/multi-indexes-7cc6c396d77e?source=collection_archive---------18-----------------------#2022-12-03">https://blog.devgenius.io/multi-indexes-7cc6c396d77e?source=collection_archive---------18-----------------------#2022-12-03</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><h2 id="72d5" class="il im in bd b dl io ip iq ir is it dk iu translated" aria-label="kicker paragraph">引用</h2><div class=""/><div class=""><h2 id="b27d" class="pw-subtitle-paragraph jt iw in bd b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk dk translated"><em class="kl">摘自鲁文·勒纳的</em> <a class="ae km" href="https://www.manning.com/books/pandas-workout?utm_source=medium&amp;utm_medium=referral&amp;utm_campaign=book_lerner2_pandas_8_3_21" rel="noopener ugc nofollow" target="_blank"> <em class="kl">熊猫健身</em> </a> <em class="kl"/></h2></div><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="gh gi kn"><img src="../Images/01b99a8912d3731a3d7116ab4f67c10e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4uSkr2BItbyKGATvbHvOHw.jpeg"/></div></div><figcaption class="kz la gj gh gi lb lc bd b be z dk translated"><a class="ae km" href="https://unsplash.com/@m_____me?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> m. </a>在<a class="ae km" href="https://unsplash.com/s/photos/index?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</figcaption></figure><p id="6183" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated"><em class="lz">本文讨论在熊猫中使用多指标。</em></p></div><div class="ab cl ma mb hr mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="ig ih ii ij ik"><p id="1001" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">在<a class="ae km" href="https://www.manning.com/books/pandas-workout?utm_source=medium&amp;utm_medium=referral&amp;utm_campaign=book_lerner2_pandas_8_3_21" rel="noopener ugc nofollow" target="_blank">manning.com</a>的结账处，将<strong class="lf ix"> fcclerner2 </strong>输入折扣代码框，即可享受<em class="lz"> </em> <a class="ae km" href="https://www.manning.com/books/pandas-workout?utm_source=medium&amp;utm_medium=referral&amp;utm_campaign=book_lerner2_pandas_8_3_21" rel="noopener ugc nofollow" target="_blank"> <em class="lz">熊猫健身</em> </a>七五折优惠。</p></div><div class="ab cl ma mb hr mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="ig ih ii ij ik"><h2 id="6270" class="mh mi in bd mj mk ml dn mm mn mo dp mp lm mq mr ms lq mt mu mv lu mw mx my it bi translated"><strong class="ak">陈述 SAT 成绩(学习目标:设置和使用多指标)</strong></h2><p id="a5bf" class="pw-post-body-paragraph ld le in lf b lg mz jx li lj na ka ll lm nb lo lp lq nc ls lt lu nd lw lx ly ig bi translated">设置索引可以让我们更容易地创建关于数据的查询。但有时我们的数据本质上是分层的。这就是“多指数”概念发挥作用的地方。使用多索引，您不仅可以将索引设置为单个列，还可以设置为多个列。例如，设想一个包含销售数据的数据框:您可能希望按年份细分销售，然后再按地区细分。一旦你使用“进一步分解”这个短语，多指数几乎肯定是一个好主意。</p><p id="1a5d" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">在这篇文章中，我们将查看 SAT(美国广泛使用的标准化大学入学考试)的分数汇总，并与考生的大学平均绩点(也称为 GPA，4.0 是最高分)进行比较——尽管我们暂时忽略 GPA。CSV 文件(<code class="fe ne nf ng nh b">sat-scores.csv</code>)有 99 列和 577 行，描述了美国所有 50 个州和三个非州(波多黎各、维尔京群岛和 DC 华盛顿州)，从 2005 年到 2015 年。</p><p id="8fe2" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">在本练习中，我希望您:</p><ul class=""><li id="8ce1" class="ni nj in lf b lg lh lj lk lm nk lq nl lu nm ly nn no np nq bi translated">读入成绩文件，只保留<code class="fe ne nf ng nh b">Year</code>、<code class="fe ne nf ng nh b">State.Code</code>、<code class="fe ne nf ng nh b">Total.Math</code>、<code class="fe ne nf ng nh b">Total.Test-takers</code>、<code class="fe ne nf ng nh b">Total.Verbal</code>列。</li><li id="d005" class="ni nj in lf b lg nr lj ns lm nt lq nu lu nv ly nn no np nq bi translated">基于年份和两个字母的州代码创建多索引。</li><li id="597b" class="ni nj in lf b lg nr lj ns lm nt lq nu lu nv ly nn no np nq bi translated">2005 年总共有多少人参加了 SAT 考试？</li><li id="e91f" class="ni nj in lf b lg nr lj ns lm nt lq nu lu nv ly nn no np nq bi translated">纽约州(<code class="fe ne nf ng nh b">NY</code>)、新泽西州(<code class="fe ne nf ng nh b">NJ</code>)、马萨诸塞州(<code class="fe ne nf ng nh b">MA</code>)和伊利诺伊州(<code class="fe ne nf ng nh b">IL</code>)2010 年 SAT 数学平均成绩是多少？</li><li id="53a1" class="ni nj in lf b lg nr lj ns lm nt lq nu lu nv ly nn no np nq bi translated">亚利桑那州(<code class="fe ne nf ng nh b">AZ</code>)、加利福尼亚州(<code class="fe ne nf ng nh b">CA</code>)和得克萨斯州(<code class="fe ne nf ng nh b">TX</code>)2012 年至 2015 年的 SAT 平均成绩是多少？</li></ul><h2 id="8f05" class="mh mi in bd mj mk ml dn mm mn mo dp mp lm mq mr ms lq mt mu mv lu mw mx my it bi translated">讨论</h2><p id="adad" class="pw-post-body-paragraph ld le in lf b lg mz jx li lj na ka ll lm nb lo lp lq nc ls lt lu nd lw lx ly ig bi translated">本文将展示多索引的强大功能和灵活性。首先，您需要加载一个 CSV 文件并创建一个基于“年份”和“州”的多索引。代码”列。我们可以分两个阶段完成这项工作，首先将文件(包括我们需要的列)读入数据帧，然后选择两列作为我们的索引:</p><pre class="ko kp kq kr gt nw nh nx ny aw nz bi"><span id="5066" class="mh mi in nh b gy oa ob l oc od">filename = '../data/sat-scores.csv'<br/>  <br/> df = pd.read_csv(filename,<br/>                 usecols=['Year', 'State.Code', 'Total.Math', 'Total.Test-takers', 'Total.Verbal'])<br/> df = df.set_index(['Year', 'State.Code'])</span></pre><p id="abaa" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">注意，和往常一样，<code class="fe ne nf ng nh b">set_index</code>的结果是一个新的数据帧，我们将它赋回给<code class="fe ne nf ng nh b">df</code>。</p><p id="5deb" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">然而，您可能记得<code class="fe ne nf ng nh b">read_csv</code>也有一个<code class="fe ne nf ng nh b">index_col</code>参数。如果我们将一个参数传递给那个参数，那么我们可以告诉<code class="fe ne nf ng nh b">read_csv</code>在一个步骤中完成所有的工作——读入数据帧，并将索引设置为我们请求的列。然而，我们可以将一列列表作为参数传递给<code class="fe ne nf ng nh b">index_col</code>，从而在收集数据帧时创建多索引。例如:</p><pre class="ko kp kq kr gt nw nh nx ny aw nz bi"><span id="aaa3" class="mh mi in nh b gy oa ob l oc od">filename = '../data/sat-scores.csv'<br/>  <br/> df = pd.read_csv(filename,<br/>                 usecols=['Year', 'State.Code', 'Total.Math', 'Total.Test-takers', 'Total.Verbal'],<br/>                 index_col=['Year', 'State.Code'])</span></pre><p id="5b5a" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">现在我们已经加载了数据框，我们可以开始研究数据并回答一些问题。</p><p id="072a" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">首先，我想知道 2010 年四个州——纽约、新泽西、马萨诸塞州和伊利诺伊州——学生的平均数学成绩。像往常一样，我们希望使用<code class="fe ne nf ng nh b">loc</code>来检索我们感兴趣的数据。但是我们需要结合三件事来创建正确的查询:</p><ul class=""><li id="67ab" class="ni nj in lf b lg lh lj lk lm nk lq nl lu nm ly nn no np nq bi translated">从多指数的第一部分(<code class="fe ne nf ng nh b">Year</code>)来看，我们只要 2010 年。</li><li id="e3bc" class="ni nj in lf b lg nr lj ns lm nt lq nu lu nv ly nn no np nq bi translated">从多指标的第二部分(<code class="fe ne nf ng nh b">State.Code</code>)我们只要<code class="fe ne nf ng nh b">NY</code>、<code class="fe ne nf ng nh b">NJ</code>、<code class="fe ne nf ng nh b">MA</code>、<code class="fe ne nf ng nh b">IL</code>。</li><li id="ae9c" class="ni nj in lf b lg nr lj ns lm nt lq nu lu nv ly nn no np nq bi translated">从栏目来看，我们感兴趣的是<code class="fe ne nf ng nh b">Total.Math</code>。</li></ul><p id="0194" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">请记住，当我们从多索引中检索时，我们需要将各个部分放在一个元组中。此外，我们可以通过使用列表来表明我们想要多个值。结果是:</p><pre class="ko kp kq kr gt nw nh nx ny aw nz bi"><span id="a141" class="mh mi in nh b gy oa ob l oc od">df.loc[(2010, ['NY', 'NJ', 'MA', 'IL']), 'Total.Math'].mean()</span></pre><p id="af22" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">上面的查询检索 2010 年的行，并且来自这四个州中的任何一个。我们只得到<code class="fe ne nf ng nh b">Total.Math</code>列，然后在其上计算平均值。</p><p id="57ea" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">下一个问题要求类似的计算，但是是几年，以及几个州。同样，如果我们仔细考虑如何构造查询，这不是问题:</p><ul class=""><li id="837c" class="ni nj in lf b lg lh lj lk lm nk lq nl lu nm ly nn no np nq bi translated">从多指数的第一部分(<code class="fe ne nf ng nh b">Year</code>)我们要的是 2012 年，2013 年，2014 年，2015 年。</li><li id="10d4" class="ni nj in lf b lg nr lj ns lm nt lq nu lu nv ly nn no np nq bi translated">从多指标的第二部分(<code class="fe ne nf ng nh b">State.Code</code>)，我们要<code class="fe ne nf ng nh b">AZ</code>、<code class="fe ne nf ng nh b">CA</code>、<code class="fe ne nf ng nh b">TX</code>。</li><li id="69cb" class="ni nj in lf b lg nr lj ns lm nt lq nu lu nv ly nn no np nq bi translated">从专栏中，我们再次对<code class="fe ne nf ng nh b">Total.Math</code>感兴趣。</li></ul><p id="f0c1" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">然后，查询变成:</p><pre class="ko kp kq kr gt nw nh nx ny aw nz bi"><span id="57c6" class="mh mi in nh b gy oa ob l oc od">df.loc[([2012,2013,2014,2015], ['AZ', 'CA', 'TX']), 'Total.Math'].mean()</span></pre><p id="fcc7" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">请注意<code class="fe ne nf ng nh b">pandas</code>是如何计算出如何组合我们的多索引的各个部分的，这样我们只得到匹配两个部分的行。</p><h2 id="c27a" class="mh mi in bd mj mk ml dn mm mn mo dp mp lm mq mr ms lq mt mu mv lu mw mx my it bi translated">解决办法</h2><pre class="ko kp kq kr gt nw nh nx ny aw nz bi"><span id="3b2e" class="mh mi in nh b gy oa ob l oc od">filename = '../data/sat-scores.csv'<br/>  <br/> df = pd.read_csv(filename,<br/>                 usecols=['Year', 'State.Code', 'Total.Math', 'Total.Test-takers', 'Total.Verbal'])<br/>  <br/> df = df.set_index(['Year', 'State.Code']) ❶<br/> df.loc[2005, 'Total.Test-takers'].sum() ❷<br/> df.loc[(2010, ['NY', 'NJ', 'MA', 'IL']), 'Total.Math'].mean() ❸<br/> df.loc[([2012,2013,2014,2015], ['AZ', 'CA', 'TX']), 'Total.Math'].mean()❹</span></pre><p id="21e5" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">❶将指数设为<code class="fe ne nf ng nh b">Year</code>和<code class="fe ne nf ng nh b">State.code</code>的组合</p><p id="dff1" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">❷检索包含 2005 的行和列<code class="fe ne nf ng nh b">Total.Test-takers</code>，然后对这些值求和</p><p id="0759" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">❸检索 2010 年和这四个州中任何一个州的行，以及列<code class="fe ne nf ng nh b">Total.Math</code>，然后得到平均值</p><p id="3101" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">❹检索 2012-2015 年这三个州的行和列<code class="fe ne nf ng nh b">Total.Math</code>，然后获得平均值</p><h2 id="6670" class="mh mi in bd mj mk ml dn mm mn mo dp mp lm mq mr ms lq mt mu mv lu mw mx my it bi translated">超越练习</h2><ul class=""><li id="9b9d" class="ni nj in lf b lg mz lj na lm oe lq of lu og ly nn no np nq bi translated">佛罗里达州、印第安纳州和爱达荷州历年的平均数学和语言成绩是多少？(你没有按州来划分这些值。)</li><li id="16c7" class="ni nj in lf b lg nr lj ns lm nt lq nu lu nv ly nn no np nq bi translated">哪一个州获得了最高的口语分数，在哪一年？</li><li id="b719" class="ni nj in lf b lg nr lj ns lm nt lq nu lu nv ly nn no np nq bi translated">2005 年的数学平均分比 2015 年高还是低？</li></ul><h2 id="6b32" class="mh mi in bd mj mk ml dn mm mn mo dp mp lm mq mr ms lq mt mu mv lu mw mx my it bi translated"><strong class="ak">按索引排序</strong></h2><p id="c5d4" class="pw-post-body-paragraph ld le in lf b lg mz jx li lj na ka ll lm nb lo lp lq nc ls lt lu nd lw lx ly ig bi translated">当我们在<code class="fe ne nf ng nh b">pandas</code>中谈论数据排序时，我们通常指的是数据排序。例如，我可能希望数据框中的行按价格或地区销售代码排序。</p><p id="9cb2" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">但是<code class="fe ne nf ng nh b">pandas</code>让我们以一种额外的方式对数据帧进行排序:基于索引值。我们可以使用方法<code class="fe ne nf ng nh b">sort_index</code>来实现这一点，像许多其他方法一样，该方法返回一个具有相同内容的新数据框，但是它的行是基于索引值排序的。我们可以这样说:</p><pre class="ko kp kq kr gt nw nh nx ny aw nz bi"><span id="e2c9" class="mh mi in nh b gy oa ob l oc od">df = df.sort_index()</span></pre><p id="4b9e" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">如果您的数据框包含多索引，那么排序将首先沿着第一级排序，然后沿着第二级排序，依此类推。</p><p id="9c4e" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">除了一些美学上的好处之外，按索引对数据框进行排序可以使某些任务变得更容易，甚至是可能的。例如，如果你试图选择一片行，<code class="fe ne nf ng nh b">pandas</code>坚持索引将被排序，以避免歧义。</p><p id="87e7" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">如果数据框未排序且具有多索引，则执行某些操作可能会导致警告:</p><pre class="ko kp kq kr gt nw nh nx ny aw nz bi"><span id="0a8d" class="mh mi in nh b gy oa ob l oc od">PerformanceWarning: indexing past lexsort depth may impact performance</span></pre><p id="5367" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">这是<code class="fe ne nf ng nh b">pandas</code>试图告诉你，大尺寸、多索引和无序索引的组合可能会给你带来麻烦。您可以通过索引对数据框进行排序来避免该警告。</p><p id="ba95" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">如果要检查数据框是否已排序，可检查此属性:</p><pre class="ko kp kq kr gt nw nh nx ny aw nz bi"><span id="84d8" class="mh mi in nh b gy oa ob l oc od">df.index.is_monotonic_increasing</span></pre><p id="1243" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">注意，这是<strong class="lf ix">而不是</strong>一个方法，而是一个布尔值。还要注意，一些老的文档和博客提到了方法<code class="fe ne nf ng nh b">is_lexsorted</code>，在<code class="fe ne nf ng nh b">pandas</code>的最新版本中已经被弃用；你应该使用<code class="fe ne nf ng nh b">is_monotonic_increasing</code>。</p><p id="6f0e" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">本文到此为止。如果你想了解更多，请点击这里查看这本书。</p></div></div>    
</body>
</html>