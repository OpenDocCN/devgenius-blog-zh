<html>
<head>
<title>Simple authN and authZ on Kafka for Users</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用户在 Kafka 上的简单 authN 和 authZ</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/simple-authn-and-authz-on-kafka-for-users-a557066a097c?source=collection_archive---------9-----------------------#2022-01-17">https://blog.devgenius.io/simple-authn-and-authz-on-kafka-for-users-a557066a097c?source=collection_archive---------9-----------------------#2022-01-17</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="09d9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><a class="ae ki" rel="noopener ugc nofollow" target="_blank" href="/apache-kafka-on-kubernetes-using-strimzi-27d47b6b13bc">在之前的文章</a>中，我们使用<a class="ae ki" href="https://strimzi.io/" rel="noopener ugc nofollow" target="_blank"> Strimzi </a>创建了一个简单的<a class="ae ki" href="https://kafka.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache Kafka </a>集群。该群集没有应用任何身份验证或授权。这在本地开发环境中是可以的，但在生产环境中是不可接受的。</p><p id="29d2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">安全性可以以多种方式应用:</p><ul class=""><li id="8e87" class="kj kk in jm b jn jo jr js jv kl jz km kd kn kh ko kp kq kr bi translated">基础架构层—通过实施网络策略、入口规则、相互 TLS 等</li><li id="302f" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated">应用层—使用相互 TLS、oauth、SCRAM 等</li></ul><blockquote class="kx ky kz"><p id="f98d" class="jk jl la jm b jn jo jp jq jr js jt ju lb jw jx jy lc ka kb kc ld ke kf kg kh ig bi translated">相互 TLS 兼具基础设施和应用层安全性。它提供了非常强大的安全性，但是如果没有合适的解决方案，可能会有很大的运营开销。</p></blockquote><p id="31f3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">Strimzi 提供了各种保护 Kafka 集群的方法。</p><p id="385c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">认证</strong>:</p><ul class=""><li id="2d5b" class="kj kk in jm b jn jo jr js jv kl jz km kd kn kh ko kp kq kr bi translated">相互 TLS</li><li id="337e" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated">急停-SHA-512</li><li id="c79e" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated">OAUTH 2.0 令牌</li></ul><p id="23a2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">授权</strong>:</p><ul class=""><li id="a29f" class="kj kk in jm b jn jo jr js jv kl jz km kd kn kh ko kp kq kr bi translated">简单授权</li><li id="0c8c" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated">OAUTH 2.0 基于令牌的授权</li><li id="ec51" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated">开放策略代理</li><li id="f1d0" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated">自定义授权</li></ul><blockquote class="kx ky kz"><p id="88e8" class="jk jl la jm b jn jo jp jq jr js jt ju lb jw jx jy lc ka kb kc ld ke kf kg kh ig bi translated">OPA 是 CNCF 孵化项目，是非常强大的政策引擎。它在基于 Kubernetes 和不基于 Kubernetes 的环境中都变得非常流行。将来，我会写一篇关于使用 Strimzi 在 Kafka 中启用 OPA 的文章。</p></blockquote><p id="4c7b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在本文中，我们将介绍以下安全访问 Kafka 集群的机制</p><ul class=""><li id="a5df" class="kj kk in jm b jn jo jr js jv kl jz km kd kn kh ko kp kq kr bi translated">认证—使用紧急停堆 SHA-512</li><li id="1b2e" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated">授权—简单授权</li></ul><p id="f0f4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">作为实施的一部分，我们希望实现几件事情:</p><ul class=""><li id="c09d" class="kj kk in jm b jn jo jr js jv kl jz km kd kn kh ko kp kq kr bi translated">制作人 app，姑且称之为<em class="la">核心 App </em>，写一个包含客户所有金融交易的话题<code class="fe le lf lg lh b">financial-transactions</code>。</li><li id="0dd4" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated">一个消费 app，姑且称之为<em class="la">通知 App </em>，可以从一个话题<code class="fe le lf lg lh b">financial-transactions</code>中读取。它使用这些数据，并向执行金融交易的帐户的所有者发送通知</li><li id="694b" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated"><em class="la">核心 App </em>也写入一个主题<code class="fe le lf lg lh b">tickets</code>，其中登记了客户所有人为联络中心团队提出的所有支持请求。</li><li id="459b" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated">一个消费者应用程序，姑且称之为<em class="la">联络中心应用程序</em>，观察主题<code class="fe le lf lg lh b">tickets</code>中的消息，并为运营人员启动工作流程。</li></ul><p id="d6e3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">银行系统是一个复杂的领域，会涉及到多种服务。然而，这里的目标是尽可能简单地解释安全模式。这里提到了一个非常简单的场景。</p><p id="c77f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们的建筑的鸟瞰图如下所示。</p><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi li"><img src="../Images/0472986c2350edacd13c7453a4062adb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9svKcOGPA1JMExIcHY8ySw.png"/></div></div><figcaption class="lu lv gj gh gi lw lx bd b be z dk translated">整体架构</figcaption></figure><p id="08ff" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">安全架构目标:</p><ul class=""><li id="c749" class="kj kk in jm b jn jo jr js jv kl jz km kd kn kh ko kp kq kr bi translated">仅允许核心应用发布到主题<code class="fe le lf lg lh b">financial-transactions</code></li><li id="01d8" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated">仅允许核心应用发布到主题<code class="fe le lf lg lh b">tickets</code></li><li id="2e3b" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated">只有通知应用程序才允许阅读主题<code class="fe le lf lg lh b">financial-transactions</code></li><li id="8607" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated">仅允许联络中心 App 读取主题<code class="fe le lf lg lh b">tickets</code></li><li id="db71" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated">核心 App 的系统用户为<code class="fe le lf lg lh b">core-app-usr-1</code></li><li id="e3e6" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated">通知 App 的系统用户为<code class="fe le lf lg lh b">notification-app-usr-1</code></li><li id="f37c" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated">联络中心 App 的系统用户为<code class="fe le lf lg lh b">contact-centre-usr-1</code></li></ul><p id="3ff6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">作为本文的一部分，我将假设您具备以下条件:</p><ul class=""><li id="9c32" class="kj kk in jm b jn jo jr js jv kl jz km kd kn kh ko kp kq kr bi translated">安全的 Kubernetes 集群</li><li id="b297" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated">簇中的 Strimzi 算子</li><li id="e520" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated">到集群的连接</li></ul><p id="034c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">您可以阅读文章<a class="ae ki" rel="noopener ugc nofollow" target="_blank" href="/apache-kafka-on-kubernetes-using-strimzi-27d47b6b13bc">Apache Kafka on Kubernetes</a>并了解如何在 Kubernetes 集群上安装 Strimzi。本文中的示例代码依赖于该文章中的各种基础设施和应用程序组件以及指令。</p><blockquote class="kx ky kz"><p id="39fd" class="jk jl la jm b jn jo jp jq jr js jt ju lb jw jx jy lc ka kb kc ld ke kf kg kh ig bi translated"><strong class="jm io"> <em class="in">相关文章列表</em> </strong>:</p><p id="f2a0" class="jk jl la jm b jn jo jp jq jr js jt ju lb jw jx jy lc ka kb kc ld ke kf kg kh ig bi translated"><a class="ae ki" rel="noopener ugc nofollow" target="_blank" href="/apache-kafka-on-kubernetes-using-strimzi-27d47b6b13bc">第 1 部分——使用 Strimzi 的 Kubernetes 上的 Apache Kafka</a></p><p id="7dc8" class="jk jl la jm b jn jo jp jq jr js jt ju lb jw jx jy lc ka kb kc ld ke kf kg kh ig bi translated"><a class="ae ki" rel="noopener ugc nofollow" target="_blank" href="/simple-authn-and-authz-on-kafka-for-users-a557066a097c">第 2 部分—针对外部用户的 Kafka 上的简单 authN 和 authZ</a></p></blockquote></div><div class="ab cl ly lz hr ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="ig ih ii ij ik"><h1 id="7b80" class="mf mg in bd mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc bi translated">Strimzi 运算符管理的 Kafka 实例</h1><p id="79b2" class="pw-post-body-paragraph jk jl in jm b jn nd jp jq jr ne jt ju jv nf jx jy jz ng kb kc kd nh kf kg kh ig bi translated">我们将在专用名称空间<code class="fe le lf lg lh b">core-kafka-cluster</code>创建一个安全集群。</p><pre class="lj lk ll lm gt ni lh nj nk aw nl bi"><span id="900f" class="nm mg in lh b gy nn no l np nq">kubectl create namespace core-kafka-cluster</span></pre><p id="bae4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们假设 Strimzi 操作符安装在名称空间<code class="fe le lf lg lh b">strimzi</code>中。让我们创建角色绑定以允许管理 Kafka 集群。</p><p id="9773" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">绑定到集群角色<code class="fe le lf lg lh b">strimzi-cluster-operator-namespaced</code>:</p><pre class="lj lk ll lm gt ni lh nj nk aw nl bi"><span id="2ef2" class="nm mg in lh b gy nn no l np nq">cat &lt;&lt;EOF | kubectl create -n core-kafka-cluster -f - <br/>apiVersion: rbac.authorization.k8s.io/v1<br/>kind: RoleBinding<br/>metadata:<br/>  name: strimzi-cluster-operator<br/>  labels:<br/>    app: strimzi<br/>subjects:<br/>  - kind: ServiceAccount<br/>    name: strimzi-cluster-operator<br/>    namespace: strimzi<br/>roleRef:<br/>  kind: ClusterRole<br/>  name: strimzi-cluster-operator-namespaced<br/>  apiGroup: rbac.authorization.k8s.io<br/>EOF</span></pre><p id="d521" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">绑定到集群角色<code class="fe le lf lg lh b">strimzi-entity-operator</code>:</p><pre class="lj lk ll lm gt ni lh nj nk aw nl bi"><span id="0680" class="nm mg in lh b gy nn no l np nq">cat &lt;&lt;EOF | kubectl create -n core-kafka-cluster -f -<br/>apiVersion: rbac.authorization.k8s.io/v1<br/>kind: RoleBinding<br/>metadata:<br/>  name: strimzi-cluster-operator-entity-operator-delegation<br/>  labels:<br/>    app: strimzi<em class="la"><br/></em>subjects:<br/>  - kind: ServiceAccount<br/>    name: strimzi-cluster-operator<br/>    namespace: strimzi<br/>roleRef:<br/>  kind: ClusterRole<br/>  name: strimzi-entity-operator<br/>  apiGroup: rbac.authorization.k8s.io<br/>EOF</span></pre><p id="a6c2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在我们将创建操作符来管理名称空间<code class="fe le lf lg lh b">core-kafka-cluster</code>中的集群:</p><pre class="lj lk ll lm gt ni lh nj nk aw nl bi"><span id="3e5d" class="nm mg in lh b gy nn no l np nq">cat &lt;&lt;EOF | kubectl create -n strimzi -f - <br/>apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: strimzi-cluster-operator-core-kafka-cluster<br/>  labels:<br/>    app: strimzi<br/>spec:<br/>  replicas: 1<br/>  selector:<br/>    matchLabels:<br/>      name: strimzi-cluster-operator<br/>      strimzi.io/kind: cluster-operator<br/>  template:<br/>    metadata:<br/>      labels:<br/>        name: strimzi-cluster-operator<br/>        strimzi.io/kind: cluster-operator<br/>    spec:<br/>      serviceAccountName: strimzi-cluster-operator<br/>      volumes:<br/>        - name: strimzi-tmp<br/>          emptyDir:<br/>            medium: Memory<br/>            sizeLimit: 1Mi<br/>        - name: co-config-volume<br/>          configMap:<br/>            name: strimzi-cluster-operator<br/>      containers:<br/>        - name: strimzi-cluster-operator<br/>          image: quay.io/strimzi/operator:0.27.0<br/>          ports:<br/>            - containerPort: 8080<br/>              name: http<br/>          args:<br/>            - /opt/strimzi/bin/cluster_operator_run.sh<br/>          volumeMounts:<br/>            - name: strimzi-tmp<br/>              mountPath: /tmp<br/>            - name: co-config-volume<br/>              mountPath: /opt/strimzi/custom-config/<br/>          env:<br/>            - name: STRIMZI_NAMESPACE<br/>              value: core-kafka-cluster<br/>            - name: STRIMZI_FULL_RECONCILIATION_INTERVAL_MS<br/>              value: "120000"<br/>            - name: STRIMZI_OPERATION_TIMEOUT_MS<br/>              value: "300000"<br/>            - name: STRIMZI_DEFAULT_TLS_SIDECAR_ENTITY_OPERATOR_IMAGE<br/>              value: quay.io/strimzi/kafka:0.27.0-kafka-3.0.0<br/>            - name: STRIMZI_DEFAULT_KAFKA_EXPORTER_IMAGE<br/>              value: quay.io/strimzi/kafka:0.27.0-kafka-3.0.0<br/>            - name: STRIMZI_DEFAULT_CRUISE_CONTROL_IMAGE<br/>              value: quay.io/strimzi/kafka:0.27.0-kafka-3.0.0<br/>            - name: STRIMZI_DEFAULT_TLS_SIDECAR_CRUISE_CONTROL_IMAGE<br/>              value: quay.io/strimzi/kafka:0.27.0-kafka-3.0.0<br/>            - name: STRIMZI_KAFKA_IMAGES<br/>              value: |<br/>                2.8.0=quay.io/strimzi/kafka:0.27.0-kafka-3.0.0<br/>                2.8.1=quay.io/strimzi/kafka:0.27.0-kafka-3.0.0<br/>                3.0.0=quay.io/strimzi/kafka:0.27.0-kafka-3.0.0<br/>            - name: STRIMZI_KAFKA_CONNECT_IMAGES<br/>              value: |<br/>                2.8.0=quay.io/strimzi/kafka:0.27.0-kafka-3.0.0<br/>                2.8.1=quay.io/strimzi/kafka:0.27.0-kafka-3.0.0<br/>                3.0.0=quay.io/strimzi/kafka:0.27.0-kafka-3.0.0<br/>            - name: STRIMZI_KAFKA_MIRROR_MAKER_IMAGES<br/>              value: |<br/>                2.8.0=quay.io/strimzi/kafka:0.27.0-kafka-3.0.0<br/>                2.8.1=quay.io/strimzi/kafka:0.27.0-kafka-3.0.0<br/>                3.0.0=quay.io/strimzi/kafka:0.27.0-kafka-3.0.0<br/>            - name: STRIMZI_KAFKA_MIRROR_MAKER_2_IMAGES<br/>              value: |<br/>                2.8.0=quay.io/strimzi/kafka:0.27.0-kafka-3.0.0<br/>                2.8.1=quay.io/strimzi/kafka:0.27.0-kafka-3.0.0<br/>                3.0.0=quay.io/strimzi/kafka:0.27.0-kafka-3.0.0<br/>            - name: STRIMZI_DEFAULT_TOPIC_OPERATOR_IMAGE<br/>              value: quay.io/strimzi/operator:0.27.0<br/>            - name: STRIMZI_DEFAULT_USER_OPERATOR_IMAGE<br/>              value: quay.io/strimzi/operator:0.27.0<br/>            - name: STRIMZI_DEFAULT_KAFKA_INIT_IMAGE<br/>              value: quay.io/strimzi/operator:0.27.0<br/>            - name: STRIMZI_DEFAULT_KAFKA_BRIDGE_IMAGE<br/>              value: quay.io/strimzi/kafka-bridge:0.21.2<br/>            - name: STRIMZI_DEFAULT_JMXTRANS_IMAGE<br/>              value: quay.io/strimzi/jmxtrans:0.27.0<br/>            - name: STRIMZI_DEFAULT_KANIKO_EXECUTOR_IMAGE<br/>              value: quay.io/strimzi/kaniko-executor:0.27.0<br/>            - name: STRIMZI_DEFAULT_MAVEN_BUILDER<br/>              value: quay.io/strimzi/maven-builder:0.27.0<br/>            - name: STRIMZI_OPERATOR_NAMESPACE<br/>              valueFrom:<br/>                fieldRef:<br/>                  fieldPath: metadata.namespace<br/>            - name: STRIMZI_FEATURE_GATES<br/>              value: ""<br/>          livenessProbe:<br/>            httpGet:<br/>              path: /healthy<br/>              port: http<br/>            initialDelaySeconds: 10<br/>            periodSeconds: 30<br/>          readinessProbe:<br/>            httpGet:<br/>              path: /ready<br/>              port: http<br/>            initialDelaySeconds: 10<br/>            periodSeconds: 30<br/>          resources:<br/>            limits:<br/>              cpu: 1000m<br/>              memory: 384Mi<br/>            requests:<br/>              cpu: 200m<br/>              memory: 384Mi<br/>  strategy:<br/>    type: Recreate<br/>EOF</span></pre><p id="f716" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">操作员窗格成功运行后，我们将创建一个具有以下属性的 Kafka 集群:</p><ul class=""><li id="9370" class="kj kk in jm b jn jo jr js jv kl jz km kd kn kh ko kp kq kr bi translated">监听端口<code class="fe le lf lg lh b">9094</code>上的外部流量</li><li id="3d71" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated">使用<code class="fe le lf lg lh b">SCRAM-SHA-512</code>验证用户</li><li id="f753" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated">使用<code class="fe le lf lg lh b">Simple</code>授权策略</li><li id="74c3" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated">(对于本地开发人员)监听器类型为<code class="fe le lf lg lh b">nodeport</code></li></ul><pre class="lj lk ll lm gt ni lh nj nk aw nl bi"><span id="18b9" class="nm mg in lh b gy nn no l np nq">cat &lt;&lt;EOF | kubectl create -n core-kafka-cluster -f -<br/>apiVersion: kafka.strimzi.io/v1beta2<br/>kind: Kafka<br/>metadata:<br/>  name: kafka<br/>spec:<br/>  kafka:<br/>    version: 3.0.0<br/>    replicas: 3<br/>    listeners:<br/>      - name: plain<br/>        port: 9092<br/>        type: internal<br/>        tls: false<br/>      - name: tls<br/>        port: 9093<br/>        type: internal<br/>        tls: true<br/>        authentication:<br/>          type: tls<br/>      - name: external<br/>        port: 9094<br/>        type: nodeport # Listening on one of the K8s node<br/>        tls: false # TLS is disabled to keep example simple<br/>        authentication: <br/>           type: scram-sha-512 # Case sensitive declaration of authenitcation type<br/>    authorization:<br/>       type: simple # Instructing Kafka to use Simple authorization policies<br/>    storage:<br/>      type: ephemeral<br/>      volumes:<br/>      - id: 0<br/>        type: ephemeral<br/>        size: 1Gi<br/>        deleteClaim: false<br/>    config:<br/>      offsets.topic.replication.factor: 1<br/>      transaction.state.log.replication.factor: 1<br/>      transaction.state.log.min.isr: 1<br/>      default.replication.factor: 1<br/>      min.insync.replicas: 1<br/>  zookeeper:<br/>    replicas: 3<br/>    storage:<br/>      type: ephemeral<br/>      size: 1Gi<br/>      deleteClaim: false<br/>  entityOperator:<br/>    topicOperator: {}<br/>    userOperator: {}<br/>EOF</span></pre><p id="6c24" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们需要 Kafka 集群做好准备。一旦 Kafka 集群启动并运行，执行下面的命令来获得我们将需要的引导服务器列表。</p><pre class="lj lk ll lm gt ni lh nj nk aw nl bi"><span id="3bf4" class="nm mg in lh b gy nn no l np nq">kubectl -n core-kafka-cluster get kafkas.kafka.strimzi.io kafka -o jsonpath='{.status.listeners[?(@.type=="external")].bootstrapServers}'</span></pre><p id="158e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这将为您提供类似下面的输出，包含 Kafka 经纪人的列表:</p><pre class="lj lk ll lm gt ni lh nj nk aw nl bi"><span id="2445" class="nm mg in lh b gy nn no l np nq">192.168.64.22:30108,192.168.64.23:30108</span></pre><p id="4b1a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们将使用示例输出作为本文其余部分的代理列表。</p></div><div class="ab cl ly lz hr ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="ig ih ii ij ik"><h1 id="b18d" class="mf mg in bd mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc bi translated">保护主题</h1><h2 id="2425" class="nm mg in bd mh nr ns dn ml nt nu dp mp jv nv nw mt jz nx ny mx kd nz oa nb ob bi translated">创建主题</h2><p id="c9c4" class="pw-post-body-paragraph jk jl in jm b jn nd jp jq jr ne jt ju jv nf jx jy jz ng kb kc kd nh kf kg kh ig bi translated">让我们执行下面的命令来创建三个主题<code class="fe le lf lg lh b">financial-transactions</code>、<code class="fe le lf lg lh b">tickets</code>和<code class="fe le lf lg lh b">assets</code>。</p><pre class="lj lk ll lm gt ni lh nj nk aw nl bi"><span id="2981" class="nm mg in lh b gy nn no l np nq">cat &lt;&lt;EOF | kubectl create -n core-kafka-cluster -f -<br/>---<br/>apiVersion: kafka.strimzi.io/v1beta2<br/>kind: KafkaTopic<br/>metadata:<br/>  name: financial-transactions <br/>  labels:<br/>    strimzi.io/cluster: kafka<br/>spec:<br/>  partitions: 2<br/>  replicas: 1<br/>  config:<br/>    retention.ms: 900000<br/>    segment.bytes: 1073741824<br/>---<br/>apiVersion: kafka.strimzi.io/v1beta2<br/>kind: KafkaTopic<br/>metadata:<br/>  name: tickets <br/>  labels:<br/>    strimzi.io/cluster: kafka<br/>spec:<br/>  partitions: 2<br/>  replicas: 1<br/>  config:<br/>    retention.ms: 900000<br/>    segment.bytes: 1073741824<br/>---<br/>apiVersion: kafka.strimzi.io/v1beta2<br/>kind: KafkaTopic<br/>metadata:<br/>  name: assets <br/>  labels:<br/>    strimzi.io/cluster: kafka<br/>spec:<br/>  partitions: 2<br/>  replicas: 1<br/>  config:<br/>    retention.ms: 900000<br/>    segment.bytes: 1073741824<br/>---<br/>EOF</span></pre><h2 id="0175" class="nm mg in bd mh nr ns dn ml nt nu dp mp jv nv nw mt jz nx ny mx kd nz oa nb ob bi translated">为核心应用程序用户配置访问权限</h2><p id="8733" class="pw-post-body-paragraph jk jl in jm b jn nd jp jq jr ne jt ju jv nf jx jy jz ng kb kc kd nh kf kg kh ig bi translated">现在，我们将为核心应用程序创建一个用户，其安全目标如下:</p><ul class=""><li id="61b9" class="kj kk in jm b jn jo jr js jv kl jz km kd kn kh ko kp kq kr bi translated">可以写到题目<code class="fe le lf lg lh b">financial-transactions</code></li><li id="06e4" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated">可以写主题<code class="fe le lf lg lh b">tickets</code></li><li id="bc03" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated">我不能阅读这些题目中的任何一个</li><li id="746a" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated">应用程序的用户 id 为<code class="fe le lf lg lh b">core-app-usr-1</code></li></ul><pre class="lj lk ll lm gt ni lh nj nk aw nl bi"><span id="7d06" class="nm mg in lh b gy nn no l np nq">cat &lt;&lt;EOF | kubectl create -n core-kafka-cluster -f -<br/>apiVersion: kafka.strimzi.io/v1beta2<br/>kind: KafkaUser<br/>metadata:<br/>  name: core-app-usr-1 # Name of the user<br/>  labels:<br/>    strimzi.io/cluster: kafka # Name of the Kafka cluster<br/>spec:<br/>  authentication:<br/>    type: scram-sha-512<br/>  authorization:<br/>    type: simple  # Authorization policy, must match with whats defined during cluster creation<br/>    acls:<br/>      - resource:<br/>          type: topic # Type of Kafka resource<br/>          name: tickets # Name of the Kafka resource<br/>          patternType: literal # Matching rule<br/>        operation: Write # Permitted operation<br/>        type: allow # Always defaults to allow, optional field.<br/>      - resource:<br/>          type: topic<br/>          name: financial-transactions<br/>          patternType: literal<br/>        operation: Write<br/>EOF</span></pre><blockquote class="kx ky kz"><p id="4fd3" class="jk jl la jm b jn jo jp jq jr js jt ju lb jw jx jy lc ka kb kc ld ke kf kg kh ig bi translated">注意:您可以在<a class="ae ki" href="https://strimzi.io/docs/operators/latest/using.html#type-AclRule-reference" rel="noopener ugc nofollow" target="_blank">strim zi ACL rule schema reference</a>阅读更多关于支持的 ACL 规则的信息。</p></blockquote><h2 id="e1d2" class="nm mg in bd mh nr ns dn ml nt nu dp mp jv nv nw mt jz nx ny mx kd nz oa nb ob bi translated">配置通知应用程序的访问权限</h2><p id="7cc8" class="pw-post-body-paragraph jk jl in jm b jn nd jp jq jr ne jt ju jv nf jx jy jz ng kb kc kd nh kf kg kh ig bi translated">现在，我们将为通知应用程序创建 usr，其安全目标如下:</p><ul class=""><li id="0635" class="kj kk in jm b jn jo jr js jv kl jz km kd kn kh ko kp kq kr bi translated">可以从题目<code class="fe le lf lg lh b">financial-transactions</code>中阅读</li><li id="131d" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated">可以作为消费群体阅读<code class="fe le lf lg lh b">notification-app</code></li><li id="3f45" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated">应用程序的用户 id<code class="fe le lf lg lh b">notification-app-usr-1</code></li></ul><pre class="lj lk ll lm gt ni lh nj nk aw nl bi"><span id="56f5" class="nm mg in lh b gy nn no l np nq">cat &lt;&lt;EOF | kubectl create -n core-kafka-cluster -f -<br/>apiVersion: kafka.strimzi.io/v1beta2<br/>kind: KafkaUser<br/>metadata:<br/>  name: notification-app-usr-1 # The notification app user<br/>  labels:<br/>    strimzi.io/cluster: kafka<br/>spec:<br/>  authentication:<br/>    type: scram-sha-512<br/>  authorization:<br/>    type: simple<br/>    acls:<br/>      - resource:<br/>          type: topic<br/>          name: financial-transactions<br/>          patternType: literal<br/>        operation: Read<br/>      - resource:<br/>          type: group # Resource type is consumer group<br/>          name: notification-app # Name of the consumer group<br/>          patternType: literal # Exact matching of pattern<br/>        operation: Read<br/>EOF</span></pre><h2 id="df13" class="nm mg in bd mh nr ns dn ml nt nu dp mp jv nv nw mt jz nx ny mx kd nz oa nb ob bi translated">配置联系中心应用程序的访问权限</h2><p id="daf7" class="pw-post-body-paragraph jk jl in jm b jn nd jp jq jr ne jt ju jv nf jx jy jz ng kb kc kd nh kf kg kh ig bi translated">现在，我们将为联络中心应用程序创建用户，其安全目标如下:</p><ul class=""><li id="095f" class="kj kk in jm b jn jo jr js jv kl jz km kd kn kh ko kp kq kr bi translated">可以阅读题目<code class="fe le lf lg lh b">tickets</code></li><li id="756b" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated">可以解读为消费群体<code class="fe le lf lg lh b">contact-centre-app</code></li><li id="85f5" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated">应用程序的用户 id<code class="fe le lf lg lh b">contact-centre-app-usr-1</code></li></ul><pre class="lj lk ll lm gt ni lh nj nk aw nl bi"><span id="e588" class="nm mg in lh b gy nn no l np nq">cat &lt;&lt;EOF | kubectl create -n core-kafka-cluster -f -<br/>apiVersion: kafka.strimzi.io/v1beta2<br/>kind: KafkaUser<br/>metadata:<br/>  name: contact-centre-app-usr-1 # The contact centre app user<br/>  labels:<br/>    strimzi.io/cluster: kafka<br/>spec:<br/>  authentication:<br/>    type: scram-sha-512<br/>  authorization:<br/>    type: simple  <br/>    acls:<br/>      - resource:<br/>          type: topic<br/>          name: tickets<br/>          patternType: literal<br/>        operation: Read<br/>      - resource:<br/>          type: group <br/>          name: contact-centre-app<br/>          patternType: literal<br/>        operation: Read<br/>EOF</span></pre><h2 id="ccb7" class="nm mg in bd mh nr ns dn ml nt nu dp mp jv nv nw mt jz nx ny mx kd nz oa nb ob bi translated">用户访问信息</h2><p id="a716" class="pw-post-body-paragraph jk jl in jm b jn nd jp jq jr ne jt ju jv nf jx jy jz ng kb kc kd nh kf kg kh ig bi translated">如果在此阶段之前一切正常，那么您可以通过执行以下命令来查看在集群上创建的用户列表:</p><pre class="lj lk ll lm gt ni lh nj nk aw nl bi"><span id="cd9c" class="nm mg in lh b gy nn no l np nq">kubectl -n core-kafka-cluster  get kafkausers.kafka.strimzi.io</span></pre><p id="dcea" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">所有用户都应持有标题<code class="fe le lf lg lh b">READY</code>下的值<code class="fe le lf lg lh b">true</code>。</p><p id="cfc2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在 Strimzi 创建用户的过程中，它为每个用户生成认证秘密(即密码)和<a class="ae ki" href="https://en.wikipedia.org/wiki/Java_Authentication_and_Authorization_Service" rel="noopener ugc nofollow" target="_blank"> JAAS </a>令牌。安全配置存储在 Kubernetes 的秘密资源中，其中资源的名称与用户名相同。</p><p id="0088" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">执行以下命令为用户获取 JAAS 令牌<code class="fe le lf lg lh b">core-app-usr-1</code></p><pre class="lj lk ll lm gt ni lh nj nk aw nl bi"><span id="0832" class="nm mg in lh b gy nn no l np nq">kubectl -n core-kafka-cluster get secrets core-app-usr-1 -o jsonpath='{.data.sasl\.jaas\.config}'</span></pre><p id="61a7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这些将探测一个<code class="fe le lf lg lh b">base64</code>编码的 JAAS 令牌，如下所示:</p><pre class="lj lk ll lm gt ni lh nj nk aw nl bi"><span id="421b" class="nm mg in lh b gy nn no l np nq">b3JnLmFwYWNoZS5rYWZrYS5jb21tb24uc2VjdXJpdHkuc2NyYW0uU2NyYW1Mb2dpbk1vZHVsZSByZXF1aXJlZCB1c2VybmFtZT0iY29yZS1hcHAtdXNyLTEiIHBhc3N3b3JkPSJkVXlZU0d5SVZ4VXIiOw==</span></pre><p id="31fd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在与 Kafka 集群交互时，应用程序的用户将需要此令牌。可以通过执行以下命令来解码该值:</p><pre class="lj lk ll lm gt ni lh nj nk aw nl bi"><span id="4a55" class="nm mg in lh b gy nn no l np nq">echo -n b3JnLmFwYWNoZS5rYWZrYS5jb21tb24uc2VjdXJpdHkuc2NyYW0uU2NyYW1Mb2dpbk1vZHVsZSByZXF1aXJlZCB1c2VybmFtZT0iY29yZS1hcHAtdXNyLTEiIHBhc3N3b3JkPSJkVXlZU0d5SVZ4VXIiOw== | base64 -d</span></pre><p id="f7c0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">输出如下所示:</p><pre class="lj lk ll lm gt ni lh nj nk aw nl bi"><span id="2672" class="nm mg in lh b gy nn no l np nq">org.apache.kafka.common.security.scram.ScramLoginModule required username="core-app-usr-1" password="dUyYSGyIVxUr";</span></pre><blockquote class="kx ky kz"><p id="62cc" class="jk jl la jm b jn jo jp jq jr js jt ju lb jw jx jy lc ka kb kc ld ke kf kg kh ig bi translated">注意:在生产环境中，可以执行以下操作:</p><p id="f216" class="jk jl la jm b jn jo jp jq jr js jt ju lb jw jx jy lc ka kb kc ld ke kf kg kh ig bi translated">1.集群管理员或 Kafka 管理员读取秘密并安全地存储它们(比如说在<a class="ae ki" href="https://www.vaultproject.io" rel="noopener ugc nofollow" target="_blank"> Hashicorp Vault </a>)并将它们作为环境值注入到生产者/消费者应用中。</p><p id="f3e1" class="jk jl la jm b jn jo jp jq jr js jt ju lb jw jx jy lc ka kb kc ld ke kf kg kh ig bi translated">2.创建 Kubernetes ACL 策略(例如，使用<a class="ae ki" href="https://www.openpolicyagent.org" rel="noopener ugc nofollow" target="_blank"> OPA </a>和<a class="ae ki" href="https://open-policy-agent.github.io/gatekeeper/website/docs/" rel="noopener ugc nofollow" target="_blank"> Gatekeeper </a>)并使秘密对相同集群中的另一个名称空间中托管的生产者/消费者应用可用。</p><p id="7037" class="jk jl la jm b jn jo jp jq jr js jt ju lb jw jx jy lc ka kb kc ld ke kf kg kh ig bi translated">第二种方法没有操作开销，秘密永远不会离开平台。</p></blockquote></div><div class="ab cl ly lz hr ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="ig ih ii ij ik"><h1 id="47a9" class="mf mg in bd mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc bi translated">测试安全控制</h1><p id="f86b" class="pw-post-body-paragraph jk jl in jm b jn nd jp jq jr ne jt ju jv nf jx jy jz ng kb kc kd nh kf kg kh ig bi translated">我们将通过使用来自官方 Kafka 下载页面的 Kafka shell 脚本来测试所应用的安全性。</p><h2 id="392d" class="nm mg in bd mh nr ns dn ml nt nu dp mp jv nv nw mt jz nx ny mx kd nz oa nb ob bi translated">客户端配置文件</h2><p id="88f3" class="pw-post-body-paragraph jk jl in jm b jn nd jp jq jr ne jt ju jv nf jx jy jz ng kb kc kd nh kf kg kh ig bi translated">让我们为用户<code class="fe le lf lg lh b">core-app-usr-1</code>创建客户机配置。</p><pre class="lj lk ll lm gt ni lh nj nk aw nl bi"><span id="765d" class="nm mg in lh b gy nn no l np nq"># Create client config file<br/>cat &lt;&lt;EOF &gt; core-app-usr-1.properties <br/>sasl.jaas.config=org.apache.kafka.common.security.scram.ScramLoginModule required username="core-app-usr-1" password="dUyYSGyIVxUr";<br/>security.protocol=SASL_PLAINTEXT<br/>sasl.mechanism=SCRAM-SHA-512<br/>EOF</span></pre><p id="63ba" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">密钥<code class="fe le lf lg lh b">sasl.jaas.config</code>保存从 Kubernetes 秘密中提取的 JAAS 配置，该秘密在名称空间<code class="fe le lf lg lh b">core-kafka-cluster</code>中被命名为<code class="fe le lf lg lh b">core-app-usr-1</code>。</p><p id="389d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">对于用户<code class="fe le lf lg lh b">notification-app-usr-1</code>和<code class="fe le lf lg lh b">contact-centre-app-usr-1</code>，需要重复同样的操作。</p><p id="efa6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在我的 Linux 机器上运行的一个方便的命令是:</p><pre class="lj lk ll lm gt ni lh nj nk aw nl bi"><span id="3794" class="nm mg in lh b gy nn no l np nq">cat &lt;&lt;EOF &gt; core-app-usr-1.properties<br/>sasl.jaas.config=`kubectl -n core-kafka-cluster get secrets core-app-usr-1 -o jsonpath='{.data.sasl\.jaas\.config}' | base64 -d`<br/>security.protocol=SASL_PLAINTEXT<br/>sasl.mechanism=SCRAM-SHA-512<br/>EOF</span></pre><h2 id="8800" class="nm mg in bd mh nr ns dn ml nt nu dp mp jv nv nw mt jz nx ny mx kd nz oa nb ob bi translated">发布主题为“金融交易”的核心应用程序</h2><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi oc"><img src="../Images/892394ea441c68cde4575e2e02b4a58d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qE2Zy9Vl6E75MtYZMd4CAA.png"/></div></div></figure><p id="d968" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">核心 app 是制作人 app，会发布到两个话题。让我们在终端上执行下面的命令来连接并发布到主题<code class="fe le lf lg lh b">financial-transactions</code>:</p><pre class="lj lk ll lm gt ni lh nj nk aw nl bi"><span id="81b6" class="nm mg in lh b gy nn no l np nq">./bin/kafka-console-producer.sh --broker-list 192.168.64.22:30108,192.168.64.23:30108 --producer.config core-app-usr-1.properties --topic financial-transactions</span></pre><p id="1800" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">其中，` 192.168.64.22:30108，192.168.64.23:30108 '是卡夫卡经纪人列表。</p><p id="70f7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">您还可以执行这个更复杂的命令来动态获取代理列表:</p><pre class="lj lk ll lm gt ni lh nj nk aw nl bi"><span id="2960" class="nm mg in lh b gy nn no l np nq">./bin/kafka-console-producer.sh --broker-list `kubectl -n core-kafka-cluster get kafkas.kafka.strimzi.io kafka -o jsonpath='{.status.listeners[?(@.type=="external")].bootstrapServers}'` --producer.config core-app-usr-1.properties --topic financial-transactions</span></pre><p id="17f3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">一旦连接上，键入任意数量的消息到主题<code class="fe le lf lg lh b">financial-transactions</code>。</p><h2 id="aef6" class="nm mg in bd mh nr ns dn ml nt nu dp mp jv nv nw mt jz nx ny mx kd nz oa nb ob bi translated">发布为主题“票证”的核心应用程序</h2><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi oc"><img src="../Images/312ee5963dcf94b8c677c4d452b6df8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*up0M60Ykj8go4Vlf8U9CUQ.png"/></div></div></figure><p id="fa45" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在，在另一个终端中，让我们将核心应用程序用户连接到主题<code class="fe le lf lg lh b">tickets</code>:</p><pre class="lj lk ll lm gt ni lh nj nk aw nl bi"><span id="5f12" class="nm mg in lh b gy nn no l np nq">./bin/kafka-console-producer.sh --broker-list `kubectl -n core-kafka-cluster get kafkas.kafka.strimzi.io kafka -o jsonpath='{.status.listeners[?(@.type=="external")].bootstrapServers}'` --producer.config core-app-usr-1.properties --topic tickets</span></pre><p id="1797" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">一旦连接到主题，输入任意数量的消息。</p><h2 id="7a51" class="nm mg in bd mh nr ns dn ml nt nu dp mp jv nv nw mt jz nx ny mx kd nz oa nb ob bi translated">发布主题为“资产”的核心应用程序</h2><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi oc"><img src="../Images/d399a2126b4ed16b1407cfb154630e70.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FgbVtFbrhSYnyrNh-qEomw.png"/></div></div></figure><p id="8721" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在，在另一个终端中，让我们将核心应用程序用户连接到主题<code class="fe le lf lg lh b">assets</code>:</p><pre class="lj lk ll lm gt ni lh nj nk aw nl bi"><span id="9e68" class="nm mg in lh b gy nn no l np nq">./bin/kafka-console-producer.sh --broker-list `kubectl -n core-kafka-cluster get kafkas.kafka.strimzi.io kafka -o jsonpath='{.status.listeners[?(@.type=="external")].bootstrapServers}'` --producer.config core-app-usr-1.properties --topic assets</span></pre><p id="eb6d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">一旦连接到主题<code class="fe le lf lg lh b">assets</code>，输入消息。您会注意到下面的错误消息。</p><pre class="lj lk ll lm gt ni lh nj nk aw nl bi"><span id="fa29" class="nm mg in lh b gy nn no l np nq">ERROR [Producer clientId=console-producer] Topic authorization failed for topics [assets] (org.apache.kafka.clients.Metadata)</span></pre><p id="36c2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这里发生了什么？</p><p id="7871" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在创建用户<code class="fe le lf lg lh b">core-app-usr-1</code>时，我们授予它写主题<code class="fe le lf lg lh b">financial-transactions</code>和<code class="fe le lf lg lh b">tickets</code>的权限。但是主题<code class="fe le lf lg lh b">assets</code>没有规则。假设用户存在于 Kafka 上，它<em class="la">认证</em>用户，但是它<em class="la">不授权</em>用户。</p><p id="a6ab" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">因此，你可以看到，只有合法的应用程序可以发布到主题<code class="fe le lf lg lh b">assets</code>，即使他们有权访问集群。</p><h2 id="cd9d" class="nm mg in bd mh nr ns dn ml nt nu dp mp jv nv nw mt jz nx ny mx kd nz oa nb ob bi translated">从主题中作为通知应用程序阅读</h2><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi od"><img src="../Images/60f07eda2bd8c8cf791d0413ea52292f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aFvs6GW4K0SqrthUv5A3aw.png"/></div></div></figure><p id="bf6e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在让我们使用客户机配置文件<code class="fe le lf lg lh b">notification-app-usr-1.properties</code>作为消费者进行连接。</p><pre class="lj lk ll lm gt ni lh nj nk aw nl bi"><span id="eeb4" class="nm mg in lh b gy nn no l np nq">./bin/kafka-console-consumer.sh --bootstrap-server `kubectl -n core-kafka-cluster get kafkas.kafka.strimzi.io kafka -o jsonpath='{.status.listeners[?(@.type=="external")].bootstrapServers}'` --consumer.config notification-app-usr-1.properties --topic financial-transactions --from-beginning</span></pre><p id="94e6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">您将收到类似于下面的错误消息:</p><pre class="lj lk ll lm gt ni lh nj nk aw nl bi"><span id="5de2" class="nm mg in lh b gy nn no l np nq">ERROR Error processing message, terminating consumer process:  (kafka.tools.ConsoleConsumer$)<br/>org.apache.kafka.common.errors.GroupAuthorizationException: Not authorized to access group: console-consumer-78145</span></pre><p id="0ff4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">那么为什么会出现这个错误信息呢？</p><p id="2245" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">嗯，我们声明了一个策略，消费者应用程序用户<code class="fe le lf lg lh b">notification-app-usr-1</code>可以收听<code class="fe le lf lg lh b">financial-transactions</code>，但它只能在消费者组<code class="fe le lf lg lh b">notification-app</code>下连接时收听。当用户群信息在连接期间缺失时，Kafka 会创建一个动态用户群(在本例中为<code class="fe le lf lg lh b">console-consumer-78145</code>)，而我们的 Kafka 集群策略会拒绝它。</p><p id="1910" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">因此，让我们通过执行以下命令来修复它:</p><pre class="lj lk ll lm gt ni lh nj nk aw nl bi"><span id="bb1b" class="nm mg in lh b gy nn no l np nq">./bin/kafka-console-consumer.sh --bootstrap-server `kubectl -n core-kafka-cluster get kafkas.kafka.strimzi.io kafka -o jsonpath='{.status.listeners[?(@.type=="external")].bootstrapServers}'` --consumer.config notification-app-usr-1.properties --topic financial-transactions --from-beginning --group notification-app</span></pre><p id="bdaf" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在，您将在控制台上看到关于主题<code class="fe le lf lg lh b">financial-transactions</code>的所有消息。</p><blockquote class="kx ky kz"><p id="f2b0" class="jk jl la jm b jn jo jp jq jr js jt ju lb jw jx jy lc ka kb kc ld ke kf kg kh ig bi translated">本文中使用的主题的 TTL 是 15 分钟，所以消息可能已经自动过期。只需在与主题<code class="fe le lf lg lh b">financial-transactions</code>相关的生产者用户<code class="fe le lf lg lh b">core-app-usr-1</code>连接的控制台中输入额外信息。</p></blockquote><h2 id="65d1" class="nm mg in bd mh nr ns dn ml nt nu dp mp jv nv nw mt jz nx ny mx kd nz oa nb ob bi translated">主题阅读作为联络中心应用程序</h2><figure class="lj lk ll lm gt ln gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi od"><img src="../Images/255aa2289f905981da1a48b1ddff0fae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2dXz7NYhmjqYOyrn3zezQA.png"/></div></div></figure><p id="afb6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在让我们使用客户端配置文件<code class="fe le lf lg lh b">contact-centre-app-usr-1.properties</code>作为消费者进行连接。</p><pre class="lj lk ll lm gt ni lh nj nk aw nl bi"><span id="bc4f" class="nm mg in lh b gy nn no l np nq">./bin/kafka-console-consumer.sh --bootstrap-server `kubectl -n core-kafka-cluster get kafkas.kafka.strimzi.io kafka -o jsonpath='{.status.listeners[?(@.type=="external")].bootstrapServers}'` --consumer.config <!-- -->contact-centre-app-usr-1.properties<!-- --> --topic financial-transactions --from-beginning --group contact-centre-app</span></pre><p id="fb09" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">您将收到类似于下面的错误消息:</p><pre class="lj lk ll lm gt ni lh nj nk aw nl bi"><span id="ded2" class="nm mg in lh b gy nn no l np nq">ERROR [Consumer clientId=consumer-contact-centre-app-1, groupId=contact-centre-app] Topic authorization failed for topics [financial-transactions] (org.apache.kafka.clients.Metadata)</span></pre><p id="4dbb" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">那么为什么会出现这个错误信息呢？</p><p id="85a1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">嗯，在针对<code class="fe le lf lg lh b">contact-centre-usr-1</code>的 ACL 策略中，只允许作为消费者组<code class="fe le lf lg lh b">contact-centre-app</code>进行身份验证，并读取主题为<code class="fe le lf lg lh b">tickets</code>的消息。没有允许它读取主题<code class="fe le lf lg lh b">financial-transactions</code>的策略。</p><p id="61d3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">因此，让我们通过执行下面的命令使它从正确的主题中读取:</p><pre class="lj lk ll lm gt ni lh nj nk aw nl bi"><span id="3451" class="nm mg in lh b gy nn no l np nq">./bin/kafka-console-consumer.sh --bootstrap-server `kubectl -n core-kafka-cluster get kafkas.kafka.strimzi.io kafka -o jsonpath='{.status.listeners[?(@.type=="external")].bootstrapServers}'` --consumer.config <!-- -->contact-centre-app-usr-1.properties<!-- --> --topic tickets --from-beginning --group contact-centre-app</span></pre><p id="6d09" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在，您将在控制台上看到主题<code class="fe le lf lg lh b">tickets</code>的所有消息。</p></div><div class="ab cl ly lz hr ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="ig ih ii ij ik"><h1 id="15e7" class="mf mg in bd mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc bi translated">摘要</h1><p id="6434" class="pw-post-body-paragraph jk jl in jm b jn nd jp jq jr ne jt ju jv nf jx jy jz ng kb kc kd nh kf kg kh ig bi translated">瞧啊。您已经使用 authn/authz 策略作为代码 IaC 模拟了一个安全的 Kafka 集群。本文还展示了我们如何在所有 Kafka 资源中实施良好的实践，并在应用程序在不同环境之间移动时一致地定义跨不同环境的安全策略。全部通过 Strimzi 运算简化。</p></div></div>    
</body>
</html>