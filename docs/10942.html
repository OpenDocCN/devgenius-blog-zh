<html>
<head>
<title>Excelling at dbt: Jinja &amp; Macros for modular and cleaner SQL Queries — Part 1/2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">卓越的 dbt: Jinja &amp;用于模块化和更简洁的 SQL 查询的宏—第 1/2 部分</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/excelling-at-dbt-jinja-macros-for-modular-and-cleaner-sql-queries-part-1-2-55e29d4b29e2?source=collection_archive---------0-----------------------#2022-12-09">https://blog.devgenius.io/excelling-at-dbt-jinja-macros-for-modular-and-cleaner-sql-queries-part-1-2-55e29d4b29e2?source=collection_archive---------0-----------------------#2022-12-09</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="cf70" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">理解 Jinja 分隔符、变量、过滤器、注释和空白控制</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/6447055ce2d8142244c3dec24893d75b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7UT1tvK_lZN5TugFRhsBlQ.jpeg"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk translated">图片来自 Unsplash，作者 Shahadat Rahman</figcaption></figure><p id="bfb2" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">到目前为止，我们大多数在日常工作中使用编程语言的人，一定已经理解了在代码中拥有可重用函数的重要性，尤其是程序员。可重复使用的功能允许程序员:</p><ul class=""><li id="3d9c" class="lo lp in ku b kv kw ky kz lb lq lf lr lj ls ln lt lu lv lw bi translated">重用相同的代码来解决类似的问题。</li><li id="c2f5" class="lo lp in ku b kv lx ky ly lb lz lf ma lj mb ln lt lu lv lw bi translated">减少开发新解决方案或产品的时间。</li><li id="4a88" class="lo lp in ku b kv lx ky ly lb lz lf ma lj mb ln lt lu lv lw bi translated">促进工作各个方面的自动化，而不是重新发明轮子。</li></ul><p id="7123" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">然而，这不仅适用于我们在软件工程或计算机科学领域工作的朋友，也适用于我们正在与数据打交道的人，无论是数据分析师、数据工程师还是数据科学家。</p><p id="2ad0" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">对于大多数数据人员来说，SQL 是我们的面包和黄油。虽然 SQL 在从数据库中获取数据方面很棒，但它并不适合可重用性和共享能力，这有时会影响我们的生产率。</p><p id="7aec" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">我们举个例子。作为一名数据分析师，您经常花费太多时间反复编写聚合、连接、数据清理和指标的相同逻辑，这导致您没有足够的时间从数据中提取洞察力(这是您的主要任务！).由此可见，我们需要的不仅仅是 SQL 来提高我们的生产力。为了帮助我们获得更高的生产率(尤其是在编写 SQL 时)，我们可以将 SQL 查询与 Jinja 和宏结合起来。Jinja 和宏可以帮助我们实现 SQL 的可重用性。</p><p id="2365" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">在这篇文章和下一篇文章中，我将分享我对 Jinja &amp; Macros 的理解，并提供一些关于如何将它们与 SQL 和 dbt 结合使用的例子。为什么是 dbt？dbt 是一个围绕 SQL 和 Jinja 构建的数据转换工具，因此我认为展示如何在 dbt 中将 Jinja 和宏与 SQL 结合使用是一个好主意。这篇文章对那些渴望成为分析工程师的人也很有用。当您计划用 dbt 转换/建模和清理数据时，Jinja 和宏肯定会派上用场。</p><p id="c761" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">我将在示例中使用的数据集是从<a class="ae mc" href="https://datahub.io/" rel="noopener ugc nofollow" target="_blank"> datahub.io </a>中提取的足球统计数据。如果你想跟随例子，请阅读<a class="ae mc" href="https://medium.com/@baluramachandra90/extract-and-load-football-statistics-to-google-cloud-storage-bigquery-with-airflow-1a217227dbd1" rel="noopener">我以前的帖子，下载数据集</a>并安装 dbt。本文假设您对 SQL 和 dbt 有所了解。这篇文章的代码可以在我的 GitHub repo 上找到。</p></div><div class="ab cl md me hr mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="ig ih ii ij ik"><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi mk"><img src="../Images/3e04549b56213e6b017d03060d7f4699.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4FVmwkzyzVUac5YYl_pw1g.png"/></div></div></figure><h2 id="5b81" class="ml mm in bd mn mo mp dn mq mr ms dp mt lb mu mv mw lf mx my mz lj na nb nc nd bi translated">金贾</h2><p id="f9ab" class="pw-post-body-paragraph ks kt in ku b kv ne jo kx ky nf jr la lb ng ld le lf nh lh li lj ni ll lm ln ig bi translated">Jinja 是一种用 Python 编写的模板语言。它经常在 Python web 框架中用于定义和重用常见的 Python 代码片段。</p><p id="6ffc" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">但是我所说的模板语言是什么意思呢？如果你曾经收到如下营销文本，那么你可能已经看到了模板语言或者 Jinja 本身。</p><blockquote class="nj"><p id="ee9a" class="nk nl in bd nm nn no np nq nr ns ln dk translated">您好{ {您的名字}}，我们为您提供了一份工作。</p></blockquote><p id="7581" class="pw-post-body-paragraph ks kt in ku b kv nt jo kx ky nu jr la lb nv ld le lf nw lh li lj nx ll lm ln ig bi translated">Jinja 使我们能够执行跨语言操作(充当桥梁)，例如在 SQL 中使用 Python 函数。这允许我们向 SQL 查询中添加更多的<em class="ny"/>“动态性”，比如在 SQL 查询中使用 for 循环和变量。</p><p id="b235" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">在 dbt 中，Jinja 是其编译过程的主要部分。它允许 dbt 构建和理解您的数据模型之间的关系，测试您的 DAG 并正确地建模您的表和模式之间的关系。由于 dbt 依赖并理解 Jinja，所以我们可以在数据建模过程中采用 Jinja，使我们的代码更加强大、模块化和高效。在我们深入研究之前，让我们先了解一下 Jinja 中一些基本的语法交互。</p><h2 id="88bd" class="ml mm in bd mn mo mp dn mq mr ms dp mt lb mu mv mw lf mx my mz lj na nb nc nd bi translated">分隔符</h2><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi nz"><img src="../Images/80699b3da95c3a756e6abf6b51f7768f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QmriC9hEG0oZWLoUuX23zA.jpeg"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk translated">图片来自 Unspalsh，作者 Jorge Rosal</figcaption></figure><p id="c14e" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">Jinja 分隔符有三种基本形式:</p><ul class=""><li id="f9d2" class="lo lp in ku b kv kw ky kz lb lq lf lr lj ls ln lt lu lv lw bi translated">用于打印输出、引用变量和调用宏的表达式</li><li id="d114" class="lo lp in ku b kv lx ky ly lb lz lf ma lj mb ln lt lu lv lw bi translated"><code class="fe oa ob oc od b">{%....%}</code>为报表。通常用于定义控制流(for 循环和条件语句)和宏。</li><li id="6398" class="lo lp in ku b kv lx ky ly lb lz lf ma lj mb ln lt lu lv lw bi translated"><code class="fe oa ob oc od b">{#....#}</code>用于输出中未包含的注释。</li></ul><p id="2886" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">让我们更深入地研究 Jinja 可以为我们提供的一些基本组件/功能，以构建模块化和更简洁的 SQL 查询。</p><h2 id="52fd" class="ml mm in bd mn mo mp dn mq mr ms dp mt lb mu mv mw lf mx my mz lj na nb nc nd bi translated">变量、列表和字典</h2><p id="012f" class="pw-post-body-paragraph ks kt in ku b kv ne jo kx ky nf jr la lb ng ld le lf nh lh li lj ni ll lm ln ig bi translated">Jinja 支持使用基本的 Python 数据对象，比如变量、列表和字典。如果您正在使用 Python 进行开发，那么您可以与这些对象进行非常相似的交互。例如，可以通过索引访问列表值，通过键访问字典。</p><p id="8d31" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">为了创建变量、列表和字典，我们在 Jinja 块<code class="fe oa ob oc od b">{%....%}</code>中使用了<code class="fe oa ob oc od b">set</code>标签。在下面的例子中，我创建了两个变量<code class="fe oa ob oc od b">my_name</code>和<code class="fe oa ob oc od b">my_var</code>，最后我将这些模板组合在一起，得到一个字符串。我使用 Jinja <code class="fe oa ob oc od b">{{...}}</code>表达式块来引用和生成变量的输出。如果您在 dbt 中运行这些代码，您将得到如下所示的输出。</p><pre class="kd ke kf kg gt oe od of bn og oh bi"><span id="4569" class="oi mm in od b be oj ok l ol om">{% set my_name = "John" %}<br/>{% set my_food = "Ramen" %}<br/><br/>Hi, My name is {{ my_name }} and my favorite food is {{ my_food }}<br/><br/>Output:<br/>--&gt; Hi, My name is John and my favorite food is Ramen</span></pre><p id="0302" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">在 Jinja 中，我们可以像在 Python 中一样创建和访问列表和字典。</p><pre class="kd ke kf kg gt oe od of bn og oh bi"><span id="15b2" class="oi mm in od b be oj ok l ol om"># Create and access a list in Jinja<br/>{% set football_clubs = ['lazio', 'borrusia dortmund', 'olympique lyonnais', 'valencia', 'manchester united'] %}<br/><br/># Use {{ }} to reference the variable and generate the output/value of the variables<br/>{{ football_clubs[0] }}<br/>{{ football_clubs[1] }}<br/><br/>Output:<br/>--&gt; lazio<br/>--&gt; borrusia dortmund<br/><br/># Create and access a dictionary in Jinja<br/>{% set favorite_player = {'lazio':'alessandro nesta',<br/>                           'dortmund':'tomáš rosický',<br/>                           'lyon':'juninho pernambucano',<br/>                           'valencia':'pablo aimar',<br/>                           'manunited':'paul scholes'} <br/>%}<br/><br/>{{ favorite_player.lazio }}<br/>{{ favorite_player.lyon }}<br/><br/>Output:<br/>--&gt; alessandro nesta<br/>--&gt; juninho pernambucano</span></pre><p id="6e7c" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">让我们看一个如何在 SQL 查询中使用 list 的应用程序。在下面的例子中，我创建了一个列表<code class="fe oa ob oc od b">football_clubs</code>，并将其插入到<code class="fe oa ob oc od b">where</code>子句中，以获取表中与列表中的值相匹配的相关记录。在引擎盖下，dbt 将把<code class="fe oa ob oc od b">HomeTeam in {{ football_clubs[0], football_clubs[1] }}</code>编译成<code class="fe oa ob oc od b">HomeTeam in ('Man United','Liverpool)</code>。在这个例子中，你也可以看到我使用了另一个 Jinja 语法，一个用于<code class="fe oa ob oc od b">{{ source() }}</code>函数的表达式。<code class="fe oa ob oc od b">{{ source() }}</code>是一个内置的 Jinja 函数，用于创建数据源和数据模型之间的依赖关系。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi on"><img src="../Images/4fb825038d90d1d3a4c5769bba5374e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UF1FCer-AHUSq5DmzIj9Gw.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk translated">作者图片:dbt 的查询编译</figcaption></figure><pre class="kd ke kf kg gt oe od of bn og oh bi"><span id="a76f" class="oi mm in od b be oj ok l ol om">{% set football_clubs = ['Man United','Liverpool'] %}<br/><br/>select <br/>    HomeTeam as home_team, <br/>    count(*) as total_home_matches,<br/>    sum(case when FTR = 'H' then 1 else 0 end) as total_home_wins,<br/>    round(sum(case when FTR = 'H' then 1 else 0 end) / count(*),2)*100 as home_wins_pct<br/>from {{ source('staging', 'english-premier-league-table') }}<br/>where <br/>    season = 'season-1819'<br/>    and HomeTeam in {{ football_clubs[0], football_clubs[1] }}<br/>group by HomeTeam<br/><br/>Output:<br/><br/>| home_team  | total_home_matches | total_home_wins | home_wins_pct |<br/>|------------|--------------------|-----------------|---------------|<br/>| Man United | 19                 | 10              | 53            |<br/>| Liverpool  | 19                 | 17              | 89            |</span></pre><h2 id="ab6b" class="ml mm in bd mn mo mp dn mq mr ms dp mt lb mu mv mw lf mx my mz lj na nb nc nd bi translated">评论</h2><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi oo"><img src="../Images/6119d85b898993cc6a8673e18bcc3c2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j0tuyiwgInNHdJTWVEfrug.jpeg"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk translated">图片来自 Artur Shamsutdin</figcaption></figure><p id="65b2" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">注释是用来让你的代码更容易被你自己和其他人理解。它们还用于注释掉部分代码，以便进行调试。您可以在<code class="fe oa ob oc od b">{#....#}</code>块中编写注释，它们不会出现在您的输出或 dbt 中编译的 SQL 代码中。</p><pre class="kd ke kf kg gt oe od of bn og oh bi"><span id="8866" class="oi mm in od b be oj ok l ol om">{# You can write comments here, and it won't show up in compiled sql #}<br/><br/>{# note: commented-out code because we no longer use this<br/>    {% for user in users %}<br/>        ...<br/>    {% endfor %}<br/>#}</span></pre><h2 id="f328" class="ml mm in bd mn mo mp dn mq mr ms dp mt lb mu mv mw lf mx my mz lj na nb nc nd bi translated">过滤</h2><p id="40d3" class="pw-post-body-paragraph ks kt in ku b kv ne jo kx ky nf jr la lb ng ld le lf nh lh li lj ni ll lm ln ig bi translated">Jinja 还提供了一种使用过滤器来修改变量的方法。您可以在带有管道符号<code class="fe oa ob oc od b">|</code>的变量中使用过滤器。有关这方面的更多信息，您可以访问本<a class="ae mc" href="https://jinja.palletsprojects.com/en/3.1.x/templates/#list-of-builtin-filters" rel="noopener ugc nofollow" target="_blank">指南</a>。</p><pre class="kd ke kf kg gt oe od of bn og oh bi"><span id="9ded" class="oi mm in od b be oj ok l ol om">{% set my_club = ' man united' %}<br/><br/># replace: remove unwanted objects or strings.<br/>{{ my_club | replace('man','manchester') }}<br/><br/>Output:<br/>--&gt;  manchester united<br/>--------------------------------------------------------<br/><br/># trim: remove leading and trailing characters.<br/>{{ my_club | trim() }}<br/><br/>Output:<br/>--&gt; man united<br/>--------------------------------------------------------<br/><br/># title: return titlecased strings, words will start with uppercase letters and the rest will remain lowercase.<br/>{{ my_club | trim() }}<br/><br/>Output:<br/>--&gt; Man United<br/>--------------------------------------------------------<br/><br/># upper: return uppercased strings.<br/>{{ my_club | trim() }}<br/><br/>Output:<br/>--&gt; MAN UNITED<br/>--------------------------------------------------------<br/><br/># multiple filters<br/>{{ my_club | replace('man','manchester') | trim() | upper() }}<br/><br/>Output:<br/>--&gt; MANCHESTER UNITED</span></pre><h2 id="0fc4" class="ml mm in bd mn mo mp dn mq mr ms dp mt lb mu mv mw lf mx my mz lj na nb nc nd bi translated">空白控制</h2><p id="9eb3" class="pw-post-body-paragraph ks kt in ku b kv ne jo kx ky nf jr la lb ng ld le lf nh lh li lj ni ll lm ln ig bi translated">如果到目前为止您一直在跟踪这些代码，并且看到您在 dbt 中编译的代码有如下所示的空白，那么您需要空白控制。空白控制是我们在 Jinja 中用来移除块中的空白。添加一个减号(<code class="fe oa ob oc od b">-</code>)告诉 Jinja 去掉一个块前后的尾随空格和换行符。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi op"><img src="../Images/6e1f510856cb96d8a25789afd8d56488.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XiozB8xABskHqQKQfiufhQ.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk translated">作者图片:使用换行符编译查询</figcaption></figure><ul class=""><li id="4a1c" class="lo lp in ku b kv kw ky kz lb lq lf lr lj ls ln lt lu lv lw bi translated">在开始块的开头添加<code class="fe oa ob oc od b">{%-</code>将删除当前行和前一行之间的空白。在上面的例子中，它删除了<code class="fe oa ob oc od b">season</code>和<code class="fe oa ob oc od b">ManUnited_home_win_pct</code>之间的空白。</li><li id="5e50" class="lo lp in ku b kv lx ky ly lb lz lf ma lj mb ln lt lu lv lw bi translated">将<code class="fe oa ob oc od b">-%}</code>添加到开始块的末尾意味着当前行的上方将有一个空行。在上面的例子中，它删除了 for 循环中的前导空格。</li><li id="d650" class="lo lp in ku b kv lx ky ly lb lz lf ma lj mb ln lt lu lv lw bi translated">添加<code class="fe oa ob oc od b">{%-</code>和<code class="fe oa ob oc od b">-%}</code>将删除当前行前后的空白。</li></ul><p id="ec87" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">你可以尝试使用<a class="ae mc" href="http://jinja.quantprogramming.com/" rel="noopener ugc nofollow" target="_blank"> Jinja live parser </a>。</p></div><div class="ab cl md me hr mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="ig ih ii ij ik"><p id="ac31" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">这篇文章是下一篇文章的基础。在下一篇文章中，我将讨论更高级的话题，比如控制结构和宏。如果你有任何反馈，请随时写在评论区。我很感谢你花时间阅读这篇文章，并关注本系列的第二篇文章。谢谢你。</p><h2 id="9498" class="ml mm in bd mn mo mp dn mq mr ms dp mt lb mu mv mw lf mx my mz lj na nb nc nd bi translated">其他资源:</h2><ul class=""><li id="5068" class="lo lp in ku b kv ne ky nf lb oq lf or lj os ln lt lu lv lw bi translated">Przemek Rogala 的 Jinja2 教程。</li><li id="b27f" class="lo lp in ku b kv lx ky ly lb lz lf ma lj mb ln lt lu lv lw bi translated"><a class="ae mc" href="https://github.com/zsombor-flds/dbt-jinja-cheatsheet" rel="noopener ugc nofollow" target="_blank"> dbt +金佳小抄</a>。</li></ul><h2 id="0229" class="ml mm in bd mn mo mp dn mq mr ms dp mt lb mu mv mw lf mx my mz lj na nb nc nd bi translated">参考资料:</h2><ul class=""><li id="c39d" class="lo lp in ku b kv ne ky nf lb oq lf or lj os ln lt lu lv lw bi translated"><a class="ae mc" href="https://jinja.palletsprojects.com/en/3.1.x/templates/" rel="noopener ugc nofollow" target="_blank">金佳模板设计器文档</a>。</li><li id="c9b8" class="lo lp in ku b kv lx ky ly lb lz lf ma lj mb ln lt lu lv lw bi translated"><a class="ae mc" href="https://docs.getdbt.com/docs/build/jinja-macros" rel="noopener ugc nofollow" target="_blank">关于 Jinja &amp;宏</a>的 dbt 指南。</li></ul></div></div>    
</body>
</html>