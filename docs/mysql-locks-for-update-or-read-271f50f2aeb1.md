# MySQL 锁——用于更新还是读取？何时使用哪把锁？

> 原文：<https://blog.devgenius.io/mysql-locks-for-update-or-read-271f50f2aeb1?source=collection_archive---------0----------------------->

## 简单的解释，加上例子，即使是小孩也能理解。何时使用一个锁而不是另一个锁。

![](img/3e5497bdc383fd04ee2bbdd7fedbf5e8.png)

照片由[米切尔罗](https://unsplash.com/@mitchel3uo?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral)

您正在使用数据库锁吗？如果您的应用程序足够小，您可能不需要这样做。但是，一旦并发操作发生，事情就开始变得混乱，比如:

*   多次按下提交按钮，
*   并行运行的 cron 操作，
*   多个异步队列工作器，
*   来自支付提供商的多条 webhook 消息等…

如果您关心应用程序的数据完整性，您应该考虑使用数据库锁。哪个最好的问题是[在谷歌](https://www.google.com/search?q=mysql+lock+difference)上臭名昭著。

> 记住，没有事务，锁是不起作用的！若要成功锁定行，请先启动一个事务。

# MySQL 中的锁类型

MySQL InnoDb 表有两种类型的“锁定选择”操作。两者都做同样的事情—阻止行被更新，但方式不同:

*   `SELECT * FROM *user* WHERE *id* = 5 **LOCK IN SHARE MODE**`
*   `SELECT * FROM *user* WHERE *id* = 3 **FOR UPDATE**`

# 锁定共享模式

1.  防止其他进程在该行被锁定时更新它
2.  **允许在锁定时读取行**

> *当您**不打算更新**行，但它的状态在事务期间对其他对象很重要时，使用它*。

当您想要锁定一行以保护它的状态，但又不想完全出于性能原因而锁定它时，锁就很有用。

# 锁定更新

1.  防止其他进程在该行被锁定时更新它
2.  **防止其他人读取锁定的行**

> *当您**打算更新**行*并且您关心行的完整性时，使用它*。*

当您希望锁定一行以保护其状态，并且希望确保其值不会改变(在事务处理期间)时，锁非常有用。)

# 现实生活场景

了解如何在现实生活中使用这两种锁。您正在构建一个**在线礼宾服务** web 应用程序。

> 客户需要充值信用余额。客户可以要求服务，并为每个请求付费。

下面是一个简化的 Laravel 控制器操作，它存储服务请求并从客户的余额中扣除服务成本:

## 客户锁定背后的原因

假设客户有 100 美元的信用额度，所请求的服务花费 75 美元。

如果我们不为客户应用任何锁或使用“共享锁”，会发生什么？如果同时向该端点发出十个请求，所有请求都会成功！每个请求将同时读取用户行，具有相同的值。

在交易完成之前，无法从数据库中读取客户**的*锁定更新***。当它这样做时，余额是 25 美元，因此剩下的 9 个请求将失败。

## 服务锁背后的原因

该服务已被“锁定读取”，以在事务期间密封其状态。它**不能修改**、**但可以读取**！

它保证我们的员工不会在客户提出请求时删除服务或更改管理面板中的任何细节。

如果我们为更新使用*锁，其他事务**将无法读取服务行**；结果这会降低应用程序的速度。*

你喜欢这个出版物吗？够简单吗？请让我知道，并在评论中留言。你可以留下一两个掌声，这样我就可以有更多的时间写作。谢谢！