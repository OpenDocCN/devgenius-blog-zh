<html>
<head>
<title>Tips and Tricks for using Crontab on Linux</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在 Linux 上使用 Crontab 的技巧和诀窍</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/tips-and-tricks-for-using-crontab-on-linux-15d5ecb323e3?source=collection_archive---------4-----------------------#2021-11-29">https://blog.devgenius.io/tips-and-tricks-for-using-crontab-on-linux-15d5ecb323e3?source=collection_archive---------4-----------------------#2021-11-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/cf110d0e43d183e97a2afcb70e989538.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NZFzs-YbY2SYgocl"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae kc" href="https://unsplash.com/@towfiqu999999?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Towfiqu barb huya</a>拍摄的照片</figcaption></figure><p id="10f3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Crontab 确实很有用，但是也有一些问题。以下都是在 Ubuntu 服务器上完成的。在其他发行版上，结果可能会有所不同。</p><p id="0dbc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">设置 Cron 作业</strong></p><p id="61b8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">快跑吧</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="1503" class="lk ll iq lg b gy lm ln l lo lp">crontab -e</span></pre><p id="53cf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">文件将在默认编辑器中打开，第一个列表被注释掉。这些评论是有用的。我在这里复制了前几个:</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="cff9" class="lk ll iq lg b gy lm ln l lo lp"># Edit this file to introduce tasks to be run by cron.<br/>#<br/># Each task to run has to be defined through a single line<br/># indicating with different fields when the task will be run<br/># and what command to run for the task</span></pre><p id="f130" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您最终会添加一行，其格式类似于:</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="3a8b" class="lk ll iq lg b gy lm ln l lo lp">@hourly /home/tony/dev/website/utils/digOceanDynamicIp.sh</span></pre><p id="17ab" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是一个每小时运行一次的脚本。这个脚本更新我的服务器在 DigitalOceans DNS 上的公共 IP 地址(如果它改变了)。</p><h2 id="6d3e" class="lk ll iq bd lq lr ls dn lt lu lv dp lw ko lx ly lz ks ma mb mc kw md me mf mg bi translated"><strong class="ak">调度</strong></h2><p id="7d1f" class="pw-post-body-paragraph kd ke iq kf b kg mh ki kj kk mi km kn ko mj kq kr ks mk ku kv kw ml ky kz la ij bi translated">注意上面的<em class="mm"> @hourly </em>。这是一种简写的非标准格式。有很多简写选项，包括<em class="mm">@每年、@每年、@每月、@每周、@每天、@每小时、</em>和<em class="mm">@重新启动。</em></p><p id="fd98" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">调度的标准格式表示命令的调度，在要运行的命令之前有五个令牌。</p><p id="5e26" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，每小时的标准格式是:</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="c56c" class="lk ll iq lg b gy lm ln l lo lp">0 * * * *</span></pre><p id="7283" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">从技术上来说，这可以解释为“每小时、每天、每月的零时运行”。</p><p id="895c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">老实说，用<a class="ae kc" href="https://crontab.guru/" rel="noopener ugc nofollow" target="_blank"> Crontab Guru </a>就行了。太牛逼了。它将帮助您学习日程安排符号，并使您轻松设置所需的日程。</p><h2 id="6778" class="lk ll iq bd lq lr ls dn lt lu lv dp lw ko lx ly lz ks ma mb mc kw md me mf mg bi translated">为了 Sudo 特权</h2><p id="3f5d" class="pw-post-body-paragraph kd ke iq kf b kg mh ki kj kk mi km kn ko mj kq kr ks mk ku kv kw ml ky kz la ij bi translated">如果您的脚本需要<em class="mm"> sudo </em>权限，最好使用<em class="mm"> sudo </em> crontab，通过运行</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="41f3" class="lk ll iq lg b gy lm ln l lo lp">sudo crontab -e</span></pre><h1 id="7b2c" class="mn ll iq bd lq mo mp mq lt mr ms mt lw mu mv mw lz mx my mz mc na nb nc mf nd bi translated"><strong class="ak"> Crontab 输出</strong></h1><h2 id="b624" class="lk ll iq bd lq lr ls dn lt lu lv dp lw ko lx ly lz ks ma mb mc kw md me mf mg bi translated"><strong class="ak">脚本输出</strong></h2><p id="a7ab" class="pw-post-body-paragraph kd ke iq kf b kg mh ki kj kk mi km kn ko mj kq kr ks mk ku kv kw ml ky kz la ij bi translated">我经常喜欢使用 crontab 来安排 bash 脚本。脚本通常会将一些信息输出到标准输出中。</p><p id="ed80" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后在 crontab 中，可以将输出定向到日志文件。</p><p id="2ea6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">举个例子，</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="3d38" class="lk ll iq lg b gy lm ln l lo lp">30 4 * * * /home/tony/toSomethingUsefulAndPrintOutput.sh &gt; /home/tony/logs/outputOfUsefulThing.log</span></pre><p id="03c4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">将脚本输出到文件<em class="mm">/home/Tony/logs/outputofusefulthing . log</em></p><h2 id="f634" class="lk ll iq bd lq lr ls dn lt lu lv dp lw ko lx ly lz ks ma mb mc kw md me mf mg bi translated"><strong class="ak">命令输出</strong></h2><p id="8b02" class="pw-post-body-paragraph kd ke iq kf b kg mh ki kj kk mi km kn ko mj kq kr ks mk ku kv kw ml ky kz la ij bi translated">在默认安装中，cron 作业被记录到<em class="mm"> /var/log/syslog </em></p><p id="cef2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通过运行以下命令，您可以在该日志文件中只看到 cron 作业</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="1b9f" class="lk ll iq lg b gy lm ln l lo lp">grep CRON /var/log/syslog</span></pre><p id="7acf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可能会看到如下错误</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="3c14" class="lk ll iq lg b gy lm ln l lo lp">Sep 14 02:00:01 tonyserver CRON[2944396]: (CRON) info (No MTA installed, discarding output)</span></pre><p id="c655" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是因为 crontab 实际上试图发送每次运行的输出。我知道，这是很古老的学校。</p><p id="5c27" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Ubuntu Server 默认没有安装邮件客户端。</p><p id="c0a2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可以通过安装 postfix(或者您喜欢的其他邮件客户端)并将其配置为在本地保存文件来解决这个问题。</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="fe25" class="lk ll iq lg b gy lm ln l lo lp">sudo apt install postfix</span></pre><p id="6bcb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要在安装过程中使用带有 cron 的 postfix(如果您不想实际向外发送电子邮件),您应该回答配置为仅用于本地。这意味着不使用网络，邮件只是由邮件客户端保存在本地。</p><p id="ac57" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在 Ubuntu 服务器上，存储输出的位置最终是<em class="mm"> /var/mail/ &lt;用户&gt; </em></p><p id="29df" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">更多关于安装 postfix 的信息，请看<a class="ae kc" href="https://askubuntu.com/questions/222512/cron-info-no-mta-installed-discarding-output-error-in-the-syslog" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><h2 id="1b62" class="lk ll iq bd lq lr ls dn lt lu lv dp lw ko lx ly lz ks ma mb mc kw md me mf mg bi translated"><strong class="ak">测试</strong></h2><p id="9336" class="pw-post-body-paragraph kd ke iq kf b kg mh ki kj kk mi km kn ko mj kq kr ks mk ku kv kw ml ky kz la ij bi translated">设置完成后，您可以通过安排 cron 任务在接下来的几分钟内运行并跟踪日志来进行测试。如果你已经确保你的脚本是等幂的，那么测试就容易一些。</p><p id="51ae" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，只需使用调度字符串将其设置为每 2 分钟运行一次:</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="c6b3" class="lk ll iq lg b gy lm ln l lo lp">*/2 * * * *</span></pre><p id="8baf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">并在输出的日志后面加上</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="9af5" class="lk ll iq lg b gy lm ln l lo lp">sudo tail -f /var/mail/&lt;user&gt;</span></pre><h2 id="c6e3" class="lk ll iq bd lq lr ls dn lt lu lv dp lw ko lx ly lz ks ma mb mc kw md me mf mg bi translated"><strong class="ak">需要注意的额外问题</strong></h2><p id="0e41" class="pw-post-body-paragraph kd ke iq kf b kg mh ki kj kk mi km kn ko mj kq kr ks mk ku kv kw ml ky kz la ij bi translated"><strong class="kf ir">如果 cron 作业正在访问 GitHub </strong>并且您正在运行<em class="mm"> sudo </em> crontab，那么存储在非根用户路径中的 ssh 密钥将不起作用。需要为根用户创建一个新的密钥。</p><p id="a3c6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">奔跑</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="3dbc" class="lk ll iq lg b gy lm ln l lo lp">sudo ssh-keygen</span></pre><p id="e4dc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">并将生成的公钥存储在您的 Github 帐户中。</p><p id="827f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有关设置 ssh 密钥的更多信息，请参见<a class="ae kc" href="https://www.digitalocean.com/community/tutorials/how-to-set-up-ssh-keys-on-ubuntu-1604" rel="noopener ugc nofollow" target="_blank">https://www . digital ocean . com/community/tutorials/how-to-set-up-ssh-keys-on-Ubuntu-1604</a>。</p></div></div>    
</body>
</html>