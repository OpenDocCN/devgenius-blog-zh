<html>
<head>
<title>Lignum : distributed message queue</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Lignum:分布式消息队列</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/lignum-distributed-message-queue-403d38548dbe?source=collection_archive---------6-----------------------#2022-11-24">https://blog.devgenius.io/lignum-distributed-message-queue-403d38548dbe?source=collection_archive---------6-----------------------#2022-11-24</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="1ff0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在所有 WFH 模糊和孤立的情况下，我开始使用 Consul 研究分布式锁，这个简单的测试程序很快成为构建一个名为<a class="ae ki" href="https://github.com/NishanthSpShetty/lignum" rel="noopener ugc nofollow" target="_blank"> Lignum </a>的分布式消息队列的途径。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/d66922d7ee1fa352c65cf0f9d221d80e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p6OjQv7lpEg7P4h3IqQZKw.jpeg"/></div></div><figcaption class="kv kw gj gh gi kx ky bd b be z dk translated">木质概述</figcaption></figure><p id="5450" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这是一篇介绍 Lignum 消息队列的文章。</p></div><div class="ab cl kz la hr lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="ig ih ii ij ik"><p id="5d79" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">什么是分布式系统？</strong></p><p id="674a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">有许多定义，一个简单的谷歌搜索将导致多个答案。我可以把分布式系统定义为一个自治或独立的程序或系统的集合，它们朝着一个共同的目标努力。</p><p id="0a86" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">也就是说，多个系统通过各种通信手段联网在一起，为一个共同的目的服务。它可以是一个请求网页和一个提供网页的系统。对于最终用户来说，这些系统可能看起来像一个系统，但可能有数百个这样的系统，它们相互通信来完成任务。</p><p id="e004" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">什么是消息队列？</strong></p><p id="e9e2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">为其他服务提供队列数据结构的系统，用于按 FIFO 顺序读写消息。<br/>队列允许生产者服务写消息，消费者异步消费。生产者和消费者不需要知道对方。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/e8805c84218f766e562d26c0c9983ad9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5ZJzr7Loa3Ad7oxF1S-ILw.jpeg"/></div></div><figcaption class="kv kw gj gh gi kx ky bd b be z dk translated">信息排队</figcaption></figure><p id="b674" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">消息队列的两个基本特征是</p><ol class=""><li id="750c" class="lg lh in jm b jn jo jr js jv li jz lj kd lk kh ll lm ln lo bi translated">消息被发送到指定的缓冲区，这些被称为主题。我们从主题中产生和消费信息。</li><li id="eee5" class="lg lh in jm b jn lp jr lq jv lr jz ls kd lt kh ll lm ln lo bi translated">消息<br/>这是我们写给主题的真实消息，供其他人使用。</li></ol><p id="0040" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">比如:阿帕奇卡夫卡，RabbitMQ，芹菜。</p><p id="326a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">什么是分布式消息队列？</strong></p><p id="56b7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">当我们构建一个托管在多个节点中的消息队列时，这些节点共同工作，作为其他服务的单个实体。</p><p id="56c9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">将有多个存放用户消息的队列来提供</p><ol class=""><li id="a9e8" class="lg lh in jm b jn jo jr js jv li jz lj kd lk kh ll lm ln lo bi translated">可靠性和高可用性</li><li id="acbb" class="lg lh in jm b jn lp jr lq jv lr jz ls kd lt kh ll lm ln lo bi translated">容错</li><li id="f051" class="lg lh in jm b jn lp jr lq jv lr jz ls kd lt kh ll lm ln lo bi translated">表演</li><li id="4708" class="lg lh in jm b jn lp jr lq jv lr jz ls kd lt kh ll lm ln lo bi translated">与多个节点共享读取负载</li></ol></div><div class="ab cl kz la hr lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="ig ih ii ij ik"><p id="c4b2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">木质</strong></p><p id="f0ef" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><a class="ae ki" href="https://github.com/NishanthSpShetty/lignum" rel="noopener ugc nofollow" target="_blank"> Lignum </a>作为一个测试程序开始使用<a class="ae ki" href="https://developer.hashicorp.com/consul/docs/dynamic-app-config/sessions" rel="noopener ugc nofollow" target="_blank">consult session lock</a>学习分布式锁定，它开始转向消息队列，因为那时我正在研究 Kafka。<br/>这是围棋里写的。我开始的时候确实考虑了测试驱动开发，但是很快就变得一团糟。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi lu"><img src="../Images/0a3223fe69ad4a79331dc7e289aea8e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1340/format:webp/1*_xry6EEE9dLNkq1Bs2x9Pg.png"/></div><figcaption class="kv kw gj gh gi kx ky bd b be z dk translated">木质建筑</figcaption></figure><p id="f0be" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">Lignum 不是一个成熟的消息队列，它是一个正在开发的项目。你可以</p><ul class=""><li id="2731" class="lg lh in jm b jn jo jr js jv li jz lj kd lk kh lv lm ln lo bi translated">向主题发送消息</li><li id="0349" class="lg lh in jm b jn lp jr lq jv lr jz ls kd lt kh lv lm ln lo bi translated">消费来自主题的消息</li><li id="26ab" class="lg lh in jm b jn lp jr lq jv lr jz ls kd lt kh lv lm ln lo bi translated">消息被复制到所有节点，这意味着任何节点都可以用来从主题中读取消息</li><li id="6cdc" class="lg lh in jm b jn lp jr lq jv lr jz ls kd lt kh lv lm ln lo bi translated">将消息保留在磁盘上</li></ul><p id="7040" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">木质部群</strong></p><ul class=""><li id="32fd" class="lg lh in jm b jn jo jr js jv li jz lj kd lk kh lv lm ln lo bi translated">Lignum 可以在集群模式下运行，不需要任何特殊的设置</li><li id="39f1" class="lg lh in jm b jn lp jr lq jv lr jz ls kd lt kh lv lm ln lo bi translated">通过使用会话锁进行协商，可以简化集群管理</li><li id="fa9f" class="lg lh in jm b jn lp jr lq jv lr jz ls kd lt kh lv lm ln lo bi translated">每个节点将连接到 Consul 以获取领导者。如果没有发现领导者，其中一个节点将被选为领导者</li><li id="fd77" class="lg lh in jm b jn lp jr lq jv lr jz ls kd lt kh lv lm ln lo bi translated">所有其他节点将把自己注册为领导者的跟随者</li><li id="7123" class="lg lh in jm b jn lp jr lq jv lr jz ls kd lt kh lv lm ln lo bi translated">发送给领导者的消息将被复制到追随者节点</li><li id="4bc7" class="lg lh in jm b jn lp jr lq jv lr jz ls kd lt kh lv lm ln lo bi translated">它有两种复制模式<br/> a. WAL 复制<br/> b. Live 复制</li><li id="22ad" class="lg lh in jm b jn lp jr lq jv lr jz ls kd lt kh lv lm ln lo bi translated">如果领导者倒下了，任何一个追随者都会被选为领导者</li></ul><p id="e747" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">复制</strong></p><p id="d14b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">目前，lignum 实现了两种模式的复制策略。</p><ol class=""><li id="857d" class="lg lh in jm b jn jo jr js jv li jz lj kd lk kh ll lm ln lo bi translated">WAL 复制</li><li id="d377" class="lg lh in jm b jn lp jr lq jv lr jz ls kd lt kh ll lm ln lo bi translated">实时复制。</li></ol><p id="ccb6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">默认情况下，选择 WAL 复制。</p><p id="9655" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">沃尔复制</strong></p><p id="b4a2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">当消息溢出配置(<code class="fe lw lx ly lz b">message.initial-szie-per-topic</code>)中定义的缓冲区时，为每个主题创建日志文件。Lignum 为每个主题创建 WAL 文件(<code class="fe lw lx ly lz b">.qwal</code>)。当消息计数达到缓冲区时，这个文件作为<code class="fe lw lx ly lz b">log</code>文件被刷新到磁盘。Lignum 经常关注这些日志文件的创建并发送给追随者。所有跟随者定期与领导者同步，提供最终/延迟的一致性。</p><p id="d2fd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">实时复制</strong></p><p id="dfbf" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这是一个流复制，当追随者已经注册了领导者，我们不需要担心同步的消息，如果主题创建后。我们可以直接将领导者收到的消息转发给追随者。在这种策略中，消息会立即发送给注册的追随者。这种方式可以提供强大的一致性。</p><p id="cf32" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">如何运行 Lignum </strong></p><ul class=""><li id="80b6" class="lg lh in jm b jn jo jr js jv li jz lj kd lk kh lv lm ln lo bi translated">先决条件<br/> —咨询<br/>您可以使用<a class="ae ki" href="https://github.com/NishanthSpShetty/lignum#requirement" rel="noopener ugc nofollow" target="_blank">自述</a>中指定的 Dockerfile</li><li id="be62" class="lg lh in jm b jn lp jr lq jv lr jz ls kd lt kh lv lm ln lo bi translated">克隆存储库</li></ul><pre class="kk kl km kn gt ma lz mb bn mc md bi"><span id="e3e8" class="me mf in lz b be mg mh l mi mj">https://github.com/NishanthSpShetty/lignum.git</span></pre><ul class=""><li id="47d4" class="lg lh in jm b jn jo jr js jv li jz lj kd lk kh lv lm ln lo bi translated">建造它<code class="fe lw lx ly lz b">make build</code></li><li id="3560" class="lg lh in jm b jn lp jr lq jv lr jz ls kd lt kh lv lm ln lo bi translated">更新<code class="fe lw lx ly lz b">config.yml</code>，你可以参考<a class="ae ki" href="https://github.com/NishanthSpShetty/lignum/blob/master/doc/config.md" rel="noopener ugc nofollow" target="_blank">这份文件</a>了解更多关于配置的细节。</li><li id="3810" class="lg lh in jm b jn lp jr lq jv lr jz ls kd lt kh lv lm ln lo bi translated">运行<code class="fe lw lx ly lz b">make run</code></li></ul><p id="8efe" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这将运行单个节点，选举自己为领导者。你现在可以用它来写和读信息了。</p><ul class=""><li id="1458" class="lg lh in jm b jn jo jr js jv li jz lj kd lk kh lv lm ln lo bi translated">发送消息</li></ul><pre class="kk kl km kn gt ma lz mb bn mc md bi"><span id="83d1" class="me mf in lz b be mg mh l mi mj">curl --request POST \<br/>  --url http://localhost:8080/api/message \<br/>  --header 'Content-Type: application/json' \<br/>  --data '{<br/>   "topic": "test",<br/>   "message":"this is a test message"<br/>   }'</span></pre><ul class=""><li id="37a1" class="lg lh in jm b jn jo jr js jv li jz lj kd lk kh lv lm ln lo bi translated">阅读邮件</li></ul><pre class="kk kl km kn gt ma lz mb bn mc md bi"><span id="544b" class="me mf in lz b be mg mh l mi mj">curl --request GET \<br/>  --url http://localhost:8080/api/message \<br/>  --header 'Content-Type: application/json' \<br/>  --data '{<br/>   "topic": "test",<br/>   "from": 0,<br/>   "to": 3<br/>   }'</span></pre><blockquote class="mk ml mm"><p id="9488" class="jk jl mn jm b jn jo jp jq jr js jt ju mo jw jx jy mp ka kb kc mq ke kf kg kh ig bi translated">注意:lignum 不跟踪消费者，所以现在我们需要提供偏移量来读取消息。</p></blockquote><p id="d0fb" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">消息从偏移量 0 开始。在上述示例中，将从偏移量 0 到偏移量 2(即[0，3])提取消息。如果有，你会从系统得到 3 条信息。</p><p id="4d71" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">它提供什么样的交货保证？<br/>由于消息是持久的，消费者可以随时读取任何偏移量，因此交付保证由消费者负责。木质素保证了消息的有序性。</p></div><div class="ab cl kz la hr lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="ig ih ii ij ik"><p id="82e3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让我们向现有集群添加节点</p><ul class=""><li id="1cb2" class="lg lh in jm b jn jo jr js jv li jz lj kd lk kh lv lm ln lo bi translated">根据您的主机更改配置。</li><li id="6d31" class="lg lh in jm b jn lp jr lq jv lr jz ls kd lt kh lv lm ln lo bi translated">如果在与上次运行相同的主机上运行，则更改配置文件中的端口、数据目录和复制端口值。</li><li id="a7f9" class="lg lh in jm b jn lp jr lq jv lr jz ls kd lt kh lv lm ln lo bi translated">运行<code class="fe lw lx ly lz b">make run</code></li></ul><p id="f002" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这将引出另一个节点，向领导节点注册它自己。一旦注册了跟随者，leader 节点中出现的任何主题都将被复制，并带有 WAL 复制中解释的所有日志文件。现在，您也可以阅读来自 follower 节点的消息。</p><p id="04ca" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这是一篇关于木质素的简短介绍。我将在未来提出一个关于其内部和开发细节的单独文档。</p><p id="61bd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">代码在 Github : <a class="ae ki" href="https://github.com/NishanthSpShetty/lignum" rel="noopener ugc nofollow" target="_blank"> Lignum </a>。</p><p id="19e8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">结账并提供反馈，欢迎投稿。</p></div><div class="ab cl kz la hr lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="ig ih ii ij ik"><p id="2634" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">查看我的 Github 档案，了解我正在进行的其他精彩项目</p><div class="mr ms gp gr mt mu"><a href="https://github.com/NishanthSpShetty" rel="noopener  ugc nofollow" target="_blank"><div class="mv ab fo"><div class="mw ab mx cl cj my"><h2 class="bd io gy z fp mz fr fs na fu fw im bi translated">nishantspshetty-概述</h2><div class="nb l"><h3 class="bd b gy z fp mz fr fs na fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="nc l"><p class="bd b dl z fp mz fr fs na fu fw dk translated">github.com</p></div></div><div class="nd l"><div class="ne l nf ng nh nd ni kt mu"/></div></div></a></div><p id="2a04" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在 LinkedIn 上与我联系</p><p id="9f3f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><a class="ae ki" href="https://www.linkedin.com/in/nishanthspshetty/" rel="noopener ugc nofollow" target="_blank">https://www.linkedin.com/in/nishanthspshetty/</a></p></div></div>    
</body>
</html>