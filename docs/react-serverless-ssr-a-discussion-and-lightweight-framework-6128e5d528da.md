# React æ— æœåŠ¡å™¨ SSR:è®¨è®ºå’Œè½»é‡çº§æ¡†æ¶

> åŸæ–‡ï¼š<https://blog.devgenius.io/react-serverless-ssr-a-discussion-and-lightweight-framework-6128e5d528da?source=collection_archive---------9----------------------->

![](img/bd3daa7d39f5672189bb85b5f7b7c50f.png)

React åº”ç”¨ç¨‹åºçš„æœåŠ¡å™¨ç«¯æ¸²æŸ“(SSR)åœ¨è¿‡å»å‡ å¹´å˜å¾—è¶Šæ¥è¶Šæµè¡Œã€‚åƒ [Remix](https://remix.run/) å’Œ [Next.js](https://nextjs.org/) è¿™æ ·çš„æ¡†æ¶å·²ç»è¯æ˜äº†ç”¨ React åœ¨æœåŠ¡å™¨ä¸Šå‘ˆç°é¡µé¢æ˜¯ä¸€ç§æœ‰æ•ˆçš„ç¼–å†™åº”ç”¨ç¨‹åºçš„æ–¹å¼ã€‚

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†æ¢ç´¢å¦‚ä½•ä¸º React SSR å¼€å‘ä¸€ä¸ªçœŸæ­£æ— æœåŠ¡å™¨çš„**å®ç°ï¼Œå®ƒæä¾›:**

*   ğŸ“¦æ¯é¡µä¸€ä¸ªä¼˜åŒ–çš„ Lambda åŒ…
*   ğŸš€å®¢æˆ·ç«¯è„šæœ¬çš„æœ‰æ•ˆåˆ†å‘
*   ğŸ¦æ˜“äºå®šåˆ¶çš„è½»é‡çº§æ¡†æ¶

# tldr

è¦å¼€å§‹å®æ–½æ— æœåŠ¡å™¨ React SSR åº”ç”¨ç¨‹åºï¼Œæ¬¢è¿ä½¿ç”¨æˆ‘å‡†å¤‡çš„å¯å®šåˆ¶æ¨¡æ¿:

*   ğŸŒŸ [Goldstack æœåŠ¡å™¨ç«¯æ¸²æŸ“æ¨¡æ¿](https://goldstack.party/templates/server-side-rendering)

è¿™ä¸ªæ¨¡æ¿ä¹Ÿå¯ä»¥åœ¨ GitHub ä¸Šåˆ†å‰:

*   ğŸ´ [react-ssr](https://github.com/goldstack/react-ssr)

# ä¸€ç‚¹å†å²å’ŒåŠ¨åŠ›

è¯·éšæ„è·³è¿‡è¿™ä¸€éƒ¨åˆ†ï¼Œç›´æ¥å‘ä¸‹æ»šåŠ¨åˆ°ä»£ç ğŸ¤—ã€‚

è¿™ç¯‡æ–‡ç« æ˜¯å¤šå¹´åŠªåŠ›å’Œå®éªŒçš„ç§¯ç´¯ã€‚æˆ‘ä¸€ç›´åœ¨å¯»æ‰¾ä¸€ç§å¼€å‘ web åº”ç”¨ç¨‹åºçš„æ–¹æ³•ï¼Œè¿™ç§æ–¹æ³•å¯ä»¥äº§ç”Ÿæ¼‚äº®çš„ä»£ç (â€œæ˜“è¯»â€)å’Œæ¼‚äº®çš„åŸºç¡€è®¾æ–½(â€œä½æˆæœ¬ï¼Œæ˜“ç»´æŠ¤â€)ã€‚

æˆ‘å‘ç° [Next.js](https://nextjs.org/) éå¸¸æ¥è¿‘æˆ‘çš„ç†æƒ³ã€‚ç„¶è€Œï¼Œå®ƒåœ¨ä¸¤ä¸ªå…³é”®æ–¹é¢æœ‰æ‰€æ¬ ç¼º:1) Next.js å¼•å…¥äº†è®¸å¤šé­”æ³•ï¼Œä½¿å¾—æ·±åº¦å®šåˆ¶åº”ç”¨ç¨‹åºå˜å¾—å›°éš¾ã€‚2)éš¾ä»¥[å°† Next.js éƒ¨ç½²åˆ° AWS](https://maxrohde.com/2021/01/30/deploy-next-js-to-aws) ã€‚

åœ¨ Wordpress å›°æ‰°äº†æˆ‘å¤šå¹´ä¹‹åï¼Œæˆ‘çŠ¹è±«äº†å¾ˆä¹…ï¼Œå†³å®šå°†æˆ‘çš„åšå®¢[å¿«ä¹ä»£ç ](https://maxrohde.com)ä» Wordpress ä¸­ç§»èµ°ã€‚åœ¨æœç´¢äº†è®¸å¤šå¯ç”¨çš„é€‰é¡¹(åŒ…æ‹¬ä¸åŒçš„åšå®¢æ‰˜ç®¡å¹³å°å’Œé™æ€æ¸²æŸ“è§£å†³æ–¹æ¡ˆï¼Œå¦‚ [Gatsby](https://www.gatsbyjs.com/) )åï¼Œæˆ‘å†³å®šå¯¹æˆ‘æ¥è¯´æœ€å¥½çš„é€‰æ‹©æ˜¯å®ç°æˆ‘è‡ªå·±çš„å®šåˆ¶åšå®¢ã€‚

æˆ‘ä¸æ˜¯è½»æ˜“åšå‡ºè¿™ä¸ªå†³å®šçš„ã€‚æˆ‘æ€»æ˜¯å‘Šè¯‰è‡ªå·±ï¼Œä¿®æ”¹åšå®¢æœ¬èº«åªæ˜¯æˆ‘æ‹–å»¶å†™æ–‡ç« çš„ä¸€ç§æ–¹å¼ã€‚ç„¶è€Œï¼Œæˆ‘è®¤ä¸ºè¿™å¯¹æˆ‘è‡ªå·±æ¥è¯´å¯èƒ½æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ç¼–ç å®è·µï¼Œå¹¶å¸®åŠ©æˆ‘æ”¹è¿›æˆ‘çš„å¼€æºé¡¹ç›®ï¼Œå³ [Goldstack é¡¹ç›®æ„å»ºå™¨](https://goldstack.party)ã€‚

å½“æˆ‘å¼€å§‹æˆ‘çš„åšå®¢é¡¹ç›®æ—¶ï¼ŒGoldstack ä¸­æœ€é€‚åˆæˆ‘çš„æ¨¡æ¿æ˜¯ [Next.js æ¨¡æ¿](https://goldstack.party/templates/nextjs)ã€‚ç„¶è€Œï¼Œç”±äºä¸Šè¿°åŸå› ï¼Œæˆ‘è®¤ä¸ºä¸€ä¸ªæ–°çš„æ¨¡æ¿ä¼šæ›´å¥½åœ°æœåŠ¡äºä¸€ä¸ªåšå®¢ã€‚å…·ä½“æ¥è¯´ï¼Œä¸€ä¸ªæ¨¡æ¿å°†æ¯” Next.js æ›´å¥½åœ°æ”¯æŒ AWS ä¸Šçš„æœåŠ¡å™¨ç«¯å‘ˆç°(Next.js æ”¯æŒ Vercel éƒ¨ç½²ä¹‹å¤–çš„æœåŠ¡å™¨ç«¯å‘ˆç°ï¼Œä½†å®ƒéœ€è¦éƒ¨ç½²åœ¨ VM ä¸Šï¼Œä½œä¸º Docker æ˜ åƒæˆ–ä½œä¸ºæ‰€æœ‰ä»£ç æ†ç»‘åœ¨ä¸€ä¸ª Lambda ä¸­ï¼›æ‰€æœ‰ä¸å¤ªâ€œæ— æœåŠ¡å™¨â€çš„é€‰é¡¹)ã€‚

å› æ­¤ï¼Œå‡ ä¸ªæœˆå‰ï¼Œæˆ‘å¼€å§‹äº†å¼€å‘æœåŠ¡å™¨ç«¯æ¸²æŸ“å‹å¥½æ¨¡æ¿[çš„è¿‡ç¨‹ã€‚æˆ‘ä¸ä¹…å‰å‘å¸ƒäº†è¿™ä¸ªæ¨¡æ¿ï¼Œä¹‹åä¹Ÿå®Œæˆäº†æˆ‘åšå®¢æ–°ç‰ˆæœ¬çš„å®ç°ã€‚è¿™ç¯‡æ–‡ç« åŒ…å«äº†æˆ‘åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­çš„ç»éªŒå’Œæ”¶è·ã€‚](https://github.com/goldstack/goldstack/commit/ac13d13a915d225486ba42815aac3e7f2c153fbf)

# å®šä¹‰è·¯çº¿

æˆ‘å–œæ¬¢åœ¨ [Next.js](https://nextjs.org/docs/routing/introduction) ä¸­å®šä¹‰è·¯ç”±çš„æ–¹å¼:åªéœ€åœ¨ä¸“ç”¨ç›®å½•ä¸­åˆ›å»ºæ–‡ä»¶ï¼ŒNext.js å°±ä¼šè‡ªåŠ¨é…ç½®ä¸æ–‡ä»¶åå’Œè·¯å¾„åŒ¹é…çš„è·¯ç”±ã€‚

è®¸å¤šæ— æœåŠ¡å™¨æ¡†æ¶éœ€è¦é…ç½®å¤æ‚çš„ JSON æ–‡ä»¶ YAML æ¥å®šä¹‰è·¯ç”±ã€‚ç„¶è€Œï¼Œæˆ‘å¸Œæœ›ä¿æŒä¸ Next.js ä¸ºæˆ‘çš„æ— æœåŠ¡å™¨ SSR å®ç°æä¾›çš„ç›¸åŒæ°´å¹³çš„ä¾¿åˆ©æ€§ã€‚

å› æ­¤ï¼Œæˆ‘ä¸ºç”Ÿæˆè·¯çº¿å®šä¹‰äº†ä»¥ä¸‹è§„åˆ™:

*   **åŸºæœ¬è·¯ç”±**:æ–‡ä»¶åç§°ç”¨äºèµ„æºåç§°ã€‚ä¾‹å¦‚ï¼Œ`src/routes/page.tsx`å°†åœ¨`mypage.com/page`ä¸‹å¯ç”¨ã€‚
*   **å­æ–‡ä»¶å¤¹**:èµ„æºè·¯å¾„ä¸­å°†ä½¿ç”¨æ–‡ä»¶å¤¹åç§°ã€‚ä¾‹å¦‚ï¼Œ`src/routes/group/page.tsx`å°†åœ¨`mypage.com/group/page`ä¸‹æä¾›ã€‚
*   **ç´¢å¼•é¡µ**:ä¸ºäº†å®šä¹‰ä¸€ä¸ªæ–‡ä»¶å¤¹(æˆ–è€…ç½‘ç«™çš„æ ¹ç›®å½•)å†…åŒ¹é…`/`çš„è·¯å¾„ï¼Œå¯ä»¥å®šä¹‰ä¸€ä¸ªåä¸º`$index.tsx`çš„æºæ–‡ä»¶ã€‚ä¾‹å¦‚ï¼Œ`src/routes/group/$index.tsx`å°†åœ¨`api.com/group/`ä¸‹æä¾›ã€‚
*   **é»˜è®¤å›é€€**:è¦å®šä¹‰ä¸€ä¸ªåœ¨æ²¡æœ‰åŒ¹é…è·¯ç”±æ—¶è°ƒç”¨çš„å›é€€ï¼Œå®šä¹‰ä¸€ä¸ªåä¸º`$default.tsx`çš„æºæ–‡ä»¶ã€‚API ä¸­åº”è¯¥åªæœ‰ä¸€ä¸ª`$default.tsx`æ–‡ä»¶ã€‚è¿™å°†åŒ¹é…æ‰€æœ‰æœªè¢«å…¶ä»–è·¯ç”±è¦†ç›–çš„è·¯å¾„ã€‚
*   **è·¯å¾„å‚æ•°**:ä½¿ç”¨è¯­æ³•`{name}`æ”¯æŒè·¯å¾„ä¸­çš„å‚æ•°ã€‚ä¾‹å¦‚ï¼Œ`src/user/{name}.tsx`å°†ä½¿å‚æ•°`name`åœ¨ç«¯ç‚¹ä¸­å¯ç”¨ã€‚å‚æ•°ä¹Ÿæ”¯æŒä½œä¸ºæ–‡ä»¶å¤¹åç§°ã€‚
*   **è´ªå©ªè·¯å¾„**:å¦‚æœä¸€ä¸ªå‚æ•°è¦åŒ¹é…å¤šä¸ªèµ„æºçº§åˆ«ï¼Œå¯ä»¥å®šä¹‰å¦‚ä¸‹`{greedy+}`ã€‚ä¾‹å¦‚`src/group/{greedy+}.tsx`å°†åŒ¹é…`mypage.com/group/1`å’Œ`mypage.com/group/some/path`ä»¥åŠ`group/`ä¸‹çš„æ‰€æœ‰å…¶ä»–è·¯å¾„ã€‚

ä¸‹é¢æ˜¯æˆ‘ä¸ºæˆ‘çš„åšå®¢å®šä¹‰çš„æ‰€æœ‰[è·¯çº¿:](https://github.com/mxro/maxrohde-web/tree/blog-improvements/packages/web-maxrohde-com/src/routes)

![](img/857f01a69b65d90eaa292fed824544a7.png)

è¯·å‚è§ä¸‹é¢çš„*å®šä¹‰åŸºç¡€è®¾æ–½*éƒ¨åˆ†ï¼Œäº†è§£è¿™äº›è·¯ç”±å¦‚ä½•è¢«æŠ•å°„åˆ°æ— æœåŠ¡å™¨åŸºç¡€è®¾æ–½ä¸Šã€‚

# å®šä¹‰å¤„ç†ç¨‹åº

å®šä¹‰äº†æœåŠ¡å™¨åº”è¯¥è§£æçš„è·¯ç”±ä¹‹åï¼Œä¸‹ä¸€æ­¥æ˜¯å®šä¹‰æä¾›å“åº”çš„å®é™…å¤„ç†ç¨‹åºã€‚

å‚è§ä¸‹é¢ä¸€ä¸ªæ ·æœ¬å¤„ç†å™¨(`[posts.tsx](https://github.com/goldstack/react-ssr/blob/9fcbe5204697546ec2b5268b637b0012a582eb17/packages/server-side-rendering-1/src/routes/posts.tsx)`):

(è¿™åªæ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ç¤ºä¾‹é¡¹ç›®ä¸­çš„å¤„ç†ç¨‹åºï¼Œå¦‚æœæ‚¨å¯¹æˆ‘çš„åšå®¢ä¸­çš„å®é™…å¤„ç†ç¨‹åºæ„Ÿå…´è¶£ï¼Œè¯·å‚è§å‘ˆç°å¸–å­åˆ—è¡¨çš„`[$index.tsx](https://github.com/mxro/maxrohde-web/blob/618c563ae20a99c91ee0fa48102d784a34a594b2/packages/web-maxrohde-com/src/routes/%24index.tsx)`ã€‚)

è¿™é‡Œçš„å…³é”®æ˜¯ä½¿ç”¨åŠ©æ‰‹æ–¹æ³•`renderPage`æ‰§è¡ŒæœåŠ¡å™¨ç«¯æ¸²æŸ“çš„`handler`æ–¹æ³•ï¼Œä»¥åŠç¡®ä¿é¡µé¢åœ¨å®¢æˆ·ç«¯æ­£ç¡®åˆå§‹åŒ–çš„`hydrate(Posts);`è¯­å¥ã€‚

è¯·æ³¨æ„ï¼Œè¿™äº›å¤„ç†ç¨‹åºæ—¢æ”¯æŒæœåŠ¡å™¨ç«¯å‘ˆç°ï¼Œä¹Ÿæ”¯æŒå®šä¹‰å®¢æˆ·ç«¯äº¤äº’æ€§ã€‚

å¦‚æœæ‚¨éœ€è¦ä»»ä½•ç‰¹å®šçš„ä»…æœåŠ¡å™¨ç«¯ npm ä¾èµ–é¡¹ï¼Œå»ºè®®åˆ›å»ºç¬¬äºŒä¸ªæºæ–‡ä»¶ï¼Œå¹¶åœ¨é‚£é‡Œå®šä¹‰ä¸€ä¸ªåœ¨`handler`æ–¹æ³•ä¸­è°ƒç”¨çš„æ–¹æ³•ã€‚

(è¿™æ˜¯ä¸Šé¢æåˆ°çš„`$index.tsx`æ–‡ä»¶æ‰€éœ€è¦çš„ï¼Œè¯¥æ–‡ä»¶éœ€è¦å¯¹ DynamoDB è¿›è¡Œä¸€äº›æŸ¥è¯¢ï¼Œå‚è§`[renderIndex.ts](https://github.com/mxro/maxrohde-web/blob/618c563ae20a99c91ee0fa48102d784a34a594b2/packages/web-maxrohde-com/src/ssr/renderIndex.ts)`ã€‚)

ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`[esbuild-ignore-with-comments-plugin](https://www.npmjs.com/package/esbuild-ignore-with-comments-plugin)`é€šè¿‡åœ¨æºæ–‡ä»¶çš„å¼€å¤´æ”¾ç½®æ³¨é‡Š`/* esbuild-ignore ui */`æ¥ç¡®ä¿å®¢æˆ·ç«¯ç»‘å®šæœŸé—´ä¸åŒ…å«ä»»ä½•ä¾èµ–é¡¹ã€‚

ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥å°†è„šæœ¬å®šä¹‰å¦‚ä¸‹(`src/server/render.ts`):

ç„¶ååœ¨å¤„ç†ç¨‹åºä¸­å¯¼å…¥è¿™ä¸ªå‘ˆç°å‡½æ•°:

# å®šä¹‰åŸºç¡€è®¾æ–½

æ— æœåŠ¡å™¨é¡¹ç›®é€šå¸¸éœ€è¦æ¯”åŸºäºå¾®æœåŠ¡æˆ–å•ä¸€å®ç°æ›´å¤æ‚çš„åŸºç¡€è®¾æ–½å®šä¹‰ã€‚ä¾‹å¦‚ï¼Œåœ¨å•ä¸€åº”ç”¨ç¨‹åºä¸­ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªä¸»è®¡ç®—å®ä¾‹ï¼Œè€Œåœ¨æ— æœåŠ¡å™¨é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸å°†è®¡ç®—åˆ†å¸ƒåœ¨åŸºç¡€æ¶æ„çš„è®¸å¤šä¸åŒç»„ä»¶ä¸­ã€‚

æ­£å¦‚æœ¬æ–‡å¼€å¤´æ‰€æ¦‚è¿°çš„ï¼Œæˆ‘æ„Ÿå…´è¶£çš„ä¸€ä¸ªå…³é”®ç‰¹æ€§æ˜¯åœ¨å•ç‹¬çš„ Lambda å‡½æ•°ä¸­éƒ¨ç½²æ¯ä¸ªé¡µé¢æˆ–è·¯å¾„ï¼Œä»¥ç¡®ä¿å¿«é€Ÿå†·å¯åŠ¨ã€‚

æˆ‘å†³å®šå®šä¹‰ä¸€ä¸ªæ¶æ„å¦‚ä¸‹:ä¸€ä¸ª [CloudFront å‘è¡Œç‰ˆ](https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/Introduction.html)ä½œä¸ºåº”ç”¨ç¨‹åºçš„åˆå§‹å…¥å£ã€‚é™æ€æ–‡ä»¶é€šè¿‡ [AWS S3](https://aws.amazon.com/s3/) æä¾›ã€‚å¯¹äºæ¯ä¸ªå®šä¹‰çš„è·¯ç”±ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª [Lambda](https://aws.amazon.com/lambda/) å‡½æ•°ï¼Œå¹¶ä½¿ç”¨ä¸€ä¸ª [AWS HTTP API ç½‘å…³](https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api.html)å°†æµé‡è·¯ç”±åˆ°æ­£ç¡®çš„ Lambda:

![](img/769b5a3f3d91b74f20dadf8ddcc77ebb.png)

å¯¹æˆ‘æ¥è¯´ï¼Œå¯æ‰©å±•æ€§æ˜¯å®šä¹‰åŸºç¡€è®¾æ–½çš„å…³é”®ï¼Œå°¤å…¶æ˜¯åœ¨æ— æœåŠ¡å™¨é¡¹ç›®ä¸­ï¼Œå› ä¸ºæˆ‘ä»¬é€šå¸¸éœ€è¦æ‰©å±•æˆ–ä¿®æ”¹æˆ‘ä»¬çš„åŸºç¡€è®¾æ–½æ¥å®ç°æ›´å¤šçš„åŠŸèƒ½ã€‚

å› æ­¤ï¼Œæˆ‘é€‰æ‹©ä½¿ç”¨ [Terraform](https://www.terraform.io/) æ¥å®šä¹‰åŸºç¡€è®¾æ–½ã€‚å‚è§`[infra/aws](https://github.com/goldstack/react-ssr/tree/master/packages/server-side-rendering-1/infra/aws)`ä¸­æ‰€æœ‰è¦æ±‚çš„åœ°å½¢é…ç½®ã€‚

æˆ‘å†³å®šä¸ºæ‰€æœ‰é’ˆå¯¹[å†·å¯åŠ¨](https://medium.com/geekculture/pick-the-right-memory-size-for-your-aws-lambda-functions-682394aa4b21)ä¼˜åŒ–çš„ lambda æä¾›ä¸€ä¸ªé€šç”¨çš„[é…ç½®ã€‚](https://github.com/goldstack/react-ssr/blob/9fcbe5204697546ec2b5268b637b0012a582eb17/packages/server-side-rendering-1/infra/aws/lambda_routes.tf#L13)

æ³¨æ„ï¼Œå˜é‡`lambdas`æ˜¯ç”±ä¸€äº›å·¥å…·åŠ¨æ€æä¾›çš„ï¼Œè¿™äº›å·¥å…·å°†`src/routes`æ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶ç¿»è¯‘æˆæ–‡ä»¶`[goldstack.json](https://github.com/goldstack/react-ssr/blob/9fcbe5204697546ec2b5268b637b0012a582eb17/packages/server-side-rendering-1/goldstack.json#L17)`ä¸­çš„åŠŸèƒ½é…ç½®ã€‚

å½“æ–°çš„è·¯ç”±è¢«å®šä¹‰æ—¶ï¼Œè¿™ä¸ªé…ç½®ç”±å°è£…åœ¨ npm åŒ…`[@golstack/utils-aws-lambda](https://www.npmjs.com/package/@goldstack/utils-aws-lambda)`ä¸­çš„[å°å®ç”¨ç¨‹åº](https://github.com/goldstack/goldstack/blob/master/workspaces/templates-lib/packages/utils-aws-lambda/src/generate/collectLambdasFromFiles.ts)åŠ¨æ€æ›´æ–°ã€‚

# éƒ¨ç½²

é™¤äº†ä¸ºæˆ‘ä»¬çš„ lambda å‡½æ•°å’Œé™æ€æ–‡ä»¶å®šä¹‰åŸºç¡€è®¾æ–½ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å°†æˆ‘ä»¬å¼€å‘çš„ä»£ç å’Œèµ„æºéƒ¨ç½²åˆ° AWS åŸºç¡€è®¾æ–½ã€‚

æˆ‘å†³å®šä½¿ç”¨ [AWS CLI](https://aws.amazon.com/cli/) æ¥éƒ¨ç½²åŠŸèƒ½ä»£ç å’Œé™æ€èµ„æºã€‚ä¸ºäº†é¿å…åœ¨æœ¬åœ°æœºå™¨ä¸Šå®‰è£… CLIï¼ŒDocker ç”¨äºè¿è¡Œ CLIã€‚

æ†ç»‘å’Œéƒ¨ç½² Lambdas ä»¥åŠç”Ÿæˆå’Œéƒ¨ç½²é™æ€èµ„æºéœ€è¦å‡ ä¸ªæ­¥éª¤ã€‚è¿™äº›æ˜¯ä½¿ç”¨ç”¨ TypeScript ç¼–å†™çš„å‡ ä¸ªè„šæœ¬ç¼–æ’çš„ã€‚è¿™äº›åœ¨åº“`[template-ssr-cli](https://github.com/goldstack/goldstack/tree/master/workspaces/templates-lib/packages/template-ssr-cli)`ä¸­å®šä¹‰ã€‚

éƒ¨ç½²è¿‡ç¨‹ä¸­æœ€æ£˜æ‰‹çš„éƒ¨åˆ†æ˜¯å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯çš„æ†ç»‘ï¼Œä¸‹é¢å°†è¯¦ç»†è®¨è®º:

# æœåŠ¡å™¨ç«¯æ†ç»‘

ä¸ºäº†éƒ¨ç½²æ— æœåŠ¡å™¨ SSR åº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬éœ€è¦æ†ç»‘ä»£ç ï¼Œä»¥ç¡®ä¿æˆ‘ä»¬åªä¸ºæ¯ä¸ªåŠŸèƒ½éƒ¨ç½²å¿…è¦çš„ä»£ç ã€‚

è¿™å¯ä»¥é€šè¿‡å¤§å¤šæ•° JavaScript æ†ç»‘å™¨å®ç°ï¼Œä¾‹å¦‚ [Webpack](https://webpack.js.org/) ã€ [Rollup](https://rollupjs.org/guide/en/) æˆ– [esbuild](https://esbuild.github.io/) ã€‚

æˆ‘å†³å®šä½¿ç”¨ *esbuild* ä½œä¸ºæˆ‘çš„å‚è€ƒå®ç°ï¼Œå› ä¸ºå®ƒå¿«é€Ÿä¸”æ˜“äºå®šåˆ¶ã€‚æ–‡ä»¶`[src/build.ts](https://github.com/goldstack/react-ssr/blob/9fcbe5204697546ec2b5268b637b0012a582eb17/packages/server-side-rendering-1/src/build.ts)`ä¸­å®šä¹‰äº† esbuild çš„é…ç½®:

è¿™ç§é…ç½®åŒæ—¶ä½¿ç”¨äº†`[esbuild-css-modules-client-plugin](https://www.npmjs.com/package/esbuild-css-modules-client-plugin)`å’Œ`[esbuild-ignore-with-comments-plugin](https://www.npmjs.com/package/esbuild-ignore-with-comments-plugin)`ã€‚å‰è€…ç”¨äºæ”¯æŒ [CSS æ¨¡å—](https://github.com/css-modules/css-modules)ï¼Œåè€…ç”¨äºç¡®ä¿åŒ…ä¸­ä¸åŒ…å«ä»…å®¢æˆ·ç«¯éœ€è¦çš„æ–‡ä»¶ã€‚

æ³¨æ„ï¼Œæ ¹æ® [AWS å»ºè®®](https://docs.aws.amazon.com/lambda/latest/dg/lambda-typescript.html)ï¼ŒåŒ…çš„ç›®æ ‡æ˜¯`node16`ï¼Œæ ¼å¼æ˜¯`commonjs`ã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œç”Ÿæˆçš„`.js`å’Œ`.css`æ–‡ä»¶è¢«ç®€å•åœ°å‹ç¼©ï¼Œå¹¶å‡†å¤‡å¥½ä½¿ç”¨ AWS CLI ä¸Šä¼ åˆ° AWSã€‚è¯·çœ‹ä¸‹é¢æ ¹æ®å‰é¢æ˜¾ç¤ºçš„è·¯çº¿ä¸ºæˆ‘çš„åšå®¢ç”Ÿæˆçš„ Zip æ–‡ä»¶:

![](img/fb63825bc97498a7f7ff8b8123e696b1.png)

# å®¢æˆ·ç«¯æ†ç»‘

å®¢æˆ·ç«¯æ†ç»‘ä¹Ÿä½¿ç”¨ esbuild æ‰§è¡Œï¼Œé…ç½®ä¹Ÿåœ¨`[src/build.ts](https://github.com/goldstack/react-ssr/blob/9fcbe5204697546ec2b5268b637b0012a582eb17/packages/server-side-rendering-1/src/build.ts)`ä¸­æä¾›:

è¿™ç§é…ç½®ä¹Ÿä½¿ç”¨äº†`[esbuild-css-modules-client-plugin](https://www.npmjs.com/package/esbuild-css-modules-client-plugin)`å’Œ`[esbuild-ignore-with-comments-plugin](https://www.npmjs.com/package/esbuild-ignore-with-comments-plugin)`ã€‚

ç”Ÿæˆçš„åŒ…å’Œ CSS æ–‡ä»¶ä¸åŒ…å«åœ¨ä¸Šä¼ åˆ° Lambdas çš„ Zip æ–‡ä»¶ä¸­ã€‚ç›¸åï¼Œå®ƒä»¬ä½¿ç”¨å“ˆå¸Œæ–‡ä»¶åä¸Šä¼ åˆ° S3ã€‚ä½¿ç”¨å®ç”¨ç¨‹åº`[static-file-mapper](https://www.npmjs.com/package/static-file-mapper)`å’Œ`[static-file-mapper-build](https://www.npmjs.com/package/static-file-mapper-build)`å®Œæˆåˆ°æ–‡ä»¶åçš„æ˜ å°„ã€‚ç”Ÿæˆä¸€ä¸ªæ–‡ä»¶`[src/state/staticFiles.json](https://github.com/goldstack/react-ssr/blob/9fcbe5204697546ec2b5268b637b0012a582eb17/packages/server-side-rendering-1/src/state/staticFiles.json)`,å®ƒç»´æŠ¤ç”Ÿæˆçš„åŒ…çš„æ˜ å°„:

é™æ€æ–‡ä»¶ä½¿ç”¨ CloudFront æä¾›ï¼Œå› æ­¤å®¢æˆ·ç«¯åŠ è½½æ—¶å»¶è¿Ÿæœ€å°ã€‚

# åœ°æ–¹å‘å±•

æ— æœåŠ¡å™¨å¼€å‘çš„æœ€å¤§æŒ‘æˆ˜ä¹‹ä¸€æ˜¯å¦‚ä½•æä¾›è‰¯å¥½çš„æœ¬åœ°å¼€å‘ä½“éªŒã€‚

å› æ­¤ï¼Œæˆ‘æƒ³ç¡®ä¿æˆ‘çš„æ–¹æ³•å…è®¸ç®€å•çš„æœ¬åœ°æµ‹è¯•ã€‚ä¸ºæ­¤ï¼Œæˆ‘é€‰æ‹©ä½¿ç”¨ä¸€ä¸ªç®€å•çš„ [Express](http://expressjs.com/) æœåŠ¡å™¨ï¼Œåœ¨æœ¬åœ°æä¾›è·¯ç”±å’Œé™æ€æ–‡ä»¶ã€‚

ä¸ºæ­¤ï¼Œæˆ‘å¼€å‘äº†å®ç”¨ç¨‹åº`[@goldstack/utils-aws-http-api-local](https://www.npmjs.com/package/@goldstack/utils-aws-http-api-local)`ã€‚å‚è§ [expressRoutes.ts](https://github.com/goldstack/goldstack/blob/ae3c9b35f0970b26f10727fcec342b004f247a5c/workspaces/templates-lib/packages/utils-aws-http-api-local/src/expressRoutes.ts) æŸ¥çœ‹æœ¬åœ°è·¯çº¿å¦‚ä½•æ˜ å°„åˆ°å¿«é€Ÿè·¯çº¿ã€‚

è¿™ä½¿å¾—å¯ä»¥è¿è¡Œä¸€ä¸ªç®€å•çš„`yarn watch`æ¥å¯åŠ¨å¹¶è¿è¡Œåº”ç”¨ç¨‹åºçš„æœ¬åœ°ç‰ˆæœ¬ã€‚

![](img/ff5ae28fc3c76c8f3e973434e6d4aaa2.png)

è¿™éœ€è¦å¤§é‡çš„é­”æ³•æ‰èƒ½æ­£å¸¸å·¥ä½œï¼ŒåŒ…æ‹¬å³æ—¶æ†ç»‘å®¢æˆ·ç«¯åŒ…ã€‚ç„¶è€Œï¼Œå¯¹äº AWS ä¸Šçš„éƒ¨ç½²æ¥è¯´ï¼Œè¿™äº›éƒ½ä¸æ˜¯å¿…éœ€çš„ï¼Œåœ¨ AWS ä¸Šï¼Œå®¢æˆ·ç«¯èµ„æºæ˜¯ä½œä¸ºé™æ€æ–‡ä»¶æä¾›çš„ï¼Œå¦‚ä¸Šæ‰€è¿°ã€‚

# å¥½çš„ï¼Œåçš„å’Œä¸‘é™‹çš„

åœ¨å†™æˆ‘çš„ React æœåŠ¡å™¨ç«¯æ¸²æŸ“æ–¹æ³•ä¹‹å‰ï¼Œæˆ‘æƒ³åœ¨ä¸€ä¸ªçœŸå®çš„é¡¹ç›®ä¸­å¯¹å®ƒè¿›è¡Œæµ‹è¯•ã€‚æˆ‘å¾ˆé«˜å…´èƒ½å¤Ÿä½¿ç”¨è¿™ç¯‡æ–‡ç« ä¸­æè¿°çš„æ–¹æ³•å°†æˆ‘çš„åšå®¢`[maxrohde.com](https://maxrohde.com)`ä» Wordpress è¿ç§»åˆ°ä¸€ä¸ªæ— æœåŠ¡å™¨çš„é¡¹ç›®ä¸­ã€‚

æˆ‘å‘ç°ï¼Œå¯¹äºè¿™ä¸ªåšå®¢æ‰€éœ€çš„æ‰€æœ‰è·¯ç”±ï¼ŒLambda ä»£ç çš„å¤§å°éƒ½ä¿æŒåœ¨ 1 MB ä»¥ä¸‹ï¼Œç”šè‡³å¯¹äºåŒ…æ‹¬ DB è¿æ¥åœ¨å†…çš„å‡½æ•°ä¹Ÿæ˜¯å¦‚æ­¤ã€‚

![](img/4b2e32b5d622067b8ca5dccf2b20e093.png)

(å¤§äº 500 kb çš„å‡½æ•°éœ€è¦ React å’Œ DynamoDB å®¢æˆ·ç«¯åº“ï¼Œå…¶ä»–å‡½æ•°éœ€è¦è¿™ä¸¤è€…çš„ç»„åˆï¼Œè€Œ`robots.txt`çš„å‡½æ•°ä¸éœ€è¦è¿™ä¸¤è€…ã€‚)

å†·å¯åŠ¨é€šå¸¸ä¼šåœ¨ 1.5 ç§’å†…å®Œæˆï¼Œè€Œå…¶ä»–è¯·æ±‚é€šå¸¸ä¼šåœ¨ 30-50 æ¯«ç§’å†…å®Œæˆï¼Œè¿™æ˜¯å‡ åƒæ¬¡è°ƒç”¨çš„æ ·æœ¬ã€‚

![](img/0c05d83010bcabdbfbf9c66a6e67571e.png)

æ¬¢è¿æ¢ç´¢åšå®¢[maxrohde.com](https://maxrohde.com)å’Œ[æºä»£ç ](https://github.com/mxro/maxrohde-web/tree/master/packages/web-maxrohde-com)ã€‚

åŸºäºè¿™ç§æ–¹æ³•çš„å‡ å‘¨å·¥ä½œï¼Œæˆ‘å‘ç°:

# å¥½äºº

*   âœ”é«˜ç”Ÿäº§ç‡å’Œè‰¯å¥½çš„å¼€å‘è€…ä½“éªŒï¼›å…è®¸å…³æ³¨åº”ç”¨ç¨‹åºé€»è¾‘ï¼Œè€Œä¸æ˜¯æ ·æ¿æ–‡ä»¶å’Œé…ç½®ã€‚
*   âœ”å°†æ¯æ¡è·¯ç”±æ‰“åŒ…æˆè‡ªå·±çš„ Lambda å·¥ä½œæ–¹å¼ï¼Œç»“æœæ˜¯å¯æ¥å—çš„æ€§èƒ½ã€éå¸¸ä½çš„æˆæœ¬ã€æ˜“äºç»´æŠ¤å’Œé«˜å¯ä¼¸ç¼©æ€§ã€‚
*   é€šè¿‡ CloudFront çš„å®¢æˆ·ç«¯èµ„æºçš„âœ”åˆ†å¸ƒå¯¼è‡´å¿«é€Ÿçš„åŠ è½½æ—¶é—´ã€‚
*   âœ”æ˜“äºæ‰©å±•ï¼›ä½¿ç”¨ [Tailwind CSS](https://tailwindcss.com/) ä¸ºåšå®¢è®¾è®¡é£æ ¼ï¼Œè¿™éœ€è¦å®šåˆ¶æ„å»ºè¿‡ç¨‹ã€‚

# åäº‹

*   ğŸ¤”React ä½¿å¾— Lambdas å’Œå®¢æˆ·ç«¯åŒ…æ¯”æˆ‘å¸Œæœ›çš„è¦é‡ã€‚å¯èƒ½éœ€è¦ä½¿ç”¨[é¢„æµ‹](https://preactjs.com/)è¿›è¡Œæ¢ç´¢ã€‚
*   ğŸ¤”TypeScript å¾ˆå¥½ï¼Œä½†æ˜¯éœ€è¦å°†æºåœ°å›¾å’Œæºä»£ç ä¸€èµ·å‘é€ï¼Œè¿™ä½¿å¾—éœ€è¦éƒ¨ç½²çš„ Zip å­˜æ¡£çš„å¤§å°å¢åŠ äº†ä¸€å€ä»¥ä¸Šã€‚

![](img/fd8bf50cf469e3571ea3cad1bc9327aa.png)

# ä¸‘é™‹çš„

*   ğŸ¤¯è™½ç„¶ 1 s å·¦å³çš„å†·å¯åŠ¨æ˜¯å¯ä»¥æ¥å—çš„ï¼Œä½†æˆ‘å¸Œæœ›å®ƒä»¬èƒ½æ›´å¿«ã€‚è¿™æ®µæ—¶é—´çš„å¤§éƒ¨åˆ†è¢« AWS ç”¨æ¥åšå¥½å‡†å¤‡ï¼Œè€Œä¸æ˜¯åŠ è½½å®é™…çš„æºä»£ç (å› æ­¤å‡å°‘æºä»£ç çš„å¤§å°åªä¼šå¯¹å†·å¯åŠ¨æ—¶é—´äº§ç”Ÿæœ€å°çš„å½±å“)ã€‚

# ä»è¿™é‡Œå»å“ªé‡Œï¼Ÿ

æˆ‘èŠ±äº†å¾ˆé•¿æ—¶é—´æ¥å¼€å‘æœ¬è´¨ä¸Šæ˜¯ç”¨äºå¼€å‘æœåŠ¡å™¨ç«¯æ¸²æŸ“ React åº”ç”¨ç¨‹åºçš„å…¨æ ˆæ¡†æ¶ã€‚æˆ‘å­¦åˆ°äº†å¾ˆå¤šå…³äº React å’Œ CSS ç”Ÿæˆçš„å·¥ä½œåŸç†ã€‚æˆ‘å¸Œæœ›åœ¨åå¹´å·¦å³çš„æ—¶é—´é‡Œä¸å¿…é‡æ–°å®ç°æˆ‘çš„åšå®¢ï¼ŒåŒæ—¶ç»§ç»­æ”¹è¿›[æ¨¡æ¿](https://goldstack.party/templates/server-side-rendering)ã€‚

ç„¶è€Œï¼Œå¦‚æœä½ æƒ³å°è¯•ä¸€ä¸‹ï¼Œå» [Goldstack](https://goldstack.party) å¹¶é€‰æ‹©*æœåŠ¡å™¨ç«¯æ¸²æŸ“*æ¨¡æ¿ã€‚æˆ–è€…ï¼Œæ‚¨ä¹Ÿå¯ä»¥å…‹éš†è‡ªåŠ¨ä¸æ¨¡æ¿ä¿æŒåŒæ­¥çš„`[react-srr](https://github.com/goldstack/react-ssr)`å­˜å‚¨åº“ã€‚

å¦‚æœä½ æœ‰ä»»ä½•æƒ³æ³•æˆ–ä¸»æ„ï¼Œè¯·ä¸è¦çŠ¹è±«[åœ¨ç¤¾äº¤å¹³å°](https://maxrohde.com/about)ä¸Šå¯»æ±‚å¸®åŠ©ï¼Œæˆ–è€…é€šè¿‡åˆ›å»º[é—®é¢˜](https://github.com/goldstack/goldstack/issues)ğŸ¤—ã€‚