<html>
<head>
<title>How-to kubectl LoadBalancer and configure Nginx Ingress controller for a GCP Cluster</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何为 GCP 集群配置负载平衡器和 Nginx 入口控制器</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/how-to-kubectl-loadbalancer-and-configure-nginx-ingress-controller-for-a-gcp-cluster-bc2f2599f8f1?source=collection_archive---------10-----------------------#2020-06-07">https://blog.devgenius.io/how-to-kubectl-loadbalancer-and-configure-nginx-ingress-controller-for-a-gcp-cluster-bc2f2599f8f1?source=collection_archive---------10-----------------------#2020-06-07</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jm jn jo jp gh gi paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="gh gi jl"><img src="../Images/2a8f2f7b9273bafb23fb1072a4b52acc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nREEI82ipapgnjIXSzp_iw.jpeg"/></div></div></figure><p id="cce2" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">你有没有想过你可以为 K8s 编写自己的负载平衡器，而不是浏览所有的文档，那么就不要再看了！我将带您完成在 Kubernetes GCP 集群上启动 Nginx 入口控制器和第 4 层负载平衡器的设置。</p><p id="08a4" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">Kubernetes 将特定于云的控制回路从 kube-controller 中分离出来。因此，如果您需要特定云平台上的负载平衡器、节点控制，那么您必须单独安装云控制器管理器。这仍然不支持这些节点上的存储，其中一个节点的存储仍然由 kube 控制器处理。对特定云上的有状态集合的修改可以在这里找到<a class="ae ku" href="https://medium.com/@rangapv/dynamic-provisioning-of-storage-on-a-gcp-kubernetes-cluster-using-helm-charts-795f576e0cab" rel="noopener">。</a></p><p id="3e53" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">现在让我们看看如何安装和配置云控制器管理器。</p><p id="e41d" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">先决条件:在所有节点上运行的所有 kubelets 都应该启用“cloud-provider=external”标志。此外,“cloud-config”标志应该指向一个文件，该文件应该具有以下格式。所有节点上的“节点标签”必须相同。密钥是从 GCP 即时消息凭证选项卡访问 GCP 云 API 的 API 密钥。</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="1116" class="le lf in la b gy lg lh l li lj"><strong class="la io">[Global]<br/>project-id = rosy-cache-200605<br/>node-tags = kubernetes</strong><br/><strong class="la io">key = AIza**************MVZhpLp62GkA</strong></span></pre><p id="83c8" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">kube-api-server 和 kube-controller <strong class="jy io">不应该</strong>有“云提供商”标志。如果你有它，那么就把它注释掉或者从配置文件中删除它。</p><ol class=""><li id="e8dd" class="lk ll in jy b jz ka kd ke kh lm kl ln kp lo kt lp lq lr ls bi translated">如下图所示设置主节点:这一步在<a class="ae ku" href="https://medium.com/@rangapv/kubernetes-install-101-with-kubeadm-149b70626a9f" rel="noopener">这篇文章</a>中已经介绍过了，需要在设置所需的标志时进行调整。作为一个总结，如果你要重新开始，那么就做这些步骤……</li></ol><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="5ec3" class="le lf in la b gy lg lh l li lj"><strong class="la io">From your home directory : Installing or Upgrading python<br/></strong>$ mkdir pyup;cd pyup;git init;git pull <a class="ae ku" href="https://github.com/rangapv/pyUpgrade.git;./py.sh" rel="noopener ugc nofollow" target="_blank">https://github.com/rangapv/pyUpgrade.git;./py.sh</a></span><span id="7c7d" class="le lf in la b gy lt lh l li lj"><strong class="la io">Again from your home directory : Installing docker</strong></span><span id="74b1" class="le lf in la b gy lt lh l li lj">$ mkdir doker;cd doker;git init;git pull <a class="ae ku" href="https://github.com/rangapv/doker.git;./dock.sh" rel="noopener ugc nofollow" target="_blank">https://github.com/rangapv/doker.git;./dock.sh</a></span><span id="3701" class="le lf in la b gy lt lh l li lj"><strong class="la io">Again from your home directory : pulling all the required k8s YAML definitions from the github<br/></strong>$ mkdir adm;cd adm;git init;git pull <a class="ae ku" href="https://github.com/rangapv/k8s.git" rel="noopener ugc nofollow" target="_blank">https://github.com/rangapv/k8s.git</a><strong class="la io"><br/></strong>$ ls<strong class="la io"><br/>ccm  kube_adm  kube_dash  kube_flannel  kube_node  pods Readme</strong></span></pre><p id="39c1" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">现在让我们为主节点安装不同的 k8s 组件:</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="390c" class="le lf in la b gy lg lh l li lj">$ cd kube_adm<strong class="la io"><br/></strong>$ ls<strong class="la io"><br/>adm_install.sh<br/></strong>$./adm_install.sh</span></pre><p id="feb4" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">并且<strong class="jy io">不要</strong>执行 kubeadm init 命令，该命令是从上面命令的屏幕输出中得到的，这是针对 kubeadm 安装的，无需修改——普通的设置。相反，我们将创建一个配置文件，并在下面的步骤 3 中使用标志执行 kubeadm init。</p><p id="4337" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">2.将 gce.conf 复制到/etc/kubernetes 文件夹；这个文件应该有你的 GCP 帐户的项目标识，也有你的 IAM 帐户的 API 密匙，可以从 GCP 控制台得到</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="39f3" class="le lf in la b gy lg lh l li lj">$ sudo vi /etc/kubernetes/gce.conf<strong class="la io"><br/>[Global]<br/>project-id = rosy-cache-200605<br/>node-tags = kubernetes<br/>key = AIzaSy*****************************p62GkA</strong></span></pre><p id="00b6" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">3.使用 kubeadm init 安装主节点集群，并在下面列出的“adm-conf”文件中更改配置</p><figure class="kv kw kx ky gt jp"><div class="bz fp l di"><div class="lu lv l"/></div></figure><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="9a19" class="le lf in la b gy lg lh l li lj">$ sudo kubeadm init --config=./adm-conf.yaml</span><span id="53bb" class="le lf in la b gy lt lh l li lj"><strong class="la io">This will give a "kube adm join ..." output as shown below</strong></span><span id="1935" class="le lf in la b gy lt lh l li lj"><strong class="la io">  mkdir -p $HOME/.kube<br/>  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config<br/>  sudo chown $(id -u):$(id -g) $HOME/.kube/config.<br/>.<br/>.<br/>kubeadm join 10.128.0.52:6443 --token bw1oyz.h5mfl6tdicnhmtf1 \<br/>    --discovery-token-ca-cert-hash sha256:c121****************27245d5b4d455f1c03f87eaf7ce4b7f30098107b</strong></span></pre><p id="54ab" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">将 kubeadm join 命令复制到 notepad++中，稍后工作节点将使用该命令加入集群。将主配置文件复制到您的$HOME/。kube/配置</p><p id="c1d4" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">4.安装网络绒布:从上面步骤 1 的“git pull”开始；adm 目录下有一个“kube _ 法兰绒”子文件夹，里面有法兰绒 YAML，应用吧。</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="d9fd" class="le lf in la b gy lg lh l li lj">$ kubectl apply -f ./kube-flannel.yml <strong class="la io"><br/>podsecuritypolicy.policy/psp.flannel.unprivileged created<br/>clusterrole.rbac.authorization.k8s.io/flannel created<br/>clusterrolebinding.rbac.authorization.k8s.io/flannel created<br/>serviceaccount/flannel created<br/>configmap/kube-flannel-cfg created<br/>daemonset.apps/kube-flannel-ds-amd64 created<br/>daemonset.apps/kube-flannel-ds-arm64 created<br/>daemonset.apps/kube-flannel-ds-arm created<br/>daemonset.apps/kube-flannel-ds-ppc64le created<br/>daemonset.apps/kube-flannel-ds-s390x created</strong></span></pre><p id="3911" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">5.部署仪表板(可选) :从上面第 1 步的“git pull”中，adm 目录有一个“kube_dash”子文件夹，建议 rbac YAML 应用它。</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="c336" class="le lf in la b gy lg lh l li lj">$ kubectl apply -f ./recommended.yaml <strong class="la io"><br/>namespace/kubernetes-dashboard created<br/>serviceaccount/kubernetes-dashboard created<br/>service/kubernetes-dashboard created<br/>secret/kubernetes-dashboard-certs created<br/>secret/kubernetes-dashboard-csrf created<br/>secret/kubernetes-dashboard-key-holder created<br/>configmap/kubernetes-dashboard-settings created<br/>role.rbac.authorization.k8s.io/kubernetes-dashboard created<br/>clusterrole.rbac.authorization.k8s.io/kubernetes-dashboard created<br/>rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created<br/>clusterrolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created<br/>deployment.apps/kubernetes-dashboard created<br/>service/dashboard-metrics-scraper created<br/>deployment.apps/dashboard-metrics-scraper created</strong></span><span id="5a58" class="le lf in la b gy lt lh l li lj">$ kubectl apply -f ./dashboard-adminuser.yaml <strong class="la io"><br/>serviceaccount/admin-user created<br/>clusterrolebinding.rbac.authorization.k8s.io/admin-user created</strong></span></pre><p id="7d5a" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">6.为云控制器管理器容器生成 kubernetes 秘密:云控制器管理器的容器需要 Kubernetes 特定的配置(比如 API 密钥)。这只是模板；在创建秘密和更新下面的“ccm.yaml”时，使用您的特定文件输入。</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="46e0" class="le lf in la b gy lg lh l li lj">$ kubectl create secret generic gce-secret --from-file=gce.conf=/etc/kubernetes/gce.conf --from-file=config=$HOME/.kube/config -n kube-system</span><span id="11ab" class="le lf in la b gy lt lh l li lj"><strong class="la io">secret/gce-secret created</strong></span></pre><p id="903f" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated"><em class="lw">此时，主节点准备就绪，您可以从下面设置工作节点，然后返回来执行云控制器管理器的下一个步骤-7！</em></p><p id="d50d" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">7.安装云控制器管理器 yaml:在我们这样做之前，让我们检查 pod 状态</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="e3d2" class="le lf in la b gy lg lh l li lj">without the cloud controller manager some of the pods are in pending state as shown below... rightfully so because of Node taints...<strong class="la io"><br/>$ kubectl get po --all-namespaces<br/>NAMESPACE     NAME                                READY   STATUS    RESTARTS   AGE<br/>kube-system   coredns-66bff467f8-l7s4r            0/1     Pending   0          2m30s<br/>kube-system   coredns-66bff467f8-t2jdh            0/1     Pending   0          2m30s<br/>kube-system   etcd-kubeadm24                      1/1     Running   0          2m45s<br/>kube-system   kube-apiserver-kubeadm24            1/1     Running   0          2m45s<br/>kube-system   kube-controller-manager-kubeadm24   1/1     Running   0          2m45s<br/>kube-system   kube-flannel-ds-amd64-vb87b         1/1     Running   0          24s<br/>kube-system   kube-proxy-85fwk                    1/1     Running   0          2m30s<br/>kube-system   kube-scheduler-kubeadm24            1/1     Running   0          2m45s</strong></span></pre><p id="4f1a" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated"><strong class="jy io">云控制器管理器(CCM)安装:</strong>这包括两个部分，CCM 部署和 RBAC 定义。服务账户/RBAC·YAML 如下所示</p><figure class="kv kw kx ky gt jp"><div class="bz fp l di"><div class="lu lv l"/></div></figure><p id="381a" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">让我们做一个库应用程序…</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="3668" class="le lf in la b gy lg lh l li lj">$ cd ~/adm/ccm/<br/>$ kubectl apply -f ./ccm-rbac.yaml <strong class="la io"><br/>serviceaccount/cloud-controller-manager created<br/>clusterrole.rbac.authorization.k8s.io/system:cloud-controller-manager created<br/>clusterrolebinding.rbac.authorization.k8s.io/system:cloud-controller-manager created</strong></span></pre><p id="6456" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">云控制器管理器的定义如下所示</p><figure class="kv kw kx ky gt jp"><div class="bz fp l di"><div class="lu lv l"/></div></figure><blockquote class="lx ly lz"><p id="bb0a" class="jw jx lw jy b jz ka kb kc kd ke kf kg ma ki kj kk mb km kn ko mc kq kr ks kt ig bi translated">注意:在上面的定义中，我使用 HostPath 将“/etc/ssl”从本地主机上传到“ccm”容器映像。因为 CCM 容器没有安装“openssl ”,在这种情况下，任何对外部 API 的请求，负载平衡器的 GCP 云 API 都会导致 X509 错误。(他们说容器是独立的，它可以在任何地方工作！)也试试登录“ccm”容器，安装“apt-get”或者“openssl”，运气会用完的…</p></blockquote><p id="53e7" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">现在让我们安装带有 kubectl apply 的云控制管理器</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="15c1" class="le lf in la b gy lg lh l li lj">$ kubectl apply -f ./ccm.yaml<strong class="la io"> <br/>deployment.apps/cloud-controller-manager created</strong></span></pre><p id="6974" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">再次检查窗格，查看它们是否已从挂起状态恢复。它显示了容器的创建，几分钟后，容器终于启动并运行了</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="6539" class="le lf in la b gy lg lh l li lj">$ kubectl get po --all-namespaces<strong class="la io"><br/>NAMESPACE              NAME                                         READY   STATUS    RESTARTS   AGE<br/>kube-system            cloud-controller-manager-6b58648559-4npts    1/1     Running   0          8m1s<br/>kube-system            coredns-66bff467f8-l7s4r                     1/1     Running   0          11m<br/>kube-system            coredns-66bff467f8-t2jdh                     1/1     Running   0          11m<br/>kube-system            etcd-kubeadm24                               1/1     Running   0          11m<br/>kube-system            kube-apiserver-kubeadm24                     1/1     Running   0          11m<br/>kube-system            kube-controller-manager-kubeadm24            1/1     Running   0          11m<br/>kube-system            kube-flannel-ds-amd64-vb87b                  1/1     Running   0          8m55s<br/>kube-system            kube-proxy-85fwk                             1/1     Running   0          11m<br/>kube-system            kube-scheduler-kubeadm24                     1/1     Running   0          11m<br/>kubernetes-dashboard   dashboard-metrics-scraper-779f5454cb-vjjvn   1/1     Running   0          19s<br/>kubernetes-dashboard   kubernetes-dashboard-64686c4bf9-5qmpp        1/1     Running   0          20s</strong></span></pre><p id="3442" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">现在我们有了主节点，让我们也创建一个工作节点…</p><ol class=""><li id="20fe" class="lk ll in jy b jz ka kd ke kh lm kl ln kp lo kt lp lq lr ls bi translated">如下所示设置工作节点</li></ol><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="23d0" class="le lf in la b gy lg lh l li lj"><strong class="la io">From your home directory : Installing or Upgrading python<br/></strong>$ mkdir pyup;cd pyup;git init;git pull <a class="ae ku" href="https://github.com/rangapv/pyUpgrade.git;./py.sh" rel="noopener ugc nofollow" target="_blank">https://github.com/rangapv/pyUpgrade.git;./py.sh</a></span><span id="b1ab" class="le lf in la b gy lt lh l li lj"><strong class="la io">Again from your home directory : Installing docker</strong></span><span id="74e8" class="le lf in la b gy lt lh l li lj">$ mkdir doker;cd doker;git init;git pull <a class="ae ku" href="https://github.com/rangapv/doker.git;./dock.sh" rel="noopener ugc nofollow" target="_blank">https://github.com/rangapv/doker.git;./dock.sh</a></span><span id="a728" class="le lf in la b gy lt lh l li lj"><strong class="la io">Again from your home directory : pulling all the required k8s YAML definitions from the github<br/></strong>$ mkdir adm;cd adm;git init;git pull <a class="ae ku" href="https://github.com/rangapv/k8s.git" rel="noopener ugc nofollow" target="_blank">https://github.com/rangapv/k8s.git</a><strong class="la io"><br/></strong>$ ls<strong class="la io"><br/>ccm  kube_adm  kube_dash  kube_flannel  kube_node  pods Readme</strong></span><span id="bd5d" class="le lf in la b gy lt lh l li lj"><strong class="la io">Here we are concerned with only the kube_node and Pods sub directory since this is the worker node.</strong></span></pre><p id="a207" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">现在让我们安装不同的 k8s 组件</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="b4dc" class="le lf in la b gy lg lh l li lj">$ cd kube_node<br/>$ ls<strong class="la io"><br/>node_install.sh<br/>$ ./node_install.sh</strong></span></pre><p id="536f" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">从上面脚本安装的屏幕输出来看，还不要执行“kube join ”,这是一个没有云控制器管理器的普通设置。相反，请遵循下一步</p><p id="4dc8" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">2.我们需要如下准备工作节点</p><ul class=""><li id="1e15" class="lk ll in jy b jz ka kd ke kh lm kl ln kp lo kt md lq lr ls bi translated">将配置文件从 master 复制到$HOME/。工作节点上的 kube</li><li id="0c1a" class="lk ll in jy b jz me kd mf kh mg kl mh kp mi kt md lq lr ls bi translated">创建一个/etc/kubernetes/gce.conf 文件，如下所示</li></ul><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="7626" class="le lf in la b gy lg lh l li lj">$ sudo vi /etc/kubernetes/gce.conf<strong class="la io"><br/>[Global]<br/>project-id = rosy-cache-200605<br/>node-tags = kubernetes<br/>key = AIzaSy***************************Lp62GkA</strong></span></pre><ul class=""><li id="f2a3" class="lk ll in jy b jz ka kd ke kh lm kl ln kp lo kt md lq lr ls bi translated">修改 kubelet 以包含 10-kubeadm.conf 文件中的标志，如下所示</li></ul><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="b50b" class="le lf in la b gy lg lh l li lj">$ sudo vi /etc/systemd/system/kubelet.service.d/10-kubeadm.conf<strong class="la io"> <br/>Add these flags to the Environment variable "--cloud-provider=external --cloud-config=/etc/kubernetes/gce.conf"</strong></span><span id="5f60" class="le lf in la b gy lt lh l li lj">The file after modification will look similar below</span><span id="9601" class="le lf in la b gy lt lh l li lj"><strong class="la io"># Note: This dropin only works with kubeadm and kubelet v1.11+<br/>[Service]<br/>Environment="KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --cloud-provider=external --cloud-config=/etc/kubernetes/gce.conf --kubeconfig=/etc/kubernetes/kubelet.conf"</strong></span></pre><ul class=""><li id="80d9" class="lk ll in jy b jz ka kd ke kh lm kl ln kp lo kt md lq lr ls bi translated">让我们执行从主节点获得的 kubectl join 命令</li></ul><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="e4a2" class="le lf in la b gy lg lh l li lj">$ sudo kubeadm join 10.128.0.52:6443 --token bw1oyz.h5mfl6tdicnhmtf1 --discovery-token-ca-cert-hash sha256:c121df3a32a87f6f97643fc727245d5b4d455f1c03f87eaf7ce4b7f30098107b &amp;</span><span id="1012" class="le lf in la b gy lt lh l li lj"><strong class="la io">....<br/>kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap...</strong></span><span id="93ee" class="le lf in la b gy lt lh l li lj"><strong class="la io">This node has joined the cluster:<br/>* Certificate signing request was sent to apiserver and a response was received.<br/>* The Kubelet was informed of the new secure connection details.</strong></span><span id="2b71" class="le lf in la b gy lt lh l li lj"><strong class="la io">Run 'kubectl get nodes' on the control-plane to see this node join the cluster.</strong></span><span id="5ded" class="le lf in la b gy lt lh l li lj">$ kubectl get nodes<strong class="la io"><br/>NAME         STATUS   ROLES    AGE     VERSION<br/>kubeadm      Ready    master   6h22m   v1.18.3<br/>kubenode     Ready    &lt;none&gt;   67s     v1.18.3</strong></span></pre><p id="ea76" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated"><strong class="jy io">我们已经通过云控制器管理器成功地建立了一个 2 节点集群。</strong></p><p id="1f2e" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">让我们部署一个带有 type = LoadBalancer 的 nginx 服务，看看 GCP 是否创建了一个带有外部 IP 的负载平衡器</p><p id="168f" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">在上面的“git pull”步骤 1 中，adm 目录有一个包含应用程序资源的“pods”子文件夹</p><p id="13a7" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">让我们应用部署和服务</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="2dc4" class="le lf in la b gy lg lh l li lj">$ cd pods<strong class="la io"><br/>$ kubectl apply -f web1-pod.yaml<br/>$ kubectl apply -f web2-pod.yaml<br/>$ kubectl apply -f web1-service.yaml<br/>$ kubectl apply -f web2-service.yaml</strong></span></pre><p id="4e27" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">让我们检查服务是否启动并运行</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="c667" class="le lf in la b gy lg lh l li lj">$ kubectl get po<strong class="la io"><br/>NAME                                   READY   STATUS    RESTARTS   AGE<br/>web1-pod-deployment-d97d4bb54-2fb2m    1/1     Running   2          20h<br/>web2-pod-deployment-69f9bb5cb4-7kqtm   1/1     Running   0          29s</strong></span><span id="7041" class="le lf in la b gy lt lh l li lj">$ kubectl get svc<strong class="la io"><br/>NAME           TYPE           CLUSTER-IP       EXTERNAL-IP     PORT(S)          AGE<br/>kubernetes     ClusterIP      10.96.0.1        &lt;none&gt;          443/TCP          22h<br/>web1-service   LoadBalancer   10.96.0.3        &lt;pending&gt; 80:30258/TCP   20h<br/>web2-service   LoadBalancer   10.107.125.219   &lt;pending&gt;       80:31300/TCP     15s</strong></span><span id="8eb2" class="le lf in la b gy lt lh l li lj">Notice the External ip is still pending , the ccm is creating the LoadBalancer on GCP</span><span id="cb32" class="le lf in la b gy lt lh l li lj"><strong class="la io">After few seconds we now have an external IP for the services...</strong></span><span id="b418" class="le lf in la b gy lt lh l li lj">$ kubectl get svc<strong class="la io"><br/>NAME           TYPE           CLUSTER-IP       EXTERNAL-IP     PORT(S)          AGE<br/>kubernetes     ClusterIP      10.96.0.1        &lt;none&gt;          443/TCP          22h<br/>web1-service   LoadBalancer   10.96.0.3        104.197.63.29   80:30258/TCP   20h<br/>web2-service   LoadBalancer   10.107.125.219   35.239.95.227   80:31300/TCP     41s</strong></span></pre><p id="c580" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">现在我们已经获得了负载平衡器的外部 IP，让我们点击那个 IP(35.239.95.227 和 104.197.63.29)<strong class="jy io"/>。</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="bcb7" class="le lf in la b gy lg lh l li lj">$ curl <a class="ae ku" href="http://35.239.95.227" rel="noopener ugc nofollow" target="_blank">http://35.239.95.227</a><strong class="la io"><br/>&lt;!DOCTYPE html&gt;<br/>&lt;html&gt;<br/>&lt;head&gt;<br/>&lt;title&gt;</strong>Welcome to nginx!<strong class="la io">&lt;/title&gt;<br/>&lt;style&gt;<br/>    body {<br/>        width: 35em;<br/>        margin: 0 auto;<br/>        font-family: Tahoma, Verdana, Arial, sans-serif;<br/>    }<br/>&lt;/style&gt;<br/>&lt;/head&gt;<br/>&lt;body&gt;<br/>&lt;h1&gt;</strong>Welcome to nginx!<strong class="la io">&lt;/h1&gt;<br/>&lt;p&gt;If you see this page, the nginx web server is successfully installed and<br/>working. Further configuration is required.&lt;/p&gt;</strong></span><span id="0a7f" class="le lf in la b gy lt lh l li lj"><strong class="la io">&lt;p&gt;For online documentation and support please refer to<br/>&lt;a href="</strong><a class="ae ku" href="http://nginx.org/" rel="noopener ugc nofollow" target="_blank"><strong class="la io">http://nginx.org/</strong></a><strong class="la io">"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;<br/>Commercial support is available at<br/>&lt;a href="</strong><a class="ae ku" href="http://nginx.com/" rel="noopener ugc nofollow" target="_blank"><strong class="la io">http://nginx.com/</strong></a><strong class="la io">"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</strong></span><span id="9070" class="le lf in la b gy lt lh l li lj"><strong class="la io">&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;<br/>&lt;/body&gt;<br/>&lt;/html&gt;</strong></span></pre><p id="229e" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">上面的曲线表明，GCP 上的负载平衡器能够将流量定向到 web1 和 web2 服务，这两个服务在端口 80 运行 nginx 服务器。</p><p id="6b48" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">现在，云控制器管理器为每个服务创建一个新的负载平衡器，这增加了向公众公开服务的成本。让我们看看如何利用单个负载均衡器来公开所有服务，基本上是一个 IP 用于所有服务。这可以通过入口控制器来实现。</p><p id="b02f" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated"><strong class="jy io"> Nginx 入口控制器:</strong></p><p id="3e83" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">让我们看看如何在 GCP 上实现 nginx 入口控制器。</p><p id="1e1f" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">先决条件:确保您的实例可以访问端口 10254、10250、80、443、6443 和 8443</p><figure class="kv kw kx ky gt jp gh gi paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="gh gi mj"><img src="../Images/5d5e894ca6f9b0eb831544ea39372304.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jRmrti_Hat1ZLwGCQYvozA.png"/></div></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk translated">防火墙访问</figcaption></figure><p id="a573" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">从 nginx 部署入口有两种不同的方式。</p><ol class=""><li id="8bb8" class="lk ll in jy b jz ka kd ke kh lm kl ln kp lo kt lp lq lr ls bi translated">Kubernetes 社区方法:</li></ol><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="6929" class="le lf in la b gy lg lh l li lj"><a class="ae ku" href="https://github.com/kubernetes/ingress-nginx" rel="noopener ugc nofollow" target="_blank"><strong class="la io">https://github.com/kubernetes/ingress-nginx</strong></a><strong class="la io"><br/></strong><a class="ae ku" href="https://kubernetes.github.io/ingress-nginx/deploy/" rel="noopener ugc nofollow" target="_blank"><strong class="la io">https://kubernetes.github.io/ingress-nginx/deploy/</strong></a></span></pre><p id="2324" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">2.官方 Nginx 方法:</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="5fed" class="le lf in la b gy lg lh l li lj"><a class="ae ku" href="https://github.com/nginxinc/kubernetes-ingress/" rel="noopener ugc nofollow" target="_blank"><strong class="la io">https://github.com/nginxinc/kubernetes-ingress/</strong></a></span></pre><p id="1fa0" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">在本文中，我将采用官方 Nginx 库的第二种方法。随着 Nginx 方法的出现，有一种旧方法和一种新方法。先来看看老办法。两者都是一样的，只是他们有两个不同的 yaml，然后他们组合成一个部署。YAML。这两种方法基本上完成相同的任务，选择其中一种而不是两种都选。您可以从任何节点应用它。</p><p id="99ed" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">古老的方式:PreDragon</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="3f60" class="le lf in la b gy lg lh l li lj">$ mkdir ingress ; cd ingress; git init; git pull <a class="ae ku" href="https://github.com/rangapv/ingress-nginx.git" rel="noopener ugc nofollow" target="_blank">https://github.com/rangapv/ingress-nginx.git</a><strong class="la io"><br/></strong>$ ls<strong class="la io"><br/>  ingress1.yaml  ingress2.yaml  postdragon  predragon  Readme</strong></span></pre><p id="bbe6" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">将目录切换到 predragon 子文件夹</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="a65c" class="le lf in la b gy lg lh l li lj"><strong class="la io">STEP1:<br/>kubectl apply -f ./mandatory.yaml</strong></span><span id="e338" class="le lf in la b gy lt lh l li lj"><strong class="la io">STEP2:<br/>kubectl apply -f ./cloud-generic.yaml</strong></span></pre><p id="92e7" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">或者…..</p><p id="4740" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">Postdragon 文件夹只有一个 deploy.yaml 文件</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="efb1" class="le lf in la b gy lg lh l li lj">$ cd postdragon ; ls<br/> <strong class="la io"> deploy.yaml</strong></span><span id="7651" class="le lf in la b gy lt lh l li lj">$ kubectl apply -f ./deploy.yaml<strong class="la io"><br/>namespace/ingress-nginx created<br/>serviceaccount/ingress-nginx created<br/>configmap/ingress-nginx-controller created<br/>clusterrole.rbac.authorization.k8s.io/ingress-nginx created<br/>clusterrolebinding.rbac.authorization.k8s.io/ingress-nginx created<br/>role.rbac.authorization.k8s.io/ingress-nginx created<br/>rolebinding.rbac.authorization.k8s.io/ingress-nginx created<br/>service/ingress-nginx-controller-admission created<br/>service/ingress-nginx-controller created<br/>deployment.apps/ingress-nginx-controller created<br/>validatingwebhookconfiguration.admissionregistration.k8s.io/ingress-nginx-admission created<br/>clusterrole.rbac.authorization.k8s.io/ingress-nginx-admission created<br/>clusterrolebinding.rbac.authorization.k8s.io/ingress-nginx-admission created<br/>job.batch/ingress-nginx-admission-create created<br/>job.batch/ingress-nginx-admission-patch created<br/>role.rbac.authorization.k8s.io/ingress-nginx-admission created<br/>rolebinding.rbac.authorization.k8s.io/ingress-nginx-admission created<br/>serviceaccount/ingress-nginx-admission created</strong></span></pre><p id="2574" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">让我们检查是否创建了窗格</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="5a9e" class="le lf in la b gy lg lh l li lj">$ kubectl get po --all-namespaces<strong class="la io"><br/>NAMESPACE              NAME                                         READY   STATUS      RESTARTS   AGE<br/>default                web1-pod-deployment-d97d4bb54-2fb2m          1/1     Running     2          21h<br/>default                web2-pod-deployment-69f9bb5cb4-7kqtm         1/1     Running     0          89m<br/>ingress-nginx          ingress-nginx-admission-create-zcvjt         0/1     Completed   0          56s<br/>ingress-nginx          ingress-nginx-admission-patch-xk9pr          0/1     Completed   0          56s<br/>ingress-nginx          ingress-nginx-controller-866488c6d4-h7s8b    1/1     Running     0          67s<br/>kube-system            cloud-controller-manager-66db4656db-jrjmg    1/1     Running     0          105m<br/>kube-system            coredns-66bff467f8-cdhft                     1/1     Running     3          24h<br/>kube-system            coredns-66bff467f8-w2zq8                     1/1     Running     3          24h<br/>kube-system            etcd-kubeadm25                               1/1     Running     3          24h<br/>kube-system            kube-apiserver-kubeadm25                     1/1     Running     3          24h<br/>kube-system            kube-controller-manager-kubeadm25            1/1     Running     3          24h<br/>kube-system            kube-flannel-ds-amd64-9sqxb                  1/1     Running     3          24h<br/>kube-system            kube-flannel-ds-amd64-nvzsf                  1/1     Running     3          24h<br/>kube-system            kube-proxy-gdr5b                             1/1     Running     3          24h<br/>kube-system            kube-proxy-mk785                             1/1     Running     3          24h<br/>kube-system            kube-scheduler-kubeadm25                     1/1     Running     3          24h<br/>kubernetes-dashboard   dashboard-metrics-scraper-779f5454cb-mqw2r   1/1     Running     3          24h<br/>kubernetes-dashboard   kubernetes-dashboard-64686c4bf9-2w5qh        1/1     Running     3          24h</strong></span></pre><p id="5fe7" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">到目前为止一切顺利！</p><p id="7985" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">系统中没有入口，让我们检查一下</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="4e67" class="le lf in la b gy lg lh l li lj">$ kubectl get ing<br/><strong class="la io">No resources found in default namespace.</strong></span></pre><p id="6b22" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">现在，我们可以在群集上应用入口资源定义。ingress2.yaml 是一个基于<strong class="jy io">主机的路由</strong>，它位于我们在上一步中创建的入口文件夹中</p><p id="883a" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">ingress2.yaml 的定义:</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="4c15" class="le lf in la b gy lg lh l li lj"><strong class="la io">apiVersion: extensions/v1beta1<br/>kind: Ingress<br/>metadata:<br/>  name: ingress-nginx<br/>  annotations:<br/>    nginx.ingress.kubernetes.io/rewrite-target: /<br/>    kubernetes.io/ingress.class: "nginx"<br/>    nginx.ingress.kubernetes.io/ssl-passthrough: "true"<br/>spec:<br/>  rules:<br/>  - host: hello.info<br/>    http:<br/>      paths:<br/>      - path: /<br/>        backend:<br/>          serviceName: web1-service<br/>          servicePort: 80<br/>  - host: world.info<br/>    http:<br/>      paths:<br/>      - path: /<br/>        backend:<br/>          serviceName: web2-service<br/>          servicePort: 80</strong></span></pre><p id="766e" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">让我们应用这个 yaml</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="9256" class="le lf in la b gy lg lh l li lj">$ kubectl apply -f ./ingress2.yaml <strong class="la io"><br/>ingress.extensions/ingress-nginx created<br/></strong>$ kubectl get ing<br/><strong class="la io">NAME            CLASS    HOSTS                   ADDRESS         PORTS   AGE<br/>ingress-nginx   &lt;none&gt;   hello.info,world.info   34.70.200.94   80      18h</strong></span></pre><p id="5aeb" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">在本地主机上添加“/etc/hosts”之后，服务将如下所示运行</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="b3f9" class="le lf in la b gy lg lh l li lj"><strong class="la io">ff02::3 ip6-allhosts<br/>169.254.169.254 metadata.google.internal metadata<br/>10.128.0.55 kubenode25.c.rosy-cache-200605.internal kubenode25  # Added by Google<br/>169.254.169.254 metadata.google.internal  # Added by Google<br/></strong>34.70.200.94 hello.info<br/>34.70.200.94 world.info</span></pre><p id="c999" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">让我们在运行服务的主机上使用 curl 命令检查服务…</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="8a0e" class="le lf in la b gy lg lh l li lj"><strong class="la io">FOR THE HOST:HELLO.info</strong></span><span id="132d" class="le lf in la b gy lt lh l li lj">$ curl <a class="ae ku" href="http://hello.info" rel="noopener ugc nofollow" target="_blank">http://hello.info</a><strong class="la io"><br/>&lt;!DOCTYPE html&gt;<br/>&lt;html&gt;<br/>&lt;head&gt;<br/>&lt;title&gt;Welcome to nginx!&lt;/title&gt;<br/>&lt;style&gt;<br/>    body {<br/>        width: 35em;<br/>        margin: 0 auto;<br/>        font-family: Tahoma, Verdana, Arial, sans-serif;<br/>    }<br/>&lt;/style&gt;<br/>&lt;/head&gt;<br/>&lt;body&gt;<br/>&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;<br/>&lt;p&gt;If you see this page, the nginx web server is successfully installed and<br/>working. Further configuration is required.&lt;/p&gt;</strong></span><span id="9a7f" class="le lf in la b gy lt lh l li lj"><strong class="la io">&lt;p&gt;For online documentation and support please refer to<br/>&lt;a href="</strong><a class="ae ku" href="http://nginx.org/" rel="noopener ugc nofollow" target="_blank"><strong class="la io">http://nginx.org/</strong></a><strong class="la io">"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;<br/>Commercial support is available at<br/>&lt;a href="</strong><a class="ae ku" href="http://nginx.com/" rel="noopener ugc nofollow" target="_blank"><strong class="la io">http://nginx.com/</strong></a><strong class="la io">"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</strong></span><span id="ba86" class="le lf in la b gy lt lh l li lj"><strong class="la io">&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;<br/>&lt;/body&gt;<br/>&lt;/html&gt;</strong></span><span id="1681" class="le lf in la b gy lt lh l li lj">------------------------------------------------------------</span><span id="1df6" class="le lf in la b gy lt lh l li lj"><strong class="la io">FOR THE HOST:WORLD.info</strong></span><span id="86ca" class="le lf in la b gy lt lh l li lj">$ curl <a class="ae ku" href="http://world.info" rel="noopener ugc nofollow" target="_blank">http://world.info</a><strong class="la io"><br/>&lt;!DOCTYPE html&gt;<br/>&lt;html&gt;<br/>&lt;head&gt;<br/>&lt;title&gt;Welcome to nginx!&lt;/title&gt;<br/>&lt;style&gt;<br/>    body {<br/>        width: 35em;<br/>        margin: 0 auto;<br/>        font-family: Tahoma, Verdana, Arial, sans-serif;<br/>    }<br/>&lt;/style&gt;<br/>&lt;/head&gt;<br/>&lt;body&gt;<br/>&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;<br/>&lt;p&gt;If you see this page, the nginx web server is successfully installed and<br/>working. Further configuration is required.&lt;/p&gt;</strong></span><span id="684f" class="le lf in la b gy lt lh l li lj"><strong class="la io">&lt;p&gt;For online documentation and support please refer to<br/>&lt;a href="</strong><a class="ae ku" href="http://nginx.org/" rel="noopener ugc nofollow" target="_blank"><strong class="la io">http://nginx.org/</strong></a><strong class="la io">"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;<br/>Commercial support is available at<br/>&lt;a href="</strong><a class="ae ku" href="http://nginx.com/" rel="noopener ugc nofollow" target="_blank"><strong class="la io">http://nginx.com/</strong></a><strong class="la io">"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</strong></span><span id="3463" class="le lf in la b gy lt lh l li lj"><strong class="la io">&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;<br/>&lt;/body&gt;<br/>&lt;/html&gt;</strong></span></pre><p id="0aea" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated"><strong class="jy io">答对了！我们成功地访问了两台主机 hello.info 和 world.info。</strong></p><p id="7ab4" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">上面的负载平衡器(带有 IP<strong class="jy io">34.70.200.94)</strong>对两台主机都工作得很好。如果您使用有效的 FQDN 创建了一个“cpanel”条目，那么该 FQDN 将进入主机的入口定义，您就可以向全世界推广您的服务了。</p><p id="f889" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">让我们做一个基于服务的路由，对入口定义做一个小的修改。我们正在删除主机部分，取而代之的是访问两个服务 web 1-http://LoadBalancerIP 上的服务和 http://LoadBalancerIP/nginx 上的 web 2-服务</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="65b1" class="le lf in la b gy lg lh l li lj"><strong class="la io">apiVersion: extensions/v1beta1<br/>kind: Ingress<br/>metadata:<br/>  name: ingress-nginx<br/>  annotations:<br/>    nginx.ingress.kubernetes.io/rewrite-target: /<br/>    kubernetes.io/ingress.class: "nginx"<br/>    nginx.ingress.kubernetes.io/ssl-passthrough: "true"<br/>spec:<br/>  rules:<br/>  - host: <br/>    http:<br/>      paths:<br/>      - path: /<br/>        backend:<br/>          serviceName: web1-service<br/>          servicePort: 80<br/>      - path: /nginx<br/>        backend:<br/>          serviceName: web2-service<br/>          servicePort: 80</strong></span></pre><p id="e1e5" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">在上面我们已经删除了主机部分。现在让我们应用这个</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="e7ca" class="le lf in la b gy lg lh l li lj">$ kubectl apply -f ./ingress1.yaml<br/><strong class="la io">ingress.extensions/ingress-nginx configured</strong></span><span id="2e81" class="le lf in la b gy lt lh l li lj">$ kubectl get ing <strong class="la io"><br/>ingress.extensions/ingress-nginx configured<br/>NAME            CLASS    HOSTS   ADDRESS         PORTS   AGE<br/>ingress-nginx   &lt;none&gt;   *       34.70.200.94   80      18h</strong></span></pre><p id="b345" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">请注意，Hosts 列是*表示它可以应用于任何主机</p><p id="e6f6" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">让我们检查 curl 命令，入口有一个 34.70.200.94 的外部 IP，这是由云控制器管理器在 GCP 创建的第 4 层负载平衡器</p><pre class="kv kw kx ky gt kz la lb lc aw ld bi"><span id="15cd" class="le lf in la b gy lg lh l li lj">$ curl <a class="ae ku" href="http://34.70.200.94/" rel="noopener ugc nofollow" target="_blank">http://34.70.200.94/</a><strong class="la io"><br/>&lt;!DOCTYPE html&gt;<br/>&lt;html&gt;<br/>&lt;head&gt;<br/>&lt;title&gt;Welcome to nginx!&lt;/title&gt;<br/>&lt;style&gt;<br/>    body {<br/>        width: 35em;<br/>        margin: 0 auto;<br/>        font-family: Tahoma, Verdana, Arial, sans-serif;<br/>    }<br/>&lt;/style&gt;<br/>&lt;/head&gt;<br/>&lt;body&gt;<br/>&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;<br/>&lt;p&gt;If you see this page, the nginx web server is successfully installed and<br/>working. Further configuration is required.&lt;/p&gt;</strong></span><span id="d3e7" class="le lf in la b gy lt lh l li lj"><strong class="la io">&lt;p&gt;For online documentation and support please refer to<br/>&lt;a href="</strong><a class="ae ku" href="http://nginx.org/" rel="noopener ugc nofollow" target="_blank"><strong class="la io">http://nginx.org/</strong></a><strong class="la io">"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;<br/>Commercial support is available at<br/>&lt;a href="</strong><a class="ae ku" href="http://nginx.com/" rel="noopener ugc nofollow" target="_blank"><strong class="la io">http://nginx.com/</strong></a><strong class="la io">"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</strong></span><span id="c753" class="le lf in la b gy lt lh l li lj"><strong class="la io">&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;<br/>&lt;/body&gt;<br/>&lt;/html&gt;<br/>____________________________________________________________</strong></span><span id="3dda" class="le lf in la b gy lt lh l li lj">$ curl <a class="ae ku" href="http://34.70.200.94/nginx" rel="noopener ugc nofollow" target="_blank">http://34.70.200.94/nginx</a><strong class="la io"><br/>&lt;!DOCTYPE html&gt;<br/>&lt;html&gt;<br/>&lt;head&gt;<br/>&lt;title&gt;Welcome to nginx!&lt;/title&gt;<br/>&lt;style&gt;<br/>    body {<br/>        width: 35em;<br/>        margin: 0 auto;<br/>font-family: Tahoma, Verdana, Arial, sans-serif;<br/>    }<br/>&lt;/style&gt;<br/>&lt;/head&gt;<br/>&lt;body&gt;<br/>&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;<br/>&lt;p&gt;If you see this page, the nginx web server is successfully installed and<br/>working. Further configuration is required.&lt;/p&gt;</strong></span><span id="b99c" class="le lf in la b gy lt lh l li lj"><strong class="la io">&lt;p&gt;For online documentation and support please refer to<br/>&lt;a href="</strong><a class="ae ku" href="http://nginx.org/" rel="noopener ugc nofollow" target="_blank"><strong class="la io">http://nginx.org/</strong></a><strong class="la io">"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;<br/>Commercial support is available at<br/>&lt;a href="</strong><a class="ae ku" href="http://nginx.com/" rel="noopener ugc nofollow" target="_blank"><strong class="la io">http://nginx.com/</strong></a><strong class="la io">"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</strong></span><span id="ef6b" class="le lf in la b gy lt lh l li lj"><strong class="la io">&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;<br/>&lt;/body&gt;<br/>&lt;/html&gt;</strong></span></pre><p id="c1bf" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">由于它是基于服务的，我们可以在世界各地使用<a class="ae ku" href="http://Loadbalancer-IP" rel="noopener ugc nofollow" target="_blank"> http://Loadbalancer-IP </a>和<a class="ae ku" href="http://LoadBalancer-IP/nginx" rel="noopener ugc nofollow" target="_blank">http://load balancer-IP/nginx</a>从任何浏览器访问它！</p><figure class="kv kw kx ky gt jp gh gi paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="gh gi mj"><img src="../Images/146ea2f89812e50927517b5311afcf8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N06hVH80DDLXQQIKBMe8SA.png"/></div></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk translated">服务 1</figcaption></figure><figure class="kv kw kx ky gt jp gh gi paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="gh gi mj"><img src="../Images/5a33cf3e568d2239f4492ff0ed914cde.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tjXQTiXlheCmh_ZzFbvfAA.png"/></div></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk translated">服务 2</figcaption></figure><p id="07b6" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">如果您将“Ingress1.yaml”和“Ingress2.yaml”组合在一起，生成一个文件并应用它；然后，我们将有一个用于所有 4 个服务定义的负载平衡器 IP，我只是将它分成两部分，以显示不同类型的负载平衡。</p></div><div class="ab cl mo mp hr mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="ig ih ii ij ik"><p id="0652" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">清理:完成实验后，您可以停止创建的主节点和工作节点实例，然后转到 GCP 控制台和负载平衡选项，删除为 web1 和 Web2 服务动态创建的负载平衡器以及入口负载平衡器。下次重新启动主节点和工作节点(基本上是集群)时，会自动创建负载平衡器。现在，您不用为任何不使用的集群服务付费了！</p><p id="dd6a" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">希望这是有帮助的！</p></div><div class="ab cl mo mp hr mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="ig ih ii ij ik"><p id="af4c" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">您可能还对以下内容感兴趣:</p><div class="mv mw gp gr mx my"><a href="https://medium.com/faun/kubernetes-install-101-with-kubeadm-149b70626a9f" rel="noopener follow" target="_blank"><div class="mz ab fo"><div class="na ab nb cl cj nc"><h2 class="bd io gy z fp nd fr fs ne fu fw im bi translated">Kubernetes 用 kubeadm 安装 101</h2><div class="nf l"><h3 class="bd b gy z fp nd fr fs ne fu fw dk translated">在您的测试环境中使用 kubeadm 启动 Kubernetes 集群的简单方法。</h3></div><div class="ng l"><p class="bd b dl z fp nd fr fs ne fu fw dk translated">medium.com</p></div></div><div class="nh l"><div class="ni l nj nk nl nh nm ju my"/></div></div></a></div><div class="mv mw gp gr mx my"><a href="https://medium.com/faun/dynamic-provisioning-of-storage-on-a-gcp-kubernetes-cluster-using-helm-charts-795f576e0cab" rel="noopener follow" target="_blank"><div class="mz ab fo"><div class="na ab nb cl cj nc"><h2 class="bd io gy z fp nd fr fs ne fu fw im bi translated">使用舵图在 GCP Kubernetes 集群上动态配置存储</h2><div class="nf l"><h3 class="bd b gy z fp nd fr fs ne fu fw dk translated">在本文中，我们将安装 Kubernetes 包管理器“helm ”,并在 Kubernetes 上部署一个 Statefulset</h3></div><div class="ng l"><p class="bd b dl z fp nd fr fs ne fu fw dk translated">medium.com</p></div></div><div class="nh l"><div class="nn l nj nk nl nh nm ju my"/></div></div></a></div><div class="mv mw gp gr mx my"><a href="https://medium.com/swlh/securing-services-in-kubernetes-d2920503fb9" rel="noopener follow" target="_blank"><div class="mz ab fo"><div class="na ab nb cl cj nc"><h2 class="bd io gy z fp nd fr fs ne fu fw im bi translated">在 kubernetes 中保护服务</h2><div class="nf l"><h3 class="bd b gy z fp nd fr fs ne fu fw dk translated">任何企业都需要与其服务产品的安全连接。在上一篇关于设置的文章中…</h3></div><div class="ng l"><p class="bd b dl z fp nd fr fs ne fu fw dk translated">medium.com</p></div></div><div class="nh l"><div class="no l nj nk nl nh nm ju my"/></div></div></a></div><p id="942a" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated"><strong class="jy io">ansi ble Playbook for AWS</strong>:<a class="ae ku" href="https://medium.com/@rangapv/new-ansible-playbook-with-roles-vault-to-create-an-instance-in-aws-from-anywhere-1584b906cd43" rel="noopener">https://medium . com/@ rang apv/new-ansi ble-Playbook-with-roles-vault-to-create-a-instance-in-AWS-from-anywhere-1584 b 906 CD 43</a></p></div><div class="ab cl mo mp hr mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="ig ih ii ij ik"><p id="91b0" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated"><strong class="jy io">参考:</strong> Nginx 入口控制器的官方步骤、安装方法以及其他云提供商步骤可在以下链接中找到</p><div class="mv mw gp gr mx my"><a href="https://kubernetes.github.io/ingress-nginx/deploy/#gce-gke" rel="noopener  ugc nofollow" target="_blank"><div class="mz ab fo"><div class="na ab nb cl cj nc"><h2 class="bd io gy z fp nd fr fs ne fu fw im bi translated">安装指南— NGINX 入口控制器</h2><div class="nf l"><h3 class="bd b gy z fp nd fr fs ne fu fw dk translated">注意默认配置监视来自所有名称空间的入口对象。要改变这种行为，请使用…</h3></div><div class="ng l"><p class="bd b dl z fp nd fr fs ne fu fw dk translated">kubernetes.github.io</p></div></div></div></a></div></div></div>    
</body>
</html>