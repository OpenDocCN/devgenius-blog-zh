# SQL äº‹åŠ¡è½¯ä»‹ç»

> åŸæ–‡ï¼š<https://blog.devgenius.io/sql-transactions-150b99fafc14?source=collection_archive---------5----------------------->

![](img/168864b81fbe5bc48cf4e52b7fe635cb.png)

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†æ¢è®¨ SQL äº‹åŠ¡çš„åŸºç¡€çŸ¥è¯†ã€‚

## ğŸ¤”é¦–å…ˆï¼Œä»€ä¹ˆæ˜¯äº‹åŠ¡å¤„ç†ï¼Ÿ

é€šè¿‡ç¡®ä¿æ‰¹é‡ SQL æ“ä½œå®Œå…¨è¿è¡Œæˆ–æ ¹æœ¬ä¸è¿è¡Œï¼Œäº‹åŠ¡å¤„ç†ç”¨äºä¿æŒæ•°æ®åº“çš„å®Œæ•´æ€§ã€‚

åœ¨ç»§ç»­ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªç”µå­å•†åŠ¡ç³»ç»Ÿï¼Œå…¶ä¸­æœ‰ä¸¤ä¸ªè®¢å•è¡¨(ordersã€OrderItems)å’Œä¸€ä¸ªå®¢æˆ·è¡¨ã€‚

![](img/4e9af4016408a8bd4f9f4f445ce61f27.png)

å®¢æˆ·è¡¨

![](img/7e4a20ed0fd247a4cee85af5b3089cc2.png)

è®¢å•è¡¨

![](img/65d9f7e078b9a6d5d2a6195d0f127111.png)

è®¢å•é¡¹ç›®è¡¨

è®¢å•è¡¨å°±æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ã€‚è®¢å•ä¿å­˜åœ¨ä¸¤ä¸ªè¡¨ä¸­:Orders è·Ÿè¸ªå®é™…è®¢å•ï¼Œè€Œ OrderItems è·Ÿè¸ªè®¢è´­çš„ç‰¹å®šé¡¹ç›®ã€‚ä½¿ç”¨ç§°ä¸ºä¸»é”®çš„å”¯ä¸€ idï¼Œè¿™ä¸¤ä¸ªè¡¨ç›¸äº’è¿æ¥ã€‚è¿™äº›è¡¨é“¾æ¥åˆ°åŒ…å«å®¢æˆ·å’Œäº§å“æ•°æ®çš„å…¶ä»–è¡¨ã€‚

å‘ç³»ç»Ÿæ·»åŠ è®¢å•æ¶‰åŠä»¥ä¸‹æ­¥éª¤:

1.  éªŒè¯æ•°æ®åº“ï¼ŒæŸ¥çœ‹å®¢æˆ·æ˜¯å¦å·²ç»åœ¨é‚£é‡Œã€‚å¦‚æœæ²¡æœ‰ï¼Œè¯·æ·»åŠ è¯¥äººã€‚
2.  è·å–å®¢æˆ·çš„ IDã€‚
3.  åº”è¯¥åœ¨ Orders è¡¨ä¸­æ·»åŠ ä¸€è¡Œï¼Œå°†å…¶é“¾æ¥åˆ°å®¢æˆ· IDã€‚
4.  ä» Orders è¡¨ä¸­è·å–æ–°åˆ†é…çš„è®¢å• IDã€‚
5.  å¯¹äºè®¢è´­çš„æ¯é¡¹å•†å“ï¼Œå‘ OrderItems è¡¨æ·»åŠ ä¸€è¡Œï¼Œå¹¶ä½¿ç”¨æ£€ç´¢åˆ°çš„ ID å°†å…¶é“¾æ¥åˆ° Orders è¡¨(é€šè¿‡äº§å“ ID é“¾æ¥åˆ° Products è¡¨)ã€‚

## ğŸ¥¸ä»€ä¹ˆæ˜¯**äº¤æ˜“å¤„ç†**

*äº‹åŠ¡å¤„ç†*æ˜¯ä¸€ç§ç®¡ç†å¿…é¡»æˆç»„æ‰§è¡Œçš„ SQL æ“ä½œé›†çš„æ–¹æ³•ï¼Œç¡®ä¿æ•°æ®åº“ä¸ä¼šå­˜å‚¨ä¸å®Œæ•´æ“ä½œçš„ç»“æœã€‚ä½¿ç”¨äº‹åŠ¡å¤„ç†ï¼Œæ‚¨å¯ä»¥ç¡®ä¿æ“ä½œé›†ä¸ä¼šåœ¨è¿‡ç¨‹ä¸­é—´åœæ­¢å¤„ç†ï¼›ç›¸åï¼Œå®ƒä»¬è¦ä¹ˆå®Œå…¨å®Œæˆå¤„ç†ï¼Œè¦ä¹ˆæ ¹æœ¬ä¸å®Œæˆå¤„ç†(é™¤éå¦æœ‰æ˜ç¡®æŒ‡ç¤º)ã€‚å¦‚æœæ²¡æœ‰é”™è¯¯ï¼Œæ•´ä¸ªè¯­å¥é›†å°†è¢«æäº¤(å†™å…¥)åˆ°æ•°æ®åº“è¡¨ä¸­ã€‚å¦‚æœç¡®å®å‘ç”Ÿäº†é”™è¯¯ï¼Œå¯ä»¥æ‰§è¡Œå›æ»š(æ’¤æ¶ˆ)æ¥å°†æ•°æ®åº“è¿”å›åˆ°å·²çŸ¥çš„å®‰å…¨çŠ¶æ€ã€‚

æ‰€ä»¥åŸºæœ¬ä¸Š:

1.  **äº‹åŠ¡**:ä¸€æ®µ SQL è¯­å¥ã€‚
2.  **å›æ»š**:æ’¤é”€æŒ‡å®š SQL è¯­å¥çš„è¿‡ç¨‹ã€‚
3.  **æäº¤**:å°†æœªä¿å­˜çš„ SQL è¯­å¥å†™å…¥æ•°æ®åº“è¡¨ã€‚
4.  **ä¿å­˜ç‚¹**:äº‹åŠ¡é›†ä¸­çš„ä¸´æ—¶å ä½ç¬¦ï¼Œå¯ä»¥å‘å…¶å‘å‡ºå›æ»šå‘½ä»¤(ä¸å›æ»šæ•´ä¸ªäº‹åŠ¡ç›¸å)ã€‚

æ‚¨å¯ä»¥**å›æ»šå“ªäº›è¯­å¥ï¼Ÿ**

INSERTã€UPDATE å’Œ DELETE è¯­å¥çš„ç®¡ç†ä½¿ç”¨äº‹åŠ¡å¤„ç†ã€‚ä½¿ç”¨ SELECT æ‰€åšçš„è¯­å¥æ˜¯ä¸å¯é€†çš„ã€‚(æ— è®ºå¦‚ä½•ï¼Œè¿™æ ·åšæ²¡æœ‰ä»€ä¹ˆæ„ä¹‰ã€‚)åˆ›å»ºå’Œåˆ é™¤ç­‰æ“ä½œæ— æ³•æ’¤æ¶ˆã€‚è¿™äº›è¯­å¥å¯ä»¥åœ¨äº‹åŠ¡å—ä¸­ä½¿ç”¨ï¼Œä½†æ˜¯å¦‚æœæ‚¨æ‰§è¡Œå›æ»šï¼Œå®ƒä»¬å°†ä¸ä¼šè¢«æ’¤é”€ã€‚

å› æ­¤ï¼Œä½¿ç”¨ç›¸åŒçš„ç¤ºä¾‹ï¼Œè¿‡ç¨‹å¦‚ä¸‹:

1.  éªŒè¯å®¢æˆ·æ˜¯å¦å·²ç»åœ¨æ•°æ®åº“ä¸­ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™æ·»åŠ ä»–ä»¬ã€‚
2.  ä¼ é€’å®¢æˆ·æ•°æ®ã€‚
3.  è·å–å®¢æˆ·çš„ IDã€‚
4.  å‘ Orders è¡¨ä¸­æ·»åŠ ä¸€è¡Œã€‚
5.  å¦‚æœå°†è¡Œæ·»åŠ åˆ°è®¢å•æ—¶å‡ºç°é—®é¢˜ï¼Œè¯·å›æ»šã€‚
6.  ä» Orders è¡¨ä¸­è·å–æ–°åˆ†é…çš„è®¢å• IDã€‚
7.  å¯¹äºæ¯ä¸ªè®¢è´­çš„é¡¹ç›®ï¼Œåœ¨ OrderItems è¡¨ä¸­æ·»åŠ ä¸€è¡Œã€‚
8.  å¦‚æœå‘ OrderItems æ·»åŠ è¡Œæ—¶å‡ºç°æ•…éšœï¼Œåˆ™å›æ»šæ‰€æœ‰å·²æ·»åŠ çš„ OrderItems è¡Œå’Œ Orders è¡Œã€‚

## äº¤æ˜“çš„ğŸ¥³å±æ€§

äº‹åŠ¡çš„ä»¥ä¸‹å››ä¸ªå¸¸è§å±æ€§è¢«ç§°ä¸º ACIDï¼Œå¦‚ä¸‹æ‰€ç¤º:

*   **åŸå­æ€§**â€”â€”ç¡®ä¿å·¥ä½œå•å…ƒå†…çš„æ¯ä¸ªæ“ä½œéƒ½æ˜¯æˆåŠŸçš„ï¼›å¦åˆ™ï¼Œäº‹åŠ¡å°†åœ¨æ•…éšœç‚¹æš‚åœï¼Œå…ˆå‰çš„æ“ä½œå°†è¢«æ’¤æ¶ˆã€‚
*   **ä¸€è‡´æ€§**â€”ç¡®ä¿åœ¨æˆåŠŸæäº¤äº‹åŠ¡åï¼Œæ•°æ®åº“ä¼šç›¸åº”åœ°æ”¹å˜çŠ¶æ€ã€‚
*   **éš”ç¦»**â€”å…è®¸ç‹¬ç«‹å’Œé€æ˜çš„äº¤æ˜“æ“ä½œã€‚
*   **æŒä¹…æ€§**ç¡®ä¿åœ¨ç³»ç»Ÿå‡ºç°æ•…éšœæ—¶ï¼Œå·²æäº¤äº¤æ˜“çš„ç»“æœæˆ–å½±å“ä»ç„¶å­˜åœ¨ã€‚

## **âš ï¸æ§åˆ¶äº¤æ˜“**

***æ³¨*** *:ç®¡ç†äº‹åŠ¡çš„å…³é”®åœ¨äºå°† SQL è¯­å¥åˆ†è§£æˆé€»è¾‘å—ï¼Œå¹¶æ˜ç¡®è¯´æ˜æ•°æ®ä½•æ—¶åº”è¯¥å›æ»šï¼Œä½•æ—¶ä¸åº”è¯¥å›æ»šã€‚*

***æ³¨æ„*** *:æœ‰äº› DBMSs è¦æ±‚ä½ æ˜¾å¼æ ‡è®°äº‹åŠ¡å—çš„å¼€å§‹å’Œç»“æŸã€‚*

## SQL Server

![](img/2af6aba9d45313b2c8277ae701f62ad9.png)

## Postgres

![](img/750525a3cf1425eecfcbe109eac71999.png)

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåœ¨ BEGIN TRANSACTION å’Œ COMMIT TRANSACTION è¯­å¥ä¹‹é—´æ‰§è¡Œçš„æ‰€æœ‰ SQL éƒ½å¿…é¡»å®Œæˆï¼Œå¦åˆ™æ— æ³•ä½¿ç”¨ã€‚å…¶ä»–æ•°æ®åº“ç®¡ç†ç³»ç»Ÿä½¿ç”¨ä¸Šè¿°å†…å®¹çš„å˜ä½“ã€‚æ‚¨ä¼šå‘ç°å¤§å¤šæ•°å®ç°éƒ½æ²¡æœ‰æ˜ç¡®çš„äº‹åŠ¡ç»“æŸã€‚ç›¸åï¼Œäº‹åŠ¡ä¼šç»§ç»­è¿›è¡Œï¼Œç›´åˆ°æŸä¸ªäº‹ä»¶ç»“æŸå®ƒï¼Œé€šå¸¸æ˜¯å›æ»šä»¥æ’¤é”€æ›´æ”¹æˆ–æäº¤ä»¥ä¿å­˜æ›´æ”¹ã€‚

## **ğŸ‘¾ä½¿ç”¨** `**ROLLBACK**`

SQL `ROLLBACK`å‘½ä»¤ç”¨äºå›æ»š(æ’¤é”€)SQL è¯­å¥ï¼Œå¦‚ä¸‹ä¸€æ¡è¯­å¥æ‰€ç¤º:

![](img/65184b10d7ce2338e93c7a6b3bffee63.png)

åœ¨æ­¤å›¾ä¸­ï¼Œæ‰§è¡Œäº†ä¸€ä¸ªåˆ é™¤æ“ä½œï¼Œç„¶åä½¿ç”¨ ROLLBACK è¯­å¥å°†å…¶åè½¬ã€‚å°½ç®¡è¿™ä¸æ˜¯æœ€å¥½çš„è¯´æ˜ï¼Œä½†å®ƒç¡®å®è¡¨æ˜åˆ é™¤æ“ä½œâ€”â€”ä¸åŒäºæ’å…¥å’Œæ›´æ–°æ“ä½œâ€”â€”åœ¨ä¸€ä¸ªäº‹åŠ¡å—ä¸­æ°¸è¿œä¸æ˜¯æœ€ç»ˆçš„ã€‚

## **ğŸ«¡åˆ©ç”¨**

é€šå¸¸ï¼ŒSQL è¯­å¥è¢«ç›´æ¥æ‰§è¡Œå¹¶å†™å…¥æ•°æ®åº“è¡¨ã€‚è¿™è¢«ç§°ä¸º*éšå¼æäº¤* â€”æäº¤(å†™æˆ–ä¿å­˜)æ“ä½œè‡ªåŠ¨å‘ç”Ÿã€‚

ä½†æ˜¯ï¼Œåœ¨äº‹åŠ¡å—ä¸­ï¼Œæäº¤å¯èƒ½ä¸ä¼šéšå¼å‘ç”Ÿã€‚è¿™ä¹Ÿæ˜¯ DBMS ç‰¹æœ‰çš„ã€‚ä¸€äº› DBMSs å°†äº‹åŠ¡ç»“æŸè§†ä¸ºéšå¼æäº¤ï¼›å…¶ä»–äººæ²¡æœ‰ã€‚

è¦å¼ºåˆ¶æ˜¾å¼æäº¤ï¼Œå¯ä»¥ä½¿ç”¨`COMMIT`è¯­å¥ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ª SQL Server ç¤ºä¾‹:

![](img/a5d0d79ea9f645b0b09eed8b53ae2d17.png)

åœ¨ SQL Server ç¤ºä¾‹ä¸­ï¼Œè®¢å•ç¼–å· 12345 å·²ä»æ•°æ®åº“ä¸­å®Œå…¨åˆ é™¤ã€‚äº‹åŠ¡å—ç”¨äºç¡®ä¿è®¢å•ä¸ä¼šè¢«éƒ¨åˆ†åˆ é™¤ï¼Œå› ä¸ºè¿™æ¶‰åŠåˆ°æ›´æ–°ä¸¤ä¸ªæ•°æ®åº“è¡¨ Orders å’Œ OrderItemsã€‚å¦‚æœæ²¡æœ‰é”™è¯¯ï¼Œæœ€ç»ˆçš„ COMMIT è¯­å¥åªå†™å…¥æ›´æ”¹ã€‚å¦‚æœç¬¬ä¸€æ¬¡åˆ é™¤æˆåŠŸï¼Œä½†ç¬¬äºŒæ¬¡åˆ é™¤å¤±è´¥ï¼Œåˆ™ä¸ä¼šæäº¤åˆ é™¤ã€‚

## **âœ…ä½¿ç”¨æ‹¯æ•‘ç‚¹æ•°**

ç®€å•çš„`ROLLBACK`å’Œ`COMMIT`è¯­å¥ä½¿æ‚¨èƒ½å¤Ÿç¼–å†™æˆ–æ’¤é”€æ•´ä¸ªäº‹åŠ¡ã€‚å°½ç®¡è¿™ç§æ–¹æ³•é€‚ç”¨äºç®€å•çš„äº‹åŠ¡ï¼Œä½†æ›´å¤æ‚çš„äº‹åŠ¡å¯èƒ½éœ€è¦éƒ¨åˆ†æäº¤æˆ–å›æ»šã€‚

ä¾‹å¦‚ï¼Œå‰é¢æè¿°çš„æ·»åŠ è®¢å•çš„è¿‡ç¨‹æ˜¯ä¸€ä¸ªå•ä¸€çš„äº‹åŠ¡ã€‚å¦‚æœå‡ºç°é”™è¯¯ï¼Œæ‚¨åªæƒ³å›æ»šåˆ°æ·»åŠ `Orders`è¡Œä¹‹å‰çš„ç‚¹ã€‚æ‚¨ä¸å¸Œæœ›å›æ»šåˆ°`Customers`è¡¨çš„æ·»åŠ (å¦‚æœæœ‰çš„è¯)ã€‚

ä¸ºäº†æ”¯æŒéƒ¨åˆ†äº‹åŠ¡çš„å›æ»šï¼Œæ‚¨å¿…é¡»èƒ½å¤Ÿåœ¨äº‹åŠ¡å—ä¸­çš„å…³é”®ä½ç½®æ”¾ç½®å ä½ç¬¦ã€‚ç„¶åï¼Œå¦‚æœéœ€è¦å›æ»šï¼Œæ‚¨å¯ä»¥å›æ»šåˆ°å…¶ä¸­ä¸€ä¸ªå ä½ç¬¦ã€‚

åœ¨ SQL ä¸­ï¼Œè¿™äº›å ä½ç¬¦è¢«ç§°ä¸º*ä¿å­˜ç‚¹*ã€‚è¦åœ¨ MariaDBã€MySQL å’Œ Oracle ä¸­åˆ›å»ºä¸€ä¸ªï¼Œå¯ä»¥ä½¿ç”¨`SAVEPOINT`è¯­å¥ï¼Œå¦‚ä¸‹æ‰€ç¤º:

![](img/6137fdeb0783a0b62ab215d3f1251449.png)

æ¯ä¸ªä¿å­˜ç‚¹éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„åç§°æ¥æ ‡è¯†å®ƒï¼Œè¿™æ ·å½“æ‚¨å›æ»šæ—¶ï¼ŒDBMS å°±çŸ¥é“æ‚¨å›æ»šåˆ°äº†å“ªé‡Œã€‚è¦å›æ»šåˆ°è¯¥ä¿å­˜ç‚¹ï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œ

![](img/e02b883dcd6a9ed4986b18205e7a2996.png)

## ğŸš§å®Œæ•´ç¤ºä¾‹:

![](img/3a930df94f61650876dd5edc11bd8f78.png)

SQL Server äº‹åŠ¡

è¿™é‡Œï¼Œä¸€ä¸ªäº‹åŠ¡å—åŒ…å«å››ä¸ª INSERT è¯­å¥ã€‚åœ¨ç¬¬ä¸€æ¬¡æ’å…¥åï¼Œä¼šå»ºç«‹ä¸€ä¸ªä¿å­˜ç‚¹ï¼Œè¿™æ ·ï¼Œå¦‚æœä»»ä½•åç»­çš„æ’å…¥æ“ä½œå¤±è´¥ï¼Œäº‹åŠ¡åªä¼šå›æ»šåˆ°è¯¥ç‚¹ã€‚å¦‚æœæ“ä½œå¤±è´¥ï¼Œå¯ä»¥é€šè¿‡æŸ¥çœ‹ SQL Server ä¸­çš„@@ERROR å˜é‡æ¥æ£€æŸ¥ã€‚(å…¶ä»– DBMSs ä½¿ç”¨å„ç§å‡½æ•°æˆ–å˜é‡è¿”å›æ­¤æ•°æ®ã€‚)å‘ç”Ÿé”™è¯¯ï¼Œå¦‚æœ@@ERROR è¿”å› 0 ä»¥å¤–çš„å€¼ï¼Œäº‹åŠ¡å°†å›æ»šåˆ°ä¿å­˜ç‚¹ã€‚å¦‚æœæ•´ä¸ªäº‹åŠ¡æˆåŠŸï¼Œå°†å‘é€ä¸€ä¸ªæäº¤æ¥ä¿å­˜æ•°æ®ã€‚

> *ä½ å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ä¸€ä¸ªå¾ˆæ£’çš„ Postgres çš„ä¾‹å­*[*https://www . tutorialspoint . com/PostgreSQL/PostgreSQL _ transactions . htm*](https://www.tutorialspoint.com/postgresql/postgresql_transactions.htm)