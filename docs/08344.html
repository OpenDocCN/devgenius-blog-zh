<html>
<head>
<title>Autoregister Django ModelAdmins</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">自动注册 Django 模型管理员</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/autoregister-django-modeladmins-7d7ac9a57e44?source=collection_archive---------4-----------------------#2022-06-07">https://blog.devgenius.io/autoregister-django-modeladmins-7d7ac9a57e44?source=collection_archive---------4-----------------------#2022-06-07</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/f252b7113616fec208eef2ea7b6cbc0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P2dCHpOO_MJwY_MT5oxhew.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">自动注册 Django 模型管理员</figcaption></figure><p id="53e6" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">前一段时间我发现 Django 有自动注册<code class="fe kx ky kz la b">ModelAdmins</code>的能力。因为这不是常识，而且有很多好处，所以我决定写一篇文章来引起 Django 社区的注意。</p><p id="7133" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">首先，我们来复习一下如何正常注册<code class="fe kx ky kz la b">ModelAdmin</code>的基础知识。</p><h1 id="efac" class="lb lc in bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">标准<code class="fe kx ky kz la b">ModelAdmin</code>注册</h1><p id="abd0" class="pw-post-body-paragraph jz ka in kb b kc lz ke kf kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw ig bi translated">为了注册<code class="fe kx ky kz la b">ModelAdmin</code>，我们首先创建一个模型:</p><figure class="me mf mg mh gt jo"><div class="bz fp l di"><div class="mi mj l"/></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">Django 模型创建</figcaption></figure><p id="665e" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">接下来，您需要创建一个<code class="fe kx ky kz la b">ModelAdmin</code>，并将其注册到<code class="fe kx ky kz la b">SiteAdmin</code>上的模型中。</p><figure class="me mf mg mh gt jo"><div class="bz fp l di"><div class="mi mj l"/></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">模型管理员创建</figcaption></figure><p id="4159" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">现在让我们运行我们的开发服务器，看看它是否工作。</p><figure class="me mf mg mh gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mk"><img src="../Images/8f0d9b5e7a8cd07c94f00bfb181bf504.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C0T6ExHZoHOhLVUC6IdrtQ.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">有事发生了</figcaption></figure><p id="8254" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">但是这些是什么？一些额外的<code class="fe kx ky kz la b">ModelAdmins</code>被注册，但是我们从来没有定义它们。这意味着 Django 正在某个地方自动注册这些标准<code class="fe kx ky kz la b">ModelAdmins</code>。</p><h1 id="f006" class="lb lc in bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">Django <code class="fe kx ky kz la b">ModelAdmins</code>集成自动注册。</h1><p id="eb79" class="pw-post-body-paragraph jz ka in kb b kc lz ke kf kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw ig bi translated">经过对<code class="fe kx ky kz la b">django.contrib.admin.apps</code>的一番挖掘，我发现这些<code class="fe kx ky kz la b">ModelAdmins</code>都注册在<code class="fe kx ky kz la b">AdminConfig</code>类的<code class="fe kx ky kz la b">ready</code>方法中。</p><pre class="me mf mg mh gt ml la mm mn aw mo bi"><span id="99e8" class="mp lc in la b gy mq mr l ms mt">class AdminConfig(SimpleAdminConfig):<br/>    """The default AppConfig for admin which does autodiscovery."""<br/><br/>    default = True<br/><br/>    def ready(self):<br/>        super().ready()<br/>        self.module.autodiscover()</span></pre><p id="7f7f" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">如果我们不仅为自动注册标准 Django 模型，而且为我们自己的模型包装这个方法，我们可以利用这个事实。</p><p id="7e89" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">我们可以这样做:</p><figure class="me mf mg mh gt jo"><div class="bz fp l di"><div class="mi mj l"/></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">模型管理自动注册</figcaption></figure><p id="ea78" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">我们检查了项目中的所有<code class="fe kx ky kz la b">AppConfigs</code>，并从<code class="fe kx ky kz la b">AppConfigs</code>获取了管理模块。当然，如果管理模块存在，情况就是这样。<br/>然后，我们将浏览此<code class="fe kx ky kz la b">AppConfig</code>中的所有模型。<br/>在那里，我们检查该型号是否已经在<code class="fe kx ky kz la b">SiteAdmin</code>注册。</p><p id="4aa4" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">如果没有，我们在管理模块中搜索名为' *model_name*ModelAdmin '的<code class="fe kx ky kz la b">ModelAdmin</code>类。如果没有定义这样的类，我们使用<code class="fe kx ky kz la b">None</code>。</p><p id="f7b3" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">最后，我们使用在<code class="fe kx ky kz la b">SiteAdmin</code>上找到的<code class="fe kx ky kz la b">ModelAdmin</code>来注册模型。</p><p id="3b58" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">如果没有定义<code class="fe kx ky kz la b">ModelAdmin</code>，默认情况下<code class="fe kx ky kz la b">register</code>方法会将模型注册到<code class="fe kx ky kz la b">ModelAdmin</code>类。</p><p id="0ace" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">但是你为什么要这样做呢？</p><h1 id="87e5" class="lb lc in bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">利益</h1><h1 id="17b6" class="lb lc in bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">1.较短的代码</h1><p id="831c" class="pw-post-body-paragraph jz ka in kb b kc lz ke kf kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw ig bi translated">使用这种注册<code class="fe kx ky kz la b">ModelAdmins</code>的方法，您可以在一个 10 行的解决方案中注册多行代码。</p><p id="09ee" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">您可以告别空的<code class="fe kx ky kz la b">ModelAdmin</code>类来注册模型，如果您以前做过的话。任何<code class="fe kx ky kz la b">ModelAdmin</code>上不再有<code class="fe kx ky kz la b">@admin.register(model)</code>包装纸。<br/>最重要的是，在模块管理中不再有冗长的模型导入列表。</p><p id="c6b5" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">根据你有多少型号和多少<code class="fe kx ky kz la b">ModelAdmins</code>需要注册，你可以节省很多行代码。</p><h1 id="992a" class="lb lc in bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">2.更容易开发</h1><p id="86fe" class="pw-post-body-paragraph jz ka in kb b kc lz ke kf kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw ig bi translated">继续上一点的想法，你不再需要担心在开发过程中注册<code class="fe kx ky kz la b">ModelAdmin</code>，因为当服务器启动时，一切都会自动发生。</p><h1 id="0645" class="lb lc in bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">3.循环进口</h1><p id="41d0" class="pw-post-body-paragraph jz ka in kb b kc lz ke kf kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw ig bi translated">在当前的系统中，管理模块中有大量的导入列表，获得循环导入并找到解决方法并不困难。有了这个解决方案，这些导入列表就没有了，您再也不用担心模型和循环导入。</p><h1 id="9c12" class="lb lc in bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">变化</h1><p id="db8c" class="pw-post-body-paragraph jz ka in kb b kc lz ke kf kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw ig bi translated">有时你不想在当前的<code class="fe kx ky kz la b">SiteAdmin</code>上注册你所有的型号，那么你会怎么做？</p><p id="99bc" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">当然你可以随意修改上面的解决方案，但是在这里我想给你一些解决最常见问题的思路。</p><h1 id="5499" class="lb lc in bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">仅注册特定型号</h1><p id="5c00" class="pw-post-body-paragraph jz ka in kb b kc lz ke kf kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw ig bi translated">如果我们想用<code class="fe kx ky kz la b">ModelAdmins</code>只注册需要的模型，我们可以在管理模块中只定义需要的<code class="fe kx ky kz la b">ModelAdmins</code>，并执行以下操作:</p><figure class="me mf mg mh gt jo"><div class="bz fp l di"><div class="mi mj l"/></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">特殊车型的自动注册</figcaption></figure><p id="ee46" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">在这个解决方案中，您需要为每个所需的模型添加管理模块<code class="fe kx ky kz la b">**ModelName**ModelAdmin</code>类。</p><p id="206f" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">或者，如果模型应该自动注册，您可以向它添加一个标志。</p><figure class="me mf mg mh gt jo"><div class="bz fp l di"><div class="mi mj l"/></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">Django 模型中的特殊标志“autoregister_model”</figcaption></figure><h1 id="6bd6" class="lb lc in bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">移除标准注册模型</h1><p id="07a9" class="pw-post-body-paragraph jz ka in kb b kc lz ke kf kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw ig bi translated">也许您不需要在您的项目中注册标准的 Django 模型。您可以通过在 ready 方法中添加一行简单的代码来删除它们。</p><figure class="me mf mg mh gt jo"><div class="bz fp l di"><div class="mi mj l"/></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">默认情况下，删除已注册的模型。</figcaption></figure><p id="f519" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">这些只是使用 Django 自动注册的一些选项。我相信您可以想出其他聪明的方法来使用它，我希望这篇文章是有用的。</p><p id="24ac" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">我感谢 Martin Achenrainer，他是我公司的学徒，他翻译并协助了这篇英文文章。这个想法于 2021 年 9 月在 PyCon RU 首次提出</p><p id="a9dd" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">马丁·阿肯赖纳的一些话。</strong></p><blockquote class="mv mw mx"><p id="7abb" class="jz ka my kb b kc kd ke kf kg kh ki kj mz kl km kn na kp kq kr nb kt ku kv kw ig bi translated">我要感谢马克西姆·达尼洛夫和他的 wP soft 公司给了我在工作场所学习和提高编程技能的机会。</p></blockquote></div></div>    
</body>
</html>