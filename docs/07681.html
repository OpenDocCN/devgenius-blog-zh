<html>
<head>
<title>Easily Manage your Application Shipment With Differentiated Configuration in Multi-Cluster</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">借助多集群中的差异化配置，轻松管理您的应用交付</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/easily-manage-your-application-shipment-with-differentiated-configuration-in-multi-cluster-cc6f9a2312a9?source=collection_archive---------11-----------------------#2022-04-14">https://blog.devgenius.io/easily-manage-your-application-shipment-with-differentiated-configuration-in-multi-cluster-cc6f9a2312a9?source=collection_archive---------11-----------------------#2022-04-14</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="aa34" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><em class="ki">由段威@BinaryHB 在推特上发布</em></p><p id="b554" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在当今的多集群业务场景下，我们经常会遇到这些典型的需求:分布到多个特定的集群，根据业务需求进行特定的分组分布，以及针对多集群的差异化配置。</p><p id="f546" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">KubeVela v1.3 在之前多集群功能的基础上进行迭代。本文将揭示如何使用它进行快速的多集群部署和管理，以解决您的所有焦虑。</p><h1 id="f76c" class="kj kk in bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">开始前</h1><ol class=""><li id="2680" class="lh li in jm b jn lj jr lk jv ll jz lm kd ln kh lo lp lq lr bi translated">准备一个 Kubernetes 集群作为 KubeVela 的控制平面。</li><li id="aaa5" class="lh li in jm b jn ls jr lt jv lu jz lv kd lw kh lo lp lq lr bi translated">确保已经成功安装了<a class="ae lx" href="https://github.com/oam-dev/kubevela/releases/tag/v1.3.0" rel="noopener ugc nofollow" target="_blank"> KubeVela v1.3 </a>和 KubeVela CLI v1.3.0。</li><li id="7904" class="lh li in jm b jn ls jr lt jv lu jz lv kd lw kh lo lp lq lr bi translated">您想要管理的子集群中的 Kubeconfig 列表。我们将以命名为北京-1、北京-2 和美国-西方-1 的三个集群为例。</li><li id="df75" class="lh li in jm b jn ls jr lt jv lu jz lv kd lw kh lo lp lq lr bi translated">下载并结合<a class="ae lx" href="https://github.com/oam-dev/samples/tree/master/12.Multi_Cluster_Demo" rel="noopener ugc nofollow" target="_blank">多集群-演示</a>以更好地理解如何使用 KubeVela 多集群功能。</li></ol><h1 id="03d1" class="kj kk in bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">分发到多个指定的集群</h1><p id="bebf" class="pw-post-body-paragraph jk jl in jm b jn lj jp jq jr lk jt ju jv ly jx jy jz lz kb kc kd ma kf kg kh ig bi translated">分布多个指定集群是最基本的多集群管理操作。在 KubeVela 中，您将使用名为<code class="fe mb mc md me b">topology</code>的策略来实现它。该集群将在属性<code class="fe mb mc md me b">clusters</code>中列出，这是一个数组。</p><p id="86d2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">首先，让我们确保将 kubeconfig 切换到控制平面集群，使用<code class="fe mb mc md me b">vela cluster join</code>将其包括在北京-1、北京-2 和美国-西方-1 的 3 个集群中:</p><pre class="mf mg mh mi gt mj me mk ml aw mm bi"><span id="5348" class="mn kk in me b gy mo mp l mq mr">➜   vela cluster join beijing-1.kubeconfig --name beijing-1<br/>➜   vela cluster join beijing-2.kubeconfig --name beijing-2<br/>➜   vela cluster join us-west-1.kubeconfig --name us-west-1<br/>➜   vela cluster list<br/>CLUSTER        	TYPE           	ENDPOINT                 	ACCEPTED	LABELS<br/>beijing-1      	X509Certificate	https://47.95.22.71:6443 	true<br/>beijing-2      	X509Certificate	https://47.93.117.83:6443	true<br/>us-west-1      	X509Certificate	https://47.88.31.118:6443	true</span></pre><p id="2032" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">然后打开 multi-cluster-demo，查看<code class="fe mb mc md me b">Basic.yaml</code>:</p><pre class="mf mg mh mi gt mj me mk ml aw mm bi"><span id="79a1" class="mn kk in me b gy mo mp l mq mr">apiVersion: core.oam.dev/v1beta1<br/>kind: Application<br/>metadata:<br/>  name: example-app<br/>  namespace: default<br/>spec:<br/>  components:<br/>    - name: hello-world-server<br/>      type: webservice<br/>      properties:<br/>        image: crccheck/hello-world<br/>        port: 8000<br/>      traits:<br/>        - type: scaler<br/>          properties:<br/>            replicas: 3<br/>        - type: gateway<br/>          properties:<br/>            domain: testsvc-mc.example.com<br/>            # classInSpec : true   If the sub clusters has Kubernetes versions below v1.20 installed, please add this field<br/>            http:<br/>              "/": 8000<br/>  policies:<br/>    - type: topology<br/>      name: beijing-clusters<br/>      properties:<br/>        clusters: ["beijing-1","beijing-2"]</span></pre><p id="6abc" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">可以看到，这个 app 使用了<code class="fe mb mc md me b">webservice</code>类型的组件，通过<code class="fe mb mc md me b">topology</code>策略将 3 个部署分发给北京-1 和北京-2 集群。</p><p id="fc30" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">请注意，将资源成功分配到受管集群的前提是，它必须包含与控制平面完全相同的命名空间。因为默认情况下每个集群都有<code class="fe mb mc md me b"><strong class="jm io">default</strong></code>名称空间，所以在这种情况下我们不用担心。但是假设我们将<code class="fe mb mc md me b"><strong class="jm io">basic.yaml</strong></code>中的名称空间改为<code class="fe mb mc md me b"><strong class="jm io">multi-cluster</strong></code>，我们将收到一个错误:</p><pre class="mf mg mh mi gt mj me mk ml aw mm bi"><span id="a2cf" class="mn kk in me b gy mo mp l mq mr">... <br/> Status:    	runningWorkflow</span><span id="42b6" class="mn kk in me b gy ms mp l mq mr">Workflow:</span><span id="6d7f" class="mn kk in me b gy ms mp l mq mr">  mode: DAG<br/>  finished: false<br/>  Suspend: false<br/>  Terminated: false<br/>  Steps<br/>  - id:9fierfkhsc<br/>    name:deploy-beijing-clusters<br/>    type:deploy<br/>    phase:failed<br/>    message:step deploy: step deploy: run step(provider=oam,do=components-apply): Found 1 errors. [(failed to apply component beijing-1-multi-cluster-0: HandleComponentsRevision: failed to create componentrevision beijing-1/multi-cluster/hello-world-server-v1: namespaces "multi-cluster" not found)]</span><span id="8c38" class="mn kk in me b gy ms mp l mq mr">Services:<br/>...</span></pre><p id="7912" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">在 KubeVela 的未来版本中，我们计划支持一个全面的认证系统，更方便、更安全地:通过 hub cluster 以快速移动的方式在托管集群中创建名称空间。</strong></p><p id="0f86" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">创建子集群的命名空间后，返回控制平面集群，创建应用程序并分发资源:</p><pre class="mf mg mh mi gt mj me mk ml aw mm bi"><span id="98f6" class="mn kk in me b gy mo mp l mq mr">➜   vela up -f basic.yaml<br/>Applying an application in vela K8s object format...<br/>"patching object" name="example-app" resource="core.oam.dev/v1beta1, Kind=Application"<br/>✅ App has been deployed 🚀🚀🚀<br/>    Port forward: vela port-forward example-app<br/>             SSH: vela exec example-app<br/>         Logging: vela logs example-app<br/>      App status: vela status example-app<br/>  Service status: vela status example-app --svc hello-world-server</span></pre><p id="8b01" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们使用<code class="fe mb mc md me b">vela status &lt;App Name&gt;</code>查看该应用的详细信息:</p><pre class="mf mg mh mi gt mj me mk ml aw mm bi"><span id="1577" class="mn kk in me b gy mo mp l mq mr">➜   vela status example-app<br/>About:</span><span id="2c7a" class="mn kk in me b gy ms mp l mq mr">  Name:      	example-app<br/>  Namespace: 	default<br/>  Created at:	2022-03-25 17:42:33 +0800 CST<br/>  Status:    	running</span><span id="53b3" class="mn kk in me b gy ms mp l mq mr">Workflow:</span><span id="82b9" class="mn kk in me b gy ms mp l mq mr">  mode: DAG<br/>  finished: true<br/>  Suspend: false<br/>  Terminated: false<br/>  Steps<br/>  - id:wftf9d4exj<br/>    name:deploy-beijing-clusters<br/>    type:deploy<br/>    phase:succeeded<br/>    message:</span><span id="cd00" class="mn kk in me b gy ms mp l mq mr">Services:</span><span id="1faa" class="mn kk in me b gy ms mp l mq mr">  - Name: hello-world-server<br/>    Cluster: beijing-1  Namespace: default<br/>    Type: webservice<br/>    Healthy Ready:3/3<br/>    Traits:<br/>      ✅ scaler      ✅ gateway: Visiting URL: testsvc-mc.example.com, IP: 60.205.222.30<br/>  - Name: hello-world-server<br/>    Cluster: beijing-2  Namespace: default<br/>    Type: webservice<br/>    Healthy Ready:3/3<br/>    Traits:<br/>      ✅ scaler      ✅ gateway: Visiting URL: testsvc-mc.example.com, IP: 182.92.222.128</span></pre><p id="7bfe" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">北京-1 和北京-2 都发布了相应的资源，它们也显示了外部访问 IP 地址，因此您可以将其公开给您的用户。</p><h1 id="dac1" class="kj kk in bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">使用分类标签进行分组</h1><p id="e4c6" class="pw-post-body-paragraph jk jl in jm b jn lj jp jq jr lk jt ju jv ly jx jy jz lz kb kc kd ma kf kg kh ig bi translated">除了上述基本需求，我们还经常会遇到其他情况:跨区域部署到某些集群，指定哪个云提供商的集群等。为了实现类似的目标，可以使用<code class="fe mb mc md me b">labels</code>功能。</p><p id="bf4a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这里，假设 us-west-1 集群来自 AWS，我们必须额外应用于 AWS 集群。您可以使用<code class="fe mb mc md me b">vela cluster labels add</code>命令来标记集群。当然，如果有更多与 AWS 相关的集群，如 us-west-2，也将在它们被标记后进行处理:</p><pre class="mf mg mh mi gt mj me mk ml aw mm bi"><span id="1c79" class="mn kk in me b gy mo mp l mq mr">➜  ~ vela cluster labels add us-west-1 provider=AWS<br/>Successfully update labels for cluster us-west-1 (type: X509Certificate).<br/>provider=AWS<br/>➜  ~ vela cluster list<br/>CLUSTER        	TYPE           	ENDPOINT                 	ACCEPTED	LABELS<br/>beijing-1      	X509Certificate	https://47.95.22.71:6443 	true<br/>beijing-2      	X509Certificate	https://47.93.117.83:6443	true<br/>us-west-1      	X509Certificate	https://47.88.31.118:6443	true    	provider=AWS</span></pre><p id="bb7b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">接下来，我们更新<code class="fe mb mc md me b">basic.yaml</code>以添加应用程序策略<code class="fe mb mc md me b">topology-aws</code>:</p><pre class="mf mg mh mi gt mj me mk ml aw mm bi"><span id="abaa" class="mn kk in me b gy mo mp l mq mr">...<br/>  policies:<br/>    - type: topology<br/>      name: beijing-clusters<br/>      properties:<br/>        clusters: ["beijing-1","beijing-2"]<br/>    - type: topology<br/>      name: topology-aws<br/>      properties:<br/>        clusterLabelSelector:<br/>          provider: AWS</span></pre><p id="a8b0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">为了节省您的时间，请直接部署<code class="fe mb mc md me b">intermediate.yaml</code>:</p><pre class="mf mg mh mi gt mj me mk ml aw mm bi"><span id="7706" class="mn kk in me b gy mo mp l mq mr">➜  ~ vela up -f intermediate.yaml</span></pre><p id="82a8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">再次检查应用程序的状态:</p><pre class="mf mg mh mi gt mj me mk ml aw mm bi"><span id="a304" class="mn kk in me b gy mo mp l mq mr">➜   vela status example-app</span><span id="5aaa" class="mn kk in me b gy ms mp l mq mr">...</span><span id="dcbf" class="mn kk in me b gy ms mp l mq mr">  - Name: hello-world-server<br/>    Cluster: us-west-1  Namespace: default<br/>    Type: webservice<br/>    Healthy Ready:3/3<br/>    Traits:<br/>      ✅ scaler      ✅ gateway: Visiting URL: testsvc-mc.example.com, IP: 192.168.40.10</span></pre><h1 id="ecbc" class="kj kk in bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">差异化配置</h1><p id="85ca" class="pw-post-body-paragraph jk jl in jm b jn lj jp jq jr lk jt ju jv ly jx jy jz lz kb kc kd ma kf kg kh ig bi translated">除了上述场景，我们倾向于有更多的应用程序战略需求，例如希望分发 5 个副本的高可用性。在这种情况下，使用<code class="fe mb mc md me b">override</code>策略:</p><pre class="mf mg mh mi gt mj me mk ml aw mm bi"><span id="e5f5" class="mn kk in me b gy mo mp l mq mr">...        <br/>        clusterLabelSelector:<br/>          provider: AWS<br/>    -  type: override<br/>       name: override-high-availability<br/>       properties:<br/>          components:<br/>            - type: webservice<br/>              traits:<br/>              - type: scaler<br/>                properties:<br/>                  replicas: 5</span></pre><p id="5163" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">同时，我们希望只有 AWS 集群才能获得高可用性。然后我们可以期待 KubeVela 的工作流程帮我们一把。我们使用以下工作流程:它旨在通过以下方式部署此应用程序，首先通过<code class="fe mb mc md me b">deploy-beijing</code>策略分发到北京的集群，然后向标记为 AWS 的集群分发 5 个副本:</p><pre class="mf mg mh mi gt mj me mk ml aw mm bi"><span id="967b" class="mn kk in me b gy mo mp l mq mr">...                <br/>                properties:<br/>                  replicas: 5<br/>  workflow:<br/>    steps:<br/>      - type: deploy<br/>        name: deploy-beijing<br/>        properties:<br/>          policies: ["beijing-clusters"]<br/>      - type: deploy<br/>        name: deploy-aws<br/>        properties:<br/>          policies: ["override-high-availability","topology-aws"]</span></pre><p id="3c7c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">然后，我们将上述策略和工作流附加到<code class="fe mb mc md me b">intermediate.yaml</code>并使其成为<code class="fe mb mc md me b">advanced.yaml</code>:</p><pre class="mf mg mh mi gt mj me mk ml aw mm bi"><span id="6b50" class="mn kk in me b gy mo mp l mq mr">...<br/>  policies:<br/>    - type: topology<br/>      name: beijing-clusters<br/>      properties:<br/>        clusters: ["beijing-1","beijing-2"]<br/>    - type: topology<br/>      name: topology-aws<br/>      properties:<br/>        clusterLabelSelector:<br/>          provider: AWS<br/>    -  type: override<br/>       name: override-high-availability<br/>       properties:<br/>          components:<br/>            - type: webservice<br/>              traits:<br/>              - type: scaler<br/>                properties:<br/>                  replicas: 5<br/>  workflow:<br/>    steps:<br/>      - type: deploy<br/>        name: deploy-beijing<br/>        properties:<br/>          policies: ["beijing-clusters"]<br/>      - type: deploy<br/>        name: deploy-aws<br/>        properties:<br/>          policies: ["override-high-availability","topology-aws"]</span></pre><p id="405c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">然后部署它，查看应用程序的状态:</p><pre class="mf mg mh mi gt mj me mk ml aw mm bi"><span id="0de2" class="mn kk in me b gy mo mp l mq mr">➜   vela up -f advanced.yaml<br/>Applying an application in vela K8s object format...<br/>"patching object" name="example-app" resource="core.oam.dev/v1beta1, Kind=Application"<br/>✅ App has been deployed 🚀🚀🚀<br/>    Port forward: vela port-forward example-app<br/>             SSH: vela exec example-app<br/>         Logging: vela logs example-app<br/>      App status: vela status example-app<br/>  Service status: vela status example-app --svc hello-world-serverapplication.core.oam.dev/podinfo-app configured<br/>  <br/>➜   vela status example-app</span><span id="5431" class="mn kk in me b gy ms mp l mq mr">...</span><span id="4946" class="mn kk in me b gy ms mp l mq mr">  - Name: hello-world-server<br/>    Cluster: us-west-1  Namespace: default<br/>    Type: webservice<br/>    Healthy Ready:5/5<br/>    Traits:<br/>      ✅ scaler      ✅ gateway: Visiting URL: testsvc-mc.example.com, IP: 192.168.40.10</span></pre><p id="8cfa" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">以上是我们这次想与你分享的，谢谢你阅读和尝试。</p><p id="98ce" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><a class="ae lx" href="https://kubevela.io/docs/install" rel="noopener ugc nofollow" target="_blank">我们邀请您进一步探索 KubeVela v1.3，以满足更复杂的业务需求，例如深入挖掘差异化配置，使用<code class="fe mb mc md me b">override</code>应用程序策略覆盖一种类型的所有资源或仅覆盖某些特定组件。</a></p></div></div>    
</body>
</html>