<html>
<head>
<title>Kubernetes goes size searching</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes进行尺寸搜索</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/hardening-your-kubernetes-stack-pt-4-cc72b09b4557?source=collection_archive---------5-----------------------#2020-08-13">https://blog.devgenius.io/hardening-your-kubernetes-stack-pt-4-cc72b09b4557?source=collection_archive---------5-----------------------#2020-08-13</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="214f" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">利用HPA和CA扩展您的集群和应用</h2></div><p id="623f" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">大多数集群不是静态的。您的应用程序的副本数量和节点数量将根据您的流量模式而变化。那么，如何根据您的需求扩展您的Kubernetes (k8s)集群呢？K8s提供两种资源来处理扩展，即水平Pod自动扩展(HPA)和集群自动扩展。两者都是k8s社区提供的。他们将一起根据资源利用率和分配来管理集群的大小调整。</p><figure class="kz la lb lc gt ld gh gi paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="gh gi ky"><img src="../Images/2388e4b0f7f78c08417566889184d4df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*pKdeaW539yrCYJTG"/></div></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">照片由<a class="ae lo" href="https://unsplash.com/@dnevozhai?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Denys Nevozhai </a>在<a class="ae lo" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><h2 id="8913" class="lp lq in bd lr ls lt dn lu lv lw dp lx kl ly lz ma kp mb mc md kt me mf mg mh bi translated"><strong class="ak">水平Pod自动缩放器(HPA) </strong></h2><p id="cc76" class="pw-post-body-paragraph kc kd in ke b kf mi jo kh ki mj jr kk kl mk kn ko kp ml kr ks kt mm kv kw kx ig bi translated">水平pod autoscaler是K8s中的一个资源，它将帮助您基于各种指标动态地增加和减少pod的数量。默认情况下，它将支持CPU和内存，但是，你也可以挂钩自定义指标。为了启用HPA，您需要在您的k8s集群上安装一个<a class="ae lo" href="https://github.com/kubernetes-sigs/metrics-server" rel="noopener ugc nofollow" target="_blank">度量服务器</a>，并向您的pod添加资源请求和/或限制，如本系列的<a class="ae lo" href="https://medium.com/dev-genius/hardening-your-kubernetes-stack-pt-1-29b7006b5085" rel="noopener">第1部分</a>中所述。HPA遵循一个简单的算法来调整pod的数量:</p><p id="901a" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><code class="fe mn mo mp mq b">desiredReplicas = ceil[currentReplicas * ( currentMetricValue / desiredMetricValue )]</code></p><p id="fcef" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">HPA循环运行，默认情况下每15秒重新评估一次<code class="fe mn mo mp mq b">desireReplicas</code>。可以通过设置<a class="ae lo" href="https://kubernetes.io/docs/reference/command-line-tools-reference/kube-controller-manager/" rel="noopener ugc nofollow" target="_blank"> kube控制器管理器</a>上的<code class="fe mn mo mp mq b">— horizontal-pod-autoscaler-sync-period</code>来改变周期。每隔一段时间，HPA都会从指标服务器查看目标pod上的指标，以计算<code class="fe mn mo mp mq b">currentMetricValue</code>。然后将<code class="fe mn mo mp mq b">currentMetricValue</code>除以pod的资源请求<code class="fe mn mo mp mq b">desiredMetricValue</code>，得到当前的资源利用率。根据当前的资源利用率和目标利用率，HPA使用上述算法来计算所需的副本，并根据它来调整当前副本。</p><p id="92db" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">例子</p><figure class="kz la lb lc gt ld"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="6946" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">从上面的例子中，您可以通过使用<code class="fe mn mo mp mq b">scaleTargetRef</code>并定位您的部署的名称和API版本来定位您的部署(第6–9行)。HPA将接管该部署的复制副本设置。您还可以看到，您可以在HPA上设置最小值和最大值(第10行和第11行),以限制复制副本的数量。然后，指标部分指定HPA将利用哪些指标来扩展事件。在本例中，我们同时使用了CPU和内存，目标利用率为60%(第16行和第20行)。HPA将对每个指标执行相同的计算，并选择最大的所需复制副本数量进行扩展或缩减。在缩减事件期间，如果无法计算任何指标的所需复制副本，HPA将跳过扩展。</p><p id="22cb" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="ke io">总结</strong></p><p id="8386" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">启用HPA可让您的群集更好地利用资源，并通过根据当前资源利用率扩展或缩减应用程序来增加群集的灵活性。这意味着你的pod不太可能压倒你的节点，因为你的应用程序的更多实例将被旋转来处理负载，将负载分散开来。这也意味着，当您接收的流量减少时，pod将会降低转速，以减少过度分配。</p><p id="0c9c" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><a class="ae lo" href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/" rel="noopener ugc nofollow" target="_blank">正式文件</a></p><p id="fd83" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">但是，如果您将规模扩大到由于集群没有足够的资源而无法再将pod分配到集群上，会发生什么情况呢？</p><h2 id="eeaa" class="lp lq in bd lr ls lt dn lu lv lw dp lx kl ly lz ma kp mb mc md kt me mf mg mh bi translated">集群自动缩放器</h2><p id="d7aa" class="pw-post-body-paragraph kc kd in ke b kf mi jo kh ki mj jr kk kl mk kn ko kp ml kr ks kt mm kv kw kx ig bi translated">Cluster autoscaler是另一个k8s社区项目。它是一个在您的集群上运行的pod，负责根据您的集群的需求扩展和缩减节点。群集根据您的部署所请求的资源自动伸缩节点。我们用一个例子来说明这一点。</p><p id="8f59" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在，您的集群有1个节点，1个vCPU和1Gi内存。假设您有一个包含2个副本的新部署，每个副本需要1个vCPU和500Mi内存。在当前设置下，您没有足够的vCPU来运行两个副本，因此其中一个副本将陷入<code class="fe mn mo mp mq b">Pending</code>状态。在您的集群上运行的Cluster autoscaler会注意到一个pod由于缺乏资源而处于<code class="fe mn mo mp mq b">Pending</code>状态，并将尝试在您的集群上部署一个新节点来解决这个问题。同样，只有在您为部署设置资源请求和/或限制时，这才会起作用。</p><h2 id="ba58" class="lp lq in bd lr ls lt dn lu lv lw dp lx kl ly lz ma kp mb mc md kt me mf mg mh bi translated">摘要</h2><p id="939c" class="pw-post-body-paragraph kc kd in ke b kf mi jo kh ki mj jr kk kl mk kn ko kp ml kr ks kt mm kv kw kx ig bi translated">Cluster autoscaler根据资源需求扩展您的集群。如果您的集群需要的资源多于它当前拥有的资源，那么它将按节点进行扩展。如果群集有未充分利用的节点，资源利用率低，并且重要的pod可以从这些节点中移出，那么它将被删除相当长的时间。</p><p id="4385" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><a class="ae lo" href="https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md#what-is-cluster-autoscaler" rel="noopener ugc nofollow" target="_blank">正式文件</a></p><p id="654d" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><a class="ae lo" href="https://medium.com/dev-genius/hardening-your-kubernetes-stack-pt-1-29b7006b5085" rel="noopener">第1部分:资源请求和限制</a> <br/> <a class="ae lo" href="https://medium.com/dev-genius/hardening-your-kubernetes-stack-pt-2-2f2db4ff410d" rel="noopener">第2部分:Pod服务质量和优先级</a> <br/> <a class="ae lo" href="https://medium.com/dev-genius/hardening-your-kubernetes-stack-pt-3-b260d45fe6e" rel="noopener">第3部分:滚动更新和Pod中断预算</a></p></div></div>    
</body>
</html>