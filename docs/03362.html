<html>
<head>
<title>React Tips — Share Data, Mock Functions, and Local Storage</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">React 提示—共享数据、模拟函数和本地存储</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/react-tips-share-data-mock-functions-and-local-storage-a6c3d4e6e7ac?source=collection_archive---------6-----------------------#2020-10-26">https://blog.devgenius.io/react-tips-share-data-mock-functions-and-local-storage-a6c3d4e6e7ac?source=collection_archive---------6-----------------------#2020-10-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/0d83eee3ebc44ad2483d224532c324e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hmw5Iax0uySYzXXd"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">照片由<a class="ae kc" href="https://unsplash.com/@miteneva?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">玛利亚·特内娃</a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="a684" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">React 是一个用于创建 web 应用程序和移动应用程序的流行库。</p><p id="f2a2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将了解一些编写更好的 React 应用程序的技巧。</p><h1 id="b523" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">从使用者更新提供者中的上下文值</h1><p id="e833" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">如果我们将函数传入上下文，就可以从提供者那里更新上下文值。</p><p id="7e45" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="b971" class="mn lc iq mj b gy mo mp l mq mr">const MyContext = React.createContext({});</span><span id="664c" class="mn lc iq mj b gy ms mp l mq mr">class Child extends Component {<br/>  constructor(props) {<br/>    super(props);<br/>    this.state = {        <br/>      name: ""<br/>    };<br/>  }</span><span id="7efc" class="mn lc iq mj b gy ms mp l mq mr">  onChange(e){<br/>    const name = e.target.value;<br/>    this.setState({<br/>      name<br/>    });<br/>    this.props.context.updateValue('name', name);<br/>  }</span><span id="1685" class="mn lc iq mj b gy ms mp l mq mr">  render() {<br/>    return (<br/>       &lt;React.Fragment&gt;<br/>         &lt;input onChange={this.onChange} /&gt;<br/>       &lt;/React.Fragment&gt;<br/>    )<br/>  }<br/>}</span><span id="a142" class="mn lc iq mj b gy ms mp l mq mr">const withContext = (Component) =&gt; {<br/>  return (props) =&gt; {<br/>    &lt;MyContext.Consumer&gt;    <br/>      {(context) =&gt; {<br/>           return &lt;Component {...props} context={context} /&gt;<br/>      }}<br/>    &lt;/MyContext.Consumer&gt;<br/>  }<br/>}</span><span id="163d" class="mn lc iq mj b gy ms mp l mq mr">Child = withContext(Child)</span><span id="3984" class="mn lc iq mj b gy ms mp l mq mr">class Parent extends Component {<br/>  constructor(props) {<br/>    super(props);<br/>    this.state = {<br/>      name: "bar",<br/>    };<br/>  }</span><span id="a1b3" class="mn lc iq mj b gy ms mp l mq mr">  updateValue = (key, val) =&gt; {<br/>    this.setState({[key]: val});<br/>  }<br/>  <br/>  render() {<br/>    return (<br/>      &lt;MyContext.Provider value={{ state: this.state, updateValue: this.updateValue }}&gt;      <br/>        &lt;Child /&gt; <br/>      &lt;/MyContext.Provider&gt;<br/>    )<br/>  }<br/>}</span></pre><p id="6869" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们创建上下文并将值从<code class="fe mt mu mv mj b">Parent</code>传递给上下文中的组件。</p><p id="26fe" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">该对象具有<code class="fe mt mu mv mj b">state</code>和<code class="fe mt mu mv mj b">updateValue</code>功能。</p><p id="bb82" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们从<code class="fe mt mu mv mj b">props.context</code>属性中获取<code class="fe mt mu mv mj b">updateValue</code>方法，这就是我们所拥有的。</p><p id="bdb5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们通过调用<code class="fe mt mu mv mj b">updateValue</code>方法设置<code class="fe mt mu mv mj b">Parent</code>的<code class="fe mt mu mv mj b">name</code>状态来设置名称。</p><p id="0eee" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们必须记住将<code class="fe mt mu mv mj b">MyContext.Consumer</code>添加到任何消耗上下文的组件中。</p><p id="60bf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为此，我们创建了<code class="fe mt mu mv mj b">withContext</code>高阶组件，用上下文消费者包装任何组件。</p><h1 id="9f6d" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">React 类的 getInitialState</h1><p id="0146" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们将初始状态放在类组件的构造函数中。</p><p id="68ee" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="c32f" class="mn lc iq mj b gy mo mp l mq mr">import { Component } from 'react';</span><span id="878f" class="mn lc iq mj b gy ms mp l mq mr">class App extends Component {<br/>  constructor(props) {<br/>    super(props);<br/>    this.state = {<br/>      foo: true,<br/>      bar: 'no'<br/>    };<br/>  }</span><span id="32fc" class="mn lc iq mj b gy ms mp l mq mr">  render() {<br/>    return (<br/>      &lt;div className="theFoo"&gt;<br/>        &lt;span&gt;{this.state.bar}&lt;/span&gt;<br/>      &lt;/div&gt;<br/>    );<br/>  }<br/>}</span></pre><p id="c256" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们在构造函数中设置了<code class="fe mt mu mv mj b">foo</code>和<code class="fe mt mu mv mj b">bar</code>状态的初始值。</p><h1 id="746b" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">将本地存储与 React 一起使用</h1><p id="7356" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以在 React 中使用本地存储方法。</p><p id="d548" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="c81d" class="mn lc iq mj b gy mo mp l mq mr">import React from 'react'</span><span id="4f54" class="mn lc iq mj b gy ms mp l mq mr">class App extends React.Component {<br/>  constructor(props) {<br/>    super(props);<br/>    const storedClicks = 0;</span><span id="d49c" class="mn lc iq mj b gy ms mp l mq mr">    if (localStorage.getItem('clicks')) {<br/>      storedClicks = +(localStorage.getItem('clicks'));<br/>    }</span><span id="58a7" class="mn lc iq mj b gy ms mp l mq mr">    this.state = {<br/>      clicks: storedClicks<br/>    };<br/>    this.click = this.click.bind(this);<br/>  }</span><span id="8148" class="mn lc iq mj b gy ms mp l mq mr">  onClick() {<br/>    const newClicks = this.state.clicks + 1;<br/>    this.setState({ clicks: newClicks });<br/>    localStorage.setItem('clicks', newClicks);<br/>  }</span><span id="cbb0" class="mn lc iq mj b gy ms mp l mq mr">  render() {<br/>    return (<br/>      &lt;div&gt;<br/>        &lt;button onClick={this.onClick}&gt;Click me&lt;/button&gt; <br/>        &lt;p&gt;{this.state.clicks} clicks&lt;/p&gt;<br/>      &lt;/div&gt;<br/>    );<br/>  }<br/>}</span></pre><p id="52e7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果本地存储存在，我们会从本地存储中获取点击。</p><p id="4aba" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们解析它是否存在，并将其设置为<code class="fe mt mu mv mj b">clicks</code>状态的初始值。</p><p id="f93e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后在<code class="fe mt mu mv mj b">render</code>方法中，我们有一个按钮用<code class="fe mt mu mv mj b">onClick</code>方法更新<code class="fe mt mu mv mj b">clicks</code>状态和本地存储<code class="fe mt mu mv mj b">clicks</code>值。</p><p id="bf87" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它更新<code class="fe mt mu mv mj b">clicks</code>状态。</p><p id="8a31" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，我们在那之后更新本地存储的<code class="fe mt mu mv mj b">clicks</code>值。</p><h1 id="08b7" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">用 Jest 测试 React 组件函数</h1><p id="a129" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以模仿组件所依赖的函数，这样我们就可以用它进行测试。</p><p id="adf5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="cacd" class="mn lc iq mj b gy mo mp l mq mr">import React, { Component } from 'react';</span><span id="1b6e" class="mn lc iq mj b gy ms mp l mq mr">class Child extends Component {<br/>   constructor (props) {<br/>      super(props);<br/>   };</span><span id="9553" class="mn lc iq mj b gy ms mp l mq mr">  render() {<br/>      const { onSubmit, label} = this.props;<br/>      return(<br/>        &lt;form  onSubmit={onSubmit}&gt;<br/>          &lt;Button type='submit'&gt;{label}&lt;/Button&gt;<br/>        &lt;/form &gt;<br/>      );<br/>   };<br/>};</span><span id="f0d9" class="mn lc iq mj b gy ms mp l mq mr">export default class App extends Component {<br/>  constructor (props) {<br/>    super(props);<br/>    this.label = “foo”;<br/>  };</span><span id="ff75" class="mn lc iq mj b gy ms mp l mq mr">  onSubmit = (option) =&gt; {<br/>    console.log('submitted');<br/>  };</span><span id="a2a1" class="mn lc iq mj b gy ms mp l mq mr">  render () {<br/>    return(<br/>      &lt;div className="container"&gt;<br/>        &lt;Child label={this.label} onSubmit={this.onSubmit} /&gt;<br/>      &lt;/div&gt;<br/>    );<br/>  };<br/>};</span></pre><p id="ca46" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，当我们通过编写以下代码来测试孩子时，我们可以模仿<code class="fe mt mu mv mj b">onSubmit</code>函数:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="0848" class="mn lc iq mj b gy mo mp l mq mr">import React from 'react';<br/>import { shallow } from 'enzyme';<br/>import Child from '../Child';</span><span id="4d4f" class="mn lc iq mj b gy ms mp l mq mr">const onSubmitSpy = jest.fn();<br/>const onSubmit = onSubmitSpy;</span><span id="fcf9" class="mn lc iq mj b gy ms mp l mq mr">const wrapper = shallow(&lt;Child onSubmit={onSubmitSpy} /&gt;);<br/>let container, containerButton;</span><span id="d14f" class="mn lc iq mj b gy ms mp l mq mr">describe("Child", () =&gt; {<br/>  beforeEach(() =&gt; {<br/>    container = wrapper.find("div");<br/>    containerButton = container.find(“Button”);<br/>    onSumbitSpy.mockClear();<br/>  });</span><span id="2448" class="mn lc iq mj b gy ms mp l mq mr">  describe("&lt;Button&gt; behavior", () =&gt; {<br/>     it("should call onSubmit", () =&gt; {<br/>       expect(onSubmitSpy).not.toHaveBeenCalled();<br/>       containerButton.simulate(‘click’);<br/>       expect(onSubmitSpy).toHaveBeenCalled();<br/>     });<br/>  });<br/>});</span></pre><p id="0db0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们用由<code class="fe mt mu mv mj b">onSubmitSpy</code>填充的<code class="fe mt mu mv mj b">onSubmit</code>属性挂载组件，这是一个模拟函数。</p><p id="a832" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们通过模拟<code class="fe mt mu mv mj b">Child</code>组件按钮上的点击事件进行测试。</p><p id="a02e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们检查被模仿的函数是否用<code class="fe mt mu mv mj b">toHaveBeenCalled</code>调用。</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mw"><img src="../Images/1df220504ee7329ead437ea1493a0a93.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*JIVgmO0HZQtOBKnR"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">照片由<a class="ae kc" href="https://unsplash.com/@danieltuttle?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">丹尼尔·塔特尔</a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><h1 id="bae0" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="fc42" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以用上下文 API 传递数据。</p><p id="d0b6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，我们可以用 Jest 模仿函数，这样我们就可以把它们作为道具传入来测试我们需要测试的东西。</p><p id="e534" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">本地存储可以在 React 组件中按原样使用。</p></div></div>    
</body>
</html>