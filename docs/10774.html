<html>
<head>
<title>ClickHouse Replication Using Keeper</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Keeper 的 ClickHouse 复制</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/clickhouse-replication-using-keeper-219ca35821d?source=collection_archive---------4-----------------------#2022-11-28">https://blog.devgenius.io/clickhouse-replication-using-keeper-219ca35821d?source=collection_archive---------4-----------------------#2022-11-28</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/2ead6bbba478d2b7597a5ed2020b99e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*M0qH3JIKWRJA6oia.png"/></div></div></figure><p id="1e38" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi kt translated"><span class="l ku kv kw bm kx ky kz la lb di"> C </span> lickHouse 与为 Yandex 开发的标准 SQL 有一些区别，标准 SQL 是基于列的、分布式的、并行处理的、可水平扩展的，将数据存储在磁盘或内存上，有 SQL 支持，但它是一个 OLAP(没有真正的更新/删除和事务支持)。联机分析处理)是数据库管理系统(DBMS)。</p><p id="cb74" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这是一个开源的免费项目。</p><p id="c766" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">与其他解决方案相比，查询问题还具有不同的负载平衡和数据一致性机制。</p><p id="2612" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">由于 DDL 支持，查询几乎可以在所有连接的服务器上运行。</p><p id="0af1" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">它为数据一致性、速度、选择和合并过程以及分布式工作提供表结构级别的支持。</p><p id="27a9" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">从使用它的那一刻起，就能感受到它的有用性和速度，尤其是随着数据的增长。</p><p id="01f5" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">ClickHouse 中有几种不同的表结构，如分布式、合并、合并树、*合并树、日志、TinyLog、内存、缓冲区、空和文件。最常用的是分布式、内存、合并树及其子分类。“分布式”实际上是一个视图，而不是一个完整的表结构。在进行定义时，强调它是一个结构，但不包含数据。</p><p id="0d6e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">“ReplicatedMergeTree”表结构通过在同一个集群中创建子集节点来复制数据，即使任何子集的一个元素正在工作，也不会改变我们结果的准确性。</p><p id="b0c6" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">分布式表结构充当这些子集的容器集。这样，我们就可以得到结果，而不用考虑哪些子集在里面，以及那些子集是如何分布的。此外，当您为数据创建分布式子集时，每个子集都可以在自身内部进行查询，并为您提供更快的结果。如文档中所述，建议最多有 300 个节点。</p><p id="d7ed" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">借助 ON CLUSTER {custom cluster}部件，您可以使其适用于所在的集群。使用这种方法，在不知道每个集群包含多少个部分和多少个副本的情况下，您可以通过任何工作节点的名称立即为集群写入所有数据。</p><h1 id="7c38" class="lc ld in bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">安装所有节点</h1><figure class="ma mb mc md gt jo"><div class="bz fp l di"><div class="me mf l"/></div></figure><figure class="ma mb mc md gt jo"><div class="bz fp l di"><div class="me mf l"/></div></figure><p id="d830" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">您可以使用安装过程中指定的默认用户和密码登录，如下所示。</p><p id="0112" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><a class="ae mg" href="http://ipname:8123/play" rel="noopener ugc nofollow" target="_blank"> http://0.0.0.1:8123/play </a></p><p id="426c" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">用户</strong>:默认</p><p id="9d50" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">密码</strong>:在安装阶段确定。</p><figure class="ma mb mc md gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mh"><img src="../Images/ee5bc3656b33c2163b6c568c0cf88140.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PzTJ60FzXeIhZ_Dj_5HsRQ.png"/></div></div></figure><pre class="ma mb mc md gt mi mj mk bn ml mm bi"><span id="498c" class="mn ld in mj b be mo mp l mq mr"># on shell<br/>clickhouse-client - password=xx - host=0.0.0.1</span></pre><p id="880c" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">然后，您可以使用 ZooKeeper 或 ClickHouse Keeper 方法来使用复制方法。我们使用了 ClickHouse Keeper 方法和 shard 和 replica 方法。<strong class="jx io">我们在 6 个节点上实施了该场景，我们使用了 3 个分片和分片之间的 2 个副本。</strong></p><p id="31d6" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io"> <em class="ms">我们在所有服务器上创建 clusters.xml、keeper.xml、macros.xml 文件，这里 keeper.xml 和宏. xml 的值根据节点不同而不同，clusters.xml 在所有节点上都是一样的。</em>T3】</strong></p><figure class="ma mb mc md gt jo gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/59424b4099f340307a0009be8262f33f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1262/format:webp/1*VfEMOphnevAfePBGyv320w.png"/></div></figure><figure class="ma mb mc md gt jo"><div class="bz fp l di"><div class="me mf l"/></div></figure><pre class="ma mb mc md gt mi mj mk bn ml mm bi"><span id="5def" class="mn ld in mj b be mo mp l mq mr">#different all node<br/>/etc/clickhouse-server/config.d/keeper.xml<br/>/etc/clickhouse-server/config.d/macros.xml<br/>#same all nodes<br/>/etc/clickhouse-server/config.d/clusters.xml</span></pre><h2 id="ff15" class="mu ld in bd le mv mw dn li mx my dp lm kg mz na lq kk nb nc lu ko nd ne ly nf bi translated"><strong class="ak">集群</strong></h2><figure class="ma mb mc md gt jo gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/d0e8e5aae804ab40bbd0c23d30645dc7.png" data-original-src="https://miro.medium.com/v2/resize:fit:592/format:webp/1*cAv7MMxQs9xM8Kt7LHWL6g.png"/></div></figure><p id="260f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io"> <em class="ms"> clusters.xml </em> </strong></p><p id="8997" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">主机</strong>:必须写服务器 IP。</p><p id="a07d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">端口</strong>:用于使用本地 TCP 协议 9000 进行通信。</p><p id="daff" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">用户</strong>:“默认”用户名。</p><p id="3541" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">密码</strong>:您在安装时提供的。</p><figure class="ma mb mc md gt jo"><div class="bz fp l di"><div class="me mf l"/></div></figure><p id="1fe3" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io"> <em class="ms"> keeper.xml </em> </strong></p><p id="7bc8" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io"> Tcp_port </strong> : 9181 端口，供 keeper 的客户端使用。</p><p id="a8fa" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io"> Server_id </strong>:无论有多少台服务器，服务器的数量都是唯一的，所以在我们的场景中，有 6 台服务器。在 keeper.xml 中，服务器是递增的，例如 1、2 等。</p><p id="6489" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io"> log_storage_path </strong>:协调日志的路径，就像 ZooKeeper 最好把日志存储在不忙的节点上。</p><p id="ff94" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">快照存储路径</strong>:协同快照的路径。</p><p id="54dc" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io"> operation_timeout_ms </strong>:单个客户端操作的超时时间(毫秒)(默认为 10000)。</p><p id="0435" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io"> session_timeout_ms </strong>:客户端会话的最大超时(毫秒)(默认值:100000)。</p><p id="6abc" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io"> raft_logs_level </strong>:关于协调的文本日志级别(跟踪、调试等)(默认:系统默认)。</p><p id="705b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">rotate _ log _ storage _ interval</strong>:单个文件存储多少条日志记录(默认为 100000)。</p><p id="d1fe" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io"> id </strong>:仲裁中的服务器标识符。</p><p id="a758" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">主机名</strong>:服务器 IPs。</p><p id="dfe8" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">端口</strong> : 9444 端口，用于监听服务器间 keeper 连接。</p><p id="b652" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">zookeeper 下的主机每台服务器的 IP。</p><p id="ab2a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">端口</strong> : 9181 端口，供保管员客户使用。</p><figure class="ma mb mc md gt jo"><div class="bz fp l di"><div class="me mf l"/></div></figure><p id="00c2" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io"> <em class="ms"> macros.xml </em> </strong></p><p id="1a1e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">集群</strong>:集群名称</p><p id="3822" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">副本:哪个副本</p><p id="99f0" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">碎片:哪个碎片</p><p id="f3ce" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">对于集群中的每台机器，我们需要定义不同的 macro.xml 来显示该机器在集群中的角色，每台机器上的碎片和副本根据您的集群结构而有所不同。</p><figure class="ma mb mc md gt jo"><div class="bz fp l di"><div class="me mf l"/></div></figure><pre class="ma mb mc md gt mi mj mk bn ml mm bi"><span id="6fe2" class="mn ld in mj b be mo mp l mq mr">clickhouse-db-01 :) select * from system.macros;<br/><br/>SELECT *<br/>FROM system.macros<br/><br/>Query id: 6a960092-5b03-4330-953b-c6de3e43bc95<br/><br/>┌─macro───┬─substitution─┐<br/>│ cluster │ testcluster  │<br/>│ replica │ replica1     │<br/>│ shard   │ 1            │<br/>└─────────┴──────────────┘</span></pre><p id="8e84" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">所有服务器 listen_host 设置为“0.0.0.0 ”,因为它允许通过网络接口进行外部通信。如何使用时区也可以在“listen.xml”中设置。</p><figure class="ma mb mc md gt jo"><div class="bz fp l di"><div class="me mf l"/></div></figure><p id="1222" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">所有节点上的服务都将重新启动，如果您开始在日志中看到以下错误，则应该在所有节点上执行以下操作。</p><pre class="ma mb mc md gt mi mj mk bn ml mm bi"><span id="f27f" class="mn ld in mj b be mo mp l mq mr"># Certificate file /etc/clickhouse-server/server.crt No such file or directory<br/>openssl req -subj "/CN=localhost" -new -newkey rsa:2048 -days 365 -nodes -x509 -keyout /etc/clickhouse-server/server.key -out /etc/clickhouse-server/server.crt<br/><br/># /etc/clickhouse-server/dhparam.pem: error:02000002:system library:OPENSSL_internal:No such file or directory (version 22.9.1.344 (official build))<br/>openssl dhparam -out /etc/clickhouse-server/dhparam.pem 4096</span></pre><p id="bdb6" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">检查副本</p><pre class="ma mb mc md gt mi mj mk bn ml mm bi"><span id="758d" class="mn ld in mj b be mo mp l mq mr">yum install nmap -y</span></pre><blockquote class="nh ni nj"><p id="a5dc" class="jv jw ms jx b jy jz ka kb kc kd ke kf nk kh ki kj nl kl km kn nm kp kq kr ks ig bi translated">four _ letter _ word _ White _ list—4lw 命令的白名单(默认:conf、cons、crst、envi、ruok、srst、srvr、stat、wchs、dirs、mntr、isro、rcvr、apiv、csnp、lgif、rqld)。</p></blockquote><pre class="ma mb mc md gt mi mj mk bn ml mm bi"><span id="810c" class="mn ld in mj b be mo mp l mq mr">echo mntr | nc localhost 9181<br/>echo conf | nc localhost 9181</span></pre><figure class="ma mb mc md gt jo"><div class="bz fp l di"><div class="me mf l"/></div></figure><blockquote class="nh ni nj"><p id="8e23" class="jv jw ms jx b jy jz ka kb kc kd ke kf nk kh ki kj nl kl km kn nm kp kq kr ks ig bi translated">8123: HTTP 请求的 HTTP API 端口。由 JDBC、ODBC 和 web 界面使用。</p><p id="3667" class="jv jw ms jx b jy jz ka kb kc kd ke kf nk kh ki kj nl kl km kn nm kp kq kr ks ig bi translated">9181:由 keeper 的客户使用的端口</p><p id="ee36" class="jv jw ms jx b jy jz ka kb kc kd ke kf nk kh ki kj nl kl km kn nm kp kq kr ks ig bi translated">9000:使用本机 TCP 协议进行通信</p><p id="3c93" class="jv jw ms jx b jy jz ka kb kc kd ke kf nk kh ki kj nl kl km kn nm kp kq kr ks ig bi translated">9444:点击房屋管理员筏口</p><p id="9b8f" class="jv jw ms jx b jy jz ka kb kc kd ke kf nk kh ki kj nl kl km kn nm kp kq kr ks ig bi translated">9440:安全本地 TCP 协议</p><p id="c959" class="jv jw ms jx b jy jz ka kb kc kd ke kf nk kh ki kj nl kl km kn nm kp kq kr ks ig bi translated">8443 : HTTPS 接口</p><p id="7a16" class="jv jw ms jx b jy jz ka kb kc kd ke kf nk kh ki kj nl kl km kn nm kp kq kr ks ig bi translated">9010:服务器间 https 端口</p><p id="8e72" class="jv jw ms jx b jy jz ka kb kc kd ke kf nk kh ki kj nl kl km kn nm kp kq kr ks ig bi translated">9281 : ClickHouse Keeper 安全端口</p></blockquote><figure class="ma mb mc md gt jo"><div class="bz fp l di"><div class="me mf l"/></div></figure><pre class="ma mb mc md gt mi mj mk bn ml mm bi"><span id="6a05" class="mn ld in mj b be mo mp l mq mr">CREATE DATABASE app ON CLUSTER 'testcluster';</span></pre><p id="b95b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">感谢阅读</p><figure class="ma mb mc md gt jo gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/4b9cec91c5bbec2d33cf16081bd51aa9.png" data-original-src="https://miro.medium.com/v2/resize:fit:160/0*8lXrlzrJYVqGeUc9.gif"/></div></figure></div><div class="ab cl no np hr nq" role="separator"><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt"/></div><div class="ig ih ii ij ik"><div class="ma mb mc md gt nv"><a href="https://clickhouse.com/docs/en/quick-start/" rel="noopener  ugc nofollow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd io gy z fp oa fr fs ob fu fw im bi translated">ClickHouse 快速入门| ClickHouse 文档</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">启动并运行 ClickHouse 最快速、最简单的方法是在 ClickHouse Cloud 中创建一个新服务。</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">clickhouse.com</p></div></div><div class="oe l"><div class="of l og oh oi oe oj jt nv"/></div></div></a></div><div class="ok ol gp gr om nv"><a href="https://zhuanlan.zhihu.com/p/461792873" rel="noopener  ugc nofollow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd io gy z fp oa fr fs ob fu fw im bi translated">如何在 3 个服务器节点上设置具有 3 个碎片和 2 个副本的 ClickHouse 分布式集群</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">官方网站:ClickHouse -快速开源 OLAP dbmslickhouse 是一个开源的高性能柱状 OLAP…</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">zhuanlan.zhihu.com</p></div></div><div class="oe l"><div class="on l og oh oi oe oj jt nv"/></div></div></a></div></div></div>    
</body>
</html>