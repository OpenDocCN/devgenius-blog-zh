<html>
<head>
<title>Export and Import your MongoDB collections using these simple bash scripts</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用这些简单的 bash 脚本导出和导入您的 MongoDB 集合</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/export-and-import-your-mongodb-collections-using-these-simple-bash-scripts-23ccf658206b?source=collection_archive---------2-----------------------#2021-12-19">https://blog.devgenius.io/export-and-import-your-mongodb-collections-using-these-simple-bash-scripts-23ccf658206b?source=collection_archive---------2-----------------------#2021-12-19</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/8046c10960a80e2203fedbcc5f375356.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UX2IEbrZwA9tM_nKT34d_g.jpeg"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">朱庇特艺术区，苏格兰爱丁堡</figcaption></figure><p id="4fc8" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">几天前，我不得不将一个远程 Mongo 数据库复制到我们的一台本地机器上。本质上，我们的最终目标是用一个大数据集测试我们的开发代码的性能。在本文中，我将解释一种借助 bash 脚本导出和导入多个数据库集合的方法。</p><p id="daf5" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">以 MySQL 数据库为例，只需在 phpMyAdmin 中单击一个按钮，就可以完成这个导出/导入任务。然而对于 MongoDB，由于我们的团队只使用 Mongo Shell，我唯一的选择就是使用 CLI 来完成任务。</p><p id="b92b" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><a class="ae kx" href="https://docs.mongodb.com/" rel="noopener ugc nofollow" target="_blank"> MongoDB </a>的官方文档建议使用<a class="ae kx" href="https://docs.mongodb.com/database-tools/mongoexport/" rel="noopener ugc nofollow" target="_blank"> mongoexport </a>工具来导出特定的集合，使用<a class="ae kx" href="https://docs.mongodb.com/database-tools/mongoimport/" rel="noopener ugc nofollow" target="_blank"> mongoimport </a>工具来导入。</p><p id="3cef" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">为了导出集合:“events”例如，从数据库将“reporting”导出到文件 events.json，可以简单地使用以下命令:</p><blockquote class="ky kz la"><p id="ac48" class="jz ka lb kb b kc kd ke kf kg kh ki kj lc kl km kn ld kp kq kr le kt ku kv kw ig bi translated">mongoexport-collection = events-db = reporting-out = events . JSON</p></blockquote><p id="0019" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">在我们的例子中，由于数据库需要认证，上面的命令必须用我们的数据库凭证来扩展。</p><pre class="lf lg lh li gt lj lk ll lm aw ln bi"><span id="b596" class="lo lp in lk b gy lq lr l ls lt">mongoexport --db=the_db_name --collection=the_collection_name \<br/>--out=the_collection_name.json --host 127.0.0.1:27017 \<br/>-u the_username -p the_password --authenticationDatabase=admin </span></pre><p id="323c" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">然后，<a class="ae kx" href="https://docs.mongodb.com/database-tools/mongoimport/" rel="noopener ugc nofollow" target="_blank"> mongoimport </a>的用法也非常简单:</p><pre class="lf lg lh li gt lj lk ll lm aw ln bi"><span id="2822" class="lo lp in lk b gy lq lr l ls lt">mongoimport --db=the_db_name --collection=the_collection_name \ <br/>--drop --file=the_collection_name.json --port=27017 \ <br/>-u the_username -p the_password --authenticationDatabase=admin</span></pre><p id="48ab" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">使用这些命令，我们只能从一个数据库向另一个数据库导出/导入单个集合。然后，为了复制<em class="lb"> n </em>个集合，上述命令应重复复制和编辑<em class="lb"> n </em>次。这是“好的”，但不是很好，也没有效率。因此，下一步是找到更好的自动化任务的方法。</p></div><div class="ab cl lu lv hr lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="ig ih ii ij ik"><p id="1f4d" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">我首先想到的是写一个 shell 脚本来完成所有多余的任务。例如，在导出过程中，脚本必须遍历可用的集合，并为每个集合调用<a class="ae kx" href="https://docs.mongodb.com/database-tools/mongoexport/" rel="noopener ugc nofollow" target="_blank"> mongoexport </a>命令。另一方面，对于导入，脚本必须遍历包含导出数据的<code class="fe mb mc md lk b">.json</code>文件，然后将后者导入第二个数据库的新集合。</p><p id="68f2" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">当我们在 UNIX 环境下工作时，BASH 脚本是我能想到的执行自动化的最明显的选择。</p><h1 id="904a" class="me lp in bd mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na bi translated">出口商</h1><p id="80db" class="pw-post-body-paragraph jz ka in kb b kc nb ke kf kg nc ki kj kk nd km kn ko ne kq kr ks nf ku kv kw ig bi translated">bash 脚本应该以<code class="fe mb mc md lk b">#!/bin/bash </code>开始，其中<code class="fe mb mc md lk b">#!</code>是一个操作符，它将脚本指向解释器位置。在我们的例子中，它指向位于<code class="fe mb mc md lk b">/bin/bash</code>的 bourne-shell。</p><p id="ef80" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">因此，我们代码的第一行应该是这样的:</p><pre class="lf lg lh li gt lj lk ll lm aw ln bi"><span id="9eb5" class="lo lp in lk b gy lq lr l ls lt">#!/bin/bash</span></pre><p id="79d9" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">使用 mongo Shell，可以通过调用:<code class="fe mb mc md lk b">db.getCollectionNames()</code>获得所选数据库中的集合列表。为了使这个命令的结果成为 bash 数组格式，我们在<code class="fe mb mc md lk b">db.getCollectionNames()</code>后添加了<code class="fe mb mc md lk b">.join(' ')</code>。</p><p id="34b3" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">要从 mongo Shell 外部执行这个命令，我们需要使用<code class="fe mb mc md lk b">--eval</code>,并以如下方式将其作为字符串传递:</p><pre class="lf lg lh li gt lj lk ll lm aw ln bi"><span id="c1b3" class="lo lp in lk b gy lq lr l ls lt">mongo the_database_name --quiet --eval "db.getCollectionNames().join(' ')"</span></pre><p id="95e8" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">然后，有必要将集合名称保存到一个变量中，以便我们以后可以遍历它们。</p><pre class="lf lg lh li gt lj lk ll lm aw ln bi"><span id="e73b" class="lo lp in lk b gy lq lr l ls lt">#!/bin/bash<br/>DB_COLLECTIONS=$(mongo the_database_name --quiet --eval "db.getCollectionNames().join(' ')")</span></pre><p id="7f5e" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">一旦我们有了每个集合的名称，我们就可以执行前面的<a class="ae kx" href="https://docs.mongodb.com/database-tools/mongoexport/" rel="noopener ugc nofollow" target="_blank"> mongoexport </a>命令将集合导出到不同的文件中。我们的<code class="fe mb mc md lk b">export.sh</code>的内容现在应该是这样的:</p><pre class="lf lg lh li gt lj lk ll lm aw ln bi"><span id="c1ff" class="lo lp in lk b gy lq lr l ls lt">#!/bin/bash</span><span id="2916" class="lo lp in lk b gy ng lr l ls lt">DB_COLLECTIONS=$(mongo the_database_name --quiet --eval "db.getCollectionNames().join(' ')")</span><span id="e1c5" class="lo lp in lk b gy ng lr l ls lt">for collection in $DB_COLLECTIONS; do</span><span id="62f4" class="lo lp in lk b gy ng lr l ls lt">    mongoexport --db=the_database_name --collection=$collection --out=$collection.json</span><span id="f43a" class="lo lp in lk b gy ng lr l ls lt">done</span></pre><p id="ffa6" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">为了让脚本更具重用性，我们可以将<code class="fe mb mc md lk b">the_database_name</code>作为脚本的一个参数传递。<code class="fe mb mc md lk b">exporter.sh</code>的最终内容应该如下所示:</p><figure class="lf lg lh li gt jo"><div class="bz fp l di"><div class="nh ni l"/></div></figure><p id="9db1" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">对于一个安全的数据库，我们应该在代码中添加凭证，以确保脚本的顺利执行。</p><p id="2f13" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">要执行这个脚本，我们只需运行<code class="fe mb mc md lk b">./exporter.sh the_database_name</code>。</p><h1 id="0eb2" class="me lp in bd mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na bi translated">进口商. sh</h1><p id="2c7f" class="pw-post-body-paragraph jz ka in kb b kc nb ke kf kg nc ki kj kk nd km kn ko ne kq kr ks nf ku kv kw ig bi translated">为了将导出的集合导入到另一个数据库中，我们将<code class="fe mb mc md lk b">.json</code>文件(从前面的<code class="fe mb mc md lk b">exporter.sh</code>中获得)移动到一个单独的文件夹中。然后，我们还在同一个文件夹中创建了<code class="fe mb mc md lk b">importer.sh</code>文件，以使事情更简单。</p><p id="b83f" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">importer 文件本质上包含一段代码，这段代码循环遍历<code class="fe mb mc md lk b">.json</code>文件，并在每次迭代中执行 mongoimport 命令。</p><pre class="lf lg lh li gt lj lk ll lm aw ln bi"><span id="af59" class="lo lp in lk b gy lq lr l ls lt">#!/bin/bash</span><span id="bf95" class="lo lp in lk b gy ng lr l ls lt">for FILE in *.json; do</span><span id="46c9" class="lo lp in lk b gy ng lr l ls lt">    c= basename $FILE .json;</span><span id="c9e6" class="lo lp in lk b gy ng lr l ls lt">    mongoimport --db=$DB --collection=$c --drop --file=$FILE --host 127.0.0.1:27017 -u the_username -p the_password --authenticationDatabase=admin</span><span id="380d" class="lo lp in lk b gy ng lr l ls lt">done</span></pre><p id="1e2e" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">我们还可以将数据库名称作为参数传递，以提高脚本的可重用性。</p><figure class="lf lg lh li gt jo"><div class="bz fp l di"><div class="nh ni l"/></div></figure><p id="bf75" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">为了使用这个脚本，我们只需运行<code class="fe mb mc md lk b">./importer.sh the_database_name</code>。</p><p id="146e" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">如果脚本的执行导致<code class="fe mb mc md lk b">Permission denied</code>错误，我们需要通过运行以下命令为脚本添加“执行”权限:</p><pre class="lf lg lh li gt lj lk ll lm aw ln bi"><span id="f537" class="lo lp in lk b gy lq lr l ls lt">chmod +x importer.sh exporter.sh</span></pre><p id="24bb" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">最后，例如，为了将集合从<code class="fe mb mc md lk b">database_0</code>导出到<code class="fe mb mc md lk b">database_1</code>，我们可以运行以下命令:</p><pre class="lf lg lh li gt lj lk ll lm aw ln bi"><span id="a778" class="lo lp in lk b gy lq lr l ls lt">./exporter.sh database_0 &amp;&amp; ./importer.sh database_1</span></pre><p id="ed56" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">就是这样！现在我们可以坐下来看脚本为我们执行导出-导入。</p><p id="7600" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">包含这些代码的一个小仓库可以在:<a class="ae kx" href="https://github.com/HoracioSoldman/export-import-mongodb" rel="noopener ugc nofollow" target="_blank">https://github.com/HoracioSoldman/export-import-mongodb</a>找到</p></div></div>    
</body>
</html>