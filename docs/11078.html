<html>
<head>
<title>How Much Disk Latency Affects etcd</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">磁盘延迟对 etcd 的影响有多大</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/how-much-disk-latency-affects-etcd-a2042370f476?source=collection_archive---------4-----------------------#2022-12-17">https://blog.devgenius.io/how-much-disk-latency-affects-etcd-a2042370f476?source=collection_archive---------4-----------------------#2022-12-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="e51d" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph">k3s | k8s | etcd |磁盘延迟| kubernetes | k3os</h2><div class=""/><div class=""><h2 id="de35" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated">通过几个选项使您的 k3s 集群更加稳定。</h2></div><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/7bbb93869b193a8a0ff37c3ccb77caf5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xj8dFs_1Ou4WGzkybAwl0g.jpeg"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">尼古拉斯·卡佩罗在<a class="ae le" href="https://unsplash.com/s/photos/graph?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><h1 id="005b" class="lf lg iq bd lh li lj lk ll lm ln lo lp kf lq kg lr ki ls kj lt kl lu km lv lw bi translated">动机</h1><p id="927b" class="pw-post-body-paragraph lx ly iq lz b ma mb ka mc md me kd mf mg mh mi mj mk ml mm mn mo mp mq mr ms ij bi translated">在我们公司，etcd 的磁盘延迟问题明显影响了集群的稳定性或性能。在将主节点转移到更好的硬件后，问题得到了解决。</p><p id="8a19" class="pw-post-body-paragraph lx ly iq lz b ma mt ka mc md mu kd mf mg mv mi mj mk mw mm mn mo mx mq mr ms ij bi translated">在实验室设置中，我还遇到了 k3s 群集的稳定性问题。一个节点将定期变为<em class="my">未就绪</em>。我用另一台 kvm 主机上的一个节点替换了它。然而集群(一个节点)再次变得不稳定，我注意到 k3s 记录了<code class="fe mz na nb nc b">etcd</code>超时消息。</p><p id="d605" class="pw-post-body-paragraph lx ly iq lz b ma mt ka mc md mu kd mf mg mv mi mj mk mw mm mn mo mx mq mr ms ij bi translated">因此，我抓住机会，使用实验室设置来试验<code class="fe mz na nb nc b">ext4</code>文件系统的选项，以缓解磁盘延迟问题。</p></div><div class="ab cl nd ne hu nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="ij ik il im in"><h1 id="9274" class="lf lg iq bd lh li nk lk ll lm nl lo lp kf nm kg lr ki nn kj lt kl no km lv lw bi translated">实验室场景</h1><p id="aea1" class="pw-post-body-paragraph lx ly iq lz b ma mb ka mc md me kd mf mg mh mi mj mk ml mm mn mo mp mq mr ms ij bi translated">三个 k3os 虚拟机(4 个内核，每个 8GB RAM)位于三个不同的主机上，具有简单的基本设置:</p><ul class=""><li id="f1b7" class="np nq iq lz b ma mt md mu mg nr mk ns mo nt ms nu nv nw nx bi translated">k3os 在没有 CNI 和入口的情况下启动 k3s。</li><li id="c724" class="np nq iq lz b ma ny md nz mg oa mk ob mo oc ms nu nv nw nx bi translated">安装纤毛 CNI</li><li id="a106" class="np nq iq lz b ma ny md nz mg oa mk ob mo oc ms nu nv nw nx bi translated">从 git 通过<code class="fe mz na nb nc b">kustomize</code>和<code class="fe mz na nb nc b">helm</code>安装了 ArgoCD，其中安装了 MetalLB、Ingress-Nginx、Longhorn、Victoria-Metrics……</li></ul><p id="7fcb" class="pw-post-body-paragraph lx ly iq lz b ma mt ka mc md mu kd mf mg mv mi mj mk mw mm mn mo mx mq mr ms ij bi translated">Longhorn 用于 Grafana、Victoria Metrics 和 Loki 的 3 节点分布式存储。</p><h2 id="4115" class="od lg iq bd lh oe of dn ll og oh dp lp mg oi oj lr mk ok ol lt mo om on lv iw bi translated">没有 ext4 调整</h2><p id="08af" class="pw-post-body-paragraph lx ly iq lz b ma mb ka mc md me kd mf mg mh mi mj mk ml mm mn mo mp mq mr ms ij bi translated">这里您可以看到没有选项应用于<code class="fe mz na nb nc b">ext4</code>根文件系统的<code class="fe mz na nb nc b">etcd</code>的标准磁盘延迟。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi oo"><img src="../Images/cc549a0eafea5245f0f7aeea7460b09c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_ghBOplABXJn6lB5EKDmhQ.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">Etcd 磁盘延迟图，介于 3 毫秒和 8 毫秒之间。一个节点具有明显更高的延迟。</figcaption></figure><h2 id="22c8" class="od lg iq bd lh oe of dn ll og oh dp lp mg oi oj lr mk ok ol lt mo om on lv iw bi translated">带 ext4 调整</h2><p id="9680" class="pw-post-body-paragraph lx ly iq lz b ma mb ka mc md me kd mf mg mh mi mj mk ml mm mn mo mp mq mr ms ij bi translated">一旦应用了<code class="fe mz na nb nc b">ext4</code>文件系统选项，磁盘延迟指标就会显著降低。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi op"><img src="../Images/6a6def0c6d04ce2caff62c8651df3209.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hL5jFpSQhcJQ5t9cmwxVLA.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">Etcd 磁盘延迟图，介于 1 毫秒和 3 毫秒之间。</figcaption></figure><p id="e731" class="pw-post-body-paragraph lx ly iq lz b ma mt ka mc md mu kd mf mg mv mi mj mk mw mm mn mo mx mq mr ms ij bi translated">虽然看起来不多，但它仍然将最小延迟降低了<strong class="lz ja">3 倍！</strong></p><h2 id="449a" class="od lg iq bd lh oe of dn ll og oh dp lp mg oi oj lr mk ok ol lt mo om on lv iw bi translated">运行时应用<code class="fe mz na nb nc b">ext4</code>选项</h2><pre class="kp kq kr ks gt oq nc or bn os ot bi"><span id="b44e" class="ou lg iq nc b be ov ow l ox oy">mount -o remount,noatime,barrier=0,commit=30 /</span></pre><h2 id="40a5" class="od lg iq bd lh oe of dn ll og oh dp lp mg oi oj lr mk ok ol lt mo om on lv iw bi translated">解释了文件系统选项</h2><p id="5f82" class="pw-post-body-paragraph lx ly iq lz b ma mb ka mc md me kd mf mg mh mi mj mk ml mm mn mo mp mq mr ms ij bi translated"><code class="fe mz na nb nc b">noatime,barrier=0,commit=30</code></p><p id="0386" class="pw-post-body-paragraph lx ly iq lz b ma mt ka mc md mu kd mf mg mv mi mj mk mw mm mn mo mx mq mr ms ij bi translated">没有时间</p><blockquote class="oz pa pb"><p id="5e84" class="lx ly my lz b ma mt ka mc md mu kd mf pc mv mi mj pd mw mm mn pe mx mq mr ms ij bi translated">读取文件时，不要更新文件访问时间。这个选项在有大量文件的文件系统上很有用，并且<strong class="lz ja">性能比更新文件访问时间更重要</strong>(这很少是重要的)。</p></blockquote><p id="e9e9" class="pw-post-body-paragraph lx ly iq lz b ma mt ka mc md mu kd mf mg mv mi mj mk mw mm mn mo mx mq mr ms ij bi translated">障碍=0</p><blockquote class="oz pa pb"><p id="518c" class="lx ly my lz b ma mt ka mc md mu kd mf pc mv mi mj pd mw mm mn pe mx mq mr ms ij bi translated">这允许/禁止在 jbd 代码中使用写屏障。barrier=0 禁用，barrier=1 使能。这也需要一个支持栅栏的 IO 堆栈，如果 jbd 在栅栏写操作中出错，它将再次禁用并发出警告。写屏障强制日志提交在磁盘上正确排序，使易失性磁盘写缓存可以安全使用，但性能会有所下降。如果您的磁盘以某种方式由电池供电，<strong class="lz ja">禁用屏障可能会安全地提高性能</strong>。挂载选项“barrier”和“nobarrier”也可用于启用或禁用屏障，以与其他 ext4 挂载选项保持一致。</p></blockquote><p id="44e9" class="pw-post-body-paragraph lx ly iq lz b ma mt ka mc md mu kd mf mg mv mi mj mk mw mm mn mo mx mq mr ms ij bi translated">提交=30</p><blockquote class="oz pa pb"><p id="9f91" class="lx ly my lz b ma mt ka mc md mu kd mf pc mv mi mj pd mw mm mn pe mx mq mr ms ij bi translated">Ext4 可以被告知每‘nrsec’秒同步其所有数据和元数据。默认值为 5 秒。这意味着，如果您断电，您将会丢失最近 5 秒钟的工作(由于日志记录，您的文件系统不会被损坏)。这个默认值(或任何较低的值)会损害性能，但有利于数据安全。将其设置为 0 与保留默认值(5 秒)的效果相同。将它设置为非常大的<strong class="lz ja">值将会提高性能。</strong></p></blockquote></div><div class="ab cl nd ne hu nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="ij ik il im in"><h1 id="e04f" class="lf lg iq bd lh li nk lk ll lm nl lo lp kf nm kg lr ki nn kj lt kl no km lv lw bi translated">灾难…(长角牛再平衡)</h1><p id="9542" class="pw-post-body-paragraph lx ly iq lz b ma mb ka mc md me kd mf mg mh mi mj mk ml mm mn mo mp mq mr ms ij bi translated">为了模拟磁盘上的一些负载，我简单地从一个没有应用 ext4 选项的节点上删除了一个大约 5GB 卷的副本。Longhorn 会自动重新创建并同步它，导致网络和磁盘负载。</p><h2 id="2fc5" class="od lg iq bd lh oe of dn ll og oh dp lp mg oi oj lr mk ok ol lt mo om on lv iw bi translated">没有 ext4 调整</h2><p id="46fb" class="pw-post-body-paragraph lx ly iq lz b ma mb ka mc md me kd mf mg mh mi mj mk ml mm mn mo mp mq mr ms ij bi translated">节点变为“未就绪”，群集变得不稳定且无法恢复。磁盘延迟飙升，导致级联长角牛故障和重新平衡。重新启动 k3s 进程有助于恢复节点。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi pf"><img src="../Images/917ae82fd4753a720221807921f96705.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sVNEsLDMKDjq5nSC9PeVRw.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">Etcd 磁盘延迟飙升至 8 秒。</figcaption></figure><h2 id="e9c8" class="od lg iq bd lh oe of dn ll og oh dp lp mg oi oj lr mk ok ol lt mo om on lv iw bi translated">带 ext4 调整</h2><p id="9f61" class="pw-post-body-paragraph lx ly iq lz b ma mb ka mc md me kd mf mg mh mi mj mk ml mm mn mo mp mq mr ms ij bi translated">在应用 ext4 选项的同时，执行相同的操作—删除大约 5GB longhorn 副本的相同拷贝。什么都没有……图表上完全看不到任何东西。当然，延迟增加了一点，但它保持在 10 毫秒以下。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi pg"><img src="../Images/b24fc780a3cc8412af2a63679f51cfd9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*okU6glQqWErGmbS4q6lz1A.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">Etcd 磁盘延迟保持在 10 毫秒以下。</figcaption></figure></div><div class="ab cl nd ne hu nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="ij ik il im in"><h1 id="97c2" class="lf lg iq bd lh li nk lk ll lm nl lo lp kf nm kg lr ki nn kj lt kl no km lv lw bi translated">放弃</h1><p id="3c17" class="pw-post-body-paragraph lx ly iq lz b ma mb ka mc md me kd mf mg mh mi mj mk ml mm mn mo mp mq mr ms ij bi translated">您会在主节点上运行 Longhorn 和工作负载吗？大概不会。但是，如果您只有三个节点可用，那么您必须确保您的集群保持稳定。</p><h1 id="bcb4" class="lf lg iq bd lh li lj lk ll lm ln lo lp kf lq kg lr ki ls kj lt kl lu km lv lw bi translated">结论</h1><p id="49c7" class="pw-post-body-paragraph lx ly iq lz b ma mb ka mc md me kd mf mg mh mi mj mk ml mm mn mo mp mq mr ms ij bi translated">留意 etcd 磁盘延迟！如果您有一个多节点集群，放松文件系统选项可以稳定您的 etcd 集群。我们牺牲了单个节点的可靠性，因为万一出现故障，我们还有另外两个节点。</p><p id="b8f3" class="pw-post-body-paragraph lx ly iq lz b ma mt ka mc md mu kd mf mg mv mi mj mk mw mm mn mo mx mq mr ms ij bi translated">快乐吉托普斯！</p></div></div>    
</body>
</html>