<html>
<head>
<title>How to configure Azure DevOps with Terraform Cloud/Enterprise?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用 Terraform Cloud/Enterprise 配置 Azure DevOps？</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/how-to-configure-azure-devops-with-terraform-enterprise-cac1bbd9810b?source=collection_archive---------3-----------------------#2022-02-05">https://blog.devgenius.io/how-to-configure-azure-devops-with-terraform-enterprise-cac1bbd9810b?source=collection_archive---------3-----------------------#2022-02-05</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="ad44" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在本文中，我们将重点关注如何使用 Terraform Cloud/Enterprise (TFE)从 Azure DevOps 环境中将基础设施部署为代码。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/09c20f1111fa9d9d05fc556816778c04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nxTXSMb3B4vviTpT0Ta5hw.png"/></div></div></figure><p id="c1d6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">为了实现这一目标，有两种选择:</p><ul class=""><li id="5b44" class="ku kv in jm b jn jo jr js jv kw jz kx kd ky kh kz la lb lc bi translated">TFE <strong class="jm io">版本控制</strong>集成</li><li id="d9e0" class="ku kv in jm b jn ld jr le jv lf jz lg kd lh kh kz la lb lc bi translated">使用<strong class="jm io"> CLI 命令</strong>的 Azure DevOps (ADO)管道</li></ul><p id="3822" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在这两个选项中，我们将在 Terraform 中部署一个简单的输出模块。</p><pre class="kj kk kl km gt li lj lk ll aw lm bi"><span id="9b9b" class="ln lo in lj b gy lp lq l lr ls">output "hello_world" { <br/>    value = "Hello, World! We used the VSC/CLI workflow for this POC :)"<br/>}</span></pre><p id="459e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">所有代码都可以在我的 GitHub <a class="ae lt" href="https://github.com/ManelBoucenna/tfe-ado-connection" rel="noopener ugc nofollow" target="_blank">库</a>中找到。</p><h1 id="7ca9" class="lu lo in bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">假设</h1><p id="9c73" class="pw-post-body-paragraph jk jl in jm b jn mr jp jq jr ms jt ju jv mt jx jy jz mu kb kc kd mv kf kg kh ig bi translated">在开始之前，您应该有以下一些假设:</p><ul class=""><li id="3924" class="ku kv in jm b jn jo jr js jv kw jz kx kd ky kh kz la lb lc bi translated">关于 ADO 管道的基本知识</li><li id="8571" class="ku kv in jm b jn ld jr le jv lf jz lg kd lh kh kz la lb lc bi translated">TFE 或 Terraform 云组织</li><li id="5337" class="ku kv in jm b jn ld jr le jv lf jz lg kd lh kh kz la lb lc bi translated">TF 工作区</li></ul><h1 id="322a" class="lu lo in bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">TFE 版本控制集成</h1><p id="63a8" class="pw-post-body-paragraph jk jl in jm b jn mr jp jq jr ms jt ju jv mt jx jy jz mu kb kc kd mv kf kg kh ig bi translated">这种方法包括将包含您的 TF 配置的特定于<strong class="jm io">的</strong> ADO 存储库的分支关联到一个 TF Cloud workspace。</p><p id="d204" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这可用于自动:</p><ul class=""><li id="4ae7" class="ku kv in jm b jn jo jr js jv kw jz kx kd ky kh kz la lb lc bi translated">在该分支上创建拉请求时，执行<a class="ae lt" href="https://www.terraform.io/cloud-docs/run/#speculative-plans" rel="noopener ugc nofollow" target="_blank">推测计划</a></li><li id="f8bc" class="ku kv in jm b jn ld jr le jv lf jz lg kd lh kh kz la lb lc bi translated">当提交被合并到该分支时，TF 的触发器队列运行。</li></ul><p id="dede" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">关于这种方法以及如何实施的更多细节可以在<a class="ae lt" href="https://www.terraform.io/cloud-docs/run/ui" rel="noopener ugc nofollow" target="_blank">这里</a>和<a class="ae lt" href="https://www.terraform.io/cloud-docs/vcs/azure-devops-services" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><h1 id="49e7" class="lu lo in bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">使用 CLI 命令的 ADO 管道</h1><p id="c1a8" class="pw-post-body-paragraph jk jl in jm b jn mr jp jq jr ms jt ju jv mt jx jy jz mu kb kc kd mv kf kg kh ig bi translated">这种方法模拟了运行<code class="fe mw mx my lj b">terraform login</code>然后引入 TFE 令牌的手动步骤。这样做通常会生成以下 CLI 配置文件(<code class="fe mw mx my lj b">.terraformrc</code>或<code class="fe mw mx my lj b">terraform.rc</code>):</p><pre class="kj kk kl km gt li lj lk ll aw lm bi"><span id="085a" class="ln lo in lj b gy lp lq l lr ls">credentials "app.terraform.io" {<br/>     token = "xxxxxx.yyyyyyy.zzzzzzzzzzzzz"<br/>  }</span></pre><p id="475e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">要在管道中自动化这一步骤:</p><ul class=""><li id="1a77" class="ku kv in jm b jn jo jr js jv kw jz kx kd ky kh kz la lb lc bi translated">在 TF 配置文件中添加 TF 组织和工作空间的值:</li></ul><pre class="kj kk kl km gt li lj lk ll aw lm bi"><span id="269a" class="ln lo in lj b gy lp lq l lr ls">terraform { <br/>    backend "remote"{ <br/>             organization = "YOUR-TFE-ORGANIZATION" #REPLACE_ME<br/>             workspaces { <br/>                        name = "YOUR-TFE-WORKSPACE" #REPLACE_ME<br/>                        } <br/>             }<br/>}</span></pre><blockquote class="mz na nb"><p id="f85b" class="jk jl nc jm b jn jo jp jq jr js jt ju nd jw jx jy ne ka kb kc nf ke kf kg kh ig bi translated">为了连接到 TFE/Cloud，您需要提供 API 令牌的凭据。如<a class="ae lt" href="https://www.terraform.io/cli/config/config-file#credentials-1" rel="noopener ugc nofollow" target="_blank"> TF 文档</a>所述，提供的令牌必须是<a class="ae lt" href="https://www.terraform.io/cloud-docs/users-teams-organizations/users#api-tokens" rel="noopener ugc nofollow" target="_blank"> <strong class="jm io">用户令牌</strong> </a>或<a class="ae lt" href="https://www.terraform.io/cloud-docs/users-teams-organizations/api-tokens#team-api-tokens" rel="noopener ugc nofollow" target="_blank"> <strong class="jm io">团队令牌</strong></a>；组织令牌不能用于 CLI Terraform 操作。</p></blockquote><ul class=""><li id="7a8e" class="ku kv in jm b jn jo jr js jv kw jz kx kd ky kh kz la lb lc bi translated">将您的 TF API 标记作为敏感值保存在 ADO 变量组中。</li><li id="135b" class="ku kv in jm b jn ld jr le jv lf jz lg kd lh kh kz la lb lc bi translated">在 ADO 管道的开头添加一个步骤，用于生成 CLI 配置文件。文件的位置可以使用<code class="fe mw mx my lj b">TF_CLI_CONFIG_FILE</code> <a class="ae lt" href="https://www.terraform.io/cli/config/environment-variables" rel="noopener ugc nofollow" target="_blank">环境变量</a>来指定。其他选项可能存在，如这里的<a class="ae lt" href="https://www.terraform.io/cli/config/config-file#locations" rel="noopener ugc nofollow" target="_blank">所述</a>。</li></ul><pre class="kj kk kl km gt li lj lk ll aw lm bi"><span id="2a13" class="ln lo in lj b gy lp lq l lr ls">variables:<br/>- group: terraform-env<br/><br/>steps:<br/>- script: |<br/>        RC_FILE=".terraformrc"<br/>        cat &gt; ${RC_FILE} &lt;&lt; EOF<br/>        credentials "app.terraform.io" {<br/>          token = "$(terraform-api-token)"<br/>        }<br/>        EOF<br/>        mv .terraformrc ~/.terraformrc<br/>        export TF_CLI_CONFIG_FILE="~/.terraformrc"<br/>  name: terraform_cloud_credentials<br/>  displayName: 'Terraform Cloud Credentials'</span></pre><ul class=""><li id="a2e6" class="ku kv in jm b jn jo jr js jv kw jz kx kd ky kh kz la lb lc bi translated">完成其余的 TF 步骤(安装、初始化、计划和应用)</li><li id="ea24" class="ku kv in jm b jn ld jr le jv lf jz lg kd lh kh kz la lb lc bi translated">添加最后一个步骤来清理您的 CLI 配置文件。</li></ul><p id="c053" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">完整的 ADO 管道应该如下所示:</p><pre class="kj kk kl km gt li lj lk ll aw lm bi"><span id="8113" class="ln lo in lj b gy lp lq l lr ls">variables:<br/>- group: terraform-env<br/><br/>steps:<br/>- task: charleszipp.azure-pipelines-tasks-terraform.azure-pipelines-tasks-terraform-installer.TerraformInstaller@0<br/>  displayName: 'Use Terraform latest'<br/><br/>- script: |<br/>        RC_FILE=".terraformrc"<br/>        cat &gt; ${RC_FILE} &lt;&lt; EOF<br/>        credentials "app.terraform.io" {<br/>          token = "$(terraform-api-token)"<br/>        }<br/>        EOF<br/>        mv .terraformrc ~/.terraformrc<br/>        export TF_CLI_CONFIG_FILE="~/.terraformrc"<br/>  name: terraform_cloud_credentials<br/>  displayName: 'Terraform Cloud Credentials'<br/><br/>- task: TerraformCLI@0<br/>  inputs:<br/>    command: 'init'<br/>    backendType: 'selfConfigured'<br/>    allowTelemetryCollection: true<br/><br/>- task: TerraformCLI@0<br/>  inputs:<br/>    command: 'plan'<br/>    allowTelemetryCollection: true<br/><br/>- task: TerraformCLI@0<br/>  inputs:<br/>    command: 'apply'<br/>    allowTelemetryCollection: true<br/>- script: |<br/>        rm ~/.terraformrc<br/>  name: terraform_cloud_credentials_cleanup<br/>  displayName: 'Terraform Cloud Credentials Clean Up'</span></pre><blockquote class="mz na nb"><p id="c742" class="jk jl nc jm b jn jo jp jq jr js jt ju nd jw jx jy ne ka kb kc nf ke kf kg kh ig bi translated">至于 VC 方法，<code class="fe mw mx my lj b"><a class="ae lt" href="https://www.terraform.io/cloud-docs/run/cli#terraform-plan" rel="noopener ugc nofollow" target="_blank">terraform plan</a></code>在 Terraform Cloud workspace 中启动<a class="ae lt" href="https://www.terraform.io/cloud-docs/run/#speculative-plans" rel="noopener ugc nofollow" target="_blank">投机计划</a>，<code class="fe mw mx my lj b"><a class="ae lt" href="https://www.terraform.io/cloud-docs/run/cli#terraform-apply" rel="noopener ugc nofollow" target="_blank">terraform apply</a></code>启动正常计划并申请。</p></blockquote><p id="acc6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">运行管道时，您应该在工作区中看到“通过 CLI 触发”的运行:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ng"><img src="../Images/e2fa6b195bd5e346772b501fcd4be52c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9O0ZVqRHglK3G7bK_TQvkA.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nh"><img src="../Images/ebcea91129e876f30b03a446901c2851.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g5Q6LM19InEN1in9FTNL-w.png"/></div></div><figcaption class="ni nj gj gh gi nk nl bd b be z dk translated">运行的输出</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nm"><img src="../Images/8135bc121f9df98505d88b0dc1c55f28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5SUQmRl7CSXT97MsOeKU6Q.png"/></div></div><figcaption class="ni nj gj gh gi nk nl bd b be z dk translated">状态文件</figcaption></figure><p id="5e69" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">完整的代码可以在我的 GitHub <a class="ae lt" href="https://github.com/ManelBoucenna/tfe-ado-connection/tree/main/cli-workflow" rel="noopener ugc nofollow" target="_blank">库</a>中找到。</p><h1 id="cc8c" class="lu lo in bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">参考</h1><ul class=""><li id="4ee1" class="ku kv in jm b jn mr jr ms jv nn jz no kd np kh kz la lb lc bi translated">地形云和 TFE <a class="ae lt" href="https://www.terraform.io/cloud-docs" rel="noopener ugc nofollow" target="_blank">文档</a></li><li id="9759" class="ku kv in jm b jn ld jr le jv lf jz lg kd lh kh kz la lb lc bi translated">迈克·海克利的<strong class="jm io"> </strong> <a class="ae lt" href="https://mikehacker.dev/blog/configuring-terraform-enterprise-credentials-to-work-with-azure-devops/" rel="noopener ugc nofollow" target="_blank">文章</a> <strong class="jm io"> </strong>在他的博客<strong class="jm io"/><a class="ae lt" href="https://mikehacker.dev/blog/" rel="noopener ugc nofollow" target="_blank">香蕉为鳞</a><strong class="jm io"/></li></ul></div></div>    
</body>
</html>