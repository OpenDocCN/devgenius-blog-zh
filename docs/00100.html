<html>
<head>
<title>How To Create a Today Extension Widget in Swift</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在 Swift 中创建今日扩展小部件</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/how-to-create-a-today-extension-widget-in-swift-8892fcd30ea8?source=collection_archive---------0-----------------------#2019-12-11">https://blog.devgenius.io/how-to-create-a-today-extension-widget-in-swift-8892fcd30ea8?source=collection_archive---------0-----------------------#2019-12-11</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><div class=""/><div class=""><h2 id="51c8" class="pw-subtitle-paragraph jo iq ir bd b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dk translated">关于如何创建“今日”扩展以在通知中心显示信息的教程</h2></div><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj kg"><img src="../Images/78242992622def98084b96e6a30e3664.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*wrY1KHXIJnJBObuD"/></div></div><figcaption class="ks kt gk gi gj ku kv bd b be z dk translated">照片由<a class="ae kw" href="https://unsplash.com/@jantined?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Jantine Doornbos </a>在<a class="ae kw" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="b93d" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">iOS 8 上引入的应用程序扩展使用户可以通过 iOS 在其他应用程序中访问你的应用程序的功能。例如，您可以将您的应用程序添加到“今日”屏幕，并在动作表上添加新动作，创建新的自定键盘，或者添加 Siri 命令，用户可以使用它来进行语音控制动作。</p><p id="622d" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">目前 iOS 支持以下扩展:共享、今日、照片编辑、自定义键盘、文件提供程序、动作、文档提供程序、finder 同步和音频。</p></div><div class="ab cl lt lu hv lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ik il im in io"><h1 id="f760" class="ma mb ir bd mc md me mf mg mh mi mj mk jx ml jy mm ka mn kb mo kd mp ke mq mr bi translated">入门指南</h1><p id="8214" class="pw-post-body-paragraph kx ky ir kz b la ms js lc ld mt jv lf lg mu li lj lk mv lm ln lo mw lq lr ls ik bi translated">首先，打开<a class="ae kw" href="https://developer.apple.com/xcode/" rel="noopener ugc nofollow" target="_blank"> Xcode </a>，新建一个项目。选择单视图应用程序。</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj mx"><img src="../Images/15ce2a04f03084e7776445340615a2b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1HzmRLY_UckENC447d0-Jw.png"/></div></div></figure><p id="7e1e" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">然后创建一个新类，命名为<code class="fe my mz na nb b">WeatherAPI.swift</code>。在这里，我们把我们将用来从<a class="ae kw" href="https://www.metaweather.com" rel="noopener ugc nofollow" target="_blank"> MetaWeather </a>获取天气预报的方法。</p><p id="7c9f" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">转到<code class="fe my mz na nb b">Main.Storyboard</code>文件，在屏幕中间添加三个标签和一个<code class="fe my mz na nb b">UIImageView</code>。</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj nc"><img src="../Images/733c10fbc123cc6d48b34b95c0cf0747.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s0luxF9gUy6GSbLqmXvvVA.png"/></div></div></figure><p id="a418" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">现在，我们需要得到伦敦的天气预报。将以下代码放入您的<code class="fe my mz na nb b">WeatherAPI.swift</code>文件中:</p><pre class="kh ki kj kk gu nd nb ne nf aw ng bi"><span id="7316" class="nh mb ir nb b gz ni nj l nk nl">import Foundation<br/><br/>class WeatherAPI {<br/>    <br/>    // 44418 - London<br/>    // Read here https://www.metaweather.com/api/ to know how to get you city<br/>    let weatherAPIEndpoint = "https://www.metaweather.com/api/location/44418/"<br/>    <br/>    func getWeather(result: @escaping (WeatherResponse?) -&gt; ()) {<br/>        <br/>        let request = NSMutableURLRequest(url: NSURL(string: weatherAPIEndpoint)! as URL,<br/>                                                cachePolicy: .useProtocolCachePolicy,<br/>                                            timeoutInterval: 10.0)<br/>        request.httpMethod = "GET"<br/><br/>        let session = URLSession.shared<br/>        let dataTask = session.dataTask(with: request as URLRequest, completionHandler: { (data, response, error) -&gt; Void in<br/>            if (error != nil) {<br/>                print(error)<br/>            } else {<br/><br/>                do {<br/>                    let responseJSON = try JSONDecoder().decode(WeatherResponse.self, from: data!)<br/>                    result(responseJSON)<br/>                } catch {<br/>                    print("error")<br/>                }<br/>                <br/>            }<br/>        })<br/><br/>        dataTask.resume()<br/>        <br/>    }<br/>    <br/>}</span></pre><p id="bd93" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">为响应添加一个新文件，并将以下代码放入其中:</p><pre class="kh ki kj kk gu nd nb ne nf aw ng bi"><span id="0f03" class="nh mb ir nb b gz ni nj l nk nl">import Foundation<br/><br/>// MARK: - Post<br/>class WeatherResponse: Codable {<br/>    let consolidatedWeather: [ConsolidatedWeather]<br/>    let time, sunRise, sunSet, timezoneName: String<br/>    let parent: Parent<br/>    let sources: [Source]<br/>    let title, locationType: String<br/>    let woeid: Int<br/>    let lattLong, timezone: String<br/><br/>    enum CodingKeys: String, CodingKey {<br/>        case consolidatedWeather = "consolidated_weather"<br/>        case time<br/>        case sunRise = "sun_rise"<br/>        case sunSet = "sun_set"<br/>        case timezoneName = "timezone_name"<br/>        case parent, sources, title<br/>        case locationType = "location_type"<br/>        case woeid<br/>        case lattLong = "latt_long"<br/>        case timezone<br/>    }<br/><br/>    init(consolidatedWeather: [ConsolidatedWeather], time: String, sunRise: String, sunSet: String, timezoneName: String, parent: Parent, sources: [Source], title: String, locationType: String, woeid: Int, lattLong: String, timezone: String) {<br/>        self.consolidatedWeather = consolidatedWeather<br/>        self.time = time<br/>        self.sunRise = sunRise<br/>        self.sunSet = sunSet<br/>        self.timezoneName = timezoneName<br/>        self.parent = parent<br/>        self.sources = sources<br/>        self.title = title<br/>        self.locationType = locationType<br/>        self.woeid = woeid<br/>        self.lattLong = lattLong<br/>        self.timezone = timezone<br/>    }<br/>}<br/><br/>// MARK: - ConsolidatedWeather<br/>class ConsolidatedWeather: Codable {<br/>    let id: Int<br/>    let weatherStateName, weatherStateAbbr, windDirectionCompass, created: String<br/>    let applicableDate: String<br/>    let minTemp, maxTemp, theTemp, windSpeed: Double<br/>    let windDirection, airPressure: Double<br/>    let humidity: Int<br/>    let visibility: Double<br/>    let predictability: Int<br/><br/>    enum CodingKeys: String, CodingKey {<br/>        case id<br/>        case weatherStateName = "weather_state_name"<br/>        case weatherStateAbbr = "weather_state_abbr"<br/>        case windDirectionCompass = "wind_direction_compass"<br/>        case created<br/>        case applicableDate = "applicable_date"<br/>        case minTemp = "min_temp"<br/>        case maxTemp = "max_temp"<br/>        case theTemp = "the_temp"<br/>        case windSpeed = "wind_speed"<br/>        case windDirection = "wind_direction"<br/>        case airPressure = "air_pressure"<br/>        case humidity, visibility, predictability<br/>    }<br/><br/>    init(id: Int, weatherStateName: String, weatherStateAbbr: String, windDirectionCompass: String, created: String, applicableDate: String, minTemp: Double, maxTemp: Double, theTemp: Double, windSpeed: Double, windDirection: Double, airPressure: Double, humidity: Int, visibility: Double, predictability: Int) {<br/>        self.id = id<br/>        self.weatherStateName = weatherStateName<br/>        self.weatherStateAbbr = weatherStateAbbr<br/>        self.windDirectionCompass = windDirectionCompass<br/>        self.created = created<br/>        self.applicableDate = applicableDate<br/>        self.minTemp = minTemp<br/>        self.maxTemp = maxTemp<br/>        self.theTemp = theTemp<br/>        self.windSpeed = windSpeed<br/>        self.windDirection = windDirection<br/>        self.airPressure = airPressure<br/>        self.humidity = humidity<br/>        self.visibility = visibility<br/>        self.predictability = predictability<br/>    }<br/>}<br/><br/>// MARK: - Parent<br/>class Parent: Codable {<br/>    let title, locationType: String<br/>    let woeid: Int<br/>    let lattLong: String<br/><br/>    enum CodingKeys: String, CodingKey {<br/>        case title<br/>        case locationType = "location_type"<br/>        case woeid<br/>        case lattLong = "latt_long"<br/>    }<br/><br/>    init(title: String, locationType: String, woeid: Int, lattLong: String) {<br/>        self.title = title<br/>        self.locationType = locationType<br/>        self.woeid = woeid<br/>        self.lattLong = lattLong<br/>    }<br/>}<br/><br/>// MARK: - Source<br/>class Source: Codable {<br/>    let title, slug: String<br/>    let url: String<br/>    let crawlRate: Int<br/><br/>    enum CodingKeys: String, CodingKey {<br/>        case title, slug, url<br/>        case crawlRate = "crawl_rate"<br/>    }<br/><br/>    init(title: String, slug: String, url: String, crawlRate: Int) {<br/>        self.title = title<br/>        self.slug = slug<br/>        self.url = url<br/>        self.crawlRate = crawlRate<br/>    }<br/>}</span></pre><p id="9209" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">现在回到你的<code class="fe my mz na nb b">ViewController.swift</code>文件，添加下面的变量作为全局变量。我们将使用它来获取徽标图像:</p><pre class="kh ki kj kk gu nd nb ne nf aw ng bi"><span id="527a" class="nh mb ir nb b gz ni nj l nk nl">let imageEndpointURL = "https://www.metaweather.com/static/img/weather/png/#IMAGE#.png"</span></pre><p id="23b2" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">然后添加以下函数，并在<code class="fe my mz na nb b">viewDidLoad</code>上调用它:</p><pre class="kh ki kj kk gu nd nb ne nf aw ng bi"><span id="f247" class="nh mb ir nb b gz ni nj l nk nl">func loadWeather() {<br/>        let API = WeatherAPI()<br/>        API.getWeather { (response) in<br/>            <br/>            DispatchQueue.main.async() {<br/>                <br/>                // get tomorrow object<br/>                let tomorrowWeather = response?.consolidatedWeather[1]<br/>                guard let unwTomorrowWeather = tomorrowWeather else {<br/>                    return<br/>                }<br/>                <br/>                // set city name<br/>                self.cityLabel.text = response?.title<br/><br/>                // get image<br/>                let weatherStateAbbr = tomorrowWeather?.weatherStateAbbr<br/>                guard let unwWeatherStateAbbr = weatherStateAbbr else {<br/>                    return<br/>                }<br/>                let imageString =  self.imageEndpointURL.replacingOccurrences(of: "#IMAGE#", with: unwWeatherStateAbbr)<br/>                let imageUrl = URL(string: imageString)<br/>                guard let unwImageUrl = imageUrl else {<br/>                    return<br/>                }<br/>                let data = try? Data(contentsOf: unwImageUrl)<br/>                <br/>                // set weather image<br/>                if let imageData = data {<br/>                    self.weatherImage.image = UIImage(data: imageData)<br/>                }<br/>                <br/>                // set weather label<br/>                self.weatherLabel.text = unwTomorrowWeather.weatherStateName<br/>            }<br/><br/>        }<br/>    }</span></pre><p id="b6bd" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">现在，如果我们启动应用程序，结果应该是这样的:</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div class="gi gj nm"><img src="../Images/190718510be37c349b7b963d51cccdd2.png" data-original-src="https://miro.medium.com/v2/resize:fit:700/format:webp/1*m7JBBXCAKkTkbpTVaUV3GA.png"/></div></figure></div><div class="ab cl lt lu hv lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ik il im in io"><h1 id="8b83" class="ma mb ir bd mc md me mf mg mh mi mj mk jx ml jy mm ka mn kb mo kd mp ke mq mr bi translated">履行</h1><p id="dd4a" class="pw-post-body-paragraph kx ky ir kz b la ms js lc ld mt jv lf lg mu li lj lk mv lm ln lo mw lq lr ls ik bi translated">我们的应用程序已经准备好了，但是这个教程应该解释如何创建一个 Today 扩展，对吗？</p><p id="63e6" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">首先，进入你的项目设置，点击底部的+按钮，选择今日扩展:</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj nn"><img src="../Images/fc4f755741702a4aeb8549e0d0d916bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fjIENO9vjVLnJExrCu2Ylw.png"/></div></div></figure><p id="b81d" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">现在，您的项目导航器中应该添加了三个新文件:</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div class="gi gj no"><img src="../Images/ec4c069f2b1267ac16841130efff9cca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1012/format:webp/1*qu30lhz3eB6TcNSaLKBBrg.png"/></div></figure><p id="189d" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">选择<code class="fe my mz na nb b">MainInterface.storyboard</code>文件，添加两个标签和一个图像。</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div class="gi gj np"><img src="../Images/62813e69919aa88ad7a2f13c5bbaf8c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1224/format:webp/1*wABPb1UhorJzy0NUBM_hSA.png"/></div></figure><p id="fc28" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">选择<code class="fe my mz na nb b">WeatherAPI.swift</code>和<code class="fe my mz na nb b">WeatherResponse.swift</code>文件，并在目标中添加 Today 扩展名。</p><p id="1101" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">这是从扩展访问该方法所必需的。</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div class="gi gj nq"><img src="../Images/c4decf5abab480255fe6cce9506191d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1056/format:webp/1*5A6sf7WEUZrFqA9LZIStxw.png"/></div></figure><p id="dc40" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">现在，进入您的<code class="fe my mz na nb b">TodayViewController.swift</code>文件，添加以下变量作为全局变量。我们将使用它来获取徽标图像:</p><pre class="kh ki kj kk gu nd nb ne nf aw ng bi"><span id="e37d" class="nh mb ir nb b gz ni nj l nk nl">let imageEndpointURL = "https://www.metaweather.com/static/img/weather/png/#IMAGE#.png"</span></pre><p id="3301" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">然后在<code class="fe my mz na nb b">viewDidLoad</code>上，添加下面一行…</p><pre class="kh ki kj kk gu nd nb ne nf aw ng bi"><span id="e979" class="nh mb ir nb b gz ni nj l nk nl">extensionContext?.widgetLargestAvailableDisplayMode = .expanded</span></pre><p id="e8aa" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">…以及以下功能，以便允许小部件扩展:</p><pre class="kh ki kj kk gu nd nb ne nf aw ng bi"><span id="7ad1" class="nh mb ir nb b gz ni nj l nk nl">func widgetActiveDisplayModeDidChange(_ activeDisplayMode: NCWidgetDisplayMode, withMaximumSize maxSize: CGSize) {<br/>      let expanded = activeDisplayMode == .expanded<br/>      preferredContentSize = expanded ? CGSize(width: maxSize.width, height: 200) : maxSize<br/>    }</span></pre><p id="a2fd" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">最后，添加从<a class="ae kw" href="https://www.metaweather.com" rel="noopener ugc nofollow" target="_blank">metaweither</a>获取数据并在 Today 扩展中显示数据的代码:</p><pre class="kh ki kj kk gu nd nb ne nf aw ng bi"><span id="baff" class="nh mb ir nb b gz ni nj l nk nl">let API = WeatherAPI()<br/>        API.getWeather { (response) in<br/>            <br/>            DispatchQueue.main.async() {<br/>                // get tomorrow object<br/>                let tomorrowWeather = response?.consolidatedWeather[1]<br/>                guard let unwTomorrowWeather = tomorrowWeather else {<br/>                    return<br/>                }<br/>                                               <br/>                self.cityLabel.text = response?.title<br/>                <br/>                // set city name<br/>                self.cityLabel.text = response?.title<br/><br/>                // get image<br/>                let weatherStateAbbr = tomorrowWeather?.weatherStateAbbr<br/>                guard let unwWeatherStateAbbr = weatherStateAbbr else {<br/>                    return<br/>                }<br/>                let imageString =  self.imageEndpointURL.replacingOccurrences(of: "#IMAGE#", with: unwWeatherStateAbbr)<br/>                let imageUrl = URL(string: imageString)<br/>                guard let unwImageUrl = imageUrl else {<br/>                    return<br/>                }<br/>                let data = try? Data(contentsOf: unwImageUrl)<br/>                               <br/>                // set weather image<br/>                if let imageData = data {<br/>                    self.weatherImage.image = UIImage(data: imageData)<br/>                }<br/>                               <br/>                // set weather label<br/>                self.weatherLabel.text = unwTomorrowWeather.weatherStateName<br/>                <br/>            }<br/>        }</span></pre></div><div class="ab cl lt lu hv lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ik il im in io"><h1 id="2c3f" class="ma mb ir bd mc md me mf mg mh mi mj mk jx ml jy mm ka mn kb mo kd mp ke mq mr bi translated">试验</h1><p id="fd5c" class="pw-post-body-paragraph kx ky ir kz b la ms js lc ld mt jv lf lg mu li lj lk mv lm ln lo mw lq lr ls ik bi translated">最后，我们准备测试应用程序。</p><p id="51e2" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">运行模拟器。在通知中心，点击编辑，并添加新的小部件。如果你都做对了，结果应该是这样的:</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div class="gi gj nm"><img src="../Images/3d510d445aefc500c56f884f0ddbd658.png" data-original-src="https://miro.medium.com/v2/resize:fit:700/format:webp/1*P0DMW_enhzemFr4tCukH8A.png"/></div></figure></div><div class="ab cl lt lu hv lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ik il im in io"><figure class="kh ki kj kk gu kl gi gj paragraph-image"><a href="https://www.buymeacoffee.com/nicolidomenico"><div class="gi gj nr"><img src="../Images/2a5f4681ef2bdba5652dc9b023b668a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D-JJemrcn63kKj3lPBwZ5w.png"/></div></a></figure><h1 id="b3fb" class="ma mb ir bd mc md ns mf mg mh nt mj mk jx nu jy mm ka nv kb mo kd nw ke mq mr bi translated">完整代码</h1><p id="0ba4" class="pw-post-body-paragraph kx ky ir kz b la ms js lc ld mt jv lf lg mu li lj lk mv lm ln lo mw lq lr ls ik bi translated">你可以在<a class="ae kw" href="https://github.com/domeniconicoli/AppExtensionsExample" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到完整的代码。感谢您的阅读。</p></div></div>    
</body>
</html>