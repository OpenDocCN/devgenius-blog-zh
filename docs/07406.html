<html>
<head>
<title>ARRAY_AGG(expr), Aggregate Repeated Rows and Get an Easy-to-Read GA4 E-commerce Table with BigQuery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ARRAY_AGG(expr)，聚合重复的行，用 BigQuery 得到一个易读的 GA4 电子商务表</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/array-agg-expr-aggregate-repeated-rows-and-get-an-easy-to-read-ga4-e-commerce-table-with-6b40a779b292?source=collection_archive---------5-----------------------#2022-03-22">https://blog.devgenius.io/array-agg-expr-aggregate-repeated-rows-and-get-an-easy-to-read-ga4-e-commerce-table-with-6b40a779b292?source=collection_archive---------5-----------------------#2022-03-22</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/38426990df51943fa0f1c76ffd607e50.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*t9azD4jNwCe4pvJf.png"/></div></div></figure><p id="28ee" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">目录</p><blockquote class="kt ku kv"><p id="735c" class="jv jw kw jx b jy jz ka kb kc kd ke kf kx kh ki kj ky kl km kn kz kp kq kr ks ig bi translated"><a class="ae la" href="#4f53" rel="noopener ugc nofollow">简介</a> <br/> <a class="ae la" href="#9ab7" rel="noopener ugc nofollow">经典场景</a><br/><a class="ae la" href="#116b" rel="noopener ugc nofollow">ARRAY _ AGG(expr)</a><br/><a class="ae la" href="#e333" rel="noopener ugc nofollow">有什么变化？</a> <br/> <a class="ae la" href="#15ca" rel="noopener ugc nofollow">结论</a></p></blockquote><h1 id="4f53" class="lb lc in bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">介绍</h1><p id="477a" class="pw-post-body-paragraph jv jw in jx b jy lz ka kb kc ma ke kf kg mb ki kj kk mc km kn ko md kq kr ks ig bi translated">情况是这样的:您想要一个为数据源返回<code class="fe me mf mg mh b">x, y and z</code>的查询。知道有可能，你努力尝试，寻找方法。有时候你很快就明白了，有时候你绞尽脑汁直到明白为止。</p><p id="2b32" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">第二天你检查结果，看着<em class="kw">查询</em>，你对自己说“<em class="kw">这没问题，它能工作，但是如果我改变它，它会更好</em>”。然后你重新开始这个过程，然后……<strong class="jx io">嘣！回到起点！</strong></p><p id="02bb" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">改进和优化<em class="kw">查询</em> </strong>是分析师日常工作的一部分。甚至在实现了你计划要做的事情之后，你(自愿地)破坏自己，重新开始以提高结果。</p><p id="b397" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在今天的文章中，我通过使用<code class="fe me mf mg mh b">ARRAY_AGG(expr)</code>函数来增强已经运行良好的<em class="kw">查询</em>来解释这种情况。</p><h1 id="9ab7" class="lb lc in bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">经典场景</h1><p id="e0a8" class="pw-post-body-paragraph jv jw in jx b jy lz ka kb kc ma ke kf kg mb ki kj kk mc km kn ko md kq kr ks ig bi translated">之前……在本文的<a class="ae la" href="https://medium.com/@Marshall.Sansano.Roma/with-create-permanent-unnested-tables-from-temporary-tables-in-a-ga4-e-commerce-project-in-cfbf87381797" rel="noopener">中,</a>我们使用了<code class="fe me mf mg mh b">UNNEST</code>函数来取消嵌套参数，使用<code class="fe me mf mg mh b">WITH</code>函数来创建一个表，该表结合了特定事件的<em class="kw"> event_params、items </em>和<em class="kw">user _ properties’</em>值。</p><figure class="mj mk ml mm gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mi"><img src="../Images/da8e8473e987424b88b5dd4c4544ff3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*CwHyacbJJ87mThrm"/></div></div></figure><p id="07d2" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io"/>q<em class="kw">查询的</em>结果<strong class="jx io">是正确的</strong>，表格显示了按日期和 user_pseudo_id 添加到购物车的产品。</p><p id="13c0" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们能改进查询<em class="kw">并得到一个更容易阅读的表格吗？我们当然可以🤓 ️</em></p><h1 id="116b" class="lb lc in bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">ARRAY_AGG 函数</h1><p id="b39f" class="pw-post-body-paragraph jv jw in jx b jy lz ka kb kc ma ke kf kg mb ki kj kk mc km kn ko md kq kr ks ig bi translated"><code class="fe me mf mg mh b">ARRAY_AGG(expr)</code>函数<strong class="jx io">聚集重复行</strong>的值，返回这些重复值的空行。在大数据量中，它允许减少<em class="kw">查询</em>的权重，从而<strong class="jx io">改善处理</strong>和成本。</p><figure class="mj mk ml mm gt jo"><div class="bz fp l di"><div class="mn mo l"/></div></figure><figure class="mj mk ml mm gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mp"><img src="../Images/bc4ed781e91804d2edc286a9855ac243.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*POzIYcjr5GpgrNAM.png"/></div></div></figure><p id="59f7" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="kw">查询</em>的结果是一个比前一个更好的<strong class="jx io"/><strong class="jx io">表</strong>，使得<strong class="jx io">更容易读取和解释数据</strong>。</p><h1 id="e333" class="lb lc in bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">有什么变化？</h1><p id="5b90" class="pw-post-body-paragraph jv jw in jx b jy lz ka kb kc ma ke kf kg mb ki kj kk mc km kn ko md kq kr ks ig bi translated">我们使用的<em class="kw">查询</em>与上一篇文章的原始查询略有不同。三个新函数被添加到<strong class="jx io">返回一个优化的结果。</strong></p><ol class=""><li id="6f00" class="mq mr in jx b jy jz kc kd kg ms kk mt ko mu ks mv mw mx my bi translated"><code class="fe me mf mg mh b">FORMAT_TIME('%T', TIME(TIMESTAMP_MICROS(event_timestamp))) </code>将<em class="kw"> event_timestamp </em>转换为特定的小时时间。<br/>例如:1630944891873141 → 16:19</li><li id="c8cc" class="mq mr in jx b jy mz kc na kg nb kk nc ko nd ks mv mw mx my bi translated"><code class="fe me mf mg mh b">ARRAY_AGG(time)</code>对表中重复的值进行分组，并返回空的重复行，<strong class="jx io">允许更快的读取和分析</strong>。</li><li id="a618" class="mq mr in jx b jy mz kc na kg nb kk nc ko nd ks mv mw mx my bi translated"><code class="fe me mf mg mh b">COUNT (item_id), COUNT(item_id) * price</code>返回产品被添加到购物车的次数以及产品的总价。</li></ol><blockquote class="ne"><p id="2b85" class="nf ng in bd nh ni nj nk nl nm nn ks dk translated">“小变化带来大变化”</p></blockquote><h1 id="15ca" class="lb lc in bd ld le lf lg lh li lj lk ll lm no lo lp lq np ls lt lu nq lw lx ly bi translated">结论</h1><p id="6bb0" class="pw-post-body-paragraph jv jw in jx b jy lz ka kb kc ma ke kf kg mb ki kj kk mc km kn ko md kq kr ks ig bi translated"><code class="fe me mf mg mh b">SQL</code>爱好者通常会寻找改进<em class="kw">查询</em>的方法，以便在分析和数据解释时更加<strong class="jx io">高效。或者，至少，我认为应该是这样。</strong></p><p id="f335" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在这种寻求持续改进的过程中，数字分析师获得了新的功能，如<code class="fe me mf mg mh b">ARRAY_AGG(expr)</code>，这也为分析中新的相关问题打开了大门。</p><ul class=""><li id="0f16" class="mq mr in jx b jy jz kc kd kg ms kk mt ko mu ks nr mw mx my bi translated">一些用户在一天的不同时间向购物车添加产品是一种趋势还是一个孤立的案例？</li><li id="b0d0" class="mq mr in jx b jy mz kc na kg nb kk nc ko nd ks nr mw mx my bi translated">从用户将产品添加到购物车到进行购买已经过去了多少天？</li><li id="c9a1" class="mq mr in jx b jy mz kc na kg nb kk nc ko nd ks nr mw mx my bi translated">这些加入购物车的产品中有多少最终被购买了？</li><li id="baca" class="mq mr in jx b jy mz kc na kg nb kk nc ko nd ks nr mw mx my bi translated">我们能想出什么点子让用户往购物车里添加更多产品？</li></ul><p id="3ba0" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这些<strong class="jx io">新假设</strong>的每一个都伴随着<strong class="jx io">基于测试或数据比较的反思练习</strong>来验证或反驳它。这是找到不断上升的分析问题的答案的唯一途径。</p></div><div class="ab cl ns nt hr nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="ig ih ii ij ik"><p id="72c6" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我受到了 Martin Weitzmann 的文章<a class="ae la" href="https://towardsdatascience.com/bigquery-creating-nested-data-with-sql-727b761f1755" rel="noopener" target="_blank"> BigQuery:用 SQL 创建嵌套数据</a>的启发</p></div></div>    
</body>
</html>