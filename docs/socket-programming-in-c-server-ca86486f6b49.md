# C-Server ä¸­çš„å¥—æ¥å­—ç¼–ç¨‹

> åŸæ–‡ï¼š<https://blog.devgenius.io/socket-programming-in-c-server-ca86486f6b49?source=collection_archive---------5----------------------->

![](img/cdd7d90157f09b3bf73f8119926e213b.png)

æ¯å¤©ï¼Œæˆ‘ä»¬éƒ½ä¼šå‘ä¸åŒçš„æœåŠ¡å™¨å‘é€å¤§é‡çš„è¯·æ±‚ï¼Œå¹¶æ”¶åˆ°ç›¸åŒçš„å“åº”ã€‚ä½†æ˜¯ä½ æœ‰æ²¡æœ‰æƒ³è¿‡è¿™ç§äº¤æµæ˜¯å¦‚ä½•åœ¨å¼•æ“ç›–ä¸‹è¿›è¡Œçš„ï¼Ÿï¼Ÿè®©æˆ‘ä»¬å»å‘ç°å®ƒï¼

ä»Šå¤©ï¼Œæœ‰å¤§é‡çš„æ¡†æ¶ç”¨äºå¼€å‘æœåŠ¡å™¨(åŸºæœ¬ä¸Šæ˜¯åç«¯ API ),å¦‚ Flaskã€Djangoã€NodeJS ç­‰ã€‚ä½†å¤§å¤šæ•°æ—§æœåŠ¡å™¨éƒ½æ˜¯ä½¿ç”¨ C æˆ– C++ä»å¤´å¼€å§‹æ„å»ºçš„ã€‚è¿™ä¸€ç³»åˆ—åšå®¢å°†æŒ‡å¯¼æ‚¨ä½¿ç”¨ C è¯­è¨€å®ç°æœåŠ¡å™¨-å®¢æˆ·ç«¯é€šä¿¡ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„å¥—æ¥å­—ç¼–ç¨‹ã€‚

æ„å»ºä¸€ä¸ªå¤§è§„æ¨¡çš„æœåŠ¡å™¨éœ€è¦å¾ˆå¤šä¸œè¥¿ã€‚ä¸å¯èƒ½æ¶µç›–æœ¬ç³»åˆ—ä¸­çš„æ‰€æœ‰å†…å®¹ï¼Œä½†è¿™å¯èƒ½æ˜¯æ‚¨å­¦ä¹ å¥—æ¥å­—ç¼–ç¨‹çš„è‰¯å¥½å¼€ç«¯ã€‚

åœ¨ç»§ç»­ä¹‹å‰ï¼Œæˆ‘å‡è®¾æ‚¨å·²ç»å¯¹ç½‘ç»œæœ¯è¯­æœ‰äº†åŸºæœ¬çš„äº†è§£ï¼Œå¦‚æœåŠ¡å™¨ã€å®¢æˆ·æœºã€è¯·æ±‚ã€å“åº”ã€åè®®(TCP/IP)ç­‰ã€‚

# åˆ›å»ºä¸€ä¸ªå¥—æ¥å­—

## ä»€ä¹ˆæ˜¯æ’åº§ï¼Ÿ

å¥—æ¥å­—åŸºæœ¬ä¸Šæ˜¯æœºå™¨ä¸Šçš„ä¸€ä¸ªç«¯ç‚¹ï¼Œç”¨äºåœ¨ä¸¤ä¸ªä¸åŒçš„è¿›ç¨‹ä¹‹é—´è¿›è¡Œé€šä¿¡ã€‚åœ¨æˆ‘ä»¬çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œåœ¨æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯è¿›ç¨‹ä¹‹é—´ã€‚å®ƒç”¨äºåœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´å‘é€å’Œæ¥æ”¶æ•°æ®ã€‚

ç¬¬ä¸€æ­¥æ˜¯ä½¿ç”¨å¦‚ä¸‹å‚æ•°çš„ **socket()** å‡½æ•°åˆ›å»ºä¸€ä¸ªå¥—æ¥å­—ï¼Œ
**domain** :æŒ‡å®šå°†ç”¨äºé€šä¿¡çš„åè®®æ—ã€‚

ç½‘ç»œä¸­å®šä¹‰äº†å¤šç§åè®®ã€‚ä¾‹å¦‚ç”¨äºæ•°æ®ä¼ è¾“çš„äº’è”ç½‘åè®®ã€ç”¨äºç½‘ç»œé—®é¢˜å¤„ç†çš„ ICMP åè®®ã€ç”¨äºåœ°å€è§£æçš„ ARP ç­‰ã€‚åœ¨æœåŠ¡å™¨-å®¢æˆ·ç«¯é€šä¿¡ä¸­ï¼Œè¿›ç¨‹ä¹‹é—´çš„é€šä¿¡éœ€è¦äº’è”ç½‘åè®®(IPv4 æˆ– IPv6)ã€‚

> IPv4 çš„ AF_INET æˆ– IPv6 çš„ AF_INET å¯ç”¨äºåŸŸ

**ç±»å‹**:æ’åº§ç±»å‹ã€‚å®ƒä¸ºå¥—æ¥å­—æŒ‡å®šäº†é€šä¿¡çš„è¯­ä¹‰ã€‚ä¾‹å¦‚ï¼Œå®ƒå¯ä»¥æ˜¯é¡ºåºå­—èŠ‚æµ(å¯¹äº TCP å¥—æ¥å­—)ã€æ•°æ®æŠ¥(å¯¹äº UDP å¥—æ¥å­—)ç­‰ã€‚

> SOCK_STREAM ç”¨äºåˆ›å»º TCP å¥—æ¥å­—ï¼ŒSOCK_DGRAM ç”¨äºåˆ›å»º UDP å¥—æ¥å­—ã€‚

**åè®®**:ä»é€‰æ‹©çš„åè®®æ—ä¸­æŒ‡å®šä¸€ä¸ªç‰¹å®šçš„åè®®ã€‚

> å¦‚æœé€šè¿‡ 0ï¼Œåˆ™é‡‡ç”¨é»˜è®¤åè®®ï¼Œå¦åˆ™é€šè¿‡è¯¥åè®®çš„é¢„å®šä¹‰çš„[å·](https://www.iana.org/assignments/protocol-numbers/protocol-numbers.xhtml)ã€‚

```
int  sockfd;
if ((sockfd = socket(AF_INET, SOCK_STREAM, 0)) < 0)
{
   printf("Cannot create socket\n");
   exit(0);
}
```

socket()å‡½æ•°è¿”å›ä¸€ä¸ª[æ–‡ä»¶æè¿°ç¬¦](https://www.computerhope.com/jargon/f/file-descriptor.htm)ï¼Œå®ƒæŒ‡å‘åˆ›å»ºçš„å¥—æ¥å­—ã€‚

# æŒ‡å®šæœåŠ¡å™¨å±æ€§

åœ¨åˆ›å»ºå¥—æ¥å­—ä¹‹åï¼Œéœ€è¦æŒ‡å®šæœåŠ¡å™¨çš„å‡ ä¸ªå±æ€§ï¼Œæ¯”å¦‚æœåŠ¡å™¨å°†è¢«æ‰˜ç®¡çš„åœ°å€ã€æœåŠ¡å™¨å°†æä¾›æœåŠ¡çš„ç«¯å£å·ç­‰ã€‚

ä¸ºæ­¤ï¼Œä½¿ç”¨äº†é¢„å®šä¹‰çš„ç»“æ„ **sockaddr_in** ã€‚ä¼ é€’åœ°å€æœ‰ä¸¤ç§æ–¹å¼ï¼Œè¦ä¹ˆä¼ é€’ç‰¹å®šåœ°å€(32 ä½ IP åœ°å€)ï¼Œè¦ä¹ˆè®© OS è‡ªå·±å†³å®šåœ°å€( **INADDR_ANY** )ã€‚

> å½“æœºå™¨çš„ IP åœ°å€æœªçŸ¥æ—¶ï¼Œä½¿ç”¨ç‰¹æ®Š IP åœ°å€ INADDR_ANYã€‚

```
struct sockaddr_in serv_addr;
serv_addr.sin_family = AF_INET; // Protocol family
serv_addr.sin_addr.s_addr = INADDR_ANY;
serv_addr.sin_port = 6000; // 16-bit number
```

# ç»‘å®šæ’åº§

å¥—æ¥å­—å‡†å¤‡å¥½äº†ï¼ŒæœåŠ¡å™¨å±æ€§ä¹Ÿå®šä¹‰å¥½äº†ã€‚ç°åœ¨æ˜¯æ—¶å€™æ†ç»‘ä»–ä»¬äº†ã€‚
ä¸ºæ­¤ï¼Œä½¿ç”¨äº† **bind()** å‡½æ•°ï¼Œè¯¥å‡½æ•°å°†å¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦(*ç”± socket()* è¿”å›)ã€æœåŠ¡å™¨å±æ€§ç»“æ„å’Œè¯¥ç»“æ„çš„å¤§å°ä½œä¸ºå‚æ•°ã€‚

```
if (bind(sockfd, (struct sockaddr *)&serv_addr, sizeof(serv_addr)) < 0)
{
    printf("Unable to bind local address\n");
    exit(0);
}
```

# å€¾å¬å®¢æˆ·çš„å¿ƒå£°

æœåŠ¡å™¨å‡ ä¹å‡†å¤‡å¥½ç›‘å¬å®¢æˆ·æœºè¯·æ±‚äº†ã€‚

å¯¹äº TCP å¥—æ¥å­—ï¼Œ **listen()** å‡½æ•°å‘Šè¯‰å¼€å§‹æ¥å—æ¥è‡ªå®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚ã€‚å®ƒéœ€è¦ä¸¤ä¸ªå‚æ•°ï¼Œsocket FD å’Œåœ¨è¿›ä¸€æ­¥çš„ä»£ç ä¸­æ¥å—ä»»ä½•è¯·æ±‚ä¹‹å‰å¯ä»¥è€ƒè™‘çš„è¿æ¥æ•°ã€‚

> å®ƒåŸºæœ¬ä¸Šæ˜¯ TCP å·²ç»æ¥å—ä½†åœ¨åº”ç”¨ç¨‹åºä¸­å°šæœªæ¥å—çš„è¿æ¥ã€‚

```
listen(sockfd,5);
```

ç°åœ¨ï¼ŒæœåŠ¡å™¨å·²ç»å‡†å¤‡å¥½æ¥å—å®¢æˆ·æœºè¯·æ±‚ã€‚

![](img/535640dbc8e278cad9d6dabfb1c90d05.png)

èµ„æ–™æ¥æº:tenor.com

# æ¥å—è¿æ¥è¯·æ±‚

ç³»ç»Ÿè°ƒç”¨ **accept()** æ¥å—å®¢æˆ·ç«¯è¿æ¥ã€‚å®ƒé˜»å¡æœåŠ¡å™¨ï¼Œç›´åˆ°å®¢æˆ·ç«¯è¯·æ±‚åˆ°æ¥ã€‚accept()ç³»ç»Ÿè°ƒç”¨åœ¨ä½œä¸ºå‚æ•°ä¼ é€’çš„ç±»å‹ä¸º **sockaddr_in** çš„ç»“æ„ä¸­å¡«å……å®¢æˆ·ç«¯çš„è¯¦ç»†ä¿¡æ¯ã€‚è¯¥ç»“æ„çš„é•¿åº¦è®°å½•åœ¨**æ–œé¢**ä¸­ã€‚

å®ƒè¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œè¯¥æè¿°ç¬¦å°†ç”¨äºä¸å®¢æˆ·æœºçš„è¿›ä¸€æ­¥é€šä¿¡ã€‚

```
clilen = sizeof(cli_addr);
newsockfd = accept(sockfd, (struct sockaddr *)&cli_addr, &clilen);
if (newsockfd < 0)
{
  printf("Accept error\n");
  exit(0);
}
```

ä¸€æ—¦è¯·æ±‚è¢«æ¥å—ï¼Œå°±ä¼šæ´¾ç”Ÿå‡ºä¸€ä¸ªå­è¿›ç¨‹æ¥å¤„ç†è¿™ä¸ªè¯·æ±‚ã€‚å¦‚æœæˆ‘ä»¬ä¸æ´¾ç”Ÿä¸€ä¸ªè¿›ç¨‹æ¥å¤„ç†è¿™ä¸ªè¯·æ±‚ï¼Œé‚£ä¹ˆæœåŠ¡å™¨ä¼šä¸€ç›´å¿™äºä¸€æ¬¡å¤„ç†ä¸€ä¸ªè¯·æ±‚ï¼Œå¹¶ä¸”ä¸ä¼šæ¥å—å…¶ä»–è¯·æ±‚ï¼Œç›´åˆ°è¿™ä¸ªè¯·æ±‚å®Œæˆã€‚

```
if (fork() == 0)
{
  close(sockfd);
  /* Close the old socket FD, since all communications for this request
  will be through the new socket FD. */
  ...
}
```

# å‘é€å’Œæ¥æ”¶æ•°æ®

æ‰€æœ‰è¿™äº›ä¸œè¥¿çš„ä¸»è¦ç›®çš„æ˜¯åœ¨æœåŠ¡å™¨å’Œå®¢æˆ·æœºä¹‹é—´ä¼ è¾“æ•°æ®ã€‚è¿™å¯ä»¥å€ŸåŠ© **send()** å’Œ **recv()** åŠŸèƒ½æ¥å®Œæˆã€‚

**send()** :å°†æ•°æ®å‘é€ç»™å…¶ä»–è¿›ç¨‹(å³å®¢æˆ·ç«¯)ã€‚
å®ƒå°†è¿›è¡Œé€šä¿¡çš„å¥—æ¥å­— FDã€è¦ä¼ è¾“çš„æ•°æ®ã€æ•°æ®çš„æœ€å¤§å¤§å°å’Œä¸€ä¸ªæ ‡å¿—ä½œä¸ºå‚æ•°ã€‚

**recv()** :æ¥æ”¶æ¥è‡ªå…¶ä»–è¿›ç¨‹(å³æ¥è‡ªå®¢æˆ·ç«¯)çš„æ•°æ®
å®ƒä¹Ÿé‡‡ç”¨æ­£åœ¨è¿›è¡Œé€šä¿¡çš„å¥—æ¥å­— FDã€å­˜å‚¨ä¼ å…¥æ•°æ®çš„æŒ‡é’ˆã€è¦æ¥æ”¶çš„æ•°æ®çš„æœ€å¤§å¤§å°ä»¥åŠä¸€ä¸ªæ ‡å¿—ä½œä¸ºå‚æ•°ã€‚

*ä¾‹å¦‚ï¼Œåœ¨è¿æ¥è¯·æ±‚è¢«æ¥å—åï¼Œä¸€ä¸ªç®€å•çš„å­—ç¬¦ä¸²è¢«å‘é€åˆ°å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯ä¹Ÿå‘é€ä¸€ä¸ªå°†è¢«æœåŠ¡å™¨æ¥æ”¶çš„å­—ç¬¦ä¸²ã€‚*

```
if (fork() == 0)
{
  close(sockfd);
  /* Close the old socket since all communications
  will be through the new socket. */

  // sending data
  for (i = 0; i < 100; i++)
    buf[i] = '\0';
  strcpy(buf, "Message from server");
  send(newsockfd, buf, 100, 0);

  // receivinng data
  for (i = 0; i < 100; i++)
    buf[i] = '\0';
  recv(newsockfd, buf, 100, 0);
  printf("%s\n", buf);
  close(newsockfd);
  exit(0);
}
close(newsockfd);
```

> æ­¤å¤–ï¼Œæˆ‘ä»¬éœ€è¦å…³é—­çˆ¶æœåŠ¡å™¨è¿›ç¨‹ä¸­æ–°åˆ›å»ºçš„å¥—æ¥å­—ï¼Œä»¥ä¾¿å…¶ä»–è¯·æ±‚å¯ä»¥ä½¿ç”¨å®ƒã€‚

æœåŠ¡å™¨åŸºæœ¬ä¸Šæ˜¯ä¸é—´æ–­è¿è¡Œçš„ç¨‹åºã€‚å› æ­¤ï¼Œä¸ºäº†å®ç°è¿™ä¸€ç‰¹æ€§ï¼Œç¤ºä¾‹ä¸­å°†ä½¿ç”¨ä¸€ä¸ªæ— é™å¾ªç¯ã€‚

# æœ€ç»ˆä»£ç 

```
int sockfd, newsockfd; /* Socket descriptors */
int clilen;
struct sockaddr_in cli_addr, serv_addr;
int i;
char buf[100];
if ((sockfd = socket(AF_INET, SOCK_STREAM, 0)) < 0)
{
    printf("Cannot create socket\n");
    exit(0);
}
struct sockaddr_in serv_addr;
serv_addr.sin_family = AF_INET; // Protocol family
serv_addr.sin_addr.s_addr = INADDR_ANY;
serv_addr.sin_port = 6000; // 16-bit number
if (bind(sockfd, (struct sockaddr *)&serv_addr, sizeof(serv_addr)) < 0)
{
    printf("Unable to bind local address\n");
    exit(0);
}
listen(sockfd, 5);

while (1)
{
    clilen = sizeof(cli_addr);
    newsockfd = accept(sockfd, (struct sockaddr *)&cli_addr, &clilen);
    if (newsockfd < 0)
    {
        printf("Accept error\n");
        exit(0);
    }

    if (fork() == 0)
    {
        close(sockfd);
        /* Close the old socket since all communications
        will be through the new socket. */

        // sending data
        for (i = 0; i < 100; i++)
            buf[i] = '\0';
        strcpy(buf, "Message from server");
        send(newsockfd, buf, 100, 0);

        // receving data
        for (i = 0; i < 100; i++)
            buf[i] = '\0';
        recv(newsockfd, buf, 100, 0);
        printf("%s\n", buf);
        close(newsockfd);
        exit(0);
    }
    close(newsockfd);
}
```

ä¸‡å²ï¼ï¼æœåŠ¡å™¨å·²å‡†å¤‡å¥½è¿›è¡Œéƒ¨ç½²ã€‚ç¼–è¯‘å¹¶è¿è¡Œä»£ç ï¼ŒæŸ¥çœ‹æ‚¨çš„æœåŠ¡å™¨åœ¨æŒ‡å®šçš„ç«¯å£ä¸Šè¿è¡Œã€‚

åœ¨æœ¬ç³»åˆ—çš„ä¸‹ä¸€ä¸ª[éƒ¨åˆ†](https://yashpaneliya.medium.com/socket-programming-in-c-client-4408231f9e65)ä¸­ï¼Œæˆ‘å°†æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨å¥—æ¥å­—åˆ›å»ºå®¢æˆ·æœºï¼Œä»¥åŠå¦‚ä½•å¤„ç†æ¥è‡ªæµè§ˆå™¨çš„è¯·æ±‚ï¼Œè¿™å°†ä½¿æˆ‘ä»¬æ›´å¥½åœ°ç†è§£æ•´ä¸ªæœåŠ¡å™¨-å®¢æˆ·æœºé€šä¿¡ã€‚

å¦‚æœä½ åœ¨æœ¬åšå®¢ä¸­å‘ç°ä»»ä½•é—®é¢˜æˆ–é”™è¯¯ä¿¡æ¯ï¼Œè¯·å‘è¡¨è¯„è®ºã€‚è¿™å°†æœ‰åŠ©äºæˆ‘å’Œè®¸å¤šå…¶ä»–å­¦ä¹ è€…ç†è§£è¿™ä¸ªæ¦‚å¿µã€‚

å¦‚æœä½ è§‰å¾—è¿™ä¸ªåšå®¢æœ‰å¸®åŠ©ï¼Œè¯·è¡¨ç¤ºæ„Ÿè°¢ğŸ˜„å¹¶ä¸ä½ çš„åŒäº‹åˆ†äº«ã€‚

æ›´äº†è§£æˆ‘:ã€https://linktr.ee/yashpaneliyaã€‘T2