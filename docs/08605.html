<html>
<head>
<title>Automating your R -E.T.L workflow: scenario 1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">自动化您的 R -E.T.L 工作流程:场景 1</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/automating-your-r-e-t-l-workflow-scenario-1-6c5cfc788878?source=collection_archive---------5-----------------------#2022-06-27">https://blog.devgenius.io/automating-your-r-e-t-l-workflow-scenario-1-6c5cfc788878?source=collection_archive---------5-----------------------#2022-06-27</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/05ced32d42f8b9f25c2532b4591fedc9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uHcbKFJOkPIP-pZDG8Flzw.jpeg"/></div></div></figure><p id="cff5" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">你的 ETL 管道看起来有不同的方式，这很大程度上取决于你如何访问你的数据，处理它和使用它。在本文中，我将处理一个场景，从 googlesheet 中获取数据，在 rmarkdown 脚本中处理，并在闪亮的仪表板上使用。</p><p id="bbe1" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在这种情况下，数据预处理脚本和闪亮的应用程序脚本都可以访问数据文件夹。因此，markdown 脚本对数据进行预处理，并将整齐的数据输出到数据文件夹中，另一端闪亮的应用程序接收整齐的数据。</p><p id="7440" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我一直在研究这些数据，并撰写了相关文章。这是一项正在进行的薪资调查，数据被收集到谷歌工作表中，提交是自发完成的。考虑一下我之前关于数据的文章。<br/>在讨论数据和开发用于分析的仪表板后，我想到了一种用最新提交的数据更新仪表板的方法，而不必手动运行 rmarkdown 脚本。</p><h2 id="1f79" class="kt ku in bd kv kw kx dn ky kz la dp lb kg lc ld le kk lf lg lh ko li lj lk ll bi translated">输入 cron 作业！</h2><p id="6156" class="pw-post-body-paragraph jv jw in jx b jy lm ka kb kc ln ke kf kg lo ki kj kk lp km kn ko lq kq kr ks ig bi translated">cron 作业是一个 unix(linux/mac)系统实用程序，可用于自动执行重复性作业。我假设你对此有想法，如果没有，我想你可能需要考虑从<a class="ae lr" href="https://linuxhandbook.com/crontab/" rel="noopener ugc nofollow" target="_blank">这篇</a>文章中学习一些基础知识。</p><p id="edb9" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io"> <em class="ls">注意:这在 linux/mac 设置下有效，为 windows 考虑任务调度器。</em> </strong></p><p id="dcb7" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">鉴于数据提交是自发完成的，我们可以设置一个 cron 作业，根据您的用例每小时、每天、每周、每月等运行 rmarkdown 脚本。<br/>使用情形因环境而异，例如，我们可能会遇到数据以分钟/秒、每天甚至每月的速度流入的情况。因此，您将编写一个 cron 作业，根据数据提交的频率更新您的数据。</p><p id="3ac0" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io"> <em class="ls">注意:有 R 个包用于调度 cron 作业</em></strong><a class="ae lr" href="https://github.com/bnosac/cronR" rel="noopener ugc nofollow" target="_blank"><strong class="jx io"><em class="ls">cronR</em></strong></a><strong class="jx io"><em class="ls">对于 Unix 和</em></strong><a class="ae lr" href="https://github.com/bnosac/taskscheduleR" rel="noopener ugc nofollow" target="_blank"><strong class="jx io"><em class="ls">task scheduler</em></strong></a><strong class="jx io"><em class="ls">对于 windows，如果你希望它简单的话:)也就是说，至于我，我选择做脚本。</em> </strong></p><h2 id="b905" class="kt ku in bd kv kw kx dn ky kz la dp lb kg lc ld le kk lf lg lh ko li lj lk ll bi translated">调度 Cron 作业</h2><p id="2746" class="pw-post-body-paragraph jv jw in jx b jy lm ka kb kc ln ke kf kg lo ki kj kk lp km kn ko lq kq kr ks ig bi translated">运行以下命令打开一个 crontab</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="adde" class="kt ku in ly b gy mc md l me mf">$ crontab -e</span></pre><p id="820e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">将会打开一个脚本，然后在脚本中输入下面一行并保存。</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="fc93" class="kt ku in ly b gy mc md l me mf">* * * * * Rscript -e "rmarkdown::render('~/path/to/your/script.Rmd')"</span></pre><p id="2106" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="ls">注意:一定要记得相应地编辑 rmarkdown 脚本的路径。</em></p><p id="b871" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">上面的 cron 作业将每分钟运行一次，您可以对其进行编辑，以便按照您希望脚本执行的方式运行。</p><h2 id="fff8" class="kt ku in bd kv kw kx dn ky kz la dp lb kg lc ld le kk lf lg lh ko li lj lk ll bi translated">从 googlesheets4 访问数据</h2><p id="c69d" class="pw-post-body-paragraph jv jw in jx b jy lm ka kb kc ln ke kf kg lo ki kj kk lp km kn ko lq kq kr ks ig bi translated">使用<a class="ae lr" href="https://github.com/tidyverse/googlesheets4" rel="noopener ugc nofollow" target="_blank"> googlesheets4 </a>包，我们可以使用 url 从 googlesheets 获取数据。<br/>您将需要使用 gs4_deauth()函数停用认证，这样我们就不会在每次脚本获取数据时被提示输入访问令牌。<br/>请记住，我们的目的是自动化整个数据导入流程，从争论到可视化/存储，因此无需认证。</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="746f" class="kt ku in ly b gy mc md l me mf">gs4_deauth() # this deactivates authentication. We won't be prompted to login using credentials.</span><span id="3e7c" class="kt ku in ly b gy mg md l me mf">salary_data &lt;- read_sheet("<a class="ae lr" href="https://docs.google.com/spreadsheets/d/1IPS5dBSGtwYVbjsfbaMCYIWnOuRmJcbequohNxCyGVw/edit?resourcekey#gid=1625408792" rel="noopener ugc nofollow" target="_blank">https://docs.google.com/spreadsheets/d/1IPS5dBSGtwYVbjsfbaMCYIWnOuRmJcbequohNxCyGVw/edit?resourcekey#gid=1625408792</a>")<br/>salary_data &lt;- data.table::setDT(salary_data)</span></pre><h2 id="dff0" class="kt ku in bd kv kw kx dn ky kz la dp lb kg lc ld le kk lf lg lh ko li lj lk ll bi translated">数据争论</h2><p id="a0c0" class="pw-post-body-paragraph jv jw in jx b jy lm ka kb kc ln ke kf kg lo ki kj kk lp km kn ko lq kq kr ks ig bi translated">此时，我们已经有了 R 中的数据，现在我们可以根据需要对其进行讨论。<br/>这个库在这个时候会派上用场。有了它，我们可以根据需要访问用于清理和转换数据的功能，这样我们就可以有一个整洁的数据作为输出，例如可以导入到一个闪亮的应用程序中或用于建模。<br/>数据清洗。回购协议上的 Rmd 文件有所有的清理和转换步骤。</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="d5f3" class="kt ku in ly b gy mc md l me mf"># change the columns name - observe the naming syntax for headers/columns<br/> names(salary_data) &lt;- c("Timestamp","age","industry","job_title","job_title_context","annual_salary",<br/>                         "Other_monetary_comp","currency","currency_other",<br/>                         "income_context","country","state","city","professional_experience_years","field_experience_years",<br/>                         "highest_edu_level","gender","race")<br/>                         <br/>                         <br/># College degree and Some college kinda means the same. Let us just categorize them into one (College degree). <br/>salary_data$highest_edu_level &lt;- gsub("Some college","College degree",salary_data$highest_edu_level)</span><span id="42ea" class="kt ku in ly b gy mg md l me mf"># replace the variants of United states with one name.  <br/>salary_data$country &lt;- stri_replace_all_regex(salary_data$country,<br/>                                  pattern=c('US', 'USA', 'usa',"U.S.","us","Usa","United States of America","united states",<br/>                                            "U.S&gt;","U.S.A","U.S.A.","united states of america","Us","The United States",<br/>                                            "United State of America","United Stated","u.s.","UNITED STATES","united States","USA-- Virgin Islands",<br/>                                            "United Statws","U.S","Unites States","U. S.","United Sates","United States of American","Uniited States",<br/>                                            "Worldwide (based in US but short term trips aroudn the world)","United Sates of America",<br/>                                            "Unted States","United Statesp","United Stattes","United Statea","United Statees","UNited States","Uniyed states",<br/>                                            "Uniyes States","United States of Americas","US of A","United States of america","U.SA","United Status","U.s.",<br/>                                            "U.s.a.","USS","Uniteed States","United Stares","Unites states","Unite States","The US","United states of America",<br/>                                            "For the United States government, but posted overseas","UnitedStates","United statew","United Statues",<br/>                                            "Untied States","USA (company is based in a US territory, I work remote)","Unitied States","Unitied States",<br/>                                            "USAB","United Sttes","united stated","United States Of America","Uniter Statez","U. S","USA tomorrow",<br/>                                            "United Stateds","US govt employee overseas, country withheld","Unitef Stated","United STates","USaa",<br/>                                            "uSA","america","United y","uS","USD","United Statss","UsA","United  States","United States is America",<br/>                                            "United states of United States","United StatesD","United States- Puerto Rico","United Statesaa","United Statest",<br/>                                            "United States govt employee overseas, country withheld","United StatesA tomorrow","United StatesAB",<br/>                                            "United StatesA (company is based in a United States territory, I work remote)","United StatesS",<br/>                                            "United Statesa.","RUnited Statessia","United States of A","United StatesA-- Virgin Islands","United StatesA.",<br/>                                            "United State","United states","United StatesA","United Statess","United StatessA","United States",<br/>                                            "United Statessmerica","United StatUnited Statess","Canada and United StatessA","United States"),<br/>                                  replacement="United States",<br/>                                  vectorize=FALSE)<br/>                                  <br/>                                  <br/># use gsub to remove the A from states. <br/>salary_data$country &lt;- gsub("United StatesA","United States",salary_data$country)</span><span id="b0cd" class="kt ku in ly b gy mg md l me mf"># do the grouping and count the records by the country column <br/>percentage.count &lt;- salary_data[,.(totalcount=.N,country)][,.(count=.N,totalcount,country),by=.(country)][,.(percentage=round(count/totalcount*100)),by=.(count,country)] %&gt;% unique()</span><span id="c56f" class="kt ku in ly b gy mg md l me mf">salary_data_US &lt;- salary_data[country %like% "United States",]</span><span id="9557" class="kt ku in ly b gy mg md l me mf"># for column currency replace other with USD where currency_other == USD<br/># data.table approach to replacing values in a column based on a condition in another column.</span><span id="26bf" class="kt ku in ly b gy mg md l me mf">salary_data_US &lt;- salary_data_US[currency_other %in% c("USD","American Dollars","US Dollar"), currency := "USD"]</span><span id="88e4" class="kt ku in ly b gy mg md l me mf"># There are alternative approaches to this, like using case_when with mutate or if_else with mutate. <br/># You could explore such options just to have the knowledge of the alternatives.</span><span id="a97f" class="kt ku in ly b gy mg md l me mf">salary_data_US &lt;- salary_data_US[currency == "USD",]</span><span id="0c28" class="kt ku in ly b gy mg md l me mf"># if you wanna check if the currency is USD only you could do uncomment and run the following lines of code.  <br/>#unique(salary_data_US$currency)</span><span id="cb94" class="kt ku in ly b gy mg md l me mf"># convert annual_salary to numerical data type. <br/>salary_data_US$annual_salary &lt;- gsub(",","",salary_data_US$annual_salary)<br/>salary_data_US$annual_salary &lt;- as.numeric(salary_data_US$annual_salary)</span><span id="e828" class="kt ku in ly b gy mg md l me mf"># we have some values which are null. we drop them  <br/>salary_data_US &lt;- salary_data_US[ highest_edu_level !="",]</span><span id="b0c1" class="kt ku in ly b gy mg md l me mf"># remove the NA<br/>salary_data_US &lt;- salary_data_US[!is.na(annual_salary),]</span><span id="5a7e" class="kt ku in ly b gy mg md l me mf"># for the gender variable, let us only pick the male and female groupings <br/>salary_data_US &lt;- salary_data_US[gender %in% c("Man","Woman")]<br/>salary_data_US$gender &lt;- as.factor(salary_data_US$gender)</span><span id="a817" class="kt ku in ly b gy mg md l me mf"># subset the dataset <br/>salary_data_US &lt;- salary_data_US[,c("age","annual_salary","professional_experience_years","highest_edu_level","gender","industry","job_title")]</span></pre><h2 id="88de" class="kt ku in bd kv kw kx dn ky kz la dp lb kg lc ld le kk lf lg lh ko li lj lk ll bi translated">数据存储/版本控制</h2><p id="6021" class="pw-post-body-paragraph jv jw in jx b jy lm ka kb kc ln ke kf kg lo ki kj kk lp km kn ko lq kq kr ks ig bi translated">一旦我们有了整齐的数据格式，我们就可以使用<a class="ae lr" href="https://pins.rstudio.com/" rel="noopener ugc nofollow" target="_blank">引脚</a>包来存储和版本化它。<br/>您可能想知道我们为什么要对数据进行版本控制，想象一下这样一个场景，您想要回滚到数据的某个状态，那么 pins 包将是您的首选，因为有了它，您可以对数据进行版本控制，因此您可以根据情况选择获取特定的版本。但是默认情况下，最新的版本是获取的版本。</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="58af" class="kt ku in ly b gy mc md l me mf"># create a board<br/>board &lt;- board_folder("./data",versioned = TRUE)</span><span id="8e73" class="kt ku in ly b gy mg md l me mf">board %&gt;% pin_write(salary_data_US,"salary_cleaned", type="csv")</span></pre><h2 id="6d0c" class="kt ku in bd kv kw kx dn ky kz la dp lb kg lc ld le kk lf lg lh ko li lj lk ll bi translated">使用数据</h2><p id="ef66" class="pw-post-body-paragraph jv jw in jx b jy lm ka kb kc ln ke kf kg lo ki kj kk lp km kn ko lq kq kr ks ig bi translated">干净的数据可以通过闪亮的仪表板获取，存储在数据库中以备将来使用，甚至进一步用于建模。<br/>对于这种情况，我们有一个访问数据的仪表板。</p><figure class="lt lu lv lw gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mh"><img src="../Images/21512b67272c5c8468837679dd422af9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kx7Ix7W2A3MMka5rQ8-mYA.png"/></div></div><figcaption class="mi mj gj gh gi mk ml bd b be z dk translated">薪金分析仪表板</figcaption></figure><p id="7271" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如果您想体验一下工作流程，可以点击<a class="ae lr" href="https://github.com/oyogo/ETL_pipeline" rel="noopener ugc nofollow" target="_blank">此处</a>访问回购。</p><h2 id="854f" class="kt ku in bd kv kw kx dn ky kz la dp lb kg lc ld le kk lf lg lh ko li lj lk ll bi translated">下一篇！</h2><p id="2827" class="pw-post-body-paragraph jv jw in jx b jy lm ka kb kc ln ke kf kg lo ki kj kk lp km kn ko lq kq kr ks ig bi translated">我正在处理 R — ETL 管道的场景 2，在这个场景中，我们有一个数据提交平台(R Shiny app ),当数据提交到服务器时，它触发一个 bash 脚本，该脚本反过来运行管道，然后分析仪表板使用 tidy 数据。</p><p id="857c" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">参考资料:</p><ol class=""><li id="7d4e" class="mm mn in jx b jy jz kc kd kg mo kk mp ko mq ks mr ms mt mu bi translated"><a class="ae lr" href="https://www.rstudio.com/blog/automated-survey-reporting/" rel="noopener ugc nofollow" target="_blank">自动调查报告</a></li></ol></div></div>    
</body>
</html>