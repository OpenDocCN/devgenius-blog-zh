<html>
<head>
<title>Breaking down the Kube-API server in Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在 Kubernetes 中分解 Kube-API 服务器</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/breaking-down-the-kube-api-server-in-kubernetes-fe66ec62c7ee?source=collection_archive---------13-----------------------#2020-07-14">https://blog.devgenius.io/breaking-down-the-kube-api-server-in-kubernetes-fe66ec62c7ee?source=collection_archive---------13-----------------------#2020-07-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="c306" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">读完这篇文章后，你会有:</p><ul class=""><li id="214f" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated">了解 kube-API 服务器的职责。</li></ul><p id="65d9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你想从这篇文章中得到最大的收获，我强烈推荐我的文章，这篇文章简要概述了 kubernetes 架构。<a class="ae ku" href="https://medium.com/dev-genius/the-kubernetes-cluster-architecture-simplified-3c4a5fb41449" rel="noopener">链接此处</a></p><p id="fc6f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本系列的前面，我们讨论了 Kube-API 服务器是 kubernetes 中的主要管理组件。</p><p id="e151" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">当您运行一个 ku ectl 命令时，ku ectl 实用程序会到达 kube-API 服务器。</strong></p><h1 id="ffbd" class="kv kw iq bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">在后台</h1><p id="9d93" class="pw-post-body-paragraph jn jo iq jp b jq lt js jt ju lu jw jx jy lv ka kb kc lw ke kf kg lx ki kj kk ij bi translated">kube-API 服务器首先对请求进行认证和验证。之后，它继续从 ETCD 集群中检索数据，并使用请求的信息进行响应。</p><figure class="lz ma mb mc gt md gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi ly"><img src="../Images/93747233e6e964778644372e4bba6cbe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GAWNOryp0fP5sEGHLWLq7A.jpeg"/></div></div></figure><p id="8be7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用 kubectl 命令行访问 kube-API 并不是强制性的。相反，您也可以通过发送 POST 请求直接与 API 通信。但是，这不如使用 CLI 常见。</p></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><h1 id="fc1c" class="kv kw iq bd kx ky mr la lb lc ms le lf lg mt li lj lk mu lm ln lo mv lq lr ls bi translated">常见的场景</h1><p id="03b9" class="pw-post-body-paragraph jn jo iq jp b jq lt js jt ju lu jw jx jy lv ka kb kc lw ke kf kg lx ki kj kk ij bi translated">让我们看一个创建 pod 的例子。和以前一样，首先对请求进行身份验证，然后进行验证。</p><p id="17f8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这种情况下，kube-API 服务器做几件事情:</p><ol class=""><li id="4697" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk mw kr ks kt bi translated">它创建一个 POD 对象，而不将其指定给节点。</li><li id="477b" class="kl km iq jp b jq mx ju my jy mz kc na kg nb kk mw kr ks kt bi translated">更新 ETCD 服务器中的信息。</li><li id="bc80" class="kl km iq jp b jq mx ju my jy mz kc na kg nb kk mw kr ks kt bi translated">通知用户 POD 已创建。</li></ol><p id="4c9b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此后，调度程序持续监视 API 服务器，并意识到存在没有分配节点的新 pod。调度器识别放置新 POD 的正确节点，并将其传送回 kube-API 服务器。</p><figure class="lz ma mb mc gt md gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/b54ad4944c6c8b2db05cc10ad29b9e1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1136/format:webp/1*3RrWQd_loJOmtWAYAYhT9Q.jpeg"/></div></figure><p id="a14e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">API 服务器继续更新 ETCD 集群中的信息。然后，API 服务器将该信息传递给适当的 worker 节点中的 kubelet。</p><p id="b908" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">kubelet 然后在节点上创建 POD，并指示容器运行时引擎部署应用程序映像。</p><p id="7acf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">完成后，kubelet 将状态更新回 API 服务器，然后 API 服务器将数据更新回 ETCD 集群。</p><figure class="lz ma mb mc gt md gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi nd"><img src="../Images/5ed3387b422d304390881b7ad37fea2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T44PHE3sSMaSo9nQEpLNww.jpeg"/></div></div></figure><p id="9b78" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">每次请求更改时，都会遵循类似的模式。</p><p id="1aef" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">kube-API 服务器是在集群中做出改变所需执行的所有不同任务的中心。</strong></p></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><h1 id="16c8" class="kv kw iq bd kx ky mr la lb lc ms le lf lg mt li lj lk mu lm ln lo mv lq lr ls bi translated">摘要</h1><p id="e969" class="pw-post-body-paragraph jn jo iq jp b jq lt js jt ju lu jw jx jy lv ka kb kc lw ke kf kg lx ki kj kk ij bi translated">总而言之，kube-API 服务器负责认证和验证请求，检索和更新 ETCD 数据存储中的数据。事实上，kube-API 服务器是唯一与 ETCD 数据存储直接交互的组件。</p><p id="cc0c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以下是在集群中创建 POD 时 kube-API 服务器采取的步骤:</p><ol class=""><li id="4f85" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk mw kr ks kt bi translated">验证用户</li><li id="bb9b" class="kl km iq jp b jq mx ju my jy mz kc na kg nb kk mw kr ks kt bi translated">验证请求</li><li id="ba6d" class="kl km iq jp b jq mx ju my jy mz kc na kg nb kk mw kr ks kt bi translated">检索数据</li><li id="2aa9" class="kl km iq jp b jq mx ju my jy mz kc na kg nb kk mw kr ks kt bi translated">更新 ETCD</li><li id="309f" class="kl km iq jp b jq mx ju my jy mz kc na kg nb kk mw kr ks kt bi translated">调度程序</li><li id="67ea" class="kl km iq jp b jq mx ju my jy mz kc na kg nb kk mw kr ks kt bi translated">库伯莱</li></ol><p id="e4eb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">其他组件，比如调度器、kube-controller-manager 和 kubelet，使用 API 服务器在集群中各自的区域执行更新。</p><p id="8cd2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这个系列中，我们将会看到如何安装和配置 kubernetes 架构的这些组件。</p><p id="5aa0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，有一个高层次的理解将使我们以后从头开始配置整个集群及其所有组件变得更加容易。</p><p id="2d35" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">kubernetes 架构由许多不同的组件组成，这些组件以许多不同的方式相互协作，因此它们都需要知道其他组件在哪里。</p></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><h1 id="a32b" class="kv kw iq bd kx ky mr la lb lc ms le lf lg mt li lj lk mu lm ln lo mv lq lr ls bi translated">证明</h1><p id="c726" class="pw-post-body-paragraph jn jo iq jp b jq lt js jt ju lu jw jx jy lv ka kb kc lw ke kf kg lx ki kj kk ij bi translated">认证、授权、加密和安全有不同的模式。这就是为什么你有这么多的选择。</p><p id="f46e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们来看几个重要的。</p><p id="8c51" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">其中许多是用于保护不同组件之间连接的证书。</p><p id="f179" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本系列后面的 SSL/TLS 证书一节中，我们将更详细地研究这些证书。所以我们暂时不会关注它们。</p><p id="8194" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是请记住，我们将在本节中看到的所有组件都有相关的证书。</p></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><h1 id="cfe0" class="kv kw iq bd kx ky mr la lb lc ms le lf lg mt li lj lk mu lm ln lo mv lq lr ls bi translated">那么，如何看待现有集群中的 kube-api 服务器选项呢？</h1><p id="dfd5" class="pw-post-body-paragraph jn jo iq jp b jq lt js jt ju lu jw jx jy lv ka kb kc lw ke kf kg lx ki kj kk ij bi translated">这取决于您如何设置集群。</p><p id="116c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">如果使用 kubeadm 工具</strong>进行设置，kubeadm 会将 kube-API 服务器作为一个 pod 部署在主节点上的 kube- system 名称空间中。</p><p id="7791" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过运行以下命令，可以看到位于 pod 定义文件中的选项:</p><pre class="lz ma mb mc gt ne nf ng nh aw ni bi"><span id="ee31" class="nj kw iq nf b gy nk nl l nm nn">cat /etc/kubernetes/manifests/kube-apiserver.yaml</span></pre><p id="7c1a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在非 kubeadm 设置中:</p><pre class="lz ma mb mc gt ne nf ng nh aw ni bi"><span id="8831" class="nj kw iq nf b gy nk nl l nm nn">cat /etc/systemd/system/kube-apiserver.service</span></pre><p id="c0c3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您还可以通过在主节点上列出流程并搜索 kube-API server 来查看正在运行的流程和有效选项。</p><pre class="lz ma mb mc gt ne nf ng nh aw ni bi"><span id="114a" class="nj kw iq nf b gy nk nl l nm nn">ps -aux | grep kube-apiserver</span></pre></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><p id="6c43" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="no">原载于</em> <a class="ae ku" href="https://static-blog-gamma.vercel.app/posts/kubernetes/core-concepts/kube-api" rel="noopener ugc nofollow" target="_blank"> <em class="no">我的博客</em> </a></p></div></div>    
</body>
</html>