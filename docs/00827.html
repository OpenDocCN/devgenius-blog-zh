<html>
<head>
<title>Solutions Architect Reacts: Introduction and Newsfeed Architecture</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">解决方案架构师反应:简介和新闻提要架构</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/solutions-architect-reacts-introduction-and-newsfeed-architecture-b1fa633efa07?source=collection_archive---------21-----------------------#2020-06-17">https://blog.devgenius.io/solutions-architect-reacts-introduction-and-newsfeed-architecture-b1fa633efa07?source=collection_archive---------21-----------------------#2020-06-17</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/fe0b4bc22b2decf31d813344ffdb4ad0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DUqgKECdqhv1uT9rxb-wDA.png"/></div></div></figure><p id="bb94" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在Toggled，我们有一个优秀的创新思想家团队，他们不仅以快速交付为荣，而且以规模为荣。我们在IT行业20多年的共同经验教会了我们许多经验，告诉我们如何解决客户的问题并设计出能够带来最大价值的解决方案。</p><p id="e654" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这一系列文章将致力于帮助您更快交付的固执己见的参考架构。我们将详述的解决方案是我们在现实生活中遇到的事情，以及我们如何着手解决它们(因此标题为“解决方案架构师的反应”)。我们可能会在某些方面钻研代码，但我们的目标是理解设计概念，而不是底层实现。</p><p id="4bf9" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">所以让我们言归正传。</p></div><div class="ab cl kt ku hr kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="ig ih ii ij ik"><figure class="lb lc ld le gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi la"><img src="../Images/aaa0093fe46334a21ab9159f842aa561.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fix3gymAlm3fhYMP"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">戴维·特拉维斯在<a class="ae lj" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="6309" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">作为一名解决方案架构师，我总是从高层次的愿景开始。我们想达到什么目的？(我们将在另一篇文章中详述我们的<strong class="jx io">切换</strong> <strong class="jx io">框架</strong>用于问题分解)我将以我们最近在<a class="ae lj" href="http://upforthat.co" rel="noopener ugc nofollow" target="_blank"> UpForThat </a>应用中遇到的挑战开始第一篇文章。</p><h1 id="0af5" class="lk ll in bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated"><strong class="ak">视觉</strong></h1><p id="b9a1" class="pw-post-body-paragraph jv jw in jx b jy mi ka kb kc mj ke kf kg mk ki kj kk ml km kn ko mm kq kr ks ig bi translated">一个移动应用程序，根据用户的位置为用户提供最新的本地信息。</p><figure class="lb lc ld le gt jo gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/65c846f959d60e63535596d77a761a37.png" data-original-src="https://miro.medium.com/v2/resize:fit:640/1*cETKeBJ5hs2Qf6ah4O78LA.gif"/></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">我们最新的应用程序upfor that(<a class="ae lj" href="http://upforthat.co" rel="noopener ugc nofollow" target="_blank">upforthat.co</a>)</figcaption></figure><h1 id="92c8" class="lk ll in bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">进一步要求</h1><ul class=""><li id="6eb8" class="mo mp in jx b jy mi kc mj kg mq kk mr ko ms ks mt mu mv mw bi translated">我需要应用程序来拾取和显示与用户当前位置相关的feed项目(如新闻、事件、广告)。</li><li id="12ed" class="mo mp in jx b jy mx kc my kg mz kk na ko nb ks mt mu mv mw bi translated">我有多个信息源，需要汇总到一个“主源”中。</li><li id="7c81" class="mo mp in jx b jy mx kc my kg mz kk na ko nb ks mt mu mv mw bi translated">“Home Feed”需要高性能和快速加载。</li><li id="348a" class="mo mp in jx b jy mx kc my kg mz kk na ko nb ks mt mu mv mw bi translated">即使当手机离线时,“主页订阅源”仍然应该填充有订阅源项目。</li></ul><h1 id="2ddc" class="lk ll in bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">相似的实现</h1><ul class=""><li id="c860" class="mo mp in jx b jy mi kc mj kg mq kk mr ko ms ks mt mu mv mw bi translated">脸书饲料</li><li id="537a" class="mo mp in jx b jy mx kc my kg mz kk na ko nb ks mt mu mv mw bi translated">Instagram Feed</li><li id="ee23" class="mo mp in jx b jy mx kc my kg mz kk na ko nb ks mt mu mv mw bi translated">其他新闻聚合器，如Feedly</li></ul><h1 id="1432" class="lk ll in bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">技术</h1><ul class=""><li id="be2b" class="mo mp in jx b jy mi kc mj kg mq kk mr ko ms ks mt mu mv mw bi translated">反应自然</li><li id="fbca" class="mo mp in jx b jy mx kc my kg mz kk na ko nb ks mt mu mv mw bi translated">火基地(<a class="ae lj" href="https://firebase.google.com/" rel="noopener ugc nofollow" target="_blank">https://firebase.google.com/</a>)</li></ul><p id="d830" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">正如简介中所解释的，技术并不重要。但是，我将详细介绍我们正在利用的特定功能，这可能会指导您自己的实现和技术选择。</p><p id="bcc2" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">对于任何问题，我们首先需要把它分解成小块。我们对这一过程的想法将是另一个切换后框架的主题。</p><h1 id="9386" class="lk ll in bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">单级馈电</h1><p id="38c8" class="pw-post-body-paragraph jv jw in jx b jy mi ka kb kc mj ke kf kg mk ki kj kk ml km kn ko mm kq kr ks ig bi translated">我们的简单案例可以归结为:</p><blockquote class="nd ne nf"><p id="1632" class="jv jw nc jx b jy jz ka kb kc kd ke kf ng kh ki kj nh kl km kn ni kp kq kr ks ig bi translated">我想检索并显示基于用户当前位置的相关数据。在最简单的情况下，我们可以采取一个饲料。</p></blockquote><figure class="lb lc ld le gt jo gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/387cec59b38e25ac253b87a46584ef8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1244/format:webp/1*ovxI0urG1WNKm7Mm1g4M-w.png"/></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">单馈架构</figcaption></figure><p id="c85a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这可以通过一个简单的<em class="nc"> GET </em>请求来完成，将用户的位置作为参数传入。</p><p id="8347" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">一般来说，API网关是我们后端服务的接口，通常它也处理用户认证。<a class="ae lj" href="https://rnfirebase.io" rel="noopener ugc nofollow" target="_blank"> React Native Firebase </a>为我们自动处理认证。</p><p id="2c6d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">云函数处理<em class="nc"> GET </em>请求，并对集合进行查询。然后，云功能返回与用户位置相关的提要条目，这些条目随后被转发回设备。云功能是GCP/Firebase版本的无服务器功能。</p><p id="b725" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">到目前为止一切顺利。就整体愿景而言，我们仍然缺少一些东西。该实现不满足三个要求:</p><ul class=""><li id="858c" class="mo mp in jx b jy jz kc kd kg nk kk nl ko nm ks mt mu mv mw bi translated">目前我们只提供一种饲料。我们希望将多个提要聚合成一个“主提要”</li><li id="9941" class="mo mp in jx b jy mx kc my kg mz kk na ko nb ks mt mu mv mw bi translated">每次我们在设备上启动“Home Feed”视图时，我们都需要等待请求完成后再显示结果。这可能需要很长时间，具体取决于在数据库上执行的查询。</li><li id="b34d" class="mo mp in jx b jy mx kc my kg mz kk na ko nb ks mt mu mv mw bi translated">当请求被执行时，我们必须等待回复，如果我们离线，那么<em class="nc"> GET </em>请求将不会收到回复。这意味着用户界面可能是空白的，或者最多显示一个装载微调器，直到我们重新上线。</li></ul><h1 id="1e20" class="lk ll in bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">复馈</h1><p id="70e8" class="pw-post-body-paragraph jv jw in jx b jy mi ka kb kc mj ke kf kg mk ki kj kk ml km kn ko mm kq kr ks ig bi translated">让我们把简单的例子变得更复杂:</p><blockquote class="nd ne nf"><p id="e1ec" class="jv jw nc jx b jy jz ka kb kc kd ke kf ng kh ki kj nh kl km kn ni kp kq kr ks ig bi translated">我想检索并显示基于用户当前位置的相关数据。该提要将是多个提要的集合。</p></blockquote><figure class="lb lc ld le gt jo gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/9e62f101ac358a5820c067910bc55334.png" data-original-src="https://miro.medium.com/v2/resize:fit:1244/format:webp/1*f5ktO0OTopVyngE1UoqZBQ.png"/></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">多馈电结构</figcaption></figure><p id="5fac" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">扩展我们的单馈架构。我们将在组合中添加一个额外的饲料。</p><p id="cf2a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这一点的关键是让云功能为我们做繁重的工作。原则上，我们希望后端服务器做尽可能多的计算，以允许客户端(移动设备)专注于可视化，而不用担心对象操作。</p><p id="13b3" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">考虑到这一点，云函数查询每个集合并将数据聚合到一个对象中。</p><p id="943b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">为了提高效率，我在NodeJS中使用Promise.all并行化了数据库查询。有几种方法可以组合来自不同数据源的数据，但我将重点介绍两种方法:</p><ul class=""><li id="b8c4" class="mo mp in jx b jy jz kc kd kg nk kk nl ko nm ks mt mu mv mw bi translated">交错是组合来自不同数据源的数据的最简单方法。所有这一切意味着将不同的数据源均匀分布，以形成一个单一的数据源。</li></ul><blockquote class="nn"><p id="b2e6" class="no np in bd nq nr ns nt nu nv nw ks dk translated">例如，对于坐标数据，<code class="fe nx ny nz oa b">x0 y0 z0 w0 x1 y1 z1 w1 x2 y2 z2 w2</code>是交错的，而<code class="fe nx ny nz oa b">x0 x1 x2 x3 y0 y1 y2 y3 z0 z1 z2 z3 w0 w1 w2 w3</code>不是。— <a class="ae lj" href="https://en.wikipedia.org/wiki/Interleaving_(data)" rel="noopener ugc nofollow" target="_blank">维基百科</a></p></blockquote><ul class=""><li id="ce10" class="mo mp in jx b jy ob kc oc kg od kk oe ko of ks mt mu mv mw bi translated">算法方法是一种更复杂的方法，它可能不会向用户呈现特定的模式。但可能取决于许多用户特定的因素，比如Instagram feed。</li></ul><blockquote class="nn"><p id="44f6" class="no np in bd nq nr ns nt nu nv nw ks dk translated">新的Instagram算法决定了用户在滚动订阅源时看到的帖子的顺序。</p><p id="5cc5" class="no np in bd nq nr og oh oi oj ok ks dk translated">根据特定的信号，它对帖子进行优先排序，将最相关的帖子推到顶部，并给予它们最大的可见性，而其他内容最终会被放在订阅源的更下方。— <a class="ae lj" href="https://www.shopify.com/blog/instagram-algorithm" rel="noopener ugc nofollow" target="_blank">购物</a></p></blockquote><p id="b30a" class="pw-post-body-paragraph jv jw in jx b jy ob ka kb kc oc ke kf kg ol ki kj kk om km kn ko on kq kr ks ig bi translated">这是我们最初设计的一个很好的迭代，所以让我们继续吧。就我们的整体愿景而言，我们仍然没有解决“主数据源”的异步加载问题。每次加载提要时，我们都必须等待响应。这可能会导致糟糕的用户体验，并且不符合以下要求:</p><ul class=""><li id="b1ca" class="mo mp in jx b jy jz kc kd kg nk kk nl ko nm ks mt mu mv mw bi translated">“Home Feed”需要高性能和快速加载。</li><li id="a12e" class="mo mp in jx b jy mx kc my kg mz kk na ko nb ks mt mu mv mw bi translated">即使当手机离线时,“主页订阅源”仍然应该填充有订阅源项目。</li></ul><h1 id="de82" class="lk ll in bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">高性能和用户友好的加载</h1><p id="9a81" class="pw-post-body-paragraph jv jw in jx b jy mi ka kb kc mj ke kf kg mk ki kj kk ml km kn ko mm kq kr ks ig bi translated">再次让我们首先用最简单的形式来描述我们的问题:</p><blockquote class="nd ne nf"><p id="cee9" class="jv jw nc jx b jy jz ka kb kc kd ke kf ng kh ki kj nh kl km kn ni kp kq kr ks ig bi translated">我希望以一种高效的方式从后端检索和显示数据，这种方式可以最大限度地减少长时间等待的需要，并让用户无论在线还是离线都有一致的用户体验。</p></blockquote><figure class="lb lc ld le gt jo gh gi paragraph-image"><div class="gh gi oo"><img src="../Images/8f56a2aabfd358020174e1dd5cae3353.png" data-original-src="https://miro.medium.com/v2/resize:fit:1256/format:webp/1*4Eb8I5IvJptOEOe2VBcwkw.png"/></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">高性能和用户友好的加载架构</figcaption></figure><p id="e86e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这是我利用一些特定的Firebase功能的地方，也是我给你如何替代你自己的技术的提示的地方。在我解释这个架构之前，有一些事情需要了解:</p><ul class=""><li id="4a3f" class="mo mp in jx b jy jz kc kd kg nk kk nl ko nm ks mt mu mv mw bi translated">Firebase为客户端(React Native app)提供了订阅Firestore (Firebase的集合数据库)中特定集合和文档的更改的能力。为了实现这一点，他们可能会实现自己的长轮询或web套接字解决方案，或者使用其他可能提供相同功能的技术。</li><li id="d8b8" class="mo mp in jx b jy mx kc my kg mz kk na ko nb ks mt mu mv mw bi translated">Firestore支持离线数据持久性。此功能会缓存您的应用程序正在使用的Firestore数据的副本，以便您的应用程序可以在设备离线时访问这些数据。您可以写、读、听和查询缓存的数据。当设备恢复在线时，云Firestore会将您的应用程序所做的任何本地更改同步到云Firestore后端。同样，为了实现这一点，您可以实现自己的解决方案或使用其他技术。</li></ul><p id="c407" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">考虑到这一点，我将浏览上述架构:</p><p id="b63e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">1a。和以前一样，移动设备向我们的API网关发送一个GET请求以及用户的当前位置，以启动提要聚合过程。提醒一下，这是我们可以识别用户的地方。这是步骤4所必需的。</p><p id="33a5" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">1b。然而，与此同时，我们的移动设备创建了对“Home Feed”集合中的用户文档的订阅。作为自动操作，除了接收后续更新之外，我的客户端还从缓存(离线)或实时收藏本身(在线)加载以前的“主页订阅”项目。设置我异步显示信息。</p><p id="cbc8" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">2.和以前一样，我启动了一个云函数来聚合提要。</p><p id="8c0c" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">3a + 3b。和以前一样，我查询相关的集合并聚合结果。</p><p id="75c5" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">4.一旦创建了结果“Home Feed”对象，我<em class="nc">将结果发布</em>到“Home Feed”集合中，特别是引用首先开始该过程的用户(在步骤1a中检索)。)</p><p id="c76a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">5.因为在步骤1b中客户端订阅了用户的“Home Feed”文档，所以我自动被推送到一个新的“Home Feed”对象的更新。然后，客户端向用户显示这一信息。</p><h1 id="8c07" class="lk ll in bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">结论</h1><p id="29b3" class="pw-post-body-paragraph jv jw in jx b jy mi ka kb kc mj ke kf kg mk ki kj kk ml km kn ko mm kq kr ks ig bi translated">暂时就这样吧！希望这能让你知道如何解决类似的问题，并提供一些参考架构，作为你自己设计的基础。</p><p id="816b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">请记住，所有的设计都是迭代的，因此我们很想听听您可能希望如何改进我们的架构，或者您如何实现类似的解决方案。</p><p id="3b0b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">请完整查看我们的UpForThat，看看我们最近在做些什么:</p><div class="op oq gp gr or os"><a href="https://upforthat.co/" rel="noopener  ugc nofollow" target="_blank"><div class="ot ab fo"><div class="ou ab ov cl cj ow"><h2 class="bd io gy z fp ox fr fs oy fu fw im bi translated">向上</h2><div class="oz l"><h3 class="bd b gy z fp ox fr fs oy fu fw dk translated">只需快速点击三下，你就可以选择今天或明天要做什么活动。留在圈子里…</h3></div><div class="pa l"><p class="bd b dl z fp ox fr fs oy fu fw dk translated">upforthat.co</p></div></div><div class="pb l"><div class="pc l pd pe pf pb pg jt os"/></div></div></a></div></div><div class="ab cl kt ku hr kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="ig ih ii ij ik"><p id="b1b0" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这是我们的第一个帖子，所以我们鼓励你发表评论，如果有具体的问题，你希望看到我们的团队在Toggled铲球，请告诉我们。Toggled的每个人都祝你一切顺利，下一篇文章再见！</p></div></div>    
</body>
</html>