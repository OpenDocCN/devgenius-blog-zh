<html>
<head>
<title>Building Your Own Export and Import Data Into Excel Using Django + Celery + Pandas + ❤️ With Progress Bar</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Django + Celery + Pandas + ❤️和进度条构建您自己的导出和导入数据到 Excel</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/building-your-own-export-and-import-data-into-excel-using-django-celery-pandas-%EF%B8%8F-with-784fd688e328?source=collection_archive---------0-----------------------#2020-10-10">https://blog.devgenius.io/building-your-own-export-and-import-data-into-excel-using-django-celery-pandas-%EF%B8%8F-with-784fd688e328?source=collection_archive---------0-----------------------#2020-10-10</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><h2 id="3be3" class="il im in bd b dl io ip iq ir is it dk iu translated" aria-label="kicker paragraph">编程，PYTHON，DJANGO</h2><div class=""/><div class=""><h2 id="b622" class="pw-subtitle-paragraph jt iw in bd b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk dk translated">使用 celery 任务队列跟踪进程的进度</h2></div><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/85417f81f57e26fa689cf70aae072c34.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*EpB8WhBQpiE9fDT5.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">来源:<a class="ae lb" href="https://buildwithdjango.com/static/blog/progress-bars/async-task-architecture.png" rel="noopener ugc nofollow" target="_blank">https://buildwithdjango . com/static/blog/progress-bars/async-task-architecture . png</a></figcaption></figure><h1 id="83c2" class="lc ld in bd le lf lg lh li lj lk ll lm kc ln kd lo kf lp kg lq ki lr kj ls lt bi translated">背景</h1><p id="e6be" class="pw-post-body-paragraph lu lv in lw b lx ly jx lz ma mb ka mc md me mf mg mh mi mj mk ml mm mn mo mp ig bi translated">几个月前，我一直致力于创建一个导出和导入数据的功能。我正在创建特性，测试，并顺利运行。直到享受了几天的特色，敌人的到来打破了我的舒适。敌人是被<strong class="lw ix">线程阻挡的</strong>。是的，导出和导入功能运行在主线程上，并阻塞另一个运行在其上的进程。我已经搜索，堆栈溢出，并在互联网上寻找解决方案。来自我的工程主管的一个关键词，但是很有价值。使用<a class="ae lb" href="https://docs.celeryproject.org/" rel="noopener ugc nofollow" target="_blank"> <strong class="lw ix">芹菜</strong> </a>在另一个线程中运行进程。啊哈，我觉得找到了好的解决办法，我的大脑试图假设和想象芹菜是多么强大。我试图找到如何将我的应用程序与芹菜集成的示例，尝试谷歌搜索并再次堆栈溢出。在这篇文章发表之前，我还没有找到有完整解决方案的文章。</p><p id="7e4e" class="pw-post-body-paragraph lu lv in lw b lx mq jx lz ma mr ka mc md ms mf mg mh mt mj mk ml mu mn mo mp ig bi translated">根据我的经验，我试图做一些完整的文章来帮助其他想建立类似功能的人。</p><h1 id="0951" class="lc ld in bd le lf lg lh li lj lk ll lm kc ln kd lo kf lp kg lq ki lr kj ls lt bi translated">先决条件</h1><p id="f22f" class="pw-post-body-paragraph lu lv in lw b lx ly jx lz ma mb ka mc md me mf mg mh mi mj mk ml mm mn mo mp ig bi translated">我的公司使用 Django Web Framework 作为我们构建 Web 应用程序和 RESTful API 的主要框架来构建应用程序。</p><p id="7537" class="pw-post-body-paragraph lu lv in lw b lx mq jx lz ma mr ka mc md ms mf mg mh mt mj mk ml mu mn mo mp ig bi translated">完整的先决条件如下所示:</p><h2 id="036a" class="mv ld in bd le mw mx dn li my mz dp lm md na nb lo mh nc nd lq ml ne nf ls it bi translated"><a class="ae lb" href="https://www.djangoproject.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="ak">姜戈</strong> </a></h2><p id="5b1d" class="pw-post-body-paragraph lu lv in lw b lx ly jx lz ma mb ka mc md me mf mg mh mi mj mk ml mm mn mo mp ig bi translated">Django 是我见过的能更快构建应用程序的最佳框架之一。这个框架基于 Python，提供了丰富的特性和模块，帮助我们构建、测试、保护和部署我们的应用程序。你可以在 Django 官方网站找到关于 Django 的详细描述。</p><h2 id="4e56" class="mv ld in bd le mw mx dn li my mz dp lm md na nb lo mh nc nd lq ml ne nf ls it bi translated"><a class="ae lb" href="https://docs.celeryproject.org/" rel="noopener ugc nofollow" target="_blank">芹菜</a></h2><p id="5d25" class="pw-post-body-paragraph lu lv in lw b lx ly jx lz ma mb ka mc md me mf mg mh mi mj mk ml mm mn mo mp ig bi translated">Celery 是一个强大的 python 库，可以帮助我们提高应用程序的性能。根据芹菜官方文档网站，芹菜是。。。</p><blockquote class="ng nh ni"><p id="ff37" class="lu lv nj lw b lx mq jx lz ma mr ka mc nk ms mf mg nl mt mj mk nm mu mn mo mp ig bi translated">Celery 是一个简单、灵活、可靠的分布式系统，用于处理大量的消息，同时提供维护这样一个系统所需的工具。</p></blockquote><h2 id="103c" class="mv ld in bd le mw mx dn li my mz dp lm md na nb lo mh nc nd lq ml ne nf ls it bi translated"><a class="ae lb" href="https://pandas.pydata.org/" rel="noopener ugc nofollow" target="_blank">熊猫</a></h2><p id="2e05" class="pw-post-body-paragraph lu lv in lw b lx ly jx lz ma mb ka mc md me mf mg mh mi mj mk ml mm mn mo mp ig bi translated">Pandas 是数据科学家用来处理大型数据集的最常用的 python 库之一。Pandas 具有丰富的功能，允许我们从多种文档格式加载数据，如 Microsoft Excel 2007、Microsoft Excel 2010、CSV、纯文本和另一种未列出的格式。在<a class="ae lb" href="https://pandas.pydata.org/" rel="noopener ugc nofollow" target="_blank">官方文件</a>中找到熊猫的完整描述。</p><h2 id="5643" class="mv ld in bd le mw mx dn li my mz dp lm md na nb lo mh nc nd lq ml ne nf ls it bi translated"><a class="ae lb" href="https://openpyxl.readthedocs.io/" rel="noopener ugc nofollow" target="_blank"> Openpyxl </a></h2><p id="291f" class="pw-post-body-paragraph lu lv in lw b lx ly jx lz ma mb ka mc md me mf mg mh mi mj mk ml mm mn mo mp ig bi translated">Openpyxl 是 python 库之一，它允许我们修改 Excel 文件。我选择 openpyxl 的主要原因是这个库能够修改现有的 Excel 文档，以便逐行插入，插入特定的行和列，并且易于对单元格进行样式化。我喜欢在我的应用程序中使用这个库。</p><h2 id="4e58" class="mv ld in bd le mw mx dn li my mz dp lm md na nb lo mh nc nd lq ml ne nf ls it bi translated"><a class="ae lb" href="https://github.com/czue/celery-progress" rel="noopener ugc nofollow" target="_blank">芹菜-进展</a></h2><p id="5557" class="pw-post-body-paragraph lu lv in lw b lx ly jx lz ma mb ka mc md me mf mg mh mi mj mk ml mm mn mo mp ig bi translated">为你的 Django/Celery 应用程序提供无依赖进度条。超级简单的设置。大量定制可用。</p><p id="f392" class="pw-post-body-paragraph lu lv in lw b lx mq jx lz ma mr ka mc md ms mf mg mh mt mj mk ml mu mn mo mp ig bi translated">完整的应用需求可以在找到<a class="ae lb" href="https://github.com/ebysofyan/django-celery-progress-sample/blob/master/requirements.txt" rel="noopener ugc nofollow" target="_blank">。</a></p><blockquote class="ng nh ni"><p id="fddc" class="lu lv nj lw b lx mq jx lz ma mr ka mc nk ms mf mg nl mt mj mk nm mu mn mo mp ig bi translated">空谈是廉价的，给我看看代码</p></blockquote><h1 id="576a" class="lc ld in bd le lf lg lh li lj lk ll lm kc ln kd lo kf lp kg lq ki lr kj ls lt bi translated">代码</h1><p id="66f0" class="pw-post-body-paragraph lu lv in lw b lx ly jx lz ma mb ka mc md me mf mg mh mi mj mk ml mm mn mo mp ig bi translated">为了开始编写代码，我假设您对 Django 有基本的了解，并且了解如何配置 Django 项目。</p><p id="ded2" class="pw-post-body-paragraph lu lv in lw b lx mq jx lz ma mr ka mc md ms mf mg mh mt mj mk ml mu mn mo mp ig bi translated">喝了咖啡，继续看书。。。</p><h2 id="0277" class="mv ld in bd le mw mx dn li my mz dp lm md na nb lo mh nc nd lq ml ne nf ls it bi translated"><strong class="ak"> 1。创建项目和安装需求</strong></h2><p id="6c5c" class="pw-post-body-paragraph lu lv in lw b lx ly jx lz ma mb ka mc md me mf mg mh mi mj mk ml mm mn mo mp ig bi translated">创建 Django 项目并将该文件作为您最喜欢的目录结构。如果您的项目已经创建，请安装上面列出的要求或在这里找到完整的要求<a class="ae lb" href="https://github.com/ebysofyan/django-celery-progress-sample/blob/master/requirements.txt" rel="noopener ugc nofollow" target="_blank"/>。<br/>运行以下命令</p><pre class="km kn ko kp gt nn no np nq aw nr bi"><span id="928c" class="mv ld in no b gy ns nt l nu nv">pip install requirements.txt</span></pre><h2 id="9b88" class="mv ld in bd le mw mx dn li my mz dp lm md na nb lo mh nc nd lq ml ne nf ls it bi translated">2.配置应用程序设置</h2><p id="6970" class="pw-post-body-paragraph lu lv in lw b lx ly jx lz ma mb ka mc md me mf mg mh mi mj mk ml mm mn mo mp ig bi translated">安装完所有的需求之后，通过将库的<code class="fe nw nx ny no b">app_name</code>注册到<code class="fe nw nx ny no b">INSTALLED_APPS</code>部分特定位置的<code class="fe nw nx ny no b">settings.py</code>中来配置您的应用程序设置。</p><pre class="km kn ko kp gt nn no np nq aw nr bi"><span id="1deb" class="mv ld in no b gy ns nt l nu nv">....</span><span id="a33a" class="mv ld in no b gy nz nt l nu nv">INSTALLED_APPS = [<br/>     "...."<br/>     "celery_progress",<br/>     "django_extensions",<br/>     "corsheaders",<br/>     "core",<br/>]</span></pre><h2 id="c682" class="mv ld in bd le mw mx dn li my mz dp lm md na nb lo mh nc nd lq ml ne nf ls it bi translated">3.配置芹菜集成</h2><p id="0e2c" class="pw-post-body-paragraph lu lv in lw b lx ly jx lz ma mb ka mc md me mf mg mh mi mj mk ml mm mn mo mp ig bi translated">Celery 需要一个消息代理后端来处理消息排队、存储数据和缓存数据。有许多消息代理后端已经被大公司使用和维护，如 Redis，RabbitMQ，亚马逊 SQS，Zookeeper 等。在这篇文章发表之前，celery 支持提到的消息代理。详情可以查看<a class="ae lb" href="https://docs.celeryproject.org/en/stable/getting-started/brokers/" rel="noopener ugc nofollow" target="_blank">芹菜经纪人文档</a>。</p><p id="134f" class="pw-post-body-paragraph lu lv in lw b lx mq jx lz ma mr ka mc md ms mf mg mh mt mj mk ml mu mn mo mp ig bi translated">在本文中，我使用 Redis 作为消息代理后端，因为它易于安装、配置，并得到大公司如 Twitter、Github、StackOverflow、Pinterest 等的验证。</p><p id="e6c0" class="pw-post-body-paragraph lu lv in lw b lx mq jx lz ma mr ka mc md ms mf mg mh mt mj mk ml mu mn mo mp ig bi translated">您可以看到下面的芹菜样本配置</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="oa ob l"/></div></figure><h2 id="8a08" class="mv ld in bd le mw mx dn li my mz dp lm md na nb lo mh nc nd lq ml ne nf ls it bi translated">4.创建网页以执行导出和导入</h2><p id="0c1f" class="pw-post-body-paragraph lu lv in lw b lx ly jx lz ma mb ka mc md me mf mg mh mi mj mk ml mm mn mo mp ig bi translated">本文不是关于如何使用 Django 创建网页的教程。我假设你能够使用 Django 创建自己的网页。如果你不知道如何设计你的网页，我可以提供下面的例子。不复杂，但足以运行该功能。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi oc"><img src="../Images/20b85d6b859cc7beaa3844d9875d87c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sGtqNioKkW-F3BqiV4iHqw.png"/></div></div></figure><h2 id="e3dc" class="mv ld in bd le mw mx dn li my mz dp lm md na nb lo mh nc nd lq ml ne nf ls it bi translated">5.创建您的芹菜任务</h2><p id="c58e" class="pw-post-body-paragraph lu lv in lw b lx ly jx lz ma mb ka mc md me mf mg mh mi mj mk ml mm mn mo mp ig bi translated">我们有两个主要特性需要在另一个线程上运行。为什么？</p><p id="e3b4" class="pw-post-body-paragraph lu lv in lw b lx mq jx lz ma mr ka mc md ms mf mg mh mt mj mk ml mu mn mo mp ig bi translated"><strong class="lw ix">导出数据:</strong>假设您的数据库中有一千行数据，您想将其追加到 excel 文件中。处理它可能需要 1 分钟。供您参考，Django 运行在单线程上，如果您在同一个线程上运行一个长时间运行的进程，它会很拥挤。</p><p id="6618" class="pw-post-body-paragraph lu lv in lw b lx mq jx lz ma mr ka mc md ms mf mg mh mt mj mk ml mu mn mo mp ig bi translated"><strong class="lw ix">导入数据:</strong>你需要从 excel 文件中导入一千行数据？相信我，你需要在另一个进程上运行它。</p><p id="d34b" class="pw-post-body-paragraph lu lv in lw b lx mq jx lz ma mr ka mc md ms mf mg mh mt mj mk ml mu mn mo mp ig bi translated">好，让我们创建第一个芹菜任务。任务只是一个普通的类和/或函数，你经常通过键入<code class="fe nw nx ny no b">class</code>或<code class="fe nw nx ny no b">def </code>来标识它们:D. Celery 有两种方法来定义任务，第一种是使用函数，另一种是使用类。如果你有一个小任务，我建议你使用函数，并与类不同的情况。让我们看看下面的例子。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="oa ob l"/></div></figure><h2 id="e428" class="mv ld in bd le mw mx dn li my mz dp lm md na nb lo mh nc nd lq ml ne nf ls it bi translated">6.运行 Django 和 Celery 服务器</h2><p id="88bf" class="pw-post-body-paragraph lu lv in lw b lx ly jx lz ma mb ka mc md me mf mg mh mi mj mk ml mm mn mo mp ig bi translated">两个应用程序都需要运行任一服务器。Django 服务器运行 web 应用程序，celery 服务器监听来自注册任务的消息事件请求。</p><pre class="km kn ko kp gt nn no np nq aw nr bi"><span id="0ab1" class="mv ld in no b gy ns nt l nu nv"># Command to run Django server<br/>python manage.py runserver 0.0.0.0:8000 #or another available port</span><span id="bcfc" class="mv ld in no b gy nz nt l nu nv"># Command to run celery server<br/>celery -A dj_celery_progress_sample worker --loglevel=DEBUG</span></pre><h2 id="8f57" class="mv ld in bd le mw mx dn li my mz dp lm md na nb lo mh nc nd lq ml ne nf ls it bi translated">7.运行芹菜任务</h2><p id="1547" class="pw-post-body-paragraph lu lv in lw b lx ly jx lz ma mb ka mc md me mf mg mh mi mj mk ml mm mn mo mp ig bi translated">芹菜类和函数库有相似的方式调用和运行任务。常规的类和函数调用与芹菜任务调用的不同之处在于，如果你运行芹菜任务类或函数，你需要调用<code class="fe nw nx ny no b">delay</code>关键字。</p><pre class="km kn ko kp gt nn no np nq aw nr bi"><span id="4906" class="mv ld in no b gy ns nt l nu nv"># function base task<br/>count_thousand_number.delay()</span><span id="b490" class="mv ld in no b gy nz nt l nu nv"># class base task<br/>ImportUserFromExcelTask().delay("path/to/excel/file.xlsx")</span></pre><h2 id="9ffd" class="mv ld in bd le mw mx dn li my mz dp lm md na nb lo mh nc nd lq ml ne nf ls it bi translated">8.使用 celery-progress 跟踪您的导入或导出进度</h2><p id="bb32" class="pw-post-body-paragraph lu lv in lw b lx ly jx lz ma mb ka mc md me mf mg mh mi mj mk ml mm mn mo mp ig bi translated">在这个示例中，我使用<code class="fe nw nx ny no b">celery-progress</code>库来创建进度计数器，并将进度集成到网页中。要使用这个库，从这个库中导入<code class="fe nw nx ny no b">ProgressRecorder</code>类并调用<code class="fe nw nx ny no b">set_progress</code>函数来计算进度。</p><pre class="km kn ko kp gt nn no np nq aw nr bi"><span id="db0d" class="mv ld in no b gy ns nt l nu nv">progress_recorder = ProgressRecorder(<em class="nj">self</em>)<br/>for index in range(0, 1000):<br/>    progress_recorder.set_progress(<br/>        index + 1, <br/>        <em class="nj">total</em>=total_record, <br/>        <em class="nj">description</em>="Inserting record into row"<br/>    )</span></pre><p id="de96" class="pw-post-body-paragraph lu lv in lw b lx mq jx lz ma mr ka mc md ms mf mg mh mt mj mk ml mu mn mo mp ig bi translated">关于本库的完整用法，可以在文档中找到。</p><div class="od oe gp gr of og"><a href="https://github.com/czue/celery-progress" rel="noopener  ugc nofollow" target="_blank"><div class="oh ab fo"><div class="oi ab oj cl cj ok"><h2 class="bd ix gy z fp ol fr fs om fu fw iw bi translated">czue/芹菜-进展</h2><div class="on l"><h3 class="bd b gy z fp ol fr fs om fu fw dk translated">为您的 Django/Celery 应用程序提供可配置的无依赖进度条。-czue/芹菜-进展</h3></div><div class="oo l"><p class="bd b dl z fp ol fr fs om fu fw dk translated">github.com</p></div></div><div class="op l"><div class="oq l or os ot op ou kv og"/></div></div></a></div><h2 id="e07e" class="mv ld in bd le mw mx dn li my mz dp lm md na nb lo mh nc nd lq ml ne nf ls it bi translated">9.在网页中显示进度</h2><p id="223c" class="pw-post-body-paragraph lu lv in lw b lx ly jx lz ma mb ka mc md me mf mg mh mi mj mk ml mm mn mo mp ig bi translated">无论何时你想要整合第八步中提到的进展，你都需要在你的网页中添加一些<code class="fe nw nx ny no b">javascript</code>代码。您可以使用上面文档中提供的样式，或者您可以创建自己的自定义样式进度来显示您的导入或导出进度。如果你喜欢将自定义进度集成到你的自定义进度条中，你可以在这里找到示例<a class="ae lb" href="https://github.com/ebysofyan/django-celery-progress-sample/blob/master/templates/index.html" rel="noopener ugc nofollow" target="_blank"/>。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="oa ob l"/></div></figure><h2 id="dd03" class="mv ld in bd le mw mx dn li my mz dp lm md na nb lo mh nc nd lq ml ne nf ls it bi translated">10.是的，我们达到了最终的结果👏🏼</h2><p id="dc62" class="pw-post-body-paragraph lu lv in lw b lx ly jx lz ma mb ka mc md me mf mg mh mi mj mk ml mm mn mo mp ig bi translated">在我们一步一步地描述这篇文章之后，我们到达结果的结尾。结果如下图所示。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ov"><img src="../Images/01293bd76481a623ffe616c32bb68e90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*uZoW7ZEuOizl_spLzfHJTA.gif"/></div></div></figure><h1 id="1fea" class="lc ld in bd le lf lg lh li lj lk ll lm kc ln kd lo kf lp kg lq ki lr kj ls lt bi translated">闭幕</h1><p id="e950" class="pw-post-body-paragraph lu lv in lw b lx ly jx lz ma mb ka mc md me mf mg mh mi mj mk ml mm mn mo mp ig bi translated">感谢您的关注，您可以在我的 Github 上找到完整的源代码，如果它有错误，请创建一个问题，欢迎您的请求来使它变得更好。不要犹豫提出你的问题。。。谢谢你</p><div class="od oe gp gr of og"><a href="https://github.com/ebysofyan/django-celery-progress-sample" rel="noopener  ugc nofollow" target="_blank"><div class="oh ab fo"><div class="oi ab oj cl cj ok"><h2 class="bd ix gy z fp ol fr fs om fu fw iw bi translated">ebysofyan/django-芹菜-进度-样本</h2><div class="on l"><h3 class="bd b gy z fp ol fr fs om fu fw dk translated">👻一个存储库，使用 Django + Celery + Pandas 和一个…</h3></div><div class="oo l"><p class="bd b dl z fp ol fr fs om fu fw dk translated">github.com</p></div></div><div class="op l"><div class="ow l or os ot op ou kv og"/></div></div></a></div><h1 id="fcec" class="lc ld in bd le lf lg lh li lj lk ll lm kc ln kd lo kf lp kg lq ki lr kj ls lt bi translated">参考</h1><ul class=""><li id="6559" class="ox oy in lw b lx ly ma mb md oz mh pa ml pb mp pc pd pe pf bi translated"><a class="ae lb" href="https://docs.celeryproject.org/en/stable/getting-started/brokers/" rel="noopener ugc nofollow" target="_blank">https://docs . celery project . org/en/stable/getting-started/brokers/</a></li><li id="df15" class="ox oy in lw b lx pg ma ph md pi mh pj ml pk mp pc pd pe pf bi translated"><a class="ae lb" href="https://redis.io/topics/whos-using-redis" rel="noopener ugc nofollow" target="_blank">https://redis.io/topics/whos-using-redis</a></li></ul></div></div>    
</body>
</html>