<html>
<head>
<title>Window functions in POSTGRESQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">POSTGRESQL 中的窗口函数</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/window-functions-in-postgresql-ff192d0d249a?source=collection_archive---------16-----------------------#2022-12-27">https://blog.devgenius.io/window-functions-in-postgresql-ff192d0d249a?source=collection_archive---------16-----------------------#2022-12-27</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="39c8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">窗口函数对一组与当前行有某种关系的表行执行计算。这些也称为分析函数，类似于对集合中的所有表格行执行分析函数的计算。窗口函数对其进行操作的一组行称为窗口。</p><p id="9fb3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">聚合函数在聚合一组行中的数据后返回一行。而对一组行进行操作的窗口函数不会减少查询返回的行数。</p><p id="1457" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">窗口函数的语法:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/91d24d45af7b44cb5b4cfedcffa45fe2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AnZi2a1goBnySIO7tvgs-w.png"/></div></div></figure><p id="da53" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">窗口功能分为三种不同的类别:</p><p id="e095" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">用 OVER 子句调用常规聚合函数时，它充当窗口函数。行保留它们的标识，并且还显示每一行的聚合值。排名窗口函数将对指定字段的值进行排名，并根据其排名对其进行分类。而值窗口函数将窗口内的值从其他行复制到其他行。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ku"><img src="../Images/f3114e6356f28da87cc047d351852efd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fqjh9dt9PeTEVXBqKvIsLw.png"/></div></div></figure><h1 id="7f19" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">窗口功能的用例</h1><p id="fa76" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">窗口函数通过提供对更复杂的 SQL 概念的替代，提高了效率并降低了分析数据集分区(窗口)的查询的复杂性。</p><p id="9657" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">。排名函数最常见的用途是根据某个值查找前(N)条记录。例如，前 10 名收入最高的员工、前 10 名排名靠前的学生、前 50 名最大订单等。</p><ul class=""><li id="db1b" class="ly lz in jm b jn jo jr js jv ma jz mb kd mc kh md me mf mg bi translated">从特定窗口内的另一行访问结果(例如，在分区内显示与最高工资相关联的值，显示前一行的销售额，等等)。)</li><li id="97a4" class="ly lz in jm b jn mh jr mi jv mj jz mk kd ml kh md me mf mg bi translated">特定窗口内的汇总(例如，销售总额、运行销售总额、运行销售平均值等。)</li></ul><p id="7d70" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">以下是 postgress 中的窗口函数:</p><p id="8360" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">累计距离</strong>:</p><p id="166d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">该函数返回一组值中某个值的累积分布。换句话说，用于查询作为一组给定值中的值的相对位置。</p><p id="e78a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">有时，您可能希望创建一个报表来显示数据集中前或后的 x%值，例如，按收入排列的前 1%的产品。</p><p id="2242" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这将返回一个≥ 0 且≤ 1 的双精度值。</p><p id="8780" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> Row_Number: </strong>该函数为每个分区中的每一行分配一个序列号。</p><p id="e226" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> Rank: </strong>该函数在有序分区内分配等级。该函数为具有相同值的行分配相同的等级，跳过下一个等级。</p><p id="c240" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> Dense_Rank </strong>:该函数为有序分区中的每一行分配一个等级，相同的等级被分配给多行，并且不跳过任何等级。</p><p id="18d9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> Percent_Rank </strong>:该函数类似于 cume_dist()函数。Percent_rank()函数计算一个值在一组值中的相对位置。</p><p id="eb37" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">0 &lt; PERCENT_RANK() &lt;= 1</p><p id="cbea" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> First_Value: </strong>该函数返回结果集的排序分区中的第一行或第一个值。</p><p id="8566" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> Lag: </strong>返回在分区内当前行之前的指定物理偏移行处评估的值。</p><p id="f98d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> Last_Value : </strong>返回对其分区内的最后一行进行评估的值。</p><p id="ce01" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> Lead : </strong>返回在分区内当前行之后偏移行的行上计算的值。</p><p id="f250" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> NTile: </strong>尽可能均等地划分分区中的行，并为每一行分配一个从 1 到参数值的整数。</p><p id="6a09" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">帮助您确定给定行属于哪个百分点(或四分位数，或任何其他细分)。</p><p id="56be" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">第 n 个值:</strong>返回针对有序分区中的第 n 行计算的值。</p><p id="305b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们讨论上面的几个函数如下。我们使用下面的雇员表作为示例表来描述。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mm"><img src="../Images/af406e9adc0fa89990c45252309c5982.png" data-original-src="https://miro.medium.com/v2/resize:fit:1136/format:webp/1*WXtBZN9QSg823iWXlNTw4w.png"/></div></figure><p id="565c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">聚合函数:</strong></p><p id="a634" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们将看到几个带有 employees 表的聚合函数示例:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/36454c9d0e30d098eefeae5d5e88dae5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1252/format:webp/1*s3Gq2pYQlKnx8cL0txmvKg.png"/></div></figure><p id="3797" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">输出是:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mo"><img src="../Images/3fd7b5cb8be7306863b0a084ee3d2064.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8NwUJ0R70fsebrVZZT2VoA.png"/></div></div></figure><p id="5fc3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">行保留它们的标识，并且还显示每一行的聚合值。在上面的示例中，它汇总了每个部门的数据，并在新列中分别显示了标记为 sum 的每个部门的总计、标记为 max 的每个部门的最大薪金值和标记为 min 的每个部门的最小薪金值。</p><p id="c742" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">排名功能:</strong></p><p id="2a99" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在我们将通过示例来了解最常用的排名函数 Row_number、Rank、dense_rank 之间的区别。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mp"><img src="../Images/7cda2bef9008217a782db4781eebe606.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UXwfA3FRKfHo3yI5H5Vk9Q.png"/></div></div></figure><p id="aad3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">输出是:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mq"><img src="../Images/fbb73f29d42ebaa615114e7cb16a5abb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lHUEEw-Z7ListSa48EAUSA.png"/></div></div></figure><p id="9120" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">因此，我们可以看到，正如 ROW_NUMBER()的定义中所提到的，行号是每个分区中的连续整数。此外，我们可以看到秩和密集秩之间的差异，在密集秩中，如果两行具有相同的秩值，则跳过一个秩，而在重复秩后，DENSE_RANK()值中没有跳过任何秩。</p><p id="a7bf" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">价值函数:</strong></p><p id="eea9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们将看到带有雇员表的几个值函数示例:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mr"><img src="../Images/76b8773519d716279672b72284208750.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*81uoCrC3Y51S31C04HU3NA.png"/></div></div></figure><p id="7676" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">输出是:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ms"><img src="../Images/21e3cee55b0e15dba583f3f389c9e534.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GIKXh43MeNhVfzyd0N4Haw.png"/></div></div></figure><p id="b2a2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">LAG 函数允许访问同一结果集中前一行的数据，而 LEAD 函数允许访问同一结果中下一行的数据，而无需使用任何 SQL 连接。您可以在上面的示例中看到，使用 LAG，LEAD 函数来检查当前员工的工资是低于还是高于上一个员工。</p><h2 id="78c5" class="mt kw in bd kx mu mv dn lb mw mx dp lf jv my mz lj jz na nb ln kd nc nd lr ne bi translated">结论</h2><p id="c6d2" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">PostgreSQL 窗口函数用于比较对比数据，它是 PostgreSQL 中分析和各种用例的关键。Windows 函数是聚合函数(SUM()、COUNT()、MIN()等。)、排名函数(ROW_NUMBER()、RANK()和 DENSE_RANK()等。)和值函数(LEAD()和 LAG()等)。)返回表中的每一行而不是单个行输出，并用于比较当前行之间的值以及与表中所有值的当前行相关的值。</p></div></div>    
</body>
</html>