<html>
<head>
<title>Ruby Code Linting and Auto-formatting with RuboCop</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Ruby 代码林挺和用 RuboCop 自动格式化</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/ruby-code-linting-and-auto-formatting-with-rubocop-316e9307f129?source=collection_archive---------6-----------------------#2022-09-19">https://blog.devgenius.io/ruby-code-linting-and-auto-formatting-with-rubocop-316e9307f129?source=collection_archive---------6-----------------------#2022-09-19</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="dd22" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">林挺是自动检测源代码中的编程和风格错误。一种称为 linter 的静态代码分析工具执行这种检查。另一方面，代码格式化程序是一种与格式化源代码相关的工具，以便它严格遵循一组预先配置的规则。linter 通常会报告违规，但通常由程序员来解决问题，而代码格式化程序将其规则直接应用于源代码，自动纠正格式化错误。</p><p id="4eb0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在项目中创建更加一致的代码风格通常需要使用单独的林挺和格式化工具，但是在某些情况下，一个工具可以解决这两个问题。RuboCop，我们将在本文中深入探讨的工具，是后者的一个很好的例子。您将学习如何将它包含在您的 Ruby 项目中，并对其进行配置，以使其输出符合您的期望。</p><blockquote class="ki"><p id="64d5" class="kj kk in bd kl km kn ko kp kq kr kh dk translated">"代码格式化是关于交流的，而交流是专业开发人员的首要任务."</p><p id="3518" class="kj kk in bd kl km kn ko kp kq kr kh dk translated">—林文治</p></blockquote></div><div class="ab cl ks kt hr ku" role="separator"><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx"/></div><div class="ig ih ii ij ik"><h1 id="0e12" class="kz la in bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">安装 RuboCop</h1><p id="9834" class="pw-post-body-paragraph jk jl in jm b jn lx jp jq jr ly jt ju jv lz jx jy jz ma kb kc kd mb kf kg kh ig bi translated">使用 RubyGems 安装 Rubocop 很容易:</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="5441" class="ml la in mh b gy mm mn l mo mp">$ gem install rubocop</span></pre><p id="c470" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">要检查安装了哪个版本:</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="164e" class="ml la in mh b gy mm mn l mo mp">$ rubocop --version<br/>1.18.3</span></pre><p id="71fd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果您更愿意使用 Bundler，将下面的代码放到您的<code class="fe mq mr ms mh b"><em class="mt">Gemfile</em></code>中，然后运行<code class="fe mq mr ms mh b"><em class="mt">bundle install</em></code>。<code class="fe mq mr ms mh b"><em class="mt">require: false</em></code>部分告诉<code class="fe mq mr ms mh b"><em class="mt">Bundler.require</em></code>不要在你的代码中要求特定的 gem，因为它只会在命令行中使用。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="8d0b" class="ml la in mh b gy mm mn l mo mp">gem 'rubocop', require: false</span></pre><p id="6fb4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">检查安装的版本:</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="48ff" class="ml la in mh b gy mm mn l mo mp">$ bundle exec rubocop --version<br/>1.18.3</span></pre><h1 id="6f2c" class="kz la in bd lb lc mu le lf lg mv li lj lk mw lm ln lo mx lq lr ls my lu lv lw bi translated">运行 Rubocop</h1><p id="c0be" class="pw-post-body-paragraph jk jl in jm b jn lx jp jq jr ly jt ju jv lz jx jy jz ma kb kc kd mb kf kg kh ig bi translated">通过在你的项目中键入<code class="fe mq mr ms mh b">rubocop</code>，你可以用它的默认设置运行 RuboCop(或者<code class="fe mq mr ms mh b">bundle exec rubocop</code>，如果和 Bundler 一起安装的话)。如果没有参数传递给该命令，它将检查当前目录和所有子目录中的所有 Ruby 源文件。或者，您可以指定要检查的文件和目录列表。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="9c1c" class="ml la in mh b gy mm mn l mo mp">$ bundle exec rubocop<br/>$ bundle exec rubocop src/lib</span></pre><p id="0303" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在没有任何配置的情况下，RuboCop 执行了社区驱动的<a class="ae mz" href="https://medium.com/@ryanneilparker/ruby-style-guide-25069742c0da" rel="noopener"> Ruby 风格指南</a>中概述的许多准则。运行该命令后，您可能会收到几个错误(违例)。每个报告的违规都包括解决它所需的所有信息，例如违规描述以及发生违规的文件和行号。</p><figure class="mc md me mf gt nb gh gi paragraph-image"><div role="button" tabindex="0" class="nc nd di ne bf nf"><div class="gh gi na"><img src="../Images/c441ff8a1b2e9effda0a86e64d546950.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FlyUflGnWU6a0KLMgxhR5g.png"/></div></div></figure><p id="4f81" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">您将在报告的底部看到一行，描述了已检查文件的数量、违规总数以及有多少违规可以自动修复。如果您添加了<code class="fe mq mr ms mh b">-a</code>或<code class="fe mq mr ms mh b">— auto-correct</code>参数，RuboCop 将试图自动纠正您的源文件中发现的任何错误(那些带有<code class="fe mq mr ms mh b">[Correctable]</code>前缀的)。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="3674" class="ml la in mh b gy mm mn l mo mp">$ bundle exec rubocop -a</span></pre><figure class="mc md me mf gt nb gh gi paragraph-image"><div role="button" tabindex="0" class="nc nd di ne bf nf"><div class="gh gi na"><img src="../Images/17aa4faa221745f70e4407098b877995.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dwRMrsyAoJrKHgxboPriAw.png"/></div></div></figure><p id="eedd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">注意现在每个纠正的错误前面都有<code class="fe mq mr ms mh b">[Corrected]</code>。在报告的底部，还提供了已纠正的违法行为的数量汇总。在前面的例子中，有另一个可纠正的错误没有自动修复，即使在添加了<code class="fe mq mr ms mh b">-a</code>标志之后。因为一些自动修正可能会稍微改变代码的语义，所以 RuboCop 认为这是不安全的。使用<code class="fe mq mr ms mh b">-A</code>或<code class="fe mq mr ms mh b">— auto-correct-all</code>标志也可以自动更正这些错误。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="dc47" class="ml la in mh b gy mm mn l mo mp">$ bundle exec rubocop -A</span></pre><figure class="mc md me mf gt nb gh gi paragraph-image"><div role="button" tabindex="0" class="nc nd di ne bf nf"><div class="gh gi na"><img src="../Images/35d04046816397fdf51f45962b87941c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2jUGsFZm0poNvLNC0dooPQ.png"/></div></div></figure><p id="0f3c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">一个好的经验法则是在使用自动更正功能后运行测试套件，以确保代码的行为没有发生意外更改。</p><h1 id="61c5" class="kz la in bd lb lc mu le lf lg mv li lj lk mw lm ln lo mx lq lr ls my lu lv lw bi translated">配置 Rubocop</h1><p id="0482" class="pw-post-body-paragraph jk jl in jm b jn lx jp jq jr ly jt ju jv lz jx jy jz ma kb kc kd mb kf kg kh ig bi translated">RuboCop 可以通过在项目的根目录下放置一个<code class="fe mq mr ms mh b">.rubocop.yml</code>文件来配置。您可以在您的主目录(<code class="fe mq mr ms mh b">~/.rubocop.yml</code>)或 XDG 配置目录(<code class="fe mq mr ms mh b">~/.config/rubocop/config.yml</code>)中使用一个全局配置文件，以便对所有项目使用相同的检查。如果在当前或后续父目录中找不到本地范围的项目配置文件，将使用此全局配置文件。</p><p id="22e9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">RuboCop 的默认配置存储在它的配置主目录(<code class="fe mq mr ms mh b">/.config/rubocop/default.yml</code>)中，所有其他的配置文件都继承自它。这意味着在配置项目时，您只需要进行不同于默认设置的更改。这可能意味着启用或禁用特定的检查，或者在接受任何参数的情况下更改它们的行为。</p><p id="7c07" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">每个单独的检查被 RuboCop 称为一个 cop，每个人负责检测一个特定的违法行为。可用的 COP 分为以下几个部门:</p><ul class=""><li id="88bf" class="ni nj in jm b jn jo jr js jv nk jz nl kd nm kh nn no np nq bi translated"><a class="ae mz" href="https://docs.rubocop.org/rubocop/1.18/cops_style.html" rel="noopener ugc nofollow" target="_blank">风格副本</a>大多基于前面提到的 Ruby 风格指南，它们检查你的代码的一致性。</li><li id="094c" class="ni nj in jm b jn nr jr ns jv nt jz nu kd nv kh nn no np nq bi translated"><a class="ae mz" href="https://docs.rubocop.org/rubocop/1.18/cops_layout.html" rel="noopener ugc nofollow" target="_blank">布局副本</a>识别格式问题，例如使用空白。</li><li id="9c23" class="ni nj in jm b jn nr jr ns jv nt jz nu kd nv kh nn no np nq bi translated"><a class="ae mz" href="https://docs.rubocop.org/rubocop/1.18/cops_lint.html" rel="noopener ugc nofollow" target="_blank"> Lint cops </a>检测你代码中的潜在错误，与<code class="fe mq mr ms mh b">ruby -w</code>相似，但有一系列额外的检查。</li><li id="040e" class="ni nj in jm b jn nr jr ns jv nt jz nu kd nv kh nn no np nq bi translated"><a class="ae mz" href="https://docs.rubocop.org/rubocop/1.18/cops_metrics.html" rel="noopener ugc nofollow" target="_blank">度量 cops </a>处理源代码度量问题，比如类长度和方法长度。</li><li id="b3a5" class="ni nj in jm b jn nr jr ns jv nt jz nu kd nv kh nn no np nq bi translated"><a class="ae mz" href="https://docs.rubocop.org/rubocop/1.18/cops_naming.html" rel="noopener ugc nofollow" target="_blank">命名警察</a>对命名惯例感兴趣。</li><li id="8e99" class="ni nj in jm b jn nr jr ns jv nt jz nu kd nv kh nn no np nq bi translated">安全警察帮助检测潜在的安全问题。</li><li id="1766" class="ni nj in jm b jn nr jr ns jv nt jz nu kd nv kh nn no np nq bi translated"><a class="ae mz" href="https://docs.rubocop.org/rubocop/1.18/cops_bundler.html" rel="noopener ugc nofollow" target="_blank"> Bundler cops </a>检查 Bundler 文件中的不良做法(如<code class="fe mq mr ms mh b">Gemfile</code>)。</li><li id="7380" class="ni nj in jm b jn nr jr ns jv nt jz nu kd nv kh nn no np nq bi translated"><a class="ae mz" href="https://docs.rubocop.org/rubocop/1.18/cops_gemspec.html" rel="noopener ugc nofollow" target="_blank"> Gemspec cops </a>检查<code class="fe mq mr ms mh b">.gemspec</code>文件中的不良行为。</li></ul><p id="a3a4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">RuboCop 还可以用额外的 linters 和 formatters 进行扩展。您可以创建自己的扩展，或者使用与您的项目相关的现有扩展。例如，Rails 扩展可用于实施 Rails 最佳实践和编码约定。</p><p id="2af3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">当您第一次创建配置文件时，您会收到大量消息，通知您存在已添加但未配置的新 COP。这是因为 RuboCop 在每个版本中都添加了新的 cops，并且这些都被标记为待定，直到在用户配置中明确启用或禁用。您可以单独启用或禁用邮件中列出的每个 COP，或者使用下面的代码片段来启用所有新的 COP(推荐)。这些消息将被禁止。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="7988" class="ml la in mh b gy mm mn l mo mp"># .rubocop.yml<br/>AllCops:<br/>  NewCops: enable</span></pre><h1 id="9733" class="kz la in bd lb lc mu le lf lg mv li lj lk mw lm ln lo mx lq lr ls my lu lv lw bi translated">将 RuboCop 集成到现有项目中</h1><p id="3483" class="pw-post-body-paragraph jk jl in jm b jn lx jp jq jr ly jt ju jv lz jx jy jz ma kb kc kd mb kf kg kh ig bi translated">大多数 ruby 爱好者没有从头开始开发新项目的奢侈。我们的大部分开发时间都花在遗留代码库上，这可能会产生大量无法立即解决的林挺问题。幸运的是，RuboCop 包含了一个功能，可以生成一个现有罪行的允许列表，可以随着时间的推移逐步解决。这样做的好处是，您可以将林挺添加到现有的项目中，而不会受到堆积如山的无法管理的林挺错误的轰炸，同时还可以在出现任何新的违规时进行标记。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="59a4" class="ml la in mh b gy mm mn l mo mp">$ bundle exec rubocop<br/><br/>614 files inspected, 1248 offenses detected</span></pre><p id="277c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">可以使用以下命令创建 allowlist 配置文件:</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="ffa5" class="ml la in mh b gy mm mn l mo mp">$ bundle exec rubocop --auto-gen-config<br/>Added inheritance from `.rubocop_todo.yml` <strong class="mh io">in</strong> `.rubocop.yml`.<br/>Created .rubocop_todo.yml.</span></pre><p id="b0b0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><code class="fe mq mr ms mh b">— auto-gen-config</code>选项收集所有的违规和计数，并在当前目录中创建一个<code class="fe mq mr ms mh b">.rubocop_todo.yml</code>文件，该文件忽略当前所有的违规。最后，它导致<code class="fe mq mr ms mh b">.rubocop.yml</code>从<code class="fe mq mr ms mh b">.rubocop_todo.yml</code>继承，确保在代码库上运行 RuboCop 不会再次出错。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="c62e" class="ml la in mh b gy mm mn l mo mp">$ bundle exec rubocop<br/>614 files inspected, no offenses detected</span></pre><h1 id="1f69" class="kz la in bd lb lc mu le lf lg mv li lj lk mw lm ln lo mx lq lr ls my lu lv lw bi translated">解决现有违规问题</h1><p id="1207" class="pw-post-body-paragraph jk jl in jm b jn lx jp jq jr ly jt ju jv lz jx jy jz ma kb kc kd mb kf kg kh ig bi translated">在建立<code class="fe mq mr ms mh b">.rubocop_todo.yml</code>档案后，不要忽视任何现存的违规行为，并逐一解决它们，这一点至关重要。您可以通过从 cop 的 Exclude 块中删除一个文件，然后修复报告的违规，运行您的测试套件以避免引入错误，并提交。从副本中删除所有文件后，您可以手动从文件中删除副本或重新生成 allowlist 文件。记住尽可能使用<code class="fe mq mr ms mh b">— auto-correct</code>选项来加快进程。</p><h1 id="aae3" class="kz la in bd lb lc mu le lf lg mv li lj lk mw lm ln lo mx lq lr ls my lu lv lw bi translated">消除林挺误差</h1><p id="18b9" class="pw-post-body-paragraph jk jl in jm b jn lx jp jq jr ly jt ju jv lz jx jy jz ma kb kc kd mb kf kg kh ig bi translated">尽管 RuboCop 是一个非常棒的工具，但它偶尔会产生误报，或者建议以不利于程序员意图的方式修复代码。发生这种情况时，您可以通过在源代码中添加注释来忽略这种违反。您可以指定应禁用哪些警察或部门，如下所示:</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="99dd" class="ml la in mh b gy mm mn l mo mp"># rubocop:disable Layout/LineLength, Style<br/>[..]<br/># rubocop:enable Layout/LineLength, Style</span></pre><p id="1515" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">您还可以一次禁用一段代码的所有 COP:</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="b5a1" class="ml la in mh b gy mm mn l mo mp"># rubocop:disable all<br/>[..]<br/># rubocop:enable all</span></pre><p id="8215" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">当您使用行尾注释时，指定的 COP 仅在该行被禁用:</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="34af" class="ml la in mh b gy mm mn l mo mp"><strong class="mh io">for</strong> x <strong class="mh io">in</strong> (<strong class="mh io">0</strong>..<strong class="mh io">10</strong>) # rubocop:disable Style/For</span></pre><p id="3ea1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">当您在编辑器中键入代码时，可以方便地看到 RuboCop 生成的警告和错误，而不必每次都通过命令行运行检查。幸运的是，RuboCop 集成在大多数流行的代码编辑器和 ide 中都是可用的，主要是通过第三方插件。在 Visual Studio 代码中，您需要做的就是安装这个<a class="ae mz" href="https://marketplace.visualstudio.com/items?itemName=rebornix.Ruby" rel="noopener ugc nofollow" target="_blank"> Ruby 扩展</a>，并将以下内容添加到您的用户<code class="fe mq mr ms mh b">settings.json</code>文档中:</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="5cd2" class="ml la in mh b gy mm mn l mo mp">{<br/>  <strong class="mh io">"ruby.lint"</strong>: {<br/>    <strong class="mh io">"rubocop"</strong>: <strong class="mh io">true</strong><br/>  }<br/>}</span></pre><h1 id="2b6c" class="kz la in bd lb lc mu le lf lg mv li lj lk mw lm ln lo mx lq lr ls my lu lv lw bi translated">结论</h1><p id="a673" class="pw-post-body-paragraph jk jl in jm b jn lx jp jq jr ly jt ju jv lz jx jy jz ma kb kc kd mb kf kg kh ig bi translated">林挺和自动格式化代码对于代码库来说有很多优势，特别是在开发团队的环境中。即使你不喜欢被告知如何格式化你的代码，记住林挺不仅仅是你的。这也是为了与您合作的其他人，以便每个人都遵循相同的约定，避免在同一个项目中处理多种编码风格的缺点。</p><p id="2403" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">同样重要的是，不要把 linter 的输出当成真理，所以要在不偏离你的主要目标的情况下，以一种给你最大好处的方式来配置它。以 RuboCop 丰富的配置选项，这应该不是问题。</p></div></div>    
</body>
</html>