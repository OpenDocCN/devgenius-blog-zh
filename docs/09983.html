<html>
<head>
<title>Streaming data from GCP PubSub to BigQuery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从 GCP 发布订阅到 BigQuery 的流数据</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/streaming-data-from-gcp-pubsub-to-bigquery-2dd914ed1e2c?source=collection_archive---------2-----------------------#2022-09-27">https://blog.devgenius.io/streaming-data-from-gcp-pubsub-to-bigquery-2dd914ed1e2c?source=collection_archive---------2-----------------------#2022-09-27</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="352f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">谷歌最近推出了一种新的订阅类型<strong class="jm io"> <em class="ki"> BigQuery 订阅</em> </strong>，使用它 PubSub 可以直接与 BigQuery 集成。这在以前是通过编写一个数据流作为中间件应用程序来实现的。</p><p id="1aff" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在我们详细讨论如何做到这一点之前。让我给你快速浏览一下这些服务是什么。</p><h2 id="94f9" class="kj kk in bd kl km kn dn ko kp kq dp kr jv ks kt ku jz kv kw kx kd ky kz la lb bi translated">谷歌发布订阅</h2><p id="9560" class="pw-post-body-paragraph jk jl in jm b jn lc jp jq jr ld jt ju jv le jx jy jz lf kb kc kd lg kf kg kh ig bi translated">顾名思义，它是 Google 基于发布订阅设计模式提供的托管服务。它广泛用于应用程序之间的异步通信。谷歌内部在 Gmail 等产品中使用这项服务，每秒发送数百万封邮件。</p><h2 id="1227" class="kj kk in bd kl km kn dn ko kp kq dp kr jv ks kt ku jz kv kw kx kd ky kz la lb bi translated"><strong class="ak"> BigQuery </strong></h2><p id="1396" class="pw-post-body-paragraph jk jl in jm b jn lc jp jq jr ld jt ju jv le jx jy jz lf kb kc kd lg kf kg kh ig bi translated">这是一个由 Google 提供的无服务器且高度可扩展的数据仓库服务。它可以轻松处理数 Pb 的数据，在几秒钟内获得分析和业务关键信息。</p><h2 id="c652" class="kj kk in bd kl km kn dn ko kp kq dp kr jv ks kt ku jz kv kw kx kd ky kz la lb bi translated">数据流</h2><p id="938a" class="pw-post-body-paragraph jk jl in jm b jn lc jp jq jr ld jt ju jv le jx jy jz lf kb kc kd lg kf kg kh ig bi translated">Google cloud dataflow 是一个完全托管的数据处理服务，用于使用 Apache Beam 编写的批处理和实时数据流管道。由于其并行处理数据的设计，可以在几秒钟内处理大量数据。</p><p id="a6d1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">为了了解更多关于这些服务的信息，你可以参考 google 文档。</p></div><div class="ab cl lh li hr lj" role="separator"><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm"/></div><div class="ig ih ii ij ik"><p id="4037" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">2022 年 7 月 25 日<em class="ki"/>谷歌宣布了一项新功能，PubSub 可以使用<strong class="jm io"> <em class="ki"> BigQuery 订阅直接将消息写入 BigQuery 表。</em>T11】</strong></p><p id="93f1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这在以下场景中很方便</p><ul class=""><li id="0029" class="lo lp in jm b jn jo jr js jv lq jz lr kd ls kh lt lu lv lw bi translated">将数据写入 BigQuery 以生成分析指标(例如，在电子商务网站上发送使用数据)</li><li id="f189" class="lo lp in jm b jn lx jr ly jv lz jz ma kd mb kh lt lu lv lw bi translated">将日志异步导出到 BigQuery。</li></ul><p id="2839" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">以下是完成设置的步骤。</p><ol class=""><li id="0830" class="lo lp in jm b jn jo jr js jv lq jz lr kd ls kh mc lu lv lw bi translated">创建一个包含/不包含表示 pubSub 消息元数据的字段的 BigQuery 表。</li><li id="c82c" class="lo lp in jm b jn lx jr ly jv lz jz ma kd mb kh mc lu lv lw bi translated">创建一个与第一步中创建的 BigQuery 表的模式相同的 PubSub 模式。</li><li id="874d" class="lo lp in jm b jn lx jr ly jv lz jz ma kd mb kh mc lu lv lw bi translated">使用步骤 2 中创建的模式创建一个 PubSub 主题。</li><li id="b756" class="lo lp in jm b jn lx jr ly jv lz jz ma kd mb kh mc lu lv lw bi translated">更新 pubSub 服务帐户。</li><li id="28f3" class="lo lp in jm b jn lx jr ly jv lz jz ma kd mb kh mc lu lv lw bi translated">创建发布订阅订阅。</li></ol><p id="4334" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">为了深入理解这一点，让我们考虑一个例子。想象一下，一个电子商务网站想要了解哪种产品在其用户中受欢迎。对于这个用例，每当用户点击一个特定的产品时，它就向主题发布一个事件。然后，它可以分析 BigQuery 中的数据，或者创建一个仪表板来了解其产品的统计数据。</p><h2 id="786c" class="kj kk in bd kl km kn dn ko kp kq dp kr jv ks kt ku jz kv kw kx kd ky kz la lb bi translated">步骤 1:创建一个大查询表</h2><p id="66f2" class="pw-post-body-paragraph jk jl in jm b jn lc jp jq jr ld jt ju jv le jx jy jz lf kb kc kd lg kf kg kh ig bi translated">Google 利用 PubSub 模式定义和 BigQuery 表定义来映射这两个服务之间的数据。BigQuery 表需要定义为每一列都具有与 PubSub 模式字段相同的名称和兼容的数据类型。</p><p id="0d7d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在我们的示例中，我们创建了一个具有以下属性的表。</p><ol class=""><li id="0553" class="lo lp in jm b jn jo jr js jv lq jz lr kd ls kh mc lu lv lw bi translated">user_id:这是点击产品页面的客户。</li><li id="aa09" class="lo lp in jm b jn lx jr ly jv lz jz ma kd mb kh mc lu lv lw bi translated">product_id:标识电子商务网站上的产品</li><li id="e1d4" class="lo lp in jm b jn lx jr ly jv lz jz ma kd mb kh mc lu lv lw bi translated">region_id:客户所属的位置。</li></ol><p id="efc7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">除了上述三个属性，我们还可以将消息元数据保存在 BigQuery 表中创建的附加列中。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi md"><img src="../Images/62cd8fe4b4e84ac50d326f8d54a4e6d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uNWoAnr6z3f5HXKUetH50w.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">BigQuery 表架构</figcaption></figure><p id="3086" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在快照中，我们可以看到除了上面提到的三列之外还有其他列。这些列表示消息的元数据。捕获元数据有它自己的好处。例如，由于 PubSub 的<em class="ki">至少一次交付</em>属性，它可能会发送重复的消息，这将在 BigQuery 中创建重复的记录，可以使用<strong class="jm io"> message_id </strong>列来标识这些记录。</p><p id="0661" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">还要注意，所有附加列都应该具有可空模式。此外，当您启用将元数据从邮件写入这些列的选项时，您不能拥有部分列。BigQuery 表中需要有全部 5 列。</p><h2 id="461f" class="kj kk in bd kl km kn dn ko kp kq dp kr jv ks kt ku jz kv kw kx kd ky kz la lb bi translated">步骤 2:创建发布订阅模式</h2><p id="a446" class="pw-post-body-paragraph jk jl in jm b jn lc jp jq jr ld jt ju jv le jx jy jz lf kb kc kd lg kf kg kh ig bi translated">PubSub 模式是以 Apache Avro 或协议缓冲区格式定义的。该架构不应包含任何表示 PubSub 消息元数据的字段。您希望与 BigQuery 集成的字段必须具有相同的名称，并且其数据类型应该兼容。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi mt"><img src="../Images/1cb12b49f3e7eed2effe5799f6daf36e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ktI53CXkp4hrZEkSIHaJOw.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">主题图式</figcaption></figure><p id="6384" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在我们的例子中，模式非常简单，只有我们为 BigQuery 表定义的 3 个字段。如果模式中存在表中没有的其他字段，可以使用 BigQuery 订阅属性<strong class="jm io"> Drop unknown fields </strong>删除这些字段。</p><h2 id="6c3d" class="kj kk in bd kl km kn dn ko kp kq dp kr jv ks kt ku jz kv kw kx kd ky kz la lb bi translated">步骤 3:创建发布订阅主题</h2><figure class="me mf mg mh gt mi gh gi paragraph-image"><div class="gh gi mu"><img src="../Images/98456e11211ce45633ed3add68147cad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1022/format:webp/1*ZwQWdtWRh8_XNFzvThIseQ.png"/></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">话题创作</figcaption></figure><p id="1a90" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在这一步中，我们使用选项<strong class="jm io">使用模式</strong>创建一个主题。我们选择在步骤 2 中创建的模式。</p><blockquote class="mv mw mx"><p id="1444" class="jk jl ki jm b jn jo jp jq jr js jt ju my jw jx jy mz ka kb kc na ke kf kg kh ig bi translated">注意:不要勾选<strong class="jm io">添加默认订阅</strong>。我们将在步骤 5 中创建订阅。</p></blockquote><h2 id="31f3" class="kj kk in bd kl km kn dn ko kp kq dp kr jv ks kt ku jz kv kw kx kd ky kz la lb bi translated">步骤 4:更新 PubSub 服务帐户</h2><p id="fdbb" class="pw-post-body-paragraph jk jl in jm b jn lc jp jq jr ld jt ju jv le jx jy jz lf kb kc kd lg kf kg kh ig bi translated">PubSub 为每个项目创建并管理一个服务帐户。PubSub 服务帐户需要访问 BigQuery 表和读取表元数据。</p><p id="3620" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">需要将以下角色添加到服务帐户中。</p><ol class=""><li id="8a58" class="lo lp in jm b jn jo jr js jv lq jz lr kd ls kh mc lu lv lw bi translated">BigQuery 数据编辑器(roles/bigquery.dataEditor)</li><li id="f954" class="lo lp in jm b jn lx jr ly jv lz jz ma kd mb kh mc lu lv lw bi translated">BigQuery 元数据查看器(roles/bigquery.metadataViewer)</li></ol><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi nb"><img src="../Images/b57e5908c78498bbdfb3ad4a1883a0c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2IsEpH5y16QnZZiljx8JQg.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">发布订阅服务帐户权限</figcaption></figure><h2 id="6cc8" class="kj kk in bd kl km kn dn ko kp kq dp kr jv ks kt ku jz kv kw kx kd ky kz la lb bi translated">步骤 5:创建发布订阅订阅</h2><p id="e71f" class="pw-post-body-paragraph jk jl in jm b jn lc jp jq jr ld jt ju jv le jx jy jz lf kb kc kd lg kf kg kh ig bi translated">在这最后一步，我们需要确保连接所有的点。只有准确创建了 BigQuery 表和 PubSub 架构，才能成功创建 PubSub 订阅。此外，如果服务帐户没有写权限，订阅将在创建时引发异常。</p><p id="d3df" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">创建订阅时，我们需要了解三个重要的属性。</p><ul class=""><li id="e17f" class="lo lp in jm b jn jo jr js jv lq jz lr kd ls kh lt lu lv lw bi translated">使用主题模式:启用该选项时，PubSub 将 PubSub 模式字段映射到 BigQuery 列。如果未启用此选项，PubSub 会将整个消息写入数据类型为<strong class="jm io">字节或字符串的 BigQuery 列<strong class="jm io">数据</strong>。</strong></li><li id="22e3" class="lo lp in jm b jn lx jr ly jv lz jz ma kd mb kh lt lu lv lw bi translated">写入元数据:这个选项使 PubSub 能够将元数据写入我们在步骤 1 中看到的附加字段。</li><li id="3b85" class="lo lp in jm b jn lx jr ly jv lz jz ma kd mb kh lt lu lv lw bi translated">删除未知字段:此选项与使用主题模式选项一起使用。如果启用，让 PubSub 删除出现在主题模式中但不在 BigQuery 表中的任何字段。如果没有此选项，带有额外字段的消息将不会写入表中，而是保留在预订积压中。</li></ul><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi nc"><img src="../Images/f4fd6b9d2753bdcf0aa06420b1162280.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zg3bKlAw6g05wrEusolQtQ.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">发布订阅订阅</figcaption></figure><p id="811a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">上面的快照显示了在 BigQuery 订阅的情况下我们需要设置的要点。其他所有设置都可以根据自己的选择来设置。</p><blockquote class="mv mw mx"><p id="b8a0" class="jk jl ki jm b jn jo jp jq jr js jt ju my jw jx jy mz ka kb kc na ke kf kg kh ig bi translated">注意:当 PubSub 消息无法写入 BigQuery 时，它将保持未确认状态，可以通过配置死信主题来处理。</p></blockquote><p id="91ce" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在我们已经万事俱备了。因此，如果您尝试在 PubSub 上发布一条消息，您应该立即看到一条新记录被添加到您的 BigQuery 表中。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi nd"><img src="../Images/268d20ff64ba29e9100173a63d3bb116.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N7qDcBIq1Js0jgWEl780gA.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">发布消息</figcaption></figure><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi ne"><img src="../Images/82147bfeeb1cf6193465b2c552487d7b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wKNFM7stJ69-JEBDDWKB9w.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">在 BigQuery 中预览数据</figcaption></figure><p id="1ce5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这使得应用程序出于分析目的在 BigQuery 中转储数据变得非常容易。</p><p id="d363" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们还可以使用 DataStudio 在这些数据的基础上进一步创建仪表板，以获得整体视图。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi nf"><img src="../Images/66f165abf91b53d7222f1aa9bf8e255d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VOQrV2rF7hV0XHTsk0kQKg.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">DataStudio 仪表板</figcaption></figure><blockquote class="mv mw mx"><p id="3f38" class="jk jl ki jm b jn jo jp jq jr js jt ju my jw jx jy mz ka kb kc na ke kf kg kh ig bi translated">我希望这有助于理解如何利用这种设计。一定要让我知道你认为这适合的用例。你可以在 https://cloud.google.com/pubsub/docs/bigquery 找到更多相关信息</p></blockquote></div></div>    
</body>
</html>