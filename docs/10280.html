<html>
<head>
<title>Change Data Capture using Snowflake Streams</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用雪花流更改数据捕获</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/change-data-capture-using-snowflake-streams-54a58e1839d3?source=collection_archive---------2-----------------------#2022-10-20">https://blog.devgenius.io/change-data-capture-using-snowflake-streams-54a58e1839d3?source=collection_archive---------2-----------------------#2022-10-20</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="a70b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">感谢您阅读我之前的博客，我们将了解更多关于使用雪花流在雪花中实现渐变维度或更改数据捕获的内容。如果你想了解更多关于变更数据捕获(CDC)的信息，你可以在这里阅读更多信息—<a class="ae ki" rel="noopener ugc nofollow" target="_blank" href="/change-data-capture-in-dwbi-etl-elt-implementations-af08b54d8fb5">https://blog . dev genius . io/Change-Data-Capture-in-dwbi-ETL-ELT-implementations-af 08 b 54d 8 FB 5</a></p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/067cedab6f643fb288e3e911f418d167.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kuGhQXnhTFl-rcPiQB7Bcg.png"/></div></div></figure><p id="79aa" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让我们在一些常见问题的帮助下，开始了解更多关于雪花流的知识</p><p id="5be6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">什么是溪流？</strong></p><p id="3ed3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">流是雪花对象，我们可以在另一个雪花对象——表上创建、修改或删除它。我们可以在任何表上创建流，比如标准表、目录表、外部表以及视图中的底层表。我们可以在想要跟踪缓慢变化的维度或 CDC 的表的顶部创建流。</p><p id="0026" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">Stream 是如何工作的？</strong></p><p id="eada" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">一旦我们在任何表上创建了流，它就会跟踪该表上的任何 DML 更改。这个对象跟踪源表中发生的任何插入、更新或删除，并在流中列出操作。</p><p id="5647" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">Stream 如何捕捉变化？</strong></p><p id="9fd1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">一旦在任何表的顶部定义了流，它就创建一个表的时间点快照作为表的当前事务版本。流将更改与快照版本进行比较，识别对源表所做的更改，并记录到流中。</p><p id="ce83" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">流中捕获的是什么？</strong></p><p id="3b0a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">正如我们现在所知道的，stream 跟踪、比较和记录对源对象的任何事务或 DML 更改。这些更改被记录到在该表之上创建的流中。Stream 以列、修改的行及其动作状态(在其中一个元数据列中插入/更新或删除)的前后阶段的形式存储信息。流不保存任何表数据，但是它只保存更改的日志数据。</p><p id="c923" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">流的格式是什么？它是否有任何用于记录或跟踪更改的列？</strong></p><p id="2b6a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">Stream 不存储任何表数据，但是它的结构类似于一个表，其中包含来自源表的所有列，并添加了以下元数据相关列</p><p id="79d2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">METADATA$ACTION —指示记录的 DML 操作(插入、删除)。</p><p id="b8f8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">METADATA $ ISUPDATE 指示操作是否是 UPDATE 语句的一部分。对源对象中行的更新表示为流中的一对删除和插入记录，元数据列 METADATA $ ISUPDATE 值设置为 TRUE。</p><p id="91e1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">METADATA$ROW_ID —为行指定唯一且不可变的 ID，可用于跟踪特定行随时间的变化。</p><p id="af9b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">流的类型有哪些？</strong></p><p id="b709" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">流也可以以不同的类型完成，如下所示</p><p id="764a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">1.<strong class="jm io">仅插入:</strong>这仅支持外部表格。该流跟踪插入操作的行。这不会捕获任何删除操作。</p><p id="956d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">2.<strong class="jm io">仅追加:</strong>标准表、目录表或视图支持。这将跟踪插入的行。这些类型的流不会跟踪更新、删除或任何截断操作</p><p id="ac64" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">3.<strong class="jm io">标准</strong>:支持—标准表、目录表或视图。因为这是标准流，所以它跟踪源对象上所有类型的 DML，如插入、更新或删除。</p><p id="8706" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">我们可以使用 Streams 跟踪地理空间数据的 CDC 吗？</strong></p><p id="5a07" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">是的，我们可以使用流来跟踪 CDC，但是我们不能为地理空间数据创建标准流，尽管地理空间数据的 CDC 可以使用仅附加流来完成。</p><p id="31c9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">流可以跟踪多长时间的数据？维护的变更日志是否有效？</strong></p><p id="4e4f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">流数据可能是陈旧的，这取决于源表的数据保持期。这不适用于外部表或目录表，因为这些表没有数据保留策略。如果源表有 14 天的数据保留期，那么流也可以保存长达 14 天的更改日志。如果更改日志数据在 14 天内未被使用，则数据会延长至最多 14 天，以确保更改日志的使用，并避免从流中遗漏或删除更改日志。</p><p id="1af3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">如何才能创建流？</strong></p><p id="7f4b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">可以使用 DDL 语句创建流。我们可以使用下面一组 DDL 创建或改变流。让我们创建一个示例表作为源表来创建流–</p><pre class="kk kl km kn gt kv kw kx ky aw kz bi"><span id="4963" class="la lb in kw b gy lc ld l le lf"><em class="lg">-- Create a table to store the names and fees paid by members of a gym</em><br/>create or replace table members (<br/>  id number(8) not null,<br/>  name varchar(255) default null,<br/>  fee number(3) null<br/>);<br/><br/><em class="lg">-- Create a stream to track changes to date in the MEMBERS table</em><br/>create or replace stream member_check on table members;</span></pre><p id="948c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这里，member_check 是在源表成员上创建的流。每当在源表上运行任何 DML 更改时，stream-member _ check 都会捕获它们。</p><p id="c919" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">我们如何使用流来使用修订？</strong></p><p id="621d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在，我们有了一个源表—成员和一个定义的流— members_check。让我们创建另一个表，并对源表 members 和 signup 运行几个 insert 语句。</p><pre class="kk kl km kn gt kv kw kx ky aw kz bi"><span id="482a" class="la lb in kw b gy lc ld l le lf">create or replace table signup (<br/>  id number(8),<br/>  dt date<br/>  );<br/><br/>insert into members (id,name,fee)<br/>values<br/>(1,'Joe',0),<br/>(2,'Jane',0),<br/>(3,'George',0),<br/>(4,'Betty',0),<br/>(5,'Sally',0);<br/><br/>insert into signup<br/>values<br/>(1,'2018-01-01'),<br/>(2,'2018-02-15'),<br/>(3,'2018-05-01'),<br/>(4,'2018-07-16'),<br/>(5,'2018-08-21');</span></pre><p id="320f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在，让我们看看流是如何记录对 members-source 表所做的更改的。</p><pre class="kk kl km kn gt kv kw kx ky aw kz bi"><span id="f046" class="la lb in kw b gy lc ld l le lf">select * from member_check;<br/><br/>+----+--------+-----+-----------------+-------------------+------------------------------------------+<br/>| ID | NAME   | FEE | METADATA$ACTION | METADATA$ISUPDATE | METADATA$ROW_ID                          |<br/>|----+--------+-----+-----------------+-------------------+------------------------------------------|<br/>|  1 | Joe    |   0 | INSERT          | False             | d200504bf3049a7d515214408d9a804fd03b46cd |<br/>|  2 | Jane   |   0 | INSERT          | False             | d0a551cecbee0f9ad2b8a9e81bcc33b15a525a1e |<br/>|  3 | George |   0 | INSERT          | False             | b98ad609fffdd6f00369485a896c52ca93b92b1f |<br/>|  4 | Betty  |   0 | INSERT          | False             | e554e6e68293a51d8e69d68e9b6be991453cc901 |<br/>|  5 | Sally  |   0 | INSERT          | False             | c94366cf8a4270cf299b049af68a04401c13976d |<br/>+----+--------+-----+-----------------+-------------------+------------------------------------------+</span></pre><p id="01a9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">我们如何使用来自流的更改日志数据并将其应用到目标表？</strong></p><p id="a6e9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">正如我们所见，members_check 是一个流，它具有与源表相同的列/DDL 以及 4 个元数据列。我们可以基于元数据操作列应用更改。让我们看一个使用 members、signup 和 members_check 的示例。让我们考虑我们有 30 天的免费试用，然后提供每月 90 美元的费用。我们需要考虑的成员和注册细节以及最新的数据插入从成员 _ 检查和计算费用在目标表列日志。我们可以如下使用 sql</p><pre class="kk kl km kn gt kv kw kx ky aw kz bi"><span id="1d04" class="la lb in kw b gy lc ld l le lf">merge into members m</span><span id="8d58" class="la lb in kw b gy lh ld l le lf">using (</span><span id="b01d" class="la lb in kw b gy lh ld l le lf">select id, dt</span><span id="daf2" class="la lb in kw b gy lh ld l le lf">from signup s</span><span id="f7b8" class="la lb in kw b gy lh ld l le lf">where datediff(day, '2018-08-15'::date, s.dt::date) &lt; -30) s</span><span id="97a6" class="la lb in kw b gy lh ld l le lf">on m.id = s.id</span><span id="499b" class="la lb in kw b gy lh ld l le lf">when matched then update set m.fee = 90;</span></pre><p id="6974" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">一旦我们运行这个 SQL，目标表就会得到更新。让我们看看成员表中的记录–</p><pre class="kk kl km kn gt kv kw kx ky aw kz bi"><span id="c601" class="la lb in kw b gy lc ld l le lf">select * from members;</span><span id="68a7" class="la lb in kw b gy lh ld l le lf">+----+--------+-----+</span><span id="ecdc" class="la lb in kw b gy lh ld l le lf">| ID | NAME   | FEE |</span><span id="e264" class="la lb in kw b gy lh ld l le lf">|----+--------+-----|</span><span id="6a91" class="la lb in kw b gy lh ld l le lf">|  1 | Joe    |  90 |</span><span id="71aa" class="la lb in kw b gy lh ld l le lf">|  2 | Jane   |  90 |</span><span id="fc4e" class="la lb in kw b gy lh ld l le lf">|  3 | George |  90 |</span><span id="6021" class="la lb in kw b gy lh ld l le lf">|  4 | Betty  |   0 |</span><span id="e103" class="la lb in kw b gy lh ld l le lf">|  5 | Sally  |   0 |</span><span id="3274" class="la lb in kw b gy lh ld l le lf">+----+--------+-----+</span></pre><p id="45c1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">使用 MERGE 语句，我们可以很容易地从流中捕获变化并应用到目标表。我们也可以使用相同的流逻辑和 MERGE 语句实现 SCD 类型 II。</p><p id="5b36" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我希望这篇博客将有助于理解流和流的实现，以从源表捕获变化，并将它们应用到目标表。我们还可以自动化该过程，并近乎实时地将更改捕获到目标表中。自动化可以使用雪花任务来完成。</p><blockquote class="li lj lk"><p id="d13a" class="jk jl lg jm b jn jo jp jq jr js jt ju ll jw jx jy lm ka kb kc ln ke kf kg kh ig bi translated">关于我:</p><p id="5abd" class="jk jl lg jm b jn jo jp jq jr js jt ju ll jw jx jy lm ka kb kc ln ke kf kg kh ig bi translated">我是 DWBI 和云建筑师！我目前在雪花公司的 GCP 担任高级数据架构师。我一直在处理各种遗留数据仓库、大数据实施、云平台/迁移。我是 SnowPro 核心认证数据架构师，也是 Google 认证的 Google 专业云架构师。您可以联系我<a class="ae ki" href="https://www.linkedin.com/in/poojakelgaonkar/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>如果您在认证、数据解决方案和实施方面需要任何进一步的帮助！</p></blockquote></div></div>    
</body>
</html>