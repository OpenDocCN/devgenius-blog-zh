<html>
<head>
<title>From utf8 to utf8mb4 in MySQL 5.7 with Django</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用 Django 在 MySQL 5.7 中从 utf8 到 utf8mb4</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/nc-django-mysql-migrating-from-utf8-to-utf8mb4-9d8b2753e632?source=collection_archive---------7-----------------------#2022-10-31">https://blog.devgenius.io/nc-django-mysql-migrating-from-utf8-to-utf8mb4-9d8b2753e632?source=collection_archive---------7-----------------------#2022-10-31</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><figure class="im in gp gr io ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi il"><img src="../Images/eb8175331b4bee91d7335be51b7a980b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NV8nWHIA7zWGS4-IXlBMHA.png"/></div></div></figure><div class=""/></div><div class="ab cl jv jw hr jx" role="separator"><span class="jy bw bk jz ka kb"/><span class="jy bw bk jz ka kb"/><span class="jy bw bk jz ka"/></div><div class="ig ih ii ij ik"><p id="749e" class="pw-post-body-paragraph kc kd iy ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ig bi translated">不知道 MySQL 5.7 默认对 UTF-8 字符有 3 字节的限制吗？我也没有。但是确实如此，如果你使用 MySQL，这就是一个问题。这篇文章将向您展示如何在不中断 Django 应用程序的情况下，自动将数据库从 utf8 迁移到 utf8mb4。</p><h1 id="e671" class="la lb iy bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">为什么这是一个问题？</h1><p id="332d" class="pw-post-body-paragraph kc kd iy ke b kf ly kh ki kj lz kl km kn ma kp kq kr mb kt ku kv mc kx ky kz ig bi translated">我不会深入细节，但简短的版本是:</p><ol class=""><li id="331e" class="md me iy ke b kf kg kj kk kn mf kr mg kv mh kz mi mj mk ml bi translated">MySQL 的 utf8 编码不是 UTF 8，所以当用户试图保存一个 4 字节的字符，比如表情符号🙃，您将开始得到如下错误:</li></ol><pre class="mm mn mo mp gt mq mr ms mt aw mu bi"><span id="4fb5" class="mv lb iy mr b gy mw mx l my mz">django.db.utils.OperationalError: (1366, “Incorrect string value: ‘\\xF0\\x9F\\x99\\x83’ for column ‘name’ at row 1”)</span></pre><p id="1922" class="pw-post-body-paragraph kc kd iy ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ig bi translated">2.MySQL 5.7 将于 2023 年 10 月寿终正寝，其默认编码是 utf8，而 MySQL 8 的默认编码现在是 utf8mb4。所以最终您还是会想迁移到 utf8mb4 或者跨表使用一堆不匹配的字符集。</p><p id="a653" class="pw-post-body-paragraph kc kd iy ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ig bi translated">如果你对<em class="na">为什么</em>感兴趣，这两篇文章做得很好:</p><ul class=""><li id="c79b" class="md me iy ke b kf kg kj kk kn mf kr mg kv mh kz nb mj mk ml bi translated"><a class="ae nc" href="https://saveriomiroddi.github.io/An-in-depth-dbas-guide-to-migrating-a-mysql-database-from-the-utf8-to-the-utf8mb4-charset/" rel="noopener ugc nofollow" target="_blank">DBA 关于将 MySQL 数据库从‘utf8’迁移到‘utf8mb 4’字符集的深入指南</a></li><li id="4344" class="md me iy ke b kf nd kj ne kn nf kr ng kv nh kz nb mj mk ml bi translated"><a class="ae nc" href="https://mathiasbynens.be/notes/mysql-utf8mb4" rel="noopener ugc nofollow" target="_blank">如何在 MySQL 数据库中支持完整 Unicode</a></li></ul><h1 id="85a2" class="la lb iy bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">怎么修？</h1><p id="f998" class="pw-post-body-paragraph kc kd iy ke b kf ly kh ki kj lz kl km kn ma kp kq kr mb kt ku kv mc kx ky kz ig bi translated"><strong class="ke iz">第一步:安全第一<br/> </strong>使用牛逼的<a class="ae nc" href="https://github.com/jazzband/django-dbbackup" rel="noopener ugc nofollow" target="_blank"> django-dbbackup </a>应用程序或使用<strong class="ke iz"> mysqldump </strong>创建备份，如下所示:</p><figure class="mm mn mo mp gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi ni"><img src="../Images/c65bc0f73065453f515571c2945137d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZuycOBJScD9YaZxL_nL7ZQ.png"/></div></div><figcaption class="nj nk gj gh gi nl nm bd b be z dk translated">mysqldump 命令来备份数据库</figcaption></figure><p id="9697" class="pw-post-body-paragraph kc kd iy ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ig bi translated"><strong class="ke iz">步骤 2:更新你的 Django 设置<br/> </strong>如果你还没有这样做，在你的<em class="na"> settings.py </em>中确保你使用 utf8mb4 作为默认编码。这告诉 MySQL 服务器，您的应用程序将向它发送 utf8mb4 编码的数据(而不是 utf8 默认值)。</p><figure class="mm mn mo mp gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi nn"><img src="../Images/14d82fbc417a336c68b6e7b588e5550d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NQjO0g7JLdvVB0u4VcOTSg.png"/></div></div><figcaption class="nj nk gj gh gi nl nm bd b be z dk translated">settings.py 中的数据库配置</figcaption></figure><p id="2999" class="pw-post-body-paragraph kc kd iy ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ig bi translated"><strong class="ke iz">步骤 3:更新你的数据库、表格和列，使用 utf8mb4 <br/> </strong>从历史上看，这是事情变得有点乏味的地方。在 MySQL 5.7 之前，您需要根据数据类型和最大长度为所有基于文本的列和索引创建自定义语句，如这里的<a class="ae nc" href="https://mathiasbynens.be/notes/mysql-utf8mb4" rel="noopener ugc nofollow" target="_blank">所述</a>。</p><p id="d25e" class="pw-post-body-paragraph kc kd iy ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ig bi translated">幸运的是，从 MySQL 5.7 开始，事情变得简单了一些，我在下面提供了一个方便的脚本来帮你做这件事。它是这样工作的:</p><p id="18dd" class="pw-post-body-paragraph kc kd iy ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ig bi translated">首先，它将数据库的默认字符集和排序规则分别更改为 utf8mb4 和 utf8mb4_unicode_ci。这告诉数据库应该使用 utf8mb4 作为所有新表的默认编码。</p><figure class="mm mn mo mp gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi no"><img src="../Images/949ed30811dcb41fa3601880b5f7e336.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ii1jPUhoLbFcbWJtzRIk5w.png"/></div></div><figcaption class="nj nk gj gh gi nl nm bd b be z dk translated">用于迁移数据库的 SQL</figcaption></figure><p id="b931" class="pw-post-body-paragraph kc kd iy ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ig bi translated">接下来，它更改所有现有的<strong class="ke iz">表</strong>的默认字符集和排序规则，然后对每个表运行<em class="na">分析+重新创建</em>。前者会自动将字符集和排序规则应用于所有现有的表格和基于文本的列/索引——根据需要调整大小——而后者只是<a class="ae nc" href="https://dev.mysql.com/doc/refman/5.7/en/analyze-table.html" rel="noopener ugc nofollow" target="_blank">的良好实践</a>。</p><figure class="mm mn mo mp gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi np"><img src="../Images/037d80db826b5db295b00abe9d9619c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lZ8J_hZ9WStGnOKEquidcA.png"/></div></div><figcaption class="nj nk gj gh gi nl nm bd b be z dk translated">SQL 来迁移数据库的表(和列)</figcaption></figure><h1 id="d31e" class="la lb iy bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">从 utf8 到 utf8mb4 的 Bash 脚本</h1><figure class="mm mn mo mp gt ip"><div class="bz fp l di"><div class="nq nr l"/></div></figure><figure class="mm mn mo mp gt ip"><div class="bz fp l di"><div class="nq nr l"/></div></figure></div></div>    
</body>
</html>