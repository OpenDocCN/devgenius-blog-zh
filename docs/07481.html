<html>
<head>
<title>How to work with QuerySets in Django</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在 Django 中使用 QuerySets</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/how-to-work-with-querysets-in-django-eb45fc9d6034?source=collection_archive---------1-----------------------#2022-03-29">https://blog.devgenius.io/how-to-work-with-querysets-in-django-eb45fc9d6034?source=collection_archive---------1-----------------------#2022-03-29</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/5008f23cbfc0204ceda0d7e7cc5958a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vwImbq-eRK9ZyL-_Ub6Z9w.png"/></div></div></figure><p id="1d43" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在前面的教程中，我们介绍了如何使用 admin Django 接口添加数据和修改数据。这一次，我们将介绍如何用 Python 代码和 Django QuerySet API 实现这一点。</p><p id="8162" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">因此，我们将做我们已经做过的事情，从上一个教程的地方继续。</p><p id="2422" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">一旦我们创建了数据模型，Django 会自动给我们一个数据库抽象 API，让我们创建、检索、更新和删除现有的对象。这是非常有用和节省时间的。</p><h1 id="d693" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">当前实施</h1><p id="3fcc" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">确保项目启动并运行，让我们通过检查我们的<strong class="jx io"> views.py </strong>文件和主应用程序目录中的<strong class="jx io"> IndexView </strong>类开始:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="4576" class="mf ku in mb b gy mg mh l mi mj"><strong class="mb io">class IndexView</strong>(TemplateView):<br/>    template_name = 'index.html'<br/><br/>    <strong class="mb io">def get_context_data</strong>(self, **kwargs):<br/>        context = super(IndexView, self).get_context_data(**kwargs)<br/>        context['blogposts'] = BlogPost.objects.all()<br/>        <strong class="mb io">return</strong> context</span></pre><p id="dc24" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们已经使用了 Django QuerySet API！是的，因为我们使用了 BlogPost.objects.all()，所以我们基本上是检索所有的 BlogPost 对象并将其保存到上下文中，这样我们就可以遍历模板文件中的所有对象。</p><p id="0c1a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们的查询集的一个改进示例:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="b11a" class="mf ku in mb b gy mg mh l mi mj">&gt;&gt;&gt; <strong class="mb io">BlogPost.objects.all</strong>().order_by("-created")[:25]</span></pre><p id="6caa" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们将按照创建日期获取所有 25 个降序对象。在<strong class="jx io">创造</strong>之前的字母正使它向相反的方向排序。Django 中的 QuerySets 是懒惰的，这意味着只有当您明确要求结果时，查询才会命中数据库。在实际使用查询结果之前，您可以在不访问数据库的情况下进一步过滤。</p><h1 id="52e0" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">姜戈壳牌公司</h1><p id="c78f" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">我们开始做一些查询吧！在 Django shell 中，我们可以测试我们的查询等等。因此，我们现在将重点使用它，同时尝试查询数据的不同选项。Django shell 基本上是 Python shell，但是我们可以访问 Django API。通过运行以下命令启动 shell:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="0930" class="mf ku in mb b gy mg mh l mi mj">python manage.py shell</span></pre><figure class="lw lx ly lz gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mk"><img src="../Images/377b61e5e1b2dee9937a1fc722a727f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AUKdpIlPwGolNckPbl5J-A.png"/></div></div></figure><p id="d923" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如果您不了解 Python shell，请查看如何使用它的教程。首先，让我们导入 BlogPost 模型，并尝试获取所有对象:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="98be" class="mf ku in mb b gy mg mh l mi mj">&gt;&gt;&gt; <strong class="mb io">from main.models import</strong> BlogPost<br/>&gt;&gt;&gt; <strong class="mb io">BlogPost.objects.all</strong>()</span></pre><figure class="lw lx ly lz gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mk"><img src="../Images/6f6392d6678cf00806d62b677d774c07.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*riGtkLQP1CemyHMeYgqjdg.png"/></div></div></figure><p id="d7a4" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这里我们用 QuerySet 得到了 BlogPost 对象。太好了，有用。</p><h1 id="826f" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">创建对象</h1><h2 id="6638" class="mf ku in bd kv ml mm dn kz mn mo dp ld kg mp mq lh kk mr ms ll ko mt mu lp mv bi translated">创建一个具有关系的对象</h2><p id="5bf9" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">让我们再添加两个对象，这样我们就有一些对象可以玩了。但是我们首先需要添加两个对象 BlogCategory 和 BlogTag，这样我们就可以将它们作为一个关系添加到 BlogPost 对象中，因为它会给我们一个错误，如果不是的话，因为它是强制的。</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="8bfb" class="mf ku in mb b gy mg mh l mi mj">&gt;&gt;&gt; <strong class="mb io">from main.models import</strong> BlogTag, BlogCategory, BlogPost<br/>&gt;&gt;&gt; bt = <strong class="mb io">BlogTag.objects.create</strong>(name="tech", created="20220329", updated="20220329")<br/>&gt;&gt;&gt; bc = <strong class="mb io">BlogCategory.objects.create</strong>(name="Django", created="20220329", updated="20220329")<br/>&gt;&gt;&gt; bp = <strong class="mb io">BlogPost.objects.create</strong>(title="Django is awesome!", text="Some sample text about how awesome Django is.", created="20220329", updated="20220329")<br/>&gt;&gt;&gt; <strong class="mb io">bp.tags.add</strong>(bt)<br/>&gt;&gt;&gt; <strong class="mb io">bp.categories.add</strong>(bc)</span></pre><figure class="lw lx ly lz gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mk"><img src="../Images/f002895cf1997de393637e1f70c72ec3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8edIgENSTuQ3879ZAQwQyA.png"/></div></div></figure><p id="8906" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们现在添加了一个带有关系的博客文章对象。</p><h2 id="f672" class="mf ku in bd kv ml mm dn kz mn mo dp ld kg mp mq lh kk mr ms ll ko mt mu lp mv bi translated">批量创建对象</h2><p id="159c" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">如果我们想批量创建许多对象，我们可以使用以下语法:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="5fba" class="mf ku in mb b gy mg mh l mi mj">&gt;&gt;&gt; bp = <strong class="mb io">BlogTag.objects.bulk_create</strong>([<br/>...   BlogTag(name="programming", created="20220329", updated="20220329"),<br/>...   BlogTag(name="crypto", created="20220329", updated="20220329"),<br/>...])</span></pre><h2 id="a06a" class="mf ku in bd kv ml mm dn kz mn mo dp ld kg mp mq lh kk mr ms ll ko mt mu lp mv bi translated">获取或创建对象</h2><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="4adc" class="mf ku in mb b gy mg mh l mi mj">&gt;&gt;&gt; obj, created = <strong class="mb io">BlogTag.objects.get_or_create</strong>(<br/>...    title="crypto",<br/>...    created="20220329",<br/>...    updated="20220329",<br/>...)</span></pre><p id="8b1f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">因此，如果对象不存在，这将创建该对象，如果存在，则只获取该对象。</p><h1 id="ec97" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">更新对象</h1><p id="6216" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">我们可以简单地使用以下命令来更新对象:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="7bd8" class="mf ku in mb b gy mg mh l mi mj">&gt;&gt;&gt; bp = <strong class="mb io">BlogPost.objects.get</strong>(id=10)<br/>&gt;&gt;&gt; bp.title = "New title"<br/>&gt;&gt;&gt; <strong class="mb io">bp.save</strong>()</span></pre><p id="27d9" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们还可以通过一些过滤同时更新许多不同的对象:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="5827" class="mf ku in mb b gy mg mh l mi mj">&gt;&gt;&gt; bp = <strong class="mb io">BlogPost.objects.filter</strong>(title__startswith="Django tutorial")<br/>&gt;&gt;&gt; <strong class="mb io">bp.update</strong>(title="Django Tutorial")</span></pre><p id="29ab" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这将更新所有以<strong class="jx io"> Django 教程</strong>开头的博客文章，并替换为<strong class="jx io"> Django 教程</strong>。非常整洁。</p><h1 id="1eed" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">过滤</h1><h2 id="86fd" class="mf ku in bd kv ml mm dn kz mn mo dp ld kg mp mq lh kk mr ms ll ko mt mu lp mv bi translated">基本过滤</h2><p id="ed01" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">过滤的工作原理听起来很明显，我们可以根据发送的给定参数过滤出结果。这可以链接在一起，因此如果我们想要对结果进行排序，我们可以在过滤后进行排序，例如:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="0a85" class="mf ku in mb b gy mg mh l mi mj">&gt;&gt;&gt; <strong class="mb io">BlogTag.objects</strong>.<strong class="mb io">filter</strong>(name__startswith="Django").order_by("name", "created")</span></pre><p id="b61b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">因此，我们可以同时进行筛选和排序，甚至将我们现在要讨论的 exclude 链接在一起。</p><h2 id="dd89" class="mf ku in bd kv ml mm dn kz mn mo dp ld kg mp mq lh kk mr ms ll ko mt mu lp mv bi translated">排除结果</h2><p id="aef0" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">我们也可以将某些内容排除在查询集之外，这样可以避免得到不需要的结果:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="1435" class="mf ku in mb b gy mg mh l mi mj">&gt;&gt;&gt; <strong class="mb io">BlogTag.objects.exclude</strong>(title__startswith="Unwanted", title__startswith="Spring Boot")</span></pre><h1 id="26dc" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">排序</h1><h2 id="6d3a" class="mf ku in bd kv ml mm dn kz mn mo dp ld kg mp mq lh kk mr ms ll ko mt mu lp mv bi translated">按一个或多个属性排序</h2><p id="4834" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">我们可以通过 order_by()方法对查询集进行排序:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="563e" class="mf ku in mb b gy mg mh l mi mj">&gt;&gt;&gt; <strong class="mb io">BlogTag.objects.order_by</strong>("name", "created").first()</span></pre><p id="04f2" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">然后我们按名称和创建日期排序，得到第一个。</p><h2 id="078c" class="mf ku in bd kv ml mm dn kz mn mo dp ld kg mp mq lh kk mr ms ll ko mt mu lp mv bi translated">反转 QuerySet 的顺序</h2><p id="244b" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">如果我们使用 reverse()方法，我们可以对查询集进行反向排序:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="d9ca" class="mf ku in mb b gy mg mh l mi mj">&gt;&gt;&gt; <strong class="mb io">BlogTag.objects.order_by</strong>("created").reverse()[:5]</span></pre><p id="8070" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在这里，我们将获得所有的博客标签，并按创建日期排序，然后我们得到最多 5 个博客标签的反向排序。</p><h2 id="7350" class="mf ku in bd kv ml mm dn kz mn mo dp ld kg mp mq lh kk mr ms ll ko mt mu lp mv bi translated">通过属性获取最新的对象</h2><p id="5afc" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">这将获取创建日期之前的最新对象:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="c335" class="mf ku in mb b gy mg mh l mi mj">&gt;&gt;&gt; <strong class="mb io">BlogTag.objects.latest</strong>("created")</span></pre><p id="4eed" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们也可以通过多个属性得到它:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="9189" class="mf ku in mb b gy mg mh l mi mj">&gt;&gt;&gt; <strong class="mb io">BlogTag.objects.latest</strong>("created", "-updated")</span></pre><p id="c396" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们还有一个方法<strong class="jx io"> earliest() </strong>，它的工作方式和 latest 一样，只是方向变了。</p><h1 id="dc9c" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">获取对象</h1><p id="5281" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">要获得一个对象，我们可以简单地使用:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="b63a" class="mf ku in mb b gy mg mh l mi mj">&gt;&gt;&gt; <strong class="mb io">BlogTag.object.get</strong>(id=10)</span></pre><h1 id="b381" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">删除对象</h1><p id="7b2f" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">我们可以简单地删除一个对象，比如:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="ef73" class="mf ku in mb b gy mg mh l mi mj">&gt;&gt;&gt; <strong class="mb io">BlogTag.objects.filter</strong>(id=id).delete()</span></pre><p id="00b1" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">删除连接到另一个对象的所有对象:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="c9f2" class="mf ku in mb b gy mg mh l mi mj"><strong class="mb io">&gt;&gt;&gt; </strong>b = <strong class="mb io">BlogPost.objects.get</strong>(id=1)<br/><strong class="mb io">&gt;&gt;&gt; BlogTag.objects.filter</strong>(blog=b).delete()</span></pre><p id="096c" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们也可以像这样删除多个对象:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="5d69" class="mf ku in mb b gy mg mh l mi mj"><strong class="mb io">&gt;&gt;&gt; </strong>bt = <strong class="mb io">BlogTag.objects.all</strong>()<br/><strong class="mb io">&gt;&gt;&gt; bt.delete</strong>()</span></pre><p id="b895" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在，通过以下方式退出 Django Shell:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="bf7a" class="mf ku in mb b gy mg mh l mi mj">exit()</span></pre><h1 id="119b" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">摘要</h1><p id="56b7" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">现在，您有望对如何在 Django 中使用 QuerySet API 有所了解。对于 Django QuerySets，我们还可以做更多的事情，但是我会做得很简短，让您浏览 Django 文档，如果您需要更具体的东西，这真的很好。</p><p id="9286" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">请务必在 LinkedIn 上关注我，了解更多即将推出的教程和其他相关内容:【https://www.linkedin.com/in/marcuscvjeticanin/<a class="ae mw" href="https://www.linkedin.com/in/marcuscvjeticanin/" rel="noopener ugc nofollow" target="_blank"/></p><h1 id="2cc5" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">参考</h1><ul class=""><li id="75e6" class="mx my in jx b jy lr kc ls kg mz kk na ko nb ks nc nd ne nf bi translated">【https://docs.djangoproject.com/en/dev/ref/models/querysets/ T4】</li><li id="3379" class="mx my in jx b jy ng kc nh kg ni kk nj ko nk ks nc nd ne nf bi translated"><a class="ae mw" href="https://docs.djangoproject.com/en/dev/topics/db/queries/" rel="noopener ugc nofollow" target="_blank">https://docs.djangoproject.com/en/dev/topics/db/queries/</a></li></ul></div></div>    
</body>
</html>