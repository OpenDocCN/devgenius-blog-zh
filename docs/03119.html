<html>
<head>
<title>Hyper-V and Windows Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Hyper-V和Windows Kubernetes</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/hyper-v-and-windows-kubernetes-6568461e7d02?source=collection_archive---------0-----------------------#2020-10-02">https://blog.devgenius.io/hyper-v-and-windows-kubernetes-6568461e7d02?source=collection_archive---------0-----------------------#2020-10-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/8cb5a4611db27dc23130bd87e11d2833.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*au_KgQ2ws80GinjDSWXpEA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">您可以在MacBook和bootcamp上创建带有Windows worker节点的混合Kubernetes集群！</figcaption></figure><p id="30c4" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi la translated">从Kubernetes 1.14开始，Windows worker node支持已经全面上市。尽管如此，还是做了很多改进来减少Linux Kubernetes worker node之间的差距。</p><p id="8404" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">依我看，在生产环境中使用Windows Kubernetes之前，有两个重要的问题需要解决。</p><ul class=""><li id="b4c1" class="lj lk iq ke b kf kg kj kk kn ll kr lm kv ln kz lo lp lq lr bi translated">Windows容器和Windows Kubernetes都依赖于主机网络服务(也称为HNS)提供的网络功能。当Kubernetes集群创建一个新服务时，Windows worker节点可以通过其本地负载平衡器将流量路由到服务，并且每个服务使用一个临时端口。不可避免的是，所有短暂的港口最终都会枯竭。这种行为将导致阻止进一步的连接使用。</li><li id="75c0" class="lj lk iq ke b kf ls kj lt kn lu kr lv kv lw kz lo lp lq lr bi translated">Windows容器不支持提升模式，所以管理员应该直接将<code class="fe lx ly lz ma b">kube-proxy</code>安装到worker节点中，而不是容器形式。此外，您应该正确配置所有网络参数。这种工作管理起来极其困难，每次都要手动升级Kubernetes worker节点。</li></ul><p id="a4ba" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">最后，Kubernetes 1.19解决了这两个问题。多亏了这一点，使本地安装的Windows Kubernetes才变得比以前更加舒适。</p><p id="2442" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">本文将演示如何在我的MacBook Pro上安装带有Hyper-V的本地Windows Kubernetes。</p><p id="ac61" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我很高兴找到了一篇由<a class="ae mb" href="https://github.com/kimkihyuk" rel="noopener ugc nofollow" target="_blank">金</a>撰写的很棒的教程文章。感谢你的精彩帖子。谢谢你。</p><div class="mc md gp gr me mf"><a href="https://medium.com/@keyhyuk.kim/hyper-v-%ED%99%98%EA%B2%BD%EC%97%90%EC%84%9C-%EC%BF%A0%EB%B2%84%EB%84%A4%ED%8B%B0%EC%8A%A4-master-worker-%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0-%EA%B5%AC%EC%B6%95%ED%95%98%EA%B8%B0-b7aead20132f" rel="noopener follow" target="_blank"><div class="mg ab fo"><div class="mh ab mi cl cj mj"><h2 class="bd ir gy z fp mk fr fs ml fu fw ip bi translated">Hyper-v 환경에서 쿠버네티스主工클러스터 구축하기</h2><div class="mm l"><h3 class="bd b gy z fp mk fr fs ml fu fw dk translated">Hyper-V 환경에서 1个主人，1个工人관계를 가지는 클러스터를 구축하고，工人머신에去application를포함하는pod와로드밸런스서비스를생성해외부에서접근할수있도록…</h3></div><div class="mn l"><p class="bd b dl z fp mk fr fs ml fu fw dk translated">medium.com</p></div></div><div class="mo l"><div class="mp l mq mr ms mo mt jw mf"/></div></div></a></div><h1 id="9b50" class="mu mv iq bd mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr bi translated">在MacBook Pro上构建稳定的Windows 10环境</h1><p id="f703" class="pw-post-body-paragraph kc kd iq ke b kf ns kh ki kj nt kl km kn nu kp kq kr nv kt ku kv nw kx ky kz ij bi translated">很遗憾，这不是一个众所周知的事实；macOS有一个安全功能，当您的Mac设备被盗或丢失时，它可以保护磁盘数据，该功能称为FileVault。Windows也有一个相同的功能，称为BitLocker。</p><p id="97fe" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">不幸的是，当你在macOS环境中打开FileVault时，你可能会遇到脆弱的Windows 10安装体验，尤其是在使用最新的基于英特尔的mac时；型号和配置可能会有所不同。</p><p id="6ef4" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">因此，我的建议是，在你的mac上安装Windows 10之前，你最好关闭它，尤其是你正试图使用Hyper-V这样的复杂功能。</p><h2 id="956b" class="nx mv iq bd mw ny nz dn na oa ob dp ne kn oc od ni kr oe of nm kv og oh nq oi bi translated">我应该关闭FileVault吗？</h2><p id="6d2f" class="pw-post-body-paragraph kc kd iq ke b kf ns kh ki kj nt kl km kn nu kp kq kr nv kt ku kv nw kx ky kz ij bi translated">有一些B计划来持久化FileVault。您可以选择支持“嵌套”虚拟化的虚拟化软件。</p><p id="e3b5" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">然而，根据我的个人经验，“嵌套虚拟化”的性能通常很糟糕，包括VMware和Parallels。</p><p id="1bc2" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">假设您无论如何都无法关闭FileVault。在这种情况下，您可以选择一种替代方式，如嵌套虚拟化的云计算(例如，Microsoft Azure上的Dv3或Ev3，或裸机支持的公共云)。</p><p id="50b7" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在财务方面，IMHO建议在Microsoft Azure上使用Dv3或Ev3实例，以节省您的预算。</p><p id="cbc6" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><a class="ae mb" href="https://docs.microsoft.com/en-us/azure/virtual-machines/windows/nested-virtualization?WT.mc_id=DOP-MVP-4024633" rel="noopener ugc nofollow" target="_blank">在Azure上选择Dv3或Ev3之前，请在此页面上咨询更多信息。</a></p><h1 id="f90c" class="mu mv iq bd mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr bi translated">重要的事情先来</h1><p id="bd06" class="pw-post-body-paragraph kc kd iq ke b kf ns kh ki kj nt kl km kn nu kp kq kr nv kt ku kv nw kx ky kz ij bi translated">为了传递简洁的信息，我想你已经满足了一些条件。我稍后会解释你为什么满足那些条件。</p><ol class=""><li id="4b09" class="lj lk iq ke b kf kg kj kk kn ll kr lm kv ln kz oj lp lq lr bi translated">您有宽带互联网连接，但没有计量连接。(特别是你应该避免移动网络共享。)</li><li id="e309" class="lj lk iq ke b kf ls kj lt kn lu kr lv kv lw kz oj lp lq lr bi translated">本文使用AMD64 Hyper-V和Windows容器进行了测试。</li><li id="d0bc" class="lj lk iq ke b kf ls kj lt kn lu kr lv kv lw kz oj lp lq lr bi translated">您使用的Hyper-V具有16GiB或更高的内存和512GiB (0.5TiB)或更大的SSD磁盘。</li><li id="7188" class="lj lk iq ke b kf ls kj lt kn lu kr lv kv lw kz oj lp lq lr bi translated">您安装了最新版本的Windows 10 Pro。</li><li id="9f1c" class="lj lk iq ke b kf ls kj lt kn lu kr lv kv lw kz oj lp lq lr bi translated">您在“添加/删除Windows组件”对话框中安装了整个Hyper-V组件。</li><li id="3a90" class="lj lk iq ke b kf ls kj lt kn lu kr lv kv lw kz oj lp lq lr bi translated">您有一个英语、美国版本的Windows Server 2019数据中心安装副本。</li></ol><h1 id="8b00" class="mu mv iq bd mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr bi translated">配置Hyper-V网络</h1><p id="66c9" class="pw-post-body-paragraph kc kd iq ke b kf ns kh ki kj nt kl km kn nu kp kq kr nv kt ku kv nw kx ky kz ij bi translated">一切准备就绪后，您可以开始在Hyper-V管理控制台窗口中配置Hyper-V内部网络。打开虚拟交换机管理对话框，并创建名为K8s的内部虚拟交换机。</p><figure class="ol om on oo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ok"><img src="../Images/866d1c377418305cda4c8fdcf0a5b358.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eknggEOikW-kWPdiPJue6Q.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">在虚拟交换机管理窗口中创建内部交换机。</figcaption></figure><p id="3eba" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">该网络的所有成员计算机都应接入互联网。为此，您需要进行互联网连接共享配置。找到连接到互联网的网络适配器，打开“共享”选项卡，并将共享设置为新创建的虚拟网络适配器。</p><figure class="ol om on oo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi op"><img src="../Images/e4fa32817fb1925c56206d37d0e7f5bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j9qYG7akRJ1-6iQwpVgMjw.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">您可以在连接到internet的适配器的属性窗口中设置internet连接共享。</figcaption></figure><h1 id="ac05" class="mu mv iq bd mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr bi translated">创建Hyper-V虚拟机</h1><p id="55eb" class="pw-post-body-paragraph kc kd iq ke b kf ns kh ki kj nt kl km kn nu kp kq kr nv kt ku kv nw kx ky kz ij bi translated">要创建一个混合Kubernetes集群，您需要创建两个安装了Ubuntu 18.04 LTS的虚拟机(一个使用Linux的主节点和工作节点)，以及一个Windows Server 2019虚拟机。</p><p id="8369" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">你可以用你的方式制作你的Ubuntu Linux VM。但是我将使用快速VM创建特性来节省时间和精力。快速虚拟机创建将使用OOBE(开箱即用的体验，您可以在打开新买的PC或笔记本电脑时体验此步骤。)，所以没有额外的文件复制过程。向导会询问一些基本问题来初始化环境，然后你马上就可以得到你的桌面了。</p><p id="0b3d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">请创建3个满足这些条件的虚拟机。</p><ul class=""><li id="0b64" class="lj lk iq ke b kf kg kj kk kn ll kr lm kv ln kz lo lp lq lr bi translated">所有虚拟机都是第二代Hyper-V虚拟机。</li><li id="331f" class="lj lk iq ke b kf ls kj lt kn lu kr lv kv lw kz lo lp lq lr bi translated">所有虚拟机都至少有两个处理器内核和2gb或更高的内存。</li><li id="11e4" class="lj lk iq ke b kf ls kj lt kn lu kr lv kv lw kz lo lp lq lr bi translated">如果是Windows VM，请在没有桌面经验的情况下安装。此选项意味着您使用的是Windows Server Core版本。</li><li id="ebe2" class="lj lk iq ke b kf ls kj lt kn lu kr lv kv lw kz lo lp lq lr bi translated">所有虚拟机都更新到最新的安全修复程序。(在Windows Server Core中，可以使用<code class="fe lx ly lz ma b">sconfig</code>命令来实现这一点。)</li><li id="bf3f" class="lj lk iq ke b kf ls kj lt kn lu kr lv kv lw kz lo lp lq lr bi translated">所有虚拟机都配置为使用静态IP地址，而不是DHCP。(在Windows Server Core中，可以使用<code class="fe lx ly lz ma b">sconfig</code>命令来实现这一点。)</li><li id="d80d" class="lj lk iq ke b kf ls kj lt kn lu kr lv kv lw kz lo lp lq lr bi translated">所有配置到<code class="fe lx ly lz ma b">hosts</code>文件(在Linux，<code class="fe lx ly lz ma b">/etc/hosts</code>文件和Windows，<code class="fe lx ly lz ma b">C:\Windows\System32\Drivers\etc\hosts</code>文件)的虚拟机在每个Kubernetes节点主机之间都有多个主机名和地址映射，包括其自身。正确注册后，您可以使用<code class="fe lx ly lz ma b">ping</code>命令测试连接。)</li></ul><h2 id="b811" class="nx mv iq bd mw ny nz dn na oa ob dp ne kn oc od ni kr oe of nm kv og oh nq oi bi translated">为客户端和节点配置SSH</h2><p id="6268" class="pw-post-body-paragraph kc kd iq ke b kf ns kh ki kj nt kl km kn nu kp kq kr nv kt ku kv nw kx ky kz ij bi translated">为了提高效率，您可以使用多个SSH连接来完成任务。我将添加一些指南来配置您的Windows 10和虚拟机之间的SSH连接。</p><p id="7aee" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">您可以从Microsoft商店安装Windows终端应用程序。</p><div class="mc md gp gr me mf"><a href="https://www.microsoft.com/store/productId/9N0DX20HK701" rel="noopener  ugc nofollow" target="_blank"><div class="mg ab fo"><div class="mh ab mi cl cj mj"><h2 class="bd ir gy z fp mk fr fs ml fu fw ip bi translated">获取Windows终端- Microsoft商店</h2><div class="mm l"><h3 class="bd b gy z fp mk fr fs ml fu fw dk translated">Windows终端是一个现代的、快速的、高效的、强大的、多产的终端应用程序，适用于…</h3></div><div class="mn l"><p class="bd b dl z fp mk fr fs ml fu fw dk translated">www.microsoft.com</p></div></div><div class="mo l"><div class="oq l mq mr ms mo mt jw mf"/></div></div></a></div><p id="e0c1" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">请参考这篇文章来配置你的Windows 10 SSH客户端。</p><div class="mc md gp gr me mf"><a href="https://medium.com/rkttu/set-up-ssh-key-and-git-integration-in-windows-10-native-way-c9b94952dd2c" rel="noopener follow" target="_blank"><div class="mg ab fo"><div class="mh ab mi cl cj mj"><h2 class="bd ir gy z fp mk fr fs ml fu fw ip bi translated">以Windows 10原生方式设置SSH Key和Git集成</h2><div class="mm l"><h3 class="bd b gy z fp mk fr fs ml fu fw dk translated">你知道Windows 10自带OpenSSH客户端吗？</h3></div><div class="mn l"><p class="bd b dl z fp mk fr fs ml fu fw dk translated">medium.com</p></div></div><div class="mo l"><div class="or l mq mr ms mo mt jw mf"/></div></div></a></div><p id="b0c3" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在Linux服务器中，您可以参考本指南来配置SSH服务器。可以从Windows 10添加自己的公钥，公钥位于<code class="fe lx ly lz ma b">%USERPROFILE%\.ssh\id_rsa.pub</code>(PowerShell中，<code class="fe lx ly lz ma b">$env:USERPROFILE\.ssh\id_rsa.pub</code>)下。</p><div class="mc md gp gr me mf"><a href="https://ubuntu.com/server/docs/service-openssh" rel="noopener  ugc nofollow" target="_blank"><div class="mg ab fo"><div class="mh ab mi cl cj mj"><h2 class="bd ir gy z fp mk fr fs ml fu fw ip bi translated">服务- OpenSSH |服务器文档| Ubuntu</h2><div class="mm l"><h3 class="bd b gy z fp mk fr fs ml fu fw dk translated">OpenSSH是一个强大的工具集，用于远程控制联网计算机和在联网计算机之间传输数据…</h3></div><div class="mn l"><p class="bd b dl z fp mk fr fs ml fu fw dk translated">ubuntu.com</p></div></div></div></a></div><p id="e8d0" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">最后，您可以使用本文配置您的Windows服务器来接受SSH连接。您可以用同样的方式注册您的公钥。</p><div class="mc md gp gr me mf"><a href="https://medium.com/rkttu/set-up-your-ssh-server-in-windows-10-native-way-1aab9021c3a6" rel="noopener follow" target="_blank"><div class="mg ab fo"><div class="mh ab mi cl cj mj"><h2 class="bd ir gy z fp mk fr fs ml fu fw ip bi translated">以Windows 10原生方式设置您的SSH服务器</h2><div class="mm l"><h3 class="bd b gy z fp mk fr fs ml fu fw dk translated">本文展示了如何设置Windows 10和Windows Server提供的内置SSH服务器。</h3></div><div class="mn l"><p class="bd b dl z fp mk fr fs ml fu fw dk translated">medium.com</p></div></div><div class="mo l"><div class="os l mq mr ms mo mt jw mf"/></div></div></a></div><p id="91e0" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">一切都准备好了吗？让我们进一步深入，完成配置。</p><h1 id="40ad" class="mu mv iq bd mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr bi translated">Linux虚拟机配置(通用步骤)</h1><p id="e4e6" class="pw-post-body-paragraph kc kd iq ke b kf ns kh ki kj nt kl km kn nu kp kq kr nv kt ku kv nw kx ky kz ij bi translated">本节包含所有Linux Kubernetes节点通常需要的步骤。</p><h2 id="42d5" class="nx mv iq bd mw ny nz dn na oa ob dp ne kn oc od ni kr oe of nm kv og oh nq oi bi translated">安装软件</h2><p id="7792" class="pw-post-body-paragraph kc kd iq ke b kf ns kh ki kj nt kl km kn nu kp kq kr nv kt ku kv nw kx ky kz ij bi translated">让我们安装附加组件。</p><pre class="ol om on oo gt ot ma ou ov aw ow bi"><span id="dab7" class="nx mv iq ma b gy ox oy l oz pa">sudo apt -y install curl vim apt-transport-https</span></pre><ul class=""><li id="8939" class="lj lk iq ke b kf kg kj kk kn ll kr lm kv ln kz lo lp lq lr bi translated"><code class="fe lx ly lz ma b">curl</code>:这个工具用来解析和运行来自互联网的shell脚本。</li><li id="b815" class="lj lk iq ke b kf ls kj lt kn lu kr lv kv lw kz lo lp lq lr bi translated">我将使用这个工具来编辑文本文件。可以用nano之类的其他工具。</li><li id="fbeb" class="lj lk iq ke b kf ls kj lt kn lu kr lv kv lw kz lo lp lq lr bi translated"><code class="fe lx ly lz ma b">apt-transport-https</code>:该工具允许为<code class="fe lx ly lz ma b">apt</code>软件包管理器向本地系统添加第三方软件包仓库。我将在这个系统上添加Kubernetes智能目录。</li></ul><h2 id="8f5e" class="nx mv iq bd mw ny nz dn na oa ob dp ne kn oc od ni kr oe of nm kv og oh nq oi bi translated">安装和配置Docker</h2><p id="b970" class="pw-post-body-paragraph kc kd iq ke b kf ns kh ki kj nt kl km kn nu kp kq kr nv kt ku kv nw kx ky kz ij bi translated">让我们安装Docker引擎。我将使用Rancher的自动安装脚本。有了这个脚本，您可以轻松快速地安装Docker引擎。</p><pre class="ol om on oo gt ot ma ou ov aw ow bi"><span id="d7d8" class="nx mv iq ma b gy ox oy l oz pa">curl <a class="ae mb" href="https://releases.rancher.com/install-docker/19.03.sh" rel="noopener ugc nofollow" target="_blank">https://releases.rancher.com/install-docker/19.03.sh</a> | sh</span></pre><p id="097e" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">安装docker引擎后，将当前用户添加到<code class="fe lx ly lz ma b">docker</code>组，无需<code class="fe lx ly lz ma b">sudo</code>命令即可连接本地Docker引擎。然后注销后再次登录。</p><pre class="ol om on oo gt ot ma ou ov aw ow bi"><span id="fc47" class="nx mv iq ma b gy ox oy l oz pa">sudo usermod -aG docker $USER</span><span id="84cd" class="nx mv iq ma b gy pb oy l oz pa">logout</span></pre><p id="7dbf" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">要在Kubernetes中使用Docker引擎，让我们编辑daemon.json文件。</p><pre class="ol om on oo gt ot ma ou ov aw ow bi"><span id="9f7b" class="nx mv iq ma b gy ox oy l oz pa">sudo vim /etc/docker/daemon.json</span></pre><p id="f6e9" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">配置文件是这样的。</p><pre class="ol om on oo gt ot ma ou ov aw ow bi"><span id="890f" class="nx mv iq ma b gy ox oy l oz pa">{<br/>  "exec-opts": ["native.cgroupdriver=systemd"],<br/>  "log-driver": "json-file",<br/>  "log-opts": {<br/>    "max-size": "100m"f<br/>  },<br/>  "storage-driver": "overlay2"<br/>}</span></pre><p id="1ae5" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">用这个命令保存文件并重启docker引擎。</p><pre class="ol om on oo gt ot ma ou ov aw ow bi"><span id="a8ac" class="nx mv iq ma b gy ox oy l oz pa">sudo systemctl restart docker</span></pre><h2 id="0eaa" class="nx mv iq bd mw ny nz dn na oa ob dp ne kn oc od ni kr oe of nm kv og oh nq oi bi translated">更改系统设置</h2><p id="e249" class="pw-post-body-paragraph kc kd iq ke b kf ns kh ki kj nt kl km kn nu kp kq kr nv kt ku kv nw kx ky kz ij bi translated">要创建Kubernetes节点，您应该关闭交换。此外，为了在Windows和Linux节点之间集成CNI插件，内核参数需要改变。</p><p id="7a41" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">首先，我们需要关闭swap。</p><pre class="ol om on oo gt ot ma ou ov aw ow bi"><span id="a20d" class="nx mv iq ma b gy ox oy l oz pa">sudo swapoff -a</span></pre><p id="f2c5" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">然后，在系统重启后，将<code class="fe lx ly lz ma b">/etc/fstab</code>文件更改为关闭持久交换。</p><pre class="ol om on oo gt ot ma ou ov aw ow bi"><span id="904d" class="nx mv iq ma b gy ox oy l oz pa">sudo sed -i ‘/ swap / s/^\(.*\)$/#\1/g’ /etc/fstab</span></pre><p id="8883" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">最后，我们需要改变内核参数来整合Windows和Linux的法兰绒CNI插件。(<a class="ae mb" href="https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/adding-windows-nodes/#configuring-flannel" rel="noopener ugc nofollow" target="_blank">参考</a>)</p><pre class="ol om on oo gt ot ma ou ov aw ow bi"><span id="1708" class="nx mv iq ma b gy ox oy l oz pa">sudo sysctl net.bridge.bridge-nf-call-iptables=1</span></pre><h2 id="7553" class="nx mv iq bd mw ny nz dn na oa ob dp ne kn oc od ni kr oe of nm kv og oh nq oi bi translated">安装Kubernetes CLI</h2><p id="4687" class="pw-post-body-paragraph kc kd iq ke b kf ns kh ki kj nt kl km kn nu kp kq kr nv kt ku kv nw kx ky kz ij bi translated">让我们安装Kubernetes CLI来初始化、配置和管理Kubernetes集群。</p><p id="02a3" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们需要将谷歌的<code class="fe lx ly lz ma b">apt</code>目录添加到系统中。让我们运行下面的命令。</p><pre class="ol om on oo gt ot ma ou ov aw ow bi"><span id="8d76" class="nx mv iq ma b gy ox oy l oz pa">curl -s <a class="ae mb" href="https://packages.cloud.google.com/apt/doc/apt-key.gpg" rel="noopener ugc nofollow" target="_blank">https://packages.cloud.google.com/apt/doc/apt-key.gpg</a> | sudo apt-key add -</span><span id="2475" class="nx mv iq ma b gy pb oy l oz pa">cat &lt;&lt;EOF | sudo tee /etc/apt/sources.list.d/kubernetes.list<br/>deb <a class="ae mb" href="https://apt.kubernetes.io/" rel="noopener ugc nofollow" target="_blank">https://apt.kubernetes.io/</a> kubernetes-xenial main<br/>EOF</span><span id="41c2" class="nx mv iq ma b gy pb oy l oz pa">sudo apt update</span></pre><p id="f5c5" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">然后，安装相关工具并修复版本。</p><pre class="ol om on oo gt ot ma ou ov aw ow bi"><span id="33a9" class="nx mv iq ma b gy ox oy l oz pa">sudo apt-get install -y kubelet kubeadm kubectl</span><span id="51ac" class="nx mv iq ma b gy pb oy l oz pa">sudo apt-mark hold kubelet kubeadm kubectl</span></pre><p id="40e7" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">验证<code class="fe lx ly lz ma b">kubeadm</code>是否正确安装。我们将在每个Linux节点上使用这个工具，包括每个控制平面和工作节点。</p><pre class="ol om on oo gt ot ma ou ov aw ow bi"><span id="5854" class="nx mv iq ma b gy ox oy l oz pa">kubeadm version</span></pre><p id="1620" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如果版本信息显示正确，您的设置就完成了。</p><h1 id="2eb6" class="mu mv iq bd mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr bi translated">配置Linux控制平面节点</h1><p id="5658" class="pw-post-body-paragraph kc kd iq ke b kf ns kh ki kj nt kl km kn nu kp kq kr nv kt ku kv nw kx ky kz ij bi translated">要初始化群集和控制平面节点，让我们运行以下命令。</p><pre class="ol om on oo gt ot ma ou ov aw ow bi"><span id="6f0d" class="nx mv iq ma b gy ox oy l oz pa">sudo kubeadm init — pod-network-cidr=10.244.0.0/16</span></pre><p id="78e8" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">注意，在该命令中，我们在<code class="fe lx ly lz ma b">--pot-network-cidr</code>选项中指定了CIDR范围。我们将在覆盖网络上虚拟地分配这个CIDR范围，并且覆盖网络在这个集群的成员节点上被识别。因此，你可以选择你的CIDR范围的价值，创建一个当地的Kubernetes集群简单。</p><p id="4aec" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir"> ⚠重要提示——运行该命令后，集群很快就会初始化。然后，您将看到其他节点的join命令行。请安全地复制该命令以供将来使用。</strong></p><p id="bf4c" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">然后，将客户机配置文件复制到主目录中，该目录包含新创建的集群的管理凭据。</p><pre class="ol om on oo gt ot ma ou ov aw ow bi"><span id="5f23" class="nx mv iq ma b gy ox oy l oz pa">mkdir -p $HOME/.kube <br/>sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config <br/>sudo chown $(id -u):$(id -g) $HOME/.kube/config</span></pre><p id="ccb6" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">您可以使用下面的命令测试配置文件。我们可以通过命令行监控所有的豆荚变绿。</p><pre class="ol om on oo gt ot ma ou ov aw ow bi"><span id="22b7" class="nx mv iq ma b gy ox oy l oz pa">watch kubectl get pods -A</span></pre><p id="4738" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">看到所有窗格都变绿后，按Ctrl+C退出。</p><h2 id="82d9" class="nx mv iq bd mw ny nz dn na oa ob dp ne kn oc od ni kr oe of nm kv og oh nq oi bi translated">安装Linux法兰绒CNI</h2><p id="a523" class="pw-post-body-paragraph kc kd iq ke b kf ns kh ki kj nt kl km kn nu kp kq kr nv kt ku kv nw kx ky kz ij bi translated">让我们为Linux节点安装法兰绒CNI。我们需要修改分布式YAML文件来实现我们的目标。</p><p id="7f73" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">先下载kube-法兰绒. yaml文件。</p><pre class="ol om on oo gt ot ma ou ov aw ow bi"><span id="92b7" class="nx mv iq ma b gy ox oy l oz pa">curl -L <a class="ae mb" href="https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</a> -o kube-flannel.yaml</span></pre><p id="cb44" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">然后用您喜欢的编辑器打开YAML文件，找到行<code class="fe lx ly lz ma b">net-conf.json: |</code>字符串。您可能会发现类似下面的行。</p><pre class="ol om on oo gt ot ma ou ov aw ow bi"><span id="38aa" class="nx mv iq ma b gy ox oy l oz pa">net-conf.json: |<br/>    {<br/>      "Network": "10.244.0.0/16",<br/>      "Backend": {<br/>        "Type": "vxlan"<br/>      }<br/>    }</span></pre><p id="c888" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这里，<code class="fe lx ly lz ma b">Network</code>应该指向您在初始化集群时指定的有效CIDR范围。然后，在<code class="fe lx ly lz ma b">Backend</code>属性下，需要添加两个属性。</p><ul class=""><li id="279b" class="lj lk iq ke b kf kg kj kk kn ll kr lm kv ln kz lo lp lq lr bi translated">VNI: 4096</li><li id="ee43" class="lj lk iq ke b kf ls kj lt kn lu kr lv kv lw kz lo lp lq lr bi translated">端口:4789</li></ul><p id="dc22" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">为了完整性，修改后的内容如下所示。</p><pre class="ol om on oo gt ot ma ou ov aw ow bi"><span id="3e91" class="nx mv iq ma b gy ox oy l oz pa">net-conf.json: |<br/>    {<br/>      "Network": "10.244.0.0/16",<br/>      "Backend": {<br/>        "Type": "vxlan",<br/>        "VNI" : 4096,<br/>        "Port": 4789<br/>      }<br/>    }</span></pre><p id="fc64" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">保存修改后的YAML文件，并使用下面的命令行应用YAML文件。</p><pre class="ol om on oo gt ot ma ou ov aw ow bi"><span id="bc57" class="nx mv iq ma b gy ox oy l oz pa">kubectl apply -f kube-flannel.yml</span></pre><p id="586e" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">然后你需要监控所有的法兰绒豆荚变绿。您可以使用下面的命令观察每个pod的状态。</p><pre class="ol om on oo gt ot ma ou ov aw ow bi"><span id="5415" class="nx mv iq ma b gy ox oy l oz pa">watch kubectl get pods -A</span></pre><h1 id="76ed" class="mu mv iq bd mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr bi translated">安装Linux工作节点</h1><p id="1e8b" class="pw-post-body-paragraph kc kd iq ke b kf ns kh ki kj nt kl km kn nu kp kq kr nv kt ku kv nw kx ky kz ij bi translated">假设您有一个用于将新节点加入集群的命令行。同<code class="fe lx ly lz ma b">kubeadm init</code>。您可以通过在前面添加<code class="fe lx ly lz ma b">sudo</code>关键字来运行该命令。</p><p id="9c8b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">但是，如果您很晚才运行该命令，或者丢失了命令行，您可以在控制平面节点的shell中使用下面的命令重新发出join命令行。</p><pre class="ol om on oo gt ot ma ou ov aw ow bi"><span id="d674" class="nx mv iq ma b gy ox oy l oz pa">kubeadm token create --print-join-command</span></pre><p id="9e94" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">或者，您可以使用以下命令行来恢复令牌和CA证书哈希。</p><pre class="ol om on oo gt ot ma ou ov aw ow bi"><span id="2169" class="nx mv iq ma b gy ox oy l oz pa">$MASTER_IP=(Control-plane VM’s IP Address)</span><span id="cdea" class="nx mv iq ma b gy pb oy l oz pa">$TOKEN=kubeadm token list -o jsonpath=’{.token}’</span><span id="a412" class="nx mv iq ma b gy pb oy l oz pa">$CA_CERT_HASH=openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | openssl dgst -sha256 -hex | sed ‘s/^.* //’</span></pre><p id="cffe" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">通过合并恢复的值，您可以用下面的命令行连接新节点。</p><pre class="ol om on oo gt ot ma ou ov aw ow bi"><span id="f6ce" class="nx mv iq ma b gy ox oy l oz pa">sudo kubeadm join $MASTER_IP:6443 — token $TOKEN — discovery-token-ca-cert-hash sha256:$CA_CERT_HASH</span></pre><p id="67e5" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在节点加入Kubernetes集群之后，您可以使用下面的命令监视节点的状态。将<code class="fe lx ly lz ma b">Not Ready</code>状态转换到<code class="fe lx ly lz ma b">Ready</code>状态需要一些时间。</p><pre class="ol om on oo gt ot ma ou ov aw ow bi"><span id="1dc4" class="nx mv iq ma b gy ox oy l oz pa">watch kubectl get nodes -o wide</span></pre><h1 id="f769" class="mu mv iq bd mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr bi translated">配置Windows工作节点</h1><p id="1e3a" class="pw-post-body-paragraph kc kd iq ke b kf ns kh ki kj nt kl km kn nu kp kq kr nv kt ku kv nw kx ky kz ij bi translated">我们来看一个最喜欢的部分，Windows worker节点！</p><h2 id="56ba" class="nx mv iq bd mw ny nz dn na oa ob dp ne kn oc od ni kr oe of nm kv og oh nq oi bi translated">在你开始之前</h2><p id="8c23" class="pw-post-body-paragraph kc kd iq ke b kf ns kh ki kj nt kl km kn nu kp kq kr nv kt ku kv nw kx ky kz ij bi translated">几乎所有为Windows编写的CNI插件都将依赖于HNS API，而HNS将代表CNI插件配置虚拟网络。</p><p id="6275" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">此时，Windows将通过显示名称或随机生成的GUID提供所有已安装的网络适配器的信息。所以CNI会用显示字符串找到一个合适的网络适配器。</p><p id="429b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">正因为如此，你需要使用美式英语版本的Windows Server。否则，Windows会将网络适配器名称翻译成默认显示语言，而不是单词<code class="fe lx ly lz ma b">Ethernet</code>。</p><p id="c3ee" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">此外，每个Windows工作节点应该具有相同的硬件配置。从Kubernetes 1.19开始，WINS用于处理来自pod的管理请求，这种方法实现了以容器形式安装<code class="fe lx ly lz ma b">kube-proxy</code>。</p><p id="abd5" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在守护程序集中安装<code class="fe lx ly lz ma b">kube-proxy</code>时，不同的硬件配置会导致守护程序集部署失败。每次都必须修改守护进程集来解决这类问题。</p><p id="bb40" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">所以如果你在这种情况下，你需要在每次部署时检查守护进程设置文件。</p><h2 id="7c06" class="nx mv iq bd mw ny nz dn na oa ob dp ne kn oc od ni kr oe of nm kv og oh nq oi bi translated">正在检查Kubernetes集群版本</h2><p id="b99a" class="pw-post-body-paragraph kc kd iq ke b kf ns kh ki kj nt kl km kn nu kp kq kr nv kt ku kv nw kx ky kz ij bi translated">当您将Windows worker节点添加到群集时，您将体验到不同之处。首先，您需要检查所有Kubernetes节点的版本是否相同，以及运行的是什么版本。</p><pre class="ol om on oo gt ot ma ou ov aw ow bi"><span id="11f1" class="nx mv iq ma b gy ox oy l oz pa">kubectl get nodes -o wide</span></pre><h2 id="5835" class="nx mv iq bd mw ny nz dn na oa ob dp ne kn oc od ni kr oe of nm kv og oh nq oi bi translated">正在检查Windows Server版本</h2><p id="87a1" class="pw-post-body-paragraph kc kd iq ke b kf ns kh ki kj nt kl km kn nu kp kq kr nv kt ku kv nw kx ky kz ij bi translated">正如我前面提到的，您需要使用最新版本的Windows Server来启用Kubernetes的所有功能。让我们用下面的命令检查Windows Server版本。</p><pre class="ol om on oo gt ot ma ou ov aw ow bi"><span id="93bb" class="nx mv iq ma b gy ox oy l oz pa">cmd.exe /s /c ver</span></pre><p id="3b56" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">假设您使用的是比以下版本更新的版本。</p><pre class="ol om on oo gt ot ma ou ov aw ow bi"><span id="969f" class="nx mv iq ma b gy ox oy l oz pa">Microsoft Windows [Version 10.0.17763.1432]</span></pre><p id="d1a1" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如果你的OS版本低于<code class="fe lx ly lz ma b">10.0.17763</code> ( <code class="fe lx ly lz ma b">10</code>和<code class="fe lx ly lz ma b">0</code>是版本号，<code class="fe lx ly lz ma b">17763</code>是内部版本号)，说明你用的不是Windows Server 2019。您应该执行就地升级或更改安装了Windows Server 2019的其他计算机。</p><p id="ae3e" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如果您的版本号的三个部分匹配，但不是最后一个低于<code class="fe lx ly lz ma b">1432</code>，您的操作系统不支持HNS中的DSR功能。</p><p id="996d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在这种情况下，您可以执行Windows Update操作或从Microsoft Update目录网站下载编号为<code class="fe lx ly lz ma b">KB4571748</code>的修补程序。</p><h2 id="0e60" class="nx mv iq bd mw ny nz dn na oa ob dp ne kn oc od ni kr oe of nm kv og oh nq oi bi translated">为窗户配置法兰绒CNI</h2><p id="42cd" class="pw-post-body-paragraph kc kd iq ke b kf ns kh ki kj nt kl km kn nu kp kq kr nv kt ku kv nw kx ky kz ij bi translated">要检查您的默认适配器名称是否为<code class="fe lx ly lz ma b">Ethernet</code>，请运行以下命令。</p><pre class="ol om on oo gt ot ma ou ov aw ow bi"><span id="b0a1" class="nx mv iq ma b gy ox oy l oz pa">Get-NetAdapter</span></pre><p id="fe75" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">然后，将<code class="fe lx ly lz ma b">kube-proxy</code>守护进程集部署到集群中。你需要更换合适的版本而不是<code class="fe lx ly lz ma b">v1.19.2</code>。您可以在控制平面节点的shell中运行以下命令。</p><pre class="ol om on oo gt ot ma ou ov aw ow bi"><span id="11ae" class="nx mv iq ma b gy ox oy l oz pa">curl -L <a class="ae mb" href="https://github.com/kubernetes-sigs/sig-windows-tools/releases/latest/download/kube-proxy.yml" rel="noopener ugc nofollow" target="_blank">https://github.com/kubernetes-sigs/sig-windows-tools/releases/latest/download/kube-proxy.yml</a> | sed ‘s/VERSION/v1.19.2/g’ | kubectl apply -f -</span></pre><p id="532d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">然后，在集群上部署覆盖版本的法兰绒CNI守护进程集。让我们再次在控制平面节点的shell中运行下面的命令行。</p><pre class="ol om on oo gt ot ma ou ov aw ow bi"><span id="ceff" class="nx mv iq ma b gy ox oy l oz pa">kubectl apply -f <a class="ae mb" href="https://github.com/kubernetes-sigs/sig-windows-tools/releases/latest/download/flannel-overlay.yml" rel="noopener ugc nofollow" target="_blank">https://github.com/kubernetes-sigs/sig-windows-tools/releases/latest/download/flannel-overlay.yml</a></span></pre><p id="ba75" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如果您发现Windows中的适配器名称不是<code class="fe lx ly lz ma b">Ethernet</code>，请更改如下命令行以解决问题。(在<code class="fe lx ly lz ma b">sed</code>命令中，前一部分是原字符串，后一部分是目标字符串。)</p><pre class="ol om on oo gt ot ma ou ov aw ow bi"><span id="e78f" class="nx mv iq ma b gy ox oy l oz pa">curl -L <a class="ae mb" href="https://github.com/kubernetes-sigs/sig-windows-tools/releases/latest/download/flannel-overlay.yml" rel="noopener ugc nofollow" target="_blank">https://github.com/kubernetes-sigs/sig-windows-tools/releases/latest/download/flannel-overlay.yml</a> | sed ‘s/Ethernet/Ethernet0 2/g’ | kubectl apply -f -</span></pre><p id="216c" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">此时，我们仍然没有将Windows worker节点加入到集群中，所以让我们继续工作。</p><h2 id="3c82" class="nx mv iq bd mw ny nz dn na oa ob dp ne kn oc od ni kr oe of nm kv og oh nq oi bi translated">安装Docker企业版Windows版</h2><p id="8e11" class="pw-post-body-paragraph kc kd iq ke b kf ns kh ki kj nt kl km kn nu kp kq kr nv kt ku kv nw kx ky kz ij bi translated">您可以在Windows Server中免费使用Docker企业版，因为您已经按照您的Windows Server价格支付了Docker EE的价格。所以你可以从微软的包商店下载Docker EE。</p><blockquote class="pc pd pe"><p id="bf4b" class="kc kd pf ke b kf kg kh ki kj kk kl km pg ko kp kq ph ks kt ku pi kw kx ky kz ij bi translated">注意:请不要与Docker CE或Docker Toolbox混淆。可以通过Docker官方网站下载Docker CE，但是Docker CE不支持Windows server的生产Windows容器。另外，Docker工具箱不提供Windows容器功能。</p></blockquote><p id="d76a" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">首先，我们来安装Docker EE安装的先决条件。</p><pre class="ol om on oo gt ot ma ou ov aw ow bi"><span id="5bfb" class="nx mv iq ma b gy ox oy l oz pa">Install-Module -Name DockerMsftProvider -Repository PSGallery -Force</span></pre><p id="0655" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">然后，安装最新版本的Docker企业版。</p><pre class="ol om on oo gt ot ma ou ov aw ow bi"><span id="225b" class="nx mv iq ma b gy ox oy l oz pa">Install-Package -Name docker -ProviderName DockerMsftProvider</span></pre><p id="06e2" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">将Docker引擎启动模式改为系统启动时自动启动。</p><pre class="ol om on oo gt ot ma ou ov aw ow bi"><span id="d353" class="nx mv iq ma b gy ox oy l oz pa">Set-Service -Name ‘docker’ -StartupType Automatic</span></pre><p id="6d04" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">最后，重新启动服务器以应用系统范围的配置更改。</p><pre class="ol om on oo gt ot ma ou ov aw ow bi"><span id="2376" class="nx mv iq ma b gy ox oy l oz pa">Restart-Computer -Force</span></pre><h2 id="f5a8" class="nx mv iq bd mw ny nz dn na oa ob dp ne kn oc od ni kr oe of nm kv og oh nq oi bi translated">安装Windows Kubernetes工作节点</h2><p id="e7cb" class="pw-post-body-paragraph kc kd iq ke b kf ns kh ki kj nt kl km kn nu kp kq kr nv kt ku kv nw kx ky kz ij bi translated">最后，我们将安装Windows Kubernetes worker节点。我们可以使用Kubernetes项目的Windows SIG团队开发的PowerShell脚本。</p><pre class="ol om on oo gt ot ma ou ov aw ow bi"><span id="c36e" class="nx mv iq ma b gy ox oy l oz pa">curl.exe -LO <a class="ae mb" href="https://github.com/kubernetes-sigs/sig-windows-tools/releases/latest/download/PrepareNode.ps1" rel="noopener ugc nofollow" target="_blank">https://github.com/kubernetes-sigs/sig-windows-tools/releases/latest/download/PrepareNode.ps1</a></span></pre><p id="e00d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们使用了Windows Server 2019中包含的<code class="fe lx ly lz ma b">curl.exe</code>。</p><p id="2cd9" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><code class="fe lx ly lz ma b">curl.exe</code>很好用，比Windows PowerShell的<code class="fe lx ly lz ma b">Invoke-WebRequest</code>好用。因为，<code class="fe lx ly lz ma b">Invoke-WebRequest</code>需要Internet Explorer，除非你指定<code class="fe lx ly lz ma b">-UseBasicParsing</code>选项。此外，您已经熟悉了Linux环境中的<code class="fe lx ly lz ma b">curl</code>实用程序。</p><p id="077b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">然后，重新检查正在运行的Kubernetes版本，并使用如下命令行所示的确切版本号运行PowerShell脚本。</p><pre class="ol om on oo gt ot ma ou ov aw ow bi"><span id="5076" class="nx mv iq ma b gy ox oy l oz pa">.\PrepareNode.ps1 -KubernetesVersion v1.19.2</span></pre><p id="3636" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">运行脚本后，目录<code class="fe lx ly lz ma b">C:\k</code>被创建，目录<code class="fe lx ly lz ma b">kubeadm.exe</code>和其他相关的CLI工具被复制到该目录。更改您的当前目录，并在这里运行发出的join命令。</p><pre class="ol om on oo gt ot ma ou ov aw ow bi"><span id="521d" class="nx mv iq ma b gy ox oy l oz pa">cd c:\k</span><span id="dc7b" class="nx mv iq ma b gy pb oy l oz pa">kubeadm.exe join &lt;IP address of control-plane node&gt;:6443 --token &lt;Token&gt; --discovery-token-ca-cert-hash sha256:&lt;CA Cert Hash&gt;</span></pre><p id="337d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">当Windows worker节点加入时，部署的CNI守护进程集会自动将pod部署到新创建的节点中。</p><p id="7d9c" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">使用Windows服务器核心基础映像构建的<code class="fe lx ly lz ma b">sigwindowstools/flannel</code>映像会导致很长的提取时间。因此，您的Windows节点将需要很长时间转换到<code class="fe lx ly lz ma b">Ready</code>状态。</p><p id="1758" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">您可以通过运行<code class="fe lx ly lz ma b">docker pull</code>命令来监视Windows worker节点中的提取状态。您可以通过调查部署的守护进程集和pod信息来发现确切的映像名称和标记。</p><h1 id="e70c" class="mu mv iq bd mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr bi translated">部署测试应用程序</h1><p id="1cf7" class="pw-post-body-paragraph kc kd iq ke b kf ns kh ki kj nt kl km kn nu kp kq kr nv kt ku kv nw kx ky kz ij bi translated">让我们部署一个同时包含Linux和Windows容器的混合Kubernetes应用程序！</p><p id="61be" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我将部署AzureVote应用程序的修改版本，由Python Django和Redis容器组成。</p><p id="a31b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这里，Redis pod使用一个自定义映像，Redis的移植版本进入Windows，Windows Server Core 1809基本映像。(我用的是移植的Redis，是老牌公司微软开放技术公司开发的)。</p><p id="0749" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如果应用程序运行正常，我们可以看到带有投票用户界面的网页。</p><p id="14b8" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">让我们看看YAML的文件来做这件事。</p><pre class="ol om on oo gt ot ma ou ov aw ow bi"><span id="826e" class="nx mv iq ma b gy ox oy l oz pa">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: azure-vote-back<br/>spec:<br/>  selector:<br/>    matchLabels:<br/>      app: azure-vote-back<br/>  replicas: 1<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: azure-vote-back<br/>    spec:<br/>      containers:<br/>      - name: azure-vote-back<br/>        image: rkttu/redis-windows:3.0-1809<br/>        ports:<br/>        - containerPort: 6379<br/>          name: redis<br/>      nodeSelector:<br/>        "beta.kubernetes.io/os": windows<br/>---<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: azure-vote-back<br/>spec:<br/>  ports:<br/>  - port: 6379<br/>  selector:<br/>    app: azure-vote-back<br/>---<br/>apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: azure-vote-front<br/>spec:<br/>  selector:<br/>    matchLabels:<br/>      app: azure-vote-front<br/>  replicas: 1<br/>  strategy:<br/>    rollingUpdate:<br/>      maxSurge: 1<br/>      maxUnavailable: 1<br/>  minReadySeconds: 5 <br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: azure-vote-front<br/>    spec:<br/>      containers:<br/>      - name: azure-vote-front<br/>        image: microsoft/azure-vote-front:v1<br/>        ports:<br/>        - containerPort: 80<br/>        resources:<br/>          requests:<br/>            cpu: 250m<br/>          limits:<br/>            cpu: 500m<br/>        env:<br/>        - name: REDIS<br/>          value: "azure-vote-back"<br/>      nodeSelector:<br/>        "beta.kubernetes.io/os": linux<br/>---<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: azure-vote-front<br/>spec:<br/>  type: LoadBalancer<br/>  ports:<br/>  - port: 80<br/>  selector:<br/>    app: azure-vote-front</span></pre><p id="ab3e" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们可以用下面的命令行部署应用程序。</p><pre class="ol om on oo gt ot ma ou ov aw ow bi"><span id="b222" class="nx mv iq ma b gy ox oy l oz pa">kubectl apply -f azurevote.yaml</span></pre><p id="f36f" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">然后，我们需要等待所有的pod进入就绪状态。同样，首次部署需要很长时间，所以请耐心等待。</p><pre class="ol om on oo gt ot ma ou ov aw ow bi"><span id="b053" class="nx mv iq ma b gy ox oy l oz pa">watch kubectl get pods -A</span></pre><p id="ce88" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">要检查Python Django pod是否成功运行，请记下pod IP地址，如果响应包含HTML页面，则使用<code class="fe lx ly lz ma b">curl</code>命令获取响应，Linux容器与Windows Redis容器连接。</p><figure class="ol om on oo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi pj"><img src="../Images/360e65ba9cf96afc69be5d31c7c15133.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a_iyMZmvjYdcqBL6u2P7hQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">检查pod运行是否正常</figcaption></figure><p id="962a" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">然后，我们可以为服务分配一个外部IP地址，以供外部访问。与公共云的Kubernetes不同，Hyper-V没有像负载平衡器这样的概念，所以我们需要分配工作节点的IP地址来服务。</p><p id="e24f" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">检查控制平面或工作节点的IP地址，并运行以下命令行来设置有效的IP地址。</p><pre class="ol om on oo gt ot ma ou ov aw ow bi"><span id="7e63" class="nx mv iq ma b gy ox oy l oz pa">kubectl patch svc azure-vote-front -p '{"spec":{"externalIPs":["192.168.137.101"]}}'</span></pre><p id="0453" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">然后，您可以使用web浏览器浏览您的节点IP；可以看到Azure投票App界面。</p><figure class="ol om on oo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/3766c8a7ac372d5204eaaddb31ebd8df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p0_m1E3Xg1QPm-Le1rvVcA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">在浏览器中运行AzureVote应用程序</figcaption></figure><p id="8009" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">遗憾的是，您不能使用Windows worker节点的IP地址来提供服务。</p><p id="0df9" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">但是，您可以通过Linux节点IP地址在Windows worker节点上路由web服务。例如，我们可以在Windows节点上托管一个IIS容器，并通过Linux节点的IP地址对其进行路由。</p><pre class="ol om on oo gt ot ma ou ov aw ow bi"><span id="0ff9" class="nx mv iq ma b gy ox oy l oz pa">apiVersion: v1<br/>kind: Pod<br/>metadata:<br/>  labels:<br/>    name: iis<br/>  name: iis<br/>  namespace: default<br/>spec:<br/>  containers:<br/>  - image: microsoft/iis<br/>    imagePullPolicy: Always<br/>    name: iis<br/>    ports:<br/>    - containerPort: 80<br/>  nodeSelector:<br/>    beta.kubernetes.io/os: windows<br/>---<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  labels:<br/>    name: iis<br/>  name: iis<br/>spec:<br/>  ports:<br/>  - port: 8080<br/>    targetPort: 80<br/>    nodePort: 30080<br/>  selector:<br/>    name: iis<br/>  type: NodePort</span></pre><figure class="ol om on oo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/7ae7d02a48797055c1f0f58417c4eaf1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AS-U20THoHoO6KgSwXHBxQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Kubernetes群集中Windows工作节点上的IIS容器。</figcaption></figure><h1 id="ee72" class="mu mv iq bd mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr bi translated">保存和恢复整个Kubernetes集群</h1><p id="f14f" class="pw-post-body-paragraph kc kd iq ke b kf ns kh ki kj nt kl km kn nu kp kq kr nv kt ku kv nw kx ky kz ij bi translated">与云上的托管Kubernetes集群不同，我在我的MacBook上构建了我自己的本地Kubernetes集群。当我不使用Kubernetes集群时，这个系统会耗尽我的电池。</p><p id="680a" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们可以从控制平面节点到工作节点按顺序保存和恢复群集的每个虚拟机，以避免此问题。</p><figure class="ol om on oo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi pk"><img src="../Images/90eb40648f387ed72ca8b87bd13c098b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AgQDAbpxqxi4vkLuT9p7yQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">我们可以通过将虚拟机从控制平面休眠和恢复到工作节点来节省我们的MacBook电池</figcaption></figure><h1 id="90d3" class="mu mv iq bd mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr bi translated">结论</h1><p id="168a" class="pw-post-body-paragraph kc kd iq ke b kf ns kh ki kj nt kl km kn nu kp kq kr nv kt ku kv nw kx ky kz ij bi translated">首先，我想写的是2020年夏天发布的开源Windows Calico CNI插件。然而，Windows Calico CNI插件需要开发以配置新的WINS架构，这超出了我的工作预算。</p><p id="333c" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">很快，Windows Kubernetes将从docker企业版迁移到containerd中，Windows版本的Docker将解耦到前端CLI和containerd中。这种方法需要一些时间，但当谈到out时，我们可以通过Hyper-V containers打破主机操作系统和容器版本匹配规则之间的严格限制，这需要虚拟化或嵌套虚拟化。</p><p id="f4a1" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如果你有任何进一步的问题或建议，请让我知道。你可以对这篇文章写一个回应。</p></div></div>    
</body>
</html>