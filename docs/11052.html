<html>
<head>
<title>Fast-API with DB Connection Pools</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">具有数据库连接池的快速应用编程接口</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/fast-api-with-db-connection-pools-cdfd6000827?source=collection_archive---------0-----------------------#2022-12-15">https://blog.devgenius.io/fast-api-with-db-connection-pools-cdfd6000827?source=collection_archive---------0-----------------------#2022-12-15</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/4a836c45b30247a383eef81248390192.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*MjB7rdGXTZwaPm6a.jpg"/></div></div></figure><h1 id="4313" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">问题陈述</h1><p id="c943" class="pw-post-body-paragraph kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">当我们编写一个与数据库交互的快速 API 时，我们的系统会有更多的负载，其中大部分时间都被数据库连接占用了。</p><h1 id="6b59" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">数据库连接的一些常见问题</h1><ol class=""><li id="2c44" class="lr ls in kv b kw kx la lb le lt li lu lm lv lq lw lx ly lz bi translated">超过数据库连接限制</li><li id="0363" class="lr ls in kv b kw ma la mb le mc li md lm me lq lw lx ly lz bi translated">数据库连接超时</li><li id="7233" class="lr ls in kv b kw ma la mb le mc li md lm me lq lw lx ly lz bi translated">数据库连接未正确关闭</li><li id="cf7d" class="lr ls in kv b kw ma la mb le mc li md lm me lq lw lx ly lz bi translated">数据库连接未正确释放</li></ol><h1 id="fd8c" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">介绍</h1><p id="fd88" class="pw-post-body-paragraph kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">在这个 API 中，我们将看到如何使用 FastAPI 和 SQLAlchemy 创建一个带有数据库连接池的 API。这样我们就可以使我们的应用程序更具可扩展性和效率。</p><p id="c82b" class="pw-post-body-paragraph kt ku in kv b kw mf ky kz la mg lc ld le mh lg lh li mi lk ll lm mj lo lp lq ig bi translated">我们将在 Fast API 和 Postgres 数据库中创建一个用户模型。我们将使用 SQLAlchemy 作为与数据库交互的 ORM。</p><h1 id="0745" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">要求</h1><ol class=""><li id="80f8" class="lr ls in kv b kw kx la lb le lt li lu lm lv lq lw lx ly lz bi translated">Python 3.6+</li></ol><h1 id="1c66" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">装置</h1><ol class=""><li id="b3f9" class="lr ls in kv b kw kx la lb le lt li lu lm lv lq lw lx ly lz bi translated">克隆存储库</li><li id="05d2" class="lr ls in kv b kw ma la mb le mc li md lm me lq lw lx ly lz bi translated">创建虚拟环境<code class="fe mk ml mm mn b">conda create -n &lt;env_name&gt; python=3.6</code></li><li id="b842" class="lr ls in kv b kw ma la mb le mc li md lm me lq lw lx ly lz bi translated">安装要求<code class="fe mk ml mm mn b">pip install -r requirements.txt</code></li><li id="b4f7" class="lr ls in kv b kw ma la mb le mc li md lm me lq lw lx ly lz bi translated">运行应用程序<code class="fe mk ml mm mn b">uvicorn main:app --reload</code></li></ol><h1 id="6c90" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">步伐</h1><p id="915c" class="pw-post-body-paragraph kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">让我们在<code class="fe mk ml mm mn b">main.py</code>中创建一个用户模型，在这个文件中，我们将提到快速 API，路由器，启动事件，关闭事件和数据库连接。</p><pre class="mo mp mq mr gt ms mn mt bn mu mv bi"><span id="91d8" class="mw jw in mn b be mx my l mz na"># Imports<br/>from fastapi import FastAPI<br/>from routers.user import view as userview<br/>from database import engine<br/>from connection_pool import database_instance<br/>from fastapi.middleware.cors import CORSMiddleware</span></pre><pre class="nb ms mn nc nd aw ne bi"><span id="8347" class="nf jw in mn b gy ng nh l ni na"># Fast API<br/>app = FastAPI()</span><span id="1517" class="nf jw in mn b gy nj nh l ni na">origins = ["*"]<br/># CORS<br/>app.add_middleware(<br/>    CORSMiddleware,<br/>    allow_origins=origins,<br/>    allow_credentials=True,<br/>    allow_methods=["*"],<br/>    allow_headers=["*"],<br/>)</span><span id="f682" class="nf jw in mn b gy nj nh l ni na"># Including routers<br/>app.include_router(userview.router)</span><span id="3ae9" class="nf jw in mn b gy nj nh l ni na"># Start up event<br/>@app.on_event("startup")<br/>async def startup():<br/>    await database_instance.connect()</span><span id="8115" class="nf jw in mn b gy nj nh l ni na"># Main route<br/>@app.get("/")<br/>async def root():<br/>    return {"message": "CMMS APP"}</span></pre><p id="3c4b" class="pw-post-body-paragraph kt ku in kv b kw mf ky kz la mg lc ld le mh lg lh li mi lk ll lm mj lo lp lq ig bi translated">让我们现在在<code class="fe mk ml mm mn b">routers/user/models.py</code>制作一个用户模型我们的模型将会有 id，fname，lname，电子邮件，密码，我们将会使用 SQLAlchemy 作为一个表单来与数据库交互。</p><pre class="mo mp mq mr gt ms mn mt bn mu mv bi"><span id="1876" class="mw jw in mn b be mx my l mz na">from sqlalchemy import Boolean, Column, ForeignKey, Integer, String<br/>from sqlalchemy.orm import relationship<br/>from database import Base</span></pre><pre class="nb ms mn nc nd aw ne bi"><span id="cd6c" class="nf jw in mn b gy ng nh l ni na">class User(Base):<br/>    __tablename__ = "user"</span><span id="1a3b" class="nf jw in mn b gy nj nh l ni na">    id = Column(Integer, primary_key=True, index=True)<br/>    fname = Column(String)<br/>    lname = Column(String)<br/>    email = Column(String)<br/>    password = Column(String)</span></pre><p id="d05c" class="pw-post-body-paragraph kt ku in kv b kw mf ky kz la mg lc ld le mh lg lh li mi lk ll lm mj lo lp lq ig bi translated">现在我们在<code class="fe mk ml mm mn b">routers/user/serializers.py</code>中为用户模型制作了序列化程序，这个序列化程序将帮助我们将数据从数据库转换成 python 对象，反之亦然。</p><pre class="mo mp mq mr gt ms mn mt bn mu mv bi"><span id="8fe9" class="mw jw in mn b be mx my l mz na">from dataclasses import Field<br/>from pydantic import BaseModel, EmailStr<br/>from typing import Optional, List<br/>from datetime import datetime<br/>import uuid</span></pre><pre class="nb ms mn nc nd aw ne bi"><span id="aa02" class="nf jw in mn b gy ng nh l ni na">class UserBase(BaseModel):<br/>    id: int<br/>    fname: str<br/>    lname: str<br/>    email: EmailStr<br/>    password: str</span><span id="2e51" class="nf jw in mn b gy nj nh l ni na">    class Config:<br/>        orm_mode = True</span></pre><p id="d9e2" class="pw-post-body-paragraph kt ku in kv b kw mf ky kz la mg lc ld le mh lg lh li mi lk ll lm mj lo lp lq ig bi translated">现在我们将在<code class="fe mk ml mm mn b">routers/user/view.py</code>文件中为用户制作一个路由器，该文件将包含用户模型的所有路由，这将有助于我们与 API 进行通信。</p><pre class="mo mp mq mr gt ms mn mt bn mu mv bi"><span id="d204" class="mw jw in mn b be mx my l mz na">from fastapi import status, HTTPException, Depends, APIRouter<br/>from sqlalchemy.orm import Session<br/>from database import get_db<br/>from typing import Optional, List<br/>from  routers.user.serializer import UserBase<br/>from  routers.user import models<br/>import time<br/>from connection_pool import database_instance</span></pre><pre class="nb ms mn nc nd aw ne bi"><span id="e260" class="nf jw in mn b gy ng nh l ni na">router = APIRouter(<br/>    prefix="/users",<br/>    tags=['user']<br/>)</span><span id="f3ad" class="nf jw in mn b gy nj nh l ni na"># Create a new area<br/>@router.get("/", status_code=status.HTTP_201_CREATED)<br/>async def get_user(db: Session = Depends(get_db)):<br/>    """ <br/>    This function is to get all users<br/>    """<br/>    try:<br/>        value = await database_instance.fetch_rows(query="SELECT * FROM public.user")<br/>        return  value<br/>    except Exception as err:<br/>        print(err.args[0])<br/>        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,<br/>                            detail=err.args[0])</span></pre><p id="367c" class="pw-post-body-paragraph kt ku in kv b kw mf ky kz la mg lc ld le mh lg lh li mi lk ll lm mj lo lp lq ig bi translated">所以我们的 API 已经准备好了，让我们在<code class="fe mk ml mm mn b">connection_pool.py</code>中建立一个数据库连接池</p><p id="b269" class="pw-post-body-paragraph kt ku in kv b kw mf ky kz la mg lc ld le mh lg lh li mi lk ll lm mj lo lp lq ig bi translated">让我们制作<code class="fe mk ml mm mn b">.env</code>文件</p><pre class="mo mp mq mr gt ms mn mt bn mu mv bi"><span id="69ee" class="mw jw in mn b be mx my l mz na">DATABASE_HOSTNAME="localhost"<br/>DATABASE_PORT="5432"<br/>DATABASE_PASSWORD="postgres"<br/>DATABASE_NAME="test_fastapi"<br/>DATABASE_USERNAME="postgres"</span></pre><p id="ad15" class="pw-post-body-paragraph kt ku in kv b kw mf ky kz la mg lc ld le mh lg lh li mi lk ll lm mj lo lp lq ig bi translated">现在让我们制作一个设置文件，在<code class="fe mk ml mm mn b">settings.py</code>中自动读取<code class="fe mk ml mm mn b">.env</code></p><pre class="mo mp mq mr gt ms mn mt bn mu mv bi"><span id="71e1" class="mw jw in mn b be mx my l mz na">from typing import Optional<br/>from pydantic import BaseSettings</span></pre><pre class="nb ms mn nc nd aw ne bi"><span id="d9f4" class="nf jw in mn b gy ng nh l ni na"># This is a pydantic model for the enviroment variables<br/>class Settings(BaseSettings):<br/>    database_hostname: str<br/>    database_port: str<br/>    database_password: str<br/>    database_name: str<br/>    database_username: str</span><span id="f270" class="nf jw in mn b gy nj nh l ni na">    class Config:<br/>        env_file = ".env"<br/></span><span id="1b4f" class="nf jw in mn b gy nj nh l ni na">settings = Settings()</span></pre><p id="db18" class="pw-post-body-paragraph kt ku in kv b kw mf ky kz la mg lc ld le mh lg lh li mi lk ll lm mj lo lp lq ig bi translated"><code class="fe mk ml mm mn b">connection_pool.py</code>文件将帮助我们与数据库建立连接池</p><pre class="mo mp mq mr gt ms mn mt bn mu mv bi"><span id="c7d5" class="mw jw in mn b be mx my l mz na">import asyncpg<br/># from psycopg2 import pool<br/>from settings import settings<br/></span></pre><pre class="nb ms mn nc nd aw ne bi"><span id="99c4" class="nf jw in mn b gy ng nh l ni na">class Database:<br/>    def __init__(self):<br/>        self.user = settings.database_username<br/>        self.password = settings.database_password<br/>        self.host = settings.database_hostname<br/>        self.port = "5432"<br/>        self.database = settings.database_name<br/>        self._cursor = None</span><span id="d0d2" class="nf jw in mn b gy nj nh l ni na">        self._connection_pool = None<br/>        self.con = None</span><span id="83c6" class="nf jw in mn b gy nj nh l ni na">    async def connect(self):<br/>        if not self._connection_pool:<br/>            try:<br/>                self._connection_pool = await asyncpg.create_pool(<br/>                    min_size=1,<br/>                    max_size=10,<br/>                    command_timeout=60,<br/>                    host=self.host,<br/>                    port=self.port,<br/>                    user=self.user,<br/>                    password=self.password,<br/>                    database=self.database,<br/>                )</span><span id="954e" class="nf jw in mn b gy nj nh l ni na">            except Exception as e:<br/>                print(e)</span><span id="718e" class="nf jw in mn b gy nj nh l ni na">    async def fetch_rows(self, query: str):<br/>        """<br/>        Function to fetch rows from the database<br/>        """<br/>        if not self._connection_pool:<br/>            await self.connect()<br/>        else:<br/>            self.con = await self._connection_pool.acquire()<br/>            try:<br/>                result = await self.con.fetch(query)<br/>                print("Results", result)<br/>                return result<br/>            except Exception as e:<br/>                print(e)<br/>            finally:<br/>                await self._connection_pool.release(self.con)<br/></span><span id="4abe" class="nf jw in mn b gy nj nh l ni na">database_instance = Database()</span></pre><p id="9c21" class="pw-post-body-paragraph kt ku in kv b kw mf ky kz la mg lc ld le mh lg lh li mi lk ll lm mj lo lp lq ig bi translated">现在，让我们在 Postgres 数据库中手动创建一个表，其中包含用户名和列 id、fname、lname、电子邮件、密码</p><pre class="mo mp mq mr gt ms mn mt bn mu mv bi"><span id="0ec7" class="mw jw in mn b be mx my l mz na">CREATE TABLE public.user<br/>(<br/>    id integer NOT NULL DEFAULT nextval('user_id_seq'::regclass),<br/>    fname character varying COLLATE pg_catalog."default" NOT NULL,<br/>    lname character varying COLLATE pg_catalog."default" NOT NULL,<br/>    email character varying COLLATE pg_catalog."default" NOT NULL,<br/>    password character varying COLLATE pg_catalog."default" NOT NULL,<br/>    CONSTRAINT user_pkey PRIMARY KEY (id)<br/>)</span></pre><p id="5900" class="pw-post-body-paragraph kt ku in kv b kw mf ky kz la mg lc ld le mh lg lh li mi lk ll lm mj lo lp lq ig bi translated">现在让我们运行我们的 API</p><pre class="mo mp mq mr gt ms mn mt bn mu mv bi"><span id="2ed1" class="mw jw in mn b be mx my l mz na">uvicorn main:app --reload</span></pre><p id="0240" class="pw-post-body-paragraph kt ku in kv b kw mf ky kz la mg lc ld le mh lg lh li mi lk ll lm mj lo lp lq ig bi translated">现在去你的浏览器，点击<code class="fe mk ml mm mn b">http://localhost:8000/docs/</code>你会看到你的 API 的文档</p><pre class="mo mp mq mr gt ms mn mt bn mu mv bi"><span id="1a99" class="mw jw in mn b be mx my l mz na">[<br/>    {<br/>        "id": 1,<br/>        "fname": "sohaib",<br/>        "lname": "anwaar",<br/>        "email": "sohaibanwaar36@gmail.com"<br/>    }<br/>]</span></pre><h1 id="4fce" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">斯瓦格用户界面</h1><figure class="mo mp mq mr gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nk"><img src="../Images/d310ce3b87bd4fc1a2d112dc06f62d57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*0j-da9urvmbvG_tC.png"/></div></div></figure><h1 id="d6c7" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">GitHub 回购</h1><p id="5c12" class="pw-post-body-paragraph kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated"><a class="ae nl" href="https://github.com/SohaibAnwaar/FastApi-SqlAlchemy" rel="noopener ugc nofollow" target="_blank">https://github.com/SohaibAnwaar/FastApi-SqlAlchemy</a></p><h1 id="9548" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">作者</h1><ul class=""><li id="2c4e" class="lr ls in kv b kw kx la lb le lt li lu lm lv lq nm lx ly lz bi translated">sohaib an war:<a class="ae nl" href="https://www.sohaibanwaar.com/" rel="noopener ugc nofollow" target="_blank">https://www.sohaibanwaar.com</a></li><li id="beac" class="lr ls in kv b kw ma la mb le mc li md lm me lq nm lx ly lz bi translated">Gmail:<a class="ae nl" href="mailto:sohaibanwaar36@gmail.com" rel="noopener ugc nofollow" target="_blank">sohaibanwaar36@gmail.com</a></li><li id="8d8f" class="lr ls in kv b kw ma la mb le mc li md lm me lq nm lx ly lz bi translated">LinkedIn : <a class="ae nl" href="https://www.linkedin.com/in/sohaib-anwaar-4b7ba1187/" rel="noopener ugc nofollow" target="_blank">在这里做一些专业的谈话</a></li><li id="b4b6" class="lr ls in kv b kw ma la mb le mc li md lm me lq nm lx ly lz bi translated">堆栈溢出:<a class="ae nl" href="https://stackoverflow.com/users/7959545/sohaib-anwaar" rel="noopener ugc nofollow" target="_blank">在这里得到我的帮助</a></li><li id="6967" class="lr ls in kv b kw ma la mb le mc li md lm me lq nm lx ly lz bi translated">在这里查看我的杰作</li><li id="f95e" class="lr ls in kv b kw ma la mb le mc li md lm me lq nm lx ly lz bi translated">GitHub : <a class="ae nl" href="https://github.com/SohaibAnwaar" rel="noopener ugc nofollow" target="_blank">在这里查看我的代码</a></li></ul></div></div>    
</body>
</html>