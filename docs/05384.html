<html>
<head>
<title>Monitoring serverless applications with AWS CloudWatch alarms</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS CloudWatch警报监控无服务器应用程序</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/monitoring-serverless-applications-with-aws-cloudwatch-alarms-e3c6deab938c?source=collection_archive---------9-----------------------#2021-07-30">https://blog.devgenius.io/monitoring-serverless-applications-with-aws-cloudwatch-alarms-e3c6deab938c?source=collection_archive---------9-----------------------#2021-07-30</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/32ea16a6538359ea33b6771bb38c3856.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Oa6CGSXwwcDboNnI.png"/></div></div></figure><p id="2b67" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在生产环境中运行任何应用程序都假设<a class="ae kt" href="https://dashbird.io/blog/ultimate-guide-monitoring-serverless-applications/" rel="noopener ugc nofollow" target="_blank">可靠的监控</a>到位，无服务器应用程序也不例外。</p><p id="2942" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">随着现代云应用变得越来越分散和复杂，监控可用性、性能和成本的挑战变得越来越困难。不幸的是，云提供商并没有提供太多现成的服务。虽然您不能完全理解仅使用CloudWatch会发生什么，但这是一个很好的起点，可以将其作为确保服务可用性和性能的第一道防线。</p><p id="b71b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">让我们<strong class="jx io">探索一下用CloudWatch监控</strong>Lambda函数的基本和<strong class="jx io">更复杂的用例。</strong></p><h1 id="73d4" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">您可以收集的CloudWatch指标</h1><p id="81b2" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">CloudWatch收集基本指标，让您能够<a class="ae kt" href="https://dashbird.io/blog/monitoring-vs-observability/" rel="noopener ugc nofollow" target="_blank">观察</a>您的系统运行情况。</p><p id="5cfb" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">对于Lambda函数，收集的指标是:错误、调用、并发、延迟和内存使用。由于<strong class="jx io">当出现问题或即将出现问题时，您不太可能碰巧在准确的时间</strong>检查您的指标，因此最好<strong class="jx io">配置警报</strong>，以防遇到某些<strong class="jx io">意外阈值或条件</strong>，通过各种渠道通知您。</p><h1 id="e022" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">如何设置CloudWatch指标警报</h1><p id="443a" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">您可以配置CloudWatch警报，以便在满足预定义条件的情况下触发SNS主题。SNS触发器然后可以调用Lambda函数，该函数将采取行动通知或可能修复该情况。</p><p id="9b30" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">您将需要使用CloudWatch日志订阅，并将条目与日志中的特定错误模式进行匹配。通过这种方式，您可以自动获得错误通知，而不是手动解析无数行日志。</p><figure class="ly lz ma mb gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi lx"><img src="../Images/9f766e562a270ebaa83ebb93e3aa274f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*s6BDt0vAt4UM3HRw.png"/></div></div></figure><p id="9735" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">解决方案是:</p><ul class=""><li id="bd32" class="mc md in jx b jy jz kc kd kg me kk mf ko mg ks mh mi mj mk bi translated">您可以定义希望收到警报的错误。</li><li id="ce0e" class="mc md in jx b jy ml kc mm kg mn kk mo ko mp ks mh mi mj mk bi translated">CloudWatch Logs捕捉这些错误，并调用Lambda函数来处理错误，通过Amazon SNS topic向您发出警报。</li></ul><p id="60c4" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">让我们为Lambda函数因任何原因失败时配置一个基本警报——下面是部署上述警报的简单指南:</p><p id="ae40" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">创建SNS主题以配置电子邮件订阅</p><p id="c252" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">创建IAM角色和策略</p><p id="8975" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">创建一个Lambda函数，通过SNS提醒你(下面是示例代码)</p><pre class="ly lz ma mb gt mq mr ms mt aw mu bi"><span id="2582" class="mv kv in mr b gy mw mx l my mz"># Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.<br/># Licensed under the Apache License, Version 2.0 (the "License").<br/># You may not use this file except in compliance with the License.<br/># A copy of the License is located at## http://aws.amazon.com/apache2.0/<br/># or in the "license" file accompanying this file.<br/># This file is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,<br/># either express or implied. See the License for the specific language governing permissions<br/># and limitations under the License.<br/># Description: This Lambda function sends an email notification to a given AWS SNS topic when a particular<br/>#              pattern is matched in the logs of a selected Lambda function. The email subject is<br/>#              Execution error for Lambda-&lt;insert Lambda function name&gt;.<br/>#              The JSON message body of the SNS notification contains the full event details.<br/><br/># Author: Sudhanshu Malhotra<br/><br/>import base64<br/>import boto3<br/>import gzip<br/>import json<br/>import logging<br/>import os<br/><br/>from botocore.exceptions import ClientError<br/><br/>logging.basicConfig(level=logging.INFO)<br/>logger = logging.getLogger(__name__)<br/><br/><br/>def logpayload(event):<br/>    logger.setLevel(logging.DEBUG)<br/>    logger.debug(event['awslogs']['data'])<br/>    compressed_payload = base64.b64decode(event['awslogs']['data'])<br/>    uncompressed_payload = gzip.decompress(compressed_payload)<br/>    log_payload = json.loads(uncompressed_payload)<br/>    return log_payload<br/><br/><br/>def error_details(payload):<br/>    error_msg = ""<br/>    log_events = payload['logEvents']<br/>    logger.debug(payload)<br/>    loggroup = payload['logGroup']<br/>    logstream = payload['logStream']<br/>    lambda_func_name = loggroup.split('/')<br/>    logger.debug(f'LogGroup: {loggroup}')<br/>    logger.debug(f'Logstream: {logstream}')<br/>    logger.debug(f'Function name: {lambda_func_name[3]}')<br/>    logger.debug(log_events)<br/>    for log_event in log_events:<br/>        error_msg += log_event['message']<br/>    logger.debug('Message: %s' % error_msg.split("\n"))<br/>    return loggroup, logstream, error_msg, lambda_func_name<br/><br/><br/>def publish_message(loggroup, logstream, error_msg, lambda_func_name):<br/>    sns_arn = os.environ['snsARN']  # Getting the SNS Topic ARN passed in by the environment variables.<br/>    snsclient = boto3.client('sns')<br/>    try:<br/>        message = ""<br/>        message += "\nLambda error  summary" + "\n\n"<br/>        message += "##########################################################\n"<br/>        message += "# LogGroup Name:- " + str(loggroup) + "\n"<br/>        message += "# LogStream:- " + str(logstream) + "\n"<br/>        message += "# Log Message:- " + "\n"<br/>        message += "# \t\t" + str(error_msg.split("\n")) + "\n"<br/>        message += "##########################################################\n"<br/><br/>        # Sending the notification...<br/>        snsclient.publish(<br/>            TargetArn=sns_arn,<br/>            Subject=f'Execution error for Lambda - {lambda_func_name[3]}',<br/>            Message=message<br/>        )<br/>    except ClientError as e:<br/>        logger.error("An error occured: %s" % e)<br/><br/><br/>def lambda_handler(event, context):<br/>    pload = logpayload(event)<br/>    lgroup, lstream, errmessage, lambdaname = error_details(pload)<br/>    publish_message(lgroup, lstream, errmessage, lambdaname)</span></pre><p id="03f0" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如果你需要一个产生错误的Lambda函数来测试，你可以使用亚马逊的这个:</p><pre class="ly lz ma mb gt mq mr ms mt aw mu bi"><span id="b9db" class="mv kv in mr b gy mw mx l my mz">import logging<br/>import os<br/><br/>logging.basicConfig(level=logging.DEBUG)<br/>logger=logging.getLogger(__name__)<br/><br/>def lambda_handler(event, context):<br/>    logger.setLevel(logging.DEBUG)<br/>    logger.debug("This is a sample DEBUG message.. !!")<br/>    logger.error("This is a sample ERROR message.... !!")<br/>    logger.info("This is a sample INFO message.. !!")<br/>    logger.critical("This is a sample 5xx error message.. !!")</span></pre><p id="fa37" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">代码来源:亚马逊</p><h1 id="60a0" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">设置指标警报的最佳实践</h1><p id="250b" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">那么什么时候应该配置度量警报呢？</p><p id="1e86" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">一般来说，<strong class="jx io">您只希望在需要您关注的情况下收到提醒</strong>。如果你创造了一个<strong class="jx io">警报过于频繁</strong>的情况，并且对它们的响应是可选的，那么<strong class="jx io">不用多久就会因为噪音</strong>或者更糟的情况而错过一个关键警报——开始完全忽略警报。</p><p id="82b3" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">例如，<strong class="jx io">你可以问自己这些问题</strong>:对于一个特定的Lambda函数，如果所有请求中有1%失败，这样可以吗？也许请求不超过1秒很重要？您可能想知道您的Lambdas是否达到了帐户范围的并发限制。<strong class="jx io">每个应用</strong>的设置都是独立的，通常需要一些<strong class="jx io">时间和迭代</strong>才能正确设置。</p><p id="993e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">另一件要考虑的事情是，您是否应该尝试<strong class="jx io">配置本质上是预防性的</strong>警报——当<strong class="jx io">某个东西尚未失败但可能很快就会失败时触发</strong>。例如，如果一个<a class="ae kt" href="https://dashbird.io/blog/task-timed-out-after-x-seconds/" rel="noopener ugc nofollow" target="_blank"> Lambda函数接近超时</a>或非常接近其内存容量？</p><h2 id="7503" class="mv kv in bd kw na nb dn la nc nd dp le kg ne nf li kk ng nh lm ko ni nj lq nk bi translated">在CloudWatch上设置自定义指标</h2><p id="8691" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">一旦你定义了你对指标的需求，你就可以开始一个接一个地设置它们<strong class="jx io">。</strong></p><p id="5f0c" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这也可以通过CloudWatch来完成。亚马逊在这里分享了一些你可以效仿的例子<a class="ae kt" href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/MonitoringPolicyExamples.html" rel="noopener ugc nofollow" target="_blank">，但这是一项相当<strong class="jx io">繁琐的任务</strong>，不仅要<strong class="jx io">正确配置它们</strong>，还要确保<strong class="jx io">一切都保持最新</strong>并与你不断增长的应用程序一起正常工作<strong class="jx io">。</strong></a></p><h1 id="25a2" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">使用CloudWatch警报是一个很好的第一道防线，但是<strong class="ak">仅仅通过CloudWatch调试应用程序既困难又耗时</strong>，尤其是当您的函数有大量调用时。</h1><p id="16f2" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">从上面的内容可以看出，<strong class="jx io">为最基本的指标创建警报是一项相当烦人的任务</strong>。定制指标的警报也是大量的工作。有一个更简单、更好的解决方案——dash bird的自动预配置警报！<a class="ae kt" href="https://dashbird.io/failure-detection/" rel="noopener ugc nofollow" target="_blank"> Dashbird的自动警报</a>监听来自日志和指标的事件，捕捉代码异常、缓慢的API响应、失败的数据库请求和缓慢的队列，并且如果有任何问题即将发生，将通过Slack、电子邮件、SNS或Webhooks立即通知您错误，以便您可以在任何问题开始影响您的客户之前快速介入并解决它。</p><figure class="ly lz ma mb gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nl"><img src="../Images/c22a49a7fdf2eb50713c791ae55ad6d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*2G9eWrKryZEwYxJD.png"/></div></div></figure><p id="ef5e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">不需要额外的工具</strong>,所以你今天就可以开始使用它，你不需要重新部署你的Lambda函数。Dashbird会为所有受支持的AWS资源设置指标和警报，因此您不必这么做。这些是基于多年来为Dashbird客户监控无服务器系统的经验，我们有超过5，000个AWS帐户连接并接收监控数据。</p><p id="a17d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们构建Dashbird是为了让无服务器的监控、调试和警报<strong class="jx io">变得简单明了</strong>，而不会丢失粒度。Dashbird不仅检测故障，它还<strong class="jx io">将您指向确切的请求</strong>，向您显示日志、X射线跟踪和该调用的相关元数据。</p><figure class="ly lz ma mb gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nm"><img src="../Images/53461f9c3943cb15d0124b595e20849d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*PNhkUgJw3bbj_jQT.png"/></div></div></figure><p id="1563" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">最后，我们使用AWS <a class="ae kt" href="https://aws.amazon.com/architecture/well-architected/" rel="noopener ugc nofollow" target="_blank">架构良好的框架</a>——来自AWS的官方资源，用于在AWS云上构建和维护应用程序。</p><p id="a5d1" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><a class="ae kt" href="https://app.dashbird.io/auth/register" rel="noopener ugc nofollow" target="_blank"> <strong class="jx io">免费试用dash bird</strong></a></p><p id="8237" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">延伸阅读:</p><ul class=""><li id="010c" class="mc md in jx b jy jz kc kd kg me kk mf ko mg ks mh mi mj mk bi translated"><a class="ae kt" href="https://dashbird.io/blog/ultimate-guide-monitoring-serverless-applications/" rel="noopener ugc nofollow" target="_blank">监控无服务器应用的终极指南</a></li><li id="d9a7" class="mc md in jx b jy ml kc mm kg mn kk mo ko mp ks mh mi mj mk bi translated"><a class="ae kt" href="https://dashbird.io/blog/lambda-metrics-monitoring-what-matters/" rel="noopener ugc nofollow" target="_blank">您应该监控的λ指标</a></li></ul></div></div>    
</body>
</html>