<html>
<head>
<title>Refresher Project —Part 2: Explaining how to build a simple infrastructure with Django, Celery, Redis, Grafana and Prometheus</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">复习项目—第 2 部分:解释如何用 Django、Celery、Redis、Grafana 和 Prometheus 构建一个简单的基础设施</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/refresher-project-part-2-explaining-how-to-build-a-simple-infrastructure-with-django-celery-ddf7a797c791?source=collection_archive---------4-----------------------#2022-07-15">https://blog.devgenius.io/refresher-project-part-2-explaining-how-to-build-a-simple-infrastructure-with-django-celery-ddf7a797c791?source=collection_archive---------4-----------------------#2022-07-15</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="9dba" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">深入演练复习项目的主要组件，以及如何从头开始构建基础架构和系统设计…</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ki"><img src="../Images/728dc780c6e599dbd60306edee4cfb29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1224/format:webp/1*C5zN9Ax0oWIexZJclP5Kfg.jpeg"/></div></figure></div><div class="ab cl kq kr hr ks" role="separator"><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv"/></div><div class="ig ih ii ij ik"><p id="20b1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><a class="ae kx" href="https://medium.com/@ibrahimroshdy/refresher-project-a-glimpse-of-system-design-and-architecture-aaef28510dd4" rel="noopener">复习项目:对系统设计和架构的一瞥</a>解释了一个简单复习项目背后架构的概述(鸟瞰图)。虽然这并不是设计的惊鸿一瞥，但更多的是把许多组件放在那里，想象它们是如何一起工作的。在本文中，我将深入研究项目的实际组成部分，以及我如何构建基础设施。</p><h1 id="a7b0" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">头脑风暴</h1><p id="a404" class="pw-post-body-paragraph jk jl in jm b jn lw jp jq jr lx jt ju jv ly jx jy jz lz kb kc kd ma kf kg kh ig bi translated">在尝试任何实现之前，您应该总是集思广益。在头脑风暴阶段，人们倾向于总是想到想法本身。你集思广益的想法越多，它就越成长和扩展。你开始添加特殊的功能，增加了想法本身的复杂性。你突然创造了一个产品的概念。然而，在头脑风暴/创造力和功能性相遇的地方，有一条细微的界限——一个虚拟的界限。在 refresher project 案例中，我没有对想法进行头脑风暴，而是对组件和工具进行头脑风暴。换句话说，从系统设计的鸟瞰图开始——从有目标的更大范围开始，然后找到合适的工具使其发挥作用。我在我的系统中布置了我想要的基本功能，比如<em class="mb">数据库存储</em>、<em class="mb">资源监控</em>和<em class="mb">信息图表</em>。最后，这些功能现在是系统的目标。</p><p id="07e1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在这个项目中,<em class="mb">目标</em>本身不是一个想法或产品，它是一个更新项目，对于一个技术热情的软件开发人员来说，它有复杂的组件来更新他们的技术技能。记住这一点，任何想法或产品都可以很容易地添加到项目中。</p><p id="83e0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我通过分离和组织以下三个主题来开始这个项目的头脑风暴:</p><ol class=""><li id="d857" class="mc md in jm b jn jo jr js jv me jz mf kd mg kh mh mi mj mk bi translated">系统架构</li><li id="e7b2" class="mc md in jm b jn ml jr mm jv mn jz mo kd mp kh mh mi mj mk bi translated">技术栈</li><li id="16c7" class="mc md in jm b jn ml jr mm jv mn jz mo kd mp kh mh mi mj mk bi translated">编程；编排</li></ol><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi mq"><img src="../Images/ec6b3678e0fa72ff7d3c0b5f0293265f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pLTuy5BNQfrfpaInfm8jLg.png"/></div></div><figcaption class="mv mw gj gh gi mx my bd b be z dk translated">图 1:项目中的三个主要主题</figcaption></figure><h1 id="2f94" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">了解数据流</h1><p id="8903" class="pw-post-body-paragraph jk jl in jm b jn lw jp jq jr lx jt ju jv ly jx jy jz lz kb kc kd ma kf kg kh ig bi translated">在<a class="ae kx" href="https://medium.com/@ibrahimroshdy/refresher-project-a-glimpse-of-system-design-and-architecture-aaef28510dd4" rel="noopener">复习项目:第 1 部分</a>中，重点是 Django 和芹菜之间的联系。Django 是提供有组织的数据访问的 web 框架工具，而 Celery 是执行和组织预定任务的异步任务管理器。最后，Grafana 作为每个数据库的分析和可视化解决方案。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi mz"><img src="../Images/959b27e6475648ff9cd1a67c55c70373.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8kBgiUWttB-UP2b997pZHA.png"/></div></div><figcaption class="mv mw gj gh gi mx my bd b be z dk translated">图 2:姜戈、芹菜、雷迪思格拉法纳的组件视图</figcaption></figure><p id="fca8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">Grafana 的额外好处之一是能够连接许多不同的数据源。其中一个数据源是 refresher 系统中的 PostgresSQL。随着 celery 任务的执行，它通过 Django 向数据库添加一个数据库条目。</p><p id="2f03" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让我们分解一下运行中的组件，以便更好地理解实际发生了什么。使用第一个主题<strong class="jm io">系统架构，</strong>我描绘了一个用于资源管理、数据库、任务队列和可视化的后端。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi na"><img src="../Images/1272748ca763e92c4c0aaa7ef5db7bb8.png" data-original-src="https://miro.medium.com/v2/resize:fit:406/format:webp/1*A0WWxAWU9jj0nSaOO2sLBw.png"/></div><figcaption class="mv mw gj gh gi mx my bd b be z dk translated">图 3:识别系统组件</figcaption></figure><p id="e2ee" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">理解数据如何从一个资源传输到另一个资源的数据流是软件架构的关键。例如从<em class="mb">图 3 </em>开始到<em class="mb">图 2 </em>只有通过理解数据流的要求。然而，数据流并不总是连续的，您可以在处理新数据的同时监视数据，即读取当前和过去的数据。那是两条不同的数据流线。为了更好地理解 refresher 项目的数据流，让我们从用户交互点开始。用户可以完成两项主要任务:</p><ol class=""><li id="d4d5" class="mc md in jm b jn jo jr js jv me jz mf kd mg kh mh mi mj mk bi translated">用户可以计划任务</li><li id="d9ba" class="mc md in jm b jn ml jr mm jv mn jz mo kd mp kh mh mi mj mk bi translated">用户可以访问仪表板</li></ol><p id="6942" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">为了完成这两个主要任务，你需要在你的组件中识别用户体验，这就引出了第二个主要话题，即<strong class="jm io">技术栈</strong>。</p><p id="8179" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">技术堆栈选择是软件工程师技能集、研究和执行能力的组合。熟练使用工具和完全初学者状态下使用工具/库之间的平衡是关键。<em class="mb">我建议经常查看</em><a class="ae kx" href="https://www.producthunt.com/" rel="noopener ugc nofollow" target="_blank"><em class="mb">product hunt</em></a><em class="mb">寻找一些最新的软件工具，这些工具可以帮助你提高研究技能，让你随时了解即将到来的工具。</em></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/45120b7233217fc4b74a024897172d55.png" data-original-src="https://miro.medium.com/v2/resize:fit:492/format:webp/1*J-ZNTNvRp2iYp0hNGAmmjg.png"/></div><figcaption class="mv mw gj gh gi mx my bd b be z dk translated">图 5:识别技术堆栈</figcaption></figure><p id="de0d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">因此，在对兼容性、支持和易于实施性进行研究后，您可以选择并了解您的技术组合。你可能会比你想象的更频繁地这么做！同样，如果你在 API 方法、CI 工具等之间进行比较，你会遵循同样的迭代过程。</p><p id="76e8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">最后，最后一个主题是将所有这些工具结合在一起，以达到上面的图 2。使用我们上面确定的两个主要任务，作为一个简单的目标，开始构建你的数据流图。这将导致一个初步的系统设计，其中你有一个基本的基础设施。</p></div><div class="ab cl kq kr hr ks" role="separator"><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv"/></div><div class="ig ih ii ij ik"><h1 id="56d8" class="ky kz in bd la lb nc ld le lf nd lh li lj ne ll lm ln nf lp lq lr ng lt lu lv bi translated">构建简单的基础设施</h1><p id="2b4f" class="pw-post-body-paragraph jk jl in jm b jn lw jp jq jr lx jt ju jv ly jx jy jz lz kb kc kd ma kf kg kh ig bi translated">如果你仔细观察，会发现有些工具，如<strong class="jm io"> redis </strong>和<strong class="jm io"> Prometheus </strong>在<em class="mb">图 2 和图 8 </em>的设计中，但没有包括在数据流图中。这正是这两个组件最终出现在系统设计中的原因。它更像是另一个组件需要的依赖项，但在研究阶段没有准备好。我们以<strong class="jm io"> redis </strong>为例。</p><p id="ca2e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在<a class="ae kx" href="https://medium.com/@ibrahimroshdy/refresher-project-a-glimpse-of-system-design-and-architecture-aaef28510dd4" rel="noopener">refresh Project:一瞥系统设计和架构</a>中，解释了 Django 如何使用一个芹菜库来将任务存储在数据库中。这意味着有一个用 Django 编码的已定义任务，该任务的引用点存储在数据库中。使用 Django，您可以组合任务的参考点，并选择在任何给定的时间执行它。那么，在指定的执行时间，任务执行过程中实际发生了什么呢？这就是<strong class="jm io">芹菜打，芹菜工，雷迪斯的工作。</strong>异步任务管理器——Celery——将至少有两个主进程在运行，一个用于 Celery Beat(将其视为任务收集器),一个或多个用于 Celery Worker(将其视为任务工作器)。Django 通过在数据库中存储任务参考点来帮助 celery，但是在运行时(任务执行运行时),收集器和工作器将在哪里存储它们的数据呢？换句话说，芹菜工人将如何知道执行哪个任务？</p><p id="914c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如上图<em class="mb">图 2 </em>所示，简单来说就是<strong class="jm io"><em class="mb"/></strong>芹菜打桩机将收集计划执行的任务，并将该任务存储到内存数据库中的 redis 中以供拾取。一旦任务的时间到来，芹菜工人将执行该任务。</p><h2 id="23fb" class="nh kz in bd la ni nj dn le nk nl dp li jv nm nn lm jz no np lq kd nq nr lu ns bi translated">Grafana &amp; PostgresSQL</h2><p id="3060" class="pw-post-body-paragraph jk jl in jm b jn lw jp jq jr lx jt ju jv ly jx jy jz lz kb kc kd ma kf kg kh ig bi translated">到目前为止，我们已经讨论了 Django、PostgresSQL、Celery、Redis 和 Grafana 之间的联系。普罗米修斯在哪里？或者说什么是<strong class="jm io">普罗米修斯</strong>？</p><p id="7030" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们先来复习一下 Grafana 和 PostgresSQL。如前所述，Grafana 的一个关键特性是能够连接多个数据源。不同类型的不同数据源，如基于 SQL 的数据源或基于非 SQL 的数据源，以及对两者应用自定义查询的能力。<br/>在我们当前的数据库设计中，我们在 PostgresSQL 数据库中有以下表格。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi nt"><img src="../Images/c33dd52f8212e8e3e593bd1cc5245d6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*73RlwZIfAt0060v0ZSm6gA.png"/></div></div><figcaption class="mv mw gj gh gi mx my bd b be z dk translated">图 6:数据库表</figcaption></figure><p id="c08f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这些表中的数据可以通过一些简单的查询转换成 Grafana 仪表板。</p><blockquote class="nu nv nw"><p id="4077" class="jk jl mb jm b jn jo jp jq jr js jt ju nx jw jx jy ny ka kb kc nz ke kf kg kh ig bi translated"><em class="in">查看此仪表盘的公共版</em> <a class="ae kx" href="https://speedtester.withnoedge.tech/d/SvuObl97k/speed-test-dashboard?orgId=2&amp;from=1655301852804&amp;to=1657893852804" rel="noopener ugc nofollow" target="_blank"> <em class="in">此处</em> </a></p></blockquote><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi oa"><img src="../Images/4381837e4cf48c117f7559fedf85c427.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m14mbQB_F2E7QL8UPbtHBg.png"/></div></div><figcaption class="mv mw gj gh gi mx my bd b be z dk translated">图 7:来自 PostgresSQL 数据库的 grafana 仪表板</figcaption></figure><h2 id="f774" class="nh kz in bd la ni nj dn le nk nl dp li jv nm nn lm jz no np lq kd nq nr lu ns bi translated">普罗米修斯</h2><p id="4164" class="pw-post-body-paragraph jk jl in jm b jn lw jp jq jr lx jt ju jv ly jx jy jz lz kb kc kd ma kf kg kh ig bi translated">所以我想到了一个我觉得每个开发者都应该问的问题:</p><blockquote class="nu nv nw"><p id="12b2" class="jk jl mb jm b jn jo jp jq jr js jt ju nx jw jx jy ny ka kb kc nz ke kf kg kh ig bi translated"><em class="in">如果我可以可视化和监控我的数据，为什么我不能对我的资源做同样的事情呢？</em></p></blockquote><p id="d930" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我想使用 Grafana 来监控我的资源(任何计算或存储资源)。我重复了上面讨论的三个主要主题，经过研究，我发现了一个名为<strong class="jm io"> Prometheus </strong>的兼容工具——一个开源监控系统，具有维度数据模型、灵活的查询语言、高效的时间序列数据库和现代警报方法<strong class="jm io">。</strong></p><p id="2247" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在系统设计中加入普罗米修斯后，少了一些<strong class="jm io"> <em class="mb">出口商</em> </strong>。数据导出器从一种形式获取数据，并将其翻译成普罗米修斯语言。例如，为了从 PostgreSQL 数据库中收集资源监控数据，您将需要 PostgreSQL 和 Prometheus 之间的转换器。因此，每当您想到 Prometheus 时，请始终记住，您需要一个数据导出器来导出您想要监视的资源。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi ob"><img src="../Images/5efb66f5f0207bb4cde98c12b48e09a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HtgVHb3H5ar2kWmrJ3Kwzg.png"/></div></div><figcaption class="mv mw gj gh gi mx my bd b be z dk translated">图 8:刷新架构</figcaption></figure><h2 id="54eb" class="nh kz in bd la ni nj dn le nk nl dp li jv nm nn lm jz no np lq kd nq nr lu ns bi translated">格拉夫纳-普罗米修斯公司</h2><p id="9ad4" class="pw-post-body-paragraph jk jl in jm b jn lw jp jq jr lx jt ju jv ly jx jy jz lz kb kc kd ma kf kg kh ig bi translated">将 Prometheus 作为数据源添加到 Grafana 后，Grafana 现在可以访问来自<em class="mb">出口商</em>的所有数据。这意味着您可以做与可视化您的数据点相同的事情，如图<em class="mb">图 7 </em>所示。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi oc"><img src="../Images/8af5c346c7f4e5c32b2569c3b65bc9bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oes8wVM6odPj0gsNy0UqXg.png"/></div></div><figcaption class="mv mw gj gh gi mx my bd b be z dk translated">图 Grafana 上的 Postgres 监控</figcaption></figure></div><div class="ab cl kq kr hr ks" role="separator"><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv"/></div><div class="ig ih ii ij ik"><h1 id="cf4e" class="ky kz in bd la lb nc ld le lf nd lh li lj ne ll lm ln nf lp lq lr ng lt lu lv bi translated">谢谢！</h1><p id="64e2" class="pw-post-body-paragraph jk jl in jm b jn lw jp jq jr lx jt ju jv ly jx jy jz lz kb kc kd ma kf kg kh ig bi translated">请务必点击查看现场仪表盘<a class="ae kx" href="https://speedtester.withnoedge.tech/d/SvuObl97k/speed-test-dashboard?orgId=2&amp;from=1655301852804&amp;to=1657893852804" rel="noopener ugc nofollow" target="_blank">！</a></p><p id="ccc5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">接下来:</strong>复习项目的技术设置！</p></div></div>    
</body>
</html>