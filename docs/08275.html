<html>
<head>
<title>Windows Function in SQL-PART2:</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">SQL 中的 Windows 函数-第 2 部分:</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/windows-function-in-sql-part2-a9cd99562eaa?source=collection_archive---------8-----------------------#2022-06-01">https://blog.devgenius.io/windows-function-in-sql-part2-a9cd99562eaa?source=collection_archive---------8-----------------------#2022-06-01</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="c9c2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">概要:</strong></p><p id="bc47" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">窗口函数是一个聚合函数，它对与当前行相关的一组行执行计算，同时保留单个行。</p><p id="47ec" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">通常，窗口函数是用最少的代码聚集和显示全部信息的实用方法。窗口函数比使用子查询或复杂的物化表结构更容易。</p><p id="ac7a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">仅供参考:代码可以在许多在线编辑器上执行。我用过 https://sqliteonline.com/<a class="ae ki" href="https://sqliteonline.com/" rel="noopener ugc nofollow" target="_blank">的</a></p><p id="4b9e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">创建表格的语法:</strong></p><p id="5e75" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">创建表 student_table(</p><p id="ff2b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">std_id 整数不为空，</p><p id="1c57" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">std_name 文本不为空，</p><p id="4181" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">dept_name 文本不为空，</p><p id="b6e1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">total_marks 整数不为空，</p><p id="453e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">std_year 整数不为空</p><p id="b91e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi">);</p><p id="7b19" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">插入样本数据的语法:</strong></p><p id="52ee" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">插入 student_table 值(101，' stu_1 '，' computer_science '，90，2015)；</p><p id="5588" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">可以根据需要插入任意多的行。</p><p id="d44b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">考虑一个名为“student_table”的表，该表包含列 std_id、std_name、dept_name 和 total_marks。student_table 中的数据可以使用以下方式显示:</p><p id="06f4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">Select * from student_table</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/ef734657241af551db260c7ffc543bac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*8Kjhyny2_8MO4Xfi.png"/></div></div></figure><p id="336f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> RANK () </strong></p><p id="2379" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">RANK()函数是一个窗口函数，可在 SQL Server 中用于计算结果集的分区内每一行的排名。相同的等级被分配给分区中具有相同值的行。第一行的等级是 1</p><p id="f251" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">可以使用 Rank()函数(这是一个 windows 函数)根据学生的总分数对系里的每个学生进行排名。根据分数，我们会给每个系的每个学生分配一个等级。</p><p id="1465" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">查询:</strong></p><p id="a52b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">选择 s.*，</p><p id="0760" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">将(按部门名称划分，按总分数排序，desc)排名()为 R</p><p id="8148" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">from student _ table as s；</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/3978613f8e474ad2655a08aedf7dd161.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*m1qIAVShK7b4podr.png"/></div></div></figure><p id="4d54" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在上面的例子中，系里的两个学生有相同的总分数，因此将为他们分配相同的等级，对于每个重复的值，等级函数将跳过下一个值。在艺术系 stu_10，stu_11 得了 88 分，因此他们两个都被指定为排名第一，然后排名第二被跳过。</p><p id="cf3a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在同一个部门 stu_12 和 stu_13 得到了相同的 84 分，因此将等级 3 分配给他们两个，然后跳过下一个等级。</p><p id="f9f4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">使用 Rank()函数可以获得每个系中基于最高分数的前 3 名学生。</p><p id="a618" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">查询:</strong></p><p id="86f4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">select t.* from(</p><p id="3de6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">选择 s.*，</p><p id="1b5f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">将(按部门名称划分，按总分数排序，desc)排名()为 R</p><p id="de46" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">从 student_table 作为 s ) t</p><p id="00dd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">其中 R &lt;4 ;</p><p id="f8ac" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">o/p:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/0c8c13e631fe4ff3f5d8c356e7e59b6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*GRsBzjMdBgVWWSQA.png"/></div></div></figure><p id="1702" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">in the above example students who have rank less than 4 or the top 3 students who have got the max total marks are displayed.</p><p id="c94d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> DENSE_RANK(): </strong></p><p id="9145" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">DENSE_RANK()是一个窗口函数，它为结果集分区内的每一行分配一个等级。与 RANK()函数不同，DENSE_RANK()函数返回连续的等级值。如果每个分区中的行具有相同的值，它们将获得相同的等级。</p><p id="befe" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在上面的示例中，如果两个人具有相同的等级 1，则跳过等级 2，然后正在分配等级 3，如果必须在不跳过的情况下分配等级 2，则可以使用 dense_rank()。</p><p id="fa16" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">查询:</strong></p><p id="b6dc" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">选择 s.*，</p><p id="c5a3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">RANK()over(partition by dept _ name order by total _ marks desc)为 R，</p><p id="d85b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">DENSE_RANK()over(partition by dept _ name order by total _ marks desc)作为 DENSE _ RANK</p><p id="274a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">从 student_table 作为</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/984682c5395b6640f13fd4177ea22ba4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*D86_1x6Yx2ELJOMj.png"/></div></div></figure><p id="f26d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">滞后()</strong></p><p id="fe95" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们使用 Lag()函数根据定义的偏移值访问前面的行数据。这是一个窗口函数。大多数组织使用或比较同比增长。rank()函数可以用来做这件事。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/0fef22465dfb83ab7532636bd989ee3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ipNQgAvIbybJBozP.png"/></div></div></figure><p id="f220" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">使用 Lag()函数可以将学生的成绩与去年进行比较。该查询将获取前一年的分数，然后将它们插入同一行。</p><p id="1c24" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">第一行没有任何先前的值，因此插入 null。使用 Lag()函数有助于避免报告层的复杂计算。</p><p id="ead9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">查询:</strong></p><p id="18d4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">选择*，</p><p id="6811" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">作为 stu_lag 的滞后(total_marks)超过(按部门名称分类，按标准年份、标准标识 desc 排序)</p><p id="0f23" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">来自学生 _ 表</p><p id="5b2c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> o/p: </strong></p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/cb1015fb897b972c88efe689cf3b5ce3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*qwAXkoPAxqqSq0JU.png"/></div></div></figure><p id="911f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">结论:</strong></p><p id="705f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">SQL 窗口函数是类似于聚合函数的计算函数，但与“group by”等普通聚合函数不同，它可以访问单个行，甚至可以将它们的一些属性添加到结果集中。</p></div></div>    
</body>
</html>