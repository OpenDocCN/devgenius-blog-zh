<html>
<head>
<title>Stockpile â€” Store Request and Response</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">åº“å­˜â€”â€”å•†åº—è¯·æ±‚å’Œå“åº”</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://blog.devgenius.io/stockpile-store-request-and-response-8075a3e02515?source=collection_archive---------18-----------------------#2022-02-19">https://blog.devgenius.io/stockpile-store-request-and-response-8075a3e02515?source=collection_archive---------18-----------------------#2022-02-19</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/775eafadf422866fa43783fc3357dea0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_iigHJkapI6rx5TXz9-Mrw.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">ä¸€ä»¶â€”â€”ä»€ä¹ˆï¼Ÿä½ ä¸ç”¨è‚¡ç¥¨å †ï¼Ÿ</figcaption></figure><p id="3e7a" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">å¯¹äºå¤§å¤šæ•°åº”ç”¨ç¨‹åºæ¥è¯´ï¼Œå­˜å‚¨ API çš„è¯·æ±‚å’Œå“åº”éå¸¸é‡è¦ï¼Œå°¤å…¶æ˜¯åœ¨ä¸å¤–éƒ¨æœåŠ¡æä¾›è€…é›†æˆæ—¶ã€‚<br/>è®°å½•è¿™äº›ä¿¡æ¯å¯ä»¥è§£å†³å¤§å¤šæ•°ç”¨ä¾‹ï¼Œä½†æ˜¯å½“è¯·æ±‚/å“åº”åŒ…å«æ•æ„Ÿä¿¡æ¯æ—¶å¯èƒ½å°±ä¸è¡Œäº†ã€‚</p><p id="fd07" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸€ç§æ–¹æ³•æ˜¯åŠ å¯†å¹¶å­˜å‚¨è¯·æ±‚å’Œå“åº”ï¼›è¿™æ­£æ˜¯æˆ‘ä»¬åœ¨è¿™ç¯‡æ–‡ç« ä¸­è¦åšçš„ã€‚</p><p id="7146" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">æ¦‚è¿°:<br/> 1ã€‚å…¶è¯·æ±‚å’Œå“åº”å°†è¢«å­˜å‚¨çš„æ–¹æ³•/å‘½ä»¤è¢«æ ‡æ³¨ä¸º<code class="fe kx ky kz la b">@StockPile</code> <br/> 2ã€‚è¦å­˜å‚¨çš„æ–¹æ³•çš„å‚æ•°ç”¨<code class="fe kx ky kz la b">@Item</code>æ ‡æ³¨ã€‚<br/> 3ã€‚æ–¹æ³•æ‹¦æˆªå™¨æ¥åŠ å¯†å’Œå­˜å‚¨è¿™äº›æ–¹æ³•çš„è¯·æ±‚ã€å“åº”/å¼‚å¸¸ã€‚</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="5421" class="lj lk in la b gy ll lm l ln lo">@Retention(RetentionPolicy.RUNTIME)<br/>@Target({METHOD})<br/>@BindingAnnotation<br/>public @interface StockPile {<br/>}</span></pre><p id="90b0" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><code class="fe kx ky kz la b">@StockPile</code>æ³¨é‡Šä»…é’ˆå¯¹æ–¹æ³•ï¼Œ<code class="fe kx ky kz la b">@Target</code> â€”æ–¹æ³•</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="9aaa" class="lj lk in la b gy ll lm l ln lo">@Retention(RetentionPolicy.RUNTIME)<br/>@Target({FIELD, PARAMETER})<br/>@BindingAnnotation<br/>public @interface Item {<br/>}</span></pre><p id="e5f0" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><code class="fe kx ky kz la b">@Item</code>è¡¨ç¤ºæ–¹æ³•çš„å‚æ•°ï¼Œ<code class="fe kx ky kz la b">@Target</code> â€”å‚æ•°</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="b387" class="lj lk in la b gy ll lm l ln lo">@Slf4j<br/>public class StockPileModule extends AbstractModule {</span><span id="3888" class="lj lk in la b gy lp lm l ln lo">    @Override<br/>    protected void configure() {<br/>        final StockPileInterceptor stockPileInterceptor = new StockPileInterceptor();<br/>        requestInjection(stockPileInterceptor);<br/>        bindInterceptor(Matchers.any(), Matchers.annotatedWith(StockPile.class), stockPileInterceptor);<br/>    }</span><span id="75a8" class="lj lk in la b gy lp lm l ln lo">    @VisibleForTesting<br/>    public static class StockPileInterceptor implements MethodInterceptor {</span><span id="80b8" class="lj lk in la b gy lp lm l ln lo">        @VisibleForTesting<br/>        @Inject<br/>        protected YourEncryptionService encryptionService;</span><span id="798d" class="lj lk in la b gy lp lm l ln lo">        @VisibleForTesting<br/>        @Inject<br/>        protected YourStorageService storageDao;</span><span id="ddd2" class="lj lk in la b gy lp lm l ln lo">        @VisibleForTesting<br/>        @Inject<br/>        protected ObjectMapper objectMapper;</span><span id="74b8" class="lj lk in la b gy lp lm l ln lo">        @Override<br/>        public Object invoke(MethodInvocation invocation) throws Throwable {<br/>            final Optional&lt;Annotation&gt; optionalAnnotation = Stream.of(invocation.getMethod().getDeclaredAnnotations())<br/>                    .filter(annotation -&gt; annotation instanceof StockPile)<br/>                    .findFirst();</span><span id="b10d" class="lj lk in la b gy lp lm l ln lo">            if (optionalAnnotation.isPresent()) {<br/>                List&lt;Object&gt; requests = new ArrayList&lt;&gt;();<br/>                final String methodName = invocation.getMethod().getName();<br/>                final Annotation[][] parameterAnnotations = invocation.getMethod().getParameterAnnotations();</span><span id="972b" class="lj lk in la b gy lp lm l ln lo">                for (int index = 0; index &lt; parameterAnnotations.length; ++index) {<br/>                    for (final Annotation annotation : parameterAnnotations[index]) {<br/>                        if (annotation instanceof Item) {<br/>                            requests.add(invocation.getArguments()[index]);<br/>                        }<br/>                    }<br/>                }<br/>                final Object response;<br/>                try {<br/>                    response = invocation.proceed();<br/>                    storageDao.save(requests, response, methodName);<br/>                } catch (Exception e) {<br/>                    storageDao.save(requests, e, methodName);<br/>                    throw e;<br/>                }<br/>                return response;<br/>            }<br/>            return invocation.proceed();<br/>        }<br/>    }   <br/>}</span></pre><p id="cff9" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">è¿™ç¯‡æ–‡ç« çš„èŒƒå›´æ˜¯æ¦‚æ‹¬è¯·æ±‚å’Œå“åº”çš„å­˜å‚¨ã€‚ç”±å¼€å‘äººå‘˜å†³å®šå­˜å‚¨è¿™äº› blobs çš„åŠ å¯†å’Œæ•°æ®å­˜å‚¨ç±»å‹(NoSQLï¼Œå¦‚ AeroSpike æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©)ã€‚</p><p id="b619" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">æ­£å¦‚åœ¨ä¸Šé¢çš„æ–¹æ³•æ‹¦æˆªå™¨ä¸­çœ‹åˆ°çš„ï¼Œæˆ‘ä»¬é¦–å…ˆéªŒè¯æ–¹æ³•æ˜¯å¦ç”¨<code class="fe kx ky kz la b">@StockPile</code>æ³¨é‡Šï¼Œç„¶åæ‰€æœ‰ç”¨<code class="fe kx ky kz la b">@Item</code>æ³¨é‡Šçš„å‚æ•°è¢«æ·»åŠ åˆ°<code class="fe kx ky kz la b">List&lt;Object&gt;</code></p><p id="f48a" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io"> storageDao.save </strong>å¸¦ä¸‰ä¸ªå‚æ•°:<br/> 1ã€‚è¯·æ±‚(<code class="fe kx ky kz la b">Object</code> ) <br/> 2ã€‚å“åº”æˆ–å¼‚å¸¸(<code class="fe kx ky kz la b">Object</code> ) <br/> 3ã€‚æ–¹æ³•åç§°(<code class="fe kx ky kz la b">String</code>)</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="1d75" class="lj lk in la b gy ll lm l ln lo">private void save(Object request, Object response, String commandName) {<br/>    try {<br/>        final String userId = MDC.get(RequestContext.REQUEST_USER_ID);<br/>        final String requestId = MDC.get(RequestContext.REQUEST_ID);<br/>        <br/>        final String workflowId = Objects.nonNull(REQUEST_USER_ID) ? userId.concat("_").concat(requestId) : userId;<br/>        final Date currentDate = new Date();</span><span id="07b4" class="lj lk in la b gy lp lm l ln lo">        Optional&lt;RequestResponseBlob&gt; requestResponseBlob = storageDao<br/>                .get(workflowId, commandName);</span><span id="48c8" class="lj lk in la b gy lp lm l ln lo">        final byte[] encryptedRequest = objectMapper.writeValueAsBytes(encryptionService.encrypt(request));<br/>        final byte[] encryptedResponse = objectMapper.writeValueAsBytes(encryptionService.encrypt(response));</span><span id="ceb0" class="lj lk in la b gy lp lm l ln lo">        if (storedOutboundMessage.isPresent()) {<br/>            RequestResponseBlob presentRequestResponse = requestResponseBlob.get();<br/>            presentRequestResponse.setRequest(encryptedRequest);<br/>            presentRequestResponse.setResponse(encryptedResponse);<br/>            presentRequestResponse.setUpdated(currentDate);<br/>            storageDao.update(presentRequestResponse);<br/>        } else {<br/>            storageDao.save(RequestResponseBlob.builder()<br/>                    .commandType(commandName)<br/>                    .workflowId(workflowId)<br/>                    .requestId(requestId)<br/>                    .request(encryptedRequest)<br/>                    .response(encryptedResponse)<br/>                    .created(currentDate)<br/>                    .updated(currentDate)<br/>                    .build());<br/>        }<br/>    } catch (Exception e) {<br/>        log.error("[STOCKPILE] Error while storing");<br/>    }<br/>}</span></pre><p id="9d7c" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">åœ¨<strong class="kb io"> MDC </strong>ä¸­å­˜æ”¾<code class="fe kx ky kz la b">userId</code>å’Œ<code class="fe kx ky kz la b">requestId</code>å‚è§<a class="ae lq" href="https://pyblog.medium.com/mdc-improving-debugging-logging-bb421a62a195" rel="noopener">å‰ä¸€å²—ä½</a>ã€‚<br/>ä¸ºäº†ä¾¿äºæŸ¥è¯¢ï¼Œä½¿ç”¨<code class="fe kx ky kz la b">userId</code>ã€<code class="fe kx ky kz la b">requestId</code>å’Œ<strong class="kb io">æ–¹æ³•å</strong>ä¼šæ¯”è¾ƒç†æƒ³ï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºã€‚</p><p id="c800" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">ç”¨æ³•:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="b7b9" class="lj lk in la b gy ll lm l ln lo">@StockPile<br/>public Response externalServiceCommandOne(@Item final SensitiveInformationRequest request, final String token) {<br/>  Response response;<br/>  // Stuff here<br/>  return response<br/>}</span></pre><p id="f397" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">å°±æ˜¯è¿™æ ·ï¼å®Œæˆçš„ğŸš€</p></div></div>    
</body>
</html>