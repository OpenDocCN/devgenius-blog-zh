<html>
<head>
<title>Install Microsoft Office In Windows Container</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Windows容器中安装Microsoft Office</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/install-microsoft-office-in-windows-container-ce05877138fd?source=collection_archive---------0-----------------------#2020-03-31">https://blog.devgenius.io/install-microsoft-office-in-windows-container-ce05877138fd?source=collection_archive---------0-----------------------#2020-03-31</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/b0c063662f1f5fd432efb9af085a045a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*X9gfTsAcgvvQKXiR.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">港集装箱办公室:<a class="ae kc" href="https://commons.wikimedia.org/wiki/File:Container_office.jpg" rel="noopener ugc nofollow" target="_blank">https://commons . wikimedia . org/wiki/File:Container _ Office . jpg</a></figcaption></figure><p id="74a8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">注意1 </strong>:写这篇文章只是为了好玩。微软从来不保证Office在Windows容器环境下工作得最好。此外，微软可以在不发出任何通知的情况下随时破坏本文中描述的功能。所以，请不要依赖这篇文章。</p><p id="48fd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">注意2 </strong>:由于软件的许可限制，您不能为任何类型的互联网和内部网服务运行Microsoft Office container。请参考微软的<a class="ae kc" href="https://support.microsoft.com/en-us/help/257757/considerations-for-server-side-automation-of-office" rel="noopener ugc nofollow" target="_blank">许可描述</a>。无论这个容器工作与否，请测试这个功能只是为了好玩。</p><h1 id="8367" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">一个关于办公自动化的故事</h1><p id="4144" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">微软Office长期以来都是最畅销的软件。这个软件成了每个人生活中必不可少的东西。</p><p id="dc69" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">微软Office以其流畅独特的界面而闻名。不仅如此，当用户可以采用自动化功能时，Office也会大放异彩。然而，这些自动化特性并不适合传统的服务器场景。性能和许可方面。</p><p id="0987" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">作为替代，微软向公众发布了OOXML格式的SDK，许多第三方和开源项目采用了OOXML并发布了它的SDK。不管怎样，微软Office总是赢，因为他们开发了自己的功能。因此，如果你想坚持使用Office的最新亮点，你将不可避免地安装微软Office。</p><p id="d5cd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这里有一个简单的问题。如果微软Office可以在Windows容器中运行，是不是很整洁呢？但我们不知道Windows容器是否支持Microsoft Office。此外，自动安装也不容易。</p><h1 id="da14" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">挖掘</h1><p id="7056" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">最近，Windows容器映像的完整版本Windows Server 2019 (1809)的开始已经发布。该映像包含支持和运行办公室的几乎所有组件。遗憾的是，尽管存在这种情况，用户仍然不能在容器中与应用程序进行交互。但是，有了这个映像，应用程序可以持久化并处理它的消息循环。</p><p id="e7af" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，微软Office的最新版本可以通过Office部署工具包(又名ODT)进行定制和自动化。您可以用XML语法编写自己的ODT配置文件，这将在容器上很好地工作。</p><p id="26ae" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我使用Windows Server version 1903容器进行了测试。</p><h1 id="f79c" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">写入ODT文件</h1><p id="f075" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">起初，我编写了一个名为<code class="fe me mf mg mh b">config.xml</code>的ODT文件来自动安装32位版本的Office 2019。</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="2721" class="mq lc iq mh b gy mr ms l mt mu">&lt;Configuration&gt;<br/>  &lt;Add OfficeClientEdition="32" Channel="PerpetualVL2019"&gt;<br/>    &lt;Product ID="ProPlus2019Volume"&gt;<br/>      &lt;Language ID="ko-kr" /&gt;<br/>    &lt;/Product&gt;<br/>  &lt;/Add&gt;<br/>  &lt;Display Level="None" AcceptEULA="TRUE" /&gt;<br/>  &lt;Property Name="AUTOACTIVATE" Value="1"/&gt;<br/>&lt;/Configuration&gt;</span></pre><p id="2f2b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">没有什么不寻常的，但重点是，我用的是32位版本的Office 2019作为永久授权版本，而不是Office 365。</p><h1 id="5d85" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">编写Dockerfile文件</h1><p id="050e" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我编写了一个docker文件，从微软下载中心下载ODT，并基于config.xml文件运行安装。</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="b920" class="mq lc iq mh b gy mr ms l mt mu">FROM mcr.microsoft.com/windows:1903 AS build</span><span id="18b8" class="mq lc iq mh b gy mv ms l mt mu">WORKDIR C:\\odtsetup<br/>ADD <a class="ae kc" href="https://download.microsoft.com/download/2/7/A/27AF1BE6-DD20-4CB4-B154-EBAB8A7D4A7E/officedeploymenttool_11617-33601.exe" rel="noopener ugc nofollow" target="_blank">https://download.microsoft.com/download/2/7/A/27AF1BE6-DD20-4CB4-B154-EBAB8A7D4A7E/officedeploymenttool_11617-33601.exe</a> odtsetup.exe<br/>RUN odtsetup.exe /quiet /norestart /extract:C:\\odtsetup</span><span id="a9d5" class="mq lc iq mh b gy mv ms l mt mu">FROM mcr.microsoft.com/windows:1903 AS download</span><span id="55a8" class="mq lc iq mh b gy mv ms l mt mu">WORKDIR C:\\odtsetup<br/>COPY --from=build C:\\odtsetup\\setup.exe .<br/>ADD config.xml .<br/>RUN setup.exe /download C:\\odtsetup\\config.xml</span><span id="ff35" class="mq lc iq mh b gy mv ms l mt mu">FROM mcr.microsoft.com/windows:1903<br/>MAINTAINER rkttu</span><span id="839f" class="mq lc iq mh b gy mv ms l mt mu">WORKDIR C:\\odtsetup<br/>COPY --from=build C:\\odtsetup\\setup.exe .<br/>COPY --from=download C:\\odtsetup\\Office .<br/>ADD config.xml .<br/>RUN setup.exe /configure C:\\odtsetup\\config.xml</span><span id="a2fc" class="mq lc iq mh b gy mv ms l mt mu">WORKDIR /<br/>RUN rmdir /s /q C:\\odtsetup</span><span id="d35e" class="mq lc iq mh b gy mv ms l mt mu"># <a class="ae kc" href="https://stackoverflow.com/questions/10837437/interop-word-documents-open-is-null" rel="noopener ugc nofollow" target="_blank">https://stackoverflow.com/questions/10837437/interop-word-documents-open-is-null</a><br/>RUN powershell -Command new-object -comobject word.application<br/>RUN mkdir C:\\Windows\\SysWOW64\\config\\systemprofile\\Desktop</span><span id="a365" class="mq lc iq mh b gy mv ms l mt mu">VOLUME C:\\data</span></pre><p id="9955" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我多次尝试实现这个Dockerfile。当我试图安装Office 365 x64时，安装程序变得奇怪或干脆失败，并返回非零代码，这导致构建映像失败。</p><p id="fe5c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后两行是在容器中正确运行Microsoft Office应用程序所必需的。我会解释的。</p><ul class=""><li id="a355" class="mw mx iq kf b kg kh kk kl ko my ks mz kw na la nb nc nd ne bi translated">我看不到发生了什么，因为没有用户界面，但是<code class="fe me mf mg mh b">Word.Application</code> COM对象应该至少启动一次来继续其余的步骤。</li><li id="8fc2" class="mw mx iq kf b kg nf kk ng ko nh ks ni kw nj la nb nc nd ne bi translated">如果用户配置文件目录中不存在桌面目录，则当调用open file方法时，COM对象将返回空引用。我在Stackoverflow网站上添加了一个<a class="ae kc" href="https://stackoverflow.com/questions/10837437/interop-word-documents-open-is-null" rel="noopener ugc nofollow" target="_blank">相关链接</a>。</li></ul><blockquote class="nk nl nm"><p id="997c" class="kd ke nn kf b kg kh ki kj kk kl km kn no kp kq kr np kt ku kv nq kx ky kz la ij bi translated">请记住，正如我在第一段所说，微软可以更新Office，这可能会导致突破性的变化，从而影响本文。</p></blockquote><p id="863b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们用一个命令来构建Office容器。请确保Docker Desktop for Windows正在运行。</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="a92f" class="mq lc iq mh b gy mr ms l mt mu">docker build -t o365full:latest .</span></pre><h1 id="8851" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">编写一个将DOCX文档转换成PDF文件的应用程序</h1><p id="ea2f" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">在容器映像构建成功后，你可以放入C#应用程序，它使用Office Primary Interop Assembly(又名PIA)接口，并将DOCX文档转换成PDF文件。</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="4cb5" class="mq lc iq mh b gy mr ms l mt mu">// Requires office.dll and word interop pia.dll from GACusing Microsoft.Office.Interop.Word;<br/>using System;<br/>using System.IO;<br/>using System.Linq;namespace OfficePIATest<br/>{<br/>    internal static class Program<br/>    {<br/>        [STAThread]<br/>        public static void Main(string[] args)<br/>        {<br/>            var input = args.ElementAtOrDefault(0) ?? string.Empty;<br/>            var output = args.ElementAtOrDefault(1) ?? string.Empty;if (!File.Exists(input))<br/>            {<br/>                Console.Error.WriteLine("Cannot open the file `{0}`.", input);<br/>                Environment.Exit(1);<br/>                return;<br/>            }if (string.IsNullOrWhiteSpace(output))<br/>            {<br/>                Console.Error.WriteLine("Invalid output path.");<br/>                Environment.Exit(2);<br/>                return;<br/>            }var outputDir = Path.GetDirectoryName(output);<br/>            if (!Directory.Exists(outputDir))<br/>                Directory.CreateDirectory(outputDir);var wordApp = new Application();<br/>            Console.Out.WriteLine("word app initialized.");Document wordDocument = null;<br/>            var t = new System.Threading.Tasks.Task(() =&gt; wordDocument = wordApp.Documents.Open(input));<br/>            t.Start();<br/>            t.Wait();if (wordDocument == null)<br/>            {<br/>                Console.Error.WriteLine("Word document is null reference.");<br/>                Environment.Exit(3);<br/>                return;<br/>            }<br/>            else<br/>                Console.Out.WriteLine("Word document opened.");wordDocument.ExportAsFixedFormat(output, WdExportFormat.wdExportFormatPDF);<br/>            Console.Out.WriteLine("Export performed.");wordDocument.Close(WdSaveOptions.wdDoNotSaveChanges,<br/>                               WdOriginalFormat.wdOriginalDocumentFormat,<br/>                               false); //Close document<br/>            Console.Write("Closing document");wordApp.Quit(); //Important: When you forget this Word keeps running in the background<br/>            Console.Out.WriteLine("Quitting word app.");<br/>        }<br/>    }<br/>}</span></pre><p id="6627" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要构建此代码，您需要Office PIA DLLs。当你安装Office时，PIA会自动把它放到%windir%\Assembly\GAC_MSIL目录下。另外，你需要Office汇编和微软。Office.Word库。</p><p id="ca84" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，在构建这段代码时，有一点很重要。您应该将此应用程序编译为x86应用程序，或者设置32位首选应用程序。我们将32位Microsoft Office安装到一个容器中，因此我们应该尊重这种配置。</p><p id="d54f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">构建您的可执行文件，并将其与示例文档文件一起添加到容器中。在docker文件的末尾添加下面一行，添加示例目录并放置您的示例文档以供测试。</p><p id="cb56" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们假设可执行文件的名称是“OfficePIATest.exe”，而放在目录“sample”中的示例文档的名称是“demo.docx”</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="6ada" class="mq lc iq mh b gy mr ms l mt mu">ADD sample .</span></pre><p id="f362" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后让我们建立docker图像。</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="2708" class="mq lc iq mh b gy mr ms l mt mu">docker build -t o365full:latest .</span></pre><p id="62bf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">请参考此要点代码以供参考。</p><h1 id="2c5f" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">测试</h1><p id="1535" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">您可以使用目录挂载来运行容器。示例应用程序将在挂载的目录下创建PDF文件。</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="3e57" class="mq lc iq mh b gy mr ms l mt mu">docker run -v %cd%\data:c:\data --rm -it --name=o365fulltest o365full:latest cmd</span></pre><p id="3697" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在容器环境中，让我们运行这个命令。</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="c330" class="mq lc iq mh b gy mr ms l mt mu">OfficePIATest.exe C:\demo.docx C:\data\test.pdf</span></pre><p id="61cb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后创建的PDF文件如下！</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nr"><img src="../Images/d9e503864acc4dab481e155f5a5eb40f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*-4Vp0QlNWSvJBYPP.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">瞧啊。容器中的Microsoft Word将示例文档转换为PDF文件。</figcaption></figure><h1 id="042f" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="9c48" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">您可以通过多种方式将Word文档更高效地转换为PDF。但是正如您所看到的，这个容器可以运行依赖于Office PIA程序集的应用程序。</p><p id="30c4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我之前说过，尽管，Office不是服务器应用程序，你不能这样使用Office，所以你不能，也不应该使用这个Windows容器。</p><p id="642a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但是Windows容器进化得相当多，所以有更多的应用程序可以转换成Windows容器。我想用文章的一小部分和你分享这个好玩的因素。</p><p id="9936" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您有任何反馈或建议，请写下来作为回应。😀</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><a href="https://www.buymeacoffee.com/rkttu"><div class="gh gi ns"><img src="../Images/6d60b235fcc46a4bd696b90e886419ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:340/format:webp/1*Dpw8-hNGI2fDmosV4E8DVQ.png"/></div></a></figure></div></div>    
</body>
</html>