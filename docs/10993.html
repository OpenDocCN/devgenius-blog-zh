<html>
<head>
<title>Examples of Analytical SQL functions in Data warehouse (Part 1)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">数据仓库中的分析 SQL 函数示例(第 1 部分)</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/examples-of-analytical-sql-functions-in-data-warehouse-part-1-99794e0273d9?source=collection_archive---------11-----------------------#2022-12-12">https://blog.devgenius.io/examples-of-analytical-sql-functions-in-data-warehouse-part-1-99794e0273d9?source=collection_archive---------11-----------------------#2022-12-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="95b0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">行动中的事物！！</p><p id="a28b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们已经在之前的<a class="ae kl" href="https://medium.com/dev-genius/important-sql-clauses-functions-in-data-engineering-and-analytics-85d8d84c2d78" rel="noopener">文章</a>中讨论了最有用的分析性 SQL 函数，所以在这篇文章和接下来的几篇文章中将会研究这些函数。我将尝试在 AWS 红移表中的一个小数据集上运行每篇文章中的几个函数。下面是我将使用的表模式和一些示例记录:</p><pre class="km kn ko kp gt kq kr ks bn kt ku bi"><span id="0db1" class="kv kw iq kr b be kx ky l kz la">create table users(<br/> userid integer not null,<br/> name varchar(255) not null,<br/> gender varchar(1) not null,<br/> weight decimal(8,2) encode delta32k,<br/> age integer not null,<br/> primary key(userid))<br/>distkey(gender)<br/>sortkey(age);<br/><br/>insert into users (userid, name, gender, age, weight) values (1, 'John Snow', 'M', 35, 61);<br/>insert into users (userid, name, gender, age, weight) values (2, 'Matt Hayden', 'M', 55, 95);<br/>insert into users (userid, name, gender, age, weight) values (3, 'Ricky Ponting', 'M', 49, 75);<br/>insert into users (userid, name, gender, age, weight) values (4, 'David Shepherd', 'M', 90, 80);<br/>insert into users (userid, name, gender, age, weight) values (5, 'Smriti Mandana', 'F', 26, 55);<br/>insert into users (userid, name, gender, age, weight) values (6, 'Sachin Tendulkar', 'M', 51, 66);<br/>insert into users (userid, name, gender, age, weight) values (7, 'Isa Guha', 'F', 41, 61);</span></pre><figure class="km kn ko kp gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="gh gi lb"><img src="../Images/66c5a7766f45c8de9b7d33dbbdf62ef6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hCu-4cOspGCuAgCE"/></div></div><figcaption class="lj lk gj gh gi ll lm bd b be z dk translated">在<a class="ae kl" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上<a class="ae kl" href="https://unsplash.com/@_purianoushka?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Anoushka P </a>拍摄的照片</figcaption></figure><p id="1ea6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> OVER，PARTITION BY，ORBER BY 和 ROWS: </strong></p><p id="3b56" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">尽管这些实际上不是函数，但它们是重要的关键字，表明 SQL 查询将以分析的方式执行。通过组合使用这些关键字的函数，使分析查询更加有效。分析查询通常在数据集窗口上执行，而不是在整个数据集本身上执行。窗口是使用窗口规范(OVER 子句)定义的，它基于三个主要概念:</p><ul class=""><li id="4008" class="ln lo iq jp b jq jr ju jv jy lp kc lq kg lr kk ls lt lu lv bi translated"><em class="lw">窗口分区，</em>形成多组行(PARTITION 子句)</li><li id="1679" class="ln lo iq jp b jq lx ju ly jy lz kc ma kg mb kk ls lt lu lv bi translated"><em class="lw">窗口排序</em>，它定义了每个分区中行的顺序或序列(ORDER BY 子句)</li><li id="2853" class="ln lo iq jp b jq lx ju ly jy lz kc ma kg mb kk ls lt lu lv bi translated"><em class="lw">窗口框架</em>，相对于每一行定义，进一步限制行的集合(行规范)</li></ul><p id="98ad" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们已经有了表、数据并知道了以分析方式使用查询的重要关键字，我们将看看一些函数:</p><p id="e747" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> ROW_NUMBER: </strong>创建一个从 1 开始递增的整数值，后续行获得下一个更高的值。跨越分区边界时复位为 1。</p><p id="a641" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以从上面的数据来看，如果我们想根据性别对所有用户进行排名，我们可以使用 ROW_NUMBER()，如下所示:</p><pre class="km kn ko kp gt kq kr ks bn kt ku bi"><span id="1562" class="kv kw iq kr b be kx ky l kz la">SELECT name, weight, gender, ROW_NUMBER() OVER (PARTITION BY gender) FROM users;</span></pre><figure class="km kn ko kp gt lc gh gi paragraph-image"><div class="gh gi mc"><img src="../Images/1fa0c5151d603e095fa7e2e1bfd0fdab.png" data-original-src="https://miro.medium.com/v2/resize:fit:570/format:webp/1*dy3MKSqXNi3Y2xNvRQrxdg.png"/></div></figure><p id="bdc7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> RATIO_TO_REPORT: </strong>计算值与组内合计的比率，这不是百分比，比率之和等于 1。</p><p id="da33" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果我们想计算用户的体重占其性别总体重的比例，我们可以如下进行:</p><pre class="km kn ko kp gt kq kr ks bn kt ku bi"><span id="9a34" class="kv kw iq kr b be kx ky l kz la">SELECT name, weight, gender, RATIO_TO_REPORT(weight) OVER (PARTITION BY gender) FROM users;</span></pre><figure class="km kn ko kp gt lc gh gi paragraph-image"><div class="gh gi md"><img src="../Images/ceac1d622d40e5ea009ce5b081202256.png" data-original-src="https://miro.medium.com/v2/resize:fit:592/format:webp/1*L3MtWG9zVLtgIeuisiXEeA.png"/></div></figure><p id="b95d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> LISTAGG: </strong>连接出现在单个列中的值，返回分隔值的字符串。也可以对列中的数据进行排序。</p><p id="a108" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有了上面的数据，如果我们想根据用户的性别将他们的名字连接起来，那么我们可以在性别分区上使用 LISTAGG 函数中的名字，如下所示。</p><pre class="km kn ko kp gt kq kr ks bn kt ku bi"><span id="b83e" class="kv kw iq kr b be kx ky l kz la">SELECT name, weight, gender, LISTAGG(name,'~') OVER (PARTITION BY gender) FROM users;</span></pre><figure class="km kn ko kp gt lc gh gi paragraph-image"><div class="gh gi me"><img src="../Images/4a32eab1bd34a8867635dfdbd5a77d00.png" data-original-src="https://miro.medium.com/v2/resize:fit:1278/format:webp/1*ZaQNCOlnpSbq-t5ThIoaOg.png"/></div></figure><p id="b92c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> LEAD: </strong>根据当前行向前查看若干行，可以访问该行。</p><p id="87a1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如，在用户表中，如果我们希望第二个用户的名字比另一个用户更重要，可以使用 LEAD 函数中行的名称和位置。为了使它工作，我们需要 ORDER BY 子句与 weight 一起使用，因为行应该按照它工作的顺序排列。请注意，最后 2 行没有销售线索值，因为在该顺序中，它们下面没有第二个用户。</p><pre class="km kn ko kp gt kq kr ks bn kt ku bi"><span id="5a8f" class="kv kw iq kr b be kx ky l kz la">SELECT name, weight, gender, LEAD(name,2) OVER (ORDER BY weight) FROM users;</span></pre><figure class="km kn ko kp gt lc gh gi paragraph-image"><div class="gh gi mf"><img src="../Images/2edc544ff9060f448615d5da15f9ccd5.png" data-original-src="https://miro.medium.com/v2/resize:fit:618/format:webp/1*HM7s20jHlXI7rLeyKVzu5A.png"/></div></figure><p id="4216" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> LAG: </strong>基于当前行回看若干行，可以访问该行。</p><p id="4258" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">示例:类似于 LEAD 函数，如果我们需要查看比其他用户少的用户，那么我们可以使用 LAG 函数。请注意，最后一个用户没有任何值，因为没有其他用户的权重更低。</p><pre class="km kn ko kp gt kq kr ks bn kt ku bi"><span id="ac85" class="kv kw iq kr b be kx ky l kz la">SELECT name, weight, gender, LAG(name,1) OVER (ORDER BY weight) FROM users;</span></pre><figure class="km kn ko kp gt lc gh gi paragraph-image"><div class="gh gi mg"><img src="../Images/29fd6a0a5e8a341d323968bedb8171db.png" data-original-src="https://miro.medium.com/v2/resize:fit:622/format:webp/1*K48nvyCAb6AtNl_PgZSfmw.png"/></div></figure><p id="1786" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">希望您已经对这些函数有了一些基本的了解，知道如何以及何时使用，以及在给定的数据集上使用时的结果。我们将在接下来的几篇文章中讨论这个列表中的其他函数。谢了。</p><p id="2d3d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">参考资料:</p><p id="f28f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://www.pluralsight.com/courses/adv-sql-queries-oracle-sql-server" rel="noopener ugc nofollow" target="_blank">https://www . plural sight . com/courses/adv-SQL-queries-Oracle-SQL-server</a></p><p id="3487" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://docs.aws.amazon.com/redshift/latest/dg/c_Window_functions.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/redshift/latest/DG/c _ Window _ functions . html</a>。</p><div class="mh mi gp gr mj mk"><a href="https://medium.com/membership/@guru.nie" rel="noopener follow" target="_blank"><div class="ml ab fo"><div class="mm ab mn cl cj mo"><h2 class="bd ir gy z fp mp fr fs mq fu fw ip bi translated">通过我的推荐链接加入媒体</h2><div class="mr l"><h3 class="bd b gy z fp mp fr fs mq fu fw dk translated">阅读 Gururaj Kulkarni(以及媒体上成千上万的其他作家)的每一个故事。您的会员费直接…</h3></div><div class="ms l"><p class="bd b dl z fp mp fr fs mq fu fw dk translated">medium.com</p></div></div><div class="mt l"><div class="mu l mv mw mx mt my lh mk"/></div></div></a></div></div></div>    
</body>
</html>