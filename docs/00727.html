<html>
<head>
<title>Laravel: Can you throttle a callback? Sure you can!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">拉勒维尔:你能抑制回调吗？你当然可以！</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/laravel-can-you-throttle-a-callback-sure-you-can-2ab64c1a99a3?source=collection_archive---------10-----------------------#2020-06-15">https://blog.devgenius.io/laravel-can-you-throttle-a-callback-sure-you-can-2ab64c1a99a3?source=collection_archive---------10-----------------------#2020-06-15</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="50c3" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">我想要一些薄煎饼！</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/74ad303e28578e752270a430256b1ab0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*kJDRRMNL5Gb9679k"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk translated">纳蕾塔·马丁在<a class="ae ks" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="92ba" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">我非常喜欢节流。有时您需要控制调用逻辑的次数，特别是在联系外部API时，以避免请求中的硬错误和停止整个应用程序。</p><p id="eaf8" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">在拉勒维尔，我们可以很容易地做到。<a class="ae ks" href="https://medium.com/p/eb443b1bedc" rel="noopener">有一个限速器</a>，你可以用它来抑制回调，或者其他任何事情。但是如果我们可以进一步创建一个助手来节省我们更多的代码行，为什么要止步于此呢？</p><h1 id="c08d" class="lp lq in bd lr ls lt lu lv lw lx ly lz jt ma ju mb jw mc jx md jz me ka mf mg bi translated">节流就像没有明天一样</h1><p id="e3af" class="pw-post-body-paragraph kt ku in kv b kw mh jo ky kz mi jr lb lc mj le lf lg mk li lj lk ml lm ln lo ig bi translated">让我们做一个全球帮手。我们称之为“节流”，因为它非常简单。它将接受速率限制器所需的密钥和我们想要执行的回调本身。我们可以为尝试次数和衰减窗口设置一些默认值，以分钟为单位。</p><blockquote class="mm"><p id="3884" class="mn mo in bd mp mq mr ms mt mu mv lo dk translated">速率限制器使用衰减接近逻辑工作:允许在一个时间窗口内进行给定次数的尝试。一旦第一次尝试超出了时间窗口，就可以进行新的尝试。</p></blockquote><p id="0412" class="pw-post-body-paragraph kt ku in kv b kw mw jo ky kz mx jr lb lc my le lf lg mz li lj lk na lm ln lo ig bi translated">过程很简单:我们将询问速率限制器给定的键是否尝试了太多次。如果不是，我们将执行回调并返回true，否则我们将返回false，表明回调没有执行。</p><pre class="kd ke kf kg gt nb nc nd ne aw nf bi"><span id="8efa" class="ng lq in nc b gy nh ni l nj nk">function throttle($key, $callback, $tries = 60, $decay = 1)<br/>{<br/>    $limiter = app(RateLimiter::class);</span><span id="80c2" class="ng lq in nc b gy nl ni l nj nk">    if (! $limiter-&gt;tooManyAttempts($key, $tries)) {<br/>        $callback();<br/>        $limiter-&gt;hit($key, $decay * 60);<br/>        return true;<br/>    }</span><span id="7443" class="ng lq in nc b gy nl ni l nj nk">    return false;<br/>}</span></pre><p id="1d15" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">这是一个相对简单的函数，你可以在代码的任何地方使用。只要您不依赖于回调结果本身或者不知道节流何时再次可用，它将在不中断您的应用程序流的情况下节流任何东西。</p><p id="9917" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">例如，我们需要向另一个用户发送一条消息，但是要避免在应用程序中向用户发送多条消息。对于这一点，节流功能可以帮助我们。</p><pre class="kd ke kf kg gt nb nc nd ne aw nf bi"><span id="27e9" class="ng lq in nc b gy nh ni l nj nk">public function send(Request $request)<br/>{<br/>    $request-&gt;validate([<br/>        'user'    =&gt; 'required|exists:users,id',<br/>        'message' =&gt; 'required|string'<br/>    ]);</span><span id="aed2" class="ng lq in nc b gy nl ni l nj nk">    $function = function () use ($request) {<br/>        User::find($request-&gt;user)-&gt;notify(<br/>            new Message($request-&gt;message)<br/>        );<br/>    };</span><span id="0c96" class="ng lq in nc b gy nl ni l nj nk">    $id = Auth::user()-&gt;id;</span><span id="e18a" class="ng lq in nc b gy nl ni l nj nk">    $executed = throttle("send_by:{$id}", $function, 2, 1);</span><span id="20df" class="ng lq in nc b gy nl ni l nj nk">    if (! $executed) {<br/>        session()-&gt;flash('Slow down, you can't spam users!');<br/>    }</span><span id="b331" class="ng lq in nc b gy nl ni l nj nk">    return back();<br/>}</span></pre><p id="14d9" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">这只是一个例子，不要当真。显然，有更好的方法来抑制发送消息之类的事情，但是节流器可以减轻调用速率限制器的痛苦，并且每次都手动进行抑制，例如，通过用MD5散列来识别消息，反复发送相同的消息。</p><pre class="kd ke kf kg gt nb nc nd ne aw nf bi"><span id="84d3" class="ng lq in nc b gy nh ni l nj nk">public function send(Request $request)<br/>{<br/>    // ...</span><span id="f4ac" class="ng lq in nc b gy nl ni l nj nk">    $hash = md5($request-&gt;message);</span><span id="ec3e" class="ng lq in nc b gy nl ni l nj nk">    $executed = throttle("send_by:{$id}:{$hash}, $function, 2, 1);</span><span id="fff5" class="ng lq in nc b gy nl ni l nj nk">    // ...<br/>}</span></pre></div><div class="ab cl nm nn hr no" role="separator"><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr"/></div><div class="ig ih ii ij ik"><p id="0294" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">你可以在我的<a class="ae ks" href="https://github.com/DarkGhostHunter/Larahelp" rel="noopener ugc nofollow" target="_blank"> Larahelp包</a>里找到这个特质和其他帮手。如果你发现在你的项目中有用的东西，给它一个机会。</p><div class="nt nu gp gr nv nw"><a href="https://github.com/DarkGhostHunter/Larahelp" rel="noopener  ugc nofollow" target="_blank"><div class="nx ab fo"><div class="ny ab nz cl cj oa"><h2 class="bd io gy z fp ob fr fs oc fu fw im bi translated">darghosthunter/Lara help</h2><div class="od l"><h3 class="bd b gy z fp ob fr fs oc fu fw dk translated">使用超过35个有用的全球助手来增强您的Laravel项目。您可以通过composer安装软件包…</h3></div><div class="oe l"><p class="bd b dl z fp ob fr fs oc fu fw dk translated">github.com</p></div></div><div class="of l"><div class="og l oh oi oj of ok km nw"/></div></div></a></div></div></div>    
</body>
</html>