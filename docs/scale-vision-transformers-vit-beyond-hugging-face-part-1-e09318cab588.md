# è¶…è¶Šæ‹¥æŠ±è„¸çš„è§†è§‰å˜å½¢é‡‘åˆš(ViT)|ç¬¬ 1 éƒ¨åˆ†

> åŸæ–‡ï¼š<https://blog.devgenius.io/scale-vision-transformers-vit-beyond-hugging-face-part-1-e09318cab588?source=collection_archive---------13----------------------->

## åŠ å¿«æ‹¥æŠ±è„¸æœ€å…ˆè¿›çš„ç»´ç”Ÿç´  t æ¨¡å‹ğŸ¤—å€ŸåŠ© Databricksã€Nvidia å’Œ Spark NLPï¼Œé€Ÿåº¦æå‡é«˜è¾¾ 2300%(25 å€)ğŸš€

![](img/c7572592ba711def70ee3e626385d598.png)

**é€šè¿‡ä½¿ç”¨**æ•°æ®æ¨¡å—**ã€**è‹±ä¼Ÿè¾¾**å’Œ **Spark NLP** æ‰©å±•**åŸºäº**å˜å‹å™¨**çš„å‹å·

æˆ‘æ˜¯ [Spark NLP](https://github.com/JohnSnowLabs/spark-nlp) å¼€æºé¡¹ç›®çš„è´¡çŒ®è€…ä¹‹ä¸€ï¼Œæœ€è¿‘è¿™ä¸ªåº“å¼€å§‹æ”¯æŒç«¯åˆ°ç«¯**è§†è§‰å˜å½¢å™¨(ViT)** æ¨¡å‹ã€‚æˆ‘åœ¨æ—¥å¸¸å·¥ä½œä¸­ä½¿ç”¨ Spark NLP å’Œå…¶ä»– ML/DL å¼€æºåº“ï¼Œæˆ‘å†³å®šéƒ¨ç½²ä¸€ä¸ª ViT ç®¡é“æ¥å®Œæˆæœ€å…ˆè¿›çš„å›¾åƒåˆ†ç±»ä»»åŠ¡ï¼Œå¹¶æä¾›**æ‹¥æŠ±è„¸**å’Œ **Spark NLP** ä¹‹é—´çš„æ·±å…¥æ¯”è¾ƒã€‚

> æœ¬æ–‡çš„ç›®çš„æ˜¯æ¼”ç¤ºå¦‚ä½•ä» Hugging Face å‘å¤–æ‰©å±• Vision Transformer (ViT)æ¨¡å‹ï¼Œå¹¶å°†å…¶éƒ¨ç½²åˆ°ç”Ÿäº§å°±ç»ªç¯å¢ƒä¸­ï¼Œä»¥å®ç°åŠ é€Ÿå’Œé«˜æ€§èƒ½çš„æ¨ç†ã€‚æœ€åï¼Œæˆ‘ä»¬å°†é€šè¿‡ä½¿ç”¨ Databricksã€Nvidia å’Œ Spark NLPï¼Œå°†æ‹¥æŠ±è„¸çš„ ViT æ¨¡å‹æ‰©å±• 25 å€(2300%)ã€‚

## åœ¨æœ¬æ–‡çš„ç¬¬ 1 éƒ¨åˆ†ï¼Œæˆ‘å°†:

*   è§†è§‰è½¬æ¢å™¨(ViT)ç®€ä»‹
*   CPU å’Œ GPU ä¸Šæˆ´å°”æœåŠ¡å™¨å†…éƒ¨æ‹¥æŠ±è„¸çš„åŸºå‡†æµ‹è¯•
*   CPU å’Œ GPU ä¸Šæˆ´å°”æœåŠ¡å™¨å†…éƒ¨çš„åŸºå‡† Spark NLP

> *æœ¬ç€å®Œå…¨é€æ˜çš„ç²¾ç¥ï¼ŒGitHub* ä¸Šçš„[](https://github.com/JohnSnowLabs/spark-nlp-workshop/tree/master/tutorials/blogposts/medium/scale-vision-transformers-vit-beyond-hugging-face?ref=hackernoon.com)

**[](/scale-vision-transformers-vit-beyond-hugging-face-part-1-e09318cab588) [## è¶…è¶Šæ‹¥æŠ±è„¸çš„è§†è§‰å˜å½¢é‡‘åˆš(ViT)|ç¬¬ 1 éƒ¨åˆ†

### åŠ å¿«æ‹¥æŠ±è„¸æœ€å…ˆè¿›çš„ç»´ç”Ÿç´  t æ¨¡å‹ğŸ¤—ä½¿ç”¨ Databricksã€Nvidia å’Œâ€¦â€¦æœ€é«˜å¯è¾¾ 2300%(å¿« 25 å€)

blog.devgenius.io](/scale-vision-transformers-vit-beyond-hugging-face-part-1-e09318cab588) [](/scale-vision-transformers-vit-beyond-hugging-face-part-2-b7b296d548b7) [## è¶…è¶Šæ‹¥æŠ±è„¸çš„è§†è§‰å˜å½¢é‡‘åˆš(ViT)|ç¬¬ 2 éƒ¨åˆ†

### åŠ å¿«æ‹¥æŠ±è„¸æœ€å…ˆè¿›çš„ç»´ç”Ÿç´  t æ¨¡å‹ğŸ¤—ä½¿ç”¨ Databricksã€Nvidia å’Œâ€¦â€¦æœ€é«˜å¯è¾¾ 2300%(å¿« 25 å€)

blog.devgenius.io](/scale-vision-transformers-vit-beyond-hugging-face-part-2-b7b296d548b7) [](/scale-vision-transformers-vit-beyond-hugging-face-part-3-5b8c13ef6477) [## è¶…è¶Šæ‹¥æŠ±è„¸çš„è§†è§‰å˜å½¢é‡‘åˆš(ViT)|ç¬¬ 3 éƒ¨åˆ†

### åŠ å¿«æ‹¥æŠ±è„¸æœ€å…ˆè¿›çš„ç»´ç”Ÿç´  t æ¨¡å‹ğŸ¤—ä½¿ç”¨ Databricksã€Nvidia å’Œâ€¦â€¦æœ€é«˜å¯è¾¾ 2300%(å¿« 25 å€)

blog.devgenius.io](/scale-vision-transformers-vit-beyond-hugging-face-part-3-5b8c13ef6477) 

# è§†è§‰å˜å‹å™¨(ViT)å‹å·ä»‹ç»

æ—©åœ¨ 2017 å¹´ï¼Œè°·æ­Œäººå·¥æ™ºèƒ½çš„ä¸€ç»„ç ”ç©¶äººå‘˜å‘è¡¨äº†ä¸€ç¯‡è®ºæ–‡ï¼Œä»‹ç»äº†ä¸€ç§æ”¹å˜äº†æ‰€æœ‰è‡ªç„¶è¯­è¨€å¤„ç†(NLP)æ ‡å‡†çš„ transformer æ¨¡å‹æ¶æ„ã€‚æœ¬æ–‡æè¿°äº†ä¸€ç§ç§°ä¸ºè‡ªæˆ‘æ³¨æ„çš„æ–°æœºåˆ¶ï¼Œä½œä¸ºä¸€ç§æ–°çš„å’Œæ›´æœ‰æ•ˆçš„è¯­è¨€åº”ç”¨æ¨¡å‹ã€‚ä¾‹å¦‚ï¼Œä¸¤ä¸ªæœ€å—æ¬¢è¿çš„åŸºäºå˜å‹å™¨çš„æ¨¡å‹ç³»åˆ—æ˜¯ GPT å’Œä¼¯ç‰¹ã€‚

![](img/0b184afb051052e6a5cd1c33bddeafe1.png)

ä¸€ç‚¹å˜å½¢é‡‘åˆšçš„å†å²[https://huggingface.co/course/chapter1/4](https://huggingface.co/course/chapter1/4)

æœ‰ä¸€ä¸ªå¾ˆæ£’çš„ç« èŠ‚æ˜¯å…³äºâ€œ[](https://huggingface.co/course/chapter1/4)****â€**å˜å½¢é‡‘åˆšæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œå¦‚æœä½ æœ‰å…´è¶£ï¼Œæˆ‘å¼ºçƒˆæ¨èä½ é˜…è¯»ã€‚**

**è™½ç„¶è¿™äº›æ–°çš„åŸºäº Transformer çš„æ¨¡å‹ä¼¼ä¹æ­£åœ¨å½»åº•æ”¹å˜ NLP ä»»åŠ¡ï¼Œä½†å®ƒä»¬åœ¨è®¡ç®—æœºè§†è§‰(CV)ä¸­çš„ä½¿ç”¨ä»ç„¶éå¸¸æœ‰é™ã€‚è®¡ç®—æœºè§†è§‰é¢†åŸŸä¸€ç›´ç”±å·ç§¯ç¥ç»ç½‘ç»œ(CNN)çš„ä½¿ç”¨æ‰€ä¸»å¯¼ï¼Œå¹¶ä¸”å­˜åœ¨åŸºäº CNN çš„æµè¡Œæ¶æ„(å¦‚ ResNet)ã€‚è¿™ç§æƒ…å†µä¸€ç›´æŒç»­åˆ° 2021 å¹´ 6 æœˆè°·æ­Œå¤§è„‘çš„å¦ä¸€ç»„ç ”ç©¶äººå‘˜åœ¨ä¸€ç¯‡é¢˜ä¸º**[**çš„è®ºæ–‡ä¸­ä»‹ç»äº†**â€œè§†è§‰å˜å½¢é‡‘åˆšâ€** (ViT)ä¸€å¹…å›¾åƒç›¸å½“äº 16x16 ä¸ªå•è¯:å˜å½¢é‡‘åˆšç”¨äºå¤§è§„æ¨¡å›¾åƒè¯†åˆ«**](https://arxiv.org/abs/2010.11929)****

****è¿™ç¯‡è®ºæ–‡ä»£è¡¨äº†å›¾åƒè¯†åˆ«æ–¹é¢çš„ä¸€ä¸ªçªç ´ï¼Œå®ƒä½¿ç”¨äº†æˆ‘ä»¬åˆšåˆšè®¨è®ºè¿‡çš„åŸºäºå˜æ¢çš„æ¨¡å‹(å¦‚ä¼¯ç‰¹å’Œ GPT)ä¸­ä½¿ç”¨çš„ç›¸åŒçš„è‡ªæˆ‘æ³¨æ„æœºåˆ¶ã€‚åœ¨åƒ BERT è¿™æ ·çš„åŸºäºè½¬æ¢çš„è¯­è¨€æ¨¡å‹ä¸­ï¼Œè¾“å…¥æ˜¯ä¸€ä¸ªå¥å­(ä¾‹å¦‚ä¸€åˆ—å•è¯)ã€‚ç„¶è€Œï¼Œåœ¨ ViT æ¨¡å‹ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆå°†å›¾åƒåˆ†å‰²æˆå­å›¾åƒç‰‡çš„ç½‘æ ¼ï¼Œç„¶ååœ¨æ¯ä¸ªåµŒå…¥çš„ç‰‡æˆä¸ºæ ‡è®°ä¹‹å‰ï¼Œæˆ‘ä»¬ç”¨çº¿æ€§é¡¹ç›®åµŒå…¥æ¯ä¸ªç‰‡ã€‚ç»“æœæ˜¯ä¸€ç³»åˆ—åµŒå…¥è¡¥ä¸ï¼Œæˆ‘ä»¬å°†å…¶ä¼ é€’ç»™ç±»ä¼¼äº BERT çš„æ¨¡å‹ã€‚****

****![](img/940719a29a134532f4f5b384c594e615.png)****

****Google Research åœ¨ 2021 å¹´çš„åŸå§‹è®ºæ–‡ä¸­ä»‹ç»çš„ ViT æ¨¡å‹ç»“æ„æ¦‚è¿°****

****Vision Transformer ä¸“æ³¨äºæ›´é«˜çš„ç²¾åº¦å’Œæ›´å°‘çš„è®¡ç®—æ—¶é—´ã€‚æŸ¥çœ‹è®ºæ–‡ä¸­å…¬å¸ƒçš„åŸºå‡†æµ‹è¯•ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œé’ˆå¯¹ [**å˜ˆæ‚çš„å­¦ç”Ÿ**](https://arxiv.org/abs/1911.04252v4) æ•°æ®é›†(ç”±è°·æ­Œäº 2020 å¹´ 6 æœˆå…¬å¸ƒ)çš„è®­ç»ƒæ—¶é—´å‡å°‘äº† 80%ï¼Œå°½ç®¡ç²¾åº¦çŠ¶æ€æˆ–å¤šæˆ–å°‘ç›¸åŒã€‚å¦‚éœ€äº†è§£æ›´å¤šå…³äº ViT æ€§èƒ½çš„ä¿¡æ¯ï¼Œè¯·è®¿é—®å…¶åœ¨ [**è®ºæ–‡ä¸Šçš„é¡µé¢ï¼Œä»£ç ä¸º**](https://paperswithcode.com/paper/an-image-is-worth-16x16-words-transformers-1) **:******

****![](img/0ed585ac142c790ff15e6c88fa6d24c6.png)****

****æµè¡Œå›¾åƒåˆ†ç±»åŸºå‡†çš„æ¯”è¾ƒã€‚([https://arxiv.org/pdf/2010.11929.pdf](https://arxiv.org/pdf/2010.11929.pdf))****

****å€¼å¾—ä¸€æçš„æ˜¯ï¼Œä¸€æ—¦æ‚¨é€šè¿‡ ViT æ¶æ„è®­ç»ƒäº†ä¸€ä¸ªæ¨¡å‹ï¼Œæ‚¨å°±å¯ä»¥åƒåœ¨ NLP ä¸­ä¸€æ ·é¢„è®­ç»ƒå’Œå¾®è°ƒæ‚¨çš„è½¬æ¢å™¨ã€‚(å®é™…ä¸Šè¿™å¾ˆé…·ï¼)****

****å¦‚æœæˆ‘ä»¬å°† ViT æ¨¡å‹ä¸ CNN è¿›è¡Œæ¯”è¾ƒï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå®ƒä»¬å…·æœ‰æ›´é«˜çš„ç²¾åº¦ï¼Œè€Œè®¡ç®—æˆæœ¬å´ä½å¾—å¤šã€‚æ‚¨å¯ä»¥å°† ViT æ¨¡å‹ç”¨äºè®¡ç®—æœºè§†è§‰ä¸­çš„å„ç§ä¸‹æ¸¸ä»»åŠ¡ï¼Œå¦‚å›¾åƒåˆ†ç±»ã€æ£€æµ‹å¯¹è±¡å’Œå›¾åƒåˆ†å‰²ã€‚è¿™ä¹Ÿå¯ä»¥æ˜¯åŒ»ç–—ä¿å¥é¢†åŸŸç‰¹æœ‰çš„ï¼Œä½ å¯ä»¥é’ˆå¯¹[è‚¡éª¨éª¨æŠ˜](https://towardsdatascience.com/vision-transformers-for-femur-fracture-classification-480d62f87252)ã€[è‚ºæ°”è‚¿](https://iopscience.iop.org/article/10.1088/1361-6560/ac3dc8/meta)ã€[ä¹³è…ºç™Œ](https://arxiv.org/abs/2110.14731)ã€[æ–°å† è‚ºç‚](https://www.mdpi.com/1660-4601/18/21/11086/pdf)å’Œ[è€å¹´ç—´å‘†ç—‡](https://www.biorxiv.org/content/10.1101/2021.11.27.470184v2.full)å¯¹ä½ çš„ ViT æ¨¡å‹è¿›è¡Œé¢„è®­ç»ƒ/å¾®è°ƒã€‚****

****æˆ‘å°†åœ¨æœ¬æ–‡æœ«å°¾ç•™ä¸‹å‚è€ƒèµ„æ–™ï¼Œä»¥é˜²æ‚¨æƒ³æ›´æ·±å…¥åœ°äº†è§£ ViT æ¨¡å‹æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚****

****[1]:æ·±æ½œ:æ‹¥æŠ±è„¸ä¸Šçš„è§†è§‰å˜å½¢é‡‘åˆšæœ€ä½³å›¾èŠ¯[https://huggingface.co/blog/vision-transformers](https://huggingface.co/blog/vision-transformers)****

## ****ä¸€äº›æ­£åœ¨ä½¿ç”¨çš„ ViT å‹å·****

****Vision Transformer (ViT)æ¨¡å‹([ViT-base-patch 16â€“224](https://huggingface.co/google/vit-base-patch16-224))åœ¨åˆ†è¾¨ç‡ä¸º 224x224 çš„ ImageNet-21k(1400 ä¸‡å¼ å›¾åƒï¼Œ21ï¼Œ843 ä¸ªç±»åˆ«)ä¸Šè¿›è¡Œäº†é¢„è®­ç»ƒï¼Œå¹¶åœ¨åˆ†è¾¨ç‡ä¸º 224x224 çš„ ImageNet 2012(100 ä¸‡å¼ å›¾åƒï¼Œ1ï¼Œ000 ä¸ªç±»åˆ«)ä¸Šè¿›è¡Œäº†å¾®è°ƒ:****

****![](img/5022db77c74538799997cd4705d19028.png)********![](img/b04d10d50b993fc8480d32bd234dc437.png)****

****[https://huggingface.co/google/vit-base-patch16-224](https://huggingface.co/google/vit-base-patch16-224)****

****ç”¨äºé£Ÿå“åˆ†ç±»çš„å¾®è°ƒ ViT æ¨¡å‹:****

****![](img/659ca69932ced659364a03795b87d3e0.png)********![](img/abcf2087fb6e8303d6b86c32787f6b27.png)****

****[https://huggingface.co/nateraw/food](https://huggingface.co/nateraw/food)â€”â€”[https://huggingface.co/julien-c/hotdog-not-hotdog](https://huggingface.co/julien-c/hotdog-not-hotdog)****

****ç„¶è€Œï¼Œå½“æ¶‰åŠåˆ°é¢„æµ‹æ—¶ï¼Œä»»ä½• DL/ML æ¨¡å‹éƒ½æœ‰å±€é™æ€§å’Œé™åˆ¶ã€‚æ²¡æœ‰ 100%å‡†ç¡®çš„æ¨¡å‹ï¼Œå› æ­¤å½“æ‚¨å°†å®ƒä»¬ç”¨äºåŒ»ç–—ä¿å¥ç­‰é‡è¦é¢†åŸŸæ—¶ï¼Œè¯·è®°ä½:****

****![](img/b43a9ddc546f066682f564e0b99ce252.png)********![](img/5f883876b1923726d960396c7dc1acac.png)****

******å›¾ç‰‡æ‘˜è‡ª:**[https://www . AKC . org/expert-advice/life style/do-you-live-in-dog-state-or-cat-state/](https://www.akc.org/expert-advice/lifestyle/do-you-live-in-dog-state-or-cat-state/)â€”**ViT model**:[https://huggingface.co/julien-c/hotdog-not-hotdog](https://huggingface.co/julien-c/hotdog-not-hotdog)****

****æˆ‘ä»¬æ˜¯å¦å¯ä»¥ä½¿ç”¨æ‹¥æŠ±è„¸çš„è¿™äº›æ¨¡å‹æˆ–å¾®è°ƒæ–°çš„ ViT æ¨¡å‹ï¼Œå¹¶å°†å…¶ç”¨äºå®é™…ç”Ÿäº§ä¸­çš„æ¨æ–­ï¼Ÿæˆ‘ä»¬å¦‚ä½•é€šè¿‡ä½¿ç”¨ AWS EMRã€Azure Insightã€GCP Dataproc æˆ– Databricks ç­‰åˆ†å¸ƒå¼è®¡ç®—æ‰˜ç®¡æœåŠ¡æ¥æ‰©å±•å®ƒä»¬ï¼Ÿ****

****å¸Œæœ›åœ¨æœ¬æ–‡ç»“æŸæ—¶ï¼Œè¿™äº›é—®é¢˜ä¸­çš„ä¸€äº›èƒ½å¤Ÿå¾—åˆ°è§£ç­”ã€‚****

# ****è®©åŸºå‡†æµ‹è¯•å¼€å§‹å§ï¼****

## ****å…³äºæˆ‘ä»¬åŸºå‡†çš„ä¸€äº›ç»†èŠ‚:****

******1-æ•°æ®é›†:** ImageNet mini: **æ ·æœ¬** ( > 3K) â€” **å®Œæ•´** ( > 34K)****

****æˆ‘å·²ç»ä» https://www.kaggle.com/datasets/ifigotin/imagenetmini-1000[çš„ ka ggle](https://www.kaggle.com/datasets/ifigotin/imagenetmini-1000)ä¸‹è½½äº† ImageNet 1000(è¿·ä½ )æ•°æ®é›†****

****æˆ‘é€‰æ‹©äº†åŒ…å«è¶…è¿‡ 34K å›¾åƒçš„ç›®å½•ï¼Œå¹¶å°†å…¶å‘½åä¸º imagenet-miniï¼Œå› ä¸ºæˆ‘æ‰€éœ€è¦çš„æ˜¯è¶³å¤Ÿå¤šçš„å›¾åƒæ¥è¿›è¡Œè€—æ—¶è¾ƒé•¿çš„åŸºå‡†æµ‹è¯•ã€‚æ­¤å¤–ï¼Œæˆ‘éšæœºé€‰æ‹©äº†ä¸åˆ° 10%çš„å®Œæ•´æ•°æ®é›†ï¼Œå¹¶å°†å…¶å‘½åä¸º **imagenet-mini-sample** ï¼Œå…¶ä¸­æœ‰ **3544 å¼ å›¾åƒ**ï¼Œç”¨äºæˆ‘çš„è¾ƒå°åŸºå‡†æµ‹è¯•ï¼Œå¹¶å¾®è°ƒåˆé€‚çš„å‚æ•°ï¼Œå¦‚æ‰¹é‡å¤§å°ã€‚****

******2-å‹å·:**è°·æ­Œçš„[vit-base-patch 16â€“224](https://huggingface.co/google/vit-base-patch16-224)****

****æˆ‘ä»¬å°†ä½¿ç”¨è¿™ä¸ªæ¥è‡ªè°·æ­Œçš„æ‹¥æŠ±è„¸æ¨¡å‹:[https://huggingface.co/google/vit-base-patch16-224](https://huggingface.co/google/vit-base-patch16-224)****

******3-åº“:** [**å˜å½¢é‡‘åˆš**](https://github.com/huggingface/transformers/) ğŸ¤—& [**ç«èŠ± NLP**](https://github.com/JohnSnowLabs/spark-nlp) ğŸš€****

## ****è£¸æœºæœåŠ¡å™¨ä¸Šçš„åŸºå‡†æµ‹è¯•æ‹¥æŠ±è„¸****

******Dell PowerEdge c 4130 ä¸Šçš„ ViT å‹å·******

****ä»€ä¹ˆæ˜¯è£¸æœºæœåŠ¡å™¨ï¼Ÿä¸€å°**è£¸æœº** - **é‡‘å±æœåŠ¡å™¨**åªæ˜¯ä¸€å°åªç”±ä¸€ä¸ªç”¨æˆ·ä½¿ç”¨çš„ç‰©ç†è®¡ç®—æœºã€‚è¿™å°æœºå™¨ä¸Šæ²¡æœ‰å®‰è£…è™šæ‹Ÿæœºç®¡ç†ç¨‹åºï¼Œæ²¡æœ‰è™šæ‹ŸåŒ–ï¼Œä¸€åˆ‡éƒ½ç›´æ¥åœ¨ä¸»æ“ä½œç³»ç»Ÿ(Linux-Ubuntu)ä¸Šæ‰§è¡Œâ€”â€”è¿™å°æœºå™¨çš„ CPUã€GPU å’Œå†…å­˜çš„è¯¦ç»†è§„æ ¼éƒ½åœ¨ç¬”è®°æœ¬ç”µè„‘ä¸­ã€‚****

> ****æ­£å¦‚æˆ‘çš„åˆå§‹æµ‹è¯•ä»¥åŠæ‹¥æŠ±è„¸å·¥ç¨‹å›¢é˜Ÿæ’°å†™çš„æ¯”è¾ƒ DL å¼•æ“æ¨ç†é€Ÿåº¦çš„å‡ ä¹æ¯ç¯‡åšå®¢æ–‡ç« æ‰€æ­ç¤ºçš„é‚£æ ·ï¼Œæ‹¥æŠ±è„¸åº“(Transformer)ä¸­æ¨ç†çš„æœ€ä½³æ€§èƒ½æ˜¯é€šè¿‡ä½¿ç”¨ PyTorch è€Œä¸æ˜¯ TensorFlow å®ç°çš„ã€‚æˆ‘ä¸ç¡®å®šè¿™æ˜¯å¦æ˜¯å› ä¸º TensorFlow åœ¨æ‹¥æŠ±è„¸æ–¹é¢æ˜¯äºŒç­‰å…¬æ°‘ï¼Œå› ä¸ºæ”¯æŒçš„åŠŸèƒ½æ›´å°‘ï¼Œæ”¯æŒçš„æ¨¡å‹æ›´å°‘ï¼Œç¤ºä¾‹æ›´å°‘ï¼Œè¿‡æ—¶çš„æ•™ç¨‹ï¼Œä»¥åŠè¿‡å» 2 å¹´ç”¨æˆ·å›ç­”çš„å¹´åº¦è°ƒæŸ¥æ›´å¤šåœ°è¯¢é—® TensorFlow æˆ– PyTorch åœ¨ CPU å’Œ GPU ä¸Šçš„æ¨ç†å»¶è¿Ÿæ›´ä½ã€‚****

> ****TensorFlow ä»ç„¶æ˜¯æœ€å¸¸ç”¨çš„æ·±åº¦å­¦ä¹ æ¡†æ¶****

****ä¸ç®¡ä»€ä¹ˆåŸå› ï¼Œæˆ‘åœ¨æ‹¥æŠ±äººè„¸åº“ä¸­é€‰æ‹©äº† PyTorchï¼Œä»¥è·å¾—æˆ‘ä»¬å›¾åƒåˆ†ç±»åŸºå‡†çš„æœ€ä½³ç»“æœã€‚è¿™æ˜¯åœ¨æ‹¥æŠ±è„¸ä¸­ä½¿ç”¨ ViT æ¨¡å‹(å½“ç„¶æ˜¯ PyTorch)çš„ç®€å•ä»£ç ç‰‡æ®µ:****

****[https://hugging face . co/Google/vit-base-patch 16-224 #ä½¿ç”¨æ–¹æ³•](https://huggingface.co/google/vit-base-patch16-224#how-to-use)****

****è¿™å¯èƒ½çœ‹èµ·æ¥ç›´æ¥é¢„æµ‹å›¾åƒä½œä¸ºè¾“å…¥ï¼Œä½†å®ƒä¸é€‚åˆå¤§é‡çš„å›¾åƒï¼Œå°¤å…¶æ˜¯åœ¨ GPU ä¸Šã€‚ä¸ºäº†é¿å…è¿ç»­é¢„æµ‹å›¾åƒï¼Œå¹¶åˆ©ç”¨ GPU ç­‰åŠ é€Ÿç¡¬ä»¶ï¼Œæœ€å¥½é€šè¿‡ [**ç®¡é“**](https://huggingface.co/docs/transformers/main_classes/pipelines#pipelines) å‘æ¨¡å‹æä¾›æ‰¹é‡å›¾åƒï¼Œè¿™åœ¨æ‹¥æŠ±é¢éƒ¨ä¸­æ˜¯å¯èƒ½çš„ã€‚ä¸ç”¨è¯´ï¼Œæ‚¨å¯ä»¥é€šè¿‡æ‰©å±• Hugging Face çš„ç®¡é“æˆ–è€…è‡ªå·±å®ç°æ‰¹å¤„ç†æŠ€æœ¯ã€‚****

****ç”¨äº**å›¾åƒåˆ†ç±»**çš„ä¸€ä¸ªç®€å•ç®¡é“å°†å¦‚ä¸‹æ‰€ç¤º:****

****[https://hugging face . co/docs/transformers/main _ classes/pipelines # transformersã€‚å›¾åƒåˆ†ç±»ç®¡é“](https://huggingface.co/docs/transformers/main_classes/pipelines#transformers.ImageClassificationPipeline)****

****æ ¹æ®æ–‡æ¡£ï¼Œæˆ‘å·²ç»ä¸ºç‰¹å¾æå–å™¨å’Œæ¨¡å‹(å½“ç„¶æ˜¯ PyTorch æ£€æŸ¥ç‚¹)ä¸‹è½½/åŠ è½½äº†**Google/vit-base-patch 16â€“224**,ä»¥ä¾¿åœ¨å›¾åƒåˆ†ç±»ä»»åŠ¡ä¸­ä½¿ç”¨å®ƒä»¬ã€‚å¯¹äºæˆ‘ä»¬çš„åŸºå‡†æµ‹è¯•ï¼Œæœ‰ä¸‰ä»¶äº‹éå¸¸é‡è¦:****

*   ******è®¾å¤‡**:å¦‚æœæ˜¯`-1`(é»˜è®¤)ï¼Œå®ƒå°†åªä½¿ç”¨ CPUï¼Œè€Œå¦‚æœæ˜¯æ­£æ•´æ•°ï¼Œå®ƒå°†åœ¨ç›¸å…³è”çš„ CUDA è®¾å¤‡ id ä¸Šè¿è¡Œæ¨¡å‹ã€‚(æœ€å¥½éšè— GPUï¼Œå¼ºåˆ¶ PyTorch ä½¿ç”¨ CPUï¼Œä¸è¦åªä¾èµ–è¿™é‡Œçš„è¿™ä¸ªæ•°å­—)ã€‚****
*   ******batch_size:** å½“ç®¡é“å°†ä½¿ç”¨ *DataLoader* (åœ¨ Pytorch æ¨¡å‹çš„ GPU ä¸Šä¼ é€’æ•°æ®é›†æ—¶)æ—¶ï¼Œè¦ä½¿ç”¨çš„æ‰¹å¤„ç†çš„å¤§å°å¯¹äºæ¨æ–­å¹¶ä¸æ€»æ˜¯æœ‰åˆ©çš„ã€‚****
*   ****æ‚¨å¿…é¡»ä½¿ç”¨ DataLoader æˆ– PyTorch æ•°æ®é›†æ¥å……åˆ†åˆ©ç”¨ GPU ä¸Šæ‹¥æŠ±é¢ç®¡é“ä¸­çš„æ‰¹å¤„ç†ã€‚****

****åœ¨æˆ‘ä»¬ç»§ç»­è¿›è¡ŒåŸºå‡†æµ‹è¯•ä¹‹å‰ï¼Œæ‚¨éœ€è¦çŸ¥é“ä¸€ä»¶å…³äºæ‹¥æŠ±é¢éƒ¨ç®¡é“æ‰¹å¤„ç†çš„äº‹æƒ…ï¼Œå®ƒå¹¶ä¸æ€»æ˜¯æœ‰æ•ˆçš„ã€‚æ­£å¦‚ Hugging Face çš„æ–‡æ¡£ä¸­æ‰€è¿°ï¼Œè®¾ç½® **batch_size** å¯èƒ½æ ¹æœ¬ä¸ä¼šæé«˜ç®¡é“çš„æ€§èƒ½ã€‚è¿™å¯èƒ½ä¼šé™ä½æ‚¨çš„é”€å”®è¿›åº¦:****

****![](img/c874180342ebb7d114037734f1bb4ff9.png)****

****[https://hugging face . co/docs/transformers/main _ classes/pipelines # pipeline-batching](https://huggingface.co/docs/transformers/main_classes/pipelines#pipeline-batching)****

****å…¬å¹³åœ°è¯´ï¼Œåœ¨æˆ‘çš„åŸºå‡†æµ‹è¯•ä¸­ï¼Œæˆ‘ä½¿ç”¨äº†ä¸€ä¸ªä» 1 å¼€å§‹çš„æ‰¹é‡èŒƒå›´ï¼Œä»¥ç¡®ä¿æˆ‘èƒ½ä»ä¸­æ‰¾åˆ°æœ€ä½³ç»“æœã€‚è¿™æ˜¯æˆ‘å¦‚ä½•åœ¨ CPU ä¸Šå¯¹æ‹¥æŠ±è„¸ç®¡é“è¿›è¡ŒåŸºå‡†æµ‹è¯•çš„:****

****åŸºå‡†æŠ±é¢ç®¡é“****

****è®©æˆ‘ä»¬æ¥çœ‹çœ‹æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªåœ¨ CPU ä¸Šçš„æ‹¥æŠ±è„¸å›¾åƒåˆ†ç±»ç®¡é“çš„åŸºå‡†æµ‹è¯•åœ¨æ ·æœ¬(3K) ImageNet æ•°æ®é›†ä¸Šçš„ç»“æœ:****

****![](img/97093bbf145cffab054a755bf166dea1.png)****

****CPU ä¸Šçš„æ‹¥æŠ±äººè„¸å›¾åƒåˆ†ç±»æµæ°´çº¿â€”â€”é¢„æµ‹ 3544 å¹…å›¾åƒ****

****å¯ä»¥çœ‹å‡ºï¼Œå®Œæˆå¯¹æ ·æœ¬æ•°æ®é›†ä¸­å¤§çº¦ **3544 å¹…å›¾åƒ**çš„å¤„ç†èŠ±è´¹äº†å¤§çº¦ 3 åˆ†é’Ÿ( **188 ç§’)**ã€‚ç°åœ¨æˆ‘çŸ¥é“äº†å“ªä¸ªæ‰¹å¤„ç†å¤§å°(8)æœ€é€‚åˆæˆ‘çš„ç®¡é“/æ•°æ®é›†/ç¡¬ä»¶ï¼Œæˆ‘å¯ä»¥åœ¨æ›´å¤§çš„æ•°æ®é›†( **34K å›¾åƒ**)ä¸Šä½¿ç”¨ç›¸åŒçš„ç®¡é“ï¼Œæ‰¹å¤„ç†å¤§å°ä¸º:****

****![](img/e80b8f0eb290e869e0b7f182f7ad5c31.png)****

****CPU ä¸Šçš„æ‹¥æŠ±äººè„¸å›¾åƒåˆ†ç±»æµæ°´çº¿â€”é¢„æµ‹ 34745 å¹…å›¾åƒ****

****è¿™ä¸€æ¬¡èŠ±äº†å¤§çº¦ 31 åˆ†é’Ÿ( **1ï¼Œ879 ç§’**)åœ¨ CPU ä¸Šå®Œæˆäº†å¯¹ **34745 å¹…å›¾åƒ**çš„åˆ†ç±»é¢„æµ‹ã€‚****

****è¦æ”¹è¿›å¤§å¤šæ•°æ·±åº¦å­¦ä¹ æ¨¡å‹ï¼Œå°¤å…¶æ˜¯è¿™äº›åŸºäº transformer çš„æ–°æ¨¡å‹ï¼Œåº”è¯¥ä½¿ç”¨ GPU ç­‰åŠ é€Ÿç¡¬ä»¶ã€‚è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•åœ¨å®Œå…¨ç›¸åŒçš„æ•°æ®é›†ä¸Šå¯¹å®Œå…¨ç›¸åŒçš„æµæ°´çº¿è¿›è¡ŒåŸºå‡†æµ‹è¯•ï¼Œä½†è¿™æ¬¡æ˜¯åœ¨ä¸€ä¸ª **GPU** è®¾å¤‡ä¸Šã€‚å¦‚å‰æ‰€è¿°ï¼Œæˆ‘ä»¬éœ€è¦å°†**è®¾å¤‡**æ”¹ä¸ºç±»ä¼¼`0`(ç¬¬ä¸€ä¸ª GPU)çš„ CUDA è®¾å¤‡ id:****

****é™¤äº†è®¾ç½®`device=0`ï¼Œæˆ‘è¿˜æŒ‰ç…§æ¨èçš„æ–¹å¼é€šè¿‡`.to(device)`åœ¨ GPU è®¾å¤‡ä¸Šè¿è¡Œ PyTorch æ¨¡å‹ã€‚ç”±äºæˆ‘ä»¬ä½¿ç”¨åŠ é€Ÿç¡¬ä»¶(GPU ),æˆ‘è¿˜å°†æµ‹è¯•çš„æœ€å¤§æ‰¹é‡å¢åŠ åˆ° 1024ï¼Œä»¥æ‰¾åˆ°æœ€ä½³ç»“æœã€‚****

****è®©æˆ‘ä»¬é€šè¿‡ç¤ºä¾‹ ImageNet æ•°æ®é›†(3K)æ¥çœ‹çœ‹æˆ‘ä»¬åœ¨ GPU è®¾å¤‡ä¸Šçš„æ‹¥æŠ±é¢éƒ¨å›¾åƒåˆ†ç±»ç®¡é“:****

****![](img/5894c2d05bcb2a7345e433ff989c3985.png)****

****GPU ä¸Šçš„æ‹¥æŠ±äººè„¸å›¾åƒåˆ†ç±»æµæ°´çº¿â€”é¢„æµ‹ 3544 å¹…å›¾åƒ****

****å¯ä»¥çœ‹å‡ºï¼Œåœ¨ä¸€ä¸ª **GPU è®¾å¤‡**ä¸Šï¼Œæˆ‘ä»¬èŠ±äº†å¤§çº¦ **50 ç§’**æ¥å®Œæˆå¯¹æ¥è‡ª imagenet-mini-sample æ•°æ®é›†çš„å¤§çº¦ **3544 å¼ å›¾åƒ**çš„å¤„ç†ã€‚æ‰¹å¤„ç†æé«˜äº†é€Ÿåº¦ï¼Œç‰¹åˆ«æ˜¯ä¸æ¥è‡ª CPU çš„ç»“æœç›¸æ¯”ï¼Œä½†æ˜¯ï¼Œåœ¨æ‰¹å¤„ç†å¤§å°ä¸º 32 å·¦å³æ—¶ï¼Œè¿™ç§æé«˜åœæ­¢äº†ã€‚å°½ç®¡åœ¨æ‰¹é‡å¤§å°ä¸º 32 ä¹‹åç»“æœæ˜¯ç›¸åŒçš„ï¼Œä½†æˆ‘è¿˜æ˜¯é€‰æ‹©äº†æ‰¹é‡å¤§å°ä¸º **256** ä½œä¸ºæˆ‘çš„æ›´å¤§çš„åŸºå‡†ï¼Œä»¥ä¾¿åˆ©ç”¨è¶³å¤Ÿçš„ GPU å†…å­˜ã€‚****

****![](img/67fc69608adad4315253071950018d00.png)****

****åœ¨ GPU ä¸Šæ‹¥æŠ±äººè„¸å›¾åƒåˆ†ç±»æµæ°´çº¿â€”â€”é¢„æµ‹ 34745 å¼ å›¾åƒ****

****è¿™ä¸€æ¬¡ï¼Œæˆ‘ä»¬çš„åŸºå‡†æµ‹è¯•ç”¨äº†å¤§çº¦ 8:17 åˆ†é’Ÿ( **497 ç§’**)åœ¨ä¸€ä¸ª **GPU** è®¾å¤‡ä¸Šå®Œæˆäº†å¯¹ **34745 å¹…å›¾åƒ**çš„é¢„æµ‹ã€‚å¦‚æœæˆ‘ä»¬æ¯”è¾ƒæˆ‘ä»¬åœ¨ CPU å’Œ GPU è®¾å¤‡ä¸Šçš„åŸºå‡†æµ‹è¯•ç»“æœï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° GPU æ˜¯èµ¢å®¶:****

****![](img/7c5d3c3fabe7b49b2650ff69f59182f6.png)****

****æ‹¥æŠ±è„¸(PyTorch)åœ¨ GPU ä¸Šæ¯” CPU å¿« 3.9 å€****

> ****æˆ‘ä½¿ç”¨ Hugging Face ç®¡é“æ¥åŠ è½½ ViT PyTorch æ£€æŸ¥ç‚¹ï¼Œå°†æˆ‘çš„æ•°æ®åŠ è½½åˆ° Torch æ•°æ®é›†ä¸­ï¼Œå¹¶åœ¨ CPU å’Œ GPU ä¸Šä½¿ç”¨ç°æˆçš„æ‰¹å¤„ç†ã€‚ä¸åœ¨ CPU ä¸Šè¿è¡Œç›¸åŒçš„æµæ°´çº¿ç›¸æ¯”ï¼Œ **GPU** çš„é€Ÿåº¦é«˜è¾¾**åˆ° 3.9 å€**ã€‚****

****æˆ‘ä»¬å·²ç»æ”¹è¿›äº†æˆ‘ä»¬çš„ ViT ç®¡é“ï¼Œé€šè¿‡ä½¿ç”¨ä¸€ä¸ª **GPU è®¾å¤‡**è€Œä¸æ˜¯ CPU æ¥æ‰§è¡Œå›¾åƒåˆ†ç±»ï¼Œä½†æ˜¯åœ¨å°†å…¶æ‰©å±•åˆ°å¤šå°æœºå™¨ä¹‹å‰ï¼Œæˆ‘ä»¬èƒ½å¦åœ¨å•å°æœºå™¨ä¸­çš„ä¸¤ä¸ª **CPU** & **GPU** ä¸Šè¿›ä¸€æ­¥æ”¹è¿›æˆ‘ä»¬çš„ç®¡é“ï¼Ÿæˆ‘ä»¬æ¥çœ‹çœ‹ Spark NLP åº“ã€‚****

# ****Spark NLP:æœ€å…ˆè¿›çš„è‡ªç„¶è¯­è¨€å¤„ç†****

****![](img/09d6d3794c338e42b6264c4f6be52771.png)****

****Spark NLP æ˜¯ä¸€ä¸ªå¼€æºçš„æœ€å…ˆè¿›çš„è‡ªç„¶è¯­è¨€å¤„ç†åº“([https://github.com/JohnSnowLabs/spark-nlp](https://github.com/JohnSnowLabs/spark-nlp))****

****Spark NLP æ˜¯ä¸€ä¸ªæœ€å…ˆè¿›çš„è‡ªç„¶è¯­è¨€å¤„ç†åº“ï¼Œæ„å»ºäº Apache Spark ä¹‹ä¸Šã€‚å®ƒä¸ºæœºå™¨å­¦ä¹ ç®¡é“æä¾›äº†ç®€å•ã€é«˜æ€§èƒ½å’Œå‡†ç¡®çš„ NLP æ³¨é‡Šï¼Œå¯ä»¥åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­è½»æ¾æ‰©å±•ã€‚Spark NLP é…æœ‰ **7000+** ç»è¿‡é¢„å¤„ç†çš„**ç®¡é“**å’Œ**å‹å·**ï¼Œæ”¯æŒè¶…è¿‡ **200+ç§è¯­è¨€**ã€‚å®ƒè¿˜æä¾›è¯¸å¦‚æ ‡è®°åŒ–ã€åˆ†è¯ã€è¯æ€§æ ‡æ³¨ã€å•è¯å’Œå¥å­åµŒå…¥ã€å‘½åå®ä½“è¯†åˆ«ã€ä¾å­˜è§£æã€æ‹¼å†™æ£€æŸ¥ã€æ–‡æœ¬åˆ†ç±»ã€æƒ…æ„Ÿåˆ†æã€æ ‡è®°åˆ†ç±»ã€æœºå™¨ç¿»è¯‘(+180 ç§è¯­è¨€)ã€æ‘˜è¦&é—®ç­”ã€æ–‡æœ¬ç”Ÿæˆã€å›¾åƒåˆ†ç±»(ViT)ç­‰ä»»åŠ¡ï¼Œä»¥åŠæ›´å¤š [NLP ä»»åŠ¡](https://github.com/JohnSnowLabs/spark-nlp#features)ã€‚****

> ****Spark NLP æ˜¯å”¯ä¸€ä¸€ä¸ªæ­£åœ¨ç”Ÿäº§çš„å¼€æº NLP åº“ï¼Œæä¾›æœ€å…ˆè¿›çš„å˜å‹å™¨ï¼Œå¦‚**ä¼¯ç‰¹**ã€**å¡é—¨ä¼¯ç‰¹**ã€**è‰¾ä¼¯ç‰¹**ã€**ä¼Šè±å…‹ç‰¹æ‹‰**ã€ **XLNet** ã€**è’¸é¦ä¼¯ç‰¹**ã€**ç½—ä¼¯å¡”**ã€**å¾·ä¼¯å¡”**ã€**XLM-ç½—ä¼¯å¡”**ã€ **è€Œ Vision Transformer ( **ViT** )ä¸ä»…å¯ä»¥æ‰©å±•åˆ° **Python** å’Œ **R** ï¼Œè¿˜å¯ä»¥é€šè¿‡åŸç”Ÿæ‰©å±• Apache Spark å¤§è§„æ¨¡æ‰©å±•åˆ° JVM ç”Ÿæ€ç³»ç»Ÿ( **Java** ã€ **Scala** å’Œ **Kotlin** )ã€‚******

## **è£¸æœºæœåŠ¡å™¨ä¸Šçš„ Spark NLP åŸºå‡†æµ‹è¯•**

****Dell PowerEdge c 4130 ä¸Šçš„ ViT å‹å·****

**Spark NLP åœ¨æœ€è¿‘çš„ **4.1.0** ç‰ˆæœ¬ä¸­æ·»åŠ äº†ä¸æ‹¥æŠ±è„¸ç›¸åŒçš„**å›¾åƒåˆ†ç±»**ViT åŠŸèƒ½ã€‚è¿™ä¸ªç‰¹æ€§å«åš***ViTForImageClassificationï¼Œ*** *å®ƒæ‹¥æœ‰è¶…è¿‡* ***240 ä¸ªé¢„å…ˆè®­ç»ƒå¥½çš„æ¨¡å‹*** *å‡†å¤‡å°±ç»ª* ***ï¼Œ*** ï¼Œåœ¨ Spark NLP ä¸­ä½¿ç”¨è¿™ä¸ªç‰¹æ€§çš„ç®€å•ä»£ç å¦‚ä¸‹:**

**å¦‚æœæˆ‘ä»¬å¹¶æ’æ¯”è¾ƒ Spark NLP å’Œ Hugging Face ä¸‹è½½å’ŒåŠ è½½é¢„è®­ç»ƒçš„ ViT æ¨¡å‹ä»¥è¿›è¡Œå›¾åƒåˆ†ç±»é¢„æµ‹ï¼Œé™¤äº†åŠ è½½å›¾åƒå’Œåœ¨ Hugging Face åº“å¤–ä½¿ç”¨ç±»ä¼¼`argmax`çš„åæœŸè®¡ç®—ï¼Œå®ƒä»¬éƒ½éå¸¸ç®€å•ã€‚æ­¤å¤–ï¼Œå®ƒä»¬éƒ½å¯ä»¥è¢«ä¿å­˜ï¼Œå¹¶åœ¨ä»¥åç”¨ä½œç®¡é“ï¼Œä»¥å°†è¿™äº›è¡Œå‡å°‘åˆ°åªæœ‰ä¸€è¡Œä»£ç :**

**![](img/f378f4da704633f668afc73d1e7d5838.png)****![](img/eef7013034e58d74e74822ca92d82bc9.png)**

**åœ¨ Spark NLP(å·¦)å’Œæ‹¥æŠ±è„¸(å³)ä¸­åŠ è½½å’Œä½¿ç”¨ ViT æ¨¡å‹è¿›è¡Œå›¾åƒåˆ†ç±»**

**å› ä¸º Apache Spark æœ‰ä¸€ä¸ªå«åš**æƒ°æ€§è¯„ä¼°**çš„æ¦‚å¿µï¼Œæ‰€ä»¥ç›´åˆ°è°ƒç”¨äº†**åŠ¨ä½œ**å®ƒæ‰å¼€å§‹æ‰§è¡Œæµç¨‹ã€‚Apache Spark ä¸­çš„æ“ä½œå¯ä»¥æ˜¯`.count()`æˆ–`.show()`æˆ–`.write()`ä»¥åŠè®¸å¤šå…¶ä»–åŸºäº RDD çš„æ“ä½œï¼Œæˆ‘ç°åœ¨ä¸ä¼šæ·±å…¥è®¨è®ºè¿™äº›æ“ä½œï¼Œå¯¹äºæœ¬æ–‡ï¼Œæ‚¨ä¸éœ€è¦äº†è§£å®ƒä»¬ã€‚æˆ‘é€šå¸¸é€‰æ‹©`count()`ç›®æ ‡åˆ—æˆ–è€…`write()`ç£ç›˜ä¸Šçš„ç»“æœæ¥è§¦å‘æ‰§è¡Œæ•°æ®å¸§ä¸­çš„æ‰€æœ‰è¡Œã€‚æ­¤å¤–ï¼Œåƒæ‹¥æŠ±è„¸åŸºå‡†ä¸€æ ·ï¼Œæˆ‘å°†å¾ªç¯é€‰æ‹©æ‰¹é‡å¤§å°ï¼Œä»¥ç¡®ä¿æˆ‘å¯ä»¥å¾—åˆ°æ‰€æœ‰å¯èƒ½çš„ç»“æœï¼Œè€Œä¸ä¼šé”™è¿‡æœ€ä½³ç»“æœã€‚**

**ç°åœ¨ï¼Œæˆ‘ä»¬çŸ¥é“äº†å¦‚ä½•åœ¨ Spark NLP ä¸­åŠ è½½ ViT æ¨¡å‹ï¼Œæˆ‘ä»¬ä¹ŸçŸ¥é“äº†å¦‚ä½•è§¦å‘ä¸€ä¸ªåŠ¨ä½œæ¥å¼ºåˆ¶å¯¹æ•°æ®å¸§ä¸­çš„æ‰€æœ‰è¡Œè¿›è¡Œè®¡ç®—ä»¥è¿›è¡ŒåŸºå‡†æµ‹è¯•ï¼Œå‰©ä¸‹è¦å­¦ä¹ çš„å°±æ˜¯æ¥è‡ª [oneAPI æ·±åº¦ç¥ç»ç½‘ç»œåº“(oneDNN)](https://github.com/oneapi-src/oneDNN) çš„ oneDNNã€‚ç”±äº Spark NLP ä¸­çš„ DL å¼•æ“æ˜¯ TensorFlowï¼Œæ‚¨è¿˜å¯ä»¥å¯ç”¨ oneDNN æ¥æé«˜ CPU ä¸Šçš„é€Ÿåº¦(åƒå…¶ä»–ä»»ä½•äº‹æƒ…ä¸€æ ·ï¼Œæ‚¨éœ€è¦æµ‹è¯•è¿™ä¸€ç‚¹ï¼Œä»¥ç¡®ä¿å®ƒæé«˜äº†é€Ÿåº¦ï¼Œè€Œä¸æ˜¯ç›¸å)ã€‚é™¤äº†æ²¡æœ‰å¯ç”¨ oneDNN çš„æ™®é€š CPU ä¹‹å¤–ï¼Œæˆ‘ä¹Ÿå°†ä½¿ç”¨è¿™ä¸ªæ ‡å¿—**

**ç°åœ¨ï¼Œæˆ‘ä»¬çŸ¥é“äº† Hugging Face çš„æ‰€æœ‰ ViT æ¨¡å‹ä¹Ÿå¯ç”¨äº Spark NLPï¼Œä»¥åŠå¦‚ä½•åœ¨ç®¡é“ä¸­ä½¿ç”¨å®ƒä»¬ï¼Œæˆ‘ä»¬å°†åœ¨è£¸æœºæˆ´å°”æœåŠ¡å™¨ä¸Šé‡å¤ä¹‹å‰çš„åŸºå‡†æµ‹è¯•ï¼Œä»¥æ¯”è¾ƒ CPU å’Œ GPUã€‚è®©æˆ‘ä»¬çœ‹çœ‹ Spark NLP åœ¨ CPU ä¸Šçš„å›¾åƒåˆ†ç±»ç®¡é“åœ¨æˆ‘ä»¬çš„æ ·æœ¬(3K) ImageNet æ•°æ®é›†ä¸Šçš„ç»“æœ:**

**![](img/c0334eef45a4a34fa8a917df6c0ab4f6.png)**

**æ²¡æœ‰ oneDNN çš„ CPU ä¸Šçš„ spark nli image-åˆ†ç±»æµæ°´çº¿â€”é¢„æµ‹ 3544 ä¸ªå›¾åƒ**

**å¤§çº¦èŠ±äº† 2.1 åˆ†é’Ÿ( **130 ç§’)**æ¥å®Œæˆå¯¹æ¥è‡ªæˆ‘ä»¬æ ·æœ¬æ•°æ®é›†çš„å¤§çº¦ **3544 å¼ å›¾åƒ**çš„å¤„ç†ã€‚ä½¿ç”¨è¾ƒå°çš„æ•°æ®é›†æ¥å°è¯•ä¸åŒçš„æ‰¹å¤„ç†å¤§å°æœ‰åŠ©äºä¸ºæ‚¨çš„ä»»åŠ¡ã€æ•°æ®é›†å’Œè®¡ç®—æœºé€‰æ‹©æ­£ç¡®çš„æ‰¹å¤„ç†å¤§å°ã€‚å¾ˆæ˜æ˜¾**æ‰¹æ¬¡å¤§å° 16** æ˜¯æˆ‘ä»¬çš„ç®¡é“äº¤ä»˜æœ€ä½³ç»“æœçš„æœ€ä½³å¤§å°ã€‚**

**æˆ‘è¿˜æƒ³å¯ç”¨ **oneDNN** ï¼Œçœ‹çœ‹åœ¨è¿™ç§ç‰¹å®šæƒ…å†µä¸‹ï¼Œä¸æ²¡æœ‰ oneDNN çš„ CPU ç›¸æ¯”ï¼Œå®ƒæ˜¯å¦æé«˜äº†æˆ‘çš„æ€§èƒ½æŒ‡æ ‡è¯„æµ‹ã€‚é€šè¿‡å°† **TF_ENABLE_ONEDNN_OPTS** çš„ç¯å¢ƒå˜é‡è®¾ç½®ä¸º **1ï¼Œå¯ä»¥åœ¨ Spark NLP ä¸­å¯ç”¨ oneDNNã€‚**è®©æˆ‘ä»¬çœ‹çœ‹ï¼Œå¦‚æœæˆ‘å¯ç”¨æ­¤æ ‡å¿—å¹¶åœ¨ CPU ä¸Šé‡æ–°è¿è¡Œä¹‹å‰çš„åŸºå‡†æµ‹è¯•ä»¥æ‰¾åˆ°æœ€ä½³æ‰¹é‡ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µ:**

**![](img/887bfaba4391dc65e5b8b9a6d3a4271a.png)**

**åœ¨å…·æœ‰ oneDNN çš„ CPU ä¸Šçš„ spark nli image-åˆ†ç±»æµæ°´çº¿â€”é¢„æµ‹ 3544 å¹…å›¾åƒ**

**å¾ˆæ˜æ˜¾ï¼Œåœ¨è¿™ç§ç‰¹å®šæƒ…å†µä¸‹ï¼Œä¸º TensorFlow å¯ç”¨ oneDNN å°†æˆ‘ä»¬çš„ç»“æœæé«˜äº†è‡³å°‘ 14%ã€‚å› ä¸ºæˆ‘ä»¬ä¸éœ€è¦åš/æ”¹å˜ä»»ä½•äº‹æƒ…ï¼Œåªéœ€è¦è¯´`export TF_ENABLE_ONEDNN_OPTS=1`æˆ‘å°†æŠŠå®ƒç”¨äºå…·æœ‰æ›´å¤§æ•°æ®é›†çš„åŸºå‡†æµ‹è¯•ï¼Œä»¥æŸ¥çœ‹å·®å¼‚ã€‚è¿™å¤§çº¦å¿«äº†å‡ ç§’é’Ÿï¼Œä½†æ˜¯åœ¨è¾ƒå¤§çš„æ•°æ®é›†ä¸Šå¿« 14%ä¼šå‡å°‘å‡ åˆ†é’Ÿçš„ç»“æœã€‚**

**ç°åœ¨ï¼Œæˆ‘çŸ¥é“äº†ä¸ä½¿ç”¨ oneDNN çš„ CPU çš„æ‰¹é‡å¤§å°ä¸º 16ï¼Œå¯ç”¨ oneDNN çš„ CPU çš„æ‰¹é‡å¤§å°ä¸º 2ï¼Œå¯ä»¥è·å¾—æœ€ä½³ç»“æœï¼Œæˆ‘å¯ä»¥ç»§ç»­åœ¨æ›´å¤§çš„æ•°æ®é›†ä¸Šä½¿ç”¨ç›¸åŒçš„ç®¡é“( **34K å›¾åƒ**):**

**![](img/9672d2180ba4d1453f82c4fb0bae2345.png)**

**æ—  oneDNN çš„ CPU ä¸Šçš„ Spark NLP å›¾åƒåˆ†ç±»æµæ°´çº¿â€”é¢„æµ‹ 34745 å¹…å›¾åƒ**

**è¿™ä¸€æ¬¡ï¼Œæˆ‘ä»¬çš„åŸºå‡†æµ‹è¯•ç”¨äº†å¤§çº¦ 24 åˆ†é’Ÿ( **1423 ç§’**)åœ¨æ²¡æœ‰å¯ç”¨ oneDNN çš„ **CPU** è®¾å¤‡ä¸Šå®Œæˆäº†å¯¹ **34745 ä¸ªå›¾åƒ**çš„åˆ†ç±»é¢„æµ‹ã€‚ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹ï¼Œå¦‚æœæˆ‘ä¸º TensorFlow å¯ç”¨ oneDNN å¹¶ä½¿ç”¨æ‰¹é‡å¤§å° 2(æœ€ä½³ç»“æœ)ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µ:**

**![](img/c9549b764c84fb22e9ba539e539f7abe.png)**

**å…·æœ‰ oneDNN çš„ CPU ä¸Šçš„ Spark NLP å›¾åƒåˆ†ç±»æµæ°´çº¿â€”é¢„æµ‹ 34745 å¹…å›¾åƒ**

**è¿™æ¬¡ç”¨äº†å¤§çº¦ 21 åˆ†é’Ÿ( **1278 ç§’**)ã€‚æ­£å¦‚æˆ‘ä»¬çš„æ ·æœ¬æ€§èƒ½æŒ‡æ ‡è¯„æµ‹æ‰€é¢„æœŸçš„é‚£æ ·ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç»“æœä¸­çœ‹åˆ°å¤§çº¦ **11%çš„æ”¹è¿›**ï¼Œä¸æ²¡æœ‰å¯ç”¨ oneDNN çš„æƒ…å†µç›¸æ¯”ï¼Œè¿™ç¡®å®èŠ‚çœäº†æ—¶é—´ã€‚**

**è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•åœ¨ GPU è®¾å¤‡ä¸Šå¯¹å®Œå…¨ç›¸åŒçš„æµæ°´çº¿è¿›è¡ŒåŸºå‡†æµ‹è¯•ã€‚åœ¨ Spark NLP ä¸­ï¼Œä½¿ç”¨ GPU æ‰€éœ€è¦çš„åªæ˜¯åœ¨å¯åŠ¨ Spark NLP ä¼šè¯æ—¶ç”¨`gpu=True`å¯åŠ¨å®ƒ:**

```
spark = sparknlp.start(gpu=True)
# you can set the memory here as well
spark = sparknlp.start(gpu=True, memory="16g")
```

**å°±æ˜¯è¿™æ ·ï¼å¦‚æœæ‚¨çš„ç®¡é“ä¸­æœ‰å¯ä»¥åœ¨ GPU ä¸Šè¿è¡Œçš„ä¸œè¥¿ï¼Œå®ƒä¼šè‡ªåŠ¨å®Œæˆï¼Œè€Œä¸éœ€è¦æ˜¾å¼åœ°åšä»»ä½•äº‹æƒ…ã€‚**

**è®©æˆ‘ä»¬é€šè¿‡ç¤ºä¾‹ ImageNet æ•°æ®é›†(3K)æ¥çœ‹çœ‹æˆ‘ä»¬åœ¨ GPU è®¾å¤‡ä¸Šçš„ Spark NLP å›¾åƒåˆ†ç±»ç®¡é“:**

**![](img/a49a420818a026da1a9147d357f700a7.png)**

**GPU ä¸Šçš„ Spark å›¾åƒåˆ†ç±»æµæ°´çº¿â€”é¢„æµ‹ 3544 å¹…å›¾åƒ**

**å‡ºäºå¥½å¥‡ï¼Œæˆ‘æƒ³çŸ¥é“æˆ‘åœ¨è¾ƒå°çš„æ•°æ®é›†ä¸Šå¯»æ‰¾ä¸€ä¸ªå¥½çš„æ‰¹é‡å¤§å°çš„åŠªåŠ›æ˜¯å¦æ­£ç¡®ï¼Œæˆ‘åœ¨è¾ƒå¤§çš„æ•°æ®é›†ä¸Šç”¨ GPU è¿è¡Œäº†ç›¸åŒçš„ç®¡é“ï¼Œä»¥æŸ¥çœ‹æ‰¹é‡å¤§å° 32 æ˜¯å¦ä¼šæœ‰æœ€å¥½çš„ç»“æœ:**

**![](img/d49457988e0516a660cb061bf70f0ebb.png)**

**GPU ä¸Šçš„ Spark NLP å›¾åƒåˆ†ç±»æµæ°´çº¿â€”é¢„æµ‹ 34745 å¹…å›¾åƒ**

**å¹¸è¿çš„æ˜¯ï¼Œæ‰¹é‡ 32 äº§ç”Ÿäº†æœ€å¥½çš„æ—¶é—´ã€‚æ‰€ä»¥ç”¨äº† 4 åˆ†åŠå·¦å³( **277 ç§’)ã€‚****

**æˆ‘å°†ä»å…·æœ‰ oneDNN çš„**CPU ä¸­æŒ‘é€‰ç»“æœï¼Œå› ä¸ºå®ƒä»¬æ›´å¿«ï¼Œæˆ‘å°†æŠŠå®ƒä»¬ä¸ **GPU** ç»“æœè¿›è¡Œæ¯”è¾ƒ:****

**![](img/81bc1314b0ac3591e9a8429c6c763f4a.png)**

**Spark NLP (TensorFlow)åœ¨ GPU ä¸Šæ¯” CPU (oneDNN)å¿« 4.6 å€**

> **è¿™å¤ªæ£’äº†ï¼æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå³ä½¿å¯ç”¨äº† oneDNNï¼ŒGPU ä¸Šçš„ Spark NLP ä¹Ÿæ¯” CPU å¿«äº† 4.6 å€**ã€‚****

****è®©æˆ‘ä»¬æ¥çœ‹çœ‹è¿™äº›ç»“æœæ˜¯å¦‚ä½•ä¸æ‹¥æŠ±è„¸åŸºå‡†è¿›è¡Œæ¯”è¾ƒçš„:****

****![](img/14eb465c158e80d261ca64d50e2d706b.png)********![](img/73c1c4bbed546b3b147c8ce3039ffe8e.png)****

******Spark NLP** åœ¨ **CPU** å’Œ **GPU** ä¸Š **ViT** å‹å·æ¨æ–­**æ¯”**æŠ±è„¸**å¿«******

> ******Spark NLP** åœ¨é¢„æµ‹å…·æœ‰ 3K å›¾åƒçš„æ ·æœ¬æ•°æ®é›†çš„å›¾åƒç±»æ—¶ï¼Œæ¯”**CPU**ä¸Šçš„æ‹¥æŠ±è„¸å¿« **65%,åœ¨å…·æœ‰ 34K å›¾åƒçš„è¾ƒå¤§æ•°æ®é›†ä¸Šå¿« 47%ã€‚ **Spark NLP** åœ¨å•ä¸ª **GPU** æ¨ç† 34K å›¾åƒçš„è¾ƒå¤§æ•°æ®é›†ä¸Šæ¯”æ‹¥æŠ±è„¸**å¿« **79%ï¼Œåœ¨è¾ƒå°æ•°æ®é›†ä¸Šå¿« 35%ã€‚******

**![](img/9df2664c63115a258989bc1bc4365b81.png)****![](img/75b99f1a337573c2e1f86814cf8c5d08.png)**

**ä¸æ‹¥æŠ±è„¸ç›¸æ¯”ï¼Œ **Spark NLP** åœ¨ **CPU** ä¸Šå¿«äº† 65% ï¼Œåœ¨ **GPU** ä¸Šå¿«äº† 79%**

> **é€šè¿‡ä½¿ç”¨ CPU æˆ– GPUï¼ŒSpark NLP æ¯”å•æœºä¸­çš„æ‹¥æŠ±è„¸æ›´å¿«â€”â€”é€šè¿‡ä½¿ç”¨è§†è§‰è½¬æ¢å™¨(ViT)è¿›è¡Œå›¾åƒåˆ†ç±»**

**åœ¨ [**ç¬¬ 2 éƒ¨åˆ†**](https://medium.com/@maziyar/scale-vision-transformers-vit-beyond-hugging-face-part-2-b7b296d548b7) ä¸­ï¼Œæˆ‘å°†åœ¨ Databricks å•èŠ‚ç‚¹(CPU & GPU)ä¸Šè¿è¡Œç›¸åŒçš„åŸºå‡†æµ‹è¯•ï¼Œä»¥æ¯”è¾ƒ Spark NLP ä¸ Hugging Faceã€‚**

# **å‚è€ƒ**

****ViT****

*   **[https://arxiv.org/pdf/2010.11929.pdf](https://arxiv.org/pdf/2010.11929.pdf)**
*   **ã€https://github.com/google-research/vision_transformer **
*   **[å›¾åƒè¯†åˆ«ä¸­çš„è§†è§‰å˜å‹å™¨(ViT)â€”â€”2022 æŒ‡å—](https://viso.ai/deep-learning/vision-transformer-vit/)**
*   **[https://github.com/lucidrains/vit-pytorch](https://github.com/lucidrains/vit-pytorch)**
*   **[https://medium . com/mlearning-ai/an-image-is-worth-16x 16-words-transformers-for-image-recognition-at-scale-51f 3561 a9f 96](https://medium.com/mlearning-ai/an-image-is-worth-16x16-words-transformers-for-image-recognition-at-scale-51f3561a9f96)**
*   **[https://medium . com/nerd-for-tech/an-image-worth-16x 16-words-transformers-for-image-recognition-at-scale-paper-summary-3a 387 e 71880 a](https://medium.com/nerd-for-tech/an-image-is-worth-16x16-words-transformers-for-image-recognition-at-scale-paper-summary-3a387e71880a)**
*   **[https://gareemadhingra 11 . medium . com/summary-of-paper-an-image-worth-16x 16-words-3f 7 F3 ACA 941](https://gareemadhingra11.medium.com/summary-of-paper-an-image-is-worth-16x16-words-3f7f3aca941)**
*   **[https://medium . com/analytics-vid hya/vision-transformers-bye-bye-convolutions-e 929d 022 E4 ab](https://medium.com/analytics-vidhya/vision-transformers-bye-bye-convolutions-e929d022e4ab)**
*   **[https://medium . com/synced review/Google-brain-uncovers-re presentation-structure-differences-between-CNN-and-vision-transformers-83b 6835 db BAC](https://medium.com/syncedreview/google-brain-uncovers-representation-structure-differences-between-cnns-and-vision-transformers-83b6835dbbac)**

****æŠ±ç´§è„¸****

*   **[https://hugging face . co/docs/transformers/main _ classes/pipelines](https://huggingface.co/docs/transformers/main_classes/pipelines)**
*   **[https://huggingface.co/blog/fine-tune-vit](https://huggingface.co/blog/fine-tune-vit)**
*   **[https://huggingface.co/blog/vision-transformers](https://huggingface.co/blog/vision-transformers)**
*   **[https://huggingface.co/blog/tf-serving-vision](https://huggingface.co/blog/tf-serving-vision)**
*   **[https://huggingface.co/blog/deploy-tfserving-kubernetes](https://huggingface.co/blog/deploy-tfserving-kubernetes)**
*   **[https://huggingface.co/google/vit-base-patch16-224](https://huggingface.co/google/vit-base-patch16-224)**
*   **[https://huggingface.co/blog/deploy-vertex-ai](https://huggingface.co/blog/deploy-vertex-ai)**
*   **[https://huggingface.co/models?other=vit](https://huggingface.co/models?other=vit)**

****æ•°æ®å—****

*   **[https://www . data bricks . com/spark/getting-started-with-Apache-spark](https://www.databricks.com/spark/getting-started-with-apache-spark)**
*   **[https://docs.databricks.com/getting-started/index.html](https://docs.databricks.com/getting-started/index.html)**
*   **[https://docs . data bricks . com/getting-started/quick-start . html](https://docs.databricks.com/getting-started/quick-start.html)**
*   **çœ‹å°½[æ•°æ®+AI å³°ä¼š 2022](https://www.databricks.com/dataaisummit/)**
*   **[https://www . data bricks . com/blog/2020/05/15/shrink-training-time-and-cost-using-NVIDIA-GPU-accelerated-xgboost-and-Apache-spark-on-data bricks . html](https://www.databricks.com/blog/2020/05/15/shrink-training-time-and-cost-using-nvidia-gpu-accelerated-xgboost-and-apache-spark-on-databricks.html)**

****Spark NLP****

*   **[Spark NLP GitHub](https://github.com/JohnSnowLabs/spark-nlp)**
*   **[Spark NLP ç ”è®¨ä¼š](https://github.com/JohnSnowLabs/spark-nlp-workshop) (Spark NLP ç¤ºä¾‹)**
*   **[ç«èŠ± NLP å˜å‹å™¨](https://nlp.johnsnowlabs.com/docs/en/transformers)**
*   **[Spark NLP è½¦å‹è½®æ¯‚](https://nlp.johnsnowlabs.com/models?edition=Spark+NLP)**
*   **[Spark NLP 3 ä¸­çš„é€Ÿåº¦ä¼˜åŒ–&åŸºå‡†æµ‹è¯•:å……åˆ†åˆ©ç”¨ç°ä»£ç¡¬ä»¶](https://www.johnsnowlabs.com/watch-webinar-speed-optimization-benchmarks-in-spark-nlp-3-making-the-most-of-modern-hardware/)**
*   **[Spark NLP ä¸­çš„ç¡¬ä»¶åŠ é€Ÿ](https://nlp.johnsnowlabs.com/docs/en/hardware_acceleration)**
*   **[é€šè¿‡ API æœåŠ¡ Spark NLP:Spring å’Œ LightPipelines](https://medium.com/spark-nlp/serving-spark-nlp-via-api-spring-and-lightpipelines-64d2e6413327)**
*   **[é€šè¿‡ API æœåŠ¡ Spark NLP(1/3):å¾®è½¯çš„ Synapse ML](https://medium.com/spark-nlp/serving-spark-nlp-via-api-1-3-microsoft-synapse-ml-2c77a3f61f9d)**
*   **[é€šè¿‡ API æœåŠ¡ Spark NLP(2/3):FastAPI å’Œ LightPipelines](https://medium.com/spark-nlp/serving-spark-nlp-via-api-2-3-fastapi-and-lightpipelines-218d1980c9fc)**
*   **[é€šè¿‡ API (3/3)æœåŠ¡ Spark NLP:æ•°æ®å—ä½œä¸šå’Œ MLFlow æœåŠ¡ API](https://medium.com/spark-nlp/serving-spark-nlp-via-api-3-3-databricks-and-mlflow-serve-apis-4ef113e7fac4)**
*   **[åˆ©ç”¨ Scala ä¸­çš„æ·±åº¦å­¦ä¹ å’Œ Spark 3.0 ä¸Šçš„ GPU](https://aws.amazon.com/blogs/opensource/leverage-deep-learning-in-scala-with-gpu-on-spark-3-0/)**
*   **[å¼€å§‹ä½¿ç”¨ GPU åŠ é€Ÿçš„ Apache Spark 3](https://www.nvidia.com/en-us/ai-data-science/spark-ebook/getting-started-spark-3/)**
*   **[é˜¿å¸•å¥‡ Spark æ€§èƒ½è°ƒä¼˜](https://spark.apache.org/docs/latest/sql-performance-tuning.html)**
*   **GPU ä¸Šå¯èƒ½çš„é¢å¤–ä¼˜åŒ–:[Apache Spark é…ç½®çš„ RAPIDS åŠ é€Ÿå™¨](https://nvidia.github.io/spark-rapids/docs/configs.html)****