<html>
<head>
<title>Deploying a Telegram bot developed with Telegraf.js to Netlify</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将使用 Telegraf.js 开发的电报机器人部署到 Netlify</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/deploying-a-telegram-bot-developed-with-telegraf-js-aef341ec0d4f?source=collection_archive---------5-----------------------#2022-08-29">https://blog.devgenius.io/deploying-a-telegram-bot-developed-with-telegraf-js-aef341ec0d4f?source=collection_archive---------5-----------------------#2022-08-29</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/8befd520952ff4746a6cc3b48e601841.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*INfjPtQvb9etMGLVuS0YMw.jpeg"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">谁知道这段代码做什么，我只是需要一个漂亮的图像。对<a class="ae jz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>的信贷</figcaption></figure><p id="4247" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在花了相当糟糕的一天时间尝试(并且失败)遵循一个两年前的关于如何将 Telegraf.js 制作的电报机器人部署到 Netlify 的教程后，我决定写一个更新的。</p><blockquote class="ky"><p id="a680" class="kz la in bd lb lc ld le lf lg lh kx dk translated">本教程将重点介绍在 Netlify 上正确部署电报机器人所需的配置，<strong class="ak">掩盖了机器人的逻辑和一些基本步骤和概念</strong>(请求电报机器人令牌，使用 Git/Github，…)。</p></blockquote><p id="fff2" class="pw-post-body-paragraph ka kb in kc b kd li kf kg kh lj kj kk kl lk kn ko kp ll kr ks kt lm kv kw kx ig bi translated">让我们从基础开始。本教程需要的主要内容是:</p><ul class=""><li id="a92d" class="ln lo in kc b kd ke kh ki kl lp kp lq kt lr kx ls lt lu lv bi translated"><a class="ae jz" href="https://nodejs.org/" rel="noopener ugc nofollow" target="_blank"> Node.js </a>已安装</li><li id="f80b" class="ln lo in kc b kd lw kh lx kl ly kp lz kt ma kx ls lt lu lv bi translated">一个净值账户</li><li id="8111" class="ln lo in kc b kd lw kh lx kl ly kp lz kt ma kx ls lt lu lv bi translated">一个<a class="ae jz" href="https://github.com/" rel="noopener ugc nofollow" target="_blank"> Github </a>账户(或任何其他版本控制系统)</li><li id="a7e5" class="ln lo in kc b kd lw kh lx kl ly kp lz kt ma kx ls lt lu lv bi translated">一个<a class="ae jz" href="https://telegram.org/" rel="noopener ugc nofollow" target="_blank">电报</a>账户和一个电报机器人令牌(如果你不知道如何获得一个机器人令牌，请在进一步阅读之前按照此处描述的步骤<a class="ae jz" href="https://core.telegram.org/bots#3-how-do-i-create-a-bot" rel="noopener ugc nofollow" target="_blank"/></li></ul></div><div class="ab cl mb mc hr md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ig ih ii ij ik"><h1 id="c440" class="mi mj in bd mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf bi translated">开源代码库</h1><h2 id="a3ec" class="ng mj in bd mk nh ni dn mo nj nk dp ms kl nl nm mw kp nn no na kt np nq ne nr bi translated">存储库设置</h2><p id="b1a7" class="pw-post-body-paragraph ka kb in kc b kd ns kf kg kh nt kj kk kl nu kn ko kp nv kr ks kt nw kv kw kx ig bi translated">首先在 Github 上创建一个<a class="ae jz" href="https://docs.github.com/en/get-started/quickstart/create-a-repo" rel="noopener ugc nofollow" target="_blank">新的存储库，然后通过终端在您的机器上克隆它。</a></p><pre class="nx ny nz oa gt ob oc od oe aw of bi"><span id="6172" class="ng mj in oc b gy og oh l oi oj">git clone https://github.com/<em class="ok">&lt;your_username&gt;</em>/<em class="ok">&lt;repository_name&gt;</em></span></pre></div><div class="ab cl mb mc hr md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ig ih ii ij ik"><h1 id="743d" class="mi mj in bd mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf bi translated">密码</h1><h2 id="e368" class="ng mj in bd mk nh ni dn mo nj nk dp ms kl nl nm mw kp nn no na kt np nq ne nr bi translated">package.json</h2><p id="556e" class="pw-post-body-paragraph ka kb in kc b kd ns kf kg kh nt kj kk kl nu kn ko kp nv kr ks kt nw kv kw kx ig bi translated">通过终端导航到新克隆的目录后，键入以下内容:</p><pre class="nx ny nz oa gt ob oc od oe aw of bi"><span id="a841" class="ng mj in oc b gy og oh l oi oj">npm init -y</span></pre><p id="dc49" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这将创建一个新的<em class="ok"> package.json </em>，其中已经填充了默认的键，只需确保键<em class="ok">“name”</em>有一个您喜欢的名称(默认将与文件夹的名称相同)。</p><p id="94b1" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">此外，运行以下命令:</p><pre class="nx ny nz oa gt ob oc od oe aw of bi"><span id="94bf" class="ng mj in oc b gy og oh l oi oj">npm install telegraf<br/>npm install netlify-lambda</span></pre><p id="ed43" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><a class="ae jz" href="https://telegraf.js.org/" rel="noopener ugc nofollow" target="_blank"> Telegraf.js </a>(在撰写本文时，最新版本是 4.9.0)是一个<em class="ok">“Telegram Bot API framework for node . js”</em>，它通过代码简化了(很多)Telegram 的 API 的使用。我尝试过不使用框架走“纯”路线，但是花时间去理解 Telegram APIs 文档是不值得的。</p><p id="3615" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Netlify-lambda 是一个“帮助在本地和 CI 环境中构建和服务 lambda 功能”的工具。</p><h2 id="625b" class="ng mj in bd mk nh ni dn mo nj nk dp ms kl nl nm mw kp nn no na kt np nq ne nr bi translated">netlify.toml</h2><p id="0766" class="pw-post-body-paragraph ka kb in kc b kd ns kf kg kh nt kj kk kl nu kn ko kp nv kr ks kt nw kv kw kx ig bi translated">在与<em class="ok"> package.json </em>相同的目录下，也创建一个名为<em class="ok"> netlify.toml </em>的文件，内容如下(编辑 09/10/2022: <a class="ol om ep" href="https://medium.com/u/962f9e337686?source=post_page-----aef341ec0d4f--------------------------------" rel="noopener" target="_blank"> Anais Reyes </a>正确指出了前面的一个错误。toml 文件，现已修复):</p><pre class="nx ny nz oa gt ob oc od oe aw of bi"><span id="c46d" class="ng mj in oc b gy og oh l oi oj">[build]<br/>  functions = "functions"<br/>  command = "netlify-lambda install &amp;&amp; mkdir ./public"<br/>[[redirects]]<br/>  from = "/api/*"<br/>  to = "/.netlify/functions/:splat"<br/>  status = 200</span></pre><p id="42c0" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Netlify 在构建和部署过程中使用该配置文件。更多信息可在<a class="ae jz" href="https://docs.netlify.com/configure-builds/file-based-configuration/" rel="noopener ugc nofollow" target="_blank"> Netlify 文档</a>中找到。</p><h2 id="7881" class="ng mj in bd mk nh ni dn mo nj nk dp ms kl nl nm mw kp nn no na kt np nq ne nr bi translated">子文件夹</h2><p id="ddef" class="pw-post-body-paragraph ka kb in kc b kd ns kf kg kh nt kj kk kl nu kn ko kp nv kr ks kt nw kv kw kx ig bi translated">我们现在需要创建这些子文件夹:</p><ul class=""><li id="f9db" class="ln lo in kc b kd ke kh ki kl lp kp lq kt lr kx ls lt lu lv bi translated"><strong class="kc io">功能</strong></li><li id="4700" class="ln lo in kc b kd lw kh lx kl ly kp lz kt ma kx ls lt lu lv bi translated"><em class="ok">功能</em> <strong class="kc io"> /bot </strong>(注意:这个子文件夹需要在第一个里面<strong class="kc io">)。</strong></li></ul><h2 id="53f6" class="ng mj in bd mk nh ni dn mo nj nk dp ms kl nl nm mw kp nn no na kt np nq ne nr bi translated">bot.js</h2><p id="d977" class="pw-post-body-paragraph ka kb in kc b kd ns kf kg kh nt kj kk kl nu kn ko kp nv kr ks kt nw kv kw kx ig bi translated">现在让我们编写一个基本的机器人，当它在聊天中收到“/start”命令时，用“Hi”来响应。</p><p id="650c" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们需要在<em class="ok"> functions/bot </em>子文件夹中创建一个名为<em class="ok"> bot.js </em>的文件。</p><figure class="nx ny nz oa gt jo"><div class="bz fp l di"><div class="on oo l"/></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">bot.js 源代码</figcaption></figure><blockquote class="ky"><p id="5c8b" class="kz la in bd lb lc op oq or os ot kx dk translated">请注意<strong class="ak"> exports.handler </strong>的语法(称为 AWS 事件处理程序语法)，这不仅是使这个机器人与 Netlify 函数一起工作的必要条件，也是所有教程都忘记提到的部分。</p></blockquote><h2 id="ace8" class="ng mj in bd mk nh ou dn mo nj ov dp ms kl ow nm mw kp ox no na kt oy nq ne nr bi translated">。gitignore</h2><p id="393d" class="pw-post-body-paragraph ka kb in kc b kd ns kf kg kh nt kj kk kl nu kn ko kp nv kr ks kt nw kv kw kx ig bi translated">创建<a class="ae jz" href="https://git-scm.com/docs/gitignore" rel="noopener ugc nofollow" target="_blank">。git 忽略项目根目录中的</a>文件，只需键入:</p><pre class="nx ny nz oa gt ob oc od oe aw of bi"><span id="983d" class="ng mj in oc b gy og oh l oi oj">node_modules</span></pre><h2 id="b301" class="ng mj in bd mk nh ni dn mo nj nk dp ms kl nl nm mw kp nn no na kt np nq ne nr bi translated">最终文件夹结构</h2><p id="e67f" class="pw-post-body-paragraph ka kb in kc b kd ns kf kg kh nt kj kk kl nu kn ko kp nv kr ks kt nw kv kw kx ig bi translated">运行<em class="ok"> npm install </em>命令后，您应该有以下文件夹结构:</p><pre class="nx ny nz oa gt ob oc od oe aw of bi"><span id="f8bf" class="ng mj in oc b gy og oh l oi oj">.<br/>├── .git/ (automatically created when cloning the repository)<br/>├── functions/<br/>│   └── bot/<br/>│       └── bot.js<br/>├── node_modules/<br/>│   └── &lt;dependencies files&gt;<br/>├── .gitignore<br/>├── netlify.toml<br/>├── package.json<br/>└── package-lock.json (auto-generated after running npm install)</span></pre><p id="972b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">很好！既然我们已经完成了“编码”,我们就<strong class="kc io">提交并把所有东西</strong>推送到存储库中。</p></div><div class="ab cl mb mc hr md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ig ih ii ij ik"><h1 id="e851" class="mi mj in bd mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf bi translated">网络生活</h1><h2 id="7a98" class="ng mj in bd mk nh ni dn mo nj nk dp ms kl nl nm mw kp nn no na kt np nq ne nr bi translated">站点部署</h2><p id="139c" class="pw-post-body-paragraph ka kb in kc b kd ns kf kg kh nt kj kk kl nu kn ko kp nv kr ks kt nw kv kw kx ig bi translated">将我们的代码推送到 Github 后，我们登录 Netlify。这里我们需要:</p><ul class=""><li id="4306" class="ln lo in kc b kd ke kh ki kl lp kp lq kt lr kx ls lt lu lv bi translated">创建新站点(通过选择<strong class="kc io">导入现有项目</strong>)</li><li id="9e71" class="ln lo in kc b kd lw kh lx kl ly kp lz kt ma kx ls lt lu lv bi translated">选择 Github(或您的版本控制系统提供商)</li><li id="4641" class="ln lo in kc b kd lw kh lx kl ly kp lz kt ma kx ls lt lu lv bi translated">选择我们推送 bot 代码的存储库。</li><li id="873c" class="ln lo in kc b kd lw kh lx kl ly kp lz kt ma kx ls lt lu lv bi translated">检查默认设置(在我的例子中，我必须从<strong class="kc io"> /dist，</strong>中更改“发布目录”的默认值，将该字段留空。</li></ul><figure class="nx ny nz oa gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi oz"><img src="../Images/8cf9545bedcda87d2192bd901dca19cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iw4RcTfkHt0kPQO0bRH1Xg.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">基本网站设置。</figcaption></figure><ul class=""><li id="98dd" class="ln lo in kc b kd ke kh ki kl lp kp lq kt lr kx ls lt lu lv bi translated">我们需要存储 BotFather 提供的电报 bot 令牌。为此，点击<strong class="kc io">显示高级</strong>，然后点击<strong class="kc io">新变量。<br/> </strong>变量<em class="ok"> </em>的<em class="ok">键</em>应该是<strong class="kc io"> BOT_TOKEN </strong>并且 BotFather 提供的 BOT 的 TOKEN 必须粘贴在 Value 字段。</li></ul><figure class="nx ny nz oa gt jo gh gi paragraph-image"><div class="gh gi pa"><img src="../Images/23c8433a3adca79ce52ed9c76e491aa4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1348/format:webp/1*u33vOUGBh-elU3MfISFOQw.png"/></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">环境变量设置。</figcaption></figure><ul class=""><li id="3df9" class="ln lo in kc b kd ke kh ki kl lp kp lq kt lr kx ls lt lu lv bi translated">点击<strong class="kc io">部署站点</strong>。如果需要，您可以自定义<strong class="kc io">站点名称</strong>(站点设置&gt;域管理&gt;选项&gt;编辑站点名称)</li></ul><figure class="nx ny nz oa gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi pb"><img src="../Images/31c9031a92301b61723983c394a020bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GsvXaocQTl3jnuAB5IJTMg.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">网站名称定制页面</figcaption></figure><h2 id="459b" class="ng mj in bd mk nh ni dn mo nj nk dp ms kl nl nm mw kp nn no na kt np nq ne nr bi translated">Webhook</h2><p id="edff" class="pw-post-body-paragraph ka kb in kc b kd ns kf kg kh nt kj kk kl nu kn ko kp nv kr ks kt nw kv kw kx ig bi translated">我们现在必须告诉 Telegram 将用户发送给机器人的所有消息转发到哪里。为此，我们需要设置 webhook。</p><p id="2be9" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">复制下面的 URL，替换<strong class="kc io"> &lt; your_bot_token &gt; </strong>和<strong class="kc io"> &lt; your_site_name &gt; </strong>，然后将结果粘贴到你的浏览器地址栏并导航。</p><pre class="nx ny nz oa gt ob oc od oe aw of bi"><span id="2eef" class="ng mj in oc b gy og oh l oi oj">https://api.telegram.org/bot<strong class="oc io">&lt;your_bot_token&gt;</strong>/setWebhook?url=https://<strong class="oc io">&lt;your_site_name&gt;</strong>.netlify.app/api/bot</span></pre><p id="2954" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">例如，我的 URL 应该是(别担心，bot 令牌现在无效):</p><pre class="nx ny nz oa gt ob oc od oe aw of bi"><span id="9217" class="ng mj in oc b gy og oh l oi oj">https://api.telegram.org/bot5594307469:AAEx9aeF6KeOMaQeAGJ79xa-tAB5RkWOdlg/setWebhook?url=https://venerable-alfajores-c6f46a.netlify.app/api/bot</span></pre><p id="3bca" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如果 webhook 设置正确，您应该会看到以下结果:</p><pre class="nx ny nz oa gt ob oc od oe aw of bi"><span id="5e95" class="ng mj in oc b gy og oh l oi oj">{"ok":true,"result":true,"description":"Webhook was set"}</span></pre></div><div class="ab cl mb mc hr md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ig ih ii ij ik"><h1 id="cbdf" class="mi mj in bd mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf bi translated">测试</h1><p id="23b0" class="pw-post-body-paragraph ka kb in kc b kd ns kf kg kh nt kj kk kl nu kn ko kp nv kr ks kt nw kv kw kx ig bi translated">如果你做的一切都正确，机器人现在会在收到<em class="ok">/开始</em>命令时回复“嗨”。</p><figure class="nx ny nz oa gt jo gh gi paragraph-image"><div class="gh gi pc"><img src="../Images/cf0d5b7a4755e3623da53b3bfb0725eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:756/format:webp/1*Z3G9a2CLZigZNGropVeqlQ.png"/></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">机器人开始工作了！</figcaption></figure><p id="52da" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">🥳祝贺你，你已经成功部署了你的机器人！🎉</p><h2 id="1fc7" class="ng mj in bd mk nh ni dn mo nj nk dp ms kl nl nm mw kp nn no na kt np nq ne nr bi translated">解决纷争</h2><ul class=""><li id="7a85" class="ln lo in kc b kd ns kh nt kl pd kp pe kt pf kx ls lt lu lv bi translated">检查 Netlify 部署是否成功(您应该会看到下面的<strong class="kc io"> Published </strong>徽章)。如果您看到<strong class="kc io">失败的</strong>徽章，您可以点击它并检查部署日志。</li></ul><figure class="nx ny nz oa gt jo gh gi paragraph-image"><div class="gh gi pg"><img src="../Images/aec0308e1fac4030f050ea77e20e5f0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:614/format:webp/1*BqL4hr2735PYnXA2Rrt-dg.png"/></div></figure><ul class=""><li id="3893" class="ln lo in kc b kd ke kh ki kl lp kp lq kt lr kx ls lt lu lv bi translated">在 Netlify 上更新任何环境变量的值后，必须触发新的部署，以便在生产中更新它。您可以从 Netlify 手动完成此操作，或者通过将新的提交推送到存储库中的主分支来完成。这将触发新的部署。</li><li id="0644" class="ln lo in kc b kd lw kh lx kl ly kp lz kt ma kx ls lt lu lv bi translated">你可以通过进入你的网站的功能部分并点击<strong class="kc io"> bot </strong>来检查你的 bot 日志。</li></ul><figure class="nx ny nz oa gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi gj"><img src="../Images/6d4272edfc68c824c1f7ecb9ba2d9f37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y2fllCSO31KilSh00x5CAQ.png"/></div></div></figure></div><div class="ab cl mb mc hr md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ig ih ii ij ik"><p id="16e5" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">社会联系</p><p id="0d45" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><a class="ae jz" href="https://www.linkedin.com/in/paolo-zanchi/" rel="noopener ugc nofollow" target="_blank">领英</a></p><p id="1a72" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><a class="ae jz" href="https://github.com/paolozanchi" rel="noopener ugc nofollow" target="_blank"> Github </a></p><p id="800b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><a class="ae jz" href="https://www.instagram.com/paozanchi/" rel="noopener ugc nofollow" target="_blank"> Instagram </a></p></div></div>    
</body>
</html>