<html>
<head>
<title>JSON To Apache Parquet Convertor Service in Golang</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Golang 的 JSON 到 Apache Parquet 转换器服务</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/json-to-apache-parquet-convertor-service-in-golang-7eedb91ca8f8?source=collection_archive---------5-----------------------#2022-09-14">https://blog.devgenius.io/json-to-apache-parquet-convertor-service-in-golang-7eedb91ca8f8?source=collection_archive---------5-----------------------#2022-09-14</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="1999" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">使用亚马逊 S3 和亚马逊 SQS 服务</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/93417f23a1ac3d4216fb21712f993a09.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dBlxX5141rZS7J1GUn-1yw.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">Golang 使用亚马逊 S3 和亚马逊 SQS 的拼花转换器服务</figcaption></figure><p id="eecb" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在我们进入实现细节之前，让我们简要地看一下使用 Apache Parquet 格式的优点。</p><blockquote class="ky kz la"><p id="3ead" class="jk jl lb jm b jn jo jp jq jr js jt ju lc jw jx jy ld ka kb kc le ke kf kg kh ig bi translated">Apache Parquet 是一种开源的、面向列的数据文件格式，旨在实现高效的数据存储和检索。它提供了高效的数据压缩和编码方案，增强了批量处理复杂数据的性能。Parquet 有多种语言版本，包括 Java、C++、Python 等…</p></blockquote><ol class=""><li id="3887" class="lg lh in jm b jn jo jr js jv li jz lj kd lk kh ll lm ln lo bi translated">这是一种基于列的格式，使用数据压缩技术节省存储空间。</li><li id="b655" class="lg lh in jm b jn lp jr lq jv lr jz ls kd lt kh ll lm ln lo bi translated">具有高读取性能和吞吐量。</li></ol></div><div class="ab cl lu lv hr lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="ig ih ii ij ik"><p id="8981" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">对于这个<em class="lb">转换器服务，</em>我们使用的是<a class="ae lf" href="https://github.com/xitongsys" rel="noopener ugc nofollow" target="_blank">xitongsys</a>/<a class="ae lf" href="https://github.com/xitongsys/parquet-go" rel="noopener ugc nofollow" target="_blank">parquet-go</a>，一个支持读写 parquet 文件的 golang 库。</p><p id="5d99" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><em class="lb">注:</em> <a class="ae lf" href="https://github.com/gajendarp05/go_json_parquet_convertor" rel="noopener ugc nofollow" target="_blank"> <em class="lb">转换器服务</em> </a>的 Github 库链接</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mb"><img src="../Images/e1845aa7534390f3b58cdee55fb99578.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SLEgvb5kF6wYfsjGE-lfVA.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">JSON 到 Parquet 文件转换器服务工作流</figcaption></figure><p id="c3b9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">工作流程分为 3 个主要部分</p><ol class=""><li id="a7b9" class="lg lh in jm b jn jo jr js jv li jz lj kd lk kh ll lm ln lo bi translated"><a class="ae lf" href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/ways-to-add-notification-config-to-bucket.html" rel="noopener ugc nofollow" target="_blank"> <strong class="jm io">配置器</strong> </a> <strong class="jm io"> e 亚马逊 S3 通知亚马逊 SQS 队列新文件创建/上传</strong></li></ol><p id="54c3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">创建一个新的 S3 桶，并添加一个<em class="lb">事件通知</em>，以便在新文件上传/添加到 S3 桶时发出通知，并添加一个 SQS 队列作为目的地。</p><p id="1bf3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><em class="lb">注:授予亚马逊 S3</em><a class="ae lf" href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/grant-destinations-permissions-to-s3.html" rel="noopener ugc nofollow" target="_blank"><em class="lb">权限</em> </a> <em class="lb">发布消息到 SQS 队列。</em></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mc"><img src="../Images/56e73fe5cf0f89a9df3dad2b2d0447da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*24x2LbftuvqoHT5Qmici7Q.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">亚马逊 S3 铲斗<strong class="bd md">转换器-测试</strong></figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi me"><img src="../Images/8f0a96a1879b3a35553558c0b8c0def1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i3MvPNlCJlnzrXYCyoKSJg.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">所有对象的事件通知创建到目的地 SQS 队列<strong class="bd md">测试</strong></figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mf"><img src="../Images/86d416b09697accbd1a9243bf8958352.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pElAjzde5D3u2r0C3XUcgA.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">将新的 JSON 文件添加到 S3 桶，并在 SQS 队列中轮询新消息</figcaption></figure></div><div class="ab cl lu lv hr lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="ig ih ii ij ik"><p id="9a92" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">2.<strong class="jm io">轮询器持续轮询 SQS 队列上的新消息</strong></p><p id="4385" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">轮询器 goroutines 不断轮询以从配置的 SQS 队列中检索新消息。为了检索消息，我们使用 SQS <a class="ae lf" href="https://docs.aws.amazon.com/AWSSimpleQueueService/latest/APIReference/API_ReceiveMessage.html" rel="noopener ugc nofollow" target="_blank">接收消息</a> API。每个 SQS 消息都被写入工作通道进行进一步的处理(我们将在下一节讨论)。</p><p id="da86" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们需要配置的一些参数是</p><p id="08a6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><em class="lb"> MaxNumberOfMessages </em>:一次请求返回的最大消息数(最大值可以是 10)</p><p id="98a3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><em class="lb"> WaitTimeSeconds </em>:返回前等待消息的时长。(<a class="ae lf" href="https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-short-and-long-polling.html" rel="noopener ugc nofollow" target="_blank">长轮询 vs 短轮询</a>)。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mg mh l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">轮询器检索 SQS 消息</figcaption></figure></div><div class="ab cl lu lv hr lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="ig ih ii ij ik"><p id="adce" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">3.<strong class="jm io">工人将 JSON 转换为拼花格式</strong></p><p id="1c90" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">一旦轮询器在信道上写下 SQS 消息，其中一个可用的工作器就拾取该消息进行处理。处理步骤包括</p><p id="281a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> a. </strong>解析 SQS 报文，提取 S3 JSON 文件的路径。<em class="lb">【第 5–16 行】</em></p><p id="28ae" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> b. </strong>使用 S3 <a class="ae lf" href="https://docs.aws.amazon.com/sdk-for-go/api/service/s3/s3manager/#Downloader.Download" rel="noopener ugc nofollow" target="_blank">下载器</a>下载 JSON 文件。<em class="lb">【第 17–28 行】</em></p><p id="a025" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> c. </strong>将 JSON 文件转换成 parquet 文件，并将 Parquet 文件上传回 S3。<a class="ae lf" href="https://github.com/xitongsys" rel="noopener ugc nofollow" target="_blank">xitongsys</a>/<a class="ae lf" href="https://github.com/xitongsys/parquet-go" rel="noopener ugc nofollow" target="_blank">parquet-go</a>库支持将拼花文件直接写入已配置的 S3 桶。<em class="lb">【第 30–49 行】</em></p><p id="7055" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> d. </strong>转换成功后删除 SQS 消息。<em class="lb">【第 52–59 行】</em></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mg mh l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">SQS 消息处理工人</figcaption></figure><p id="f42a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><em class="lb">注意:在运行服务之前设置所有的环境变量。</em></p><p id="1afa" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在上传一个新的 JSON 文件到 S3 桶时，<strong class="jm io">轮询器</strong>将获得新的 SQS 消息并将其发送到<strong class="jm io">工作器</strong>进行处理。工人将把 JSON 转换成 Parquet，把文件上传到同一个 S3 桶，并删除 SQS 消息。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mi"><img src="../Images/6419d93887249bc192a60a89ff840510.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RIJZ3qmrORYzgOr9UtjmIQ.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">新 JSON 文件上传/创建</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mj"><img src="../Images/b28d04458e99a837459bdbb6674ac46d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M4hCgZoHplBsa2lSetX_DA.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">JSON 到拼花转换</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mk"><img src="../Images/8fcaa832b737294aa2bbaa556cf31032.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vobKHjF4GyWhrGu689J_Lw.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">拼花文件存放在同一个 S3 桶中</figcaption></figure><p id="9d0d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这一个就到此为止。我希望这是有用的，感谢你的时间。:-)</p></div></div>    
</body>
</html>