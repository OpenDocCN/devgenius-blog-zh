<html>
<head>
<title>Node.js Best Practices — Malicious Commands</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Node.js最佳实践—恶意命令</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/node-js-best-practices-malicious-commands-74eb63b98884?source=collection_archive---------4-----------------------#2020-08-23">https://blog.devgenius.io/node-js-best-practices-malicious-commands-74eb63b98884?source=collection_archive---------4-----------------------#2020-08-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/6b20543eea43caf0b6981c88b1872624.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*TVLIU55DxXnnuX6g"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">扎卡里·斯皮尔斯在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="28f1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">像任何类型的应用程序一样，JavaScript应用程序也必须写得很好。</p><p id="9a1d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">否则，我们以后会遇到各种各样的问题。</p><p id="96a1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将看看在编写节点应用程序时应该遵循的一些最佳实践。</p><h1 id="e92b" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">设置Cookies</h1><p id="ab0b" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以用Express设置cookies。</p><p id="20d8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以使用cookie会话来发送cookie。</p><p id="ad6c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="26cd" class="mn lc iq mj b gy mo mp l mq mr">const cookieSession = require('cookie-session');<br/>const express = require('express');<br/> <br/>const app = express();<br/> <br/>app.use(cookieSession({<br/>  name: 'session',<br/>  keys: [<br/>    process.env.COOKIE_KEY1,<br/>    process.env.COOKIE_KEY2<br/>  ]<br/>}));<br/> <br/>app.use((req, res, next) =&gt; {<br/>  const n = req.session.views || 0;<br/>  req.session.views = n++;<br/>  res.end(n);<br/>});<br/> <br/>app.listen(3000);</span></pre><p id="b216" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们使用cookie会话包来设置cookie。</p><h1 id="2fdc" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">CSRF</h1><p id="1d83" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">跨站点请求伪造是一种攻击，其中用户在他们登录的应用程序中执行不想要的操作。</p><p id="69e2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这些攻击的目标是状态改变请求，因为它们看不到伪造请求的响应。</p><p id="25e7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了保护我们免受CSRF的攻击，我们可以使用<code class="fe ms mt mu mj b">csrf</code>模块。</p><p id="99a0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">而在Express中，我们可以使用<code class="fe ms mt mu mj b">csurf</code>模块。</p><p id="32b8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="4b93" class="mn lc iq mj b gy mo mp l mq mr">const cookieParser = require('cookie-parser');<br/>const csrf = require('csurf');<br/>const bodyParser = require('body-parser');<br/>const express = require('express');<br/> <br/>const csrfProtection = csrf({ cookie: true });<br/>const parseForm = bodyParser.urlencoded({ extended: false });<br/> <br/>const app = express();<br/> <br/>app.use(cookieParser());<br/> <br/>app.get('/form', csrfProtection, (req, res) =&gt; {<br/>  res.render('send', { csrfToken: req.csrfToken() });<br/>});<br/> <br/>app.post('/process', parseForm, csrfProtection, (req, res) =&gt; {<br/>  res.send('submitted');<br/>});</span></pre><p id="8ae9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们可以在模板中添加表单:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="50dc" class="mn lc iq mj b gy mo mp l mq mr">&lt;form action="/process" method="POST"&gt;<br/>  &lt;input type="hidden" name="_csrf" value="{{csrfToken}}"&gt;<br/>  <br/>  Name: &lt;input type="text" name="name"&gt;<br/>  &lt;button type="submit"&gt;Submit&lt;/button&gt;<br/>&lt;/form&gt;</span></pre><p id="97c3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们在表单中添加了一个带有<code class="fe ms mt mu mj b">csrfToken</code>的隐藏输入，这样我们只能在出现CSRF令牌时提交表单。</p><h1 id="b802" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">数据有效性</h1><p id="1cd8" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们应该验证我们的数据，以防止跨站点脚本。</p><p id="df20" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当攻击者将恶意代码转化为带有特制链接的HTML时，就会出现跨站点脚本。</p><p id="9572" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当应用程序存储未正确过滤的用户输入时，会出现存储的跨站点脚本。</p><p id="02f7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它在应用程序中运行。</p><p id="9d4e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了防止这种类型的攻击，我们应该总是过滤和杀毒用户输入。</p><h1 id="8225" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">SQL注入</h1><p id="8f8d" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">另一种要防范的攻击是SQL注入。</p><p id="f164" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们在代码中动态运行SQL语句，这样我们就可以读取数据并进行恶意操作。</p><p id="2ed1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了防止这些攻击，我们应该使用参数化查询或预处理语句。</p><p id="a6ac" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">像node-postgres模块这样的一些模块将允许我们创建如下的参数化查询:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="343b" class="mn lc iq mj b gy mo mp l mq mr">const q = 'SELECT name FROM books WHERE id = $1';<br/>client.query(q, ['1'], (err, result) =&gt; {});</span></pre><p id="0ca7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae kc" href="http://sqlmap.org/" rel="noopener ugc nofollow" target="_blank"> sqlmap </a>让我们在应用程序中自动检测和探索SQL注入缺陷。</p><p id="9dd5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以用它来测试SQL注入漏洞。</p><h1 id="817c" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">命令注入</h1><p id="38d4" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">另一个可能出现的安全缺陷是命令注入。</p><p id="b1eb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以将命令放在查询字符串中来运行shell命令。</p><p id="f4f8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了防止这些攻击者，我们应该始终净化用户输入。</p><p id="ee13" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以编写这样的代码:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="58ae" class="mn lc iq mj b gy mo mp l mq mr">https://example.com/downloads?file=%3Bcat%20/etc/passwd</span></pre><p id="506f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">另外，<code class="fe ms mt mu mj b">child_process.exec</code>运行<code class="fe ms mt mu mj b">/bin/sh</code>，所以它是bash解释器而不是程序启动器。</p><p id="bb90" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">攻击者可以用反勾号或<code class="fe ms mt mu mj b">$()</code>注入新命令。</p><p id="a036" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以用<code class="fe ms mt mu mj b">child_process.execFile</code>克服这一点。</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mv"><img src="../Images/66197999ac51ad3ff988732d78ed12a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*098i2AmTwm_6J-xl"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">由<a class="ae kc" href="https://unsplash.com/@roi_dimor?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Roi Dimor </a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><h1 id="d453" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="c38e" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以设置cookies并运行各种安全命令。</p><p id="4c27" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，我们需要防止恶意输入。</p></div></div>    
</body>
</html>