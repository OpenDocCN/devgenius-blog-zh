<html>
<head>
<title>Build a Custom Ansible Execution Environment — ansible-builder command-line tool</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">构建定制的 Ansible 执行环境— ansible-builder 命令行工具</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/build-an-ansible-execution-environment-ansible-builder-command-line-tool-b05e35f402e8?source=collection_archive---------1-----------------------#2022-08-28">https://blog.devgenius.io/build-an-ansible-execution-environment-ansible-builder-command-line-tool-b05e35f402e8?source=collection_archive---------1-----------------------#2022-08-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="e7ec" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">如何使用 ansible-builder 命令行工具来构建自定义“my _ ee”ansi ble 执行环境，指定一些自定义系统(git)、Python (boto)和集合(community.aws)依赖项。</h2></div><figure class="kf kg kh ki gt kj"><div class="bz fp l di"><div class="kk kl l"/></div></figure><h1 id="e2cc" class="km kn iq bd ko kp kq kr ks kt ku kv kw jw kx jx ky jz kz ka la kc lb kd lc ld bi translated">如何构建自定义的 Ansible 执行环境？</h1><p id="136e" class="pw-post-body-paragraph le lf iq lg b lh li jr lj lk ll ju lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">使用 Ansible 执行环境是维护 Ansible 集合的最新 Python 依赖性而不干扰 Linux 系统的最新技术。是 Python 虚拟环境的进化。</p><p id="94a8" class="pw-post-body-paragraph le lf iq lg b lh ma jr lj lk mb ju lm ln mc lp lq lr md lt lu lv me lx ly lz ij bi translated">这种初始配置有时对一些不可靠的用户来说是一个障碍。</p><p id="b746" class="pw-post-body-paragraph le lf iq lg b lh ma jr lj lk mb ju lm ln mc lp lq lr md lt lu lv me lx ly lz ij bi translated">我是卢卡·伯尔顿，欢迎来到今天的《神秘飞行员》节目。</p><h1 id="66f3" class="km kn iq bd ko kp kq kr ks kt ku kv kw jw kx jx ky jz kz ka la kc lb kd lc ld bi translated">可行的执行环境</h1><ul class=""><li id="3156" class="mf mg iq lg b lh li lk ll ln mh lr mi lv mj lz mk ml mm mn bi translated">可行的执行环境</li><li id="f3d5" class="mf mg iq lg b lh mo lk mp ln mq lr mr lv ms lz mk ml mm mn bi translated"><code class="fe mt mu mv mw b">ansible-builder</code>命令行工具</li><li id="ffc9" class="mf mg iq lg b lh mo lk mp ln mq lr mr lv ms lz mk ml mm mn bi translated"><code class="fe mt mu mv mw b">ansible-runner</code>命令行工具</li></ul><p id="b134" class="pw-post-body-paragraph le lf iq lg b lh ma jr lj lk mb ju lm ln mc lp lq lr md lt lu lv me lx ly lz ij bi translated">我们来谈谈 Ansible 的执行环境。</p><p id="c09d" class="pw-post-body-paragraph le lf iq lg b lh ma jr lj lk mb ju lm ln mc lp lq lr md lt lu lv me lx ly lz ij bi translated">Ansible 执行环境是可用作 Ansible 控制节点的容器映像。</p><p id="dee1" class="pw-post-body-paragraph le lf iq lg b lh ma jr lj lk mb ju lm ln mc lp lq lr md lt lu lv me lx ly lz ij bi translated">这是 Red Hat 为简化自动化过程而开发的最新技术。</p><p id="bd8a" class="pw-post-body-paragraph le lf iq lg b lh ma jr lj lk mb ju lm ln mc lp lq lr md lt lu lv me lx ly lz ij bi translated">主要优势是使用容器技术创建可移植自动化运行时的开发和生产映像的标准环境。</p><p id="718a" class="pw-post-body-paragraph le lf iq lg b lh ma jr lj lk mb ju lm ln mc lp lq lr md lt lu lv me lx ly lz ij bi translated">这项技术取代了手动 Python 虚拟环境、Ansible 模块依赖和 bubblewrap。</p><p id="32d0" class="pw-post-body-paragraph le lf iq lg b lh ma jr lj lk mb ju lm ln mc lp lq lr md lt lu lv me lx ly lz ij bi translated">有经验的用户可能对管理定制 Python 虚拟环境和 Ansible 模块依赖关系的许多挑战都很熟悉。Ansible Automation Platform 的企业用户熟悉在 bubblewrap 下限制执行作业，以便隔离进程</p><p id="da1d" class="pw-post-body-paragraph le lf iq lg b lh ma jr lj lk mb ju lm ln mc lp lq lr md lt lu lv me lx ly lz ij bi translated">创建由 Ansible Builder 工具执行。</p><p id="9172" class="pw-post-body-paragraph le lf iq lg b lh ma jr lj lk mb ju lm ln mc lp lq lr md lt lu lv me lx ly lz ij bi translated">Ansible Builder 生成一个目录，作为容器映像构建的构建上下文，其中包含`<code class="fe mt mu mv mw b">Containerfile</code>',以及需要添加到映像中的任何其他文件。</p><p id="54d7" class="pw-post-body-paragraph le lf iq lg b lh ma jr lj lk mb ju lm ln mc lp lq lr md lt lu lv me lx ly lz ij bi translated">另一方面，执行由 Ansible Runner 工具执行。</p><p id="0a04" class="pw-post-body-paragraph le lf iq lg b lh ma jr lj lk mb ju lm ln mc lp lq lr md lt lu lv me lx ly lz ij bi translated">Ansible Runner 使您能够在当前机器上将执行环境作为容器运行。这基本上就是确保内容按预期运行。</p><h1 id="846b" class="km kn iq bd ko kp kq kr ks kt ku kv kw jw kx jx ky jz kz ka la kc lb kd lc ld bi translated">链接</h1><ul class=""><li id="c367" class="mf mg iq lg b lh li lk ll ln mh lr mi lv mj lz mk ml mm mn bi translated"><a class="ae mx" href="https://www.ansible.com/products/execution-environments" rel="noopener ugc nofollow" target="_blank">https://www.ansible.com/products/execution-environments</a></li><li id="2f14" class="mf mg iq lg b lh mo lk mp ln mq lr mr lv ms lz mk ml mm mn bi translated"><a class="ae mx" href="https://docs.ansible.com/automation-controller/latest/html/userguide/execution_environments.html" rel="noopener ugc nofollow" target="_blank">https://docs . ansi ble . com/automation-controller/latest/html/user guide/execution _ environments . html</a></li></ul><h1 id="4feb" class="km kn iq bd ko kp kq kr ks kt ku kv kw jw kx jx ky jz kz ka la kc lb kd lc ld bi translated">演示</h1><p id="f286" class="pw-post-body-paragraph le lf iq lg b lh li jr lj lk ll ju lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">使用 ansible-builder 工具<br/>构建一个 Ansible 执行环境-执行环境名称:<em class="my"> my_ee </em> <br/> -系统依赖:git <br/> - Python 依赖 boto3 <br/> -集合依赖:community.aws</p><p id="e856" class="pw-post-body-paragraph le lf iq lg b lh ma jr lj lk mb ju lm ln mc lp lq lr md lt lu lv me lx ly lz ij bi translated">如何使用 ansible-builder 工具构建一个 Ansible 执行环境？</p><p id="8128" class="pw-post-body-paragraph le lf iq lg b lh ma jr lj lk mb ju lm ln mc lp lq lr md lt lu lv me lx ly lz ij bi translated">我将向您展示如何使用指定一些定制系统、Python 和集合依赖的<code class="fe mt mu mv mw b">ansible-builder</code>工具来构建一个定制的“<code class="fe mt mu mv mw b">my_ee</code>”ansi ble 执行环境。</p><p id="0461" class="pw-post-body-paragraph le lf iq lg b lh ma jr lj lk mb ju lm ln mc lp lq lr md lt lu lv me lx ly lz ij bi translated">例如，让我们构建一个名为“<code class="fe mt mu mv mw b">my_ee</code>”的定制的可执行环境，其中包含系统需求“<code class="fe mt mu mv mw b">git</code>”、Python 库“<code class="fe mt mu mv mw b">boto3</code>”和 Amazon 集合“<code class="fe mt mu mv mw b">community.aws</code>”。</p><h1 id="538b" class="km kn iq bd ko kp kq kr ks kt ku kv kw jw kx jx ky jz kz ka la kc lb kd lc ld bi translated">密码</h1><ul class=""><li id="717f" class="mf mg iq lg b lh li lk ll ln mh lr mi lv mj lz mk ml mm mn bi translated">执行环境. yml</li></ul><pre class="kf kg kh ki gt mz mw na nb aw nc bi"><span id="18b8" class="nd kn iq mw b gy ne nf l ng nh">---<br/>version: 1<br/>dependencies:<br/>  galaxy: requirements.yml<br/>  python: requirements.txt<br/>  system: bindep.txt<br/>additional_build_steps:<br/>  prepend: |<br/>        RUN pip3 install --upgrade pip setuptools<br/>  append:<br/>    - RUN ls -al /</span></pre><ul class=""><li id="245f" class="mf mg iq lg b lh ma lk mb ln ni lr nj lv nk lz mk ml mm mn bi translated">要求. yml</li></ul><pre class="kf kg kh ki gt mz mw na nb aw nc bi"><span id="6b54" class="nd kn iq mw b gy ne nf l ng nh">---<br/>collections:<br/>  - name: community.aws<br/>requirements.txt</span><span id="dece" class="nd kn iq mw b gy nl nf l ng nh">botocore&gt;=1.18.0<br/>boto3&gt;=1.15.0<br/>boto&gt;=2.49.0</span></pre><ul class=""><li id="2b28" class="mf mg iq lg b lh ma lk mb ln ni lr nj lv nk lz mk ml mm mn bi translated">bindep.txt</li></ul><pre class="kf kg kh ki gt mz mw na nb aw nc bi"><span id="616a" class="nd kn iq mw b gy ne nf l ng nh">git [platform:rpm]<br/>git [platform:dpkg]</span></pre><h1 id="61e2" class="km kn iq bd ko kp kq kr ks kt ku kv kw jw kx jx ky jz kz ka la kc lb kd lc ld bi translated">执行</h1><pre class="kf kg kh ki gt mz mw na nb aw nc bi"><span id="df7d" class="nd kn iq mw b gy ne nf l ng nh">$ ansible-builder build -t my_ee -v 3<br/>Running command:<br/>  podman build -f context/Containerfile -t my_ee context<br/>Complete! The build context can be found at: /home/devops/ee/context</span></pre><p id="9d60" class="pw-post-body-paragraph le lf iq lg b lh ma jr lj lk mb ju lm ln mc lp lq lr md lt lu lv me lx ly lz ij bi translated">当 ansible-builder 工具未安装时，您应该通过 DNF 命令安装它:</p><pre class="kf kg kh ki gt mz mw na nb aw nc bi"><span id="7c72" class="nd kn iq mw b gy ne nf l ng nh">[root@demo ee]# dnf install ansible-runner</span></pre><p id="f937" class="pw-post-body-paragraph le lf iq lg b lh ma jr lj lk mb ju lm ln mc lp lq lr md lt lu lv me lx ly lz ij bi translated">该工具需要访问您的 Red Hat Ansible Automation 订阅提供的 Red Hat 容器注册表(Red Hat Portal 的用户名和密码)。</p><pre class="kf kg kh ki gt mz mw na nb aw nc bi"><span id="4dd7" class="nd kn iq mw b gy ne nf l ng nh">$ podman login registry.redhat.io</span></pre><p id="8971" class="pw-post-body-paragraph le lf iq lg b lh ma jr lj lk mb ju lm ln mc lp lq lr md lt lu lv me lx ly lz ij bi translated">一个成功的构建会产生下面的<code class="fe mt mu mv mw b">context/Containerfile</code>:</p><pre class="kf kg kh ki gt mz mw na nb aw nc bi"><span id="2546" class="nd kn iq mw b gy ne nf l ng nh">ARG <em class="my">EE_BASE_IMAGE</em>=registry.redhat.io/ansible-automation-platform-22/ee-minimal-rhel8:latest<br/>ARG <em class="my">EE_BUILDER_IMAGE</em>=registry.redhat.io/ansible-automation-platform-22/ansible-builder-rhel8:latest<br/>FROM <em class="my">$EE_BASE_IMAGE</em> as galaxy<br/>ARG <em class="my">ANSIBLE_GALAXY_CLI_COLLECTION_OPTS</em>=<br/>USER root<br/>ADD _build /build<br/>WORKDIR /build<br/>RUN ansible-galaxy role install -r requirements.yml --roles-path "/usr/share/ansible/roles"<br/>RUN <em class="my">ANSIBLE_GALAXY_DISABLE_GPG_VERIFY</em>=1 ansible-galaxy collection install <em class="my">$ANSIBLE_GALAXY_CLI_COLLECTION_OPTS</em> -r requirements.yml --collections-path "/usr/share/ansible/collections"<br/>FROM <em class="my">$EE_BUILDER_IMAGE</em> as builder<br/>COPY --from=galaxy /usr/share/ansible /usr/share/ansible<br/>ADD _build/requirements.txt requirements.txt<br/>ADD _build/bindep.txt bindep.txt<br/>RUN ansible-builder introspect --sanitize --user-pip=requirements.txt --user-bindep=bindep.txt --write-bindep=/tmp/src/bindep.txt --write-pip=/tmp/src/requirements.txt<br/>RUN assemble<br/>FROM <em class="my">$EE_BASE_IMAGE</em><br/>USER root<br/>RUN pip3 install --upgrade pip setuptools<br/>COPY --from=galaxy /usr/share/ansible /usr/share/ansible<br/>COPY --from=builder /output/ /output/<br/>RUN /output/install-from-bindep &amp;&amp; rm -rf /output/wheels<br/>RUN ls -la /</span></pre><div class="nm nn gp gr no np"><a href="https://github.com/lucab85/ansible-pilot" rel="noopener  ugc nofollow" target="_blank"><div class="nq ab fo"><div class="nr ab ns cl cj nt"><h2 class="bd ir gy z fp nu fr fs nv fu fw ip bi translated">GitHub-lucab 85/ansi ble-Pilot:ansi ble Pilot YouTube 频道代码库</h2><div class="nw l"><h3 class="bd b gy z fp nu fr fs nv fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="nx l"><p class="bd b dl z fp nu fr fs nv fu fw dk translated">github.com</p></div></div><div class="ny l"><div class="nz l oa ob oc ny od oe np"/></div></div></a></div><h1 id="ef80" class="km kn iq bd ko kp kq kr ks kt ku kv kw jw kx jx ky jz kz ka la kc lb kd lc ld bi translated">概述</h1><p id="5fae" class="pw-post-body-paragraph le lf iq lg b lh li jr lj lk ll ju lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">现在您知道了如何使用带有定制系统、Python 和 Ansible 集合的<code class="fe mt mu mv mw b">ansible-builder</code>命令行工具来构建 Ansible 执行环境。</p><p id="8de4" class="pw-post-body-paragraph le lf iq lg b lh ma jr lj lk mb ju lm ln mc lp lq lr md lt lu lv me lx ly lz ij bi translated">我希望你喜欢读这篇文章。如果你愿意支持我成为一名作家，可以考虑注册<a class="ae mx" href="https://ansiblepilot.medium.com/membership" rel="noopener">成为</a>的媒体成员。每月只需 5 美元，你就可以无限制地使用 Medium。</p><p id="e0fb" class="pw-post-body-paragraph le lf iq lg b lh ma jr lj lk mb ju lm ln mc lp lq lr md lt lu lv me lx ly lz ij bi translated">订阅<a class="ae mx" href="https://www.youtube.com/channel/UC5MNbTYRHSCu9vAki3z9SmA" rel="noopener ugc nofollow" target="_blank"> YouTube 频道</a>、<a class="ae mx" href="https://ansiblepilot.medium.com/" rel="noopener"> Medium </a>、<a class="ae mx" href="https://ansiblepilot.substack.com/" rel="noopener ugc nofollow" target="_blank"> Substack </a>和<a class="ae mx" href="https://www.ansiblepilot.com/" rel="noopener ugc nofollow" target="_blank">网站</a>，不要错过 Ansible Pilot 的下一集。</p><h1 id="3fa7" class="km kn iq bd ko kp kq kr ks kt ku kv kw jw kx jx ky jz kz ka la kc lb kd lc ld bi translated">Ansible 的最佳资源</h1><h1 id="dc7b" class="km kn iq bd ko kp kq kr ks kt ku kv kw jw kx jx ky jz kz ka la kc lb kd lc ld bi translated">视频课程</h1><ul class=""><li id="dcc1" class="mf mg iq lg b lh li lk ll ln mh lr mi lv mj lz mk ml mm mn bi translated"><a class="ae mx" href="https://www.udemy.com/course/ansible-by-examples-devops/?referralCode=8E065F6D6F8622A3DEC8" rel="noopener ugc nofollow" target="_blank">在 200 多个示例中学习 Ansible Automation&amp;实践课程:通过一些关于如何使用最常见模块的真实示例和 ansi ble 剧本来学习 ansi ble</a></li></ul><h1 id="3338" class="km kn iq bd ko kp kq kr ks kt ku kv kw jw kx jx ky jz kz ka la kc lb kd lc ld bi translated">书</h1><ul class=""><li id="a502" class="mf mg iq lg b lh li lk ll ln mh lr mi lv mj lz mk ml mm mn bi translated"><a class="ae mx" href="https://leanpub.com/ansiblebyexamples" rel="noopener ugc nofollow" target="_blank">可通过示例回答:200 多个针对 Linux 和 Windows 系统管理员和开发人员的自动化示例</a></li><li id="0e61" class="mf mg iq lg b lh mo lk mp ln mq lr mr lv ms lz mk ml mm mn bi translated"><a class="ae mx" href="https://leanpub.com/ansibleforwindowsbyexamples" rel="noopener ugc nofollow" target="_blank">适用于 Windows 的示例:针对 Windows 系统管理员和开发人员的 30 多个自动化示例</a></li><li id="31f1" class="mf mg iq lg b lh mo lk mp ln mq lr mr lv ms lz mk ml mm mn bi translated"><a class="ae mx" href="https://leanpub.com/ansibleforlinuxbyexamples" rel="noopener ugc nofollow" target="_blank">ansi ble For Linux by Examples:100 多个针对 Linux 系统管理员和开发人员的自动化示例</a></li><li id="2d33" class="mf mg iq lg b lh mo lk mp ln mq lr mr lv ms lz mk ml mm mn bi translated"><a class="ae mx" href="https://leanpub.com/linuxfileanddirectorybyansibleexamples" rel="noopener ugc nofollow" target="_blank"> Ansible Linux 文件系统示例:30 多个针对现代 IT 基础设施的 Linux 文件和目录操作自动化示例</a></li><li id="0125" class="mf mg iq lg b lh mo lk mp ln mq lr mr lv ms lz mk ml mm mn bi translated"><a class="ae mx" href="https://leanpub.com/ansible-for-kubernetes-by-examples" rel="noopener ugc nofollow" target="_blank">通过示例负责容器和 Kubernetes:10 多个自动化示例来自动化容器、Kubernetes 和 OpenShift </a></li><li id="f1ee" class="mf mg iq lg b lh mo lk mp ln mq lr mr lv ms lz mk ml mm mn bi translated"><a class="ae mx" href="https://leanpub.com/ansibleforsecuritybyexamples" rel="noopener ugc nofollow" target="_blank">负责安全示例:100 多个自动化示例，用于自动化现代 IT 基础设施的安全和验证合规性</a></li><li id="0a26" class="mf mg iq lg b lh mo lk mp ln mq lr mr lv ms lz mk ml mm mn bi translated"><a class="ae mx" href="https://leanpub.com/ansible-tips-and-tricks" rel="noopener ugc nofollow" target="_blank">可行的技巧和窍门:10 多个可行的例子来节省时间和自动化更多的任务</a></li><li id="c0cd" class="mf mg iq lg b lh mo lk mp ln mq lr mr lv ms lz mk ml mm mn bi translated"><a class="ae mx" href="https://leanpub.com/ansiblelinuxusersandgroupsbyexamples" rel="noopener ugc nofollow" target="_blank"> Ansible Linux 用户&amp;按示例分组:20 多个关于现代 IT 基础设施的 Linux 用户和分组操作的自动化示例</a></li><li id="99d0" class="mf mg iq lg b lh mo lk mp ln mq lr mr lv ms lz mk ml mm mn bi translated"><a class="ae mx" href="https://leanpub.com/ansible-for-vmware-by-examples" rel="noopener ugc nofollow" target="_blank">ansi ble For VMware by Examples:10 多个自动化您的 VMware 基础架构的示例(Ansible by Examples) </a></li><li id="9048" class="mf mg iq lg b lh mo lk mp ln mq lr mr lv ms lz mk ml mm mn bi translated"><a class="ae mx" href="https://leanpub.com/ansible-for-postgresql-by-examples" rel="noopener ugc nofollow" target="_blank">Ansible For PostgreSQL by Examples:10 多个自动化 PostgreSQL 数据库的示例</a></li><li id="2b1b" class="mf mg iq lg b lh mo lk mp ln mq lr mr lv ms lz mk ml mm mn bi translated"><a class="ae mx" href="https://leanpub.com/ansible-for-aws-by-examples" rel="noopener ugc nofollow" target="_blank">ansi ble For Amazon Web Services AWS By Examples:10 多个自动化 AWS 现代基础设施的示例</a></li></ul><h1 id="3f5a" class="km kn iq bd ko kp kq kr ks kt ku kv kw jw kx jx ky jz kz ka la kc lb kd lc ld bi translated">捐赠</h1><div class="nm nn gp gr no np"><a href="https://patreon.com/lucaberton" rel="noopener  ugc nofollow" target="_blank"><div class="nq ab fo"><div class="nr ab ns cl cj nt"><h2 class="bd ir gy z fp nu fr fs nv fu fw ip bi translated">卢卡·伯尔顿正在为 Ansible | Patreon 创建软件开源</h2><div class="nw l"><h3 class="bd b gy z fp nu fr fs nv fu fw dk translated">今天就成为卢卡·伯尔顿的赞助人:获得世界上最大会员的独家内容和体验…</h3></div><div class="nx l"><p class="bd b dl z fp nu fr fs nv fu fw dk translated">patreon.com</p></div></div><div class="ny l"><div class="of l oa ob oc ny od oe np"/></div></div></a></div><div class="nm nn gp gr no np"><a href="https://github.com/sponsors/lucab85" rel="noopener  ugc nofollow" target="_blank"><div class="nq ab fo"><div class="nr ab ns cl cj nt"><h2 class="bd ir gy z fp nu fr fs nv fu fw ip bi translated">GitHub 赞助商上的赞助商@lucab85</h2><div class="nw l"><h3 class="bd b gy z fp nu fr fs nv fu fw dk translated">我是一个活跃的开源贡献者，参与到了 Ansible 社区中，尽管我到处都是。@lucab85 的…</h3></div><div class="nx l"><p class="bd b dl z fp nu fr fs nv fu fw dk translated">github.com</p></div></div><div class="ny l"><div class="og l oa ob oc ny od oe np"/></div></div></a></div><figure class="kf kg kh ki gt kj gh gi paragraph-image"><div role="button" tabindex="0" class="oi oj di ok bf ol"><div class="gh gi oh"><img src="../Images/7279b7fe7d9490903dad032257dd99fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*70vk_Yx2yd5KlfAoYILBwA.png"/></div></div></figure></div></div>    
</body>
</html>