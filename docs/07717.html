<html>
<head>
<title>OAuth2 Authorization with React</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ä½¿ç”¨ React è¿›è¡Œ OAuth2 æˆæƒ</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://blog.devgenius.io/oauth2-authorization-with-react-df276f747d5a?source=collection_archive---------6-----------------------#2022-04-18">https://blog.devgenius.io/oauth2-authorization-with-react-df276f747d5a?source=collection_archive---------6-----------------------#2022-04-18</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/617f22bebba280cb9e56b2b9a328109e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*3246zB5zUBPhRGaQ.png"/></div></div></figure><blockquote class="jv jw jx"><p id="506f" class="jy jz ka kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><em class="in">å¦‚æœä½ æƒ³åœ¨ä½ çš„ React é¡¹ç›®ä¸­ä½¿ç”¨</em> <strong class="kb io"> <em class="in"> OAuth2 </em> </strong> <em class="in">æˆæƒå¯ä»¥ä½¿ç”¨æˆ‘å‘å¸ƒçš„åŒ…:</em><a class="ae kx" href="https://github.com/tasoskakour/react-use-oauth2" rel="noopener ugc nofollow" target="_blank"><em class="in">@ tasoskakour/React-use-oauth 2</em></a><em class="in">ã€‚</em></p></blockquote><h1 id="0139" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">ä»€ä¹ˆæ˜¯ OAuth2ï¼Ÿ</h1><p id="b5e8" class="pw-post-body-paragraph jy jz in kb b kc lw ke kf kg lx ki kj ly lz km kn ma mb kq kr mc md ku kv kw ig bi translated">OAuth2 æ˜¯æˆæƒçš„è¡Œä¸šæ ‡å‡†åè®®ã€‚å®ƒä¸ºæˆ‘ä»¬æä¾›äº† web åº”ç”¨ç¨‹åºã€æ¡Œé¢åº”ç”¨ç¨‹åºã€ç§»åŠ¨ç”µè¯å’Œå®¢å…è®¾å¤‡çš„ç‰¹å®šæˆæƒæµç¨‹ã€‚ä½ å¯ä»¥åœ¨è¿™é‡Œé˜…è¯»æ›´å¤šå…³äºæ¡†æ¶<a class="ae kx" href="https://oauth.net/2/" rel="noopener ugc nofollow" target="_blank">çš„å†…å®¹ã€‚</a></p><h1 id="194b" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">æˆ‘ä»¬åœ¨ç½‘ç»œä¸Šçš„ä»€ä¹ˆåœ°æ–¹ä½¿ç”¨ OAuth2ï¼Ÿ</h1><p id="bc7c" class="pw-post-body-paragraph jy jz in kb b kc lw ke kf kg lx ki kj ly lz km kn ma mb kq kr mc md ku kv kw ig bi translated">OAuth2 åè®®çš„ä¸»è¦ç”¨é€”ä¹‹ä¸€æ˜¯ä¸ç¬¬ä¸‰æ–¹æä¾›å•†(å¦‚è°·æ­Œã€è„¸ä¹¦ã€è‹¹æœç­‰)è¿›è¡Œè®¤è¯å’Œæˆæƒã€‚æ‰€è°“çš„â€œç¤¾äº¤ç™»å½•â€ã€‚æˆ‘å¾ˆç¡®å®šä½ ä»¬ä¸­çš„å¤§å¤šæ•°äººè¿‡å»éƒ½ä½¿ç”¨è¿‡ OAuth2(ä½œä¸ºä¸€ä¸ªç»ˆç«¯ç”¨æˆ·)çš„ç¤¾äº¤ç™»å½•ã€‚</p><p id="504f" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated">åœ¨ä¸‹é¢çš„å›¾ç‰‡ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç”¨æˆ·æ—¢å¯ä»¥é€šè¿‡ä¼ ç»Ÿçš„æä¾›ç”¨æˆ·åå’Œå¯†ç çš„æ–¹å¼æ‰‹åŠ¨ç™»å½•(å³ä¾§)ï¼Œä¹Ÿå¯ä»¥é€šè¿‡è„¸ä¹¦/æ¨ç‰¹/è°·æ­Œç™»å½•(å·¦ä¾§)ã€‚é€šè¿‡é€‰æ‹©ä¸è¿™äº›ç¤¾äº¤æä¾›å•†ä¹‹ä¸€ç™»å½•ï¼Œä»–ä»¬åŸºæœ¬ä¸Šæ˜¯åœ¨ä¸è¯¥æä¾›å•†è¿›è¡Œè®¤è¯ï¼Œå¹¶æˆæƒåº”ç”¨ç¨‹åºè®¿é—®ä»–ä»¬çš„ç¤¾äº¤è´¦æˆ·çš„æŸäº›ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä»–ä»¬é€‰æ‹©ç™»å½•è°·æ­Œï¼Œåœ¨æˆåŠŸè®¤è¯åï¼Œåº”ç”¨ç¨‹åºå¯èƒ½çŸ¥é“ä»–ä»¬çš„è°·æ­Œç”µå­é‚®ä»¶ï¼Œä¸ªäººèµ„æ–™ç…§ç‰‡å’Œå§“åã€‚</p><figure class="me mf mg mh gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/3922dacffffadf7f090a29f8172cff4c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*V0pLt-d3Bn4yQwjb.png"/></div></div></figure><p id="5b68" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated">ä½¿ç”¨ç¤¾äº¤ç™»å½•çš„ä¸€ä¸ªå¥½å¤„å°±æ˜¯ç®€å•ã€‚åªéœ€ä¸€æ¬¡ç‚¹å‡»ï¼Œç”šè‡³æ— éœ€è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨å‡ ç§’é’Ÿå†…å¼€å§‹ä½¿ç”¨åº”ç”¨ç¨‹åºã€‚å½“ç„¶ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿è¿™ä¸ªåº”ç”¨ç¨‹åºæ˜¯å€¼å¾—ä¿¡ä»»çš„ï¼Œæˆ‘ä»¬<strong class="kb io">æ€»æ˜¯éœ€è¦æ³¨æ„è¿™ä¸ªåº”ç”¨ç¨‹åºæœ€ç»ˆä¼šä»æˆ‘ä»¬çš„ç¤¾äº¤è´¦æˆ·ä¸­æ”¶é›†ä»€ä¹ˆä¿¡æ¯ã€‚</strong></p><h1 id="bac9" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">OAuth2 æˆæƒç±»å‹</h1><p id="9627" class="pw-post-body-paragraph jy jz in kb b kc lw ke kf kg lx ki kj ly lz km kn ma mb kq kr mc md ku kv kw ig bi translated">æœ€å¸¸è§çš„ OAuth2 æˆæƒç±»å‹æ˜¯<a class="ae kx" href="https://oauth.net/2/grant-types/authorization-code/" rel="noopener ugc nofollow" target="_blank">æˆæƒç </a>å’Œ<a class="ae kx" href="https://oauth.net/2/grant-types/implicit/" rel="noopener ugc nofollow" target="_blank">éšå¼æµç¨‹</a>ã€‚</p><p id="90b0" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated"><strong class="kb io"> OAuth 2.0 æˆæƒç æˆäºˆ</strong></p><p id="9b48" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated">æœºå¯†å’Œå…¬å…±å®¢æˆ·ç«¯ä½¿ç”¨æˆæƒç æˆæƒç±»å‹æ¥äº¤æ¢è®¿é—®ä»¤ç‰Œçš„æˆæƒç ã€‚è¿™ä¸ªæµç¨‹çš„æ­¥éª¤æ˜¯:</p><p id="cfc5" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated"><strong class="kb io"> 1) </strong>å®¢æˆ·ç«¯(ä½ çš„åº”ç”¨ç¨‹åº)æ„å»ºå¹¶å‘é€ç»™ç”¨æˆ·ä¸€ä¸ªæˆæƒ URL(ä¾‹å¦‚å¯¹äº Google æ¥è¯´æ˜¯<code class="fe mi mj mk ml b">https://accounts.google.com/o/oauth2/v2/auth</code>),å…¶æ ¼å¼å¦‚ä¸‹:</p><pre class="me mf mg mh gt mm ml mn mo aw mp bi"><span id="034a" class="mq kz in ml b gy mr ms l mt mu">https://authorization-server.com/auth?<br/>response_type=code&amp;<br/>client_id=CLIENT_ID&amp;<br/>redirect_uri=REDIRECT_URI&amp;<br/>scope=photos&amp;<br/>state=1234zyx</span></pre><p id="e6a4" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated"><strong class="kb io"> 2) </strong>ç”¨æˆ·çœ‹åˆ°æˆæƒæç¤ºï¼Œç‚¹å‡»â€œå…è®¸â€(æˆ–â€œæ‹’ç»â€)ã€‚(å¯èƒ½ä¼šè¦æ±‚ç”¨æˆ·å…ˆè¿›è¡Œèº«ä»½éªŒè¯)ã€‚</p><p id="2235" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated"><strong class="kb io"> 3) </strong>ç”¨æˆ·è¢«é‡å®šå‘åˆ°æœ€åˆä¼ é€’ç»™ç¬¬ä¸€æ­¥è¯·æ±‚çš„<code class="fe mi mj mk ml b">redirect_uri</code>ï¼Œä»¥åŠ<code class="fe mi mj mk ml b">code</code>å’Œ<code class="fe mi mj mk ml b">state</code>ã€‚è¯¥ URL å°†é‡‡ç”¨ä»¥ä¸‹å½¢å¼:</p><pre class="me mf mg mh gt mm ml mn mo aw mp bi"><span id="8226" class="mq kz in ml b gy mr ms l mt mu">https://REDIRECT_URI.com/callback?<br/>code=AUTH_CODE_HERE&amp;<br/>state=1234zyx</span></pre><p id="7256" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated"><strong class="kb io">æ³¨æ„:</strong><code class="fe mi mj mk ml b">state</code>å‚æ•°å¿…é¡»ä¸æ­¥éª¤ 1 ä¸­æœ€åˆç”Ÿæˆçš„çŠ¶æ€ç›¸åŒ¹é…ã€‚è¿™æ˜¯ä¸ºäº†å‡è½» CSRF çš„æ”»å‡»ã€‚åœ¨è¿™é‡Œé˜…è¯»æ›´å¤š<a class="ae kx" href="https://auth0.com/docs/secure/attack-protection/state-parameters" rel="noopener ugc nofollow" target="_blank"/>ã€‚</p><p id="2d82" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated">åœ¨è¿™ä¸€æ­¥ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ç”¨ä¸€ä¸ªå®é™…çš„è®¿é—®ä»¤ç‰Œæ¥äº¤æ¢æ¥æ”¶åˆ°çš„<code class="fe mi mj mk ml b">code</code>ã€‚ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦å‘æˆæƒæœåŠ¡å™¨çš„ä»¤ç‰Œç«¯ç‚¹å‘å‡º POST è¯·æ±‚ï¼Œå…¶å½¢å¼å¦‚ä¸‹æ‰€ç¤º(ä¾‹å¦‚ï¼Œå¯¹äº Google æ¥è¯´ï¼Œå®ƒæ˜¯<code class="fe mi mj mk ml b">https://oauth2.googleapis.com/token</code>)ã€‚è¯·æ³¨æ„ï¼Œè¿™ä¸ªè¯·æ±‚éœ€è¦ä»æˆ‘ä»¬çš„æœåŠ¡å™¨å‘å‡ºï¼Œå› ä¸ºæˆ‘ä»¬ä¸èƒ½å°†<code class="fe mi mj mk ml b">CLIENT_SECRET</code>æš´éœ²ç»™å‰ç«¯åº”ç”¨ç¨‹åºã€‚</p><pre class="me mf mg mh gt mm ml mn mo aw mp bi"><span id="9b43" class="mq kz in ml b gy mr ms l mt mu">https://api.authorization-server.com/token<br/>grant_type=authorization_code&amp;<br/>code=AUTH_CODE_HERE&amp;<br/>redirect_uri=REDIRECT_URI&amp;<br/>client_id=CLIENT_ID&amp;<br/>client_secret=CLIENT_SECRET</span></pre><p id="ea6b" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated">5)æˆæƒæœåŠ¡å™¨å›å¤è®¿é—®ä»¤ç‰Œå’Œåˆ°æœŸæ—¶é—´:</p><pre class="me mf mg mh gt mm ml mn mo aw mp bi"><span id="0ee3" class="mq kz in ml b gy mr ms l mt mu">{<br/>"access_token":"RsT5OjbzRn430zqMLgV3Ia",<br/>"expires_in":3600<br/>}</span></pre><p id="b638" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated"><strong class="kb io">æ³¨</strong>:æˆæƒä»£ç æµä¸€èˆ¬è¢«è®¤ä¸ºæ˜¯å®‰å…¨çš„ã€‚ç„¶è€Œï¼Œé€šè¿‡ä½¿ç”¨ PKCE ( <a class="ae kx" href="https://tools.ietf.org/html/rfc7636" rel="noopener ugc nofollow" target="_blank"> RFC 7636 </a>)æ‰©å±•ï¼Œåˆ©ç”¨<code class="fe mi mj mk ml b">code_verifier</code>ã€<code class="fe mi mj mk ml b">code_challenge</code>å’Œ<code class="fe mi mj mk ml b">code_challenge_method</code>ï¼Œå®ƒå¯ä»¥æ›´åŠ é˜²å¼¹ã€‚è¿™ä¸ªæ‰©å±•è¶…å‡ºäº†æœ¬æ–‡çš„èŒƒå›´ã€‚ä½ å¯ä»¥åœ¨è¿™é‡Œé˜…è¯»æ›´å¤šå…³äºå®ƒçš„ä¿¡æ¯ã€‚</p><p id="8727" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated"><strong class="kb io">éšå¼æµæˆäºˆ</strong></p><p id="c827" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated">éšå¼æµæ˜¯ JavaScript åº”ç”¨ç¨‹åºçš„ç®€åŒ– OAuth æµï¼Œå…¶ä¸­è®¿é—®ä»¤ç‰Œè¢«ç«‹å³è¿”å›ï¼Œæ— éœ€é¢å¤–çš„æˆæƒç äº¤æ¢æ­¥éª¤ã€‚</p><p id="ad32" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated">è¿™æ„å‘³ç€éšå¼æµç¨‹çš„æ­¥éª¤æ˜¯æˆ‘ä»¬ä¸Šé¢ä¸ºæˆæƒä»£ç æˆæƒç¼–å†™çš„æ­¥éª¤ 1-3ã€‚è¿˜æœ‰ä¸€ä¸ªåŒºåˆ«æ˜¯é‡å®šå‘ URL å°†åœ¨ hash (#)å‚æ•°ä¸­åŒ…å«<code class="fe mi mj mk ml b">access_token</code>,è€Œä¸æ˜¯åœ¨æœç´¢(ï¼Ÿ)URL çš„å‚æ•°ã€‚å®ƒå°†å…·æœ‰ä»¥ä¸‹å½¢å¼:</p><pre class="me mf mg mh gt mm ml mn mo aw mp bi"><span id="bf2e" class="mq kz in ml b gy mr ms l mt mu">https://REDIRECT_URI.com/callback#<br/>access_token=ACCESS_TOKEN&amp;<br/>expires_in=3600&amp;<br/>token_type=Bearer&amp;<br/>state=1234zyx</span></pre><p id="80f7" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated">å¦‚ä»Šï¼ŒOAuth 2.0 æ ‡å‡†æ¨èä½¿ç”¨<em class="ka">æˆæƒç æˆæƒ</em>è€Œä¸æ˜¯<em class="ka">éšå¼æµ</em>ï¼Œè¿™æ˜¯ç”±äºåœ¨ HTTP é‡å®šå‘ä¸­è¿”å›è®¿é—®ä»¤ç‰Œçš„å†…åœ¨é£é™©ï¼Œè€Œæ²¡æœ‰ç¡®è®¤å®ƒå·²ç»è¢«å®¢æˆ·ç«¯æ¥æ”¶ã€‚</p><p id="08d2" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated">ç„¶è€Œï¼Œå¤§å¤šæ•°ä¸»è¦æä¾›å•†ä»ç„¶æ”¯æŒå¹¶å…è®¸åº”ç”¨ç¨‹åºä½¿ç”¨<em class="ka">éšå¼æµ</em>ã€‚ä¾‹å¦‚ï¼Œåœ¨è¿™é‡Œä½ å¯ä»¥é˜…è¯» Google å…³äºå®¢æˆ·ç«¯ Web åº”ç”¨ç¨‹åº OAuth 2.0 çš„æ–‡æ¡£ï¼Œå®ƒåŸºæœ¬ä¸Šä½¿ç”¨äº†ä¸€ä¸ªéšå¼æµç¨‹ã€‚</p><h1 id="884b" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">React:ç”¨é’©å­å®ç° OAuth2</h1><p id="316e" class="pw-post-body-paragraph jy jz in kb b kc lw ke kf kg lx ki kj ly lz km kn ma mb kq kr mc md ku kv kw ig bi translated">åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªåä¸º<code class="fe mi mj mk ml b">useOAuth2</code>çš„ React é’©å­ï¼Œå®ƒå°†å®ç°ä¸€ä¸ªå¸¦æœ‰<strong class="kb io">æˆæƒç æˆæƒ</strong>çš„<strong class="kb io"> OAuth2 </strong>ã€‚</p><blockquote class="jv jw jx"><p id="c84d" class="jy jz ka kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><em class="in">å¦‚æœä½ æƒ³åœ¨ä½ çš„ React é¡¹ç›®ä¸­ä½¿ç”¨</em><strong class="kb io"><em class="in">oauth 2</em></strong><em class="in">æˆæƒä½ å¯ä»¥ä½¿ç”¨æˆ‘å‘å¸ƒçš„åŒ…:</em><a class="ae kx" href="https://github.com/tasoskakour/react-use-oauth2" rel="noopener ugc nofollow" target="_blank"><em class="in">@ tasoskakour/React-use-oauth 2</em></a><em class="in">ã€‚</em></p></blockquote><p id="98f2" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated">ä¸ºäº†ä½¿æˆæƒæ›´åŠ ç”¨æˆ·å‹å¥½ï¼Œæˆ‘ä»¬å°†åˆ©ç”¨ä¸€ä¸ªå¼¹å‡ºçª—å£ï¼›ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹ç¬¬ä¸‰æ–¹çš„æˆæƒå°†éšç€é‡å®šå‘åœ¨å¼¹å‡ºçª—å£ä¸­å‘ç”Ÿ<strong class="kb io">ã€‚</strong></p><p id="4a7c" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated"><strong class="kb io">ç¬¬ä¸€æ­¥:å‡†å¤‡æŒ‚é’©</strong></p><p id="d09f" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated">æˆ‘ä»¬çš„é’©å­éœ€è¦çš„é“å…·æ˜¯:</p><ul class=""><li id="2d26" class="mv mw in kb b kc kd kg kh ly mx ma my mc mz kw na nb nc nd bi translated"><strong class="kb io"> authorizeUrl </strong>:ç¬¬ä¸‰æ–¹æˆæƒ Url(ä¾‹å¦‚å¯¹äº Google æ˜¯<code class="fe mi mj mk ml b"><a class="ae kx" href="https://accounts.google.com/o/oauth2/v2/auth)." rel="noopener ugc nofollow" target="_blank">https://accounts.google.com/o/oauth2/v2/auth</a></code> <a class="ae kx" href="https://accounts.google.com/o/oauth2/v2/auth)." rel="noopener ugc nofollow" target="_blank">)ã€‚</a></li><li id="4a49" class="mv mw in kb b kc ne kg nf ly ng ma nh mc ni kw na nb nc nd bi translated"><strong class="kb io"> clientId </strong>:åº”ç”¨ç¨‹åºçš„ OAuth2 å®¢æˆ·ç«¯ Idã€‚</li><li id="7d8c" class="mv mw in kb b kc ne kg nf ly ng ma nh mc ni kw na nb nc nd bi translated"><strong class="kb io"> redirectUri </strong>:ç¡®å®šç”¨æˆ·å®Œæˆæˆæƒæµç¨‹åï¼Œç¬¬ä¸‰æ–¹ API æœåŠ¡å™¨å°†ç”¨æˆ·é‡å®šå‘åˆ°å“ªé‡Œã€‚åœ¨æˆ‘ä»¬çš„å®ç°ä¸­ï¼Œå°†åœ¨<code class="fe mi mj mk ml b">redirectUri</code>ä¸Šå‘ˆç°ä¸€ä¸ªå¼¹å‡ºçª—å£ã€‚</li><li id="963c" class="mv mw in kb b kc ne kg nf ly ng ma nh mc ni kw na nb nc nd bi translated"><strong class="kb io">èŒƒå›´</strong> (string â€” <em class="ka">å¯é€‰</em>):æ ¹æ®æ‚¨çš„åº”ç”¨éœ€æ±‚åˆ—å‡ºçš„èŒƒå›´ã€‚</li></ul><p id="fef7" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated">è®©æˆ‘ä»¬æŠŠè¿™äº›é“å…·æ”¾åˆ°é’©å­ä¸Šï¼Œç„¶ååˆ›å»ºä¸€ä¸ª UI çŠ¶æ€åŠ©æ‰‹ï¼Œå®ƒå°†åŒ…å«<code class="fe mi mj mk ml b">{loading, error}</code>å’Œä¸€ä¸ªåä¸º<code class="fe mi mj mk ml b">getAuth</code>çš„å‡½æ•°ã€‚è¯¥å‡½æ•°å°†åˆå§‹åŒ–æˆæƒæµç¨‹ï¼Œå› æ­¤ä½œä¸ºç¬¬ä¸€æ­¥ï¼Œå®ƒéœ€è¦å°†<code class="fe mi mj mk ml b">loading</code>è®¾ç½®ä¸ºçœŸå¹¶æ¸…é™¤ä»»ä½•é”™è¯¯ã€‚</p><pre class="me mf mg mh gt mm ml mn mo aw mp bi"><span id="fc79" class="mq kz in ml b gy mr ms l mt mu">// useOAuth2.js<br/>import { useCallback, useState } from 'react'; <br/><br/>const useOAuth2 = (props) =&gt; {<br/>  const {<br/>      authorizeUrl,<br/>      clientId,<br/>      redirectUri,<br/>      scope = '',<br/>    } = props;<br/><br/>  const [{ loading, error }, setUI] = useState({ loading: false, error: null });<br/><br/>  const getAuth = useCallback(() =&gt; {<br/>      // 1. Init<br/>      setUI({<br/>        loading: true,<br/>        error: null,<br/>      });<br/>  })<br/>}</span></pre><p id="9f0a" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated"><strong class="kb io">æ­¥éª¤ 2:ç”ŸæˆçŠ¶æ€</strong></p><p id="231d" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated">åœ¨æ„å»ºæˆæƒ URL ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ç”Ÿæˆä¸€ä¸ª<code class="fe mi mj mk ml b">state</code>å‚æ•°ã€‚éœ€è¦è¿™ä¸ªå‚æ•°æ¥ç¼“è§£<a class="ae kx" href="https://auth0.com/docs/secure/attack-protection/state-parameters" rel="noopener ugc nofollow" target="_blank"> CSRF æ”»å‡»</a>ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åœ¨è¿™é‡Œä¼ é€’æˆ‘ä»¬æƒ³è¦çš„ä»»ä½•å…¶ä»–çŠ¶æ€ä¿¡æ¯ï¼Œä»¥ä¾¿åœ¨é‡å®šå‘ä¹‹åè¿›è¡Œæ¢å¤ã€‚</p><p id="769f" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated">ä¸ºäº†ç”ŸæˆçŠ¶æ€ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†<code class="fe mi mj mk ml b">window.crypto</code>å‡½æ•°ã€‚å®ç°è¿™ä¸€ç‚¹çš„ä»£ç æ‘˜è‡ªè¿™ç¯‡æ–‡ç« ã€‚</p><p id="617f" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated">æˆ‘ä»¬è¿˜éœ€è¦å°†çŠ¶æ€æŒä¹…åŒ–åˆ°<code class="fe mi mj mk ml b">sessionStorage</code>ï¼Œä»¥ä¾¿æˆ‘ä»¬çš„å¼¹å‡ºçª—å£èƒ½å¤Ÿåœ¨é‡å®šå‘å‘ç”Ÿåè¯»å–å®ƒ(æˆ‘ä»¬ä¹Ÿå¯ä»¥å°†å®ƒæŒä¹…åŒ–åˆ°<em class="ka"> cookies </em>æˆ–<em class="ka"> localStorage </em>)ã€‚</p><pre class="me mf mg mh gt mm ml mn mo aw mp bi"><span id="a628" class="mq kz in ml b gy mr ms l mt mu">// useOAuth2.js<br/>import { useCallback, useState } from 'react'; <br/><br/>const OAUTH_STATE_KEY = 'react-use-oauth2-state-key';<br/><br/>// https://medium.com/@dazcyril/generating-cryptographic-random-state-in-javascript-in-the-browser-c538b3daae50<br/>const generateState = () =&gt; {<br/>	const validChars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';<br/>	let array = new Uint8Array(40);<br/>	window.crypto.getRandomValues(array);<br/>	array = array.map((x: number) =&gt; validChars.codePointAt(x % validChars.length));<br/>	const randomState = String.fromCharCode.apply(null, array);<br/>	return randomState;<br/>};<br/><br/>const saveState = (state: string) =&gt; {<br/>	sessionStorage.setItem(OAUTH_STATE_KEY, state);<br/>};<br/><br/>const removeState = () =&gt; {<br/>	sessionStorage.removeItem(OAUTH_STATE_KEY);<br/>};<br/><br/>const useOAuth2 = (props) =&gt; {<br/>  const {<br/>      authorizeUrl,<br/>      clientId,<br/>      redirectUri,<br/>      scope = '',<br/>    } = props;<br/><br/>  const [{ loading, error }, setUI] = useState({ loading: false, error: null });<br/><br/>  const getAuth = useCallback(() =&gt; {<br/>      // 1. Init<br/>      setUI({<br/>        loading: true,<br/>        error: null,<br/>      });<br/><br/>      // 2. Generate and save state<br/>      const state = generateState();<br/>      saveState(state);<br/>  })<br/>}</span></pre><p id="7528" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated"><strong class="kb io">ç¬¬ä¸‰æ­¥:æ‰“å¼€å¼¹å‡ºçª—å£</strong></p><p id="877b" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated">ç°åœ¨æˆ‘ä»¬å°†å¼€å§‹æˆæƒè¿‡ç¨‹ï¼</p><p id="3098" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated">æˆ‘ä»¬åˆ©ç”¨æ¥å—<code class="fe mi mj mk ml b">authorizeUrl, clientId, redirectUri, scope, state</code>å‚æ•°çš„<code class="fe mi mj mk ml b">enhanceAuthorizeUrl</code>å‡½æ•°åˆ›å»ºæˆæƒ URLï¼Œå¹¶æ‰“å¼€ä¸€ä¸ªæŒ‡å‘è¯¥ URL çš„<strong class="kb io">å¼¹å‡ºçª—å£</strong>ã€‚ä¸ºäº†æ›´å¥½åœ°æ“ä½œå¼¹å‡ºçª—å£ï¼Œæˆ‘ä»¬åˆ©ç”¨<code class="fe mi mj mk ml b">useRef</code>æ¥ä¿å­˜å¼¹å‡ºçª—å£å®ä¾‹ã€‚</p><pre class="me mf mg mh gt mm ml mn mo aw mp bi"><span id="dd96" class="mq kz in ml b gy mr ms l mt mu">// useOAuth2.js<br/>import { useCallback, useState } from 'react'; <br/><br/>const OAUTH_STATE_KEY = 'react-use-oauth2-state-key';<br/>const POPUP_HEIGHT = 700;<br/>const POPUP_WIDTH = 600;<br/><br/>// https://medium.com/@dazcyril/generating-cryptographic-random-state-in-javascript-in-the-browser-c538b3daae50<br/>const generateState = () =&gt; {<br/>	const validChars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';<br/>	let array = new Uint8Array(40);<br/>	window.crypto.getRandomValues(array);<br/>	array = array.map((x) =&gt; validChars.codePointAt(x % validChars.length));<br/>	const randomState = String.fromCharCode.apply(null, array);<br/>	return randomState;<br/>};<br/><br/>const saveState = (state) =&gt; {<br/>	sessionStorage.setItem(OAUTH_STATE_KEY, state);<br/>};<br/><br/>const removeState = () =&gt; {<br/>	sessionStorage.removeItem(OAUTH_STATE_KEY);<br/>};<br/><br/>const openPopup = (url) =&gt; {<br/>	// To fix issues with window.screen in multi-monitor setups, the easier option is to<br/>	// center the pop-up over the parent window.<br/>	const top = window.outerHeight / 2 + window.screenY - POPUP_HEIGHT / 2;<br/>	const left = window.outerWidth / 2 + window.screenX - POPUP_WIDTH / 2;<br/>	return window.open(<br/>		url,<br/>		'OAuth2 Popup',<br/>		`height=${POPUP_HEIGHT},width=${POPUP_WIDTH},top=${top},left=${left}`<br/>	);<br/>};<br/><br/>const closePopup = (popupRef) =&gt; {<br/>	popupRef.current?.close();<br/>};<br/><br/>const enhanceAuthorizeUrl = (<br/>	authorizeUrl,<br/>	clientId,<br/>	redirectUri,<br/>	scope,<br/>	state<br/>) =&gt; {<br/>	return `${authorizeUrl}?response_type=code&amp;client_id=${clientId}&amp;redirect_uri=${redirectUri}&amp;scope=${scope}&amp;state=${state}`;<br/>};<br/><br/>const useOAuth2 = (props) =&gt; {<br/>  const {<br/>      authorizeUrl,<br/>      clientId,<br/>      redirectUri,<br/>      scope = '',<br/>    } = props;<br/><br/>  const popupRef = useRef();<br/>  const [{ loading, error }, setUI] = useState({ loading: false, error: null });<br/><br/>  const getAuth = useCallback(() =&gt; {<br/>      // 1. Init<br/>      setUI({<br/>        loading: true,<br/>        error: null,<br/>      });<br/><br/>      // 2. Generate and save state<br/>      const state = generateState();<br/>      saveState(state);<br/><br/>      // 3. Open popup<br/>      popupRef.current = openPopup(<br/>        enhanceAuthorizeUrl(authorizeUrl, clientId, redirectUri, scope, state)<br/>      );<br/>  })<br/>}</span></pre><p id="3826" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated"><strong class="kb io">åˆ›å»ºå¼¹å‡ºç»„ä»¶</strong></p><p id="bfef" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated">è®©æˆ‘ä»¬æš‚æ—¶ç¦»å¼€<code class="fe mi mj mk ml b">useOAuth2</code>é’©å­ï¼Œè®©æˆ‘ä»¬ä¸“æ³¨äº<strong class="kb io">å¼¹å‡º</strong>å®ç°ã€‚</p><p id="7d4c" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated">ç°åœ¨æˆ‘ä»¬å¤„äºè¿™æ ·ä¸€ç§çŠ¶æ€ï¼Œç”¨æˆ·åœ¨ä¸€ä¸ªå¼¹å‡ºçª—å£ä¸­ï¼Œå¹¶å‘ç¬¬ä¸‰æ–¹æ‰§è¡Œæˆæƒã€‚ä¹‹åï¼Œå®ƒä»¬å°†è¢«é‡å®šå‘åˆ°æˆ‘ä»¬åœ¨åˆå§‹è¯·æ±‚ä¸­ä¼ é€’çš„<code class="fe mi mj mk ml b">redirect_uri</code>ã€‚</p><p id="f3d3" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated">ä¸€ä¸ªæ–¹ä¾¿çš„åšæ³•æ˜¯ä¸ºé‚£ä¸ª<code class="fe mi mj mk ml b">redirect_uri</code>å‘ˆç°å¸¦æœ‰ååº”è·¯çº¿çš„å¼¹å‡ºçª—å£ã€‚ä¾‹å¦‚ï¼Œä½¿<code class="fe mi mj mk ml b">redirect_uri</code>æˆä¸º<code class="fe mi mj mk ml b">https://your-app.com/callback</code>ï¼Œç„¶ååˆ›å»ºå¦‚ä¸‹ä»£ç å—æ‰€ç¤ºçš„è·¯çº¿ã€‚è¿™æ ·ï¼ŒæˆæƒæœåŠ¡å™¨å°†æŠŠæˆ‘ä»¬é‡å®šå‘å›<code class="fe mi mj mk ml b">redirect_uri</code>ï¼Œå®ƒå°†åªå‘ˆç°æˆ‘ä»¬çš„å¼¹å‡ºç»„ä»¶ã€‚</p><pre class="me mf mg mh gt mm ml mn mo aw mp bi"><span id="aac7" class="mq kz in ml b gy mr ms l mt mu">// routes.js<br/>import { BrowserRouter, Route, Routes } from 'react-router-dom';<br/>import { OAuthPopup } from 'OAuth2Popup';<br/><br/>const Example = () =&gt; (<br/>	&lt;BrowserRouter&gt;<br/>		&lt;Routes&gt;<br/>			&lt;Route element={&lt;OAuthPopup /&gt;} path="/callback" /&gt;<br/>			&lt;Route element={&lt;Home /&gt;} path="/" /&gt;<br/>            {/* ... your other routes ... */}<br/>		&lt;/Routes&gt;<br/>	&lt;/BrowserRouter&gt;<br/>);</span></pre><p id="979e" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated">ç°åœ¨è®©æˆ‘ä»¬ç»§ç»­ Popup ç»„ä»¶ã€‚å®ƒéœ€è¦å¤„ç†ä¸‰ä»¶äº‹:</p><ol class=""><li id="1f2d" class="mv mw in kb b kc kd kg kh ly mx ma my mc mz kw nj nb nc nd bi translated">è¯»å– URL é‡å®šå‘å‚æ•°<code class="fe mi mj mk ml b">code</code>å’Œ<code class="fe mi mj mk ml b">state</code>ã€‚å¦‚æœå‡ºç°é”™è¯¯ï¼Œå°†ä¼šå‡ºç°ä¸€ä¸ª<code class="fe mi mj mk ml b">error</code>å‚æ•°ã€‚</li><li id="61bc" class="mv mw in kb b kc ne kg nf ly ng ma nh mc ni kw nj nb nc nd bi translated">æ£€æŸ¥<code class="fe mi mj mk ml b">state</code>å‚æ•°æ˜¯å¦ä¸æœ€åˆå‘é€ç»™è¯·æ±‚çš„å‚æ•°ç›¸åŒ¹é…ï¼›æˆ‘ä»¬ä»<em class="ka">ä¼šè¯å­˜å‚¨</em>ä¸­è¯»å–å‚æ•°ã€‚</li><li id="639f" class="mv mw in kb b kc ne kg nf ly ng ma nh mc ni kw nj nb nc nd bi translated">å‘çˆ¶çª—å£<a class="ae kx" href="https://developer.mozilla.org/en-US/docs/Web/API/Window/opener" rel="noopener ugc nofollow" target="_blank"> (window.opener) </a>åé¦ˆæˆæƒæˆåŠŸæˆ–å¤±è´¥ã€‚</li></ol><p id="999d" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated">ä¸ºäº†åœ¨<strong class="kb io">å¼¹å‡ºæ¡†</strong>å’Œå®ƒçš„<strong class="kb io">å¼€å¯å™¨</strong>ä¹‹é—´å»ºç«‹é€šä¿¡ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†<code class="fe mi mj mk ml b">window.opener.postMessage</code>å‡½æ•°ï¼Œè¯¥å‡½æ•°å‘<strong class="kb io">å¼€å¯å™¨</strong>å¯ä»¥ç›‘å¬çš„çª—å£å‘é€æ¶ˆæ¯ã€‚</p><p id="5f3b" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated">ä¸Šé¢çš„æ­¥éª¤è¢«ç¿»è¯‘æˆä¸‹é¢çš„ä»£ç :</p><pre class="me mf mg mh gt mm ml mn mo aw mp bi"><span id="0d4b" class="mq kz in ml b gy mr ms l mt mu">// OAuth2Popup.jsx<br/>import { useEffect } from 'react';<br/>import { queryToObject } from './tools';<br/><br/>const OAUTH_STATE_KEY = 'react-use-oauth2-state-key';<br/>const OAUTH_RESPONSE = 'react-use-oauth2-response';<br/><br/>const checkState = (receivedState) =&gt; {<br/>	const state = sessionStorage.getItem(OAUTH_STATE_KEY);<br/>	return state === receivedState;<br/>};<br/><br/>const queryToObject = (query) =&gt; {<br/>	const parameters = new URLSearchParams(query);<br/>	return Object.fromEntries(parameters.entries());<br/>};<br/><br/>const OAuthPopup = (props) =&gt; {<br/>	const {<br/>		Component = (<br/>			&lt;div style={{ margin: '12px' }} data-testid="popup-loading"&gt;<br/>				Loading...<br/>			&lt;/div&gt;<br/>		),<br/>	} = props;<br/><br/>	// On mount<br/>	useEffect(() =&gt; {<br/>		const payload = queryToObject(window.location.search.split('?')[1]);<br/>		const state = payload &amp;&amp; payload.state;<br/>		const error = payload &amp;&amp; payload.error;<br/><br/>		if (!window.opener) {<br/>			throw new Error('No window opener');<br/>		}<br/><br/>		if (error) {<br/>			window.opener.postMessage({<br/>				type: OAUTH_RESPONSE,<br/>				error: decodeURI(error) || 'OAuth error: An error has occured.',<br/>			});<br/>		} else if (state &amp;&amp; checkState(state)) {<br/>			window.opener.postMessage({<br/>				type: OAUTH_RESPONSE,<br/>				payload,<br/>			});<br/>		} else {<br/>			window.opener.postMessage({<br/>				type: OAUTH_RESPONSE,<br/>				error: 'OAuth error: State mismatch.',<br/>			});<br/>		}<br/>	}, []);<br/><br/>	return Component;<br/>};<br/><br/>export default OAuthPopup;</span></pre><p id="8265" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated"><strong class="kb io">æ­¥éª¤ 4:æ”¶å¬å¼¹å‡ºæ¶ˆæ¯</strong></p><p id="fe67" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated">è®©æˆ‘ä»¬å›åˆ°æˆ‘ä»¬çš„<code class="fe mi mj mk ml b">useOAuth2</code>é’©å­ã€‚</p><p id="62db" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated">æ‰“å¼€å¼¹å‡ºçª—å£åï¼Œæˆ‘ä»¬éœ€è¦æ³¨å†Œä¸€ä¸ª<strong class="kb io">æ¶ˆæ¯ç›‘å¬å™¨</strong>åˆ°çª—å£ï¼Œç›‘å¬æ¥è‡ªå¼¹å‡ºçª—å£çš„ä»»ä½•æ¶ˆæ¯ã€‚ä¸ºäº†åŒºåˆ«äºæ‰€æœ‰å…¶ä»–çª—å£æ¶ˆæ¯ï¼Œå¼¹å‡ºçª—å£å°†æ¶ˆæ¯ç±»å‹è®¾ç½®ä¸º<code class="fe mi mj mk ml b">react-use-oauth2-response</code>ã€‚</p><p id="5c51" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated">å¦‚æœå¼¹å‡ºçª—å£è¿”å›ä¸€ä¸ªé”™è¯¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬è®¾ç½®é€‚å½“çš„ UI çŠ¶æ€ï¼Œå¦åˆ™æˆ‘ä»¬å¾—åˆ°åŒ…å«<code class="fe mi mj mk ml b">code</code>å‚æ•°çš„æ¶ˆæ¯æœ‰æ•ˆè´Ÿè½½ã€‚</p><p id="31f2" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated">è¿˜æœ‰ä¸€ç§æƒ…å†µæ˜¯ï¼Œç”¨æˆ·åœ¨å®Œæˆæˆæƒä¹‹å‰å¼ºè¡Œå…³é—­äº†å¼¹å‡ºçª—å£ã€‚ä¸ºäº†æ•æ‰è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬è®¾ç½®äº†ä¸€ä¸ªæ—¶é—´é—´éš”ï¼Œå®šæœŸæ£€æŸ¥å¼¹å‡ºçª—å£æ˜¯å¦è¢«å¼ºåˆ¶å…³é—­ï¼Œå¦‚æœæ˜¯ï¼Œå®ƒä¼šæ‰§è¡Œä¸€äº›æ¸…ç†ä»»åŠ¡ï¼Œå¦‚é‡ç½® UIï¼Œåˆ é™¤æ¶ˆæ¯ç›‘å¬å™¨ç­‰ã€‚</p><pre class="me mf mg mh gt mm ml mn mo aw mp bi"><span id="0d31" class="mq kz in ml b gy mr ms l mt mu">// useOAuth2.js<br/>import { useCallback, useState } from 'react'; <br/><br/>const OAUTH_STATE_KEY = 'react-use-oauth2-state-key';<br/>const POPUP_HEIGHT = 700;<br/>const POPUP_WIDTH = 600;<br/>const OAUTH_RESPONSE = 'react-use-oauth2-response';<br/><br/>// https://medium.com/@dazcyril/generating-cryptographic-random-state-in-javascript-in-the-browser-c538b3daae50<br/>const generateState = () =&gt; {<br/>	const validChars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';<br/>	let array = new Uint8Array(40);<br/>	window.crypto.getRandomValues(array);<br/>	array = array.map((x) =&gt; validChars.codePointAt(x % validChars.length));<br/>	const randomState = String.fromCharCode.apply(null, array);<br/>	return randomState;<br/>};<br/><br/>const saveState = (state) =&gt; {<br/>	sessionStorage.setItem(OAUTH_STATE_KEY, state);<br/>};<br/><br/>const removeState = () =&gt; {<br/>	sessionStorage.removeItem(OAUTH_STATE_KEY);<br/>};<br/><br/>const openPopup = (url) =&gt; {<br/>	// To fix issues with window.screen in multi-monitor setups, the easier option is to<br/>	// center the pop-up over the parent window.<br/>	const top = window.outerHeight / 2 + window.screenY - POPUP_HEIGHT / 2;<br/>	const left = window.outerWidth / 2 + window.screenX - POPUP_WIDTH / 2;<br/>	return window.open(<br/>		url,<br/>		'OAuth2 Popup',<br/>		`height=${POPUP_HEIGHT},width=${POPUP_WIDTH},top=${top},left=${left}`<br/>	);<br/>};<br/><br/>const closePopup = (popupRef) =&gt; {<br/>	popupRef.current?.close();<br/>};<br/><br/>const cleanup = (<br/>	intervalRef,<br/>	popupRef,<br/>	handleMessageListener<br/>) =&gt; {<br/>	clearInterval(intervalRef.current);<br/>	closePopup(popupRef);<br/>	removeState();<br/>	window.removeEventListener('message', handleMessageListener);<br/>};<br/><br/>const enhanceAuthorizeUrl = (<br/>	authorizeUrl,<br/>	clientId,<br/>	redirectUri,<br/>	scope,<br/>	state<br/>) =&gt; {<br/>	return `${authorizeUrl}?response_type=code&amp;client_id=${clientId}&amp;redirect_uri=${redirectUri}&amp;scope=${scope}&amp;state=${state}`;<br/>};<br/><br/>const useOAuth2 = (props) =&gt; {<br/>  const {<br/>      authorizeUrl,<br/>      clientId,<br/>      redirectUri,<br/>      scope = '',<br/>    } = props;<br/><br/>  const popupRef = useRef();<br/>  const [{ loading, error }, setUI] = useState({ loading: false, error: null });<br/><br/>  const getAuth = useCallback(() =&gt; {<br/>      // 1. Init<br/>      setUI({<br/>        loading: true,<br/>        error: null,<br/>      });<br/><br/>      // 2. Generate and save state<br/>      const state = generateState();<br/>      saveState(state);<br/><br/>      // 3. Open popup<br/>      popupRef.current = openPopup(<br/>        enhanceAuthorizeUrl(authorizeUrl, clientId, redirectUri, scope, state)<br/>      );<br/><br/>      // 4. Register message listener<br/>      async function handleMessageListener(message) {<br/>        try {<br/>          const type = message &amp;&amp; message.data &amp;&amp; message.data.type;<br/>          if (type === OAUTH_RESPONSE) {<br/>            const errorMaybe = message &amp;&amp; message.data &amp;&amp; message.data.error;<br/>            if (errorMaybe) {<br/>              setUI({<br/>                loading: false,<br/>                error: errorMaybe || 'Unknown Error',<br/>              });<br/>            } else {<br/>              const code = message &amp;&amp; message.data &amp;&amp; message.data.payload &amp;&amp; message.data.payload.code;<br/>              // ... Check next step to see what we'll do with the code<br/>            }<br/>          }<br/>        } catch (genericError) {<br/>          console.error(genericError);<br/>          setUI({<br/>            loading: false,<br/>            error: genericError.toString(),<br/>          });<br/>        } finally {<br/>          // Clear stuff ...<br/>          cleanup(intervalRef, popupRef, handleMessageListener);<br/>        }<br/>      }<br/>      window.addEventListener('message', handleMessageListener);<br/><br/>      // 4. Begin interval to check if popup was closed forcefully by the user<br/>      intervalRef.current = setInterval(() =&gt; {<br/>        const popupClosed = !popupRef.current || !popupRef.current.window || popupRef.current.window.closed;<br/>        if (popupClosed) {<br/>          // Popup was closed before completing auth...<br/>          setUI((ui) =&gt; ({<br/>            ...ui,<br/>            loading: false,<br/>          }));<br/>          console.warn('Warning: Popup was closed before completing authentication.');<br/>          clearInterval(intervalRef.current);<br/>          removeState();<br/>          window.removeEventListener('message', handleMessageListener);<br/>        }<br/>      }, 250);<br/><br/>      // Remove listener(s) on unmount<br/>      return () =&gt; {<br/>        window.removeEventListener('message', handleMessageListener);<br/>        if (intervalRef.current) clearInterval(intervalRef.current);<br/>      };<br/>    })<br/>}</span></pre><p id="c2f6" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated"><strong class="kb io">æ­¥éª¤ 5:ç”¨æ¥å…¥ä»¤ç‰Œäº¤æ¢ä»£ç </strong></p><p id="fb49" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated">æœ€åä¸€æ­¥æ˜¯å°†æ”¶åˆ°çš„<code class="fe mi mj mk ml b">code</code>ä¸å®é™…çš„<code class="fe mi mj mk ml b">access_token</code>è¿›è¡Œäº¤æ¢ã€‚</p><p id="db80" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated">ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæœåŠ¡å™¨ï¼Œå› ä¸ºæˆ‘ä»¬ä¸èƒ½å°†<code class="fe mi mj mk ml b">client_secret</code>æš´éœ²ç»™å‰ç«¯åº”ç”¨ç¨‹åºã€‚ç„¶åï¼Œæˆ‘ä»¬çš„æœåŠ¡å™¨å°†å‘ç¬¬ä¸‰æ–¹æˆæƒæœåŠ¡å™¨<code class="fe mi mj mk ml b">/token</code>ç«¯ç‚¹å‘å‡º POST è¯·æ±‚ï¼Œä»¥å®é™…è·å–<code class="fe mi mj mk ml b">access_token</code>ã€‚</p><p id="8f54" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated">ä¾‹å¦‚ï¼Œå¯¹äºè°·æ­Œæ¥è¯´ï¼Œè¿™æ˜¯<code class="fe mi mj mk ml b">https://oauth2.googleapis.com/token</code>ã€‚å¦è¯·æ³¨æ„ï¼Œæ¯ä¸ªæä¾›å•†çš„è§„æ ¼å¯èƒ½æœ‰æ‰€ä¸åŒã€‚</p><p id="dcfa" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated">æˆ‘ä»¬éœ€è¦åˆ›å»ºçš„æœåŠ¡å™¨è·¯ç”±éå¸¸ç®€å•ã€‚ä¸ºäº†è¿™ä¸ªæ•™ç¨‹ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨<a class="ae kx" href="https://github.com/fastify/fastify" rel="noopener ugc nofollow" target="_blank"> fastify </a>æ¡†æ¶æ¥å®ç°å®ƒ:</p><pre class="me mf mg mh gt mm ml mn mo aw mp bi"><span id="ca2f" class="mq kz in ml b gy mr ms l mt mu">// server.js<br/>import Fastify from 'fastify';<br/>import fetch from 'node-fetch';<br/><br/>const fastify = Fastify({<br/>	logger: true,<br/>});<br/><br/>const CLIENT_SECRET = process.env.CLIENT_SECRET;<br/>const AUTHORIZATION_SERVER_TOKEN_URL = process.env.AUTHORIZATION_SERVER_TOKEN_URL; // e.g https://oauth2.googleapis.com/token<br/><br/>fastify.post('/token', async (request, reply) =&gt; {<br/>	const { code, client_id, redirect_uri } = request.query;<br/><br/>	const data = await fetch(<br/>		`${AUTHORIZATION_SERVER_TOKEN_URL}?grant_type=authorization_code&amp;client_id=${client_id}&amp;client_secret=${CLIENT_SECRET}&amp;redirect_uri=${redirect_uri}&amp;code=${code}`,<br/>		{<br/>			method: 'POST',<br/>		}<br/>	);<br/><br/>	reply.send(await data.json());<br/>});<br/><br/>fastify.listen(3001, (error) =&gt; {<br/>	if (error) throw error;<br/>});</span><span id="98ed" class="mq kz in ml b gy nk ms l mt mu">// useOAuth2.js<br/>import { useCallback, useState } from 'react'; <br/><br/>const OAUTH_STATE_KEY = 'react-use-oauth2-state-key';<br/>const POPUP_HEIGHT = 700;<br/>const POPUP_WIDTH = 600;<br/>const OAUTH_RESPONSE = 'react-use-oauth2-response';<br/><br/>// https://medium.com/@dazcyril/generating-cryptographic-random-state-in-javascript-in-the-browser-c538b3daae50<br/>const generateState = () =&gt; {<br/>	const validChars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';<br/>	let array = new Uint8Array(40);<br/>	window.crypto.getRandomValues(array);<br/>	array = array.map((x) =&gt; validChars.codePointAt(x % validChars.length));<br/>	const randomState = String.fromCharCode.apply(null, array);<br/>	return randomState;<br/>};<br/><br/>const saveState = (state) =&gt; {<br/>	sessionStorage.setItem(OAUTH_STATE_KEY, state);<br/>};<br/><br/>const removeState = () =&gt; {<br/>	sessionStorage.removeItem(OAUTH_STATE_KEY);<br/>};<br/><br/>const openPopup = (url) =&gt; {<br/>	// To fix issues with window.screen in multi-monitor setups, the easier option is to<br/>	// center the pop-up over the parent window.<br/>	const top = window.outerHeight / 2 + window.screenY - POPUP_HEIGHT / 2;<br/>	const left = window.outerWidth / 2 + window.screenX - POPUP_WIDTH / 2;<br/>	return window.open(<br/>		url,<br/>		'OAuth2 Popup',<br/>		`height=${POPUP_HEIGHT},width=${POPUP_WIDTH},top=${top},left=${left}`<br/>	);<br/>};<br/><br/>const closePopup = (popupRef) =&gt; {<br/>	popupRef.current?.close();<br/>};<br/><br/>const cleanup = (<br/>	intervalRef,<br/>	popupRef,<br/>	handleMessageListener<br/>) =&gt; {<br/>	clearInterval(intervalRef.current);<br/>	closePopup(popupRef);<br/>	removeState();<br/>	window.removeEventListener('message', handleMessageListener);<br/>};<br/><br/>const enhanceAuthorizeUrl = (<br/>	authorizeUrl,<br/>	clientId,<br/>	redirectUri,<br/>	scope,<br/>	state<br/>) =&gt; {<br/>	return `${authorizeUrl}?response_type=code&amp;client_id=${clientId}&amp;redirect_uri=${redirectUri}&amp;scope=${scope}&amp;state=${state}`;<br/>};<br/><br/>const objectToQuery = (object) =&gt; {<br/>	return new URLSearchParams(object).toString();<br/>};<br/><br/>const formatExchangeCodeForTokenServerURL = (<br/>	serverUrl,<br/>	clientId,<br/>	code,<br/>	redirectUri<br/>) =&gt; {<br/>	return `${serverUrl}?${objectToQuery({<br/>		client_id: clientId,<br/>		code,<br/>		redirect_uri: redirectUri,<br/>	})}`;<br/>};<br/><br/>const useOAuth2 = (props) =&gt; {<br/>  const {<br/>      authorizeUrl,<br/>      clientId,<br/>      redirectUri,<br/>      scope = '',<br/>    } = props;<br/><br/>  const popupRef = useRef();<br/>  const [{ loading, error }, setUI] = useState({ loading: false, error: null });<br/><br/>  const getAuth = useCallback(() =&gt; {<br/>      // 1. Init<br/>      setUI({<br/>        loading: true,<br/>        error: null,<br/>      });<br/><br/>      // 2. Generate and save state<br/>      const state = generateState();<br/>      saveState(state);<br/><br/>      // 3. Open popup<br/>      popupRef.current = openPopup(<br/>        enhanceAuthorizeUrl(authorizeUrl, clientId, redirectUri, scope, state)<br/>      );<br/><br/>      // 4. Register message listener<br/>      async function handleMessageListener(message) {<br/>        try {<br/>          const type = message &amp;&amp; message.data &amp;&amp; message.data.type;<br/>          if (type === OAUTH_RESPONSE) {<br/>            const errorMaybe = message &amp;&amp; message.data &amp;&amp; message.data.error;<br/>            if (errorMaybe) {<br/>              setUI({<br/>                loading: false,<br/>                error: errorMaybe || 'Unknown Error',<br/>              });<br/>            } else {<br/>              const code = message &amp;&amp; message.data &amp;&amp; message.data.payload &amp;&amp; message.data.payload.code;<br/>              const response = await fetch(<br/>                formatExchangeCodeForTokenServerURL(<br/>                  'https://your-server.com/token',<br/>                  clientId,<br/>                  code,<br/>                  redirectUri<br/>                )<br/>              );<br/>              if (!response.ok) {<br/>                setUI({<br/>                  loading: false,<br/>                  error: "Failed to exchange code for token",<br/>                });<br/>              } else {<br/>                payload = await response.json();<br/>                setUI({<br/>                  loading: false,<br/>                  error: null,<br/>                });<br/>                setData(payload);<br/>                // Lines above will cause 2 rerenders but it's fine for this tutorial :-)<br/>              }<br/>            }<br/>          }<br/>        } catch (genericError) {<br/>          console.error(genericError);<br/>          setUI({<br/>            loading: false,<br/>            error: genericError.toString(),<br/>          });<br/>        } finally {<br/>          // Clear stuff ...<br/>          cleanup(intervalRef, popupRef, handleMessageListener);<br/>        }<br/>      }<br/>      window.addEventListener('message', handleMessageListener);<br/><br/>      // 4. Begin interval to check if popup was closed forcefully by the user<br/>      intervalRef.current = setInterval(() =&gt; {<br/>        const popupClosed = !popupRef.current || !popupRef.current.window || popupRef.current.window.closed;<br/>        if (popupClosed) {<br/>          // Popup was closed before completing auth...<br/>          setUI((ui) =&gt; ({<br/>            ...ui,<br/>            loading: false,<br/>          }));<br/>          console.warn('Warning: Popup was closed before completing authentication.');<br/>          clearInterval(intervalRef.current);<br/>          removeState();<br/>          window.removeEventListener('message', handleMessageListener);<br/>        }<br/>		  }, 250);<br/><br/>      // Remove listener(s) on unmount<br/>      return () =&gt; {<br/>        window.removeEventListener('message', handleMessageListener);<br/>        if (intervalRef.current) clearInterval(intervalRef.current);<br/>      };<br/>    })<br/>}</span></pre><h1 id="67e2" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">ç»“æŸäº†</h1><p id="7d09" class="pw-post-body-paragraph jy jz in kb b kc lw ke kf kg lx ki kj ly lz km kn ma mb kq kr mc md ku kv kw ig bi translated">æˆ‘å¸Œæœ›ä½ å‘ç°è¿™ç¯‡æ–‡ç« ä¿¡æ¯ä¸°å¯Œã€‚ğŸ™‚</p><p id="67fb" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated">åœ¨æ¥ä¸‹æ¥çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†è¯¦ç»†è®¨è®ºå¦‚ä½•ä½¿ç”¨ Google OAuth2 å’Œ Google APIs æ¥è·å–ç”¨æˆ·ä¿¡æ¯ã€‚</p><p id="7ccc" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated">æ•¬è¯·æœŸå¾…ï¼</p></div><div class="ab cl nl nm hr nn" role="separator"><span class="no bw bk np nq nr"/><span class="no bw bk np nq nr"/><span class="no bw bk np nq"/></div><div class="ig ih ii ij ik"><p id="39dc" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ly kl km kn ma kp kq kr mc kt ku kv kw ig bi translated"><em class="ka">åŸè½½äº</em><a class="ae kx" href="https://tasoskakour.com/blog/react-use-oauth2" rel="noopener ugc nofollow" target="_blank"><em class="ka">https://tasoskakour.com</em></a><em class="ka">ã€‚</em></p></div></div>    
</body>
</html>