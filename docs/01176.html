<html>
<head>
<title>Async Image Loading â€”Itâ€™s Combine Way</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">å¼‚æ­¥å›¾åƒåŠ è½½â€”â€”è¿™æ˜¯ä¸€ç§ç»„åˆæ–¹å¼</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://blog.devgenius.io/async-image-loading-its-combine-way-be203eae12f7?source=collection_archive---------1-----------------------#2020-06-26">https://blog.devgenius.io/async-image-loading-its-combine-way-be203eae12f7?source=collection_archive---------1-----------------------#2020-06-26</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/c63b0fc871086edc6d2a851e784be082.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j7aGijN5HTrkdp8wyJ_24g.jpeg"/></div></div></figure><p id="cf3a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">è‹¹æœåœ¨2019å¹´WWDCå‘å¸ƒäº†SwiftUIå’ŒCombineæ¡†æ¶ã€‚ä»é‚£ä»¥åï¼Œå®ƒæ”¹å˜äº†ç¼–ç çš„æ–¹å¼ã€‚æˆ‘ä»¬çŸ¥é“å¦‚ä½•ä»è¿œç¨‹URLä¸‹è½½å¹¶æ˜¾ç¤ºå›¾åƒã€‚æˆ‘ç›¸ä¿¡æˆ‘ä»¬å·²ç»è¿™æ ·åšäº†ä¸€åƒæ¬¡äº†ã€‚æœ‰äº›å¼€å‘äººå‘˜ä½¿ç”¨å†…ç½®æ¡†æ¶æ¥å®Œæˆè¿™é¡¹ä»»åŠ¡ï¼Œæœ‰äº›å¼€å‘äººå‘˜åˆ™è‡ªè¡Œå®ç°ã€‚</p><p id="c6ec" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">æˆ‘ä»¬å°†ä»è¿œç¨‹URLä¸‹è½½ä¸€ä¸ªå›¾åƒï¼Œå¹¶åœ¨SwiftUI Imageä¸­æ˜¾ç¤ºè¯¥å›¾åƒã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬å°†å€ŸåŠ©Combine frameworkæ¥å¤„ç†ä»URLSession dataTaskæ¥æ”¶çš„æ•°æ®ï¼Œå¹¶åœ¨SwiftUIä¸­å‘ˆç°è¯¥å›¾åƒã€‚æˆ‘å¸Œæœ›ä½ å¯¹SwiftUIå’ŒCombineæ¡†æ¶æœ‰æ‰€äº†è§£ã€‚è®©æˆ‘ä»¬å¼€å§‹å§â€¦</p><h1 id="92ad" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">å…¥é—¨æŒ‡å—</h1><p id="b094" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªSwiftUIæ–‡ä»¶ï¼Œå¹¶å°†å…¶å‘½åä¸ºAsyncWebImageViewã€‚è¿™é‡Œæˆ‘ä»¬å°†æ¸²æŸ“ä¸‹è½½çš„å›¾åƒã€‚</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="899d" class="mf ku in mb b gy mg mh l mi mj">import SwiftUI</span><span id="27ef" class="mf ku in mb b gy mk mh l mi mj"><br/>struct AsyncWebImageView: View {<br/>    private var url: URL<br/>    private var placeHolder: Image</span><span id="cfdd" class="mf ku in mb b gy mk mh l mi mj">    init(url: URL, placeHolder: Image) {<br/>        self.url = url<br/>        self.placeHolder = placeHolder<br/>    }</span><span id="26d0" class="mf ku in mb b gy mk mh l mi mj">    var body: some View {<br/>        placeHolder<br/>            .resizable()<br/>            .onAppear { }<br/>            .onDisappear { }<br/>    }</span><span id="bb5c" class="mf ku in mb b gy mk mh l mi mj">}</span></pre><p id="2800" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">ç°åœ¨æ˜¯æ—¶å€™è®¾è®¡<em class="ml"> AsyncImageBinder </em>ç±»äº†ã€‚è¿™ä¸ªè°ƒç”¨å°†è´Ÿè´£ä¸‹è½½å’Œç¼“å­˜å›¾åƒã€‚è¿™é‡Œæˆ‘å°†ä½¿ç”¨Combineæ¡†æ¶ã€‚</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="0769" class="mf ku in mb b gy mg mh l mi mj">import Foundation<br/>import Combine<br/>import UIKit</span><span id="b732" class="mf ku in mb b gy mk mh l mi mj">// 1<br/>class AsyncImageBinder: ObservableObject {       <br/>    private var subscription: AnyCancellable?</span><span id="17cb" class="mf ku in mb b gy mk mh l mi mj">    // 2<br/>    @Published private(set) var image: UIImage?<br/></span><span id="a938" class="mf ku in mb b gy mk mh l mi mj">    // 3    <br/>    func load(url: URL) {<br/>        //do something<br/>    }</span><span id="f36b" class="mf ku in mb b gy mk mh l mi mj">    // 4<br/>    func cancel() {<br/>        // do something<br/>    }</span><span id="127e" class="mf ku in mb b gy mk mh l mi mj">}</span></pre><p id="5fd0" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">æˆ‘ä»¬çŸ¥é“è”åˆæ”¶å‰²æœºæœ‰ä¸¤ä¸ªç»„æˆéƒ¨åˆ†ã€‚å³<em class="ml">å‘å¸ƒè€…</em>å’Œ<em class="ml">è®¢é˜…è€…ã€‚<br/> </em>å‘å¸ƒè€…å‘å¸ƒå€¼ï¼Œè®¢é˜…è€…æ¥æ”¶å€¼ã€‚</p><ol class=""><li id="3785" class="mm mn in jx b jy jz kc kd kg mo kk mp ko mq ks mr ms mt mu bi translated">è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº†<em class="ml"> ObservableObject </em>åè®®ã€‚è¿™æ˜¯ä½¿æ¨¡å‹å¯è§‚å¯Ÿçš„ç»¼åˆæ–¹æ³•ã€‚</li><li id="5641" class="mm mn in jx b jy mv kc mw kg mx kk my ko mz ks mr ms mt mu bi translated">æˆ‘ä»¬ä½¿ç”¨äº†å¸¦æœ‰å›¾åƒå±æ€§çš„å·²å‘å¸ƒå±æ€§åŒ…è£…ã€‚æ¯å½“æˆ‘ä»¬æ›´æ–°å›¾åƒçš„å€¼æ—¶ï¼Œå®ƒéƒ½ä¼šé€šçŸ¥è®¢é˜…è€…ã€‚</li><li id="c23b" class="mm mn in jx b jy mv kc mw kg mx kk my ko mz ks mr ms mt mu bi translated"><em class="ml"> load(url:) </em>æ–¹æ³•å°†ä»è¿œç¨‹urlè·å–å›¾åƒã€‚</li><li id="cb1e" class="mm mn in jx b jy mv kc mw kg mx kk my ko mz ks mr ms mt mu bi translated"><em class="ml">å–æ¶ˆ</em>æ–¹æ³•ä¼šåœ¨æˆ‘ä»¬ä¸æƒ³åœ¨UIä¸­æ¸²æŸ“å›¾åƒçš„æ—¶å€™å–æ¶ˆè®¢é˜…ã€‚</li></ol><h2 id="1444" class="mf ku in bd kv na nb dn kz nc nd dp ld kg ne nf lh kk ng nh ll ko ni nj lp nk bi translated">ä»è¿œç¨‹URLè·å–å›¾åƒ</h2><p id="5bb0" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">è®©æˆ‘ä»¬åœ¨load(url:)æ–¹æ³•ä¸­å®ç°å›¾åƒä¸‹è½½ä»£ç ã€‚</p><p id="4b01" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">å¼•å…¥Combineä¹‹åï¼ŒURLSessionåˆå¢åŠ äº†ä¸¤ä¸ªå®ä¾‹æ–¹æ³•ã€‚ä»–ä»¬æ˜¯</p><ol class=""><li id="1193" class="mm mn in jx b jy jz kc kd kg mo kk mp ko mq ks mr ms mt mu bi translated">dataTaskPublisher(å¯¹äºurl: URL) -&gt; URLSessionã€‚DataTaskPublisher</li><li id="bf03" class="mm mn in jx b jy mv kc mw kg mx kk my ko mz ks mr ms mt mu bi translated">dataTaskPublisher(for request:URL request)-&gt; URL sessionã€‚DataTaskPublisher</li></ol><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="ea80" class="mf ku in mb b gy mg mh l mi mj">func load(url: URL) {<br/>    subscription = URLSession.shared<br/>                       .dataTaskPublisher(for: url)      // 1<br/>                       .map { UIImage(data: $0.data) }   // 2<br/>                       .replaceError(with: nil)          // 3<br/>                       .receive(on: DispatchQueue.main)  // 4<br/>                       .assign(to: \.image, on: self)    // 5</span><span id="49f3" class="mf ku in mb b gy mk mh l mi mj">}</span><span id="ec58" class="mf ku in mb b gy mk mh l mi mj">func cancel() {<br/>    subscription?.cancel()<br/>}</span></pre><p id="0703" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">æ˜¯ä¸æ˜¯å¾ˆé…·ï¼ï¼ï¼</p><p id="f337" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">æˆ‘ä»¬åªéœ€è¦å†™è¿™ä¹ˆå¤šä»£ç æ¥ä»è¿œç¨‹URLè·å–å›¾åƒã€‚è®©æˆ‘ä»¬æ˜ç™½æˆ‘ä»¬åœ¨åšä»€ä¹ˆã€‚</p><ol class=""><li id="0e64" class="mm mn in jx b jy jz kc kd kg mo kk mp ko mq ks mr ms mt mu bi translated">dataTaskPublisher(å¯¹äºurl: URL)ä¼šç»™æˆ‘ä»¬URLSession.DataTaskPublisher .æˆ‘ä»¬çŸ¥é“ï¼Œæ¯ä¸ªPublisheréƒ½æœ‰ä¸¤ä¸ªå…³è”çš„ç±»å‹ã€‚å®ƒä»¬æ˜¯è¾“å‡ºå’Œå¤±è´¥(é”™è¯¯)ã€‚æ‰€ä»¥URLSessionçš„è¾“å‡ºã€‚DataTaskPublisheræœ‰æ•°æ®å’Œå“åº”ã€‚æˆ‘ä»¬éœ€è¦å¤„ç†æ•°æ®ã€‚æ‰€ä»¥æˆ‘ä»¬åœ¨è¿™ä¸ªå‘å¸ƒå™¨ä¸Šæ¨å‡ºäº†ä¸€ç³»åˆ—çš„æ“ä½œã€‚</li><li id="db58" class="mm mn in jx b jy mv kc mw kg mx kk my ko mz ks mr ms mt mu bi translated">mapå°†å°è¯•ä»æ•°æ®ä¸­è·å–UIImageã€‚</li><li id="529f" class="mm mn in jx b jy mv kc mw kg mx kk my ko mz ks mr ms mt mu bi translated">å¦‚æœæˆ‘ä»¬æ— æ³•è·å–å›¾åƒæ•°æ®å¹¶ä»¥é”™è¯¯ç»“æŸï¼ŒreplaceError(with:)å°†ç”¨nilæ›¿æ¢é”™è¯¯ã€‚</li><li id="4a53" class="mm mn in jx b jy mv kc mw kg mx kk my ko mz ks mr ms mt mu bi translated">æ ¹æ®å¤šçº¿ç¨‹è§„åˆ™ï¼Œæˆ‘ä»¬åº”è¯¥åªåœ¨ä¸»çº¿ç¨‹ä¸Šæ›´æ–°UIã€‚è¿™é‡Œæˆ‘ä»¬å°†åœ¨ä¸»çº¿ç¨‹ä¸Šæ¥æ”¶ã€‚</li><li id="c4db" class="mm mn in jx b jy mv kc mw kg mx kk my ko mz ks mr ms mt mu bi translated">è¿™é‡Œæˆ‘ä»¬å°†æŠŠæ¥æ”¶åˆ°çš„å€¼èµ‹ç»™å›¾åƒå±æ€§ã€‚</li></ol><h2 id="7e1d" class="mf ku in bd kv na nb dn kz nc nd dp ld kg ne nf lh kk ng nh ll ko ni nj lp nk bi translated">åœ¨ç”¨æˆ·ç•Œé¢ä¸­æ¸²æŸ“å›¾åƒ</h2><p id="87e9" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">ç°åœ¨æ˜¯æ—¶å€™æ›´æ–°AsyncWebImageViewæ¥åœ¨è¿™é‡Œå‘ˆç°ä¸‹è½½çš„å›¾åƒäº†ã€‚</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="fe94" class="mf ku in mb b gy mg mh l mi mj">struct AsyncWebImageView: View {<br/>    // ...</span><span id="9d2b" class="mf ku in mb b gy mk mh l mi mj">    // 1<br/>    @ObservedObject var binder = AsyncImageBinder() </span><span id="dae0" class="mf ku in mb b gy mk mh l mi mj"><br/>    init(url: URL, placeHolder: Image) {<br/>        // ...</span><span id="4e7a" class="mf ku in mb b gy mk mh l mi mj">        // 2<br/>        self.binder.load(url: self.url)<br/>    }</span><span id="4b3b" class="mf ku in mb b gy mk mh l mi mj">    var body: some View {<br/>        VStack {<br/>            // 3<br/>            if binder.image != nil {<br/>                Image(uiImage: binder.image!)<br/>                    .renderingMode(.original)<br/>                    .resizable()<br/>            } else {<br/>                placeHolder<br/>            }<br/>        }<br/>        .onAppear {  }<br/>        .onDisappear { self.binder.cancel() }<br/>    <br/>    }</span><span id="67eb" class="mf ku in mb b gy mk mh l mi mj">}</span></pre><p id="afb3" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">è®©æˆ‘ä»¬äº†è§£ä¸€ä¸‹è¿™æ˜¯æ€ä¹ˆå›äº‹â€¦</p><ol class=""><li id="c09d" class="mm mn in jx b jy jz kc kd kg mo kk mp ko mq ks mr ms mt mu bi translated">ObservedObjectå±æ€§åŒ…è£…ç±»å‹è®¢é˜…å¯è§‚å¯Ÿç±»å‹å¯¹è±¡ã€‚æ‰€ä»¥ï¼Œæ¯å½“æˆ‘ä»¬è¦æ”¹å˜<em class="ml"> AsyncImageBinderç±»</em>çš„imageå±æ€§çš„å€¼æ—¶ï¼Œ<em class="ml"> AsyncWebImageView </em>å°±ä¼šè¢«é€šçŸ¥è¿™ä¸ªæ”¹å˜ã€‚</li><li id="5d2d" class="mm mn in jx b jy mv kc mw kg mx kk my ko mz ks mr ms mt mu bi translated">æˆ‘ä»¬æ­£åœ¨è°ƒç”¨<em class="ml"> AsyncImageBinderçš„load(url:)æ–¹æ³•ã€‚</em></li><li id="2990" class="mm mn in jx b jy mv kc mw kg mx kk my ko mz ks mr ms mt mu bi translated">è¿™é‡Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸€ä¸ªæ¡ä»¶æ“ä½œã€‚å¦‚æœimageå±æ€§çš„å€¼ä¸ºé›¶ï¼Œæˆ‘ä»¬å°†æ˜¾ç¤ºå ä½ç¬¦å›¾åƒã€‚</li></ol><h2 id="508e" class="mf ku in bd kv na nb dn kz nc nd dp ld kg ne nf lh kk ng nh ll ko ni nj lp nk bi translated">è®©æˆ‘ä»¬çœ‹çœ‹ç»“æœ</h2><p id="af83" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">ç°åœ¨æ˜¯æ—¶å€™çœ‹çœ‹æˆ‘ä»¬åˆ°ç›®å‰ä¸ºæ­¢éƒ½åšäº†äº›ä»€ä¹ˆã€‚æˆ‘ä»¬å°†åœ¨é¢„è§ˆä¸­çœ‹åˆ°è¿™äº›å˜åŒ–ã€‚è®©æˆ‘ä»¬åœ¨<em class="ml"> AsyncWebImageView </em>ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç </p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="bbcd" class="mf ku in mb b gy mg mh l mi mj">struct AsyncWebImageView_Previews: PreviewProvider {<br/>    static let url = URL(string: "https://image.tmdb.org/t/p/original/cDbOrc2RtIA37nLm0CzVpFLrdaG.jpg")!</span><span id="fafc" class="mf ku in mb b gy mk mh l mi mj"><br/>    static var previews: some View {<br/>        AsyncWebImageView(url: url)<br/>    }</span><span id="7387" class="mf ku in mb b gy mk mh l mi mj">}</span></pre><p id="946a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">è¿™æ˜¯æˆ‘ä»¬å°†åœ¨é¢„è§ˆä¸­çœ‹åˆ°çš„ã€‚</p><figure class="lw lx ly lz gt jo gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/d07cae0be86d80b287e0524ecc147e5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:790/format:webp/1*rG7SaeLW9jHoE8IboaMrbg.png"/></div><figcaption class="nm nn gj gh gi no np bd b be z dk translated">è¿™æ˜¯ä»é¢„è§ˆä¸­æ•è·çš„å›¾åƒ</figcaption></figure><h2 id="7bc7" class="mf ku in bd kv na nb dn kz nc nd dp ld kg ne nf lh kk ng nh ll ko ni nj lp nk bi translated">ç¼“å­˜å›¾åƒ</h2><p id="1185" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªAsyncImageCacheç±»ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†NSCacheæ¥å­˜å‚¨å›¾åƒã€‚</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="2a47" class="mf ku in mb b gy mg mh l mi mj">class AsyncImageCache {<br/>    <br/>    // 1<br/>    static let shared = AsyncImageCache()</span><span id="9128" class="mf ku in mb b gy mk mh l mi mj">    // 2<br/>    private var cache: NSCache = NSCache&lt;NSString, UIImage&gt;()</span><span id="02f7" class="mf ku in mb b gy mk mh l mi mj">    // 3<br/>    subscript(key: String) -&gt; UIImage? {<br/>        get { cache.object(forKey: key as NSString) }<br/>        set(image) { image == nil ? self.cache.removeObject(forKey: (key as NSString)) : self.cache.setObject(image!, forKey: (key as NSString)) }</span><span id="9626" class="mf ku in mb b gy mk mh l mi mj">    }</span><span id="7426" class="mf ku in mb b gy mk mh l mi mj">}</span></pre><p id="a955" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">è®©æˆ‘ä»¬æ˜ç™½æˆ‘ä»¬åœ¨åšä»€ä¹ˆã€‚</p><ol class=""><li id="feff" class="mm mn in jx b jy jz kc kd kg mo kk mp ko mq ks mr ms mt mu bi translated">æˆ‘ä»¬å°†åˆ›å»ºå•ä¾‹ã€‚Singletonå°†ç¡®ä¿AsyncImageCacheåªæœ‰ä¸€ä¸ªå…¥å£ç‚¹ã€‚å½“æˆ‘ä»¬åœ¨ä¸€ä¸ªåˆ—è¡¨ä¸­ä½¿ç”¨å¤šä¸ª<em class="ml"> AsyncWebImageView </em>æ—¶ï¼Œè¿™å°†å¯¹æˆ‘ä»¬å¾ˆæœ‰å¸®åŠ©ã€‚</li><li id="9d96" class="mm mn in jx b jy mv kc mw kg mx kk my ko mz ks mr ms mt mu bi translated">æˆ‘ä»¬å°†æœ‰ä¸€ä¸ªNSCacheå®ä¾‹ã€‚</li><li id="b9fb" class="mm mn in jx b jy mv kc mw kg mx kk my ko mz ks mr ms mt mu bi translated">NSCacheæ˜¯ä¸€ä¸ªå¯å˜çš„é›†åˆï¼Œæˆ‘ä»¬å°†æ•°æ®ä¸´æ—¶å­˜å‚¨åœ¨ä¸€ä¸ªé”®å€¼å¯¹ä¸­ã€‚æˆ‘ä»¬çŸ¥é“ä¸‹æ ‡ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç§ä»é›†åˆä¸­è®¿é—®æ•°æ®çš„å¿«æ·æ–¹å¼ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸‹æ ‡ã€‚</li></ol><p id="5928" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">ç°åœ¨æ˜¯æ—¶å€™æ›´æ–°AsyncImageBinder ç±»äº†ã€‚</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="8481" class="mf ku in mb b gy mg mh l mi mj">//...</span><span id="31d7" class="mf ku in mb b gy mk mh l mi mj">private var cache = AsyncImageCache.shared</span><span id="98af" class="mf ku in mb b gy mk mh l mi mj">//...</span><span id="33ad" class="mf ku in mb b gy mk mh l mi mj">func load(url: URL) {<br/>    // 1<br/>if let image: UIImage = cache[url.absoluteString] {<br/>        self.image = image<br/>        return<br/>    }<br/>    </span><span id="7b47" class="mf ku in mb b gy mk mh l mi mj">    subscription = URLSession.shared.dataTaskPublisher(for: url)<br/>                       .map { UIImage(data: $0.data) }<br/>                       .replaceError(with: nil)<br/>                       .handleEvents(receiveOutput: { self.cache[url.absoluteString] = $0 })                 // 2<br/>                       .receive(on: DispatchQueue.main)<br/>                       .assign(to: \.image, on: self)</span><span id="8cdf" class="mf ku in mb b gy mk mh l mi mj">}</span></pre><ol class=""><li id="7f45" class="mm mn in jx b jy jz kc kd kg mo kk mp ko mq ks mr ms mt mu bi translated">åœ¨ä»è¿œç¨‹URLè·å–å›¾åƒä¹‹å‰ï¼Œæˆ‘ä»¬å°†æ£€æŸ¥æ˜¯å¦å·²å°†å›¾åƒå­˜å‚¨åœ¨ç‰¹å®šURLçš„NSCacheä¸­ã€‚å¦‚æœæœ‰ï¼Œæˆ‘ä»¬å°†ä»NSCacheè·å–å›¾åƒå¹¶æ›´æ–°å›¾åƒå±æ€§ã€‚</li><li id="f8a0" class="mm mn in jx b jy mv kc mw kg mx kk my ko mz ks mr ms mt mu bi translated">å‘å¸ƒè€…çš„handleEventsæ“ä½œå¸®åŠ©æˆ‘ä»¬è·Ÿè¸ªå‘å¸ƒè€…çš„äº‹ä»¶ã€‚åœ¨receiveOutputäº‹ä»¶ä¸­ï¼Œæˆ‘ä»¬å°†å›¾åƒå­˜å‚¨åœ¨NSCacheä¸­ã€‚</li></ol><p id="1918" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">é…·â€¦</p><h1 id="ede6" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">ç»“è®º</h1><p id="bc42" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">ç»„åˆæ¡†æ¶éå¸¸å¼ºå¤§ã€‚å®ƒæä¾›äº†ä¸€ç§æ›´ç®€å•çš„æ–¹æ³•æ¥å®Œæˆå¼‚æ­¥ä»»åŠ¡ã€‚</p></div><div class="ab cl nq nr hr ns" role="separator"><span class="nt bw bk nu nv nw"/><span class="nt bw bk nu nv nw"/><span class="nt bw bk nu nv"/></div><div class="ig ih ii ij ik"><p id="bebe" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">æ„Ÿè°¢é˜…è¯»ã€‚å¸Œæœ›ä½ å–œæ¬¢å®ƒã€‚éšæ„è¯„è®ºã€‚</p><p id="275b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">å¦‚æœä½ è§‰å¾—è¿™ç¯‡æ–‡ç« æœ‰å¸®åŠ©ï¼Œè¯·é¼“æŒï¼Œä½ çŸ¥é“æ¯ä¸ªäººå¯ä»¥é¼“æŒ50æ¬¡ğŸ˜‰ï¼Œå¹¶é¼“åŠ±æˆ‘è¿›ä¸€æ­¥å†™æ›´å¤šçš„æ–‡ç« ã€‚</p></div></div>    
</body>
</html>