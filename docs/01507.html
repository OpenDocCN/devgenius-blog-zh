<html>
<head>
<title>Creating sound from scratch with Go</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Go从头开始创建声音</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/creating-sound-from-scratch-with-go-9cef90b62370?source=collection_archive---------6-----------------------#2020-07-05">https://blog.devgenius.io/creating-sound-from-scratch-with-go-9cef90b62370?source=collection_archive---------6-----------------------#2020-07-05</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="c51a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在本帖中，我们将使用Go从头开始创建声音(二进制格式)。这个帖子的最终结果是播放一个特定频率、采样率和持续时间的声音。我们还将应用指数衰减，使声音逐渐减弱。最后，声音应该变成这个视频中的声音:</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="kn ko l"/></div></figure><h1 id="e20b" class="kp kq in bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">第一步:什么声音？</h1><p id="d0a8" class="pw-post-body-paragraph jk jl in jm b jn ln jp jq jr lo jt ju jv lp jx jy jz lq kb kc kd lr kf kg kh ig bi translated">最简单的形式是，声音对计算机来说可以被认为是一种简单的数字编码波。在声音到达您的耳朵之前，它会经过一个数模转换器，本质上是将数字信号转换为耳机/扬声器的电流。</p><p id="2a4d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">例如，注释A如下所示:</p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div class="gh gi ls"><img src="../Images/70be74050992efdd1b6c58c43a920c07.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/format:webp/0*RiOG40oPkzCyiL6V.png"/></div><figcaption class="lv lw gj gh gi lx ly bd b be z dk translated"><a class="ae lz" href="http://www-users.math.umn.edu/~rogness/math1155/soundwaves/" rel="noopener ugc nofollow" target="_blank">http://www-users.math.umn.edu/~rogness/math1155/soundwaves/</a></figcaption></figure><p id="93e3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">第一步，让我们试着用go创建一个正弦波。</p><p id="064a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们可以使用<code class="fe ma mb mc md b">math.Sin(x)</code>生成它，并将x作为弧度传递。我们将不得不在一个范围内迭代以得到正弦波。为了停留在音频编程的领域，我们将绘制到正弦波的“点”的数量是我们的样本。</p><p id="05a0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">(如果你想跳过前面，这篇文章的所有代码都在github:<a class="ae lz" href="https://github.com/DylanMeeus/MediumCode/blob/master/Audio/FirstSound/main.go" rel="noopener ugc nofollow" target="_blank">https://github.com/DylanMeeus/MediumCode/blob/master/Audio</a>)</p><pre class="ki kj kk kl gt me md mf mg aw mh bi"><span id="e32e" class="mi kq in md b gy mj mk l ml mm">const nsamps = 50 // samples to generate<br/>func generate() {<br/>     tau = math.Pi * 2<br/>     var angle float64 = tau / nsamps<br/>     for i := 0; i &lt; nsamps; i++ {<br/>         samp = math.Sin(angle * float64(i))<br/>         fmt.Printf("%.8f\n", samp)<br/>     }<br/>}</span></pre><p id="a37f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">注意，我们将样本打印到stdout，我们可以将这个输出通过管道传输到一个文件(<code class="fe ma mb mc md b">go run main.go &gt; out.txt</code>)。该文件中的输出如下所示:</p><pre class="ki kj kk kl gt me md mf mg aw mh bi"><span id="ecda" class="mi kq in md b gy mj mk l ml mm">-0.00000000<br/>-0.12533323<br/>-0.24868989<br/>-0.36812455<br/>-0.48175367<br/>-0.58778525<br/>..<br/></span></pre><p id="3c0e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">有点看不清这里发生了什么。但是使用<code class="fe ma mb mc md b">gnuplot</code>我们可以更容易地可视化这个文件。在<code class="fe ma mb mc md b">gnuplot</code>中，运行:</p><p id="01cc" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><code class="fe ma mb mc md b">plot "out.txt" with lines</code></p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/e75b5d22b74b476488c284c9ecd8d49f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*kL8CAzHZxYOrMBkvDFOMfA.png"/></div><figcaption class="lv lw gj gh gi lx ly bd b be z dk translated">gnuplot的输出</figcaption></figure><p id="dd1a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这看起来像是一个完美连续的正弦波，但这是gnuplot“用线条”可视化它的方式。如果我们绘制柱状图，我们可以看到一个稍微不同的视图。(<code class="fe ma mb mc md b">plot "out.txt" with boxes</code>)</p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/654d7a76a03aa172e0bd30ae16a64fcc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*BOs1Fyln54FvmJnKBkh2Fw.png"/></div><figcaption class="lv lw gj gh gi lx ly bd b be z dk translated">带横条的gnuplot</figcaption></figure><p id="5d4e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">既然我们能产生正弦波，我们就有了发声的基础。虽然在这一点上这只是浮点数，但我们实际上可以把它变成可以播放的原始音频文件。</p><h1 id="f4fd" class="kp kq in bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">第二步:产生声音</h1><p id="7b08" class="pw-post-body-paragraph jk jl in jm b jn ln jp jq jr lo jt ju jv lp jx jy jz lq kb kc kd lr kf kg kh ig bi translated">为了把这个正弦波变成真实的声音，我们必须介绍一些东西。</p><p id="9fcd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">* *采样率** </strong></p><p id="e837" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">首先，声音以一定的采样率存储。采样率告诉你每秒有多少样本被用来编码你的声音。CD质量的录音具有44100赫兹的采样率，允许高达22.05KHz的频率。考虑到人耳听到20Hz到20KHz之间的声音，这已经足够了(假设你只针对人类听众😛).</p><p id="9a03" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">虽然其他格式也是可能的，例如48Khz用于DVD视频质量或96KHz用于DVD音频质量，但我们现在将坚持CD质量。正如你将看到的——改变这一点是微不足道的。你可以自己随意摆弄一下，看看是否能听出声音的不同。</p><p id="574f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">因此，我们需要至少44100个样本，而不是使用我们的<code class="fe ma mb mc md b">nsamps = 50</code>。为了调整声音的持续时间，我们还将为此添加一个变量。</p><pre class="ki kj kk kl gt me md mf mg aw mh bi"><span id="ef1b" class="mi kq in md b gy mj mk l ml mm">const (<br/>      Duration = 2<br/>      SampleRate = 44100<br/>)</span></pre><p id="15a4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> **频率** </strong></p><p id="434d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">接下来，我们将引入一个频率。现在我们将使用440赫兹的频率，它被定义为“音高标准”。这是中c以上音符A的标准调音。为了不偏离我们创作音乐的目标，如果你对我们为什么使用这个频率感到好奇，请查看这个维基页面。</p><p id="442f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">加上这个，我们将再次扩展我们的常量:</p><pre class="ki kj kk kl gt me md mf mg aw mh bi"><span id="99b0" class="mi kq in md b gy mj mk l ml mm">const (<br/>      Duration   = 2<br/>      SampleRate = 44100<br/>      Frequency  = 440  // Pitch Standard<br/>)</span></pre><p id="fd9a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> **存储声音*** </strong></p><p id="b27f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们现在有了产生声音的基本成分，但是我们缺少了一个重要的部分。我们如何存储这些数据，以便我们的计算机可以将其解释为声音？</p><p id="4d83" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们在步骤1中生成的floats确实可以使用，但是我们必须将它们存储为二进制表示。这里一个棘手的部分是，你必须以你的计算机可以读取它们的方式存储它们——这意味着你必须在BigEndian机器上使用BigEndian，否则使用LittleEndian。</p><p id="0fdb" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在linux系统上，这可以通过您的终端发现(在macOS上可能是相同的命令，不要验证！).</p><pre class="ki kj kk kl gt me md mf mg aw mh bi"><span id="ac6d" class="mi kq in md b gy mj mk l ml mm">dylan@devuan:~$ lscpu | grep "Byte Order"<br/>Byte Order:            Little Endian</span></pre><p id="d7a5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> **代码！** </strong></p><p id="51ed" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在我们知道该做什么，并设置了我们的常数，让我们修改生成函数来把它们联系在一起。声音将存储在您机器上名为“out.bin”的文件中。<em class="mo">(为了简洁，我已经去掉了错误处理！)</em></p><pre class="ki kj kk kl gt me md mf mg aw mh bi"><span id="ecfa" class="mi kq in md b gy mj mk l ml mm">func generate() {<br/>	nsamps := Duration * SampleRate<br/>	var angle float64 = tau / float64(nsamps)<br/>	file := "out.bin"<br/>	f, _ := os.Create(file)<br/>	for i := 0; i &lt; nsamps; i++ {<br/>		sample := math.Sin(angle * Frequency * float64(i))<br/>		var buf [8]byte<br/>		binary.LittleEndian.PutUint32(buf[:],<br/>                       math.Float32bits(float32(sample)))<br/>		bw,_ := f.Write(buf[:])<br/>		fmt.Printf("\rWrote: %v bytes to %s", bw, file)<br/>	}<br/>}</span></pre><p id="64ac" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">使用<code class="fe ma mb mc md b">ffplay</code>我们现在可以播放这个文件，尽管我们需要指定我们的采样率和格式。指定我们的<code class="fe ma mb mc md b">showmode</code>我们也可以想象正在播放的声音:</p><pre class="ki kj kk kl gt me md mf mg aw mh bi"><span id="0c9a" class="mi kq in md b gy mj mk l ml mm">ffplay -f f32le -ar  44100 -showmode 1 out.bin</span></pre><figure class="ki kj kk kl gt km gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/76f705735a8b6150dd0d7d25a2966b51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*BbaovxPpS_HmMsBlNIPdgQ.png"/></div><figcaption class="lv lw gj gh gi lx ly bd b be z dk translated">使用ffplay播放我们的文件</figcaption></figure><p id="aee7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">听起来是这样的:</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="kn ko l"/></div></figure><p id="9057" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">或者，您也可以使用Audacity，将我们的二进制文件作为“原始音频文件”导入。只要确保你选择单声道和正确的编码。😉</p><p id="6e53" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这就是我们如何创建音高标准。虽然一个小的改进将是篡改接近尾声的声音。这比持续的信号感觉更“自然”。为了实现这一点，我们可以在信号接近结束时引入指数衰减。</p><h1 id="7d23" class="kp kq in bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">扩展1:指数衰减</h1><p id="85ed" class="pw-post-body-paragraph jk jl in jm b jn ln jp jq jr lo jt ju jv lp jx jy jz lq kb kc kd lr kf kg kh ig bi translated">我们不需要增加很多就能得到指数衰减。我们想淡出我们的信号，所以我们将定义一个开始和结束“振幅”来产生一个衰减因子。接下来，在每次迭代中，我们将通过乘以衰减因子来修改信号的实际幅度。</p><p id="8d0f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在函数的顶部，我们将定义这些变量:</p><pre class="ki kj kk kl gt me md mf mg aw mh bi"><span id="9411" class="mi kq in md b gy mj mk l ml mm">func generate() {<br/>     var (<br/>         start float64 = 1.0<br/>         end float64   = 1.0e-4<br/>     )<br/>     nsamps = Duration * SampleRate<br/>     decayfac := math.Pow(end/start, 1.0/float64(nsamps))<br/>     ..</span></pre><p id="fa53" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">一旦我们设置好了它们，在生成波形的循环中，我们可以在每次迭代中修改样本</p><pre class="ki kj kk kl gt me md mf mg aw mh bi"><span id="f4e8" class="mi kq in md b gy mj mk l ml mm">sample := math.Sin(angle * Frequency * float64(i))<br/>sample *= start<br/>start *= decayfac</span></pre><p id="9d85" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">当我们把这些放在一起，我们的功能就变成了:</p><pre class="ki kj kk kl gt me md mf mg aw mh bi"><span id="6118" class="mi kq in md b gy mj mk l ml mm">func generate() {<br/>	var (<br/>		start float64 = 1.0<br/>		end   float64 = 1.0e-4<br/>	)<br/>	nsamps := Duration * SampleRate<br/>	var angle float64 = tau / float64(nsamps)<br/>	file := "out.bin"<br/>	f, _ := os.Create(file)<br/>	decayfac := math.Pow(end/start, 1.0/float64(nsamps))<br/>	for i := 0; i &lt; nsamps; i++ {<br/>		sample := math.Sin(angle * Frequency * float64(i))<br/>		sample *= start<br/>		start *= decayfac<br/>		var buf [8]byte<br/>		binary.LittleEndian.PutUint32(buf[:],<br/>                       math.Float32bits(float32(sample)))<br/>		bw, _ := f.Write(buf[:])<br/>		fmt.Printf("\rWrote: %v bytes to %s", bw, file)<br/>	}<br/>}</span></pre><p id="8f4b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在，如果我们播放这个声音，我们可以从这篇文章顶部的视频中获得声音。😃</p></div><div class="ab cl mp mq hr mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="ig ih ii ij ik"><p id="cc2a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">所有代码都在GitHub上:<a class="ae lz" href="https://github.com/DylanMeeus/MediumCode/blob/master/Audio/FirstSound/main.go" rel="noopener ugc nofollow" target="_blank">https://GitHub . com/dylanmeus/medium code/blob/master/Audio/first sound/main . go</a></p></div><div class="ab cl mp mq hr mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="ig ih ii ij ik"><p id="905f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果你喜欢这篇文章💙去为好，考虑:</p><ul class=""><li id="4559" class="mw mx in jm b jn jo jr js jv my jz mz kd na kh nb nc nd ne bi translated">跟着我来到这里，在媒体上</li><li id="94c3" class="mw mx in jm b jn nf jr ng jv nh jz ni kd nj kh nb nc nd ne bi translated">或者推特<a class="ae lz" href="https://www.twitter.com/DylanMeeus" rel="noopener ugc nofollow" target="_blank">推特</a></li></ul></div></div>    
</body>
</html>