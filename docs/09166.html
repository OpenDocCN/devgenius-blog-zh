<html>
<head>
<title>Load Data using EMR Spark with Apache Iceberg</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用带有 Apache Iceberg 的 EMR Spark 加载数据</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/load-data-using-emr-spark-with-apache-iceberg-7568f356e68c?source=collection_archive---------6-----------------------#2022-08-03">https://blog.devgenius.io/load-data-using-emr-spark-with-apache-iceberg-7568f356e68c?source=collection_archive---------6-----------------------#2022-08-03</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><blockquote class="jk jl jm"><p id="b6c0" class="jn jo jp jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ig bi translated">创建 EMR 集群，然后使用 Spark 和 Apache Iceberg 加载数据的快速指令集。</p></blockquote><p id="9e12" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy km ka kb kc kn ke kf kg ko ki kj kk kl ig bi translated"><strong class="jq io">技术堆栈:</strong></p><p id="6f2d" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy km ka kb kc kn ke kf kg ko ki kj kk kl ig bi translated"><strong class="jq io"> AWS EMR </strong>作为计算引擎。弹性 MapReduce (EMR)是一个托管集群平台，可简化大数据框架的运行。</p><p id="7d90" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy km ka kb kc kn ke kf kg ko ki kj kk kl ig bi translated"><strong class="jq io"> AWS S3 </strong> as 数据仓库(data warehouse)。简单存储服务(亚马逊 S3)是一种对象存储服务，提供行业领先的可扩展性、数据可用性、安全性和性能。</p><p id="df05" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy km ka kb kc kn ke kf kg ko ki kj kk kl ig bi translated"><strong class="jq io"> AWS DynamoDB </strong>作为 Spark 目录 metastore。Amazon DynamoDB 是一个完全托管的专有 NoSQL 数据库服务，支持键值和文档数据结构。</p><p id="3eb6" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy km ka kb kc kn ke kf kg ko ki kj kk kl ig bi translated"><strong class="jq io"> Apache Spark </strong>作为用于大数据工作负载的开源分布式数据处理框架/系统。</p><p id="7e67" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy km ka kb kc kn ke kf kg ko ki kj kk kl ig bi translated"><strong class="jq io"> Apache Iceberg </strong>作为大型数据集的开放表格式。一种用于数据湖的高性能、并发、符合 ACID 的表格式。</p><h1 id="fe90" class="kp kq in bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">创建 AWS EMR 集群和 Jupyter 笔记本的步骤</h1><blockquote class="jk jl jm"><p id="1d10" class="jn jo jp jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ig bi translated"><strong class="jq io">让我们创建一个 EMR 集群</strong></p></blockquote><p id="5a45" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy km ka kb kc kn ke kf kg ko ki kj kk kl ig bi translated">转到 AWS 服务并点击 EMR。单击“创建集群”按钮。</p><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="gh gi ln"><img src="../Images/2e2bcd93308942724e21eecf81a575c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IQsXCZnbRb4CVJrLAqHZXA.png"/></div></div></figure><p id="fa6d" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy km ka kb kc kn ke kf kg ko ki kj kk kl ig bi translated">点击“进入高级选项”</p><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="gh gi lz"><img src="../Images/d8cfd21c5f1c5a41b179d12968641fac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Fq3A34FmELvLkOwUFkb6_Q.png"/></div></div></figure><p id="1708" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy km ka kb kc kn ke kf kg ko ki kj kk kl ig bi translated">让我们在下拉选择器中选择 EMR 版本为<strong class="jq io"> 6.4.0 </strong>。接下来，选中以下所有应用程序的复选框，将它们包含在集群中:</p><p id="dfb7" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy km ka kb kc kn ke kf kg ko ki kj kk kl ig bi translated">spark 3 . 1 . 2<br/>JupyterHub 1.41<br/>jupyterenterprise gateway 2 . 1 . 0</p><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="gh gi ma"><img src="../Images/1736906b62e22ba5f16737f8944d84a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NYRSXhTkN7rbW6aqp6DQCA.png"/></div></div></figure><p id="8d45" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy km ka kb kc kn ke kf kg ko ki kj kk kl ig bi translated">在“编辑软件设置”部分，请在文本框中输入以下配置。请确保将<your s3="" path="">替换为您想要用于仓库的 S3 位置的路径，例如 s3://dficebergdemo</your></p><pre class="lo lp lq lr gt mb mc md me aw mf bi"><span id="70c2" class="mg kq in mc b gy mh mi l mj mk">[<br/> {<br/> “classification”:”spark-defaults”,<br/> “properties”:{<br/> “spark.jars.packages”:”org.apache.iceberg:iceberg-spark3-runtime:0.12.1,software.amazon.awssdk:bundle:2.15.40,software.amazon.awssdk:url-connection-client:2.15.40",<br/> “spark.sql.extensions”:”org.apache.iceberg.spark.extensions.IcebergSparkSessionExtensions”,<br/> “spark.sql.defaultCatalog”:”prodiceberg”,<br/> “spark.sql.catalog.prodiceberg”:”org.apache.iceberg.spark.SparkCatalog”,<br/> “spark.sql.catalog.prodiceberg.catalog-impl”:”org.apache.iceberg.aws.dynamodb.DynamoDbCatalog”,<br/> “spark.sql.catalog.prodiceberg.warehouse”:”s3://dficebergdemo”,<br/> “spark.sql.catalog.prodiceberg.dynamodb.table-name”:”prodiceberg_metastore”<br/> }<br/> }<br/>]</span></pre><p id="4d8b" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy km ka kb kc kn ke kf kg ko ki kj kk kl ig bi translated">所以最后，它看起来会像下面这样-</p><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="gh gi ml"><img src="../Images/9a4118e1a7df5c7c20bf8137608384d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0zqvn9_-TnlEm8rQuuJhHg.png"/></div></div></figure><p id="7a21" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy km ka kb kc kn ke kf kg ko ki kj kk kl ig bi translated">单击“下一步”并选择硬件的默认选项。单击下一步，在“常规集群设置”中更改集群名称。单击下一步，选择适当的安全选项，最后单击“创建集群”。</p><p id="3bf5" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy km ka kb kc kn ke kf kg ko ki kj kk kl ig bi translated">这将在大约 10 到 15 分钟内创建集群。</p><blockquote class="jk jl jm"><p id="6ef1" class="jn jo jp jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ig bi translated"><strong class="jq io">让我们创建一个 Jupyter 笔记本</strong></p></blockquote><p id="df00" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy km ka kb kc kn ke kf kg ko ki kj kk kl ig bi translated">在 AWS 管理控制台的 EMR 仪表板上，选择左侧导航窗格中的“笔记本”。然后你可以点击“创建笔记本”</p><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="gh gi mm"><img src="../Images/d4e8f452bdb52cb07d19de2d4460d89a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0n4uXOzPUOCOeEwoVRsMVQ.png"/></div></div></figure><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="gh gi mn"><img src="../Images/59d9fabac2c2c3941a0eff820bdcd9e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zbsCsYX--IKyxy3mzXS-HA.png"/></div></div></figure><p id="a827" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy km ka kb kc kn ke kf kg ko ki kj kk kl ig bi translated">Jupyter Enterprise Gateway 可帮助您将此笔记本电脑连接到我们在上一步中创建的集群。为笔记本提供适当的名称。您将看到一个选择现有集群的选项，并且可以看到在上一步中创建的集群。从弹出窗口中选择特定集群，然后单击“选择集群”以将集群与笔记本连接。最后，点击“创建笔记本”按钮。笔记本将处于挂起状态，直到笔记本服务器启动。</p><h1 id="926c" class="kp kq in bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">加载数据的步骤</h1><blockquote class="jk jl jm"><p id="8787" class="jn jo jp jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ig bi translated"><strong class="jq io">让我们加载数据</strong></p></blockquote><p id="1d3b" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy km ka kb kc kn ke kf kg ko ki kj kk kl ig bi translated">点击笔记本名称，访问笔记本。</p><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="gh gi mo"><img src="../Images/555b6ca7cec8c5bef44d996c9d5bd841.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l_v2H2Me2ClteqOkgt0pXg.png"/></div></div></figure><p id="aa69" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy km ka kb kc kn ke kf kg ko ki kj kk kl ig bi translated">点击“在 Jupyter 中打开”</p><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="gh gi mp"><img src="../Images/9d65ffb70fbdb30f683a98c35960d3f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l73HcnTCgbTR5rvuYZbTcQ.png"/></div></div></figure><p id="89e4" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy km ka kb kc kn ke kf kg ko ki kj kk kl ig bi translated">把 Jupyter 狗窝改成 PySpark</p><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div class="gh gi mq"><img src="../Images/37556504e2aa2d5e56371632d52ea60a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1394/format:webp/1*lHuaexba26asmlUeN2jMwQ.png"/></div></figure><p id="c1c9" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy km ka kb kc kn ke kf kg ko ki kj kk kl ig bi translated">请通过在单元中运行 spark 来启动 spark 会话。</p><pre class="lo lp lq lr gt mb mc md me aw mf bi"><span id="92dd" class="mg kq in mc b gy mh mi l mj mk"><strong class="mc io">spark</strong></span></pre><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="gh gi mr"><img src="../Images/91ca4fbbde156c4deaa5e36882063a14.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o10bpS8O2Z6nkTbPG7xX6A.png"/></div></div></figure><p id="6515" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy km ka kb kc kn ke kf kg ko ki kj kk kl ig bi translated">我们将使用纽约市出租车和豪华轿车委员会(TLC)的出行记录数据(<a class="ae ms" href="https://registry.opendata.aws/nyc-tlc-trip-records-pds/" rel="noopener ugc nofollow" target="_blank">https://registry.opendata.aws/nyc-tlc-trip-records-pds/</a>)。该数据包含纽约市出租车和出租汽车的出行信息。</p><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/0b9dc1e64f0248a9949616a46374c15a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F38Va8PZeGiT5ELMbiS8dQ.png"/></div><figcaption class="mu mv gj gh gi mw mx bd b be z dk translated">https://coiled.io/blog/nyc-taxi-parquet-csv-index-error/<a class="ae ms" href="https://coiled.io/blog/nyc-taxi-parquet-csv-index-error/" rel="noopener ugc nofollow" target="_blank"/></figcaption></figure><blockquote class="jk jl jm"><p id="532e" class="jn jo jp jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ig bi translated"><strong class="jq io">让我们创建数据库和表格来加载数据</strong></p></blockquote><p id="33ca" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy km ka kb kc kn ke kf kg ko ki kj kk kl ig bi translated">我们将创建一个<strong class="jq io"> nyc </strong>数据库，并将几个月的数据保存到一个名为<strong class="jq io">taxi</strong>的冰山表中。请注意，所有文件现在都是拼花格式，而不是 CSV 格式。</p><pre class="lo lp lq lr gt mb mc md me aw mf bi"><span id="ce0d" class="mg kq in mc b gy mh mi l mj mk"><strong class="mc io">spark.sql(“CREATE DATABASE nyc”)<br/>df = spark.read.option(“header”, True).parquet(“s3://nyc-tlc/trip data/yellow_tripdata_2020–03.parquet”)<br/>df.writeTo(“nyc.taxis”).create()</strong></span></pre><p id="3dbe" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy km ka kb kc kn ke kf kg ko ki kj kk kl ig bi translated">您可以运行 describe table 命令来查看列和列类型。</p><pre class="lo lp lq lr gt mb mc md me aw mf bi"><span id="a668" class="mg kq in mc b gy mh mi l mj mk"><strong class="mc io">spark.sql(“DESCRIBE TABLE nyc.taxis”).show(truncate=False)</strong></span></pre><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div class="gh gi my"><img src="../Images/607ed244dae746e759045c4bf56bef85.png" data-original-src="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*iHZfSNh-UZKwh4qHCOqqUA.png"/></div></figure><p id="a9f9" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy km ka kb kc kn ke kf kg ko ki kj kk kl ig bi translated">再加载一个月的数据。</p><pre class="lo lp lq lr gt mb mc md me aw mf bi"><span id="d5d9" class="mg kq in mc b gy mh mi l mj mk"><strong class="mc io">df = spark.read.option(“header”, True).parquet(“s3://nyc-tlc/trip data/yellow_tripdata_2020–04.parquet”)<br/>df.write.mode(“append”).insertInto(“nyc.taxis”)</strong></span></pre><p id="563c" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy km ka kb kc kn ke kf kg ko ki kj kk kl ig bi translated">让我们检查一下<strong class="jq io"> nyc.taxis </strong>表的记录计数。</p><pre class="lo lp lq lr gt mb mc md me aw mf bi"><span id="889c" class="mg kq in mc b gy mh mi l mj mk"><strong class="mc io">spark.sql(“””<br/> SELECT COUNT(*) as cnt<br/> FROM nyc.taxis<br/>“””).show()</strong></span></pre><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="gh gi mz"><img src="../Images/9724e21b63af580b57afe1a3ee12b230.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L4TrKbNK3ch7Fe3uEYACgg.png"/></div></div></figure><p id="2d48" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy km ka kb kc kn ke kf kg ko ki kj kk kl ig bi translated">这样，我们只需加载数据，使用 EMR 集群作为计算引擎，使用 S3 持久化数据，使用 Apache Iceberg 作为开放表格式，就像 SQL 表一样工作。</p><p id="7952" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy km ka kb kc kn ke kf kg ko ki kj kk kl ig bi translated">用于 DML 操作、时间旅行、模式进化、数据回滚、数据压缩等的表达性 SQL。Apache Iceberg 有一些有趣的特性，如果我们追求一个开源和开放标准必不可少的数据架构，那么它是表格格式的最佳选择。</p><p id="2a08" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy km ka kb kc kn ke kf kg ko ki kj kk kl ig bi translated">如果你想了解更多关于这个技术栈的信息，请点击下面的链接</p><div class="na nb gp gr nc nd"><a href="https://iceberg.apache.org/spec/" rel="noopener  ugc nofollow" target="_blank"><div class="ne ab fo"><div class="nf ab ng cl cj nh"><h2 class="bd io gy z fp ni fr fs nj fu fw im bi translated">投机</h2><div class="nk l"><h3 class="bd b gy z fp ni fr fs nj fu fw dk translated">这是 Iceberg 表格式的规范，旨在管理大量缓慢变化的…</h3></div><div class="nl l"><p class="bd b dl z fp ni fr fs nj fu fw dk translated">iceberg.apache.org</p></div></div><div class="nm l"><div class="nn l no np nq nm nr lx nd"/></div></div></a></div><div class="na nb gp gr nc nd"><a href="https://iceberg.apache.org/docs/latest/" rel="noopener  ugc nofollow" target="_blank"><div class="ne ab fo"><div class="nf ab ng cl cj nh"><h2 class="bd io gy z fp ni fr fs nj fu fw im bi translated">介绍</h2><div class="nk l"><h3 class="bd b gy z fp ni fr fs nj fu fw dk translated">Apache Iceberg 是一种用于大型分析数据集的开放式表格格式。Iceberg 为计算引擎添加了表格，包括…</h3></div><div class="nl l"><p class="bd b dl z fp ni fr fs nj fu fw dk translated">iceberg.apache.org</p></div></div><div class="nm l"><div class="ns l no np nq nm nr lx nd"/></div></div></a></div><div class="na nb gp gr nc nd"><a href="https://docs.aws.amazon.com/emr/latest/ManagementGuide/emr-what-is-emr.html" rel="noopener  ugc nofollow" target="_blank"><div class="ne ab fo"><div class="nf ab ng cl cj nh"><h2 class="bd io gy z fp ni fr fs nj fu fw im bi translated">什么是亚马逊 EMR？</h2><div class="nk l"><h3 class="bd b gy z fp ni fr fs nj fu fw dk translated">Amazon EMR(以前称为 Amazon Elastic MapReduce)是一个托管集群平台，可以简化大数据的运行…</h3></div><div class="nl l"><p class="bd b dl z fp ni fr fs nj fu fw dk translated">docs.aws.amazon.com</p></div></div></div></a></div><div class="na nb gp gr nc nd"><a href="https://www.dremio.com/resources/guides/apache-iceberg-an-architectural-look-under-the-covers/" rel="noopener  ugc nofollow" target="_blank"><div class="ne ab fo"><div class="nf ab ng cl cj nh"><h2 class="bd io gy z fp ni fr fs nj fu fw im bi translated">阿帕奇冰山:隐藏的建筑景观</h2><div class="nk l"><h3 class="bd b gy z fp ni fr fs nj fu fw dk translated">如果你更喜欢视频而不是文字，这里有一个在这篇文章中介绍这一内容的录音，我们会去…</h3></div><div class="nl l"><p class="bd b dl z fp ni fr fs nj fu fw dk translated">www.dremio.com</p></div></div><div class="nm l"><div class="nt l no np nq nm nr lx nd"/></div></div></a></div></div></div>    
</body>
</html>