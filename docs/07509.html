<html>
<head>
<title>How to install a passwordless OpenSSH server within a docker container using public-private key pairs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用公私密钥对在 docker 容器中安装无密码 OpenSSH 服务器</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/how-to-install-an-openssh-server-within-a-docker-container-with-a-passwordless-public-private-key-f4f4be9ef9f9?source=collection_archive---------9-----------------------#2022-03-31">https://blog.devgenius.io/how-to-install-an-openssh-server-within-a-docker-container-with-a-passwordless-public-private-key-f4f4be9ef9f9?source=collection_archive---------9-----------------------#2022-03-31</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><h1 id="64f3" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">为什么要在 docker 容器中安装 OpenSSH 服务器？</h1><p id="0f66" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">当您编写安装远程服务器或云实例的方法时，您希望在生产环境中运行之前确保它能够正常工作。</p><p id="c067" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">在远程实例中测试这种脚本可能需要将其重置为初始状态，这是一项耗时的任务。</p><p id="8541" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">通过用本地 docker 容器替换远程服务器，您无需花费任何成本，您可以加速开发过程，并且每次您想要再次运行脚本时，您只需重新启动容器，它就会立即恢复到初始状态。</p><h2 id="e47f" class="ll jl in bd jm lm ln dn jq lo lp dp ju kt lq lr jy kx ls lt kc lb lu lv kg lw bi translated">生成公钥-私钥对</h2><p id="50be" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">使用“ssh-keygen”命令生成公钥和私钥对:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="7cfc" class="ll jl in mc b gy mg mh l mi mj">ssh-keygen -t rsa -b 4096 -C "<a class="ae mk" href="mailto:ubuntu@example.com" rel="noopener ugc nofollow" target="_blank">ubuntu@example.com</a>" -f id_rsa -P ""</span></pre><p id="b3fc" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">应该生成两个文件 id_rsa 和 id_rsa.pub，它们将在稍后用于 SSH 连接。</p><h2 id="c3bb" class="ll jl in bd jm lm ln dn jq lo lp dp ju kt lq lr jy kx ls lt kc lb lu lv kg lw bi translated">文档文件</h2><p id="5132" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">创建一个名为 Dockerfile 的文件，复制/粘贴下面的代码:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="608a" class="ll jl in mc b gy mg mh l mi mj">FROM ubuntu:21.10</span><span id="c507" class="ll jl in mc b gy ml mh l mi mj">RUN apt update &amp;&amp; apt install openssh-server sudo -y</span><span id="553b" class="ll jl in mc b gy ml mh l mi mj">RUN useradd -rm -d /home/ubuntu -s /bin/bash -g root -G sudo -u 1000 ubuntu</span><span id="a830" class="ll jl in mc b gy ml mh l mi mj">RUN  echo 'ubuntu:ubuntu' | chpasswd</span><span id="3021" class="ll jl in mc b gy ml mh l mi mj">RUN echo '%sudo ALL=(ALL) NOPASSWD:ALL' &gt;&gt; \ /etc/sudoers</span><span id="69e1" class="ll jl in mc b gy ml mh l mi mj">RUN mkdir /home/ubuntu/.ssh</span><span id="876d" class="ll jl in mc b gy ml mh l mi mj">COPY ./id_rsa.pub /home/ubuntu/.ssh/id_rsa.pub</span><span id="24e4" class="ll jl in mc b gy ml mh l mi mj">RUN cat /home/ubuntu/.ssh/id_rsa.pub &gt;&gt; /home/ubuntu/.ssh/authorized_keys</span><span id="d479" class="ll jl in mc b gy ml mh l mi mj">RUN chmod -R go= /home/ubuntu/.ssh</span><span id="3323" class="ll jl in mc b gy ml mh l mi mj">RUN chown -R ubuntu /home/ubuntu/.ssh</span><span id="9dda" class="ll jl in mc b gy ml mh l mi mj">RUN service ssh start</span><span id="b8aa" class="ll jl in mc b gy ml mh l mi mj">EXPOSE 22</span><span id="4bb5" class="ll jl in mc b gy ml mh l mi mj">CMD ["/usr/sbin/sshd","-D"]</span></pre><p id="600a" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">这个 docker 文件扩展了官方的 ubuntu 映像，安装了“openssh-server”和“sudo ”,然后创建了一个名为“Ubuntu”的用户，该用户拥有 root 权限，没有密码。</p><p id="bd66" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">公钥被复制并添加到 authorized_keys 文件中，以便使用私钥通过 SSH 进行连接。</p><h2 id="2505" class="ll jl in bd jm lm ln dn jq lo lp dp ju kt lq lr jy kx ls lt kc lb lu lv kg lw bi translated">docker-compose.yml</h2><p id="2eda" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">创建一个名为 docker-compose.yml 的文件，复制/粘贴下面的代码:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="4813" class="ll jl in mc b gy mg mh l mi mj">version: '3'</span><span id="caea" class="ll jl in mc b gy ml mh l mi mj">services:</span><span id="6bb8" class="ll jl in mc b gy ml mh l mi mj">    ubuntu_01:<br/>        container_name: ubuntu_01<br/>        build:<br/>            context: .<br/>            dockerfile: Dockerfile<br/>        networks:<br/>            - network</span><span id="2857" class="ll jl in mc b gy ml mh l mi mj">    ubuntu_02:<br/>        container_name: ubuntu_02<br/>        build:<br/>            context: .<br/>            dockerfile: Dockerfile<br/>        networks:<br/>            - network</span><span id="bde6" class="ll jl in mc b gy ml mh l mi mj">    ubuntu_03:<br/>        container_name: ubuntu_03<br/>        build:<br/>            context: .<br/>            dockerfile: Dockerfile<br/>        networks:<br/>            - network</span><span id="a1b0" class="ll jl in mc b gy ml mh l mi mj">networks:<br/>    network:<br/>        driver: bridge</span></pre><p id="d251" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">这个 docker 组合使用相同的先前创建的映像定义 3 个容器，并将它们附加到网络。</p><h2 id="d9c2" class="ll jl in bd jm lm ln dn jq lo lp dp ju kt lq lr jy kx ls lt kc lb lu lv kg lw bi translated">打开集装箱</h2><p id="8977" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">让我们运行它们:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="6788" class="ll jl in mc b gy mg mh l mi mj">docker-compose up -d</span></pre><p id="2fe2" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">验证一切正常运行:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="bdfe" class="ll jl in mc b gy mg mh l mi mj">docker ps</span></pre><p id="9243" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">您应该会看到这样的内容:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="ef3e" class="ll jl in mc b gy mg mh l mi mj">CONTAINER ID   IMAGE                  COMMAND               CREATED             STATUS             PORTS     NAMES<br/>4d1b8091014e   ubuntu-ssh_ubuntu_03   "/usr/sbin/sshd -D"   About an hour ago   Up About an hour   22/tcp    ubuntu_03<br/>506d1af29f25   ubuntu-ssh_ubuntu_02   "/usr/sbin/sshd -D"   About an hour ago   Up About an hour   22/tcp    ubuntu_02<br/>76c85e4fe2ec   ubuntu-ssh_ubuntu_01   "/usr/sbin/sshd -D"   About an hour ago   Up About an hour   22/tcp    ubuntu_01</span></pre><h2 id="c036" class="ll jl in bd jm lm ln dn jq lo lp dp ju kt lq lr jy kx ls lt kc lb lu lv kg lw bi translated">获取“ubuntu_01”容器 IP</h2><p id="0203" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">执行下面的命令，根据名称获取容器 IP:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="402d" class="ll jl in mc b gy mg mh l mi mj">docker inspect -f '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}' ubuntu_01</span></pre><p id="0f87" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">输出应该类似于:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="fcc5" class="ll jl in mc b gy mg mh l mi mj">172.25.0.4</span></pre><h2 id="ec59" class="ll jl in bd jm lm ln dn jq lo lp dp ju kt lq lr jy kx ls lt kc lb lu lv kg lw bi translated">通过 SSH 连接到“ubuntu_01”容器</h2><p id="b739" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">一切都已启动并运行，所以让我们使用“ubuntu”用户和私钥连接到容器“ubuntu_01 ”:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="0f54" class="ll jl in mc b gy mg mh l mi mj">ssh ubuntu@172.25.0.4 -i id_rsa</span></pre><p id="9986" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">对于第一次连接，它会要求您确认主机，只需键入“是”并按“回车”即可。</p><p id="e39a" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">通过添加选项"-o StrictHostKeyChecking=no "来禁用主机检查，并使用" docker inspect …"来获取 IP 作为变量，这将使您可以使用一条线路进行连接，而无需密码或主机检查。</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="48d7" class="ll jl in mc b gy mg mh l mi mj">ssh -o StrictHostKeyChecking=no ubuntu@$(docker inspect -f '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}' ubuntu_01) -i id_rsa</span></pre><p id="df0d" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">我希望这将是有用的，我愿意接受任何反馈来改进这篇文章。</p><p id="b80c" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">感谢您的阅读:)</p><p id="4f73" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">欢迎<strong class="kk io">关注</strong>了解更多内容🔔，<strong class="kk io">拍拍</strong>👏🏻<strong class="kk io">与你喜欢的任何人分享文章</strong>。</p><p id="f42c" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">一如既往，我感谢你的支持。</p></div></div>    
</body>
</html>