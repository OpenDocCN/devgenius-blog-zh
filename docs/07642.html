<html>
<head>
<title>S3 trigger: Serverless CSV upload into DynamoDB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">S3 触发器:无服务器 CSV 上传到 DynamoDB</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/s3-trigger-serverless-csv-upload-into-dynamodb-8877c770fb32?source=collection_archive---------4-----------------------#2022-04-12">https://blog.devgenius.io/s3-trigger-serverless-csv-upload-into-dynamodb-8877c770fb32?source=collection_archive---------4-----------------------#2022-04-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/be0cdc18024a6c09047c677285b000d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qVmvbHlHFLj8RxLW4eq22g.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">米卡·鲍梅斯特在<a class="ae kc" href="https://unsplash.com/s/photos/csv?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="7951" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可以在许多用例中使用 AWS Lambda 触发器。这一次的诀窍是通过将 CSV 文件的内容上传到 S3 存储桶并触发 Lambda 函数将它们存储在 DynamoDB 中，从而将静态数据添加到数据库中。尽管 CSV 看起来非常古老，但它仍然经常在 it 项目中用于交换数据或从一个数据存储导入到另一个数据存储。</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lb"><img src="../Images/7a6fcf021f08b176497b4e0e2f7d0b59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QOavsWDHgdCYtz7Jt_1VWA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">方法:将 CSV 导入 DynamoDB</figcaption></figure><p id="cec3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将在<a class="ae kc" rel="noopener ugc nofollow" target="_blank" href="/how-to-build-a-serverless-rest-api-with-nestjs-and-dynamodb-7b58b5b59bf6">之前的故事</a>中讨论创建一个在线图书馆服务。我们将创建一种方法，使用 CSV 文件将图书类别加载到 DynamoDB 数据库中。图书类别 CSV 可能如下所示。使用带 DynamoDB 的<a class="ae kc" rel="noopener ugc nofollow" target="_blank" href="/how-to-do-single-table-design-with-dynamodb-db9101a43277">单表设计策略</a>的分区键(PK)和排序键(SK)。</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div class="gh gi lg"><img src="../Images/faed4385a546806ac0eac100e9ea6d16.png" data-original-src="https://miro.medium.com/v2/resize:fit:604/format:webp/1*fZTU1WnMCdA3vppU46vRyA.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">图书类别. csv</figcaption></figure><h2 id="c3b0" class="lh li iq bd lj lk ll dn lm ln lo dp lp ko lq lr ls ks lt lu lv kw lw lx ly lz bi translated">使用 AWS Lambda 的异步调用</h2><p id="332a" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated">在我们接触一些代码之前，我们先来看看 Lambda 是如何处理来自 S3 的触发器的。一些 AWS 服务，如亚马逊 S3 和亚马逊社交网络，异步调用函数来处理来自触发器的事件。下图显示了异步调用 Lambda 函数的客户端。</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div class="gh gi mf"><img src="../Images/da9f2019cf4d53388db06334e2f1c0ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1254/format:webp/0*aj_GNvdDMFXYZbWd.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">图表:使用 AWS Lambda 的异步调用</figcaption></figure><p id="b8e7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于异步调用，Lambda 将事件放在一个队列中，并返回一个成功的响应，没有附加信息。一个单独的进程从队列中读取事件，并将它们发送到您的函数。</p><p id="0821" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Lambda 管理函数的异步事件队列，并尝试在出错时重试。这里需要知道的重要一点是，即使你的函数没有返回错误，它也可以多次从 Lambda 接收相同的事件，因为队列本身最终是一致的。确保您的函数代码<em class="mg">优雅地处理重复事件</em>，并且您有足够的并发性来处理所有调用。</p><h2 id="16c7" class="lh li iq bd lj lk ll dn lm ln lo dp lp ko lq lr ls ks lt lu lv kw lw lx ly lz bi translated">目的地</h2><p id="8f9f" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated">您可以为函数配置目的地，以便将异步调用的记录发送到另一个服务。您可以为处理失败的事件和成功处理的事件配置单独的目标。有关更多信息，请参见 AWS 上的<a class="ae kc" href="https://docs.aws.amazon.com/lambda/latest/dg/invocation-async.html" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div class="gh gi mh"><img src="../Images/f7aba0b90f74f6b78a38007624edad21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1282/format:webp/0*YI8L3GyYIIvguZH3.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">异步调用的目标</figcaption></figure><h2 id="00cf" class="lh li iq bd lj lk ll dn lm ln lo dp lp ko lq lr ls ks lt lu lv kw lw lx ly lz bi translated">无服务器设置</h2><p id="e3b7" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated">现在，让我们来看一些实际的代码。</p><p id="d616" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将使用<a class="ae kc" href="https://www.serverless.com" rel="noopener ugc nofollow" target="_blank">无服务器框架</a>和一个模板来生成一个空白的 TypeScript 项目，用于接收 S3 上传事件的记录。</p><blockquote class="mi mj mk"><p id="496a" class="kd ke mg kf b kg kh ki kj kk kl km kn ml kp kq kr mm kt ku kv mn kx ky kz la ij bi translated"><em class="iq">本文的完整项目可以在 Github</em><a class="ae kc" href="https://github.com/cyberworkz/examples" rel="noopener ugc nofollow" target="_blank"><em class="iq">【https://github.com/cyberworkz/examples</em></a><em class="iq">的 bookcategory-upload 文件夹中找到。</em></p></blockquote><p id="da44" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用以下命令，通过无服务器 CLI 创建一个新项目:</p><pre class="lc ld le lf gt mo mp mq mr aw ms bi"><span id="62b4" class="lh li iq mp b gy mt mu l mv mw">sls create --template-url <a class="ae kc" href="https://github.com/cyberworkz/serverless-templates/tree/main/aws-nodejs-typescript-s3" rel="noopener ugc nofollow" target="_blank">https://github.com/cyberworkz/serverless-templates/tree/main/aws-nodejs-typescript-s3</a> --path bookcategory-upload</span></pre><p id="d98e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这将创建一个旨在从 S3 桶中拾取事件的项目。让我们进入文件夹 bookcategory-upload 并浏览无服务器配置文件(serverless.yml)。</p><figure class="lc ld le lf gt jr"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="3ed8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当使用后缀. csv 创建对象时，lambda 函数接收器作用于 S3 事件。存储桶名称被设置为自定义变量。更多关于无服务器框架的变量可以在<a class="ae kc" href="https://www.serverless.com/framework/docs/providers/aws/guide/variables" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><pre class="lc ld le lf gt mo mp mq mr aw ms bi"><span id="9ea3" class="lh li iq mp b gy mt mu l mv mw">events:      <br/>      - s3:          <br/>          bucket: ${self:custom.bucket}          <br/>          event: s3:ObjectCreated:*</span></pre><p id="e71c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">添加了一个<em class="mg"> iamRoleStatement </em>来获取函数读取文件和写入 DynamoDB 表的权限。</p><pre class="lc ld le lf gt mo mp mq mr aw ms bi"><span id="8065" class="lh li iq mp b gy mt mu l mv mw">iamRoleStatements:    <br/>- Effect: Allow      <br/>  Action:        <br/>  - s3:*      <br/>  Resource: "*"<br/>- Effect: Allow<br/>  Action:<br/>    - dynamodb:PutItem<br/>  Resource:<br/>    - &lt;dynamodb-arn&gt;</span></pre><h2 id="7989" class="lh li iq bd lj lk ll dn lm ln lo dp lp ko lq lr ls ks lt lu lv kw lw lx ly lz bi translated">代码⌨️</h2><p id="7696" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated">首先，我们需要安装一些额外的依赖项来完成繁重的工作。安装以下软件包:</p><ul class=""><li id="47e8" class="mz na iq kf b kg kh kk kl ko nb ks nc kw nd la ne nf ng nh bi translated"><a class="ae kc" href="https://www.npmjs.com/package/typedi" rel="noopener ugc nofollow" target="_blank">类型二</a></li><li id="d3d3" class="mz na iq kf b kg ni kk nj ko nk ks nl kw nm la ne nf ng nh bi translated"><a class="ae kc" href="https://www.npmjs.com/package/@fast-csv/parse" rel="noopener ugc nofollow" target="_blank">@ fast-CSV/解析</a></li></ul><pre class="lc ld le lf gt mo mp mq mr aw ms bi"><span id="da85" class="lh li iq mp b gy mt mu l mv mw">npm i @fast-csv/parse<br/>npm i typedi</span></pre><p id="98a5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">TypeDI 允许在没有紧密耦合的情况下将依赖项注入到类中。Fast-csv 是一个用于解析 csv 文件的库。</p><p id="4ee9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在让我们转向代码。bookcategory-upload 目录结构应该如下所示:</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/aa4edc58dca5258e5bacf53658184700.png" data-original-src="https://miro.medium.com/v2/resize:fit:540/format:webp/1*ef3LXyc45RiWT1caQVS3qA.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">图书类别-上传目录结构</figcaption></figure><p id="81c9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">重要文件如下:</p><blockquote class="mi mj mk"><p id="748e" class="kd ke mg kf b kg kh ki kj kk kl km kn ml kp kq kr mm kt ku kv mn kx ky kz la ij bi translated">-<strong class="kf ir">processor . ts</strong>-&gt;-<em class="iq">处理 S3 事件</em></p><p id="a6cc" class="kd ke mg kf b kg kh ki kj kk kl km kn ml kp kq kr mm kt ku kv mn kx ky kz la ij bi translated">-<strong class="kf ir">csv-record-import-service . ts</strong>-&gt;<em class="iq">读取流作为 CSV 记录并解析记录</em></p><p id="6cb3" class="kd ke mg kf b kg kh ki kj kk kl km kn ml kp kq kr mm kt ku kv mn kx ky kz la ij bi translated">-<strong class="kf ir">data-repository . ts</strong>-&gt;-<em class="iq">将记录导入数据存储</em></p></blockquote><p id="1675" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">S3 事件的处理是在 processor.ts 文件中用下面一行完成的。</p><pre class="lc ld le lf gt mo mp mq mr aw ms bi"><span id="ef9e" class="lh li iq mp b gy mt mu l mv mw">const processor: S3Handler = async (event: S3Event) =&gt; {</span></pre><p id="6f8a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用带有代码完成功能的编辑器，您可以研究 S3Event 的可能性。</p><figure class="lc ld le lf gt jr"><div class="bz fp l di"><div class="mx my l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">处理器. ts</figcaption></figure><p id="85be" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">从事件中，我们循环到记录并检索 S3 存储桶密钥。我们从桶中检索一个流，并将其传递给 CsvImportService。</p><figure class="lc ld le lf gt jr"><div class="bz fp l di"><div class="mx my l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">CSV-导入-服务. ts</figcaption></figure><p id="c022" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">CsvImportService 解析流中的每一行，并将其传递给 DataRepository 类。</p><figure class="lc ld le lf gt jr"><div class="bz fp l di"><div class="mx my l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">数据仓库. ts</figcaption></figure><p id="caac" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">DataRepository 检查类别前缀，并在类别不存在的情况下将其放入 DynamoDB 表中。表名是从 Lambda 执行的环境中提取的。</p><pre class="lc ld le lf gt mo mp mq mr aw ms bi"><span id="b6ae" class="lh li iq mp b gy mt mu l mv mw">put({                  <br/>      TableName: this.tableName,                  <br/>      Item: item,                  <br/>      ConditionExpression: 'attribute_not_exists(#name)',                      <br/>      ExpressionAttributeNames: {                    <br/>          '#name': 'code',                  <br/>    },</span></pre><h2 id="a536" class="lh li iq bd lj lk ll dn lm ln lo dp lp ko lq lr ls ks lt lu lv kw lw lx ly lz bi translated">部署🚀</h2><p id="a439" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated">现在我们已经准备好部署 Lambda 函数了。使用以下命令将其部署到您的 AWS 帐户。</p><pre class="lc ld le lf gt mo mp mq mr aw ms bi"><span id="5606" class="lh li iq mp b gy mt mu l mv mw">serverless deploy</span></pre><p id="5dd6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">成功后，你会在你的 AWS Lambda 页面上找到<em class="mg"> bookCategoryImporter </em>功能。导航到它会显示部署了 Lambda 函数的 S3 触发事件。</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi no"><img src="../Images/2db73443f76801837ee95a0e775141ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gMO7xinP3AQu7LJ52OjD5g.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">bookCategoryImporter 函数</figcaption></figure><p id="3580" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在 Serverless.yml 文件中指定的存储桶也将被创建。您可以通过上传以下文件来测试 AWS Lambda 函数:</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div class="gh gi np"><img src="../Images/e050f400e8b1eac11d02dfd9e4abebdf.png" data-original-src="https://miro.medium.com/v2/resize:fit:648/format:webp/1*zoTeBNaSZVDrkRoGAUY_sQ.png"/></div></figure><p id="3ca2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您创建了一个 DynamoDB 并上传了一个包含上述内容的 csv 文件，那么您应该在 DynamoDB 中获得以下项目:</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/6ef6b3dc9382638a1b88f65ddae728d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1312/format:webp/1*qUUlOAcQ3TrnKozOEw_j8Q.png"/></div></figure><h2 id="a263" class="lh li iq bd lj lk ll dn lm ln lo dp lp ko lq lr ls ks lt lu lv kw lw lx ly lz bi translated">完成的🙏</h2><p id="08e3" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated">所以，这就结束了。我希望这对你的无服务器之旅有所帮助。同样，这个项目的代码可以在 Github 上找到👇图书类别-上传文件夹中的【https://github.com/cyberworkz/examples】T2。</p><h1 id="dcb4" class="nr li iq bd lj ns nt nu lm nv nw nx lp ny nz oa ls ob oc od lv oe of og ly oh bi translated">海科·范德沙夫</h1><ul class=""><li id="816f" class="mz na iq kf b kg ma kk mb ko oi ks oj kw ok la ne nf ng nh bi translated"><strong class="kf ir"> <em class="mg">如果你喜欢这个，请</em> </strong> <a class="ae kc" href="https://serverlesscorner.com/about" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir"> <em class="mg">跟随 Serverlesscorner.com 上中</em> </strong> </a> <strong class="kf ir"> <em class="mg">。</em> </strong></li><li id="9126" class="mz na iq kf b kg ni kk nj ko nk ks nl kw nm la ne nf ng nh bi translated"><strong class="kf ir"> <em class="mg">爱情</em> </strong> ❤️ <strong class="kf ir"> <em class="mg">阅读</em> </strong> <strong class="kf ir"> <em class="mg">我的故事和其他关于媒？</em> </strong> <a class="ae kc" href="https://serverlesscorner.com/membership" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir"> <em class="mg">成为会员</em> </strong> </a> <strong class="kf ir"> <em class="mg">如果你还没有成为会员。</em> </strong></li><li id="7ffe" class="mz na iq kf b kg ni kk nj ko nk ks nl kw nm la ne nf ng nh bi translated"><strong class="kf ir"> <em class="mg">想阅读更多无服务器？报名参加我的</em> </strong> <a class="ae kc" href="https://serverlessconsulting.org/newsletter" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir"> <em class="mg">月刊</em> </strong> </a> <strong class="kf ir"> <em class="mg">📬关于无服务器技术和使用案例的启发性和深刻的故事。</em>T53】</strong></li></ul></div></div>    
</body>
</html>