<html>
<head>
<title>How to Connect &amp; Query SQL Server using Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用 Python 连接和查询 SQL Server</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/how-to-connect-query-sql-server-using-python-15c9d79d1207?source=collection_archive---------3-----------------------#2022-11-26">https://blog.devgenius.io/how-to-connect-query-sql-server-using-python-15c9d79d1207?source=collection_archive---------3-----------------------#2022-11-26</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="c08d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">使用 Python、SQL Server</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/cda5d628e28a53cf485c98ecb4387c54.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eO9v02lTATLSDduc9GI2pg.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">Python SQL Server 连接</figcaption></figure><p id="81b9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">今天我将讲述如何使用 python 连接到 SQL 数据库。这是在<a class="ae ky" href="https://medium.com/dev-genius/how-to-build-an-etl-pipeline-with-python-1b78407c3875" rel="noopener"> ETL 系列</a>中出现的一个常见问题。所以，我决定报道它，如果观众面临连接问题，就把他们引向它。</p><p id="1bf3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">此 SQL Server 安装程序将使您能够:</p><ul class=""><li id="c629" class="kz la in jm b jn jo jr js jv lb jz lc kd ld kh le lf lg lh bi translated">通过 Python 建立与 SQL Server 数据库的连接</li><li id="bc85" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">查询 SQL Server 数据库</li><li id="c395" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">检索数据并保存到数据帧中</li></ul><p id="896c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">完整的代码可以在<a class="ae ky" href="https://github.com/hnawaz007/pythondataanalysis/blob/main/ETL%20Pipeline/Connect%20to%20SQL%20Server%20with%20Python.ipynb" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到。相关视频教程可在<a class="ae ky" href="https://www.youtube.com/watch?v=zdezE6TWSQQ" rel="noopener ugc nofollow" target="_blank"> YouTube </a>上找到。</p><p id="2f98" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这个前提条件很少。我们需要安装和配置 SQL Server 数据库。我已经在这里报道了这个<a class="ae ky" href="https://www.youtube.com/watch?v=e5mvoKuV3xs" rel="noopener ugc nofollow" target="_blank">。此外，我们将使用 Jupyter 笔记本来排除数据库连接故障。Jupyter 笔记本电脑的安装包含在此处</a>的视频<a class="ae ky" href="https://www.youtube.com/watch?v=B0G-44dqHRM&amp;t=0s" rel="noopener ugc nofollow" target="_blank">中。</a></p><p id="827f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">对于 SQL Server，我们使用 SQL Server Native Client 11。我们可以从这个<a class="ae ky" href="https://www.microsoft.com/en-us/download/details.aspx?id=36434" rel="noopener ugc nofollow" target="_blank">链接</a>下载。只需下载安装程序，用默认设置安装即可。我们可以检查注册表编辑器，以确保安装了 SQL Server Native Client。注册表项将位于以下位置</p><pre class="kj kk kl km gt ln lo lp bn lq lr bi"><span id="0084" class="ls lt in lo b be lu lv l lw lx">Computer\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Microsoft SQL Server Native Client 11.0\CurrentVersion</span></pre><p id="bbf4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果设置完成，那么让我们启动一个 Jupyter 笔记本。为了连接到 SQL Server 数据库，我们使用 pyodbc 库。我们可以使用 pip 命令安装它。</p><pre class="kj kk kl km gt ln lo lp bn lq lr bi"><span id="8397" class="ls lt in lo b be lu lv l ly lx">Pip install pyodbc</span></pre><p id="f494" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这将在我们的机器上安装库。现在，我们可以将它导入到笔记本中。此外，让我们导入 pandas 库，这样我们就可以读取数据并将其保存在一个类似表格的结构中。</p><pre class="kj kk kl km gt ln lo lp bn lq lr bi"><span id="304f" class="ls lt in lo b be lu lv l ly lx">import pyodbc<br/>import pandas as pd</span></pre><p id="ab9e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们定义保存数据库凭证和细节的变量。我们使用 pyodbc 中的 connect 函数来建立数据库连接。</p><pre class="kj kk kl km gt ln lo lp bn lq lr bi"><span id="c113" class="ls lt in lo b be lu lv l ly lx">#database username. Use config file or env vars<br/>uid = "etl" <br/>#database password. Use config file or env vars<br/>pwd = "demopass" <br/>driver = "{SQL Server Native Client 11.0}"<br/>server = "localhost" # or your computer name<br/>database = "AdventureWorksDW2019;"</span></pre><p id="725e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在 connect 函数中，我们连接变量来创建一个连接字符串。因为我们安装了 SQL Server Express 版本，所以它有一个默认的实例名<em class="lz"> SQLExpress </em>。如果您有普通版或开发版，那么您不必在服务器名称后定义实例。</p><pre class="kj kk kl km gt ln lo lp bn lq lr bi"><span id="c3cc" class="ls lt in lo b be lu lv l ly lx">conn = pyodbc.connect('DRIVER=' + driver + ';SERVER=' + server + '\SQLEXPRESS' + ';DATABASE=' + database + ';UID=' + uid + ';PWD=' + pwd)</span></pre><p id="39f2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们需要一个 SQL 查询来测试我们与上述 SQL Server 数据库的连接。让我们发出一个简单的 select 语句，从数据库中检索一些数据。</p><pre class="kj kk kl km gt ln lo lp bn lq lr bi"><span id="2c60" class="ls lt in lo b be lu lv l ly lx">sql = "SELECT * FROM [dbo].[DimProductCategory]"</span></pre><p id="5fd1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在我们可以使用 pandas read SQL 查询函数来查询数据库。我们拥有这项功能所需的所有组件。我们为它提供 SQL 变量；这是我们保存在变量中的 SQL 查询和数据库连接。</p><pre class="kj kk kl km gt ln lo lp bn lq lr bi"><span id="dd5f" class="ls lt in lo b be lu lv l ly lx">df = pd.read_sql_query(sql, conn)<br/>df.head()</span></pre><p id="b0b2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们用 shift+enter 键执行笔记本单元格。如果这个单元执行时没有错误，那么恭喜您，您的设置已经完成，您可以继续构建 etl 管道了。</p><p id="55a8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">最常见的错误是缺少 Native client。请确保它已安装。其次将 TCP/IP 协议禁用。要解决这个问题，我们可以打开 SQL Server 配置管理器并选择网络配置。确保 TCP/IP 协议已启用。如果没有，那么右击它并启用它。进行此更改后，请确保重新启动 SQL Server 服务。</p><p id="e9cd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">结论</strong></p><ul class=""><li id="5601" class="kz la in jm b jn jo jr js jv lb jz lc kd ld kh le lf lg lh bi translated">我们讲述了如何使用 Python 建立到 SQL Server 数据库的连接。</li><li id="16df" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">我们定义数据库细节并通过 pyodbc 建立连接。</li><li id="fdb4" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">我们查询了数据库，并以熊猫数据框的形式检索了数据。</li><li id="d169" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">完整的代码可以在<a class="ae ky" href="https://github.com/hnawaz007/pythondataanalysis/blob/main/ETL%20Pipeline/Connect%20to%20SQL%20Server%20with%20Python.ipynb" rel="noopener ugc nofollow" target="_blank">这里找到</a></li></ul></div></div>    
</body>
</html>