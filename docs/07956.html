<html>
<head>
<title>MERN Auth with Session — Part 2: Session with MongoDB and Express</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用会话的 MERN 认证—第 2 部分:使用 MongoDB 和 Express 的会话</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/mern-auth-with-session-part-2-session-with-mongodb-and-express-b185c17ad6f0?source=collection_archive---------3-----------------------#2022-05-06">https://blog.devgenius.io/mern-auth-with-session-part-2-session-with-mongodb-and-express-b185c17ad6f0?source=collection_archive---------3-----------------------#2022-05-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="83ae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">TL；在本教程中，我们将使用 Expressjs、Session Auth、Reactjs 和 Material UI 构建一个登录/注册表单。</strong></p><p id="07f0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是三个部分中的第二部分，在这一部分中，我们将重点关注使用保存在数据库中的会话来授权用户。</p><p id="557d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是最终代码:<a class="ae kl" href="https://github.com/gsambrotta/auth-session-mern-boilerplate" rel="noopener ugc nofollow" target="_blank">https://github.com/gsambrotta/auth-session-mern-boilerplate</a></p><p id="8cff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是第 1 部分:<a class="ae kl" href="https://medium.com/@designbygio/mern-auth-with-session-part-1-express-login-api-922cd29336a8" rel="noopener">https://medium . com/@ design bygio/mern-auth-with-session-part-1-express-log in-API-922 CD 29336 A8</a></p><p id="2f95" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是第三部分:<a class="ae kl" href="https://medium.com/@designbygio/mern-auth-with-session-part-3-register-login-form-with-auth-af4a1f314dd1" rel="noopener">https://medium . com/@ design bygio/mern-auth-with-session-part-3-register-log in-form-with-auth-af 4a 1 f 314 DD 1</a></p></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><h1 id="0549" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">什么是会话认证？</h1><p id="03ef" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">当我们谈到会话身份验证时，我们指的是在用户登录后，创建与用户会话相关的信息并将其保存到数据库的过程。</p><p id="2fad" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">实际情况是:<br/>每次用户登录时，一个会话对象被创建并保存在数据库中。<br/>该对象包含:</p><ul class=""><li id="4c49" class="lw lx iq jp b jq jr ju jv jy ly kc lz kg ma kk mb mc md me bi translated">标识对象的 id</li><li id="a6dd" class="lw lx iq jp b jq mf ju mg jy mh kc mi kg mj kk mb mc md me bi translated">有保质期的饼干。这将跟踪用户会话的生存期。例如，如果我们给定 10 天的到期日期，用户将能够从他/她第一次登录开始连续登录 10 天。然后会话过期，用户需要再次登录。</li><li id="fa67" class="lw lx iq jp b jq mf ju mg jy mh kc mi kg mj kk mb mc md me bi translated">用户信息</li></ul><figure class="ml mm mn mo gt mp gh gi paragraph-image"><div class="gh gi mk"><img src="../Images/d3c0b4d8b9b02e9c661c5c9aed41af4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:710/format:webp/1*6Nrvt_kJ9gpavxj9CjVAnA.png"/></div><figcaption class="ms mt gj gh gi mu mv bd b be z dk translated">数据库中的会话条目示例</figcaption></figure><p id="886f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">同时，这个 cookie 是会话对象的一部分，它也被发送到客户端，并且将自动随每个请求一起发送。<br/>一旦我们在前端有了这个 cookie，我们就可以很容易地用它来验证用户是否通过了身份验证(在本教程的第 3 部分中解释)。</p><p id="c02e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，希望对会话认证的工作原理有了更清楚的了解，让我们看看如何对它进行编码。</p><h1 id="3f60" class="kt ku iq bd kv kw mw ky kz la mx lc ld le my lg lh li mz lk ll lm na lo lp lq bi translated">在数据库中创建会话条目</h1><p id="c856" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">为此，我们将使用两个流行的包。</p><ul class=""><li id="4db9" class="lw lx iq jp b jq jr ju jv jy ly kc lz kg ma kk mb mc md me bi translated"><code class="fe nb nc nd ne b">express-session</code> —创建会话对象</li><li id="656e" class="lw lx iq jp b jq mf ju mg jy mh kc mi kg mj kk mb mc md me bi translated"><code class="fe nb nc nd ne b">connect-mongodb-session</code> —将会话自动保存到 MongoDB</li></ul><p id="ad58" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们首先在我们的 Express 项目中安装软件包:</p><pre class="ml mm mn mo gt nf ne ng nh aw ni bi"><span id="7d0d" class="nj ku iq ne b gy nk nl l nm nn">$ cd server<br/>$ npm i express-session connect-mongodb-session</span></pre><figure class="ml mm mn mo gt mp"><div class="bz fp l di"><div class="no np l"/></div><figcaption class="ms mt gj gh gi mu mv bd b be z dk translated">index.js —只是会话代码</figcaption></figure><p id="2616" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这些是我们将添加到<code class="fe nb nc nd ne b">index.js</code>中的新代码位。<br/>我们先来看看它们是什么，再来看看如何整合到<code class="fe nb nc nd ne b">index.js</code>中。</p><p id="e2d1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，我们需要两个包。<br/>注意<code class="fe nb nc nd ne b">connect-mongodb-session</code>期望一个参数，即<code class="fe nb nc nd ne b">session </code>，这样它可以将会话保存到 MongoDB。<br/>之后，我们将 MongoDBStore 与 MongoDB 连接起来。<br/>我们通过传递数据库 url 和集合名称来实现。<br/>我将我的会话集合命名为<code class="fe nb nc nd ne b">mySessions.</code> <br/>如果这个集合在您的数据库中还不存在，MongoDB 会为您创建一个。</p><p id="1b25" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来是时候配置我们的会话了。<br/>首先，我们用<code class="fe nb nc nd ne b">app.use(session(...))</code>调用 session 对象作为 Express 应用级中间件。<br/>要设置会话，您可以阅读软件包中的文档，但主要是:</p><ul class=""><li id="294a" class="lw lx iq jp b jq jr ju jv jy ly kc lz kg ma kk mb mc md me bi translated"><strong class="jp ir">秘密</strong>:服务器用来验证会话的随机令牌</li><li id="fe4f" class="lw lx iq jp b jq mf ju mg jy mh kc mi kg mj kk mb mc md me bi translated"><strong class="jp ir">name</strong>:cookie 的名称，如何从客户端读取</li><li id="93dc" class="lw lx iq jp b jq mf ju mg jy mh kc mi kg mj kk mb mc md me bi translated"><strong class="jp ir"> store </strong> : <code class="fe nb nc nd ne b">MongoDBStore</code>或者你所说的与 MongoDB 的连接</li><li id="5a8e" class="lw lx iq jp b jq mf ju mg jy mh kc mi kg mj kk mb mc md me bi translated">maxAge:cookie 的截止日期</li></ul><p id="43df" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是我们如何将这些行与<code class="fe nb nc nd ne b">index.js</code>中的其余代码集成在一起</p><figure class="ml mm mn mo gt mp"><div class="bz fp l di"><div class="no np l"/></div><figcaption class="ms mt gj gh gi mu mv bd b be z dk translated">索引. js</figcaption></figure><h1 id="b4c7" class="kt ku iq bd kv kw mw ky kz la mx lc ld le my lg lh li mz lk ll lm na lo lp lq bi translated">每次登录时使用会话</h1><p id="3791" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">既然我们已经设置了会话对象和到数据库的连接。是时候使用会话了。我们前往<code class="fe nb nc nd ne b">/routers/loginRoutes.js</code>并修改<code class="fe nb nc nd ne b">POST /login</code>路线。</p><figure class="ml mm mn mo gt mp"><div class="bz fp l di"><div class="no np l"/></div><figcaption class="ms mt gj gh gi mu mv bd b be z dk translated">loginRoutes.js</figcaption></figure><p id="4652" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们只添加了三行代码:</p><ul class=""><li id="e451" class="lw lx iq jp b jq jr ju jv jy ly kc lz kg ma kk mb mc md me bi translated"><strong class="jp ir"><em class="nq">const user session = { email:user . email }</em></strong>—这里简单创建一个带有用户信息的对象，并将其命名为<code class="fe nb nc nd ne b">userSession</code></li><li id="6c43" class="lw lx iq jp b jq mf ju mg jy mh kc mi kg mj kk mb mc md me bi translated"><strong class="jp ir"><em class="nq">req . session . user = user session</em></strong><em class="nq"/>—我们将<code class="fe nb nc nd ne b">userSession</code>对象保存到<code class="fe nb nc nd ne b">req.session</code>对象，这样它就可以被每个请求传递</li><li id="392c" class="lw lx iq jp b jq mf ju mg jy mh kc mi kg mj kk mb mc md me bi translated"><strong class="jp ir"> <em class="nq"> res.status(200)。json({ msg:'您已成功登录'，userSession }) </em> </strong> —将<code class="fe nb nc nd ne b">userSession</code>添加到响应中，这样它将作为 cookie 发送到客户端。</li></ul><p id="a574" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这就是我们在每次用户登录时将会话对象保存到数据库所需要做的全部工作。<br/>如果现在您使用有效凭证向<code class="fe nb nc nd ne b">/login</code>发出 POST 请求，您应该会在数据库上看到一个名为<code class="fe nb nc nd ne b">mySession</code>的新集合，它应该包括一个会话对象，如上图所示，带有到期日期和用户电子邮件。<br/>请注意，此会话对象将在 3 小时内有效，然后将从数据库中删除。你可能想延长有效期。</p></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><p id="e8a6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在下一部分中，我们将构建登录和注册表单，并了解如何从客户端发送信息，以及如何基于 cookie 值显示不同的 UI。在顶部检查到下一部分的链接。</p></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><figure class="ml mm mn mo gt mp gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/a8762aa77c0d8d3e8f09a8844f593e6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:274/format:webp/1*_5muYU231TVKA7apk-37IA.jpeg"/></div></figure><p id="6535" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你的学习之路需要支持吗？<a class="ae kl" href="https://www.codementor.io/@giorgiasambrotta?refer=badge" rel="noopener ugc nofollow" target="_blank">我们来聊聊 codementor </a></p></div></div>    
</body>
</html>