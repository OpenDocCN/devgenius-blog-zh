<html>
<head>
<title>How to implement map previews and location sharing on Android</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在 Android 上实现地图预览和位置共享</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/how-to-implement-map-previews-and-location-sharing-on-android-5743a747f37c?source=collection_archive---------8-----------------------#2022-04-26">https://blog.devgenius.io/how-to-implement-map-previews-and-location-sharing-on-android-5743a747f37c?source=collection_archive---------8-----------------------#2022-04-26</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><figure class="im in gp gr io ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi il"><img src="../Images/c8f1330114f114987e869c54c631b73b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Ba7siy_UA72xh6La.png"/></div></div><figcaption class="iw ix gj gh gi iy iz bd b be z dk translated">2022 仙鸟</figcaption></figure><div class=""/><div class=""><h2 id="c446" class="pw-subtitle-paragraph jz jb jc bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">允许用户使用 Google Play 服务地图 SDK 发送显示其位置的聊天地图</h2></div><p id="b748" class="pw-post-body-paragraph kr ks jc kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">解决方案工程师| <a class="ae ln" href="https://www.sendbird.com/" rel="noopener ugc nofollow" target="_blank"> Sendbird </a></p><p id="2142" class="pw-post-body-paragraph kr ks jc kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated"><em class="lo">如需更多指导，请参见我们的</em> <a class="ae ln" href="https://sendbird.com/docs/desk/v1/android/guides/link-preview" rel="noopener ugc nofollow" target="_blank"> <em class="lo">文档</em> </a> <em class="lo">。你可能还想看一个仙鸟聊天的</em><a class="ae ln" href="https://sendbird.com/demos/in-app-chat" rel="noopener ugc nofollow" target="_blank"><em class="lo">demo</em></a><em class="lo">。查看此</em> <a class="ae ln" href="https://sendbird.com/features/chat-messaging" rel="noopener ugc nofollow" target="_blank"> <em class="lo">页面</em> </a> <em class="lo">了解更多关于仙鸟聊天的信息。</em></p><blockquote class="lp lq lr"><p id="2ec6" class="kr ks lo kt b ku kv kd kw kx ky kg kz ls lb lc ld lt lf lg lh lu lj lk ll lm ig bi translated"><em class="jc">成为第一个了解新教程、开发者相关聊天/电话发布以及其他重要更新的人，</em> <a class="ae ln" href="https://get.sendbird.com/dev-newsletter-subscription.html" rel="noopener ugc nofollow" target="_blank"> <em class="jc">注册</em> </a> <em class="jc">我们的开发者简讯。</em></p></blockquote><h1 id="f2d9" class="lv lw jc bd lx ly lz ma mb mc md me mf ki mg kj mh kl mi km mj ko mk kp ml mm bi translated">介绍</h1><p id="0fac" class="pw-post-body-paragraph kr ks jc kt b ku mn kd kw kx mo kg kz la mp lc ld le mq lg lh li mr lk ll lm ig bi translated">应用内位置共享和地图预览提供了一种与朋友和服务提供商交流地理位置的有效方式。它们消除了到达某个位置的方向的任何模糊性，并让用户安心，同时允许用户监控旅行的进度。例如，位置共享简化了送货服务人员的生活，并提高了他们的客户在查询时发送其位置的满意度。</p><p id="a97e" class="pw-post-body-paragraph kr ks jc kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">地图和信息是协调实时互动的绝佳方式。奥美集团副主席、《炼金术:在品牌、商业和生活中创造魔法的黑暗艺术和奇特科学》一书的作者罗里·萨瑟兰提醒我们，为什么优步地图是<a class="ae ln" href="https://www.youtube.com/watch?v=iueVZJVEmEs" rel="noopener ugc nofollow" target="_blank">魔法</a>。他称之为:</p><p id="e946" class="pw-post-body-paragraph kr ks jc kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">“…一个心理上的幻想，因为它并没有减少等待出租车的时间，只是让等待的沮丧感减少了 90%。”罗里·萨瑟兰</p><p id="498e" class="pw-post-body-paragraph kr ks jc kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">正如您所猜测的，该功能特别适用于以下行业的应用:</p><ul class=""><li id="4fd8" class="ms mt jc kt b ku kv kx ky la mu le mv li mw lm mx my mz na bi translated">交通和拼车</li><li id="dd40" class="ms mt jc kt b ku nb kx nc la nd le ne li nf lm mx my mz na bi translated">交付和物流</li><li id="b0f9" class="ms mt jc kt b ku nb kx nc la nd le ne li nf lm mx my mz na bi translated">食品或杂货递送</li><li id="f336" class="ms mt jc kt b ku nb kx nc la nd le ne li nf lm mx my mz na bi translated">其他消费品交付</li><li id="70cf" class="ms mt jc kt b ku nb kx nc la nd le ne li nf lm mx my mz na bi translated">线上到线下服务</li></ul><p id="b0c1" class="pw-post-body-paragraph kr ks jc kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">这个简单的教程将带你通过易于理解的消息内地图预览实现位置共享。</p><p id="1ebc" class="pw-post-body-paragraph kr ks jc kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">请注意，本指南假设您已经使用 Sendbird SDK 实现了 chat。如果您还没有，请查看<a class="ae ln" href="https://sendbird.com/docs/chat/v3/android/quickstart/send-first-message" rel="noopener ugc nofollow" target="_blank">文档</a>或<a class="ae ln" href="https://sendbird.com/developer/tutorials/build-chat-uikit-android" rel="noopener ugc nofollow" target="_blank">本教程</a>以了解如何做到这一点。</p><p id="75e8" class="pw-post-body-paragraph kr ks jc kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">我们开始吧！💻</p><h1 id="49b6" class="lv lw jc bd lx ly lz ma mb mc md me mf ki mg kj mh kl mi km mj ko mk kp ml mm bi translated">在 Sendbird 中实现位置共享和地图预览</h1><p id="88c3" class="pw-post-body-paragraph kr ks jc kt b ku mn kd kw kx mo kg kz la mp lc ld le mq lg lh li mr lk ll lm ig bi translated">当用户按下“分享位置”按钮时，Android 的<code class="fe ng nh ni nj b">LocationManager</code>类提供用户的地理坐标。Sendbird 在一个<code class="fe ng nh ni nj b">UserMessage</code>中发送他们的位置，其中<code class="fe ng nh ni nj b">CustomType</code>被设置为 location。发送消息后，通过其适配器插入<code class="fe ng nh ni nj b">RecyclerView</code>。基于<code class="fe ng nh ni nj b">MessageType(UserMessage)</code>和<code class="fe ng nh ni nj b">CustomType(location)</code>,<code class="fe ng nh ni nj b">layoutInflater</code>展开一个包含<code class="fe ng nh ni nj b">MapView</code>的自定义视图。最后，您将地理坐标添加到<code class="fe ng nh ni nj b">MapView</code>中。</p><p id="f46d" class="pw-post-body-paragraph kr ks jc kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">请注意，使用 Google Play 服务地图 SDK，用户可以在应用内聊天中分享他们的位置，而接收者可以在 Google Maps 中打开该位置。Sendbird 以易于理解的预览方式显示地图，以便快速浏览。</p><figure class="nl nm nn no gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi nk"><img src="../Images/4b33d0a005c5054b7c023b2a2969449b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*oMn9k-s8udGLwUgi.png"/></div></div></figure><p id="3f38" class="pw-post-body-paragraph kr ks jc kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">要实现位置共享和地图预览，请执行以下步骤:</p><ul class=""><li id="3830" class="ms mt jc kt b ku kv kx ky la mu le mv li mw lm mx my mz na bi translated">了解 Android 上位置共享和地图预览的先决条件(如下所述)</li><li id="bd0b" class="ms mt jc kt b ku nb kx nc la nd le ne li nf lm mx my mz na bi translated">获得使用用户位置的权限</li><li id="8ef2" class="ms mt jc kt b ku nb kx nc la nd le ne li nf lm mx my mz na bi translated">声明您的 API 访问令牌和对地图的依赖</li><li id="27f8" class="ms mt jc kt b ku nb kx nc la nd le ne li nf lm mx my mz na bi translated">创建发件人和收件人的布局</li><li id="ed1c" class="ms mt jc kt b ku nb kx nc la nd le ne li nf lm mx my mz na bi translated">检索用户的位置</li><li id="6f32" class="ms mt jc kt b ku nb kx nc la nd le ne li nf lm mx my mz na bi translated">在<code class="fe ng nh ni nj b">UserMessage</code>中发送用户的位置</li><li id="9b04" class="ms mt jc kt b ku nb kx nc la nd le ne li nf lm mx my mz na bi translated">通过检查自定义类型来处理收到的消息，并将其绑定到视图</li></ul><h1 id="066d" class="lv lw jc bd lx ly lz ma mb mc md me mf ki mg kj mh kl mi km mj ko mk kp ml mm bi translated">位置共享和地图预览的先决条件</h1><p id="b4c4" class="pw-post-body-paragraph kr ks jc kt b ku mn kd kw kx mo kg kz la mp lc ld le mq lg lh li mr lk ll lm ig bi translated">再次重申，本指南假设您已经使用 Sendbird SDK 实现了 chat。查看<a class="ae ln" href="https://sendbird.com/docs/chat/v3/android/quickstart/send-first-message" rel="noopener ugc nofollow" target="_blank">文档</a>或<a class="ae ln" href="https://sendbird.com/developer/tutorials/build-chat-uikit-android" rel="noopener ugc nofollow" target="_blank">本教程</a>了解更多信息。</p><p id="c13e" class="pw-post-body-paragraph kr ks jc kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">请注意，本指南中的代码使用 Sendbird 的 SyncManager SDK 来发送和接收消息。</p><p id="80cb" class="pw-post-body-paragraph kr ks jc kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">您将需要:</p><ul class=""><li id="8096" class="ms mt jc kt b ku kv kx ky la mu le mv li mw lm mx my mz na bi translated">Sendbird Android SDK</li><li id="cd53" class="ms mt jc kt b ku nb kx nc la nd le ne li nf lm mx my mz na bi translated">Google Play 服务地图 SDK</li><li id="60de" class="ms mt jc kt b ku nb kx nc la nd le ne li nf lm mx my mz na bi translated"><a class="ae ln" href="https://developers.google.com/maps/documentation/android-sdk/get-api-key" rel="noopener ugc nofollow" target="_blank">一个谷歌 API 访问令牌</a></li></ul><p id="1d03" class="pw-post-body-paragraph kr ks jc kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">注意:</p><ul class=""><li id="e52b" class="ms mt jc kt b ku kv kx ky la mu le mv li mw lm mx my mz na bi translated">如果你使用的是 Android 的内置模拟器，请注意它可能不会显示你的位置。</li></ul><p id="87cc" class="pw-post-body-paragraph kr ks jc kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">其他资源:</p><ul class=""><li id="500a" class="ms mt jc kt b ku kv kx ky la mu le mv li mw lm mx my mz na bi translated">谷歌官方地图指南</li><li id="5a81" class="ms mt jc kt b ku nb kx nc la nd le ne li nf lm mx my mz na bi translated">使用地图的谷歌官方示例应用程序</li></ul><h1 id="456c" class="lv lw jc bd lx ly lz ma mb mc md me mf ki mg kj mh kl mi km mj ko mk kp ml mm bi translated">步骤 1:获得使用用户位置的许可</h1><p id="7a80" class="pw-post-body-paragraph kr ks jc kt b ku mn kd kw kx mo kg kz la mp lc ld le mq lg lh li mr lk ll lm ig bi translated">要使用位置共享，您需要获得使用用户位置的权限。</p><p id="1339" class="pw-post-body-paragraph kr ks jc kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">在运行时请求此。为了简洁起见，本指南省略了运行时代码。</p><p id="77ff" class="pw-post-body-paragraph kr ks jc kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">相反，它显示权限，如<code class="fe ng nh ni nj b">AndroidManifest.xml</code>所示。</p><figure class="nl nm nn no gt ip"><div class="bz fp l di"><div class="np nq l"/></div></figure><h1 id="7983" class="lv lw jc bd lx ly lz ma mb mc md me mf ki mg kj mh kl mi km mj ko mk kp ml mm bi translated">步骤 2:声明您的 API 访问令牌，并为 maps 添加一个依赖项</h1><p id="7c9c" class="pw-post-body-paragraph kr ks jc kt b ku mn kd kw kx mo kg kz la mp lc ld le mq lg lh li mr lk ll lm ig bi translated">在<code class="fe ng nh ni nj b">AndroidManifest.xml</code>中声明您的 API 访问令牌。</p><figure class="nl nm nn no gt ip"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="f930" class="pw-post-body-paragraph kr ks jc kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">在应用级<code class="fe ng nh ni nj b">build.gradle</code>文件中添加一个地图依赖。</p><figure class="nl nm nn no gt ip"><div class="bz fp l di"><div class="np nq l"/></div></figure><h1 id="c11c" class="lv lw jc bd lx ly lz ma mb mc md me mf ki mg kj mh kl mi km mj ko mk kp ml mm bi translated">步骤 3:为发件人和收件人创建布局</h1><p id="78e4" class="pw-post-body-paragraph kr ks jc kt b ku mn kd kw kx mo kg kz la mp lc ld le mq lg lh li mr lk ll lm ig bi translated">创建聊天双方的布局，即发送方和接收方。本指南将它们区分为“我”和“其他”，其中“我”代表发送者，“其他”代表接收者。两者都应该包含一个<code class="fe ng nh ni nj b">MapView</code>。</p><figure class="nl nm nn no gt ip"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="29f9" class="pw-post-body-paragraph kr ks jc kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">查看每个布局的完整要点。</p><p id="21d7" class="pw-post-body-paragraph kr ks jc kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">我(发件人):</p><figure class="nl nm nn no gt ip"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="f9fa" class="pw-post-body-paragraph kr ks jc kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">其他(收件人):</p><figure class="nl nm nn no gt ip"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="e5f4" class="pw-post-body-paragraph kr ks jc kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">注意:</p><p id="3a3b" class="pw-post-body-paragraph kr ks jc kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">本指南跳过了设置<code class="fe ng nh ni nj b">recyclerview</code>，设置按钮监听器等的实现。您可以在本要点中查看示例代码。</p><h1 id="6c68" class="lv lw jc bd lx ly lz ma mb mc md me mf ki mg kj mh kl mi km mj ko mk kp ml mm bi translated">步骤 4:检索用户的位置</h1><p id="34a7" class="pw-post-body-paragraph kr ks jc kt b ku mn kd kw kx mo kg kz la mp lc ld le mq lg lh li mr lk ll lm ig bi translated">从<code class="fe ng nh ni nj b">LocationManager</code>检索地理坐标。当用户决定共享他们的位置时，就会发生这种情况。</p><figure class="nl nm nn no gt ip"><div class="bz fp l di"><div class="np nq l"/></div></figure><h1 id="2e7e" class="lv lw jc bd lx ly lz ma mb mc md me mf ki mg kj mh kl mi km mj ko mk kp ml mm bi translated">步骤 5:在用户消息中发送用户的位置</h1><p id="df07" class="pw-post-body-paragraph kr ks jc kt b ku mn kd kw kx mo kg kz la mp lc ld le mq lg lh li mr lk ll lm ig bi translated">一旦获得经度和纬度，就以<code class="fe ng nh ni nj b">UserMessage</code>的形式发送它。为了表明这是一个位置，将单个消息上的<code class="fe ng nh ni nj b">CustomType</code>设置为“位置”</p><p id="617c" class="pw-post-body-paragraph kr ks jc kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">接下来，通过将消息添加到适配器，将消息插入到<code class="fe ng nh ni nj b">RecyclerView</code>中。</p><p id="3247" class="pw-post-body-paragraph kr ks jc kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">完整的实现见下文。</p><figure class="nl nm nn no gt ip"><div class="bz fp l di"><div class="np nq l"/></div></figure><h1 id="3660" class="lv lw jc bd lx ly lz ma mb mc md me mf ki mg kj mh kl mi km mj ko mk kp ml mm bi translated">步骤 6:将视图绑定到客户视图持有者</h1><p id="ac11" class="pw-post-body-paragraph kr ks jc kt b ku mn kd kw kx mo kg kz la mp lc ld le mq lg lh li mr lk ll lm ig bi translated">将消息添加到适配器之后，在绑定视图之前检查消息类型。通过覆盖<code class="fe ng nh ni nj b">getItemViewType</code>来做到这一点。</p><figure class="nl nm nn no gt ip"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="3743" class="pw-post-body-paragraph kr ks jc kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">基于<code class="fe ng nh ni nj b">getItemViewType</code>返回的内容，根据消息是属于“我”(发送者)还是“其他”(接收者)，展开布局。</p><figure class="nl nm nn no gt ip"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="e02a" class="pw-post-body-paragraph kr ks jc kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">接下来，将视图绑定到您的<code class="fe ng nh ni nj b">custom viewHolder</code>。</p><figure class="nl nm nn no gt ip"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="dfdb" class="pw-post-body-paragraph kr ks jc kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">在您的自定义<code class="fe ng nh ni nj b">viewHolder</code>中，实现<code class="fe ng nh ni nj b">OnMapReadyCallback</code>，并覆盖<code class="fe ng nh ni nj b">onMapReady</code>函数。</p><figure class="nl nm nn no gt ip"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="8d33" class="pw-post-body-paragraph kr ks jc kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">您可能会发现查看完整的适配器代码非常有用。</p><figure class="nl nm nn no gt ip"><div class="bz fp l di"><div class="np nq l"/></div></figure><h1 id="3c0f" class="lv lw jc bd lx ly lz ma mb mc md me mf ki mg kj mh kl mi km mj ko mk kp ml mm bi translated">结论</h1><p id="2183" class="pw-post-body-paragraph kr ks jc kt b ku mn kd kw kx mo kg kz la mp lc ld le mq lg lh li mr lk ll lm ig bi translated">就这样结束了！通过 Sendbird 的地图预览和位置共享实施，您的用户现在可以发送显示他们位置的地图，从而改善与他人的交流，并使他们的应用程序体验更具魔力。</p><p id="3886" class="pw-post-body-paragraph kr ks jc kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">编码快乐！💻</p><blockquote class="lp lq lr"><p id="0d6b" class="kr ks lo kt b ku kv kd kw kx ky kg kz ls lb lc ld lt lf lg lh lu lj lk ll lm ig bi translated"><em class="jc">为了第一时间了解新教程、与开发者相关的聊天/电话发布以及其他重要更新，</em> <a class="ae ln" href="https://get.sendbird.com/dev-newsletter-subscription.html" rel="noopener ugc nofollow" target="_blank"> <em class="jc">注册我们的开发者简讯</em> </a> <em class="jc">。</em></p></blockquote></div></div>    
</body>
</html>