<html>
<head>
<title>K8s — pause container</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">K8s —暂停容器</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/k8s-pause-container-f7abd1e9b488?source=collection_archive---------0-----------------------#2022-10-23">https://blog.devgenius.io/k8s-pause-container-f7abd1e9b488?source=collection_archive---------0-----------------------#2022-10-23</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><div class=""/><div class=""><h2 id="0e17" class="pw-subtitle-paragraph jo iq ir bd b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dk translated">为什么我们在 K8s 吊舱中有暂停容器？</h2></div><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div class="gi gj kg"><img src="../Images/928dbbb87d67196991f5006442e70dcf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1134/format:webp/0*MJQBtMd0aYyKAuQM.png"/></div></figure><p id="d096" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">当您检查 K8s 集群上运行的容器时，您经常会看到<code class="fe lk ll lm ln b">pause</code>容器，例如下面的例子:</p><p id="f5e0" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">你有没有想过为什么会有<code class="fe lk ll lm ln b">pause</code>容器？当我们创建 pod 时，我们不记得我们曾经创建过这些<code class="fe lk ll lm ln b">pause</code>容器，那么它们来自哪里呢？你可能会想，既然这些容器不是我们自己创建的，也许是 K8s 集群自动创建的？</p><p id="e84a" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">没错，这些<code class="fe lk ll lm ln b">pause</code>容器是 K8s 创建的，你可以认为是 K8s 给的免费容器。例如:</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gi gj lo"><img src="../Images/fa4ac405c7c8012d1e3dc0b6d454b200.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y9oVBQEhMOnY-EyHqcInnw.png"/></div></div></figure><p id="89b0" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">K8s 中所谓的<code class="fe lk ll lm ln b">pause</code>容器有时被称为<code class="fe lk ll lm ln b">infra</code>容器。它与用户容器“捆绑”在一起，在同一个 Pod 中运行。</p><p id="45a5" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated"><code class="fe lk ll lm ln b">pause</code>容器是 Pod 网络模型的精髓。了解<code class="fe lk ll lm ln b">pause</code>容器可以更好的帮助你理解 K8s Pod 设计的初衷。</p><h1 id="f827" class="lt lu ir bd lv lw lx ly lz ma mb mc md jx me jy mf ka mg kb mh kd mi ke mj mk bi translated">暂停容器</h1><p id="d118" class="pw-post-body-paragraph ko kp ir kq b kr ml js kt ku mm jv kw kx mn kz la lb mo ld le lf mp lh li lj ik bi translated">创建 Pod 时，<code class="fe lk ll lm ln b">kubelet</code>进程首先调用 CRI 接口<code class="fe lk ll lm ln b">RuntimeService.RunPodSandbox</code>创建沙盒环境，设置网络等基本操作环境。</p><p id="cc8d" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">一旦 Pod 沙箱建立起来，<code class="fe lk ll lm ln b">kubelet</code>就可以在其中创建用户容器。当需要删除一个容器时，<code class="fe lk ll lm ln b">kubelet</code>将首先移除容器沙箱，然后停止里面的所有容器。</p><p id="83e0" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated"><code class="fe lk ll lm ln b">pause</code>容器是存在于<strong class="kq is">每个</strong> pod 中的一个容器，它就像一个模板或父容器，pod 中的所有新容器都从其继承名称空间。<code class="fe lk ll lm ln b">pause</code>容器启动，然后进入“睡眠”。</p><p id="0efb" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">它是一个“模板”容器，保留了 pod 中所有容器共享的名称空间。</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div class="gi gj mq"><img src="../Images/73d3bd4f1d3c031d3264ebc6fcd25520.png" data-original-src="https://miro.medium.com/v2/resize:fit:640/format:webp/0*p0P9es-zJPbWpKwE.jpg"/></div><figcaption class="mr ms gk gi gj mt mu bd b be z dk translated">来自<a class="ae mv" href="https://www.ithands-on.com/" rel="noopener ugc nofollow" target="_blank">的图片手动打开</a></figcaption></figure><p id="746d" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">从下面的<code class="fe lk ll lm ln b">pause.c</code> <a class="ae mv" href="https://github.com/kubernetes/kubernetes/blob/master/build/pause/linux/pause.c" rel="noopener ugc nofollow" target="_blank">源代码</a>可以看出:</p><pre class="kh ki kj kk gu mw ln mx my aw mz bi"><span id="2b55" class="na lu ir ln b gz nb nc l nd ne">#include &lt;signal.h&gt;<br/>#include &lt;stdio.h&gt;<br/>#include &lt;stdlib.h&gt;<br/>#include &lt;string.h&gt;<br/>#include &lt;sys/types.h&gt;<br/>#include &lt;sys/wait.h&gt;<br/>#include &lt;unistd.h&gt;</span><span id="d20e" class="na lu ir ln b gz nf nc l nd ne">#define STRINGIFY(x) #x<br/>#define VERSION_STRING(x) STRINGIFY(x)</span><span id="3e3e" class="na lu ir ln b gz nf nc l nd ne">#ifndef VERSION<br/>#define VERSION HEAD<br/>#endif</span><span id="249d" class="na lu ir ln b gz nf nc l nd ne">static void sigdown(int signo) {<br/>  psignal(signo, "Shutting down, got signal");<br/>  exit(0);<br/>}</span><span id="9dba" class="na lu ir ln b gz nf nc l nd ne">static void sigreap(int signo) {<br/>  while (waitpid(-1, NULL, WNOHANG) &gt; 0)<br/>    ;<br/>}</span><span id="1704" class="na lu ir ln b gz nf nc l nd ne">int main(int argc, char **argv) {<br/>  int i;<br/>  for (i = 1; i &lt; argc; ++i) {<br/>    if (!strcasecmp(argv[i], "-v")) {<br/>      printf("pause.c %s\n", VERSION_STRING(VERSION));<br/>      return 0;<br/>    }<br/>  }</span><span id="1a17" class="na lu ir ln b gz nf nc l nd ne">if (getpid() != 1)<br/>    /* Not an error because pause sees use outside of infra containers. */<br/>    fprintf(stderr, "Warning: pause should be the first process\n");</span><span id="a824" class="na lu ir ln b gz nf nc l nd ne">if (sigaction(SIGINT, &amp;(struct sigaction){.sa_handler = sigdown}, NULL) &lt; 0)<br/>    return 1;<br/>  if (sigaction(SIGTERM, &amp;(struct sigaction){.sa_handler = sigdown}, NULL) &lt; 0)<br/>    return 2;<br/>  if (sigaction(SIGCHLD, &amp;(struct sigaction){.sa_handler = sigreap,<br/>                                             .sa_flags = SA_NOCLDSTOP},<br/>                NULL) &lt; 0)<br/>    return 3;</span><span id="a904" class="na lu ir ln b gz nf nc l nd ne">for (;;)<br/>    pause();<br/>  fprintf(stderr, "Error: infinite loop terminated\n");<br/>  return 42;<br/>}</span></pre><p id="032c" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">您可以看到<code class="fe lk ll lm ln b">pause</code>容器做了以下两件事。</p><ol class=""><li id="a3c2" class="ng nh ir kq b kr ks ku kv kx ni lb nj lf nk lj nl nm nn no bi translated">注册各种信号处理函数，主要处理两类信息:退出信号和子信号。当它接收到<code class="fe lk ll lm ln b">SIGINT</code>或<code class="fe lk ll lm ln b">SIGTERM</code>时，直接退出。当收到<code class="fe lk ll lm ln b">SIGCHLD</code>信号时，调用<code class="fe lk ll lm ln b">waitpid</code>并回收退出的进程。</li><li id="1d88" class="ng nh ir kq b kr np ku nq kx nr lb ns lf nt lj nl nm nn no bi translated">循环的主进程调用<code class="fe lk ll lm ln b">pause()</code>函数，让进程休眠，直到它被终止或收到信号。</li></ol><p id="a4fc" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">因此，即使 Pod 中的最后一个容器崩溃，共享的名称空间仍然存在，因为<code class="fe lk ll lm ln b">pause</code>容器持有名称空间。</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div class="gi gj mq"><img src="../Images/c0854b6a08581ff0f4180fcca31e7a39.png" data-original-src="https://miro.medium.com/v2/resize:fit:640/format:webp/0*it3UszxHHlhkW26p.jpg"/></div><figcaption class="mr ms gk gi gj mt mu bd b be z dk translated">来自<a class="ae mv" href="https://www.ithands-on.com/" rel="noopener ugc nofollow" target="_blank">的图片手动打开</a></figcaption></figure><h1 id="fa5d" class="lt lu ir bd lv lw lx ly lz ma mb mc md jx me jy mf ka mg kb mh kd mi ke mj mk bi translated"><strong class="ak">暂停容器演示</strong></h1><p id="0e5c" class="pw-post-body-paragraph ko kp ir kq b kr ml js kt ku mm jv kw kx mn kz la lb mo ld le lf mp lh li lj ik bi translated">当您在 Linux 系统上运行一个新进程时，该进程从父进程继承其名称空间。在命名空间中运行进程的方法是通过取消与父进程共享的命名空间来创建一个新的命名空间。以下是使用<code class="fe lk ll lm ln b">unshare</code>工具在新的 PID、UTS、IPC 和 mount 名称空间中运行 shell 的示例。</p><pre class="kh ki kj kk gu mw ln mx my aw mz bi"><span id="4c44" class="na lu ir ln b gz nb nc l nd ne">$ unshare --pid --uts --ipc --mount -f chroot rootfs /bin/sh</span></pre><p id="1b07" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">一旦一个流程正在运行，您可以将其他流程添加到该流程的名称空间中以形成一个 Pod，其中 Pod 中的容器共享该名称空间。</p><p id="244a" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">以<code class="fe lk ll lm ln b">docker</code>为例，让我们看看如何使用<code class="fe lk ll lm ln b">pause</code>容器和共享名称空间从头开始创建一个 Pod。</p><h2 id="f460" class="na lu ir bd lv nu nv dn lz nw nx dp md kx ny nz mf lb oa ob mh lf oc od mj oe bi translated">创建暂停容器</h2><pre class="kh ki kj kk gu mw ln mx my aw mz bi"><span id="89e2" class="na lu ir ln b gz nb nc l nd ne">$ docker run -d --name pause gcr.io/google_containers/pause-amd64:3.0<br/>Unable to find image 'gcr.io/google_containers/pause-amd64:3.0' locally<br/>3.0: Pulling from google_containers/pause-amd64<br/>a3ed95caeb02: Pull complete<br/>f11233434377: Pull complete<br/>Digest: sha256:163ac025575b775d1c0f9bf0bdd0f086883171eb475b5068e7defa4ca9e76516<br/>Status: Downloaded newer image for gcr.io/google_containers/pause-amd64:3.0<br/>aa603afaba05b18f8e53844f216d965fb2487feddd32937f56611499af24c0a1</span></pre><h2 id="e39c" class="na lu ir bd lv nu nv dn lz nw nx dp md kx ny nz mf lb oa ob mh lf oc od mj oe bi translated">运行 nginx 容器</h2><p id="4ce8" class="pw-post-body-paragraph ko kp ir kq b kr ml js kt ku mm jv kw kx mn kz la lb mo ld le lf mp lh li lj ik bi translated">接下来我们运行一个<code class="fe lk ll lm ln b">nginx</code>容器:</p><pre class="kh ki kj kk gu mw ln mx my aw mz bi"><span id="07e4" class="na lu ir ln b gz nb nc l nd ne">$ docker run -d --name nginx --net=container:pause  --pid=container:pause nginx</span></pre><h2 id="0f7c" class="na lu ir bd lv nu nv dn lz nw nx dp md kx ny nz mf lb oa ob mh lf oc od mj oe bi translated">检查网络名称空间</h2><p id="08bf" class="pw-post-body-paragraph ko kp ir kq b kr ml js kt ku mm jv kw kx mn kz la lb mo ld le lf mp lh li lj ik bi translated">首先让我们获得<code class="fe lk ll lm ln b">pause</code>和<code class="fe lk ll lm ln b">nginx</code>容器的 PID:</p><pre class="kh ki kj kk gu mw ln mx my aw mz bi"><span id="56a7" class="na lu ir ln b gz nb nc l nd ne">$ ps -ef | grep pause<br/>root      9377  9353  0 15:47 ?        00:00:00 /pause</span><span id="c7ca" class="na lu ir ln b gz nf nc l nd ne">$ ps -ef | grep nginx<br/>root      9932  9910  0 15:53 ?        00:00:00 nginx: master process nginx -g daemon off;</span></pre><p id="0d85" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">现在让我们检查网络命名空间 ID:</p><pre class="kh ki kj kk gu mw ln mx my aw mz bi"><span id="8a37" class="na lu ir ln b gz nb nc l nd ne">$ lsns | grep pause | grep net<br/>4026532388 net         4  9377 root   /pause</span></pre><p id="dbb4" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">如您所见，<code class="fe lk ll lm ln b">pause</code>容器的网络名称空间 ID 是<code class="fe lk ll lm ln b">4026532388</code>。</p><p id="8c3d" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">现在让我们找出<code class="fe lk ll lm ln b">nginx</code>的网络名称空间 ID。</p><pre class="kh ki kj kk gu mw ln mx my aw mz bi"><span id="6cec" class="na lu ir ln b gz nb nc l nd ne">$ readlink /proc/9932/task/9932/ns/net<br/>net:[4026532388]</span></pre><p id="d9bb" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">因此，我们可以确认<code class="fe lk ll lm ln b">nginx</code>容器与<code class="fe lk ll lm ln b">pause</code>容器共享同一个网络名称空间。</p></div></div>    
</body>
</html>