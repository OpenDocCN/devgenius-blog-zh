<html>
<head>
<title>Containerizing .net core + PostgreSQL application using docker and docker-compose</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">集装箱化。net core + PostgreSQL 应用使用 docker 和 docker-compose</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/containerizing-net-core-postgresql-application-using-docker-and-docker-compose-af06831568a5?source=collection_archive---------0-----------------------#2022-09-04">https://blog.devgenius.io/containerizing-net-core-postgresql-application-using-docker-and-docker-compose-af06831568a5?source=collection_archive---------0-----------------------#2022-09-04</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/9c628cde4118871e1bbb42dfde4728fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*AEqweNtukEChVgqt"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated"><a class="ae jz" href="https://unsplash.com/@carrier_lost?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">伊恩·泰勒</a>在<a class="ae jz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</figcaption></figure><p id="250b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在构建软件时，我们可以遵循大量的架构设计，微服务架构是众所周知的架构设计之一，我们可以使用它来构建松散耦合、可独立部署的软件。在本文中，我将介绍如何使用？net core 和 PostgreSQL 借助 docker 和 docker-compose。</p><figure class="kz la lb lc gt jo gh gi paragraph-image"><div class="gh gi ky"><img src="../Images/29440dc44aecfac32d0fa2e4cfc4d3d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1282/format:webp/1*D2GVKiMsMy0u4td1x0K8Sg.png"/></div></figure><p id="8b16" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">本文将涵盖上图中突出显示的区域，而不会涵盖 API 网关之类的场景，因为这可能超出了本文的范围。</p><p id="f244" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">让我们开始吧，首先我们需要在我们的机器上安装以下软件，</p><ul class=""><li id="7cc7" class="ld le in kc b kd ke kh ki kl lf kp lg kt lh kx li lj lk ll bi translated"><a class="ae jz" href="https://visualstudio.microsoft.com/" rel="noopener ugc nofollow" target="_blank"> Visual Studio </a></li><li id="999b" class="ld le in kc b kd lm kh ln kl lo kp lp kt lq kx li lj lk ll bi translated"><a class="ae jz" href="https://docs.docker.com/desktop/install/windows-install/" rel="noopener ugc nofollow" target="_blank">码头工人</a></li><li id="f35c" class="ld le in kc b kd lm kh ln kl lo kp lp kt lq kx li lj lk ll bi translated"><a class="ae jz" href="https://www.postgresql.org/download/windows/" rel="noopener ugc nofollow" target="_blank"> PostgreSQL </a></li></ul><p id="9b8c" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">根据您的操作系统，安装可能略有不同。一旦你设置好所需的软件，让我们开始编码吧。</p><figure class="kz la lb lc gt jo gh gi paragraph-image"><div class="gh gi lr"><img src="../Images/ddbdf34090efed7adb1b97748c9380ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/1*bGFerF-JplXpeqfEBprTvw.jpeg"/></div></figure><p id="8d43" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">首先，我将从 Visual Studio 模板中选择一个空白解决方案，并创建一个目录结构，如下图所示。目录结构不需要和我创建的一样，你可以用你自己的方式定义它。</p><p id="d629" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Infrastructure 文件夹用于保存域文件夹下的域实体，我在 Infrastructure 文件夹中实现了存储库模式，它将充当应用程序的数据访问和业务逻辑之间的抽象层。模型文件夹将保存我们的 API 所需的请求和响应模型。</p><figure class="kz la lb lc gt jo gh gi paragraph-image"><div class="gh gi ls"><img src="../Images/3e8e9a7c740776b00b3ef706c2f4dd2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:870/format:webp/1*d7SOl80ld-Jqcwt9ZHTLIw.png"/></div></figure><p id="8ab9" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">定义目录结构后，让我们安装实现所需的 nuget 包。</p><figure class="kz la lb lc gt jo gh gi paragraph-image"><div class="gh gi lt"><img src="../Images/13769809c07970f05a99c61073772959.png" data-original-src="https://miro.medium.com/v2/resize:fit:858/format:webp/1*82q1A0WzO0EBC3UELhRTKw.png"/></div></figure><ul class=""><li id="b8fe" class="ld le in kc b kd ke kh ki kl lf kp lg kt lh kx li lj lk ll bi translated">Npgsql。<a class="ae jz" href="https://www.nuget.org/packages/Npgsql.EntityFrameworkCore.PostgreSQL/7.0.0-preview.7" rel="noopener ugc nofollow" target="_blank"> EntityFrameworkCore </a>。一种数据库系统</li><li id="5ab5" class="ld le in kc b kd lm kh ln kl lo kp lp kt lq kx li lj lk ll bi translated"><a class="ae jz" href="https://www.nuget.org/packages/Microsoft.EntityFrameworkCore.Tools/7.0.0-preview.7.22376.2" rel="noopener ugc nofollow" target="_blank">微软。实体框架工作核心工具</a></li></ul><p id="5b1d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">安装 nuget 包后，我将添加一个名为 Customer 的类，我将在整个系列中使用这个实体，我将在我们的数据库中保存一个客户，然后从数据库中检索客户。</p><figure class="kz la lb lc gt jo gh gi paragraph-image"><div class="gh gi lu"><img src="../Images/6ad0102371df85be7441754a39c8c372.png" data-original-src="https://miro.medium.com/v2/resize:fit:1308/format:webp/1*qgAiesixt_OQ697OWImkHQ.png"/></div></figure><p id="8bf7" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">添加客户实体后，我创建了一个名为 ApplicationDataContext 的类，它扩展了 EF Core DbContext 类，表示与数据库的会话，可用于查询和保存我们实体的实例。</p><figure class="kz la lb lc gt jo gh gi paragraph-image"><div class="gh gi lv"><img src="../Images/55f827f5ff1d9a047645584ec3ee143a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1318/format:webp/1*wJaVvRt3HmXekPV5rIxz0A.png"/></div></figure><p id="fcc7" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">然后，我将在 launchSettings.json 中添加连接字符串，并在 Program.cs 文件中注册 ApplicationDataContext</p><figure class="kz la lb lc gt jo gh gi paragraph-image"><div class="gh gi lw"><img src="../Images/586cefb84ad4d5b32a914bbdec4e03cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1220/format:webp/1*K5Sj1s29UKU_BjD27M5NyA.png"/></div></figure><p id="0b9e" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">一旦你完成了到目前为止提到的所有步骤，你就可以在 Visual Studio 中打开 nuget 包管理器控制台并执行“添加-迁移”和“更新-数据库”命令。这将在您的项目中创建一个迁移文件夹，并根据我们定义的实体创建数据库。</p><p id="8845" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">然后，我创建了两个 API 方法，一个是检索所有客户，另一个是在数据库中保存一个客户。我会把源代码的链接放在你可以找到我写的 API 的地方。我不打算解释 API 方法，因为这可能超出了本文的范围。</p><p id="80e9" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">一旦你开始这个项目，你将能够看到我们的 API 的大摇大摆的文档，如下图。</p><figure class="kz la lb lc gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi lx"><img src="../Images/37b572abbdc100ed171f1248612f13b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*afZzvd6eBlmASwQ3lZ8SoA.png"/></div></div></figure></div><div class="ab cl ly lz hr ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="ig ih ii ij ik"><p id="1efd" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">让我们将应用程序容器化</strong></p><p id="a5f1" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">到目前为止，我们已经创建了我们的应用程序，并在本地主机上进行了测试，现在让我们为我们的应用程序添加 docker 支持。使用 Visual Studio 为我们的应用程序添加 docker 支持非常简单，您只需右键单击 API 项目并添加 Docker 支持。</p><p id="f640" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这将在我们的应用程序中添加一个 Docker 文件，如下图所示。因为我将在 src 文件夹中使用 docker-compose，所以我将 src 从 docker 文件的路径中删除。</p><figure class="kz la lb lc gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mf"><img src="../Images/d0be067dc3b205391a615e4a503c509b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BxDM8SYjDpAYCKC6dP36mA.png"/></div></div></figure><p id="366c" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">因为我们计划将我们的应用程序和 PostgreSQL 数据库部署为容器，所以我们将使用 docker-compose 来管理这些容器。Docker Compose 是一个用于定义和运行多容器 Docker 应用程序的工具。</p><p id="2a49" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在为我们的应用程序添加 docker 支持之后，我在 src 文件夹中创建了一个 docker-compose 文件</p><figure class="kz la lb lc gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mg"><img src="../Images/34fbf73de5cf10c6bdd3db3ad0821367.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3otXLKfcTf40sikVMxpzgw.png"/></div></div></figure><p id="a836" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在 docker-compose 文件中，我们将使用 docker 容器中的 PostgreSQL 数据库，而不是使用本地 PostgreSQL 数据库。一旦我们终止容器，容器中的所有数据都将丢失，因此我使用卷将数据保存在 customer_db 容器中。</p><p id="015b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">创建 docker-compose 文件后，我们可以从 src 文件夹中执行命令<strong class="kc io"> docker-compose up </strong>。这个命令将构建图像并启动我们的应用程序和数据库实例。一旦你打开 Docker 桌面应用程序，你会看到我们的容器运行成功。</p><figure class="kz la lb lc gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mh"><img src="../Images/3e54ce0c0fc479e10e76ab3740acec07.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z68GBpAl4i8CsStDV6UJHQ.png"/></div></div></figure><p id="c1e7" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这篇文章到此为止。在本文中，我们介绍了如何设置我们的应用程序在本地环境中运行。然后我们添加了对应用程序的 docker 支持，后来我们使用 docker-compose 作为单独的容器来托管我们的应用程序和数据库。希望你能从这篇文章中找到有用的东西。本文的源代码在下面的链接中提到。✌️</p><p id="26a1" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><a class="ae jz" href="https://github.com/infaz98/.net-core-postgresql-docker-demo-app" rel="noopener ugc nofollow" target="_blank">https://github.com/infaz98/.net-core-PostgreSQL-docker-demo-app</a></p></div></div>    
</body>
</html>