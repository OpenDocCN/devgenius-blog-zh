<html>
<head>
<title>Custom Terraform Provider Design: Part 02</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">定制地形提供商设计:第 2 部分</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/custom-terraform-provider-design-part-02-e67436752706?source=collection_archive---------2-----------------------#2022-01-21">https://blog.devgenius.io/custom-terraform-provider-design-part-02-e67436752706?source=collection_archive---------2-----------------------#2022-01-21</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><blockquote class="jk jl jm"><p id="ad1f" class="jn jo jp jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ig bi translated">在<a class="ae km" href="https://souravpatnaik.medium.com/custom-terraform-provider-design-c39287c816e9" rel="noopener">第 01 部分</a>中，我们已经介绍了 Terraform 的基础知识，即代码基础设施(IaC)；按照 terraform 的<a class="ae km" href="https://www.terraform.io/plugin/sdkv2/sdkv2-intro" rel="noopener ugc nofollow" target="_blank"> SDKv2 </a>设置我们的开发环境，以创建我们自己的定制 Terraform 提供者。</p></blockquote><p id="56d6" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk kl ig bi translated">现在，我们将实际实现自定义 terraform 提供者的逻辑。</p><h1 id="bb29" class="kq kr in bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">好的，那么我们到底要做什么…</h1><p id="b4a6" class="pw-post-body-paragraph jn jo in jq b jr lo jt ju jv lp jx jy kn lq kb kc ko lr kf kg kp ls kj kk kl ig bi translated">我们将为与我们的<a class="ae km" href="https://github.com/sourav977/avengers-backend" rel="noopener ugc nofollow" target="_blank"> <strong class="jq io">复仇者-后端</strong> </a>应用程序的 API 交互的 Terraform 提供者创建<strong class="jq io">复仇者资源</strong>。为此，我们将:</p><ol class=""><li id="c9ee" class="lt lu in jq b jr js jv jw kn lv ko lw kp lx kl ly lz ma mb bi translated"><strong class="jq io">通过添加一个脚手架来定义复仇者资源</strong>，该脚手架定义了一个空模式和创建、读取、更新和删除复仇者的函数。</li><li id="db4e" class="lt lu in jq b jr mc jv md kn me ko mf kp mg kl ly lz ma mb bi translated"><strong class="jq io">定义复仇者模式</strong>。我们将在所有需要的地方定义复仇者联盟资源需要的所有参数。</li><li id="a5cb" class="lt lu in jq b jr mc jv md kn me ko mf kp mg kl ly lz ma mb bi translated"><strong class="jq io">实现创建、读取、更新、删除功能</strong>。Create 调用 POST 请求到/Avengers/createNewAvenger；Read 调用 GET 请求到/Avengers/getAllAvengers；更新调用 PUT 请求到/Avengers/updateAvengerByName；而 Delete 通过复仇者联盟-客户端库调用删除请求给复仇者联盟-后端应用的/avengers/deleteAvengerByName。</li><li id="b027" class="lt lu in jq b jr mc jv md kn me ko mf kp mg kl ly lz ma mb bi translated">更新<strong class="jq io"> Provider() </strong>模式中的<strong class="jq io"> ResourcesMap </strong></li><li id="e121" class="lt lu in jq b jr mc jv md kn me ko mf kp mg kl ly lz ma mb bi translated">实现<strong class="jq io">数据源</strong>功能</li><li id="d3b8" class="lt lu in jq b jr mc jv md kn me ko mf kp mg kl ly lz ma mb bi translated">更新提供者()模式中的<strong class="jq io">数据源映射</strong></li><li id="43a8" class="lt lu in jq b jr mc jv md kn me ko mf kp mg kl ly lz ma mb bi translated"><strong class="jq io">本地构建</strong></li><li id="5163" class="lt lu in jq b jr mc jv md kn me ko mf kp mg kl ly lz ma mb bi translated"><strong class="jq io">就地测试</strong>。在 main.tf 文件中定义 avengers 资源来创建、读取、更新、删除</li><li id="eb6b" class="lt lu in jq b jr mc jv md kn me ko mf kp mg kl ly lz ma mb bi translated">将所有更改提交到你的 GitHub 库。</li></ol><h1 id="8d2c" class="kq kr in bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">步骤 1:复制复仇者联盟资源支架</h1><ul class=""><li id="5f62" class="lt lu in jq b jr lo jv lp kn mh ko mi kp mj kl mk lz ma mb bi translated">在复仇者目录下创建<strong class="jq io"> resource_avengers.go </strong></li><li id="6753" class="lt lu in jq b jr mc jv md kn me ko mf kp mg kl mk lz ma mb bi translated">我们必须遵循上面的文件命名约定。我的资源名是 avengers，所以文件名 resource _ Avengers . go . "<strong class="jq io">resource _</strong>"将作为资源名的前缀。示例:resource_users.go、resource_signup.go、resource_login.go、resource_iam.go 等。</li><li id="c6b6" class="lt lu in jq b jr mc jv md kn me ko mf kp mg kl mk lz ma mb bi translated">每个资源都应该有一个单独的 resource_ <resource-name>。去归档。</resource-name></li><li id="ae2c" class="lt lu in jq b jr mc jv md kn me ko mf kp mg kl mk lz ma mb bi translated">将以下代码添加到 resource_avengers.go 文件中。这是复仇者资源的脚手架。</li></ul><pre class="ml mm mn mo gt mp mq mr ms aw mt bi"><span id="6368" class="mu kr in mq b gy mv mw l mx my">package avengers<br/><br/><br/>import (<br/>  "context"<br/><br/><br/>  "github.com/hashicorp/terraform-plugin-sdk/v2/diag"<br/>  "github.com/hashicorp/terraform-plugin-sdk/v2/helper/schema"<br/><br/>  aclient "github.com/sourav977/avengers-client"<br/>)<br/><br/><br/>func resourceAvengers() *schema.Resource {<br/>  return &amp;schema.Resource{<br/>    CreateContext: resourceAvengersCreate,<br/>    ReadContext:   resourceAvengersRead,<br/>    UpdateContext: resourceAvengersUpdate,<br/>    DeleteContext: resourceAvengersDelete,<br/>    Schema: map[string]*schema.Schema{},<br/>  }<br/>}<br/><br/><br/>func resourceAvengersCreate(ctx context.Context, d *schema.ResourceData, m interface{}) diag.Diagnostics {<br/>  // Warning or errors can be collected in a slice type<br/>  var diags diag.Diagnostics<br/><br/><br/>  return diags<br/>}<br/><br/><br/>func resourceAvengersRead(ctx context.Context, d *schema.ResourceData, m interface{}) diag.Diagnostics {<br/>  // Warning or errors can be collected in a slice type<br/>  var diags diag.Diagnostics</span><span id="1e83" class="mu kr in mq b gy mz mw l mx my">return diags<br/>}<br/><br/><br/>func resourceAvengersUpdate(ctx context.Context, d *schema.ResourceData, m interface{}) diag.Diagnostics {<br/>  return resourceOrderRead(ctx, d, m)<br/>}<br/><br/><br/>func resourceAvengersDelete(ctx context.Context, d *schema.ResourceData, m interface{}) diag.Diagnostics {<br/>  // Warning or errors can be collected in a slice type<br/>  var diags diag.Diagnostics<br/><br/><br/>  return diags<br/>}</span></pre><p id="8225" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk kl ig bi translated">让我们看一下上面的代码片段。</p><ul class=""><li id="51da" class="lt lu in jq b jr js jv jw kn lv ko lw kp lx kl mk lz ma mb bi translated">在 resource_avengers.go 中，<strong class="jq io"> resourceAvengers() </strong>是重要的函数。由于我们正在创建复仇者资源，所以函数名为 resourceAvengers()。</li><li id="7db1" class="lt lu in jq b jr mc jv md kn me ko mf kp mg kl mk lz ma mb bi translated"><strong class="jq io"> CreateContext </strong>、<strong class="jq io"> ReadContext </strong>、<strong class="jq io"> UpdateContext </strong>、<strong class="jq io"> DeleteContext </strong>是对该资源的 CRUD 操作。它们持有相应的函数名<strong class="jq io"> resourceAvengersCreate </strong>，<strong class="jq io"> resourceAvengersRead </strong>，<strong class="jq io"> resourceAvengersUpdate </strong>，<strong class="jq io"> resourceAvengersDelete </strong>，其中实际逻辑已经实现，并在同一个 go 文件中声明和定义。</li><li id="92b0" class="lt lu in jq b jr mc jv md kn me ko mf kp mg kl mk lz ma mb bi translated">在模式中，我们将定义复仇者资源支持哪些不同的参数</li><li id="b26d" class="lt lu in jq b jr mc jv md kn me ko mf kp mg kl mk lz ma mb bi translated">导入我们的客户端-库<a class="ae km" href="https://github.com/sourav977/avengers-client" rel="noopener ugc nofollow" target="_blank"> <strong class="jq io">复仇者-客户端</strong> </a>，通过它我们将与我们的<a class="ae km" href="https://github.com/sourav977/avengers-backend" rel="noopener ugc nofollow" target="_blank"><strong class="jq io">aven egrs-后端</strong> </a>进行通信。</li></ul><h1 id="6096" class="kq kr in bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">步骤 2:定义复仇者模式</h1><p id="c9ca" class="pw-post-body-paragraph jn jo in jq b jr lo jt ju jv lp jx jy kn lq kb kc ko lr kf kg kp ls kj kk kl ig bi translated">所有 Terraform 资源都必须有一个模式。这允许提供者将 JSON 响应映射到模式。</p><ul class=""><li id="ffaf" class="lt lu in jq b jr js jv jw kn lv ko lw kp lx kl mk lz ma mb bi translated">为了创建复仇者资源，我们在复仇者后端定义了模型/对象。ref:<a class="ae km" href="https://github.com/sourav977/avengers-backend/blob/main/models/avenger.go" rel="noopener ugc nofollow" target="_blank">https://github . com/sourav 977/Avengers-back end/blob/main/models/avenger . go</a></li><li id="4f95" class="lt lu in jq b jr mc jv md kn me ko mf kp mg kl mk lz ma mb bi translated">为了保存复仇者联盟的结果，我们在复仇者联盟客户端库中创建了类似的模型/对象。ref:<a class="ae km" href="https://github.com/sourav977/avengers-client/blob/main/models.go" rel="noopener ugc nofollow" target="_blank">https://github . com/sourav 977/Avengers-client/blob/main/models . go</a></li></ul><pre class="ml mm mn mo gt mp mq mr ms aw mt bi"><span id="29f0" class="mu kr in mq b gy mv mw l mx my">type Avenger struct {<br/>		ID     string `json:"_id,omitempty"`<br/>		Name   string `json:"name,omitempty"`<br/>		Alias  string `json:"alias,omitempty"`<br/>		Weapon string `json:"weapon,omitempty"`<br/>	}</span></pre><ul class=""><li id="3527" class="lt lu in jq b jr js jv jw kn lv ko lw kp lx kl mk lz ma mb bi translated">所以当你将要执行一个 create 操作的时候，你要传递上面的数据，当你将要执行 get all 的时候，你会收到一个复仇者列表。所以我们必须像那样设计我们的模式。为了便于学习，我没有创建一个复合结构，但得到所有复仇者联盟是复仇者联盟的一部分。</li><li id="a2ff" class="lt lu in jq b jr mc jv md kn me ko mf kp mg kl mk lz ma mb bi translated">替换行架构:map[string]*schema。resourceAvengers()函数中的架构{}，具有以下架构。</li></ul><pre class="ml mm mn mo gt mp mq mr ms aw mt bi"><span id="fa1f" class="mu kr in mq b gy mv mw l mx my">Schema: map[string]*schema.Schema {<br/>            "avengers": &amp;schema.Schema{<br/>                Type:     schema.TypeList,<br/>                Computed: true,<br/>                Elem: &amp;schema.Resource{<br/>                    Schema: map[string]*schema.Schema{<br/>                        "_id": &amp;schema.Schema{<br/>                            Type:        schema.TypeString,<br/>                            Computed:    true,<br/>                            Description: "the _id value returned from mongodb",<br/>                        },<br/>                        "name": &amp;schema.Schema{<br/>                            Type:        schema.TypeString,<br/>                            Computed:    true,<br/>                            Description: "full name of avenger",<br/>                        },<br/>                        "alias": &amp;schema.Schema{<br/>                            Type:        schema.TypeString,<br/>                            Computed:    true,<br/>                            Description: "any alias/nickname of avenger",<br/>                        },<br/>                        "weapon": &amp;schema.Schema{<br/>                            Type:        schema.TypeString,<br/>                            Computed:    true,<br/>                            Description: "his/her special weapons",<br/>                        },<br/>                    },<br/>                },<br/>            },<br/>            "_id": &amp;schema.Schema{<br/>                Type:        schema.TypeString,<br/>                Computed:    true,<br/>                Description: "the _id value returned from mongodb",<br/>            },<br/>            "name": &amp;schema.Schema{<br/>                Type:        schema.TypeString,<br/>                Required:    true,<br/>                Description: "full name of avenger",<br/>            },<br/>            "alias": &amp;schema.Schema{<br/>                Type:        schema.TypeString,<br/>                Required:    true,<br/>                Description: "any alias/nickname of avenger",<br/>            },<br/>            "weapon": &amp;schema.Schema{<br/>                Type:        schema.TypeString,<br/>                Required:    true,<br/>                Description: "his/her special weapons",<br/>            },<br/>            "deleted_count": &amp;schema.Schema{<br/>                Type:        schema.TypeInt,<br/>                Computed:    true,<br/>                Description: "deleted item count",<br/>            },<br/>            "matched_count": &amp;schema.Schema{<br/>                Type:        schema.TypeInt,<br/>                Computed:    true,<br/>                Description: "total matched item found",<br/>            },<br/>            "modified_count": &amp;schema.Schema{<br/>                Type:        schema.TypeInt,<br/>                Computed:    true,<br/>                Description: "total item modified",<br/>            },<br/>            "upserted_count": &amp;schema.Schema{<br/>                Type:        schema.TypeInt,<br/>                Computed:    true,<br/>                Description: "total item upserted",<br/>            },<br/>        },</span></pre><ul class=""><li id="808d" class="lt lu in jq b jr js jv jw kn lv ko lw kp lx kl mk lz ma mb bi translated">如果你注意到，“复仇者联盟”是模式类型。类型列表。在这里，我们将举行获得所有复仇者的结果。当 terraform 将执行 get/getall 操作时，它将被填充。</li><li id="ce3f" class="lt lu in jq b jr mc jv md kn me ko mf kp mg kl mk lz ma mb bi translated">类型:模式。类型字符串、架构。TypeInt 表示这些值分别为 string、Int 类型。</li><li id="f78d" class="lt lu in jq b jr mc jv md kn me ko mf kp mg kl mk lz ma mb bi translated">Computed: true，表示在创建时计算该值的结果(除非 config 指定)。</li><li id="50d5" class="lt lu in jq b jr mc jv md kn me ko mf kp mg kl mk lz ma mb bi translated">Required: true，表示创建/更新/删除时需要该值。</li><li id="77df" class="lt lu in jq b jr mc jv md kn me ko mf kp mg kl mk lz ma mb bi translated">因为我们的复仇者联盟客户端库会告诉我们它从复仇者联盟后端得到了什么，所以我定义了复仇者联盟客户端将返回给 terraform provider 的所有元素。</li></ul><h1 id="a0fb" class="kq kr in bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">步骤 03:实现创建功能:</h1><ul class=""><li id="cb07" class="lt lu in jq b jr lo jv lp kn mh ko mi kp mj kl mk lz ma mb bi translated">现在在 resourceAvengersCreate()函数中添加下面的代码。</li></ul><pre class="ml mm mn mo gt mp mq mr ms aw mt bi"><span id="dde1" class="mu kr in mq b gy mv mw l mx my">func resourceAvengersCreate(ctx context.Context, d *schema.ResourceData, m interface{}) diag.Diagnostics {<br/>    // Warning or errors can be collected in a slice type<br/>    log.Printf("[DEBUG] %s: Beginning resourceAvengersCreate", d.Id())<br/>    var diags diag.Diagnostics<br/>    c := m.(*ApiClient)<br/><br/><br/>    name := d.Get("name").(string)<br/>    alias := d.Get("alias").(string)<br/>    weapon := d.Get("weapon").(string)<br/><br/><br/>    a := aclient.Avenger{<br/>        Name:   name,<br/>        Alias:  alias,<br/>        Weapon: weapon,<br/>    }<br/><br/><br/>    res, err := c.avengersclient.CreateAvenger(a)<br/>    if err != nil {<br/>        return diag.FromErr(err)<br/>    }<br/><br/><br/>    if err := d.Set("_id", res.ID); err != nil {<br/>        return diag.FromErr(err)<br/>    }<br/>    if err := d.Set("name", res.Name); err != nil {<br/>        return diag.FromErr(err)<br/>    }<br/>    if err := d.Set("alias", res.Alias); err != nil {<br/>        return diag.FromErr(err)<br/>    }<br/>    if err := d.Set("weapon", res.Weapon); err != nil {<br/>        return diag.FromErr(err)<br/>    }<br/><br/><br/>    d.SetId(res.ID)<br/>    log.Printf("[DEBUG] %s: resourceAvengersCreate finished successfully", d.Id())<br/>    return diags<br/>}</span></pre><ul class=""><li id="2283" class="lt lu in jq b jr js jv jw kn lv ko lw kp lx kl mk lz ma mb bi translated">让我们看一下上面的代码。</li><li id="4af9" class="lt lu in jq b jr mc jv md kn me ko mf kp mg kl mk lz ma mb bi translated">首先，我初始化一个客户端连接，从 Schema 获取值，然后调用<strong class="jq io"> CreateAvenger() </strong>。从 avengers-client 接收数据后，再次整理相应的值并返回。</li><li id="1284" class="lt lu in jq b jr mc jv md kn me ko mf kp mg kl mk lz ma mb bi translated">下面是创建复仇者资源的序列图。</li></ul><figure class="ml mm mn mo gt nb gh gi paragraph-image"><div role="button" tabindex="0" class="nc nd di ne bf nf"><div class="gh gi na"><img src="../Images/e4d629561b62358aaf92b1db6ec4f9c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9Ef72q2sBu3eJySwsEm5UQ.png"/></div></div><figcaption class="ni nj gj gh gi nk nl bd b be z dk translated">创建复仇者资源的顺序图</figcaption></figure><ul class=""><li id="58bd" class="lt lu in jq b jr js jv jw kn lv ko lw kp lx kl mk lz ma mb bi translated">类似地，实现读取、更新、删除逻辑。ref:<a class="ae km" href="https://github.com/sourav977/terraform-provider-avengers/blob/main/avengers/resource_avengers.go" rel="noopener ugc nofollow" target="_blank">https://github . com/sourav 977/terra form-provider-Avengers/blob/main/Avengers/resource _ Avengers . go</a></li></ul><h1 id="942e" class="kq kr in bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">步骤 04:更新 Provider()模式中的资源映射</h1><ul class=""><li id="db04" class="lt lu in jq b jr lo jv lp kn mh ko mi kp mj kl mk lz ma mb bi translated">打开 provider/provider.go 文件，添加我们在步骤 03 中编辑完成的<strong class="jq io"> resourceAvengers() </strong>:</li></ul><pre class="ml mm mn mo gt mp mq mr ms aw mt bi"><span id="18fc" class="mu kr in mq b gy mv mw l mx my">ResourcesMap: map[string]*schema.Resource {<br/>               "avengers_resource": resourceAvengers(),<br/>        },</span></pre><ul class=""><li id="c09a" class="lt lu in jq b jr js jv jw kn lv ko lw kp lx kl mk lz ma mb bi translated">另外，将模式添加到<strong class="jq io"> Provider() </strong>函数中，添加以下代码:</li></ul><pre class="ml mm mn mo gt mp mq mr ms aw mt bi"><span id="006f" class="mu kr in mq b gy mv mw l mx my">Schema: map[string]*schema.Schema {<br/>            "host": &amp;schema.Schema {<br/>                Type:        schema.TypeString,<br/>                Required:    true,<br/>                DefaultFunc: schema.EnvDefaultFunc("AVENGERS_BACKEND_HOST_URL", "http://localhost:8000"),<br/>            },<br/>        },<br/>        ConfigureContextFunc: providerConfigure,</span></pre><ul class=""><li id="fb32" class="lt lu in jq b jr js jv jw kn lv ko lw kp lx kl mk lz ma mb bi translated"><strong class="jq io">主机</strong>:复仇者联盟提供者配置中始终需要。如果您的应用程序有登录/注册功能，然后在这里添加用户名，密码等字段。</li><li id="8d82" class="lt lu in jq b jr mc jv md kn me ko mf kp mg kl mk lz ma mb bi translated"><strong class="jq io"> ConfigureContextFunc </strong>:在任何读取、创建、更新、删除等函数之前都会被调用。provider configuration 是一个函数，在这个函数中，您将通过调用客户端库来执行所有预验证检查，如登录/注册等。</li><li id="bfcf" class="lt lu in jq b jr mc jv md kn me ko mf kp mg kl mk lz ma mb bi translated">有关更多信息，请参考 provider.go。ref:<a class="ae km" href="https://github.com/sourav977/terraform-provider-avengers/blob/main/avengers/provider.go" rel="noopener ugc nofollow" target="_blank">https://github . com/sourav 977/terra form-provider-Avengers/blob/main/Avengers/provider . go</a></li></ul><h1 id="20c0" class="kq kr in bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">步骤 05:实现数据源</h1><ul class=""><li id="cba2" class="lt lu in jq b jr lo jv lp kn mh ko mi kp mj kl mk lz ma mb bi translated">dataSource 是执行操作以一次获得所有资源数据的地方。</li><li id="71be" class="lt lu in jq b jr mc jv md kn me ko mf kp mg kl mk lz ma mb bi translated">我们将在 getAllAvengers 中实现它</li><li id="7440" class="lt lu in jq b jr mc jv md kn me ko mf kp mg kl mk lz ma mb bi translated">在复仇者目录中创建<strong class="jq io">data _ source _ Avengers . go</strong></li><li id="e124" class="lt lu in jq b jr mc jv md kn me ko mf kp mg kl mk lz ma mb bi translated">我们必须遵循上面的文件命名约定。我的资源名称是 avengers，因此文件名 data _ source _ Avengers . go . "<strong class="jq io">data _ source _</strong>"将作为资源名称的前缀。例如:data_source_users.go、data_source_signup.go、data_source_login.go、data_source_iam.go 等。</li><li id="c80f" class="lt lu in jq b jr mc jv md kn me ko mf kp mg kl mk lz ma mb bi translated">每个资源都应该有一个单独的 data_source_ <resource-name>。去归档。</resource-name></li><li id="55d3" class="lt lu in jq b jr mc jv md kn me ko mf kp mg kl mk lz ma mb bi translated">在脚手架下方添加:</li></ul><pre class="ml mm mn mo gt mp mq mr ms aw mt bi"><span id="9c00" class="mu kr in mq b gy mv mw l mx my">func dataSourceAvengers() *schema.Resource <br/>    return &amp;schema.Resource{{<br/>}}</span></pre><ul class=""><li id="e8dd" class="lt lu in jq b jr js jv jw kn lv ko lw kp lx kl mk lz ma mb bi translated"><strong class="jq io">data source angers()</strong>是 terraform 将调用的函数，用于检索特定资源的所有数据。</li><li id="d75d" class="lt lu in jq b jr mc jv md kn me ko mf kp mg kl mk lz ma mb bi translated">我们必须在这里创建一个模式，它将保存所有的资源数据和一个相应的函数来执行这样的操作。</li><li id="9afb" class="lt lu in jq b jr mc jv md kn me ko mf kp mg kl mk lz ma mb bi translated">这里我们将只添加模式来保存结果数据(复仇者的切片)，不需要创建单独的 ReadAll 功能，因为我们已经在<strong class="jq io"> resourceAvengersRead() </strong>函数提供者/resource_avengers.go 文件中实现了该功能。ref:<a class="ae km" href="https://github.com/sourav977/terraform-provider-avengers/blob/main/avengers/resource_avengers.go" rel="noopener ugc nofollow" target="_blank">https://github . com/sourav 977/terra form-provider-Avengers/blob/main/Avengers/resource _ Avengers . go</a></li></ul><h1 id="8a3c" class="kq kr in bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">步骤 06:更新 Provider()模式中的 DataSourcesMap</h1><ul class=""><li id="df6e" class="lt lu in jq b jr lo jv lp kn mh ko mi kp mj kl mk lz ma mb bi translated">打开 provider/provider.go 文件，添加我们在步骤 03 中编辑完成的<strong class="jq io">data source angers()</strong>:</li></ul><pre class="ml mm mn mo gt mp mq mr ms aw mt bi"><span id="435f" class="mu kr in mq b gy mv mw l mx my">DataSourcesMap: map[string]*schema.Resource {<br/>            "avengers_datasource": dataSourceAvengers(),<br/>        },</span></pre><h1 id="6a66" class="kq kr in bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">步骤 07:构建代码</h1><ul class=""><li id="e245" class="lt lu in jq b jr lo jv lp kn mh ko mi kp mj kl mk lz ma mb bi translated">奔跑</li></ul><pre class="ml mm mn mo gt mp mq mr ms aw mt bi"><span id="229a" class="mu kr in mq b gy mv mw l mx my">make install</span></pre><ul class=""><li id="c5ea" class="lt lu in jq b jr js jv jw kn lv ko lw kp lx kl mk lz ma mb bi translated">验证您的<strong class="jq io">~/. terra form . d/plugins/$ { HOSTNAME }/$ { NAMESPACE }/$ { VERSION }/$ { OS } _ $ { OS _ ARCH }</strong>路径，并检查构建的二进制文件是否可用。</li></ul><h1 id="e24e" class="kq kr in bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">步骤 08:本地测试</h1><ul class=""><li id="0d1c" class="lt lu in jq b jr lo jv lp kn mh ko mi kp mj kl mk lz ma mb bi translated">在你的项目根路径中，创建<strong class="jq io">示例</strong>目录并将其光盘化。</li><li id="70cb" class="lt lu in jq b jr mc jv md kn me ko mf kp mg kl mk lz ma mb bi translated">创建<strong class="jq io"> main.tf </strong>文件，添加以下内容</li></ul><pre class="ml mm mn mo gt mp mq mr ms aw mt bi"><span id="7670" class="mu kr in mq b gy mv mw l mx my">terraform {<br/>  required_providers {<br/>    avengers = {<br/>      version = "1.0.1"<br/>      source  = "github.com/sourav977/avengers"<br/>    }<br/>  }<br/>}<br/><br/><br/>provider "avengers" {<br/>  host = "http://localhost:8000"<br/>}<br/><br/><br/>resource "avengers_resource" "foo" {<br/>  name = "sourav patnaik"<br/>  alias = "sikan"<br/>  weapon = "hammer"<br/>}<br/><br/><br/>output "created_avenger" {<br/>  value = avengers_resource.foo<br/>}</span></pre><ul class=""><li id="19d3" class="lt lu in jq b jr js jv jw kn lv ko lw kp lx kl mk lz ma mb bi translated">现在运行:</li></ul><pre class="ml mm mn mo gt mp mq mr ms aw mt bi"><span id="629a" class="mu kr in mq b gy mv mw l mx my">terraform init</span></pre><figure class="ml mm mn mo gt nb gh gi paragraph-image"><div role="button" tabindex="0" class="nc nd di ne bf nf"><div class="gh gi nm"><img src="../Images/2251d475958fbfd0061984efbb593516.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*um4qVRBU4HQgb2vqjDrxFA.png"/></div></div><figcaption class="ni nj gj gh gi nk nl bd b be z dk translated">地形初始化输出</figcaption></figure><ul class=""><li id="a29c" class="lt lu in jq b jr js jv jw kn lv ko lw kp lx kl mk lz ma mb bi translated">现在运行:</li></ul><pre class="ml mm mn mo gt mp mq mr ms aw mt bi"><span id="10dd" class="mu kr in mq b gy mv mw l mx my">terraform plan</span></pre><figure class="ml mm mn mo gt nb gh gi paragraph-image"><div role="button" tabindex="0" class="nc nd di ne bf nf"><div class="gh gi nn"><img src="../Images/6c724c05e69ace03e5a953c14ca1c5a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x3gN16dsKa1iEEQVkBYNDA.png"/></div></div><figcaption class="ni nj gj gh gi nk nl bd b be z dk translated">地形图输出</figcaption></figure><ul class=""><li id="7912" class="lt lu in jq b jr js jv jw kn lv ko lw kp lx kl mk lz ma mb bi translated">现在运行:</li></ul><pre class="ml mm mn mo gt mp mq mr ms aw mt bi"><span id="1805" class="mu kr in mq b gy mv mw l mx my">terraform apply</span></pre><p id="d83f" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk kl ig bi translated">并在询问时输入“是”。</p><figure class="ml mm mn mo gt nb gh gi paragraph-image"><div role="button" tabindex="0" class="nc nd di ne bf nf"><div class="gh gi no"><img src="../Images/63ef2f68a6dc14d27d901e22c1afacea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BNgefrwhayXaJ2dxUJHQpA.png"/></div></div><figcaption class="ni nj gj gh gi nk nl bd b be z dk translated">terraform 应用输出</figcaption></figure><ul class=""><li id="cd77" class="lt lu in jq b jr js jv jw kn lv ko lw kp lx kl mk lz ma mb bi translated">类似地，通过编写适当的 terraform 脚本来执行 GetAll、Update、Delete 操作。参考:<a class="ae km" href="https://github.com/sourav977/terraform-provider-avengers" rel="noopener ugc nofollow" target="_blank">https://github.com/sourav977/terraform-provider-avengers</a></li></ul><h1 id="56e8" class="kq kr in bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">步骤 09:将代码提交到 GitHub</h1><ul class=""><li id="b7e1" class="lt lu in jq b jr lo jv lp kn mh ko mi kp mj kl mk lz ma mb bi translated">在本地成功验证您的定制 terraform 提供者之后，将代码推送到您的 GitHub 存储库。在项目根目录中:</li></ul><pre class="ml mm mn mo gt mp mq mr ms aw mt bi"><span id="0ada" class="mu kr in mq b gy mv mw l mx my">git add .<br/>git commit -m "&lt;your message ... &gt;"<br/>git push<br/>git tag v1.0.0<br/>git push origin v1.0.0</span></pre><ul class=""><li id="39f9" class="lt lu in jq b jr js jv jw kn lv ko lw kp lx kl mk lz ma mb bi translated">是的，你必须创建一个标签。这将在第 03 部分中要求。</li></ul></div><div class="ab cl np nq hr nr" role="separator"><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu"/></div><div class="ig ih ii ij ik"><blockquote class="jk jl jm"><p id="aeeb" class="jn jo jp jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ig bi translated"><em class="in">在</em> <a class="ae km" href="https://souravpatnaik.medium.com/create-custom-terraform-provider-part-03-c3f6bc9fd183" rel="noopener"> <strong class="jq io"> <em class="in">第 03 部分</em> </strong> </a> <em class="in">中，我们将在 Terraform 注册表中创建一个帐户，并推送我们的自定义 Terraform 提供者。</em></p></blockquote><p id="f1f9" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk kl ig bi translated">我在我的<a class="ae km" href="https://www.linkedin.com/pulse/create-custom-terraform-provider-part-02-sourav-patnaik/" rel="noopener ugc nofollow" target="_blank"> <strong class="jq io"> LinkedIn 账号</strong> </a>也发表过同样的内容。请检查。</p><p id="d29c" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk kl ig bi translated">Sourav Patnaik</p></div></div>    
</body>
</html>