<html>
<head>
<title>ExternalDNS and Host-Based TLS Ingress in AKS Cluster</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AKS 集群中的外部 DNS 和基于主机的 TLS 入口</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/externaldns-and-host-based-tls-ingress-in-aks-cluster-edf75fae36f3?source=collection_archive---------1-----------------------#2022-03-05">https://blog.devgenius.io/externaldns-and-host-based-tls-ingress-in-aks-cluster-edf75fae36f3?source=collection_archive---------1-----------------------#2022-03-05</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/6ebf09ab8f069e1aa336f07be9eebb0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H4QT_sfWYBOff7V-ehujXA.png"/></div></div></figure><p id="e4ef" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">本文涵盖了用 Azure Kubernetes 服务(AKS)和 Azure DNS 配置<a class="ae kt" href="https://github.com/kubernetes-sigs/external-dns" rel="noopener ugc nofollow" target="_blank"> E </a> xternalDNS 的过程。通过正确部署和配置外部 DNS 和必要的 Azure 服务，您可以确保从您的自定义域到 Kubernetes 的正确路由。入口对象将使用正确的记录更新 DNS 区域。</p><h1 id="5ed0" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">要执行的步骤:</h1><ul class=""><li id="12f0" class="ls lt in jx b jy lu kc lv kg lw kk lx ko ly ks lz ma mb mc bi translated">为自定义域创建 DNS 区域。</li><li id="d9cb" class="ls lt in jx b jy md kc me kg mf kk mg ko mh ks lz ma mb mc bi translated">为入口控制器创建名称空间 ingress-basic，其中将创建所有与入口控制器相关的资源。</li><li id="9af1" class="ls lt in jx b jy md kc me kg mf kk mg ko mh ks lz ma mb mc bi translated">将群集节点池的托管身份分配给 DNS 区域。</li><li id="3173" class="ls lt in jx b jy md kc me kg mf kk mg ko mh ks lz ma mb mc bi translated">使用 Helm 在 ingress-basic 命名空间中部署 ExternalDNS。</li><li id="da75" class="ls lt in jx b jy md kc me kg mf kk mg ko mh ks lz ma mb mc bi translated">使用 Helm 在 ingress-basic 命名空间中安装 SSL 证书的 cert-manager。</li><li id="225c" class="ls lt in jx b jy md kc me kg mf kk mg ko mh ks lz ma mb mc bi translated">创建用于颁发证书的 CA 群集颁发者。</li><li id="7a9e" class="ls lt in jx b jy md kc me kg mf kk mg ko mh ks lz ma mb mc bi translated">创建第一个应用和服务。</li><li id="5a1b" class="ls lt in jx b jy md kc me kg mf kk mg ko mh ks lz ma mb mc bi translated">创建第二个应用和服务。</li><li id="a350" class="ls lt in jx b jy md kc me kg mf kk mg ko mh ks lz ma mb mc bi translated">创建入口路由，以配置基于主机的规则以及将流量路由到两个应用程序之一的 DNS 记录和 TLS 证书。</li><li id="1ce7" class="ls lt in jx b jy md kc me kg mf kk mg ko mh ks lz ma mb mc bi translated">验证自动创建的证书。</li><li id="a627" class="ls lt in jx b jy md kc me kg mf kk mg ko mh ks lz ma mb mc bi translated">使用自定义域测试应用程序。</li></ul><h1 id="701a" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">创建一个 DNS 区域</h1><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="a071" class="mr kv in mn b gy ms mt l mu mv"># Create a DNS Zone for custom Domain<br/>az network dns zone create -g aksdemocluster-rg -n mydevsecops.org</span></pre><h1 id="b841" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">创建入口控制器</h1><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="2b57" class="mr kv in mn b gy ms mt l mu mv"># Create a namespace for ingress resources<br/>kubectl create namespace ingress-basic</span><span id="5bfd" class="mr kv in mn b gy mw mt l mu mv"># Add the Helm repository<br/>helm repo add ingress-nginx <a class="ae kt" href="https://kubernetes.github.io/ingress-nginx" rel="noopener ugc nofollow" target="_blank">https://kubernetes.github.io/ingress-nginx</a><br/>helm repo update</span><span id="fca6" class="mr kv in mn b gy mw mt l mu mv"># Use Helm to deploy an NGINX ingress controller<br/>helm install ingress-nginx ingress-nginx/ingress-nginx \<br/>    --namespace ingress-basic \<br/>    --set controller.replicaCount=2</span></pre><h1 id="2ab9" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">设置权限</h1><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="7499" class="mr kv in mn b gy ms mt l mu mv"># Assign Variables<br/>tenantid=$(az account show --subscription "Visual Studio Enterprise Subscription" --query tenantId --output tsv)</span><span id="02b1" class="mr kv in mn b gy mw mt l mu mv">subscriptionid=$(az account show --query id -o tsv)</span><span id="fcf0" class="mr kv in mn b gy mw mt l mu mv">UserClientId=$(az aks show --name <a class="ae kt" href="https://portal.azure.com/#@shailenderchoudharygmail.onmicrosoft.com/resource/subscriptions/461db24f-c0a7-4a65-aa6b-764717134583/resourceGroups/aksdemocluster-rg/providers/Microsoft.ContainerService/managedClusters/aksdemocluster" rel="noopener ugc nofollow" target="_blank">aksdemocluster</a> --resource-group <a class="ae kt" href="https://portal.azure.com/#@shailenderchoudharygmail.onmicrosoft.com/resource/subscriptions/461db24f-c0a7-4a65-aa6b-764717134583/resourceGroups/aksdemocluster-rg" rel="noopener ugc nofollow" target="_blank">aksdemocluster-rg</a> --query identityProfile.kubeletidentity.clientId -o tsv)</span><span id="677b" class="mr kv in mn b gy mw mt l mu mv">DNSID=$(az network dns zone show --name mydevsecops.org --resource-group aksdemocluster-rg --query id -o tsv)</span><span id="2545" class="mr kv in mn b gy mw mt l mu mv"># Assign managed identity of cluster’s node pools DNS Zone Contributor rights on to Custom Domain DNS zone.<br/>az role assignment create --assignee $UserClientId --role 'DNS Zone Contributor' --scope $DNSID</span></pre><h1 id="2834" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">部署外部 DNS</h1><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="b5e4" class="mr kv in mn b gy ms mt l mu mv"># Add the Helm repository<br/>helm repo add bitnami <a class="ae kt" href="https://charts.bitnami.com/bitnami" rel="noopener ugc nofollow" target="_blank">https://charts.bitnami.com/bitnami</a><br/>helm repo update<br/><br/># Use Helm to deploy an External DNS<br/>helm install external-dns bitnami/external-dns --namespace ingress-basic --set provider=azure --set txtOwnerId=aksdemocluster --set policy=sync --set azure.resourceGroup=aksdemocluster-rg --set azure.tenantId=$tenantid --set azure.subscriptionId=$subscriptionid --set azure.useManagedIdentityExtension=true --set azure.userAssignedIdentityID=$UserClientId</span></pre><h1 id="14c9" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">安装证书管理器</h1><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="0221" class="mr kv in mn b gy ms mt l mu mv"># Label the cert-manager namespace to disable resource validation<br/>kubectl label namespace ingress-basic cert-manager.io/disable-validation=true</span><span id="cce2" class="mr kv in mn b gy mw mt l mu mv"># Add the Jetstack Helm repository<br/>helm repo add jetstack <a class="ae kt" href="https://charts.jetstack.io#" rel="noopener ugc nofollow" target="_blank">https://charts.jetstack.io</a></span><span id="038d" class="mr kv in mn b gy mw mt l mu mv"><a class="ae kt" href="https://charts.jetstack.io#" rel="noopener ugc nofollow" target="_blank">#</a> Update your local Helm chart repository cache<br/>helm repo update</span><span id="8a5a" class="mr kv in mn b gy mw mt l mu mv"># Install CRDs with kubectl<br/>kubectl apply -f <a class="ae kt" href="https://github.com/cert-manager/cert-manager/releases/download/v1.7.1/cert-manager.crds.yaml#" rel="noopener ugc nofollow" target="_blank">https://github.com/cert-manager/cert-manager/releases/download/v1.7.1/cert-manager.crds.yaml</a></span><span id="112b" class="mr kv in mn b gy mw mt l mu mv"><a class="ae kt" href="https://github.com/cert-manager/cert-manager/releases/download/v1.7.1/cert-manager.crds.yaml#" rel="noopener ugc nofollow" target="_blank">#</a> Install the cert-manager Helm chart<br/>helm install cert-manager jetstack/cert-manager \<br/>  --namespace ingress-basic \<br/>  --version v1.7.1</span></pre><h1 id="789a" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">创建 CA 群集颁发者</h1><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="116f" class="mr kv in mn b gy ms mt l mu mv">apiVersion: cert-manager.io/v1<br/>kind: ClusterIssuer<br/>metadata:<br/>  name: letsencrypt<br/>spec:<br/>  acme:<br/>    server: <a class="ae kt" href="https://acme-v02.api.letsencrypt.org/directory" rel="noopener ugc nofollow" target="_blank">https://acme-v02.api.letsencrypt.org/directory</a><br/>    email: shailender.choudhary@gmail.com<br/>    privateKeySecretRef:<br/>      name: letsencrypt<br/>    solvers:<br/>    - http01:<br/>        ingress:<br/>          class: nginx<br/>          podTemplate:<br/>            spec:<br/>              nodeSelector:<br/>                "kubernetes.io/os": linux</span></pre><p id="72ea" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">要创建发行者，请使用 kubectl 命令。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="cca4" class="mr kv in mn b gy ms mt l mu mv">kubectl apply -f cluster-issuer.yaml --namespace ingress-basic</span></pre><h1 id="8ca9" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">运行演示应用程序</h1><p id="63db" class="pw-post-body-paragraph jv jw in jx b jy lu ka kb kc lv ke kf kg mx ki kj kk my km kn ko mz kq kr ks ig bi translated">创建一个<em class="na"> aks-helloworld-one.yaml </em>文件，并在以下示例中复制 yaml:</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="84e0" class="mr kv in mn b gy ms mt l mu mv">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: aks-helloworld-one<br/>spec:<br/>  replicas: 1<br/>  selector:<br/>    matchLabels:<br/>      app: aks-helloworld-one<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: aks-helloworld-one<br/>    spec:<br/>      containers:<br/>      - name: aks-helloworld-one<br/>        image: mcr.microsoft.com/azuredocs/aks-helloworld:v1<br/>        ports:<br/>        - containerPort: 80<br/>        env:<br/>        - name: TITLE<br/>          value: "Welcome to Azure Kubernetes Service (AKS)"<br/>---<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: aks-helloworld-one<br/>spec:<br/>  type: ClusterIP<br/>  ports:<br/>  - port: 80<br/>  selector:<br/>    app: aks-helloworld-one</span></pre><p id="9460" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">创建一个<em class="na"> aks-helloworld-two.yaml </em>文件，并在以下示例中复制 yaml:</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="474a" class="mr kv in mn b gy ms mt l mu mv">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: aks-helloworld-two<br/>spec:<br/>  replicas: 1<br/>  selector:<br/>    matchLabels:<br/>      app: aks-helloworld-two<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: aks-helloworld-two<br/>    spec:<br/>      containers:<br/>      - name: aks-helloworld-two<br/>        image: mcr.microsoft.com/azuredocs/aks-helloworld:v1<br/>        ports:<br/>        - containerPort: 80<br/>        env:<br/>        - name: TITLE<br/>          value: "AKS Ingress Demo"<br/>---<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: aks-helloworld-two<br/>spec:<br/>  type: ClusterIP<br/>  ports:<br/>  - port: 80<br/>  selector:<br/>    app: aks-helloworld-two</span></pre><p id="2e88" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">使用 kubectl 运行两个演示应用程序:</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="1361" class="mr kv in mn b gy ms mt l mu mv">kubectl apply -f aks-helloworld-one.yaml --namespace ingress-basic<br/>kubectl apply -f aks-helloworld-two.yaml --namespace ingress-basic</span></pre><h1 id="4ea4" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">创建入口路由</h1><p id="bc9c" class="pw-post-body-paragraph jv jw in jx b jy lu ka kb kc lv ke kf kg mx ki kj kk my km kn ko mz kq kr ks ig bi translated">入口资源配置将流量路由到两个应用之一的规则。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="9f3e" class="mr kv in mn b gy ms mt l mu mv">apiVersion: networking.k8s.io/v1<br/>kind: Ingress<br/>metadata:<br/>  name: hello-world-ingress<br/>  annotations:<br/>    kubernetes.io/ingress.class: nginx<br/>    cert-manager.io/cluster-issuer: letsencrypt<br/>spec:<br/>  tls:<br/>  - hosts:<br/>    - web1.mydevsecops.org<br/>    - web2.mydevsecops.org<br/>    secretName: tls-secret<br/>  rules:<br/>  - host: web1.mydevsecops.org<br/>    http:<br/>      paths:<br/>      - path: /<br/>        <!-- -->pathType: Prefix<br/>        backend:<br/>          service:<br/>            name: aks-helloworld-one<br/>            port:<br/>              number: 80</span><span id="4883" class="mr kv in mn b gy mw mt l mu mv">- host: web2.mydevsecops.org<br/>    http:<br/>      paths:<br/>      - path: /<br/>        <!-- -->pathType: Prefix<br/>        backend:<br/>          service:<br/>            name: aks-helloworld-two<br/>            port:<br/>              number: 80</span></pre><p id="909f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">使用 kubectl 创建入口资源:</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="2164" class="mr kv in mn b gy ms mt l mu mv">kubectl apply -f hello-world-ingress.yaml --namespace ingress-basic</span></pre><h1 id="894d" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">验证证书</h1><p id="7e19" class="pw-post-body-paragraph jv jw in jx b jy lu ka kb kc lv ke kf kg mx ki kj kk my km kn ko mz kq kr ks ig bi translated">要验证证书是否创建成功，请使用<code class="fe nb nc nd mn b">kubectl describe certificate tls-secret --namespace ingress-basic</code>命令。</p><p id="e390" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">注意</strong>:等待几分钟，让 Txt 和 A 记录在 DNS 区域中更新。</p><p id="79a7" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在浏览器中打开 web1.mydevsecops.org 和 web2.mydevsecops.org，检查从 App1 和 App2 路由的 2 个不同的网页。</p><p id="83fc" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">有关 Azure Kubernetes 服务(AKS)的更多详细视频，请查看我的 YouTube 频道:</p><p id="d866" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><a class="ae kt" href="https://www.youtube.com/channel/UCkJRkUw2hYSlleTUuHY43lQ" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/channel/UCkJRkUw2hYSlleTUuHY43lQ</a></p></div></div>    
</body>
</html>