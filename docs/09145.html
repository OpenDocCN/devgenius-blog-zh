<html>
<head>
<title>Realtime Change Data Capture To BigQuery — No Kafka, No Dataflow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">实时将数据捕获更改为 BigQuery —没有 Kafka，没有数据流</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/realtime-change-data-capture-to-bigquery-no-kafka-no-dataflow-fb4a6994441b?source=collection_archive---------1-----------------------#2022-08-02">https://blog.devgenius.io/realtime-change-data-capture-to-bigquery-no-kafka-no-dataflow-fb4a6994441b?source=collection_archive---------1-----------------------#2022-08-02</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="e88c" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">使用 Debezium 和 Pub/Sub 实时运行从 MySQL 到 BigQuery 的 CDC 的概念验证…</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/f3ee4ae207d3c2cb28a665313e131ab6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jFSVHigWciilv4JQ"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk translated">卡斯帕·卡米尔·鲁宾在<a class="ae ks" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kt"><img src="../Images/b421ae9d8a572863759ba763b6b69aee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pbB5XWZtP-tqvtmo7AEjEg.png"/></div></div></figure><blockquote class="ku kv kw"><p id="c53d" class="kx ky kz la b lb lc jo ld le lf jr lg lh li lj lk ll lm ln lo lp lq lr ls lt ig bi translated">有一段时间，我一直在考虑使用 Debezium 进行概念验证，从 RDBMS 执行变更数据捕获或 CDC，并将数据接收到 BigQuery，低延迟，无需 Kafka 和 Kafka Connect。上次我尝试使用<a class="ae ks" href="https://debezium.io/documentation/reference/stable/operations/debezium-server.html" rel="noopener ugc nofollow" target="_blank">Debezium Server</a>-Cloud Pub/Sub 组合，但是遇到了一个失望，因为我需要部署<a class="ae ks" href="https://cloud.google.com/dataflow/docs/guides/templates/provided-streaming#pubsub-topic-to-bigquery" rel="noopener ugc nofollow" target="_blank">数据流作业</a>，这产生了额外的成本和更多的管理资源。所以，我当时就把这个想法甩了。直到…</p></blockquote></div><div class="ab cl lu lv hr lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="ig ih ii ij ik"><blockquote class="ku kv kw"><p id="acea" class="kx ky kz la b lb lc jo ld le lf jr lg lh li lj lk ll lm ln lo lp lq lr ls lt ig bi translated"><strong class="la io">更新 2022–08–23</strong>关于使用浮点或双精度数据类型的<a class="ae ks" href="https://www.googlecloudcommunity.com/gc/Data-Analytics/BigQuery-Subscription-Error-Incompatible-schema-type-DOUBLE-vs/m-p/458537#M616" rel="noopener ugc nofollow" target="_blank">问题已经解决</a>。感谢谷歌云团队！</p></blockquote></div><div class="ab cl lu lv hr lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="ig ih ii ij ik"><p id="74b0" class="pw-post-body-paragraph kx ky in la b lb lc jo ld le lf jr lg mb li lj lk mc lm ln lo md lq lr ls lt ig bi translated">最近，Google Cloud 推出了<a class="ae ks" href="https://cloud.google.com/blog/products/data-analytics/pub-sub-launches-direct-path-to-bigquery-for-streaming-analytics" rel="noopener ugc nofollow" target="_blank"> <strong class="la io">新功能，将数据从 Pub/Sub 直接传输到 BigQuery </strong> </a>。有了这个新的<strong class="la io"> BigQuery 订阅</strong>特性，我可能会有另一个替代解决方案。我很有兴趣试一试。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi me"><img src="../Images/2662660cb772266c0cdca456f3b4f38f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*J9HEEUc51nKKEJGn.jpg"/></div></div></figure><blockquote class="ku kv kw"><p id="f138" class="kx ky kz la b lb lc jo ld le lf jr lg lh li lj lk ll lm ln lo lp lq lr ls lt ig bi translated"><strong class="la io">注意:这只是为了好玩，并不打算用于生产用例。我会在这篇文章的最后给出更多的细节。</strong></p></blockquote></div><div class="ab cl lu lv hr lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="ig ih ii ij ik"><h1 id="ea93" class="mf mg in bd mh mi mj mk ml mm mn mo mp jt mq ju mr jw ms jx mt jz mu ka mv mw bi translated">在本地准备数据库和 Debezium 服务器</h1><p id="1a50" class="pw-post-body-paragraph kx ky in la b lb mx jo ld le my jr lg mb mz lj lk mc na ln lo md nb lr ls lt ig bi translated">我使用 MySQL 作为源数据库，并使用 Docker 将 Debezium 服务器部署在我的笔记本电脑上。你可以找到下面的<code class="fe nc nd ne nf b">docker-compose.yml</code>文件作为参考。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="465b" class="pw-post-body-paragraph kx ky in la b lb lc jo ld le lf jr lg mb li lj lk mc lm ln lo md lq lr ls lt ig bi translated">让我们对上面的 Docker 合成文件做一个小小的演练:</p><ul class=""><li id="44bb" class="ni nj in la b lb lc le lf mb nk mc nl md nm lt nn no np nq bi translated">MySQL 容器中预装了一个名为<code class="fe nc nd ne nf b">inventory</code>的数据库。我们将使用一个名为<code class="fe nc nd ne nf b">inventory.products</code>的桌子作为这次试验的测试桌子。</li><li id="e0c0" class="ni nj in la b lb nr le ns mb nt mc nu md nv lt nn no np nq bi translated">Debezium Server 容器有 2 个装载卷。第一个是对 Pub/Sub 和 BigQuery 具有写权限的服务帐户文件(<code class="fe nc nd ne nf b">demo-sa.json</code>)。第二个，我们挂载<code class="fe nc nd ne nf b">conf/</code>目录，其中包含名为<code class="fe nc nd ne nf b">application.properties</code>的 Debezium Server 配置文件。您可以在下面看到初始配置文件。请参考<a class="ae ks" href="https://debezium.io/documentation/reference/stable/operations/debezium-server.html#_sink_configuration" rel="noopener ugc nofollow" target="_blank"> Debezium Server sink 配置文档</a>中的详细内容。</li></ul><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="e7e2" class="pw-post-body-paragraph kx ky in la b lb lc jo ld le lf jr lg mb li lj lk mc lm ln lo md lq lr ls lt ig bi translated">这是我的目录结构。</p><pre class="kd ke kf kg gt nw nf nx ny aw nz bi"><span id="f18c" class="oa mg in nf b gy ob oc l od oe">├── conf<br/>│   └── application.properties<br/>├── demo-sa.json<br/>└── docker-compose.yml</span></pre><p id="103f" class="pw-post-body-paragraph kx ky in la b lb lc jo ld le lf jr lg mb li lj lk mc lm ln lo md lq lr ls lt ig bi translated">目前，我们还没有准备好运行 MySQL 和 Debezium 容器，因为我们需要在谷歌云上获得这些资源:</p><ul class=""><li id="bbab" class="ni nj in la b lb lc le lf mb nk mc nl md nm lt nn no np nq bi translated">发布/子模式—可选</li><li id="861c" class="ni nj in la b lb nr le ns mb nt mc nu md nv lt nn no np nq bi translated">酒吧/子话题</li><li id="31d8" class="ni nj in la b lb nr le ns mb nt mc nu md nv lt nn no np nq bi translated">酒吧/Sub 订阅</li><li id="dc93" class="ni nj in la b lb nr le ns mb nt mc nu md nv lt nn no np nq bi translated">大查询表</li></ul><p id="33d5" class="pw-post-body-paragraph kx ky in la b lb lc jo ld le lf jr lg mb li lj lk mc lm ln lo md lq lr ls lt ig bi translated">我们将在以后创建这些资源。</p><h1 id="becd" class="mf mg in bd mh mi of mk ml mm og mo mp jt oh ju mr jw oi jx mt jz oj ka mv mw bi translated">了解大查询订阅</h1><h2 id="7b10" class="oa mg in bd mh ok ol dn ml om on dp mp mb oo op mr mc oq or mt md os ot mv ou bi translated">酒吧/自助服务帐户权限</h2><p id="5cff" class="pw-post-body-paragraph kx ky in la b lb mx jo ld le my jr lg mb mz lj lk mc na ln lo md nb lr ls lt ig bi translated">要创建大查询订阅，发布/订阅服务帐户必须具有写入特定大查询表和读取表元数据的权限。将大查询数据编辑器(<strong class="la io">角色/大查询.数据编辑器</strong>)角色和大查询元数据查看器(<strong class="la io">角色/大查询.元数据查看器</strong>)角色授予发布/订阅服务帐户。以下是操作方法:</p><ul class=""><li id="537d" class="ni nj in la b lb lc le lf mb nk mc nl md nm lt nn no np nq bi translated">在控制台中，转到 IAM 页面。</li><li id="8651" class="ni nj in la b lb nr le ns mb nt mc nu md nv lt nn no np nq bi translated">转到 IAM</li><li id="02d7" class="ni nj in la b lb nr le ns mb nt mc nu md nv lt nn no np nq bi translated">选择“包括谷歌提供的角色授予”。</li><li id="eca8" class="ni nj in la b lb nr le ns mb nt mc nu md nv lt nn no np nq bi translated">按名称过滤:酒吧/Sub 服务帐户。服务账户的格式为<a class="ae ks" href="mailto:service-project-number@gcp-sa-pubsub.iam.gserviceaccount.com" rel="noopener ugc nofollow" target="_blank">服务-项目-编号@ GCP-sa-pubsub . iam . gserviceaccount . com</a></li><li id="a44a" class="ni nj in la b lb nr le ns mb nt mc nu md nv lt nn no np nq bi translated">单击编辑酒吧/Sub 服务帐户。</li><li id="ac7f" class="ni nj in la b lb nr le ns mb nt mc nu md nv lt nn no np nq bi translated">在编辑权限窗格中，单击添加另一个角色。</li><li id="6572" class="ni nj in la b lb nr le ns mb nt mc nu md nv lt nn no np nq bi translated">在选择角色下拉列表中，输入大查询，然后选择大查询数据编辑器角色。</li><li id="ae86" class="ni nj in la b lb nr le ns mb nt mc nu md nv lt nn no np nq bi translated">再次单击添加另一个角色。</li><li id="ac99" class="ni nj in la b lb nr le ns mb nt mc nu md nv lt nn no np nq bi translated">在选择角色下拉列表中，输入大查询，然后选择大查询元数据查看器角色。</li></ul><p id="ae00" class="pw-post-body-paragraph kx ky in la b lb lc jo ld le lf jr lg mb li lj lk mc lm ln lo md lq lr ls lt ig bi translated">更多信息请参见<a class="ae ks" href="https://cloud.google.com/pubsub/docs/create-subscription#assign_service_account" rel="noopener ugc nofollow" target="_blank">为发布/订阅服务账户分配大查询角色</a>。</p><h2 id="480a" class="oa mg in bd mh ok ol dn ml om on dp mp mb oo op mr mc oq or mt md os ot mv ou bi translated">大查询订阅的属性:主题架构</h2><p id="4c1a" class="pw-post-body-paragraph kx ky in la b lb mx jo ld le my jr lg mb mz lj lk mc na ln lo md nb lr ls lt ig bi translated">BigQuery 订阅有一个选项叫做<strong class="la io">使用主题模式</strong>。此选项允许发布/订阅将主题消息中的字段写入到 BigQuery 表中的相应列中。这听起来很有趣。但是，它附带了额外的要求:</p><ul class=""><li id="ff6f" class="ni nj in la b lb lc le lf mb nk mc nl md nm lt nn no np nq bi translated">主题模式和大查询模式中的字段必须具有相同的名称，并且它们的类型必须相互兼容。</li><li id="e9f5" class="ni nj in la b lb nr le ns mb nt mc nu md nv lt nn no np nq bi translated">主题模式中的任何可选字段在 BigQuery 模式中也必须是可选的。</li><li id="a036" class="ni nj in la b lb nr le ns mb nt mc nu md nv lt nn no np nq bi translated">主题架构中的必需字段在 BigQuery 架构中不需要是必需的。</li><li id="5e61" class="ni nj in la b lb nr le ns mb nt mc nu md nv lt nn no np nq bi translated">如果有 BigQuery 字段不在主题模式中，这些 BigQuery 字段必须处于模式<code class="fe nc nd ne nf b">NULLABLE</code>。</li><li id="d7c8" class="ni nj in la b lb nr le ns mb nt mc nu md nv lt nn no np nq bi translated">如果主题模式具有 BigQuery 模式中不存在的附加字段，并且这些字段可以被删除，则选择选项<strong class="la io">删除未知字段</strong>。</li></ul><p id="917f" class="pw-post-body-paragraph kx ky in la b lb lc jo ld le lf jr lg mb li lj lk mc lm ln lo md lq lr ls lt ig bi translated">如果我们不使用 Use topic schema 选项，订阅将写入一个名为<code class="fe nc nd ne nf b">data</code>的列。所以，用这个选项比较容易。只要确保目标表有<code class="fe nc nd ne nf b">data</code>列。</p><p id="2022" class="pw-post-body-paragraph kx ky in la b lb lc jo ld le lf jr lg mb li lj lk mc lm ln lo md lq lr ls lt ig bi translated">BigQuery 订阅文档的<a class="ae ks" href="https://cloud.google.com/pubsub/docs/bigquery#properties_of_a_subscription" rel="noopener ugc nofollow" target="_blank">属性中有更多相关信息。</a></p><p id="51fc" class="pw-post-body-paragraph kx ky in la b lb lc jo ld le lf jr lg mb li lj lk mc lm ln lo md lq lr ls lt ig bi translated">我从第二个选项开始。</p><p id="38ea" class="pw-post-body-paragraph kx ky in la b lb lc jo ld le lf jr lg mb li lj lk mc lm ln lo md lq lr ls lt ig bi translated">但是，在此之前，让我们设置一些环境变量，使我们的生活更容易。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="2e51" class="pw-post-body-paragraph kx ky in la b lb lc jo ld le lf jr lg mb li lj lk mc lm ln lo md lq lr ls lt ig bi translated">所以，事不宜迟…</p><h1 id="f70f" class="mf mg in bd mh mi of mk ml mm og mo mp jt oh ju mr jw oi jx mt jz oj ka mv mw bi translated">没有模式定义的 MySQL CDC 到 BigQuery</h1><p id="2813" class="pw-post-body-paragraph kx ky in la b lb mx jo ld le my jr lg mb mz lj lk mc na ln lo md nb lr ls lt ig bi translated">让我们在运行 CDC 部分之前准备好所需的资源。</p><p id="c341" class="pw-post-body-paragraph kx ky in la b lb lc jo ld le lf jr lg mb li lj lk mc lm ln lo md lq lr ls lt ig bi translated">首先，创建一个 BigQuery 表。因为我们没有使用模式，所以我们将创建一个包含<code class="fe nc nd ne nf b">data</code>列的表。</p><pre class="kd ke kf kg gt nw nf nx ny aw nz bi"><span id="a895" class="oa mg in nf b gy ob oc l od oe">CREATE OR REPLACE TABLE<br/>&lt;project_id&gt;.&lt;dataset&gt;.mysql_inventory_products_no_schema (<br/>  data STRING<br/>);</span></pre><p id="f5b2" class="pw-post-body-paragraph kx ky in la b lb lc jo ld le lf jr lg mb li lj lk mc lm ln lo md lq lr ls lt ig bi translated">接下来，创建一个名为<code class="fe nc nd ne nf b">mysql.inventory.products</code>的发布/订阅主题。这样命名的原因是，Debezium Server for MySQL 使用了<code class="fe nc nd ne nf b">serverName.databaseName.tableName</code>的约定作为目标主题名。</p><pre class="kd ke kf kg gt nw nf nx ny aw nz bi"><span id="abcf" class="oa mg in nf b gy ob oc l od oe">gcloud pubsub topics create mysql.inventory.products</span></pre><p id="0dfd" class="pw-post-body-paragraph kx ky in la b lb lc jo ld le lf jr lg mb li lj lk mc lm ln lo md lq lr ls lt ig bi translated">接下来，创建一个 BigQuery 订阅。</p><pre class="kd ke kf kg gt nw nf nx ny aw nz bi"><span id="4cc7" class="oa mg in nf b gy ob oc l od oe">gcloud pubsub subscriptions create \<br/>  mysql.inventory.products-bq-sub \<br/>  --topic mysql.inventory.products \<br/>  --bigquery-table=$PROJECT_ID.$BQ_DATASET.mysql_inventory_products_no_schema</span></pre><p id="34d3" class="pw-post-body-paragraph kx ky in la b lb lc jo ld le lf jr lg mb li lj lk mc lm ln lo md lq lr ls lt ig bi translated">现在，让我们检查一下集装箱。</p><pre class="kd ke kf kg gt nw nf nx ny aw nz bi"><span id="d31a" class="oa mg in nf b gy ob oc l od oe">docker-compose up</span></pre><p id="52ea" class="pw-post-body-paragraph kx ky in la b lb lc jo ld le lf jr lg mb li lj lk mc lm ln lo md lq lr ls lt ig bi translated">在等待 MySQL 容器准备就绪时，Debezium 服务器容器可能会退出并重新启动几次。</p><p id="c651" class="pw-post-body-paragraph kx ky in la b lb lc jo ld le lf jr lg mb li lj lk mc lm ln lo md lq lr ls lt ig bi translated">使用 SQL 检查 BigQuery。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ov"><img src="../Images/e67edd06d1c10e364e3ebfac2f56a3ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ejy554N2QM6VZ4vGjPAZlw.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk translated">试试 1:管用！但是那可怕的难读的行是什么？</figcaption></figure><p id="36fc" class="pw-post-body-paragraph kx ky in la b lb lc jo ld le lf jr lg mb li lj lk mc lm ln lo md lq lr ls lt ig bi translated">印象深刻！但这就是为什么那些长毛唱片？</p><p id="5e58" class="pw-post-body-paragraph kx ky in la b lb lc jo ld le lf jr lg mb li lj lk mc lm ln lo md lq lr ls lt ig bi translated">因为 Debezium 服务器默认发送原始的 CDC 格式，包括数据本身的<code class="fe nc nd ne nf b">payload</code>和<code class="fe nc nd ne nf b">schema</code>。你可以在 Debezium MySQL 数据变更事件文档页面上了解更多信息。</p><p id="a0d7" class="pw-post-body-paragraph kx ky in la b lb lc jo ld le lf jr lg mb li lj lk mc lm ln lo md lq lr ls lt ig bi translated">我们需要使用<a class="ae ks" href="https://debezium.io/documentation/reference/stable/transformations/event-flattening.html" rel="noopener ugc nofollow" target="_blank"> Debezium 的单消息转换(SMT)，称为新记录状态提取</a>。让我们将这些行添加到<code class="fe nc nd ne nf b">application.properties</code>文件中。</p><pre class="kd ke kf kg gt nw nf nx ny aw nz bi"><span id="51ff" class="oa mg in nf b gy ob oc l od oe">debezium.source.transforms=unwrap<br/>debezium.source.transforms.unwrap.type=io.debezium.transforms.ExtractNewRecordState<br/>debezium.source.transforms.unwrap.add.fields=op,table,source.ts_ms<br/>debezium.source.transforms.unwrap.delete.handling.mode=rewrite</span></pre><p id="28a0" class="pw-post-body-paragraph kx ky in la b lb lc jo ld le lf jr lg mb li lj lk mc lm ln lo md lq lr ls lt ig bi translated">让我们重新设置所有的事情，重新开始。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="6d0f" class="pw-post-body-paragraph kx ky in la b lb lc jo ld le lf jr lg mb li lj lk mc lm ln lo md lq lr ls lt ig bi translated">使用 SQL 再次检查。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ov"><img src="../Images/1cbd1d780d24fd7c87b210ff25ac9cd4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uY_8V8_K2U_WNQb-cAcufg.png"/></div></div></figure><p id="b8d5" class="pw-post-body-paragraph kx ky in la b lb lc jo ld le lf jr lg mb li lj lk mc lm ln lo md lq lr ls lt ig bi translated">现在，好多了。但是那些<code class="fe nc nd ne nf b">schema</code>是什么东西呢？我们能摆脱他们吗？</p><p id="32c0" class="pw-post-body-paragraph kx ky in la b lb lc jo ld le lf jr lg mb li lj lk mc lm ln lo md lq lr ls lt ig bi translated">我们当然可以。在<code class="fe nc nd ne nf b">application.properties</code>上添加这些行并重新开始。</p><pre class="kd ke kf kg gt nw nf nx ny aw nz bi"><span id="a54d" class="oa mg in nf b gy ob oc l od oe">debezium.source.key.converter.schemas.enable=false<br/>debezium.source.value.converter.schemas.enable=false</span></pre><p id="9e6a" class="pw-post-body-paragraph kx ky in la b lb lc jo ld le lf jr lg mb li lj lk mc lm ln lo md lq lr ls lt ig bi translated">使用 SQL 再次检查。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ow"><img src="../Images/f7d1c60b71389a34d6a4bdbafc49ae9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QQa-qeuqX7Xc0PRzwKvTAw.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk translated">那太好了。</figcaption></figure><p id="2236" class="pw-post-body-paragraph kx ky in la b lb lc jo ld le lf jr lg mb li lj lk mc lm ln lo md lq lr ls lt ig bi translated">这就对了。</p><p id="dab8" class="pw-post-body-paragraph kx ky in la b lb lc jo ld le lf jr lg mb li lj lk mc lm ln lo md lq lr ls lt ig bi translated">注意，我们有额外的字段<code class="fe nc nd ne nf b">__op</code>、<code class="fe nc nd ne nf b">__table</code>、<code class="fe nc nd ne nf b">__source_ts_ms</code>和<code class="fe nc nd ne nf b">__deleted</code>。这是因为我们在<code class="fe nc nd ne nf b">application.properties</code>上有这些额外的配置。</p><pre class="kd ke kf kg gt nw nf nx ny aw nz bi"><span id="de0f" class="oa mg in nf b gy ob oc l od oe">debezium.source.transforms.unwrap.add.fields=op,table,source.ts_ms</span></pre><h1 id="a9d6" class="mf mg in bd mh mi of mk ml mm og mo mp jt oh ju mr jw oi jx mt jz oj ka mv mw bi translated">用模式定义将 MySQL CDC 转换成 BigQuery</h1><p id="38ab" class="pw-post-body-paragraph kx ky in la b lb mx jo ld le my jr lg mb mz lj lk mc na ln lo md nb lr ls lt ig bi translated">我们已经成功地将没有模式定义 MySQL CDC 流式传输到一个单列的 BigQuery 表中。现在，让我们尝试使用 schema，这样我们就有了一个表格数据，它具有与 MySQL 源表模式相匹配的独立字段。</p><p id="64a0" class="pw-post-body-paragraph kx ky in la b lb lc jo ld le lf jr lg mb li lj lk mc lm ln lo md lq lr ls lt ig bi translated">首先，让我们清理一下我们之前制造的混乱。</p><pre class="kd ke kf kg gt nw nf nx ny aw nz bi"><span id="929a" class="oa mg in nf b gy ob oc l od oe"># Delete subscription<br/>gcloud pubsub subscriptions delete mysql.inventory.products-bq-sub</span><span id="7900" class="oa mg in nf b gy ox oc l od oe"># Delete topic<br/>gcloud pubsub topics delete mysql.inventory.products</span><span id="f2fa" class="oa mg in nf b gy ox oc l od oe"># Drop BigQuery table (Using SQL UI)<br/>DROP TABLE &lt;project_id&gt;.&lt;dataset&gt;.mysql_inventory_products_no_schema;</span></pre><p id="f888" class="pw-post-body-paragraph kx ky in la b lb lc jo ld le lf jr lg mb li lj lk mc lm ln lo md lq lr ls lt ig bi translated">创建新的 BigQuery 表。</p><pre class="kd ke kf kg gt nw nf nx ny aw nz bi"><span id="4b58" class="oa mg in nf b gy ob oc l od oe">CREATE OR REPLACE TABLE tibrahim_debezium.mysql_inventory_products (<br/>  id INT64 NOT NULL,<br/>  name STRING,<br/>  description STRING,<br/>  weight float64,<br/>  __op STRING,<br/>  __table STRING,<br/>  __source_ts_ms INT64,<br/>  __deleted STRING<br/>);</span></pre><p id="eecd" class="pw-post-body-paragraph kx ky in la b lb lc jo ld le lf jr lg mb li lj lk mc lm ln lo md lq lr ls lt ig bi translated">接下来，让我们为发布/订阅主题创建模式。此方案必须是与源表定义匹配的有效 AVRO 方案。</p><pre class="kd ke kf kg gt nw nf nx ny aw nz bi"><span id="6706" class="oa mg in nf b gy ob oc l od oe">gcloud pubsub schemas create mysql.inventory.products-schema \<br/>--type=AVRO \<br/>--definition='{"type":"record","name":"MysqlInventoryProductsSchema","fields":[{"type":"int","optional":false,"name":"id"},{"type":"string","optional":false,"name":"name"},{"type":"string","optional":false,"name":"description"},{"type":"float","optional":false,"name":"weight"},{"type":"string","optional":true,"name":"__op"},{"type":"string","optional":true,"name":"__table"},{"type":"long","optional":true,"name":"__source_ts_ms"},{"type":"string","optional":true,"name":"__deleted"}]}'</span></pre><p id="2330" class="pw-post-body-paragraph kx ky in la b lb lc jo ld le lf jr lg mb li lj lk mc lm ln lo md lq lr ls lt ig bi translated">现在，让我们使用模式创建发布/订阅主题。</p><pre class="kd ke kf kg gt nw nf nx ny aw nz bi"><span id="ee14" class="oa mg in nf b gy ob oc l od oe">gcloud pubsub topics create mysql.inventory.products --message-encoding=json --schema=mysql.inventory.products-schema</span></pre><p id="f94a" class="pw-post-body-paragraph kx ky in la b lb lc jo ld le lf jr lg mb li lj lk mc lm ln lo md lq lr ls lt ig bi translated">现在，新特性 BigQuery 订阅…带有模式</p><pre class="kd ke kf kg gt nw nf nx ny aw nz bi"><span id="7f9c" class="oa mg in nf b gy ob oc l od oe">gcloud pubsub subscriptions create mysql.inventory.products-bq-sub \<br/> --topic mysql.inventory.products \<br/> --bigquery-table=$PROJECT_ID.$BQ_DATASET.mysql_inventory_products \<br/> --use-topic-schema</span></pre><p id="6e39" class="pw-post-body-paragraph kx ky in la b lb lc jo ld le lf jr lg mb li lj lk mc lm ln lo md lq lr ls lt ig bi translated">哎哟，我们这里有一个错误。</p><pre class="kd ke kf kg gt nw nf nx ny aw nz bi"><span id="e19b" class="oa mg in nf b gy ob oc l od oe">ERROR: Failed to create subscription [projects/&lt;PROJECT_ID&gt;/subscriptions/mysql.inventory.products-bq-sub]: Incompatible schema type for field weight: DOUBLE vs. FLOAT.<br/>ERROR: (gcloud.pubsub.subscriptions.create) Failed to create the following: [mysql.inventory.products-bq-sub].</span></pre><p id="0721" class="pw-post-body-paragraph kx ky in la b lb lc jo ld le lf jr lg mb li lj lk mc lm ln lo md lq lr ls lt ig bi translated">BigQuery 订阅似乎有一个与<code class="fe nc nd ne nf b">float</code>数据类型相关的问题/错误。我在 Google Cloud 社区论坛上写了一篇关于这个问题的<a class="ae ks" href="https://www.googlecloudcommunity.com/gc/Data-Analytics/BigQuery-Subscription-Error-Incompatible-schema-type-DOUBLE-vs/m-p/449166" rel="noopener ugc nofollow" target="_blank">帖子</a>，似乎我不是唯一一个经历这个错误的人。</p><p id="1639" class="pw-post-body-paragraph kx ky in la b lb lc jo ld le lf jr lg mb li lj lk mc lm ln lo md lq lr ls lt ig bi translated">好吧，我对这个问题有点失望。但是，我们不能就此打住。我们将尝试使用另一个没有<code class="fe nc nd ne nf b">float</code>列的表。让我们使用<code class="fe nc nd ne nf b">addresses</code>表。</p><p id="c392" class="pw-post-body-paragraph kx ky in la b lb lc jo ld le lf jr lg mb li lj lk mc lm ln lo md lq lr ls lt ig bi translated">已更改 Debezium 服务器<code class="fe nc nd ne nf b">application.properties</code>:</p><pre class="kd ke kf kg gt nw nf nx ny aw nz bi"><span id="587b" class="oa mg in nf b gy ob oc l od oe">debezium.source.table.include.list=inventory.addresses</span></pre><p id="18e1" class="pw-post-body-paragraph kx ky in la b lb lc jo ld le lf jr lg mb li lj lk mc lm ln lo md lq lr ls lt ig bi translated">让我们为<code class="fe nc nd ne nf b">addresses</code>表创建一个新的 BigQuery 表。</p><pre class="kd ke kf kg gt nw nf nx ny aw nz bi"><span id="e1d4" class="oa mg in nf b gy ob oc l od oe">CREATE OR REPLACE TABLE &lt;project_id&gt;.&lt;dataset&gt;.mysql_inventory_addresses (<br/>  `id` int64 NOT NULL,<br/>  `customer_id` int NOT NULL,<br/>  `street` STRING NOT NULL,<br/>  `city` STRING NOT NULL,<br/>  `state` STRING NOT NULL,<br/>  `zip` STRING NOT NULL,<br/>  `type` STRING NOT NULL,<br/>  __op STRING,<br/>  __table STRING,<br/>  __source_ts_ms INT64,<br/>  __deleted STRING<br/>);</span></pre><p id="c973" class="pw-post-body-paragraph kx ky in la b lb lc jo ld le lf jr lg mb li lj lk mc lm ln lo md lq lr ls lt ig bi translated">接下来，创建发布/订阅模式、主题、BigQuery 订阅并运行 Debezium 服务器。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="4587" class="pw-post-body-paragraph kx ky in la b lb lc jo ld le lf jr lg mb li lj lk mc lm ln lo md lq lr ls lt ig bi translated">我的朋友，这就是我们数据的漂亮表格视图。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ow"><img src="../Images/c7488810d3b0574493bf434dbab236fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LQcJ6Yd1kqLgVRmnLUviPg.png"/></div></div></figure></div><div class="ab cl lu lv hr lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="ig ih ii ij ik"><h1 id="8545" class="mf mg in bd mh mi mj mk ml mm mn mo mp jt mq ju mr jw ms jx mt jz mu ka mv mw bi translated">我的外卖</h1><p id="b01e" class="pw-post-body-paragraph kx ky in la b lb mx jo ld le my jr lg mb mz lj lk mc na ln lo md nb lr ls lt ig bi translated">借助 Debezium 服务器和 Pub/Sub，可以在没有 Kafka 和 Kafka Connect 的情况下运行变更数据捕获。随着 BigQuery 订阅特性的发布，无需云数据流，直接传输到 BigQuery 表变得更加容易。需要监控的资源更少，麻烦更少，成本更低。</p><p id="6d35" class="pw-post-body-paragraph kx ky in la b lb lc jo ld le lf jr lg mb li lj lk mc lm ln lo md lq lr ls lt ig bi translated">然而，这种更简单的方法带来了另一个问题:</p><ul class=""><li id="a188" class="ni nj in la b lb lc le lf mb nk mc nl md nm lt nn no np nq bi translated"><strong class="la io">模式演变</strong> <br/>目前，在一个模式与一个主题相关联之后，你不能更新该模式。如果您的源表模式发生了变化，那么 CDC 流将会失败。<a class="ae ks" href="https://docs.confluent.io/platform/current/schema-registry/index.html" rel="noopener ugc nofollow" target="_blank">融合模式注册中心</a>或<a class="ae ks" href="https://www.apicur.io/registry/" rel="noopener ugc nofollow" target="_blank"> Apicurio 模式注册中心</a>已经解决了这个挑战。关于这一点，有一个<a class="ae ks" href="https://issuetracker.google.com/issues/206147008" rel="noopener ugc nofollow" target="_blank">谷歌问题跟踪器</a>。让我们希望谷歌发布/订阅团队将在不久的将来解决这个问题。如果你的数据源经常改变模式，也许你最好坚持使用 Kafka 栈。</li><li id="7f65" class="ni nj in la b lb nr le ns mb nt mc nu md nv lt nn no np nq bi translated"><strong class="la io">主题和目的表自动创建/模式自动演化</strong> <br/>在撰写本文时，我们需要在运行 Debezium 之前创建模式、主题、订阅和 BigQuery 表。如果您有几十或几百个表，那么您需要自动创建、管理和销毁资源。更成熟的框架如<a class="ae ks" href="https://docs.confluent.io/platform/current/connect/overview.html" rel="noopener ugc nofollow" target="_blank"> Kafka Connect </a>和开源的<a class="ae ks" href="https://github.com/confluentinc/kafka-connect-bigquery" rel="noopener ugc nofollow" target="_blank">Kafka Connect biqquery Sink</a>已经解决了这个问题。同样，如果你在这个问题上有问题，那么也许你应该坚持使用 Kafka Connect 或者其他成熟的框架。</li></ul><p id="df17" class="pw-post-body-paragraph kx ky in la b lb lc jo ld le lf jr lg mb li lj lk mc lm ln lo md lq lr ls lt ig bi translated">如果你没有上述任何问题，那么这种方法可能适合你。反正这个功能真的很棒。不仅仅是为了捕获变更数据，您还可以将它用于很多事情，比如将物联网传感器数据直接发送到 BigQuery。或者捕捉网络事件。天空是极限。</p></div></div>    
</body>
</html>