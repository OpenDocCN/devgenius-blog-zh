<html>
<head>
<title>Why use Apache Airflow Deferrable Operators?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为什么使用阿帕奇气流可推迟运营商？</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/why-use-apache-airflow-deferrable-operators-e2178ea105d7?source=collection_archive---------2-----------------------#2022-11-04">https://blog.devgenius.io/why-use-apache-airflow-deferrable-operators-e2178ea105d7?source=collection_archive---------2-----------------------#2022-11-04</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/e3c8db1ede9629a99f83718b2bfd6a42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ORaj_P2LDe7FldmL-4682A.jpeg"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">由<a class="ae jz" href="https://unsplash.com/@samthewam24?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Samuel Sianipar </a>在<a class="ae jz" href="https://unsplash.com/s/photos/pipe?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="9e3d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">而如何在你的气流任务空转的时候节省资源？</p><p id="2028" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">距离 Airflow 2.2 发布已经有一段时间了，引入了一种新型的算子，叫做<strong class="kc io">可延迟算子</strong>。</p><p id="4494" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">每次在 Airflow 中运行任务时，它都会占用一个 worker 槽。因此，如果您有 100 个工作插槽和 100 个传感器同时运行并处于空闲状态，您将无法再运行任何任务，即使整个气流可能处于空闲状态。</p><p id="cf41" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">可延期操作员如何提供帮助？</strong></p><p id="02b4" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">可延迟操作符在到达该点时被挂起，此时需要等待某些外部条件得到满足。一旦操作员到达这一点，它将进入一个新的状态，称为<strong class="kc io">延迟</strong>，并将任务执行移交给<strong class="kc io">触发器</strong>(下面将详细介绍触发器)。<br/>处于延迟状态时，操作员将被停止，一个工作插槽将返回到池中。<br/>一旦来自触发器的 await 条件得到满足，操作者将使用操作者定义的某种方法恢复操作。</p><figure class="kz la lb lc gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ky"><img src="../Images/908facf1570f2240344092fdacaf8ef8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*nzrxNnTA6DlCjoly.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">归功于<a class="ae jz" rel="noopener ugc nofollow" target="_blank" href="/airflow-deferrable-operators-5a7c90aaa14f">阿米特·辛格·拉索尔</a></figcaption></figure><p id="3c0c" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">触发。</strong></p><p id="adee" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Trigger 是一个小型的异步 Python 函数，可以快速连续地评估给定的条件。一个典型的例子是检查集群上运行的 Spark 作业的状态。由于这个函数被设计得又快又小，所以单个进程可以处理数千个这样的小任务。这个过程称为 Trigerrer。</p><p id="a4fb" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">特里格勒过程。</strong></p><p id="8eb1" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这是一个新的 Airflow 服务(比如 scheduler 或 worker)，它在您的 Airflow 环境中运行一个 asyncio even 循环。它被设计成高度可用的，即你可以同时在不同的机器上运行多个服务，它们将通过正确的锁定和 HA 自动共存。</p><p id="80ac" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">切换现有运营商，使用可延期运营商。</strong></p><p id="4d90" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">某些运营商已经有一个可推迟的版本。例如，如果您正在使用数据块，您需要做的就是将常规的<code class="fe ld le lf lg b">DatabricksSubmitRunOperator</code>替换为<code class="fe ld le lf lg b">DatabricksSubmitRunDeferrableOperator</code>，如下例所示:</p><pre class="kz la lb lc gt lh lg li lj aw lk bi"><span id="3a78" class="ll lm in lg b gy ln lo l lp lq">json = {<br/>    'new_cluster': {'spark_version': '2.1.0-db3-scala2.11', 'num_workers': 2},<br/>    'notebook_task': {<br/>        'notebook_path': '/Users/airflow@example.com/PrepareData',<br/>    },<br/>}<br/>notebook_run = DatabricksSubmitRunDeferrableOperator(task_id='notebook_run', json=json)</span></pre><p id="04b1" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">使用传感器的区别。</strong></p><p id="504c" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Airflow 也有一个针对传感器的<code class="fe ld le lf lg b">reschedule</code>模式解决方案，它允许传感器只在固定的时间间隔运行，但这没有那么灵活，因为它只允许使用时间作为恢复的理由，而不是其他任何东西。</p><p id="8153" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">使用可延迟运算符的好处。</strong></p><ul class=""><li id="0aec" class="lr ls in kc b kd ke kh ki kl lt kp lu kt lv kx lw lx ly lz bi translated">减少资源消耗——一个触发器可以处理数千个延迟任务，从而释放更多的工作线程。</li><li id="f382" class="lr ls in kc b kd ma kh mb kl mc kp md kt me kx lw lx ly lz bi translated">高度可用的触发器确保管道在基础设施出现故障时不会中断。</li><li id="73f8" class="lr ls in kc b kd ma kh mb kl mc kp md kt me kx lw lx ly lz bi translated">这是朝着事件驱动 Dag 迈出的一大步。</li></ul><p id="f4df" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">好好呆着，让你的管道平稳运行！</p></div></div>    
</body>
</html>