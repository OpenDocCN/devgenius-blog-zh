<html>
<head>
<title>Authenticating users to your web app using metamask and nodejs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 metamask 和 nodejs 向您的 web 应用程序验证用户</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/authenticating-users-to-your-web-app-using-metamask-and-nodejs-e920e45e358?source=collection_archive---------1-----------------------#2022-01-06">https://blog.devgenius.io/authenticating-users-to-your-web-app-using-metamask-and-nodejs-e920e45e358?source=collection_archive---------1-----------------------#2022-01-06</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="9fd3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">包含代码片段的分步指南，用于实现 web3 登录流程。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/1a10c275e6985bbcc80f83751526d8d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LxnTZ2gSPb-TTEGIhk7aiQ.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">背景图片来自<a class="ae ky" href="https://www.pexels.com/pt-br/foto/fotografia-aerea-de-pinheiros-na-montanha-9754/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">像素</a>中的<a class="ae ky" href="https://www.pexels.com/pt-br/@creative-vix?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">创意波动率</a></figcaption></figure><p id="c167" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">因此，您正在构建一个 web3 web 应用程序，现在到了可怕的部分，您需要对用户进行身份验证，并确保您的一些服务路径只有在正确的身份验证后才能访问。别担心，你无意中找到了正确的文章。</p><p id="a3bb" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在本文中，我们将生成并使用 jwt (json web 令牌)来允许用户访问 nodejs 中受保护的路由，这需要对用户进行身份验证(比如更新他们自己的配置文件细节)。不同之处在于，用户不再提供用户名和密码，而是只使用元掩码钱包进行身份验证。以下是我们将使用的技术:</p><ul class=""><li id="78cc" class="kz la in jm b jn jo jr js jv lb jz lc kd ld kh le lf lg lh bi translated">我们后端/api 的 Nodejs。</li><li id="50ba" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">用于生成 jwt 令牌的 Passportjs。</li><li id="b704" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">前端登录的元掩码。</li><li id="8e0b" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">Vuejs 和 Nuxtjs 用于我们的前端(您也应该能够将此代码转换为其他框架，如 React)。</li></ul><p id="cbfe" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">为了使本文简短，我不会深入讨论下面提到的一些主题(例如脚本编程、客户端状态管理、执行 http 请求、将 nodejs 连接到数据库等等)，本文应该作为任何开发人员在他们的应用程序中快速实现 web3 jwt 身份验证流程的快速分步指南。</p><h1 id="6af5" class="ln lo in bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">认证流程</h1><p id="f505" class="pw-post-body-paragraph jk jl in jm b jn ml jp jq jr mm jt ju jv mn jx jy jz mo kb kc kd mp kf kg kh ig bi translated">身份验证流程如下:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mq"><img src="../Images/b2679159ed4303c7fd9a58a4f016eb13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2KhuA2u-5lFnbw4sMrtspw.png"/></div></div></figure><p id="d2e1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">根据定义，随机数是在加密通信中只能使用一次的任意数字。在本文中，我们将使用以下代码在 javascript 中生成随机随机数:</p><pre class="kj kk kl km gt mr ms mt mu aw mv bi"><span id="5d41" class="mw lo in ms b gy mx my l mz na">nonce = Math.floor(Math.random() * 1000000);</span></pre><p id="d92e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">此外，如果用户是第一次登录该平台，我们将通过将他添加到我们的用户数据库并自动为他分配一个随机数来自动注册他。</p><h1 id="30e0" class="ln lo in bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">前端设置</h1><p id="d6ff" class="pw-post-body-paragraph jk jl in jm b jn ml jp jq jr mm jt ju jv mn jx jy jz mo kb kc kd mp kf kg kh ig bi translated">在我的例子中，我创建了下面的 vue 组件，它将具有上面提到的所有必需的逻辑:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/9f6b7626b24f195ba35975f8c5a8d3da.png" data-original-src="https://miro.medium.com/v2/resize:fit:544/format:webp/1*W6lL9j8cVIY4hjfqMlN8yQ.png"/></div></figure><p id="83ac" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果用户没有安装元掩码，它会要求用户先安装它:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/b74e4655e3b96e0db6acc27e4aac7a8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:730/format:webp/1*GIWnn6WK_FF1YtVmcpvu5Q.png"/></div></figure><p id="adb1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">模板 html 代码(使用 Vuejs 和 Nuxtjs)如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="7254" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">与核心相关的 javascript 代码如下。注意，在这段代码中，我们使用<a class="ae ky" href="https://axios-http.com/docs/intro" rel="noopener ugc nofollow" target="_blank"> axios </a>来执行 http 请求，使用<a class="ae ky" href="https://vuex.vuejs.org/" rel="noopener ugc nofollow" target="_blank"> vuex </a>来本地管理 web 应用程序中的状态。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="a908" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在我们的本地应用 vuex 状态下，当调用 metamask/ethereum getter 时，我们执行以下操作:</p><pre class="kj kk kl km gt mr ms mt mu aw mv bi"><span id="975b" class="mw lo in ms b gy mx my l mz na">ethereum: state =&gt; { if(process.client) { return window.ethereum } }</span></pre><p id="8a3f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">完整的脚本代码包括这个 Vue 组件的其他提到的方法可以在<a class="ae ky" href="https://gist.github.com/duartefdias/b2d1557a35a0bec6329d3f54e1771f5e" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><h1 id="2204" class="ln lo in bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">后端设置</h1><p id="aae9" class="pw-post-body-paragraph jk jl in jm b jn ml jp jq jr mm jt ju jv mn jx jy jz mo kb kc kd mp kf kg kh ig bi translated">在后端，我们在 Nodejs 中实现了以下路由:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="4cde" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">上述文件的完整代码和其他路径可以在<a class="ae ky" href="https://gist.github.com/duartefdias/0a1467e7f788a1ca261d2b1e02596783" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="069d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">您还需要为 passportjs 创建一个设置，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="84c9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">JWT_SECRET 是一个将用于解密 JWT 令牌的字符串。可以是你想要的任何东西。</p><h1 id="9d75" class="ln lo in bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">用户体验</h1><p id="1bd7" class="pw-post-body-paragraph jk jl in jm b jn ml jp jq jr mm jt ju jv mn jx jy jz mo kb kc kd mp kf kg kh ig bi translated">假设您正确地实现了上述设置，您现在应该有一个类似于下面的用户登录流:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nf"><img src="../Images/4db70741b39ab65cdcf28a23ea1ea23d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*E1HXeWhysXtaiRp5AAaiOg.gif"/></div></div></figure><p id="d988" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">您可以将 metamask 中显示的消息自定义为您想要的任何内容。只要确保完整的字符串(message + nonce)在前端和后端是相同的。</p><p id="cf14" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">前端应用程序现在将拥有一个 jwt 令牌，它可以将这个令牌附加到任何 http 请求中，以访问受保护的 api 路由。</p><h1 id="3b71" class="ln lo in bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">在节点中创建受保护的路由</h1><p id="71b8" class="pw-post-body-paragraph jk jl in jm b jn ml jp jq jr mm jt ju jv mn jx jy jz mo kb kc kd mp kf kg kh ig bi translated">您可以像这样轻松地创建受保护的路由:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="6f21" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在本例中，在运行任何路由代码之前，路由将使用 passportjs 中间件来验证所提供的 jwt 令牌是否有效。否则，它将向用户返回一条未经授权的消息。</p><h1 id="1e6b" class="ln lo in bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">结论</h1><p id="a7b2" class="pw-post-body-paragraph jk jl in jm b jn ml jp jq jr mm jt ju jv mn jx jy jz mo kb kc kd mp kf kg kh ig bi translated">本文是一篇简短实用的指南，介绍了如何在应用程序中快速实现 web3 jwt 认证流程。如果你遇到困难，或者想进一步了解上面提到的一些话题，我建议你查阅以下资源:</p><ul class=""><li id="9a8e" class="kz la in jm b jn jo jr js jv lb jz lc kd ld kh le lf lg lh bi translated"><a class="ae ky" href="https://docs.metamask.io/guide/" rel="noopener ugc nofollow" target="_blank"> Metamask 开发者文档</a></li><li id="2a1a" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated"><a class="ae ky" href="https://docs.metamask.io/guide/create-dapp.html#project-setup" rel="noopener ugc nofollow" target="_blank">使用元掩码创建基本的分散式应用</a></li><li id="1c2d" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated"><a class="ae ky" href="https://expressjs.com/en/starter/generator.html" rel="noopener ugc nofollow" target="_blank">使用 express 创建 nodejs 应用程序</a></li><li id="45ae" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated"><a class="ae ky" href="https://mongoosejs.com/docs/" rel="noopener ugc nofollow" target="_blank">创建数据库模式并使用 Mongoose 访问 MongoDB 数据库</a></li><li id="4c26" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated"><a class="ae ky" href="http://www.passportjs.org/packages/passport-jwt/" rel="noopener ugc nofollow" target="_blank">使用 passport-jwt 库生成 jwt 令牌</a></li><li id="3a7d" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated"><a class="ae ky" href="https://nuxtjs.org/docs/get-started/installation" rel="noopener ugc nofollow" target="_blank">使用 Nuxtjs 创建前端应用</a></li><li id="6953" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated"><a class="ae ky" href="https://axios-http.com/docs/intro" rel="noopener ugc nofollow" target="_blank">使用 axios 执行 http 请求</a></li><li id="5c1b" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated"><a class="ae ky" href="https://nuxtjs.org/docs/directory-structure/store/" rel="noopener ugc nofollow" target="_blank">使用 Vuex 管理前端应用的本地状态</a></li></ul><p id="c342" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">编码快乐！</p></div></div>    
</body>
</html>