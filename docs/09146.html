<html>
<head>
<title>A Beginner Guide to dbt Tests</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">dbt 测试初学者指南</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/a-beginner-guide-to-dbt-tests-31ddc4178170?source=collection_archive---------2-----------------------#2022-08-02">https://blog.devgenius.io/a-beginner-guide-to-dbt-tests-31ddc4178170?source=collection_archive---------2-----------------------#2022-08-02</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="6fa8" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">为您的数据转换创建测试用例</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/2716c2b13cd3b892f4278fa4ad4900e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MiJMIpkb3OnBKWdM"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk translated"><a class="ae ks" href="https://unsplash.com/es/@firmbee?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Firmbee.com</a>在<a class="ae ks" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</figcaption></figure><p id="11ac" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><strong class="kv io">简介</strong></p><p id="c557" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">当使用数据构建工具(<a class="ae ks" href="https://www.getdbt.com/" rel="noopener ugc nofollow" target="_blank"> dbt) </a>运行您的<strong class="kv io"> ELT 管道</strong>时，最好能够在早期执行简单的验证，一个很好的方法就是使用 dbt 测试。这是 dbt 项目中受支持的特性，它允许您为您的转换创建测试用例。这种测试允许您尝试在早期捕捉潜在的问题，这样可以节省您尝试在下游解决问题的努力。在本指南中，我将展示如何使用 dbt 测试来验证您的转换。</p><p id="da08" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">我将测试一个现有的 ELT 管道的 dbt 项目的公开可用的<a class="ae ks" href="https://console.cloud.google.com/marketplace/product/bigquery-public-datasets/covid19-public-data-program?project=resonant-matter-297100" rel="noopener ugc nofollow" target="_blank">谷歌大查询公共数据集项目</a>新冠肺炎数据。在本指南中，我将介绍在转换上创建和运行 dbt 测试的一些主要方面。我涉及的主题包括:</p><ul class=""><li id="1839" class="lp lq in kv b kw kx kz la lc lr lg ls lk lt lo lu lv lw lx bi translated">dbt 中的测试概述</li><li id="a38d" class="lp lq in kv b kw ly kz lz lc ma lg mb lk mc lo lu lv lw lx bi translated">dbt 核心内置测试</li><li id="f041" class="lp lq in kv b kw ly kz lz lc ma lg mb lk mc lo lu lv lw lx bi translated">dbt 自定义测试</li></ul><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi md"><img src="../Images/6f5add4806431a66c6b5ac444a2e511d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e_NT0zHKZIOjffHDOU4mXw.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk translated">作者图片</figcaption></figure><p id="260c" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><strong class="kv io">设置</strong></p><p id="6f0f" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">在这个 ELT <strong class="kv io"> </strong>管道中，已经使用<a class="ae ks" href="https://airbyte.com/" rel="noopener ugc nofollow" target="_blank"> Airbyte </a>完成了<strong class="kv io">提取</strong>和<strong class="kv io">加载</strong>步骤，还增加了一个<strong class="kv io">规范化</strong>步骤，将结果 json blob 字段转换为列。这意味着我可以使用 dbt 直接进入<strong class="kv io">转换</strong>步骤，我在前面添加了一些验证测试。这个项目的 dbt repo 在这里是<a class="ae ks" href="https://github.com/BayoAdejare/airbyte_dbt_covid19" rel="noopener ugc nofollow" target="_blank">这里是</a>，在整个指南中，我将使用 dbt Core 版本 1.2.0 来开发测试，dbt 项目连接到一个<a class="ae ks" href="https://www.snowflake.com/" rel="noopener ugc nofollow" target="_blank">雪花</a>数据仓库。</p><p id="b43f" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><strong class="kv io">概述</strong></p><p id="e9b5" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">一般来说，有两种类型的测试可以实现，第一种是<strong class="kv io">内置测试</strong>，第二种是<strong class="kv io">定制测试。</strong>内置测试是 dbt Core 自带的预定义测试，通常被定义为 model 文件夹的 yaml 模式文件中的属性，这就是为什么它们通常被称为模式测试。自定义或定制测试是在 tests 文件夹中编写的，这些一次性断言是 SQL SELECT 查询，根据返回值验证数据。除了这两个测试之外，您还可以从 dbt 包中实现测试，比如<a class="ae ks" href="https://hub.getdbt.com/calogica/dbt_expectations/latest/" rel="noopener ugc nofollow" target="_blank"> dbt-expectations </a>和<a class="ae ks" href="https://hub.getdbt.com/dbt-labs/dbt_utils/latest/" rel="noopener ugc nofollow" target="_blank"> dbt-utils </a>。</p><blockquote class="me"><p id="5b99" class="mf mg in bd mh mi mj mk ml mm mn lo dk translated">当编写 dbt 测试时，根据数据和需求以有意义的定性方式定义它们是很重要的，因为您从测试中获得的价值只和您定义的一样好。</p></blockquote><p id="cd7d" class="pw-post-body-paragraph kt ku in kv b kw mo jo ky kz mp jr lb lc mq le lf lg mr li lj lk ms lm ln lo ig bi translated">在本指南中，我仅使用内置测试和一个示例定制测试来说明开始测试您的 dbt 项目是多么简单。</p><p id="65dd" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><strong class="kv io">内置测试</strong></p><p id="ac36" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">在 dbt 项目的 models 文件夹 yaml 模式文件中，我使用 dbt 对资源(即数据源和模型)的内置测试来定义属性。dbt 可以运行四种不同类型的测试:</p><ol class=""><li id="443a" class="lp lq in kv b kw kx kz la lc lr lg ls lk lt lo mt lv lw lx bi translated"><strong class="kv io">唯一性:</strong>测试列是否具有唯一值。</li><li id="cd47" class="lp lq in kv b kw ly kz lz lc ma lg mb lk mc lo mt lv lw lx bi translated"><strong class="kv io"> Not null: </strong>测试列没有空值。</li><li id="a530" class="lp lq in kv b kw ly kz lz lc ma lg mb lk mc lo mt lv lw lx bi translated"><strong class="kv io">参照完整性:</strong>测试列值是否与父参照表存在关系。</li><li id="4760" class="lp lq in kv b kw ly kz lz lc ma lg mb lk mc lo mt lv lw lx bi translated"><strong class="kv io">接受值:</strong>测试该列仅包含指定的已定义值。</li></ol><p id="38e0" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">在我的项目中，我定义了一个对数据源的惟一性和各自 hashid 列的 not null 的测试。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi mu"><img src="../Images/3f5d52792384878a936efbfb0b7c3dad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3fwT8YSY4jpewWnXr2i0MQ.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk translated">定义唯一和非空测试(按作者)</figcaption></figure><p id="bcd0" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">为了测试源表上的特定测试，我使用以下命令:</p><p id="7c02" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><code class="fe mv mw mx my b">dbt test --select source:raw_covid19.stg_epidemiology</code></p><p id="5d92" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">使用<code class="fe mv mw mx my b">dbt test</code>命令，我可以执行所有的测试用例并得到一个结果。dbt 将运行测试并显示结果，默认结果可以是<code class="fe mv mw mx my b">PASS</code>、<code class="fe mv mw mx my b">WARN</code>、<code class="fe mv mw mx my b">ERROR</code>或<code class="fe mv mw mx my b">SKIP</code>，下面是具体数据源的测试运行结果:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi mz"><img src="../Images/a3877b78db253d392e16984e68f2b59b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pgI__pkgt5m2M7wDwjF2uQ.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk translated">通过测试结果:不为空，唯一(按作者)</figcaption></figure><p id="ae82" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">如果测试运行导致一个错误，dbt 将输出错误细节，我通过运行一个包含以下错误的测试来说明这一点:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi na"><img src="../Images/b86606847900d26dcc314aa9c992909e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YM2H52nshtNZzpA3sisgyA.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk translated">带有消息的错误测试结果(由作者提供)</figcaption></figure><p id="59d0" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">对于参照完整性，也称为关系测试，我实现了一个模型测试，检查<code class="fe mv mw mx my b">epidemiology</code>模型中的每个<code class="fe mv mw mx my b">location_key</code>对应于<code class="fe mv mw mx my b">index</code>表中的一个<code class="fe mv mw mx my b">location_key</code>。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/d677920abf2dc114d75caf73d38afa86.png" data-original-src="https://miro.medium.com/v2/resize:fit:852/format:webp/1*2dNLhtpNymuPD5hvdq2z7A.png"/></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk translated">定义参照完整性测试(按作者)</figcaption></figure><p id="2fe9" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">对于可接受值测试，我测试了<code class="fe mv mw mx my b">location_key</code>只有预定义范围内的指定值。请注意，我还将严重性级别配置为<code class="fe mv mw mx my b">WARN</code>，这意味着它将显示一个警告，而不是一个错误异常，并提供更多详细信息。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/ddb426ebd2917a00e76c3c3883f8daa6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1308/format:webp/1*6Si66oTj_u_cgPCXS9fleA.png"/></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk translated">定义可接受值测试(作者)</figcaption></figure><p id="b022" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">在上面的例子中，对于定义的可接受值，将测试任何与国家名称不匹配的记录，测试将在测试运行期间给出一个<code class="fe mv mw mx my b">WARN</code>，如下所示 244 条记录不匹配可接受值测试标准:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi nd"><img src="../Images/041042ee1581135df8024b6ce3014d97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SApV1Ra8tRe1S_9-DgS8qQ.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk translated">用消息警告测试结果(按作者)</figcaption></figure><p id="247b" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><strong class="kv io">自定义测试</strong></p><p id="754b" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">自定义测试在您的 dbt 项目的<code class="fe mv mw mx my b">tests</code>文件夹中定义，它们是使用 dbt 的 SQL SELECT 语句和额外的 Jinja 模板编写的测试断言。定制测试有利于测试业务转换，并确保定性数据，例如，下面的定制测试示例:</p><pre class="kd ke kf kg gt ne my nf ng aw nh bi"><span id="4eeb" class="ni nj in my b gy nk nl l nm nn">-- Test assertion for cumulative confirmed cases greater than 0.</span><span id="34f2" class="ni nj in my b gy no nl l nm nn">select</span><span id="df8f" class="ni nj in my b gy no nl l nm nn">    location_key,</span><span id="efe7" class="ni nj in my b gy no nl l nm nn">    date,</span><span id="173d" class="ni nj in my b gy no nl l nm nn">    sum(cumulative_confirmed) as total_cumulative_confirmed</span><span id="0aaa" class="ni nj in my b gy no nl l nm nn">from <br/>    {{ source('raw_covid19', 'stg_epidemiology' )}}</span><span id="c727" class="ni nj in my b gy no nl l nm nn">group by</span><span id="6797" class="ni nj in my b gy no nl l nm nn">    location_key,</span><span id="f2ed" class="ni nj in my b gy no nl l nm nn">    date</span><span id="73e9" class="ni nj in my b gy no nl l nm nn">having not(total_cumulative_confirmed &gt;= 0)</span></pre><p id="a586" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">在下面的 dbt 沿袭图中，定义的测试包含在它的依赖项中，当执行不带选项的测试或运行命令时，还会执行自定义测试。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi np"><img src="../Images/1910baeb5c5842f470e1cb8d6f705b66.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NhkBl20634Qu8AAO5qxQgQ.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk translated">dbt 谱系图示例(按作者)</figcaption></figure><p id="58c6" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><strong class="kv io">结论</strong></p><p id="f7b0" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">这就结束了 dbt 测试的初学者指南，当然 dbt 测试还可以做更多的事情，例如创建通用宏测试、快照测试和实现测试包。在 dbt 中使用内置或定制测试简单明了，它有助于提高可观察性，并且应该成为任何 dbt 项目中的标准。总的来说，测试是一个很好的实践，而且越早包含在工作流程中越好。编写高质量的测试将有助于您的数据更加可靠，并增加可观察性。更不用说，您可以更早地发现数据质量问题，防止报告不准确。因此，使用 dbt，在早期开发测试，并随着时间的推移更新它们。</p><p id="bb7b" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><strong class="kv io">参考文献</strong></p><ul class=""><li id="ffd1" class="lp lq in kv b kw kx kz la lc lr lg ls lk lt lo lu lv lw lx bi translated"><a class="ae ks" href="https://docs.getdbt.com/docs/building-a-dbt-project/tests" rel="noopener ugc nofollow" target="_blank">测试 dbt 文件</a></li><li id="dd40" class="lp lq in kv b kw ly kz lz lc ma lg mb lk mc lo lu lv lw lx bi translated"><a class="ae ks" href="https://docs.getdbt.com/reference/resource-configs/severity" rel="noopener ugc nofollow" target="_blank">测试的 dbt 严重级别配置</a></li><li id="cc42" class="lp lq in kv b kw ly kz lz lc ma lg mb lk mc lo lu lv lw lx bi translated"><a class="ae ks" href="https://www.getdbt.com/blog/data-testing-why-you-need-it-and-how-to-get-started/" rel="noopener ugc nofollow" target="_blank">数据测试入门</a></li><li id="3045" class="lp lq in kv b kw ly kz lz lc ma lg mb lk mc lo lu lv lw lx bi translated"><a class="ae ks" href="https://docs.airbyte.com/operator-guides/transformation-and-normalization/transformations-with-dbt" rel="noopener ugc nofollow" target="_blank">气生体转化与规格化教程</a></li><li id="c7c1" class="lp lq in kv b kw ly kz lz lc ma lg mb lk mc lo lu lv lw lx bi translated"><a class="ae ks" href="https://datacoves.com/post/an-overview-of-testing-options-in-dbt-data-build-tool" rel="noopener ugc nofollow" target="_blank">dbt 测试选项的 datacove 概述</a></li></ul><p id="dea4" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><strong class="kv io"> <em class="nq">感谢</em> </strong> <em class="nq">的阅读！如果你想和我联系，请随时通过 adebayo.adejare@gmail.com 联系我或者我的</em> <a class="ae ks" href="https://www.linkedin.com/in/adebayoadejare/" rel="noopener ugc nofollow" target="_blank"> <em class="nq"> LinkedIn 个人资料</em> </a> <em class="nq">。也可以在我的</em><a class="ae ks" href="https://github.com/BayoAdejare" rel="noopener ugc nofollow" target="_blank"><em class="nq">Github</em></a><em class="nq">中查看部分代码。</em></p></div></div>    
</body>
</html>