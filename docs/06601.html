<html>
<head>
<title>Simple SMS Api and Collector using FastAPI, Spring Boot, Kafka and MongoDB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用FastAPI、Spring Boot、Kafka和MongoDB的简单SMS Api和收集器</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/simple-sms-api-and-collector-using-fastapi-spring-boot-kafka-and-mongodb-94895feb08c0?source=collection_archive---------2-----------------------#2022-01-19">https://blog.devgenius.io/simple-sms-api-and-collector-using-fastapi-spring-boot-kafka-and-mongodb-94895feb08c0?source=collection_archive---------2-----------------------#2022-01-19</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="ef37" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">本文只是开发各种复杂集成系统的概念证明，通过Apache Kafka的支持，您可以用任何编程语言实现这些系统。</p><p id="8439" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">使用SMPP协议直接开发与SMSC集成的SMS API有点复杂。然而，我们可以通过提供一个单独的关注层来降低系统的复杂性，我们可以拯救和分离我们的服务。短信的发送和触发大多是异步的，所以使用Kafka作为消息代理非常适合这种情况。有一个java <a class="ae ki" href="http://smppapi.sourceforge.net/documentation/user-guide/" rel="noopener ugc nofollow" target="_blank">库</a>支持这个任务，我们可以利用它。</p><p id="10bf" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">短信</strong>系统的重要部分有<strong class="jm io"> CP、MT、MO </strong>并且可以DN。</p><ul class=""><li id="1f4e" class="kj kk in jm b jn jo jr js jv kl jz km kd kn kh ko kp kq kr bi translated">CP:内容提供商，即使用该服务的参与者，主要是向他们的客户发送短信，这些短信可以是免费的、收费的或用于活动目的。他们还需要在用户主要通过短代码回复短信时收到通知。</li><li id="3549" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated">移动终端，指的是发送到手机的信息。它由CP生成，向用户发送SMS。</li><li id="1b04" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated">MO:移动始发，指的是从移动手机发送的消息。它是由用户回复给特定发件人或短代码的SMS时生成的。</li><li id="4d3a" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated">DN:交付通知，主要触发返回给CP</li></ul><p id="570e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">以下是系统的概要设计</strong>:</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div class="gh gi kx"><img src="../Images/24467f40f50aef38101e43708959d2f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1186/0*wmA2MbVb89z2Ur8k"/></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">系统HLD</figcaption></figure><h1 id="c87b" class="lj lk in bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">系统组件:</h1><ul class=""><li id="2b4d" class="kj kk in jm b jn mh jr mi jv mj jz mk kd ml kh ko kp kq kr bi translated">API: <a class="ae ki" href="https://fastapi.tiangolo.com" rel="noopener ugc nofollow" target="_blank"> <strong class="jm io"> FastAPI </strong> </a>作为前台web服务允许CP触发rest格式的短信API</li><li id="af33" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated">收集器:<a class="ae ki" href="https://spring.io/projects/spring-boot" rel="noopener ugc nofollow" target="_blank"> <strong class="jm io"> Spring Boot </strong> </a>控制台应用程序，作为守护程序服务不断从Apache Kafka获取数据，使用SMPP协议转发到SMSC/模拟器，并从SMSC/模拟器接收MO数据</li><li id="26e5" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated"><a class="ae ki" href="https://www.mongodb.com" rel="noopener ugc nofollow" target="_blank"> <strong class="jm io"> MongoDB </strong> </a>:存储日志和配置数据的数据库</li><li id="5531" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated"><a class="ae ki" href="https://kafka.apache.org" rel="noopener ugc nofollow" target="_blank"> <strong class="jm io">阿帕奇卡夫卡</strong> </a>:消息代理，作为队列向消费者转发消息，并接收来自生产者的消息</li><li id="e7bb" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated"><strong class="jm io"> SMPP模拟器</strong>:(感谢<a class="ae ki" href="http://www.seleniumsoftware.com" rel="noopener ugc nofollow" target="_blank"> <strong class="jm io">硒</strong> </a>)在我们的电脑上充当SMSC，这只是为了确保我们可以开发一个不需要连接到真正的SMSC的系统</li><li id="9d51" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated"><strong class="jm io">样本处理器</strong>:提供一个样本处理器web服务来模拟CP服务。</li><li id="2f5b" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated"><a class="ae ki" href="https://www.docker.com" rel="noopener ugc nofollow" target="_blank"> <strong class="jm io"> Docker </strong> </a>:使用docker-compose制作并在我们的电脑上轻松运行</li></ul><h1 id="32ad" class="lj lk in bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">顺序图</h1><p id="3d2c" class="pw-post-body-paragraph jk jl in jm b jn mh jp jq jr mi jt ju jv mm jx jy jz mn kb kc kd mo kf kg kh ig bi translated">作为一个系统设计过程，如果我们有序列图就好了，这样我们可以了解系统流程的全貌。</p><p id="4435" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">重要的顺序图由两部分组成，MT流程和MO流程:</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi mp"><img src="../Images/1bc0314314ebf2f207deca2f6cc86f32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*e8-ldgcDtogSwCrw"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">MT流量</figcaption></figure><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi mu"><img src="../Images/127af3bf185d85fdeda2a120b90bd2ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*c_yc-PLjT9eKJxGp"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">钼流量</figcaption></figure><p id="b479" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">数据存储结构:</strong></p><p id="cf7e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">由于该系统主要存储不包含某些事务的日志数据，NoSQL最适合该系统，所以我使用<strong class="jm io"> MongoDB </strong>。</p><p id="1c81" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">收藏:</p><ul class=""><li id="49d9" class="kj kk in jm b jn jo jr js jv kl jz km kd kn kh ko kp kq kr bi translated"><strong class="jm io"> content_provider </strong>:存储内容提供商信息，如:用户名、密码、secreteKey、moUrl、dnUrl</li><li id="6030" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated"><strong class="jm io"> mt_logs </strong>:存储mt日志信息，如:内容、src、目的地、请求日期等</li><li id="e80f" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated"><strong class="jm io"> dn_logs </strong>:存储dn日志信息，如:编号、发起者、内容、签名、回调内容、回调状态代码</li><li id="f61b" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated"><strong class="jm io"> mo_logs </strong>:存储mo日志信息，如:src、dest、content、requestDate、callBackResult、callBackStatusCode</li></ul><h1 id="d47e" class="lj lk in bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated"><strong class="ak">实现:</strong></h1><h2 id="fc16" class="mv lk in bd ll mw mx dn lp my mz dp lt jv na nb lx jz nc nd mb kd ne nf mf ng bi translated">FastAPI: </h2><p id="e443" class="pw-post-body-paragraph jk jl in jm b jn mh jp jq jr mi jt ju jv mm jx jy jz mn kb kc kd mo kf kg kh ig bi translated">由于FastAPI是适用于微服务的高性能API，所以它非常适合本系统。我将其分为以下项目结构:</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/7f022c8c52f90824417c6ddf25f8de44.png" data-original-src="https://miro.medium.com/v2/resize:fit:618/0*FN4xn3hkSnBWBxCv"/></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">fastapi项目文件</figcaption></figure><p id="7526" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">config.py : <strong class="jm io">定义一些配置信息，如mogodb连接、kafka和主题</strong></p><figure class="ky kz la lb gt lc"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="0027" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">model.py:文件定义了模型信息，如内容提供者、消息提交、MO等。</p><figure class="ky kz la lb gt lc"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="aad7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">main.py: API逻辑和一些支持功能，如身份验证、创建回调签名和web api消费。</p><figure class="ky kz la lb gt lc"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="1917" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">Dockerfile:用于在docker ( compose)中运行这个项目</p><figure class="ky kz la lb gt lc"><div class="bz fp l di"><div class="ni nj l"/></div></figure><h2 id="600b" class="mv lk in bd ll mw mx dn lp my mz dp lt jv na nb lx jz nc nd mb kd ne nf mf ng bi translated">收集器控制台应用程序:</h2><p id="af59" class="pw-post-body-paragraph jk jl in jm b jn mh jp jq jr mi jt ju jv mm jx jy jz mn kb kc kd mo kf kg kh ig bi translated">Springboot是事实上成熟的企业Java框架，它提供了丰富的特性，包括IoC和DI，允许开发人员开发灵活的、可维护的企业级项目。</p><p id="eb28" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">它由以下几部分组成:</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/4e385bc3e522b582893397e806eb5f4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:572/format:webp/1*HqowLGwqkG0ybhi5PpghsA.png"/></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">Spring Boot项目结构</figcaption></figure><p id="4872" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">配置</strong>:基于<strong class="jm io"> application.properties </strong>文件的kafka配置</p><figure class="ky kz la lb gt lc"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="6b34" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">数据</strong>:用于kafka和采集器之间的异步数据</p><figure class="ky kz la lb gt lc"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="5f0e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> queue </strong>:抽象类BaseAsyncQueue为异步内存队列创建抽象，它将允许我们创建一个具体的类来绑定到SMPP，如发送器、接收器、收发器。控制台应用程序基于这个库<a class="ae ki" href="http://smppapi.sourceforge.net" rel="noopener ugc nofollow" target="_blank"><strong class="jm io">http://smppapi.sourceforge.net</strong></a>与SMPP模拟器集成</p><figure class="ky kz la lb gt lc"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="5e67" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> SmsService </strong>:处理核心逻辑并监听Kafka监听器的spring boot服务</p><p id="4129" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">Docker文件:<a class="ae ki" href="https://gist.github.com/engleangs/b4c0222fbd040a63e31ebc0f8a8a8b00" rel="noopener ugc nofollow" target="_blank">https://gist . github . com/engleangs/b4c 0222 FBD 040 a 63 e 31 ebc 0 f 8 A8 A8 b 00</a></p><p id="b103" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> SMPP模拟器</strong></p><p id="a8bb" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">http://www.seleniumsoftware.com<a class="ae ki" href="http://www.seleniumsoftware.com" rel="noopener ugc nofollow" target="_blank">提供的模拟器</a>为了轻松启动模拟器，我们可以使用下面的docker文件:<a class="ae ki" href="https://gist.github.com/engleangs/c4311e9322cbf78719bc50480a976989" rel="noopener ugc nofollow" target="_blank">https://gist . github . com/engleangs/c 4311 e 9322 CBF 78719 BC 50480 a 976989</a></p><p id="f20b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">完整的项目可以在这里找到<a class="ae ki" href="https://github.com/engleangs/sms-api-and-collector" rel="noopener ugc nofollow" target="_blank"><strong class="jm io">https://github.com/engleangs/sms-api-and-collector</strong></a>。要启动并运行它，只需确保在将该项目克隆到计算机后，安装docker并键入docker命令"<strong class="jm io"> docker compose up -d </strong>"。</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/2c064a044c0050df34e3a3af5a30cc54.png" data-original-src="https://miro.medium.com/v2/resize:fit:1178/format:webp/1*MRGa2yR43VPwm29vLaFk1Q.png"/></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">Docker图像</figcaption></figure><p id="6d9c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">启动和运行结果，需要首先创建内容提供商，如下存储在数据库中:</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi nm"><img src="../Images/768c0c99faac22a265b559c01e8399d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-ahODE-q29b1Yh2x81x_CA.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">Mongodb中的数据</figcaption></figure><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi nn"><img src="../Images/7d688642b7fc49acbad9cab5227adff7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kfTjffMn9iZne6qyn6d3bg.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">在本地计算机上访问FastAPi文档</figcaption></figure><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi no"><img src="../Images/c38526496c7f66717ebf871d614cd6a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AFn3h7Qrl_1K5y-xIYYcog.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">MT API文档</figcaption></figure><p id="adca" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">快速API日志</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi np"><img src="../Images/71bf7ff5de774c762acdab9973eb1cba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nZ70phii9_7IQFIa_PbC9Q.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">通过Docker日志记录MT、DN和MO日志</figcaption></figure><p id="3f43" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">SMPP模拟测井</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi nq"><img src="../Images/90524b0d64d2032d42537f8ef32051e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s1xkhBf_N_N4yi1W8am7OQ.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">通过Docker日志查看日志</figcaption></figure><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi nr"><img src="../Images/7be6f4e8275961bdc8f94effa3b23c03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F7z-HSzkgsvGrFWWJaAnbQ.png"/></div></div><figcaption class="lf lg gj gh gi lh li bd b be z dk translated">Spring Boot SMPP收集日志</figcaption></figure><p id="bbe3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">希望你能从这篇基础文章中学到一些东西。</p><p id="29d8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">对于这个已初始化的项目，还需要添加更多功能(<strong class="jm io"> todo </strong>):</p><p id="7e41" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> API : </strong></p><ul class=""><li id="24da" class="kj kk in jm b jn jo jr js jv kl jz km kd kn kh ko kp kq kr bi translated">认证验证:添加更安全和复杂的安全，如JWT或Sha25签名验证认证从CP</li><li id="fdbe" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated">为每个APi调用和其他重要事件添加日志文件或数据库日志</li><li id="964d" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated">将api触发与FastAPI和重试机制分开</li><li id="094f" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated">使用RateLimit或Redis的TPS控制</li></ul><p id="28bc" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> SMPP采集器控制台应用:</strong></p><ul class=""><li id="84d2" class="kj kk in jm b jn jo jr js jv kl jz km kd kn kh ko kp kq kr bi translated">为短信集成添加更多语言支持</li><li id="17f5" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated">添加基于短代码的路由和过滤属于特定</li><li id="c562" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated">基于来自SMPP的错误代码添加更详细的错误消息</li></ul><blockquote class="ns nt nu"><p id="7254" class="jk jl nv jm b jn jo jp jq jr js jt ju nw jw jx jy nx ka kb kc ny ke kf kg kh ig bi translated"><a class="ae ki" href="https://www.openmarket.com/docs/Content/apis/v3smpp/smpp-error-codes.htm" rel="noopener ugc nofollow" target="_blank">https://www . open market . com/docs/Content/APIs/v3 smpp/smpp-error-codes . htm</a></p></blockquote></div></div>    
</body>
</html>