<html>
<head>
<title>Spring WebFlux Security OTP Email with MongoDB and Flutter 1/2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Spring WebFlux 安全 OTP 电子邮件与 MongoDB 和 Flutter 1/2</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/spring-webflux-security-otp-email-with-mongodb-and-flutter-1-2-f73e1d94ec7a?source=collection_archive---------1-----------------------#2022-06-06">https://blog.devgenius.io/spring-webflux-security-otp-email-with-mongodb-and-flutter-1-2-f73e1d94ec7a?source=collection_archive---------1-----------------------#2022-06-06</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="469e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在这个故事中，我们将看到如何在一个反应式 Spring Webflux 中使用 MongoDB 和 Flutter 来集成 Spring 安全性。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/7ad4cea161ad1c5fb75617c2ab0af083.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jQB_Q0dMlP2Y4FM1vMkGiQ.png"/></div></div></figure><h1 id="2655" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">先决条件</h1><p id="5fa2" class="pw-post-body-paragraph jk jl in jm b jn ls jp jq jr lt jt ju jv lu jx jy jz lv kb kc kd lw kf kg kh ig bi translated">这是遵循第 1 部分的所有先决条件的列表:</p><ul class=""><li id="82c0" class="lx ly in jm b jn jo jr js jv lz jz ma kd mb kh mc md me mf bi translated">Java 17</li><li id="178c" class="lx ly in jm b jn mg jr mh jv mi jz mj kd mk kh mc md me mf bi translated">Spring Boot /入门网站流量 2.6.7</li><li id="23d4" class="lx ly in jm b jn mg jr mh jv mi jz mj kd mk kh mc md me mf bi translated"><a class="ae ml" href="https://mvnrepository.com/artifact/org.projectlombok/lombok" rel="noopener ugc nofollow" target="_blank">龙目岛</a> 1.18</li><li id="6bb9" class="lx ly in jm b jn mg jr mh jv mi jz mj kd mk kh mc md me mf bi translated">Maven 3.6.3</li><li id="7b8d" class="lx ly in jm b jn mg jr mh jv mi jz mj kd mk kh mc md me mf bi translated">邮递员</li><li id="0d26" class="lx ly in jm b jn mg jr mh jv mi jz mj kd mk kh mc md me mf bi translated">Mongo 4.4。</li></ul><h1 id="eda4" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">概观</h1><h2 id="2a97" class="mm kv in bd kw mn mo dn la mp mq dp le jv mr ms li jz mt mu lm kd mv mw lq mx bi translated">什么是一次性密码(OTP)？</h2><p id="ffcf" class="pw-post-body-paragraph jk jl in jm b jn ls jp jq jr lt jt ju jv lu jx jy jz lv kb kc kd lw kf kg kh ig bi translated"><strong class="jm io">一次性密码</strong> ( <strong class="jm io"> OTP </strong>)，也称为<strong class="jm io">一次性 PIN 码</strong>、<strong class="jm io">一次性授权码</strong> ( <strong class="jm io"> OTAC </strong>)或<strong class="jm io">动态密码</strong>，是在计算机系统或其他数字设备上仅对一次登录会话或交易有效的密码。—<a class="ae ml" href="https://en.wikipedia.org/wiki/One-time_password" rel="noopener ugc nofollow" target="_blank">https://en.wikipedia.org/wiki/One-time_password</a></p><h2 id="1674" class="mm kv in bd kw mn mo dn la mp mq dp le jv mr ms li jz mt mu lm kd mv mw lq mx bi translated">使用 OTP 有什么好处？</h2><p id="966c" class="pw-post-body-paragraph jk jl in jm b jn ls jp jq jr lt jt ju jv lu jx jy jz lv kb kc kd lw kf kg kh ig bi translated">与静态密码相比，OTPs 最重要的优点是它们不易受到重放攻击。这意味着试图记录已经用于登录服务或进行交易的 OTP 的潜在入侵者将不能使用它，因为它将不再有效。</p><h1 id="8b40" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">入门指南</h1><p id="4758" class="pw-post-body-paragraph jk jl in jm b jn ls jp jq jr lt jt ju jv lu jx jy jz lv kb kc kd lw kf kg kh ig bi translated">我们将使用具有 Spring WebFlux 安全性的 JSON Web Token (JWT)提供者来实现基于令牌的认证和授权。</p><p id="e9f9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">下图描述了身份验证流程:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi my"><img src="../Images/8f2d4cd3853fad4c6749a8be13670fb6.png" data-original-src="https://miro.medium.com/v2/resize:fit:984/format:webp/1*RIEwFSKPsCAzvu7kkwg6qw.png"/></div></figure><p id="6320" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们将从从<a class="ae ml" href="http://start.spring.io/" rel="noopener ugc nofollow" target="_blank"> start.spring.io </a>创建一个简单的 Spring Boot 项目开始，它具有以下依赖项:<em class="mz"> Spring Reactive Web、Spring Security、Spring Data Reactive MongoDB NoSQL、Java Mail Sender、百里香、Lombok 和验证</em>。</p><p id="5b7a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">以下是 maven 项目的依赖关系:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="da5d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">首先，让我们创建一个实现 UserDetails 的用户 POJO 类。我们使用注释<a class="ae ml" href="https://docs.spring.io/spring-data/data-mongodb/docs/current/api/org/springframework/data/mongodb/core/mapping/Document.html" rel="noopener ugc nofollow" target="_blank"> @Document </a>来设置模型将使用的集合名称。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="d098" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们的用户类包含管理 OTP 代码和用户权限的嵌入式模型<code class="fe nc nd ne nf b">OtpRequest </code> et <code class="fe nc nd ne nf b">Role </code>。</p><h1 id="5bcf" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">实现 ReactiveUserDetailsService</h1><p id="739f" class="pw-post-body-paragraph jk jl in jm b jn ls jp jq jr lt jt ju jv lu jx jy jz lv kb kc kd lw kf kg kh ig bi translated"><code class="fe nc nd ne nf b">ReactiveUserDetailsService</code>定义了一种方法，Spring Security 使用该方法通过返回<code class="fe nc nd ne nf b">Mono&lt;UserDetails&gt;.</code>的用户名来检索用户</p><p id="b42c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们将创建一个名为 UserDetailsService 的类，它覆盖 ReactiveUserDetailsService 接口的方法<code class="fe nc nd ne nf b">findByUsername()</code>。<br/>在这个方法中，我们使用 UserRepository 检索用户对象，如果它存在的话。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="na nb l"/></div></figure><h1 id="b252" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">配置 Spring 安全性</h1><p id="eb0a" class="pw-post-body-paragraph jk jl in jm b jn ls jp jq jr lt jt ju jv lu jx jy jz lv kb kc kd lw kf kg kh ig bi translated">在<em class="mz">配置</em>包中，创建将管理所有安全方面的<code class="fe nc nd ne nf b">SecurityConfiguration </code>类。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="889d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我来解释一下上面的代码。</p><p id="191a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">–<code class="fe nc nd ne nf b">@EnableWebFluxSecurity</code>允许 Spring Security 中的 WebFlux 支持。</p><p id="1b37" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">–<code class="fe nc nd ne nf b">@EnableReactiveMethodSecurity</code>允许在反应式应用程序中提供方法安全性支持，然后使用方法级注释，比如@PreAuthorize("isAuthenticated()")</p><p id="4350" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">–<code class="fe nc nd ne nf b">passwordEncoder()</code>bean 编码密码的方法</p><p id="5450" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">–<code class="fe nc nd ne nf b">reactiveauthenticationManager()</code>bean 方法，使用 ReactiveUserDetailsService 来验证所提供的用户名和密码。</p><p id="73c2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">–<code class="fe nc nd ne nf b">springSecurityFilterChain(ServerHttpSecurity http) </code>以 ServerHttpSecurity 为参数的 bean 方法。ServerHttpSecurity 类似于 Spring Security 的 HttpSecurity，只是针对 WebFlux。它允许为特定的 HTTP 请求配置基于 web 的安全性。</p><h1 id="6d63" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">WebFlux 处理器和路由器功能</h1><p id="6792" class="pw-post-body-paragraph jk jl in jm b jn ls jp jq jr lt jt ju jv lu jx jy jz lv kb kc kd lw kf kg kh ig bi translated">现在，让我们实现路由器和管理器功能。首先，我们将创建包含<code class="fe nc nd ne nf b">login(), register(), otpCheckCode(), otpResendCode()</code>方法的 AccountHandler 类。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="bc96" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><code class="fe nc nd ne nf b">handle</code>函数方法接受<code class="fe nc nd ne nf b">ServerRequest</code>并返回<code class="fe nc nd ne nf b">Mono&lt;ServerResponse&gt;</code>。</p><p id="f285" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">传入的请求被路由到一个带有<code class="fe nc nd ne nf b">RouterFunction.</code>的处理函数</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="na nb l"/></div></figure><h1 id="e3ce" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">运行和测试</h1><p id="6bf7" class="pw-post-body-paragraph jk jl in jm b jn ls jp jq jr lt jt ju jv lu jx jy jz lv kb kc kd lw kf kg kh ig bi translated">运行应用程序。</p><p id="07e8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在 web 浏览器中打开<a class="ae ml" href="http://localhost:8080/webjars/swagger-ui/index.html#/" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/web jars/swagger-ui/index . html</a>URL。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ng"><img src="../Images/aa2477904c0e066a71c6374053ff14e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lmfiP0t3GsfyaYY9mqJtLA.png"/></div></div><figcaption class="nh ni gj gh gi nj nk bd b be z dk translated">swagger 文档页面</figcaption></figure><p id="9d6c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">到目前为止，它是有效的👌</p><p id="d000" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">第一步是创建一个新用户。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nl"><img src="../Images/37ab99bdf3212279436f74f13ee2ac01.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3dMY00FDIDxmFlZlCZ9vzg.png"/></div></div></figure><p id="2ccf" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们使用之前创建的用户的用户名和密码登录。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nl"><img src="../Images/231269cfce7bcb71d8fa6eec0c073aa9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RdmQBrblE6aN8LsWgEMbRA.png"/></div></div></figure><p id="5e1f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">信息正确后，我们将创建一个包含以下消息的临时令牌(10 分钟):<strong class="jm io"> <em class="mz">部分成功的用户登录—一个 OTP 代码已发送到您的电子邮件地址</em> </strong></p><p id="9ed6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">邮件的内容如下:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nm"><img src="../Images/65ffa0d966d2e9dfc7f7ca354fe86a1a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*exHzU5cSukxSIAM3ivLJsA.png"/></div></div></figure><h1 id="9231" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">继续阅读</h1><p id="823e" class="pw-post-body-paragraph jk jl in jm b jn ls jp jq jr lt jt ju jv lu jx jy jz lv kb kc kd lw kf kg kh ig bi translated">在《T21》第二部中，我们用一个使用 Flutter 和 Dart 的移动应用程序实现了整个过程。</p><p id="8525" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">完整的后端源代码可以在我的<a class="ae ml" href="https://github.com/anicetkeric/webflux-otp/tree/main/spring-security-webflux-otp" rel="noopener ugc nofollow" target="_blank"> GitHub 仓库中找到。</a></p><p id="df1b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果你喜欢这篇文章，请给它一些掌声支持。</p><p id="b2cd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">快乐编码🙂。</p><h1 id="3cdd" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">参考</h1><ul class=""><li id="12ea" class="lx ly in jm b jn ls jr lt jv nn jz no kd np kh mc md me mf bi translated">http://nilhcem.com/FakeSMTP/<a class="ae ml" href="http://nilhcem.com/FakeSMTP/" rel="noopener ugc nofollow" target="_blank"/></li><li id="4168" class="lx ly in jm b jn mg jr mh jv mi jz mj kd mk kh mc md me mf bi translated">【https://www.viralpatel.net/java-create-validate-jwt-token/ T4】</li><li id="a5db" class="lx ly in jm b jn mg jr mh jv mi jz mj kd mk kh mc md me mf bi translated"><a class="ae ml" href="https://docs.spring.io/spring-security/site/docs/5.2.0.RELEASE/reference/html/jc-webflux.html" rel="noopener ugc nofollow" target="_blank">https://docs . spring . io/spring-security/site/docs/5 . 2 . 0 . release/reference/html/JC-web flux . html</a></li></ul></div></div>    
</body>
</html>