<html>
<head>
<title>Apache ShardingSphere Enterprise Applications: Zhuanzhuan’s Transaction System with 100s of Millions of Records</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Apache ShardingSphere 企业应用:拥有数亿条记录的转转交易系统</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/apache-shardingsphereenterprise-applications-zhuanzhuans-transaction-system-with-100s-of-6ade71faa9e6?source=collection_archive---------8-----------------------#2022-04-29">https://blog.devgenius.io/apache-shardingsphereenterprise-applications-zhuanzhuans-transaction-system-with-100s-of-6ade71faa9e6?source=collection_archive---------8-----------------------#2022-04-29</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><h1 id="c760" class="jm jn in bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">背景和挑战</h1><p id="91b7" class="pw-post-body-paragraph kk kl in km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ig bi translated"><a class="ae li" href="https://www.zhuanzhuan.com/index.html" rel="noopener ugc nofollow" target="_blank">转转</a>是一个允许 it 用户出售二手物品的互联网平台——有点像东方的易贝。它的业务一直在蓬勃发展，随之而来的是订购系统开始面临越来越多的性能挑战。订单数据库是系统的基石，其性能不容小觑。</p><p id="d401" class="pw-post-body-paragraph kk kl in km b kn lj kp kq kr lk kt ku kv ll kx ky kz lm lb lc ld ln lf lg lh ig bi translated"><strong class="km io"> <em class="lo">挑战:</em> </strong></p><ul class=""><li id="db9a" class="lp lq in km b kn lj kr lk kv lr kz ls ld lt lh lu lv lw lx bi translated">在促销和特殊折扣期间，数据库的负担非常沉重，每秒数万个单数据库查询(qps)占用了大量数据库资源，并导致写入性能显著下降。</li><li id="2356" class="lp lq in km b kn ly kr lz kv ma kz mb ld mc lh lu lv lw lx bi translated">数据压力增大，单个数据库包含几个大表，数据上亿，挑战服务器的容量极限。</li><li id="b6c5" class="lp lq in km b kn ly kr lz kv ma kz mb ld mc lh lu lv lw lx bi translated">数据量巨大，数据备份和恢复需要很长时间，在极端情况下会带来数据丢失的高风险。</li></ul><h1 id="5d42" class="jm jn in bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">为什么是 ShardingSphere？</h1><p id="dded" class="pw-post-body-paragraph kk kl in km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ig bi translated">一开始，转转的团队采取了调整措施来缓解数据库压力。示例包括:</p><ul class=""><li id="eb04" class="lp lq in km b kn lj kr lk kv lr kz ls ld lt lh lu lv lw lx bi translated"><strong class="km io"> <em class="lo">优化重大交易，减少交易，甚至消除交易</em> </strong></li></ul><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi md"><img src="../Images/a3e6e5cf55f9f60fd9f81ac3d44e4462.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4ngNHZSnNtyyf9XS"/></div></div></figure><p id="1106" class="pw-post-body-paragraph kk kl in km b kn lj kp kq kr lk kt ku kv ll kx ky kz lm lb lc ld ln lf lg lh ig bi translated">我们调整了原始的事务顺序，将核心步骤表生成放在最后，并将事务只保存在 order 主数据库中。当主表的操作异常时，允许对其他与订单相关的表进行脏读。</p><ul class=""><li id="8e37" class="lp lq in km b kn lj kr lk kv lr kz ls ld lt lh lu lv lw lx bi translated"><strong class="km io"> <em class="lo">订单数据缓存</em> </strong></li></ul><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi mp"><img src="../Images/18cbaf42b77c80ab40bb9dd4ad8b1a9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*c_Ohy6DGe_LvqzoB"/></div></div></figure><p id="05a4" class="pw-post-body-paragraph kk kl in km b kn lj kp kq kr lk kt ku kv ll kx ky kz lm lb lc ld ln lf lg lh ig bi translated">数据一致性是缓存中最棘手的部分。由于订单数据涉及结算和佣金，非实时和不一致的数据会导致严重的事故。</p><p id="9453" class="pw-post-body-paragraph kk kl in km b kn lj kp kq kr lk kt ku kv ll kx ky kz lm lb lc ld ln lf lg lh ig bi translated">严格保持缓存数据的一致性会使编码变得复杂，降低系统的并发性。因此，我们在缓存计划上做了一些妥协:</p><ol class=""><li id="2697" class="lp lq in km b kn lj kr lk kv lr kz ls ld lt lh mq lv lw lx bi translated">缓存失败时允许直接查询。</li><li id="7ada" class="lp lq in km b kn ly kr lz kv ma kz mb ld mc lh mq lv lw lx bi translated">添加版本序列号，查询最新版本的数据，保证数据的实时性。</li><li id="0e63" class="lp lq in km b kn ly kr lz kv ma kz mb ld mc lh mq lv lw lx bi translated">通过<a class="ae li" href="https://www.elastic.co" rel="noopener ugc nofollow" target="_blank"> Elasticsearch (ES) </a>和主次分离进行复杂查询，对于一些大表，我们采用了冷热数据分离。</li></ol><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi mr"><img src="../Images/a38453512a06f56de45c525e5b12ed3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*P32NcsxTfTki4S5D"/></div></div></figure><p id="df77" class="pw-post-body-paragraph kk kl in km b kn lj kp kq kr lk kt ku kv ll kx ky kz lm lb lc ld ln lf lg lh ig bi translated">通过这些优化，减轻了数据库压力。然而，在高并发场景下，比如打折季，这看起来仍然势不可挡。</p><p id="b137" class="pw-post-body-paragraph kk kl in km b kn lj kp kq kr lk kt ku kv ll kx ky kz lm lb lc ld ln lf lg lh ig bi translated">为了从根本上解决订单数据库的性能问题，转转决定在<code class="fe ms mt mu mv b">order</code>数据库上采用数据分片(数据库和表拆分)，这样我们就不用担心未来 3-5 年的订单容量了。</p><p id="72d3" class="pw-post-body-paragraph kk kl in km b kn lj kp kq kr lk kt ku kv ll kx ky kz lm lb lc ld ln lf lg lh ig bi translated">壮壮在比较了效率、稳定性、学习成本等因素后，选择了<a class="ae li" href="https://shardingsphere.apache.org" rel="noopener ugc nofollow" target="_blank">分片球</a>。不同的数据分片组件。</p><p id="3df0" class="pw-post-body-paragraph kk kl in km b kn lj kp kq kr lk kt ku kv ll kx ky kz lm lb lc ld ln lf lg lh ig bi translated">ShardingSphere 的优势:</p><ul class=""><li id="6b75" class="lp lq in km b kn lj kr lk kv lr kz ls ld lt lh lu lv lw lx bi translated">它提供了标准化的数据分片、分布式事务和数据库治理，适用于多种情况，如 Java 同构、异构语言和云原生。</li><li id="7677" class="lp lq in km b kn ly kr lz kv ma kz mb ld mc lh lu lv lw lx bi translated">它具有灵活的分片策略，支持多种分片方法。</li><li id="13b7" class="lp lq in km b kn ly kr lz kv ma kz mb ld mc lh lu lv lw lx bi translated">它很容易与其他组件集成，并且事务入侵程度较低。</li><li id="687d" class="lp lq in km b kn ly kr lz kv ma kz mb ld mc lh lu lv lw lx bi translated">它有大量的文档和活跃的社区。</li></ul><p id="5ad0" class="pw-post-body-paragraph kk kl in km b kn lj kp kq kr lk kt ku kv ll kx ky kz lm lb lc ld ln lf lg lh ig bi translated">ShardingSphere 开创了 Database Plus 的概念，并采用了面向插件的架构，其中所有模块都是相互独立的，允许每个模块单独使用或灵活组合使用。</p><p id="8d43" class="pw-post-body-paragraph kk kl in km b kn lj kp kq kr lk kt ku kv ll kx ky kz lm lb lc ld ln lf lg lh ig bi translated">由<a class="ae li" href="https://shardingsphere.apache.org" rel="noopener ugc nofollow" target="_blank"> JDBC </a>、<a class="ae li" href="https://shardingsphere.apache.org/document/current/en/overview/#shardingsphere-proxy" rel="noopener ugc nofollow" target="_blank">代理</a>和<a class="ae li" href="https://shardingsphere.apache.org/document/current/en/overview/#shardingsphere-sidecartodo" rel="noopener ugc nofollow" target="_blank">边车(规划)</a>三款产品组成，支持独立和混合部署。</p><p id="86e5" class="pw-post-body-paragraph kk kl in km b kn lj kp kq kr lk kt ku kv ll kx ky kz lm lb lc ld ln lf lg lh ig bi translated">以下是三种产品的功能对比:</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi mw"><img src="../Images/ffe286f8851142a1dc8702ddb349faea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*U8zgKweEjTbTzFqr"/></div></div></figure><p id="eb81" class="pw-post-body-paragraph kk kl in km b kn lj kp kq kr lk kt ku kv ll kx ky kz lm lb lc ld ln lf lg lh ig bi translated">通过比较，并考虑到高并发性，我们选择了 sharing sphere-JDBC 作为我们的数据分片中间件。</p><p id="43fa" class="pw-post-body-paragraph kk kl in km b kn lj kp kq kr lk kt ku kv ll kx ky kz lm lb lc ld ln lf lg lh ig bi translated">JDBC 是一个轻量级的 Java 框架，在 JDBC 层提供额外的服务。它通过客户端直接连接数据库，通过 Jar 包提供服务，不需要额外的部署和依赖。它可以被看作是一个增强的 JDBC 驱动程序，完全兼容 JDBC 和其他对象关系映射(ORM)框架。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi mx"><img src="../Images/50ccfd5aae5739cf1a61b9760306ce3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*752PTJqt2mXDghz37TGpiw.png"/></div></div></figure><h1 id="f5e6" class="jm jn in bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">项目实施要点</h1><ul class=""><li id="b33c" class="lp lq in km b kn ko kr ks kv my kz mz ld na lh lu lv lw lx bi translated"><strong class="km io">分片键</strong></li></ul><p id="3854" class="pw-post-body-paragraph kk kl in km b kn lj kp kq kr lk kt ku kv ll kx ky kz lm lb lc ld ln lf lg lh ig bi translated">当前订单 ID 由<code class="fe ms mt mu mv b">timestamp+user identification code+machine code+incremental sequence</code>生成。用户识别码取自买方 ID 的第 9 至 16 位，当用户 ID 生成时，它是一个真随机数，因此适合作为分片密钥。</p><p id="576a" class="pw-post-body-paragraph kk kl in km b kn lj kp kq kr lk kt ku kv ll kx ky kz lm lb lc ld ln lf lg lh ig bi translated">选择用户识别码作为分片密钥有一些优点:</p><ul class=""><li id="c7fb" class="lp lq in km b kn lj kr lk kv lr kz ls ld lt lh lu lv lw lx bi translated">数据可以尽可能均匀地分布到每个数据库和表中。</li><li id="8da6" class="lp lq in km b kn ly kr lz kv ma kz mb ld mc lh lu lv lw lx bi translated">可以通过订单 ID 或用户 ID 快速找到具体的分片位置。</li><li id="cbdb" class="lp lq in km b kn ly kr lz kv ma kz mb ld mc lh lu lv lw lx bi translated">同一买家的数据可以分布到相同的数据库和表中，方便买家信息的综合查询。</li></ul><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi nb"><img src="../Images/c600722b205320626a24888c58e730da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*UACrtZau2EJD2hqz"/></div></div></figure><p id="35c2" class="pw-post-body-paragraph kk kl in km b kn lj kp kq kr lk kt ku kv ll kx ky kz lm lb lc ld ln lf lg lh ig bi translated">分片策略:我们采用 16 个数据库和 16 个表。用户识别码用于拆分数据库，高 4 位用于拆分表。</p><ul class=""><li id="5023" class="lp lq in km b kn lj kr lk kv lr kz ls ld lt lh lu lv lw lx bi translated"><strong class="km io">新旧数据库之间的数据迁移</strong></li></ul><p id="2396" class="pw-post-body-paragraph kk kl in km b kn lj kp kq kr lk kt ku kv ll kx ky kz lm lb lc ld ln lf lg lh ig bi translated">迁移必须在线，不能接受停机迁移，因为在迁移过程中会有新的数据写入。</p><p id="1926" class="pw-post-body-paragraph kk kl in km b kn lj kp kq kr lk kt ku kv ll kx ky kz lm lb lc ld ln lf lg lh ig bi translated">数据应该是完整的，迁移过程应该对客户端不敏感。迁移后，新数据库中的数据应该与旧数据库中的数据一致。</p><p id="a484" class="pw-post-body-paragraph kk kl in km b kn lj kp kq kr lk kt ku kv ll kx ky kz lm lb lc ld ln lf lg lh ig bi translated">迁移应该允许回滚，这样当迁移过程中出现问题时，应该能够回滚到源数据库，而不会影响系统可用性。</p><p id="8dd7" class="pw-post-body-paragraph kk kl in km b kn lj kp kq kr lk kt ku kv ll kx ky kz lm lb lc ld ln lf lg lh ig bi translated">数据迁移步骤如下:双重写入-&gt;迁移历史数据-&gt;验证-&gt;旧数据库离线。</p><h1 id="cbb3" class="jm jn in bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">效果和益处</h1><ul class=""><li id="91fd" class="lp lq in km b kn ko kr ks kv my kz mz ld na lh lu lv lw lx bi translated">解决了单一数据库容量限制的问题。</li><li id="8b7b" class="lp lq in km b kn ly kr lz kv ma kz mb ld mc lh lu lv lw lx bi translated">分片后单个数据库和表的数据量大大减少。单个表的数据量从近亿级降低到几百万级，大大提高了整体性能。</li><li id="d3f8" class="lp lq in km b kn ly kr lz kv ma kz mb ld mc lh lu lv lw lx bi translated">降低了极端情况下因单个数据库和表过大而导致数据丢失的风险，减轻了运维压力。</li></ul><p id="fa30" class="pw-post-body-paragraph kk kl in km b kn lj kp kq kr lk kt ku kv ll kx ky kz lm lb lc ld ln lf lg lh ig bi translated">下面是在两个促销和折扣期间，订单下达服务的接口调用次数和接口消耗时间的比较:</p><p id="f89f" class="pw-post-body-paragraph kk kl in km b kn lj kp kq kr lk kt ku kv ll kx ky kz lm lb lc ld ln lf lg lh ig bi translated"><strong class="km io"> <em class="lo">推广前采用 ShardingSphere </em> </strong></p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi nc"><img src="../Images/234a9356357d87cbaa9cce7ed5920ef6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fP-VGC9Zq4TykK1i"/></div></div></figure><p id="9759" class="pw-post-body-paragraph kk kl in km b kn lj kp kq kr lk kt ku kv ll kx ky kz lm lb lc ld ln lf lg lh ig bi translated"><strong class="km io"> <em class="lo">晋级后采用 ShardingSphere </em> </strong></p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi nd"><img src="../Images/bf89f0be6bbea030a1f48a04be81d3bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ne5lg4hkJvMuJjWs"/></div></div></figure><h1 id="5566" class="jm jn in bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">摘要</h1><p id="d915" class="pw-post-body-paragraph kk kl in km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ig bi translated">ShardingSphere 以其精心设计的架构、高度灵活、可插拔和可扩展的功能简化了数据分片的开发，允许 R&amp;D 团队只关注业务本身，从而实现数据架构的灵活扩展。</p><h1 id="8994" class="jm jn in bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">Apache ShardingSphere 项目链接:</h1><p id="eb27" class="pw-post-body-paragraph kk kl in km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh ig bi translated"><a class="ae li" href="https://github.com/apache/shardingsphere/issues?page=1&amp;q=is%3Aopen+is%3Aissue+label%3A%22project%3A+OpenForce+2022%22" rel="noopener ugc nofollow" target="_blank"> ShardingSphere Github </a></p><p id="9624" class="pw-post-body-paragraph kk kl in km b kn lj kp kq kr lk kt ku kv ll kx ky kz lm lb lc ld ln lf lg lh ig bi translated"><a class="ae li" href="https://twitter.com/ShardingSphere" rel="noopener ugc nofollow" target="_blank"> ShardingSphere Twitter </a></p><p id="f247" class="pw-post-body-paragraph kk kl in km b kn lj kp kq kr lk kt ku kv ll kx ky kz lm lb lc ld ln lf lg lh ig bi translated"><a class="ae li" href="https://join.slack.com/t/apacheshardingsphere/shared_invite/zt-sbdde7ie-SjDqo9~I4rYcR18bq0SYTg" rel="noopener ugc nofollow" target="_blank">切割球松弛度</a></p><p id="d0b2" class="pw-post-body-paragraph kk kl in km b kn lj kp kq kr lk kt ku kv ll kx ky kz lm lb lc ld ln lf lg lh ig bi translated"><a class="ae li" href="https://shardingsphere.apache.org/community/cn/contribute/" rel="noopener ugc nofollow" target="_blank">投稿指南</a></p></div></div>    
</body>
</html>