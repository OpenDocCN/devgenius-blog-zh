<html>
<head>
<title>Versioning REST APIs in .Net 6</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">版本化 REST APIs。网络 6</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/versioning-rest-apis-in-net-6-7b3caeb6f14a?source=collection_archive---------14-----------------------#2022-10-06">https://blog.devgenius.io/versioning-rest-apis-in-net-6-7b3caeb6f14a?source=collection_archive---------14-----------------------#2022-10-06</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/eedb500ceeeaf04c5096216c4e52b73b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Qfy014Kcl0735vkYWx3o5Q.jpeg"/></div></div></figure><p id="48d7" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">API 版本控制是一种实践，用于隔离对 API 所做的可能破坏现有消费者的更改。对 API 的更改是不可避免的，一旦您的 API 脱离生产并被数百个客户端应用程序使用，任何未版本化的突破性更改都可能是破坏性的，需要小心管理。版本控制让你以一种可控的方式做到这一点。</p><p id="83f4" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">对 API 的突破性更改包括以下内容:</p><ul class=""><li id="e46f" class="kt ku in jx b jy jz kc kd kg kv kk kw ko kx ks ky kz la lb bi translated">一个或多个呼叫的响应数据格式的改变</li><li id="4f2c" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">请求或响应类型的变化(例如，将整数变为浮点数)</li><li id="172f" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">删除 API 的任何部分。</li></ul><p id="3210" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">有几种方法可以对 API 进行版本控制。让我们看看最突出的。</p><p id="b899" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这种方法包括指定版本，如 v1、v2 等。在 API 本身的 URL 中。这是 API 版本控制最直接、最容易维护的形式。这也是目前最流行的版本控制方法。以下是一些例子:</p><blockquote class="lh li lj"><p id="fa24" class="jv jw lk jx b jy jz ka kb kc kd ke kf ll kh ki kj lm kl km kn ln kp kq kr ks ig bi translated"><strong class="jx io"><em class="in">YouTube API</em>T3】</strong></p><p id="1550" class="jv jw lk jx b jy jz ka kb kc kd ke kf ll kh ki kj lm kl km kn ln kp kq kr ks ig bi translated">【https://developers.google.com/youtube/v3/docs】文档:<a class="ae lo" href="https://developers.google.com/youtube/v3/docs" rel="noopener ugc nofollow" target="_blank"><em class="in"/></a></p><p id="93e4" class="jv jw lk jx b jy jz ka kb kc kd ke kf ll kh ki kj lm kl km kn ln kp kq kr ks ig bi translated"><strong class="jx io"><em class="in">sales force API</em></strong></p><p id="9ad1" class="jv jw lk jx b jy jz ka kb kc kd ke kf ll kh ki kj lm kl km kn ln kp kq kr ks ig bi translated"><em class="in">文档:</em><a class="ae lo" href="https://developer.salesforce.com/docs/atlas.en-us.api_rest.meta/api_rest/intro_curl.htm" rel="noopener ugc nofollow" target="_blank"><em class="in">https://developer . sales force . com/docs/atlas . en-us . API _ rest . meta/API _ rest/intro _ curl . htm</em></a></p><p id="d5cf" class="jv jw lk jx b jy jz ka kb kc kd ke kf ll kh ki kj lm kl km kn ln kp kq kr ks ig bi translated"><em class="in">举例:</em><a class="ae lo" href="https://MyDomainName.my.salesforce.com/services/data/v56.0/sobjects/Account" rel="noopener ugc nofollow" target="_blank"><em class="in">https://my domain name . my . sales force . com/services/data/v 56.0/s objects/Account</em></a></p></blockquote><p id="aa64" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在这种方法中，API 版本在查询字符串中传递。这方面的一个例子是</p><blockquote class="lh li lj"><p id="b7f6" class="jv jw lk jx b jy jz ka kb kc kd ke kf ll kh ki kj lm kl km kn ln kp kq kr ks ig bi translated"><strong class="jx io"> <em class="in">谷歌地图 API </em> </strong></p><p id="0784" class="jv jw lk jx b jy jz ka kb kc kd ke kf ll kh ki kj lm kl km kn ln kp kq kr ks ig bi translated"><em class="in">文档:</em><a class="ae lo" href="https://developers.google.com/maps/documentation/javascript/versions" rel="noopener ugc nofollow" target="_blank"><em class="in">https://developers . Google . com/maps/Documentation/JavaScript/versions</em></a></p><p id="42b8" class="jv jw lk jx b jy jz ka kb kc kd ke kf ll kh ki kj lm kl km kn ln kp kq kr ks ig bi translated"><em class="in">举例:</em><a class="ae lo" href="https://maps.googleapis.com/maps/api/js?v=3.49&amp;key=YOUR_API_KEY&amp;callback=initMap" rel="noopener ugc nofollow" target="_blank"><em class="in">https://maps.googleapis.com/maps/api/js?v=3.49&amp;KEY = YOUR _ API _ KEY&amp;callback = init map</em></a></p></blockquote><p id="3b96" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">另一种方法是使用日期而不是数字，作为 URI API 的一个版本。这种方法被 Twilio 使用。</p><blockquote class="lh li lj"><p id="cf25" class="jv jw lk jx b jy jz ka kb kc kd ke kf ll kh ki kj lm kl km kn ln kp kq kr ks ig bi translated"><strong class="jx io"> <em class="in">朱里奥</em> </strong></p><p id="f385" class="jv jw lk jx b jy jz ka kb kc kd ke kf ll kh ki kj lm kl km kn ln kp kq kr ks ig bi translated"><em class="in">文献:【https://www.twilio.com/docs/usage/api/address?】</em><a class="ae lo" href="https://www.twilio.com/docs/usage/api/address?code-sample=code-create-an-address&amp;code-language=Node.js&amp;code-sdk-version=3.x" rel="noopener ugc nofollow" target="_blank"><em class="in">code-sample = code-create-an-address&amp;code-language = node . js&amp;code-SDK-version = 3 . x</em></a></p><p id="7f89" class="jv jw lk jx b jy jz ka kb kc kd ke kf ll kh ki kj lm kl km kn ln kp kq kr ks ig bi translated"><em class="in">举例:</em><a class="ae lo" href="https://api.twilio.com/2010-04-01/Accounts/%7bAccountSid%7d/Addresses.json" rel="noopener ugc nofollow" target="_blank"><em class="in">https://API . twilio . com/2010-04-01/Accounts/{ Accounts id }/addresses . JSON</em></a></p></blockquote><p id="ff70" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">最后一种版本控制方法是使用消息头，消费者应该在自定义消息头中传递版本号。头(例如，内容类型)允许您保留版本之间的 URIs(URL 路径保持不变),并且还可以用于返回链接的资源 URL 版本。</p><p id="83af" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">根据<a class="ae lo" href="https://en.wikipedia.org/wiki/HATEOAS" rel="noopener ugc nofollow" target="_blank"> RMM Level 3 REST 原则:超媒体控件</a>，您应该使用 HTTP Accept 和 Content-Type 头来处理数据版本以及描述数据。此外，纯 REST 原则规定，一个资源应该由一个且只有一个端点来标识，这可以通过基于头的版本控制非常有效地实现。</p><blockquote class="lh li lj"><p id="df6c" class="jv jw lk jx b jy jz ka kb kc kd ke kf ll kh ki kj lm kl km kn ln kp kq kr ks ig bi translated"><strong class="jx io"> <em class="in"> GitHub API </em> </strong></p><p id="9a84" class="jv jw lk jx b jy jz ka kb kc kd ke kf ll kh ki kj lm kl km kn ln kp kq kr ks ig bi translated"><em class="in">文档:</em><a class="ae lo" href="https://docs.github.com/en/rest/guides/getting-started-with-the-rest-api#using-headers" rel="noopener ugc nofollow" target="_blank"><em class="in">https://docs . github . com/en/rest/guides/getting-started-with-the-rest-API # using-headers</em></a></p><p id="93da" class="jv jw lk jx b jy jz ka kb kc kd ke kf ll kh ki kj lm kl km kn ln kp kq kr ks ig bi translated"><em class="in">例子:接受:application/JSON；v=2 </em></p></blockquote><p id="fd71" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">本文假设您已经安装了 Visual Studio 2022，并且熟悉创建 ASP.Net Web API 项目。</p><p id="97d8" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们现在将在 ASP.Net web API 中使用请求头方法进行版本控制。安装<strong class="jx io">微软。AspNetCore . MVC . versioning</strong>nu get 包。最简单的方法是通过软件包管理安装</p><pre class="lp lq lr ls gt lt lu lv bn lw lx bi"><span id="6704" class="ly lz in lu b be ma mb l mc md">PM/&gt; Install-Package Microsoft.AspNetCore.Mvc.Versioning</span></pre><p id="0751" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在打开<strong class="jx io"> Program.cs </strong>并添加以下代码行</p><pre class="lp lq lr ls gt lt lu lv bn lw lx bi"><span id="9750" class="ly lz in lu b be ma mb l mc md">builder.Services.AddApiVersioning();</span></pre><p id="466b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在构建并运行项目，并直接访问端点。</p><p id="05fa" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">您将收到以下回复。</p><p id="db12" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><code class="fe me mf mg lu b">"code": "ApiVersionUnspecified", "message": "An API version is required, but was not specified.", "innerError": null</code></p><p id="296a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">您的 API 项目被连接起来以支持版本控制，并在没有版本的情况下访问任何端点时返回 HTTP 400 响应。默认情况下需要追加<strong class="jx io">？api-request=1.0 </strong>到 URL 以使其工作，就像这样:</p><blockquote class="lh li lj"><p id="f1bc" class="jv jw lk jx b jy jz ka kb kc kd ke kf ll kh ki kj lm kl km kn ln kp kq kr ks ig bi translated"><a class="ae lo" href="https://localhost:7146/api/Listings?api-request=1.0" rel="noopener ugc nofollow" target="_blank">T34】https://localhost:7146/API/Listings？api-request=1.0  </a></p></blockquote><p id="5bf2" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">但是，这不是很直观。没有办法通过查看 swagger 文档来确定 API 期望使用这个查询字符串参数的版本。</p><p id="87c0" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">解决这个问题的一种方法是在没有指定版本时设置一个默认版本。下面这段<strong class="jx io"> <em class="lk"> Program.cs </em> </strong>中的代码可以完成这一点:</p><p id="8dd2" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><code class="fe me mf mg lu b">builder.Services.AddApiVersioning(options =&gt; options.AssumeDefaultVersionWhenUnspecified = true; options.DefaultApiVersion = new ApiVersion(1, 0);</code></p><p id="4965" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在，您将能够运行项目并浏览端点，而不会出现错误。</p><p id="d7b2" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">使用请求头进行版本控制</strong></p><p id="f405" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">要使用定制请求头，您可以将 API 的<strong class="jx io"> ApiVersionReader </strong>设置为<strong class="jx io"> HeaderApiVersionReader </strong>，然后传入头名称。下面是代码的样子:</p><p id="77f5" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><code class="fe me mf mg lu b">builder.Services.AddApiVersioning(options =&gt; options.DefaultApiVersion = new ApiVersion(1, 0); options.ApiVersionReader = new HeaderApiVersionReader("X-Api-Version");</code></p><p id="e098" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在尝试使用<a class="ae lo" href="https://www.postman.com/" rel="noopener ugc nofollow" target="_blank"> Postman </a>或 Curl 调用 API 端点，并在请求中传递头部<code class="fe me mf mg lu b">X-Api-Version </code>。</p><p id="8ae0" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这就是在 ASP 中启用 API 版本控制所需要做的全部工作。Ner 核心 web API，并使用自定义请求头来版本化您的 API。</p><p id="24ab" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">要了解更多关于剩余版本方案的细节，请订阅我的邮件列表和即将发布的电子书。</p><p id="9f39" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">编程快乐！</p><blockquote class="lh li lj"><p id="1d52" class="jv jw lk jx b jy jz ka kb kc kd ke kf ll kh ki kj lm kl km kn ln kp kq kr ks ig bi translated">我最新的电子书出版了。这是一个循序渐进的指南，将教你如何用 MongoDB 后端和。网芯。用 NoSQL 数据库 Mongo DB  获得您的<a class="ae lo" href="https://www.amazon.com/dp/B0BT1Z8D4Z" rel="noopener ugc nofollow" target="_blank"> <strong class="jx io">副本</strong></a></p></blockquote></div></div>    
</body>
</html>