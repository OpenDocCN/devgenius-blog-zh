<html>
<head>
<title>How to set up CI/CD using docker and github actions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用 docker 和 github 操作设置 CI/CD</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/how-to-set-up-ci-cd-using-docker-and-github-actions-c2502073c74c?source=collection_archive---------6-----------------------#2022-03-02">https://blog.devgenius.io/how-to-set-up-ci-cd-using-docker-and-github-actions-c2502073c74c?source=collection_archive---------6-----------------------#2022-03-02</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jk jl jm jn gh gi paragraph-image"><div class="ab gu cl jo"><img src="../Images/3756c6b676c4b70e6ba29eb362338868.png" data-original-src="https://miro.medium.com/v2/format:webp/0*F8MQz8-QSOg8NfUC.png"/></div></figure><p id="b975" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">在本文中，我们将讨论如何在 google cloud run 上使用 github 操作自动部署 dockerized 应用程序。</p><p id="de4a" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">我们将使用以下架构在 gcp 云运行服务上部署我们的代码。</p><pre class="kp kq kr ks gt kt ku kv kw aw kx bi"><span id="00d1" class="ky kz in ku b gy la lb l lc ld">1. Dockerizing the application.<br/>2. Building the docker image.<br/>3. Pushing the image to google container registry i.e GCR.<br/>4. Running the container to cloud run by fetching image from gcr.</span></pre><p id="d9b5" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">首先，您应该:</p><ol class=""><li id="3b9f" class="le lf in jt b ju jv jy jz kc lg kg lh kk li ko lj lk ll lm bi translated"><a class="ae ln" href="https://cloud.google.com/iam/docs/creating-managing-service-account-keys" rel="noopener ugc nofollow" target="_blank"> Google 服务账号密钥</a>作为 json 文件下载。</li><li id="6ad1" class="le lf in jt b ju lo jy lp kc lq kg lr kk ls ko lj lk ll lm bi translated">建筑形象档案。</li></ol><p id="1abb" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">我假设你的应用程序中已经有 docker 文件。你可以点击这个链接来设置 python flask 应用程序的 docker 文件。</p><p id="e4e5" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">分享下面我的 docker 文件下面</p><pre class="kp kq kr ks gt kt ku kv kw aw kx bi"><span id="a6aa" class="ky kz in ku b gy la lb l lc ld">FROM python:3<br/>USER root<br/>WORKDIR /app</span><span id="53f3" class="ky kz in ku b gy lt lb l lc ld">COPY . .<br/>EXPOSE 8000</span><span id="3366" class="ky kz in ku b gy lt lb l lc ld">RUN pip install -r requirements.txt<br/>CMD ["gunicorn"  ,"--timeout","2000","-w","1", "-b", "0.0.0.0:8000", "main:app"]</span></pre><p id="222c" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">如果您想使用 github actions 构建部署到 google cloud 的管道，您需要使用 google 创建服务帐户，并下载该帐户的凭证 json 文件。Json 文件如下所示</p><pre class="kp kq kr ks gt kt ku kv kw aw kx bi"><span id="dd82" class="ky kz in ku b gy la lb l lc ld">{</span><span id="4aac" class="ky kz in ku b gy lt lb l lc ld">"type": "service_account",</span><span id="8813" class="ky kz in ku b gy lt lb l lc ld">"project_id": "project id",</span><span id="9dbc" class="ky kz in ku b gy lt lb l lc ld">"private_key_id": "",</span><span id="e401" class="ky kz in ku b gy lt lb l lc ld">"private_key": "-----BEGIN PRIVATE KEY-----<br/>-----END PRIVATE KEY-----\n",</span><span id="24ff" class="ky kz in ku b gy lt lb l lc ld">"client_email": "loreal-frontend-cloud-r@loreal-321234.iam.gserviceaccount.com",</span><span id="318a" class="ky kz in ku b gy lt lb l lc ld">"client_id": "11445571437233213417",</span><span id="0c78" class="ky kz in ku b gy lt lb l lc ld">"auth_uri": "https://accounts.google.com/o/oauth2/auth",</span><span id="da7f" class="ky kz in ku b gy lt lb l lc ld">"token_uri": "https://oauth2.googleapis.com/token",</span><span id="b425" class="ky kz in ku b gy lt lb l lc ld">"auth_provider_x509_cert_url": "",</span><span id="9984" class="ky kz in ku b gy lt lb l lc ld">"client_x509_cert_url": ""</span><span id="47f3" class="ky kz in ku b gy lt lb l lc ld">}</span></pre><p id="edca" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">下面您可以找到 workflow.yaml 文件，它应该在。存储库的 github/workflows 目录。</p><p id="9423" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">在编写 yaml 文件之前，需要在 github 中保密的事项:</p><ol class=""><li id="dfa1" class="le lf in jt b ju jv jy jz kc lg kg lh kk li ko lj lk ll lm bi translated">gcp 项目标识:GCP 项目标识。</li><li id="bede" class="le lf in jt b ju lo jy lp kc lq kg lr kk ls ko lj lk ll lm bi translated">gcp 图像 _ 存储库 _ 名称:图像将被推送到的 GCP 存储库。</li><li id="0de6" class="le lf in jt b ju lo jy lp kc lq kg lr kk ls ko lj lk ll lm bi translated">gcp 电子邮件:GCP 服务帐户电子邮件。</li><li id="b36e" class="le lf in jt b ju lo jy lp kc lq kg lr kk ls ko lj lk ll lm bi translated">GCP 应用端口:请求将被发送到这个端口上的容器。在我的例子中是 8000，因为我在端口 8000 上运行 gunicorn 服务器。</li><li id="4e54" class="le lf in jt b ju lo jy lp kc lq kg lr kk ls ko lj lk ll lm bi translated">GCP 凭证:粘贴 json 凭证文件的内容。</li><li id="c1d6" class="le lf in jt b ju lo jy lp kc lq kg lr kk ls ko lj lk ll lm bi translated">GCP 实例 id:运行容器的服务的 ID。</li></ol><pre class="kp kq kr ks gt kt ku kv kw aw kx bi"><span id="ce50" class="ky kz in ku b gy la lb l lc ld">name: "Docker push and deploy app on Google Cloud Run"<br/><br/>on:<br/>  push:<br/>    branches: ["master"]<br/>jobs:<br/>  build:<br/>    name: Setup Gcloud Account and Deploy the application on google cloud<br/>    if: "!contains(github.event.head_commit.message, 'skip ci')"<br/>    runs-on: ubuntu-latest<br/><br/>    env:<br/>      IMAGE_NAME: gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.GCP_IMAGE_REPOSITORY_NAME}}<br/><br/>    steps:<br/>    - name: Print image tag<br/>      run: echo $GITHUB_RUN_ID<br/>    - name: Login To GCP<br/>      uses: google-github-actions/setup-gcloud@v0<br/>      with:<br/>        project_id: ${{ secrets.GCP_PROJECT_ID }}<br/>        service_account_email: ${{ secrets.GCP_EMAIL }}<br/>        service_account_key: ${{ secrets.GCP_CREDENTIALS }}<br/><br/>    - name: Configure Docker<br/>      run: gcloud auth configure-docker --quiet<br/><br/>    - name: Checkout repository<br/>      uses: actions/checkout@v2<br/><br/>    - name: Build Docker image<br/>      run: docker build . -t $IMAGE_NAME:$GITHUB_RUN_ID<br/><br/>    - name: Push Docker image<br/>      run: docker push $IMAGE_NAME:$GITHUB_RUN_ID<br/><br/>    - name: Deploy Docker image<br/>      run: gcloud run deploy ${{ secrets.GCP_INSTANCE_ID }} --image $IMAGE_NAME:$GITHUB_RUN_ID --allow-unauthenticated --port ${{ secrets.GCP_APP_PORT }} --region us-central1 --platform managed</span></pre><p id="3ab2" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">了解 workflow.yaml 文件:</p><ol class=""><li id="7f00" class="le lf in jt b ju jv jy jz kc lg kg lh kk li ko lj lk ll lm bi translated">分支:每当主分支上有任何变化，我的工作(即设置 Gcloud 帐户和部署谷歌上的应用程序)将被触发。</li><li id="56b1" class="le lf in jt b ju lo jy lp kc lq kg lr kk ls ko lj lk ll lm bi translated">仅当 git 提交消息中没有跳过 ci 的消息时，才运行作业。</li><li id="58f3" class="le lf in jt b ju lo jy lp kc lq kg lr kk ls ko lj lk ll lm bi translated">设置环境变量 IMAGE_NAME。</li><li id="a974" class="le lf in jt b ju lo jy lp kc lq kg lr kk ls ko lj lk ll lm bi translated">登录您的 gcp 帐户。</li><li id="20fb" class="le lf in jt b ju lo jy lp kc lq kg lr kk ls ko lj lk ll lm bi translated">将<a class="ae ln" href="https://cloud.google.com/sdk/gcloud/reference/auth" rel="noopener ugc nofollow" target="_blank"> gcloud 注册为 Docker 凭证助手</a>。</li><li id="9b95" class="le lf in jt b ju lo jy lp kc lq kg lr kk ls ko lj lk ll lm bi translated">使用<strong class="jt io"> docker build 构建 docker 镜像。-t $ IMAGE _ NAME:$ GITHUB _ RUN _ ID</strong></li><li id="09f8" class="le lf in jt b ju lo jy lp kc lq kg lr kk ls ko lj lk ll lm bi translated">将 docker 映像推送到 gcr。</li><li id="d2ca" class="le lf in jt b ju lo jy lp kc lq kg lr kk ls ko lj lk ll lm bi translated">部署到 gcp 云运行服务。</li></ol></div></div>    
</body>
</html>