<html>
<head>
<title>K8s — Manage Multiple Clusters Using kubectl at Scale</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">K8s —使用 kubectl 大规模管理多个集群</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/k8s-manage-multiple-clusters-using-kubectl-at-scale-9f200c692099?source=collection_archive---------1-----------------------#2022-10-05">https://blog.devgenius.io/k8s-manage-multiple-clusters-using-kubectl-at-scale-9f200c692099?source=collection_archive---------1-----------------------#2022-10-05</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><div class=""/><div class=""><h2 id="53dd" class="pw-subtitle-paragraph jo iq ir bd b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dk translated">使用 kubectl 高效管理多个 K8s 集群</h2></div><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj kg"><img src="../Images/7347e3d735f6666a77bc8881906626f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-TgidDpZ7ejQUr6VCuxgjw.png"/></div></div></figure><p id="3c9c" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">有时，您需要为不同的用例场景设置多个 K8s 集群，例如需要隔离的法规遵从性、增加的可用性、开发/生产环境或希望消除供应商锁定，..等等。</p><p id="10b8" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">多个 K8s 群集的三种常见使用情形是:</p><ul class=""><li id="e38e" class="lo lp ir ku b kv kw ky kz lb lq lf lr lj ls ln lt lu lv lw bi translated">如果您提供的是托管 K8s 服务，比如 AWS EKS，您将需要管理多个 EKS 集群，允许客户端管理工作节点。虽然您的客户不会为管理他们的主节点而烦恼，但您的团队将需要访问它们来管理诸如扩展、可用性和备份之类的事情。</li></ul><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj lx"><img src="../Images/9924b448159e27e5bab1569a7e0d6c4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BH9xDElwdUeqnJvCv4Q0pA.png"/></div></div></figure><ul class=""><li id="761d" class="lo lp ir ku b kv kw ky kz lb lq lf lr lj ls ln lt lu lv lw bi translated">您的组织需要多个内部集群来隔离应用运行环境。例如，开发阶段的应用程序应该部署在开发集群中，而测试阶段的应用程序应该部署在测试集群中，生产就绪的应用程序应该部署在生产集群中。这种方法限制了对生产集群的访问，并在生产集群上创建了强大的安全性。</li></ul><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj ly"><img src="../Images/276ac40a88fcfb7ce3b0e8426df9a3ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WP7JqHi-MKJdwykw4eagOw.png"/></div></div></figure><ul class=""><li id="65eb" class="lo lp ir ku b kv kw ky kz lb lq lf lr lj ls ln lt lu lv lw bi translated">K8s 管理员也可以创建虚拟集群。虚拟集群是从现有的 Kubernetes 集群派生出来的，并使用集群的资源。创建虚拟集群的好处是提高安全性和降低成本。</li></ul><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div class="gi gj lz"><img src="../Images/6137601614c37c51febac2b52c009b74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/format:webp/1*2ggeQCwMI18ZfDVckjd65Q.png"/></div></figure><p id="6cb7" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi">​</p><h1 id="5542" class="ma mb ir bd mc md me mf mg mh mi mj mk jx ml jy mm ka mn kb mo kd mp ke mq mr bi translated">管理多个 K8s 集群</h1><p id="f3d7" class="pw-post-body-paragraph ks kt ir ku b kv ms js kx ky mt jv la lb mu ld le lf mv lh li lj mw ll lm ln ik bi translated">K8s 命令行工具<code class="fe mx my mz na b">kubectl</code>，是 K8s 管理员最好的朋友。它允许您对 K8s 集群运行管理命令。对于配置，<code class="fe mx my mz na b">kubectl</code>在<code class="fe mx my mz na b">$HOME/.kube</code>目录中查找名为 config 的文件。您可以通过设置<code class="fe mx my mz na b">KUBECONFIG</code>环境变量或设置<code class="fe mx my mz na b">--kubeconfig</code>标志来指定其他 kubeconfig 文件。</p><p id="4674" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">来自 K8s 官方文档:“配置对多个集群的访问”(<a class="ae nb" href="https://kubernetes.io/docs/tasks/access-application-cluster/configure-access-multiple-clusters/" rel="noopener ugc nofollow" target="_blank">配置对多个集群的访问| Kubernetes </a>)，它描述了配置对多个 K8s 集群的访问的两种方式。</p><h2 id="1273" class="nc mb ir bd mc nd ne dn mg nf ng dp mk lb nh ni mm lf nj nk mo lj nl nm mq nn bi translated">单一配置文件</h2><p id="ea81" class="pw-post-body-paragraph ks kt ir ku b kv ms js kx ky mt jv la lb mu ld le lf mv lh li lj mw ll lm ln ik bi translated">在这种方法中，您使用一个配置文件为所有 K8s 集群定义<code class="fe mx my mz na b">clusters</code>、<code class="fe mx my mz na b">users</code>和<code class="fe mx my mz na b">contexts</code>，例如:</p><pre class="kh ki kj kk gu no na np nq aw nr bi"><span id="2329" class="nc mb ir na b gz ns nt l nu nv"># config-demo file<br/>apiVersion: v1<br/>clusters:<br/>- cluster:<br/>    certificate-authority: fake-ca-file<br/>    server: <a class="ae nb" href="https://1.2.3.4" rel="noopener ugc nofollow" target="_blank">https://1.2.3.4</a><br/>  name: development<br/>- cluster:<br/>    insecure-skip-tls-verify: true<br/>    server: <a class="ae nb" href="https://5.6.7.8" rel="noopener ugc nofollow" target="_blank">https://5.6.7.8</a><br/>  name: scratch<br/>contexts:<br/>- context:<br/>    cluster: development<br/>    namespace: frontend<br/>    user: developer<br/>  name: dev-frontend<br/>- context:<br/>    cluster: development<br/>    namespace: storage<br/>    user: developer<br/>  name: dev-storage<br/>- context:<br/>    cluster: scratch<br/>    namespace: default<br/>    user: experimenter<br/>  name: exp-scratch<br/>current-context: ""<br/>kind: Config<br/>preferences: {}<br/>users:<br/>- name: developer<br/>  user:<br/>    client-certificate: fake-cert-file<br/>    client-key: fake-key-file<br/>- name: experimenter<br/>  user:<br/>    password: some-password<br/>    username: exp</span></pre><p id="8250" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">上面的配置文件定义了两个集群:<code class="fe mx my mz na b">development</code>和<code class="fe mx my mz na b">scratch</code>，两个用户和三个上下文。要在不同的集群之间切换，您可以使用下面的<code class="fe mx my mz na b">kubectl</code>命令:</p><pre class="kh ki kj kk gu no na np nq aw nr bi"><span id="cd43" class="nc mb ir na b gz ns nt l nu nv">$ kubectl config --kubeconfig=config-demo use-context dev-frontend</span></pre><p id="72f7" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">将使用<code class="fe mx my mz na b">dev-frontend</code>中定义的集群(即开发集群)。</p><p id="f9a3" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">这种方法的问题是，并不总是这样配置 kubeconfig 文件。如果你有很多 K8s 集群，这个文件很快就会变得混乱。每次你想切换的时候，你必须设置上下文。​</p><h2 id="f7cf" class="nc mb ir bd mc nd ne dn mg nf ng dp mk lb nh ni mm lf nj nk mo lj nl nm mq nn bi translated">多个配置文件</h2><p id="cd0e" class="pw-post-body-paragraph ks kt ir ku b kv ms js kx ky mt jv la lb mu ld le lf mv lh li lj mw ll lm ln ik bi translated">第二种方法是为每个集群创建一个单独的配置文件。所以上面的单个配置文件可以分为:</p><ul class=""><li id="512c" class="lo lp ir ku b kv kw ky kz lb lq lf lr lj ls ln lt lu lv lw bi translated">配置开发文件</li></ul><pre class="kh ki kj kk gu no na np nq aw nr bi"><span id="97da" class="nc mb ir na b gz ns nt l nu nv"># config-development<br/>apiVersion: v1<br/>clusters:<br/>- cluster:<br/>    certificate-authority: fake-ca-file<br/>    server: <a class="ae nb" href="https://1.2.3.4" rel="noopener ugc nofollow" target="_blank">https://1.2.3.4</a><br/>  name: development<br/>contexts:<br/>- context:<br/>    cluster: development<br/>    namespace: frontend<br/>    user: developer<br/>  name: dev-frontend<br/>- context:<br/>    cluster: development<br/>    namespace: storage<br/>    user: developer<br/>  name: dev-storage<br/>current-context: ""<br/>kind: Config<br/>preferences: {}<br/>users:<br/>- name: developer<br/>  user:<br/>    client-certificate: fake-cert-file<br/>    client-key: fake-key-file</span></pre><ul class=""><li id="8875" class="lo lp ir ku b kv kw ky kz lb lq lf lr lj ls ln lt lu lv lw bi translated">配置-暂存文件</li></ul><pre class="kh ki kj kk gu no na np nq aw nr bi"><span id="a5fb" class="nc mb ir na b gz ns nt l nu nv"># config-scratch<br/>apiVersion: v1<br/>clusters:<br/>- cluster:<br/>    insecure-skip-tls-verify: true<br/>    server: <a class="ae nb" href="https://5.6.7.8" rel="noopener ugc nofollow" target="_blank">https://5.6.7.8</a><br/>  name: scratch<br/>contexts:<br/>- context:<br/>    cluster: scratch<br/>    namespace: default<br/>    user: experimenter<br/>  name: exp-scratch<br/>current-context: ""<br/>kind: Config<br/>preferences: {}<br/>users:<br/>- name: experimenter<br/>  user:<br/>    password: some-password<br/>    username: exp</span></pre><p id="a557" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">然后您可以使用<code class="fe mx my mz na b">$KUBECONFIG</code>环境变量的一个很酷的功能，它允许您指定多个用冒号分隔的<code class="fe mx my mz na b">kubeconfig</code>文件。当您有多个配置文件时，应该是这样的:</p><pre class="kh ki kj kk gu no na np nq aw nr bi"><span id="1f36" class="nc mb ir na b gz ns nt l nu nv">$KUBECONFIG=/$HOME/.kube/contexts/config-development:/$HOME/.kube/contexts/config-scratch</span></pre><p id="5145" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">然后你可以使用<code class="fe mx my mz na b">kubectl config use-context &lt;context_name&gt;</code>在不同的上下文之间切换。这解决了允许我们有多个配置文件的问题，但仍然相当手动，因为每次你重启终端或如果有一个新的 kubeconfig(或删除一个旧的)，你必须更新该环境变量。</p><p id="3d3b" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">这就是<code class="fe mx my mz na b">kubectx</code>和<code class="fe mx my mz na b">kubens</code>发挥作用的地方！它允许您轻松地检查所有可用的上下文、名称空间，并通过键入<code class="fe mx my mz na b">kubectx context-name</code>或<code class="fe mx my mz na b">kubens namespace</code>在它们之间切换，就是这样！</p><h1 id="8ce5" class="ma mb ir bd mc md me mf mg mh mi mj mk jx ml jy mm ka mn kb mo kd mp ke mq mr bi translated">库贝克斯和库本斯</h1><p id="376b" class="pw-post-body-paragraph ks kt ir ku b kv ms js kx ky mt jv la lb mu ld le lf mv lh li lj mw ll lm ln ik bi translated"><code class="fe mx my mz na b">kubectx</code>是一个在<code class="fe mx my mz na b">kubectl</code>上更快切换上下文(集群)的工具。<code class="fe mx my mz na b">kubens</code>是一个在 Kubernetes 名称空间之间轻松切换(并为<code class="fe mx my mz na b">kubectl</code>配置它们)的工具。</p><h2 id="d548" class="nc mb ir bd mc nd ne dn mg nf ng dp mk lb nh ni mm lf nj nk mo lj nl nm mq nn bi translated">安装 kubectx 插件</h2><pre class="kh ki kj kk gu no na np nq aw nr bi"><span id="161a" class="nc mb ir na b gz ns nt l nu nv">$ kubectl krew install ctx<br/>Updated the local copy of plugin index.<br/>Installing plugin: ctx<br/>Installed plugin: ctx<br/>\<br/> | Use this plugin:<br/> |      kubectl ctx<br/> | Documentation:<br/> |      <a class="ae nb" href="https://github.com/ahmetb/kubectx" rel="noopener ugc nofollow" target="_blank">https://github.com/ahmetb/kubectx</a><br/> | Caveats:<br/> | \<br/> |  | If fzf is installed on your machine, you can interactively choose<br/> |  | between the entries using the arrow keys, or by fuzzy searching<br/> |  | as you type.<br/> |  | See <a class="ae nb" href="https://github.com/ahmetb/kubectx" rel="noopener ugc nofollow" target="_blank">https://github.com/ahmetb/kubectx</a> for customization and details.<br/> | /<br/>/</span></pre><h2 id="95af" class="nc mb ir bd mc nd ne dn mg nf ng dp mk lb nh ni mm lf nj nk mo lj nl nm mq nn bi translated">安装 kubens 插件</h2><pre class="kh ki kj kk gu no na np nq aw nr bi"><span id="d184" class="nc mb ir na b gz ns nt l nu nv">$ k krew install ns<br/>Updated the local copy of plugin index.<br/>Installing plugin: ns<br/>Installed plugin: ns<br/>\<br/> | Use this plugin:<br/> |      kubectl ns<br/> | Documentation:<br/> |      <a class="ae nb" href="https://github.com/ahmetb/kubectx" rel="noopener ugc nofollow" target="_blank">https://github.com/ahmetb/kubectx</a><br/> | Caveats:<br/> | \<br/> |  | If fzf is installed on your machine, you can interactively choose<br/> |  | between the entries using the arrow keys, or by fuzzy searching<br/> |  | as you type.<br/> | /<br/>/</span></pre><h1 id="b5b0" class="ma mb ir bd mc md me mf mg mh mi mj mk jx ml jy mm ka mn kb mo kd mp ke mq mr bi translated">常见用法</h1><pre class="kh ki kj kk gu no na np nq aw nr bi"><span id="f2b0" class="nc mb ir na b gz ns nt l nu nv"><strong class="na is"># List all the contexts</strong><br/>$ kubectl ctx<br/>cluster-dev<br/>**cluster-prd**<br/>cluster-test</span><span id="d306" class="nc mb ir na b gz nw nt l nu nv"><strong class="na is"># Switch to another cluster that's in kubeconfig</strong><br/>$ kubectl ctx cluster-dev<br/>Switched to context "cluster-dev".</span><span id="fed1" class="nc mb ir na b gz nw nt l nu nv"><strong class="na is"># Switch back to previous cluster</strong><br/>$ kubectl ctx -<br/>Switched to context "cluster-prd".</span><span id="d403" class="nc mb ir na b gz nw nt l nu nv"><strong class="na is"># Create an alias for the context</strong><br/>$ kubectl ctx dublin=gke_ahmetb_europe-west1-b_dublin<br/>Context "dublin" set.<br/>Aliased "gke_ahmetb_europe-west1-b_dublin" as "dublin".</span><span id="de16" class="nc mb ir na b gz nw nt l nu nv"><strong class="na is"># List all namespace</strong><br/>$ kubectl ns<br/>kube-system<br/>namespace1<br/>namespace2<br/>...</span><span id="9eaf" class="nc mb ir na b gz nw nt l nu nv"><strong class="na is"># Change the active namespace on kubectl</strong><br/>$ kubectl ns kube-system<br/>Context "test" set.<br/>Active namespace is "kube-system".</span><span id="fa0b" class="nc mb ir na b gz nw nt l nu nv"><strong class="na is"># Go back to the previous namespace</strong><br/>$ kubectl nss -<br/>Context "test" set.<br/>Active namespace is "default".</span></pre><h1 id="1fe4" class="ma mb ir bd mc md me mf mg mh mi mj mk jx ml jy mm ka mn kb mo kd mp ke mq mr bi translated">结论</h1><p id="f0d0" class="pw-post-body-paragraph ks kt ir ku b kv ms js kx ky mt jv la lb mu ld le lf mv lh li lj mw ll lm ln ik bi translated">我希望有了<code class="fe mx my mz na b">kubectx</code>和<code class="fe mx my mz na b">kubens</code>插件，你的日常 K8s 管理工作会更有效率，你的生产力会更高。感谢阅读，我会在我的下一篇文章中看到你！</p></div></div>    
</body>
</html>