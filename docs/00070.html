<html>
<head>
<title>All You Need to Kickstart Youtube Upload with Elixir</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">你所需要的就是用灵药启动 Youtube 上传</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/all-you-need-to-kickstart-youtube-upload-with-elixir-25dd62127033?source=collection_archive---------0-----------------------#2019-10-07">https://blog.devgenius.io/all-you-need-to-kickstart-youtube-upload-with-elixir-25dd62127033?source=collection_archive---------0-----------------------#2019-10-07</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><div class=""/><div class=""><h2 id="f9a8" class="pw-subtitle-paragraph jo iq ir bd b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dk translated">找出帮助你上传<strong class="ak">仙丹</strong>的秘密和偷偷摸摸的 bug。</h2></div><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj kg"><img src="../Images/9352a73e515ee1707a56b1b1c376c008.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*aI-qLMxAApEyw0Zu"/></div></div><figcaption class="ks kt gk gi gj ku kv bd b be z dk translated">照片由<a class="ae kw" href="https://unsplash.com/@christianw?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">克里斯蒂安·威迪格</a>在<a class="ae kw" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><h1 id="8173" class="kx ky ir bd kz la lb lc ld le lf lg lh jx li jy lj ka lk kb ll kd lm ke ln lo bi translated">多次上传</h1><p id="829c" class="pw-post-body-paragraph lp lq ir lr b ls lt js lu lv lw jv lx ly lz ma mb mc md me mf mg mh mi mj mk ik bi translated">您是否遇到过视频上传问题？我有。于是想到了这个项目来解决。我选择了长生不老药来解决这个问题，并开始了。</p><h1 id="6afd" class="kx ky ir bd kz la lb lc ld le lf lg lh jx li jy lj ka lk kb ll kd lm ke ln lo bi translated">先获得授权！</h1><p id="8be1" class="pw-post-body-paragraph lp lq ir lr b ls lt js lu lv lw jv lx ly lz ma mb mc md me mf mg mh mi mj mk ik bi translated">你需要授权才能让它工作。使用控制器重定向到所需的验证端点。</p><pre class="kh ki kj kk gu ml mm mn mo aw mp bi"><span id="c310" class="mq ky ir mm b gz mr ms l mt mu"># auth.ex<br/><strong class="mm is">defmodule</strong> <strong class="mm is">GoogleServices</strong>.<strong class="mm is">Auth</strong> <strong class="mm is">do</strong><br/><strong class="mm is">  use</strong> <strong class="mm is">OAuth2</strong>.<strong class="mm is">Strategy</strong><br/>  <strong class="mm is">require</strong> <strong class="mm is">Logger</strong><br/><br/>  @redirect_url  "http://localhost:4000/auth/callback"<br/>  @auth_site "https://accounts.google.com"<br/>  @auth_url "/o/oauth2/auth"<br/>  @token_url "https://oauth2.googleapis.com/token"<br/><br/>  # Public API<br/>  <strong class="mm is">def</strong> client <strong class="mm is">do</strong><br/><strong class="mm is">    OAuth2</strong>.<strong class="mm is">Client</strong>.new([<br/>      strategy: __MODULE__,<br/>      client_id: <strong class="mm is">Application</strong>.get_env(:videoupload, :google_auth_client_id),<br/>      client_secret: <strong class="mm is">Application</strong>.get_env(:videoupload, :google_auth_client_secret),<br/>      redirect_uri: @redirect_url,<br/>      site: @auth_site,<br/>      authorize_url: @auth_url,<br/>      token_url:  @token_url<br/>    ])<br/>  <strong class="mm is">end</strong></span><span id="8c73" class="mq ky ir mm b gz mv ms l mt mu">...</span></pre><p id="aff8" class="pw-post-body-paragraph lp lq ir lr b ls mw js lu lv mx jv lx ly my ma mb mc mz me mf mg na mi mj mk ik bi translated">重定向到 Google Auth URL，然后用回调来处理它。</p><pre class="kh ki kj kk gu ml mm mn mo aw mp bi"><span id="34a2" class="mq ky ir mm b gz mr ms l mt mu"># auth_controller.ex</span><span id="a063" class="mq ky ir mm b gz mv ms l mt mu">...</span><span id="bd9e" class="mq ky ir mm b gz mv ms l mt mu"><strong class="mm is">def</strong> youtube(conn, _params) <strong class="mm is">do</strong><br/><strong class="mm is">   </strong>redirect conn, external:<br/>     <strong class="mm is">GoogleServices</strong>.<strong class="mm is">Auth</strong>.authorize_url!(scope: @yt_scope_url)<br/><strong class="mm is">end<br/>...</strong></span></pre><p id="c446" class="pw-post-body-paragraph lp lq ir lr b ls mw js lu lv mx jv lx ly my ma mb mc mz me mf mg na mi mj mk ik bi translated">一个函数应该解析回调代码。TokenStore 是存储令牌的 GenServer，并在请求时提供令牌。</p><pre class="kh ki kj kk gu ml mm mn mo aw mp bi"><span id="257a" class="mq ky ir mm b gz mr ms l mt mu"># auth_controller.ex</span><span id="7021" class="mq ky ir mm b gz mv ms l mt mu"><strong class="mm is">def</strong> callback(conn, %{"code" =&gt; code, "scope"=&gt; scope}) <strong class="mm is">do</strong><br/><strong class="mm is">      </strong># Exchange an auth code for an access token<br/>      # Extract token to separate worker and call to get it<br/><br/>      api_scope = <strong class="mm is">String</strong>.split(scope, "/")<br/>      |&gt; <strong class="mm is">List</strong>.last<br/><br/>      <strong class="mm is">Logger</strong>.info("###Api Scope #{api_scope} ###")<br/><br/>      oauth_client = <strong class="mm is">GoogleServices</strong>.<strong class="mm is">Auth</strong>.get_token!(code: code)<br/>      <strong class="mm is">GenServer</strong>.cast(<strong class="mm is">TokenStore</strong>, {:set, api_scope, oauth_client.token.access_token})<br/><br/>      conn |&gt; redirect(to: "/")<br/>    <strong class="mm is">end</strong></span></pre><h1 id="5c9e" class="kx ky ir bd kz la lb lc ld le lf lg lh jx li jy lj ka lk kb ll kd lm ke ln lo bi translated">以后再联系！</h1><p id="b848" class="pw-post-body-paragraph lp lq ir lr b ls lt js lu lv lw jv lx ly lz ma mb mc md me mf mg mh mi mj mk ik bi translated">对于 YouTube 来说，这种联系是至关重要的，为此，我们将有一个单独的模块。它将使用<strong class="lr is">特斯拉</strong>和扩展它的基本网址和标题，所以它可以轻松地联系 API。创建连接将需要令牌，这将在后面讨论。</p><pre class="kh ki kj kk gu ml mm mn mo aw mp bi"><span id="73f1" class="mq ky ir mm b gz mr ms l mt mu"><strong class="mm is">defmodule</strong> <strong class="mm is">YouTubeData</strong>.<strong class="mm is">Connection</strong> <strong class="mm is">do</strong><br/><strong class="mm is">  </strong>@moduledoc """<br/>  Handle Tesla connections for YouTubeData.<br/>  """</span><span id="6e75" class="mq ky ir mm b gz mv ms l mt mu">  <strong class="mm is">use</strong> <strong class="mm is">Tesla</strong></span><span id="cb1c" class="mq ky ir mm b gz mv ms l mt mu"># Add any middleware here (authentication)<br/>  plug <strong class="mm is">Tesla</strong>.<strong class="mm is">Middleware</strong>.<strong class="mm is">BaseUrl</strong>,  "https://www.googleapis.com/upload/youtube/v3"<br/>  plug <strong class="mm is">Tesla</strong>.<strong class="mm is">Middleware</strong>.<strong class="mm is">Headers</strong>, %{"User-Agent" =&gt; "Elixir"}<br/>  plug <strong class="mm is">Tesla</strong>.<strong class="mm is">Middleware</strong>.<strong class="mm is">EncodeJson</strong></span></pre><h1 id="5e63" class="kx ky ir bd kz la lb lc ld le lf lg lh jx li jy lj ka lk kb ll kd lm ke ln lo bi translated">立即开始上传！</h1><p id="1dd9" class="pw-post-body-paragraph lp lq ir lr b ls lt js lu lv lw jv lx ly lz ma mb mc md me mf mg mh mi mj mk ik bi translated">下面列出了 YouTube 上传鲜为人知的秘密。您将拥有来自<code class="fe nb nc nd mm b">Connection</code>模块的<code class="fe nb nc nd mm b">new/1</code>方法，该方法将创建正确的连接。同样重要的是关键字列表中的<code class="fe nb nc nd mm b">uploadType</code>，它将作为查询参数被附加。所有的逻辑都可以放在 facade 或服务中，并且可以通过前端访问。</p><pre class="kh ki kj kk gu ml mm mn mo aw mp bi"><span id="217c" class="mq ky ir mm b gz mr ms l mt mu"><br/>        # Create your client with new token<br/>        ytClient = new(token)</span><span id="d3dd" class="mq ky ir mm b gz mv ms l mt mu">        # Add some metadata<br/>        snippet = %<strong class="mm is">YouTubeData</strong>.<strong class="mm is">Model</strong>.<strong class="mm is">VideoSnippet</strong>{<br/>          title: "Dummy",<br/>          categoryId: <strong class="mm is">22</strong>,<br/>          description: "Dummy"<br/>        }<br/><br/>        status = %<strong class="mm is">YouTubeData</strong>.<strong class="mm is">Model</strong>.<strong class="mm is">VideoStatus</strong>{<br/>          privacyStatus: "private"<br/>        }<br/><br/>        video = %<strong class="mm is">YouTubeData</strong>.<strong class="mm is">Model</strong>.<strong class="mm is">Video</strong>{<br/>          snippet: snippet,<br/>          status: status<br/>        }<br/><br/><br/>        # Important step to follow!<br/>        keyword_list = [{:uploadType, "multipart"}]<br/><br/>        <strong class="mm is">case</strong> youtube_videos_insert(ytClient, filename, video, "snippet,status", keyword_list) <strong class="mm is">do ...</strong></span></pre><h1 id="2db3" class="kx ky ir bd kz la lb lc ld le lf lg lh jx li jy lj ka lk kb ll kd lm ke ln lo bi translated">注意这个重要的步骤！</h1><p id="f355" class="pw-post-body-paragraph lp lq ir lr b ls lt js lu lv lw jv lx ly lz ma mb mc md me mf mg mh mi mj mk ik bi translated">下面列出了创建请求的秘密顺序，注意请求参数的名称。<code class="fe nb nc nd mm b">resource</code>将包含元数据，<code class="fe nb nc nd mm b">media</code>将包含<code class="fe nb nc nd mm b">multipart/form-data</code>。<code class="fe nb nc nd mm b">part</code>很重要，因为它保存了发送给 Google 服务的内容和返回的内容。</p><pre class="kh ki kj kk gu ml mm mn mo aw mp bi"><span id="4e6a" class="mq ky ir mm b gz mr ms l mt mu"><strong class="mm is">def</strong> youtube_videos_insert(connection,file, video, part, opts \\ []) <strong class="mm is">do</strong><br/><strong class="mm is">    </strong>optional_params = %{<br/>      :"alt" =&gt; :query,<br/>      :"fields" =&gt; :query,<br/>      :"key" =&gt; :query,<br/>      :"oauth_token" =&gt; :query,<br/>      :"prettyPrint" =&gt; :query,<br/>      :"quotaUser" =&gt; :query,<br/>      :"userIp" =&gt; :query,<br/>      :"autoLevels" =&gt; :query,<br/>      :"body" =&gt; :body,<br/>      :"notifySubscribers" =&gt; :query,<br/>      :"onBehalfOfContentOwner" =&gt; :query,<br/>      :"onBehalfOfContentOwnerChannel" =&gt; :query,<br/>      :"stabilize" =&gt; :query,<br/>      :"uploadType" =&gt; :query<br/>    }<br/>    %{}<br/>    |&gt; method(:post)<br/>    |&gt; url("/videos")<br/>    |&gt; add_param(:body, :"resource", video)<br/>    |&gt; add_param(:file, :"media", file)<br/>    |&gt; add_param(:query, :"part", part)<br/>    |&gt; add_optional_params(optional_params, opts)<br/>    |&gt; <strong class="mm is">Enum</strong>.into([])<br/>    |&gt; (&amp;<strong class="mm is">Connection</strong>.request(connection, &amp;1)).()<br/>    |&gt; decode(<strong class="mm is">YouTubeData</strong>.<strong class="mm is">Model</strong>.<strong class="mm is">Video</strong>)<br/>  <strong class="mm is">end</strong></span></pre><h1 id="0282" class="kx ky ir bd kz la lb lc ld le lf lg lh jx li jy lj ka lk kb ll kd lm ke ln lo bi translated">我发现了 4 个错误，这样你就不用再去找了</h1><p id="b008" class="pw-post-body-paragraph lp lq ir lr b ls lt js lu lv lw jv lx ly lz ma mb mc md me mf mg mh mi mj mk ik bi translated">当你试图独自上传视频时，你会遇到很多错误。这里列出了一些。</p><p id="dddd" class="pw-post-body-paragraph lp lq ir lr b ls mw js lu lv mx jv lx ly my ma mb mc mz me mf mg na mi mj mk ik bi translated"><code class="fe nb nc nd mm b">mediaBodyRequired</code>如果在请求的开头没有包含带有<code class="fe nb nc nd mm b">:file</code> atom 的媒体部分，就会出现错误。</p><p id="d27f" class="pw-post-body-paragraph lp lq ir lr b ls mw js lu lv mx jv lx ly my ma mb mc mz me mf mg na mi mj mk ik bi translated"><code class="fe nb nc nd mm b">unknownPart</code>错误信息告诉您，您没有像上面添加的那样将零件参数添加到查询中。</p><p id="059b" class="pw-post-body-paragraph lp lq ir lr b ls mw js lu lv mx jv lx ly my ma mb mc mz me mf mg na mi mj mk ik bi translated"><code class="fe nb nc nd mm b">unexpectedPart</code>如果发<code class="fe nb nc nd mm b">snippet,status</code>以外的东西。</p><p id="12e4" class="pw-post-body-paragraph lp lq ir lr b ls mw js lu lv mx jv lx ly my ma mb mc mz me mf mg na mi mj mk ik bi translated"><code class="fe nb nc nd mm b">authorizationRequired</code>您的令牌已过期，请手动刷新或使用刷新令牌刷新。</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div class="gi gj ne"><img src="../Images/5226f2c2284d62add0493075054c595c.png" data-original-src="https://miro.medium.com/v2/resize:fit:364/1*oZ1FihqIxYfVS_0A8pSMfw.gif"/></div><figcaption class="ks kt gk gi gj ku kv bd b be z dk translated">&amp;clap_if_you_want/0</figcaption></figure></div></div>    
</body>
</html>