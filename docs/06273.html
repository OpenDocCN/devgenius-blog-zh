<html>
<head>
<title>Backup and Restore SQL Server database (.bak) using C# .NET</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">备份和还原 SQL Server 数据库(。bak)使用 C#。网</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/backup-and-restore-sql-server-database-bak-using-c-net-4f3a848d15d?source=collection_archive---------1-----------------------#2021-12-27">https://blog.devgenius.io/backup-and-restore-sql-server-database-bak-using-c-net-4f3a848d15d?source=collection_archive---------1-----------------------#2021-12-27</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><h1 id="b6ef" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">支持</h1><p id="552e" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">要备份 SQL Server 数据库，我们需要知道数据库的名称以及我们要在本地保存它的路径。</p><p id="7fc9" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">考虑下面的方法和 appsettings.json</p><figure class="ll lm ln lo gt lp"><div class="bz fp l di"><div class="lq lr l"/></div></figure><figure class="ll lm ln lo gt lp"><div class="bz fp l di"><div class="lq lr l"/></div></figure><p id="720d" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">这里发生了一些事情。该方法有两个参数:databaseName(服务器上要备份的数据库的名称)和 localDatabasePath(可选，默认为 null)。如果 localDatabasePath 为空，将使用 appsettings.json 文件中指定的 SQL Server 的 basePath(SqlServerBasePath)。注意这是 MSSQL 的基本目录。localDatabasePath 将如下所示(其中“Database”是指定的数据库名称):</p><pre class="ll lm ln lo gt ls lt lu lv aw lw bi"><span id="d03f" class="lx jl in lt b gy ly lz l ma mb">C:\Program Files\Microsoft SQL Server\MSSQL15.MSSQLSERVER\MSSQL\Backup\Database.bak</span></pre><p id="b47d" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">localDatabasePath 必须以. bak 结尾，如果指定 localDatabasePath，请确保 NT Service\MSSQLSERVER 帐户有权保存备份。</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div class="gh gi mc"><img src="../Images/eb60ba59ef57fc4bcdc3595ebcf0a6ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:946/format:webp/1*4qqv92Ff-wo2Qx35hYnRtA.png"/></div></figure><p id="da62" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">被执行的 T-SQL</p><pre class="ll lm ln lo gt ls lt lu lv aw lw bi"><span id="7b20" class="lx jl in lt b gy ly lz l ma mb">BACKUP DATABASE @databaseName</span><span id="3789" class="lx jl in lt b gy mf lz l ma mb">TO DISK = @localDatabasePath</span><span id="3a18" class="lx jl in lt b gy mf lz l ma mb">WITH FORMAT,</span><span id="dffe" class="lx jl in lt b gy mf lz l ma mb">MEDIANAME = @formatMediaName,</span><span id="2d90" class="lx jl in lt b gy mf lz l ma mb">NAME = @formatName</span></pre><p id="e110" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">接受四个参数:databaseName，数据库的名称；localDatabasePath，保存备份的位置，包括名称。formatMediaName 和 formatName，它们是从 databaseName 自动生成的。我们在这里使用 WITH FORMAT，这样它将覆盖所有数据。这样做时要小心。请参见 Microsoft 文档中的以下内容:</p><p id="5ce5" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated"><a class="ae mg" href="https://docs.microsoft.com/en-us/sql/relational-databases/backup-restore/create-a-full-database-backup-sql-server?view=sql-server-ver15#TsqlProcedure" rel="noopener ugc nofollow" target="_blank">“使用</a> <code class="fe mh mi mj lt b"><a class="ae mg" href="https://docs.microsoft.com/en-us/sql/relational-databases/backup-restore/create-a-full-database-backup-sql-server?view=sql-server-ver15#TsqlProcedure" rel="noopener ugc nofollow" target="_blank">BACKUP</a></code> <a class="ae mg" href="https://docs.microsoft.com/en-us/sql/relational-databases/backup-restore/create-a-full-database-backup-sql-server?view=sql-server-ver15#TsqlProcedure" rel="noopener ugc nofollow" target="_blank">语句的格式子句时要格外小心，因为这会破坏先前存储在备份介质上的任何备份。”</a></p><h1 id="8f68" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">恢复</h1><p id="0b8c" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">要恢复 SQL Server 数据库，我们需要数据库名称和数据库路径。我们要还原的 bak 文件。</p><p id="c409" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">考虑下面的方法(使用与上面相同的 appsettings.json)</p><figure class="ll lm ln lo gt lp"><div class="bz fp l di"><div class="lq lr l"/></div></figure><p id="8a0d" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">当恢复数据库时，我们将指定。mdf 和。除了。bak 位置。在 appsettings.json 内部有一个指向 SQL Server 本地安装的 SQLServerBasePath。</p><pre class="ll lm ln lo gt ls lt lu lv aw lw bi"><span id="4f64" class="lx jl in lt b gy ly lz l ma mb">C:\Program Files\Microsoft SQL Server\MSSQL15.MSSQLSERVER\MSSQL</span></pre><p id="1444" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">从这里我们可以构建路径/数据/。mdf|。使用 SQLServerBasePath 的 ldf。使用 localDatabasePath 和下面的查询，我们可以从。bak 文件。这给了我们在构建到。mdf 和。ldf 文件。</p><pre class="ll lm ln lo gt ls lt lu lv aw lw bi"><span id="c669" class="lx jl in lt b gy ly lz l ma mb">RESTORE FILELISTONLY FROM DISK = @localDatabasePath</span></pre><p id="3295" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">当从查询中读取结果时，为了获得正确的值，您必须检查“类型”。</p><pre class="ll lm ln lo gt ls lt lu lv aw lw bi"><span id="aa48" class="lx jl in lt b gy ly lz l ma mb">var type = reader["Type"].ToString();</span></pre><p id="8a52" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">如果类型是“D ”,则逻辑名称是。mdf，如果是“L”型，那就是。ldf，此处指定为<a class="ae mg" href="https://docs.microsoft.com/en-us/sql/t-sql/statements/restore-statements-filelistonly-transact-sql?redirectedfrom=MSDN&amp;view=sql-server-ver15" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="e230" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">现在我们可以恢复数据库了。要无缝地做到这一点，我们首先需要将数据库设置为 SINGLE_USER，并终止任何可能导致恢复失败的活动连接。传入 databaseName 参数，我们必须使用动态 SQL 来运行该语句，因为在 ALTER DATABASE 中指定数据库名称时，SQL Server 不允许使用变量名。</p><pre class="ll lm ln lo gt ls lt lu lv aw lw bi"><span id="e731" class="lx jl in lt b gy ly lz l ma mb">declare @database varchar(max) = quotename(@databaseName)</span><span id="1fc3" class="lx jl in lt b gy mf lz l ma mb">EXEC('ALTER DATABASE ' + @database + ' SET SINGLE_USER WITH ROLLBACK IMMEDIATE')</span></pre><p id="b5d4" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">在运行 restore 命令之前，我们需要一些变量。</p><pre class="ll lm ln lo gt ls lt lu lv aw lw bi"><span id="62c3" class="lx jl in lt b gy ly lz l ma mb">// start with the base path and add DATA<br/>var dataPath = Path.Combine(options.Value.SqlServerBasePath, "DATA");</span><span id="a3ac" class="lx jl in lt b gy mf lz l ma mb">// Use the dataName for the mdf<br/>var fileListDataPath = Path.Combine(dataPath, $"{fileListDataName}.mdf");</span><span id="e4db" class="lx jl in lt b gy mf lz l ma mb">// Use the logName for the ldf<br/>var fileListLogPath = Path.Combine(dataPath, $"{fileListLogName}.ldf");</span></pre><p id="a326" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">接下来，我们需要运行实际的恢复命令。</p><pre class="ll lm ln lo gt ls lt lu lv aw lw bi"><span id="9980" class="lx jl in lt b gy ly lz l ma mb">RESTORE DATABASE @databaseName</span><span id="4204" class="lx jl in lt b gy mf lz l ma mb">FROM DISK = @localDatabasePath</span><span id="8032" class="lx jl in lt b gy mf lz l ma mb">WITH REPLACE,</span><span id="096e" class="lx jl in lt b gy mf lz l ma mb">MOVE @fileListDataName to @fileListDataPath,</span><span id="d166" class="lx jl in lt b gy mf lz l ma mb">MOVE @fileListLogName to @fileListLogPath</span></pre><p id="6a47" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">给定数据库名称、本地数据库路径、文件列表数据名称、文件列表日志名称以及它们的路径，使用路径{本地数据库路径}替换(WITH REPLACE 表示它将覆盖现有的数据库，<a class="ae mg" href="https://docs.microsoft.com/en-us/sql/t-sql/statements/restore-statements-transact-sql?view=sql-server-ver15#REPLACEoption" rel="noopener ugc nofollow" target="_blank">来恢复数据库{databaseName}，在使用此处说明的内容时要小心，因为它将覆盖适当的检查以防止数据丢失</a>)，同时指定移动的位置。mdf 和。ldf 文件。</p><p id="8bd9" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">这样做之后，我们需要将数据库设置回 MULTI_USER，所以让我们运行以下命令</p><pre class="ll lm ln lo gt ls lt lu lv aw lw bi"><span id="247c" class="lx jl in lt b gy ly lz l ma mb">declare @database varchar(max) = quotename(@databaseName)</span><span id="1ac0" class="lx jl in lt b gy mf lz l ma mb">EXEC('ALTER DATABASE ' + @database + ' SET MULTI_USER')</span></pre><h1 id="a934" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">GitHub 存储库</h1><p id="63bc" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">要查看整个项目，请查看 GitHub 存储库。</p><p id="6ab2" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated"><a class="ae mg" href="https://github.com/joemoceri/database-toolkit" rel="noopener ugc nofollow" target="_blank">https://github.com/joemoceri/database-toolkit</a></p></div></div>    
</body>
</html>