<html>
<head>
<title>Advanced Feature Toggle using Unleash (Java Implementation)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Unleash 切换高级功能(Java 实现)</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/advanced-feature-toggle-using-unleash-java-implementation-5d5e95ed6052?source=collection_archive---------3-----------------------#2022-06-21">https://blog.devgenius.io/advanced-feature-toggle-using-unleash-java-implementation-5d5e95ed6052?source=collection_archive---------3-----------------------#2022-06-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/27a8e6112498f6f1481570572765f1fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/1*GDQnf0CgffQPJ1y60J3WYA.gif"/></div></figure><p id="450f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir"> <em class="ks">在本帖中，我们将介绍功能切换的一个高级用例，以及 Unleash 如何通过客户端和由 Unleash 提供的 Java SDK 帮助实现这一点。</em>T3】</strong></p><p id="f58b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果你不熟悉功能切换，它的好处，释放，如何设置，以及它将如何帮助实现功能切换，这里是你可以参考的<a class="ae kt" rel="noopener ugc nofollow" target="_blank" href="/feature-toggle-using-unleash-d19d17d0366d">帖子</a></p><p id="f99a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">上面的帖子将涵盖什么是策略，但我们将深入探讨每一个策略，以及在何种情况下它可能是有用的，以及如何实现自定义激活策略</p></div><div class="ab cl ku kv hu kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="ij ik il im in"><p id="eab6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">释放中的策略是什么？</strong></p><p id="e2e0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">策略是一种条件，通过评估来决定切换是打开还是关闭。“释放”提供了一个内置激活策略列表，可用于决定触发条件。</p><p id="8a87" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">多个策略可以与一个功能切换相关联。我们可以定义一个策略，并在多个切换中重用相同的策略</p><p id="93c0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">下面是每次切换检查时由 Unleash SDK 评估的代码</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="859f" class="lk ll iq lg b gy lm ln l lo lp">private boolean checkEnabled(String toggleName, UnleashContext context, BiFunction&lt;String, UnleashContext, Boolean&gt; fallbackAction) {<br/>        this.checkIfToggleMatchesNamePrefix(toggleName);<br/>        FeatureToggle featureToggle = this.toggleRepository.getToggle(toggleName);<br/>        UnleashContext enhancedContext = context.applyStaticFields(this.config);<br/>        boolean enabled;<br/>        if (featureToggle == null) {<br/>            enabled = (Boolean)fallbackAction.apply(toggleName, enhancedContext);<br/>        } else if (!featureToggle.isEnabled()) {<br/>            enabled = false;<br/>        } else {<br/>            if (featureToggle.getStrategies().size() == 0) {<br/>                return true;<br/>            }</span><span id="7d45" class="lk ll iq lg b gy lq ln l lo lp">enabled = featureToggle.getStrategies().stream().anyMatch((strategy) -&gt; {<br/>                Strategy configuredStrategy = this.getStrategy(strategy.getName());<br/>                if (configuredStrategy == UNKNOWN_STRATEGY) {<br/>                    LOGGER.warn("Unable to find matching strategy for toggle:{} strategy:{}", toggleName, strategy.getName());<br/>                }</span><span id="cc13" class="lk ll iq lg b gy lq ln l lo lp">return configuredStrategy.isEnabled(strategy.getParameters(), enhancedContext, strategy.getConstraints());<br/>            });<br/>        }</span><span id="b0fa" class="lk ll iq lg b gy lq ln l lo lp">return enabled;<br/>    }</span></pre><p id="5e41" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">对于每个切换，都有 2 个检查是由释放 SDK 在内部进行的</p><p id="22bb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">1.检查该功能本身是开还是关(第 8 行)</p><p id="f192" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">2.为了检查是否有与该特性相关联的策略，以及是否有一个以上的策略可用于切换，SDK 检查是否有任何条件(我们将很快看到每个策略内部检查的具体内容)评估为真(第 15 行)。</p><p id="3d2a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">请检查 configuredStrategy.isEnabled 方法的第一个参数</p><p id="f2eb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir"> strategy.getParameters() </strong>它将包含在客户端 UI 中为策略配置的参数。SDK 确保将这些值作为带有键和值的映射从 UI 中传递(键和值是专门为切换配置的)。</p><p id="12f9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">下面是现成可用的策略选项列表。为了在我们的 SDK 中使用它们，我们不需要任何改变，因为 SDK 包含了它们的实现。</p><ul class=""><li id="44ac" class="lr ls iq jw b jx jy kb kc kf lt kj lu kn lv kr lw lx ly lz bi translated"><strong class="jw ir">标准</strong> —默认策略，意味着要么全部开启，要么全部关闭</li></ul><p id="c039" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这是最简单和最直接的策略，可用于释放，如果你想采取二元决策的 100%的流量，然后这是要使用的策略。</p><p id="bb2b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">Unleash SDK 提供的默认实现如下所示</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="69a1" class="lk ll iq lg b gy lm ln l lo lp">public final class DefaultStrategy implements Strategy {<br/>    private static final String STRATEGY_NAME = "default";</span><span id="5fdc" class="lk ll iq lg b gy lq ln l lo lp">public DefaultStrategy() {<br/>    }</span><span id="a7cc" class="lk ll iq lg b gy lq ln l lo lp">public String getName() {<br/>        return "default";<br/>    }</span><span id="fc64" class="lk ll iq lg b gy lq ln l lo lp">public boolean isEnabled(Map&lt;String, String&gt; parameters) {<br/>        return true;<br/>    }<br/>}</span></pre><p id="2f31" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">正如您所看到的，因为它是针对 100%的用户的，所以策略评估的默认实现总是返回 TRUE，这使得特性的开/关是唯一的决定因素</p><ul class=""><li id="8f66" class="lr ls iq jw b jx jy kb kc kf lt kj lu kn lv kr lw lx ly lz bi translated"><strong class="jw ir">用户标识</strong> —我们可以在 Unleash UI 中定义一个用户标识列表，只有那些已定义的用户，切换才会处于打开状态，而其他用户则处于关闭状态</li></ul><p id="c2f8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">一旦创建了一个切换，您需要在 UI 中专门添加策略，如下所示(点击配置用户 id)</p><figure class="lb lc ld le gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi ma"><img src="../Images/4caa64115c0fe7da5672d6e3a785fd46.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*EuFHd0AwdNXkWP7Q.png"/></div></div></figure><p id="18d8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在下一个屏幕中，您应该可以选择将用户 id 列表指定为逗号分隔的值。</p><figure class="lb lc ld le gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi mf"><img src="../Images/eaef7ee79204561a7b5b60b0906555e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*H-AdL94q1CTsWuWF.png"/></div></div></figure><p id="2da0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">并点击保存。下一个屏幕将显示为特性切换配置的策略列表，请注意，至少需要一个与切换相关的策略。</p><figure class="lb lc ld le gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi mg"><img src="../Images/3124bbb7f0a4b02913e0e6dbcb36463d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*zVcB11YHLnk-fVbv.png"/></div></div></figure><p id="2c65" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">上面列出的 UserId 的值是特定于开关的，并且可以针对与之关联的每个开关进行更改。SDK 实现的 UserId 策略如下所示</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="eaf5" class="lk ll iq lg b gy lm ln l lo lp">public final class UserWithIdStrategy implements Strategy {<br/>    protected static final String PARAM = "userIds";<br/>    private static final String STRATEGY_NAME = "userWithId";</span><span id="4f45" class="lk ll iq lg b gy lq ln l lo lp">public UserWithIdStrategy() {<br/>    }</span><span id="6ef0" class="lk ll iq lg b gy lq ln l lo lp">public String getName() {<br/>        return "userWithId";<br/>    }</span><span id="0a6f" class="lk ll iq lg b gy lq ln l lo lp">public boolean isEnabled(Map&lt;String, String&gt; parameters) {<br/>        return false;<br/>    }</span><span id="ce3d" class="lk ll iq lg b gy lq ln l lo lp">public boolean isEnabled(Map&lt;String, String&gt; parameters, UnleashContext unleashContext) {<br/>        return (Boolean)unleashContext.getUserId().map((currentUserId) -&gt; {<br/>            return Optional.ofNullable((String)parameters.get("userIds")).map((userIdString) -&gt; {<br/>                return Arrays.asList(userIdString.split(",\\s?"));<br/>            }).filter((f) -&gt; {<br/>                return f.contains(currentUserId);<br/>            }).isPresent();<br/>        }).orElse(false);<br/>    }<br/>}</span></pre><p id="dad8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">isEnabled 方法的第一个参数是一个 Map <string string="">,它将包含一个以逗号分隔的 userIds 列表，如下所示</string></p><p id="c5a9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">密钥—用户标识</p><p id="d251" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">值— 1，2，3</p><p id="46b8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">isEnabled 方法的第二个参数是 UnleashContext，它包含以下属性</p><p id="7d0c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="ks"> appName </em></p><p id="78c2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="ks">环境</em></p><p id="a612" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir"> <em class="ks"> userId </em> </strong></p><p id="22ea" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="ks">会话 Id </em></p><p id="659d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="ks">远程地址</em></p><p id="ece4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="ks">映射&lt;字符串，字符串&gt;属性——可用于定制策略(我们将在本博客中看到)</em></p><p id="b9e0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这些是由 Unleash 提供的内置属性，以迎合各种激活策略。在这个上下文中，当 isEnabled()方法作为 UnleashContext 对象被调用时，应该为 userId 提供当前的 userId</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="85fe" class="lk ll iq lg b gy lm ln l lo lp">isEnabled(UnleashContext.builder().userId("1").build);</span></pre><p id="fa28" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">请注意，在上面的 isEnabled()方法调用中，只需要释放上下文，SDK 负责在内部调用策略，并传递在释放 UI 中配置的值作为逗号分隔值的映射(Key=userIds，value="1，2，3 ")。</p><p id="aeca" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">正如您在上面的代码中看到的，由 Unleash SDK 提供的现有实现试图检查 Unleash 上下文中存在的 userId 是否存在于地图中(userId 在 Unleash UI 中维护)</p><p id="31d7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我不包括其他策略的实现，因为他们将根据策略类型进行类似的检查。</p><p id="328a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">他们的实现可以在<a class="ae kt" href="https://github.com/Unleash/unleash-client-java/tree/main/src/main/java/io/getunleash/strategy" rel="noopener ugc nofollow" target="_blank"> <strong class="jw ir">释放 Java SDK Github </strong> </a>中看到</p><ul class=""><li id="915b" class="lr ls iq jw b jx jy kb kc kf lt kj lu kn lv kr lw lx ly lz bi translated"><strong class="jw ir">IP</strong>—我们可以在 Unleash UI 中定义一个 IP 地址列表，只有那些已定义的 IP，切换才会处于打开状态，而其他 IP 则处于关闭状态</li></ul><p id="7b88" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">与 UserId 策略类似，这需要在 unleash UI 中与 IP 地址列表一起设置，SDK 使用此数据来评估当前 IP 的切换是开/关</p><ul class=""><li id="04d0" class="lr ls iq jw b jx jy kb kc kf lt kj lu kn lv kr lw lx ly lz bi translated"><strong class="jw ir">主机名</strong> —我们可以在 Unleash UI 中定义一个主机名列表，只有那些已定义的主机名，切换才会处于打开状态，而对于其他主机名，切换会处于关闭状态</li><li id="9ad4" class="lr ls iq jw b jx mh kb mi kf mj kj mk kn ml kr lw lx ly lz bi translated"><strong class="jw ir">逐步推广</strong> —该策略将所有逐步推广策略合并为一个策略。我们可以在这个策略中定义粘性和展示百分比</li></ul><p id="1524" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">除了上述策略，我们还可以在 UI 中定义自己的定制策略，并定义其服务器端实现(我们将在另一篇博客中看到)。</p><p id="ffb9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">多个策略可以与一个功能切换相关联。我们可以定义一个策略，并在多个切换中重用相同的策略</p></div><div class="ab cl ku kv hu kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="ij ik il im in"><p id="1a8f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">什么是定制策略，如何创建定制策略？</p><p id="0e19" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">尽管 Unleash 提供了许多内置策略来解码 toggle 状态，但有时我们可能需要验证特定的规则，然后才能决定 toggle 是否打开/关闭，在这种情况下，我们可以创建<a class="ae kt" href="https://docs.getunleash.io/advanced/custom_activation_strategy" rel="noopener ugc nofollow" target="_blank">自定义策略</a>。</p><p id="6b92" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">例如，我们有一个应用程序，它从多个来源(店内订单、网站订单、管理订单、来自第三方的订单等)获取客户订单，对其进行处理，然后将汇总的订单发送给供应商。我们希望实现一个功能，其中订单可以包含与产品相关联的定制消息。但是在向公众发布这项功能之前，我们想尝试一下这个功能。因此，我们希望实现一个功能切换，仅当切换打开时，才在供应商订单上应用定制消息。</p><p id="ccd8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们希望只为管理订单测试这些订单，这些订单是在商店收集的，以便以风险较小的方式验证解决方案。</p><p id="0977" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因此，切换评估标准是</p><ul class=""><li id="de7c" class="lr ls iq jw b jx jy kb kc kf lt kj lu kn lv kr lw lx ly lz bi translated">订单类型应为“管理”</li><li id="0be9" class="lr ls iq jw b jx mh kb mi kf mj kj mk kn ml kr lw lx ly lz bi translated">交货类型应为“商店 _ 集合”</li></ul><p id="1cdc" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">由于我们有评估切换的定制需求，我们需要在 Unleash UI 中创建一个定制策略，并在服务器端实现该策略。</p><p id="1c9c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们看看如何创建和实现它</p><p id="86e8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">在 Unleash UI 中创建自定义策略</strong></p><p id="3e10" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">导航至释放 UI(如果您没有进行任何设置，请阅读<a class="ae kt" rel="noopener ugc nofollow" target="_blank" href="/feature-toggle-using-unleash-d19d17d0366d">此</a>)并点击配置(高级)&gt;策略</p><figure class="lb lc ld le gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi mm"><img src="../Images/a4a7ef1763cdff1cdd9fc49f54e714aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*QnnBeh70seU2LwHR.png"/></div></div></figure><p id="fbf8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">点击下一个屏幕上的新策略</p><figure class="lb lc ld le gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi mn"><img src="../Images/3505fa1008116d0a2e390781db97bf1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*CQm2rHRAwWwEOKIF.png"/></div></div></figure><p id="d7b0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">填充切换名称和描述</p><figure class="lb lc ld le gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi mo"><img src="../Images/8f74a4b8f922100c769d2349e9929d29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*tt7OTtgKxakeqT3U.png"/></div></div></figure><p id="3115" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">点击添加参数，然后点击“创建策略”</p><figure class="lb lc ld le gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi mp"><img src="../Images/075af764e61b34b755868a61fc1612af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*l-aJTC747wr3R_ZF.png"/></div></div></figure><p id="53f9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">一旦创建了策略，它就可以与任意数量的切换相关联。创建一个切换(您可以参考<a class="ae kt" rel="noopener ugc nofollow" target="_blank" href="/feature-toggle-using-unleash-d19d17d0366d">这篇</a>文章了解相关步骤)并通过点击屏幕下方的“添加策略”并选择新创建的策略来链接它</p><figure class="lb lc ld le gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi mq"><img src="../Images/23be1c13dd445fb34def1de07acc06c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*aBVLnUfsW5J1T4we.png"/></div></div></figure><p id="67ca" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为我们希望启用此新功能的策略填充值，并保存该策略</p><figure class="lb lc ld le gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi mr"><img src="../Images/0d14e653ccea6b53e91e4816f8469d46.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*VA43n4AH0hBrkw0H.png"/></div></div></figure></div><div class="ab cl ku kv hu kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="ij ik il im in"><p id="9d92" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">如何在服务器端实现自定义策略</strong></p><p id="de95" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">实现一个定制策略并使用它来决定切换状态将需要 2 个变化</p><ol class=""><li id="d431" class="lr ls iq jw b jx jy kb kc kf lt kj lu kn lv kr ms lx ly lz bi translated"><strong class="jw ir">实施自定义策略定义</strong></li></ol><p id="9905" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们需要实现由 Unleash 提供的策略接口</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="fe39" class="lk ll iq lg b gy lm ln l lo lp">import java.util.Arrays;<br/>import java.util.Map;</span><span id="0d8c" class="lk ll iq lg b gy lq ln l lo lp">import org.springframework.stereotype.Component;<br/>import org.springframework.util.ObjectUtils;</span><span id="324a" class="lk ll iq lg b gy lq ln l lo lp">import lombok.RequiredArgsConstructor;<br/>import no.finn.unleash.UnleashContext;<br/>import no.finn.unleash.strategy.Strategy;</span><span id="a9a4" class="lk ll iq lg b gy lq ln l lo lp"><a class="ae kt" href="http://twitter.com/Component" rel="noopener ugc nofollow" target="_blank">@Component</a><br/><a class="ae kt" href="http://twitter.com/RequiredArgsConstruc" rel="noopener ugc nofollow" target="_blank">@RequiredArgsConstruc</a>tor<br/>public class RolloutByOrderTypeDeliveryType implements Strategy {</span><span id="7d2a" class="lk ll iq lg b gy lq ln l lo lp">protected static final String STRATEGY_NAME = "rolloutByOrderTypeDeliveryType";<br/>    private static final String ORDER_TYPE_PARAM = "orderType";<br/>    private static final String DELIVERY_TYPE_PARAM = "deliveryType";<br/>    private static final String ALLOWED_ORDER_TYPES = "orderTypes";<br/>    private static final String ALLOWED_DELIVERY_TYPES = "deliveryTypes";</span><span id="7585" class="lk ll iq lg b gy lq ln l lo lp"><a class="ae kt" href="http://twitter.com/Override" rel="noopener ugc nofollow" target="_blank">@Override</a><br/>    public String getName() {<br/>        return STRATEGY_NAME;<br/>    }</span><span id="5a54" class="lk ll iq lg b gy lq ln l lo lp"><a class="ae kt" href="http://twitter.com/Override" rel="noopener ugc nofollow" target="_blank">@Override</a><br/>    public boolean isEnabled(Map&lt;String, String&gt; map) {<br/>        return false;<br/>    }</span><span id="b63c" class="lk ll iq lg b gy lq ln l lo lp">/**<br/>     * Evaluation method to analyse toggle state for the given order type and delivery type<br/>     * &lt;p&gt;<br/>     * parameters will contain the key value pairs maintained in Unleash UI for instance &lt;orderTypes,"admin1,admin2,admin3"&gt;<br/>     * unleashContext.properties should be populated with the current orders order type and delivery type by the calling method<br/>     * with key &lt;orderType,"admin1"&gt; and &lt;deliveryType,"store_collection"&gt;<br/>     *<br/>     * <a class="ae kt" href="http://twitter.com/param" rel="noopener ugc nofollow" target="_blank">@param</a> parameters<br/>     * <a class="ae kt" href="http://twitter.com/param" rel="noopener ugc nofollow" target="_blank">@param</a> unleashContext<br/>     * <a class="ae kt" href="http://twitter.com/return" rel="noopener ugc nofollow" target="_blank">@return</a><br/>     */<br/>    <a class="ae kt" href="http://twitter.com/Override" rel="noopener ugc nofollow" target="_blank">@Override</a><br/>    public boolean isEnabled(Map&lt;String, String&gt; parameters, UnleashContext unleashContext) {<br/>        if (parameters == null || unleashContext == null) {<br/>            return false;<br/>        }</span><span id="8756" class="lk ll iq lg b gy lq ln l lo lp">var orderType = unleashContext.getProperties().get(ORDER_TYPE_PARAM);<br/>        var deliveryType = unleashContext.getProperties().get(DELIVERY_TYPE_PARAM);<br/>        var allowedOrderTypes = parameters.get(ALLOWED_ORDER_TYPES);<br/>        var allowedDeliveryTypes = parameters.get(ALLOWED_DELIVERY_TYPES);</span><span id="13ca" class="lk ll iq lg b gy lq ln l lo lp">if (ObjectUtils.isEmpty(allowedOrderTypes) || ObjectUtils.isEmpty(allowedDeliveryTypes)) {<br/>            return false;<br/>        }</span><span id="618a" class="lk ll iq lg b gy lq ln l lo lp">return Arrays.asList(allowedOrderTypes.split(",\\s*")).stream().anyMatch(appIdList -&gt; appIdList.contains(orderType)) &amp;&amp;<br/>               Arrays.asList(allowedDeliveryTypes.split(",\\s*")).stream().anyMatch(institutionIdList -&gt; institutionIdList.contains(deliveryType));<br/>    }</span><span id="db5b" class="lk ll iq lg b gy lq ln l lo lp">}</span></pre><p id="381f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">请注意，该类用“@Component”进行了注释，因此它可以连接到 unleash config 类。</p><p id="9058" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">上面的实现需要被挂钩，以将配置作为 bean 释放，以便它在实例化期间被获取，并且在运行时释放将能够调用策略并传递 UI 中维护的值</p><p id="9c86" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">Bean 可能看起来像这样</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="7f73" class="lk ll iq lg b gy lm ln l lo lp"><a class="ae kt" href="http://twitter.com/Bean" rel="noopener ugc nofollow" target="_blank">@Bean</a><br/>    public Unleash unleash(final UnleashConfig unleashConfig, List&lt;Strategy&gt; strategies) {<br/>        return new DefaultUnleash(unleashConfig, strategies.toArray(Strategy[]::new));<br/>    }</span></pre><p id="3270" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">正如您在上面看到的，我们的新策略实现和内置策略实现将在实例化期间被挑选出来，并将被提供给释放配置</p><p id="3235" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir"> 2 使用切换按钮</strong></p><p id="5d1a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">一旦自定义策略实现并自动连接到释放配置，我们就可以开始调用释放 isEnabled 方法来决定切换是开还是关</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="287b" class="lk ll iq lg b gy lm ln l lo lp"><a class="ae kt" href="http://twitter.com/RequiredArgsConstruc" rel="noopener ugc nofollow" target="_blank">@RequiredArgsConstruc</a>tor<br/><a class="ae kt" href="http://twitter.com/Component" rel="noopener ugc nofollow" target="_blank">@Component</a><br/>public class MyService {</span><span id="38a0" class="lk ll iq lg b gy lq ln l lo lp">// Service provided by Unleash SDK which contains in built method to // perform the toggle evaluation<br/>private final Unleash unleash;</span><span id="d556" class="lk ll iq lg b gy lq ln l lo lp">/**<br/>     * Existing service which process order and pass order to suppliers<br/>     * If toggle is enabled, processOrder with custom message if not follows existing order process order flow<br/>     *<br/>     * <a class="ae kt" href="http://twitter.com/param" rel="noopener ugc nofollow" target="_blank">@param</a> order<br/>     * <a class="ae kt" href="http://twitter.com/return" rel="noopener ugc nofollow" target="_blank">@return</a><br/>     */<br/>    public OrderResponse processOrder(Order order) {</span><span id="668a" class="lk ll iq lg b gy lq ln l lo lp">        if (unleash.isEnabled("test_toggle_custom_strategy",  UnleashContext.builder().addProperty("orderType", order.getType()).addProperty("deliveryType", order.getDeliveryType()).build())) {<br/>            return processOrder(order, order.getMessages());<br/>        }</span><span id="a592" class="lk ll iq lg b gy lq ln l lo lp">        // Existing flow<br/>        return processOrder(order);<br/>    }<br/>}</span></pre><p id="cac3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">请注意，我们需要将切换名称和当前处理订单的现有订单类型和交付类型(作为映射)传递给 isEnabled 方法，该方法将调用我们提供的定制策略实现，并能够决定切换状态</p></div><div class="ab cl ku kv hu kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="ij ik il im in"><p id="6f88" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这个帖子就到这里，希望这个内容有用。另一篇文章再见！</p></div></div>    
</body>
</html>