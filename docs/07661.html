<html>
<head>
<title>Cross-Origin iframe communication with Window.postMessage</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">与 Window.postMessage 的跨源 iframe 通信</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/cross-origin-iframe-communication-with-window-postmessage-5b8648bbdff0?source=collection_archive---------9-----------------------#2022-04-13">https://blog.devgenius.io/cross-origin-iframe-communication-with-window-postmessage-5b8648bbdff0?source=collection_archive---------9-----------------------#2022-04-13</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="1280" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">使用浏览器的 Web API 在页面和嵌入其中的 iframe 之间安全地传递消息</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/2d6c9b6044ad792b45e55f3135be2fc2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7OJLmP2QEqAoxK3n-KhACg.png"/></div></div></figure><h1 id="cab1" class="ko kp in bd kq kr ks kt ku kv kw kx ky jt kz ju la jw lb jx lc jz ld ka le lf bi translated">🤔为什么我们需要跨源 iframe 通信？</h1><p id="fd4a" class="pw-post-body-paragraph lg lh in li b lj lk jo ll lm ln jr lo lp lq lr ls lt lu lv lw lx ly lz ma mb ig bi translated">假设您需要集成将作为应用程序一部分的“第三方服务”。</p><p id="00c6" class="pw-post-body-paragraph lg lh in li b lj mc jo ll lm md jr lo lp me lr ls lt mf lv lw lx mg lz ma mb ig bi translated">你们两家公司都只是初创公司，我们没有种类齐全的工具可以让我们的生活变得更轻松，所以我们选择<code class="fe mh mi mj mk b">iframe</code>作为第一选项。我们<em class="ml">必须</em>整合我们现有的测试版本。之后，我们将重构代码，并将使用 edge 技术，就像我们的经理承诺的那样(😉)</p><p id="52a0" class="pw-post-body-paragraph lg lh in li b lj mc jo ll lm md jr lo lp me lr ls lt mf lv lw lx mg lz ma mb ig bi translated">他们的应用程序(作为一个例子)可以显示私人信息，可能是一些实时的银行细节/运输/交易细节，只有在用户授权后才可用。</p><h1 id="1026" class="ko kp in bd kq kr ks kt ku kv kw kx ky jt kz ju la jw lb jx lc jz ld ka le lf bi translated">🤓有什么更好的解决方案？</h1><p id="7139" class="pw-post-body-paragraph lg lh in li b lj lk jo ll lm ln jr lo lp lq lr ls lt lu lv lw lx ly lz ma mb ig bi translated">最好的集成版本(IMHO)是获得一个包含组件、钩子、实用程序等的 react 库。，那将为我们做一切。例如，查看<a class="ae mm" href="https://stripe.com/docs/stripe-js/react" rel="noopener ugc nofollow" target="_blank"> React Stripe.js 组件</a>。退而求其次——采用开放 API(例如<a class="ae mm" href="https://stripe.com/docs/api" rel="noopener ugc nofollow" target="_blank"> Stripe API </a>)并实现我们自己的组件。</p><h1 id="9365" class="ko kp in bd kq kr ks kt ku kv kw kx ky jt kz ju la jw lb jx lc jz ld ka le lf bi translated">🤨我们要建造什么？</h1><h2 id="97e9" class="mn kp in bd kq mo mp dn ku mq mr dp ky lp ms mt la lt mu mv lc lx mw mx le my bi translated">💭想法总结</h2><p id="c725" class="pw-post-body-paragraph lg lh in li b lj lk jo ll lm ln jr lo lp lq lr ls lt lu lv lw lx ly lz ma mb ig bi translated">作为父应用程序，我们希望使用某种令牌在<code class="fe mh mi mj mk b">iframe</code>中登录，这样<code class="fe mh mi mj mk b">iframe</code>就可以显示相关信息。每隔 N 分钟(本例中为 5 秒)，我们的令牌就会过期，而<code class="fe mh mi mj mk b">iframe</code>需要请求另一个令牌。作为奖励，我们可以将一个主题从<em class="ml">暗</em>改为<em class="ml">亮</em>，这可能发生在双方。</p><p id="2136" class="pw-post-body-paragraph lg lh in li b lj mc jo ll lm md jr lo lp me lr ls lt mf lv lw lx mg lz ma mb ig bi translated">大多数情况下，我会列出只与<code class="fe mh mi mj mk b">iframe</code>和<code class="fe mh mi mj mk b">Web API</code>部分相关的代码，而不会专注于创建应用程序或解释<a class="ae mm" href="https://nextjs.org/docs/deployment#managed-nextjs-with-vercel" rel="noopener ugc nofollow" target="_blank"> <em class="ml">“如何部署到 Vercel】</em></a>。</p><p id="60ab" class="pw-post-body-paragraph lg lh in li b lj mc jo ll lm md jr lo lp me lr ls lt mf lv lw lx mg lz ma mb ig bi translated">父应用程序和子应用程序将是我们实际需要的实现。对于前端，我们将使用<a class="ae mm" href="https://nextjs.org/" rel="noopener ugc nofollow" target="_blank"> Next.js </a>和<a class="ae mm" href="https://chakra-ui.com/" rel="noopener ugc nofollow" target="_blank"> Chakra-UI </a>作为组件。我们将在<a class="ae mm" href="https://vercel.com/" rel="noopener ugc nofollow" target="_blank"> Vercel </a>和<a class="ae mm" href="https://www.netlify.com/" rel="noopener ugc nofollow" target="_blank"> Netlify </a>上部署应用程序(以实现真正的跨来源)。</p><p id="8293" class="pw-post-body-paragraph lg lh in li b lj mc jo ll lm md jr lo lp me lr ls lt mf lv lw lx mg lz ma mb ig bi translated">此外，我会使用 Nrwl Nx 的工作区来实现 monorepo，保持运行/构建过程无缝。</p><h1 id="a823" class="ko kp in bd kq kr ks kt ku kv kw kx ky jt kz ju la jw lb jx lc jz ld ka le lf bi translated">👨‍💻代码(如果您不想阅读简介，请跳到这里)</h1><h1 id="b0e1" class="ko kp in bd kq kr ks kt ku kv kw kx ky jt kz ju la jw lb jx lc jz ld ka le lf bi translated">🤖“通信员。”</h1><p id="d4fb" class="pw-post-body-paragraph lg lh in li b lj lk jo ll lm ln jr lo lp lq lr ls lt lu lv lw lx ly lz ma mb ig bi translated">🔗<a class="ae mm" href="https://iframe-communicator.vercel.app" rel="noopener ugc nofollow" target="_blank">iframe-communicator . vercel . app</a></p><p id="6243" class="pw-post-body-paragraph lg lh in li b lj mc jo ll lm md jr lo lp me lr ls lt mf lv lw lx mg lz ma mb ig bi translated">🔗github:<a class="ae mm" href="https://github.com/andriishupta/iframe-communicator" rel="noopener ugc nofollow" target="_blank">github.com/andriishupta/iframe-communicator</a></p><p id="1de5" class="pw-post-body-paragraph lg lh in li b lj mc jo ll lm md jr lo lp me lr ls lt mf lv lw lx mg lz ma mb ig bi translated">这是一个“特殊”的应用程序，你可以用它来进行<strong class="li io"> <em class="ml">真实世界的测试</em> </strong>，看看消息在你的应用程序中是如何工作的。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi mz"><img src="../Images/e3e4076062a9019f81b049825455b8d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2yUKdY_ZRLNSRJMI"/></div></div></figure><h1 id="ba6b" class="ko kp in bd kq kr ks kt ku kv kw kx ky jt kz ju la jw lb jx lc jz ld ka le lf bi translated">🧑父代码</h1><p id="bcf5" class="pw-post-body-paragraph lg lh in li b lj lk jo ll lm ln jr lo lp lq lr ls lt lu lv lw lx ly lz ma mb ig bi translated">🔗<a class="ae mm" href="https://cross-origin-iframe-communication-with-nextjs-parent-app.vercel.app/" rel="noopener ugc nofollow" target="_blank">将</a>链接到已部署的应用程序</p><p id="5042" class="pw-post-body-paragraph lg lh in li b lj mc jo ll lm md jr lo lp me lr ls lt mf lv lw lx mg lz ma mb ig bi translated">🔗源代码可在处复制<a class="ae mm" href="https://github.com/andriishupta/cross-origin-iframe-communication-with-nextjs/blob/main/packages/parent-app/pages/index.tsx" rel="noopener ugc nofollow" target="_blank"/></p><p id="6b27" class="pw-post-body-paragraph lg lh in li b lj mc jo ll lm md jr lo lp me lr ls lt mf lv lw lx mg lz ma mb ig bi translated">至于父应用，我们肯定会有<code class="fe mh mi mj mk b">iframe</code>呈现在我们这边。让我们从它开始:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi na"><img src="../Images/b42c4e73a25ad44ff19e4c9b378a4bcc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ueGHskSuftNdxsAL"/></div></div></figure><ul class=""><li id="419c" class="nb nc in li b lj mc lm md lp nd lt ne lx nf mb ng nh ni nj bi translated">iframeRef 是我们对 DOM 元素的<a class="ae mm" href="https://reactjs.org/docs/hooks-reference.html#useref" rel="noopener ugc nofollow" target="_blank"> React.js 引用</a>，所以我们可以稍后使用它</li><li id="22b5" class="nb nc in li b lj nk lm nl lp nm lt nn lx no mb ng nh ni nj bi translated">这将发送我的初始令牌</li></ul><p id="87be" class="pw-post-body-paragraph lg lh in li b lj mc jo ll lm md jr lo lp me lr ls lt mf lv lw lx mg lz ma mb ig bi translated">接下来:我们如何发送消息是<a class="ae mm" href="https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage" rel="noopener ugc nofollow" target="_blank"> Window.postMessage </a></p><blockquote class="np nq nr"><p id="eb4a" class="lg lh ml li b lj mc jo ll lm md jr lo ns me lr ls nt mf lv lw nu mg lz ma mb ig bi translated">window.postMessage()方法安全地启用窗口对象之间的跨原点通信；例如在页面和它所产生的弹出窗口之间，或者在页面和嵌入其中的 iframe 之间。</p></blockquote><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi nv"><img src="../Images/1556c3c68283fe149def31a49b9ed299.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*U2l1tjoYXi_p9OBj"/></div></div></figure><pre class="kd ke kf kg gt nw mk nx ny aw nz bi"><span id="ead4" class="mn kp in mk b gy oa ob l oc od">const postMessage = (message: Message) =&gt; { iframeRef.current.contentWindow.postMessage(message, CHILD_APP_URL); };</span></pre><p id="b353" class="pw-post-body-paragraph lg lh in li b lj mc jo ll lm md jr lo lp me lr ls lt mf lv lw lx mg lz ma mb ig bi translated"><code class="fe mh mi mj mk b">postMessage</code>以一个<code class="fe mh mi mj mk b">message: Message</code>作为参数——它是我们自己选择并与子 app 约定要通过的消息<strong class="li io">种类</strong>:</p><blockquote class="np nq nr"><p id="733b" class="lg lh ml li b lj mc jo ll lm md jr lo ns me lr ls nt mf lv lw nu mg lz ma mb ig bi translated"><em class="in">使用结构化克隆算法对数据进行序列化。这意味着您可以将各种各样的数据对象安全地传递到目标窗口，而不必自己序列化它们。</em></p></blockquote><p id="92bd" class="pw-post-body-paragraph lg lh in li b lj mc jo ll lm md jr lo lp me lr ls lt mf lv lw lx mg lz ma mb ig bi translated">为了发送实际的消息，我们使用<code class="fe mh mi mj mk b">iframeRef.current.contentWindow</code>作为我们的<code class="fe mh mi mj mk b">targetWindow</code>(来自文档)，该函数的第二个参数是<code class="fe mh mi mj mk b">targetOrigin</code>:</p><blockquote class="np nq nr"><p id="7cae" class="lg lh ml li b lj mc jo ll lm md jr lo ns me lr ls nt mf lv lw nu mg lz ma mb ig bi translated"><em class="in">指定要调度的事件的 targetWindow 的来源，可以是字符串“*”</em></p></blockquote><p id="1ea8" class="pw-post-body-paragraph lg lh in li b lj mc jo ll lm md jr lo lp me lr ls lt mf lv lw lx mg lz ma mb ig bi translated">我知道我的<code class="fe mh mi mj mk b">targetOrigin</code>，所以我通过它，并建议你不要忽视<a class="ae mm" href="https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage#security_concerns" rel="noopener ugc nofollow" target="_blank">安全风险</a>。</p><p id="5eb9" class="pw-post-body-paragraph lg lh in li b lj mc jo ll lm md jr lo lp me lr ls lt mf lv lw lx mg lz ma mb ig bi translated">最后但同样重要的是，我们想听听来自孩子的信息！</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi oe"><img src="../Images/a934b79bf5ccb41debdd6f8df949b03a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*AjRJW0meLCSxTPl-"/></div></div></figure><p id="c712" class="pw-post-body-paragraph lg lh in li b lj mc jo ll lm md jr lo lp me lr ls lt mf lv lw lx mg lz ma mb ig bi translated">安全和过滤:我们只接受我们确信的消息</p><p id="b635" class="pw-post-body-paragraph lg lh in li b lj mc jo ll lm md jr lo lp me lr ls lt mf lv lw lx mg lz ma mb ig bi translated">现在，让我们从<em class="ml"> MessageEvent </em>中获取数据，进行一些检查并按照业务逻辑行事:</p><p id="4748" class="pw-post-body-paragraph lg lh in li b lj mc jo ll lm md jr lo lp me lr ls lt mf lv lw lx mg lz ma mb ig bi translated"><em class="ml">*对于更多选项，这段代码可以用 switch/case(谁喜欢)、三元运算符或对象文字来改进。</em></p><p id="60f4" class="pw-post-body-paragraph lg lh in li b lj mc jo ll lm md jr lo lp me lr ls lt mf lv lw lx mg lz ma mb ig bi translated">最后添加一个监听器并返回一个回调函数来移除，这样当一个组件关闭时，您可以导航到另一个页面，在那里您不需要监听一个<code class="fe mh mi mj mk b">iframe</code>。</p><pre class="kd ke kf kg gt nw mk nx ny aw nz bi"><span id="7e32" class="mn kp in mk b gy oa ob l oc od">window.addEventListener('message', handler); return () = &gt; window.removeEventListener('message', handler);</span></pre><h1 id="a74f" class="ko kp in bd kq kr ks kt ku kv kw kx ky jt kz ju la jw lb jx lc jz ld ka le lf bi translated">👶子代码</h1><p id="bbe2" class="pw-post-body-paragraph lg lh in li b lj lk jo ll lm ln jr lo lp lq lr ls lt lu lv lw lx ly lz ma mb ig bi translated">🔗<a class="ae mm" href="https://lustrous-donut-e3b29a.netlify.app" rel="noopener ugc nofollow" target="_blank">将</a>链接到已部署的应用程序</p><p id="670f" class="pw-post-body-paragraph lg lh in li b lj mc jo ll lm md jr lo lp me lr ls lt mf lv lw lx mg lz ma mb ig bi translated">🔗此处可复制<a class="ae mm" href="https://github.com/andriishupta/cross-origin-iframe-communication-with-nextjs/blob/main/packages/child-app/pages/index.tsx" rel="noopener ugc nofollow" target="_blank">的源代码</a></p><p id="df4d" class="pw-post-body-paragraph lg lh in li b lj mc jo ll lm md jr lo lp me lr ls lt mf lv lw lx mg lz ma mb ig bi translated">对于子应用程序来说，方法是相同的，只是在哪里调用<em class="ml"> postMessage </em> — <code class="fe mh mi mj mk b">window.parent</code>。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi of"><img src="../Images/1ba3f2a11d126294bf87db553bc57584.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hlKbonw8DnjjV447"/></div></div></figure><p id="1763" class="pw-post-body-paragraph lg lh in li b lj mc jo ll lm md jr lo lp me lr ls lt mf lv lw lx mg lz ma mb ig bi translated">而监听消息在<code class="fe mh mi mj mk b">type</code>中有所不同。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi og"><img src="../Images/221cf6f4e453880e2e7baeb6fc8a1395.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*y0443w4eThRcywSL"/></div></div></figure><p id="dc5f" class="pw-post-body-paragraph lg lh in li b lj mc jo ll lm md jr lo lp me lr ls lt mf lv lw lx mg lz ma mb ig bi translated">🎨父应用:<a class="ae mm" href="https://cross-origin-iframe-communication-with-nextjs-parent-app.vercel.app" rel="noopener ugc nofollow" target="_blank">跨来源-iframe-communication-with-next..</a></p><p id="8183" class="pw-post-body-paragraph lg lh in li b lj mc jo ll lm md jr lo lp me lr ls lt mf lv lw lx mg lz ma mb ig bi translated">👨‍💻github:<a class="ae mm" href="https://github.com/andriishupta/cross-origin-iframe-communication-with-nextjs" rel="noopener ugc nofollow" target="_blank">github.com/andriishupta/cross-origin-iframe..</a></p><p id="1aa0" class="pw-post-body-paragraph lg lh in li b lj mc jo ll lm md jr lo lp me lr ls lt mf lv lw lx mg lz ma mb ig bi translated">🤖"沟通者":<a class="ae mm" href="https://iframe-communicator.vercel.app" rel="noopener ugc nofollow" target="_blank">iframe-Communicator . vercel . app</a></p><p id="76a2" class="pw-post-body-paragraph lg lh in li b lj mc jo ll lm md jr lo lp me lr ls lt mf lv lw lx mg lz ma mb ig bi translated">👨‍💻“沟通者”的 github:<a class="ae mm" href="https://github.com/andriishupta/cross-origin-iframe-communication-with-nextjs" rel="noopener ugc nofollow" target="_blank">github.com/andriishupta/cross-origin-iframe..</a></p><h1 id="4186" class="ko kp in bd kq kr ks kt ku kv kw kx ky jt kz ju la jw lb jx lc jz ld ka le lf bi translated">📝摘要</h1><p id="f3cc" class="pw-post-body-paragraph lg lh in li b lj lk jo ll lm ln jr lo lp lq lr ls lt lu lv lw lx ly lz ma mb ig bi translated">跨源 iframe 通信在特定情况下会非常方便，我们完全可以利用双向消息传递来使其更加动态。单击示例，自己检查一下。</p><p id="5759" class="pw-post-body-paragraph lg lh in li b lj mc jo ll lm md jr lo lp me lr ls lt mf lv lw lx mg lz ma mb ig bi translated">感谢阅读！</p></div><div class="ab cl oh oi hr oj" role="separator"><span class="ok bw bk ol om on"/><span class="ok bw bk ol om on"/><span class="ok bw bk ol om"/></div><div class="ig ih ii ij ik"><p id="cf70" class="pw-post-body-paragraph lg lh in li b lj mc jo ll lm md jr lo lp me lr ls lt mf lv lw lx mg lz ma mb ig bi translated"><em class="ml">原载于</em><a class="ae mm" href="https://andriishupta.dev/cross-origin-iframe-communication-with-window-post-message" rel="noopener ugc nofollow" target="_blank"><em class="ml">https://blog . andriishupta . dev</em></a><em class="ml">。</em></p></div></div>    
</body>
</html>