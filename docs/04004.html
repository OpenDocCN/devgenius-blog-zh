<html>
<head>
<title>Malformed Lambda Proxy Response — What causes it and how to fix it?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Lambda 代理响应格式错误——是什么原因导致的，如何修复？</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/malformed-lambda-proxy-response-what-causes-it-and-how-to-fix-b0e5dfcf5d42?source=collection_archive---------0-----------------------#2021-01-14">https://blog.devgenius.io/malformed-lambda-proxy-response-what-causes-it-and-how-to-fix-b0e5dfcf5d42?source=collection_archive---------0-----------------------#2021-01-14</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/f93cc17e46e3afd6ad12071d505bf19d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hhJb6wHFRGQDGwhdOfFu5g.png"/></div></div></figure><p id="a70b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">当人们试图用<a class="ae kt" href="https://dashbird.io/knowledge-base/api-gateway/what-is-aws-api-gateway/" rel="noopener ugc nofollow" target="_blank"> AWS API Gateway </a>和<a class="ae kt" href="https://dashbird.io/knowledge-base/aws-lambda/introduction-to-aws-lambda/" rel="noopener ugc nofollow" target="_blank"> AWS Lambda </a>构建无服务器应用时，经常出现的一个问题是<em class="ku">由于配置错误而执行失败:畸形的 Lambda 代理响应。</em></p><p id="8b57" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">没有什么比一般的错误消息更糟糕的了，它没有告诉你任何需要修复的问题，对吗？AWS 并不以它的错误信息设计而闻名，如果你可以称之为错误信息设计的话，更不用说为你提供解决问题的方法了。那么如何修复这个 Lambda 错误，是什么原因造成的呢？</p><h1 id="c64b" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">修复格式错误的 Lambda 代理响应</h1><p id="9730" class="pw-post-body-paragraph jv jw in jx b jy lt ka kb kc lu ke kf kg lv ki kj kk lw km kn ko lx kq kr ks ig bi translated">为了解决这个问题，你需要<strong class="jx io">改变你的</strong> <a class="ae kt" href="https://dashbird.io/knowledge-base/aws-lambda/anatomy-of-a-lambda-function/" rel="noopener ugc nofollow" target="_blank"> <strong class="jx io"> Lambda 函数</strong> </a> <strong class="jx io">返回的</strong>。为此，您需要返回一个具有两个属性的对象:</p><ul class=""><li id="dadf" class="ly lz in jx b jy jz kc kd kg ma kk mb ko mc ks md me mf mg bi translated"><code class="fe mh mi mj mk b">statusCode</code>–这是您希望为您的客户端提供的 HTTP 状态代码，带有类型编号。</li><li id="37a0" class="ly lz in jx b jy ml kc mm kg mn kk mo ko mp ks md me mf mg bi translated"><code class="fe mh mi mj mk b">body </code>–这是您的 HTTP 响应的内容，类型为 string。</li></ul><p id="f114" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如果您使用了异步函数，它应该是这样的:</p><pre class="mq mr ms mt gt mu mk mv mw aw mx bi"><span id="f965" class="my kw in mk b gy mz na l nb nc">exports.handler = async function(event, context) {<br/>  return {statusCode: 200, body: "OK"};<br/>};</span></pre><p id="e0d6" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如果你是一个更有前途的开发人员，它应该是这样的:</p><pre class="mq mr ms mt gt mu mk mv mw aw mx bi"><span id="76b8" class="my kw in mk b gy mz na l nb nc">exports.handler = function(event, context) {<br/>  return new Promise(function(resolove, reject) {<br/>    resolve({statusCode: 200, body: "OK"});<br/>  });<br/>};</span></pre><p id="429f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">最后，如果你参加了复试，这将解决你的问题:</p><pre class="mq mr ms mt gt mu mk mv mw aw mx bi"><span id="14da" class="my kw in mk b gy mz na l nb nc">exports.handler = function(event, context, callback) {<br/>  callback({statusCode: 200, body: "OK"});<br/>};</span></pre><h1 id="efe1" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">了解格式错误的 Lambda 代理错误响应</h1><p id="e6f2" class="pw-post-body-paragraph jv jw in jx b jy lt ka kb kc lu ke kf kg lv ki kj kk lw km kn ko lx kq kr ks ig bi translated">如果您有时间，为什么不在这个过程中了解一下错误的“原因”呢？</p><p id="bc2d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">首先，<em class="ku">格式错误的 Lambda 代理响应</em>并不是真正的配置错误，因为<strong class="jx io">问题在于您的 Lambda 代码</strong>。但是，检查返回值的例程也可能检查其他可以从外部配置的东西，比如从 AWS CloudFormation。</p><p id="f52e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">但是错误消息中的代理部分呢？</p><p id="3dcd" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如果您在 AWS 控制台的 AWS API Gateway 中为您的 API 配置了一个路由，那么您需要<strong class="jx io">为该路由选择一个集成</strong>，在我们的例子中，是一个 Lambda 集成。这种集成是 AWS Lambda 和 AWS API 网关之间的粘合剂。毕竟，Lambda 不仅仅可以用于处理 API 网关请求。</p><p id="8b35" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如果你通过 CloudFormation 配置路线，事情会变得更清楚一些。</p><pre class="mq mr ms mt gt mu mk mv mw aw mx bi"><span id="7ca2" class="my kw in mk b gy mz na l nb nc">ExampleApi:<br/>  ...<br/>DefaultStage:<br/>  ...<br/>ExampleRoute:<br/>  Type: AWS::ApiGatewayV2::Route<br/>  Properties:<br/>    ApiId:<br/>      Ref: ExampleApi<br/>    RouteKey: ANY /<br/>    Target:<br/>      Fn::Join:<br/>        - integrations/<br/>        - Ref: ProxyIntegration<br/>ProxyIntegration:<br/>  Type: AWS::ApiGatewayV2::Integration<br/>  Properties:<br/>    ApiId:<br/>      Ref: ExampleApi<br/>    IntegrationType: AWS_PROXY<br/>    IntegrationUri:<br/>      Fn::GetAtt:<br/>        - ExampleFunction<br/>        - Arn<br/>    PayloadFormatVersion: "2.0"<br/>ExampleRole:<br/>  ...<br/>ExampleFunction:<br/>  Type: AWS::Lambda::Function<br/>  Properties:<br/>    Code:<br/>      ZipFile:<br/>        'exports.handler = async () =&gt; ({ statusCode: 200, body: "Example" });'<br/>    Handler: index.handler<br/>    Role:<br/>      Fn::GetAtt:<br/>        - ExampleRole<br/>        - Arn<br/>    Runtime: nodejs12.x<br/>  DependsOn:<br/>    - ExampleRole</span></pre><p id="da30" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我想你已经发现了这里的重点。我们在 AWS 控制台中创建的集成实际上是一种<strong class="jx io">特定类型的集成，称为</strong> <code class="fe mh mi mj mk b"><strong class="jx io">AWS_PROXY</strong></code>。它用于与许多 AWS 服务集成，AWS 控制台有一个很好的 UI，使与 Lambda 的集成更简单。</p><p id="8500" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">实际上有五种类型的 API 网关集成。三个用于 WebSockets 端点，两个用于 HTTP 端点。</p><h1 id="04ca" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">HTTP 集成类型</h1><p id="4012" class="pw-post-body-paragraph jv jw in jx b jy lt ka kb kc lu ke kf kg lv ki kj kk lw km kn ko lx kq kr ks ig bi translated">当您构建一个常规的 HTTP API 时。</p><ol class=""><li id="9861" class="ly lz in jx b jy jz kc kd kg ma kk mb ko mc ks nd me mf mg bi translated"><code class="fe mh mi mj mk b"><strong class="jx io">AWS_PROXY</strong></code>与 Lambda 或其他 AWS 服务集成，如 Step 函数。</li><li id="834c" class="ly lz in jx b jy ml kc mm kg mn kk mo ko mp ks nd me mf mg bi translated"><code class="fe mh mi mj mk b"><strong class="jx io">HTTP_PROXY</strong></code>将请求传递给另一个 HTTP 端点。</li></ol><h1 id="f721" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">WebSocket 集成类型</h1><p id="3d01" class="pw-post-body-paragraph jv jw in jx b jy lt ka kb kc lu ke kf kg lv ki kj kk lw km kn ko lx kq kr ks ig bi translated">当您构建基于 WebSocket 的 HTTP API 时。</p><ol class=""><li id="4521" class="ly lz in jx b jy jz kc kd kg ma kk mb ko mc ks nd me mf mg bi translated"><code class="fe mh mi mj mk b"><strong class="jx io">AWS</strong></code>与 Lambda 整合。</li><li id="c74c" class="ly lz in jx b jy ml kc mm kg mn kk mo ko mp ks nd me mf mg bi translated"><code class="fe mh mi mj mk b"><strong class="jx io">HTTP</strong></code>与其他(即第三方)HTTP APIs 集成。</li><li id="0f85" class="ly lz in jx b jy ml kc mm kg mn kk mo ko mp ks nd me mf mg bi translated"><code class="fe mh mi mj mk b"><strong class="jx io">MOCK</strong></code>让一个 WebSocket 端点像环回一样工作，不涉及任何其他服务。</li></ol><h1 id="1478" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">摘要</h1><p id="44e5" class="pw-post-body-paragraph jv jw in jx b jy lt ka kb kc lu ke kf kg lv ki kj kk lw km kn ko lx kq kr ks ig bi translated">对于开发人员来说，错误消息是一个常见的痛点，但通常修复起来非常简单。但是，如果您了解一些错误起源的背景，这将有助于在将来更快地修复它。</p><p id="a33b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">要了解更多关于特定的常见无服务器错误以及如何修复它们，请务必访问我们的<a class="ae kt" href="https://dashbird.io/event-library/" rel="noopener ugc nofollow" target="_blank">事件库</a>。</p></div></div>    
</body>
</html>