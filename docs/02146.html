<html>
<head>
<title>Deephaven System Monitoring Using Node.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Node.js进行Deephaven系统监控</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/deephaven-system-monitoring-using-node-js-37a928da4ab0?source=collection_archive---------23-----------------------#2020-07-20">https://blog.devgenius.io/deephaven-system-monitoring-using-node-js-37a928da4ab0?source=collection_archive---------23-----------------------#2020-07-20</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="3d80" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">如何设置外部监控和电子邮件提醒</h2></div><p id="f120" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">马修·鲁尼恩</p><figure class="kz la lb lc gt ld gh gi paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="gh gi ky"><img src="../Images/e169bc570b46a4837aa9fcb7a61ab194.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*wIqOFeoqUgs5M0Di"/></div></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">在<a class="ae lo" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae lo" href="https://unsplash.com/@krstoj?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Krsto Jevtic </a>拍摄的照片</figcaption></figure><h1 id="860c" class="lp lq in bd lr ls lt lu lv lw lx ly lz jt ma ju mb jw mc jx md jz me ka mf mg bi translated">为什么要监控持久查询？</h1><p id="b43f" class="pw-post-body-paragraph kc kd in ke b kf mh jo kh ki mi jr kk kl mj kn ko kp mk kr ks kt ml kv kw kx ig bi translated">Deephaven的持久查询应该是，顾名思义，持久的。但这并不意味着他们不会犯错。也许更新没有按计划进行，或者您的服务器正在耗尽分配日常查询的资源，或者您的查询耗尽了RAM。这可能会导致有问题的故障。令人欣慰的是，Deephaven让故障排除方法触手可及。其中一个选择是使用OpenAPI和Node.js从外部监控Deephaven。</p><p id="890e" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">监控可以通过4个简单的步骤完成:</p><ol class=""><li id="95a7" class="mm mn in ke b kf kg ki kj kl mo kp mp kt mq kx mr ms mt mu bi translated">连接到一个Deephaven实例(在这里了解这个<a class="ae lo" href="https://levelup.gitconnected.com/getting-started-with-deephaven-openapi-in-node-js-41f7dffe31e" rel="noopener ugc nofollow" target="_blank"/>)</li><li id="8ba9" class="mm mn in ke b kf mv ki mw kl mx kp my kt mz kx mr ms mt mu bi translated">配置通知服务</li><li id="4cb0" class="mm mn in ke b kf mv ki mw kl mx kp my kt mz kx mr ms mt mu bi translated">倾听失败</li><li id="fd3b" class="mm mn in ke b kf mv ki mw kl mx kp my kt mz kx mr ms mt mu bi translated">向电子邮件、Slack等发送失败通知。</li></ol><p id="9767" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">本文展示了一个如何使用Deephaven的OpenAPI和Node.js来轻松监控持久查询状态并在出现错误或失败时发送警告电子邮件的示例。(当然，您可以设置关于任何事情的警报，比如表更新。)</p><h1 id="1f47" class="lp lq in bd lr ls lt lu lv lw lx ly lz jt ma ju mb jw mc jx md jz me ka mf mg bi translated">连接到深水港</h1><p id="0eda" class="pw-post-body-paragraph kc kd in ke b kf mh jo kh ki mi jr kk kl mj kn ko kp mk kr ks kt ml kv kw kx ig bi translated">我们将使用“【Deephaven OpenAPI和Node.js 入门”中的基础项目作为起点。请注意，app.js中的代码使用了服务器位置和凭证的示例值，需要对这些值进行更改以匹配您的身份验证细节。本教程假设您已经有一些想要监控的持久查询。</p><p id="ab9f" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">下面是一些基于连接到深水港的启动代码的示例代码。连接后，它获得通知配置(配置细节)，然后创建我们的故障监视器。</p><figure class="kz la lb lc gt ld"><div class="bz fp l di"><div class="na nb l"/></div></figure><h1 id="233b" class="lp lq in bd lr ls lt lu lv lw lx ly lz jt ma ju mb jw mc jx md jz me ka mf mg bi translated">配置通知服务</h1><p id="d980" class="pw-post-body-paragraph kc kd in ke b kf mh jo kh ki mi jr kk kl mj kn ko kp mk kr ks kt ml kv kw kx ig bi translated">连接到Deephaven后，我们需要配置我们的认证服务。对于电子邮件通知，Nodemailer包(<a class="ae lo" href="https://nodemailer.com/" rel="noopener ugc nofollow" target="_blank">https://nodemailer.com/</a>)是一个不错的选择。要使用Nodemailer，我们必须用我们的电子邮件服务器选项创建一个传输对象。这个传送器可以用来发送信息。</p><p id="dc95" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">为了简化测试我们的电子邮件(并防止垃圾邮件进入我们的收件箱)，我们将使用Ethereal的测试帐户(<a class="ae lo" href="https://ethereal.email/" rel="noopener ugc nofollow" target="_blank">https://ethereal.email/</a>)，它很方便地包含在Nodemailer中。Ethereal允许您在浏览器中预览电子邮件，而无需发送电子邮件。如果你想发送真实的电子邮件，那么传送器需要反映你的实际电子邮件服务器配置。</p><p id="e7b8" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">创建节点邮件传输器的代码如下:</p><figure class="kz la lb lc gt ld"><div class="bz fp l di"><div class="na nb l"/></div></figure><h1 id="ec02" class="lp lq in bd lr ls lt lu lv lw lx ly lz jt ma ju mb jw mc jx md jz me ka mf mg bi translated">监听故障</h1><p id="594c" class="pw-post-body-paragraph kc kd in ke b kf mh jo kh ki mi jr kk kl mj kn ko kp mk kr ks kt ml kv kw kx ig bi translated">现在我们需要监控我们的持久查询是否失败。每个持久查询可以以几种状态之一存在，包括:</p><ul class=""><li id="29b6" class="mm mn in ke b kf kg ki kj kl mo kp mp kt mq kx nc ms mt mu bi translated">收购工人</li><li id="c0ec" class="mm mn in ke b kf mv ki mw kl mx kp my kt mz kx nc ms mt mu bi translated">正在初始化</li><li id="1915" class="mm mn in ke b kf mv ki mw kl mx kp my kt mz kx nc ms mt mu bi translated">运转</li><li id="5452" class="mm mn in ke b kf mv ki mw kl mx kp my kt mz kx nc ms mt mu bi translated">不成功的</li><li id="3e31" class="mm mn in ke b kf mv ki mw kl mx kp my kt mz kx nc ms mt mu bi translated">错误</li><li id="94ac" class="mm mn in ke b kf mv ki mw kl mx kp my kt mz kx nc ms mt mu bi translated">不连贯的</li><li id="197c" class="mm mn in ke b kf mv ki mw kl mx kp my kt mz kx nc ms mt mu bi translated">停止</li></ul><p id="0454" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">当前状态是查询配置的一部分。方便的是，OpenAPI提供了一种监听配置更新的方法，配置更新通常是由状态变化触发的。然后，我们可以检查每个配置更新的状态，以查看查询是否已经进入失败状态(“断开”、“错误”或“失败”)之一，并发送通知。</p><p id="2f5b" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">对于本例，我们将创建一个名为“PQAlertMonitor”的类来监视故障并发送通知。在这个类的构造函数中，我们将为持久查询配置更新添加事件侦听器，以便在我们创建该类的实例时立即开始监控。</p><p id="3366" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">构造函数代码如下:</p><figure class="kz la lb lc gt ld"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="c51f" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如上所述，有三种坏的状态我们想要被通知:“断开”、“错误”和“失败”。我们还需要从配置中收集一些关于查询失败的额外信息，这将有助于故障排除。一些有用的配置属性是<strong class="ke io">名称</strong>——查询的人类可读名称(例如，“我的查询”)——和<strong class="ke io">序列号</strong>——一个更有助于在日志中快速定位准确查询的唯一标识符。</p><p id="1d6e" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">检查查询是否处于错误状态的代码如下:</p><figure class="kz la lb lc gt ld"><div class="bz fp l di"><div class="na nb l"/></div></figure><h1 id="c457" class="lp lq in bd lr ls lt lu lv lw lx ly lz jt ma ju mb jw mc jx md jz me ka mf mg bi translated">发送失败消息</h1><p id="90c8" class="pw-post-body-paragraph kc kd in ke b kf mh jo kh ki mi jr kk kl mj kn ko kp mk kr ks kt ml kv kw kx ig bi translated">我们监控系统的最后一部分是实际发送信息。我们将只发送一个简单的消息，包含我们的查询、序列号和查询主机的名称。即使有数百个正在运行的持久查询，这些信息也应该足以准确定位您正在查找的查询。(Deephaven用户可能希望查看我们关于Deephaven内部表的文档，例如QueryPerformanceLog，以了解更多关于查找查询细节以及如何解决其糟糕状态的信息。)</p><p id="5e23" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">发送电子邮件的代码如下所示:</p><figure class="kz la lb lc gt ld"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="78ff" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这些消息可以很容易地与任何其他服务(Slack、SMS等)一起发送。)通过切换信使对象和相应的功能。我们使用Ethereal来轻松预览我们的电子邮件格式，如果需要，可以在不影响收件箱的情况下进行修改。Nodemailer允许您在Ethereal上检索消息的URL。下面显示了一个消息预览示例。</p><figure class="kz la lb lc gt ld gh gi paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="gh gi nd"><img src="../Images/ae593a30e55e3967f1455fd917f022b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*omUTD2yi8uAf-LtA"/></div></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">示例电子邮件</figcaption></figure><p id="c2c9" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">一旦对电子邮件的格式感到满意，就可以更改Nodemailer配置，使用实际的电子邮件服务器来代替Ethereal。</p><h1 id="e1aa" class="lp lq in bd lr ls lt lu lv lw lx ly lz jt ma ju mb jw mc jx md jz me ka mf mg bi translated">包扎</h1><p id="9ef9" class="pw-post-body-paragraph kc kd in ke b kf mh jo kh ki mi jr kk kl mj kn ko kp mk kr ks kt ml kv kw kx ig bi translated">在本文中，我们介绍了如何使用Node.js从外部监控Deephaven持久查询，以便在出现问题时发送通知。多亏了Deephaven的OpenAPI，代码变得简短、简单和直观。我们现在可以高枕无忧了，因为我们知道任何可能出现的持续查询失败都会被立即报告，并提供足够的详细信息来快速找到日志文件，从而解决问题。</p><p id="53ab" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在GitHub 上查看完整的项目。</p></div></div>    
</body>
</html>