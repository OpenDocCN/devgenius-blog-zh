<html>
<head>
<title>Debugging My Way Out Performance Issues in Azure SQL Database</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">调试Azure SQL数据库中的性能问题</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/debugging-my-way-out-performance-issues-in-azure-sql-database-9a1c9380cd1d?source=collection_archive---------4-----------------------#2020-07-17">https://blog.devgenius.io/debugging-my-way-out-performance-issues-in-azure-sql-database-9a1c9380cd1d?source=collection_archive---------4-----------------------#2020-07-17</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><h2 id="70c8" class="il im in bd b dl io ip iq ir is it dk iu translated" aria-label="kicker paragraph">Azure / SQL数据库</h2><div class=""/><div class=""><h2 id="c402" class="pw-subtitle-paragraph jt iw in bd b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk dk translated">我如何阻止Azure SQL数据库在随机时间变得难以忍受的慢。</h2></div><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/c679e5ef07f6d2f5af0d6bffc674d598.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*49WBKI-_la87Ji5d"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">Joshua Hoehne 在<a class="ae lb" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="2c99" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">我继承了一个<em class="ly">的遗留物</em> web API，并且我一直致力于支持一些试点项目。</p><p id="1d03" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">最近，它决定给我最好的礼物:不眠之夜试图找出性能问题。有时，<strong class="le ix">生产API中的一个端点会变得非常慢</strong>。从数据库中提取几个字节需要几分钟，计算利用率达到100%。这将持续几个小时，有时几天，然后自己恢复正常。绝望让我克服了对堆栈溢出提问的恐惧，从那里我得到了找到解决方案的工具。</p><p id="0c21" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">在这篇短文中，我想介绍一下我找到的<strong class="le ix">调试过程</strong>、<strong class="le ix">工具</strong>和<strong class="le ix">解决方案</strong>。希望它能帮助其他开发者克服他们自己的问题！</p><h1 id="5b45" class="lz ma in bd mb mc md me mf mg mh mi mj kc mk kd ml kf mm kg mn ki mo kj mp mq bi translated">起点</h1><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mr"><img src="../Images/b7bdae40e2fb628efde4a906d69af7bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6aX-4xCrMzVKvYgQ8U0ALA.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">架构的高级视图</figcaption></figure><p id="e500" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">该申请包括以下两个部分:</p><ul class=""><li id="a113" class="ms mt in le b lf lg li lj ll mu lp mv lt mw lx mx my mz na bi translated"><strong class="le ix"> API: </strong>用C#写的使用<strong class="le ix">。NET框架</strong> 4.6。它利用了使用<strong class="le ix">代码优先</strong>方法的<strong class="le ix">实体框架</strong> 6.2(简而言之，域模型是EF负责映射到数据库的C#类)。API作为Azure应用服务托管。</li><li id="b33e" class="ms mt in le b lf nb li nc ll nd lp ne lt nf lx mx my mz na bi translated"><strong class="le ix">数据库:</strong> Azure SQL数据库托管在Azure中(作为托管服务)，使用无服务器计划，自动从2个扩展到16个vCores。</li></ul><p id="3cb5" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated"><em class="ly">受牵连的</em>端点试图使用以下查询从数据库中检索传感器数据，执行了大约八次。每个调用都返回一个数据点(时间戳和值)。在正常情况下，通话大约需要一秒钟。在<em class="ly">倒霉的时候</em>，花了几分钟。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="ng nh l"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">导致性能问题的查询</figcaption></figure><h1 id="7cfd" class="lz ma in bd mb mc md me mf mg mh mi mj kc mk kd ml kf mm kg mn ki mo kj mp mq bi translated">调试:在堆栈溢出之前</h1><p id="166d" class="pw-post-body-paragraph lc ld in le b lf ni jx lh li nj ka lk ll nk ln lo lp nl lr ls lt nm lv lw lx ig bi translated">这一切都始于团队中令人担忧的消息:<em class="ly">应用程序没有响应，你能调查一下吗？从技术上来说，它并不是没有反应。这只是一个非常小的端点没有在合理的时间内响应。</em></p><p id="12ae" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated"><em class="ly">也许某个</em> <strong class="le ix"> <em class="ly"> bug被推上了生产？</em> </strong> <em class="ly"> </em>没有，最近没人碰生产代码。<em class="ly">也许</em> <strong class="le ix"> <em class="ly">它降级了我们的订阅？</em> </strong> <em class="ly"> </em>不，都是好的。<strong class="le ix"> <em class="ly"> DoS？</em> </strong>否，数据库和API端的CPU利用率都为零，也没有来自<a class="ae lb" href="https://docs.microsoft.com/en-us/azure/azure-monitor/app/app-insights-overview" rel="noopener ugc nofollow" target="_blank"> AppInsight </a>的请求记录。</p><p id="d4aa" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">然而，一些奇怪的事情引起了我的注意。如果我触发端点，我会看到<strong class="le ix">数据库计算利用率峰值达到最大值</strong>。这种情况以前从未发生过，分配给数据库的资源超过了预期的工作负载。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nn"><img src="../Images/5083c7acfacae296b5b7554f8efd62bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rCLybbgGUKEQQsAru7i7bQ.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">执行查询时数据库上的使用峰值，来自Azure门户指标</figcaption></figure><p id="fa3e" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">好了，<strong class="le ix">让我们深入研究一下代码</strong>。打开Visual Studio &gt;复制生产数据库的连接字符串&gt;调试&gt;打开<a class="ae lb" href="https://www.postman.com/" rel="noopener ugc nofollow" target="_blank">邮差</a>运行查询。<em class="ly"> </em>完美表现，结果不到一秒就回来了。<em class="ly">什么？</em>让我们在已部署的应用上再试一次。它没有反应。<em class="ly">什么？</em></p><p id="c324" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">让我们试试别的东西。打开<a class="ae lb" href="https://docs.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms?view=sql-server-ver15" rel="noopener ugc nofollow" target="_blank">SQL Server Management Studio</a>，运行<strong class="le ix">原始查询</strong>。完美的表现。<em class="ly">什么？</em></p><p id="5a02" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">好吧，也许是服务器坏了？让我们试试<strong class="le ix">在Azure中重启</strong>应用。不管用。<strong class="le ix">停止</strong>和<strong class="le ix">启动</strong>。不管用。<strong class="le ix">重新部署</strong>新版本。不管用。午休时间。</p><p id="4e43" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">午饭回来，应用程序<strong class="le ix">运行的很流畅</strong>，好像什么都没发生。<em class="ly">什么？</em></p><h1 id="9944" class="lz ma in bd mb mc md me mf mg mh mi mj kc mk kd ml kf mm kg mn ki mo kj mp mq bi translated">调试:堆栈溢出后</h1><p id="4288" class="pw-post-body-paragraph lc ld in le b lf ni jx lh li nj ka lk ll nk ln lo lp nl lr ls lt nm lv lw lx ig bi translated">它<em class="ly">自愈了</em>一次，但没有第二次。同样的故事，同样的尝试，浪费了一天时间查看应用洞察中的每个可能的指标和依赖关系。没什么有用的。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi no"><img src="../Images/a823425dd514a5870c8fc1009e925351.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4wN_VQFndcxd4MZF"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">绝对是个谜。照片由<a class="ae lb" href="https://unsplash.com/@kieran_wood?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">基兰伍德</a>在<a class="ae lb" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="298b" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">我决定<a class="ae lb" href="https://stackoverflow.com/questions/62890402/azure-net-framework-with-ef-code-first-and-microsoft-sql-server-sudden-cpu-s?noredirect=1#comment111218372_62890402" rel="noopener ugc nofollow" target="_blank">询问栈溢出</a>，考虑到我所掌握的信息很少，希望很小。幸运的是，SO用户<a class="ae lb" href="https://stackoverflow.com/users/639829/preben-huybrechts" rel="noopener ugc nofollow" target="_blank"> Preben Huybrechts </a>开始问一些非常有见地的问题。</p><blockquote class="np nq nr"><p id="bfe6" class="lc ld ly le b lf lg jx lh li lj ka lk ns lm ln lo nt lq lr ls nu lu lv lw lx ig bi translated">您是否有SensorInfoId、开始时间和结束时间的测量系列索引？你有测量时间的递减指数吗？你调查过锁定吗？可以用<a class="ae lb" href="https://github.com/amachanic/sp_whoisactive/blob/master/who_is_active.sql" rel="noopener ugc nofollow" target="_blank"> sp_whoisactive </a></p><p id="b4e6" class="lc ld ly le b lf lg jx lh li lj ka lk ns lm ln lo nt lq lr ls nu lu lv lw lx ig bi translated">分享你的<a class="ae lb" href="https://www.brentozar.com/sql/wait-stats/" rel="noopener ugc nofollow" target="_blank">等待统计数据</a>也会有所帮助。</p><p id="9fb8" class="lc ld ly le b lf lg jx lh li lj ka lk ns lm ln lo nt lq lr ls nu lu lv lw lx ig bi translated">如果可能，你也可以<a class="ae lb" href="https://www.brentozar.com/pastetheplan/" rel="noopener ugc nofollow" target="_blank">分享执行计划</a></p></blockquote><p id="74d6" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">是，我有所有那些索引。很好，更多的工具来帮助我调试！</p><p id="19e9" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated"><strong class="le ix"> sp_whoisactive是带我找到解决方案的工具</strong>。要使用它，请下载。sql文件，用Microsoft SQL Server Management Studio打开它，然后运行它。下次执行查询时，运行</p><pre class="km kn ko kp gt nv nw nx ny aw nz bi"><span id="406a" class="oa ma in nw b gy ob oc l od oe">EXEC sp_WhoIsActive<br/>@get_task_info = 2</span></pre><p id="47da" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">这个命令将为您提供一个关于谁在使用数据库以及如何使用数据库的详细概述。您可以查看作者的文档以获得广泛的信息。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi of"><img src="../Images/596343a2626c91f6f3338f39c89a8fce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-OQiPNUFyT2Ed1mCh322Iw.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">sp_WhoIsActive执行结果的示例视图。</figcaption></figure><p id="660b" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">我可以看到我正在测试的查询:除了让我抓狂的那个之外，都很快。那台挂着，<strong class="le ix">除了<em class="ly"> wait_info </em> </strong>之外，一切似乎都是正确的。这是一个读查询，没有其他正在进行的查询，没有锁，但是在那个列中写了一些东西:<strong class="le ix"> CXPACKET。</strong></p><p id="c861" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">正如Brent Ozar在<a class="ae lb" href="https://www.brentozar.com/archive/2013/08/what-is-the-cxpacket-wait-type-and-how-do-you-reduce-it/" rel="noopener ugc nofollow" target="_blank">发表的一篇非常清晰的文章</a>中所描述的，CXPACKET意味着有一个查询正在多个内核上执行，一些任务正在等待其他任务完成。如果与性能问题一起观察，这可能是一个迹象，表明存在<strong class="le ix">过度的并行化，这会降低查询的速度，而不是优化查询</strong>。</p><p id="d946" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">在SQL Server中，可以配置最大并行度(<em class="ly"> Max DOP </em>)，而<strong class="le ix">微软自己建议Max DOP为8 </strong>。但是，在SQL Server 2019之前，默认值是<em class="ly"> infinite </em> (0)，就像我的例子。</p><p id="adcd" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">通过<a class="ae lb" href="https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/configure-the-max-degree-of-parallelism-server-configuration-option?view=sql-server-ver15#SSMSProcedure" rel="noopener ugc nofollow" target="_blank">将MaxDOP </a>配置为8，应用程序又回到了<em class="ly">的工作状态。</em></p><h1 id="181a" class="lz ma in bd mb mc md me mf mg mh mi mj kc mk kd ml kf mm kg mn ki mo kj mp mq bi translated">我的解释</h1><p id="1387" class="pw-post-body-paragraph lc ld in le b lf ni jx lh li nj ka lk ll nk ln lo lp nl lr ls lt nm lv lw lx ig bi translated">即使问题得到了解决，找出为什么它只是偶尔发生，而且是在看似随机的情况下，仍然是一件有趣的事情。</p><p id="156f" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">有时，返回大量数据的传感器和时间间隔会触发相同的端点。我猜在那些情况下，<strong class="le ix">查询被认为是<em class="ly">慢的</em>并且随后像</strong>一样被优化，即使是在查询返回一小组数据的(最频繁的)情况下。除此之外，SQL数据库可以从2个扩展到16个vCores，从而提高可能的并行化水平。</p><h1 id="824d" class="lz ma in bd mb mc md me mf mg mh mi mj kc mk kd ml kf mm kg mn ki mo kj mp mq bi translated">TL；速度三角形定位法(dead reckoning)</h1><p id="4b65" class="pw-post-body-paragraph lc ld in le b lf ni jx lh li nj ka lk ll nk ln lo lp nl lr ls lt nm lv lw lx ig bi translated">SQL Server最大并行度(Max DOP)被配置为无穷大。该查询即使很小，也是在并发级别运行的，这使得它太慢了。</p><p id="11f1" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated"><strong class="le ix">将最大DOP更改为微软建议的8级，解决了该问题。</strong></p></div></div>    
</body>
</html>