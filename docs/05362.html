<html>
<head>
<title>How To Use Spring Security With SAML Protocol Binding</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在SAML协议绑定中使用Spring Security</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/how-to-use-spring-security-with-saml-protocol-binding-a4d48b847fc?source=collection_archive---------1-----------------------#2021-07-27">https://blog.devgenius.io/how-to-use-spring-security-with-saml-protocol-binding-a4d48b847fc?source=collection_archive---------1-----------------------#2021-07-27</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="3520" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在这篇文章中，我将展示如何使用Spring Security和SAML协议绑定来集成Keycloak身份提供者。如果你想了解如何使用Keycloak，你可以在这里阅读<a class="ae ki" href="https://betterjavacode.com/programming/spring-boot-application-keycloak" rel="noopener ugc nofollow" target="_blank"/>。</p><h1 id="4049" class="kj kk in bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">什么是SAML？</h1><p id="bc42" class="pw-post-body-paragraph jk jl in jm b jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc kd ll kf kg kh ig bi translated">SAML代表安全断言标记语言。它是服务提供商(SP)和身份提供商(IdP)之间交换身份验证和授权数据的开放标准。</p><p id="c0aa" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">身份提供者</strong> —执行认证并验证用户身份以获得授权，然后将其传递给服务提供者。</p><p id="8efa" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">服务提供者</strong> —信任身份提供者，并基于授权向用户提供对服务的访问。</p><h1 id="db2a" class="kj kk in bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">SAML认证流程</h1><p id="778b" class="pw-post-body-paragraph jk jl in jm b jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc kd ll kf kg kh ig bi translated">作为这个流程的一部分，我们将构建一个简单的待办事项列表应用程序。此后，用户将访问应用程序，并被重定向进行身份验证。</p><p id="b048" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> SAML认证用户流程:</strong></p><ol class=""><li id="d587" class="lm ln in jm b jn jo jr js jv lo jz lp kd lq kh lr ls lt lu bi translated">用户访问服务提供商(SP)待办事项列表应用程序。</li><li id="f373" class="lm ln in jm b jn lv jr lw jv lx jz ly kd lz kh lr ls lt lu bi translated">应用程序将用户重定向到Keycloak登录屏幕。在这个重定向过程中，应用程序向Keycloak IDP发送一个AuthnRequest。</li><li id="5248" class="lm ln in jm b jn lv jr lw jv lx jz ly kd lz kh lr ls lt lu bi translated">如果请求来自正确的依赖方/服务提供商，Keycloak IDP会验证该请求。它检查发行者和重定向URI (ACS URL)。</li><li id="5777" class="lm ln in jm b jn lv jr lw jv lx jz ly kd lz kh lr ls lt lu bi translated">Keycloak IDP将SAML响应发送回服务提供商。</li><li id="88e2" class="lm ln in jm b jn lv jr lw jv lx jz ly kd lz kh lr ls lt lu bi translated">服务提供商使用提供的IDP公共证书验证签名的响应。</li><li id="a234" class="lm ln in jm b jn lv jr lw jv lx jz ly kd lz kh lr ls lt lu bi translated">如果响应有效，我们将从断言中提取属性NameID，并让用户登录。</li></ol><figure class="mb mc md me gt mf gh gi paragraph-image"><div class="gh gi ma"><img src="../Images/1886319e0eb272c00042c0756d155c0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1250/0*J59CcEA--TrqFGlx"/></div></figure><p id="199c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">注意</strong>—<em class="mi">Spring Security SAML extension是一个用于提供SAML支持的库。但是在2018年之后，Spring安全团队移动了那个项目，现在支持SAML 2认证作为核心Spring安全的一部分</em>。</p><h1 id="9910" class="kj kk in bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">将Spring安全性与SAML协议绑定一起使用</h1><p id="8941" class="pw-post-body-paragraph jk jl in jm b jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc kd ll kf kg kh ig bi translated">因此，一旦您创建了一个Spring Boot项目，我们将需要导入以下依赖项。</p><pre class="mb mc md me gt mj mk ml mm aw mn bi"><span id="0886" class="mo kk in mk b gy mp mq l mr ms">dependencies {<br/>	implementation 'org.springframework.boot:spring-boot-starter-data-jpa'<br/>	implementation 'org.springframework.boot:spring-boot-starter-jdbc'<br/>	implementation 'org.springframework.boot:spring-boot-starter-thymeleaf'<br/>	implementation 'org.springframework.boot:spring-boot-starter-web'<br/>	/*<br/>	 * Spring Security<br/>	 */<br/>	implementation 'org.springframework.boot:spring-boot-starter-security'<br/>	runtimeOnly 'mysql:mysql-connector-java'<br/>	providedRuntime 'org.springframework.boot:spring-boot-starter-tomcat'<br/>	implementation 'org.springframework.security:spring-security-saml2-service-provider:5.3.5' +<br/>			'.RELEASE'<br/><br/>	/*<br/>	 * Keycloak<br/>	 */<br/>	implementation 'org.keycloak:keycloak-spring-boot-starter:11.0.3'<br/>	testImplementation('org.springframework.boot:spring-boot-starter-test') {<br/>		exclude group: 'org.junit.vintage', module: 'junit-vintage-engine'<br/>	}<br/>}</span></pre><p id="6856" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">相应地，依赖关系<code class="fe mt mu mv mk b">spring-security-saml2-service-provider</code>将允许我们添加依赖方注册。它还有助于身份提供商注册。</p><p id="8e39" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在，我们将在我们的<code class="fe mt mu mv mk b">SecurityConfig</code>中添加该注册，如下所示:</p><pre class="mb mc md me gt mj mk ml mm aw mn bi"><span id="4b9f" class="mo kk in mk b gy mp mq l mr ms">    @Bean<br/>    public RelyingPartyRegistrationRepository relyingPartyRegistrationRepository() throws CertificateException<br/>    {<br/>        final String idpEntityId = "http://localhost:8180/auth/realms/ToDoListSAMLApp";<br/>        final String webSSOEndpoint = "http://localhost:8180/auth/realms/ToDoListSAMLApp/protocol/saml";<br/>        final String registrationId = "keycloak";<br/>        final String localEntityIdTemplate = "{baseUrl}/saml2/service-provider-metadata" +<br/>                "/{registrationId}";<br/>        final String acsUrlTemplate = "{baseUrl}/login/saml2/sso/{registrationId}";<br/><br/><br/>        Saml2X509Credential idpVerificationCertificate;<br/>        try (InputStream pub = new ClassPathResource("credentials/idp.cer").getInputStream())<br/>        {<br/>            X509Certificate c = (X509Certificate) CertificateFactory.getInstance("X.509").generateCertificate(pub);<br/>            idpVerificationCertificate = new Saml2X509Credential(c, VERIFICATION);<br/>        }<br/>        catch (Exception e)<br/>        {<br/>            throw new RuntimeException(e);<br/>        }<br/><br/>        RelyingPartyRegistration relyingPartyRegistration = RelyingPartyRegistration<br/>                .withRegistrationId(registrationId)<br/>                .providerDetails(config -&gt; config.entityId(idpEntityId))<br/>                .providerDetails(config -&gt; config.webSsoUrl(webSSOEndpoint))<br/>                .providerDetails(config -&gt; config.signAuthNRequest(false))<br/>                .credentials(c -&gt; c.add(idpVerificationCertificate))<br/>                .assertionConsumerServiceUrlTemplate(acsUrlTemplate)<br/>                .build();<br/><br/>        return new InMemoryRelyingPartyRegistrationRepository(relyingPartyRegistration);<br/>    }</span></pre><p id="ffc7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们的登录也会随着<code class="fe mt mu mv mk b"> HttpSecurity</code>发生如下变化:</p><pre class="mb mc md me gt mj mk ml mm aw mn bi"><span id="3458" class="mo kk in mk b gy mp mq l mr ms">httpSecurity.authorizeRequests()<br/>.antMatchers("/js/**","/css/**","/img/**").permitAll()<br/>.antMatchers("/signup","/forgotpassword").permitAll()<br/>.antMatchers("/saml/**").permitAll()<br/>.anyRequest().authenticated()<br/>.and()<br/>.formLogin()<br/>.loginPage("/login").permitAll()<br/>.and()<br/>.saml2Login(Customizer.withDefaults()).exceptionHandling(exception -&gt;<br/>exception.authenticationEntryPoint(entryPoint()))<br/>.logout()<br/>.logoutUrl("/logout")<br/>.logoutSuccessHandler(logoutSuccessHandler)<br/>.deleteCookies("JSESSIONID")<br/>.permitAll();</span></pre><p id="cd51" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们现在用的是<code class="fe mt mu mv mk b"> saml2Login </code>。默认情况下，如果您访问该应用程序，它将重定向到身份提供商。我们希望在自定义登录页面被重定向到身份提供者keycloak之前对其进行配置。这就是为什么我们有<code class="fe mt mu mv mk b">authenticationEntryPoint</code>允许我们配置自定义登录页面。因此，现在如果我们在<code class="fe mt mu mv mk b">https://localhost:8743/login</code>访问我们的应用程序，我们将看到下面的登录页面:</p><figure class="mb mc md me gt mf gh gi paragraph-image"><div class="gh gi ma"><img src="../Images/f16fdbf396c3bd8f5588660f62e1cc9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1250/0*z6ot6nP0ovuuBh_c"/></div></figure><p id="99af" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">所以一旦你选择了<code class="fe mt mu mv mk b">Login with Keycloak SAML</code>的选项，它就会发送一个<code class="fe mt mu mv mk b">AuthnRequest</code>到Keycloak。此外，该请求是一个未签名的请求。Keycloak将发送一个签名的响应。控制器将接收该签名的响应以解码<code class="fe mt mu mv mk b">NameId</code>属性。</p><pre class="mb mc md me gt mj mk ml mm aw mn bi"><span id="c10a" class="mo kk in mk b gy mp mq l mr ms">@GetMapping(value="/index")<br/>public String getHomePage(Model model, @AuthenticationPrincipal Saml2AuthenticatedPrincipal saml2AuthenticatedPrincipal)<br/>{<br/>   String principal = saml2AuthenticatedPrincipal.getName();<br/>   model.addAttribute("username", principal);<br/>   return "index";<br/>}</span></pre><p id="0f11" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">一旦检索到<code class="fe mt mu mv mk b">NameId</code>，它将让用户登录。</p><h1 id="009d" class="kj kk in bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">键盘锁上的配置</h1><p id="39e6" class="pw-post-body-paragraph jk jl in jm b jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc kd ll kf kg kh ig bi translated">我们必须在Keycloak管理控制台中配置我们的应用程序。</p><ul class=""><li id="a916" class="lm ln in jm b jn jo jr js jv lo jz lp kd lq kh mw ls lt lu bi translated">为您的应用程序创建一个领域。</li><li id="0a25" class="lm ln in jm b jn lv jr lw jv lx jz ly kd lz kh mw ls lt lu bi translated">选择端点— SAML 2.0 IdP元数据</li><li id="0b0e" class="lm ln in jm b jn lv jr lw jv lx jz ly kd lz kh mw ls lt lu bi translated">在客户端—添加服务提供商。</li><li id="0d8a" class="lm ln in jm b jn lv jr lw jv lx jz ly kd lz kh mw ls lt lu bi translated">对于您的客户端，配置根URL、SAML处理URL(https://localhost:8743/SAML 2/service-provider-metadata/key cloak)</li><li id="b789" class="lm ln in jm b jn lv jr lw jv lx jz ly kd lz kh mw ls lt lu bi translated">您还可以调整其他设置，如签名断言，包括AuthnStatement。</li><li id="c90a" class="lm ln in jm b jn lv jr lw jv lx jz ly kd lz kh mw ls lt lu bi translated">当然，在“细粒度SAML端点配置”一节中配置ACS URL。</li></ul><figure class="mb mc md me gt mf gh gi paragraph-image"><div class="gh gi ma"><img src="../Images/cc724abb012eef0fdd815d1ace5e2c0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1250/0*VxC8dWnoJbPM5RPB"/></div></figure><h1 id="0f36" class="kj kk in bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">代码库</h1><p id="14aa" class="pw-post-body-paragraph jk jl in jm b jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc kd ll kf kg kh ig bi translated">这个项目的代码可以在我的<a class="ae ki" href="https://github.com/yogsma/betterjavacode/tree/main/todolistkeycloaksaml" rel="noopener ugc nofollow" target="_blank"> github库</a>中找到。我还在我的书《简化Spring安全》中详细介绍了这一点。想了解更多，可以在这里买我的书<a class="ae ki" href="https://yogsma.gumroad.com/l/VgSdH" rel="noopener ugc nofollow" target="_blank">。</a></p><h1 id="accf" class="kj kk in bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">结论</h1><p id="0ed9" class="pw-post-body-paragraph jk jl in jm b jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc kd ll kf kg kh ig bi translated">在这篇文章中，我展示了如何在SAML协议中使用Spring Security。这些年来，Spring安全性有了很多改进，现在它可以很容易地用于不同的协议，比如OAuth，OIDC。如果你喜欢这篇文章，请在这里订阅我的博客。</p></div><div class="ab cl mx my hr mz" role="separator"><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc"/></div><div class="ig ih ii ij ik"><p id="9849" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><em class="mi">原载于2021年7月27日https://betterjavacode.com</em><a class="ae ki" href="https://betterjavacode.com/programming/how-to-use-spring-security-with-saml-protocol-binding" rel="noopener ugc nofollow" target="_blank"><em class="mi"/></a><em class="mi">。</em></p></div></div>    
</body>
</html>