<html>
<head>
<title>How To Read and Write Files in a Web Application</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在 Web 应用程序中读写文件</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/how-to-read-and-write-files-in-a-web-application-ca52ec7e2f14?source=collection_archive---------12-----------------------#2022-08-15">https://blog.devgenius.io/how-to-read-and-write-files-in-a-web-application-ca52ec7e2f14?source=collection_archive---------12-----------------------#2022-08-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="1cb4" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">轻松高效地与文件交互</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/8b56cf43fe1889f03a85c0a2d1240892.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*suVgIqiVUhmDWcGI"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">布雷特·乔丹在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="b402" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">应用程序与本地文件交互是很常见的，但这在 web 应用程序中很难实现。主要是因为浏览器有保障的安全性。我们可以使用带有 IndexedDB API 的文件类型的 HTML input 元素来实现类似的东西，但这需要很多细节和精心制作。并且如果需要频繁操作，则性能可能不令人满意。</p><p id="6c85" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">文件系统访问 API 使 web 应用程序能够轻松高效地访问文件。具体来说，它允许 JavaScript 与用户本地设备或用户可访问的网络文件系统上的文件进行交互。这个 API 的核心功能包括读取文件、写入或保存文件以及访问目录结构。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="db42" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">访问单个文件</h1><p id="ba8f" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">在我们开始之前，我们需要知道文件系统访问特性只在<a class="ae kv" href="https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts" rel="noopener ugc nofollow" target="_blank">安全上下文</a> (HTTPS)，部分或全部<a class="ae kv" href="https://developer.mozilla.org/en-US/docs/Web/API/File_System_Access_API#browser_compatibility" rel="noopener ugc nofollow" target="_blank">支持浏览器</a>中可用。它不允许跨源，但我们可以在本地服务上测试。</p><p id="6e43" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要访问文件，我们可以使用<code class="fe mw mx my mz b">window.showOpenFilePicker</code>，但是它必须处理用户手势来显示文件选择器。如果我们直接调用它，它会:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi na"><img src="../Images/86bfe2e8f35429225924c832038836db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ykElIXMMYbVJOPbUbFkIDQ.png"/></div></div></figure><p id="cc7e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">以下代码允许用户从文件选取器中选择一个文件:</p><pre class="kg kh ki kj gt nb mz nc nd aw ne bi"><span id="b69f" class="nf ma iq mz b gy ng nh l ni nj">&lt;button id="pick"&gt;Click&lt;/button&gt;<br/>&lt;script&gt;<br/>  const getFile = async () =&gt; {<br/>    // open file picker<br/>    const [fileHandle] = await window.showOpenFilePicker();<br/>    console.log('fileHandle: ', fileHandle);</span><span id="11cb" class="nf ma iq mz b gy nk nh l ni nj">    const file = await fileHandle.getFile();<br/>    console.log('file: ', file);</span><span id="024a" class="nf ma iq mz b gy nk nh l ni nj">    const content = await file.text();<br/>    console.log('content: ', content);</span><span id="93c0" class="nf ma iq mz b gy nk nh l ni nj">    };</span><span id="9c77" class="nf ma iq mz b gy nk nh l ni nj">    const btn = document.getElementById('pick');<br/>    btn.addEventListener('click', () =&gt; {<br/>      getFile();<br/>    });<br/>&lt;/script&gt;</span></pre><p id="55cf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果我们选择了一个<code class="fe mw mx my mz b">document.txt</code>文件:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nl"><img src="../Images/4e3422f37e2591641afafb1e16766243.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YjvKIqVbhK3iDLS63jvzSg.png"/></div></div></figure><p id="4145" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">细心的你可能会发现，我们在这里解构的是数组的第一项，<code class="fe mw mx my mz b">showOpenFilePicker</code>实际上会返回<code class="fe mw mx my mz b"><a class="ae kv" href="https://wicg.github.io/file-system-access/#api-filesystemfilehandle" rel="noopener ugc nofollow" target="_blank">FileSystemFileHandle</a></code> objects 数组。我将在下面描述如何支持多个文件。</p><h1 id="ffb7" class="lz ma iq bd mb mc nm me mf mg nn mi mj jw no jx ml jz np ka mn kc nq kd mp mq bi translated">访问多个文件:</h1><p id="9ed7" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">要访问多个文件，只需将一个选项配置传递给<code class="fe mw mx my mz b">showOpenFilePicker</code>:</p><pre class="kg kh ki kj gt nb mz nc nd aw ne bi"><span id="f64b" class="nf ma iq mz b gy ng nh l ni nj">const getFile = async () =&gt; {<br/>  const options = {<br/>    <strong class="mz ir">multiple: true,</strong><br/>  };</span><span id="a41a" class="nf ma iq mz b gy nk nh l ni nj">  // open file picker<br/>  const fileHandles = await window.showOpenFilePicker(options);<br/>  console.log('fileHandles: ', fileHandles);<br/>};</span></pre><p id="b3ca" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">默认情况下，multiple 属性值为 false。此外，还有其他配置项可供选择。比如我们只想接受<code class="fe mw mx my mz b">.png</code>文件，那么<code class="fe mw mx my mz b">options</code>可以是这样的:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nr"><img src="../Images/38a576a85bd3ee92d822244b65eaf9f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SvEg0meD6TwTMIbt-2o4Hw.png"/></div></div></figure><p id="f6d9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下面是 MDN 上对<code class="fe mw mx my mz b"><a class="ae kv" href="https://developer.mozilla.org/en-US/docs/Web/API/window/showOpenFilePicker#parameters" rel="noopener ugc nofollow" target="_blank">options</a></code>更详细的描述。以下是选择的截图:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/c108cef3eef397d90563c31a975f1845.png" data-original-src="https://miro.medium.com/v2/resize:fit:1176/format:webp/1*SklVZkyEqUuA-JRMmS7CXg.png"/></div></figure><h1 id="29a9" class="lz ma iq bd mb mc nm me mf mg nn mi mj jw no jx ml jz np ka mn kc nq kd mp mq bi translated">写入文件</h1><p id="816c" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">我们也可以使用<code class="fe mw mx my mz b">Window.showSaveFilePicker()</code>来显示一个允许用户保存文件的文件选择器。可以用新文件名或现有文件名保存(完全覆盖)。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/6053a1f60ee428d74588b019198e862b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1214/format:webp/1*u_LaLhpAJ0i_NM3BSwdg2w.png"/></div></figure><p id="d4f6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">请参见代码中的注释。值得一提的是，除了写 blobs，还可以是简单的字符串，还可以有更高级的特性:</p><pre class="kg kh ki kj gt nb mz nc nd aw ne bi"><span id="3ad6" class="nf ma iq mz b gy ng nh l ni nj">// just pass in the data (no options)<br/>writableStream.write(data);</span><span id="e82b" class="nf ma iq mz b gy nk nh l ni nj">// writes the data to the stream from the determined position<br/>writableStream.write({ type: "write", position, data });</span><span id="530c" class="nf ma iq mz b gy nk nh l ni nj">// updates the current file cursor offset to the position specified<br/>writableStream.write({ type: "seek", position });</span><span id="d8c9" class="nf ma iq mz b gy nk nh l ni nj">// resizes the file to be size bytes long<br/>writableStream.write({ type: "truncate", size });</span></pre><p id="3197" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">点击后截图:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/ad8eec70839efbda86e175a91681a69a.png" data-original-src="https://miro.medium.com/v2/resize:fit:656/format:webp/1*crl5qJBrXdhjYb3kRDf3hQ.png"/></div></figure><p id="d0ef" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们也可以配置<code class="fe mw mx my mz b"><a class="ae kv" href="https://developer.mozilla.org/en-US/docs/Web/API/window/showSaveFilePicker#parameters" rel="noopener ugc nofollow" target="_blank">options</a></code>来实现一些其他功能，如建议文件名等。</p><h2 id="112f" class="nf ma iq bd mb nv nw dn mf nx ny dp mj lf nz oa ml lj ob oc mn ln od oe mp of bi translated">编辑现有文件</h2><p id="b200" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">编辑现有文件与此类似:</p><pre class="kg kh ki kj gt nb mz nc nd aw ne bi"><span id="1b32" class="nf ma iq mz b gy ng nh l ni nj">const writeFile = async () =&gt; {<br/>  const blob = new Blob(['&lt;body&gt;Hello World!&lt;/body&gt;'], {<br/>    type: 'text/html',<br/>  });</span><span id="9d39" class="nf ma iq mz b gy nk nh l ni nj">  const [fileHandle] = await window.showOpenFilePicker(options);</span><span id="8baa" class="nf ma iq mz b gy nk nh l ni nj">  const file = await fileHandle.getFile();<br/>  const writableStream = await fileHandle.createWritable();</span><span id="0dbe" class="nf ma iq mz b gy nk nh l ni nj">  await writableStream.write(blob);<br/>  await writableStream.close();<br/>};</span></pre><p id="0bb7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">浏览器会提示我们是否要授权，确认后才会写:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi og"><img src="../Images/2cdc49f0af54bb2dc802a36a3a68dbb5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UgBM5K6XFD8a7B4GDBV6hA.png"/></div></div></figure><h1 id="429a" class="lz ma iq bd mb mc nm me mf mg nn mi mj jw no jx ml jz np ka mn kc nq kd mp mq bi translated">访问目录</h1><p id="51dc" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated"><code class="fe mw mx my mz b">window.showDirectoryPicker</code>让我们可以简单地实现这一点:</p><pre class="kg kh ki kj gt nb mz nc nd aw ne bi"><span id="7357" class="nf ma iq mz b gy ng nh l ni nj">&lt;button id="pick"&gt;Click&lt;/button&gt;<br/>&lt;script&gt;<br/>  const getDir = async () =&gt; {<br/>    const directoryHandle = await window.showDirectoryPicker();<br/>    console.log('directoryHandle: ', directoryHandle);</span><span id="41ce" class="nf ma iq mz b gy nk nh l ni nj">    for await (const entry of directoryHandle.values()) {<br/>      console.log(entry.kind, entry.name);<br/>    }<br/>  };</span><span id="6173" class="nf ma iq mz b gy nk nh l ni nj">  const btn = document.getElementById('pick');<br/>  btn.addEventListener('click', () =&gt; {<br/>    getDir();<br/>  });<br/>&lt;/script&gt;</span></pre><p id="a05e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">权限确认:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oh"><img src="../Images/63743f02f386033eabe2e5bb7bf48c61.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*js3uGal0X875pYU_ONQZSg.png"/></div></div></figure><p id="01b8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">结果截图:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oi"><img src="../Images/faaa3ad490575e48e4b93ba7f705536c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ubJi4_waM2tQvZZ2-Jq1_Q.png"/></div></div></figure><h1 id="020e" class="lz ma iq bd mb mc nm me mf mg nn mi mj jw no jx ml jz np ka mn kc nq kd mp mq bi translated">浏览器兼容性</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oj"><img src="../Images/bc2c9f82a75f56dfb18079cce62d0b80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eoLTe4hikTTvnTQt5Ts11g.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">图片来自<a class="ae kv" href="https://caniuse.com/?search=File%20System%20Access" rel="noopener ugc nofollow" target="_blank">can use</a></figcaption></figure><h1 id="7b79" class="lz ma iq bd mb mc nm me mf mg nn mi mj jw no jx ml jz np ka mn kc nq kd mp mq bi translated">结论</h1><p id="dc56" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">本文只是简单介绍，如果有兴趣可以参考以下资源:</p><p id="e956" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">[1] <a class="ae kv" href="https://wicg.github.io/file-system-access/" rel="noopener ugc nofollow" target="_blank">文件系统访问 API </a> (W3C 规范)</p><p id="084c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">[2] <a class="ae kv" href="https://developer.mozilla.org/en-US/docs/Web/API/File_System_Access_API" rel="noopener ugc nofollow" target="_blank">文件系统访问 API </a> (MDN)</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="d7ef" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="ok">感谢阅读。如果你喜欢这样的故事，想支持我，请考虑成为</em> <a class="ae kv" href="https://medium.com/@islizeqiang/membership" rel="noopener"> <em class="ok">中会员</em> </a> <em class="ok">。每月 5 美元，你可以无限制地访问媒体内容。如果你通过</em> <a class="ae kv" href="https://medium.com/@islizeqiang/membership" rel="noopener"> <em class="ok">我的链接</em> </a> <em class="ok">报名，我会得到一点佣金。</em></p><p id="2350" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你的支持对我来说很重要——谢谢。</p></div></div>    
</body>
</html>