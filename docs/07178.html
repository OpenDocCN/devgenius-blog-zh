<html>
<head>
<title>Unit testing with Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用 Python 进行单元测试</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/unit-testing-with-python-b7f41985e542?source=collection_archive---------12-----------------------#2022-03-03">https://blog.devgenius.io/unit-testing-with-python-b7f41985e542?source=collection_archive---------12-----------------------#2022-03-03</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="18cc" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">像大多数开始使用 AWS 技术，特别是 Lambda 函数的开发人员一样，我发现有必要开始用 Python 编写代码，随着从 Java 到 Python 的转换，我开始寻找库和技术来测试我的代码。</p><p id="33be" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">包括我自己在内的大多数开发人员发现，当我们面对一些复杂的场景时，很难测试我们的代码，我将带你浏览一些案例，向你展示如何解决这些案例，所以让我们开始吧。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ki"><img src="../Images/9f1ceed73b07971bb0ecaa94ae9b0957.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*samCkyVsxx44HJGHMZRgcw.jpeg"/></div><figcaption class="kq kr gj gh gi ks kt bd b be z dk translated">加州帕萨迪纳</figcaption></figure></div><div class="ab cl ku kv hr kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="ig ih ii ij ik"><blockquote class="lb"><p id="20a7" class="lc ld in bd le lf lg lh li lj lk kh dk translated">案例一:如何模拟 datetime？</p></blockquote><blockquote class="ll lm ln"><p id="2e96" class="jk jl lo jm b jn lp jp jq jr lq jt ju lr ls jx jy lt lu kb kc lv lw kf kg kh ig bi translated">FreezGun library 是一个可以帮助你冻结时间的库:</p><p id="9ecc" class="jk jl lo jm b jn jo jp jq jr js jt ju lr jw jx jy lt ka kb kc lv ke kf kg kh ig bi translated">一旦调用了装饰器或上下文管理器，所有对 datetime.datetime.now()、datetime.datetime.utcnow()、datetime.date.today()、time.time()、time.localtime()、time.gmtime()和 time.strftime()的调用都将返回已冻结的时间。time.monotonic()和 time.perf_counter()也将被冻结，但像往常一样，它不保证它们的绝对值，只保证它们随时间的变化。https://github.com/spulec/freezegun</p></blockquote><pre class="kj kk kl km gt ly lz ma mb aw mc bi"><span id="2b29" class="md me in lz b gy mf mg l mh mi">from datetime import datetime<br/>from freezegun import freeze_time</span><span id="1081" class="md me in lz b gy mj mg l mh mi">@freeze_time(datetime(2022,2,22,12,34,56,789000))<br/>def test_time(self):<br/>    actual = hey_time()<br/>    self.assertEqual("hey: it's 2022-02-22 12:34:56.789000", actual)</span><span id="db22" class="md me in lz b gy mj mg l mh mi">def hey_time():<br/>    return 'hey: it's ' + datetime.utcnow()</span></pre></div><div class="ab cl ku kv hr kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="ig ih ii ij ik"><blockquote class="lb"><p id="f889" class="lc ld in bd le lf lg lh li lj lk kh dk translated">案例二:如何模拟一个函数根据传入的参数返回不同的响应？</p></blockquote><figure class="ml mm mn mo mp kn gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi mk"><img src="../Images/92128e6dc313c30a5d3e63b6d85dde58.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-JW4ZVWqjlYvc9ABQQomHg.png"/></div></div><figcaption class="kq kr gj gh gi ks kt bd b be z dk translated">想象一下，崔妮蒂和尼奥走到一家咖啡馆，崔妮蒂向咖啡师要了两杯咖啡，一杯加糖，另一杯不加糖。</figcaption></figure><p id="7456" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果你是 Java 出身，大概知道在<strong class="jm io"><em class="lo"/></strong><em class="lo">中</em> 的时候可以用<strong class="jm io"> <em class="lo">来控制方法行为。</em>幸运的是，python 提供了类似的解决方案，但是语法不同。那么，让我们假设你有一个调用 S3 桶并返回一个文件的函数，这个函数接收文件名参数并从 S3 桶中获取它，你怎么能根据输入参数返回不同的文件呢？通过将模拟函数中的<strong class="jm io"><em class="lo">side _ effect</em></strong><em class="lo"/>属性分配给<em class="lo"> </em> <strong class="jm io"> <em class="lo"> MagicMock、</em> </strong>，您将能够根据输入参数控制函数的结果。在下面的代码中，我创建了函数<em class="lo"> handler_side_effect </em>，它将检查第一个传入的参数，并基于此返回不同的结果。现在想象一下基于<strong class="jm io"> <em class="lo"> args </em> </strong>数组你能想出什么复杂的场景。</strong></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi mu"><img src="../Images/9af40bdf811c3f84e4b00ab95f625381.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9biYjuP-mzLyPPRfY8zqkQ.png"/></div></div><figcaption class="kq kr gj gh gi ks kt bd b be z dk translated">三一不关心幕后发生了什么，她关心的是最后的输出。</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi mu"><img src="../Images/6b6536a455ea8c57735ccc46e80d7b47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vt86J70jNsVjmrS10S6HUA.png"/></div></div><figcaption class="kq kr gj gh gi ks kt bd b be z dk translated">当我们模仿咖啡馆时，我们把它当作一个盒子，我们给它一个输入，我们期待一个输出。</figcaption></figure><pre class="kj kk kl km gt ly lz ma mb aw mc bi"><span id="c677" class="md me in lz b gy mf mg l mh mi"><strong class="lz io">test.py </strong></span><span id="4d94" class="md me in lz b gy mj mg l mh mi">REGION = 'jordan-east-1'<br/><br/>@mock.patch('src.s3_util.fetch_file_from_s3')<br/>def test_handler(self, mock_fetch_file_from_s3):<br/>    mock_fetch_file_from_s3.side_effect = MagicMock(side_effect=handler_side_effect)</span><span id="5949" class="md me in lz b gy mj mg l mh mi">def handler_side_effect(*args, **kwargs):<br/>    if args[0] == 'Regular':<br/>        return {"Ingredients ": "Humus, Tomato, Falafel, and Bread"}<br/>    elif args[0] == 'Super':<br/>         return {"Ingredients ": "Humus, Fries, Tahina, Eggplant, Tomato, Falafel, and Bread"}</span><span id="259a" class="md me in lz b gy mj mg l mh mi"><strong class="lz io">src/s3_util.py</strong></span><span id="9106" class="md me in lz b gy mj mg l mh mi">def fetch_file_from_s3(file_name: str):<br/>    ...<br/>    return file</span></pre></div><div class="ab cl ku kv hr kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="ig ih ii ij ik"><blockquote class="lb"><p id="2db7" class="lc ld in bd le lf lg lh li lj lk kh dk translated">案例三:如何模拟一个函数一直返回一个值？</p></blockquote><p id="ed56" class="pw-post-body-paragraph jk jl in jm b jn lp jp jq jr lq jt ju jv ls jx jy jz lu kb kc kd lw kf kg kh ig bi translated">如果你有一个简单的函数，尽管有输入参数，你的函数需要返回相同的值，那么你可以在模拟函数中使用<strong class="jm io"> <em class="lo"> return_value </em> </strong>属性。</p><pre class="kj kk kl km gt ly lz ma mb aw mc bi"><span id="6de9" class="md me in lz b gy mf mg l mh mi">@mock.patch('src.s3_util.fetch_file_from_s3')<br/>def test_handler(self, mock_fetch_file_from_s3):<br/>    mock_fetch_file_from_s3.return_value = 'I'm cool as Avocado'</span></pre></div><div class="ab cl ku kv hr kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="ig ih ii ij ik"><blockquote class="lb"><p id="f0a2" class="lc ld in bd le lf lg lh li lj lk kh dk translated">案例四:如何验证被模仿的函数是用特定的参数调用的？</p></blockquote><p id="e8ea" class="pw-post-body-paragraph jk jl in jm b jn lp jp jq jr lq jt ju jv ls jx jy jz lu kb kc kd lw kf kg kh ig bi translated">在某些情况下，仅仅验证你模仿的函数的结果是不够的，你还需要验证被模仿的函数是否是用特定的参数调用的？它被呼叫了多少次？等等……<br/>重要的是要提到在 python 中模拟函数的<strong class="jm io">顺序</strong>有点混乱，在下面的例子中，你会注意到<strong class="jm io"> <em class="lo">模拟 _ 腐殖质</em> </strong>在参数中排在第一位，所以请记住这一点，以免碰壁:)</p><pre class="kj kk kl km gt ly lz ma mb aw mc bi"><span id="bb0b" class="md me in lz b gy mf mg l mh mi">@mock.patch('src.eggplant.add')<br/>@mock.patch('src.humus.add')<br/>def test_falafel_factory(self, mock_humus, mock_eggplant):<br/>    mock_humus.assert_called_with('humus')<br/>    mock_humus.assert_called_with('lentils')<br/>    <!-- -->self.assertEqual(<!-- -->mock_humus<!-- -->.call_count, 2)<br/>    self.assertEqual(<!-- -->mock_eggplant<!-- -->.call_count, 0)</span><span id="b906" class="md me in lz b gy mj mg l mh mi"><strong class="lz io">src/falafel_sandwitch_factory.py</strong></span><span id="2e1c" class="md me in lz b gy mj mg l mh mi">from humus  import add<br/>def make_falafel_sandwitch(self):<br/>     add('humus')<br/>     add('lentils')<br/></span><span id="c900" class="md me in lz b gy mj mg l mh mi"><strong class="lz io">src/humus.py</strong></span><span id="2090" class="md me in lz b gy mj mg l mh mi">def add(self, ingredient):<br/>     ...<br/></span><span id="c346" class="md me in lz b gy mj mg l mh mi"><strong class="lz io">src/eggplant.py</strong></span><span id="e734" class="md me in lz b gy mj mg l mh mi">def add(self, ingredient):<br/>     ...</span></pre></div><div class="ab cl ku kv hr kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="ig ih ii ij ik"><blockquote class="lb"><p id="a5ce" class="lc ld in bd le lf lg lh li lj lk kh dk translated">案例五:异常出现时如何测试你的函数？</p></blockquote><p id="4dec" class="pw-post-body-paragraph jk jl in jm b jn lp jp jq jr lq jt ju jv ls jx jy jz lu kb kc kd lw kf kg kh ig bi translated">如果您的函数必须处理异常，您希望能够测试您的函数行为，假设您有一个从 s3 bucket 获取信息并对该信息进行分析的函数，并且您遇到了来自 s3 的异常，比如找不到文件或区域关闭。模仿给了你控制 fetch 函数行为的能力，你可以在被模仿的函数被调用时抛出一个异常，在你的代码中捕捉这个异常，并验证被模仿的函数是用某些参数调用的。</p><pre class="kj kk kl km gt ly lz ma mb aw mc bi"><span id="a399" class="md me in lz b gy mf mg l mh mi">@mock.patch('src.data_factory.read_from_s3')<br/>def test_data_factory(self, mock_read_from_s3):<br/>    mock_read_file.side_effect =    MagicMock(side_effect=Exception('Trinity is mad at you')) <br/>    try:<br/>       fetch_data_and_analyse()<br/>    except Exception as e: <br/>       self.assertEqual('Trinity is mad at you', format(error))<br/>    mock_read_from_s3.assert_called_with('cool_bucket')<br/>    self.assertEqual(<!-- -->mock_read_from_s3<!-- -->.call_count, 1)</span><span id="faf4" class="md me in lz b gy mj mg l mh mi"><strong class="lz io">src/data_factory.py</strong></span><span id="2539" class="md me in lz b gy mj mg l mh mi">from s3_util  import read_from_s3<br/>def fetch_data_and_analyse(self):</span><span id="85da" class="md me in lz b gy mj mg l mh mi">   try:<br/>     data = read_from_s3('cool_bucket')</span><span id="7c7f" class="md me in lz b gy mj mg l mh mi">   except Exception as e:<br/>     print(e)</span><span id="f535" class="md me in lz b gy mj mg l mh mi">   analyse(data)</span><span id="8ab4" class="md me in lz b gy mj mg l mh mi"><strong class="lz io">src/s3_util.py</strong></span><span id="8f8d" class="md me in lz b gy mj mg l mh mi">def read_from_s3(self, bucket_name):<br/>     ...</span></pre><p id="0c94" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这是目前为止，如果你有以上案例中没有提到的任何案例，请给我留下评论，如果我有答案，我会尽量给你回复。</p></div></div>    
</body>
</html>