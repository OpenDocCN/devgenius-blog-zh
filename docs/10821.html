<html>
<head>
<title>API Authorization with JWT</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">API 授权</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/api-authorization-with-jwt-53c349a19361?source=collection_archive---------7-----------------------#2022-12-02">https://blog.devgenius.io/api-authorization-with-jwt-53c349a19361?source=collection_archive---------7-----------------------#2022-12-02</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="4264" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在本文中，我们将讨论 JWT (Json Web Token)是什么，它有什么用，以及如何将它添加到 REST API 中。</p><h2 id="49d6" class="ki kj in bd kk kl km dn kn ko kp dp kq jv kr ks kt jz ku kv kw kd kx ky kz la bi translated">定义</h2><p id="4bfa" class="pw-post-body-paragraph jk jl in jm b jn lb jp jq jr lc jt ju jv ld jx jy jz le kb kc kd lf kf kg kh ig bi translated">首先，我将回顾一些定义。</p><p id="7772" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">认证</strong>:“验证用户或进程身份的过程或动作”(你就是你所说的那个人)</p><p id="96c4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">授权:</strong>“给予某人做某事或拥有某物许可的过程”(假设你是这个人，你被允许访问这个东西吗)</p><h2 id="09f2" class="ki kj in bd kk kl km dn kn ko kp dp kq jv kr ks kt jz ku kv kw kd kx ky kz la bi translated">例子</h2><p id="0c9e" class="pw-post-body-paragraph jk jl in jm b jn lb jp jq jr lc jt ju jv ld jx jy jz le kb kc kd lf kf kg kh ig bi translated">假设我们有一个银行网站，在那里我们显示机密的用户信息。为了向用户显示这些信息，我们必须。</p><ol class=""><li id="9fef" class="lg lh in jm b jn jo jr js jv li jz lj kd lk kh ll lm ln lo bi translated">使用密码和用户名对他们进行验证(例如，这个人是 Sally)</li><li id="f98e" class="lg lh in jm b jn lp jr lq jv lr jz ls kd lt kh ll lm ln lo bi translated">授权他们查看他们请求的页面上的数据(即 Sally 不能查看 John 的银行对账单)</li></ol><h2 id="579b" class="ki kj in bd kk kl km dn kn ko kp dp kq jv kr ks kt jz ku kv kw kd kx ky kz la bi translated">这是什么？</h2><p id="5cb7" class="pw-post-body-paragraph jk jl in jm b jn lb jp jq jr lc jt ju jv ld jx jy jz le kb kc kd lf kf kg kh ig bi translated">Json Web 令牌是一种新的授权方法，它利用加密散列在客户机和服务器之间安全地传输用户元数据。</p><p id="4c82" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">对于普通人来说，令牌本身只是一堆毫无意义的字符，但是如果您有正确的密钥，就可以提取用户元数据。例如，<code class="fe lu lv lw lx b">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyIjoiU2FsbHkifQ.u7gUUVZWpG_ur96XDyNEuIHFeyFZlYNE22we9cFAMpk</code>是对有效载荷进行编码的 JWT</p><pre class="ly lz ma mb gt mc lx md bn me mf bi"><span id="7455" class="mg kj in lx b be mh mi l mj mk">{<br/>  "user": "Sally"<br/>}</span></pre><p id="8dc1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">用秘钥“秘密”🤫。你可以在这个网站上玩杂凑游戏<a class="ae ml" href="https://jwt.io/" rel="noopener ugc nofollow" target="_blank">https://jwt.io/</a></p><figure class="ly lz ma mb gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="mo mp di mq bf mr"><div class="gh gi mm"><img src="../Images/0bc087d09f4b0bba73dcf3475062a17c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U1goI4_giv31VlVksB367w.png"/></div></div></figure><p id="c43f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果你知道这个秘密，你也可以把 JWT 解码成有效载荷。</p><h2 id="0a7c" class="ki kj in bd kk kl km dn kn ko kp dp kq jv kr ks kt jz ku kv kw kd kx ky kz la bi translated"><strong class="ak">怎么有用？</strong></h2><p id="76dc" class="pw-post-body-paragraph jk jl in jm b jn lb jp jq jr lc jt ju jv ld jx jy jz le kb kc kd lf kf kg kh ig bi translated">现在我们知道令牌只是一个加密字符串，那么它有什么帮助呢？我们可以用它给用户一张通行证去访问他们被允许访问的东西。</p><figure class="ly lz ma mb gt mn gh gi paragraph-image"><div class="gh gi mu"><img src="../Images/c2c9673b9fcc68bb53600232eb97efbc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1390/format:webp/1*STlfA5M6VAQfET7zXoWGHA.png"/></div></figure><p id="1cd0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">步骤</strong></p><ol class=""><li id="859d" class="lg lh in jm b jn jo jr js jv li jz lj kd lk kh ll lm ln lo bi translated">客户端发送用户名和密码</li><li id="64f2" class="lg lh in jm b jn lp jr lq jv lr jz ls kd lt kh ll lm ln lo bi translated">服务器对用户进行身份验证，并使用关于用户的一些元数据，通过密钥创建 JWT</li><li id="5272" class="lg lh in jm b jn lp jr lq jv lr jz ls kd lt kh ll lm ln lo bi translated">JWT 通过 HTTP 头在/登录响应中发送回客户端，客户端将 JWT 存储在本地存储中</li><li id="2380" class="lg lh in jm b jn lp jr lq jv lr jz ls kd lt kh ll lm ln lo bi translated">在对服务器的后续请求中，客户端在请求头中提供这个令牌</li><li id="3721" class="lg lh in jm b jn lp jr lq jv lr jz ls kd lt kh ll lm ln lo bi translated">服务器使用密钥解密 JWT，找出试图访问端点的人</li><li id="dad0" class="lg lh in jm b jn lp jr lq jv lr jz ls kd lt kh ll lm ln lo bi translated">服务器向知道他们是谁的客户端发送响应</li></ol><p id="b471" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">由于这是一个加密散列，人们不能伪造他们是谁，也就是说，为了创建<code class="fe lu lv lw lx b">{“user”:”John”}</code>的 JWT，我需要知道密钥。我也不能在不知道密钥的情况下拿走一个 JWT 并找出它属于谁，因为也需要它来解密 JWT。</p><p id="a6ea" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">使用它，我们可以为一组付费用户创建高级端点，使用用户特定数据个性化 api 结果，阻止用户访问其他用户的数据，即使他们知道要访问哪些用户数据的 URL。</p><h2 id="c435" class="ki kj in bd kk kl km dn kn ko kp dp kq jv kr ks kt jz ku kv kw kd kx ky kz la bi translated">将 JWT 添加到 API 中</h2><p id="3893" class="pw-post-body-paragraph jk jl in jm b jn lb jp jq jr lc jt ju jv ld jx jy jz le kb kc kd lf kf kg kh ig bi translated">现在让我们看一个例子，利用 JWT 授权创建一个 express 服务器。</p><pre class="ly lz ma mb gt mc lx md bn me mf bi"><span id="8024" class="mg kj in lx b be mh mi l mj mk">const express = require('express')<br/>const jwt = require('jsonwebtoken');<br/>const app = express()<br/>app.use(express.json());<br/>const port = 3000<br/><br/>app.post('/authenticate', (req, res) =&gt; {<br/>    //AUTHENTICATE HERE<br/><br/>    //create jwt using user info<br/>    console.info(req.body)<br/>    const {username} = req.body;<br/>    const token = jwt.sign({username: username}, "SECRET", { expiresIn: '30s' });<br/>    console.info(token);<br/><br/>    //send token<br/>    res.setHeader("x-auth-token", token)<br/>    res.sendStatus(200)<br/>})<br/><br/>app.get("/guarded", (req, res) =&gt; {<br/>    if (req.header("x-auth-token") == null) {<br/>        // USER DIDN'T SUPPLY TOKEN<br/>        return res.status(400).send("NO AUTH TOKEN SUPPLIED");<br/>    }<br/>    try {<br/>        const decoded = jwt.verify(req.header("x-auth-token"), 'SECRET');<br/>        console.info(decoded);<br/>        //could use the user to personalize some db query or guard a page for only some users<br/>        res.send(decoded["username"]);<br/>    } catch (e) {<br/>        // USER MESSED WITH TOKEN<br/>        return res.status(400).send("INVALID AUTH TOKEN PROVIDED")<br/>    }<br/>})<br/><br/>app.listen(port, () =&gt; {<br/>    console.log(`Example app listening on port ${port}`)<br/>})</span></pre><p id="ec57" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这是完整的代码，以获得一个认证路线和一个受保护的(只有授权的个人)路线。</p><p id="dfe1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">/认证</strong></p><pre class="ly lz ma mb gt mc lx md bn me mf bi"><span id="311f" class="mg kj in lx b be mh mi l mj mk">app.post('/authenticate', (req, res) =&gt; {<br/>    //AUTHENTICATE HERE<br/><br/>    //create jwt using user info<br/>    console.info(req.body)<br/>    const {username} = req.body;<br/>    const token = jwt.sign({username: username}, "SECRET", { expiresIn: '30s' });<br/>    console.info(token);<br/><br/>    //send token<br/>    res.setHeader("x-auth-token", token)<br/>    res.sendStatus(200)<br/>})</span></pre><p id="39eb" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">首先，您将验证用户并取回他们的元数据，这些元数据将在有效载荷中使用(我只是将提供的主体作为有效载荷)。然后，我们用我们的“秘密”密钥对令牌进行签名，并设置一个 30 秒的过期时间(因此这个令牌将在 30 秒后失效)。然后我们在一个头中将它发送给用户。</p><figure class="ly lz ma mb gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="mo mp di mq bf mr"><div class="gh gi mv"><img src="../Images/1504e533dffbbe18378f5c3334b08e93.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nLok3Y8Cyc3MqaYj4k-y8Q.png"/></div></div></figure><p id="b048" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">/守护</strong></p><pre class="ly lz ma mb gt mc lx md bn me mf bi"><span id="507f" class="mg kj in lx b be mh mi l mj mk">app.get("/guarded", (req, res) =&gt; {<br/>    if (req.header("x-auth-token") == null) {<br/>        // USER DIDN'T SUPPLY TOKEN<br/>        return res.status(400).send("NO AUTH TOKEN SUPPLIED");<br/>    }<br/>    try {<br/>        const decoded = jwt.verify(req.header("x-auth-token"), 'SECRET');<br/>        console.info(decoded);<br/>        //could use the user to personalize some db query or guard a page for only some users<br/>        res.send(decoded["username"]);<br/>    } catch (e) {<br/>        // USER MESSED WITH TOKEN or TOKEN EXPIRED<br/>        return res.status(400).send("INVALID AUTH TOKEN PROVIDED")<br/>    }<br/>})</span></pre><p id="4238" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">受保护的路由将首先检查请求者是否在其报头中提供了身份验证令牌，如果没有，我们将发回“未提供身份验证令牌”。然后，我们尝试验证和解码令牌。如果验证失败，它会抛出一个错误，因此我们会捕获它并返回“提供了无效的 AUTH TOKEN”。最后，如果用户提供了有效的 auth 令牌，我们只需将他们的用户名(通过解码有效负载获得)发送给他们。</p><figure class="ly lz ma mb gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="mo mp di mq bf mr"><div class="gh gi mw"><img src="../Images/6aa182a08b7ce70c9cd97b8fd0e4d457.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6Nr-vPP-SB4ohKkZKhik-A.png"/></div></div></figure><p id="78ef" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在您已经准备好向您的 API 添加授权了！</p></div></div>    
</body>
</html>