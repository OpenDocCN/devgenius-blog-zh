<html>
<head>
<title>MySQL Locks — for Update or Read? When to use which lock?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">MySQL 锁——用于更新还是读取？何时使用哪把锁？</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/mysql-locks-for-update-or-read-271f50f2aeb1?source=collection_archive---------0-----------------------#2022-09-18">https://blog.devgenius.io/mysql-locks-for-update-or-read-271f50f2aeb1?source=collection_archive---------0-----------------------#2022-09-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="7ff4" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">简单的解释，加上例子，即使是小孩也能理解。何时使用一个锁而不是另一个锁。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/3e5497bdc383fd04ee2bbdd7fedbf5e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*UJH-gqv6uK14senL"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@mitchel3uo?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">米切尔罗</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></figcaption></figure><p id="31cf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您正在使用数据库锁吗？如果您的应用程序足够小，您可能不需要这样做。但是，一旦并发操作发生，事情就开始变得混乱，比如:</p><ul class=""><li id="2a7c" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">多次按下提交按钮，</li><li id="80a0" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">并行运行的 cron 操作，</li><li id="3c8b" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">多个异步队列工作器，</li><li id="2d49" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">来自支付提供商的多条 webhook 消息等…</li></ul><p id="15f1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您关心应用程序的数据完整性，您应该考虑使用数据库锁。哪个最好的问题是<a class="ae kv" href="https://www.google.com/search?q=mysql+lock+difference" rel="noopener ugc nofollow" target="_blank">在谷歌</a>上臭名昭著。</p><blockquote class="mg"><p id="dea5" class="mh mi iq bd mj mk ml mm mn mo mp lr dk translated">记住，没有事务，锁是不起作用的！若要成功锁定行，请先启动一个事务。</p></blockquote></div><div class="ab cl mq mr hu ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="ij ik il im in"><h1 id="6b88" class="mx my iq bd mz na nb nc nd ne nf ng nh jw ni jx nj jz nk ka nl kc nm kd nn no bi translated">MySQL 中的锁类型</h1><p id="04f1" class="pw-post-body-paragraph kw kx iq ky b kz np jr lb lc nq ju le lf nr lh li lj ns ll lm ln nt lp lq lr ij bi translated">MySQL InnoDb 表有两种类型的“锁定选择”操作。两者都做同样的事情—阻止行被更新，但方式不同:</p><ul class=""><li id="e2d4" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated"><code class="fe nu nv nw nx b">SELECT * FROM <em class="ny">user </em>WHERE <em class="ny">id </em>= 5 <strong class="ky ir">LOCK IN SHARE MODE</strong></code></li><li id="e084" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated"><code class="fe nu nv nw nx b">SELECT * FROM <em class="ny">user </em>WHERE <em class="ny">id </em>= 3 <strong class="ky ir">FOR UPDATE</strong></code></li></ul></div><div class="ab cl mq mr hu ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="ij ik il im in"><h1 id="6b67" class="mx my iq bd mz na nb nc nd ne nf ng nh jw ni jx nj jz nk ka nl kc nm kd nn no bi translated">锁定共享模式</h1><ol class=""><li id="ac33" class="ls lt iq ky b kz np lc nq lf nz lj oa ln ob lr oc ly lz ma bi translated">防止其他进程在该行被锁定时更新它</li><li id="2b66" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr oc ly lz ma bi translated"><strong class="ky ir">允许在锁定时读取行</strong></li></ol><blockquote class="od oe of"><p id="2a5a" class="kw kx ny ky b kz la jr lb lc ld ju le og lg lh li oh lk ll lm oi lo lp lq lr ij bi translated"><em class="iq">当您<strong class="ky ir">不打算更新</strong>行，但它的状态在事务期间对其他对象很重要时，使用它</em>。</p></blockquote><p id="5f2e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当您想要锁定一行以保护它的状态，但又不想完全出于性能原因而锁定它时，锁就很有用。</p><h1 id="6d29" class="mx my iq bd mz na oj nc nd ne ok ng nh jw ol jx nj jz om ka nl kc on kd nn no bi translated">锁定更新</h1><ol class=""><li id="04a9" class="ls lt iq ky b kz np lc nq lf nz lj oa ln ob lr oc ly lz ma bi translated">防止其他进程在该行被锁定时更新它</li><li id="3665" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr oc ly lz ma bi translated"><strong class="ky ir">防止其他人读取锁定的行</strong></li></ol><blockquote class="od oe of"><p id="e9ee" class="kw kx ny ky b kz la jr lb lc ld ju le og lg lh li oh lk ll lm oi lo lp lq lr ij bi translated"><em class="iq">当您<strong class="ky ir">打算更新</strong>行<em class="iq">并且您关心行的完整性时，使用它</em>。</em></p></blockquote><p id="95fd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当您希望锁定一行以保护其状态，并且希望确保其值不会改变(在事务处理期间)时，锁非常有用。)</p></div><div class="ab cl mq mr hu ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="ij ik il im in"><h1 id="4392" class="mx my iq bd mz na nb nc nd ne nf ng nh jw ni jx nj jz nk ka nl kc nm kd nn no bi translated">现实生活场景</h1><p id="85db" class="pw-post-body-paragraph kw kx iq ky b kz np jr lb lc nq ju le lf nr lh li lj ns ll lm ln nt lp lq lr ij bi translated">了解如何在现实生活中使用这两种锁。您正在构建一个<strong class="ky ir">在线礼宾服务</strong> web 应用程序。</p><blockquote class="od oe of"><p id="f0b4" class="kw kx ny ky b kz la jr lb lc ld ju le og lg lh li oh lk ll lm oi lo lp lq lr ij bi translated">客户需要充值信用余额。客户可以要求服务，并为每个请求付费。</p></blockquote><p id="1398" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下面是一个简化的 Laravel 控制器操作，它存储服务请求并从客户的余额中扣除服务成本:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oo op l"/></div></figure><h2 id="1f00" class="oq my iq bd mz or os dn nd ot ou dp nh lf ov ow nj lj ox oy nl ln oz pa nn pb bi translated">客户锁定背后的原因</h2><p id="1201" class="pw-post-body-paragraph kw kx iq ky b kz np jr lb lc nq ju le lf nr lh li lj ns ll lm ln nt lp lq lr ij bi translated">假设客户有 100 美元的信用额度，所请求的服务花费 75 美元。</p><p id="1d94" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果我们不为客户应用任何锁或使用“共享锁”，会发生什么？如果同时向该端点发出十个请求，所有请求都会成功！每个请求将同时读取用户行，具有相同的值。</p><p id="a1d9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在交易完成之前，无法从数据库中读取客户<strong class="ky ir">的<em class="ny">锁定更新</em></strong>。当它这样做时，余额是 25 美元，因此剩下的 9 个请求将失败。</p><h2 id="7fd7" class="oq my iq bd mz or os dn nd ot ou dp nh lf ov ow nj lj ox oy nl ln oz pa nn pb bi translated">服务锁背后的原因</h2><p id="bda4" class="pw-post-body-paragraph kw kx iq ky b kz np jr lb lc nq ju le lf nr lh li lj ns ll lm ln nt lp lq lr ij bi translated">该服务已被“锁定读取”，以在事务期间密封其状态。它<strong class="ky ir">不能修改</strong>、<strong class="ky ir">但可以读取</strong>！</p><p id="fef3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">它保证我们的员工不会在客户提出请求时删除服务或更改管理面板中的任何细节。</p><p id="818c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果我们为更新使用<em class="ny">锁，其他事务<strong class="ky ir">将无法读取服务行</strong>；结果这会降低应用程序的速度。</em></p></div><div class="ab cl mq mr hu ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="ij ik il im in"><p id="5fe1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你喜欢这个出版物吗？够简单吗？请让我知道，并在评论中留言。你可以留下一两个掌声，这样我就可以有更多的时间写作。谢谢！</p></div></div>    
</body>
</html>