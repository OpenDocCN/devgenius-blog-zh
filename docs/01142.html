<html>
<head>
<title>PowerShell Code Signing</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">PowerShell 代码签名</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/powershell-code-signing-fc6086aeb61e?source=collection_archive---------4-----------------------#2020-06-25">https://blog.devgenius.io/powershell-code-signing-fc6086aeb61e?source=collection_archive---------4-----------------------#2020-06-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="1482" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用数字签名保护您的脚本</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/3b2eb967f69f4f86f47914057d9132c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*bGiAeNIIsa7IwsWj"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">塔达斯·萨尔在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="d385" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您是系统管理员，您可能必须运行任务计划程序作业或将任务委派给最终用户。但是您想过如何安全地运行这些任务吗？如何确保系统中脚本的完整性和质量？这就是代码签名可以发挥作用的地方。</p><p id="50ca" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">数字签名是一种保证文件或消息在计算签名后未被更改的过程。签名脚本可以确保您运行的脚本的完整性。验证脚本可以安全运行后，您可以对脚本进行数字签名以防止他人篡改。</p><p id="cabf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">可以使用签名证书对文件进行签名。通过调整 Powershell 执行策略，只允许运行已签名的脚本，您可以保持对系统上脚本完整性的控制。今天，让我们深入了解 Powershell 代码签名是如何工作的，以及如何对要使用的脚本进行签名！</p><h1 id="6fe8" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">配置签名证书</h1><p id="a345" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">首先，让我们创建一个证书模板！证书模板将使用户能够请求单个证书来签署他们的脚本。</p><h2 id="4090" class="mp lt iq bd lu mq mr dn ly ms mt dp mc lf mu mv me lj mw mx mg ln my mz mi na bi translated">创建证书模板</h2><p id="5b46" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">首先，转到您的控制面板，然后进入“管理工具&gt;证书颁发机构”。右键单击“证书模板”，然后单击“管理”。您应该会看到可供使用的内置模板列表。右键单击“代码签名”并选择“复制模板”。</p><p id="4c9c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您应该会看到一个窗口，提示您设置新模板的属性。在“常规”选项卡中，您可以设置模板的名称。在“兼容性”标签中，您可以设置证书颁发机构和证书接收者。在“加密”选项卡中，您可以配置所使用的加密算法的详细信息，如加密提供商、算法名称、密钥大小等。</p><p id="78a2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在“安全”选项卡中，您可以配置哪些用户或组可以创建代码签名证书。被允许创建代码签名证书的用户需要被授予“注册”和“读取”权限。</p><p id="45ce" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您已经配置了证书模板，您可以简单地导入它以供使用。</p><pre class="kg kh ki kj gt nb nc nd ne aw nf bi"><span id="78f9" class="mp lt iq nc b gy ng nh l ni nj">ldifde -i -k -f TEMPLATE_FILE</span></pre><p id="deef" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">回到“管理工具&gt;证书颁发机构”，右键单击“证书模板”，然后转到“新建&gt;要颁发的证书模板”。</p><h2 id="e0e1" class="mp lt iq bd lu mq mr dn ly ms mt dp mc lf mu mv me lj mw mx mg ln my mz mi na bi translated">创建签名证书</h2><p id="a530" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在开发机器上，您现在可以创建代码签名证书。首先，打开微软管理控制台(mmc.msc)。然后，转到“文件&gt;添加/删除管理单元”。从“可用管理单元”菜单中，选择“证书”并单击“添加”，然后单击“确定”。</p><p id="2e9a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在原来的窗口中，右键单击“个人”，选择“所有任务&gt;请求新证书”。勾选相应的证书，然后单击“注册”。将创建代码签名证书。</p><p id="1b62" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可以通过运行此命令导入要使用的证书。</p><pre class="kg kh ki kj gt nb nc nd ne aw nf bi"><span id="1d8e" class="mp lt iq nc b gy ng nh l ni nj">Import-Certificate -FilePath "CERT_TO_IMPORT" -CertStoreLocation cert:CERT_LOCATION</span></pre><p id="c412" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您也可以将证书从证书存储中导出到文件中。</p><pre class="kg kh ki kj gt nb nc nd ne aw nf bi"><span id="5b9a" class="mp lt iq nc b gy ng nh l ni nj">$cert = Get-ChildItem -Path cert:<!-- -->CERT_LOCATION<!-- --> <br/>Export-Certificate -Cert $cert -FilePath FILE_PATH</span></pre><h1 id="2c42" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">签名脚本</h1><p id="8016" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">现在，您可以使用代码签名证书来签署脚本了！这些命令将检索代码签名证书，并使用它来签名您的脚本。</p><pre class="kg kh ki kj gt nb nc nd ne aw nf bi"><span id="54db" class="mp lt iq nc b gy ng nh l ni nj">$cert=Get-ChildItem -Path Cert:CERT_LOCATION -CodeSigningCert <br/>Set-AuthenticodeSignature -FilePath SCRIPT_PATH -Certificate $cert</span></pre><p id="8774" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您现在可以运行您的签名脚本了。</p><pre class="kg kh ki kj gt nb nc nd ne aw nf bi"><span id="2fba" class="mp lt iq nc b gy ng nh l ni nj">SCRIPT_PATH</span></pre><h2 id="1264" class="mp lt iq bd lu mq mr dn ly ms mt dp mc lf mu mv me lj mw mx mg ln my mz mi na bi translated">如何防止数字签名过期</h2><p id="7284" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在签名证书过期之前，脚本中的数字签名一直有效。或者，如果时间戳服务器可以验证在签名证书有效时脚本被签名，则签名可以保持有效。由于大多数签名证书在一年后过期，使用时间戳服务器可以确保用户可以在更长的时间内使用您的脚本。</p><h1 id="b0f6" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">Powershell 执行策略</h1><p id="8c97" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">PowerShell 的执行策略控制 PowerShell 如何加载配置文件和运行脚本。通过设置适当的执行策略，可以防止恶意脚本的执行。特别是，将执行策略设置为“AllSigned”可以确保只有使用可信证书签名的脚本和配置文件才能在您的系统上运行。</p><p id="166f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要在您的计算机上找到有效的执行策略，您可以使用:</p><pre class="kg kh ki kj gt nb nc nd ne aw nf bi"><span id="76a6" class="mp lt iq nc b gy ng nh l ni nj">Get-ExecutionPolicy</span></pre><p id="a2b8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可以使用此命令将 PowerShell 的执行策略设置为 AllSigned。</p><pre class="kg kh ki kj gt nb nc nd ne aw nf bi"><span id="ca6d" class="mp lt iq nc b gy ng nh l ni nj">Set-ExecutionPolicy AllSigned</span></pre><h1 id="144d" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">结论</h1><p id="bb40" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">签署脚本并相应地限制 Powershell 的执行策略是确保您运行的脚本的完整性的好方法。在这篇文章中，我们讨论了如何创建代码签名证书，以及如何使用该证书对脚本进行签名。</p></div></div>    
</body>
</html>