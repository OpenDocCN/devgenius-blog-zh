<html>
<head>
<title>Introduction to OpenTelemetry &amp; Distributed tracing — Part II</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">OpenTelemetry 和分布式跟踪简介—第二部分</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/introduction-to-opentelemetry-distributed-tracing-part-ii-7ddab4a4cf15?source=collection_archive---------3-----------------------#2022-07-22">https://blog.devgenius.io/introduction-to-opentelemetry-distributed-tracing-part-ii-7ddab4a4cf15?source=collection_archive---------3-----------------------#2022-07-22</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="13d9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在上一篇文章中，我们试图在高层次上理解这些概念。在这篇博文中，我们将深入研究一个工作示例，所以让我们开始吧。</p><p id="a36b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">下面是我们将要构建的示例的架构。在本例中，我们将使用 OpenTelemetry 的 Java 代理，它将自动检测代码，为我们生成跟踪数据。遥测数据将被导出到像 Zipkin 这样的可视化工具中。Zipkin 基本上是一个可执行的 jar，可以运行它来存储(在内存中)和查看跟踪信息。最终用户将能够访问 Zipkin UI 并查看使用 OpenTelemetry 库生成的跟踪数据。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/e5e04bc14066cff9c84f82ce887d033c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yDWhduVJDg4kFHIbU1IpAg.jpeg"/></div></div></figure><p id="7519" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们有 2 个春季开机微服务— <a class="ae ku" href="https://github.com/metalhead44/otel-spring-tracing/tree/main/otel-tracing-studentservice" rel="noopener ugc nofollow" target="_blank">学生服务</a>和<a class="ae ku" href="https://github.com/metalhead44/otel-spring-tracing/tree/main/otel-tracing-schoolservice" rel="noopener ugc nofollow" target="_blank">学校服务</a>。我不会分享创建这个微服务的步骤，以保持这个博客专注于 OpenTelemetry。你可以<a class="ae ku" href="https://github.com/metalhead44/otel-spring-tracing" rel="noopener ugc nofollow" target="_blank">从我的 git repo </a>下载代码，或者你可以使用任何现有的 spring boot 微服务来测试这个例子。</p><h1 id="1fd6" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated"><strong class="ak">步骤 1:下载 OpenTelemetry java 代理</strong></h1><p id="dc4b" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">OpenTelemetry 有两种用途。您可以使用 SDK 在您的代码库中编写您自己的跟踪信息，或者您可以使用 OpenTelemetry 的自动检测功能，它以自动化的方式提供或生成遥测数据。我们将在本例中使用<strong class="jm io">自动插装</strong>技术，因为它提供了<strong class="jm io">零代码插装</strong>。</p><p id="2e01" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">下载<a class="ae ku" href="https://github.com/open-telemetry/opentelemetry-java-instrumentation/releases/latest/download/opentelemetry-javaagent.jar" rel="noopener ugc nofollow" target="_blank"> <strong class="jm io">最新版本</strong> </a> <strong class="jm io"> </strong>并放入文件夹。</p><h1 id="186a" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">步骤 2:配置您的服务，使用 VM 参数启动 java 代理</h1><p id="8f40" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">我使用 eclipse 进行开发，所以我编辑了两个服务的<em class="ly"> RunAs </em>选项，如下所示。</p><pre class="kj kk kl km gt lz ma mb mc aw md bi"><span id="e4ff" class="me kw in ma b gy mf mg l mh mi">-javaagent:D:\Installations\opentelemetry-javaagent.jar -Dotel.traces.exporter=zipkin -Dotel.resource.attributes=service.name=student-service -Dotel.metrics.exporter=none -Dotel.exporter.zipkin.endpoint=http://localhost:9411/api/v2/spans</span><span id="1b03" class="me kw in ma b gy mj mg l mh mi">-javaagent:D:\Installations\opentelemetry-javaagent.jar -Dotel.traces.exporter=zipkin -Dotel.resource.attributes=service.name=school-service -Dotel.metrics.exporter=none -Dotel.exporter.zipkin.endpoint=http://localhost:9411/api/v2/spans</span></pre><p id="b72b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让我们理解这些参数的含义</p><ul class=""><li id="9197" class="mk ml in jm b jn jo jr js jv mm jz mn kd mo kh mp mq mr ms bi translated"><strong class="jm io"> Dotel.traces.exporter </strong> —此参数指定 otel 将跟踪数据推送到的导出器。<br/>-<strong class="jm io">dotel . metrics . exporter</strong>= none—该参数指定我们不想导出任何指标数据。<br/><strong class="jm io">-dotel . resource . attributes</strong>=该参数指定服务名等属性来标识来自该组件的跟踪<br/><strong class="jm io">-dotel . exporter . Zipkin . Endpoint</strong>=该参数指定跟踪数据需要发送到的<strong class="jm io"> Zipkin </strong>端点。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/7303fc854fa6b0c34f3b7cffb115d083.png" data-original-src="https://miro.medium.com/v2/resize:fit:1092/0*N0g7JibdwP_k5V2U"/></div><figcaption class="mu mv gj gh gi mw mx bd b be z dk translated">Eclipse 虚拟机参数</figcaption></figure><h1 id="9d73" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">步骤 3:下载并启动 Zipkin 服务器。</h1><p id="fb3d" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">如果您安装了 Java 8 或更高版本，最快的开始方式是获取最新发布的<a class="ae ku" href="https://search.maven.org/remote_content?g=io.zipkin&amp;a=zipkin-server&amp;v=LATEST&amp;c=exec" rel="noopener ugc nofollow" target="_blank">作为自包含的可执行 jar。</a></p><p id="6d1a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">使用命令运行 zipkin jar</p><pre class="kj kk kl km gt lz ma mb mc aw md bi"><span id="9405" class="me kw in ma b gy mf mg l mh mi">java -jar {path to zipkin jar}/zipkin.jar</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi my"><img src="../Images/78ecabd98753e5131ef3d96606063713.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*i0OVwZ583VSNRbfw"/></div></div></figure><h1 id="18a2" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated"><strong class="ak">步骤 4:从 eclipse 或从 cmd 提示符启动这两个服务。</strong></h1><p id="23be" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">例子—</p><pre class="kj kk kl km gt lz ma mb mc aw md bi"><span id="6ea9" class="me kw in ma b gy mf mg l mh mi">java -javaagent:D:\Installations\opentelemetry-javaagent.jar -Dotel.traces.exporter=zipkin -Dotel.resource.attributes=service.name=student-service -Dotel.metrics.exporter=none -Dotel.exporter.zipkin.endpoint=http://localhost:9411/api/v2/spans -jar school-service.jar</span></pre><p id="0d93" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">启动这两个服务后，您应该能够在控制台上看到代理日志的前几行。</p><pre class="kj kk kl km gt lz ma mb mc aw md bi"><span id="da68" class="me kw in ma b gy mf mg l mh mi">[otel.javaagent 2022-07-20 11:01:04:159 +0530] [main] INFO io.opentelemetry.javaagent.tooling.VersionLogger - opentelemetry-javaagent - version: 1.15.0</span></pre><p id="565d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">通过点击 URL 来测试服务</p><p id="afc8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><a class="ae ku" href="http://localhost:9001/school-details/abcschool." rel="noopener ugc nofollow" target="_blank">T18】http://localhost:9001/school-details/ABC school。 </a></p><p id="96b1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">学校服务</strong>将点击<strong class="jm io">学生服务</strong>并在浏览器上以 JSON 格式返回响应。</p><pre class="kj kk kl km gt lz ma mb mc aw md bi"><span id="fae7" class="me kw in ma b gy mf mg l mh mi">School Name - abcschool Student Details [{"name":"Sajal","className":"Class IV"},{"name":"Lokesh","className":"Class V"}]</span></pre><h1 id="78d2" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">第 5 步:在 Zipkin UI 中查看踪迹。</h1><p id="ebf2" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">让我们在浏览器上通过点击</p><p id="7609" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><a class="ae ku" href="http://localhost:9411/zipkin/" rel="noopener ugc nofollow" target="_blank"><strong class="jm io">http://localhost:9411/zipkin/</strong></a></p><p id="9f3d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">点击<strong class="jm io">运行查询</strong>按钮查看痕迹</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mz"><img src="../Images/9a834b743c8d09e708d3e975d8b96e99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*byZs3lwz9TeZxbbDS7EerQ.png"/></div></div><figcaption class="mu mv gj gh gi mw mx bd b be z dk translated">Zipkin UI</figcaption></figure><p id="fd6c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如您所见，追踪信息现在可以在<strong class="jm io"> Zipkin </strong> UI 上看到。它显示了作为跟踪请求的一部分调用的方法和端点。您还可以在右侧窗格中看到其他属性。这些属性是由 java 代理自动生成的。您还可以将自定义属性添加到跟踪数据中，以便对处理跟踪进行更精细的控制。</p><p id="b676" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">你可以在<strong class="jm io"> Zipkin UI </strong>上看到痕迹，这是一个很好的开始。<strong class="jm io"> Kudos </strong>！！</p><p id="2dc5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">关联日志- </strong></p><p id="a400" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在上面的例子中，各个服务的日志仍然没有关联。也就是说，如果有 100 个来自浏览器的请求，我们无法判断哪些日志语句属于两个服务上的哪个请求。我们需要一个惟一的标识符，比如可以以一种<strong class="jm io">自动化</strong>的方式注入日志语句的<strong class="jm io"> TraceId </strong>，然后可以用它来关联日志。</p><p id="5aad" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">关联前的日志-</p><pre class="kj kk kl km gt lz ma mb mc aw md bi"><span id="f867" class="me kw in ma b gy mf mg l mh mi">/\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \<br/>( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \<br/> \\/  ___)| |_)| | | | | || (_| |  ) ) ) )<br/>  '  |____| .__|_| |_|_| |_\__, | / / / /<br/> =========|_|==============|___/=/_/_/_/<br/> :: Spring Boot ::                (v2.6.9)<br/><br/>2022-07-20 11:16:15.301  INFO 25032 --- [           main] c.n.o.o.OtelTracingSchoolApplication     : Starting OtelTracingSchoolApplication using Java 17.0.2 on DESKTOP-9OJQPJ2 with PID 25032 (D:\git\otel-tracing-schoolservice\target\classes started by Nitin in D:\git\otel-tracing-schoolservice)<br/>2022-07-20 11:16:15.332  INFO 25032 --- [           main] c.n.o.o.OtelTracingSchoolApplication     : No active profile set, falling back to 1 default profile: "default"<br/>2022-07-20 11:16:18.267  INFO 25032 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat initialized with port(s): 9001 (http)<br/>2022-07-20 11:16:18.379  INFO 25032 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]<br/>2022-07-20 11:16:18.380  INFO 25032 --- [           main] org.apache.catalina.core.StandardEngine  : Starting Servlet engine: [Apache Tomcat/9.0.64]<br/>2022-07-20 11:16:18.665  INFO 25032 --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext<br/>2022-07-20 11:16:18.665  INFO 25032 --- [           main] w.s.c.ServletWebServerApplicationContext : Root WebApplicationContext: initialization completed in 3202 ms<br/>2022-07-20 11:16:19.807  INFO 25032 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 9001 (http) with context path ''<br/>2022-07-20 11:16:19.831  INFO 25032 --- [           main] c.n.o.o.OtelTracingSchoolApplication     : Started OtelTracingSchoolApplication in 5.837 seconds (JVM running for 9.663)<br/>2022-07-20 11:16:20.297  INFO 25032 --- [nio-9001-exec-1] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring DispatcherServlet 'dispatcherServlet'<br/>2022-07-20 11:16:20.298  INFO 25032 --- [nio-9001-exec-1] o.s.web.servlet.DispatcherServlet        : Initializing Servlet 'dispatcherServlet'<br/>2022-07-20 11:16:20.301  INFO 25032 --- [nio-9001-exec-1] o.s.web.servlet.DispatcherServlet        : Completed initialization in 2 ms<br/>School service is Healthy<br/>School service is Healthy<br/>Getting School details for abcschool<br/>Response Received as [{"name":"Sajal","className":"Class IV"},{"name":"Lokesh","className":"Class V"}]</span></pre><p id="d377" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在让我们使用 OpenTelemetry 的强大功能将<strong class="jm io"> TraceId </strong>注入到我们服务的每个请求的日志语句中。</p><p id="6372" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">步骤 1:将 OpenTelemetry 日志依赖项添加到 pom 文件中。</strong></p><pre class="kj kk kl km gt lz ma mb mc aw md bi"><span id="3df4" class="me kw in ma b gy mf mg l mh mi">&lt;!-- https://mvnrepository.com/artifact/io.opentelemetry.instrumentation/opentelemetry-logback-1.0 --&gt;</span><span id="22f2" class="me kw in ma b gy mj mg l mh mi">&lt;dependency&gt;<br/>&lt;groupId&gt;io.opentelemetry.instrumentation&lt;/groupId&gt;  &lt;artifactId&gt;opentelemetry-logback-1.0&lt;/artifactId&gt;<br/>&lt;version&gt;1.9.2-alpha&lt;/version&gt;<br/>&lt;scope&gt;runtime&lt;/scope&gt;<br/>&lt;/dependency&gt;</span></pre><p id="9220" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">第二步:在 logback.xml 中添加自定义包装器到日志 appender</strong></p><p id="2a96" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">示例- logback.xml</p><pre class="kj kk kl km gt lz ma mb mc aw md bi"><span id="6f96" class="me kw in ma b gy mf mg l mh mi">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;<br/>&lt;configuration&gt;<br/>&lt;appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender"&gt;&lt;encoder&gt;<br/>  &lt;pattern&gt;&lt;![CDATA[%date{HH:mm:ss.SSS} [%thread] %-5level %logger{15}#%line %X{req.requestURI} traceId: %X{trace_id} spanId: %X{span_id} %msg\n]]&gt;&lt;/pattern&gt;<br/>&lt;/encoder&gt;<br/>&lt;/appender&gt;</span><span id="7568" class="me kw in ma b gy mj mg l mh mi">&lt;appender name="OTEL" class="io.opentelemetry.instrumentation.logback.v1_0.OpenTelemetryAppender"&gt;<br/>   &lt;appender-ref ref="STDOUT" /&gt;<br/>&lt;/appender&gt;</span><span id="a1cc" class="me kw in ma b gy mj mg l mh mi">&lt;root&gt;<br/>  &lt;level value="INFO" /&gt;<br/>  &lt;appender-ref ref="STDOUT" /&gt;<br/>&lt;/root&gt;<br/>&lt;/configuration&gt;</span></pre><p id="8114" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让我们重新启动服务，现在您可以看到<strong class="jm io"> TraceId </strong>被附加到跨服务的日志中。</p><pre class="kj kk kl km gt lz ma mb mc aw md bi"><span id="bcee" class="me kw in ma b gy mf mg l mh mi">13:50:23.158 [http-nio-9001-exec-1] INFO o.s.w.s.DispatcherServlet#547 traceId: 241abff9a2782b4dc3e161225c47eecb spanId: aa4211e7549e3c79 Completed initialization in 2 ms<br/>13:50:23.305 [http-nio-9001-exec-1] INFO c.n.o.o.SchoolServiceController#25 <strong class="ma io">traceId: 241abff9a2782b4dc3e161225c47eecb spanId: 4594f9ef350d0a26</strong> Getting School details for abcschool<br/>13:50:24.283 [http-nio-9001-exec-1] INFO c.n.o.o.SchoolServiceController#30 <strong class="ma io">traceId: 241abff9a2782b4dc3e161225c47eecb spanId: 4594f9ef350d0a26</strong> Response Received as [{"name":"Sajal","className":"Class IV"},{"name":"Lokesh","className":"Class V"}]</span></pre><p id="e6e8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">希望您能够使用 OpenTelemetry 代理并成功地跟踪和查看服务，还能够使用<strong class="jm io"> TraceId </strong>跟踪日志。</p><p id="fe39" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在本系列 的第 3 部分<a class="ae ku" href="https://nitin-rohidas.medium.com/introduction-to-opentelemetry-distributed-tracing-part-iii-9b1bce59c1bd" rel="noopener"> <strong class="jm io">中，我们将更详细地介绍使用<strong class="jm io">弹性搜索</strong>来确保我们能够持久存储我们的跟踪信息。我们还将关注添加<strong class="jm io">业务标识符</strong>的定制，以便于理解和使用跟踪数据。在以后的文章中，我还将介绍 Otel 收集器的概念。</strong></a></p></div></div>    
</body>
</html>