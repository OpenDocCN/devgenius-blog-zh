<html>
<head>
<title>Server-Side Development with Hapi.js — Sessions and Advanced HTTP Requests</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Hapi.js 进行服务器端开发—会话和高级 HTTP 请求</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/server-side-development-with-hapi-js-sessions-and-advanced-http-requests-be0abc5114d5?source=collection_archive---------0-----------------------#2021-02-27">https://blog.devgenius.io/server-side-development-with-hapi-js-sessions-and-advanced-http-requests-be0abc5114d5?source=collection_archive---------0-----------------------#2021-02-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/ca5e346bff533ad8cd1ab64a0d4e5362.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*GePYaibnzGnLpKaK"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">图片由<a class="ae kc" href="https://unsplash.com/@enka80?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> nine koepfer </a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="df14" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Hapi.js 是一个用于开发后端 web 应用程序的小型节点框架。</p><p id="af85" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将看看如何用 Hapi.js 创建后端应用程序。</p><h1 id="e4db" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">高级 HTTP 请求</h1><p id="1012" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以用<code class="fe me mf mg mh b">@hapi/wreck</code>模块发出复杂的 HTTP 请求。</p><p id="eab0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="9cd5" class="mq lc iq mh b gy mr ms l mt mu">const Wreck = require('@hapi/wreck');<br/>const Https = require('https')<br/>const Http = require('http')</span><span id="5814" class="mq lc iq mh b gy mv ms l mt mu">const method = 'GET';<br/>const uri = '/';<br/>const readableStream = Wreck.toReadableStream('foo=bar');</span><span id="5962" class="mq lc iq mh b gy mv ms l mt mu">const wreck = Wreck.defaults({<br/>  headers: { 'x-foo-bar': 123 },<br/>  agents: {<br/>    https: new Https.Agent({ maxSockets: 100 }),<br/>    http: new Http.Agent({ maxSockets: 1000 }),<br/>    httpsAllowUnauthorized: new Https.Agent({ maxSockets: 100, rejectUnauthorized: false })<br/>  }<br/>});</span><span id="3425" class="mq lc iq mh b gy mv ms l mt mu">const wreckWithTimeout = wreck.defaults({<br/>  timeout: 5<br/>});</span><span id="d48a" class="mq lc iq mh b gy mv ms l mt mu">const options = {<br/>  baseUrl: 'https://www.example.com',<br/>  payload: readableStream || 'foo=bar' || Buffer.from('foo=bar'),<br/>  headers: {},<br/>  redirects: 3,<br/>  beforeRedirect: (redirectMethod, statusCode, location, resHeaders, redirectOptions, next) =&gt; next(),<br/>  redirected: function (statusCode, location, req) {},<br/>  timeout: 1000,<br/>  maxBytes: 1048576,<br/>  rejectUnauthorized: false,<br/>  agent: null,  <br/>};</span><span id="31cb" class="mq lc iq mh b gy mv ms l mt mu">const example = async () =&gt; {<br/>  const promise = wreck.request(method, uri, options);<br/>  try {<br/>    const res = await promise;<br/>    const body = await Wreck.read(res, options);<br/>    console.log(body.toString());<br/>  }<br/>  catch (err) {<br/>    console.log(err)<br/>  }<br/>};</span><span id="1997" class="mq lc iq mh b gy mv ms l mt mu">example()</span></pre><p id="4986" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">属性有请求头。</p><p id="6aa4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">timeout</code>具有以毫秒为单位的请求超时。</p><p id="1a32" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">maxBytes</code>具有请求的最大大小。</p><p id="afdc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">agent</code>拥有用户代理。</p><p id="f371" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以添加的<code class="fe me mf mg mh b">secureProtocol</code>是要使用的 SSL 方法。</p><p id="ec8e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">并且可以添加<code class="fe me mf mg mh b">ciphers</code>属性来选择 TLS 密码。</p><p id="f4cd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们使用<code class="fe me mf mg mh b">Wreck.read</code>来读取响应。</p><p id="8586" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们也可以调用<code class="fe me mf mg mh b">promise.req.abort()</code>来中止请求。</p><h1 id="eb89" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">会话处理</h1><p id="faa8" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以用<code class="fe me mf mg mh b">@hapi/yar</code>模块处理会话数据。</p><p id="99fa" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="9294" class="mq lc iq mh b gy mr ms l mt mu">const Hapi = require('@hapi/hapi');</span><span id="24e5" class="mq lc iq mh b gy mv ms l mt mu">const server = Hapi.Server({ port: 3000 });<br/>const options = {<br/>  storeBlank: false,<br/>  cookieOptions: {<br/>    password: 'the-password-must-be-at-least-32-characters-long'    <br/>  }<br/>};</span><span id="8677" class="mq lc iq mh b gy mv ms l mt mu">const init = async () =&gt; {  <br/>  await server.register({<br/>    plugin: require('@hapi/yar'),<br/>    options<br/>  });</span><span id="075f" class="mq lc iq mh b gy mv ms l mt mu">  server.route({ <br/>    method: 'GET', <br/>    path: '/', <br/>    handler: (request, h) =&gt; {<br/>      request.yar.set('example', { key: 'value' });<br/>      return 'hello';<br/>    }<br/>  });</span><span id="3d44" class="mq lc iq mh b gy mv ms l mt mu">  server.route({ <br/>    method: 'GET', <br/>    path: '/session', <br/>    handler: (request, h) =&gt; {<br/>      const example = request.yar.get('example');      <br/>      return example;<br/>    }<br/>  });</span><span id="4c68" class="mq lc iq mh b gy mv ms l mt mu">  await server.start();<br/>  console.log('Server running at:', server.info.uri);<br/>};<br/>init();</span></pre><p id="5162" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">注册<code class="fe me mf mg mh b">@hapi/yar</code>插件:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="344f" class="mq lc iq mh b gy mr ms l mt mu">await server.register({<br/>  plugin: require('@hapi/yar'),<br/>  options<br/>});</span></pre><p id="47f8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">options</code>属性具有<code class="fe me mf mg mh b">cookieOptions.password</code>属性，用于设置加密会话的密码。</p><p id="de06" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后在<code class="fe me mf mg mh b">/</code>路由中，我们调用<code class="fe me mf mg mh b">request.yar.set</code>方法将键和值添加到会话中。</p><p id="f92c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后在<code class="fe me mf mg mh b">/session</code>路径中，我们用想要得到的键调用<code class="fe me mf mg mh b">request.yar.get</code>方法来获取数据。</p><p id="146f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们应该得到:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="a70a" class="mq lc iq mh b gy mr ms l mt mu">{<br/>  "key": "value"<br/>}</span></pre><p id="b6bf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">作为回应。</p><h1 id="6bdf" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="7d4d" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以使用<code class="fe me mf mg mh b">@hapi/wreck</code>模块发出高级 HTTP 请求。</p><p id="4c24" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">@hapi/yar</code>模块让我们可以管理应用程序中的会话数据。</p></div></div>    
</body>
</html>