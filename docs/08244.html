<html>
<head>
<title>Short.io Integration with Twilio — Ruby App</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Short.io 与 Twilio — Ruby 应用程序的集成</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/short-io-integration-with-twilio-ruby-app-6fa005f60e46?source=collection_archive---------15-----------------------#2022-05-29">https://blog.devgenius.io/short-io-integration-with-twilio-ruby-app-6fa005f60e46?source=collection_archive---------15-----------------------#2022-05-29</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="1753" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">Twilio 是一种用于发送短信的流行服务。有时需要在这些消息中发送 URL 然而，这些网址会很快变长，所以人们喜欢在发送短信之前使用网址缩写服务来缩短网址。Short.io 是一个<strong class="jm io">品牌的</strong>网址缩写服务。<strong class="jm io">无品牌的</strong> URL(即 Bitly、TinyURL 和其他)是有风险的，因为一些移动运营商(威瑞森👀我看你)会<strong class="jm io">屏蔽包含无品牌短链接的短信</strong>。</p><p id="ee35" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在本指南中，我们将通过一种方法来集成 short.io 和 Twilio，以发送带有短链接的 SMS 消息。代码示例是使用 vanilla Ruby 完成的；然而，这些方法也可以被带到一个<strong class="jm io"> Rails 应用</strong>中。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/ce66c3e5dc45343d6be11e7b5e542c9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8o92UcGGFm8EMVd7"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@ademay?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Adem may</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure></div><div class="ab cl kz la hr lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="ig ih ii ij ik"><h1 id="516e" class="lg lh in bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated"><strong class="ak">高级概述</strong></h1><p id="4c38" class="pw-post-body-paragraph jk jl in jm b jn me jp jq jr mf jt ju jv mg jx jy jz mh kb kc kd mi kf kg kh ig bi translated">解释程序架构的图表。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mj"><img src="../Images/cc7a417286d936e1dae10d2e8fff46ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x_cDrIRUXZOpBWcy2pe4Kw.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">Twilio — short.io 与 Ruby App 的集成</figcaption></figure><ol class=""><li id="6dad" class="mk ml in jm b jn jo jr js jv mm jz mn kd mo kh mp mq mr ms bi translated">我们的服务器向 short.io API 发送包含原始 URL 的<strong class="jm io"> POST </strong>请求</li><li id="d727" class="mk ml in jm b jn mt jr mu jv mv jz mw kd mx kh mp mq mr ms bi translated">short.io 发送回一个包含短 URL 等信息的响应</li><li id="f622" class="mk ml in jm b jn mt jr mu jv mv jz mw kd mx kh mp mq mr ms bi translated">我们的服务器向 Twilio 发送一个<strong class="jm io"> POST </strong>请求，其中包含发送方号码、接收方号码和 SMS 消息(带有短 url)等信息</li><li id="f03d" class="mk ml in jm b jn mt jr mu jv mv jz mw kd mx kh mp mq mr ms bi translated">Twilio API 服务器将尝试向接收方的手机发送短信</li><li id="6527" class="mk ml in jm b jn mt jr mu jv mv jz mw kd mx kh mp mq mr ms bi translated">Twilio 向我们的服务器发回一个响应，指示成功或失败</li></ol><h1 id="698b" class="lg lh in bd li lj my ll lm ln mz lp lq lr na lt lu lv nb lx ly lz nc mb mc md bi translated"><strong class="ak">第三方宝石“必需”</strong></h1><p id="65b3" class="pw-post-body-paragraph jk jl in jm b jn me jp jq jr mf jt ju jv mg jx jy jz mh kb kc kd mi kf kg kh ig bi translated">实际上，这个实现并不真正“需要”第三方 gem。以下这些宝石将使开发变得更简单。</p><ol class=""><li id="ae1d" class="mk ml in jm b jn jo jr js jv mm jz mn kd mo kh mp mq mr ms bi translated">httparty:让网络请求变得更简单、更干净。像其他许多宝石一样，这个宝石为 Ruby 中内置的<strong class="jm io"> Net::HTTP </strong>类提供了一个包装。</li><li id="0773" class="mk ml in jm b jn mt jr mu jv mv jz mw kd mx kh mp mq mr ms bi translated">twilio-ruby:由 twilio 创建的帮助函数库，帮助开发者更容易地使用 Twilio 的 API</li><li id="bfb2" class="mk ml in jm b jn mt jr mu jv mv jz mw kd mx kh mp mq mr ms bi translated">我使用这个 gem 来创建一个. env 来存储/访问 API 凭证</li></ol><h1 id="600b" class="lg lh in bd li lj my ll lm ln mz lp lq lr na lt lu lv nb lx ly lz nc mb mc md bi translated"><strong class="ak">构建请求</strong></h1><p id="3459" class="pw-post-body-paragraph jk jl in jm b jn me jp jq jr mf jt ju jv mg jx jy jz mh kb kc kd mi kf kg kh ig bi translated">与 API 通信本质上就是发送带有正确标题的请求并期待响应。下表显示了如何构造对 short.io 的请求</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nd"><img src="../Images/7df6c8efaefce047f97476891229f7ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jD5T_RuUQugU6gNG9LMoEg.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">简称 io 的请求结构</figcaption></figure><p id="cd82" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">从<a class="ae ky" href="https://developers.short.io/docs/cre" rel="noopener ugc nofollow" target="_blank">这里</a>获取你的 short.io API 密匙。对于几何体，表中仅列出了所需的参数。点击这里查看更多<a class="ae ky" href="https://developers.short.io/reference/linkspost" rel="noopener ugc nofollow" target="_blank">选项</a>。</p><p id="5fd6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">使用 twilio-ruby gem 的美妙之处在于，它允许我们绕过配置和直接与网络请求及其报头交互的折磨。这让我们可以专注于更重要的事情，如设置身体。不过，如果你想手动做事，我也提供了下面的表格。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ne"><img src="../Images/698184c4759fb9d193ea941af3752d6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a9tMgbL3N-vdS8ufiXmdpQ.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">Twilio 的请求结构</figcaption></figure><p id="d338" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这里的授权使用<a class="ae ky" href="https://en.wikipedia.org/wiki/Basic_access_authentication" rel="noopener ugc nofollow" target="_blank">基本授权</a>。请务必在此处获得您的 Twilio 证书<a class="ae ky" href="https://www.twilio.com/docs/usage/requests-to-twilio#credentials" rel="noopener ugc nofollow" target="_blank">。注意:我们使用选项 2 (API 密钥)。这个选项比使用主密钥的第一个选项安全得多，因为您可以创建多个 API 密钥，如果它们被破坏，您可以撤销它们。</a></p><p id="5ade" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><a class="ae ky" href="https://www.twilio.com/docs/sms/api/message-resource#create-a-message-resource" rel="noopener ugc nofollow" target="_blank">这里的</a>是你也可以传递的可选身体参数列表。</p></div><div class="ab cl kz la hr lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="ig ih ii ij ik"><p id="72f9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">好戏开始了。我们现在会看到很多代码，但是不要担心。我会边走边解释。我使用类是因为它给了我们在未来通过添加更多方法来扩展 short.io 和 Twilio 服务的灵活性(也许我想处理语音呼叫)。</p><h1 id="6960" class="lg lh in bd li lj my ll lm ln mz lp lq lr na lt lu lv nb lx ly lz nc mb mc md bi translated"><strong class="ak"> Short.io 类</strong></h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nf"><img src="../Images/a5d1a3139ae6f8f4f6b0923fbac3bc05.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_4E63UId6G4rRWOPYvN9-g.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">short.io 类</figcaption></figure><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="0763" class="nl lh in nh b gy nm nn l no np">require "json"<br/>require "httparty"</span></pre><p id="9015" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">需要宝石。httparty 用于处理网络请求，json 用于转换/解析请求体和响应。(还记得<strong class="jm io"> Content-Type </strong>头被设置为 json 吗？？？)</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="e34c" class="nl lh in nh b gy nm nn l no np">attr_reader :short_url</span></pre><p id="a2f6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">设置一个名为 short_url 的实例变量来存储我们的短 url，并将其设为只读。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="52f3" class="nl lh in nh b gy nm nn l no np">include HTTParty<br/>base_uri "https://api.short.io/"<br/>headers "Accept" =&gt; "application/json"<br/>headers "Content-Type" =&gt; "application/json"</span></pre><p id="9862" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">包括 HTTParty 模块和 set 头。诸如 base_uri、headers…等方法是 HTTParty 的一部分。因此，我们需要将它包含在我们的课程中。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="96fa" class="nl lh in nh b gy nm nn l no np">def initialize(short_domain = nil, api_key = nil)<br/>  @short_domain = short_domain<br/>  @short_api_key = api_key<br/>  @short_url = nil<br/>end</span></pre><p id="713b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这是我们的构造函数，它设置我们的类实例变量。我们传入我们的 short.io 域名和 API 密钥。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="a840" class="nl lh in nh b gy nm nn l no np">def create_short_url(original_url = nil)<br/>  .....  <br/>  Code is too long to paste here 😅<br/>  .....<br/>end</span></pre><p id="6f14" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这个实例方法将我们的主体和授权头包装到一个名为 params 的变量中。使用 httparty 发出带有路径“/links”和参数的 POST 请求。JSON 响应返回，我们提取 shortURL 并将其存储在名为 short_url 的实例变量中</p><h1 id="705c" class="lg lh in bd li lj my ll lm ln mz lp lq lr na lt lu lv nb lx ly lz nc mb mc md bi translated"><strong class="ak"> Twilio 类</strong></h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nq"><img src="../Images/9138c960175d1f61d0fbbcaf2ce2e614.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GSrqTem4cyjB-hsMyFWBLQ.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">Twilio 级</figcaption></figure><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="e71c" class="nl lh in nh b gy nm nn l no np">require "twilio-ruby"</span></pre><p id="0ac9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">需要宝石。twilio-ruby gem 是一个我们可以使用的有用方法库。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="df99" class="nl lh in nh b gy nm nn l no np">attr_writer :api_key, :api_secret, :acc_sid</span></pre><p id="290b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们创建实例变量来存储凭证；然而，为了额外的安全，它们只能被设置而不能被读取。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="fd73" class="nl lh in nh b gy nm nn l no np">def initialize(api_key = nil, api_secret = nil, acc_sid = nil)<br/>  @api_key = api_key<br/>  @api_secret = api_secret<br/>  @acc_sid = acc_sid<br/>  @client = Twilio::REST::Client.new(api_key, api_secret, acc_sid)<br/>end</span></pre><p id="3381" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们的构造函数设置实例变量的初始值。还创建了一个<strong class="jm io"> Twilio 客户端</strong>对象，并将其设置为客户端实例变量。Twilio 客户端对象将允许我们建立与 Twilio 的连接，并与他们的 API 服务进行交互。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="9b2a" class="nl lh in nh b gy nm nn l no np">def send_sms(params = nil)<br/>  from = params[:From]<br/>  body = params.key?(:URL) ? params[:Body] + params[:URL] : params[:Body]<br/>  to = params[:To]<br/>  <em class="nr"># returns a twilio API message object<br/>  # refer to docs: </em><a class="ae ky" href="https://www.twilio.com/docs/sms/api/message-resource#message-properties" rel="noopener ugc nofollow" target="_blank"><em class="nr">https://www.twilio.com/docs/sms/api/message-  resource#message-properties</em></a><em class="nr"><br/>  </em>@client.messages.create(<br/>    from: from,<br/>    body: body,<br/>    to: to<br/>  )<br/>end</span></pre><p id="764b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">包含必需的键/值对(:From，:Body，:To)的 params 散列与可选键一起传递。为了发送 SMS，Twilio 客户端对象中的 message 类的一个名为<strong class="jm io"> create </strong>的实例方法被 params 中的内容调用。</p><p id="c92c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">最棒的是，我们不需要手动定义请求头和设置任何 API 端点，因为 twilio-ruby 助手会在我们创建新客户端时在幕后为我们完成这些工作。</p><h1 id="13c4" class="lg lh in bd li lj my ll lm ln mz lp lq lr na lt lu lv nb lx ly lz nc mb mc md bi translated"><strong class="ak">我们来测试一下吧！</strong></h1><p id="730e" class="pw-post-body-paragraph jk jl in jm b jn me jp jq jr mf jt ju jv mg jx jy jz mh kb kc kd mi kf kg kh ig bi translated">是时候把所有东西放在一起，看看我们的劳动成果了🍇。在一个名为<strong class="jm io"> main </strong>的单独文件中，我添加了以下代码。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/c24728ee2b31b7b876d69020fb87576c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sij6SlaJM9P37B4Ux4siKg.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">main.rb</figcaption></figure><p id="123e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">因为我使用 gem <strong class="jm io"> dotenv </strong>将我的 API 凭证存储在环境变量中，所以我需要加载它们。我还需要我们的 short.io 和 Twilio 类。</p><p id="f830" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">接下来，用域和 API 键实例化一个新的 short.io 对象。我们调用<strong class="jm io"> create_short_url </strong>实例方法传入一个长 url(请点击它😉).</p><p id="ba65" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">一个新的 Twilio 对象是用传入的 Twilio 凭证创建的。最后，调用<strong class="jm io"> send_sms </strong>实例方法以及 params 散列来发送我们的 sms！🥳🥳🥳</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/1a2d96776f5ae7149e20520dc50ab474.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h6wq3C_RjxYuh_8byPp9kA.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">带有短 URL 的短信</figcaption></figure></div><div class="ab cl kz la hr lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="ig ih ii ij ik"><h1 id="3ab9" class="lg lh in bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">资源</h1><p id="70f2" class="pw-post-body-paragraph jk jl in jm b jn me jp jq jr mf jt ju jv mg jx jy jz mh kb kc kd mi kf kg kh ig bi translated">本教程也可以作为 git repo <a class="ae ky" href="https://github.com/xihai01/twilio-short.io-integration-ruby" rel="noopener ugc nofollow" target="_blank">在这里</a>获得。你可以随意使用它，克隆它，玩它。如果你喜欢或发现这篇文章有帮助，请喜欢并分享它！此外，请随意留下您可能有的任何建议或意见。我一定会回复所有的评论！</p><p id="0a97" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><a class="ae ky" href="https://developers.short.io/reference/linkspost" rel="noopener ugc nofollow" target="_blank">创建链接的 short.io API 参考</a></p><p id="1f70" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><a class="ae ky" href="https://www.twilio.com/docs/sms/api/message-resource#message-properties" rel="noopener ugc nofollow" target="_blank"> Twilio SMS API 参考</a></p></div></div>    
</body>
</html>