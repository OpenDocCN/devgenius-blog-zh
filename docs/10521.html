<html>
<head>
<title>Coding GraphQL Gateway Service</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">编码 GraphQL 网关服务</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/coding-graphql-gateway-service-b8516d4052d4?source=collection_archive---------15-----------------------#2022-11-07">https://blog.devgenius.io/coding-graphql-gateway-service-b8516d4052d4?source=collection_archive---------15-----------------------#2022-11-07</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="7eff" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">本内容面向那些对 REST 和 GraphQL 有基本了解的工程师。我们将陆续公布以下内容。</p><p id="fe19" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"># 1<a class="ae ki" href="https://medium.com/@sofikul.m/design-my-todos-project-with-graphql-rest-microservices-482cffc7729b" rel="noopener">my-todos 项目设计</a></p><p id="a0eb" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><a class="ae ki" href="https://medium.com/@sofikul.m/coding-graphql-services-eafd9235fdf7" rel="noopener"> #2 编码 GraphQL 服务(我们在本文中)</a></p><p id="3a7c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><a class="ae ki" href="https://medium.com/@sofikul.m/6894d6f40ac0" rel="noopener"> #3 GraphQL 服务认证和授权</a></p><p id="0fc4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"><em class="kj">【4 #编码 GraphQL 网关服务(我们在这里)</em> </strong></p><p id="2c13" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">#5 使用 Nuxt 编码 my-todos web</p><p id="fb0b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">#6 所有服务的部署</p></div><div class="ab cl kk kl hr km" role="separator"><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp"/></div><div class="ig ih ii ij ik"><h1 id="cc11" class="kr ks in bd kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo bi translated">我们要在这里讨论什么？</h1><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div class="gh gi lp"><img src="../Images/d9795c968daece8789927560be19befa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1348/format:webp/1*q3Ri4gP2tNSf2tNqxfRRcA.png"/></div></figure><p id="df35" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们已经开发了子图(如用户服务)。现在是时候将它们缝合在一个 GraphQL 服务(称为网关服务)中，该服务将向消费者公开。这个网关服务将合并上述服务，其中一个是用户 GraphQL 服务(在 Node express apollo 服务器中开发)，另一个是任务 rest 服务(Node express 服务器)。</p></div><div class="ab cl kk kl hr km" role="separator"><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp"/></div><div class="ig ih ii ij ik"><h1 id="4354" class="kr ks in bd kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo bi translated">技术栈</h1><p id="22d9" class="pw-post-body-paragraph jk jl in jm b jn lx jp jq jr ly jt ju jv lz jx jy jz ma kb kc kd mb kf kg kh ig bi translated">我们将用于构建 GraphQL 服务的技术堆栈</p><ul class=""><li id="cc30" class="mc md in jm b jn jo jr js jv me jz mf kd mg kh mh mi mj mk bi translated">节点(快速框架)</li><li id="6845" class="mc md in jm b jn ml jr mm jv mn jz mo kd mp kh mh mi mj mk bi translated">Apollo GraphQL 服务器</li><li id="dcdb" class="mc md in jm b jn ml jr mm jv mn jz mo kd mp kh mh mi mj mk bi translated">以打字打的文件</li><li id="22c2" class="mc md in jm b jn ml jr mm jv mn jz mo kd mp kh mh mi mj mk bi translated">GraphQL 库(graphql 工具缝合库等)</li></ul><p id="a976" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">说得够多了，我们将马上着手实施👨‍💻。深呼吸😊专注于👇</p><h1 id="fa4e" class="kr ks in bd kt ku mq kw kx ky mr la lb lc ms le lf lg mt li lj lk mu lm ln lo bi translated">项目结构</h1><p id="21d1" class="pw-post-body-paragraph jk jl in jm b jn lx jp jq jr ly jt ju jv lz jx jy jz ma kb kc kd mb kf kg kh ig bi translated">让我们首先决定我们的项目结构。现在我有以下内容给你。完整结构见<a class="ae ki" href="https://github.com/Sofiukl/my-todos-gateway-gql" rel="noopener ugc nofollow" target="_blank">本</a>。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/ead8996314688b312c96e7f27c1a7171.png" data-original-src="https://miro.medium.com/v2/resize:fit:490/format:webp/1*Tqj-6dxlM4YGNiEr0rbqeA.png"/></div></figure><figure class="lq lr ls lt gt lu"><div class="bz fp l di"><div class="mw mx l"/></div></figure><h1 id="cd48" class="kr ks in bd kt ku mq kw kx ky mr la lb lc ms le lf lg mt li lj lk mu lm ln lo bi translated">项目开发</h1><h2 id="4a15" class="my ks in bd kt mz na dn kx nb nc dp lb jv nd ne lf jz nf ng lj kd nh ni ln nj bi translated">#01 图表 SQL 模式</h2><p id="d355" class="pw-post-body-paragraph jk jl in jm b jn lx jp jq jr ly jt ju jv lz jx jy jz ma kb kc kd mb kf kg kh ig bi translated">我们需要在网关中处理多个模式，因为该服务将合并几个子图。</p><ul class=""><li id="6d01" class="mc md in jm b jn jo jr js jv me jz mf kd mg kh mh mi mj mk bi translated"><strong class="jm io"> <em class="kj">用户服务模式</em> </strong>:该模式在用户服务中定义，将被远程获取。</li><li id="acc8" class="mc md in jm b jn ml jr mm jv mn jz mo kd mp kh mh mi mj mk bi translated"><strong class="jm io"> <em class="kj">任务 rest 服务</em> </strong> <em class="kj"> : </em>模式定义需要在网关服务中创建，至于 REST 服务我们没有现有的模式。让我们首先创建它。</li></ul><figure class="lq lr ls lt gt lu"><div class="bz fp l di"><div class="mw mx l"/></div></figure><ul class=""><li id="dc52" class="mc md in jm b jn jo jr js jv me jz mf kd mg kh mh mi mj mk bi translated"><strong class="jm io"> <em class="kj">网关模式:</em> </strong>我们需要一个特定于网关服务的模式，因为我们需要将子图缝合在一起以构建一个完整的功能。</li></ul><figure class="lq lr ls lt gt lu"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="a729" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们在上面做什么</p><ul class=""><li id="49dd" class="mc md in jm b jn jo jr js jv me jz mf kd mg kh mh mi mj mk bi translated">用<code class="fe nk nl nm nn b">todos</code>扩展<code class="fe nk nl nm nn b">GetUserResponse</code>，以便在获取用户响应时返回用户的 todos。</li><li id="46cf" class="mc md in jm b jn ml jr mm jv mn jz mo kd mp kh mh mi mj mk bi translated">使用<code class="fe nk nl nm nn b">user</code>扩展<code class="fe nk nl nm nn b">Todo</code>类型，以便在 get todo 响应中返回 todo 的创建者。</li></ul><h2 id="c686" class="my ks in bd kt mz na dn kx nb nc dp lb jv nd ne lf jz nf ng lj kd nh ni ln nj bi translated">#02 用于类型脚本类型生成的 GraphQL 模式</h2><p id="2e33" class="pw-post-body-paragraph jk jl in jm b jn lx jp jq jr ly jt ju jv lz jx jy jz ma kb kc kd mb kf kg kh ig bi translated">我们在上面的模式中定义了 GetUserResponse，LogInResponse 类型。我们的代码中也需要相应的类型。我们将使用 npm ( <a class="ae ki" href="https://www.npmjs.com/package/@graphql-codegen/cli" rel="noopener ugc nofollow" target="_blank"> @graphql-codegen </a>)从模式文件中自动创建它。</p><p id="90f1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">该库需要一个 codegen.yml 配置文件。</p><figure class="lq lr ls lt gt lu"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="b886" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">您需要运行下面的命令来创建类型。</p><pre class="lq lr ls lt gt no nn np nq aw nr bi"><span id="4530" class="my ks in nn b gy ns nt l nu nv">graphql-codegen --config codegen.yml</span></pre><p id="54dd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">输出将在/src/generated 文件夹下创建。你可以查看我的<a class="ae ki" href="https://github.com/Sofiukl/my-todos-gateway-gql" rel="noopener ugc nofollow" target="_blank">库</a>。</p><h2 id="ea06" class="my ks in bd kt mz na dn kx nb nc dp lb jv nd ne lf jz nf ng lj kd nh ni ln nj bi translated">#03 创建网关 apollo 服务器</h2><p id="5bb8" class="pw-post-body-paragraph jk jl in jm b jn lx jp jq jr ly jt ju jv lz jx jy jz ma kb kc kd mb kf kg kh ig bi translated">在网关服务服务器文件中，我们需要处理比子图的服务器文件更多的东西。</p><ul class=""><li id="512f" class="mc md in jm b jn jo jr js jv me jz mf kd mg kh mh mi mj mk bi translated">提取远程模式</li><li id="775e" class="mc md in jm b jn ml jr mm jv mn jz mo kd mp kh mh mi mj mk bi translated">获取本地模式(如果有)</li><li id="2b39" class="mc md in jm b jn ml jr mm jv mn jz mo kd mp kh mh mi mj mk bi translated">网关模式中的扩展类型</li><li id="8c0a" class="mc md in jm b jn ml jr mm jv mn jz mo kd mp kh mh mi mj mk bi translated">为所有扩展类型定义冲突解决程序</li><li id="87ee" class="mc md in jm b jn ml jr mm jv mn jz mo kd mp kh mh mi mj mk bi translated">包括数据源(如果有)</li></ul><figure class="lq lr ls lt gt lu"><div class="bz fp l di"><div class="mw mx l"/></div></figure><ul class=""><li id="eea1" class="mc md in jm b jn jo jr js jv me jz mf kd mg kh mh mi mj mk bi translated"><em class="kj">获取所有远程模式</em>:远程获取用户服务模式。参考第 50 行</li><li id="bd26" class="mc md in jm b jn ml jr mm jv mn jz mo kd mp kh mh mi mj mk bi translated"><em class="kj">获取本地模式如果任何</em> : Todo 模式只存在于网关服务中，那么我们需要在本地获取它。参考第 52 行</li><li id="7dff" class="mc md in jm b jn ml jr mm jv mn jz mo kd mp kh mh mi mj mk bi translated"><em class="kj">在网关模式中扩展类型</em>:类型扩展将在网关模式中定义。参考文件 schema.graphql</li><li id="1979" class="mc md in jm b jn ml jr mm jv mn jz mo kd mp kh mh mi mj mk bi translated"><em class="kj">为所有扩展类型定义解析器</em>:需要按照网关模式实现所有扩展类型的解析器。参考第 59–91 行</li><li id="f83b" class="mc md in jm b jn ml jr mm jv mn jz mo kd mp kh mh mi mj mk bi translated"><em class="kj">包含数据源(如果有的话)</em>:有时我们有基于我们的实现的外部数据源(如 REST 数据源、SQL 数据源等)，需要在服务器配置的 data source 部分提及。对我们来说，我们将提到 TodoAPI 数据源。参考 117–121</li></ul><p id="59b6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">完整代码可以在我的<a class="ae ki" href="https://github.com/Sofiukl/my-todos-gateway-gql" rel="noopener ugc nofollow" target="_blank">回购</a>中找到。</p><h2 id="4686" class="my ks in bd kt mz na dn kx nb nc dp lb jv nd ne lf jz nf ng lj kd nh ni ln nj bi translated">#04 编写解析器代码</h2><ul class=""><li id="b860" class="mc md in jm b jn lx jr ly jv nw jz nx kd ny kh mh mi mj mk bi translated"><strong class="jm io">用户服务解析器</strong>:不需要为远程模式创建解析器，因为这将从子图服务远程获取。因此，用户服务网关中不需要解析器。</li><li id="04e4" class="mc md in jm b jn ml jr mm jv mn jz mo kd mp kh mh mi mj mk bi translated"><strong class="jm io">任务服务解析器</strong>:由于 todo 服务是一个遗留的 rest 服务，模式和解析器需要在我们的网关服务中创建。</li></ul><figure class="lq lr ls lt gt lu"><div class="bz fp l di"><div class="mw mx l"/></div></figure><ul class=""><li id="9ff5" class="mc md in jm b jn jo jr js jv me jz mf kd mg kh mh mi mj mk bi translated"><strong class="jm io">网关模式解析器</strong>:这已经在 server.ts 文件参考行 59–91 中定义了</li></ul><h2 id="8a9e" class="my ks in bd kt mz na dn kx nb nc dp lb jv nd ne lf jz nf ng lj kd nh ni ln nj bi translated">#05 处理子图的远程授权</h2><p id="2ad4" class="pw-post-body-paragraph jk jl in jm b jn lx jp jq jr ly jt ju jv lz jx jy jz ma kb kc kd mb kf kg kh ig bi translated">由于我们的用户服务受到身份验证的保护，授权头也需要传递给子图服务。我们已经在我们的用户执行器中实现了这一点。参考下文</p><figure class="lq lr ls lt gt lu"><div class="bz fp l di"><div class="mw mx l"/></div></figure><h2 id="dadb" class="my ks in bd kt mz na dn kx nb nc dp lb jv nd ne lf jz nf ng lj kd nh ni ln nj bi translated">#06 在开发模式下运行代码</h2><p id="f727" class="pw-post-body-paragraph jk jl in jm b jn lx jp jq jr ly jt ju jv lz jx jy jz ma kb kc kd mb kf kg kh ig bi translated">下面是我们在 package.json 中定义的脚本</p><pre class="lq lr ls lt gt no nn np nq aw nr bi"><span id="1631" class="my ks in nn b gy ns nt l nu nv">"schema-type": "graphql-codegen --config codegen.yml",<br/>"lint": "eslint . --ext .ts",<br/>"build": "npm run schema-type &amp;&amp; tsc",<br/>"start": "npm run build &amp;&amp; node build/server.js"</span></pre><p id="84ad" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们可以使用<code class="fe nk nl nm nn b">npm run start</code>来运行我们的开发服务器。</p><h2 id="4c39" class="my ks in bd kt mz na dn kx nb nc dp lb jv nd ne lf jz nf ng lj kd nh ni ln nj bi translated">#07 测试 API</h2><p id="67f7" class="pw-post-body-paragraph jk jl in jm b jn lx jp jq jr ly jt ju jv lz jx jy jz ma kb kc kd mb kf kg kh ig bi translated">Apollo server 提供了内置文档和平台，可以非常快速轻松地测试这些特性。</p><p id="fb6c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">运动场将在端点<code class="fe nk nl nm nn b">baseurl/graphql</code>可用，例如<a class="ae ki" href="http://localhost:4000/graphql" rel="noopener ugc nofollow" target="_blank">http://localhost:4000/graph QL</a></p><p id="bddb" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们将测试以下两点</p><p id="09e8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">(1) <strong class="jm io"> <em class="kj">扩展</em> </strong> <code class="fe nk nl nm nn b"><strong class="jm io"><em class="kj">Todo</em></strong></code> <strong class="jm io"> <em class="kj">类型用</em> </strong> <code class="fe nk nl nm nn b"><strong class="jm io"><em class="kj">user</em></strong></code> <strong class="jm io"> <em class="kj">这样 todo 的创建者将在 get todo 响应中返回。</em> </strong></p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="oa ob di oc bf od"><div class="gh gi nz"><img src="../Images/e6463a731807d9c1ba997a482d02f252.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v3lxZwgyuLiOppdg41xkhA.png"/></div></div></figure><p id="434d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> <em class="kj"> (2)用</em> </strong> <code class="fe nk nl nm nn b"><strong class="jm io"><em class="kj">todos</em></strong></code> <strong class="jm io"> <em class="kj">扩展</em> </strong> <code class="fe nk nl nm nn b"><strong class="jm io"><em class="kj">GetUserResponse</em></strong></code> <strong class="jm io"> <em class="kj">以便在得到用户响应时返回用户的 todos。</em> </strong></p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="oa ob di oc bf od"><div class="gh gi nz"><img src="../Images/0d35cb5d3f19b63f9adbc6808297f8a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ABABKEruktFW97v-BEWHgw.png"/></div></div></figure><blockquote class="oe"><p id="d881" class="of og in bd oh oi oj ok ol om on kh dk translated"><em class="oo">🔥恭喜你！您已经定义了您的 GraphQL 网关服务。</em></p></blockquote><h2 id="2801" class="my ks in bd kt mz op dn kx nb oq dp lb jv or ne lf jz os ng lj kd ot ni ln nj bi translated">#08 参考</h2><ul class=""><li id="12e4" class="mc md in jm b jn lx jr ly jv nw jz nx kd ny kh mh mi mj mk bi translated"><a class="ae ki" href="https://www.the-guild.dev/graphql/tools/docs/remote-schemas" rel="noopener ugc nofollow" target="_blank">远程模式</a></li><li id="9f60" class="mc md in jm b jn ml jr mm jv mn jz mo kd mp kh mh mi mj mk bi translated"><a class="ae ki" href="https://www.the-guild.dev/graphql/tools/docs/schema-stitching/stitch-combining-schemas" rel="noopener ugc nofollow" target="_blank">模式拼接</a></li><li id="cefa" class="mc md in jm b jn ml jr mm jv mn jz mo kd mp kh mh mi mj mk bi translated"><a class="ae ki" href="https://www.apollographql.com/docs/apollo-server/v3" rel="noopener ugc nofollow" target="_blank">数据来源</a></li></ul><p id="6a5f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">🌟完整的源代码可以在<a class="ae ki" href="https://github.com/Sofiukl/my-todos-gateway-gql" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="db1b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">想看讲座吗？</p><figure class="lq lr ls lt gt lu"><div class="bz fp l di"><div class="ou mx l"/></div></figure><h1 id="fc0a" class="kr ks in bd kt ku mq kw kx ky mr la lb lc ms le lf lg mt li lj lk mu lm ln lo bi translated">下一步是什么💁</h1><p id="6d86" class="pw-post-body-paragraph jk jl in jm b jn lx jp jq jr ly jt ju jv lz jx jy jz ma kb kc kd mb kf kg kh ig bi translated">庆祝你的学习和成就🎉。我们将在下一篇文章<a class="ae ki" href="https://medium.com/@sofikul.m/coding-my-todos-web-to-consume-graphql-service-1e78302e7a04" rel="noopener"> <em class="kj"> #5 使用 Nuxt </em> </a>编写 my-todos web 中见到您。请订阅，以便在我们发布后立即获得更新。</p><blockquote class="oe"><p id="0235" class="of og in bd oh oi ov ow ox oy oz kh dk translated"><em class="oo">坚持学习！</em></p></blockquote></div></div>    
</body>
</html>