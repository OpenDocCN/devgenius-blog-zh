<html>
<head>
<title>MDC â€” Improve Logging for Debugging</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">MDC â€”æ”¹è¿›è°ƒè¯•æ—¥å¿—è®°å½•</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://blog.devgenius.io/mdc-improving-debugging-logging-bb421a62a195?source=collection_archive---------5-----------------------#2022-02-18">https://blog.devgenius.io/mdc-improving-debugging-logging-bb421a62a195?source=collection_archive---------5-----------------------#2022-02-18</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/56fbb1f3c3b0bfb7a31d4e79ed96fdda.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hG1QyD_nylPOT3a0LAzMEw.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">å»ºç­‘å•†é²å‹ƒåŒæ„ï¼</figcaption></figure><p id="1aa8" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">å°†ä½ çš„æ—¥å¿—æ„å»ºå¾—å’Œ<a class="ae kx" href="http://www.bobthebuilder.com/en-us/" rel="noopener ugc nofollow" target="_blank">å»ºé€ è€…é²å‹ƒ</a>ä¸€æ ·å¥½ğŸ¤ª</p><p id="0901" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">é€šå¸¸ï¼Œåœ¨å¤§å¤šæ•°åç«¯åº”ç”¨ç¨‹åºä¸­ï¼Œçº¿ç¨‹æ± ä¸­çš„ä¸€ä¸ª<em class="ky">ç‹¬ç«‹çº¿ç¨‹å¤„ç†ä¸€ä¸ªå®¢æˆ·ç«¯è¯·æ±‚</em>ã€‚ä¸€æ—¦è¯·æ±‚å®Œæˆï¼Œçº¿ç¨‹å°±è¢«è¿”å›åˆ°çº¿ç¨‹æ± ï¼Œå¹¶ç”Ÿæˆå…¶å…¸å‹çš„æ—¥å¿—ã€‚</p><p id="c908" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">æˆ‘ä»¬è¦è§£å†³ä»€ä¹ˆï¼Ÿè®©æˆ‘ä»¬ä»¥<strong class="kb io">ä¸ºä¾‹</strong>ã€‚<br/>è€ƒè™‘è¿™æ ·ä¸€ç§æƒ…å†µ:ä¸¤ä¸ªç”¨æˆ·<em class="ky">å·²ç»ç™»å½•å¹¶ä»æ•°æ®åº“ä¸­æ£€ç´¢æ•°æ®ã€‚é€šè¿‡åŒºåˆ†çº¿ç¨‹ IDï¼Œå¯ä»¥å¾ˆå®¹æ˜“åœ°çœ‹å‡ºå“ªä¸ªæ—¥å¿—è¯­å¥å±äºå“ªä¸ªè¯·æ±‚ã€‚è¿™ç§åŸºäºçº¿ç¨‹çš„æ—¥å¿—å…³è”æ˜¯ä»å•ä¸ªè¯·æ±‚ä¸­è¯†åˆ«æ‰€æœ‰æ—¥å¿—çš„æœ‰ç”¨æŠ€æœ¯ã€‚ç„¶è€Œï¼Œä½¿ç”¨è¿™ç§æŠ€æœ¯ï¼Œæˆ‘ä»¬æ— æ³•åŒºåˆ†å“ªä¸ªè¯·æ±‚å±äºå“ªä¸ªç”¨æˆ·ã€‚ç°åœ¨ï¼Œå½“å®ç°å¤šçº¿ç¨‹æ—¶ï¼Œäº‹æƒ…å˜å¾—æ›´åŠ æ··ä¹±ã€‚</em></p><p id="aa28" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">éƒ¨åˆ†è§£å†³æ–¹æ¡ˆ</strong> : <br/>å…¶ä¸­ä¸€ç§æ–¹æ³•æ˜¯åœ¨è¯·æ±‚è¿›å…¥æœåŠ¡æ—¶ç”Ÿæˆä¸€ä¸ªæƒŸä¸€çš„ç¼–å·ï¼Œå¹¶åœ¨æ¯ä¸ªæ—¥å¿—è¯­å¥ä¸­æ‰“å°å‡ºæ¥ï¼Œä½†æ˜¯è¿™åˆä¸€æ¬¡å¾ˆéš¾ä¸ç”¨æˆ·ç›¸å…³è”</p><p id="184a" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">è§£å†³æ–¹æ¡ˆ:</strong> <br/>å¦ä¸€ä¸ªè§£å†³æ–¹æ¡ˆæ˜¯ä¸ºæ¯ä¸ªæ—¥å¿—è¯­å¥æ‰“å°<em class="ky">ç”¨æˆ· ID </em>å’Œ<em class="ky">è¯·æ±‚ ID </em>ã€‚<em class="ky">è¯·æ±‚ ID </em>å°†åœ¨å®¢æˆ·ç«¯ç”Ÿæˆã€‚å¯¹äºç”¨æˆ·çš„æ¯ä¸ªè¯·æ±‚ï¼Œè¯·æ±‚ ID éƒ½æ˜¯å”¯ä¸€çš„ã€‚å¦‚æœæœ‰æ¥è‡ªå¤šä¸ªç”¨æˆ·çš„å¹¶å‘è¯·æ±‚ï¼Œè¿™å°†æœ‰åŠ©äºè¯†åˆ«ä¸€ä¸ªè¯·æ±‚(å› ä¸ºæˆ‘ä»¬ä¹Ÿæœ‰<em class="ky">ç”¨æˆ· ID </em>)ã€‚è¿™äº›ä½œä¸º HTTP å¤´ä¸æ¯ä¸ªè¯·æ±‚ä¸€èµ·ä¼ é€’ï¼Œå¹¶é™„åŠ åˆ°æ¯ä¸ªæ—¥å¿—è¡Œã€‚</p><p id="0a96" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">æ–¹æ³•</strong>:<br/><a class="ae kx" href="https://logging.apache.org/log4j/1.2/apidocs/org/apache/log4j/MDC.html" rel="noopener ugc nofollow" target="_blank">MDC</a>æä¾›äº†ä¸€ä¸ªç®€å•çš„é”®/å€¼(map)æœºåˆ¶æ¥æ•è·å°‘é‡çš„å®šåˆ¶è¯Šæ–­æ•°æ®ã€‚å› ä¸ºå®ƒå†…ç½®åœ¨æ—¥å¿—æ¡†æ¶ä¸­ï¼Œæ‰€ä»¥ä» MDC å‘æ¯ä¸ªæ—¥å¿—è¡Œæ·»åŠ å€¼éå¸¸å®¹æ˜“ã€‚log4jã€log4j2 å’Œ SL4J/logback æ”¯æŒ MDCã€‚</p><p id="7a26" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">MDC å…è®¸æˆ‘ä»¬åœ¨ä¸€ä¸ªç±»ä¼¼ map çš„ç»“æ„ä¸­å¡«å……ä¸€äº›ä¿¡æ¯ï¼Œå½“æ—¥å¿—æ¶ˆæ¯è¢«å†™å…¥æ—¶ï¼Œappender å¯ä»¥è®¿é—®è¿™äº›ä¿¡æ¯ã€‚MDC ç»“æ„ä»¥ä¸<em class="ky"> ThreadLocal </em>å˜é‡ç›¸åŒçš„æ–¹å¼åœ¨å†…éƒ¨é™„åŠ åˆ°æ‰§è¡Œçº¿ç¨‹ã€‚</p><p id="ac42" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">é«˜å±‚æƒ³æ³•</strong>æ˜¯:</p><ul class=""><li id="12cf" class="kz la in kb b kc kd kg kh kk lb ko lc ks ld kw le lf lg lh bi translated">åœ¨çº¿ç¨‹å¼€å§‹æ—¶ï¼Œç”¨æ—¥å¿—é™„åŠ å™¨æ‰€éœ€çš„ä¿¡æ¯å¡«å…… MDC</li><li id="4c83" class="kz la in kb b kc li kg lj kk lk ko ll ks lm kw le lf lg lh bi translated">è®°å½•æ¶ˆæ¯</li></ul><p id="f0b9" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">å®ç°</strong> : <br/>åº”ç”¨æ ˆ:<a class="ae kx" href="https://www.java.com/en/download/" rel="noopener ugc nofollow" target="_blank">Java</a>â€”<a class="ae kx" href="http://dropwizard.io/en/stable/" rel="noopener ugc nofollow" target="_blank">drop wizard</a><br/>ç„¶è€Œï¼Œè¿™ç§å®ç°èƒŒåçš„æ€æƒ³é€‚ç”¨äºä»»ä½•æ¡†æ¶ã€‚</p><p id="fe16" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">æ‰€æœ‰èµ„æºçš„æ–¹æ³•æ‹¦æˆªå™¨:</p><pre class="ln lo lp lq gt lr ls lt lu aw lv bi"><span id="9a81" class="lw lx in ls b gy ly lz l ma mb">/**<br/> * @author adesh.nalpet<br/> * created on 20th December 2019<br/> * A resource method interceptor for adding request context to MDC (Logger)<br/> */<br/>@Slf4j<br/>public class RequestContextModule extends AbstractModule {</span><span id="557f" class="lw lx in ls b gy mc lz l ma mb">    @Override<br/>    protected void configure() {<br/>        final RequestContextInterceptor requestContextInterceptor = new RequestContextInterceptor();<br/>        requestInjection(requestContextInterceptor);<br/>        bindInterceptor(Matchers.any(), Matchers.annotatedWith(Path.class), requestContextInterceptor);<br/>    }</span><span id="bb89" class="lw lx in ls b gy mc lz l ma mb">    @VisibleForTesting<br/>    public static class RequestContextInterceptor implements MethodInterceptor {</span><span id="16dc" class="lw lx in ls b gy mc lz l ma mb">        @Override<br/>        public Object invoke(MethodInvocation invocation) throws Throwable {</span><span id="3eaa" class="lw lx in ls b gy mc lz l ma mb">            /* Applicable for methods annotated with @Path (Resources) */<br/>            final Optional&lt;Annotation&gt; optionalAnnotation = Stream.of(invocation.getMethod().getDeclaredAnnotations())<br/>                    .filter(annotation -&gt; annotation instanceof Path)<br/>                    .findFirst();</span><span id="3041" class="lw lx in ls b gy mc lz l ma mb">            if (optionalAnnotation.isPresent()) {<br/>                final Annotation[][] parameterAnnotations = invocation.getMethod().getParameterAnnotations();</span><span id="04f7" class="lw lx in ls b gy mc lz l ma mb">                for (int index = 0; index &lt; parameterAnnotations.length; ++index) {<br/>                    for (final Annotation annotation : parameterAnnotations[index]) {<br/>                        /* Check for method arguments annotated with @Auth */<br/>                        if (annotation instanceof Auth) {<br/>                            try {<br/>                                final Auth auth = (Auth) invocation.getArguments()[index];<br/>                                /* Add request and user ID to MDC<br/>                                Note :<br/>                                * Any information in Auth can be logged.<br/>                                * Consider compliance restrictions before logging any sensitive information.<br/>                                */<br/>                                MDC.put(RequestContext.REQUEST_ID, auth.getRequestId());<br/>                                MDC.put(RequestContext.REQUEST_USER_ID, auth.getUserId());<br/>                            } catch (Exception e) {<br/>                                /* Deliberately catching all exceptions,<br/>                                to ensure application is not affected from logger<br/>                                TODO : Set-up alerts for the below log */<br/>                                log.error("[Auth to MDC] Error while fetching Auth");<br/>                            }<br/>                        }<br/>                    }<br/>                }<br/>            }<br/>            return invocation.proceed();<br/>        }<br/>    }<br/>}</span></pre><p id="e489" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">æ¸…é™¤ä¸Šä¸‹æ–‡çš„å“åº”è¿‡æ»¤å™¨:</p><pre class="ln lo lp lq gt lr ls lt lu aw lv bi"><span id="5680" class="lw lx in ls b gy ly lz l ma mb">/**<br/> * @author adesh.nalpet<br/> * created on 20th December 2019<br/> * A Servlet response filter to clear MDC.<br/> */<br/>public class ClearContextResponseFilter implements Filter {<br/>    @Override<br/>    public void init(FilterConfig filterConfig) throws ServletException {<br/>        /* deliberately nothing */<br/>    }</span><span id="757d" class="lw lx in ls b gy mc lz l ma mb">    @Override<br/>    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException {<br/>        try {<br/>            chain.doFilter(request, response);<br/>        } finally {<br/>            RequestContext.clearContext();<br/>        }<br/>    }</span><span id="a902" class="lw lx in ls b gy mc lz l ma mb">    @Override<br/>    public void destroy() {<br/>        /* deliberately nothing */<br/>    }<br/>}</span></pre><p id="1ea7" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">è¯·æ±‚ä¸Šä¸‹æ–‡:</p><pre class="ln lo lp lq gt lr ls lt lu aw lv bi"><span id="1cdc" class="lw lx in ls b gy ly lz l ma mb">/**<br/> * @author adesh.nalpet<br/> * created on 20th December 2019<br/> * TODO : Validate storing RequestContext in thread local.<br/> */<br/>public class RequestContext {</span><span id="66d2" class="lw lx in ls b gy mc lz l ma mb">    public static final String REQUEST_ID = "request_id";<br/>    public static final String REQUEST_USER_ID = "user_id";</span><span id="14df" class="lw lx in ls b gy mc lz l ma mb">    public static void clearContext() {<br/>        MDC.remove(REQUEST_ID);<br/>        MDC.remove(REQUEST_USER_ID);<br/>    }<br/>}</span></pre><p id="9575" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">æ—¥å¿—æ ¼å¼:</p><pre class="ln lo lp lq gt lr ls lt lu aw lv bi"><span id="7329" class="lw lx in ls b gy ly lz l ma mb">logFormat: "%(%-5level) [%date] %X{request_id} %X{user_id} [%thread] [%logger{0}]: %message%n"</span></pre><p id="d9a3" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">èµ°å‘ MDCğŸš€</p></div></div>    
</body>
</html>