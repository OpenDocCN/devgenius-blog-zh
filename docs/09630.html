<html>
<head>
<title>How I deployed my Telegram bot entirely for FREE</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我如何完全免费地部署我的电报机器人</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/create-and-deploy-your-telegram-bot-here-entirely-free-757d5d5e8099?source=collection_archive---------0-----------------------#2022-09-02">https://blog.devgenius.io/create-and-deploy-your-telegram-bot-here-entirely-free-757d5d5e8099?source=collection_archive---------0-----------------------#2022-09-02</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/a8f7f24c1de0b91a834f4dda24b79047.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*JF91uzeI8KiZbgpM"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">照片由<a class="ae jz" href="https://unsplash.com/@lanacodes?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">拉娜码</a>在<a class="ae jz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></figcaption></figure><p id="4164" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在本教程中，我将向您展示如何部署您的电报机器人，并保持它 24/7 运行完全免费。</p><h1 id="37cb" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">介绍</h1><p id="8ee0" class="pw-post-body-paragraph ka kb in kc b kd lw kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ma kv kw kx ig bi translated">对于电报机器人的开发，通常有两种方法:轮询和 webhooks。许多教程使用 NodeJS 或 Python 服务器的轮询方法，轮询(或拉)bot 收到的任何消息到服务器。这意味着为了部署它，我们需要一台 24/7 全天候运行的服务器来不断轮询更新。没有多少免费选项可以让服务器保持 24/7 运行，所以这是一个问题。</p><p id="4606" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">今天，我们将探讨 webhooks 的选项。为您的 telegram bot 设置一个 webhook 意味着无论何时您的 bot 接收到一条新消息，telegram 都会将该更新发送到您预定义的 webhook 端点。从我们的自定义端点，我们可以自由地做任何我们想做的事情，因为我们知道我们的机器人已经收到了一条消息，我们可以对它做出响应。</p><p id="f62a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">例如，当我们的机器人收到来自用户的消息时，telegram 会向我们预定义的端点发送一个 POST 请求，其中包含关于该消息的信息(用户、消息文本、时间等)。我们的端点将接收带有有效负载的 POST 请求，这样我们就可以响应用户了。</p><p id="145c" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">但是这是否意味着我们也需要一个服务器来接受这些 POST 请求呢？是的，但是我们不需要服务器全天候运行。相反，我们将使用无服务器功能。有很多免费的无服务器函数可供选择:Cloudflare Workers，Vercel 无服务器函数等。</p><p id="c19c" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在本教程中，我们将利用 Cloudflare Workers 创建一个 POST 端点，并将其设置为 Telegram bot 的 webhook。</p><p id="1dd4" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">目录:</p><ol class=""><li id="dff7" class="mb mc in kc b kd ke kh ki kl md kp me kt mf kx mg mh mi mj bi translated">创建新的 Cloudflare 工作线程</li><li id="8a6d" class="mb mc in kc b kd mk kh ml kl mm kp mn kt mo kx mg mh mi mj bi translated">为我们的电报机器人设置 webhooks</li></ol><h1 id="5b81" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated"><strong class="ak"> 1。创建新的 Cloudflare 工作进程</strong></h1><ul class=""><li id="ec11" class="mb mc in kc b kd lw kh lx kl mp kp mq kt mr kx ms mh mi mj bi translated">导航到<a class="ae jz" href="http://dash.cloudflare.com" rel="noopener ugc nofollow" target="_blank">dash.cloudflare.com</a>并登录(或注册)</li><li id="46fa" class="mb mc in kc b kd mk kh ml kl mm kp mn kt mo kx ms mh mi mj bi translated">在侧边栏上，点击“工人”</li><li id="3989" class="mb mc in kc b kd mk kh ml kl mm kp mn kt mo kx ms mh mi mj bi translated">单击“创建服务”创建您的新员工</li><li id="247f" class="mb mc in kc b kd mk kh ml kl mm kp mn kt mo kx ms mh mi mj bi translated">为您的新员工输入一个名称，并选择“HTTP 处理程序”作为启动程序，然后单击“创建服务”</li></ul><figure class="mu mv mw mx gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mt"><img src="../Images/407a9fa94c781e7b93702e45b14f5cfe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ddX2d5RpeA17MtTZsbXs3A.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">“创建服务”</figcaption></figure><ul class=""><li id="f281" class="mb mc in kc b kd ke kh ki kl md kp me kt mf kx ms mh mi mj bi translated">创建服务后，单击“快速编辑”直接在浏览器中编辑您的员工</li></ul><figure class="mu mv mw mx gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi my"><img src="../Images/6bb84c41a61141568b0c8af5fa36a7ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RXNGoELekCDqZY4mtFRxUw.png"/></div></div></figure><ul class=""><li id="528c" class="mb mc in kc b kd ke kh ki kl md kp me kt mf kx ms mh mi mj bi translated">现在，在您的编辑器中，您应该会看到新 Cloudflare worker 的默认代码。</li></ul><pre class="mu mv mw mx gt mz na nb nc aw nd bi"><span id="c5de" class="ne kz in na b gy nf ng l nh ni">addEventListener("fetch", event =&gt; {<br/>  event.respondWith(handleRequest(event.request))<br/>})</span><span id="ce7b" class="ne kz in na b gy nj ng l nh ni">async function handleRequest(request) {<br/>  return new Response("Hello world")<br/>}</span></pre><p id="7f80" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们将如何处理传入请求的逻辑将在<code class="fe nk nl nm na b">handleRequest</code>函数中完成。</p><p id="7ad2" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在这一点上，知道电报将发送给我们的有效载荷是什么是很好的。</p><pre class="mu mv mw mx gt mz na nb nc aw nd bi"><span id="8d22" class="ne kz in na b gy nf ng l nh ni">{<br/>  "update_id": 1140,<br/>  "message": {<br/>    "message_id": 73,<br/>    "from": {<br/>      "id": "id of user",<br/>      "is_bot": false,<br/>      "first_name": "name of user",<br/>      "username": "username of user",<br/>      "language_code": "en"<br/>    },<br/>    "chat": {<br/>      "id": id of chat,<br/>      "first_name": "name of user",<br/>      "username": "username of user",<br/>      "type": "private"<br/>    },<br/>    "date": 1662102031,<br/>    "text": "hi"<br/>  }<br/>}</span></pre><p id="9050" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">从有效载荷中，我们能够知道用户是谁，用户正在发送的聊天内容是什么(这对群聊很重要)以及消息文本是什么。首先，让我们的机器人回显用户的消息，但是在消息的末尾添加一个‘over’。</p><pre class="mu mv mw mx gt mz na nb nc aw nd bi"><span id="58cb" class="ne kz in na b gy nf ng l nh ni">async function handleRequest(request) {<br/>  if (request.method === "POST") {<br/>    const payload = await request.json() <br/>    // Getting the POST request JSON payload<br/>    if ('message' in payload) { <br/>      // Checking if the payload comes from Telegram<br/>      const chatId = payload.message.chat.id<br/>      const text = payload.message.text + " over"<br/>      const url = `<a class="ae jz" href="https://api.telegram.org/bot${API_KEY}/sendMessage?chat_id=${chatId}&amp;text=${text}`" rel="noopener ugc nofollow" target="_blank">https://api.telegram.org/bot${API_KEY}/sendMessage?chat_id=${chatId}&amp;text=${text}`</a><br/>      const data = await fetch(url).then(resp =&gt; resp.json()) <br/>      // Calling the API endpoint to send a telegram message<br/>    }<br/>  }<br/>  return new Response("OK") // Doesn't really matter<br/>}</span></pre><p id="84a0" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在这个代码片段中，我们检查传入的请求是否是 POST，以及有效负载是否包含来自 Telegram 的重要信息。我们从有效载荷中获取 chatId 和文本，并生成一个惟一的 URL，我们将调用 GET to，它将通过我们的 bot 程序发送一条消息。还缺一样东西，就是<code class="fe nk nl nm na b">${API_KEY}</code>。这是 bot API 令牌将被替换的地方，我们可以通过 Cloudflare Workers 设置来设置该值。</p><ul class=""><li id="e833" class="mb mc in kc b kd ke kh ki kl md kp me kt mf kx ms mh mi mj bi translated">点击“保存和部署”,然后退出编辑器，返回您员工的控制面板。</li><li id="d08c" class="mb mc in kc b kd mk kh ml kl mm kp mn kt mo kx ms mh mi mj bi translated">在设置面板下，点击变量。在这里，您可以为 worker 设置环境变量。</li></ul><figure class="mu mv mw mx gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nn"><img src="../Images/76f078476d405bc60d69e50fd69a3f98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UYSZRCgfJxhPEhYD8Gd3nA.png"/></div></div></figure><ul class=""><li id="64c5" class="mb mc in kc b kd ke kh ki kl md kp me kt mf kx ms mh mi mj bi translated">点击“添加变量”,输入变量名为<code class="fe nk nl nm na b">API_KEY</code>,输入值为机器人的 API 令牌，保存您的设置。</li></ul><h1 id="55d3" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated"><strong class="ak"> 2。为我们的 bot 设置 web hooks</strong></h1><p id="27b8" class="pw-post-body-paragraph ka kb in kc b kd lw kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ma kv kw kx ig bi translated">现在，我们的端点已经准备好了，剩下要做的就是将 bot 的 webhook 设置为自定义端点。</p><p id="3b78" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">使用我们的 bot API 令牌和我们的新 worker 的 URL(应该以 workers.dev 结尾)，将值替换到这个 URL 中，然后简单地将其复制并粘贴到您的浏览器中，并输入</p><pre class="mu mv mw mx gt mz na nb nc aw nd bi"><span id="d1bf" class="ne kz in na b gy nf ng l nh ni">https://api.telegram.org/bot&lt;replace with bot api token&gt;/setWebhook?url=&lt;replace with our worker url&gt;</span></pre><p id="a9ee" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如果你把这看作是一种回应，那你就万事俱备了！</p><pre class="mu mv mw mx gt mz na nb nc aw nd bi"><span id="c85d" class="ne kz in na b gy nf ng l nh ni">{"ok":true,"result":true,"description":"Webhook was set"}</span></pre><figure class="mu mv mw mx gt jo gh gi paragraph-image"><div class="gh gi no"><img src="../Images/49b58f02137384556e79e53ea9c2283f.png" data-original-src="https://miro.medium.com/v2/resize:fit:736/format:webp/1*GiDGdFcTg52GtZ2P2Wg2LQ.png"/></div></figure><p id="f8b1" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在，当你跟你的机器人打招呼时，它应该回应‘你好完毕’！</p><h1 id="41e9" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated"><strong class="ak">那不是很容易吗？</strong></h1><p id="1207" class="pw-post-body-paragraph ka kb in kc b kd lw kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ma kv kw kx ig bi translated">所以现在你已经设置了你的电报机器人，它可以 24/7 完全免费运行！你可以定制这段代码，让你的机器人做你想做的任何事情。在未来的教程中，我将向您展示如何使用 Cloudflare KV 为您的机器人设置一个简单的数据库，以保留用户数据并增强您的机器人的功能！这真的很简单，所以如果你想看更多，就喜欢这个教程吧！</p></div></div>    
</body>
</html>