<html>
<head>
<title>Building Apache Pinot and Presto</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">建立阿帕奇皮诺和普雷斯托</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/building-apache-pinot-and-presto-bf91388c7df5?source=collection_archive---------5-----------------------#2022-10-10">https://blog.devgenius.io/building-apache-pinot-and-presto-bf91388c7df5?source=collection_archive---------5-----------------------#2022-10-10</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="8a90" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">逐步使用流式数据库</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/9b8dac9a6b55f5fb8ea68c0cf54c59b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Tn-BXidTMfiRl91I"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk translated">丹·迈耶斯在<a class="ae ks" href="https://unsplash.com/photos/tq2ClHwDbD8" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="7858" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">最近，我们一直在调查一些流数据库解决方案，主要目标是<a class="ae ks" href="https://pinot.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache Pinot </a>，根据描述，这符合我们的需求，因此是主要目标。</p><blockquote class="lp lq lr"><p id="9647" class="kt ku ls kv b kw kx jo ky kz la jr lb lt ld le lf lu lh li lj lv ll lm ln lo ig bi translated"><em class="in"> Apache Pinot，一种实时分布式 OLAP 数据存储，专为低延迟高吞吐量分析而构建，非常适合面向用户的分析工作负载。</em></p></blockquote><p id="b647" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">但是有些<a class="ae ks" href="https://docs.pinot.apache.org/" rel="noopener ugc nofollow" target="_blank">官方文件</a>其实是缺失的，所以我在网上找了一些资料，终于能够做一些实验了。这些过程当时没有记录，所以我不确定实际使用了什么参考资料。</p><p id="59be" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">目前整个实验基础设施都是用<code class="fe lw lx ly lz b">docker-compose</code>搭建的，Github 库中的完整代码如下。<a class="ae ks" href="https://github.com/wirelessr/pinot-plus-presto" rel="noopener ugc nofollow" target="_blank">https://github.com/wirelessr/pinot-plus-presto</a>T21</p><h1 id="708d" class="ma mb in bd mc md me mf mg mh mi mj mk jt ml ju mm jw mn jx mo jz mp ka mq mr bi translated">阿帕奇皮诺</h1><p id="db43" class="pw-post-body-paragraph kt ku in kv b kw ms jo ky kz mt jr lb lc mu le lf lg mv li lj lk mw lm ln lo ig bi translated">先解释核心部件，我们来看看<code class="fe lw lx ly lz b">docker-compose.yml</code>。</p><pre class="kd ke kf kg gt mx lz my mz aw na bi"><span id="fd52" class="nb mb in lz b gy nc nd l ne nf">services:<br/>  zookeeper:<br/>    image: zookeeper:3.5.6<br/>    <br/>  pinot-controller:<br/>    image: apachepinot/pinot:0.9.3<br/>    ports:<br/>      - "9000:9000"<br/>      - "8888"<br/>    environment:<br/>      JAVA_OPTS: "-javaagent:/opt/pinot/etc/jmx_prometheus_javaagent/jmx_prometheus_javaagent-0.12.0.jar=8888:/opt/pinot/etc/jmx_prometheus_javaagent/configs/pinot.yml -Dplugins.dir=/opt/pinot/plugins -Xms1G -Xmx4G -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -Xloggc:gc-pinot-controller.log"<br/>    <br/>  pinot-broker:<br/>    image: apachepinot/pinot:0.9.3<br/>    ports:<br/>      - "8099:8099"<br/>      - "8888"<br/>    environment:<br/>      JAVA_OPTS: "-javaagent:/opt/pinot/etc/jmx_prometheus_javaagent/jmx_prometheus_javaagent-0.12.0.jar=8888:/opt/pinot/etc/jmx_prometheus_javaagent/configs/pinot.yml -Dplugins.dir=/opt/pinot/plugins -Xms4G -Xmx4G -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -Xloggc:gc-pinot-broker.log"<br/>    <br/>  pinot-server:<br/>    image: apachepinot/pinot:0.9.3<br/>    ports:<br/>      - "8098:8098"<br/>      - "8888"<br/>    environment:<br/>      JAVA_OPTS: "-javaagent:/opt/pinot/etc/jmx_prometheus_javaagent/jmx_prometheus_javaagent-0.12.0.jar=8888:/opt/pinot/etc/jmx_prometheus_javaagent/configs/pinot.yml -Dplugins.dir=/opt/pinot/plugins -Xms4G -Xmx16G -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -Xloggc:gc-pinot-server.log"</span></pre><p id="912e" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">以上是构建 Pinot 所需的四个基本服务，大部分与官方文档相同的都被省略了，只列出了我修改过的部分。对了，我已经把图片版换成新的了，不过还是让我们在例子里保留正式版吧。</p><p id="76b3" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">主要的变化是对三种皮诺服务的<code class="fe lw lx ly lz b">ports</code>和<code class="fe lw lx ly lz b">environment</code>的修改，以便普罗米修斯公司可以使用皮诺的指标。</p><p id="67de" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">因此，<code class="fe lw lx ly lz b">ports</code>打开一个额外的<code class="fe lw lx ly lz b">8888</code>，并给<code class="fe lw lx ly lz b">JAVA_OPTS</code>增加一个额外的<code class="fe lw lx ly lz b">javaagent</code>参数。<code class="fe lw lx ly lz b">javaagent</code>的目的是使最初的皮诺 JMX 指标能够基于网络并向普罗米修斯公司公开。</p><p id="8ccb" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">到目前为止，官方文档中的<code class="fe lw lx ly lz b">jmx_prometheus_javaagent.jar</code>并没有包含版本号，但是我从官方容器中找不到对应的文件，所以只能用<code class="fe lw lx ly lz b">jmx_prometheus_javaagent-0.12.0.jar</code>来代替。</p><h1 id="85a8" class="ma mb in bd mc md me mf mg mh mi mj mk jt ml ju mm jw mn jx mo jz mp ka mq mr bi translated">监视</h1><p id="5194" class="pw-post-body-paragraph kt ku in kv b kw ms jo ky kz mt jr lb lc mu le lf lg mv li lj lk mw lm ln lo ig bi translated">为了观察服务的状态，我们还需要构建<code class="fe lw lx ly lz b">Prometheus</code>和<code class="fe lw lx ly lz b">Grafana</code>。</p><pre class="kd ke kf kg gt mx lz my mz aw na bi"><span id="e2be" class="nb mb in lz b gy nc nd l ne nf">prometheus:<br/>    image: prom/prometheus<br/>    container_name: monitoring-prometheus<br/>    restart: unless-stopped<br/>    volumes:<br/>    - monitoring-prometheus-data-1:/prometheus<br/>    - ./volumes/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml<br/>    ports:<br/>    - "9090:9090"<br/>  grafana:<br/>    image: grafana/grafana<br/>    volumes:<br/>    - ./volumes/grafana/provisioning:/etc/grafana/provisioning<br/>    - ./volumes/grafana/dashboards:/var/lib/grafana/dashboards<br/>    ports:<br/>    - "3000:3000"<br/>    environment:<br/>      GF_SERVER_ROOT_URL: https://localhost:3000<br/>      GF_SECURITY_ADMIN_PASSWORD: password</span></pre><p id="24a3" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">在<code class="fe lw lx ly lz b">volumes</code>中，我们定义了这两个服务所需的配置文件。</p><ul class=""><li id="a3c5" class="ng nh in kv b kw kx kz la lc ni lg nj lk nk lo nl nm nn no bi translated">Prometheus 需要知道从哪里获取指标，因此它需要设置三个 Pinot 服务的 FQDNs。</li><li id="89c0" class="ng nh in kv b kw np kz nq lc nr lg ns lk nt lo nl nm nn no bi translated">Grafana 需要数据源设置和 Pinot 专用仪表板。</li></ul><p id="b630" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">运行<code class="fe lw lx ly lz b">docker-compose</code>后，我们可以从<code class="fe lw lx ly lz b">https://localhost:3000</code>查看仪表盘。账号和密码简单来说就是<code class="fe lw lx ly lz b">admin</code>和<code class="fe lw lx ly lz b">password</code>。</p><h1 id="1ded" class="ma mb in bd mc md me mf mg mh mi mj mk jt ml ju mm jw mn jx mo jz mp ka mq mr bi translated">阿帕奇普雷斯托</h1><p id="2977" class="pw-post-body-paragraph kt ku in kv b kw ms jo ky kz mt jr lb lc mu le lf lg mv li lj lk mw lm ln lo ig bi translated">最后一个服务是<a class="ae ks" href="https://prestodb.io/" rel="noopener ugc nofollow" target="_blank"> Presto </a>。</p><p id="a940" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">我们为什么需要 Presto？因为 Pinot 支持 SQL，但实际上 Pinot 不支持<code class="fe lw lx ly lz b">JOIN</code>。如果需要合并两个表，必须由外部 SQL 引擎提供。</p><p id="b2ff" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">Presto 是一个 SQL 引擎，支持 ANSI SQL 和多个数据源，当然也包括 Pinot，所以我选择在我的实验中使用 Presto。</p><pre class="kd ke kf kg gt mx lz my mz aw na bi"><span id="1a78" class="nb mb in lz b gy nc nd l ne nf">presto-coordinator:<br/>    image: apachepinot/pinot-presto<br/>    restart: unless-stopped<br/>    ports:<br/>    - "18080:8080"</span></pre><p id="bd26" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">Presto 有两个角色，协调者和工作者。在实验环境中，我们简单地使用协调器的内置 worker。</p><p id="a792" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">官方容器<code class="fe lw lx ly lz b">apachepinot/pinot-presto</code>默认为协调器，没有任何设置，已经使用了 FQDN <code class="fe lw lx ly lz b">pinot-controller:9000</code>，所以不需要做任何改动，我们可以直接使用。</p><h1 id="250c" class="ma mb in bd mc md me mf mg mh mi mj mk jt ml ju mm jw mn jx mo jz mp ka mq mr bi translated">结论</h1><p id="d8d4" class="pw-post-body-paragraph kt ku in kv b kw ms jo ky kz mt jr lb lc mu le lf lg mv li lj lk mw lm ln lo ig bi translated">在克隆了 Github 存储库之后，我们可以直接运行<code class="fe lw lx ly lz b">docker-compose up -d</code>来让实验环境正常运行。</p><p id="a53f" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">整个实验环境包含三个关键点。</p><ol class=""><li id="c4e3" class="ng nh in kv b kw kx kz la lc ni lg nj lk nk lo nu nm nn no bi translated">Apache Pinot:流式数据库本身。</li><li id="5e58" class="ng nh in kv b kw np kz nq lc nr lg ns lk nt lo nu nm nn no bi translated">Prometheus 和 Grafana:模拟生产环境的监控系统。</li><li id="670a" class="ng nh in kv b kw np kz nq lc nr lg ns lk nt lo nu nm nn no bi translated">Apache Presto:Pinot 中没有的查询功能。</li></ol><p id="ec32" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">对了，官方文档并没有介绍如何使用有安全的卡夫卡，只是以没有安全的卡夫卡为例。</p><p id="c518" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">在<a class="ae ks" href="https://www.confluent.io/" rel="noopener ugc nofollow" target="_blank">合流</a>的情况下，卡夫卡内置了<code class="fe lw lx ly lz b">SASL_SSL</code>，我参考这篇文章来设置卡夫卡的账号和密码。<br/><a class="ae ks" href="https://dev.startree.ai/docs/pinot/recipes/kafka-sasl" rel="noopener ugc nofollow" target="_blank">https://dev.startree.ai/docs/pinot/recipes/kafka-sasl</a></p><p id="91ab" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">这个实验环境可能会根据我的一些需求进行扩展，比如添加 Presto workers。</p></div></div>    
</body>
</html>