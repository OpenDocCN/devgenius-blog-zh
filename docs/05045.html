<html>
<head>
<title>Let’s Encrypt change affects OpenSSL 1.0.x and CentOS 7</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">让我们加密影响 OpenSSL 1.0.x 和 CentOS 7 的变化</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/lets-encrypt-change-affects-openssl-1-0-x-and-centos-7-49bd66016af3?source=collection_archive---------0-----------------------#2021-06-08">https://blog.devgenius.io/lets-encrypt-change-affects-openssl-1-0-x-and-centos-7-49bd66016af3?source=collection_archive---------0-----------------------#2021-06-08</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><h2 id="5706" class="il im in bd b dl io ip iq ir is it dk iu translated" aria-label="kicker paragraph"><a class="ae ep" href="https://www.0snet.com" rel="noopener ugc nofollow" target="_blank">第 0 根安全网络</a></h2><div class=""/><div class=""><h2 id="8d34" class="pw-subtitle-paragraph jt iw in bd b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk dk translated">包含过期根证书的默认证书链</h2></div><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/0d53e4f9e8e436956fa2b3a630a20ef5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*6LBXj-WOLTji2-N3"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">由<a class="ae lb" href="https://unsplash.com/@tvick?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">泰勒维克</a>在<a class="ae lb" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="bf38" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi ly translated">et 的 Encrypt 是一个由互联网安全研究小组(ISRG)运营的认证机构，它为互联网上的安全通信提供免费的自动 TLS 证书。在网络环境中，每当浏览器通过<em class="mh"> https </em>连接到网站时，浏览器<strong class="le ix">会验证</strong>网站的 TLS 证书，以确保通信安全。</p><p id="b24b" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">验证 TLS 证书的过程需要 web 浏览器或操作系统来维护根证书的可信数据库。并且，从网站提供的 TLS 证书开始，通过创建到可信数据库中存在的根证书的证书链/路径来验证其颁发者。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mi"><img src="../Images/3c3202b35aeecf8a8c49bce915492fda.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KCN6h08pVrTEBQpCBc0Hlw.png"/></div></div></figure><p id="a17c" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">不幸的是，可信数据库中的这些根证书有一个截止日期。并且，相应地，由这些根证书颁发的任何中间证书也将与该到期日一致(除了下面解释的新的<strong class="le ix">交叉签名的 ISRG 根 X1 </strong>中间证书)。</p><p id="329b" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated"><a class="ae lb" href="https://letsencrypt.org/certs/lets-encrypt-r3-cross-signed.txt" rel="noopener ugc nofollow" target="_blank"> <strong class="le ix">交叉签名让我们加密 R3 </strong> </a>和<a class="ae lb" href="https://crt.sh/?id=8395" rel="noopener ugc nofollow" target="_blank"> <strong class="le ix"> DST 根 CA X3 </strong> </a>，中间和根证书分别于<strong class="le ix">2021 年 9 月 29 日</strong>和<strong class="le ix">2021 年 9 月 30 日</strong>到期。</p><blockquote class="mj"><p id="59b0" class="mk ml in bd mm mn mo mp mq mr ms lx dk translated">" Android 有意不强制使用作为信任锚的证书的截止日期."</p></blockquote></div><div class="ab cl mt mu hr mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="ig ih ii ij ik"><h1 id="b0df" class="na nb in bd nc nd ne nf ng nh ni nj nk kc nl kd nm kf nn kg no ki np kj nq nr bi translated">根存储包含</h1><p id="3284" class="pw-post-body-paragraph lc ld in le b lf ns jx lh li nt ka lk ll nu ln lo lp nv lr ls lt nw lv lw lx ig bi translated">任何证书颁发机构的成功最终取决于其根证书受信任的平台和设备。这允许平台和设备上的 TLS 客户端成功地验证由它们颁发的证书。</p><p id="5805" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">当 Let's Encrypt 在 2015 年推出时，他们的新根证书<a class="ae lb" href="https://letsencrypt.org/certs/isrgrootx1.txt" rel="noopener ugc nofollow" target="_blank"> <strong class="le ix"> ISRG 根 X1 </strong> </a>在任何设备或平台上都不可信。因此，由<a class="ae lb" href="https://crt.sh/?id=8395" rel="noopener ugc nofollow" target="_blank"><strong class="le ix">DST Root CA【X3】</strong></a>Root 认证的他们 5 年有效期的中间证书的交叉签名是一个<a class="ae lb" href="https://letsencrypt.org/2015/10/19/lets-encrypt-is-trusted.html" rel="noopener ugc nofollow" target="_blank">重要的里程碑</a>，它被<a class="ae lb" href="https://letsencrypt.org/2020/09/17/new-root-and-intermediates.html#the-new-certificates" rel="noopener ugc nofollow" target="_blank">延长一年</a>到 2020 年。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nx"><img src="../Images/7a29b193d93c6a7e2037a6b1f85a33e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_p3ciZztWALzNaqj8ZjlEg.png"/></div></div></figure><p id="c6be" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">通常，根证书用于签署一堆中间证书，这些中间证书可以<strong class="le ix">向订户颁发</strong>证书。这些订户证书仅包含作为其<strong class="le ix">颁发者</strong>提及的中间证书，没有提及任何根证书。</p><p id="0c3f" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">因此，可以有多个由不同认证机构签署的具有相同名称和公钥的中间证书，这些证书被称为<a class="ae lb" href="https://letsencrypt.org/certificates/#cross-signing" rel="noopener ugc nofollow" target="_blank">交叉签名证书</a>。这导致同一订户证书有不同的证书链和路径。</p></div><div class="ab cl mt mu hr mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="ig ih ii ij ik"><h1 id="60a3" class="na nb in bd nc nd ne nf ng nh ni nj nk kc nl kd nm kf nn kg no ki np kj nq nr bi translated">新十字符号</h1><p id="9239" class="pw-post-body-paragraph lc ld in le b lf ns jx lh li nt ka lk ll nu ln lo lp nv lr ls lt nw lv lw lx ig bi translated">根证书<strong class="le ix"> ISRG 根 X1 </strong>现在被<a class="ae lb" href="https://letsencrypt.org/docs/certificate-compatibility/#platforms-that-trust-isrg-root-x1" rel="noopener ugc nofollow" target="_blank">大多数平台</a>和设备信任。然而，为了<a class="ae lb" href="https://letsencrypt.org/2020/12/21/extending-android-compatibility.html" rel="noopener ugc nofollow" target="_blank">保持与旧 Android 设备的兼容性</a>，Let's Encrypt 决定采取一种独特的方法，</p><blockquote class="ny nz oa"><p id="eb60" class="lc ld mh le b lf lg jx lh li lj ka lk ob lm ln lo oc lq lr ls od lu lv lw lx ig bi translated">IdenTrust 已经同意从他们的<strong class="le ix"> DST 根 CA X3 </strong>为我们的<strong class="le ix"> ISRG 根 X1 </strong>签发 3 年交叉签名。这个新的交叉标志会有些新奇，因为它超过了根 X3 夏令时的有效期。这个解决方案之所以有效，是因为 Android 有意不强制使用作为信任锚的证书的截止日期。ISRG 和 IdenTrust 联系了我们的审计员和根程序来审查这个计划，并确保没有任何合规性问题。</p></blockquote><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi oe"><img src="../Images/44eec2cf52c7b54c8aa713938bcfd7b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wlJghpc3MhyBJ2tw-ljmDA.png"/></div></div></figure><p id="e1cc" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">最初的计划是在一月初过渡到他们自己的根。但是，随着使用特殊交叉签名的计划的改变，新颁发的证书(自 2021 年 5 月 4 日起)使用一个<a class="ae lb" href="https://community.letsencrypt.org/t/production-chain-changes/150739" rel="noopener ugc nofollow" target="_blank">更长的链</a>与<a class="ae lb" href="https://letsencrypt.org/certs/isrg-root-x1-cross-signed.txt" rel="noopener ugc nofollow" target="_blank"> <strong class="le ix">交叉签名的 ISRG 根 X1 </strong> </a>作为中间证书。</p><p id="c78c" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">这里具有讽刺意味的是，让我们加密颁发一个新的 ECDSA 根证书<a class="ae lb" href="https://letsencrypt.org/certs/isrg-root-x2.txt" rel="noopener ugc nofollow" target="_blank"> <strong class="le ix"> ISRG 根 X2 </strong> </a>去年声明<a class="ae lb" href="https://letsencrypt.org/2020/09/17/new-root-and-intermediates.html#why-we-issued-an-ecdsa-root-and-intermediates" rel="noopener ugc nofollow" target="_blank">更小的证书尺寸</a>作为一大好处。但是，使用新的交叉符号，每次连接都需要额外传输 512 字节的证书数据。</p></div><div class="ab cl mt mu hr mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="ig ih ii ij ik"><h1 id="c49f" class="na nb in bd nc nd ne nf ng nh ni nj nk kc nl kd nm kf nn kg no ki np kj nq nr bi translated">OpenSSL 1.0.2 —不支持</h1><p id="42f9" class="pw-post-body-paragraph lc ld in le b lf ns jx lh li nt ka lk ll nu ln lo lp nv lr ls lt nw lv lw lx ig bi translated">不幸的是，由于构建和验证<a class="ae lb" href="https://community.letsencrypt.org/t/questions-re-openssl-client-compatibility-changes-for-let-s-encrypt-certificates/143817/37" rel="noopener ugc nofollow" target="_blank">证书路径的方式</a>，并非所有 TLS 的实现都能成功验证交叉签名。<strong class="le ix"> OpenSSL 1.0.2 </strong>就是这种情况。因此，在<strong class="le ix"> RHEL/CentOS 7 </strong>上运行的使用 OpenSSL 的程序将<a class="ae lb" href="https://community.letsencrypt.org/t/openssl-client-compatibility-changes-for-let-s-encrypt-certificates/143816" rel="noopener ugc nofollow" target="_blank">无法验证新的证书链</a>或建立 TLS 连接。</p><p id="227f" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">升级到<strong class="le ix"> OpenSSL 1.1.x </strong>并不简单，很可能<a class="ae lb" href="https://wiki.openssl.org/index.php/OpenSSL_1.1.0_Changes#No_longer_works" rel="noopener ugc nofollow" target="_blank">会破坏一些应用</a>。也就是说，有几个选择:要么更新客户端的信任存储，要么更改服务器端的证书链。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi of"><img src="../Images/6e249349e9880346c63bafc3d42af073.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zOzyIfSnSOg35y4ZHCDvzg.png"/></div></div></figure><p id="d6d0" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">这些问题与去年<a class="ae lb" href="https://www.agwa.name/blog/post/fixing_the_addtrust_root_expiration" rel="noopener ugc nofollow" target="_blank"> Sectigo 根证书到期</a>非常相似。因此，从客户端的可信列表中删除<strong class="le ix"> DST 根 CA X3 </strong>根证书(或者从服务器端的证书链中删除新的交叉签名的中间证书)应该可以解决这个问题。</p><p id="720b" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">然而，有一个微妙的区别。去年，为了避免这个问题，发行机构可以决定不将有问题的中间证书包括在链中。这里，有意识地决定让默认链使用交叉签名证书。</p><p id="27a9" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">因此，一个干净的解决方案是切换到备用链，只支持<strong class="le ix"> Android 7.1.1 或更高版本</strong>。然而，如果你有一个旧的 android 设备和客户端的混合与<strong class="le ix"> OpenSSL 1.0.x </strong>支持，切换到一个不同的认证机构，也许？</p><h2 id="bd4c" class="og nb in bd nc oh oi dn ng oj ok dp nk ll ol om nm lp on oo no lt op oq nq it bi translated">Certbot</h2><p id="dec5" class="pw-post-body-paragraph lc ld in le b lf ns jx lh li nt ka lk ll nu ln lo lp nv lr ls lt nw lv lw lx ig bi translated">从<a class="ae lb" href="https://github.com/certbot/certbot/blob/v1.9.0/certbot/CHANGELOG.md#160---2020-07-07" rel="noopener ugc nofollow" target="_blank">版本 1.6.0 </a>开始，Certbot ACME 客户端支持<a class="ae lb" href="https://certbot.eff.org/docs/using.html#certbot-command-line-options" rel="noopener ugc nofollow" target="_blank">选项</a> <code class="fe or os ot ou b">--preferred-chain</code> <a class="ae lb" href="https://github.com/certbot/certbot/issues/8577" rel="noopener ugc nofollow" target="_blank">选择</a>越短的加密链。该选项可以如下所示使用，</p><pre class="km kn ko kp gt ov ou ow ox aw oy bi"><span id="af5b" class="og nb in ou b gy oz pa l pb pc">certbot renew --dry-run --preferred-chain "ISRG Root X1"</span></pre><p id="c9e0" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">或者，将以下内容添加到<em class="mh">/etc/lets encrypt/renewal/</em>下的配置中，</p><pre class="km kn ko kp gt ov ou ow ox aw oy bi"><span id="3ca7" class="og nb in ou b gy oz pa l pb pc">preferred_chain = ISRG Root X1</span></pre><blockquote class="ny nz oa"><p id="4837" class="lc ld mh le b lf lg jx lh li lj ka lk ob lm ln lo oc lq lr ls od lu lv lw lx ig bi translated">由于证书机器人中的<a class="ae lb" href="https://github.com/certbot/certbot/issues/8577" rel="noopener ugc nofollow" target="_blank">缺陷，版本</a><a class="ae lb" href="https://github.com/certbot/certbot/blob/master/certbot/CHANGELOG.md#1120---2021-02-02" rel="noopener ugc nofollow" target="_blank"> 1.12.0 </a>将被要求<a class="ae lb" href="https://community.letsencrypt.org/t/choice-of-default-long-chain-vs-short-chain/161184/30" rel="noopener ugc nofollow" target="_blank">选择较短的链条</a>。然而，截至 2021 年 10 月 6 日，EPEL 上 CentOS 7 的最新版本仅为 1.11.0。因此，在 CentOS 7 上选择较短的链并不直接。</p></blockquote></div><div class="ab cl mt mu hr mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="ig ih ii ij ik"><h1 id="a7df" class="na nb in bd nc nd ne nf ng nh ni nj nk kc nl kd nm kf nn kg no ki np kj nq nr bi translated">测试证书</h1><p id="cbbc" class="pw-post-body-paragraph lc ld in le b lf ns jx lh li nt ka lk ll nu ln lo lp nv lr ls lt nw lv lw lx ig bi translated">如果您希望自己重现问题，可以使用下面的测试证书，</p><h2 id="00ab" class="og nb in bd nc oh oi dn ng oj ok dp nk ll ol om nm lp on oo no lt op oq nq it bi translated">即将到期的 CA，非常老的 X3</h2><ul class=""><li id="2de7" class="pd pe in le b lf ns li nt ll pf lp pg lt ph lx pi pj pk pl bi translated"><a class="ae lb" href="https://www.0throot.com/blog/14/assets/x3.pem" rel="noopener ugc nofollow" target="_blank"> x3.pem </a>，<a class="ae lb" href="https://www.0throot.com/blog/14/assets/x3.txt" rel="noopener ugc nofollow" target="_blank"> x3.txt </a></li></ul><h2 id="18b0" class="og nb in bd nc oh oi dn ng oj ok dp nk ll ol om nm lp on oo no lt op oq nq it bi translated">主 CA、根<strong class="ak"> X1 </strong>和<strong class="ak">由</strong>非常老的<strong class="ak"> X3 </strong>交叉签名</h2><ul class=""><li id="2c52" class="pd pe in le b lf ns li nt ll pf lp pg lt ph lx pi pj pk pl bi translated"><a class="ae lb" href="https://www.0throot.com/blog/14/assets/x1.pem" rel="noopener ugc nofollow" target="_blank"> x1.pem </a>、<a class="ae lb" href="https://www.0throot.com/blog/14/assets/x1.txt" rel="noopener ugc nofollow" target="_blank"> x1.txt </a>、<a class="ae lb" href="https://www.0throot.com/blog/14/assets/x1-cross.pem" rel="noopener ugc nofollow" target="_blank"> x1-cross.pem </a>、<a class="ae lb" href="https://www.0throot.com/blog/14/assets/x1-cross.txt" rel="noopener ugc nofollow" target="_blank"> x1-cross.txt </a></li></ul><h2 id="eeb3" class="og nb in bd nc oh oi dn ng oj ok dp nk ll ol om nm lp on oo no lt op oq nq it bi translated">主 CA，中间<strong class="ak"> R3 </strong></h2><ul class=""><li id="1da7" class="pd pe in le b lf ns li nt ll pf lp pg lt ph lx pi pj pk pl bi translated"><a class="ae lb" href="https://www.0throot.com/blog/14/assets/r3.pem" rel="noopener ugc nofollow" target="_blank"> r3.pem </a>，<a class="ae lb" href="https://www.0throot.com/blog/14/assets/r3.txt" rel="noopener ugc nofollow" target="_blank"> r3.txt </a></li></ul><h2 id="b252" class="og nb in bd nc oh oi dn ng oj ok dp nk ll ol om nm lp on oo no lt op oq nq it bi translated">订户，<strong class="ak">本地主机</strong></h2><ul class=""><li id="1515" class="pd pe in le b lf ns li nt ll pf lp pg lt ph lx pi pj pk pl bi translated"><a class="ae lb" href="https://www.0throot.com/blog/14/assets/localhost.pem" rel="noopener ugc nofollow" target="_blank"> localhost.pem </a>，<a class="ae lb" href="https://www.0throot.com/blog/14/assets/localhost.txt" rel="noopener ugc nofollow" target="_blank"> localhost.txt </a></li><li id="f6e3" class="pd pe in le b lf pm li pn ll po lp pp lt pq lx pi pj pk pl bi translated"><em class="mh">full chain:</em><a class="ae lb" href="https://www.0throot.com/blog/14/assets/chain-long-localhost.pem" rel="noopener ugc nofollow" target="_blank">chain-long-localhost . PEM</a>，<a class="ae lb" href="https://www.0throot.com/blog/14/assets/chain-short-localhost.pem" rel="noopener ugc nofollow" target="_blank">chain-short-localhost . PEM</a></li></ul><h2 id="6d3e" class="og nb in bd nc oh oi dn ng oj ok dp nk ll ol om nm lp on oo no lt op oq nq it bi translated">订户，test.example.com</h2><ul class=""><li id="1bb5" class="pd pe in le b lf ns li nt ll pf lp pg lt ph lx pi pj pk pl bi translated"><a class="ae lb" href="https://www.0throot.com/blog/14/assets/test.example.com.pem" rel="noopener ugc nofollow" target="_blank">test.example.com.pem</a>，<a class="ae lb" href="https://www.0throot.com/blog/14/assets/test.example.com.txt" rel="noopener ugc nofollow" target="_blank">test.example.com.txt</a></li><li id="25ab" class="pd pe in le b lf pm li pn ll po lp pp lt pq lx pi pj pk pl bi translated"><em class="mh">full chain:</em><a class="ae lb" href="https://www.0throot.com/blog/14/assets/chain-long-example.pem" rel="noopener ugc nofollow" target="_blank">chain-long-example . PEM</a>，<a class="ae lb" href="https://www.0throot.com/blog/14/assets/chain-short-example.pem" rel="noopener ugc nofollow" target="_blank">chain-short-example . PEM</a></li></ul><h2 id="8b0e" class="og nb in bd nc oh oi dn ng oj ok dp nk ll ol om nm lp on oo no lt op oq nq it bi translated">CA 文件进行验证</h2><ul class=""><li id="9054" class="pd pe in le b lf ns li nt ll pf lp pg lt ph lx pi pj pk pl bi translated"><a class="ae lb" href="https://www.0throot.com/blog/14/assets/x3.pem" rel="noopener ugc nofollow" target="_blank"> x3.pem </a>，<a class="ae lb" href="https://www.0throot.com/blog/14/assets/x1.pem" rel="noopener ugc nofollow" target="_blank"> x1.pem </a>，<a class="ae lb" href="https://www.0throot.com/blog/14/assets/x3+x1.pem" rel="noopener ugc nofollow" target="_blank"> x3+x1.pem </a></li></ul><p id="b857" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">按如下方式启动测试服务器，</p><pre class="km kn ko kp gt ov ou ow ox aw oy bi"><span id="ea70" class="og nb in ou b gy oz pa l pb pc">nc -kCl --ssl-cert chain-long-example.pem --ssl-key chain-long-example.pem 4433</span></pre><p id="962d" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">(记住将 test.example.com 的主机条目添加到相应的 IP 地址中。)</p></div><div class="ab cl mt mu hr mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="ig ih ii ij ik"><h2 id="211b" class="og nb in bd nc oh oi dn ng oj ok dp nk ll ol om nm lp on oo no lt op oq nq it bi translated"><strong class="ak"> OpenSSL 1.0.2k (CentOS 7) </strong></h2><p id="c52e" class="pw-post-body-paragraph lc ld in le b lf ns jx lh li nt ka lk ll nu ln lo lp nv lr ls lt nw lv lw lx ig bi translated">下面的命令试图在未来某个时间<strong class="le ix">2021 年 10 月 1 日</strong>在端口<strong class="le ix"> 4433 </strong>上建立到<em class="mh">test.example.com</em>的 TLS 连接。如下所示，如果根证书过期，证书验证就会失败。但是，如果可信列表中没有过期的根证书，验证将会成功。</p><pre class="km kn ko kp gt ov ou ow ox aw oy bi"><span id="d85a" class="og nb in ou b gy oz pa l pb pc">$ faketime '1 Oct 2021' openssl s_client -connect test.example.com:4433 -CAfile <strong class="ou ix">x3+x1.pem</strong> -quiet <br/>depth=3 C = US, ST = California, L = San Francisco, O = Soon To Expire CA, CN = Very Old X3<br/><strong class="ou ix">verify error:num=10:certificate has expired</strong><br/><strong class="ou ix">notAfter=Sep 30 09:36:31 2021 GMT</strong></span><span id="135f" class="og nb in ou b gy pr pa l pb pc">$ faketime '1 Oct 2021' openssl s_client -connect test.example.com:4433 -CAfile <strong class="ou ix">x1.pem</strong> -quiet <br/>depth=2 C = US, ST = California, L = San Francisco, O = Main CA, CN = Root X1<br/><strong class="ou ix">verify return:1<br/>...</strong></span></pre><h2 id="1c44" class="og nb in bd nc oh oi dn ng oj ok dp nk ll ol om nm lp on oo no lt op oq nq it bi translated"><strong class="ak"> Wget 1.14 (CentOS 7) </strong></h2><p id="f4e7" class="pw-post-body-paragraph lc ld in le b lf ns jx lh li nt ka lk ll nu ln lo lp nv lr ls lt nw lv lw lx ig bi translated">不幸的是，由于这种变化，像<strong class="le ix"> wget </strong>这样的基础工具将无法验证让我们加密证书。我希望<strong class="le ix"> ca-certificates </strong>包将被更新，过期的根证书将被删除，或者提供一些其他的解决方案。</p><pre class="km kn ko kp gt ov ou ow ox aw oy bi"><span id="4e1d" class="og nb in ou b gy oz pa l pb pc">$ faketime '1 Oct 2021' wget -q <a class="ae lb" href="https://test.example.com:4433/" rel="noopener ugc nofollow" target="_blank">https://test.example.com:4433/</a> --ca-certificate <strong class="ou ix">x1.pem</strong> -O-<br/>Hello World</span><span id="4830" class="og nb in ou b gy pr pa l pb pc">$ faketime '1 Oct 2021' wget <a class="ae lb" href="https://test.example.com:4433/" rel="noopener ugc nofollow" target="_blank">https://test.example.com:4433/</a> --ca-certificate <strong class="ou ix">x3+x1.pem</strong> -O-<br/>...<br/>(test.example.com)|192.168.1.112|:4433... connected.<br/>ERROR: cannot verify test.example.com's certificate, issued by ‘/C=US/ST=California/L=San Francisco/O=Main CA/CN=Intermediate R3’:<br/>  <strong class="ou ix">Issued certificate has expired.</strong><br/>...</span></pre><h2 id="05d1" class="og nb in bd nc oh oi dn ng oj ok dp nk ll ol om nm lp on oo no lt op oq nq it bi translated"><strong class="ak">卷曲度 7.29(百分位 7) </strong></h2><p id="792f" class="pw-post-body-paragraph lc ld in le b lf ns jx lh li nt ka lk ll nu ln lo lp nv lr ls lt nw lv lw lx ig bi translated">Curl 似乎没有受到影响，因为它是用<strong class="le ix"> NSS </strong>而不是<strong class="le ix"> OpenSSL </strong>构建的。</p><pre class="km kn ko kp gt ov ou ow ox aw oy bi"><span id="8d2b" class="og nb in ou b gy oz pa l pb pc">$ faketime '1 Oct 2021' curl <a class="ae lb" href="https://test.example.com:4433/" rel="noopener ugc nofollow" target="_blank">https://test.example.com:4433/</a> --cacert <strong class="ou ix">x1.pem</strong><br/>Hello World</span><span id="92e2" class="og nb in ou b gy pr pa l pb pc">$ faketime '1 Oct 2021' curl <a class="ae lb" href="https://test.example.com:4433/" rel="noopener ugc nofollow" target="_blank">https://test.example.com:4433/</a> --cacert <strong class="ou ix">x3+x1.pem</strong><br/>Hello World</span><span id="798c" class="og nb in ou b gy pr pa l pb pc">$ curl --version<br/>curl 7.29.0 (x86_64-redhat-linux-gnu) libcurl/7.29.0 <strong class="ou ix">NSS/3.53.1</strong> zlib/1.2.7 libidn/1.28 libssh2/1.8.0<br/>...</span></pre></div><div class="ab cl mt mu hr mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="ig ih ii ij ik"><h1 id="f8e5" class="na nb in bd nc nd ne nf ng nh ni nj nk kc nl kd nm kf nn kg no ki np kj nq nr bi translated">最后的想法</h1><p id="7aa9" class="pw-post-body-paragraph lc ld in le b lf ns jx lh li nt ka lk ll nu ln lo lp nv lr ls lt nw lv lw lx ig bi translated">目前还不清楚这对 CentOS 7 会有什么影响。事实上，我甚至不确定 ACME 客户端是否能够在 CentOS 7 服务器上获取证书，因为 API 端点使用类似的证书链，</p><pre class="km kn ko kp gt ov ou ow ox aw oy bi"><span id="6dfc" class="og nb in ou b gy oz pa l pb pc">$ faketime '1 Oct 2021' openssl s_client -connect <strong class="ou ix">acme-v02.api.letsencrypt.org:443</strong> -quiet<br/>depth=2 O = Digital Signature Trust Co., CN = DST Root CA X3<br/><strong class="ou ix">verify error:num=10:certificate has expired</strong><br/>notAfter=Sep 30 14:01:15 2021 GMT</span></pre><p id="5ee8" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">考虑到<strong class="le ix"> RHEL 7 </strong>和其他发行版如<strong class="le ix"> OL 7 </strong> (Oracle Linux)和<strong class="le ix"> AMI 2 </strong>(亚马逊机器映像)可能会受到影响，这个问题可能会很普遍。但是，这一切只有在<strong class="le ix"> DST 根 CA X3 </strong>根证书没有被<strong class="le ix"><em class="mh">CA-certificates</em></strong>包删除的情况下。一旦它被移除，影响应该是最小的。</p><h1 id="644d" class="na nb in bd nc nd ps nf ng nh pt nj nk kc pu kd nm kf pv kg no ki pw kj nq nr bi translated">参考</h1><ol class=""><li id="1974" class="pd pe in le b lf ns li nt ll pf lp pg lt ph lx px pj pk pl bi translated"><a class="ae lb" href="https://letsencrypt.org/docs/dst-root-ca-x3-expiration-september-2021/" rel="noopener ugc nofollow" target="_blank"> DST 根 CA X3 到期</a>(2021 年 9 月)</li><li id="4560" class="pd pe in le b lf pm li pn ll po lp pp lt pq lx px pj pk pl bi translated"><a class="ae lb" href="https://letsencrypt.org/2020/12/21/extending-android-compatibility.html" rel="noopener ugc nofollow" target="_blank">扩展 Android 设备兼容性</a>让我们加密证书</li><li id="2307" class="pd pe in le b lf pm li pn ll po lp pp lt pq lx px pj pk pl bi translated"><a class="ae lb" href="https://community.letsencrypt.org/t/openssl-client-compatibility-changes-for-let-s-encrypt-certificates/143816" rel="noopener ugc nofollow" target="_blank"> OpenSSL 客户端兼容性变更</a></li></ol></div><div class="ab cl mt mu hr mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="ig ih ii ij ik"><p id="4f14" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated"><em class="mh">在第 0 根，我们提供解决方案</em> <a class="ae lb" href="https://www.0snet.com/" rel="noopener ugc nofollow" target="_blank"> <em class="mh">第 0 根安全网络— 0SNet </em> </a> <em class="mh">使用 TLS 客户端证书保护组织的内部 web 应用。看看我们的产品吧，它很容易部署，并且可以在</em><a class="ae lb" href="https://0snet.info/#install.aws" rel="noopener ugc nofollow" target="_blank"><em class="mh">AWS</em></a><em class="mh"/><a class="ae lb" href="https://0snet.info/#install.gcp" rel="noopener ugc nofollow" target="_blank"><em class="mh">GCP</em></a><em class="mh">和</em><a class="ae lb" href="https://0snet.info/#install.azu" rel="noopener ugc nofollow" target="_blank"><em class="mh">Azure</em></a><em class="mh">上找到。</em></p></div></div>    
</body>
</html>