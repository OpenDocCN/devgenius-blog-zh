<html>
<head>
<title>How to process media in AWS Lambda? (FFMPEG)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在 AWS Lambda 中处理媒体？(FFMPEG)</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/how-to-process-media-in-aws-lambda-ffmpeg-f53491cf8768?source=collection_archive---------0-----------------------#2019-07-29">https://blog.devgenius.io/how-to-process-media-in-aws-lambda-ffmpeg-f53491cf8768?source=collection_archive---------0-----------------------#2019-07-29</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/eedc28e10dc87da3b12a4eb897ca5245.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wzWUZ05IBI5eEWF3uBAoUA.jpeg"/></div></div></figure><p id="2bcb" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">上周，我接到一个新任务，我需要为图像和视频制作缩略图。对于 Python 来说，这是一项非常简单的任务。但作为一名解决方案架构师，我注意到一直在呼叫视频以供播放，而没有人从呼叫中获得任何额外的好处，这让我担心计费问题(S3 呼叫、数据传输和其他小事)。是的，你可以在浏览器上或者用 CloudFront 缓存链接，如果你用的话。但是这些是 API，它遵循无服务器结构。嗯，另一组场景是我可以减少检索这些媒体的费用。其中之一是，如果上传的是视频，就把它缩短。酷，但是，怎么做？</p><p id="59d4" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我以前经常使用 FFMPEG，我喜欢它，也喜欢它给我带来的好处。我用它来拍摄上传视频的小版本。FFMPEG 是一个基于二进制的工具，这意味着，它需要以正确的方式编译，以让托管服务器的操作系统理解如何处理。</p><p id="22f3" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们都知道 Lambda 的局限性，以及它会带来怎样的痛苦。所以，我们将使用层！</p><p id="c181" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我知道我说了很多，让我们开始吧:</p><h1 id="695b" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">编译资源:</h1><p id="6c96" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">首先，编译你的资源。</p><p id="b3cd" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如果你不熟悉这个过程，请跳到我之前的文章，看一看。</p><p id="7ddc" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我将在这里使用一些步骤，使文章在步骤方面有意义。</p><figure class="ly lz ma mb gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi lx"><img src="../Images/af156eb4cd9fb22d499de569196e5f27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*69PXDNhgmkBuGJpsPiPNrQ.png"/></div></div></figure><p id="5c88" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">连接到具有 Lambda 环境的 Docker 模板。它几乎就像是其操作系统的克隆版。</p><figure class="ly lz ma mb gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mc"><img src="../Images/e610b224261290374e9bf7c9b9e23166.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IOIHmfu6b4AwZvtZ9xB2kg.png"/></div></div></figure><p id="dbd0" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">根据图片，让我描述一下我做了什么:</p><p id="0638" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">1-我访问了 Docker 图像。</p><p id="e37d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">2-我制作了一个目录，并将其命名为 python(这是 AWS layers 推荐给你的 python 层命名的名称)</p><p id="4e43" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">3-输入 Python 目录。</p><p id="f134" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">4-我下载了 ffmpeg 的可执行版本。你可以在这个<a class="ae lw" href="https://johnvansickle.com/ffmpeg/" rel="noopener ugc nofollow" target="_blank">链接</a>上找到。</p><p id="0ca3" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">5-解压缩文件，并将 ffmpeg 和 ffprobe 放入主目录(python 根文件)。注意:确保你给了这两个文件在 Lambda 中执行的适当权限。</p><p id="c9c5" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">6-安装所需的资源。</p><p id="40bf" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如你所见，我编译了 Pillow (Python 图像库)，你可以用它来处理图像。这样做的原因是为了告诉你，它建议所有的 Lambda 资源都必须为它编译，一些依赖项可能是基于二进制的，并可能导致函数中的错误。</p><p id="323d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">完成这些步骤后，您应该拥有以下文件:</p><figure class="ly lz ma mb gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi md"><img src="../Images/7ae8c02853cdfe0158775707ee49d5f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1208/format:webp/1*Q_smw4oY6ZgHrBwncP8OOg.png"/></div></div></figure><p id="156b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">压缩目录，并为下一步做好准备，这是使层。</p><h1 id="183c" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">开始在云上准备资源:</h1><p id="78fa" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">访问 AWS 控制台并导航至 S3:</p><figure class="ly lz ma mb gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mc"><img src="../Images/115edfc1f5f1e0ff0489f4523a8553e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7VuBsgk2HBBSfiVPzQyHRA.png"/></div></div></figure><p id="12e5" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">你应该有一个桶，这样你就可以上传层。</p><blockquote class="me mf mg"><p id="7344" class="jv jw mh jx b jy jz ka kb kc kd ke kf mi kh ki kj mj kl km kn mk kp kq kr ks ig bi translated">注意:任何大于 50mb 的层必须上传到 S3，复制链接，我们将需要它。</p><p id="4b2a" class="jv jw mh jx b jy jz ka kb kc kd ke kf mi kh ki kj mj kl km kn mk kp kq kr ks ig bi translated">注意:任何层解压缩后必须小于 250mb，否则，层不会被创建。</p></blockquote><p id="7a0b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">让我们创建一个存储桶:</p><figure class="ly lz ma mb gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mc"><img src="../Images/02b778c1606aff3b92c5da238dfdc77a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wKsuyYCGDlhdMUmc32zd3g.png"/></div></div></figure><p id="72b7" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">下一步，上传图层:</p><figure class="ly lz ma mb gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ml"><img src="../Images/8abad5ddff6ae3163188cd32b29c17a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*133d2XzuRgXift2d7qO_wQ.png"/></div></div></figure><blockquote class="me mf mg"><p id="d02b" class="jv jw mh jx b jy jz ka kb kc kd ke kf mi kh ki kj mj kl km kn mk kp kq kr ks ig bi translated">注意:文件不应该是公共的，如果 IAM 用户有权限访问这些特性\工具(S3，Lambda)，那么，你就处于有利位置。</p></blockquote><p id="e1fb" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">文件上传后，复制链接。</p><p id="e832" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">导航到 Lambda:</p><figure class="ly lz ma mb gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mc"><img src="../Images/fb23faba24b8073f0f79090970b23627.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5rSFoq41LGr4re_22Y3_YQ.png"/></div></div></figure><p id="8693" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在屏幕左侧，单击图层:</p><figure class="ly lz ma mb gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mc"><img src="../Images/1d5d59d9011d01b2fe32eec4b5d59774.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CKVWtktczCNtsB5bCQPTeA.png"/></div></div></figure><p id="3dbf" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">点击创建新层，并填写以下表格:</p><figure class="ly lz ma mb gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mm"><img src="../Images/ab1dc3eb7577c55ecf22e4f16aa82fca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3Ut2Eh38jqXammS-VV0ZGg.png"/></div></div></figure><p id="53ff" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">1-给它一个名称</p><p id="1614" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">2-强烈建议为您的图层编写描述，因为同一图层可能有不同的版本。</p><p id="9164" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">3-单击第二个选项并粘贴链接。</p><p id="0279" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">4-指定兼容的运行时，因为它对您跟踪版本很重要。</p><figure class="ly lz ma mb gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mn"><img src="../Images/ec7deee7e74d133489c5a496101cedcc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PBNtepJQADMPF9QDlsZaAA.png"/></div></div></figure><p id="64aa" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">酷，我们准备好开始编码了:</p><blockquote class="me mf mg"><p id="463d" class="jv jw mh jx b jy jz ka kb kc kd ke kf mi kh ki kj mj kl km kn mk kp kq kr ks ig bi translated">免责声明:我知道下面的代码不是完美的代码，或者人们可能会争论它，这只是为了证明该过程是有效的和工作的。</p></blockquote><p id="500e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">让我们进入 Lambda 函数并开始编码:</p><figure class="ly lz ma mb gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mo"><img src="../Images/61791f69011b0fb90fef679a328f4043.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hU5VRwcAnrFuQM28H8dTtA.png"/></div></div></figure><p id="ccda" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我已经创建了函数并为它选择了运行时，我用的是 Python3.6。</p><blockquote class="me mf mg"><p id="6c6b" class="jv jw mh jx b jy jz ka kb kc kd ke kf mi kh ki kj mj kl km kn mk kp kq kr ks ig bi translated">注意:当你处理媒体甚至文件时，你需要确保你的函数有正确的权限集，我更新了这个函数的角色，使其具有读写 S3 的能力。</p></blockquote><p id="3ba4" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">正如你在下图中注意到的，我做的第一件事是将图层链接到函数。</p><figure class="ly lz ma mb gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mp"><img src="../Images/46160d04ca79e76095b3b5f35becd528.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3xGzumCcQ04ELRL5t1DH9Q.png"/></div></div></figure><p id="e179" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这是我从 S3 下载视频的代码片段，在第 7 秒时从视频中截取一帧并保存为 png，然后上传到 S3。</p><figure class="ly lz ma mb gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mq"><img src="../Images/503670379a5f156dd69972fb20d6f024.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j77cFR5uYJnBT16rPN6LFw.png"/></div></div></figure><blockquote class="me mf mg"><p id="e0ea" class="jv jw mh jx b jy jz ka kb kc kd ke kf mi kh ki kj mj kl km kn mk kp kq kr ks ig bi translated">注意:如果您不熟悉 Lambda，/tmp 是 Lambda 中的可写目录。</p></blockquote><p id="a89d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">正如你所猜测的，是的，它成功了！</p><figure class="ly lz ma mb gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mr"><img src="../Images/f59d6699f4e6aa2428905fcdaed3eb30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LCuk5VV4nLktrWZ2XltZxA.png"/></div></div></figure><h1 id="9434" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">结论和一些提示:</h1><p id="0211" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">这种方式非常适合我，是的，你可以增强它，但对于 Lambda 和无服务器世界的新来者来说，这是一个很好的起点。</p><p id="a196" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我有一些笔记和建议给你:</p><p id="6f6c" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">1-给这个函数所有可用的资源(超时和内存)，在你的场景中测试它，然后优化它，原因是看它实际上用了多少来处理你的媒体。你有不同的场景。因此，将应用不同的超时和 CPU/GPU/互联网使用。</p><p id="c8f3" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">2-如果你像我一样，使用了使用 ffmpeg link <em class="mh"> imageio </em>的库，你必须在你的代码中声明 ffmpeg 路径，否则，lambda 看不到它，在这种情况下，它在<em class="mh"> /opt/python </em>中。</p><p id="a338" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">3-另外，如果你要使用这些库，在压缩和上传之前，确保 ffmpeg 和 ffprobe 是可执行的。我面对这个问题。</p><p id="c313" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">4-使用 S3 下载/上传媒体，尽量不要将其作为文件返回，同一地区服务之间的数据传输是零美元。</p><p id="bf8c" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">快乐的无服务器处理！</p></div></div>    
</body>
</html>