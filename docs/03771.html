<html>
<head>
<title>Javascript — fetch API and HTML error statuses</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Javascript —获取API和HTML错误状态</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/javascript-fetch-api-and-html-error-statuses-694e7df55c4?source=collection_archive---------3-----------------------#2020-12-14">https://blog.devgenius.io/javascript-fetch-api-and-html-error-statuses-694e7df55c4?source=collection_archive---------3-----------------------#2020-12-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><blockquote class="jn"><p id="d19f" class="jo jp iq bd jq jr js jt ju jv jw jx dk translated">不要被这种有点令人惊讶的互动所迷惑。</p></blockquote><figure class="jz ka kb kc kd ke gh gi paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="gh gi jy"><img src="../Images/3f4de320cb41db3937a2309b635b2419.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qKVF5FWRimqu6ezB"/></div></div><figcaption class="kl km gj gh gi kn ko bd b be z dk translated">马科斯·迈尔在<a class="ae kp" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure></div><div class="ab cl kq kr hu ks" role="separator"><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv"/></div><div class="ij ik il im in"><p id="ef2b" class="pw-post-body-paragraph kx ky iq kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt jx ij bi translated">前几天我写了一个GET请求到一个端点，在测试中，我收到了很多400错误。400错误与<strong class="kz ir">客户端错误</strong>有关，基本上是由提出请求的人引起的错误。一些常见的400错误有:<strong class="kz ir"> <br/> - 400坏请求<br/> - 401未授权<br/> - 404未发现<br/> - </strong> <a class="ae kp" href="https://en.wikipedia.org/wiki/HTTP_418" rel="noopener ugc nofollow" target="_blank"> <strong class="kz ir"> 418我是茶壶</strong> </a> <strong class="kz ir"> </strong>(好吧也许没有这么多这一条，但这是一个真正的错误代码)</p><p id="8ddb" class="pw-post-body-paragraph kx ky iq kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt jx ij bi translated">现在，这是绝对好的，我已经预料到会遇到这些错误。但是我没有想到的是，当API响应返回时，我的API钩子(在我的例子中是React-query)正在触发<strong class="kz ir"> onSuccess方法</strong>。基本上，我的调用失败了，出现400错误，但是我的API管理钩子认为它成功了。非常奇怪。</p><p id="6f40" class="pw-post-body-paragraph kx ky iq kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt jx ij bi translated">起初，我怀疑React-query中有违规行为，不知何故，400个错误被编码为成功，尽管这在我看来很疯狂。<br/>但是经过一番挖掘，发现其实是<strong class="kz ir"> fetch API </strong>的‘毛病’。事实证明，<strong class="kz ir">这根本不是故障</strong>，这是预期行为。那么fetch如何处理HTTP错误状态呢？</p></div><div class="ab cl kq kr hu ks" role="separator"><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv"/></div><div class="ij ik il im in"><h2 id="cd06" class="lv lw iq bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">什么是成功？</h2><p id="60fc" class="pw-post-body-paragraph kx ky iq kz b la mo lc ld le mp lg lh li mq lk ll lm mr lo lp lq ms ls lt jx ij bi translated">对于你们中的一些读者来说，这篇文章可能看起来非常明显——我认为这可以归结为我们自己对成功的定义。对我来说，API环境中的成功意味着类似于:</p><p id="125e" class="pw-post-body-paragraph kx ky iq kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt jx ij bi translated">1.我们发出了我们的请求。服务器回应<br/> 3。我们被授权提出那个请求。我们的要求被执行<br/> 5。一切正常，我们得到了200 ok状态的🥳</p><p id="1919" class="pw-post-body-paragraph kx ky iq kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt jx ij bi translated"><strong class="kz ir">但这不是fetch定义成功的方式</strong>。Fetch只对第2点感兴趣。fetch所关心的是网络是否能够执行请求。本质上，我们可以认为fetch是这样工作的；</p><figure class="mu mv mw mx gt ke gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/e0a5398416205e823e05507fa08d4dc4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1080/format:webp/1*Xkfm59PppA4EBp689NOAeg.png"/></div><figcaption class="kl km gj gh gi kn ko bd b be z dk translated">获取API成功响应的简化</figcaption></figure><p id="517b" class="pw-post-body-paragraph kx ky iq kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt jx ij bi translated">如果你像我一样认为，成功基本上等同于200的地位，那么这是一个有点难以接受的概念。我们可以返回一个500的错误，但在技术上仍然是成功的？Fetch说是的。</p><h2 id="06a1" class="lv lw iq bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">那么我们如何用fetch处理错误状态呢？</h2><p id="5b18" class="pw-post-body-paragraph kx ky iq kz b la mo lc ld le mp lg lh li mq lk ll lm mr lo lp lq ms ls lt jx ij bi translated">让我们来看看一些代码。</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="721c" class="lv lw iq mz b gy nd ne l nf ng">export const getExample = async ({ token }) =&gt; {<br/>    const response = await fetch("API_URL", {<br/>        method: "GET",<br/>        headers: {<br/>            "Authorization": `Bearer ${token}`<br/>        }<br/>    });<br/>    return response;<br/>};</span></pre><p id="a4a2" class="pw-post-body-paragraph kx ky iq kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt jx ij bi translated">这个<code class="fe nh ni nj mz b">getExample</code>函数返回一个承诺，这是一个简单的GET fetch API请求的响应。如果我们使用API管理库(比如React-query/Apollo ect)来消费这个承诺，那么他们会告诉我们这是一个成功的调用，因为响应承诺没有失败。请记住— Fetch仅在网络错误时不履行承诺，而在错误状态时不履行承诺。如果我们想改变这种行为，我们要做的就是<strong class="kz ir">手动拒绝/拒绝承诺</strong>。</p><p id="671e" class="pw-post-body-paragraph kx ky iq kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt jx ij bi translated">谢天谢地，这很简单。虽然fetch没有违背我们的承诺，但是如果返回的错误状态不是200–299，它会将一个名为<code class="fe nh ni nj mz b">ok</code>的响应标志设置为false。更多关于<code class="fe nh ni nj mz b">response.Ok</code>旗帜的信息，请点击此处—<a class="ae kp" href="https://developer.mozilla.org/en-US/docs/Web/API/Response/ok" rel="noopener ugc nofollow" target="_blank">https://developer . Mozilla . org/en-US/docs/Web/API/Response/ok</a></p><p id="8944" class="pw-post-body-paragraph kx ky iq kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt jx ij bi translated">记住这一点，我们可以写一个检查，看看布尔标志是否被设置为假，如果是这样，我们可以手动取消承诺。这应该可以了；</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="464e" class="lv lw iq mz b gy nd ne l nf ng">...</span><span id="4339" class="lv lw iq mz b gy nk ne l nf ng">if (!response.ok) await <strong class="mz ir"><em class="lu">Promise</em></strong>.reject(new <strong class="mz ir"><em class="lu">Error</em></strong>(response.status.toString())); //Write your own error msg here<br/>return response;</span></pre></div><div class="ab cl kq kr hu ks" role="separator"><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv"/></div><div class="ij ik il im in"><h2 id="cb17" class="lv lw iq bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated"><strong class="ak">重述</strong></h2><p id="0031" class="pw-post-body-paragraph kx ky iq kz b la mo lc ld le mp lg lh li mq lk ll lm mr lo lp lq ms ls lt jx ij bi translated"><strong class="kz ir"> API成功！== 200 OK </strong> <br/> Fetch只要得到服务器的响应就不关心错误状态。如果代码不是我们想要的样子，我们需要手动检查并使响应承诺失败。<br/>或者……我们可以只使用Axios，它会自动为我们完成这项工作。</p></div><div class="ab cl kq kr hu ks" role="separator"><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv"/></div><div class="ij ik il im in"><p id="8735" class="pw-post-body-paragraph kx ky iq kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt jx ij bi translated"><strong class="kz ir"> <em class="lu">来源</em> </strong></p><div class="nl nm gp gr nn no"><a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API" rel="noopener  ugc nofollow" target="_blank"><div class="np ab fo"><div class="nq ab nr cl cj ns"><h2 class="bd ir gy z fp nt fr fs nu fu fw ip bi translated">获取API</h2><div class="nv l"><h3 class="bd b gy z fp nt fr fs nu fu fw dk translated">获取API提供了获取资源的接口(包括通过网络)。对…似乎很熟悉</h3></div><div class="nw l"><p class="bd b dl z fp nt fr fs nu fu fw dk translated">developer.mozilla.org</p></div></div><div class="nx l"><div class="ny l nz oa ob nx oc kj no"/></div></div></a></div><div class="nl nm gp gr nn no"><a href="https://developer.mozilla.org/en-US/docs/Web/API/Response" rel="noopener  ugc nofollow" target="_blank"><div class="np ab fo"><div class="nq ab nr cl cj ns"><h2 class="bd ir gy z fp nt fr fs nu fu fw ip bi translated">响应-Web API | MDN</h2><div class="nv l"><h3 class="bd b gy z fp nt fr fs nu fu fw dk translated">Fetch API的接口表示对请求的响应。您可以使用…创建新的响应对象</h3></div><div class="nw l"><p class="bd b dl z fp nt fr fs nu fu fw dk translated">developer.mozilla.org</p></div></div><div class="nx l"><div class="od l nz oa ob nx oc kj no"/></div></div></a></div></div><div class="ab cl kq kr hu ks" role="separator"><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv"/></div><div class="ij ik il im in"><p id="5549" class="pw-post-body-paragraph kx ky iq kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt jx ij bi translated">如果你喜欢这篇文章或者觉得它有用，请随意。或者，你可以在这里的Medium  <a class="ae kp" href="https://jamesmbrightman.medium.com/membership" rel="noopener"> <em class="lu">上支持我</em> </a> <em class="lu">或者给我买一杯</em> <a class="ae kp" href="https://ko-fi.com/jamesbrightman" rel="noopener ugc nofollow" target="_blank"> <em class="lu">咖啡</em> </a> <em class="lu">！非常感谢所有的支持。</em></p></div></div>    
</body>
</html>