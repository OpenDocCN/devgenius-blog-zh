<html>
<head>
<title>Facial Emotion Detection using AWS Rekognition in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Python中基于AWS识别的人脸情感检测</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/facial-emotion-detection-using-aws-rekognition-in-python-69b2da668192?source=collection_archive---------4-----------------------#2020-06-15">https://blog.devgenius.io/facial-emotion-detection-using-aws-rekognition-in-python-69b2da668192?source=collection_archive---------4-----------------------#2020-06-15</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/fa726fc7dec903b943ae5bfa17002109.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*HBfash5hK4kfadmv"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">乔希·里默尔在<a class="ae jz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><h1 id="78c4" class="ka kb in bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">AWS识别</h1><p id="942f" class="pw-post-body-paragraph ky kz in la b lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv ig bi translated">Amazon Rekognition使用成熟的、高度可扩展的深度学习技术，无需使用机器学习专业知识，就可以轻松地将图像和视频分析添加到您的应用程序中。</p><p id="57f3" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">我们将看到如何使用这个服务从图像中检测人脸和人脸上的情绪。</p><h1 id="6a85" class="ka kb in bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">人脸检测</h1><p id="d3f0" class="pw-post-body-paragraph ky kz in la b lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv ig bi translated">首先，我们将了解如何检测图像中的人脸。为了访问AWS Rekognition，我们将使用python包<em class="mb"> boto3 </em>。移民局</p><p id="6304" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">使用以下命令安装<em class="mb"> boto3 </em>:</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="86e1" class="ml kb in mh b gy mm mn l mo mp">pip install boto3</span></pre><p id="0002" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">要使用<em class="mb">重新识别</em>服务，</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="9c69" class="ml kb in mh b gy mm mn l mo mp">import boto3</span><span id="27ea" class="ml kb in mh b gy mq mn l mo mp">rekognition = boto3.client('rekognition',aws_access_key_id=AWS_ACCESS_KEY,<br/>             aws_secret_access_key=AWS_SECRET_KEY,<br/>             region_name=AWS_REGION)</span></pre><p id="debc" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">我们将使用本地存储中的图像。Rekogntion有一个函数<em class="mb"> detect_faces() </em>从图像中检测所有的人脸。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="db77" class="ml kb in mh b gy mm mn l mo mp">with open('file.png', 'rb') as image_data:<br/>     response_content = image_data.read()</span><span id="b899" class="ml kb in mh b gy mq mn l mo mp">rekognition_response =<br/>rekognition.detect_faces(Image={'Bytes':response_content}, Attributes=['ALL'])</span></pre><p id="50ba" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">如果你想从S3桶中检查一个图像，你可以传递桶名和文件密钥。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="fa5e" class="ml kb in mh b gy mm mn l mo mp">rekognition_response = rekognition.detect_faces(Image={'S3Object': {'Bucket': BUCKET_NAME, 'Name': file_key}}, Attributes=['ALL'])</span></pre><p id="8cb4" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated"><em class="mb"> detect_faces() </em>函数返回以下响应。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="c49e" class="ml kb in mh b gy mm mn l mo mp">{<br/>    'FaceDetails': [<br/>        {<br/>            'BoundingBox': {<br/>                'Width': <strong class="mh io">...</strong>,<br/>                'Height': <strong class="mh io">...</strong>,<br/>                'Left': <strong class="mh io">...</strong>,<br/>                'Top': <strong class="mh io">...</strong><br/>            },<br/>            'AgeRange': {<br/>                'Low': 123,<br/>                'High': 123<br/>            },<br/>            'Smile': {<br/>                'Value': <strong class="mh io">True|False</strong>,<br/>                'Confidence': <strong class="mh io">...</strong><br/>            },<br/>            'Eyeglasses': {<br/>                'Value': <strong class="mh io">True|False</strong>,<br/>                'Confidence': <strong class="mh io">...</strong><br/>            },<br/>            'Sunglasses': {<br/>                'Value': <strong class="mh io">True|False</strong>,<br/>                'Confidence': <strong class="mh io">...</strong><br/>            },<br/>            'Gender': {<br/>                'Value': 'Male'<strong class="mh io">|</strong>'Female',<br/>                'Confidence': <strong class="mh io">...</strong><br/>            },<br/>            'Beard': {<br/>                'Value': <strong class="mh io">True|False</strong>,<br/>                'Confidence': <strong class="mh io">...</strong><br/>            },<br/>            'Mustache': {<br/>                'Value': <strong class="mh io">True|False</strong>,<br/>                'Confidence': <strong class="mh io">...</strong><br/>            },<br/>            'EyesOpen': {<br/>                'Value': <strong class="mh io">True|False</strong>,<br/>                'Confidence': <strong class="mh io">...</strong><br/>            },<br/>            'MouthOpen': {<br/>                'Value': <strong class="mh io">True|False</strong>,<br/>                'Confidence': <strong class="mh io">...</strong><br/>            },<br/>            'Emotions': [<br/>                {<br/>                    'Type': 'HAPPY'<strong class="mh io">|</strong>'SAD'<strong class="mh io">|</strong>'ANGRY'<strong class="mh io">|</strong>'CONFUSED'<strong class="mh io">|</strong>'DISGUSTED'<strong class="mh io">|</strong>'SURPRISED'<strong class="mh io">|</strong>'CALM'<strong class="mh io">|</strong>'UNKNOWN'<strong class="mh io">|</strong>'FEAR',<br/>                    'Confidence': <strong class="mh io">...</strong><br/>                },<br/>            ],<br/>            'Landmarks': [<br/>                {<br/>                    'Type': 'eyeLeft'<strong class="mh io">|</strong>'eyeRight'<strong class="mh io">|</strong>'nose'<strong class="mh io">|</strong>'mouthLeft'<strong class="mh io">|</strong>'mouthRight'<strong class="mh io">|</strong>'leftEyeBrowLeft'<strong class="mh io">|</strong>'leftEyeBrowRight'<strong class="mh io">|</strong>'leftEyeBrowUp'<strong class="mh io">|</strong>'rightEyeBrowLeft'<strong class="mh io">|</strong>'rightEyeBrowRight'<strong class="mh io">|</strong>'rightEyeBrowUp'<strong class="mh io">|</strong>'leftEyeLeft'<strong class="mh io">|</strong>'leftEyeRight'<strong class="mh io">|</strong>'leftEyeUp'<strong class="mh io">|</strong>'leftEyeDown'<strong class="mh io">|</strong>'rightEyeLeft'<strong class="mh io">|</strong>'rightEyeRight'<strong class="mh io">|</strong>'rightEyeUp'<strong class="mh io">|</strong>'rightEyeDown'<strong class="mh io">|</strong>'noseLeft'<strong class="mh io">|</strong>'noseRight'<strong class="mh io">|</strong>'mouthUp'<strong class="mh io">|</strong>'mouthDown'<strong class="mh io">|</strong>'leftPupil'<strong class="mh io">|</strong>'rightPupil'<strong class="mh io">|</strong>'upperJawlineLeft'<strong class="mh io">|</strong>'midJawlineLeft'<strong class="mh io">|</strong>'chinBottom'<strong class="mh io">|</strong>'midJawlineRight'<strong class="mh io">|</strong>'upperJawlineRight',<br/>                    'X': <strong class="mh io">...</strong>,<br/>                    'Y': <strong class="mh io">...</strong><br/>                },<br/>            ],<br/>            'Pose': {<br/>                'Roll': <strong class="mh io">...</strong>,<br/>                'Yaw': <strong class="mh io">...</strong>,<br/>                'Pitch': <strong class="mh io">...</strong><br/>            },<br/>            'Quality': {<br/>                'Brightness': <strong class="mh io">...</strong>,<br/>                'Sharpness': <strong class="mh io">...</strong><br/>            },<br/>            'Confidence': <strong class="mh io">...</strong><br/>        },<br/>    ],<br/>    'OrientationCorrection': 'ROTATE_0'<strong class="mh io">|</strong>'ROTATE_90'<strong class="mh io">|</strong>'ROTATE_180'<strong class="mh io">|</strong>'ROTATE_270'<br/>}</span></pre><p id="e735" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">正如您在上面看到的，Rekognition为图像中检测到的每个人脸提供了许多属性。</p><p id="6857" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">在这里，我们将使用边界框属性来确定从图像中检测到的人脸的尺寸。</p><p id="1b43" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">要使用它，首先我们需要找到所用图像的精确宽度和高度。为此，我们将使用Python包<em class="mb"> Pillow(PIL) </em>。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="d258" class="ml kb in mh b gy mm mn l mo mp">pip install Pillow<br/></span><span id="9af9" class="ml kb in mh b gy mq mn l mo mp">from PIL import Image</span><span id="2249" class="ml kb in mh b gy mq mn l mo mp">image = Image.open('file.png')<br/>image_width, image_height = image.size</span></pre><p id="e7bf" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">我们将从图像中裁剪掉所有的脸。Rekogntion返回0到1之间的十进制小数形式的边界框值(例如，0.391559898853302)。所以，我们要把这些值作为整数。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="1be8" class="ml kb in mh b gy mm mn l mo mp">i = 1<br/>for item in rekognition_response.get('FaceDetails'):<br/>    bounding_box = item['BoundingBox']<br/>    print('Bounding box {}'.format(bounding_box))<br/>    width = image_width * bounding_box['Width']<br/>    height = image_height * bounding_box['Height']<br/>    left = image_width * bounding_box['Left']<br/>    top = image_height * bounding_box['Top']<br/><br/>    left = int(left)<br/>    top = int(top)<br/>    width = int(width) + left<br/>    height = int(height) + top<br/><br/>    box = (left, top, width, height)<br/>    box_string = (str(left), str(top), str(width), str(height))<br/>    print(box)<br/>    cropped_image = image.crop(box)<br/>    thumbnail_name = '{}.png'.format(i)<br/>    i += 1<br/>    cropped_image.save(thumbnail_name, 'PNG')</span></pre><figure class="mc md me mf gt jo gh gi paragraph-image"><div class="gh gi mr"><img src="../Images/a39846121f25b66047da2381ea8cbe2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:450/format:webp/1*qRysZI67n17WBO14XquQ7g.jpeg"/></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">原象</figcaption></figure><figure class="mc md me mf gt jo gh gi paragraph-image"><div class="gh gi ms"><img src="../Images/0524e543635438f2625bcc48d0d4f7af.png" data-original-src="https://miro.medium.com/v2/resize:fit:130/format:webp/1*SFnFS8xOvZhCUb45wMXRQQ.png"/></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">裁剪面1</figcaption></figure><figure class="mc md me mf gt jo gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/bc9345343fc9c1ca61831de6405af233.png" data-original-src="https://miro.medium.com/v2/resize:fit:122/format:webp/1*D9_eg0MuhzTt54Hh1_9GxA.png"/></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">裁剪面2</figcaption></figure><h1 id="e695" class="ka kb in bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">情感检测</h1><p id="d701" class="pw-post-body-paragraph ky kz in la b lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv ig bi translated">现在，我们将检测面部表情。在来自<em class="mb"> detect_faces() </em>函数的相同Rekognition响应中，我们得到了情感值。我们将解析<em class="mb"> FaceDetails </em>属性来获取情绪。它将返回7种类型的情绪-快乐，平静，悲伤，愤怒，惊讶，困惑和厌恶，以及他们对每张脸的信心值。</p><p id="535f" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">举个例子，</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="55d0" class="ml kb in mh b gy mm mn l mo mp">'Emotions': [{<br/>   'Type': 'CALM',<br/>   'Confidence': 21.520294189453125<br/>  }, {<br/>   'Type': 'ANGRY',<br/>   'Confidence': 1.0282570123672485<br/>  }, {<br/>   'Type': 'HAPPY',<br/>   'Confidence': 1.2899268865585327<br/>  }, {<br/>   'Type': 'DISGUSTED',<br/>   'Confidence': 0.8267041444778442<br/>  }, {<br/>   'Type': 'SAD',<br/>   'Confidence': 0.14941808581352234<br/>  }, {<br/>   'Type': 'FEAR',<br/>   'Confidence': 0.3257277309894562<br/>  }, {<br/>   'Type': 'CONFUSED',<br/>   'Confidence': 3.0882787704467773<br/>  }, {<br/>   'Type': 'SURPRISED',<br/>   'Confidence': 71.7713851928711<br/>  }]</span></pre><p id="6efb" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">我们将解析这个响应，并获取具有最高置信度值的情感。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="72c8" class="ml kb in mh b gy mm mn l mo mp">i = 1<br/>for item in rekognition_response.get('FaceDetails'):<br/>    bounding_box = item['BoundingBox']<br/>    print('Bounding box {}'.format(bounding_box))<br/>    width = image_width * bounding_box['Width']<br/>    height = image_height * bounding_box['Height']<br/>    left = image_width * bounding_box['Left']<br/>    top = image_height * bounding_box['Top']<br/><br/>    left = int(left)<br/>    top = int(top)<br/>    width = int(width) + left<br/>    height = int(height) + top<br/><br/>    box = (left, top, width, height)<br/>    box_string = (str(left), str(top), str(width), str(height))<br/>    print(box)<br/>    cropped_image = image.crop(box)<br/>    thumbnail_name = '{}.png'.format(i)<br/>    i += 1<br/>    cropped_image.save(thumbnail_name, 'PNG')<br/><br/>    face_emotion_confidence = 0<br/>    face_emotion = None<br/>    for emotion in item.get('Emotions'):<br/>        if emotion.get('Confidence') &gt;= face_emotion_confidence:<br/>            face_emotion_confidence = emotion['Confidence']<br/>            face_emotion = emotion.get('Type')<br/>    print('{} - {}'.format(thumbnail_name, face_emotion))</span></pre><p id="011b" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">我们通过面部表情得到以下数值。</p><figure class="mc md me mf gt jo gh gi paragraph-image"><div class="gh gi ms"><img src="../Images/0524e543635438f2625bcc48d0d4f7af.png" data-original-src="https://miro.medium.com/v2/resize:fit:130/format:webp/1*SFnFS8xOvZhCUb45wMXRQQ.png"/></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">惊讶的</figcaption></figure><figure class="mc md me mf gt jo gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/bc9345343fc9c1ca61831de6405af233.png" data-original-src="https://miro.medium.com/v2/resize:fit:122/format:webp/1*D9_eg0MuhzTt54Hh1_9GxA.png"/></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">幸福的</figcaption></figure><p id="d97c" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">希望这篇教程有帮助。玩得开心。</p><p id="766d" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">继续编码！！！</p></div></div>    
</body>
</html>