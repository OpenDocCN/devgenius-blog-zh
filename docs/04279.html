<html>
<head>
<title>How to use Rails ActionCable from an external client application</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何从外部客户端应用程序使用Rails ActionCable</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/how-to-use-rails-actioncable-from-an-external-client-application-cd4e602594e1?source=collection_archive---------0-----------------------#2021-02-20">https://blog.devgenius.io/how-to-use-rails-actioncable-from-an-external-client-application-cd4e602594e1?source=collection_archive---------0-----------------------#2021-02-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/411bdbaef9e42e81bf198fdb29192d9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*50CxOmLMxibmUV0Q"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated"><a class="ae kc" href="https://unsplash.com/@umby?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">翁贝托</a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><blockquote class="kd ke kf"><p id="edfe" class="kg kh ki kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">WebSockets是一种很好的方式，它允许使用持久的双向通道进行客户机-服务器通信，而客户机不必轮询服务器。</p></blockquote><p id="cd44" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">在这篇文章<strong class="kj ir">中，我将解释如何从一个通用应用程序</strong>开始使用Ruby on Rails中的websocket。我不会深究什么是Websocket或者如何创建Rails项目。我就在本文最后留一些链接吧。</p><h2 id="ab22" class="li lj iq bd lk ll lm dn ln lo lp dp lq lf lr ls lt lg lu lv lw lh lx ly lz ma bi translated">首先，Rails中的WebSocket被称为ActionCable。</h2></div><div class="ab cl mb mc hu md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ij ik il im in"><p id="5ad9" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated"><strong class="kj ir">问题</strong>:来自<a class="ae kc" href="https://guides.rubyonrails.org/action_cable_overview.html#parent-channel-setup" rel="noopener ugc nofollow" target="_blank">官方文档</a>或其他类似<a class="ae kc" href="https://dev.to/nkemjiks/simple-chatroom-with-rails-6-and-actioncable-3bc3" rel="noopener ugc nofollow" target="_blank">的教程本</a>解释了如何配置服务器部分，并展示了使用<em class="ki"> rails/actioncable </em>节点模块从Javascript前端进行订阅和通信的代码。但是<strong class="kj ir">如果你有一个只有API的Rails项目或者你有一个除了JS </strong>之外的前端，比如一个Android或者iOS应用程序，那该怎么办？这也是我写这篇文章的原因。</p><p id="06ee" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated"><strong class="kj ir">开始:</strong>假设我们有一个Rails项目，您运行下面的命令</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="f94b" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">它将生成一个名为<em class="ki">&lt;your _ name&gt;_ channel . Rb</em>的文件，我们可以在其中处理客户端订阅或/和我们可以编写客户端调用的自定义方法……为了保持简单，我们将实现订阅的方法，并从头开始编写一个自定义的哑方法(“my_method”)，该方法接收“data”参数。我们稍后会看到什么是“数据”。在这个例子中，让我们用ChatChannel替换&lt; your_name &gt;。这是文件的样子。</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div></figure><h2 id="5e08" class="li lj iq bd lk ll lm dn ln lo lp dp lq lf lr ls lt lg lu lv lw lh lx ly lz ma bi translated">我们的目标是从JS之外的外部客户端或Rails项目之外访问“subscribed”和“my_method”方法。开始吧！！！</h2><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mo"><img src="../Images/59b443adafce06bb00659fe6e457efe9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8O31MO34wqNISr2q"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">布拉登·科拉姆在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="4515" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated"><em class="ki">第一个问题:如何创建WebSocket客户端？或者我们可以使用一个“邮差”一样的客户端已经可用吗？</em></p><p id="8940" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">有许多方法和库可以为许多平台建立WebSocket连接，但是要开始，我建议使用WebSocket客户端</p><ul class=""><li id="257a" class="mp mq iq kj b kk kl ko kp lf mr lg ms lh mt le mu mv mw mx bi translated"><a class="ae kc" href="http://www.websocket.org/echo.html" rel="noopener ugc nofollow" target="_blank">http://www.websocket.org/echo.html</a></li><li id="f54d" class="mp mq iq kj b kk my ko mz lf na lg nb lh nc le mu mv mw mx bi translated"><a class="ae kc" href="https://chrome.google.com/webstore/detail/websocket-test-client/fgponpodhbmadfljofbimhhlengambbn" rel="noopener ugc nofollow" target="_blank">这个Chrome插件</a></li></ul><p id="c57c" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated"><em class="ki">第二个问题:我应该调用哪个URL？在我的项目路线中，我看不到任何与ActionCable </em>相关的内容</p><ul class=""><li id="bcc1" class="mp mq iq kj b kk kl ko kp lf mr lg ms lh mt le mu mv mw mx bi translated">首先，我们必须将协议从http/https改为ws。</li><li id="0c66" class="mp mq iq kj b kk my ko mz lf na lg nb lh nc le mu mv mw mx bi translated">假设我们的Rails项目运行在localhost端口3000上。</li><li id="241f" class="mp mq iq kj b kk my ko mz lf na lg nb lh nc le mu mv mw mx bi translated">默认情况下，在没有指定任何其他内容的情况下，Rails在<em class="ki"> /cable </em>路径上公开WebSocket服务</li></ul><p id="7386" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">把这些东西放在一起<strong class="kj ir">URL是ws://localhost:3000/cable </strong></p><p id="db95" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated"><em class="ki">第三个问题:我们如何沟通？</em></p><p id="0189" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated"><strong class="kj ir">基本上与WebSocket协议</strong>规定的JSON  <strong class="kj ir">消息一致。像<em class="ki"> rails/actioncable </em> JS模块一样，libraries提供了一种“SDK方式”来管理这些消息，但是在我们简单的web客户端中，我们只有一个“消息字段”来写入命令，仅此而已。我努力寻找请求的格式，在我写作的时候，我想还有很多需要寻找的东西。为了指引我正确的方向，我找到了这两篇文章(<a class="ae kc" href="https://medium.com/@emikaijuin/connecting-to-action-cable-without-rails-d39a8aaa52d5" rel="noopener"> 1 </a>、<a class="ae kc" href="https://thoughtbot.com/blog/talking-to-actioncable-without-rails" rel="noopener ugc nofollow" target="_blank"> 2 </a>)。<em class="ki"> 2 </em>也解释了如何验证用户。为了以简单的方式了解“步骤0”的工作原理，我将忽略这一步。从<em class="ki"> 1 </em>中，我尝试将<em class="ki"> sendTXT </em>方法中的字符串按原样复制/粘贴到web客户端消息字段中(即使使用了开始/结束双引号和所有转义字符:<em class="ki"> "{\"command\":\"subscribe\ "，\ " identifier \ ":\ " { \ \ \ " channel \ \ \ ":\ \ \ " ArduinoChannel \ \ \ " } \ "</em>)，但没有成功(我先将名称改为我的通道名称)。我试图删除开始/结束引号，我认为一个问题是转义字符太多。因此，我试图在Rails控制台的帮助下序列化一个表示上述JSON的字典。我终于得到了这个JSON:</strong></p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div></figure><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="nd mn l"/></div></figure><p id="c685" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">成功了！！！！网络控制台回复我“欢迎”！只需查看一下Rails日志，确保调用了“subscribed”方法并打印出“subscribed”。是啊！！！好了，那么:现在如何调用<em class="ki"> my_method </em>方法？</p><p id="3bb6" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">这是最棒的部分:我们可以传递尽可能多的参数，并且可以用非常相似的JSON调用任何方法</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="85cf" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">区别在于:</p><ul class=""><li id="ce31" class="mp mq iq kj b kk kl ko kp lf mr lg ms lh mt le mu mv mw mx bi translated">命令类型已从“订阅”更改为“消息”</li><li id="129b" class="mp mq iq kj b kk my ko mz lf na lg nb lh nc le mu mv mw mx bi translated">标识符<strong class="kj ir">必须</strong>与订阅保持一致</li><li id="c733" class="mp mq iq kj b kk my ko mz lf na lg nb lh nc le mu mv mw mx bi translated">我们添加了带有JSON字符串(带有所有转义字符)的“data”键</li></ul><p id="a846" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">让我们从控制台发送这条消息，并查看一下Rails日志。我们会看到这些线条</p><ul class=""><li id="5e71" class="mp mq iq kj b kk kl ko kp lf mr lg ms lh mt le mu mv mw mx bi translated"><em class="ki">chat channel # my _ method({ " code " =&gt;" a " })。</em>它识别“action”关键字，并将JSON解释为散列参数。如果我们打印<em class="ki">数据</em>参数，我们得到的确实是<em class="ki"> {"action"= &gt; "my_method "，" code"= &gt; "a"} </em></li></ul><h1 id="3ced" class="ne lj iq bd lk nf ng nh ln ni nj nk lq nl nm nn lt no np nq lw nr ns nt lz nu bi translated">我们的目标达到了！！！太好了！</h1><p id="7764" class="pw-post-body-paragraph kg kh iq kj b kk nv km kn ko nw kq kr lf nx ku kv lg ny ky kz lh nz lc ld le ij bi translated">最后一点:在普通的Rails (http)控制器方法中，您可以编写以下代码:</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="c297" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated">您正在通过WebSocket在“chat_channel”上发送“更新已经到达…”字符串:这甚至会打印在您的web控制台上。这看起来不像通知吗？</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="oa mn l"/></div></figure></div><div class="ab cl mb mc hu md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ij ik il im in"><h1 id="09b0" class="ne lj iq bd lk nf ob nh ln ni oc nk lq nl od nn lt no oe nq lw nr of nt lz nu bi translated">更多参考</h1><p id="682a" class="pw-post-body-paragraph kg kh iq kj b kk nv km kn ko nw kq kr lf nx ku kv lg ny ky kz lh nz lc ld le ij bi translated">要了解WebSocket或创建Rails项目</p><ul class=""><li id="2cb7" class="mp mq iq kj b kk kl ko kp lf mr lg ms lh mt le mu mv mw mx bi translated"><a class="ae kc" href="https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API" rel="noopener ugc nofollow" target="_blank">什么是WebSocket？</a></li><li id="fe9b" class="mp mq iq kj b kk my ko mz lf na lg nb lh nc le mu mv mw mx bi translated"><a class="ae kc" href="https://docs.docker.com/compose/rails/" rel="noopener ugc nofollow" target="_blank">用Docker </a>创建一个Rails应用</li><li id="595b" class="mp mq iq kj b kk my ko mz lf na lg nb lh nc le mu mv mw mx bi translated"><a class="ae kc" href="https://guides.rubyonrails.org/getting_started.html" rel="noopener ugc nofollow" target="_blank"> Rails官方指南创建新项目</a></li></ul><p id="1c52" class="pw-post-body-paragraph kg kh iq kj b kk kl km kn ko kp kq kr lf kt ku kv lg kx ky kz lh lb lc ld le ij bi translated"><em class="ki">感谢阅读……</em></p></div></div>    
</body>
</html>