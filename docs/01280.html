<html>
<head>
<title>Dockerizing a Rails 6 Application with Postgresql WITHOUT Docker Compose</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在没有 Docker Compose 的情况下用 Postgresql 对 Rails 6 应用程序进行 Dockerizing</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/dockerizing-a-rails-6-application-with-postgresql-without-docker-compose-1a0853956ae6?source=collection_archive---------7-----------------------#2020-06-29">https://blog.devgenius.io/dockerizing-a-rails-6-application-with-postgresql-without-docker-compose-1a0853956ae6?source=collection_archive---------7-----------------------#2020-06-29</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/f3fa31384ba4b6b4f6c2bccee338af25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oPLpigWvl2hds7b0GjjAQw.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">在没有 Docker Compose 的情况下用 Postgresql 对 Rails 6 应用程序进行 Dockerizing</figcaption></figure><h1 id="905f" class="jz ka in bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">介绍</h1><p id="31e2" class="pw-post-body-paragraph kx ky in kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu ig bi translated">在最后一个故事中，我展示了如何在 Docker 上创建自己的 rails 6 映像。</p><p id="2813" class="pw-post-body-paragraph kx ky in kz b la lw lc ld le lx lg lh li ly lk ll lm lz lo lp lq ma ls lt lu ig bi translated">当我尝试将 Rails 与 Docker 结合使用时，另一件让我产生疑虑事情是 Rails 6 应用程序和 Postgresql 数据库之间的集成。我花了很多时间研究一种不用 DOCKER COMPOSE 的方法。</p><p id="3610" class="pw-post-body-paragraph kx ky in kz b la lw lc ld le lx lg lh li ly lk ll lm lz lo lp lq ma ls lt lu ig bi translated">但你会问我:“为什么没有码头工人作曲？”</p><p id="70e9" class="pw-post-body-paragraph kx ky in kz b la lw lc ld le lx lg lh li ly lk ll lm lz lo lp lq ma ls lt lu ig bi translated">答案很简单。我喜欢研究理解我在做什么。使用现成映像或现成的 docker 构建器来创建我的容器并返回我的项目配置不允许我确切地了解 docker 是如何工作的。</p><h1 id="763d" class="jz ka in bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">创建 Postgres 容器</h1><p id="14f7" class="pw-post-body-paragraph kx ky in kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu ig bi translated">没错。做完这个小小的解释后，我们再来看什么事。要用 postgresql 创建一个 Rails 应用程序，我们需要打开两个 docker 容器。</p><p id="6e71" class="pw-post-body-paragraph kx ky in kz b la lw lc ld le lx lg lh li ly lk ll lm lz lo lp lq ma ls lt lu ig bi translated">首先，我们将打开一个 postgresql 容器。要使用此命令，您需要位于要添加 postgres 文件的独立文件夹中。</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="3ea7" class="mk ka in mg b gy ml mm l mn mo">docker run --name postgres -d -e POSTGRES_PASSWORD=password_postgres -v $(pwd):/var/lib/postgresql/data postgres</span><span id="d248" class="mk ka in mg b gy mp mm l mn mo"><strong class="mg io">Explanation</strong></span><span id="92b0" class="mk ka in mg b gy mp mm l mn mo"><strong class="mg io"><em class="mq">docker run</em></strong> is a command used when you want to start up containers based on an image</span><span id="1174" class="mk ka in mg b gy mp mm l mn mo"><strong class="mg io"><em class="mq">--name postgres</em></strong> - define container's name (it's important to make link, I will explain after). In this case, container name is "postgres". If you don't set the name, docker will use a random funny name.</span><span id="134e" class="mk ka in mg b gy mp mm l mn mo"><strong class="mg io"><em class="mq">-d</em></strong> - create container on detach mode, this is make the container run in background</span><span id="f773" class="mk ka in mg b gy mp mm l mn mo"><strong class="mg io"><em class="mq">-e POSTGRES_PASSWORD=password_postgres</em></strong> - this flag set environment variables. In this case, the POSTGRES_PASSWORD is being set to "<em class="mq">password</em><strong class="mg io"><em class="mq">_</em></strong>postgres"</span><span id="85b8" class="mk ka in mg b gy mp mm l mn mo"><strong class="mg io"><em class="mq">-v $(pwd):/var/lib/postgresql/data</em></strong> - this flag bind mount a volume. $(pwd) is a variable use to references the actual directory. So, we are binding the actual directory in our computer to a directory in /var/lib/postgresql/data inside the container. Everything that is added or removed from any of this two directories will happen in the other too. It is a important step, because without this step, our container can be closed and all data in our database be lost.</span><span id="c9c8" class="mk ka in mg b gy mp mm l mn mo"><strong class="mg io"><em class="mq">postgres</em></strong> - it's the image name.</span></pre><p id="9890" class="pw-post-body-paragraph kx ky in kz b la lw lc ld le lx lg lh li ly lk ll lm lz lo lp lq ma ls lt lu ig bi translated">它将返回容器 ID。</p><figure class="mb mc md me gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mr"><img src="../Images/ff574387dc00abd6325ed64950bee49b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8Ijqa9pgw7n5QD0WJiGcZQ.png"/></div></div></figure><p id="8326" class="pw-post-body-paragraph kx ky in kz b la lw lc ld le lx lg lh li ly lk ll lm lz lo lp lq ma ls lt lu ig bi translated">保留这个 ID，让我们进行下一步。</p><h1 id="6630" class="jz ka in bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">创建 Rails 容器</h1><p id="92b9" class="pw-post-body-paragraph kx ky in kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu ig bi translated">现在，我们需要创建我们的 rails 容器。要使用这个命令，您也需要位于一个单独的文件夹中，但是在这种情况下，该文件夹将保存您所有的 Rails 项目。</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="f310" class="mk ka in mg b gy ml mm l mn mo">docker run -it -p 3000:3000 --link postgres:db -v $(pwd):/projects rails6</span><span id="211d" class="mk ka in mg b gy mp mm l mn mo"><strong class="mg io">Explanation<br/></strong><em class="mq">I will only explain lines that I didn't explain yet.</em></span><span id="b866" class="mk ka in mg b gy mp mm l mn mo"><strong class="mg io"><em class="mq">docker run</em></strong> - already explained</span><span id="00a4" class="mk ka in mg b gy mp mm l mn mo"><strong class="mg io"><em class="mq">-it</em></strong> - flags used when you need a container that need to be interactive, in other words, it enables you to use the terminal inside container</span><span id="7588" class="mk ka in mg b gy mp mm l mn mo"><strong class="mg io"><em class="mq">-p 3000:3000</em></strong> - publish a container port to host. In this case, we are mapping the container's port 3000 to host computer's port 3000. This is, when we use port 3000 on container, the same output will be in host computer's port 3000.</span><span id="3c8d" class="mk ka in mg b gy mp mm l mn mo"><strong class="mg io"><em class="mq">--link postgres:db</em></strong> - this is the most important parameter to this post. Basically, this flag make a link between a existent container named postgres and map with a name (db) to our rails container.</span><span id="4e03" class="mk ka in mg b gy mp mm l mn mo"><strong class="mg io"><em class="mq">-v $(pwd):/projects</em></strong> - In this case, you have to separate a directory to put your projects. This is a important way to code a project in your favorite text editor. You will need to open the project in your computer to edit it. And the project need to be acessible by the container to be executed.</span><span id="ce7e" class="mk ka in mg b gy mp mm l mn mo"><strong class="mg io"><em class="mq">rails6</em></strong> - image name. In this case, I'm using the image created in the <a class="ae lv" href="https://medium.com/swlh/how-to-create-a-rails-6-image-in-docker-ubuntu-18-04-76ba23555b24" rel="noopener">last story</a>.</span></pre><p id="8e8b" class="pw-post-body-paragraph kx ky in kz b la lw lc ld le lx lg lh li ly lk ll lm lz lo lp lq ma ls lt lu ig bi translated">运行此命令，您将进入集装箱码头。</p><figure class="mb mc md me gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ms"><img src="../Images/ec45ded1bfc4055807c9f806d6244f4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*irmCt0CLq2vQ_e02Gbutlg.png"/></div></div></figure><p id="c9ac" class="pw-post-body-paragraph kx ky in kz b la lw lc ld le lx lg lh li ly lk ll lm lz lo lp lq ma ls lt lu ig bi translated">现在，你必须进入在/projects 文件夹里面的容器。</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="5c94" class="mk ka in mg b gy ml mm l mn mo">cd projects</span></pre><p id="df2a" class="pw-post-body-paragraph kx ky in kz b la lw lc ld le lx lg lh li ly lk ll lm lz lo lp lq ma ls lt lu ig bi translated">您将开始一个新的 Rails 6 项目，其中数据库配置为 postgresql。</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="9f57" class="mk ka in mg b gy ml mm l mn mo">rails new project_name --database=postgresql</span><span id="20bc" class="mk ka in mg b gy mp mm l mn mo"><em class="mq">project_name can be changed by any valid name.</em></span></pre><p id="f176" class="pw-post-body-paragraph kx ky in kz b la lw lc ld le lx lg lh li ly lk ll lm lz lo lp lq ma ls lt lu ig bi translated">Rails 将初始化您的项目。这一步可能需要一段时间。</p><figure class="mb mc md me gt jo gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/fc5da1cc5af9d1eb7cbce25dde774758.png" data-original-src="https://miro.medium.com/v2/resize:fit:970/format:webp/1*cHVYIhUHQfqrulImtQZRJA.png"/></div></figure><p id="136b" class="pw-post-body-paragraph kx ky in kz b la lw lc ld le lx lg lh li ly lk ll lm lz lo lp lq ma ls lt lu ig bi translated">你必须在你喜欢的文本编辑器中进入项目文件夹来开始数据库配置。</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="e4ae" class="mk ka in mg b gy ml mm l mn mo">cd project_name</span><span id="b515" class="mk ka in mg b gy mp mm l mn mo"><em class="mq">project_name will be the name of your project</em></span></pre><h1 id="c6ae" class="jz ka in bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">配置数据库</h1><p id="3ea1" class="pw-post-body-paragraph kx ky in kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu ig bi translated">打开 config &gt; database.yml</p><p id="e17b" class="pw-post-body-paragraph kx ky in kz b la lw lc ld le lx lg lh li ly lk ll lm lz lo lp lq ma ls lt lu ig bi translated">在<em class="mq">默认部分</em>，你会看到这样的内容:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="7c29" class="mk ka in mg b gy ml mm l mn mo">default: &amp;default<br/>  adapter: postgresql<br/>  encoding: unicode<br/>  # For details on connection pooling, see Rails configuration guide<br/>  # <a class="ae lv" href="https://guides.rubyonrails.org/configuring.html#database-pooling" rel="noopener ugc nofollow" target="_blank">https://guides.rubyonrails.org/configuring.html#database-pooling</a><br/>  pool: &lt;%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %&gt;</span></pre><p id="84af" class="pw-post-body-paragraph kx ky in kz b la lw lc ld le lx lg lh li ly lk ll lm lz lo lp lq ma ls lt lu ig bi translated">你必须添加一些信息来配置数据库:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="3600" class="mk ka in mg b gy ml mm l mn mo">default: &amp;default<br/>  adapter: postgresql<br/>  encoding: unicode<br/>  # For details on connection pooling, see Rails configuration guide<br/>  # <a class="ae lv" href="https://guides.rubyonrails.org/configuring.html#database-pooling" rel="noopener ugc nofollow" target="_blank">https://guides.rubyonrails.org/configuring.html#database-pooling</a><br/>  pool: &lt;%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %&gt;<br/>  host: db<br/>  username: postgres<br/>  password: password_postgres</span><span id="2ec9" class="mk ka in mg b gy mp mm l mn mo"><strong class="mg io">Explanation</strong></span><span id="f7bf" class="mk ka in mg b gy mp mm l mn mo"><strong class="mg io"><em class="mq">host: db</em></strong> - host is the IP for your database. But in this case, we are using "db", because docker create this name, when we use --link in container creation.</span><span id="885d" class="mk ka in mg b gy mp mm l mn mo"><strong class="mg io"><em class="mq">username: postgres</em></strong> - username is your postgres username (by default it is "postgres")</span><span id="6179" class="mk ka in mg b gy mp mm l mn mo"><strong class="mg io"><em class="mq">password: password_postgres</em></strong> - password is your postgres password (the environment variable defined on container run)</span></pre><p id="4116" class="pw-post-body-paragraph kx ky in kz b la lw lc ld le lx lg lh li ly lk ll lm lz lo lp lq ma ls lt lu ig bi translated">如果一切顺利，当您在带有“rails server -b 0.0.0.0”的容器中运行项目时。</p><p id="408d" class="pw-post-body-paragraph kx ky in kz b la lw lc ld le lx lg lh li ly lk ll lm lz lo lp lq ma ls lt lu ig bi translated"><em class="mq">使用“-b 0.0.0.0”很重要，因为这是 docker 进行端口间链接的正确 ip。</em></p><p id="3722" class="pw-post-body-paragraph kx ky in kz b la lw lc ld le lx lg lh li ly lk ll lm lz lo lp lq ma ls lt lu ig bi translated">您将看到类似这样的内容:</p><figure class="mb mc md me gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mu"><img src="../Images/60b9d0768d2eb4a61b1251fa80c0bbe3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*drTYTSBv5CKeF-blgKorXg.png"/></div></div></figure><p id="cc09" class="pw-post-body-paragraph kx ky in kz b la lw lc ld le lx lg lh li ly lk ll lm lz lo lp lq ma ls lt lu ig bi translated">这是一个预期的错误，因为我们还没有创建数据库。</p><h1 id="f074" class="jz ka in bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">创建 postgres 数据库</h1><p id="66c4" class="pw-post-body-paragraph kx ky in kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu ig bi translated">为此，我们需要在其他终端中打开 postgres 容器。</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="d140" class="mk ka in mg b gy ml mm l mn mo">docker exec -it postgres psql -U postgres --password</span></pre><p id="47c6" class="pw-post-body-paragraph kx ky in kz b la lw lc ld le lx lg lh li ly lk ll lm lz lo lp lq ma ls lt lu ig bi translated">你必须输入你的 postgres 密码，然后会打开一个 postgres 界面:</p><figure class="mb mc md me gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mv"><img src="../Images/86c9a9c09877a7af239208fce00b2028.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gK5P5rhJJjPtdonSMoMeLQ.png"/></div></div></figure><p id="f74d" class="pw-post-body-paragraph kx ky in kz b la lw lc ld le lx lg lh li ly lk ll lm lz lo lp lq ma ls lt lu ig bi translated">现在，您将创建您的开发数据库。</p><p id="7c6a" class="pw-post-body-paragraph kx ky in kz b la lw lc ld le lx lg lh li ly lk ll lm lz lo lp lq ma ls lt lu ig bi translated">这里有一个观察，你可以用任何名字创建数据库，但是如果你这样做，你需要在 database.yml 中配置它。</p><p id="9aed" class="pw-post-body-paragraph kx ky in kz b la lw lc ld le lx lg lh li ly lk ll lm lz lo lp lq ma ls lt lu ig bi translated">要创建数据库，请执行以下操作:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="a667" class="mk ka in mg b gy ml mm l mn mo">CREATE DATABASE project_name_development;</span></pre><figure class="mb mc md me gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mw"><img src="../Images/20abb3dddfc0a1679dbef83ec16b1170.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eS-lifjiXyAIdu0C7QwX4A.png"/></div></div></figure><p id="379f" class="pw-post-body-paragraph kx ky in kz b la lw lc ld le lx lg lh li ly lk ll lm lz lo lp lq ma ls lt lu ig bi translated">当您想退出 postgres 界面时，使用“\q”命令。</p><p id="a893" class="pw-post-body-paragraph kx ky in kz b la lw lc ld le lx lg lh li ly lk ll lm lz lo lp lq ma ls lt lu ig bi translated">为了简化，我使用了错误页面中的名称。</p><p id="786e" class="pw-post-body-paragraph kx ky in kz b la lw lc ld le lx lg lh li ly lk ll lm lz lo lp lq ma ls lt lu ig bi translated">现在，如果您运行项目，您将看到欢迎 Rails 6 页面。</p><figure class="mb mc md me gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mx"><img src="../Images/fc651a3821e5c5685ab0c7b60ffc6470.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IYiVUcCReWpbsbwlyeeoSQ.png"/></div></div></figure><h1 id="7e11" class="jz ka in bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">结论</h1><p id="7e13" class="pw-post-body-paragraph kx ky in kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu ig bi translated">请记住，我们只是为开发环境配置一切。要在生产环境中做到这一点，您还必须创建生产数据库。</p><p id="b505" class="pw-post-body-paragraph kx ky in kz b la lw lc ld le lx lg lh li ly lk ll lm lz lo lp lq ma ls lt lu ig bi translated">我希望这个故事对你有所帮助，我愿意澄清可能的疑问。</p><h1 id="58c7" class="jz ka in bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">参考</h1><p id="6897" class="pw-post-body-paragraph kx ky in kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu ig bi translated">图片取自<a class="ae lv" href="https://pixabay.com/pt/photos/%C3%A1rea-de-trabalho-arrumar-limpa-2325627/" rel="noopener ugc nofollow" target="_blank"> PixaBay </a></p></div></div>    
</body>
</html>