<html>
<head>
<title>Backup and Restore MySQL database (.sql) using C# .NET</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">备份和恢复 MySQL 数据库(。sql)使用 C#。网</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/backup-and-restore-mysql-database-sql-using-c-net-203c28abcda4?source=collection_archive---------3-----------------------#2021-12-29">https://blog.devgenius.io/backup-and-restore-mysql-database-sql-using-c-net-203c28abcda4?source=collection_archive---------3-----------------------#2021-12-29</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><h1 id="2f2c" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">支持</h1><p id="43b0" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">为了备份一个 MySQL 数据库，我们首先需要知道服务器上数据库的名称以及本地保存它的路径。考虑下面的方法和 appsettings.json。</p><figure class="lg lh li lj gt lk"><div class="bz fp l di"><div class="ll lm l"/></div></figure><figure class="lg lh li lj gt lk"><div class="bz fp l di"><div class="ll lm l"/></div></figure><p id="64b7" class="pw-post-body-paragraph ki kj in kk b kl ln kn ko kp lo kr ks kt lp kv kw kx lq kz la lb lr ld le lf ig bi translated">我们需要使用 mysqldump 的命令行工具来创建数据库备份。为了使用 C#实现这一点。NET 中，我们需要使用<a class="ae ls" href="https://docs.microsoft.com/en-us/dotnet/api/system.diagnostics.process?view=net-6.0" rel="noopener ugc nofollow" target="_blank">进程</a>类，并将<a class="ae ls" href="https://docs.microsoft.com/en-us/dotnet/api/system.diagnostics.processstartinfo.filename?view=net-6.0" rel="noopener ugc nofollow" target="_blank">文件名</a>设置为 appsettings.json 中设置的 MySqlDumpPath 属性</p><pre class="lg lh li lj gt lt lu lv lw aw lx bi"><span id="b1fc" class="ly jl in lu b gy lz ma l mb mc">startInfo.FileName = options.Value.MySqlDumpPath;</span></pre><p id="4ec8" class="pw-post-body-paragraph ki kj in kk b kl ln kn ko kp lo kr ks kt lp kv kw kx lq kz la lb lr ld le lf ig bi translated">我们传递默认文件，所以不需要使用-u 或-p 开关作为用户名和密码。当使用 Process 类运行进程时，不能使用&lt; and &gt;，幸运的是<a class="ae ls" href="https://dev.mysql.com/doc/refman/5.7/en/mysqldump.html" rel="noopener ugc nofollow" target="_blank"> mysqldump 支持-r 开关，我们可以使用它来代替&gt; </a>。</p><pre class="lg lh li lj gt lt lu lv lw aw lx bi"><span id="9da8" class="ly jl in lu b gy lz ma l mb mc">startInfo.Arguments = $@"--defaults-file=""{options.Value.MySqlDefaultsFilePath}"" {databaseName} -r {localDatabasePath}";</span></pre><p id="94ee" class="pw-post-body-paragraph ki kj in kk b kl ln kn ko kp lo kr ks kt lp kv kw kx lq kz la lb lr ld le lf ig bi translated">为了实现这一点，您需要确保更新您的缺省文件。在 Windows 上，my.ini 的路径如下。</p><pre class="lg lh li lj gt lt lu lv lw aw lx bi"><span id="1f4a" class="ly jl in lu b gy lz ma l mb mc">C:\ProgramData\MySQL\MySQL Server 8.0\my.ini</span></pre><p id="1b07" class="pw-post-body-paragraph ki kj in kk b kl ln kn ko kp lo kr ks kt lp kv kw kx lq kz la lb lr ld le lf ig bi translated">打开该文件，确保在[mysqldump]下放置用户名和密码以及连接时要使用的凭证。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi md"><img src="../Images/cbd1cdf37839baaf7e2c3c0f2d1aadc2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rTbQx-_i78jkHEqpQauN7A.png"/></div></div></figure><p id="af89" class="pw-post-body-paragraph ki kj in kk b kl ln kn ko kp lo kr ks kt lp kv kw kx lq kz la lb lr ld le lf ig bi translated">最终的 mysqldump 命令将如下所示。</p><pre class="lg lh li lj gt lt lu lv lw aw lx bi"><span id="fd38" class="ly jl in lu b gy lz ma l mb mc">C:\Program Files\MySQL\MySQL Server 8.0\bin\mysqldump.exe --defaults-file="C:\ProgramData\MySQL\MySQL Server 8.0\my.ini" sakila -r C:\backups\sakila.sql</span></pre><p id="7b22" class="pw-post-body-paragraph ki kj in kk b kl ln kn ko kp lo kr ks kt lp kv kw kx lq kz la lb lr ld le lf ig bi translated">之后，我们指定了一些关于进程的标志，这样它就不会创建命令窗口，也不会使用 shell execute。我们首先调用<a class="ae ls" href="https://docs.microsoft.com/en-us/dotnet/api/system.diagnostics.process.start?view=net-6.0" rel="noopener ugc nofollow" target="_blank"> Start </a>，然后调用<a class="ae ls" href="https://docs.microsoft.com/en-us/dotnet/api/system.diagnostics.process.waitforexit?view=net-6.0" rel="noopener ugc nofollow" target="_blank"> WaitForExit </a>，这样我们就不会提前终止进程，然后<a class="ae ls" href="https://docs.microsoft.com/en-us/dotnet/api/system.diagnostics.process.close?view=net-6.0" rel="noopener ugc nofollow" target="_blank">关闭</a>进程。</p><pre class="lg lh li lj gt lt lu lv lw aw lx bi"><span id="600c" class="ly jl in lu b gy lz ma l mb mc">startInfo.CreateNoWindow = true;</span><span id="db17" class="ly jl in lu b gy mk ma l mb mc">startInfo.UseShellExecute = false;</span><span id="a068" class="ly jl in lu b gy mk ma l mb mc">process.StartInfo = startInfo;</span><span id="a98e" class="ly jl in lu b gy mk ma l mb mc">process.Start();</span><span id="a460" class="ly jl in lu b gy mk ma l mb mc">process.WaitForExit();</span><span id="3dd2" class="ly jl in lu b gy mk ma l mb mc">process.Close();</span></pre><p id="2e46" class="pw-post-body-paragraph ki kj in kk b kl ln kn ko kp lo kr ks kt lp kv kw kx lq kz la lb lr ld le lf ig bi translated">它将在 localDatabasePath 中指定的位置创建一个. sql 文件。</p><h1 id="0131" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">恢复</h1><p id="61f1" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">为了恢复一个 MySQL 数据库，我们需要服务器上数据库的名称和我们要恢复的数据库的本地路径。考虑下面的方法，使用与上面相同的 appsettings.json。</p><figure class="lg lh li lj gt lk"><div class="bz fp l di"><div class="ll lm l"/></div></figure><p id="8d56" class="pw-post-body-paragraph ki kj in kk b kl ln kn ko kp lo kr ks kt lp kv kw kx lq kz la lb lr ld le lf ig bi translated">这个方法遇到了上面关于在流程参数中使用</p><p id="523d" class="pw-post-body-paragraph ki kj in kk b kl ln kn ko kp lo kr ks kt lp kv kw kx lq kz la lb lr ld le lf ig bi translated">首先，我们将进程的文件名设置为。bat 文件' mysql-restore.bat '。</p><p id="dbf0" class="pw-post-body-paragraph ki kj in kk b kl ln kn ko kp lo kr ks kt lp kv kw kx lq kz la lb lr ld le lf ig bi translated">在文件内部，我们需要使用变量，所以我们的命令看起来像这样。</p><figure class="lg lh li lj gt lk"><div class="bz fp l di"><div class="ll lm l"/></div></figure><p id="9bed" class="pw-post-body-paragraph ki kj in kk b kl ln kn ko kp lo kr ks kt lp kv kw kx lq kz la lb lr ld le lf ig bi translated">出于上述同样的原因，这里我们可以省略-u 和-p 标志。确保用您的用户和密码更新您的默认文件<a class="ae ls" href="https://dev.mysql.com/doc/refman/8.0/en/option-files.html" rel="noopener ugc nofollow" target="_blank">【MySQL】组</a>。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div class="gh gi ml"><img src="../Images/976b2641ae3da9abf628ce0481e7f8f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1110/format:webp/1*EqlfhjuMWG4A9KxadXhLVw.png"/></div></figure><p id="d717" class="pw-post-body-paragraph ki kj in kk b kl ln kn ko kp lo kr ks kt lp kv kw kx lq kz la lb lr ld le lf ig bi translated">第一个和第三个参数应该加引号来处理包含空格的路径，第二个参数是数据库的名称，不应该加引号。</p><pre class="lg lh li lj gt lt lu lv lw aw lx bi"><span id="4815" class="ly jl in lu b gy lz ma l mb mc">startInfo.Arguments = $@"""{options.Value.MySqlDefaultsFilePath}"" {databaseName} ""{localDatabasePath}""";</span></pre><p id="2de0" class="pw-post-body-paragraph ki kj in kk b kl ln kn ko kp lo kr ks kt lp kv kw kx lq kz la lb lr ld le lf ig bi translated">最终的恢复命令如下所示。</p><pre class="lg lh li lj gt lt lu lv lw aw lx bi"><span id="7f60" class="ly jl in lu b gy lz ma l mb mc">mysql --defaults-file="C:\ProgramData\MySQL\MySQL Server 8.0\my.ini" sakila &lt; "C:\backups\sakila.sql"</span></pre><p id="e1fb" class="pw-post-body-paragraph ki kj in kk b kl ln kn ko kp lo kr ks kt lp kv kw kx lq kz la lb lr ld le lf ig bi translated">之后，我们运行与上面相同的方法来启动并等待进程退出。</p><pre class="lg lh li lj gt lt lu lv lw aw lx bi"><span id="124f" class="ly jl in lu b gy lz ma l mb mc">startInfo.CreateNoWindow = true;</span><span id="6561" class="ly jl in lu b gy mk ma l mb mc">startInfo.UseShellExecute = false;</span><span id="fc6b" class="ly jl in lu b gy mk ma l mb mc">process.StartInfo = startInfo;</span><span id="5fd2" class="ly jl in lu b gy mk ma l mb mc">process.Start();</span><span id="e42d" class="ly jl in lu b gy mk ma l mb mc">process.WaitForExit();</span><span id="424d" class="ly jl in lu b gy mk ma l mb mc">process.Close();</span></pre><p id="bd13" class="pw-post-body-paragraph ki kj in kk b kl ln kn ko kp lo kr ks kt lp kv kw kx lq kz la lb lr ld le lf ig bi translated">一旦命令运行完毕，数据库将在服务器上恢复。</p><h1 id="933a" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">GitHub 知识库</h1><p id="f97e" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">要查看整个项目，请查看 GitHub 资源库。</p><p id="cd5d" class="pw-post-body-paragraph ki kj in kk b kl ln kn ko kp lo kr ks kt lp kv kw kx lq kz la lb lr ld le lf ig bi translated">https://github.com/joemoceri/database-toolkit<a class="ae ls" href="https://github.com/joemoceri/database-toolkit" rel="noopener ugc nofollow" target="_blank"/></p></div></div>    
</body>
</html>