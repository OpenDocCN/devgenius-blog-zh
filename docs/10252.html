<html>
<head>
<title>GCP | How can you enrich your Google Analytics data?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GCP |你如何丰富你的谷歌分析数据？</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/gcp-how-can-you-enrich-your-google-analytics-data-4c761453a3e?source=collection_archive---------11-----------------------#2022-10-18">https://blog.devgenius.io/gcp-how-can-you-enrich-your-google-analytics-data-4c761453a3e?source=collection_archive---------11-----------------------#2022-10-18</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="9fc8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">谷歌分析本身就很棒，但如果有第一方的数据，它会变得更加强大。</p><p id="0bf9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">营销人员使用谷歌分析，因为它提供了对网站流量，转换率和许多其他指标的综合分析。然而，提供更多基于预测模型的用户级第一方数据使事情变得更有洞察力。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/b8cb86332897488ebae2e6c342d433da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4CFo3yCFeOJxMHIAMgpwNQ.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">米利安·耶西耶在<a class="ae ky" href="https://unsplash.com/collections/SfbsdAzEzLw/google-ads%2Fanalytics%2F-ppc?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><h1 id="6c25" class="kz la in bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">该过程</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lx"><img src="../Images/42efe1f671238b40019ebd8ca89ba095.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WAV9pmgOgBTSo2p0x40SJw.png"/></div></div></figure><p id="9275" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">本文描述了提取 BigQuery 中的数据并将其存储在云存储桶中的日常过程。该数据是 ML 模型预测或上游应用的结果。</p><p id="347a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">每次将文件放入存储桶时，都会触发云功能。然后，在对 GA 进行 API 调用之前，它从数据存储中收集文件的属性。API 调用创建一个与 GA 的认证会话来上传文件。</p><h1 id="7bb2" class="kz la in bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">技术性</h1><p id="c7a7" class="pw-post-body-paragraph jk jl in jm b jn ly jp jq jr lz jt ju jv ma jx jy jz mb kb kc kd mc kf kg kh ig bi translated">让我们深入技术细节。</p><h2 id="bdd8" class="md la in bd lb me mf dn lf mg mh dp lj jv mi mj ln jz mk ml lr kd mm mn lv mo bi translated">BigQuery</h2><p id="fac6" class="pw-post-body-paragraph jk jl in jm b jn ly jp jq jr lz jt ju jv ma jx jy jz mb kb kc kd mc kf kg kh ig bi translated">由于您要将数据上传到 GA 中的定制维度，因此数据需要包含定制维度的名称作为列中的标题。这里的问题是自定义维度名称包含一个冒号，这是 BigQuery 中不允许的列名(例如“ga:dimension99”)。</p><p id="69c1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">有一种方法可以解决这个问题:</p><p id="937d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">更新特定表中的数据，将列名作为表中的第一条记录，或者创建一个包含该记录的单独视图。实现这一点的查询包括添加一个附加列，该列为具有列标题的记录分配一个比其他所有记录都小的序列号，并相应地进行排序。</p><pre class="kj kk kl km gt mp mq mr ms aw mt bi"><span id="6684" class="md la in mq b gy mu mv l mw mx">SELECT column1, column2 # do not include seq_no in final output<br/>FROM (<br/> # add a record with column names<br/> SELECT 'ga:dimension999' as column1, 'ga:dimension998' as column2, 1 as seq_no<br/> UNION ALL<br/> SELECT column1, column2, 2 as seq_no<br/> FROM `{projectid},{datasetid}.{tableid}`<br/>)<br/># this will place the column names as the first record<br/>ORDER BY seq_no ASC</span></pre><p id="b9c1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">此外，将 DAG 代码中的 print_header 参数(使用提供的数据创建文件)设置为<strong class="jm io"> false </strong>将确保 BigQuery 中的实际列名不会打印出来，将输出结果中的第一条记录作为列标题。</p><h2 id="8e0c" class="md la in bd lb me mf dn lf mg mh dp lj jv mi mj ln jz mk ml lr kd mm mn lv mo bi translated">阿帕奇气流</h2><p id="07c7" class="pw-post-body-paragraph jk jl in jm b jn ly jp jq jr lz jt ju jv ma jx jy jz mb kb kc kd mc kf kg kh ig bi translated">谷歌的 Cloud Composer 运行在 Apache Airflow 上。这允许您使用直接非循环图(DAG)来构建和监控管道。这里描述的 DAG 很简单，每个节点从不同的 BigQuery 表中提取不同的模型预测结果，然后一个接一个地运行。</p><p id="aff2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">创建 DAG 非常简单，只需将 python 脚本放入 DAGs 文件夹中，然后检查 Airflow UI 以查看其构造是否正确。</p><p id="427d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">所描述的 DAG 结构:</p><pre class="kj kk kl km gt mp mq mr ms aw mt bi"><span id="1952" class="md la in mq b gy mu mv l mw mx">with models.DAG(<br/>  #Name of DAG<br/>  "&lt;name_of_your_dag&gt;",<br/>  schedule_interval="&lt;frequency&gt;",<br/>  default_args=default_dag_args,<br/>) as dag:<br/>  start = DummyOperator(task_id="start_node", dag=dag)<br/>  name_of_node1 = python_operator.PythonOperator(<br/>     task_id="&lt;name_of_node&gt;",<br/>     python_callable=&lt;function_to_call&gt;,<br/> )<br/> name_of_node2 = python_operator.PythonOperator(<br/>     task_id="&lt;name_of_node&gt;",<br/>     python_callable=&lt;function_to_call&gt;,<br/> )<br/> end = DummyOperator(task_id="end_node", dag=dag)<br/> (<br/>    &gt;&gt; start<br/>    &gt;&gt; name_of_node_1<br/>    &gt;&gt; name_of_node_2<br/>    &gt;&gt; end<br/> )</span></pre><p id="09cf" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">Frequency 被格式化为一个 cron 调度表达式(这个<a class="ae ky" href="https://crontab.guru/" rel="noopener ugc nofollow" target="_blank">链接</a>可能会对您有所帮助), default_dag_args 包含以下详细信息:</p><pre class="kj kk kl km gt mp mq mr ms aw mt bi"><span id="7712" class="md la in mq b gy mu mv l mw mx">default_dag_args = {<br/>   "owner": "&lt;organisation_maybe&gt;",<br/>   "start_date": &lt;&gt;,<br/>   "email": ["&lt;your_email&gt;"],<br/>   "email_on_failure": True,<br/>   "retries": &lt;integer&gt;,<br/>   "retry_delay": &lt;integer&gt;,<br/>   "catchup": False,<br/>}</span></pre><p id="b1a6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">每个“function_to_call”都包含用于从 BigQuery 中提取数据的查询以及需要放入存储中的文件的名称。然后将这些作为参数传递给一个助手函数，该函数获取数据，将其写入一个 CSV 文件，并将该文件放入存储中。这是通过 BigQuery API 完成的。</p><pre class="kj kk kl km gt mp mq mr ms aw mt bi"><span id="2890" class="md la in mq b gy mu mv l mw mx">extract_job = client.extract_table(<br/>  query_job.destination,<br/>  destination_url,<br/>  location=LOCATION,<br/>  job_config=ExtractJobConfig(<br/>     destination_format="CSV",<br/>     field_felimiter=",",<br/>     print_header=False,<br/>  ),<br/>)<br/>print(f"Started extract job: {extract_job.job_id}")</span><span id="8507" class="md la in mq b gy my mv l mw mx">res = extract_job.result()</span></pre><p id="fcf6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">上面的代码片段使用了 BigQuery 客户端(例如，client = bigquery。Client()来自 google.cloud 库)。query_job.destination 是使用 client.query( <your_query>)提取数据并将结果分配给名为 query_job 的变量的结果，destination uri 是存储桶的位置，格式为“GS://{ BUCKET _ NAME }/{ GA _ ARTICLE _ FOLDER }/{ FILE _ NAME }”，location 是存储桶或项目所在的区域。</your_query></p><h2 id="b5bc" class="md la in bd lb me mf dn lf mg mh dp lj jv mi mj ln jz mk ml lr kd mm mn lv mo bi translated">数据存储</h2><p id="c6b1" class="pw-post-body-paragraph jk jl in jm b jn ly jp jq jr lz jt ju jv ma jx jy jz mb kb kc kd mc kf kg kh ig bi translated">在这里，文件的属性可以存储在相同的“种类”下，并适当地命名。其中一个主要属性包括 file_name_regex，云函数将查询该属性，并查看它是否与存储中丢弃的文件相匹配。如果匹配，它将检索 GA 上传所需的附加属性，包括 account_id、custom_data_source_id 和 webpropertyid。</p><p id="a6cb" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这部分是完全可选的。您可以将这些属性存储在其他地方。</p><h2 id="5754" class="md la in bd lb me mf dn lf mg mh dp lj jv mi mj ln jz mk ml lr kd mm mn lv mo bi translated">云函数</h2><p id="c1b3" class="pw-post-body-paragraph jk jl in jm b jn ly jp jq jr lz jt ju jv ma jx jy jz mb kb kc kd mc kf kg kh ig bi translated">一旦文件丢失，就会触发事件驱动的云功能。您可以通过在部署脚本中指定以下标志来设置这种类型的事件触发器:</p><blockquote class="mz na nb"><p id="b4a2" class="jk jl nc jm b jn jo jp jq jr js jt ju nd jw jx jy ne ka kb kc nf ke kf kg kh ig bi translated">—trigger-event = " Google . storage . object . finalize "</p><p id="36c2" class="jk jl nc jm b jn jo jp jq jr js jt ju nd jw jx jy ne ka kb kc nf ke kf kg kh ig bi translated">— trigger-resource=" <name_of_storage_bucket>"</name_of_storage_bucket></p></blockquote><p id="99b1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">谷歌分析应用编程接口:</p><p id="b0d1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在进行任何上传之前，您需要启用 API 并生成一个 client_secrets.json 文件。该文件包含身份验证所需的私钥/公钥对。此处更详细地描述了<a class="ae ky" href="https://developers.google.com/analytics/devguides/reporting/core/v4/quickstart/service-py" rel="noopener ugc nofollow" target="_blank">的过程。将此文件保存在云存储桶中，您可以使用云存储 URI 找到它。一旦保存了这个文件，就按照下面的步骤(在前面的链接中也有描述)来创建一个服务对象，这是进一步使用 API 所需要的。</a></p><pre class="kj kk kl km gt mp mq mr ms aw mt bi"><span id="e40f" class="md la in mq b gy mu mv l mw mx">credentials = ServiceAccountCredentials.from_json_keyfile_name(<br/>      &lt;client_secrets.json file location&gt;, &lt;[SCOPES]&gt;)<br/><br/>  # Build the service object.<br/>  analytics = build('analyticsreporting', 'v4', credentials=credentials)<br/><br/>  return analytics</span></pre><p id="ffa4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这里的范围是指作业所需的访问级别，即只读、只写、编辑等。对于这项工作，需要的是简单的访问和编辑:</p><pre class="kj kk kl km gt mp mq mr ms aw mt bi"><span id="daa2" class="md la in mq b gy mu mv l mw mx">SCOPES = ["https://www.googleapis.com/auth/analytics",    "https://www.googleapis.com/auth/analytics.edit"]</span></pre><p id="72f8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在你可以上传了。这可以如下所示完成，其中“文件名”是包含需要上传到 GA360 的数据的 GCS 文件的路径。进一步的细节可以在谷歌分析文档<a class="ae ky" href="https://developers.google.com/analytics/devguides/config/mgmt/v3/mgmtReference/management/uploads/uploadData" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><pre class="kj kk kl km gt mp mq mr ms aw mt bi"><span id="a8f7" class="md la in mq b gy mu mv l mw mx">media = MediaFileUpload(filename, mimetype="application/octet-stream", resumable=False)</span><span id="31fe" class="md la in mq b gy my mv l mw mx">daily_upload = (<br/>    analytics.management().uploads()<br/>    .uploadData(<br/>       accountId=account_id,<br/>       webPropertyId=webpropertyid,<br/>       customDataSourceId=custom_datasource_id,<br/>       media_body=media,<br/>  )<br/>.execute()<br/>)</span></pre></div></div>    
</body>
</html>