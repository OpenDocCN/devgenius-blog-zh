<html>
<head>
<title>Cool BigQuery Features Using Standard SQL Syntax</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用标准 SQL 语法的超酷 BigQuery 特性</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/cool-bigquery-features-using-standard-sql-syntax-e7a47ef9b72e?source=collection_archive---------3-----------------------#2022-03-02">https://blog.devgenius.io/cool-bigquery-features-using-standard-sql-syntax-e7a47ef9b72e?source=collection_archive---------3-----------------------#2022-03-02</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="452b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">BigQuery 中有几个很酷的特性，我们可以通过标准的 SQL 语法来使用，即使是最频繁的用户也常常不知道。本文件旨在展示其中一些，而不是详尽无遗的工作。</p><p id="826b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">下面的主题没有逻辑顺序，只是收集了一些我感兴趣的特性/功能。</p><p id="fa88" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">以下内容不必按顺序阅读，只是一种目录。</p><p id="9bae" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">源代码可从:<a class="ae ki" href="https://github.com/brbep/bigquery-cool-features-standard-sql" rel="noopener ugc nofollow" target="_blank">https://github . com/brbep/big query-cool-features-standard-SQL</a>获得。</p><h2 id="70e1" class="kj kk in bd kl km kn dn ko kp kq dp kr jv ks kt ku jz kv kw kx kd ky kz la lb bi translated"><strong class="ak">开始前的假设</strong></h2><ul class=""><li id="626f" class="lc ld in jm b jn le jr lf jv lg jz lh kd li kh lj lk ll lm bi translated">你需要有一个谷歌云帐户。如果没有，可以从<a class="ae ki" href="https://cloud.google.com/free" rel="noopener ugc nofollow" target="_blank">的<strong class="jm io">这里</strong>的</a>创建。点击右上角的<strong class="jm io">免费开始</strong>按钮。</li><li id="9ee4" class="lc ld in jm b jn ln jr lo jv lp jz lq kd lr kh lj lk ll lm bi translated">例如，您需要一个 Bigquery 项目(参见<a class="ae ki" href="https://cloud.google.com/resource-manager/docs/creating-managing-projects" rel="noopener ugc nofollow" target="_blank"> <strong class="jm io">文档</strong> </a>)以及编辑表格和访问数据的权限。</li></ul><h2 id="22e7" class="kj kk in bd kl km kn dn ko kp kq dp kr jv ks kt ku jz kv kw kx kd ky kz la lb bi translated"><strong class="ak">参考文献</strong></h2><ul class=""><li id="a922" class="lc ld in jm b jn le jr lf jv lg jz lh kd li kh lj lk ll lm bi translated"><a class="ae ki" href="https://cloud.google.com/bigquery/docs" rel="noopener ugc nofollow" target="_blank"> Bigquery 文档</a></li><li id="0836" class="lc ld in jm b jn ln jr lo jv lp jz lq kd lr kh lj lk ll lm bi translated"><a class="ae ki" href="https://cloud.google.com/blog/topics/developers-practitioners/bigquery-admin-reference-guide-recap" rel="noopener ugc nofollow" target="_blank"> BigQuery 管理参考指南</a></li><li id="4ca1" class="lc ld in jm b jn ln jr lo jv lp jz lq kd lr kh lj lk ll lm bi translated"><a class="ae ki" href="https://cloud.google.com/blog/products/data-analytics/top-25-google-search-terms-now-in-bigquery" rel="noopener ugc nofollow" target="_blank">前 25 个谷歌搜索词，现在在 BigQuery </a></li><li id="2f0e" class="lc ld in jm b jn ln jr lo jv lp jz lq kd lr kh lj lk ll lm bi translated"><a class="ae ki" href="https://cloud.google.com/bigquery/docs/release-notes" rel="noopener ugc nofollow" target="_blank"> BigQuery 发布说明</a></li></ul></div><div class="ab cl ls lt hr lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ig ih ii ij ik"><h1 id="72de" class="lz kk in bd kl ma mb mc ko md me mf kr mg mh mi ku mj mk ml kx mm mn mo la mp bi translated"><strong class="ak">目录</strong></h1><ol class=""><li id="827c" class="lc ld in jm b jn le jr lf jv lg jz lh kd li kh mq lk ll lm bi translated"><a class="ae ki" href="https://medium.com/p/e7a47ef9b72e#b094" rel="noopener">删除重复数据</a></li><li id="3e27" class="lc ld in jm b jn ln jr lo jv lp jz lq kd lr kh mq lk ll lm bi translated"><a class="ae ki" href="https://medium.com/p/e7a47ef9b72e#7df2" rel="noopener">在一列或整个表格中搜索字符串</a></li><li id="8641" class="lc ld in jm b jn ln jr lo jv lp jz lq kd lr kh mq lk ll lm bi translated"><a class="ae ki" href="https://medium.com/p/e7a47ef9b72e#a759" rel="noopener">从日期表达式</a>中返回最后一天</li><li id="630c" class="lc ld in jm b jn ln jr lo jv lp jz lq kd lr kh mq lk ll lm bi translated"><a class="ae ki" href="https://medium.com/p/e7a47ef9b72e#638d" rel="noopener">通过 SQL 实现安全</a></li><li id="efb3" class="lc ld in jm b jn ln jr lo jv lp jz lq kd lr kh mq lk ll lm bi translated"><a class="ae ki" href="https://medium.com/p/e7a47ef9b72e#7f61" rel="noopener">重命名表</a></li><li id="820b" class="lc ld in jm b jn ln jr lo jv lp jz lq kd lr kh mq lk ll lm bi translated"><a class="ae ki" href="https://medium.com/p/e7a47ef9b72e#b7b3" rel="noopener">访问历史数据</a></li><li id="d38e" class="lc ld in jm b jn ln jr lo jv lp jz lq kd lr kh mq lk ll lm bi translated"><a class="ae ki" href="https://medium.com/p/e7a47ef9b72e#1f8e" rel="noopener">脚本和存储过程</a></li><li id="fb10" class="lc ld in jm b jn ln jr lo jv lp jz lq kd lr kh mq lk ll lm bi translated"><a class="ae ki" href="https://medium.com/p/e7a47ef9b72e#e567" rel="noopener">多对帐单交易</a></li><li id="8baa" class="lc ld in jm b jn ln jr lo jv lp jz lq kd lr kh mq lk ll lm bi translated"><a class="ae ki" href="https://medium.com/p/e7a47ef9b72e#b090" rel="noopener">动态 SQL </a></li><li id="022d" class="lc ld in jm b jn ln jr lo jv lp jz lq kd lr kh mq lk ll lm bi translated"><a class="ae ki" href="https://medium.com/p/e7a47ef9b72e#987a" rel="noopener">根据列值生成行 ID</a></li><li id="e4ff" class="lc ld in jm b jn ln jr lo jv lp jz lq kd lr kh mq lk ll lm bi translated"><a class="ae ki" href="https://medium.com/p/e7a47ef9b72e#a9c2" rel="noopener">调试报表</a></li><li id="f0d2" class="lc ld in jm b jn ln jr lo jv lp jz lq kd lr kh mq lk ll lm bi translated"><a class="ae ki" href="https://medium.com/p/e7a47ef9b72e#acfa" rel="noopener">创建外部表格</a></li><li id="34b8" class="lc ld in jm b jn ln jr lo jv lp jz lq kd lr kh mq lk ll lm bi translated"><a class="ae ki" href="https://medium.com/p/e7a47ef9b72e#30f7" rel="noopener">导出数据</a></li><li id="f72a" class="lc ld in jm b jn ln jr lo jv lp jz lq kd lr kh mq lk ll lm bi translated"><a class="ae ki" href="https://medium.com/p/e7a47ef9b72e#efd0" rel="noopener">创建和执行 ML 模型</a></li><li id="7e92" class="lc ld in jm b jn ln jr lo jv lp jz lq kd lr kh mq lk ll lm bi translated"><a class="ae ki" href="https://medium.com/p/e7a47ef9b72e#3f28" rel="noopener">分析和可视化地理空间数据</a></li></ol></div><div class="ab cl ls lt hr lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ig ih ii ij ik"><h1 id="b094" class="lz kk in bd kl ma mb mc ko md me mf kr mg mh mi ku mj mk ml kx mm mn mo la mp bi translated">1.删除重复数据</h1><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="0cb8" class="kj kk in mw b gy na nb l nc nd"># Data Source<br/>WITH produce AS<br/> (SELECT 'kale' as item, 23 as purchases, 'vegetable' as category, CURRENT_TIMESTAMP()-MAKE_INTERVAL(minute =&gt; 2) AS updated_timestamp<br/>  UNION ALL SELECT 'kale' as item, 23 as purchases, 'vegetable' as category, CURRENT_TIMESTAMP()-MAKE_INTERVAL(second =&gt; 63) AS updated_timestamp<br/>  UNION ALL SELECT 'kale' as item, 23 as purchases, 'vegetable' as category, CURRENT_TIMESTAMP()-MAKE_INTERVAL(second =&gt; 75) AS updated_timestamp<br/>  UNION ALL SELECT 'orange', 2, 'fruit', CURRENT_TIMESTAMP()-MAKE_INTERVAL(second =&gt; 72) AS updated_timestamp<br/>  UNION ALL SELECT 'cabbage', 9, 'vegetable', CURRENT_TIMESTAMP()-MAKE_INTERVAL(hour =&gt; 7) AS updated_timestamp<br/>  UNION ALL SELECT 'apple', 8, 'fruit', CURRENT_TIMESTAMP()-MAKE_INTERVAL(second =&gt; 33) AS updated_timestamp<br/>  UNION ALL SELECT 'leek', 2, 'vegetable', CURRENT_TIMESTAMP()-MAKE_INTERVAL(second =&gt; 157) AS updated_timestamp<br/>  UNION ALL SELECT 'lettuce', 10, 'vegetable', CURRENT_TIMESTAMP()-MAKE_INTERVAL(hour =&gt; 1000) AS updated_timestamp),</span><span id="a120" class="kj kk in mw b gy ne nb l nc nd"># Deduplication Options</span><span id="a863" class="kj kk in mw b gy ne nb l nc nd"># By ROW_NUMBER<br/>dedup_by_rownumber AS (<br/>  SELECT * EXCEPT(rnumber)<br/>  FROM (<br/>    SELECT<br/>      *,<br/>      ROW_NUMBER() OVER (PARTITION BY item ORDER BY updated_timestamp DESC) AS rnumber<br/>    FROM produce )<br/>  WHERE rnumber = 1<br/>),</span><span id="a043" class="kj kk in mw b gy ne nb l nc nd"># By QUALIFY<br/>dedup_by_qualify AS (<br/>  SELECT *<br/>  FROM produce<br/>  WHERE true<br/>  QUALIFY ROW_NUMBER() OVER (PARTITION BY item ORDER BY updated_timestamp DESC) = 1<br/>),</span><span id="2776" class="kj kk in mw b gy ne nb l nc nd"># By ARRAY_AGG<br/>dedup_by_arrayagg AS (<br/>  SELECT event.*<br/>  FROM (<br/>    SELECT <br/>      ARRAY_AGG(pd ORDER BY pd.updated_timestamp DESC LIMIT 1)[OFFSET(0)] AS event<br/>    FROM produce AS pd<br/>    GROUP BY pd.item)<br/>)</span><span id="d2e3" class="kj kk in mw b gy ne nb l nc nd">SELECT *, 'ROW_NUMBER' AS dedup_by FROM dedup_by_rownumber<br/>UNION ALL SELECT *, 'QUALIFY' FROM dedup_by_qualify<br/>UNION ALL SELECT *, 'ARRAY_AGG' FROM dedup_by_arrayagg</span></pre><p id="53f5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">提示</strong></p><ul class=""><li id="b9f0" class="lc ld in jm b jn jo jr js jv nf jz ng kd nh kh lj lk ll lm bi translated"><code class="fe ni nj nk mw b">QUALIFY</code>子句过滤分析函数的结果。</li><li id="7046" class="lc ld in jm b jn ln jr lo jv lp jz lq kd lr kh lj lk ll lm bi translated"><strong class="jm io">第一条或最后一条记录</strong>:当试图计算数据子集中的第一条或最后一条记录时，如果单个分区中的<code class="fe ni nj nk mw b">ORDER BY</code>元素太多，使用<code class="fe ni nj nk mw b">ROW_NUMBER()</code>函数可能会失败，并出现资源超出错误。取而代之的是，尝试使用<code class="fe ni nj nk mw b">ARRAY_AGG()</code>——这样运行起来更有效率，因为<code class="fe ni nj nk mw b">ORDER BY</code>被允许在每个<code class="fe ni nj nk mw b">GROUP BY</code>上丢弃除顶部记录之外的所有内容。</li></ul><p id="3dc1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">文档:</strong><a class="ae ki" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/functions-and-operators#make_interval" rel="noopener ugc nofollow" target="_blank">MAKE _ INTERVAL</a>；<a class="ae ki" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/functions-and-operators#row_number" rel="noopener ugc nofollow" target="_blank">排 _ 号</a>；<a class="ae ki" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/query-syntax#qualify_clause" rel="noopener ugc nofollow" target="_blank">晋级</a>；<a class="ae ki" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/functions-and-operators#array_agg" rel="noopener ugc nofollow" target="_blank">数组 _ 聚集</a></p><h1 id="7df2" class="lz kk in bd kl ma nl mc ko md nm mf kr mg nn mi ku mj no ml kx mm np mo la mp bi translated">2.在列或整个表格中搜索字符串</h1><p id="60a7" class="pw-post-body-paragraph jk jl in jm b jn le jp jq jr lf jt ju jv nq jx jy jz nr kb kc kd ns kf kg kh ig bi translated">执行规范化的、不区分大小写的搜索，以查看某个值是否存在于表达式中。如果值存在，则返回<code class="fe ni nj nk mw b">TRUE</code>，否则返回<code class="fe ni nj nk mw b">FALSE</code>。</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="8cc9" class="kj kk in mw b gy na nb l nc nd">DECLARE search_value STRING DEFAULT 'toast';</span><span id="3415" class="kj kk in mw b gy ne nb l nc nd">WITH recipes AS<br/> (SELECT 'Blueberry pancakes' as breakfast, 'Egg salad sandwich' as lunch, 'Potato dumplings' as dinner UNION ALL<br/>  SELECT 'Potato pancakes', 'Toasted cheese sandwich', 'Beef stroganoff' UNION ALL<br/>  SELECT 'Ham scramble', 'Steak avocado salad', 'Tomato pasta' UNION ALL<br/>  SELECT 'Avocado toast', 'Tomato soup', 'Blueberry salmon' UNION ALL<br/>  SELECT 'Corned beef hash', 'Lentil potato soup', 'Glazed ham')<br/>  <br/>SELECT <br/>  *,<br/>  CONTAINS_SUBSTR(breakfast, search_value) AS breakfast_result<br/>FROM recipes <br/>WHERE CONTAINS_SUBSTR(recipes, search_value);</span></pre><p id="f2a0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">文档:</strong> <a class="ae ki" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/functions-and-operators#contains_substr" rel="noopener ugc nofollow" target="_blank">包含 _SUBSTR </a></p><h1 id="a759" class="lz kk in bd kl ma nl mc ko md nm mf kr mg nn mi ku mj no ml kx mm np mo la mp bi translated">3.从日期表达式中返回最后一天</h1><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="067b" class="kj kk in mw b gy na nb l nc nd">--DATE PART: YEAR, QUARTER, MONTH, WEEK, WEEK(SUNDAY, MONDAY etc.), ISOWEEK, ISOYEAR<br/>SELECT LAST_DAY(DATE '2021-02-25', MONTH) AS last_day;</span></pre><p id="d069" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">文档:</strong> <a class="ae ki" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/functions-and-operators#last_day" rel="noopener ugc nofollow" target="_blank">最后 _ 天</a></p><h1 id="638d" class="lz kk in bd kl ma nl mc ko md nm mf kr mg nn mi ku mj no ml kx mm np mo la mp bi translated">4.通过 SQL 保护</h1><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="7921" class="kj kk in mw b gy na nb l nc nd">GRANT `roles/bigquery.dataViewer` ON TABLE my_project.my_dataset.my_table<br/>TO "user:<a class="ae ki" href="mailto:tom@example.com" rel="noopener ugc nofollow" target="_blank">tom@example.com</a>", "user:<a class="ae ki" href="mailto:sara@example.com" rel="noopener ugc nofollow" target="_blank">sara@example.com</a>";</span><span id="26ea" class="kj kk in mw b gy ne nb l nc nd">REVOKE `roles/bigquery.admin` ON SCHEMA my_project.my_dataset<br/>FROM "group:<a class="ae ki" href="mailto:example-team@example.com" rel="noopener ugc nofollow" target="_blank">example-team@example.com</a>", "serviceAccount:<a class="ae ki" href="mailto:user@test-project.iam.gserviceaccount.com" rel="noopener ugc nofollow" target="_blank">user@test-project.iam.gserviceaccount.com</a>"</span></pre><p id="c80b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">文档:</strong> <a class="ae ki" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/data-control-language" rel="noopener ugc nofollow" target="_blank">标准 SQL 中的数据控制语言语句</a></p><h1 id="7f61" class="lz kk in bd kl ma nl mc ko md nm mf kr mg nn mi ku mj no ml kx mm np mo la mp bi translated">5.重命名表格</h1><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="da4e" class="kj kk in mw b gy na nb l nc nd">ALTER TABLE my_project.my_dataset.my_table RENAME TO new_table_name</span></pre><p id="bee7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">文档:</strong> <a class="ae ki" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/data-definition-language?hl=en#alter_table_rename_to_statement" rel="noopener ugc nofollow" target="_blank">将表重命名为语句</a></p><h1 id="b7b3" class="lz kk in bd kl ma nl mc ko md nm mf kr mg nn mi ku mj no ml kx mm np mo la mp bi translated">6.访问历史数据</h1><p id="1155" class="pw-post-body-paragraph jk jl in jm b jn le jp jq jr lf jt ju jv nq jx jy jz nr kb kc kd ns kf kg kh ig bi translated">使用<code class="fe ni nj nk mw b">time travel</code>您可以从最近<strong class="jm io">七天</strong>内的任何点访问数据。这个特性是由 Google 提供和管理的，你不需要做任何事情来获得它，只需要运行一个 SQL 查询来访问历史数据。</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="9db1" class="kj kk in mw b gy na nb l nc nd">SELECT *<br/>FROM `my_project.my_dataset.my_table`<br/>FOR SYSTEM_TIME AS OF TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 30 SECOND);</span></pre><p id="5fbd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">文档:</strong> <a class="ae ki" href="https://cloud.google.com/bigquery/docs/time-travel" rel="noopener ugc nofollow" target="_blank">时间旅行</a></p><h1 id="1f8e" class="lz kk in bd kl ma nl mc ko md nm mf kr mg nn mi ku mj no ml kx mm np mo la mp bi translated">7.脚本和存储过程</h1><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="d3ec" class="kj kk in mw b gy na nb l nc nd">CREATE OR REPLACE TABLE my_project.my_dataset.my_table (customer_id STRING);</span></pre><ul class=""><li id="ed4c" class="lc ld in jm b jn jo jr js jv nf jz ng kd nh kh lj lk ll lm bi translated">设置变量，运行 INSERT 语句，并将结果显示为格式化的文本字符串:</li></ul><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="5426" class="kj kk in mw b gy na nb l nc nd">DECLARE id STRING;<br/>SET id = GENERATE_UUID();</span><span id="9549" class="kj kk in mw b gy ne nb l nc nd">INSERT INTO my_project.my_dataset.my_table (customer_id)<br/>   VALUES(id);</span><span id="a648" class="kj kk in mw b gy ne nb l nc nd">SELECT FORMAT("Created customer ID %s", id);</span></pre><ul class=""><li id="0adf" class="lc ld in jm b jn jo jr js jv nf jz ng kd nh kh lj lk ll lm bi translated">将相同的脚本转换成一个过程:</li></ul><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="0db3" class="kj kk in mw b gy na nb l nc nd">CREATE OR REPLACE PROCEDURE my_dataset.create_customer()<br/>BEGIN<br/>  DECLARE id STRING;<br/>  SET id = GENERATE_UUID();<br/>  INSERT INTO my_project.my_dataset.my_table (customer_id)<br/>    VALUES(id);<br/>  SELECT FORMAT("Created customer %s", id);<br/>END;</span><span id="8cab" class="kj kk in mw b gy ne nb l nc nd">CALL my_dataset.create_customer();</span></pre><p id="7c68" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">文档:</strong> <a class="ae ki" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/scripting-concepts" rel="noopener ugc nofollow" target="_blank">脚本和存储过程</a></p><h1 id="e567" class="lz kk in bd kl ma nl mc ko md nm mf kr mg nn mi ku mj no ml kx mm np mo la mp bi translated">8.多语句交易</h1><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="e1da" class="kj kk in mw b gy na nb l nc nd">CREATE OR REPLACE TABLE my_dataset.inventory<br/>(<br/> product string,<br/> quantity int64,<br/> supply_constrained bool<br/>);</span><span id="4294" class="kj kk in mw b gy ne nb l nc nd">CREATE OR REPLACE TABLE my_dataset.new_arrivals<br/>(<br/> product string,<br/> quantity int64,<br/> warehouse string<br/>);</span><span id="1932" class="kj kk in mw b gy ne nb l nc nd">INSERT my_dataset.inventory (product, quantity)<br/>VALUES('top load washer', 10),<br/>     ('front load washer', 20),<br/>     ('dryer', 30),<br/>     ('refrigerator', 10),<br/>     ('microwave', 20),<br/>     ('dishwasher', 30);</span><span id="4a67" class="kj kk in mw b gy ne nb l nc nd">INSERT my_dataset.new_arrivals (product, quantity, warehouse)<br/>VALUES('top load washer', 100, 'warehouse #1'),<br/>     ('dryer', 200, 'warehouse #2'),<br/>     ('oven', 300, 'warehouse #1');</span><span id="31cc" class="kj kk in mw b gy ne nb l nc nd">BEGIN TRANSACTION;</span><span id="c41b" class="kj kk in mw b gy ne nb l nc nd">-- Create a temporary table that holds new arrivals from 'warehouse #1'.<br/>CREATE TEMP TABLE tmp<br/>  AS SELECT * FROM my_dataset.new_arrivals WHERE warehouse = 'warehouse #1';</span><span id="f6f2" class="kj kk in mw b gy ne nb l nc nd">-- Delete the matching records from the NewArravals table.<br/>DELETE my_dataset.new_arrivals WHERE warehouse = 'warehouse #1';</span><span id="5e03" class="kj kk in mw b gy ne nb l nc nd">-- Merge the records from the temporary table into the inventory table.<br/>MERGE my_dataset.inventory AS I<br/>USING tmp AS T<br/>ON I.product = T.product<br/>WHEN NOT MATCHED THEN<br/> INSERT(product, quantity, supply_constrained)<br/> VALUES(product, quantity, false)<br/>WHEN MATCHED THEN<br/> UPDATE SET quantity = I.quantity + T.quantity;</span><span id="7acf" class="kj kk in mw b gy ne nb l nc nd">-- Drop the temporary table and commit the transaction.<br/>DROP TABLE tmp;</span><span id="a3dd" class="kj kk in mw b gy ne nb l nc nd">COMMIT TRANSACTION;</span></pre><p id="cfd2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">单据:</strong> <a class="ae ki" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/transactions?hl=en" rel="noopener ugc nofollow" target="_blank">多对帐单交易</a></p><h1 id="b090" class="lz kk in bd kl ma nl mc ko md nm mf kr mg nn mi ku mj no ml kx mm np mo la mp bi translated">9.动态 SQL</h1><p id="38ca" class="pw-post-body-paragraph jk jl in jm b jn le jp jq jr lf jt ju jv nq jx jy jz nr kb kc kd ns kf kg kh ig bi translated">动态执行动态 SQL 语句。</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="09c0" class="kj kk in mw b gy na nb l nc nd">DECLARE y INT64;</span><span id="f9ed" class="kj kk in mw b gy ne nb l nc nd">-- y = 1 * (3 + 2) = 5<br/>EXECUTE IMMEDIATE "SELECT ? * (? + 2)" USING 1, 3;</span><span id="af74" class="kj kk in mw b gy ne nb l nc nd">-- y = 1 * (3 + 2) + 3 = 8<br/>EXECUTE IMMEDIATE "SELECT <a class="ae ki" href="http://twitter.com/a" rel="noopener ugc nofollow" target="_blank">@a</a> * (<a class="ae ki" href="http://twitter.com/b" rel="noopener ugc nofollow" target="_blank">@b</a> + 2) + <a class="ae ki" href="http://twitter.com/b" rel="noopener ugc nofollow" target="_blank">@b</a>" INTO y USING 1 as a, 3 as b;</span><span id="0ce7" class="kj kk in mw b gy ne nb l nc nd">SELECT y;</span></pre><p id="44d4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">文档:</strong> <a class="ae ki" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/scripting?hl=en#execute_immediate" rel="noopener ugc nofollow" target="_blank">立即执行</a></p><h1 id="987a" class="lz kk in bd kl ma nl mc ko md nm mf kr mg nn mi ku mj no ml kx mm np mo la mp bi translated">10.基于列值生成行 ID</h1><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="56e4" class="kj kk in mw b gy na nb l nc nd">WITH produce AS<br/> (SELECT 'kale' as item, 23 as purchases, 'vegetable' as category<br/>  UNION ALL SELECT 'kale', 23, 'vegetable' <br/>  UNION ALL SELECT 'kale', 23, 'vegetable' <br/>  UNION ALL SELECT 'orange', 2, 'fruit'<br/>  UNION ALL SELECT 'cabbage', 9, 'vegetable'<br/>  UNION ALL SELECT 'apple', 8, 'fruit'<br/>  UNION ALL SELECT 'leek', 2, 'vegetable'<br/>  UNION ALL SELECT 'lettuce', 10, 'vegetable')<br/> <br/>SELECT <br/>  *,<br/>  TO_JSON_STRING(t) AS json_from_columns,<br/>  FARM_FINGERPRINT(TO_JSON_STRING(t)) AS rowid_from_columns<br/>FROM produce AS t</span></pre><p id="245f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">文档:</strong><a class="ae ki" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/functions-and-operators#to_json_string" rel="noopener ugc nofollow" target="_blank">TO _ JSON _ STRING</a>；<a class="ae ki" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/functions-and-operators#farm_fingerprint" rel="noopener ugc nofollow" target="_blank">农场 _ 指纹</a></p><h1 id="a9c2" class="lz kk in bd kl ma nl mc ko md nm mf kr mg nn mi ku mj no ml kx mm np mo la mp bi translated">11.调试语句</h1><p id="52ed" class="pw-post-body-paragraph jk jl in jm b jn le jp jq jr lf jt ju jv nq jx jy jz nr kb kc kd ns kf kg kh ig bi translated">评估表达式。如果表达式的计算结果为<code class="fe ni nj nk mw b">TRUE</code>，则该语句成功返回，没有任何结果。如果表达式的计算结果为<code class="fe ni nj nk mw b">FALSE</code>或<code class="fe ni nj nk mw b">NULL</code>，该语句将生成一个错误。如果存在描述，描述将出现在错误消息中。</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="bd63" class="kj kk in mw b gy na nb l nc nd">ASSERT<br/>(SELECT COUNT(*) FROM UNNEST([1, 2, 3, 4, 5, 6])) &gt; 5<br/>AS 'Table must contain more than 5 rows.';</span><span id="edaa" class="kj kk in mw b gy ne nb l nc nd">ASSERT EXISTS(<br/>  SELECT X<br/>  FROM UNNEST([7877, 7879, 7883, 7901, 7907]) X<br/>  WHERE X = 7919<br/>) AS 'Column X must contain the value 7919';</span></pre><p id="ebc1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">文档:</strong>T5】断言</p><h1 id="acfa" class="lz kk in bd kl ma nl mc ko md nm mf kr mg nn mi ku mj no ml kx mm np mo la mp bi translated">12.创建外部表</h1><p id="7b6f" class="pw-post-body-paragraph jk jl in jm b jn le jp jq jr lf jt ju jv nq jx jy jz nr kb kc kd ns kf kg kh ig bi translated">外部表允许 BigQuery 查询存储在 BigQuery 存储之外的数据。</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="e46f" class="kj kk in mw b gy na nb l nc nd">CREATE OR REPLACE EXTERNAL TABLE my_dataset.ext_produce <br/>(<br/>  item STRING,<br/>  purchases INT64,<br/>  category STRING,<br/>  path STRING<br/>)<br/>OPTIONS (<br/>  format = 'CSV',<br/>  uris = ['gs://my-bucket/file1.csv', 'gs://my-bucket/file2.csv']<br/>);</span><span id="cb2e" class="kj kk in mw b gy ne nb l nc nd">SELECT * <br/>FROM `my_dataset.ext_produce`</span></pre><p id="5882" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">文档:</strong>T9】创建外部表语句</p><h1 id="30f7" class="lz kk in bd kl ma nl mc ko md nm mf kr mg nn mi ku mj no ml kx mm np mo la mp bi translated">13.导出数据</h1><p id="5790" class="pw-post-body-paragraph jk jl in jm b jn le jp jq jr lf jt ju jv nq jx jy jz nr kb kc kd ns kf kg kh ig bi translated">将查询结果导出到外部存储位置。支持的格式包括:AVRO，CSV，JSON，拼花。</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="ef2d" class="kj kk in mw b gy na nb l nc nd">EXPORT DATA OPTIONS(<br/>  uri='gs://my-bucket/my-folder/*.json',<br/>  format='JSON',<br/>  overwrite=true) AS<br/>SELECT * <br/>FROM `my-project.my-dataset.my-table`</span></pre><p id="3d60" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">文档:</strong> <a class="ae ki" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/other-statements?hl=en#export_data_statement" rel="noopener ugc nofollow" target="_blank">导出数据报表</a></p><h1 id="efd0" class="lz kk in bd kl ma nl mc ko md nm mf kr mg nn mi ku mj no ml kx mm np mo la mp bi translated">14.创建和执行 ML 模型</h1><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="d9de" class="kj kk in mw b gy na nb l nc nd">#CreateModel<br/>CREATE OR REPLACE MODEL `my_dataset.sample_model`<br/>OPTIONS(model_type='logistic_reg') AS<br/>SELECT<br/>  IF(totals.transactions IS NULL, 0, 1) AS label,<br/>  IFNULL(device.operatingSystem, "") AS os,<br/>  device.isMobile AS is_mobile,<br/>  IFNULL(geoNetwork.country, "") AS country,<br/>  IFNULL(totals.pageviews, 0) AS pageviews<br/>FROM<br/>  `bigquery-public-data.google_analytics_sample.ga_sessions_*`<br/>WHERE<br/>  _TABLE_SUFFIX = '20160801';<br/>  <br/>#EvaluateModel<br/>SELECT<br/>  *<br/>FROM<br/>  ML.EVALUATE(MODEL `my_dataset.sample_model`, (<br/>SELECT<br/>  IF(totals.transactions IS NULL, 0, 1) AS label,<br/>  IFNULL(device.operatingSystem, "") AS os,<br/>  device.isMobile AS is_mobile,<br/>  IFNULL(geoNetwork.country, "") AS country,<br/>  IFNULL(totals.pageviews, 0) AS pageviews<br/>FROM<br/>  `bigquery-public-data.google_analytics_sample.ga_sessions_*`<br/>WHERE<br/>  _TABLE_SUFFIX BETWEEN '20170701' AND '20170801'));<br/>  <br/>#PredictOutcomes<br/>SELECT<br/>  country,<br/>  SUM(predicted_label) as total_predicted_purchases<br/>FROM<br/>  ML.PREDICT(MODEL `my_dataset.sample_model`, (<br/>SELECT<br/>  IFNULL(device.operatingSystem, "") AS os,<br/>  device.isMobile AS is_mobile,<br/>  IFNULL(totals.pageviews, 0) AS pageviews,<br/>  IFNULL(geoNetwork.country, "") AS country<br/>FROM<br/>  `bigquery-public-data.google_analytics_sample.ga_sessions_*`<br/>WHERE<br/>  _TABLE_SUFFIX BETWEEN '20170701' AND '20170801'))<br/>GROUP BY country<br/>ORDER BY total_predicted_purchases DESC<br/>LIMIT 10</span></pre><p id="c84e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">文档:</strong> <a class="ae ki" href="https://cloud.google.com/bigquery-ml/docs" rel="noopener ugc nofollow" target="_blank"> ML 文档</a>；<a class="ae ki" href="https://cloud.google.com/bigquery-ml/docs/bigqueryml-web-ui-start" rel="noopener ugc nofollow" target="_blank">快速启动</a>；<a class="ae ki" href="https://cloud.google.com/bigquery-ml/docs/tutorials" rel="noopener ugc nofollow" target="_blank"> ML 教程</a></p><h1 id="3f28" class="lz kk in bd kl ma nl mc ko md nm mf kr mg nn mi ku mj no ml kx mm np mo la mp bi translated">15.分析和可视化地理空间数据</h1><p id="5a60" class="pw-post-body-paragraph jk jl in jm b jn le jp jq jr lf jt ju jv nq jx jy jz nr kb kc kd ns kf kg kh ig bi translated">地理空间分析允许您通过使用地理数据类型和标准 SQL 地理函数来分析和可视化 BigQuery 中的地理空间数据。要可视化地理位置数据，您可以使用:</p><ul class=""><li id="e595" class="lc ld in jm b jn jo jr js jv nf jz ng kd nh kh lj lk ll lm bi translated">谷歌数据工作室</li><li id="5a08" class="lc ld in jm b jn ln jr lo jv lp jz lq kd lr kh lj lk ll lm bi translated">BigQuery Geo Viz</li><li id="3d51" class="lc ld in jm b jn ln jr lo jv lp jz lq kd lr kh lj lk ll lm bi translated">谷歌地球引擎</li><li id="ae46" class="lc ld in jm b jn ln jr lo jv lp jz lq kd lr kh lj lk ll lm bi translated">Jupyter 笔记本</li></ul><p id="7506" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><a class="ae ki" href="https://user-images.githubusercontent.com/3390857/129909651-8d19afda-68c3-4efb-83a3-c5b2d6bc5c7c.png" rel="noopener ugc nofollow" target="_blank"> BigQuery Geo Viz 示例</a></p><p id="c4b3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">文档:</strong><a class="ae ki" href="https://cloud.google.com/bigquery/docs/gis" rel="noopener ugc nofollow" target="_blank">big query GIS</a>；<a class="ae ki" href="https://cloud.google.com/bigquery/docs/gis-tutorial-hurricane#run_a_standard_sql_query_on_data" rel="noopener ugc nofollow" target="_blank"> BigQuery GIS 教程</a>；<a class="ae ki" href="https://cloud.google.com/bigquery/docs/geospatial-visualize" rel="noopener ugc nofollow" target="_blank">可视化地理空间数据</a></p></div></div>    
</body>
</html>