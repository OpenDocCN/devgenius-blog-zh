<html>
<head>
<title>Node.js Server Optimization &amp; Consolidation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Node.js服务器优化和整合</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/production-grade-node-js-nginx-pm2-and-more-16d8b9fc56a2?source=collection_archive---------2-----------------------#2021-05-16">https://blog.devgenius.io/production-grade-node-js-nginx-pm2-and-more-16d8b9fc56a2?source=collection_archive---------2-----------------------#2021-05-16</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/8849a9c545135860d82d8cf8c3819872.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*H93RVQJ_p9irGYMb"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">泽维尔·冯·埃拉赫在<a class="ae jz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="7be5" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">想象一下，您刚刚创建了Node.js应用程序，现在您必须确保服务器的可用性和健壮性。我们将从一个非常基本的/不推荐的方法开始，来理解我们在部署Node.js应用程序时做错了什么，并逐步向上构建，朝着我们的最终目标填充缺失的部分。在本教程中，我们将使用<strong class="kc io">快递。</strong></p><h2 id="247a" class="ky kz in bd la lb lc dn ld le lf dp lg kl lh li lj kp lk ll lm kt ln lo lp lq bi translated">快速应用程序</h2><figure class="lr ls lt lu gt jo"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="ccad" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">一个很基础的app，有健康的路线，也有故障的路线。</p><p id="8282" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">。包封/包围（动词envelop的简写）</p><figure class="lr ls lt lu gt jo"><div class="bz fp l di"><div class="lv lw l"/></div></figure></div><div class="ab cl lx ly hr lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ig ih ii ij ik"><h2 id="2ca2" class="ky kz in bd la lb lc dn ld le lf dp lg kl lh li lj kp lk ll lm kt ln lo lp lq bi translated">一级:</h2><figure class="lr ls lt lu gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi me"><img src="../Images/0bb00d24edba5e0bb16db8f06901c9b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Bm9qhLScdQG9ZHo6DQ_irw.png"/></div></div></figure><blockquote class="mf mg mh"><p id="0c73" class="ka kb mi kc b kd ke kf kg kh ki kj kk mj km kn ko mk kq kr ks ml ku kv kw kx ig bi translated">命令:</p></blockquote><pre class="lr ls lt lu gt mm mn mo mp aw mq bi"><span id="7397" class="ky kz in mn b gy mr ms l mt mu">node index.js</span></pre><p id="2c1b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">运行应用程序的第一种也是最差的方式是，<strong class="kc io">直接用node执行脚本，</strong> Node.js本来就是单线程的，带有一个事件模型，在生产中不能像预期的那样伸缩。</p><p id="6b00" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">有些人可能不同意节点是单线程的评论，可能会对“工作线程”、Node.js使用不同的内部读写过程以及人们为解决问题而做的其他事情有争议，这只会增加项目的复杂性。</p><p id="04bc" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">试错法入门</p><p id="943d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">当我们使用我们的客户或邮递员给bad-route打电话时会发生什么，应用程序不会工作，你的应用程序会瘫痪，你会失去你宝贵的客户和他们的信任。</p><p id="515a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">你对这种方法有什么期望？</p><figure class="lr ls lt lu gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mv"><img src="../Images/0ef5538671945a97c3086e2e5e48afee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wuQcwbfh1KJjwg6YimzyfA.png"/></div></div></figure><p id="1ac7" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如何重现这个错误作出一个get请求到你的健康路线你会得到一个“积极”的回应从服务器，打开另一个标签与bad-route，应用程序将崩溃，直到我们手动启动。</p><p id="ba01" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">除此之外，你还会有意想不到的结果和障碍。</p><p id="13b5" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">有什么解决办法？</strong></p><p id="182d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">建立一个“自我修复”机制。</p><blockquote class="mf mg mh"><p id="b470" class="ka kb mi kc b kd ke kf kg kh ki kj kk mj km kn ko mk kq kr ks ml ku kv kw kx ig bi translated">“恢复很难。后悔更难。”—布列塔尼·伯格恩</p></blockquote><p id="e60b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们需要在我们的应用程序之上有某种监督/过程管理器，来跟踪我们的应用程序是否运行良好，是否如“预期”的那样</p><p id="b3cd" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">你可以考虑nodemon，<strong class="kc io"> nodemon </strong>的核心只是一个开发脚本，为你提供热重装，免去重启服务器的麻烦。它只有很少的监控机制，并不是在生产中管理我们项目的理想人选。</p><p id="4e82" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这里最好的赌注是<strong class="kc io"> PM2，永远，</strong>或类似的东西。</p></div><div class="ab cl lx ly hr lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ig ih ii ij ik"><h2 id="da01" class="ky kz in bd la lb lc dn ld le lf dp lg kl lh li lj kp lk ll lm kt ln lo lp lq bi translated">第二级:</h2><p id="dd60" class="pw-post-body-paragraph ka kb in kc b kd mw kf kg kh mx kj kk kl my kn ko kp mz kr ks kt na kv kw kx ig bi translated">命令:</p><pre class="lr ls lt lu gt mm mn mo mp aw mq bi"><span id="67e0" class="ky kz in mn b gy mr ms l mt mu">npm i -g pm2</span><span id="736f" class="ky kz in mn b gy nb ms l mt mu">pm2 start index.js --name "Server" -i 0</span></pre><figure class="lr ls lt lu gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi me"><img src="../Images/5c6f2b2e75b6b4d60f3f97b6bb51aa66.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KL5WOmKUVcfNZtfCqSoGuA.png"/></div></div></figure><p id="bd86" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">PM2是迄今为止我的Node.js应用程序在规模上最久经考验的进程管理器，它帮助你在服务器上拥有越多的线程/CPU单元。线程/内核与您可以运行的集群单元成正比。</p><p id="1ee7" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">除了对我们的应用程序进行负载平衡之外，pm2还提供了流畅的部署，为我们节省了大量时间。除此之外，您还可以存储和管理日志。分离访问日志和错误日志。</p><p id="0126" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">全新部署或更改后重新加载应用程序的命令:</p><pre class="lr ls lt lu gt mm mn mo mp aw mq bi"><span id="d1bf" class="ky kz in mn b gy mr ms l mt mu">pm2 reload all</span></pre><p id="bd2b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">命令查看应用程序的日志以尽快部署热修复程序:</p><pre class="lr ls lt lu gt mm mn mo mp aw mq bi"><span id="5721" class="ky kz in mn b gy mr ms l mt mu">pm2 logs</span></pre><p id="71ec" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">当您的应用程序被部署到生产环境中时，您会在日常工作中使用这些命令。</p><p id="181d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">您还可以在生产中监控您的应用程序。</p><pre class="lr ls lt lu gt mm mn mo mp aw mq bi"><span id="f8db" class="ky kz in mn b gy mr ms l mt mu">pm2 monit</span></pre><p id="2387" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这将为您提供一个漂亮的老式终端UI，其中包含审计应用程序性能所需的所有细节</p><p id="2fcb" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">根据他们的官方文件，这些是你从pm2得到的特性:</strong></p><figure class="lr ls lt lu gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nc"><img src="../Images/73442b4b42b5144274c1e3b2d8cf1ca2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UmvBv4p8j18hZSJGcRYxBA.png"/></div></div></figure><p id="0dde" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在，我们已经完成了应用程序的<strong class="kc io">垂直扩展</strong>部分，应用程序将分担负载，并随意优雅地关闭和重启。</p><p id="6542" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">尽管pm2有这么多出色的功能，但它也有可能失灵。</p><p id="49f1" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">示例:</p><p id="07fb" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">您对应用程序进行了全新部署；您没有针对CI/CD管道的测试套件，我们在这里都是有罪的。</p><p id="17ee" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在新的部署中发生了什么，X安装了一个新的依赖项，您通过先安装它来重新加载，或者您安装了它，但是您的package.json不知何故被遗漏了，或者提交在同行评审中被部分恢复。</p><p id="8f8b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在你重新加载了你的应用程序。</p><p id="80d2" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在，第一次重新加载时，由于缺少依赖项，应用程序会立即崩溃。现在处于恐慌状态，这些都需要迎合。</p><p id="1646" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这里有什么建议:</p><p id="8242" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">始终保持稳健的CI/CD渠道。对于部署，请始终创建应用程序的版本。决定在一个新的上游块中部署新的应用程序，看看是否一切顺利，然后在主运行应用程序上进行部署。</p><p id="f830" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">让这变得更容易的工具是高度可扩展的，并且在<strong class="kc io"> NGINX后面有一个活跃的社区。</strong></p></div><div class="ab cl lx ly hr lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ig ih ii ij ik"><h2 id="5f1b" class="ky kz in bd la lb lc dn ld le lf dp lg kl lh li lj kp lk ll lm kt ln lo lp lq bi translated">第三级:</h2><figure class="lr ls lt lu gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nd"><img src="../Images/57cfd3da37ab75d647dd8a6b1c5abbd9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vCczuoYkNx-fciz37oTPgQ.png"/></div></div></figure><p id="1df9" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">什么是<strong class="kc io"> NGINX </strong>？</p><p id="951a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">根据NGINX官方文件:</p><blockquote class="mf mg mh"><p id="becc" class="ka kb mi kc b kd ke kf kg kh ki kj kk mj km kn ko mk kq kr ks ml ku kv kw kx ig bi translated">NGINX 是一款开源软件，用于web服务、反向代理、缓存、负载平衡、媒体流等等。它最初是一个为获得最佳性能和稳定性而设计的web服务器。除了HTTP服务器功能，NGINX还可以充当电子邮件(IMAP、POP3和SMTP)的代理服务器，以及HTTP、TCP和UDP服务器的反向代理和负载平衡器。</p></blockquote><p id="e034" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">NGINX是一个高性能的服务器，但我们的用例是创建一个反向代理/负载平衡器。</p><p id="6659" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们将如何使用<strong class="kc io"> NGINX </strong>？</p><p id="e169" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们可以在两个不同的服务器上托管两个不同版本的应用程序，并在这两个服务器之间创建一个API网关。</p><p id="ef9e" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如果这听起来令人困惑，让我们看一个例子:</p><figure class="lr ls lt lu gt jo"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="924f" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">正如我们所知，旧服务器是预期拥有并回复大部分流量的服务器，但同时我们也可以使用新服务器。</p><p id="aca5" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">实际上有两种方法，要么在old_server内添加新服务器的上游块，让NGINX进行负载平衡，我们可以使用IP和端口的任意组合来分配负载，我们可以让一些实例运行在负载平衡NGINX的同一个实例上，或者我们可以在实例之间进行分配。</p><p id="7c00" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们在这里所做的是为我们的客户提供的版本，允许新的API分发给一些客户，并根据他们的反馈以及稳定性和健壮性方面的经验，我们可以决定微调回滚或将发布提交给所有客户端。</p><p id="66d9" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">使用Nginx，我们可以实现<strong class="kc io">水平扩展</strong>在我们的示例中，对于那些混淆水平和垂直扩展的人，<strong class="kc io">垂直扩展是为了提升当前的机器规格，水平扩展是为了在混合中附加更多实例并分担负载。</strong></p><p id="6df3" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">NGINX是一个非常强大的工具，他们证明了它不仅对于API是健壮的，而且对于以非常高的吞吐量服务于你的静态分发、你的HTML、CSS和其他资产也是健壮的。</p><p id="34e8" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如果你决定与客户分享，NGINX会让你的URL更加友好。移除端口和丑陋的配置也有助于您摆脱管理噩梦<strong class="kc io"> CORS </strong>。</p><p id="8a93" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">NGINX还有其他的替代品，包括APACHE和HAPROXY等等。</p><p id="3165" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">希望你已经很好地理解了问题的概念和它们的解决方案，讨论手头问题的解决方案也能让解决方案更加清晰。</p><h1 id="f074" class="ne kz in bd la nf ng nh ld ni nj nk lg nl nm nn lj no np nq lm nr ns nt lp nu bi translated">关键要点:</h1><p id="7eed" class="pw-post-body-paragraph ka kb in kc b kd mw kf kg kh mx kj kk kl my kn ko kp mz kr ks kt na kv kw kx ig bi translated"><em class="mi">在考虑缩放时，请记住它的垂直和水平两个方面。</em></p><p id="9b58" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><em class="mi"> PM2和NGINX为您的Node.js应用程序提供了强大的扩展能力。</em></p><h2 id="cded" class="ky kz in bd la lb lc dn ld le lf dp lg kl lh li lj kp lk ll lm kt ln lo lp lq bi translated">资源:</h2><div class="nv nw gp gr nx ny"><a href="https://pm2.keymetrics.io/" rel="noopener  ugc nofollow" target="_blank"><div class="nz ab fo"><div class="oa ab ob cl cj oc"><h2 class="bd io gy z fp od fr fs oe fu fw im bi translated">PM2 -家</h2><div class="of l"><h3 class="bd b gy z fp od fr fs oe fu fw dk translated">伙计们刚刚在我的实时服务器上安装了pm2，并连接到Keymetrics。印象深刻。这一切天衣无缝，棒极了…</h3></div><div class="og l"><p class="bd b dl z fp od fr fs oe fu fw dk translated">pm2.keymetrics.io</p></div></div><div class="oh l"><div class="oi l oj ok ol oh om jt ny"/></div></div></a></div><div class="nv nw gp gr nx ny"><a href="https://www.nginx.com/resources/glossary/nginx/" rel="noopener  ugc nofollow" target="_blank"><div class="nz ab fo"><div class="oa ab ob cl cj oc"><h2 class="bd io gy z fp od fr fs oe fu fw im bi translated">NGINX是什么？- NGINX</h2><div class="of l"><h3 class="bd b gy z fp od fr fs oe fu fw dk translated">NGINX是用于web服务、反向代理、缓存、负载平衡、媒体流等的开源软件。它…</h3></div><div class="og l"><p class="bd b dl z fp od fr fs oe fu fw dk translated">www.nginx.com</p></div></div><div class="oh l"><div class="on l oj ok ol oh om jt ny"/></div></div></a></div><p id="b4d5" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">快乐编码+缩放</p><p id="066b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">敬请期待更多和平！！！</p></div></div>    
</body>
</html>