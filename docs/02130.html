<html>
<head>
<title>Declarative Schema Overview in Magento 2 — Part 1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Magento 2中的声明式模式概述—第1部分</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/how-to-use-declarative-schemas-in-magento-2-part-1-d6c34e00841d?source=collection_archive---------7-----------------------#2020-07-20">https://blog.devgenius.io/how-to-use-declarative-schemas-in-magento-2-part-1-d6c34e00841d?source=collection_archive---------7-----------------------#2020-07-20</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/0431b23b02b986bfa7158cd690402554.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tDh5pwvVjdDw3k3L3tN4WA.jpeg"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">Artem Sapegin 在<a class="ae jz" href="https://unsplash.com/" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="b896" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">当我们更改数据库时，通常是通过安装或升级脚本来完成的。我们首先创建一个包含php类“InstallSchema”的安装脚本，并在其中编写PHP代码来调整数据库。然后，当我们需要更改一个表时，我们创建一个“UpgradeSchema”，查看需要升级的版本，并添加我们的更改。</p><p id="b489" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">使用安装脚本的缺点</strong></p><p id="a172" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在安装过程中，Magento会检查模块的所有版本，直到达到最新版本。看起来像这样:</p><pre class="ky kz la lb gt lc ld le lf aw lg bi"><span id="e554" class="lh li in ld b gy lj lk l ll lm">1.0.0 create database schema (install table X)<br/>1.0.1 update database schema (add column A to table X)<br/>1.0.2 update database schema (add column B to table X)<br/>1.0.3 update database schema (remove column A from table X)</span></pre><p id="846f" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">虽然这一切乍一看都很好，但有许多缺点。</p><p id="09d3" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">使用这种方法，我们的升级脚本的复杂性增加了。</p><p id="3742" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">例如，如果不将模块添加到新版本中，就不可能删除您之前添加的列。开发人员应该在不破坏任何东西的情况下，完全理解每个安装和升级脚本包含的内容。这导致了额外的复杂性和不必要的错误。</p><p id="9878" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">幸运的是，Magento以声明性方案的形式提出了一个解决方案。新方法允许开发者声明数据库的最终期望状态，并允许系统自动适应它，而不需要多余的操作。此外，不需要编写卸载脚本，因为当删除模块时，更改会自动删除。</p><p id="129c" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">什么是声明性模式？</p><p id="3455" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Magento 2.3中引入了声明性模式，这是对数据库进行更改的一种新方式。Magento 2.3中还不要求使用声明性模式，但是建议使用它。除了上面已经提到的所有优点之外，它还具有以下优点:</p><ul class=""><li id="9a97" class="ln lo in kc b kd ke kh ki kl lp kp lq kt lr kx ls lt lu lv bi translated">安装的试运行模式。</li><li id="76ff" class="ln lo in kc b kd lw kh lx kl ly kp lz kt ma kx ls lt lu lv bi translated">性能优化:声明式调度方法通过从当前版本移动到最后一点节省了大量时间。</li><li id="b652" class="ln lo in kc b kd lw kh lx kl ly kp lz kt ma kx ls lt lu lv bi translated">支持回滚:开发人员可以恢复到以前的版本。</li><li id="e218" class="ln lo in kc b kd lw kh lx kl ly kp lz kt ma kx ls lt lu lv bi translated">安装前的验证。</li></ul><p id="b22a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">如何使用声明性模式</strong></p><p id="0532" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">声明性方案以XML文件的形式出现。您可以通过在etc/文件夹中添加一个db_schema.xml文件来创建它。</p><p id="290b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">例如，我们想要一个包含以下信息的表:文件名、文件位置以及与quote_item的关系。我们称该表为“报价_项目_文件”,包含以下各列:文件名、位置、报价_项目_项目_id、创建时间。如果我们把它写在etc/db_schema.xml中，它看起来会像这样。</p><figure class="ky kz la lb gt jo"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="8e92" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如果你能看到它是直截了当的。我们从一个具有以下属性的表节点开始，名称、资源和引擎。这又有一个子节点“column ”,它描述了表中的列。此外，当我们想要创建与另一个表(在我们的例子中是“quote_item”表)的关系时，它有一个主键类型为“primary”的约束子节点和一个外键类型为“foreign”的约束子节点。</p><p id="8582" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">然后我们运行:</p><pre class="ky kz la lb gt lc ld le lf aw lg bi"><span id="7717" class="lh li in ld b gy lj lk l ll lm">bin/magento setup:db-declaration:generate-whitelist --module-name=Module_Name &amp;&amp; bin/magento s:up</span></pre><p id="dba3" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">json用于保持Magento中的向后兼容性。</p><p id="0344" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">当我们转到数据库时，您会看到我们的表已经创建好了。如果我们想改变表中的任何内容，只需修改文件并再次运行命令。</p><figure class="ky kz la lb gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi md"><img src="../Images/2aecf7d35ceaf9fdae7425d0fde2504e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yTFjuK0nZ_l8qp5imtdn2g.png"/></div></div></figure><p id="08ca" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">为了举例说明这有多容易，我们将created_at列添加到表中。</p><figure class="ky kz la lb gt jo"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="ee8f" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">然后我们再次运行bin/magento s:up，看到这个列已经被添加到数据库中。</p><figure class="ky kz la lb gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi md"><img src="../Images/85f7649dbde20e5dd113ed5cbe1181e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pqzW2ZmPTGCWc0-7Y4gDlA.png"/></div></div></figure><p id="a54e" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如果我们想完全删除表，只需从xml中删除它。</p><p id="d44a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">重命名表格</strong></p><p id="9114" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">可以通过创建新的表节点并删除旧的表节点来重命名表。然后，我们将“onCreate”属性添加到包含方法和当前表名作为参数的新表节点中。" migrateDataFromAnotherTable(quote _ item _ file)"见下文。</p><figure class="ky kz la lb gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi me"><img src="../Images/6c65a190897a895afccce45da7cb555f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BHGb_0T-7FNkHTWkHD5Qiw.png"/></div></div></figure><blockquote class="mf mg mh"><p id="d071" class="ka kb mi kc b kd ke kf kg kh ki kj kk mj km kn ko mk kq kr ks ml ku kv kw kx ig bi translated">重命名一个表时，记得重新生成db_schema_whitelist.json文件，这样除了旧名称之外，它还包含新名称。</p></blockquote><p id="4e61" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">结论</strong></p><p id="2b73" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">到目前为止，第一部分是关于Magento 2中的声明性模式。在第二部分中，我将讨论如何将安装/升级脚本转换为声明式方案、试运行以及如何执行回滚。</p><p id="edfc" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">来源:<a class="ae jz" href="https://devdocs.magento.com/guides/v2.4/extension-dev-guide/declarative-schema/" rel="noopener ugc nofollow" target="_blank">声明性模式概述</a></p><h1 id="c54c" class="mm li in bd mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni bi translated">觉得这个帖子有用吗？请点击👏下面的按钮！:)</h1></div></div>    
</body>
</html>