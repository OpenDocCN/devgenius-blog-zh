# ä½¿ç”¨åç¨‹å’Œæµç¨‹æµ‹è¯•æˆ¿é—´æ•°æ®åº“â€”æµ‹è¯•åŸºç¡€

> åŸæ–‡ï¼š<https://blog.devgenius.io/testing-room-database-with-coroutines-and-flows-testing-fundamentals-iii-5f6c3b9e4c94?source=collection_archive---------2----------------------->

## Android æµ‹è¯•æ•™ç¨‹

## æ°¸è¿œä¸ºæµåŠ¨çš„å˜åŒ–ç•™æœ‰ç©ºé—´ï¼

![](img/fe4330cc7ca5ff4cbb94b2f5ff44f2d8.png)

æ¥æº:https://testinggenez.com/

æˆ‘ä»¬å¤§éƒ¨åˆ†æ—¶é—´å¤„ç†çš„ä¸€ä¸ªå¸¸è§ç”¨ä¾‹æ˜¯åœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨æœ¬åœ°æ•°æ®åº“æ¥æ”¯æŒç¼“å­˜ï¼Œä¸ºæ­¤ä½¿ç”¨ç©ºé—´æ˜¯ä¼—æ‰€å‘¨çŸ¥çš„ã€‚å› æ­¤ï¼Œä¸ºæˆ‘ä»¬çš„æ•°æ®åº“ç¼–å†™æµ‹è¯•å˜å¾—éå¸¸é‡è¦ï¼Œå› ä¸ºåœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œæœ¬åœ°æ•°æ®åº“æ˜¯åº”ç”¨ç¨‹åºçš„å”¯ä¸€æ•°æ®æºã€‚

ä½¿ç”¨æ•°æ®åº“æœ€å¸¸è§çš„æ“ä½œæ˜¯ CRUD æ“ä½œã€‚å› æ­¤ï¼Œåœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†æ¢ç´¢å¦‚ä½•ä¸ºè¿™æ ·çš„æ“ä½œç¼–å†™æµ‹è¯•ï¼Œä»¥åŠå½“å®ƒä»¬è¿”å›ç»™æˆ‘ä»¬ä¸€ä¸ªæµæ—¶ã€‚

æˆ‘ä»¬å°†æœ‰ä¸€ä¸ªç®€å•çš„åº”ç”¨ç¨‹åºï¼Œä»¥åç§°çš„é¡¹ç›®ï¼Œå¹¶å°†å…¶ä¿å­˜åœ¨æ•°æ®åº“ä¸­ã€‚è®©æˆ‘ä»¬å¼€å§‹å§ã€‚

# æˆ¿é—´å¸ƒç½®

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åœ¨åº”ç”¨ç¨‹åºä¸­è®¾ç½®æˆ¿é—´æ•°æ®åº“ã€‚æ‰€ä»¥è®©æˆ‘ä»¬å¿«é€Ÿåœ°åšé‚£ä»¶äº‹ã€‚å¦‚ä¸‹æ‰€ç¤ºæ·»åŠ ä¾èµ–é¡¹ã€‚

ç°åœ¨åˆ›å»ºä¸€ä¸ªè¡¨å®ä½“ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚

ç„¶åå¦‚ä¸‹å®šä¹‰ Dao æ¥å£ã€‚è¿™æ˜¯æˆ‘ä»¬å®šä¹‰æ•°æ®åº“ API çš„ç±»ã€‚æˆ‘ä»¬çš„æ·»åŠ å’Œåˆ é™¤åŠŸèƒ½è¢«æš‚åœã€‚

ç„¶ååˆ›å»ºæ•°æ®åº“å®ä½“ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚

å°±æ˜¯è¿™æ ·ã€‚è®¾ç½®å®Œæˆäº†ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥å¿«é€Ÿæµè§ˆä¸€ä¸‹åˆšåˆšè®¾ç½®çš„å†…å®¹ã€‚å› æ­¤ï¼Œæˆ‘ä»¬ä¸ºæ•°æ®åº“å®šä¹‰äº†ä¸‰ä¸ªç®€å•çš„ APIï¼Œåˆ†åˆ«æ˜¯æ·»åŠ /æ›´æ–°é¡¹ç›®ã€åˆ é™¤é¡¹ç›®å’Œè·å–æ‰€æœ‰é¡¹ç›®ã€‚

# æµ‹è¯•è®¾ç½®

ä¸ºäº†æµ‹è¯•æˆ‘ä»¬çš„æ•°æ®åº“è®¾ç½®ï¼Œæˆ‘ä»¬éœ€è¦äº‹å…ˆäº†è§£ä»¥ä¸‹å‡ ç‚¹

*   åœ¨æµ‹è¯•ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬ä¸æ˜¯åœ¨è®¾å¤‡å­˜å‚¨ä¸­æ‹¥æœ‰çœŸå®çš„æ•°æ®åº“ï¼Œè€Œæ˜¯åœ¨å†…å­˜ä¸­åˆ›å»ºä¸€ä¸ªæ•°æ®åº“ï¼Œæˆ–è€…ä½ å¯ä»¥è¯´æ˜¯ä¸€ä¸ªä¸´æ—¶æ•°æ®åº“ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥å¿«é€Ÿæµ‹è¯•å®ƒï¼Œå¹¶ä¸”å®ƒä¸ä¼šç»™æˆ‘ä»¬çš„è®¾å¤‡æˆ–åº”ç”¨ç¨‹åºå¢åŠ ä»»ä½•é¢å¤–çš„è´Ÿè½½ã€‚ä¸€æ—¦æµ‹è¯•å®Œæˆï¼Œå®ƒå°±ä¼šè¢«ç§»é™¤ã€‚
*   å› ä¸ºæˆ‘ä»¬ä½¿ç”¨æµæ¥è§‚å¯Ÿä»»ä½•æ•°æ®åº“å˜åŒ–ï¼Œæ‰€ä»¥åœ¨æµ‹è¯•ç¯å¢ƒä¸­è§‚å¯Ÿæµæ˜¯å¾ˆæ£˜æ‰‹çš„ã€‚æ‰€ä»¥æˆ‘ä»¬å°†ä½¿ç”¨ä¸€ä¸ªåä¸º[æ¶¡è½®æœº](https://github.com/cashapp/turbine)çš„åº“ã€‚å®ƒä½¿å¾—æµ‹è¯•æµç¨‹å˜å¾—å®¹æ˜“ã€‚æˆ‘ä»¬éœ€è¦åœ¨ androidTestImplementation ä¸‹æ·»åŠ å®ƒçš„ä¾èµ–é¡¹ï¼Œå¦‚ä¸‹æ‰€ç¤º

```
androidTestImplementation 'app.cash.turbine:turbine:0.9.0'
```

*   ç”±äº Room æ˜¯ä¸€ä¸ª android åº“ï¼Œæˆ‘ä»¬å°†åœ¨ androidTest ç›®å½•ä¸­ç¼–å†™æµ‹è¯•ã€‚

è®©æˆ‘ä»¬ä¸º ItemDao åˆ›å»ºæµ‹è¯•ç±»ã€‚

æˆ‘ä»¬åœ¨è¿™ä¸ªç±»ä¸Šæ·»åŠ äº†ä¸¤ä¸ªæ³¨é‡Šã€‚@ ***RunWith*** æ³¨é‡Šå‘Šè¯‰ç¼–è¯‘å™¨ç”¨ AndroidJUnit4 è€Œä¸æ˜¯ JUnit apis è¿è¡Œè¿™ä¸ªç±»ã€‚

@ ***SmallTest*** æ³¨é‡Šå‘Šè¯‰ç¼–è¯‘å™¨ï¼Œå®ƒæ­£åœ¨é¢‘ç¹åœ°æµ‹è¯•è¿è¡Œï¼Œå®ƒçš„æ‰§è¡Œæ—¶é—´åº”è¯¥å°äº 200msã€‚æµ‹è¯•å¤§å°é™å®šç¬¦æ˜¯æ„å»ºæµ‹è¯•ä»£ç çš„ä¸€ç§å¾ˆå¥½çš„æ–¹å¼ï¼Œç”¨äºå°†ä¸€ä¸ªæµ‹è¯•åˆ†é…ç»™ä¸€ä¸ªè¿è¡Œæ—¶é—´ç›¸ä¼¼çš„æµ‹è¯•å¥—ä»¶ã€‚

ç°åœ¨æˆ‘ä»¬éœ€è¦å°†æˆ‘ä»¬çš„åç¨‹è°ƒåº¦ç¨‹åºä» main æ”¹ä¸º test dispatcherï¼Œå¦åˆ™æˆ‘ä»¬çš„æµ‹è¯•å°†ä¼šå¼‚å¸¸å¤±è´¥ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªè§„åˆ™ï¼Œç®€å•åœ°å°†ä¸»è°ƒåº¦ç¨‹åºè®¾ç½®ä¸ºæµ‹è¯•è°ƒåº¦ç¨‹åºï¼Œå¹¶åœ¨å®Œæˆæ—¶é‡ç½®å®ƒã€‚

æˆ‘ä»¬å°†è¿™ä¸ªè§„åˆ™æ·»åŠ åˆ° ItemDaoTest.kt ä¸­ã€‚

```
@get: Rule
*val* dispatcherRule = TestDispatcherRule()
```

ç°åœ¨è®©æˆ‘ä»¬ä¸ºæµ‹è¯•åˆ›å»ºæ•°æ®åº“å’Œ dao å®ä¾‹ã€‚

å¦‚å‰æ‰€è¿°ï¼Œæˆ‘ä»¬åœ¨æ³¨é‡Šå‰çš„**ä¸‹åˆ›å»ºäº†ä¸€ä¸ªå†…å­˜ä¸­çš„æ•°æ®åº“å®ä¾‹ï¼Œå¹¶åœ¨**æ³¨é‡Šåå…³é—­äº†**ä¸­çš„æ•°æ®åº“ã€‚**

å¥½å§ï¼ç»ˆäºåˆ°äº†å†™æµ‹è¯•çš„æ—¶å€™äº†ã€‚æˆ‘ä»¬å°†ç¼–å†™ä»¥ä¸‹æµ‹è¯•ç”¨ä¾‹

*   åœ¨æ•°æ®åº“ä¸­æ·»åŠ ä¸¤ä¸ªé¡¹ç›®å¹¶è·å–æ‰€æœ‰é¡¹ç›®æµåº”è¯¥è¿”å›è¿™ä¸¤ä¸ªé¡¹ç›®ã€‚
*   æ·»åŠ ä¸¤ä¸ªé¡¹ç›®å¹¶åˆ é™¤å…¶ä¸­ä»»ä½•ä¸€ä¸ªã€‚æˆ‘ä»¬çš„è·å–æ‰€æœ‰é¡¹ç›®æµåº”è¯¥åªè¿”å›æœªåˆ é™¤çš„é¡¹ç›®ã€‚
*   æ·»åŠ ä¸¤é¡¹å¹¶æ›´æ–°å…¶ä¸­ä»»ä½•ä¸€é¡¹ã€‚æˆ‘ä»¬çš„ get all items æµåº”è¯¥è¿”å›æ›´æ–°çš„é¡¹ç›®ã€‚

# ç¼–å†™æµ‹è¯•ç”¨ä¾‹

## æµ‹è¯•æ¡ˆä¾‹ 1

åœ¨æ•°æ®åº“ä¸­æ·»åŠ ä¸€ä¸ªé¡¹ç›®ï¼Œåº”è¯¥åœ¨æˆ‘ä»¬çš„æµç¨‹ä¸­è¿”å›ã€‚

```
@Test
*fun* addItem_shouldReturn_theItem_inFlow() = *runTest* **{ }**
```

å› ä¸ºæˆ‘ä»¬çš„ add å‡½æ•°æ˜¯ä¸€ä¸ª suspend å‡½æ•°ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æµ‹è¯•åç¨‹ç”Ÿæˆå™¨ ***runTest ä¸‹è¿è¡Œå®ƒã€‚***

ç„¶åï¼Œæˆ‘ä»¬åˆ›å»ºæˆ‘ä»¬çš„é¡¹ç›®ï¼Œå¹¶å°†å®ƒä»¬æ·»åŠ åˆ°æ•°æ®åº“ä¸­ã€‚

```
*val* item1 = Item(uid = 1, itemName = "item 1")
*val* item2 = Item(uid = 2, itemName = "item 2")
itemDao.addItem(item1)
itemDao.addItem(item2)
```

ç°åœ¨æˆ‘ä»¬ä½¿ç”¨æ‰©å±•å‡½æ•° ***test æ¥æµ‹è¯•æˆ‘ä»¬çš„æµã€‚*** æˆ‘ä»¬ä½¿ç”¨æ±½è½®æœºçš„ ***awaitItem()*** å‡½æ•°è§‚å¯Ÿå‘å°„é¡¹åˆ—è¡¨ã€‚

```
itemDao.getAllItems().test **{** *val* list = awaitItem()
    *assert*(list.contains(item1))
    *assert*(list.contains(item2))
    cancel()
**}**
```

ä¸€æ—¦æˆ‘ä»¬æœ‰äº†åˆ—è¡¨ï¼Œæˆ‘ä»¬å°±æ–­è¨€è¿™ä¸¤ä¸ªé¡¹ç›®æ˜¯å¦éƒ½åœ¨åˆ—è¡¨ä¸­ã€‚å¦‚æœæ˜¯ï¼Œé‚£ä¹ˆæµ‹è¯•å°†é€šè¿‡ï¼Œå¦åˆ™å°†å¤±è´¥ã€‚

æœ€åæˆ‘ä»¬è°ƒç”¨ ***cancel()*** å‡½æ•°ï¼Œå†æ¬¡ä»æ¶¡è½®åº“ä¸­å–å‡ºã€‚

> è¿™æ˜¯ä¸€ä¸ªé‡è¦çš„æ•æ‰ï¼Œå› ä¸ºå¦‚æœæˆ‘ä»¬ä¸è¿›è¡Œè¿™ä¸ªè°ƒç”¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„æµå°†æ°¸è¿œä¸ä¼šå®Œæˆï¼Œæµ‹è¯•å°†æ°¸è¿œè¿è¡Œä¸‹å»ã€‚åœ¨æµ‹è¯•ç¯å¢ƒä¸­ï¼Œæµåº”è¯¥æ˜¯æœ‰é™çš„ï¼Œåªæœ‰è¿™æ ·å®ƒæ‰èƒ½å®Œæˆï¼Œæˆ‘ä»¬æ‰èƒ½åœ¨å‘å‡ºçš„å€¼ä¸Šæµ‹è¯•æˆ‘ä»¬çš„æ–­è¨€ã€‚

è¿è¡Œä¸Šè¿°æµ‹è¯•çš„ç»“æœå°†æ˜¯

![](img/fce5e1eb52619fb00b97ee1ff3312137.png)

å¤ªå¥½äº†ï¼å› æ­¤ï¼Œæˆ‘ä»¬å·²ç»æˆåŠŸåœ°æ‰§è¡Œå¹¶æµ‹è¯•äº†æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªæµ‹è¯•ã€‚ç°åœ¨è®©æˆ‘ä»¬æµ‹è¯•ä»æ•°æ®åº“ä¸­åˆ é™¤é¡¹ç›®ã€‚

## æµ‹è¯•æ¡ˆä¾‹ 2

åœ¨æ•°æ®åº“ä¸­åˆ é™¤ä¸€ä¸ªé¡¹ç›®ï¼Œåº”è¯¥åœ¨æˆ‘ä»¬çš„æµç¨‹ä¸­è¿”å›ã€‚

```
@Test
*fun* deletedItem_shouldNot_be_present_inFlow() = *runTest* **{ }**
```

ä¸ºäº†æ‰§è¡Œè¿™ä¸ªæµ‹è¯•ï¼Œæˆ‘ä»¬å°†é¦–å…ˆåœ¨æ•°æ®åº“ä¸­æ·»åŠ ä¸¤ä¸ªé¡¹ç›®ï¼Œå¦‚ä¸‹æ‰€ç¤º

```
*val* item1 = Item(uid = 1, itemName = "item 1")
*val* item2 = Item(uid = 2, itemName = "item 2")
itemDao.addItem(item1)
itemDao.addItem(item2)
```

ç„¶åï¼Œæˆ‘ä»¬å°†å¯¹ç¬¬äºŒä¸ªé¡¹ç›®æ‰§è¡Œåˆ é™¤æ“ä½œ(ä¸¤è€…éƒ½å¯ä»¥)ã€‚

```
itemDao.removeItem(item2)
```

ç°åœ¨ï¼Œæˆ‘ä»¬è§‚å¯Ÿè¿™ä¸ªæµï¼Œå¹¶æ£€æŸ¥è¢«åˆ é™¤çš„æ¡ç›®æ˜¯å¦ä¸åœ¨è¿”å›çš„æ¡ç›®åˆ—è¡¨ä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤º

```
itemDao.getAllItems().test **{** *val* list = awaitItem()
    *assert*(list.size == 1)
    *assert*(list.contains(item1))
    cancel()
**}**
```

ä¸€æ—¦æˆ‘ä»¬å®Œæˆæ–­è¨€ï¼Œè¯·ç¡®ä¿è°ƒç”¨ cancelã€‚

è¿è¡Œæµ‹è¯•ï¼Œç»“æœå¦‚ä¸‹

![](img/5934496ae096ed7fed562ac55c18c9ea.png)

è¿˜æœ‰ Bamnï¼æˆ‘ä»¬æˆåŠŸåœ°æµ‹è¯•äº†åˆ é™¤æ•°æ®åº“ä¸­çš„é¡¹ç›®ã€‚

## æµ‹è¯•æ¡ˆä¾‹ 3

æ›´æ–°æ•°æ®åº“ä¸­çš„é¡¹ç›®ï¼Œåº”è¯¥åœ¨æˆ‘ä»¬çš„æµç¨‹ä¸­è¿”å›ã€‚

```
@Test
*fun* updateItem_shouldReturn_theItem_inFlow() = *runTest* **{ }**
```

> å¦‚æœæ‚¨å·²ç»äº†è§£äº†è¿™ä¹ˆå¤šï¼Œé‚£ä¹ˆæ‚¨ä¸€å®šå·²ç»å¯¹å¦‚ä½•æµ‹è¯•æˆ‘ä»¬çš„æ•°æ®åº“ä»¥åŠæµ‹è¯•ä»€ä¹ˆæœ‰äº†è¶³å¤Ÿçš„äº†è§£ã€‚æ‰€ä»¥ç°åœ¨æ‚¨å¯ä»¥è‡ªå·±ç¼–å†™æ›´æ–°é¡¹ç›®æµ‹è¯•ç”¨ä¾‹å¹¶æ–­è¨€æ¡ä»¶ã€‚
> 
> è¯·å‘è¡¨è¯„è®ºï¼Œè®©æˆ‘çŸ¥é“ä½ æ˜¯å¦èƒ½å¤ŸæˆåŠŸåœ°åšåˆ°è¿™ä¸€ç‚¹ï¼Œå³ä½¿æ²¡æœ‰ã€‚ğŸ¤˜

å“‡å“¦ã€‚æˆ‘ä»¬å·²ç»ä¸ºæˆ‘ä»¬çš„æˆ¿é—´æ•°æ®åº“ç¼–å†™äº†æµ‹è¯•ç”¨ä¾‹ï¼Œå¹¶æµ‹è¯•äº†æˆ‘ä»¬çš„æµç¨‹ã€‚è¿™å°†è¶³ä»¥å¼€å§‹æµ‹è¯•ï¼Œå¹¶ä½¿æ‚¨çš„ä»£ç æ›´åŠ é˜²é”™ã€‚ç°åœ¨è¿›è¡Œè®¾ç½®ï¼Œå¹¶å°è¯•ä¸åŒçš„åœºæ™¯ã€‚

æ‚¨å¯ä»¥æŸ¥çœ‹ä¸‹é¢çš„å®Œæ•´è¦ç‚¹ä»¥ä¾›å‚è€ƒã€‚

# æœ‰å¥–é˜…è¯»

*   [è§†å›¾æ¨¡å‹æµ‹è¯•](/writing-viewmodel-tests-in-android-testing-fundamentals-ii-5bc44efa4a39)
*   [å¦‚ä½•åœ¨ Android ä¸­ç¼–å†™æœ¬åœ°æµ‹è¯•](/writing-viewmodel-tests-in-android-testing-fundamentals-ii-5bc44efa4a39)

# ç›®å‰å°±è¿™äº›äº†ï¼æ•¬è¯·æœŸå¾…ï¼

ä¸æˆ‘è”ç³»(å¦‚æœå†…å®¹å¯¹æ‚¨æœ‰å¸®åŠ©),è¯·è®¿é—®

*   [ä¸­ç­‰](https://saurabhpant.medium.com/)
*   [GitHub](https://github.com/aqua30)
*   [æ¨ç‰¹](https://twitter.com/saurabh30pant)
*   [é¢†è‹±](https://www.linkedin.com/in/saurabh-pant-44619057/)

è®¢é˜…ç”µå­é‚®ä»¶ï¼ŒåŒæ­¥äº†è§£æ›´å¤šå…³äº Android/IOS/Backend/Web çš„æœ‰è¶£è¯é¢˜ã€‚

ç›´åˆ°ä¸‹ä¸€æ¬¡â€¦

å¹²æ¯ï¼