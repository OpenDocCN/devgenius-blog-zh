<html>
<head>
<title>BigQuery with Spring Boot having custom query</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Spring Boot 具有自定义查询的 BigQuery</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/bigquery-and-spring-boot-169a778776ea?source=collection_archive---------3-----------------------#2022-08-20">https://blog.devgenius.io/bigquery-and-spring-boot-169a778776ea?source=collection_archive---------3-----------------------#2022-08-20</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/907201923a6588712765116efe9eda89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zqi07ESzU8TWLjt7LPJSkg.png"/></div></div></figure><p id="a1a2" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">BigQuery 是一个无服务器、高度可扩展且经济高效的多云数据仓库，旨在实现业务敏捷性。<br/>它规定:</p><ul class=""><li id="b87f" class="kt ku in jx b jy jz kc kd kg kv kk kw ko kx ks ky kz la lb bi translated">以最快的速度实时分析大型数据集</li><li id="f797" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">使用机器学习的商业分析</li><li id="0243" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">与可视化工具集成</li><li id="d8ee" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">高安全性、高可靠性、高可扩展性</li></ul><blockquote class="lh li lj"><p id="adc0" class="jv jw lk jx b jy jz ka kb kc kd ke kf ll kh ki kj lm kl km kn ln kp kq kr ks ig bi translated"><em class="in">在本主题中，我们将介绍使用 Maven 集成 BigQuery 和 spring boot。</em></p></blockquote><p id="77e1" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">首先，我们需要一个来自谷歌云控制台的服务帐户来建立与应用程序的连接。每个应用程序都有自己的服务帐户。服务帐户让 BigQuery 知道应用程序是可信的，可以在其上运行作业。</p><blockquote class="lh li lj"><p id="0c49" class="jv jw lk jx b jy jz ka kb kc kd ke kf ll kh ki kj lm kl km kn ln kp kq kr ks ig bi translated"><strong class="jx io">创建服务账户:</strong></p></blockquote><p id="eece" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">进入<a class="ae lo" href="https://console.cloud.google.com/iam-admin/serviceaccounts" rel="noopener ugc nofollow" target="_blank">服务账户页面</a>，点击“创建服务账户”。</p><figure class="lq lr ls lt gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi lp"><img src="../Images/28cd317fe3e75143e70e93f7b432cf32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BTBhKbNll2rjdFTYAXFJSw.png"/></div></div></figure><p id="491d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在，我们可以进入服务帐户的“Keys”选项卡来创建一个密钥。</p><figure class="lq lr ls lt gt jo gh gi paragraph-image"><div class="gh gi lu"><img src="../Images/077670495e53b5d51a6dd7999f56c5b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1086/format:webp/1*Gi1X1pvhAhIbwPPGH6cC7A.png"/></div></figure><p id="9d20" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在这之后，我们将能够以 JSON 文件的形式下载这个密钥。我们将在我们的 Spring boot 应用程序中使用它。</p><blockquote class="lh li lj"><p id="b81f" class="jv jw lk jx b jy jz ka kb kc kd ke kf ll kh ki kj lm kl km kn ln kp kq kr ks ig bi translated"><strong class="jx io">在应用中实施</strong></p></blockquote><p id="8883" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io"> a)添加 Maven 依赖关系</strong></p><pre class="lq lr ls lt gt lv lw lx ly aw lz bi"><span id="f6c3" class="ma mb in lw b gy mc md l me mf">&lt;dependency&gt;<br/>    &lt;groupId&gt;com.google.cloud&lt;/groupId&gt;<br/>    &lt;artifactId&gt;google-cloud-bigquery&lt;/artifactId&gt;<br/>&lt;/dependency&gt;</span></pre><p id="2482" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io"> b)使用 BigQuery 创建连接类</strong></p><p id="436e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在这个类中，我们将使用下面的云配置创建连接对象</p><p id="d920" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">a)在创建服务帐户时从 Google cloud 下载的 JSON 文件。</p><p id="cb38" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">b) BigQuery 项目 Id。</p><pre class="lq lr ls lt gt lv lw lx ly aw lz bi"><span id="7abe" class="ma mb in lw b gy mc md l me mf"><a class="ae lo" href="http://twitter.com/Component" rel="noopener ugc nofollow" target="_blank">@Component</a><br/>public class BigQueryUtil {</span><span id="3721" class="ma mb in lw b gy mg md l me mf">public static GoogleCredentials getCreds(){<br/>        GoogleCredentials credentials = null;</span><span id="dd8d" class="ma mb in lw b gy mg md l me mf">File file = new File("&lt;path&gt;/&lt;downloaded json file&gt;"); // bigquery.json<br/>        String absolutePath = file.getAbsolutePath();<br/>        <br/>        final File credentialsPath = new File(absolutePath);<br/>        try (FileInputStream serviceAccountStream = new FileInputStream(credentialsPath)) {<br/>            credentials = ServiceAccountCredentials.fromStream(serviceAccountStream);<br/>            <br/>        }catch(Exception e) {<br/>        }<br/>        return credentials;<br/>        <br/>    }<br/>    <br/>    public static BigQuery getConnection() {<br/>        BigQuery bigquery = null;<br/>        try {<br/>            bigquery = BigQueryOptions.newBuilder().setProjectId(&lt;Project id&gt;).setCredentials(getCreds()).build().getService();<br/>        } catch (Exception e) {<br/>       <br/>        }<br/>        return bigquery;<br/>    }</span><span id="e13b" class="ma mb in lw b gy mg md l me mf">}</span></pre><p id="dafd" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io"> c)创建服务类以使用连接类</strong></p><p id="710c" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在这堂课中，我们将使用下面的云配置</p><p id="8dc1" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">a)大查询数据集。</p><p id="2f47" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">b)数据集内的 BigQuery 表。</p><pre class="lq lr ls lt gt lv lw lx ly aw lz bi"><span id="c6a1" class="ma mb in lw b gy mc md l me mf"><a class="ae lo" href="http://twitter.com/Service" rel="noopener ugc nofollow" target="_blank">@Service</a><br/>public class BigQueryServiceImpl {<br/>    <br/>    private static final String dataset = &lt;data set&gt;;<br/>    private static final String table = &lt;table&gt;;</span><span id="b90f" class="ma mb in lw b gy mg md l me mf">public void run(List&lt;String&gt; records) {<br/>        InsertAllRequest insertAllRequest = null;<br/>        String datasetId = dataset;<br/>        String tableId = table;<br/>        Builder bld =  InsertAllRequest.newBuilder(datasetId, tableId);<br/>        for(String record:records) {<br/>            insertAllRequest = getInsertRequest(bld, record);<br/>        }<br/>        if(insertAllRequest!=null) {<br/>            pushObBG(insertAllRequest);<br/>        }<br/>    }<br/>    <br/>    <br/>    <br/>    public void pushObBG(InsertAllRequest record) {<br/>        try {<br/>            BigQuery bigquery = BigQueryUtil.getConnection();<br/>            InsertAllRequest insertAllRequest = record;<br/>            InsertAllResponse bresponse = bigquery.insertAll(insertAllRequest);<br/>        }catch(Exception e) {<br/>        }<br/>        return;<br/>    }</span><span id="d8e8" class="ma mb in lw b gy mg md l me mf">private static InsertAllRequest getInsertRequest(Builder bld, String record) {<br/>        return bld.addRow(getRow(record))<br/>        .build();<br/>    }<br/>    <br/>    private static Map&lt;String, Object&gt; getRow(String record) {<br/>       JSONObject respObject = new JSONObject(record);<br/>        String msg = StringUtils.isNotBlank(respObject.get("msg").toString()) ? respObject.get("msg").toString() : "";<br/>        String aptm = StringUtils.isNotBlank(respObject.get("aptm").toString()) ? respObject.get("aptm").toString() : "";<br/>        String apv = StringUtils.isNotBlank(respObject.get("apv").toString()) ? respObject.get("apv").toString() : "";<br/>        Map&lt;String, Object&gt; rowMap = new HashMap&lt;String, Object&gt;();<br/>        Long aptmL = Long.parseLong(aptm);<br/>        String time = DateUtil.convertLongToDateTime(aptmL*1000);<br/>        rowMap.put("api_version", apv);<br/>        rowMap.put("msg", msg);<br/>        rowMap.put("app_time", time);<br/>        return rowMap;<br/>    }</span><span id="964c" class="ma mb in lw b gy mg md l me mf">}</span></pre><p id="5f0b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们将上面的代码分为三个部分</p><ol class=""><li id="ea87" class="kt ku in jx b jy jz kc kd kg kv kk kw ko kx ks mh kz la lb bi translated">使用数据集和表创建构建器实例。</li><li id="1183" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks mh kz la lb bi translated">在生成器实例上准备插入请求。</li><li id="ee5f" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks mh kz la lb bi translated">使用 insertAll 保存 BigQuery 上的数据。</li></ol><p id="e9da" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">要检查不同类型的查询操作，我们可以去<em class="lk">https://cloud.google.com/bigquery/docs/samples/</em></p><p id="7228" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">仅此而已。我们现在可以使用 BigQuery 快速保存和获取大量数据。</p></div></div>    
</body>
</html>