# NodeJS ä¸­çš„å¹¶è¡Œæ‰§è¡Œ

> åŸæ–‡ï¼š<https://blog.devgenius.io/parallel-execution-in-nodejs-3fd40f30ee14?source=collection_archive---------3----------------------->

![](img/b31021cd2a7267495f593815f3ec4393.png)

NodeJS æ˜¯ JavaScript çš„è¿è¡Œæ—¶ç¯å¢ƒã€‚å®ƒæ˜¯æœåŠ¡å™¨ç«¯å’Œå•çº¿ç¨‹çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¸Œæœ›å¼‚æ­¥å¹¶è¡Œåœ°åšäº‹ã€‚

ç°åœ¨ï¼ŒNode ä½¿ç”¨äº†å‡ ä¸ªçº¿ç¨‹ï¼Œåªæœ‰ä¸€ä¸ªæ‰§è¡Œçº¿ç¨‹ï¼Œå¹¶ä¸”åŠ å…¥äº†å¾ˆå¤šä¸œè¥¿æ¥ä½¿å®ƒå¼‚æ­¥ï¼Œæ¯”å¦‚é˜Ÿåˆ—å’Œ libuv åº“ã€‚

ä½¿èŠ‚ç‚¹ç¨‹åºå¼‚æ­¥çš„æœ€åŸºæœ¬çš„æ–¹æ³•æ˜¯ä½¿ç”¨å›è°ƒã€‚ç„¶è€Œï¼Œæœ‰å¾ˆå¤šåœ°æ–¹å¯èƒ½å‡ºé”™ï¼Œæˆ‘æƒ³è®¨è®ºçš„æ˜¯ä½¿ç”¨æ‰¿è¯ºæ¥è·å¾—æ›´æµç•…çš„ç»“æœã€‚

å›è°ƒå¯ä»¥å¾ˆå®¹æ˜“åœ°è½¬æ¢ä¸ºæ‰¿è¯ºï¼Œå°±åƒå†…ç½®çš„ promisify ä¸€æ ·ï¼Œä½¿ç”¨æ‰¿è¯ºå¯ä»¥ä½¿æ‚¨çš„ä»£ç æ›´æ˜“äºç®¡ç†ï¼Œå¹¶æœ‰åŠ©äºé¿å…å›è°ƒåœ°ç‹±ã€‚

# ä»€ä¹ˆæ˜¯å¼‚æ­¥ï¼Ÿ

å¼‚æ­¥åŸºæœ¬ä¸Šæ„å‘³ç€æˆ‘ä»¬å¯ä»¥è®©äº‹ä»¶å’Œå‡½æ•°ç‹¬ç«‹äºä¸»æ‰§è¡Œçº¿ç¨‹è¿è¡Œï¼Œè¿™æ ·æˆ‘ä»¬çš„çº¿ç¨‹å°±ä¸éœ€è¦ç­‰å¾…äº‹ä»¶å®Œæˆæ‰èƒ½ç»§ç»­è¿è¡Œã€‚ç„¶åï¼Œæˆ‘ä»¬æœ‰å›è°ƒæˆ–å¤„ç†ç¨‹åºæ¥å¤„ç†ç‹¬ç«‹äºä¸»çº¿ç¨‹è¿è¡Œçš„äº‹ä»¶çš„å“åº”

*å³*

```
fetch(file).then(console.log)
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä½¿ç”¨ fetch() API(ä¸€ä¸ªåŸºäº Promise çš„ XMLHttpRequest ç‰ˆæœ¬)æ¥è·å–ä¸€äº›æ•°æ®ï¼Œå½“æ”¶åˆ°æ¥è‡ªè°ƒç”¨çš„å“åº”æ—¶ï¼Œæˆ‘å°†å®ƒè®°å½•åˆ°æ§åˆ¶å°ã€‚

å½“ fetch() API è¿è¡Œæ—¶ï¼Œä¸»æ‰§è¡Œçº¿ç¨‹çš„å…¶ä½™éƒ¨åˆ†ä¹Ÿå°†ç»§ç»­è¿è¡Œï¼Œç›´åˆ°å®ƒå®Œæˆï¼Œæˆ‘ä»¬æ‰ä¸ä¼šåœç•™åœ¨è¿™ä¸€è¡Œã€‚

# è®©æˆ‘ä»¬ç¼–ç 

æˆ‘ä»¬çš„è®¾ç½®å°†éå¸¸ç®€å•ã€‚æ˜¾ç„¶ï¼Œæ‚¨éœ€è¦å®‰è£…èŠ‚ç‚¹ï¼›æˆ‘ä¼šç­‰â€¦

æ˜ç™½äº†å—ï¼Ÿæ¥ä¸‹æ¥åˆ›å»ºæ‚¨çš„é¡¹ç›®ç›®å½•ï¼Œåœ¨æ‚¨æœ€å–œæ¬¢çš„ç¼–è¾‘å™¨ä¸­æ‰“å¼€å®ƒ(æç¤º:VSCode)å¹¶æ‰“å¼€ä¸€ä¸ªæ–°æ–‡ä»¶ï¼Œæˆ‘ä»¬å°†ä»–å‘½åä¸º index.jsã€‚

æˆ‘ä»¬å”¯ä¸€å‰©ä¸‹è¦åšçš„äº‹æ˜¯ã€‚

æƒ³çŸ¥é“è¿›åº¦æ¡æ˜¯å¦‚ä½•åœ¨ç»ˆç«¯ä¸­å‡ºç°çš„å—ï¼Ÿlog-update æ˜¯ä¸€ä¸ªå¾ˆæ£’çš„åŒ…ï¼Œå®ƒç»™äº†æˆ‘ä»¬è¿™ç§èƒ½åŠ›ï¼Œæˆ‘ä»¬å¯ä»¥â€œæ›´æ–°â€ä¸€ä¸ªè¿›åº¦æ¡ï¼Œè€Œä¸ç”¨åœ¨ç»ˆç«¯ä¸­çœ‹åˆ°å®ƒçš„æ¯ä¸€æ¬¡è¿­ä»£ã€‚

æ‰€ä»¥ï¼Œè®©æˆ‘ä»¬åˆ›é€ æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªæ‰¿è¯ºã€‚

```
const delay = (seconds, fn) => {
    setTimeout(fn, seconds*1000);
}

delay(1, () => {
    console.log('one second');
})
```

ä¸ï¼Œè¿™ä¸æ˜¯ä¸€ä¸ªæ‰¿è¯ºï¼Œä½†æˆ‘ä»¬å¿…é¡»é¦–å…ˆæ˜ç™½æˆ‘ä»¬æƒ³è¦å®ç°ä»€ä¹ˆã€‚ä¸Šé¢çš„ä»£ç åˆ›å»ºäº†ä¸€ä¸ªå»¶è¿Ÿå‡½æ•°ï¼Œå®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ•°å­—å’Œä¸€ä¸ªå›è°ƒå‡½æ•°ã€‚delay å‡½æ•°ç„¶åè®¾ç½®ä¸€ä¸ªè®¡æ—¶å™¨ï¼Œä½¿ç”¨æˆ‘ä»¬ä¼ é€’ç»™å®ƒçš„æ•°å­—ä½œä¸ºè®¡æ—¶å™¨å»¶è¿Ÿçš„ç§’æ•°ï¼Œå¹¶å°†æˆ‘ä»¬çš„å›è°ƒä¼ é€’ç»™æ‰€è¿°è®¡æ—¶å™¨ã€‚

*æ³¨æ„:setTimout æœ¬èº«æ˜¯ä¸€ç§å¼‚æ­¥ç¼–ç¨‹çš„æ–¹æ³•ï¼Œè€ƒè™‘åˆ° setTimout å‡½æ•°åªæ˜¯æµè§ˆå™¨å®šæ—¶å™¨åŠŸèƒ½çš„ä¸€ä¸ªæ ‡ç­¾ï¼Œå®ƒè®¾ç½®äº†ä¸€ä¸ªåœ¨æˆ‘ä»¬çš„ä¸»æ‰§è¡Œçº¿ç¨‹æˆ–å…¨å±€è°ƒç”¨å †æ ˆå®Œæˆè¿è¡Œåè¿è¡Œçš„å›è°ƒã€‚*

åœ¨æˆ‘ä»¬å®šä¹‰äº† delay ä¹‹åï¼Œæˆ‘ä»¬è°ƒç”¨å®ƒï¼Œå°†ç§’æ•°è®¾ç½®ä¸º 1ï¼Œå¹¶ä¼ é€’ä¸€ä¸ªè¦èµ‹ç»™ fn çš„å‡½æ•°å®šä¹‰ã€‚è¿™ä¸ªå®šä¹‰å°†è¿è¡Œ`console.log('one second')`

å¦‚æœæˆ‘ä»¬æƒ³è¦åˆ›å»ºæ›´å¤šçš„å»¶è¿Ÿï¼Œæˆ–è€…æŒ‰é¡ºåºè¿è¡Œæ›´å¤šçš„å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥åƒè¿™æ ·åµŒå¥—å®ƒä»¬:

```
console.log('starting delay')
delay(2, ()=>{
    console.log('two seconds');
    delay(1, ()=>{
        console.log('three seconds');
        delay(1, ()=>{
            console.log('four seconds')
        })
    })
})
```

æˆ‘ä»¬ç§°è¿™ç§å›è°ƒä¸ºåœ°ç‹±ï¼Œè¿™æ˜¯æœ‰é“ç†çš„ã€‚é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•é¿å…è¿™ç§æƒ…å†µå‘¢ï¼Ÿæ‰¿è¯ºã€‚

åœ¨ ES6 ä¸­ï¼Œæˆ‘ä»¬è¢«æä¾›äº†æ‰¿è¯ºï¼Œå½“è¢«æ‰§è¡Œæ—¶ï¼Œä¼šåšä¸¤ä»¶äº‹ã€‚

è®©æˆ‘ä»¬é‡æ–°çœ‹çœ‹ fetch() API:

```
const data = fetch('api/uri');
data.then(...)
```

å½“æˆ‘ä»¬è¿è¡Œ fetch()æ—¶ï¼Œå®ƒè¿”å›ä¸€ä¸ª Promise å¯¹è±¡ï¼Œè¿™æ˜¯ä¸€ä¸ªå…è®¸æˆ‘ä»¬çŸ¥é“æˆ‘ä»¬æœ‰ä¸€äº›äº‹æƒ…æ‚¬è€Œæœªå†³çš„å“åº”ï¼Œè€Œä¸æ˜¯åƒ ES6 ä¹‹å‰é‚£æ ·è¢«è’™åœ¨é¼“é‡Œï¼Œå®ƒè¿˜é€šè¿‡ web æµè§ˆå™¨å‘å‡ºç½‘ç»œè¯·æ±‚ã€‚ä¸€æ—¦è¯·æ±‚å¾—åˆ°å“åº”ï¼Œå®ƒå°±ä¼šç”¨æ•°æ®å¡«å…… Promise å¯¹è±¡ã€‚

å› æ­¤ï¼Œç®€è€Œè¨€ä¹‹ï¼Œå®ƒåœ¨è¿è¡Œå…¶æ ¸å¿ƒåŠŸèƒ½çš„åŒæ—¶è¿”å›ä¸€ä¸ªå“åº”ã€‚

è®°ä½è¿™ä¸€ç‚¹ï¼Œè®©æˆ‘ä»¬ä¿®æ­£æˆ‘ä»¬çš„å»¶è¿Ÿå‡½æ•°:

```
const delay = (sec) => new Promise((resolve, reject) => {
    setTimeout(resolve('me last'), sec*1000);
}) 
â€‹
delay(1).then(console.log)
console.log('me first')
```

æˆ‘ä»¬å°† delay å®šä¹‰ä¸ºä¸€ä¸ªç®­å¤´å‡½æ•°ï¼Œå®ƒè¿è¡Œ`new Promise`åˆ›å»ºä¸€ä¸ª promise å¯¹è±¡ï¼Œç°åœ¨åˆ†é…ç»™æ ‡ç­¾ delayã€‚Delay å°†æ¥å—ç§’æ•°çš„å‚æ•°ï¼Œæ­£å¦‚æ‚¨æ‰€çœ‹åˆ°çš„ï¼Œå‡½æ•°å®šä¹‰æ­£åœ¨è¢«ä¼ é€’ç»™`new Promise`ã€‚

è¿™ä¸ªå‡½æ•°å°±æ˜¯ executorï¼Œå®ƒåŸºæœ¬ä¸Šæ˜¯è‡ªåŠ¨è¿è¡Œçš„ï¼Œä¸€æ—¦æœ‰ç»“æœï¼Œå°±è°ƒç”¨ resolve æˆ– rejectã€‚Resolve å’Œ reject æ˜¯ JavaScript æä¾›çš„å›è°ƒå‡½æ•°ï¼Œå®ƒå°†è¿”å›ä¸€æ¡æ¶ˆæ¯ï¼Œæ— è®ºæ˜¯é”™è¯¯è¿˜æ˜¯æˆåŠŸã€‚

åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æ‰€åšçš„åªæ˜¯è®¾ç½®ä¸€ä¸ªè®¡æ—¶å™¨å¹¶è®°å½•ä¸€ä¸ªæˆåŠŸæ¶ˆæ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬å¹¶ä¸çœŸæ­£éœ€è¦ reject å›è°ƒã€‚å½“æˆ‘ä»¬è°ƒç”¨`.then()`æ—¶ï¼Œæˆ‘ä»¬ä¼šè‡ªåŠ¨ä¼ é€’è¿”å›çš„æ¶ˆæ¯â€œæˆ‘åœ¨æœ€åâ€ï¼Œç„¶åå°†å…¶è®°å½•åˆ°æ§åˆ¶å°ã€‚åœ¨æ§åˆ¶å°ä¸­ï¼Œæ‚¨å°†çœ‹åˆ°:

```
me first
me last
```

å°½ç®¡ delay æ˜¯å…ˆè¿è¡Œçš„ï¼Œä½†æˆ‘ä»¬ä¸å¿…ç­‰å¾…å®ƒå®Œæˆï¼Œæˆ‘ä»¬ç»§ç»­æ‰§è¡Œçº¿ç¨‹å¹¶è®°å½•â€œme firstâ€ã€‚

å¥½å§ï¼Œæˆ‘å·²ç»è¯´äº†å¾ˆå¤šå…³äºå¼‚æ­¥çš„äº‹æƒ…ã€‚è®©æˆ‘ä»¬çœ‹çœ‹ä»£ç ï¼Œå¯¹å—ï¼Ÿ

index.js:

```
const log_ = require('log-update');
â€‹
const toX = () => "X"
â€‹
const delay = (sec) => new Promise((resolve) => {
    setTimeout(resolve, sec*1000);
});
â€‹
let promises = [
  delay(4),
  delay(6),
  delay(4),
  delay(3),
  delay(5),
  delay(7),
  delay(9),
  delay(10),
  delay(3),
  delay(5)
];
â€‹
class PromiseQueue{
  constructor(promises=[], concurrent=1){
    this.concurrent = concurrent;
    this.total = promises.length;
    this.todo = promises;
    this.running = [];
    this.complete = [];
  }
â€‹
  get runAnother(){
    return (this.running.length < this.concurrent) && this.todo.length;
  }
â€‹
  graphTasks(){
    let {todo, running, complete} = this;
    log_(`
    todo: [${todo.map(toX)}]
    running: [${running.map(toX)}]
    complete: [${complete.map(toX)}]
    `)
  }
â€‹
  runTasks(){
    while(this.runAnother){
      let promise = this.todo.shift();
      promise.then(()=>{
        this.complete.push(this.running.shift());
        this.graphTasks()
        this.runTasks()
      })
      this.running.push(promise);
      this.graphTasks()
    }
  }
}
â€‹
â€‹
const queue = new PromiseQueue(promises, 2);
queue.runTasks();
```

æ§åˆ¶å°:

```
todo: [X]
running: [X,X]
complete: [X,X,X,X]
```

é‚£ä¹ˆâ€¦å‘ç”Ÿäº†ä»€ä¹ˆäº‹ï¼Ÿ

å—¯ï¼Œæˆ‘ä»¬é¦–å…ˆå¯¼å…¥æˆ‘ä»¬æ–¹ä¾¿çš„`log-update`åŒ…ã€‚å®Œæˆäº†ã€‚

ç„¶åï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªç®€å•çš„å•è¡Œç®­å¤´å‡½æ•°ï¼ŒåŸºæœ¬ä¸Šåªæ˜¯è¿”å›ä¸€ä¸ª xã€‚

æˆ‘ä»¬çš„å»¶æœŸæ‰¿è¯ºäº§ç”Ÿäº†ã€‚å¤ªæ£’äº†ã€‚

åœ¨é‚£ä¹‹åï¼Œäº‹æƒ…å¼€å§‹å˜å¾—æ–°ã€‚æˆ‘ä»¬åˆ†æ‰‹å§ã€‚

ç¬¬ä¸€éƒ¨åˆ†å¹¶ä¸å¯æ€•ï¼Œæˆ‘ä»¬åªæ˜¯åˆ—å‡ºäº†å»¶è¿Ÿè°ƒç”¨çš„åˆ—è¡¨ã€‚æˆ‘ä»¬æŠŠè¿™ä¸ªåˆ—è¡¨è´´åœ¨ä¸€ä¸ªå«åšæ‰¿è¯ºçš„æ ‡ç­¾ä¸Šã€‚

```
let promises = [
  delay(1),
  delay(3),
  delay(2),
  delay(5),
  delay(3),
  delay(9),
  delay(11)
];
```

ç°åœ¨ï¼ŒES6 ä¸­ä¹Ÿå¼•å…¥äº†ä¸‹ä¸€ä½ï¼Œclass å…³é”®å­—ã€‚ä½†æ˜¯ï¼Œå¦‚æœä½ ç†Ÿæ‚‰ ES6 ä¹‹å‰çš„é¢å‘å¯¹è±¡ç¼–ç¨‹ï¼Œé‚£ä¹ˆä½ åº”è¯¥ä½¿ç”¨â€œä¼ªç±»â€ã€‚

```
function Car(make, color){
    this.name = "car";
    this.make = make;
    this.color = color
}
let toyotaSedan = new Car('toyota', 'red');
```

è¿™ç§ä¼ªç±»ç»“æ„å…è®¸æˆ‘ä»¬åœ¨ ES6 ä¹‹å‰ä½¿ç”¨å‡½æ•°æ„å»ºç±»å¯¹è±¡ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬ä½¿ç”¨ class å…³é”®å­—å’Œä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œä½†æ˜¯æˆ‘ç›¸ä¿¡å®ƒåªæ˜¯ä¸€ä¸ªå¹Œå­ï¼Œåœ¨å¼•æ“ç›–ä¸‹å·¥ä½œæ˜¯ä¸€æ ·çš„ğŸ¤·â€â™‚ï¸.

æˆ‘ä»¬çš„ PromiseQueue ç±»:

```
class PromiseQueue{
  constructor(promises=[], concurrent=1){
    this.concurrent = concurrent;
    this.total = promises.length;
    this.todo = promises;
    this.running = [];
    this.complete = [];
  }
â€‹
  get runAnother(){
    return (this.running.length < this.concurrent) && this.todo.length;
  }
â€‹
  graphTasks(){
    let {todo, running, complete} = this;
    log_(`
    todo: [${todo.map(toX)}]
    running: [${running.map(toX)}]
    complete: [${complete.map(toX)}]
    `)
  }
â€‹
  runTasks(){
    while(this.runAnother){
      let promise = this.todo.shift();
      promise.then(()=>{
        this.complete.push(this.running.shift());
        this.graphTasks()
        this.runTasks()
      })
      this.running.push(promise);
      this.graphTasks()
    }
  }
}
â€‹
```

æˆ‘ä»¬ä½¿ç”¨æ„é€ å‡½æ•°æ¥åˆ†é…å±æ€§ã€‚æˆ‘ä»¬éœ€è¦ï¼Œå¹¶å‘ï¼Œæ€»è®¡ï¼Œå¾…åŠäº‹é¡¹ï¼Œè¿è¡Œå’Œå®Œæˆã€‚ç”±å‚æ•°åˆ†é…çš„å”¯ä¸€æ‰€æœ‰è€…æ˜¯ todoã€total å’Œ concurrentã€‚Running å’Œ complete å°†åœ¨æˆ‘ä»¬ç±»ä¸­çš„æ–¹æ³•è¿è¡Œè¿‡ç¨‹ä¸­æ›´æ–°ã€‚

æ‰¿è¯ºé»˜è®¤ä¸ºç©ºæ•°ç»„å’Œå¹¶å‘

`runAnother()`å¦‚æœæˆ‘ä»¬åœ¨ todo ä¸­è¿˜æœ‰å‰©ä½™å†…å®¹ï¼Œå¹¶ä¸”è¿è¡Œåˆ—è¡¨çš„é•¿åº¦å°äºæŒ‡å®šçš„å¹¶å‘å€¼ï¼Œåˆ™è¿”å›ä¸€ä¸ªå¸ƒå°”ç»“æœã€‚

ä½¿ç”¨æ—¥å¿—æ›´æ–°æ¥è®°å½•æ¯ä¸ªåˆ—è¡¨çš„è¿›åº¦ã€æˆ‘ä»¬çš„å¾…åŠäº‹é¡¹ã€æˆ‘ä»¬è¿è¡Œäº†å¤šå°‘ä»¥åŠå®Œæˆäº†å¤šå°‘ã€‚

åªè¦æœ‰ä»»åŠ¡è¦åšï¼Œå®ƒå°±ä¼šç»§ç»­è¿è¡Œï¼Œå®ƒéå†æ‰¿è¯ºåˆ—è¡¨ï¼Œè¿è¡Œæ¯ä¸€ä¸ªæ‰¿è¯ºï¼Œå¹¶æ¨åŠ¨å®ƒä»¬è¿è¡Œï¼Œç„¶åå®Œæˆï¼Œä¸€æ¬¡ä¸¤ä¸ªã€‚

æœ€åï¼Œæˆ‘ä»¬åˆ›å»ºç±»å¹¶è°ƒç”¨ runTasks:

```
const queue = new PromiseQueue(promises, 2);
queue.runTasks();
```

å¸Œæœ›ä½ è·Ÿç€åšäº†ï¼Œå½“ä½ è¿è¡Œå®ƒçš„æ—¶å€™ï¼Œä½ ä¼šåœ¨ä½ çš„ç»ˆç«¯ä¸Šçœ‹åˆ°ä¸€ä¸ªå¾ˆé…·çš„å°è¿›åº¦å›¾ï¼Œå®ƒä¼šéšç€ä»»åŠ¡çš„å®Œæˆè€Œå®æ—¶æ›´æ–°ã€‚

æˆ‘å¸Œæœ›ä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Œå®ƒç”šè‡³æœ‰ä¸€ç‚¹ç‚¹å¸®åŠ©ã€‚æˆ‘æ˜¯æ•™ç¼–ç¨‹çš„ï¼Œæ‰€ä»¥è¯·åŸè°…æˆ‘åšäº†è¿™ä¹ˆå¤šåç»­è§£é‡Šï¼Œè¿™äº›è§£é‡Šå¯èƒ½ä¸å¼‚æ­¥ç¼–ç¨‹æ²¡æœ‰å¤ªå¤šå…³ç³»ã€‚