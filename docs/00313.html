<html>
<head>
<title>Camera preview and a QR-code Scanner in SwiftUI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">SwiftUI 中的相机预览和二维码扫描仪</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/camera-preview-and-a-qr-code-scanner-in-swiftui-48b111155c66?source=collection_archive---------0-----------------------#2020-06-02">https://blog.devgenius.io/camera-preview-and-a-qr-code-scanner-in-swiftui-48b111155c66?source=collection_archive---------0-----------------------#2020-06-02</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="d568" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在这篇文章中，我将指导你使用 SwiftUI 为 iOS 创建一个二维码扫描仪。</p><p id="1b59" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们还将看到如何创建摄像头馈送的预览，并将其用作 SwiftUI 视图。最终结果将与模拟器、Xcode 的实时预览以及 UI 测试兼容！</p><h1 id="88d2" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated"><strong class="ak">什么是二维码？</strong></h1><p id="e431" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">QR 码代表快速响应码。它们包含少量信息，以计算机和移动设备可以理解的方式呈现。QR 码是一种 2D 条形码，称为矩阵码。存在一些变体，如阿兹特克代码或数据矩阵代码。二维码通常是这样的:</p><figure class="lm ln lo lp gt lq gh gi paragraph-image"><div class="gh gi ll"><img src="../Images/543325f2552d68422eed7ca3e4eabed2.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/format:webp/1*cRxUPmBgWWVCVJnE0d8p1Q.png"/></div><figcaption class="lt lu gj gh gi lv lw bd b be z dk translated">由<a class="ae lx" href="https://apps.apple.com/app/kodos/id1504012725" rel="noopener ugc nofollow" target="_blank"> Kodos </a>制作——一个漂亮的二维码制作应用程序</figcaption></figure><h1 id="36fb" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">入门指南</h1><p id="9928" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">让我们从在 Xcode 中创建新的 iOS 应用程序项目开始。您需要选择单视图应用程序模板，并确保用户界面技术设置为<strong class="jm io"> SwiftUI </strong>。</p><figure class="lm ln lo lp gt lq gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi ly"><img src="../Images/fba0afe6385180bfa94e698e681aff58.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gqg2xTj7-Ilg906E8JgppA.png"/></div></div><figcaption class="lt lu gj gh gi lv lw bd b be z dk translated">在 Xcode 中创建新的 Xcode 单视图应用程序</figcaption></figure><figure class="lm ln lo lp gt lq gh gi paragraph-image"><div class="gh gi md"><img src="../Images/ef681c25a92905adbc33634a945076cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:624/format:webp/1*4iLAiC48YO1zb0WCa2hzhA.png"/></div><figcaption class="lt lu gj gh gi lv lw bd b be z dk translated">运行项目以确保一切都已设置好</figcaption></figure><h1 id="8bb6" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">准备布局</h1><p id="6d6f" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">扫描仪屏幕的布局可能取决于您特定的应用程序用例，因此我们将创建一个非常简单的视图，允许我们查看相机预览、任何检测到的 QR 码的值以及一个开关手电筒的按钮。</p><figure class="lm ln lo lp gt lq gh gi paragraph-image"><div class="gh gi md"><img src="../Images/740584c377125069d13eb292caf892a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:624/format:webp/1*LwWfbHeQQSvh6hcTosNCZg.png"/></div></figure><p id="2764" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">创建 ScannerViewModel，它将保存视图的状态</p><figure class="lm ln lo lp gt lq"><div class="bz fp l di"><div class="me mf l"/></div></figure><p id="79e4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">扫描间隔是一个变量，它允许我们控制多长时间重新扫描一次二维码。如果我们想提供连续扫描功能，这是很有用的。</p><p id="c251" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><code class="fe mg mh mi mj b">torchIsOn</code>字段保存设备手电筒的当前状态。本教程假设手电筒总是可用的。</p><p id="d369" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><code class="fe mg mh mi mj b">lastQrCode</code>字段将保存最后检测到的 QR 码值的字符串值。当用户扫描时，该字段将更新为最后扫描的二维码。</p><p id="068b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">最后是一个函数<code class="fe mg mh mi mj b">onFoundQrCode</code>，每当检测到新的二维码时，我们的二维码扫描仪都会调用这个函数。</p></div><div class="ab cl mk ml hr mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ig ih ii ij ik"><p id="cde1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在让我们创建 ScannerView 布局</p><figure class="lm ln lo lp gt lq"><div class="bz fp l di"><div class="me mf l"/></div></figure><p id="d6e6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们将使用 ZStack 创建一个布局，显示相机视图的扫描仪将在后面看到，占据整个屏幕，在它的顶部，我们将布局一些界面元素，如带有最近扫描的二维码或手电筒按钮的气球。</p><h1 id="2cda" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">关于相机视图</h1><p id="e09d" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">我们将创建一个视图，显示来自设备摄像头的馈送。理想情况下，我们还希望能够使用 SwiftUI 定位摄像机视图。</p><p id="ca61" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们将要使用的大部分功能来自于<a class="ae lx" href="https://developer.apple.com/av-foundation/" rel="noopener ugc nofollow" target="_blank"> AVFoundation </a>框架。目前，它不提供任何现成的 SwiftUI 视图，我们将创建一个传统的 UIView，并将其作为一个 UIViewRepresentable 嵌入我们的 SwiftUI 应用程序中。</p><p id="9fe1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们将设置一个<code class="fe mg mh mi mj b">AVCaptureSession</code>，它将使用设备背面的摄像头作为输入，使用一个<code class="fe mg mh mi mj b">AVCaptureMetadataOutput</code>作为输出，允许我们接收从摄像头输入识别的元数据对象流。这些元数据对象就是我们要收集的实际二维码值。</p><p id="c59b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">由于我们将在 SwiftUI 布局中使用相机视图，如果实现与模拟器配合良好，这将是理想的(因此 SwiftUI 预览功能将工作)。由于模拟器缺少物理摄像机设备，我们将在摄像机视图中嵌入一个后备。</p><h1 id="32eb" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">代表</h1><p id="1066" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">代理将负责处理元数据输出，检查是否找到了 QR 码，并将该 QR 码值通知父视图。</p><figure class="lm ln lo lp gt lq"><div class="bz fp l di"><div class="me mf l"/></div></figure><p id="8d26" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">最值得注意的是，我们的委托对象将采用<code class="fe mg mh mi mj b">AVCaptureMetadataOutputObjectsDelegate</code>协议，以便监听在摄像机提要中检测到的新的元数据对象。</p><p id="2da1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">代理还将利用我们在视图模型中准备的扫描间隔。只要捕获会话处于活动状态，并且二维码图像在摄像机画面中，就会不断检测到新的元数据对象。为此，我们将跳过帧，每个扫描间隔只通知父视图一次。</p><h1 id="7e03" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">摄像机回顾</h1><p id="1cbd" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">相机预览是我们将要用来显示来自相机的实时反馈(或模拟器的模拟值)的<code class="fe mg mh mi mj b">UIView</code>。这是一个<code class="fe mg mh mi mj b">UIKit</code>视图，最终将在 SwiftUI 布局中使用<code class="fe mg mh mi mj b">UIViewRepresentable</code>呈现。</p><p id="47fa" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">该视图是为给定的<code class="fe mg mh mi mj b">AVCaptureSession</code>创建的，包括一个基于 CoreAnimation 的<code class="fe mg mh mi mj b">AVCaptureVideoPreviewLayer</code>，使我们能够预览摄像机会话的视觉输出。这就是用户最终将看到的“相机预览”。当相机不可用时，我们将用一个简单的<code class="fe mg mh mi mj b">UILabel</code>来代替视频预览，显示我们提供的模拟数据内容。</p><p id="8d69" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这意味着二维码扫描可以在 Xcode、模拟器或 UI 测试的预览或实时视图中“模拟”。</p><figure class="lm ln lo lp gt lq"><div class="bz fp l di"><div class="me mf l"/></div></figure><h1 id="dfeb" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">就快完成了，创建了 UIViewRepresentable</h1><p id="0691" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">我们需要的最后一部分是在 SwiftUI 中显示 CameraPreview 视图的方法。这可以通过实现框架提供的<code class="fe mg mh mi mj b">UIViewRepresentable</code>协议来实现。</p><p id="0e47" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">该协议的目的是让我们将 SwiftUI 状态和生命周期事件转换成 UIKit。例如，在 SwiftUI 视图中，当它们的状态改变时，它们经常被销毁和重新创建，而在 UIKit 中，UIView 通常被保存和更新。</p><p id="92da" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们最起码需要的是:</p><ul class=""><li id="89f5" class="mr ms in jm b jn jo jr js jv mt jz mu kd mv kh mw mx my mz bi translated">创建一个 CameraView 并将其与一个<code class="fe mg mh mi mj b">AVCaptureSession</code>相关联。</li><li id="b4dd" class="mr ms in jm b jn na jr nb jv nc jz nd kd ne kh mw mx my mz bi translated">检查我们是否在一个真实的设备上运行，如果是，请求访问摄像机的许可。</li></ul><p id="2b12" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><em class="nf">💡记得在</em> <code class="fe mg mh mi mj b"><em class="nf">Info.plist</em></code> <em class="nf">文件中添加</em> <code class="fe mg mh mi mj b"><em class="nf">NSCameraUsageDescription</em></code> <em class="nf">键，否则使用相机会导致死机。</em></p><ul class=""><li id="b195" class="mr ms in jm b jn jo jr js jv mt jz mu kd mv kh mw mx my mz bi translated">当 SwiftUI 视图更新时，我们需要确保 CameraView 也将更新它的布局。</li><li id="5f66" class="mr ms in jm b jn na jr nb jv nc jz nd kd ne kh mw mx my mz bi translated">当 SwiftUI 准备移除和销毁 QrCodeScannerView 时，我们需要正确地处置捕获会话。</li></ul><figure class="lm ln lo lp gt lq"><div class="bz fp l di"><div class="me mf l"/></div></figure><p id="4500" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让我们通过添加以下内容来调整 QrCodeScannerView:</p><ul class=""><li id="50d7" class="mr ms in jm b jn jo jr js jv mt jz mu kd mv kh mw mx my mz bi translated">请求允许使用摄像机的能力</li><li id="3e0d" class="mr ms in jm b jn na jr nb jv nc jz nd kd ne kh mw mx my mz bi translated">将 SwiftUI 视图中的扫描间隔设置为修改器的能力。</li><li id="0715" class="mr ms in jm b jn na jr nb jv nc jz nd kd ne kh mw mx my mz bi translated">设置模拟数据以便在模拟或 UI 测试期间使用的能力。</li><li id="63a5" class="mr ms in jm b jn na jr nb jv nc jz nd kd ne kh mw mx my mz bi translated">控制设备手电筒光线的能力。</li></ul><p id="ccdc" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">以下是扫描仪视图的完整实现:</p><figure class="lm ln lo lp gt lq"><div class="bz fp l di"><div class="me mf l"/></div></figure><h1 id="4f30" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">结束了</h1><p id="78db" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">现在我们可以在 SwiftUI 布局中使用 QrCodeScannerView。用以下内容替换文本视图:</p><pre class="lm ln lo lp gt ng mj nh ni aw nj bi"><span id="fec3" class="nk kj in mj b gy nl nm l nn no">QrCodeScannerView()<br/>.found(r: <strong class="mj io">self</strong>.viewModel.onFoundQrCode)<br/>.torchLight(isOn: <strong class="mj io">self</strong>.viewModel.torchIsOn)<br/>.interval(delay: <strong class="mj io">self</strong>.viewModel.scanInterval)</span></pre><p id="5e61" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">Tadaa🎉</p><figure class="lm ln lo lp gt lq gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi np"><img src="../Images/dc5fd37c18a3b54ffa7ffd699d0261b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v8gHjRixl1IBbcRVH4hq9w.png"/></div></div><figcaption class="lt lu gj gh gi lv lw bd b be z dk translated">向 macOS 的 Kodos 应用程序问好！</figcaption></figure><figure class="lm ln lo lp gt lq gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi nq"><img src="../Images/cfbdf1e6413458957d4ad5401531352f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w1u2BFvsj1WwmGdMLlEuhg.png"/></div></div></figure></div></div>    
</body>
</html>