<html>
<head>
<title>Examples of Analytical SQL functions in Data warehouse (Part 2)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">数据仓库中的分析 SQL 函数示例(第 2 部分)</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/examples-of-analytical-sql-functions-in-data-warehouse-part-2-baeaacca1b71?source=collection_archive---------8-----------------------#2022-12-23">https://blog.devgenius.io/examples-of-analytical-sql-functions-in-data-warehouse-part-2-baeaacca1b71?source=collection_archive---------8-----------------------#2022-12-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="8ff3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用示例数据进行操作！！</p><p id="6901" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本系列的第 1 部分的<a class="ae kl" rel="noopener ugc nofollow" target="_blank" href="/examples-of-analytical-sql-functions-in-data-warehouse-part-1-99794e0273d9">中，我们已经查看了</a><a class="ae kl" href="https://medium.com/dev-genius/important-sql-clauses-functions-in-data-engineering-and-analytics-85d8d84c2d78" rel="noopener">文章</a>中列出的函数。在本文中，我们将介绍更多正在运行的函数。我在 Redshift 上创建的表上执行这些查询，我将把模式和一些示例 insert 语句放在下面:</p><pre class="km kn ko kp gt kq kr ks bn kt ku bi"><span id="51b9" class="kv kw iq kr b be kx ky l kz la">create table users(<br/>userid integer not null,<br/>name varchar(255) not null,<br/>gender varchar(1) not null,<br/>weight decimal(8,2) encode delta32k,<br/>age integer not null,<br/>primary key(userid))<br/>distkey(gender)<br/>sortkey(age);<br/><br/>insert into users (userid, name, gender, age, weight) values (1, 'John Snow', 'M', 35, 61);<br/>insert into users (userid, name, gender, age, weight) values (2, 'Matt Hayden', 'M', 55, 95);<br/>insert into users (userid, name, gender, age, weight) values (3, 'Ricky Ponting', 'M', 49, 75);<br/>insert into users (userid, name, gender, age, weight) values (4, 'David Shepherd', 'M', 90, 80);<br/>insert into users (userid, name, gender, age, weight) values (5, 'Smriti Mandana', 'F', 26, 55);<br/>insert into users (userid, name, gender, age, weight) values (6, 'Sachin Tendulkar', 'M', 51, 66);<br/>insert into users (userid, name, gender, age, weight) values (7, 'Isa Guha', 'F', 41, 61);</span></pre><figure class="km kn ko kp gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="gh gi lb"><img src="../Images/2a835a2ac214cec744c26983a7e17435.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NgH785jE_Xe3NLke"/></div></div><figcaption class="lj lk gj gh gi ll lm bd b be z dk translated">照片由<a class="ae kl" href="https://unsplash.com/@gtomassetti?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">乔治·托马塞蒂</a>在<a class="ae kl" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="ebc6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> OVER，PARTITION BY，ORBER BY 和 ROWS: </strong></p><p id="3f58" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">虽然我在上一篇文章中已经提到了这一点，但我还是要把这一部分包括进来，为新读者提供一个背景。这些实际上并不是函数，而是表示 SQL 查询将以分析方式执行的重要关键字。通过组合使用这些关键字的函数，使分析查询更加有效。分析查询通常在数据集窗口上执行，而不是在整个数据集本身上执行。窗口是使用窗口规范(OVER 子句)定义的，它基于三个主要概念:</p><ul class=""><li id="2c51" class="ln lo iq jp b jq jr ju jv jy lp kc lq kg lr kk ls lt lu lv bi translated"><em class="lw">窗口分区，</em>形成多组行(PARTITION 子句)</li><li id="ea32" class="ln lo iq jp b jq lx ju ly jy lz kc ma kg mb kk ls lt lu lv bi translated"><em class="lw">窗口排序</em>，它定义了每个分区中行的顺序或序列(ORDER BY 子句)</li><li id="15ca" class="ln lo iq jp b jq lx ju ly jy lz kc ma kg mb kk ls lt lu lv bi translated"><em class="lw">窗口框架</em>，相对于每一行定义，进一步限制行的集合(行规范)</li></ul><p id="cd63" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们已经有了表、数据并知道了以分析方式使用查询的重要关键字，我们将看看一些函数:</p><p id="f260" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">等级:</strong>根据列的顺序提供等级。如果有并列的排名，那么它跳过这些数字。例:1、2、2、4、5 等。</p><p id="38bd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如:在上表中，如果我们想对所有用户的体重进行排名，那么我们可以看到用户 John 和 Isa 得到相同的排名，排名 3 被跳过。</p><pre class="km kn ko kp gt kq kr ks bn kt ku bi"><span id="402d" class="kv kw iq kr b be kx ky l kz la">SELECT name, weight, gender, RANK() OVER (ORDER BY weight) FROM users;</span></pre><figure class="km kn ko kp gt lc gh gi paragraph-image"><div class="gh gi mc"><img src="../Images/54e77405ca9a10a63d55a174307abb07.png" data-original-src="https://miro.medium.com/v2/resize:fit:424/format:webp/1*iqcJWDcmDq4agg3iMDdHAw.png"/></div></figure><p id="9251" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> DENSE_RANK: </strong>类似于 RANK 但是如果有平局它不会跳过 RANK。例:1、2、2、3、4 等。</p><p id="56dc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如:同样从上表中，如果我们想使用密集排名函数对所有用户的权重进行排名，那么我们可以看到用户 John 和 Isa 获得相同的排名，下一个用户排名为 3，因为该函数没有跳过数字。</p><pre class="km kn ko kp gt kq kr ks bn kt ku bi"><span id="62da" class="kv kw iq kr b be kx ky l kz la">SELECT name, weight, gender, DENSE_RANK() OVER (ORDER BY weight) FROM users;</span></pre><figure class="km kn ko kp gt lc gh gi paragraph-image"><div class="gh gi md"><img src="../Images/3ada3716799ec132438366e152113fda.png" data-original-src="https://miro.medium.com/v2/resize:fit:490/format:webp/1*Z34Up8I2bltBrZOpcyu0PQ.png"/></div></figure><p id="c6f8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> FIRST_VALUE </strong>:检索符合分区边界的列中的第一个值。应与 ORDER BY 一起使用。</p><p id="b84f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例:从上面的数据中，我们可以找到性别分区中权重最高的第一个用户，如下所示。请注意，在 redshift 中，我们不得不使用 rows between 子句提到窗口框架。</p><pre class="km kn ko kp gt kq kr ks bn kt ku bi"><span id="f576" class="kv kw iq kr b be kx ky l kz la">SELECT name, weight, gender, FIRST_VALUE(name) OVER (PARTITION BY gender ORDER BY weight desc rows between UNBOUNDED PRECEDING and UNBOUNDED FOLLOWING) FROM users;</span></pre><figure class="km kn ko kp gt lc gh gi paragraph-image"><div class="gh gi me"><img src="../Images/8256e5a1711a4271f20cbf317082a067.png" data-original-src="https://miro.medium.com/v2/resize:fit:498/format:webp/1*ZVMfD7HOcXRZdiudcpJBYw.png"/></div></figure><p id="f65b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> LAST_VALUE </strong>:检索符合分区边界的列中的最后一个值。应与 ORDER BY 一起使用。</p><p id="893d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例:从上面的数据中，我们可以找到性别分区中权重最低的最后一个用户，如下所示。请注意，在 redshift 中，我们不得不使用 rows between 子句提到窗口框架。</p><pre class="km kn ko kp gt kq kr ks bn kt ku bi"><span id="4d42" class="kv kw iq kr b be kx ky l kz la">SELECT name, weight, gender, LAST_VALUE(name) OVER (PARTITION BY gender ORDER BY weight desc rows between UNBOUNDED PRECEDING and UNBOUNDED FOLLOWING) FROM users;</span></pre><figure class="km kn ko kp gt lc gh gi paragraph-image"><div class="gh gi mf"><img src="../Images/159f374b8f865ccb31b4196d02c0d5cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:516/format:webp/1*T8AZ7TMe0mV_KYf-p1xutA.png"/></div></figure><p id="208b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">第 n 个值</strong>:返回分区中需要的行，需要 ORDER BY 子句。可以从表格的顶部或底部检索数据。</p><p id="77b6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例:从上面的数据中，我们可以根据他们的体重在性别分区中找到第二个用户，如下所示。请注意，在 redshift 中，我们不得不使用 rows between 子句提到窗口框架。</p><pre class="km kn ko kp gt kq kr ks bn kt ku bi"><span id="2f83" class="kv kw iq kr b be kx ky l kz la">SELECT name, weight, gender, NTH_VALUE(name, 2) OVER (PARTITION BY gender ORDER BY weight desc rows between UNBOUNDED PRECEDING and UNBOUNDED FOLLOWING) FROM users;</span></pre><figure class="km kn ko kp gt lc gh gi paragraph-image"><div class="gh gi mg"><img src="../Images/46a2266b54d8a461ab97e32613a285e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:518/format:webp/1*Nl1H6t4MlN_Lp90jkXuadg.png"/></div></figure><p id="3a7b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">希望您已经对这些函数有了一些基本的了解，知道如何以及何时使用，以及在给定的数据集上使用时的结果。在接下来的几篇文章中，我们将从这个<a class="ae kl" href="https://medium.com/dev-genius/important-sql-clauses-functions-in-data-engineering-and-analytics-85d8d84c2d78" rel="noopener">列表</a>中介绍更多的函数。谢了。</p><p id="7a09" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">参考资料:</p><p id="9fc0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://www.pluralsight.com/courses/adv-sql-queries-oracle-sql-server" rel="noopener ugc nofollow" target="_blank">https://www . plural sight . com/courses/adv-SQL-queries-Oracle-SQL-server</a></p><p id="6f1d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://docs.aws.amazon.com/redshift/latest/dg/c_Window_functions.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/redshift/latest/DG/c _ Window _ functions . html</a>。</p><div class="mh mi gp gr mj mk"><a href="https://medium.com/membership/@guru.nie" rel="noopener follow" target="_blank"><div class="ml ab fo"><div class="mm ab mn cl cj mo"><h2 class="bd ir gy z fp mp fr fs mq fu fw ip bi translated">通过我的推荐链接加入媒体</h2><div class="mr l"><h3 class="bd b gy z fp mp fr fs mq fu fw dk translated">阅读 Gururaj Kulkarni(以及媒体上成千上万的其他作家)的每一个故事。您的会员费直接…</h3></div><div class="ms l"><p class="bd b dl z fp mp fr fs mq fu fw dk translated">medium.com</p></div></div><div class="mt l"><div class="mu l mv mw mx mt my lh mk"/></div></div></a></div></div></div>    
</body>
</html>