<html>
<head>
<title>Run Ansible Playbook From Terraform: Provision and Configure Bastion Host in AWS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从 Terraform 运行 Ansible 剧本:在 AWS 中供应和配置 Bastion 主机</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/run-ansible-playbook-from-terraform-provision-and-configure-bastion-host-in-aws-df5420804100?source=collection_archive---------3-----------------------#2022-12-24">https://blog.devgenius.io/run-ansible-playbook-from-terraform-provision-and-configure-bastion-host-in-aws-df5420804100?source=collection_archive---------3-----------------------#2022-12-24</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="5b65" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi ki translated">通常，我们必须将 EC2 实例配置为堡垒主机，然后我们运行可行的行动手册或初始化脚本来安装包或配置系统。但是如果我们一次完成 terraform 和 ansible，既可以节省时间，又可以减少劳动。</p><p id="14ac" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在这篇文章中，我们将学习如何实现这个目标。我们将建立一个堡垒主机并自动安装 docker 和 docker-compose v2！</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/6a7f48ce03e4e2572c1109bc415812f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VoCpihN9ph80tmOHYWW8zw.png"/></div></div></figure><h2 id="a0bd" class="ld le in bd lf lg lh dn li lj lk dp ll jv lm ln lo jz lp lq lr kd ls lt lu lv bi translated">终端时间</h2><div class="lw lx gp gr ly lz"><a href="https://github.com/by-sabbir/terraform-ansible-ec2" rel="noopener  ugc nofollow" target="_blank"><div class="ma ab fo"><div class="mb ab mc cl cj md"><h2 class="bd io gy z fp me fr fs mf fu fw im bi translated">GitHub-by-sab Bir/terraform-ansible-ec2:用 terra form 部署 EC2，用 ansi ble 配置</h2><div class="mg l"><h3 class="bd b gy z fp me fr fs mf fu fw dk translated">使用 terraform 部署 ec2 并使用 ansi ble-GitHub-by-sab Bir/terra form-ansi ble-EC2 进行配置:使用…部署 EC2</h3></div><div class="mh l"><p class="bd b dl z fp me fr fs mf fu fw dk translated">github.com</p></div></div><div class="mi l"><div class="mj l mk ml mm mi mn lb lz"/></div></div></a></div><p id="3505" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">克隆存储库，并在以下位置编辑文件</p><ul class=""><li id="c058" class="mo mp in jm b jn jo jr js jv mq jz mr kd ms kh mt mu mv mw bi translated"><code class="fe mx my mz na b">modules/ec2/variables.tf</code></li><li id="51f0" class="mo mp in jm b jn nb jr nc jv nd jz ne kd nf kh mt mu mv mw bi translated"><code class="fe mx my mz na b">modules/sshkey/variables.tf</code></li><li id="f889" class="mo mp in jm b jn nb jr nc jv nd jz ne kd nf kh mt mu mv mw bi translated"><code class="fe mx my mz na b">./variables.tf</code></li></ul><p id="376f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">用您的 VPC ID、公共子网、私有和公共密钥来更改变量。如果从头开始部署或者使用外部的<code class="fe mx my mz na b">terraform data resource.</code>，这个过程也可以自动化，但是这超出了本文的范围。现在运行以下命令:</p><pre class="ks kt ku kv gt ng na nh bn ni nj bi"><span id="69d1" class="nk le in na b be nl nm l nn no">terraform plan</span></pre><p id="3dec" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这将显示供应计划和/或显示基础代码是否有任何错误。</p><p id="c700" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">假设前面的命令成功执行，让我们调配基础架构—</p><pre class="ks kt ku kv gt ng na nh bn ni nj bi"><span id="cc37" class="nk le in na b be nl nm l nn no">terraform apply --auto-approve</span></pre><p id="71ca" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">成功完成后，您将得到类似于下面的内容，</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi np"><img src="../Images/1da22c3929a45455ea1fc5af7dd4b28e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8KnvSVTCuALrgMZGg3qugQ.png"/></div></div></figure><p id="8b26" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">厉害！现在你应该能够通过在<code class="fe mx my mz na b"><a class="ae nq" href="https://github.com/by-sabbir/terraform-ansible-ec2/blob/550736a9044a6c49fbc7272a234d086e1a3a3bd8/modules/ec2/variables.tf#L14" rel="noopener ugc nofollow" target="_blank">modules/ec2/variables.tf</a></code>指定的私钥 ssh 到服务器</p><h2 id="8a67" class="ld le in bd lf lg lh dn li lj lk dp ll jv lm ln lo jz lp lq lr kd ls lt lu lv bi translated">近距离观察</h2><p id="6328" class="pw-post-body-paragraph jk jl in jm b jn nr jp jq jr ns jt ju jv nt jx jy jz nu kb kc kd nv kf kg kh ig bi">—</p><p id="4744" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">项目结构</strong></p><p id="17e3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">对于这个项目，我决定采用<code class="fe mx my mz na b">moduler</code>或<code class="fe mx my mz na b">module-based</code>的方法。这使我们能够重用 IaC。此外，您可以使用这种模式为生产中的所有基础设施资源启动一个平台<code class="fe mx my mz na b">monorepo</code>。</p><pre class="ks kt ku kv gt ng na nh bn ni nj bi"><span id="ec20" class="nk le in na b be nl nm l nn no">.<br/>├── ansible<br/>├── modules<br/>│   ├── ec2<br/>│   └── sshkey<br/>└── main.tf</span></pre><p id="73c1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><code class="fe mx my mz na b">ansible</code>文件夹包含一个安装脚本和<code class="fe mx my mz na b">playbook.</code>文件夹，我们主要关注的是<code class="fe mx my mz na b">modules</code>文件夹。这包含了基础架构的所有资源。我们可以使用任何资源的<code class="fe mx my mz na b">outputs</code>来供应其他资源，我们可以在该文件夹中独立地更新/删除基础架构的任何组件。我就是喜欢这个 IaC 结构。</p><p id="1f31" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在，剩下的就简单了。让我们从<code class="fe mx my mz na b">modules/ec2/main.tf</code>开始剖析下面的地形代码行 79–126，</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="nw nx l"/></div></figure><p id="21d4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们将 EC2 的<code class="fe mx my mz na b">connection</code>方法声明为 SSH，因此我们为该块提供了一个私钥，就个人而言，我每天都会将<code class="fe mx my mz na b">ed25519</code>用于公钥加密。这将由<code class="fe mx my mz na b">file</code>和<code class="fe mx my mz na b">remote-exec</code>置备程序使用。让我们来看看<code class="fe mx my mz na b">ansible/install.sh</code>文件——</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="nw nx l"/></div></figure><p id="f604" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这是一个非常简单的脚本，我们正在更新新创建的虚拟机的包缓存，然后安装 ansible。最后，我们运行 ansible 剧本。ansible playbook 包含安装 docker 和 compose 插件的必要步骤。</p><blockquote class="ny nz oa"><p id="4508" class="jk jl ob jm b jn jo jp jq jr js jt ju oc jw jx jy od ka kb kc oe ke kf kg kh ig bi translated">注意:我没有管理状态和锁定。如果您将它用于生产，请使用您选择的远程状态和锁定机制。</p></blockquote><h2 id="cf8b" class="ld le in bd lf lg lh dn li lj lk dp ll jv lm ln lo jz lp lq lr kd ls lt lu lv bi translated">清理</h2><pre class="ks kt ku kv gt ng na nh bn ni nj bi"><span id="f1f1" class="nk le in na b be nl nm l nn no">terraform destroy</span></pre></div><div class="ab cl of og hr oh" role="separator"><span class="oi bw bk oj ok ol"/><span class="oi bw bk oj ok ol"/><span class="oi bw bk oj ok"/></div><div class="ig ih ii ij ik"><p id="1fc9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">就是这样！改进/想法将受到高度赞赏。</p><p id="dfb0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">快乐的建筑设计…</p></div></div>    
</body>
</html>