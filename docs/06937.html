<html>
<head>
<title>Setting up a simple CI/CD with Django and Gitlab</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Django 和 Gitlab 设置简单的 CI/CD</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/setting-up-a-simple-ci-cd-with-django-and-gitlab-80ac3492638c?source=collection_archive---------2-----------------------#2022-02-13">https://blog.devgenius.io/setting-up-a-simple-ci-cd-with-django-and-gitlab-80ac3492638c?source=collection_archive---------2-----------------------#2022-02-13</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div class="gh gi jk"><img src="../Images/b053a27089d4b781702fb6d8cfe0a612.png" data-original-src="https://miro.medium.com/v2/resize:fit:680/format:webp/1*HP0Qss6BAQcv0UbHb21YFQ.png"/></div></figure><p id="dfec" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">我想在我的项目中实践拥有一个类似 DevOps 的环境，因此，我决定修补 CI/CD 管道，并最终与世界共享它。我希望这篇指南能帮助你建立一个简单的管道，同时揭开 DevOps 及其相关工具的神秘面纱。</p><h1 id="ee7e" class="kp kq in bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated"><strong class="ak">项目概述:</strong></h1><p id="1529" class="pw-post-body-paragraph jr js in jt b ju ln jw jx jy lo ka kb kc lp ke kf kg lq ki kj kk lr km kn ko ig bi translated">这个项目是关于有一个 Django API，并将其添加到 Gitlab repo，同时确保它作为 Docker 容器部署。因此，要做到这一点，我们必须安装这些工具，这正是下一部分的内容。然后，我们将配置这些工具来帮助实现我们的自动化管道。</p><p id="d80e" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">请注意，我使用的环境是 Ubuntu 20.04。</p><h1 id="79ee" class="kp kq in bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">安装 Docker:</h1><p id="e4da" class="pw-post-body-paragraph jr js in jt b ju ln jw jx jy lo ka kb kc lp ke kf kg lq ki kj kk lr km kn ko ig bi translated">据 https://docs.docker.com/engine/install/ubuntu/<a class="ae ls" href="https://docs.docker.com/engine/install/ubuntu/" rel="noopener ugc nofollow" target="_blank">:</a></p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="6094" class="mc kq in ly b gy md me l mf mg">#### prerequisites<br/>$ sudo apt-get update<br/>$ sudo apt-get install ca-certificates curl gnupg lsb-release</span><span id="11ae" class="mc kq in ly b gy mh me l mf mg">#### setup docker apt repository<br/>curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg</span><span id="e74f" class="mc kq in ly b gy mh me l mf mg">echo \<br/>  "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \<br/>  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><span id="c5c6" class="mc kq in ly b gy mh me l mf mg">#### install docker packages<br/>sudo apt-get update<br/>sudo apt-get install docker-ce docker-ce-cli containerd.io</span><span id="3bb3" class="mc kq in ly b gy mh me l mf mg">#### test your installation<br/>sudo docker run hello-world</span></pre><h1 id="17a8" class="kp kq in bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">安装 Gitlab 社区版(自管理安装):</h1><p id="0eaf" class="pw-post-body-paragraph jr js in jt b ju ln jw jx jy lo ka kb kc lp ke kf kg lq ki kj kk lr km kn ko ig bi translated">根据<a class="ae ls" href="https://about.gitlab.com/install/#ubuntu" rel="noopener ugc nofollow" target="_blank">https://about.gitlab.com/install/#ubuntu</a>:</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="e2ec" class="mc kq in ly b gy md me l mf mg">## prerequisites<br/>sudo apt-get update<br/>sudo apt-get install -y curl openssh-server ca-certificates tzdata perl <br/>sudo apt-get install -y postfix</span><span id="d4a6" class="mc kq in ly b gy mh me l mf mg">## add Gitlab apt repository <br/>curl https://packages.gitlab.com/install/repositories/gitlab/gitlab-ee/script.deb.sh | sudo bash</span></pre><p id="710d" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">除非您在安装过程中提供了自定义密码，否则会随机生成一个密码，并在<code class="fe mi mj mk ly b">/etc/gitlab/initial_root_password</code>中存储 24 小时。使用用户名为<code class="fe mi mj mk ly b">root</code>的密码登录。<br/>另外，请注意，要使用您的服务器 IP 访问 Gitlab，您必须将 EXTERNAL_URL 设置为您想要的 IP 或 FQDN(例如:“http://192.168.1.140”)</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="9266" class="mc kq in ly b gy md me l mf mg">sudo EXTERNAL_URL="https://gitlab.example.com" apt-get install gitlab-c</span></pre><h1 id="2821" class="kp kq in bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">安装 Gitlab Runner:</h1><p id="4310" class="pw-post-body-paragraph jr js in jt b ju ln jw jx jy lo ka kb kc lp ke kf kg lq ki kj kk lr km kn ko ig bi translated">据<a class="ae ls" href="https://docs.gitlab.com/runner/install/linux-manually.html" rel="noopener ugc nofollow" target="_blank">https://docs.gitlab.com/runner/install/linux-manually.html</a>:</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="0c38" class="mc kq in ly b gy md me l mf mg">curl -LJO "<a class="ae ls" href="https://gitlab-runner-downloads.s3.amazonaws.com/latest/deb/gitlab-runner_${arch}.deb" rel="noopener ugc nofollow" target="_blank">https://gitlab-runner-downloads.s3.amazonaws.com/latest/deb/gitlab-runner_amd64.deb</a></span><span id="c321" class="mc kq in ly b gy mh me l mf mg">sudo dpkg -i gitlab-runner_amd64.deb</span></pre><p id="9d62" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">确保 Gitlab-runner 正在运行:</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="2dd5" class="mc kq in ly b gy md me l mf mg">sudo gitlab-runner status</span></pre><h1 id="f0a3" class="kp kq in bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">从 Github 获取 Django 代码:</h1><p id="c1f6" class="pw-post-body-paragraph jr js in jt b ju ln jw jx jy lo ka kb kc lp ke kf kg lq ki kj kk lr km kn ko ig bi translated">我已经准备了一个基于<a class="ae ls" href="https://www.youtube.com/watch?v=cJveiktaOSQ&amp;list=PLYynv4DCCc8er26ZPaXOfCUMpqIwJGV71&amp;index=35&amp;t=422s" rel="noopener ugc nofollow" target="_blank"> Dennis Ivy 优秀而简洁的教程</a>的 Django API 示例:</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="ddd3" class="mc kq in ly b gy md me l mf mg">cd /home/$USER<br/>git clone <a class="ae ls" href="https://github.com/VertigoX64/django_gitlab_cicd" rel="noopener ugc nofollow" target="_blank">https://github.com/VertigoX64/django_gitlab_cicd</a></span></pre></div><div class="ab cl ml mm hr mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="ig ih ii ij ik"><p id="252f" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">现在我们有了所有需要的工具。我们只需要把代码放入 Gitlab 并启用它的内部 CICD 管道。</p><h1 id="68a3" class="kp kq in bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">将 Django 代码输入 Gitlab:</h1><p id="171b" class="pw-post-body-paragraph jr js in jt b ju ln jw jx jy lo ka kb kc lp ke kf kg lq ki kj kk lr km kn ko ig bi translated">1-登录到您为 EXTERNAL_URL 变量输入的地址。(例如:“http://192.168.1.140”)</p><p id="722c" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">2-创建新的存储库。</p><p id="6da9" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">3-进入刚刚为 Django 代码克隆了 git 存储库的文件夹，运行以下命令:</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="42c1" class="mc kq in ly b gy md me l mf mg">git remote set-url origin<!-- --> <a class="ae ls" href="http://192.168.100.140/YOUR_USERNAME/YOUR_REPOSITORY_NAME.git" rel="noopener ugc nofollow" target="_blank">http://192.168.100.140/YOUR_USERNAME/YOUR_REPOSITORY_NAME.git</a></span><span id="df70" class="mc kq in ly b gy mh me l mf mg">git push origin</span></pre><p id="ac1c" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">为了确保代码已经被成功地推送到 Gitlab，请查看存储库页面。你应该看看里面的文件。</p><h1 id="8f32" class="kp kq in bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">注册并配置 Gitlab 运行程序:</h1><p id="59fd" class="pw-post-body-paragraph jr js in jt b ju ln jw jx jy lo ka kb kc lp ke kf kg lq ki kj kk lr km kn ko ig bi translated">根据<a class="ae ls" href="https://docs.gitlab.com/runner/register/index.html#linux" rel="noopener ugc nofollow" target="_blank">https://docs.gitlab.com/runner/register/index.html#linux</a>:</p><p id="b8a8" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">运行此命令</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="0018" class="mc kq in ly b gy md me l mf mg">sudo gitlab-runner register</span></pre><p id="959c" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">然后打开 Gitlab 实例，进入里面的 Django 代码 repo。打开左侧边栏上的设置菜单，并转到 CI/CD 部分。然后，展开 Runners 部分并找到注册令牌。然后，运行以下代码:</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="f3dd" class="mc kq in ly b gy md me l mf mg">REGISTRATION_TOKEN=YOUR_REGISTRATIONTOKEN<br/>sudo gitlab-runner register --url http://192.168.100.140/ --registration-token $REGISTRATION_TOKEN</span></pre><p id="6073" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">最后一步，打开 Gitlab-runner 的配置文件(位于/etc/gitlab-runner/config.toml)并将 executor 参数的值更改为“shell”(根据下面的配置，<strong class="jt io">第 11 行</strong>):</p><figure class="lt lu lv lw gt jo"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="6584" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">为了记录，这里是我用过的 gitlab-ci.yaml:</p><figure class="lt lu lv lw gt jo"><div class="bz fp l di"><div class="ms mt l"/></div></figure><h1 id="70fe" class="kp kq in bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">结束了</h1><p id="30f4" class="pw-post-body-paragraph jr js in jt b ju ln jw jx jy lo ka kb kc lp ke kf kg lq ki kj kk lr km kn ko ig bi translated">您可以导航到 Gitlab 侧边栏上的 CI/CD 菜单来查看您的管道。在您的管道历史记录中，应该至少有一个通过或失败的管道。</p><p id="ce6f" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">我希望这本指南会有用。</p></div></div>    
</body>
</html>