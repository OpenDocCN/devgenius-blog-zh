<html>
<head>
<title>PyOps — Scapy Introduction</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">PyOps — Scapy 简介</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/pyops-scapy-introduction-c15658b47eca?source=collection_archive---------14-----------------------#2022-02-14">https://blog.devgenius.io/pyops-scapy-introduction-c15658b47eca?source=collection_archive---------14-----------------------#2022-02-14</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><div class=""/><div class=""><h2 id="bc29" class="pw-subtitle-paragraph jo iq ir bd b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dk translated">一个强大的交互式数据包处理程序</h2></div><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div class="gi gj kg"><img src="../Images/2c97989a6d6a36d3e64a73a31d72c689.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*jyR9X6wr-HrDWap0i_6OcQ.png"/></div></figure><h1 id="6398" class="ko kp ir bd kq kr ks kt ku kv kw kx ky jx kz jy la ka lb kb lc kd ld ke le lf bi translated">关于 Scapy</h1><p id="37a6" class="pw-post-body-paragraph lg lh ir li b lj lk js ll lm ln jv lo lp lq lr ls lt lu lv lw lx ly lz ma mb ik bi translated"><code class="fe mc md me mf b">Scapy</code>是一个 Python 程序，使用户能够发送、嗅探、解析和伪造网络数据包。该功能允许构建能够探测、扫描或攻击网络的工具。</p><p id="a926" class="pw-post-body-paragraph lg lh ir li b lj mg js ll lm mh jv lo lp mi lr ls lt mj lv lw lx mk lz ma mb ik bi translated">换句话说，<code class="fe mc md me mf b">Scapy</code>是一个强大的交互式包操纵程序。它能够伪造或解码大量协议的数据包，通过网络发送它们，捕获它们，匹配请求和回复，等等。</p><p id="5a15" class="pw-post-body-paragraph lg lh ir li b lj mg js ll lm mh jv lo lp mi lr ls lt mj lv lw lx mk lz ma mb ik bi translated"><code class="fe mc md me mf b">Scapy</code>可以轻松处理大多数经典任务，如扫描、跟踪路由、探测、单元测试、攻击或网络发现。可以替代 hping、arpspoof、arp-sk、arping、p0f 甚至 Nmap、tcpdump、tshark 的部分功能。</p><p id="3828" class="pw-post-body-paragraph lg lh ir li b lj mg js ll lm mh jv lo lp mi lr ls lt mj lv lw lx mk lz ma mb ik bi translated"><code class="fe mc md me mf b">Scapy</code>官网:<a class="ae ml" href="https://scapy.net/" rel="noopener ugc nofollow" target="_blank">https://scapy.net/</a></p><h1 id="861d" class="ko kp ir bd kq kr ks kt ku kv kw kx ky jx kz jy la ka lb kb lc kd ld ke le lf bi translated">Scapy 模块</h1><p id="4c6e" class="pw-post-body-paragraph lg lh ir li b lj lk js ll lm ln jv lo lp lq lr ls lt lu lv lw lx ly lz ma mb ik bi translated"><code class="fe mc md me mf b">Scapy</code>该模块提供了多种网络数据包操作方法，包括<code class="fe mc md me mf b">send()</code>、<code class="fe mc md me mf b">SYN/ACK</code>扫描、<code class="fe mc md me mf b">sniff()</code>、<code class="fe mc md me mf b">wrpcap()</code>、<code class="fe mc md me mf b">TCP traceroute()</code>等。本文我们将重点介绍<code class="fe mc md me mf b">traceroute()</code>方法。</p><h2 id="abea" class="mm kp ir bd kq mn mo dn ku mp mq dp ky lp mr ms la lt mt mu lc lx mv mw le mx bi translated">Traceroute</h2><p id="c9b0" class="pw-post-body-paragraph lg lh ir li b lj lk js ll lm ln jv lo lp lq lr ls lt lu lv lw lx ly lz ma mb ik bi translated"><code class="fe mc md me mf b">Traceroute</code>是一种工具/技术，用于列出数据包到达目标所经过的所有路由器。该技术是向目标发送一系列数据包，并设置生存时间(TTL ),使得路径上的每个路由器都必须通知您数据包的死亡。</p><p id="eab2" class="pw-post-body-paragraph lg lh ir li b lj mg js ll lm mh jv lo lp mi lr ls lt mj lv lw lx mk lz ma mb ik bi translated">该技术基于 IP 协议的设计方式。IP 报头中的 TTL 值被视为跳数限制。每当路由器收到要转发的数据包时，它会将 TTL 减 1，然后转发该数据包。当 TTL 达到 0 时，路由器将向源机器发送一个回复，表明数据包已经死亡。</p><p id="0012" class="pw-post-body-paragraph lg lh ir li b lj mg js ll lm mh jv lo lp mi lr ls lt mj lv lw lx mk lz ma mb ik bi translated">各种工具背后的技术是相同的，但是它们实现的方式略有不同。Unix 系统使用 UDP 数据报，而 Windows <em class="my"> tracert </em>程序使用 ICMP，而<em class="my"> tcptraceroute </em>使用 TCP。</p><p id="fd9c" class="pw-post-body-paragraph lg lh ir li b lj mg js ll lm mh jv lo lp mi lr ls lt mj lv lw lx mk lz ma mb ik bi translated">在<code class="fe mc md me mf b">Scapy</code>中，<code class="fe mc md me mf b">traceroute</code>方法的定义如下:</p><pre class="kh ki kj kk gu mz mf na nb aw nc bi"><span id="9159" class="mm kp ir mf b gz nd ne l nf ng">traceroute(target, dport=80, minttl=1, maxttl=30, sport=, l4=None, filter=None, timeout=2, verbose=None, **kargs)</span></pre><p id="9ffd" class="pw-post-body-paragraph lg lh ir li b lj mg js ll lm mh jv lo lp mi lr ls lt mj lv lw lx mk lz ma mb ik bi translated">此方法实现 TCP 跟踪路由功能。关键参数描述如下:</p><ul class=""><li id="f956" class="nh ni ir li b lj mg lm mh lp nj lt nk lx nl mb nm nn no np bi translated">target:要跟踪的目标对象，可以是域名，也可以是 IP，类型为列表。支持同时指定多个目标，如["www.qq.com "，" www.baidu.com "，" www . Google . com . hk "]；</li><li id="a0b2" class="nh ni ir li b lj nq lm nr lp ns lt nt lx nu mb nm nn no np bi translated">dport:目的端口，类型为列表，支持同时指定多个端口，如[80，443]；</li><li id="7a93" class="nh ni ir li b lj nq lm nr lp ns lt nt lx nu mb nm nn no np bi translated">minttl:指定跟踪路由的最小跳数(节点数)；</li><li id="8b57" class="nh ni ir li b lj nq lm nr lp ns lt nt lx nu mb nm nn no np bi translated">maxttl:指定路由跟踪的最大跳数(节点数)。</li></ul><h1 id="4433" class="ko kp ir bd kq kr ks kt ku kv kw kx ky jx kz jy la ka lb kb lc kd ld ke le lf bi translated">实践</h1><p id="895c" class="pw-post-body-paragraph lg lh ir li b lj lk js ll lm ln jv lo lp lq lr ls lt lu lv lw lx ly lz ma mb ik bi translated">在本练习中，我们使用<code class="fe mc md me mf b">scapy</code>的<code class="fe mc md me mf b">traceroute()</code>方法来实现从探测器到目标服务器的路由跟踪。</p><p id="fdb4" class="pw-post-body-paragraph lg lh ir li b lj mg js ll lm mh jv lo lp mi lr ls lt mj lv lw lx mk lz ma mb ik bi translated">先用 probe 扫描 SYN 模式的 TCP 服务，同时启动 tcpdump 捕获数据包，捕获扫描过程经过的所有路由点，然后通过 graph()方法绘制路由 IP 轨迹，调用中间的 ASN 映射查询 IP 地理信息，生成 svg 过程文档。</p><h2 id="93b4" class="mm kp ir bd kq mn mo dn ku mp mq dp ky lp mr ms la lt mt mu lc lx mv mw le mx bi translated">代码:</h2><pre class="kh ki kj kk gu mz mf na nb aw nc bi"><span id="d533" class="mm kp ir mf b gz nd ne l nf ng">import time<br/>import warnings<br/>import logging<br/>warnings.filterwarnings("ignore", category=DeprecationWarning)<br/>logging.getLogger('scapy.runtime').setLevel(logging.ERROR)<br/>from scapy import traceroute</span><span id="f033" class="mm kp ir mf b gz nv ne l nf ng">domains = input('Please input one or more IP/domain: ')<br/>target = domains.split(' ')<br/>dport = [80]</span><span id="3f6f" class="mm kp ir mf b gz nv ne l nf ng">if len(target) &gt;= 1 and target[0] != '':<br/>    res,unans = traceroute(target, dport=dport, retry=-2)<br/>    res.graph(target='&gt; output.svg')<br/>    time.sleep(1)<br/>else:<br/>    print("IP/domain number of errors, exit")</span></pre><h2 id="b13f" class="mm kp ir bd kq mn mo dn ku mp mq dp ky lp mr ms la lt mt mu lc lx mv mw le mx bi translated">输出:</h2><pre class="kh ki kj kk gu mz mf na nb aw nc bi"><span id="4756" class="mm kp ir mf b gz nd ne l nf ng">Please input one or more IP/domain: google.com<br/>Begin emission:<br/>Finished sending 30 packets.<br/>***************************.Begin emission:<br/>Finished sending 3 packets.<br/>Begin emission:<br/>Finished sending 3 packets.<br/>..<br/>Received 30 packets, got 27 answers, remaining 3 packets<br/>   142.250.80.110:tcp80 <br/>1  192.168.1.1     11   <br/>3  100.41.25.94    11   <br/>4  140.222.3.212   11   <br/>7  140.222.1.45    11   <br/>8  204.148.20.6    11   <br/>9  108.170.248.33  11   <br/>10 142.251.65.113  11   <br/>11 142.250.80.110  SA   <br/>12 142.250.80.110  SA   <br/>...<br/>28 142.250.80.110  SA   <br/>29 142.250.80.110  SA   <br/>30 142.250.80.110  SA</span></pre><p id="0a09" class="pw-post-body-paragraph lg lh ir li b lj mg js ll lm mh jv lo lp mi lr ls lt mj lv lw lx mk lz ma mb ik bi translated">“11”表示扫描的指定服务没有响应；“SA”表示要扫描的指定服务已经响应，通常是最后一个主机 IP。</p><h2 id="6cf3" class="mm kp ir bd kq mn mo dn ku mp mq dp ky lp mr ms la lt mt mu lc lx mv mw le mx bi translated">生成的图形:</h2><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div class="gi gj nw"><img src="../Images/11bcbdab1b9d378bd67be35669f62a10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1384/format:webp/1*iE091XEjsI3T9vxNgC4eEg.png"/></div></figure><p id="744e" class="pw-post-body-paragraph lg lh ir li b lj mg js ll lm mh jv lo lp mi lr ls lt mj lv lw lx mk lz ma mb ik bi translated">通过路由轨迹图，我们可以清楚地看到从检测点到目标节点的路由方向。运营商经常分流路由节点，不排除选择的路由线路不是最优的。</p><h1 id="8eb3" class="ko kp ir bd kq kr ks kt ku kv kw kx ky jx kz jy la ka lb kb lc kd ld ke le lf bi translated">结论</h1><p id="bb4a" class="pw-post-body-paragraph lg lh ir li b lj lk js ll lm ln jv lo lp lq lr ls lt lu lv lw lx ly lz ma mb ik bi translated"><code class="fe mc md me mf b">Scapy</code> asl 有一个终端模式，一旦你安装了它，你只需输入<code class="fe mc md me mf b">scapy</code>就可以启动它:</p><pre class="kh ki kj kk gu mz mf na nb aw nc bi"><span id="e4e7" class="mm kp ir mf b gz nd ne l nf ng">scapy<br/>INFO: Can't import matplotlib. Won't be able to plot.<br/>INFO: Can't import PyX. Won't be able to use psdump() or pdfdump().<br/>WARNING: No IPv4 address found on en5 !<br/>WARNING: No IPv4 address found on en1 !<br/>WARNING: more No IPv4 address found on en2 !<br/>INFO: Can't import python-cryptography v1.7+. Disabled WEP decryption/encryption. (Dot11)<br/>INFO: Can't import python-cryptography v1.7+. Disabled IPsec encryption/authentication.<br/>WARNING: IPython not available. Using standard Python shell instead.<br/>AutoCompletion, History are disabled.<br/>                                      <br/>                     aSPY//YASa       <br/>             apyyyyCY//////////YCa       |<br/>            sY//////YSpcs  scpCY//Pp     | Welcome to Scapy<br/> ayp ayyyyyyySCP//Pp           syY//C    | Version 2.4.5<br/> AYAsAYYYYYYYY///Ps              cY//S   |<br/>         pCCCCY//p          cSSps y//Y   | <a class="ae ml" href="https://github.com/secdev/scapy" rel="noopener ugc nofollow" target="_blank">https://github.com/secdev/scapy</a><br/>         SPPPP///a          pP///AC//Y   |<br/>              A//A            cyP////C   | Have fun!<br/>              p///Ac            sC///a   |<br/>              P////YCpc           A//A   | Craft packets like it is your last<br/>       scccccp///pSP///p          p//Y   | day on earth.<br/>      sY/////////y  caa           S//P   |                      -- Lao-Tze<br/>       cayCyayP//Ya              pY/Ya   |<br/>        sY/PsY////YCc          aC//Yp <br/>         sc  sccaCY//PCypaapyCP//YSs  <br/>                  spCPY//////YPSps    <br/>                       ccaacs         <br/>                                      <br/>&gt;&gt;&gt;</span></pre><p id="874b" class="pw-post-body-paragraph lg lh ir li b lj mg js ll lm mh jv lo lp mi lr ls lt mj lv lw lx mk lz ma mb ik bi translated">要列出所有支持的协议:</p><pre class="kh ki kj kk gu mz mf na nb aw nc bi"><span id="2da2" class="mm kp ir mf b gz nd ne l nf ng">&gt;&gt;&gt; ls()<br/>AH         : AH<br/>AKMSuite   : AKM suite<br/>ARP        : ARP<br/>ASN1P_INTEGER : None<br/>ASN1P_OID  : None<br/>ASN1P_PRIVSEQ : None<br/>ASN1_Packet : None<br/>ATT_Error_Response : Error Response<br/>ATT_Exchange_MTU_Request : Exchange MTU Request<br/>ATT_Exchange_MTU_Response : Exchange MTU Response<br/>ATT_Execute_Write_Request : Execute Write Request<br/>ATT_Execute_Write_Response : Execute Write Response<br/>ATT_Find_By_Type_Value_Request : Find By Type Value Request</span></pre><p id="4370" class="pw-post-body-paragraph lg lh ir li b lj mg js ll lm mh jv lo lp mi lr ls lt mj lv lw lx mk lz ma mb ik bi translated">要列出所有支持的命令:</p><pre class="kh ki kj kk gu mz mf na nb aw nc bi"><span id="967e" class="mm kp ir mf b gz nd ne l nf ng">&gt;&gt;&gt; lsc()<br/>IPID_count          : Identify IP id values classes in a list of packets<br/>arpcachepoison      : Poison target's cache with (your MAC,victim's IP) couple<br/>arping              : Send ARP who-has requests to determine which hosts are up<br/>arpleak             : Exploit ARP leak flaws, like NetBSD-SA2017-002.<br/>...<br/>tshark              : Sniff packets and print them calling pkt.summary().<br/>wireshark           : <br/>wrpcap              : Write a list of packets to a pcap file</span></pre><p id="36b4" class="pw-post-body-paragraph lg lh ir li b lj mg js ll lm mh jv lo lp mi lr ls lt mj lv lw lx mk lz ma mb ik bi translated"><code class="fe mc md me mf b">Scapy</code>有许多其他功能，它是 Python DevOps 分析网络活动和网络数据包的一个非常强大的工具。</p></div></div>    
</body>
</html>