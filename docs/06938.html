<html>
<head>
<title>Linux — Disk I/O Performance</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Linux —磁盘 I/O 性能</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/linux-disk-i-o-performance-1e920faba23?source=collection_archive---------3-----------------------#2022-02-13">https://blog.devgenius.io/linux-disk-i-o-performance-1e920faba23?source=collection_archive---------3-----------------------#2022-02-13</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><div class=""/><div class=""><h2 id="366f" class="pw-subtitle-paragraph jo iq ir bd b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dk translated">如何监控和解决磁盘 I/O 性能问题</h2></div><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj kg"><img src="../Images/4985ab0eba3c955f9b0ac2932a43349b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8KepnFejbklqhxuWLq6QpA.png"/></div></div></figure><p id="a941" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">在我之前的一篇文章:<a class="ae lo" rel="noopener ugc nofollow" target="_blank" href="/linux-disk-i-o-deep-dive-ccd2dd30b98e"> Linux —磁盘 I/O 深潜</a>中，我谈到了 Linux 磁盘 I/O 是如何工作的，我们了解到 Linux 存储系统 I/O 栈由文件系统层、通用块层和设备层组成。</p><p id="b81e" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">其中，通用块层是 Linux 磁盘 I/O 的核心，向上，为文件系统和应用提供访问块设备的标准接口；向下，它将各种异构磁盘设备抽象为一个统一的块设备，并响应文件系统和应用程序发送的 I/O。</p><p id="f295" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">在本文中，我们来看看磁盘的性能指标，以及如何观察这些指标。</p><h1 id="48a6" class="lp lq ir bd lr ls lt lu lv lw lx ly lz jx ma jy mb ka mc kb md kd me ke mf mg bi translated">Linux 磁盘性能指标</h1><p id="1da2" class="pw-post-body-paragraph ks kt ir ku b kv mh js kx ky mi jv la lb mj ld le lf mk lh li lj ml ll lm ln ik bi translated">谈到测量磁盘性能，我们经常提到五个常见指标:利用率、饱和度、IOPS、吞吐量和响应时间。这五个指标是衡量磁盘性能的基本指标。</p><ul class=""><li id="4b21" class="mm mn ir ku b kv kw ky kz lb mo lf mp lj mq ln mr ms mt mu bi translated"><strong class="ku is">利用率</strong>:磁盘处理 I/O 的时间百分比，过度使用(比如超过 80%)通常意味着磁盘 I/O 存在性能瓶颈</li><li id="0561" class="mm mn ir ku b kv mv ky mw lb mx lf my lj mz ln mr ms mt mu bi translated"><strong class="ku is">饱和度</strong>:指磁盘处理 I/O 的繁忙程度，过度饱和意味着磁盘存在严重的性能瓶颈。当饱和度为 100%时，磁盘无法接受新的 I/O 请求。</li><li id="6984" class="mm mn ir ku b kv mv ky mw lb mx lf my lj mz ln mr ms mt mu bi translated"><strong class="ku is"> IOPS(每秒输入/输出)</strong>:指每秒的 I/O 请求数。</li><li id="a2ab" class="mm mn ir ku b kv mv ky mw lb mx lf my lj mz ln mr ms mt mu bi translated"><strong class="ku is">吞吐量</strong>:每秒 I/O 请求的大小。</li><li id="7e7d" class="mm mn ir ku b kv mv ky mw lb mx lf my lj mz ln mr ms mt mu bi translated"><strong class="ku is">响应时间</strong>:发送一个 I/O 请求到收到响应的间隔时间。</li></ul><p id="52cd" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">这里应该注意的是，利用率只考虑 I/O 的存在与否，而不考虑 I/O 的大小。换句话说，当利用率为 100%时，磁盘仍有可能接受新的 I/O 请求。</p><p id="ebf8" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">一般来说，在为应用选择服务器时，首先要对磁盘的 I/O 性能进行基准测试，这样才能准确评估磁盘性能是否能满足应用的需求。</p><p id="ff46" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">当然，这需要您在随机读取、顺序读取、随机写入和顺序写入等各种场景下测试不同 I/O 大小(通常是 512B 到 1MB 之间的几个值)的性能。</p><h1 id="9e73" class="lp lq ir bd lr ls lt lu lv lw lx ly lz jx ma jy mb ka mc kb md kd me ke mf mg bi translated">磁盘输入输出观察</h1><p id="b83b" class="pw-post-body-paragraph ks kt ir ku b kv mh js kx ky mi jv la lb mj ld le lf mk lh li lj ml ll lm ln ik bi translated">首先要观察的是每个磁盘的使用情况。<code class="fe na nb nc nd b">iostat</code>是最常用的磁盘 I/O 性能观察工具。它提供了各种常见的性能指标，如每个磁盘的使用率、IOPS 和吞吐量。当然，这些指标其实来自于<code class="fe na nb nc nd b">/proc/diskstats</code>。</p><p id="9371" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">以下是<code class="fe na nb nc nd b">iostat</code>的输出示例:</p><pre class="kh ki kj kk gu ne nd nf ng aw nh bi"><span id="5e04" class="ni lq ir nd b gz nj nk l nl nm"># -d -x means display all disk I/O performance<br/>$ iostat -d -x 1 <br/>Device            r/s     w/s     rkB/s     wkB/s   rrqm/s   wrqm/s  %rrqm  %wrqm r_await w_await aqu-sz rareq-sz wareq-sz  svctm  %util <br/>loop0            0.00    0.00      0.00      0.00     0.00     0.00   0.00   0.00    0.00    0.00   0.00     0.00     0.00   0.00   0.00 <br/>loop1            0.00    0.00      0.00      0.00     0.00     0.00   0.00   0.00    0.00    0.00   0.00     0.00     0.00   0.00   0.00 <br/>sda              0.00    0.00      0.00      0.00     0.00     0.00   0.00   0.00    0.00    0.00   0.00     0.00     0.00   0.00   0.00 <br/>sdb              0.00    0.00      0.00      0.00     0.00     0.00   0.00   0.00    0.00    0.00   0.00     0.00     0.00   0.00   0.00</span></pre><p id="f829" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">在上述指标中，您应该注意:</p><ul class=""><li id="7798" class="mm mn ir ku b kv kw ky kz lb mo lf mp lj mq ln mr ms mt mu bi translated"><code class="fe na nb nc nd b">%util</code>是我们之前提到的磁盘 I/O 使用情况</li><li id="419c" class="mm mn ir ku b kv mv ky mw lb mx lf my lj mz ln mr ms mt mu bi translated"><code class="fe na nb nc nd b">r/s+ w/s</code>是 IOPS</li><li id="95c1" class="mm mn ir ku b kv mv ky mw lb mx lf my lj mz ln mr ms mt mu bi translated"><code class="fe na nb nc nd b">rkB/s+wkB/s</code>是吞吐量</li><li id="afd3" class="mm mn ir ku b kv mv ky mw lb mx lf my lj mz ln mr ms mt mu bi translated"><code class="fe na nb nc nd b">r_await+w_await</code>是反应时间</li></ul><p id="31fd" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">您可能已经注意到，磁盘饱和度不是直接从<code class="fe na nb nc nd b">iostat</code>获得的。事实上，通常没有其他简单的方法来测量饱和度。但是，您可以将观察到的情况(平均请求队列长度或读写请求完成的等待时间)与基准测试(如通过 fio)的结果进行比较，以综合评估磁盘饱和度。</p><h2 id="096b" class="ni lq ir bd lr nn no dn lv np nq dp lz lb nr ns mb lf nt nu md lj nv nw mf nx bi translated">过程输入输出观察</h2><p id="7e81" class="pw-post-body-paragraph ks kt ir ku b kv mh js kx ky mi jv la lb mj ld le lf mk lh li lj ml ll lm ln ik bi translated">除了每个磁盘的 I/O 情况，每个进程的 I/O 情况也是你关注的重点。</p><p id="bc58" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">上面提到的 iostat 只提供了磁盘的整体 I/O 性能数据。缺点是无法知道哪些进程在读写磁盘。为了观察进程的 I/O，您还可以使用工具<code class="fe na nb nc nd b">pidstat</code>和<code class="fe na nb nc nd b">iotop</code>。</p><p id="ebb0" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">例如，使用<code class="fe na nb nc nd b">pidstat</code></p><pre class="kh ki kj kk gu ne nd nf ng aw nh bi"><span id="0552" class="ni lq ir nd b gz nj nk l nl nm">$ pidstat -d 1 <br/>13:39:51      UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command <br/>13:39:52      102       916      0.00      4.00      0.00       0  rsyslogd</span></pre><p id="547a" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">从<code class="fe na nb nc nd b">pidstat</code>的输出可以看到，它可以实时查看每个进程的 I/O 情况，包括以下内容:</p><ul class=""><li id="f32e" class="mm mn ir ku b kv kw ky kz lb mo lf mp lj mq ln mr ms mt mu bi translated">用户 ID (UID)和进程 ID (PID)。</li><li id="fc2d" class="mm mn ir ku b kv mv ky mw lb mx lf my lj mz ln mr ms mt mu bi translated">每秒读取的数据大小(kB_rd/s)，以 kB 为单位。</li><li id="c8fb" class="mm mn ir ku b kv mv ky mw lb mx lf my lj mz ln mr ms mt mu bi translated">每秒发出的写请求数据的大小(kB_wr/s)，单位为 kB。</li><li id="44b0" class="mm mn ir ku b kv mv ky mw lb mx lf my lj mz ln mr ms mt mu bi translated">每秒取消的写入请求的数据大小(kB_ccwr/s)，以 kB 为单位。</li><li id="ef9f" class="mm mn ir ku b kv mv ky mw lb mx lf my lj mz ln mr ms mt mu bi translated">块 I/O 延迟(iodelay)，包括等待同步块 I/O 和换入块 I/O 完成的时间，以时钟周期为单位。</li></ul><p id="d0f2" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">除了用<code class="fe na nb nc nd b">pidstat</code>实时查看，根据 I/O 大小对进程进行排序也是性能分析中的常用方法。为此，我推荐另一个工具，<code class="fe na nb nc nd b">iotop</code>。这是一个类似 top 的工具，因为你可以根据 I/O 大小对进程进行排序，并找到 I/O 较大的进程。</p><pre class="kh ki kj kk gu ne nd nf ng aw nh bi"><span id="4103" class="ni lq ir nd b gz nj nk l nl nm">$ iotop<br/>Total DISK READ :       0.00 B/s | Total DISK WRITE :       7.85 K/s <br/>Actual DISK READ:       0.00 B/s | Actual DISK WRITE:       0.00 B/s <br/>  TID  PRIO  USER     DISK READ  DISK WRITE  SWAPIN     IO&gt;    COMMAND <br/>15055 be/3 root        0.00 B/s    7.85 K/s  0.00 %  0.00 % systemd-journald</span></pre><p id="173c" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">从这个输出中，您可以看到前两行分别代表进程的总磁盘读写大小和总磁盘实际读写大小。由于缓存、缓冲区、I/O 合并等因素，它们可能不相等。</p><p id="7fd5" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">剩下的部分从各个角度表示了进程的 I/O 情况，包括线程 ID、I/O 优先级、每秒磁盘读取大小、每秒磁盘写入大小、换入和等待 I/O 时钟百分比。</p><h1 id="3d98" class="lp lq ir bd lr ls lt lu lv lw lx ly lz jx ma jy mb ka mc kb md kd me ke mf mg bi translated">结论</h1><p id="a328" class="pw-post-body-paragraph ks kt ir ku b kv mh js kx ky mi jv la lb mj ld le lf mk lh li lj ml ll lm ln ik bi translated">在本文中，我介绍了 Linux 磁盘 I/O 的性能指标和性能工具。我们通常使用几个指标来评估磁盘的 I/O 性能，如 IOPS、吞吐量、利用率、饱和度和响应时间。</p><p id="2366" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">可以用<code class="fe na nb nc nd b">iostat</code>来获取磁盘的 I/O 情况，也可以用<code class="fe na nb nc nd b">pidstat</code>、<code class="fe na nb nc nd b">iotop</code>等。观察进程的输入输出情况。但是，在分析这些性能指标时，要注意结合读写比、I/O 类型、I/O 大小进行综合分析。</p></div></div>    
</body>
</html>