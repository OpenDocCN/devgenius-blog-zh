<html>
<head>
<title>Server-Side Development with Fastify — Hooks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Fastify进行服务器端开发— Hooks</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/server-side-development-with-fastify-hooks-cde209d1898d?source=collection_archive---------4-----------------------#2021-02-25">https://blog.devgenius.io/server-side-development-with-fastify-hooks-cde209d1898d?source=collection_archive---------4-----------------------#2021-02-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/bb19ffc2b50e957286fc70d65e4a3d0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*GLCL0OZ7mfznmDFE"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">安德斯·吉尔登在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="adcf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Fastify是一个用于开发后端web应用程序的小型节点框架。</p><p id="af85" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将了解如何使用Fastify创建后端应用程序。</p><h1 id="b612" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">准备挂钩</h1><p id="3aec" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated"><code class="fe me mf mg mh b">preParsing</code>钩子让我们在解析请求有效负载流之前对其进行转换。</p><p id="8d7c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果它返回值，它必须返回一个流。</p><p id="7584" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="ad4a" class="mq lc iq mh b gy mr ms l mt mu">const fastify = require('fastify')({})</span><span id="0ac3" class="mq lc iq mh b gy mv ms l mt mu">fastify.addHook('preParsing', (request, reply, payload, done) =&gt; {    <br/>  done(null, payload)<br/>})</span><span id="11e3" class="mq lc iq mh b gy mv ms l mt mu">const start = async () =&gt; {<br/>  try {<br/>    fastify.post('/', function (request, reply) {<br/>      reply.send()<br/>    })<br/>    await fastify.listen(3000, '0.0.0.0')  <br/>  } catch (err) {<br/>    fastify.log.error(err)    <br/>    process.exit(1)<br/>  }<br/>}<br/>start()</span></pre><p id="8525" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">将<code class="fe me mf mg mh b">payload</code>传递给<code class="fe me mf mg mh b">done</code>函数。</p><p id="e036" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="8b62" class="mq lc iq mh b gy mr ms l mt mu">const fastify = require('fastify')({})</span><span id="5888" class="mq lc iq mh b gy mv ms l mt mu">fastify.addHook('preParsing', async (request, reply, payload) =&gt; {<br/>  return payload<br/>})<br/>const start = async () =&gt; {<br/>  try {<br/>    fastify.post('/', function (request, reply) {<br/>      reply.send()<br/>    })<br/>    await fastify.listen(3000, '0.0.0.0')  <br/>  } catch (err) {<br/>    fastify.log.error(err)    <br/>    process.exit(1)<br/>  }<br/>}<br/>start()</span></pre><p id="531e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">向<code class="fe me mf mg mh b">payload</code>返回承诺解析。</p><h1 id="0fcf" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">预验证</h1><p id="8a70" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated"><code class="fe me mf mg mh b">preValidation</code>钩子让我们在验证请求之前运行代码。</p><p id="69d9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它在<code class="fe me mf mg mh b">preParsing</code>挂钩后运行。</p><p id="412d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="4869" class="mq lc iq mh b gy mr ms l mt mu">const fastify = require('fastify')({})</span><span id="2252" class="mq lc iq mh b gy mv ms l mt mu">fastify.addHook('preValidation', (request, reply, done) =&gt; {<br/>  done()<br/>})</span><span id="9002" class="mq lc iq mh b gy mv ms l mt mu">const start = async () =&gt; {<br/>  try {<br/>    fastify.post('/', function (request, reply) {<br/>      reply.send()<br/>    })<br/>    await fastify.listen(3000, '0.0.0.0')  <br/>  } catch (err) {<br/>    fastify.log.error(err)    <br/>    process.exit(1)<br/>  }<br/>}<br/>start()</span></pre><p id="2866" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以在回调中添加一些检查。</p><p id="7951" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们也可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="54d9" class="mq lc iq mh b gy mr ms l mt mu">const fastify = require('fastify')({})</span><span id="05fe" class="mq lc iq mh b gy mv ms l mt mu">fastify.addHook('preValidation', async (request, reply) =&gt; {   <br/>  return<br/>})</span><span id="ad77" class="mq lc iq mh b gy mv ms l mt mu">const start = async () =&gt; {<br/>  try {<br/>    fastify.post('/', function (request, reply) {<br/>      reply.send()<br/>    })<br/>    await fastify.listen(3000, '0.0.0.0')  <br/>  } catch (err) {<br/>    fastify.log.error(err)    <br/>    process.exit(1)<br/>  }<br/>}<br/>start()</span></pre><p id="680b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">做同样的事情。</p><h1 id="75cc" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">前序列化</h1><p id="0a1a" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated"><code class="fe me mf mg mh b">preSerialization</code>挂钩允许在有效载荷序列化之前对其进行更改或替换。</p><p id="fb80" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="8569" class="mq lc iq mh b gy mr ms l mt mu">const fastify = require('fastify')({})</span><span id="85d1" class="mq lc iq mh b gy mv ms l mt mu">fastify.addHook('preSerialization', (request, reply, payload, done) =&gt; {<br/>  const err = null<br/>  const newPayload = { wrapped: payload }<br/>  done(err, newPayload)<br/>})</span><span id="3367" class="mq lc iq mh b gy mv ms l mt mu">const start = async () =&gt; {<br/>  try {<br/>    fastify.post('/', function (request, reply) {<br/>      reply.send(request.body)<br/>    })<br/>    await fastify.listen(3000, '0.0.0.0')  <br/>  } catch (err) {<br/>    fastify.log.error(err)    <br/>    process.exit(1)<br/>  }<br/>}<br/>start()</span></pre><p id="76f0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，当我们用有效载荷向<code class="fe me mf mg mh b">/</code>发出POST请求时:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="2756" class="mq lc iq mh b gy mr ms l mt mu">{<br/>    "abc": 123<br/>}</span></pre><p id="d496" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们得到:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="473e" class="mq lc iq mh b gy mr ms l mt mu">{<br/>    "wrapped": {<br/>        "abc": 123<br/>    }<br/>}</span></pre><p id="1af3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">作为回应。</p><p id="146e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">等价地，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="c448" class="mq lc iq mh b gy mr ms l mt mu">const fastify = require('fastify')({})</span><span id="5441" class="mq lc iq mh b gy mv ms l mt mu">fastify.addHook('preSerialization', async (request, reply, payload) =&gt; {<br/>  return { wrapped: payload }<br/>})</span><span id="f980" class="mq lc iq mh b gy mv ms l mt mu">const start = async () =&gt; {<br/>  try {<br/>    fastify.post('/', function (request, reply) {<br/>      reply.send(request.body)<br/>    })<br/>    await fastify.listen(3000, '0.0.0.0')  <br/>  } catch (err) {<br/>    fastify.log.error(err)    <br/>    process.exit(1)<br/>  }<br/>}<br/>start()</span></pre><p id="236e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">得到同样的结果。</p><p id="776c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果有效负载是字符串、缓冲区、流或<code class="fe me mf mg mh b">null</code>，则不调用这个钩子。</p><h1 id="678e" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">错误</h1><p id="d491" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">钩子让我们捕捉应用程序中出现的错误。</p><p id="6bb9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="b181" class="mq lc iq mh b gy mr ms l mt mu">const fastify = require('fastify')({})</span><span id="95c5" class="mq lc iq mh b gy mv ms l mt mu">fastify.addHook('onError', (request, reply, error, done) =&gt; {<br/>  done()<br/>})</span><span id="2bf9" class="mq lc iq mh b gy mv ms l mt mu">const start = async () =&gt; {<br/>  try {<br/>    fastify.post('/', function (request, reply) {<br/>      reply.send(request.body)<br/>    })<br/>    await fastify.listen(3000, '0.0.0.0')  <br/>  } catch (err) {<br/>    fastify.log.error(err)    <br/>    process.exit(1)<br/>  }<br/>}<br/>start()</span></pre><p id="3c49" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">捕捉错误。<code class="fe me mf mg mh b">error</code>有错误数据。</p><p id="973d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">同样，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="f381" class="mq lc iq mh b gy mr ms l mt mu">const fastify = require('fastify')({})</span><span id="9d44" class="mq lc iq mh b gy mv ms l mt mu">fastify.addHook('onError', async (request, reply, error) =&gt; {<br/>  console.log(error)<br/>})</span><span id="8a98" class="mq lc iq mh b gy mv ms l mt mu">const start = async () =&gt; {<br/>  try {<br/>    fastify.post('/', function (request, reply) {<br/>      reply.send(request.body)<br/>    })<br/>    await fastify.listen(3000, '0.0.0.0')  <br/>  } catch (err) {<br/>    fastify.log.error(err)    <br/>    process.exit(1)<br/>  }<br/>}<br/>start()</span></pre><p id="0e84" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">做同样的事情。</p><h1 id="893a" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="1729" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以添加钩子，用Fastify收听各种事件。</p></div></div>    
</body>
</html>