<html>
<head>
<title>Rewrite Rules in Nginx</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在 Nginx 中重写规则</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/rewrite-rules-in-nginx-130c3b8803f3?source=collection_archive---------4-----------------------#2021-10-22">https://blog.devgenius.io/rewrite-rules-in-nginx-130c3b8803f3?source=collection_archive---------4-----------------------#2021-10-22</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/ed4832bda526ce0fb14f9beb8c1f4c06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4bCfLnsC3FP5_rNModQzog.jpeg"/></div></div></figure><p id="af0e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">由<a class="ae kt" href="https://blog.engineyard.com/author/ritu-chaturvedi" rel="noopener ugc nofollow" target="_blank"> Ritu Chaturvedi </a></p><p id="eaeb" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="ku">重写规则</em>修改部分或全部网址。这样做有两个原因。首先，通知客户端资源的重新分配，其次，控制到 Nginx 的流量。广泛用于重写 URL 的两种通用方法是<em class="ku"> return </em>指令和<em class="ku"> rewrite </em>指令。其中，重写指令更强大。让我们讨论一下为什么会这样，以及如何重写 URL。</p><p id="e46f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">对 NGINX 有更好的<a class="ae kt" href="https://www.thegeekstuff.com/2013/11/nginx-vs-apache/" rel="noopener ugc nofollow" target="_blank">理解会让关注这个博客更容易。</a></p><p id="a094" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">返回<em class="ku">指令</em>返回</strong></p><p id="f72c" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="ku"> Return </em>是重写在服务器或本地机器上声明的 URL 的最简单的方法。</p><p id="79a3" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io"> <em class="ku">返回服务器中的</em>:</strong></p><p id="9e11" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">假设您的站点被迁移到一个新域，所有现有的 URL 都将被重定向到这里；运行下面的代码将任何新请求定向到您的站点。</p><figure class="kw kx ky kz gt jo gh gi paragraph-image"><div class="gh gi kv"><img src="../Images/ca2dcd62a9faf663bbb4b0056627686d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/format:webp/0*6Y84Rvq2DcBUwFvA.png"/></div></figure><p id="41f5" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这将引导所有命中 www 的请求。【previousdomain.com】<em class="ku"/>到<a class="ae kt" href="http://www.currentdomain.com." rel="noopener ugc nofollow" target="_blank"><em class="ku">www.currentdomain.com。</em></a><em class="ku"/><a class="ae kt" href="http://www.previousomain.com" rel="noopener ugc nofollow" target="_blank">www。<em class="ku">previousomain.com</em>两个变量，<em class="ku"> $scheme </em>和<em class="ku"> $request_uri，</em>从输入的 URL 获取数据。<em class="ku">Listen 80’</em>表示该阻塞同时适用于 HTTP 和 HTTPS 请求。</a></p><p id="b6d8" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">中的<em class="ku">返回</em>中的</strong></p><p id="af59" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如果你想重定向页面来代替一个完整的域，你可以使用位置块下的<em class="ku"> return </em>指令。</p><p id="85ad" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">知道如何创建 Nginx 重写规则可以节省你大量的精力和时间。</p><p id="9897" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">重写指令</strong></p><p id="06ad" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">就像<em class="ku"> return </em>指令一样，rewrite 指令也可以在服务器和本地起作用。与<em class="ku"> return </em>指令相比，<em class="ku"> rewrite </em>指令可以处理复杂的 URL 替换。下面是<em class="ku">重写</em>的语法:</p><figure class="kw kx ky kz gt jo gh gi paragraph-image"><div class="gh gi la"><img src="../Images/16ef4a5ac0c6fd0c848b0f6728e4847f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1254/format:webp/0*6XmR-SZJRahEAPGv.png"/></div></figure><p id="bccf" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="ku"> regex </em>是一个正则表达式，用于匹配传入的 URI。</p><p id="f700" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="ku"> replacement_url </em>是用于改变所请求的 URI 的字符串。</p><p id="b97d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="ku">标志</em>的值决定是否需要更多的重定向或处理。</p><p id="9244" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">静态页面<em class="ku">改写</em> </strong></p><p id="e6cd" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">假设你想把页面<a class="ae kt" href="https://example.com/tutorial" rel="noopener ugc nofollow" target="_blank"><em class="ku">https://example.com/tutorial</em></a>重定向到<a class="ae kt" href="https://example.com/new_page." rel="noopener ugc nofollow" target="_blank"><em class="ku">https://example.com/new_page</em>。</a>该指令将:</p><figure class="kw kx ky kz gt jo gh gi paragraph-image"><div class="gh gi lb"><img src="../Images/564f350df252365cec4d27c7087ec487.png" data-original-src="https://miro.medium.com/v2/resize:fit:1244/format:webp/0*L1I7ha-Vk2LgynLg.png"/></div></figure><p id="b212" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">行<em class="ku"> location = /tutorial </em>定义了指南的任何标识都将被替换。<em class="ku">重写</em>命令表示用'<em class="ku">new _ page . html '【t23]替换符号<em class="ku"> ^ </em>和$中的短语，然后中断该命令。符号“？”被称为非贪婪修饰符，在此之后模式搜索停止。</em></p><p id="3bf0" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">动态页面<em class="ku">重写</em> </strong></p><p id="0264" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">考虑将网址<a class="ae kt" href="https://www.sample.com/user.php?id=11" rel="noopener ugc nofollow" target="_blank"><em class="ku">https://www.sample.com/user.php?id=11</em></a><em class="ku"/>改写为<a class="ae kt" href="https://www.sample.com/user/11." rel="noopener ugc nofollow" target="_blank"><em class="ku">https://www.sample.com/user/11</em>。</a>此处，user=11 将被替换。通过使用静态重写方法，需要写重写命令 10 次。相反，让我们一步到位。</p><figure class="kw kx ky kz gt jo gh gi paragraph-image"><div class="gh gi lb"><img src="../Images/2a23d9335806f92c52b14968345b766f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1244/format:webp/0*81xU5vrWtJKLxQgn.png"/></div></figure><p id="f81f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">第<em class="ku">行 location = /user.php </em>要求 Nginx 检查前缀'/user '。如前所述，Nginx 将在开始和结束符号之间搜索短语，如<em class="ku"> ^ </em>和$以及非贪婪的“？”修饰语。我们例子中的短语是一个用户范围。它在方括号中被称为[0–9]+该表达式中的反向引用在括号中注明，并由$1 符号引用。因此，对于我们的例子，重写将自动为所有用户发生。</p><p id="45ad" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">动态引用的一个特例是多个反向引用。</p><p id="0aa3" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在，我们已经讨论了如何为简单和复杂的 URL 编写重写规则。</p><p id="a289" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">通过一些处理各种场景的<a class="ae kt" href="https://www.thegeekstuff.com/2017/08/nginx-rewrite-examples/" rel="noopener ugc nofollow" target="_blank">例子</a>理解重写规则的详细工作。</p><h1 id="2ff0" class="lc ld in bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">直接比较</h1><p id="2f7f" class="pw-post-body-paragraph jv jw in jx b jy ma ka kb kc mb ke kf kg mc ki kj kk md km kn ko me kq kr ks ig bi translated">让我们通过比较这两个指令来分析它们，并找出为什么重写派生指令更强大。</p><p id="5804" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">退货指令</strong></p><ul class=""><li id="210f" class="mf mg in jx b jy jz kc kd kg mh kk mi ko mj ks mk ml mm mn bi translated">使用和理解都很简单。</li><li id="14f7" class="mf mg in jx b jy mo kc mp kg mq kk mr ko ms ks mk ml mm mn bi translated">它可以在服务器和位置环境中使用。</li><li id="863a" class="mf mg in jx b jy mo kc mp kg mq kk mr ko ms ks mk ml mm mn bi translated">它明确地提到了修正或更新的 URL，以便客户将来可以使用它们。</li><li id="d6f4" class="mf mg in jx b jy mo kc mp kg mq kk mr ko ms ks mk ml mm mn bi translated">返回指令也可以包含多个错误代码。</li><li id="25af" class="mf mg in jx b jy mo kc mp kg mq kk mr ko ms ks mk ml mm mn bi translated">对于代码 301、302、303 和 307，URL 参数定义重定向 URL。</li></ul><p id="6927" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="ku">返回(301 | 302 | 303 | 307)网址；</em></p><ul class=""><li id="6220" class="mf mg in jx b jy jz kc kd kg mh kk mi ko mj ks mk ml mm mn bi translated">对于其他代码，文本将由用户明确提及。</li></ul><p id="6b64" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="ku">return(1xx | 2xx | 4xx | 5xx)[" text "]；</em></p><p id="78c2" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">例如:<em class="ku">返回 401“由于令牌过期或无效，访问被拒绝”；</em></p><ul class=""><li id="7fc3" class="mf mg in jx b jy jz kc kd kg mh kk mi ko mj ks mk ml mm mn bi translated">该指令可用于返回的 URL 对于服务器和位置块都是正确的情况，并且重写的 URL 是用 Nginx 变量构建的。</li></ul><p id="a605" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">重写指令</strong></p><ul class=""><li id="2afe" class="mf mg in jx b jy jz kc kd kg mh kk mi ko mj ks mk ml mm mn bi translated">它可以适应更复杂的 URL 修改，其中需要在没有 Nginx 变量的情况下捕获元素或更新路径中的元素。</li><li id="8999" class="mf mg in jx b jy mo kc mp kg mq kk mr ko ms ks mk ml mm mn bi translated">它可以在服务器和位置环境中使用。</li><li id="e021" class="mf mg in jx b jy mo kc mp kg mq kk mr ko ms ks mk ml mm mn bi translated">重写指令只能返回代码 301 或 302。若要容纳其他代码，请在 rewrite 指令后显式添加 return 指令。</li><li id="cfee" class="mf mg in jx b jy mo kc mp kg mq kk mr ko ms ks mk ml mm mn bi translated">它可能不会向客户端发送重定向详细信息。</li><li id="1b0a" class="mf mg in jx b jy mo kc mp kg mq kk mr ko ms ks mk ml mm mn bi translated">Nginx 请求处理不会暂停。</li></ul><h1 id="969a" class="lc ld in bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">结论</h1><p id="8e14" class="pw-post-body-paragraph jv jw in jx b jy ma ka kb kc mb ke kf kg mc ki kj kk md km kn ko me kq kr ks ig bi translated"><em class="ku"> return </em>和<em class="ku"> rewrite </em>指令可用于在服务器和位置上下文中重定向 URL。虽然 return 指令简单得多，但是 rewrite 指令被广泛使用，因为它也可以处理对 URL 的复杂修改/更新。</p></div><div class="ab cl mt mu hr mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="ig ih ii ij ik"><p id="5fa1" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="ku">原载于</em><a class="ae kt" href="https://blog.engineyard.com/rewrite-rules-nginx?utm_source=medium.com&amp;utm_medium=Devgraph&amp;utm_id=QiWorks.in" rel="noopener ugc nofollow" target="_blank"><em class="ku">https://blog.engineyard.com</em></a><em class="ku">。</em></p></div></div>    
</body>
</html>