<html>
<head>
<title>Zero Downtime Mongo DB Migration</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">零停机 Mongo 数据库迁移</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/zero-downtime-mongo-db-migration-96c736cb0db?source=collection_archive---------9-----------------------#2022-03-01">https://blog.devgenius.io/zero-downtime-mongo-db-migration-96c736cb0db?source=collection_archive---------9-----------------------#2022-03-01</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="3059" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">TL；DR: </strong>如果您想将您的数据从基于本地 k8s 的 mongo DB 迁移到云管理的 kubernetes 集群(EKS)上的 Mongo DB，这里有一个分步指南。</p><p id="3989" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">背景:</strong></p><p id="8ca4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">其中一个客户希望将其整个平台从本地基础设施迁移到 AWS 云，包括微服务架构中涉及的有状态和无状态组件。这种迁移的主要瓶颈是 MongoDB 迁移，因为客户机不能承受其数字平台上的任何停机时间。</p><p id="2227" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">为了实现零宕机的 mongoDB 迁移，我们使用了 mongoDB 的 MongoDB 复制机制，然后将它们重新配置为新迁移的 MongoDB 复制集。</p><p id="b4fa" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">设置连接:</strong></p><p id="a29c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在这个设置中，我们有 3 个属于 mongo replicaSet rs0 的 pod。其中一个 pod 是主 pod，另外两个辅助 pod 与主 pod 同步。</p><p id="ccc2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让我们从 on-prem 调用现有的 pod<strong class="jm io">mongo-0、mongo-1、mongo-2 </strong>，我们需要迁移的云上的数据的 mongoDB pods 是<strong class="jm io"> cloud-0、cloud-1、cloud-2。</strong>确保您能够解析本地和云环境中的所有主机名。</p><p id="db59" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在，为了执行迁移，我们首先必须验证 mongoDB 成员之间的连通性。这里我们需要 4 种类型的连接:</p><ol class=""><li id="27d9" class="ki kj in jm b jn jo jr js jv kk jz kl kd km kh kn ko kp kq bi translated">在数据将要迁移到的新 mongoDB 成员之间(<strong class="jm io"> cloud-0，cloud-1，cloud-2 在端口 27017 </strong></li><li id="7ec4" class="ki kj in jm b jn kr jr ks jv kt jz ku kd kv kh kn ko kp kq bi translated">在数据将要迁移的旧 mongoDB 成员之间(<strong class="jm io"> mongo-0、mongo-1、mongo-2 在端口 27017 上</strong>)</li><li id="3cb0" class="ki kj in jm b jn kr jr ks jv kt jz ku kd kv kh kn ko kp kq bi translated">新旧 mongoDB 吊舱之间(在端口<strong class="jm io"> 27017 上的<strong class="jm io"> cloud-0 </strong>、<strong class="jm io"> cloud-1、cloud-2 </strong>与端口<strong class="jm io"> 27017 上的 mongo-0、mongo-1、mongo-2 </strong>之间，反之亦然</strong>)</li><li id="7ab0" class="ki kj in jm b jn kr jr ks jv kt jz ku kd kv kh kn ko kp kq bi translated">从有状态集群 mongoDB 到无状态集群(应用平面)</li></ol><figure class="kx ky kz la gt lb gh gi paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="gh gi kw"><img src="../Images/fae1882df295a348048c8b4c97c27e7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1372/format:webp/1*6SzM4pU9-xoHk-tL9s7Miw.jpeg"/></div></div><figcaption class="li lj gj gh gi lk ll bd b be z dk translated">从本地到 AWS EKS 集群的 MongoDB 连接</figcaption></figure><p id="b0a2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">同步所有数据:<br/> </strong>一旦连接测试成功，开始使用以下命令逐个添加新成员…</p><pre class="kx ky kz la gt lm ln lo lp aw lq bi"><span id="5cfe" class="lr ls in ln b gy lt lu l lv lw">rs.add("mongo0:27017");<br/>cfg = rs.conf();<br/>cfg.members[3].votes = 0;<br/>cfg.members[3].priority = 0;<br/>rs.reconfig(cfg);<br/>#Once it transitions to secondary proceed further</span><span id="b331" class="lr ls in ln b gy lx lu l lv lw">rs.add("mongo1:27017");<br/>cfg = rs.conf();<br/>cfg.members[4].votes = 0;<br/>cfg.members[4].priority = 0;<br/>rs.reconfig(cfg);</span><span id="56de" class="lr ls in ln b gy lx lu l lv lw">#Once it transitions to secondary proceed further</span><span id="ff66" class="lr ls in ln b gy lx lu l lv lw">rs.add("mongo2:27017");<br/>cfg = rs.conf();<br/>cfg.members[5].votes = 0;<br/>cfg.members[5].priority = 0;<br/>rs.reconfig(cfg);</span><span id="6ff4" class="lr ls in ln b gy lx lu l lv lw">#Once it transitions to secondary proceed further</span></pre><p id="5e9c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">更改投票和优先级:</strong></p><p id="d1be" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在，作为副本集 rs0 的一部分，我们有了 1 个主要成员和 5 个次要成员。</p><p id="e29e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在，我们确保在同步过程中，没有云成员有资格投票成为主要成员。现在，我们将更改成员的投票和优先级，以便其中一个云成员成为主要成员。</p><p id="779f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">选举初选:</strong></p><p id="83a1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">要从 3 个云辅助实例中选择一个主实例，请在主 mongo 实例上运行以下命令:</p><pre class="kx ky kz la gt lm ln lo lp aw lq bi"><span id="2789" class="lr ls in ln b gy lt lu l lv lw">cfg = rs.conf();<br/>cfg.members[0].votes = 0.5;<br/>cfg.members[0].priority = 0.5;<br/>cfg.members[1].votes = 0.5;<br/>cfg.members[1].priority = 0.5;<br/>cfg.members[2].votes = 0.5;<br/>cfg.members[2].priority = 0.5;</span><span id="34e9" class="lr ls in ln b gy lx lu l lv lw">cfg.members[3].votes = 1;<br/>cfg.members[3].priority = 1;<br/>cfg.members[4].votes = 1;<br/>cfg.members[4].priority = 1;<br/>cfg.members[5].votes = 1;<br/>cfg.members[5].priority = 1;</span><span id="120e" class="lr ls in ln b gy lx lu l lv lw">rs.reconfig(cfg);<br/># after running above command, primary on-prem member will become secondary and one of the cloud member will be elected as Primary member.</span></pre><p id="9c8e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">恭喜:</strong></p><p id="54c8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">太好了！我们成功地将主要 mongoDB 成员从本地切换到云。现在，您可以安全地删除旧的 mongo-0、mongo-1 和 mongo-2 成员，并更改 mongoDB 的连接字符串，该字符串被所有支持的应用程序使用。</p><p id="0b94" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">删除辅助内部成员的命令有:</p><pre class="kx ky kz la gt lm ln lo lp aw lq bi"><span id="2718" class="lr ls in ln b gy lt lu l lv lw">rs.remove(mongo-0);<br/>rs.remove(mongo-1);<br/>rs.remove(mongo-2);</span></pre><p id="b9e3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果您的后端应用程序能够解析(本地和云)mongo 成员主机名，上述步骤不会导致任何停机。确保在连接字符串更改后重新启动所有服务。</p></div><div class="ab cl ly lz hr ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="ig ih ii ij ik"><p id="4171" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果这有帮助，或者如果你有问题，请留下评论。</p><p id="07f8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">感谢您的阅读。</p></div></div>    
</body>
</html>