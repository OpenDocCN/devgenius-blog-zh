<html>
<head>
<title>Automating installation of HA RKE2 Kubernetes cluster with Ansible</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Ansible 自动安装 HA RKE2 Kubernetes 集群</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/automating-installation-of-ha-rke2-kubernetes-cluster-with-ansible-2456cc95d970?source=collection_archive---------1-----------------------#2022-01-04">https://blog.devgenius.io/automating-installation-of-ha-rke2-kubernetes-cluster-with-ansible-2456cc95d970?source=collection_archive---------1-----------------------#2022-01-04</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="57f6" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">使用 kube-vip 创建 Ansible 清单并安装高可用性(HA) RKE2 集群。</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi kc"><img src="../Images/3373d1abb973d0f5a6610cc52795d722.png" data-original-src="https://miro.medium.com/v2/resize:fit:1382/1*5W0xsO11iqd8GWn6hr-NcQ.gif"/></div></figure><p id="2b2a" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">虽然有不同的方法来安装 Kubernetes 集群，尤其是在云平台中的托管集群，但仍然有一些情况下我们需要在 DC 中的裸机上安装它。因此，根据您的需求，可能会出现一些与安装相关的问题，包括如何自动化该过程，使其灵活且可重新部署？</p><p id="aa1c" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们将使用<a class="ae lg" href="https://docs.rke2.io" rel="noopener ugc nofollow" target="_blank"> RKE2 </a>来供应和管理 Kubernetes 集群，<a class="ae lg" href="https://kube-vip.chipzoller.dev/" rel="noopener ugc nofollow" target="_blank"> kube-vip </a>用于 HA 故障转移解决方案，而<a class="ae lg" href="https://www.ansible.com" rel="noopener ugc nofollow" target="_blank"> Ansible </a>用于自动化安装过程，使其具有灵活性和可重新部署性。</p><p id="a800" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">在开始之前，我想简单地提示一下我们要用 Ansible 创建和应用的步骤和文件的顺序，以便用 kube-vip 准备好我们的 HA RKE2 集群。</p><pre class="kd ke kf kg gt lh li lj lk aw ll bi"><span id="b190" class="lm ln in li b gy lo lp l lq lr">.<br/>├── <strong class="li io">inventory_file</strong> # Hostnames of master and agent nodes (<strong class="li io">1</strong>)<br/>├── <strong class="li io">env_vars.yaml</strong> # The environment variables (<strong class="li io">2</strong>)<br/>├── <strong class="li io">rke2-install-server.yml</strong> # The first master node (<strong class="li io">3</strong>)<br/>├── <strong class="li io">kube-vip.yaml</strong> # For kube-vip installation (<strong class="li io">4</strong>)<br/>└── <strong class="li io">token.enc</strong> # Encrypted TOKEN (<strong class="li io">5</strong>)<br/>├── <strong class="li io">rke2-add-server.yaml</strong> # For additional master nodes (<strong class="li io">6</strong>)<br/>├── <strong class="li io">rke2-add-agent-node.yaml</strong> # For adding the agent nodes (<strong class="li io">7</strong>)<br/><br/>0 directories, 7 files</span></pre></div><div class="ab cl ls lt hr lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ig ih ii ij ik"><p id="5c34" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">为了拥有一个 HA <a class="ae lg" href="https://docs.rke2.io/" rel="noopener ugc nofollow" target="_blank"> RKE2 </a>集群，我们需要:</p><ul class=""><li id="06b1" class="lz ma in km b kn ko kq kr kt mb kx mc lb md lf me mf mg mh bi translated">至少 3 个主节点</li><li id="5d38" class="lz ma in km b kn mi kq mj kt mk kx ml lb mm lf me mf mg mh bi translated">控制平面节点之间具有浮动 IP 地址的故障切换解决方案<br/> <strong class="km io"> * </strong> DNS 记录指向该浮动 IP 地址<br/><strong class="km io">*</strong><a class="ae lg" href="https://kube-vip.chipzoller.dev/docs" rel="noopener ugc nofollow" target="_blank"><strong class="km io">kube-VIP</strong></a><strong class="km io">。</strong>对于<strong class="km io"> </strong>高可用性故障转移解决方案，我将选择<a class="ae lg" href="https://kube-vip.chipzoller.dev/docs" rel="noopener ugc nofollow" target="_blank"> <strong class="km io"> kube-vip </strong> </a>，与其他类似工具相比，它本身支持控制平面健康监视(<em class="mn">控制平面负载平衡</em>)以及许多其他有用的<a class="ae lg" href="https://kube-vip.chipzoller.dev/docs/about/features" rel="noopener ugc nofollow" target="_blank">功能</a></li><li id="b2ee" class="lz ma in km b kn mi kq mj kt mk kx ml lb mm lf me mf mg mh bi translated">3 个工作节点，用于集群中的插件和其他工作负载。</li></ul><blockquote class="mo"><p id="1f3b" class="mp mq in bd mr ms mt mu mv mw mx lf dk translated">让我们继续讨论<a class="ae lg" href="https://www.ansible.com" rel="noopener ugc nofollow" target="_blank"> <em class="my"> Ansible </em> </a> <em class="my">清单。</em></p></blockquote><p id="3acc" class="pw-post-body-paragraph kk kl in km b kn mz jo kp kq na jr ks kt nb kv kw kx nc kz la lb nd ld le lf ig bi translated">在我们的例子中，ansi ble<strong class="km io">$ Inventory _ File</strong>(用您的库存文件替换它)的内容是</p><ul class=""><li id="1223" class="lz ma in km b kn ko kq kr kt mb kx mc lb md lf me mf mg mh bi translated"><strong class="km io">。/inventory_file </strong></li></ul><pre class="kd ke kf kg gt lh li lj lk aw ll bi"><span id="afff" class="lm ln in li b gy lo lp l lq lr">all:<br/>  hosts:<br/>    example-host1: # master node<br/>    example-host2: # master node<br/>    example-host3: # master node<br/>    example-host4: # agent node<br/>    example-host5: # agent node<br/>    example-host6: # agent node</span></pre><p id="38e8" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">为了避免重用这些值，让我们创建环境变量文件，供以后在 ansible 清单中使用:</p><ul class=""><li id="a51b" class="lz ma in km b kn ko kq kr kt mb kx mc lb md lf me mf mg mh bi translated"><strong class="km io">。/env_vars.yaml </strong></li></ul><pre class="kd ke kf kg gt lh li lj lk aw ll bi"><span id="14b5" class="lm ln in li b gy lo lp l lq lr">##################################################<br/>##################################################<br/>###               RKE2 Configs                 ###<br/>##################################################<br/>##################################################<br/><br/>WATCHDIR: "/var/lib/rancher/rke2/server/manifests"<br/>CONFDIR: "/etc/rancher/rke2"<br/>CONFFILE: "{{ CONFDIR }}/config.yaml"<br/>SERVER_FAILOVER_IP: "w.x.y.z" <strong class="li io"># Replace with your failover floating IP address.</strong><br/>SERVER_ADDRESS_SHORT: "example-hostname" <strong class="li io"># Hostname pointed to failover floating IP (</strong>w.x.y.z<strong class="li io">), change with yours.</strong><br/>SERVER_ADDRESS_FQDN: "example-hostname.somedomain.tld" <strong class="li io"># FQDN pointed to failover floating IP (</strong>w.x.y.z<strong class="li io">), change with yours.</strong><br/><br/>##################################################<br/>##################################################<br/>###               RKE2 Version                 ###<br/>##################################################<br/>##################################################<br/><br/>INSTALL_RKE2_VERSION: "v1.22.4+rke2r2" <strong class="li io"># Change with your preferred version.</strong><br/><br/>##################################################<br/>##################################################<br/>###                kube-vip                    ###<br/>##################################################<br/>##################################################<br/><br/>INTERFACE: "ens192" <strong class="li io"># Change with yor IFACE</strong><br/>VIP: "{{ SERVER_FAILOVER_IP }}"<br/>CONTAINER_RUNTIME_ENDPOINT: "unix:///run/k3s/containerd/containerd.sock"<br/>CONTAINERD_ADDRESS: "/run/k3s/containerd/containerd.sock"<br/>KUBE_VIP_IMAGE: "docker.io/plndr/kube-vip"<br/>KUBE_VIP_IMAGE_TAG: "latest"</span></pre><p id="4028" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">开始时，我们需要安装第一个主节点。让我们为此创建一个 ansible 清单。</p><ul class=""><li id="0b40" class="lz ma in km b kn ko kq kr kt mb kx mc lb md lf me mf mg mh bi translated"><strong class="km io">。/rke2-install-server.yaml </strong></li></ul><pre class="kd ke kf kg gt lh li lj lk aw ll bi"><span id="834e" class="lm ln in li b gy lo lp l lq lr">- name: Install rke2 first server instance<br/>  hosts: example-host1<br/>  become: true<br/>  vars_files:<br/>    - env_vars.yaml <br/><br/>  tasks:<br/>  - name: create directories if they don't exist<br/>    file:<br/>      path: "{{ item }}"<br/>      state: directory<br/>      owner: root<br/>      group: root<br/>      mode: 0755<br/>      recurse: yes<br/>    loop:<br/>      - "{{ CONFDIR }}"<br/>      - "{{ WATCHDIR }}"<br/><br/>  - name: get hostname short<br/>    shell: |<br/>      hostname -s<br/>    register: hostname_short<br/>  - name: hostname fqdn<br/>    shell: |<br/>      hostname -f<br/>    register: hostname_fqdn<br/><br/>  - name: Print hostname fqdn and short<br/>    debug:<br/>      msg:<br/>      - "hostname short '{{ hostname_short.stdout }}'"<br/>      - "hostname fqdn: '{{ hostname_fqdn.stdout }}'"<br/><br/>  - name: Creating the config.yaml<br/>    copy:<br/>      dest: "{{ CONFFILE }}"<br/>      content: |<br/>        tls-san:<br/>          - "{{ hostname_short.stdout }}"<br/>          - "{{ hostname_fqdn.stdout }}"<br/>          - "{{ SERVER_ADDRESS_SHORT }}"<br/>          - "{{ SERVER_ADDRESS_FQDN }}"<br/>          - "{{ SERVER_FAILOVER_IP }}"<br/>        <br/>        cni: "canal" # optional<br/>    notify: "rke2-server service restart"<br/><br/>  - name: Creating the CoreDNS config file<br/>    copy:<br/>      dest: "{{ WATCHDIR }}/rke2-coredns-config.yaml"<br/>      content: |<br/>        apiVersion: helm.cattle.io/v1<br/>        kind: HelmChartConfig<br/>        metadata:<br/>          creationTimestamp: null<br/>          name: rke2-coredns<br/>          namespace: kube-system<br/>        spec:<br/>          valuesContent: |-<br/>            nodelocal:<br/>              enabled: true <strong class="li io"># Change this to false or remove this (<em class="mn">Creating the CoreDNS config file</em>) section altogether if you don’t want to install <em class="mn">NodeLocal DNSCache</em></strong><br/>          bootstrap: true<br/><br/>  - name: Installing rke2 server<br/>    shell: |<br/>      curl -sfL https://get.rke2.io | INSTALL_RKE2_CHANNEL=stable INSTALL_RKE2_VERSION="{{ INSTALL_RKE2_VERSION }}" sh -<br/>    notify: "rke2-server service start"<br/><br/>  handlers:<br/>    - name: Make sure a service unit is running<br/>      systemd:<br/>        state: started<br/>        name: rke2-server<br/>      listen: "rke2-server service start"<br/><br/>    - name: Make sure a service unit is restarted<br/>      systemd:<br/>        state: restarted<br/>        name: rke2-server<br/>      listen: "rke2-server service restart"</span></pre><p id="8998" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">创建第一个主节点的 ansible 命令。</p><pre class="kd ke kf kg gt lh li lj lk aw ll bi"><span id="6486" class="lm ln in li b gy lo lp l lq lr"><strong class="li io">ansible-playbook -u $USERNAME -i $Inventory_File -l example-host1 ./rke2-install-server.yaml</strong></span></pre><p id="94c2" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">第一个主节点准备好了。</p><p id="700c" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">您可以在<strong class="km io"><em class="mn">/etc/rancher/rke 2/rke 2 . YAML</em></strong>文件中获取 kubectl 配置，默认情况下，服务器地址是 127.0.0.1，用您设置的主机名替换 example-host1，以便远程访问。稍后，在 kube-vip 安装后，我们将使用我们的 HA 浮动 ip 地址或主机名对其进行更改。</p><p id="6c74" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">在安装第二个和第三个主节点和其他代理节点之前，应该安装<a class="ae lg" href="https://kube-vip.chipzoller.dev/docs" rel="noopener ugc nofollow" target="_blank"> kube-vip </a>。</p><p id="f129" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated"><em class="mn">让我们为</em><strong class="km io"><em class="mn">kube-VIP</em></strong><em class="mn">安装</em>创建一个 ansible 清单文件</p><ul class=""><li id="a3cc" class="lz ma in km b kn ko kq kr kt mb kx mc lb md lf me mf mg mh bi translated"><strong class="km io">。/kube-vip.yaml </strong></li></ul><pre class="kd ke kf kg gt lh li lj lk aw ll bi"><span id="4b15" class="lm ln in li b gy lo lp l lq lr">- name: Install kube-vip<br/>  hosts: example-host1<br/>  become: true<br/>  vars_files:<br/>    - env_vars.yaml  <br/><br/>  tasks:<br/>  - name: Download kube-vip RBAC file<br/>    get_url:<br/>      url: https://kube-vip.io/manifests/rbac.yaml<br/>      dest: "{{ WATCHDIR }}/kube-vip-rbac.yaml"<br/>      owner: root<br/>      group: root<br/>      mode: 0644<br/><br/>  - name: Deploying kube-vip<br/>    shell: |<br/>      ctr --namespace k8s.io image pull "{{ KUBE_VIP_IMAGE }}":"{{ KUBE_VIP_IMAGE_TAG }}"<br/>      ctr --namespace k8s.io run --rm --net-host "{{ KUBE_VIP_IMAGE }}":"{{ KUBE_VIP_IMAGE_TAG }}" vip /kube-vip \<br/>      manifest daemonset \<br/>      --arp \<br/>      --interface "{{ INTERFACE }}" \<br/>      --address "{{ VIP }}" \<br/>      --controlplane \<br/>      --leaderElection \<br/>      --taint \<br/>      --services \<br/>      --inCluster | tee "{{ WATCHDIR }}/kube-vip.yaml"</span></pre><p id="9db3" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated"><strong class="km io">安装 kube-vip 的 ansible 命令:</strong></p><pre class="kd ke kf kg gt lh li lj lk aw ll bi"><span id="c6a5" class="lm ln in li b gy lo lp l lq lr"><strong class="li io">ansible-playbook -u $USERNAME -i $Inventory_File -l example-host1 ./kube-vip.yaml</strong></span></pre><p id="0515" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">在此步骤之后，浮动 IP 地址由 kube-vip daemonset 在第一个主节点示例 host1 上提出，因为<em class="mn"> RKE2 监视</em><strong class="km io"><em class="mn">/var/lib/rancher/rke 2/server/manifests</em></strong>(在我们的 ansible variables 文件中，<strong class="km io"> </strong>将<strong class="km io"> </strong>定义为<strong class="km io"> WATCHDIR </strong>)目录中的所有文件，并将其安装到集群中，因此不需要在</p><p id="53bf" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">要查看 kube-vip pod 和 ip 是否正在运行/就绪，您可以使用以下<a class="ae lg" href="https://kubernetes.io/docs/reference/kubectl/cheatsheet/" rel="noopener ugc nofollow" target="_blank"> <strong class="km io"> kubectl </strong> </a>命令:</p><pre class="kd ke kf kg gt lh li lj lk aw ll bi"><span id="f9b9" class="lm ln in li b gy lo lp l lq lr"><strong class="li io">kubectl -n kube-system logs $(kubectl -n kube-system get po |grep kube-vip-ds|awk '{print $1}')</strong></span></pre><p id="e7c6" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们将使用这个浮动 IP 地址或主机名<em class="mn">示例-hostname.somedomain.tld </em>指向该 IP 地址作为我们在<strong class="km io"><em class="mn">/etc/rancher/rke 2/config . YAML</em></strong>文件中的服务器地址，用于将其他主节点或代理节点加入到集群中。</p><p id="9914" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">现在是时候将额外的主节点和代理节点加入集群了。<br/>为了加入它们，我们需要在<em class="mn">示例-host1 </em>服务器中的<strong class="km io"><em class="mn">/var/lib/rancher/rke 2/server/node-token</em></strong>文件中获取令牌，以便稍后将其放入带有 ansible 的附加加入节点的<strong class="km io"><em class="mn">/etc/rancher/rke 2/config . YAML</em></strong>文件中。<br/>由于<strong class="km io">令牌</strong>文件的内容很敏感，我们需要在 ansible 目录和清单中加密保存和使用它。下面是在我们的 ansible 清单中将它作为环境变量安全保存和使用的步骤。</p><p id="62ba" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated"><strong class="km io">加密令牌:</strong></p><pre class="kd ke kf kg gt lh li lj lk aw ll bi"><span id="b30a" class="lm ln in li b gy lo lp l lq lr"><strong class="li io">ssh example-host1 'cat /var/lib/rancher/rke2/server/node-token'</strong></span><span id="d03f" class="lm ln in li b gy ne lp l lq lr">Copy the output.</span><span id="8302" class="lm ln in li b gy ne lp l lq lr"><strong class="li io">cat &gt; ./token.enc &lt;&lt; \EOF</strong><br/>TOKEN: <em class="mn">PASTE_HERE_THE_TOKEN::STRING_IN_THE:node-token_FILE</em><br/><strong class="li io">EOF</strong></span><span id="4224" class="lm ln in li b gy ne lp l lq lr"><strong class="li io">ansible-vault encrypt ./token.enc</strong></span><span id="11ee" class="lm ln in li b gy ne lp l lq lr">New Vault password:<br/>Confirm New Vault password:<br/>Encryption successful</span></pre><p id="18a9" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">现在，在我们加密了令牌之后，让我们创建一个 ansible 清单，用于添加两个额外的主节点示例-host2 和示例-host3:</p><ul class=""><li id="f82d" class="lz ma in km b kn ko kq kr kt mb kx mc lb md lf me mf mg mh bi translated"><strong class="km io">。/rke2-add-server.yaml </strong></li></ul><pre class="kd ke kf kg gt lh li lj lk aw ll bi"><span id="80bc" class="lm ln in li b gy lo lp l lq lr">- name: install rke2 server<br/>  hosts: ~example-host[2-3]<br/>  become: true<br/>  vars_files:<br/>    - env_vars.yaml<br/>    - token.enc  # <em class="mn">The encrypted TOKEN file, later it is decrypted in the command-line with the </em><strong class="li io"><em class="mn">--ask-vault-pass </em></strong><em class="mn">option.</em><br/><br/>  tasks:<br/>  - name: create directories if they don't exist<br/>    file:<br/>      path: "{{ item }}"<br/>      state: directory<br/>      owner: root<br/>      group: root<br/>      mode: 0755<br/>      recurse: yes<br/>    loop:<br/>      - "{{ CONFDIR }}"<br/>      - "{{ WATCHDIR }}"<br/><br/>  - name: get hostname short<br/>    shell: |<br/>      hostname -s<br/>    register: hostname_short<br/>  - name: hostname fqdn<br/>    shell: |<br/>      hostname -f<br/>    register: hostname_fqdn<br/><br/>  - name: Print hostname fqdn and short<br/>    debug:<br/>      msg:<br/>      - "hostname short '{{ hostname_short.stdout }}'"<br/>      - "hostname fqdn: '{{ hostname_fqdn.stdout }}'"<br/><br/>  - name: Creating the config.yaml<br/>    copy:<br/>      dest: "{{ CONFFILE }}"<br/>      content: |<br/>        token: {{ TOKEN }}<br/>        server: https://{{ SERVER_ADDRESS_FQDN }}:9345<br/>        tls-san:<br/>          - "{{ hostname_short.stdout }}"<br/>          - "{{ hostname_fqdn.stdout }}"<br/>          - "{{ SERVER_ADDRESS_SHORT }}"<br/>          - "{{ SERVER_ADDRESS_FQDN }}"<br/>          - "{{ SERVER_FAILOVER_IP }}"<br/>    notify: "rke2-server service restart"<br/><br/>  - name: Installing rke2 server<br/>    shell: |<br/>      curl -sfL https://get.rke2.io | INSTALL_RKE2_CHANNEL=stable INSTALL_RKE2_VERSION="{{ INSTALL_RKE2_VERSION }}" sh -<br/>    notify: "rke2-server service start"<br/><br/>  handlers:<br/>  - name: Make sure a service unit is running<br/>    systemd:<br/>      state: started<br/>      name: rke2-server<br/>    listen: "rke2-server service start"<br/><br/>  - name: Make sure a service unit is restarted<br/>    ansible.builtin.systemd:<br/>      state: restarted<br/>      name: rke2-server<br/>    listen: "rke2-server service restart"</span></pre><p id="e5ac" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated"><strong class="km io">请注意</strong>，在下面的命令中，主节点被一个接一个地添加，就好像你同时启动两个主节点，第二个主节点可能会失败。这是因为集群中有太多的学习者 etcd 成员。<br/>在添加代理节点的情况下，我们可以毫无问题地同时添加所有代理节点。</p><p id="d5f1" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated"><strong class="km io">可行命令:</strong></p><pre class="kd ke kf kg gt lh li lj lk aw ll bi"><span id="fbfc" class="lm ln in li b gy lo lp l lq lr"><strong class="li io">ansible-playbook -u $USERNAME -i $Inventor_File ./rke2-add-server.yaml -l example-host2 --ask-vault-pass</strong></span><span id="5bec" class="lm ln in li b gy ne lp l lq lr">Vault password:</span><span id="2a9c" class="lm ln in li b gy ne lp l lq lr"><strong class="li io">ansible-playbook -u $USERNAME -i $Inventor_File ./rke2-add-server.yaml -l example-host3 --ask-vault-pass</strong></span><span id="e028" class="lm ln in li b gy ne lp l lq lr">Vault password:</span></pre><p id="4c71" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">对于保险库密码:在加密<strong class="km io"><em class="mn"/></strong><strong class="km io"><em class="mn">token . enc</em></strong>文件的内容时，输入您在上面设置的相同密码。</p><p id="458e" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">最后，让我们将 3 个代理节点添加到群集，正如我在上面提到的，我们可以同时添加所有这些节点。</p><ul class=""><li id="514a" class="lz ma in km b kn ko kq kr kt mb kx mc lb md lf me mf mg mh bi translated"><strong class="km io">。/rke2-add-agent-node.yaml </strong></li></ul><pre class="kd ke kf kg gt lh li lj lk aw ll bi"><span id="97b0" class="lm ln in li b gy lo lp l lq lr">- name: install rke2 agent node<br/>  hosts: all:!~example-host[1-3] # Including all hosts and excluding the master nodes.<br/>  become: true<br/>  vars_files:<br/>    - env_vars.yaml<br/>    - token.enc  # <em class="mn">The encrypted TOKEN file, later it is decrypted in the command-line with the </em><strong class="li io"><em class="mn">--ask-vault-pass </em></strong><em class="mn">option.</em><br/><br/>  tasks:<br/>  - name: create directories if they don't exist<br/>    file:<br/>      path: "{{ item }}"<br/>      state: directory<br/>      owner: root<br/>      group: root<br/>      mode: 0755<br/>      recurse: yes<br/>    loop:<br/>      - "{{ CONFDIR }}"<br/><br/>  - name: get hostname short<br/>    shell: |<br/>      hostname -s<br/>    register: hostname_short<br/>  - name: hostname fqdn<br/>    shell: |<br/>      hostname -f<br/>    register: hostname_fqdn<br/><br/>  - name: Print hostname fqdn and short<br/>    debug:<br/>      msg:<br/>      - "hostname short '{{ hostname_short.stdout }}'"<br/>      - "hostname fqdn: '{{ hostname_fqdn.stdout }}'"<br/><br/>  - name: Creating the config.yaml<br/>    copy:<br/>      dest: "{{ CONFFILE }}"<br/>      content: |<br/>        token: {{ TOKEN }}<br/>        server: https://{{ SERVER_ADDRESS_FQDN }}:9345<br/>        <br/>  - name: Installing rke2 agent<br/>    shell: |<br/>      curl -sfL https://get.rke2.io | INSTALL_RKE2_CHANNEL=stable INSTALL_RKE2_VERSION="{{ INSTALL_RKE2_VERSION }}" sh -<br/>    notify: "rke2-agent service start"<br/><br/>  handlers:<br/>  - name: Make sure a service unit is running<br/>    systemd:<br/>      state: started<br/>      name: rke2-agent<br/>    listen: "rke2-agent service start"<br/><br/>  - name: Make sure a service unit is restarted<br/>    ansible.builtin.systemd:<br/>      state: restarted<br/>      name: rke2-agent<br/>    listen: "rke2-agent service restart"</span></pre><p id="cb44" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated"><strong class="km io">接下来，键入命令:</strong></p><pre class="kd ke kf kg gt lh li lj lk aw ll bi"><span id="e066" class="lm ln in li b gy lo lp l lq lr"><strong class="li io">ansible-playbook -u $USERNAME -i $Inventor_File ./rke2-add-agent-node.yaml --ask-vault-pass</strong></span><span id="f765" class="lm ln in li b gy ne lp l lq lr">Vault password:</span></pre><p id="b7df" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们的 HA RKE2 群集准备好了 3 个主节点和 3 个代理节点，通过 kube-vip 以及启用的 NodeLocal DNSCache 在控制计划节点之间提供故障转移浮动 IP。</p></div></div>    
</body>
</html>