<html>
<head>
<title>Examples of Analytical SQL functions in Data warehouse (Part 3)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">数据仓库中的分析 SQL 函数示例(第 3 部分)</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/examples-of-analytical-sql-functions-in-data-warehouse-part-3-54faf976d452?source=collection_archive---------4-----------------------#2022-12-30">https://blog.devgenius.io/examples-of-analytical-sql-functions-in-data-warehouse-part-3-54faf976d452?source=collection_archive---------4-----------------------#2022-12-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="491a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">多几个功能！！</p><p id="568b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本系列的第 2 部分中，我们已经查看了这个<a class="ae kl" href="https://medium.com/dev-genius/important-sql-clauses-functions-in-data-engineering-and-analytics-85d8d84c2d78" rel="noopener">列表</a>中的一些函数。在本文中，我们将介绍更多正在运行的函数。我在 Redshift 上创建的表上执行这些查询，我将把模式和一些示例 insert 语句放在下面:</p><pre class="km kn ko kp gt kq kr ks bn kt ku bi"><span id="446b" class="kv kw iq kr b be kx ky l kz la">create table users(<br/>userid integer not null,<br/>name varchar(255) not null,<br/>gender varchar(1) not null,<br/>weight decimal(8,2) encode delta32k,<br/>age integer not null,<br/>primary key(userid))<br/>distkey(gender)<br/>sortkey(age);<br/><br/>insert into users (userid, name, gender, age, weight) values (1, 'John Snow', 'M', 35, 61);<br/>insert into users (userid, name, gender, age, weight) values (2, 'Matt Hayden', 'M', 55, 95);<br/>insert into users (userid, name, gender, age, weight) values (3, 'Ricky Ponting', 'M', 49, 75);<br/>insert into users (userid, name, gender, age, weight) values (4, 'David Shepherd', 'M', 90, 80);<br/>insert into users (userid, name, gender, age, weight) values (5, 'Smriti Mandana', 'F', 26, 55);<br/>insert into users (userid, name, gender, age, weight) values (6, 'Sachin Tendulkar', 'M', 51, 66);<br/>insert into users (userid, name, gender, age, weight) values (7, 'Isa Guha', 'F', 41, 61);</span></pre><figure class="km kn ko kp gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="gh gi lb"><img src="../Images/15092363dd706594ae97b14679ad2045.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ce6IucDWXafSNMvv"/></div></div><figcaption class="lj lk gj gh gi ll lm bd b be z dk translated">照片由<a class="ae kl" href="https://unsplash.com/@mjessier?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">米利安·杰西耶</a>在<a class="ae kl" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</figcaption></figure><p id="53c5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> OVER，PARTITION BY，ORBER BY 和 ROWS: </strong></p><p id="cfa8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">虽然我在上一篇文章中已经提到了这一点，但我还是要把这一部分包括进来，为新读者提供一个背景。这些实际上并不是函数，而是表示 SQL 查询将以分析方式执行的重要关键字。通过组合使用这些关键字的函数，使分析查询更加有效。分析查询通常在数据集窗口上执行，而不是在整个数据集本身上执行。窗口是使用窗口规范(OVER 子句)定义的，它基于三个主要概念:</p><ul class=""><li id="9f0a" class="ln lo iq jp b jq jr ju jv jy lp kc lq kg lr kk ls lt lu lv bi translated"><em class="lw">窗口分区，</em>形成多组行(PARTITION 子句)</li><li id="17d5" class="ln lo iq jp b jq lx ju ly jy lz kc ma kg mb kk ls lt lu lv bi translated"><em class="lw">窗口排序</em>，它定义了每个分区中行的顺序或序列(ORDER BY 子句)</li><li id="1ad3" class="ln lo iq jp b jq lx ju ly jy lz kc ma kg mb kk ls lt lu lv bi translated"><em class="lw">窗口框架</em>，相对于每一行定义，进一步限制行的集合(行规范)</li></ul><p id="f220" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们已经有了表、数据并知道了以分析方式使用查询的重要关键字，我们将看看一些函数:</p><p id="720c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">中位数</strong>:有序数据的中间值。如果行数为偶数，则取 2 个中间值的平均值。</p><p id="5341" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在上面的数据中，如果我们可以根据性别找到所有用户的中值权重，我们将得到女性的平均值，因为只有 2 条记录，而男性用户的平均值为 75，因为按此顺序有 5 行。</p><pre class="km kn ko kp gt kq kr ks bn kt ku bi"><span id="eb8d" class="kv kw iq kr b be kx ky l kz la">SELECT name, weight, gender, MEDIAN(weight) OVER (PARTITION BY gender) FROM users;</span></pre><figure class="km kn ko kp gt lc gh gi paragraph-image"><div class="gh gi mc"><img src="../Images/16306f60db669a0f04fde82f6823dbba.png" data-original-src="https://miro.medium.com/v2/resize:fit:446/format:webp/1*KArJcnfgLKB2LZe3n-Mhjg.png"/></div></figure><p id="bc70" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> NTILE </strong>:单参数表示期望的桶数。返回一个整数，表示每一行的组包含。</p><p id="80cd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以使用 ntile (2)函数根据用户的性别对用户进行分组，如下所示，每个性别对应 2 个存储桶。此外，由于只有 2 名女性用户，她们被放在不同的桶中。</p><pre class="km kn ko kp gt kq kr ks bn kt ku bi"><span id="5435" class="kv kw iq kr b be kx ky l kz la">SELECT name, weight, gender, NTILE(2) OVER (PARTITION BY gender ORDER BY weight) FROM users;</span></pre><figure class="km kn ko kp gt lc gh gi paragraph-image"><div class="gh gi md"><img src="../Images/e747d4b99526790d57591a6243b52279.png" data-original-src="https://miro.medium.com/v2/resize:fit:416/format:webp/1*OZmTjIbZYzbrC_aecYVyJA.png"/></div></figure><p id="6aed" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> CUME_DIST </strong>:数值小于或等于该行数值除以总行数的行数。</p><p id="bddd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在上面的数据中，如果我们能找到按体重排序的相同性别的累积分布，我们会得到下面的结果。(女性为 1/2 和 2/2，男性为 1/5、2/5、3/5、4/5 和 5/5)。</p><pre class="km kn ko kp gt kq kr ks bn kt ku bi"><span id="9501" class="kv kw iq kr b be kx ky l kz la">SELECT name, weight, gender, cume_dist() OVER (PARTITION BY gender ORDER BY weight) FROM users;</span></pre><figure class="km kn ko kp gt lc gh gi paragraph-image"><div class="gh gi me"><img src="../Images/ddb1a2413d78c5a054c400b634b04adc.png" data-original-src="https://miro.medium.com/v2/resize:fit:474/format:webp/1*CeaZzfQUXQTodQrO6uJcQg.png"/></div></figure><p id="3581" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> PERCENT_RANK </strong>:使用列上的 RANK 函数计算排名，减去 1，然后除以行数减 1。</p><p id="e659" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以根据按体重排序的性别划分来计算上述数据中的百分比排名，结果如下:((1–1)/(2–1)，(2–1)/(2–1)对于女性，((1–1)/(5–1)，(2–1)/(5–1)，(3–1)/(5–1)，(4–1)/(5–1)和(5–1)/5–1)对于男性。</p><pre class="km kn ko kp gt kq kr ks bn kt ku bi"><span id="2160" class="kv kw iq kr b be kx ky l kz la">SELECT name, weight, gender, PERCENT_RANK() OVER (PARTITION BY gender ORDER BY weight) FROM users;</span></pre><figure class="km kn ko kp gt lc gh gi paragraph-image"><div class="gh gi mf"><img src="../Images/96ee468027e612697138895c1865489d.png" data-original-src="https://miro.medium.com/v2/resize:fit:502/format:webp/1*AvQRjxIRmcTR4Zk0W7X_NQ.png"/></div></figure><p id="719e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> PERCENTILE_DISC </strong>:将所需百分点值与 CUME_DIST 函数值进行比较，返回与 CUME_DIST 相关联的等于或高于所需百分点值的列值。</p><p id="cbaf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在上述数据中，我们可以找到基于性别划分的第 50 百分位值，并可以得到以下结果。</p><pre class="km kn ko kp gt kq kr ks bn kt ku bi"><span id="bafa" class="kv kw iq kr b be kx ky l kz la">SELECT name, weight, gender, percentile_disc(0.50) WITHIN GROUP (ORDER BY weight) OVER (PARTITION BY gender) FROM users;</span></pre><figure class="km kn ko kp gt lc gh gi paragraph-image"><div class="gh gi mg"><img src="../Images/87888348d4d2803d8f460439e2d633a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:516/format:webp/1*xDD3Pi7B5qjiPxa836jHGA.png"/></div></figure><p id="8c17" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> PERCENTILE_CONT </strong>:与 PERCENTILE_DISC 类似，只是执行线性插值，返回值不一定来自表格。</p><p id="3d7f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在上述数据中，我们可以找到基于性别划分的第 50 百分位计数，并得到以下结果。</p><pre class="km kn ko kp gt kq kr ks bn kt ku bi"><span id="ad7f" class="kv kw iq kr b be kx ky l kz la">SELECT name, weight, gender, PERCENTILE_CONT(0.50) WITHIN GROUP (ORDER BY weight) OVER (PARTITION BY gender) FROM users;</span></pre><figure class="km kn ko kp gt lc gh gi paragraph-image"><div class="gh gi mh"><img src="../Images/a65ed472a9f191f5aa2f82721610d262.png" data-original-src="https://miro.medium.com/v2/resize:fit:522/format:webp/1*5eUClI0y018WTPKvjlMgyQ.png"/></div></figure><p id="4da2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">希望您已经对这些函数有了一些基本的了解，知道如何以及何时使用，以及在给定的数据集上使用时的结果。我们将在下一篇文章中讨论这个<a class="ae kl" href="https://medium.com/dev-genius/important-sql-clauses-functions-in-data-engineering-and-analytics-85d8d84c2d78" rel="noopener">列表</a>中剩余的最后一组函数。谢了。</p><p id="7dd5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">参考资料:</p><p id="5b65" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://www.pluralsight.com/courses/adv-sql-queries-oracle-sql-server" rel="noopener ugc nofollow" target="_blank">https://www . plural sight . com/courses/adv-SQL-queries-Oracle-SQL-server</a></p><p id="01ad" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://docs.aws.amazon.com/redshift/latest/dg/c_Window_functions.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/redshift/latest/DG/c _ Window _ functions . html</a>。</p><div class="mi mj gp gr mk ml"><a href="https://medium.com/membership/@guru.nie" rel="noopener follow" target="_blank"><div class="mm ab fo"><div class="mn ab mo cl cj mp"><h2 class="bd ir gy z fp mq fr fs mr fu fw ip bi translated">通过我的推荐链接加入媒体</h2><div class="ms l"><h3 class="bd b gy z fp mq fr fs mr fu fw dk translated">阅读 Gururaj Kulkarni(以及媒体上成千上万的其他作家)的每一个故事。您的会员费直接…</h3></div><div class="mt l"><p class="bd b dl z fp mq fr fs mr fu fw dk translated">medium.com</p></div></div><div class="mu l"><div class="mv l mw mx my mu mz lh ml"/></div></div></a></div></div></div>    
</body>
</html>