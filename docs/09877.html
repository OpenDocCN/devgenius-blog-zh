<html>
<head>
<title>How to use Google cloud vision API to detect the face(s) on image uploads in Laravel</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用 Google cloud vision API 在 Laravel 中检测图片上传中的人脸</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/how-to-use-google-cloud-vision-api-to-detect-the-face-s-on-image-uploads-in-laravel-f1d107f324a1?source=collection_archive---------11-----------------------#2022-09-19">https://blog.devgenius.io/how-to-use-google-cloud-vision-api-to-detect-the-face-s-on-image-uploads-in-laravel-f1d107f324a1?source=collection_archive---------11-----------------------#2022-09-19</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><figure class="im in gp gr io ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi il"><img src="../Images/ca31385e8da1b3f791425488b83780c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nmKbyFiFO2HID7V-"/></div></div><figcaption class="iw ix gj gh gi iy iz bd b be z dk translated">Laravel 的谷歌云视觉人脸检测</figcaption></figure><div class=""/><p id="972d" class="pw-post-body-paragraph jz ka jc kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">在本文中，我们将了解如何使用 Google cloud vision API 在 Laravel 应用程序中检测图像上传中的人脸。</p><p id="429a" class="pw-post-body-paragraph jz ka jc kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><a class="ae kx" href="https://cloud.google.com/vision/docs/detecting-faces" rel="noopener ugc nofollow" target="_blank">人脸检测</a>检测图像中的多张人脸以及相关的关键面部属性，如情绪状态或佩戴头饰。不支持特定的个人面部识别。</p><ul class=""><li id="3d3d" class="ky kz jc kb b kc kd kg kh kk la ko lb ks lc kw ld le lf lg bi translated">检测局部图像中的人脸</li></ul><p id="8262" class="pw-post-body-paragraph jz ka jc kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">Vision API 可以对本地图像文件执行功能检测，方法是在请求正文中以 base64 编码字符串的形式发送图像文件的内容。</p><p id="1683" class="pw-post-body-paragraph jz ka jc kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">在这篇关于<a class="ae kx" href="https://alemsbaja.hashnode.dev/how-to-use-google-cloud-vision-api-safe-search-detection-to-detect-explicit-content-on-image-uploads-in-laravel" rel="noopener ugc nofollow" target="_blank">如何使用 Google cloud vision API 安全搜索检测来检测 Laravel </a>中图片上传的露骨内容的教程中，我们详细介绍了如何创建 Google Cloud Platform (GCP)项目、服务帐户凭证以及将 cloud vision 软件包集成到 Laravel 中。</p><p id="701c" class="pw-post-body-paragraph jz ka jc kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">为了简单起见，我们将直接探讨如何在图像上传中检测人脸，因为我们已经有了一个<a class="ae kx" href="https://github.com/RaphAlemoh/google_cloud_vision_features/blob/main/resources/views/uploads/create.blade.php" rel="noopener ugc nofollow" target="_blank">表单</a>，用于上传之前功能集成的文件。</p><figure class="li lj lk ll gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi lh"><img src="../Images/f57ae3ab4c508cbc3bca104b072f359f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*BHVAF-RtVo1BcmhA"/></div></div></figure><p id="d0bc" class="pw-post-body-paragraph jz ka jc kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">注意:为了清楚起见，每个特征在 web.php 文件中都有自己的路径。</p><p id="d14c" class="pw-post-body-paragraph jz ka jc kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb jd">你也可以检查 GitHub 上的一个特定分支，查看它的实现</strong></p><p id="0e86" class="pw-post-body-paragraph jz ka jc kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">这里有一个存储库，其中有一个集成的<a class="ae kx" href="https://github.com/GoogleCloudPlatform/php-docs-samples/blob/master/vision/src/detect_face.php" rel="noopener ugc nofollow" target="_blank">示例</a>。</p><p id="26f1" class="pw-post-body-paragraph jz ka jc kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">当文件上传后，我们可以在 post 方法中运行检测。</p><p id="0057" class="pw-post-body-paragraph jz ka jc kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">就像在<a class="ae kx" href="https://alemsbaja.hashnode.dev/how-to-use-google-cloud-vision-api-safe-search-detection-to-detect-explicit-content-on-image-uploads-in-laravel" rel="noopener ugc nofollow" target="_blank">安全搜索检测功能</a>中一样，每个人脸检测方法的响应可以是下面数组中的任何值。</p><p id="806d" class="pw-post-body-paragraph jz ka jc kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">有了这些值，我们就可以检测出面部表情是愤怒、喜悦还是惊喜的情绪。</p><ul class=""><li id="3c5a" class="ky kz jc kb b kc kd kg kh kk la ko lb ks lc kw ld le lf lg bi translated">导入类</li></ul><pre class="li lj lk ll gt lm ln lo lp aw lq bi"><span id="c2fb" class="lr ls jc ln b gy lt lu l lv lw">use Google\Cloud\Vision\V1\ImageAnnotatorClient;<br/>// this HtmlStringclass is used to format the text detected on the image<br/>use Illuminate\Support\HtmlString;</span></pre><ul class=""><li id="de6e" class="ky kz jc kb b kc kd kg kh kk la ko lb ks lc kw ld le lf lg bi translated">对上传的图像运行面部检测</li></ul><p id="6e95" class="pw-post-body-paragraph jz ka jc kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">就像在<a class="ae kx" href="https://alemsbaja.hashnode.dev/how-to-use-google-cloud-vision-api-safe-search-detection-to-detect-explicit-content-on-image-uploads-in-laravel" rel="noopener ugc nofollow" target="_blank">安全搜索检测功能</a>中一样，每个人脸检测方法的响应可以是下面数组中的任何值。</p><pre class="li lj lk ll gt lm ln lo lp aw lq bi"><span id="202a" class="lr ls jc ln b gy lt lu l lv lw">$likelihoodName = [<br/>                'UNKNOWN', 'VERY_UNLIKELY', 'UNLIKELY',<br/>                'POSSIBLE', 'LIKELY', 'VERY_LIKELY'<br/>            ];</span></pre><p id="d551" class="pw-post-body-paragraph jz ka jc kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">有了这些值，我们就可以检测出面部表情是愤怒、喜悦还是惊喜的情绪。</p><ul class=""><li id="2f66" class="ky kz jc kb b kc kd kg kh kk la ko lb ks lc kw ld le lf lg bi translated">代码片段</li></ul><pre class="li lj lk ll gt lm ln lo lp aw lq bi"><span id="ead0" class="lr ls jc ln b gy lt lu l lv lw">public function detectFaces(Request $request)<br/>    {<br/>        $request-&gt;validate([<br/>            'avatar' =&gt; 'required|image|max:10240',<br/>        ]);</span><span id="ac9c" class="lr ls jc ln b gy lx lu l lv lw">try {<br/>            $imageAnnotator = new ImageAnnotatorClient([<br/>                //we can also keep the details of the google cloud JSON file in an env and read it as an object here<br/>                'credentials' =&gt; config_path('laravel-cloud.json')<br/>            ]);<br/>            # annotate the image</span><span id="e154" class="lr ls jc ln b gy lx lu l lv lw">$path = $request-&gt;file("avatar");<br/>            $image = file_get_contents($path);</span><span id="0ddd" class="lr ls jc ln b gy lx lu l lv lw">$outFile = null;</span><span id="c935" class="lr ls jc ln b gy lx lu l lv lw">$response = $imageAnnotator-&gt;faceDetection($image);<br/>            $faces = $response-&gt;getFaceAnnotations();</span><span id="93d9" class="lr ls jc ln b gy lx lu l lv lw"># names of likelihood from google.cloud.vision.enums<br/>            $likelihoodName = [<br/>                'UNKNOWN', 'VERY_UNLIKELY', 'UNLIKELY',<br/>                'POSSIBLE', 'LIKELY', 'VERY_LIKELY'<br/>            ];</span><span id="a933" class="lr ls jc ln b gy lx lu l lv lw">$number_of_faces = count($faces);</span><span id="fa97" class="lr ls jc ln b gy lx lu l lv lw">// the number of faces found on the image<br/>            // printf('%d faces found:' . PHP_EOL, count($faces));</span><span id="da2b" class="lr ls jc ln b gy lx lu l lv lw">$image_face_content = '';</span><span id="d45f" class="lr ls jc ln b gy lx lu l lv lw">$count = 0;</span><span id="0543" class="lr ls jc ln b gy lx lu l lv lw">foreach ($faces as $face) {<br/>                $count = +1;<br/>                $anger = $face-&gt;getAngerLikelihood();<br/>                //the likelihood of anger<br/>                // printf('Anger: %s' . PHP_EOL, $likelihoodName[$anger]);<br/>                $image_face_content .= "Face $count is Angry?: $likelihoodName[$anger] \n";</span><span id="d63d" class="lr ls jc ln b gy lx lu l lv lw">$joy = $face-&gt;getJoyLikelihood();<br/>                //the likelihood of joy<br/>                // printf('Joy: %s' . PHP_EOL, $likelihoodName[$joy]);<br/>                $image_face_content .= "Face $count is Joyful?: $likelihoodName[$joy] \n";</span><span id="2d77" class="lr ls jc ln b gy lx lu l lv lw">$surprise = $face-&gt;getSurpriseLikelihood();<br/>                //suprise status<br/>                // printf('Surprise: %s' . PHP_EOL, $likelihoodName[$surprise]);<br/>                $image_face_content .= "Face $count is Suprised?: $likelihoodName[$surprise] \n";</span><span id="716f" class="lr ls jc ln b gy lx lu l lv lw"># get bounds<br/>                $vertices = $face-&gt;getBoundingPoly()-&gt;getVertices();<br/>                $bounds = [];<br/>                foreach ($vertices as $vertex) {<br/>                    $bounds[] = sprintf('(%d,%d)', $vertex-&gt;getX(), $vertex-&gt;getY());<br/>                }</span><span id="26be" class="lr ls jc ln b gy lx lu l lv lw">//returns the bounds in for the faces result<br/>                print('Bounds: ' . join(', ', $bounds) . PHP_EOL);<br/>                print(PHP_EOL);<br/>            }<br/>            // [END vision_face_detection]</span><span id="fd0d" class="lr ls jc ln b gy lx lu l lv lw"># [START vision_face_detection_tutorial_process_response]<br/>            # draw box around faces<br/>            if ($faces &amp;&amp; $outFile) {<br/>                $imageCreateFunc = [<br/>                    'png' =&gt; 'imagecreatefrompng',<br/>                    'gd' =&gt; 'imagecreatefromgd',<br/>                    'gif' =&gt; 'imagecreatefromgif',<br/>                    'jpg' =&gt; 'imagecreatefromjpeg',<br/>                    'jpeg' =&gt; 'imagecreatefromjpeg',<br/>                ];<br/>                $imageWriteFunc = [<br/>                    'png' =&gt; 'imagepng',<br/>                    'gd' =&gt; 'imagegd',<br/>                    'gif' =&gt; 'imagegif',<br/>                    'jpg' =&gt; 'imagejpeg',<br/>                    'jpeg' =&gt; 'imagejpeg',<br/>                ];</span><span id="b5b0" class="lr ls jc ln b gy lx lu l lv lw">copy($path, $outFile);<br/>                $ext = strtolower(pathinfo($path, PATHINFO_EXTENSION));<br/>                if (!array_key_exists($ext, $imageCreateFunc)) {<br/>                    throw new \Exception('Unsupported image extension');<br/>                }</span><span id="ae17" class="lr ls jc ln b gy lx lu l lv lw">$outputImage = call_user_func($imageCreateFunc[$ext], $outFile);</span><span id="ea0f" class="lr ls jc ln b gy lx lu l lv lw">foreach ($faces as $face) {<br/>                    $vertices = $face-&gt;getBoundingPoly()-&gt;getVertices();<br/>                    if ($vertices) {<br/>                        $x1 = $vertices[0]-&gt;getX();<br/>                        $y1 = $vertices[0]-&gt;getY();<br/>                        $x2 = $vertices[2]-&gt;getX();<br/>                        $y2 = $vertices[2]-&gt;getY();<br/>                        imagerectangle($outputImage, $x1, $y1, $x2, $y2, 0x00ff00);<br/>                    }<br/>                }</span><span id="475b" class="lr ls jc ln b gy lx lu l lv lw">call_user_func($imageWriteFunc[$ext], $outputImage, $outFile);</span><span id="048c" class="lr ls jc ln b gy lx lu l lv lw">printf('Output image written to %s' . PHP_EOL, $outFile);</span><span id="3379" class="lr ls jc ln b gy lx lu l lv lw">//to display the image with boxes on surrounding the faces<br/>                // header('Content-Type: image/jpeg');<br/>                // imagejpeg($outputImage);<br/>                // imagedestroy($outputImage);<br/>            }</span><span id="de4b" class="lr ls jc ln b gy lx lu l lv lw">$formatted_text = new HtmlString($image_face_content);</span><span id="bc45" class="lr ls jc ln b gy lx lu l lv lw">return redirect()-&gt;route('home')<br/>                -&gt;with('success', "Number of faces on the image: $number_of_faces. Details of face detection on uploaded image $formatted_text");<br/>        } catch (Exception $e) {<br/>            return $e-&gt;getMessage();<br/>        }</span><span id="3eb0" class="lr ls jc ln b gy lx lu l lv lw">$imageAnnotator-&gt;close();<br/>    }</span></pre><p id="9dfe" class="pw-post-body-paragraph jz ka jc kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">让我们上传这张图片看看结果</p><figure class="li lj lk ll gt ip gh gi paragraph-image"><div class="gh gi ly"><img src="../Images/c1ac899cd9ce900d849e0f06ce0dbfdc.png" data-original-src="https://miro.medium.com/v2/resize:fit:470/0*rG9IvKTVg_5a_lZM"/></div></figure><ul class=""><li id="099f" class="ky kz jc kb b kc kd kg kh kk la ko lb ks lc kw ld le lf lg bi translated">图像上人脸检测的结果</li></ul><figure class="li lj lk ll gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi lz"><img src="../Images/ba520a23bc2ab4b7a0232bdad6381170.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*pyeSrNswlhMXJWN1"/></div></div></figure><p id="366f" class="pw-post-body-paragraph jz ka jc kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">有可能那张脸是快乐的或微笑的…是的！！！</p><ul class=""><li id="7a86" class="ky kz jc kb b kc kd kg kh kk la ko lb ks lc kw ld le lf lg bi translated">检测远程图像中的人脸</li></ul><p id="a873" class="pw-post-body-paragraph jz ka jc kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">为了方便起见，Vision API 可以直接对位于 Google 云存储或 Web 上的图像文件执行特征检测，而无需在请求正文中发送图像文件的内容。</p><p id="4c5e" class="pw-post-body-paragraph jz ka jc kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb jd">注意:</strong>当从 HTTP/HTTPS URL 获取图像时，谷歌不能保证请求会被完成。如果指定的主机拒绝了请求(例如，由于请求限制或 DOS 阻止)，或者如果 Google 为了防止滥用而限制了对站点的请求，您的请求可能会失败。生产应用程序不应依赖外部托管的映像。</p><pre class="li lj lk ll gt lm ln lo lp aw lq bi"><span id="6d57" class="lr ls jc ln b gy lt lu l lv lw">//specify the path to the file on GCS<br/>     $image = 'file_path...<a class="ae kx" href="https://googleapis.com.......png'" rel="noopener ugc nofollow" target="_blank">https://googleapis.com.......png'</a>;</span><span id="7101" class="lr ls jc ln b gy lx lu l lv lw">//run the facedection feature on the image<br/>            $response = $imageAnnotatorClient-&gt;faceDetection($image);</span></pre><p id="09ed" class="pw-post-body-paragraph jz ka jc kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">下面是教程<a class="ae kx" href="https://github.com/RaphAlemoh/google_cloud_vision_features" rel="noopener ugc nofollow" target="_blank">资源库</a></p><p id="3c02" class="pw-post-body-paragraph jz ka jc kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">感谢您阅读本文！！！。</p><p id="0e3a" class="pw-post-body-paragraph jz ka jc kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">如果你觉得这篇文章有帮助，请分享给你的网络，并随时使用评论区的问题，答案和贡献。</p></div><div class="ab cl ma mb hr mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="ig ih ii ij ik"><p id="6594" class="pw-post-body-paragraph jz ka jc kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><em class="mh">原发布于</em><a class="ae kx" href="https://alemsbaja.hashnode.dev/how-to-use-google-cloud-vision-api-to-detect-the-faces-on-image-uploads-in-laravel" rel="noopener ugc nofollow" target="_blank"><em class="mh">https://alemsbaja . hashnode . dev</em></a><em class="mh">。</em></p></div></div>    
</body>
</html>