<html>
<head>
<title>Web socket in Flutter</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">颤动中的腹板插口</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/web-socket-in-flutter-615d21ddf1c5?source=collection_archive---------0-----------------------#2022-09-19">https://blog.devgenius.io/web-socket-in-flutter-615d21ddf1c5?source=collection_archive---------0-----------------------#2022-09-19</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/6b4a3de19f9b664cb1eaafb0e6846384.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*q9psv0hEbv-cG6Jb"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">尼尔·索尼在<a class="ae jz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="e9f0" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">用于双向通信，如实时消息、GPS 跟踪、视频通话等。我们经常使用 web socket。让我们深入了解它是如何工作的，它的实现和最佳实践是什么。</p><p id="4705" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">附注:在阅读过程中，你会得到很多专业建议。</p><blockquote class="ky kz la"><p id="6b76" class="ka kb lb kc b kd ke kf kg kh ki kj kk lc km kn ko ld kq kr ks le ku kv kw kx ig bi translated">Web 套接字在发布/订阅模式下工作</p></blockquote><h1 id="8cec" class="lf lg in bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">什么是发布/订阅模式？</h1><p id="9a62" class="pw-post-body-paragraph ka kb in kc b kd md kf kg kh me kj kk kl mf kn ko kp mg kr ks kt mh kv kw kx ig bi translated">发布/订阅消息传递意味着发布/订阅消息传递模型。我们必须订阅数据，socket 将开始提供更新。很简单的一句话，订阅获取数据流，退订停止获取数据。</p><p id="1e32" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在连接 websocket 之后，我们必须通过双向通信来保持它的连接。如果任何一种方式停止发送数据，连接将会丢失，您必须重新连接。让我们开始实现 Flutter。为此，我们将使用下面给出的插件:</p><h1 id="949d" class="lf lg in bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">1.将它添加到您的 pubspec.yaml 中</h1><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="8fd9" class="mr lg in mn b gy ms mt l mu mv">web_socket_channel: ^2.1.0</span></pre><p id="19df" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">将这一行添加到<em class="lb"> pubspec.yaml </em>的依赖项中，运行<em class="lb"> flutter pub get </em>。</p><p id="7ad6" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">将其导入到您的文件中</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="91d4" class="mr lg in mn b gy ms mt l mu mv">import 'package:web_socket_channel/io.dart';</span></pre><blockquote class="ky kz la"><p id="20b5" class="ka kb lb kc b kd ke kf kg kh ki kj kk lc km kn ko ld kq kr ks le ku kv kw kx ig bi translated">Pro tip 1:让你的助手类成为一个<a class="ae jz" href="https://flutterbyexample.com/lesson/singletons" rel="noopener ugc nofollow" target="_blank">单例类</a>，并在这里保留所有重要的方法。</p></blockquote><h1 id="41a2" class="lf lg in bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">2.连接到插座</h1><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="cfb7" class="mr lg in mn b gy ms mt l mu mv">IOWebSocketChannel _client;</span><span id="659a" class="mr lg in mn b gy mw mt l mu mv">WebSocket.<em class="lb">connect</em>(_endPoint).then((ws) {<br/>  _client = IOWebSocketChannel(ws);<br/>  if (_client != null) {<br/>    _client.sink.add("Socket added");<br/>  }<br/>}).onError((error, stackTrace) {<br/>  <br/>});</span></pre><p id="ac45" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这里，我们正在建立与套接字的连接。端点将是你的 url 以<em class="lb"> ws 或 wss 开头。</em>连接后，我们将获得一个套接字客户端。保持低调。IOWebSocketChannel.sink.add 将用于发送数据。</p><h1 id="7b45" class="lf lg in bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">3.订阅一个主题</h1><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="7cf7" class="mr lg in mn b gy ms mt l mu mv">_client.sink.add(subscriptionText);</span></pre><p id="f082" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这里，订阅文本将是您想要发送到后端以开始订阅的消息。</p><h1 id="f188" class="lf lg in bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">4.开始收听消息</h1><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="8e28" class="mr lg in mn b gy ms mt l mu mv">_client.stream.listen((message){<br/>    //parse your message here<br/> },<br/> onDone: () {<br/>   <br/> },<br/>);</span></pre><p id="dd9e" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">IOWebSocketChannel.stream 将开始发送可以通过上述方法监听的数据。你可以解析你的信息并在你的应用中使用。</p><p id="03be" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">onDone:它将调用断开插座。</p><blockquote class="ky kz la"><p id="28e0" class="ka kb lb kc b kd ke kf kg kh ki kj kk lc km kn ko ld kq kr ks le ku kv kw kx ig bi translated">专业技巧 2:总是以字节发送和接收数据，或者使用 ProtoBuf</p></blockquote><h1 id="c902" class="lf lg in bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">4.取消订阅该主题</h1><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="c45e" class="mr lg in mn b gy ms mt l mu mv">_client.sink.add(unSubscriptionText);</span></pre><p id="9004" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">发送后端提到的取消订阅消息。它将停止数据流。</p><h1 id="da09" class="lf lg in bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">5.断开插座</h1><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="1c2d" class="mr lg in mn b gy ms mt l mu mv">_client?.sink?.close(status.goingAway);</span></pre><p id="491c" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">IOWebSocketChannel.sink.close 将关闭连接。这里 status.goingAway 是在 library 中定义的状态。您也可以使用自定义文本。</p><h1 id="b875" class="lf lg in bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">最佳实践</h1><ol class=""><li id="24a6" class="mx my in kc b kd md kh me kl mz kp na kt nb kx nc nd ne nf bi translated">避免多次发送订阅消息。</li><li id="383a" class="mx my in kc b kd ng kh nh kl ni kp nj kt nk kx nc nd ne nf bi translated">每 10 秒发送一次心跳。心跳是保持连接活动的文本。这是后端服务器上提到的文本。</li><li id="b486" class="mx my in kc b kd ng kh nh kl ni kp nj kt nk kx nc nd ne nf bi translated">每次连接/断开互联网时，您都应该连接您的插座，并再次订阅所有主题。</li><li id="9882" class="mx my in kc b kd ng kh nh kl ni kp nj kt nk kx nc nd ne nf bi translated">保持一个缓冲队列，以保存订阅，如果你失去了互联网之间的连接。您可以在重新连接互联网时发送此订阅。</li><li id="872a" class="mx my in kc b kd ng kh nh kl ni kp nj kt nk kx nc nd ne nf bi translated">维护一个映射来检索以前订阅的数据。</li><li id="2a8e" class="mx my in kc b kd ng kh nh kl ni kp nj kt nk kx nc nd ne nf bi translated">如果你得到错误或由于互联网断开，保持重试至少 3 次(或者你可以继续尝试)。</li><li id="bfbd" class="mx my in kc b kd ng kh nh kl ni kp nj kt nk kx nc nd ne nf bi translated">如果不需要，不要忘记退订主题。</li><li id="46e4" class="mx my in kc b kd ng kh nh kl ni kp nj kt nk kx nc nd ne nf bi translated">应用程序恢复时连接套接字，应用程序暂停时断开连接。</li></ol><blockquote class="ky kz la"><p id="c0e8" class="ka kb lb kc b kd ke kf kg kh ki kj kk lc km kn ko ld kq kr ks le ku kv kw kx ig bi translated">Pro tip 3:尽量少一次订阅。</p></blockquote><p id="0cd5" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这是工作代码。您可以根据您的使用情况对其进行修改。</p><figure class="mi mj mk ml gt jo"><div class="bz fp l di"><div class="nl nm l"/></div></figure></div><div class="ab cl nn no hr np" role="separator"><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns"/></div><div class="ig ih ii ij ik"><p id="2005" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">今天到此为止。谢谢你坚持到最后。欢迎建议。快乐编码。</p><p id="756a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">让我们现在就在<a class="ae jz" href="https://twitter.com/iamAshujha" rel="noopener ugc nofollow" target="_blank"> Twitter </a>、<a class="ae jz" href="https://www.instagram.com/ashutosh.j_/" rel="noopener ugc nofollow" target="_blank"> Instagram </a>或<a class="ae jz" href="https://www.linkedin.com/in/ashujhaji/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上连线。</p></div></div>    
</body>
</html>