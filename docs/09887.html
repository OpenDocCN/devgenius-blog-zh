<html>
<head>
<title>Integrate AWS Secret Manager in your NodeJS application</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将 AWS Secret Manager 集成到 NodeJS 应用程序中</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/integrate-aws-secret-manager-in-your-nodejs-application-c167115eec3e?source=collection_archive---------1-----------------------#2022-09-20">https://blog.devgenius.io/integrate-aws-secret-manager-in-your-nodejs-application-c167115eec3e?source=collection_archive---------1-----------------------#2022-09-20</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/dc34b95591c52547b18fc6d2ab20b43e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*0d6GpCAxogdP2UGc.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">Pic Credit K21 学院</figcaption></figure><p id="59ff" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">在上一篇<a class="ae kx" href="http://require(&quot;./config/env.config&quot;); const express = require(&quot;express&quot;);  /**  * Remaining codes ...  */" rel="noopener ugc nofollow" target="_blank">博客</a>中，我解释了如何在 NodeJS 应用程序中集成不同的环境变量文件。在这篇博客中，我将向您展示如何在 NodeJS 应用程序中添加 AWS secret manager，以便直接从 AWS 获取机密。</p><h2 id="e974" class="ky kz in bd la lb lc dn ld le lf dp lg kk lh li lj ko lk ll lm ks ln lo lp lq bi translated">目录</h2><ol class=""><li id="194e" class="lr ls in kb b kc lt kg lu kk lv ko lw ks lx kw ly lz ma mb bi translated">安装 AWS Cli</li><li id="df11" class="lr ls in kb b kc mc kg md kk me ko mf ks mg kw ly lz ma mb bi translated">配置 AWS 机密</li><li id="b359" class="lr ls in kb b kc mc kg md kk me ko mf ks mg kw ly lz ma mb bi translated">如何在 AWS secret manager 中创建秘密？</li><li id="e0cf" class="lr ls in kb b kc mc kg md kk me ko mf ks mg kw ly lz ma mb bi translated">向您的应用程序添加 Secret manager 代码片段</li><li id="1749" class="lr ls in kb b kc mc kg md kk me ko mf ks mg kw ly lz ma mb bi translated">呼叫秘密管理器代码片段</li></ol><p id="e6b3" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io"> 1。如何安装 AWS Cli？</strong></p><p id="13af" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">要开始使用，您必须在系统上安装 AWS cli。按照这个<a class="ae kx" href="https://docs.aws.amazon.com/cli/v1/userguide/install-windows.html" rel="noopener ugc nofollow" target="_blank">链接</a>在 windows 系统上安装 AWS cli(你也可以找到其他操作系统的链接)。现在下载 MSI 文件。现在运行下载的 MSI 安装程序。安装完成后，您可以通过键入以下命令来确认安装</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="36fe" class="ky kz in mm b gy mq mr l ms mt">C:\Users&gt;aws --version<br/>aws-cli/2.7.31 Python/3.9.11 Windows/10 exe/AMD64 prompt/off</span></pre><p id="8a1b" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io"> 2。如何在你的机器上配置 AWS Secrets？</strong></p><p id="1ed6" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">我假设你已经有了 AWS 访问密钥 ID 和密码。如果您没有这些证书，那么您可以点击此<a class="ae kx" href="https://aws.amazon.com/blogs/security/wheres-my-secret-access-key/" rel="noopener ugc nofollow" target="_blank">链接</a>下载您的 AWS 证书。现在，要配置 AWS 凭据，请键入以下命令</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="b557" class="ky kz in mm b gy mq mr l ms mt">C:\Users&gt;aws configure<br/>AWS Access Key ID [****************34Xe]:&lt;type your Access Key ID&gt;<br/>AWS Secret Access Key [****************sdE4]:&lt;type your Secret Access Key&gt;<br/>Default region name [ap-south-1]: &lt;enter default region&gt;<br/>Default output format [None]:</span></pre><p id="eb74" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">完成上述步骤后，您可以通过键入以下命令进行确认</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="6208" class="ky kz in mm b gy mq mr l ms mt">C:\Users&gt;aws configure list</span></pre><p id="9988" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">该命令将给出您在机器上设置的配置列表。</p><p id="f47c" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io"> 3。如何在 AWS secret manager 中创建秘密？</strong></p><p id="a99a" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">现在，要在 NodeJS 应用程序中获取秘密，必须将它添加到 AWS secret manager 中。要添加机密，请转到 AWS，然后在搜索框中键入 AWS secret manager，并在搜索结果中单击 AWS secret manager。它将打开 AWS 秘密管理器页面。</p><figure class="mh mi mj mk gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mu"><img src="../Images/6ea68a55ea92051a93ab8b6af42a85da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jnsqTZVEG25m-MFbndEXlw.png"/></div></div></figure><p id="0cd5" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">现在，您可以单击存储一个新的秘密，并选择秘密类型作为其他类型的秘密，并添加秘密作为键值对</p><figure class="mh mi mj mk gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mv"><img src="../Images/8f3d2d860d4eba0b7e5f1af060c6f865.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0syBcsp0uTq8dN28WBQKKw.png"/></div></div></figure><p id="37f6" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io"> 4。将 Secret manager 代码片段添加到您的应用程序中</strong></p><p id="16ba" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">完成上述所有步骤后，在 NodeJS 应用程序中添加以下代码。您可以将它添加到<strong class="kb io"> config/env.config.js </strong>文件中(您可以将代码块放在应用程序中的任何地方，但是我喜欢更有条理和更好的名称:)</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="4d60" class="ky kz in mm b gy mq mr l ms mt">var AWS = require('aws-sdk'),<br/>    region = "ap-south-1",<br/>    secret,<br/>    secretName="your-aws-secret-name", // You can load this secret based on the environment<br/>    decodedBinarySecret;</span><span id="37c4" class="ky kz in mm b gy mw mr l ms mt">// Create a Secrets Manager client<br/>var client = new AWS.SecretsManager({<br/>    region: region<br/>});</span><span id="1c44" class="ky kz in mm b gy mw mr l ms mt">client.getSecretValue({SecretId: secretName}, function(err, data) {<br/>    if (err) {<br/>        if (err.code === 'DecryptionFailureException')<br/>            // Secrets Manager can't decrypt the protected secret text using the provided KMS key.<br/>            // Deal with the exception here, and/or rethrow at your discretion.<br/>            throw err;<br/>        else if (err.code === 'InternalServiceErrorException')<br/>            // An error occurred on the server side.<br/>            // Deal with the exception here, and/or rethrow at your discretion.<br/>            throw err;<br/>        else if (err.code === 'InvalidParameterException')<br/>            // You provided an invalid value for a parameter.<br/>            // Deal with the exception here, and/or rethrow at your discretion.<br/>            throw err;<br/>        else if (err.code === 'InvalidRequestException')<br/>            // You provided a parameter value that is not valid for the current state of the resource.<br/>            // Deal with the exception here, and/or rethrow at your discretion.<br/>            throw err;<br/>        else if (err.code === 'ResourceNotFoundException')<br/>            // We can't find the resource that you asked for.<br/>            // Deal with the exception here, and/or rethrow at your discretion.<br/>            throw err;<br/>    }<br/>    else {<br/>        // Decrypts secret using the associated KMS key.<br/>        // Depending on whether the secret is a string or binary, one of these fields will be populated.<br/>        if ('SecretString' in data) {<br/>            secret = JSON.parse(data.SecretString);<br/>            <br/>            // Add all secret which is present on AWS to process.env <br/>            // which will be available in all over application<br/>            for(const envKey of Object.keys(secret)) {<br/>                process.env[envKey] = secret[envKey];<br/>            }<br/>        } else {<br/>            let buff = new Buffer(data.SecretBinary, 'base64');<br/>            decodedBinarySecret = buff.toString('ascii');<br/>        }<br/>    }<br/>    <br/>    // console log in case of error<br/>    console.log(err);<br/>});</span></pre><p id="32cf" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">在这个代码片段中，我使用了 aws-cli 节点包，它主要用于从 NodeJS 应用程序执行任何 aws 操作。现在我正在定义秘密名称和地区。在它下面，我正在创建 AWS secret manager 的一个实例。在下一行中，我将调用<strong class="kb io"> getSecretValue </strong>函数，该函数将 SecretId 作为参数，这将是您在 AWS Secret manager 中创建的秘密名称。<strong class="kb io"> getSecretValue </strong>是一个异步函数，在回调函数中有两个参数 err 和 data。我正在处理基于错误类型的错误。如果我在 else 中没有得到任何错误，我将检查数据是否有<strong class="kb io"> SecretString </strong>，如果有，那么从数据中解析 SecretString，并将所有键值对添加到 process.env 。这一行将确保无论什么是目前在您的秘密经理，将可在您的所有应用程序。</p><p id="6a91" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io"> 5。呼叫秘密管理器代码片段</strong></p><p id="2fae" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">现在出现了最后一个问题，在哪里调用这个秘密管理器代码片段？在调用任何包或文件之前，您必须调用这个代码片段。所以更好的地方是你的 NodeJS 启动文件，你可以把它命名为 index.js 或者 server.js 或者 app.js。对我来说，它是 index.js，所以你可以这样调用它</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="16de" class="ky kz in mm b gy mq mr l ms mt">require("./config/env.config");<br/>const express = require("express");</span><span id="e67c" class="ky kz in mm b gy mw mr l ms mt">/**<br/> * Remaining codes ...<br/> */</span></pre><p id="8f7e" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">结论</strong></p><p id="5a4a" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">有时在。NodeJS 应用程序的 env 文件。所以最好将它添加到 AWS Secret Manager 中，这样，如果没有您的 AWS 凭证，就没有人会得到凭证。感谢阅读。快乐编码。</p><p id="2d28" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">你喜欢这篇文章吗？如果有，通过<a class="ae kx" href="https://www.youtube.com/@codingwithkrpajay?sub_confirmation=1" rel="noopener ugc nofollow" target="_blank"> <strong class="kb io">订阅解码，我们的 YouTube 频道</strong> </a> <strong class="kb io">获取更多类似内容！</strong></p><p id="5c4e" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">同样的博客也将在 https://ajaykrp.me/推出。</p></div></div>    
</body>
</html>