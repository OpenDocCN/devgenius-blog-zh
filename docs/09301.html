<html>
<head>
<title>Create A Countdown Timer That Runs Even If The App Is Closed</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">创建一个倒计时定时器，即使应用程序关闭也能运行</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/create-a-countdown-timer-that-runs-if-the-app-is-closed-e5501598e16d?source=collection_archive---------6-----------------------#2022-08-13">https://blog.devgenius.io/create-a-countdown-timer-that-runs-if-the-app-is-closed-e5501598e16d?source=collection_archive---------6-----------------------#2022-08-13</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/></div><div class="ab cl jk jl hr jm" role="separator"><span class="jn bw bk jo jp jq"/><span class="jn bw bk jo jp jq"/><span class="jn bw bk jo jp"/></div><div class="ig ih ii ij ik"><p id="3932" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">我将演示如何创建一个倒计时定时器，如果你退出应用程序，并在一段时间后回来工作。您将能够启动、停止和重置计时器。我们将使用共享首选项来实现这一点。向下滚动到末尾，观看该应用程序的视频演示。这个项目的 GitHub 库的链接也在最后。我们开始吧:)</p><ol class=""><li id="94c8" class="kp kq in jt b ju jv jy jz kc kr kg ks kk kt ko ku kv kw kx bi translated">在 Android Studio 中创建一个空项目，并启用视图绑定。</li><li id="226c" class="kp kq in jt b ju ky jy kz kc la kg lb kk lc ko ku kv kw kx bi translated">在 activity_main.xml 文件中添加一个 textview 和两个按钮。</li></ol><pre class="ld le lf lg gt lh li lj lk aw ll bi"><span id="47a7" class="lm ln in li b gy lo lp l lq lr">&lt;androidx.constraintlayout.widget.ConstraintLayout xmlns:android="http://schemas.android.com/apk/res/android"<br/>    xmlns:app="http://schemas.android.com/apk/res-auto"<br/>    xmlns:tools="http://schemas.android.com/tools"<br/>    android:layout_width="match_parent"<br/>    android:layout_height="match_parent"<br/>    tools:context=".MainActivity"&gt;<br/><br/>    &lt;TextView<br/>        android:id="@+id/timerTV"<br/>        android:layout_width="wrap_content"<br/>        android:layout_height="wrap_content"<br/>        android:textColor="@color/black"<br/>        android:textSize="40sp"<br/>        android:text="05:00"<br/>        app:layout_constraintBottom_toBottomOf="parent"<br/>        app:layout_constraintEnd_toEndOf="parent"<br/>        app:layout_constraintStart_toStartOf="parent"<br/>        app:layout_constraintTop_toTopOf="parent" /&gt;<br/><br/>    &lt;Button<br/>        android:id="@+id/startOrStopBtn"<br/>        android:layout_width="wrap_content"<br/>        android:layout_height="wrap_content"<br/>        android:text="Start"<br/>        android:layout_marginTop="8dp"<br/>        android:layout_marginEnd="8dp"<br/>        app:layout_constraintEnd_toStartOf="@+id/resetBtn"<br/>        app:layout_constraintHorizontal_chainStyle="packed"<br/>        app:layout_constraintStart_toStartOf="parent"<br/>        app:layout_constraintTop_toBottomOf="@id/timerTV" /&gt;<br/><br/>    &lt;Button<br/>        android:id="@+id/resetBtn"<br/>        android:layout_width="wrap_content"<br/>        android:layout_height="wrap_content"<br/>        android:layout_marginTop="8dp"<br/>        android:text="Reset"<br/>        android:layout_marginStart="8dp"<br/>        app:layout_constraintEnd_toEndOf="parent"<br/>        app:layout_constraintStart_toEndOf="@+id/startOrStopBtn"<br/>        app:layout_constraintTop_toBottomOf="@id/timerTV" /&gt;<br/><br/>&lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;</span></pre><p id="b65c" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">运行应用程序，它应该看起来像这样。</p><figure class="ld le lf lg gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi ls"><img src="../Images/4a54849ea4e10848cae9a01468c91b21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0JQ-DUXy3T8Vv3w7QDrxLg.jpeg"/></div></div></figure></div><div class="ab cl jk jl hr jm" role="separator"><span class="jn bw bk jo jp jq"/><span class="jn bw bk jo jp jq"/><span class="jn bw bk jo jp"/></div><div class="ig ih ii ij ik"><p id="03b8" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated"><strong class="jt io"> MainActivity.kt </strong></p><p id="11e6" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">从现在开始，所有的事情都将在 MainActivity.kt 上完成。我将尽力解释每个函数的作用，最后，我将把所有代码粘贴到 MainActivity.kt 中。</p><p id="d3f6" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">首先，在 MainActivity 中创建这些变量。</p><pre class="ld le lf lg gt lh li lj lk aw ll bi"><span id="5c17" class="lm ln in li b gy lo lp l lq lr">private lateinit var binding: ActivityMainBinding<br/>private var timeLeftInMillis = 0L<br/>private var countDownTimer: CountDownTimer? = null<br/>private var timerIsRunning = false<br/>private var remainingTimeInMillis = 300000L<br/>private var endTime = 0L</span></pre><p id="cd6f" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">在 onCreate()内部，向 start 和 reset 按钮添加 onClickListeners。</p><pre class="ld le lf lg gt lh li lj lk aw ll bi"><span id="5ff2" class="lm ln in li b gy lo lp l lq lr">override fun onCreate(savedInstanceState: Bundle?) {<br/>    super.onCreate(savedInstanceState)<br/>    binding = ActivityMainBinding.inflate(<em class="ma">layoutInflater</em>)<br/>    setContentView(binding.<em class="ma">root</em>)<br/><br/>    binding.startOrStopBtn.setOnClickListener <strong class="li io">{<br/>        </strong>startOrStopTimer()<br/>    <strong class="li io">}<br/><br/>    </strong>binding.resetBtn.setOnClickListener <strong class="li io">{<br/>        </strong>stopOrResetTimer()<br/>    <strong class="li io">}<br/><br/></strong>}</span></pre><p id="7971" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated"><strong class="jt io"> startOrStopTimer() </strong></p><pre class="ld le lf lg gt lh li lj lk aw ll bi"><span id="0e5e" class="lm ln in li b gy lo lp l lq lr">private fun startOrStopTimer() {<br/>    if (!timerIsRunning) {<br/>        countDownTimer?.cancel()<br/>        binding.startOrStopBtn.<em class="ma">text </em>= "Stop"<br/>        countDownTimer = object : CountDownTimer(remainingTimeInMillis, 1000) {<br/>            override fun onTick(millisUntilFinished: Long) {<br/>                remainingTimeInMillis = millisUntilFinished<br/>                timeLeftInMillis = millisUntilFinished<br/>                timerIsRunning = true<br/><br/>                binding.timerTV.<em class="ma">text </em>= millisUntilFinished.<em class="ma">convertToTimeFormat</em>()<br/>            }<br/><br/>            override fun onFinish() {<br/>                timerIsRunning = false<br/>                remainingTimeInMillis = 0L<br/>                timeLeftInMillis = 0L<br/>                binding.startOrStopBtn.<em class="ma">text </em>= "Start"<br/>            }<br/>        }.start()<br/>    } else {<br/>        countDownTimer?.cancel()<br/>        timerIsRunning = false<br/>        binding.startOrStopBtn.<em class="ma">text </em>= "Start"<br/>    }<br/>}</span></pre><p id="021c" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">在这个函数中，我们检查定时器是否没有运行。如果不是，我们创建一个 CountDownTimer()，持续时间为“remainingTimeInMillis”。如果用户点击复位按钮，remainingTimeInMillis 的值将是 5 分钟，或者该值将是定时器先前停止的时间。每秒都会调用 onTick()函数，因为我们将 countDownInterval 设置为 1000 毫秒。因此，我们每秒都在更新剩余的 TimeInMillis、timeLeftInMillis 和 timerIsRunning。我稍后会谈到 converToTimeLeftFormat()函数的作用。当时间到时，onFinish()函数被调用。</p><p id="3c85" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated"><strong class="jt io"> stopOrResetTimer() </strong></p><pre class="ld le lf lg gt lh li lj lk aw ll bi"><span id="276f" class="lm ln in li b gy lo lp l lq lr">private fun stopOrResetTimer() {<br/>    countDownTimer?.cancel()<br/>    timerIsRunning = false<br/>    timeLeftInMillis = 300000<br/>    remainingTimeInMillis = 300000<br/>    binding.timerTV.<em class="ma">text </em>= remainingTimeInMillis.<em class="ma">convertToTimeFormat</em>()<br/>    binding.startOrStopBtn.<em class="ma">text </em>= "Start"<br/>}</span></pre><p id="4962" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">这个功能非常简单。我们基本上是把时间调回到 300000 毫秒，也就是 5 分钟。然后将 timerIsRunning 设置为 false，更新 textview，使其显示“05:00 ”,并将按钮文本从“停止”改为“开始”。</p><p id="d2e9" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated"><strong class="jt io">long . converttotimeformat()</strong></p><pre class="ld le lf lg gt lh li lj lk aw ll bi"><span id="cb2f" class="lm ln in li b gy lo lp l lq lr">private fun Long.convertToTimeFormat(): String {<br/>    val minutes = (this / 1000).toInt() / 60<br/>    val seconds = (this / 1000).toInt() % 60<br/><br/>    return java.lang.String.format(Locale.getDefault(), "%02d:%02d", minutes, seconds)<br/>}</span></pre><p id="33c2" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">这个函数是一个扩展函数，它只是将毫秒转换成这种格式:“04:10”，其中 4 是分钟，10 是秒。</p><p id="9c7a" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated"><strong class="jt io"> onStart() </strong></p><pre class="ld le lf lg gt lh li lj lk aw ll bi"><span id="78ad" class="lm ln in li b gy lo lp l lq lr">override fun onStart() {<br/>    super.onStart()<br/>    val prefs = getSharedPreferences("COUNT_DOWN_TIMER", <em class="ma">MODE_PRIVATE</em>)<br/>    timeLeftInMillis = prefs.getLong("millisecondsLeft", 0L)<br/>    timerIsRunning = prefs.getBoolean("isTimerRunning", false)<br/>    endTime = prefs.getLong("endTimeInMillis", 0L)<br/><br/>    if (endTime != 0L &amp;&amp; timerIsRunning) {<br/>        val timeSpentInBackground: Long = (System.currentTimeMillis() - endTime)<br/>        remainingTimeInMillis = timeLeftInMillis - timeSpentInBackground<br/>    } else {<br/>        remainingTimeInMillis = timeLeftInMillis<br/>    }<br/>    binding.timerTV.<em class="ma">text </em>= remainingTimeInMillis.<em class="ma">convertToTimeFormat</em>()<br/><br/>    if (remainingTimeInMillis != 0L &amp;&amp; timerIsRunning) {<br/><br/>        binding.startOrStopBtn.<em class="ma">text </em>= "Stop"<br/>        countDownTimer = object : CountDownTimer (remainingTimeInMillis, 1000) {<br/>            override fun onTick(millisUntilFinished: Long) {<br/>                remainingTimeInMillis = millisUntilFinished<br/>                timeLeftInMillis = millisUntilFinished<br/>                timerIsRunning = true<br/><br/>                binding.timerTV.<em class="ma">text </em>= millisUntilFinished.<em class="ma">convertToTimeFormat</em>()<br/>            }<br/><br/>            override fun onFinish() {<br/>                timerIsRunning = false<br/>                remainingTimeInMillis = 0L<br/>                timeLeftInMillis = 0L<br/>                binding.startOrStopBtn.<em class="ma">text </em>= "Start"<br/>            }<br/>        }.start()<br/>    }<br/>}</span></pre><p id="9610" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">这个函数基本上是从共享首选项中获取变量，并检查用户在什么时候点击应用程序，如果计时器正在运行，则检索一个布尔值。如果用户点击离开应用程序时计时器正在运行，它会计算离开应用程序的时间。然后用剩余时间启动计时器。</p><p id="15eb" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated"><strong class="jt io"> onStop() </strong></p><pre class="ld le lf lg gt lh li lj lk aw ll bi"><span id="2a69" class="lm ln in li b gy lo lp l lq lr">override fun onStop() {<br/>    super.onStop()<br/>    countDownTimer?.cancel()<br/><br/>    val prefs = getSharedPreferences("COUNT_DOWN_TIMER", <em class="ma">MODE_PRIVATE</em>)<br/>    val editor = prefs.edit()<br/>    editor.putLong("millisecondsLeft", timeLeftInMillis)<br/>    editor.putBoolean("isTimerRunning", timerIsRunning)<br/>    editor.putLong("endTimeInMillis", System.currentTimeMillis())<br/>    editor.commit()<br/>}</span></pre><p id="f586" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">保存毫秒保留到保存的首选项。这是计时器中剩余的时间，以毫秒为单位。它还保存了“isTimerRunning”，这是一个布尔值，用于检查用户离开应用程序时计时器是否在运行。最后是“endTimeInMillis”，这是用户离开应用程序的准确时间。</p><p id="0f22" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">MainActivity()中的最终代码应该如下所示。</p><pre class="ld le lf lg gt lh li lj lk aw ll bi"><span id="ad41" class="lm ln in li b gy lo lp l lq lr">class MainActivity : AppCompatActivity() {<br/><br/>    private lateinit var binding: ActivityMainBinding<br/>    private var timeLeftInMillis = 0L<br/>    private var countDownTimer: CountDownTimer? = null<br/>    private var timerIsRunning = false<br/>    private var remainingTimeInMillis = 300000L<br/>    private var endTime = 0L<br/><br/>    override fun onCreate(savedInstanceState: Bundle?) {<br/>        super.onCreate(savedInstanceState)<br/>        binding = ActivityMainBinding.inflate(<em class="ma">layoutInflater</em>)<br/>        setContentView(binding.<em class="ma">root</em>)<br/><br/>        binding.startOrStopBtn.setOnClickListener <strong class="li io">{<br/>            </strong>startOrStopTimer()<br/>        <strong class="li io">}<br/><br/>        </strong>binding.resetBtn.setOnClickListener <strong class="li io">{<br/>            </strong>stopOrResetTimer()<br/>        <strong class="li io">}<br/><br/>    </strong>}<br/><br/>    private fun startOrStopTimer() {<br/>        if (!timerIsRunning) {<br/>            countDownTimer?.cancel()<br/>            binding.startOrStopBtn.<em class="ma">text </em>= "Stop"<br/>            countDownTimer = object : CountDownTimer(remainingTimeInMillis, 1000) {<br/>                override fun onTick(millisUntilFinished: Long) {<br/>                    remainingTimeInMillis = millisUntilFinished<br/>                    timeLeftInMillis = millisUntilFinished<br/>                    timerIsRunning = true<br/><br/>                    binding.timerTV.<em class="ma">text </em>= millisUntilFinished.<em class="ma">convertToTimeFormat</em>()<br/>                }<br/><br/>                override fun onFinish() {<br/>                    timerIsRunning = false<br/>                    remainingTimeInMillis = 0L<br/>                    timeLeftInMillis = 0L<br/>                    binding.startOrStopBtn.<em class="ma">text </em>= "Start"<br/>                }<br/>            }.start()<br/>        } else {<br/>            countDownTimer?.cancel()<br/>            timerIsRunning = false<br/>            binding.startOrStopBtn.<em class="ma">text </em>= "Start"<br/>        }<br/>    }<br/><br/>    private fun stopOrResetTimer() {<br/>        countDownTimer?.cancel()<br/>        timerIsRunning = false<br/>        timeLeftInMillis = 300000<br/>        remainingTimeInMillis = 300000<br/>        binding.timerTV.<em class="ma">text </em>= remainingTimeInMillis.<em class="ma">convertToTimeFormat</em>()<br/>        binding.startOrStopBtn.<em class="ma">text </em>= "Start"<br/>    }<br/><br/>    private fun Long.convertToTimeFormat(): String {<br/>        val minutes = (this / 1000).toInt() / 60<br/>        val seconds = (this / 1000).toInt() % 60<br/><br/>        return java.lang.String.format(Locale.getDefault(), "%02d:%02d", minutes, seconds)<br/>    }<br/><br/>    override fun onStart() {<br/>        super.onStart()<br/>        val prefs = getSharedPreferences("COUNT_DOWN_TIMER", <em class="ma">MODE_PRIVATE</em>)<br/>        timeLeftInMillis = prefs.getLong("millisecondsLeft", 0L)<br/>        timerIsRunning = prefs.getBoolean("isTimerRunning", false)<br/>        endTime = prefs.getLong("endTimeInMillis", 0L)<br/><br/>        if (endTime != 0L &amp;&amp; timerIsRunning) {<br/>            val timeSpentInBackground: Long = (System.currentTimeMillis() - endTime)<br/>            remainingTimeInMillis = timeLeftInMillis - timeSpentInBackground<br/>        } else {<br/>            remainingTimeInMillis = timeLeftInMillis<br/>        }<br/>        binding.timerTV.<em class="ma">text </em>= remainingTimeInMillis.<em class="ma">convertToTimeFormat</em>()<br/><br/>        if (remainingTimeInMillis != 0L &amp;&amp; timerIsRunning) {<br/><br/>            binding.startOrStopBtn.<em class="ma">text </em>= "Stop"<br/>            countDownTimer = object : CountDownTimer (remainingTimeInMillis, 1000) {<br/>                override fun onTick(millisUntilFinished: Long) {<br/>                    remainingTimeInMillis = millisUntilFinished<br/>                    timeLeftInMillis = millisUntilFinished<br/>                    timerIsRunning = true<br/><br/>                    binding.timerTV.<em class="ma">text </em>= millisUntilFinished.<em class="ma">convertToTimeFormat</em>()<br/>                }<br/><br/>                override fun onFinish() {<br/>                    timerIsRunning = false<br/>                    remainingTimeInMillis = 0L<br/>                    timeLeftInMillis = 0L<br/>                    binding.startOrStopBtn.<em class="ma">text </em>= "Start"<br/>                }<br/>            }.start()<br/>        }<br/>    }<br/><br/>    override fun onStop() {<br/>        super.onStop()<br/>        countDownTimer?.cancel()<br/><br/>        val prefs = getSharedPreferences("COUNT_DOWN_TIMER", <em class="ma">MODE_PRIVATE</em>)<br/>        val editor = prefs.edit()<br/>        editor.putLong("millisecondsLeft", timeLeftInMillis)<br/>        editor.putBoolean("isTimerRunning", timerIsRunning)<br/>        editor.putLong("endTimeInMillis", System.currentTimeMillis())<br/>        editor.commit()<br/>    }<br/>}</span></pre><p id="8eb0" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated"><strong class="jt io">视频演示</strong></p><p id="a6c6" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">【https://vimeo.com/739134591 T2】号</p><p id="a869" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated"><strong class="jt io"> GitHub 资源库</strong></p><p id="f80e" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated"><a class="ae mb" href="https://github.com/alexportillo519/CountDownTimer" rel="noopener ugc nofollow" target="_blank">https://github.com/alexportillo519/CountDownTimer</a></p><p id="3486" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">希望这有所帮助。如果你有任何问题让我知道。编码快乐！</p></div></div>    
</body>
</html>