<html>
<head>
<title>DAPR — Part 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">DAPR —第二部分</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/dapr-part-2-31e04571c01e?source=collection_archive---------3-----------------------#2021-01-17">https://blog.devgenius.io/dapr-part-2-31e04571c01e?source=collection_archive---------3-----------------------#2021-01-17</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/226f1266d4f55fe43134210ea308dedc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VfTuEWur4Dl0o2w4ouBf4A.png"/></div></div></figure><p id="8a84" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在<a class="ae kt" href="https://medium.com/dev-genius/dapr-part-1-229b78081378" rel="noopener">第 1 部分</a>中，我已经解释了 DAPR 的关键概念，在这一部分我们将看到状态存储的示例实现，使用本地<strong class="jx io"> kubernets </strong>集群、<strong class="jx io"> redis </strong>缓存和<strong class="jx io"> dotnet core 5 </strong>。</p><p id="2de7" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">你可以在这里找到示例项目<a class="ae kt" href="https://github.com/egrish/sample-dotnet-dapr-redis" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="9f2e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">先决条件:</p><ul class=""><li id="ca7f" class="ku kv in jx b jy jz kc kd kg kw kk kx ko ky ks kz la lb lc bi translated"><a class="ae kt" href="https://minikube.sigs.k8s.io/docs/" rel="noopener ugc nofollow" target="_blank"> Minikube </a></li><li id="236f" class="ku kv in jx b jy ld kc le kg lf kk lg ko lh ks kz la lb lc bi translated">码头工人</li><li id="0d75" class="ku kv in jx b jy ld kc le kg lf kk lg ko lh ks kz la lb lc bi translated">库贝内特斯(库贝特尔)</li><li id="8746" class="ku kv in jx b jy ld kc le kg lf kk lg ko lh ks kz la lb lc bi translated">点网核心 5.0</li><li id="322b" class="ku kv in jx b jy ld kc le kg lf kk lg ko lh ks kz la lb lc bi translated"><a class="ae kt" href="https://dapr.io/" rel="noopener ugc nofollow" target="_blank"> Dapr </a></li></ul><p id="cde5" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这是一个简单的 dotnet core 5.0 Web API 项目，有几个端点:</p><ul class=""><li id="6346" class="ku kv in jx b jy jz kc kd kg kw kk kx ko ky ks kz la lb lc bi translated">后期添加客户端</li><li id="feda" class="ku kv in jx b jy ld kc le kg lf kk lg ko lh ks kz la lb lc bi translated">获取 getClient</li><li id="ce1f" class="ku kv in jx b jy ld kc le kg lf kk lg ko lh ks kz la lb lc bi translated">删除删除客户端</li></ul><p id="a303" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们希望使用 dapr SDK for DotNet Core 将客户端数据保存在 redis 缓存中。</p><p id="e110" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">安装和基本使用</strong></p><ol class=""><li id="ad7d" class="ku kv in jx b jy jz kc kd kg kw kk kx ko ky ks li la lb lc bi translated"><strong class="jx io">启动 minikube </strong></li></ol><pre class="lj lk ll lm gt ln lo lp lq aw lr bi"><span id="587d" class="ls lt in lo b gy lu lv l lw lx">minikube start</span></pre><p id="9b45" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io"> 2。在您的 kubernetes 集群上本地安装 DAPR</strong></p><pre class="lj lk ll lm gt ln lo lp lq aw lr bi"><span id="2b3c" class="ls lt in lo b gy lu lv l lw lx">dapr init -k</span></pre><p id="ef87" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io"> 3。将 Redis 安装到您的集群中</strong></p><pre class="lj lk ll lm gt ln lo lp lq aw lr bi"><span id="013d" class="ls lt in lo b gy lu lv l lw lx">dapr init -k</span></pre><p id="d323" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">并检查状态</p><pre class="lj lk ll lm gt ln lo lp lq aw lr bi"><span id="b829" class="ls lt in lo b gy lu lv l lw lx">kubectl get pods</span></pre><p id="6489" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">，您应该会看到 3 个节点处于运行状态。</p><p id="ae70" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">要获取 redis 密码，请使用</p><pre class="lj lk ll lm gt ln lo lp lq aw lr bi"><span id="640f" class="ls lt in lo b gy lu lv l lw lx">export REDIS_PASSWORD=$(kubectl get secret --namespace default redis -o jsonpath="{.data.redis-password}" | base64 --decode)</span></pre><p id="288d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io"> 4。在本地运行 DAPR API 项目</strong></p><pre class="lj lk ll lm gt ln lo lp lq aw lr bi"><span id="01e5" class="ls lt in lo b gy lu lv l lw lx">cd src/DaprSamples/SampleStateStore_Redis<br/>dotnet build<br/>dapr run --app-id controller --app-port 5000 -- dotnet run</span></pre><p id="0369" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">，其中 app-id 为 Dapr 定义了应用的名称。</p><p id="af2c" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io"> 5。将 DAPR 组件添加到 Kubernetes 集群</strong></p><p id="173f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="ly"> 5.1。创建 redis-statestore.yaml </em></p><p id="f89b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">并补充</p><pre class="lj lk ll lm gt ln lo lp lq aw lr bi"><span id="6893" class="ls lt in lo b gy lu lv l lw lx">apiVersion: v1<br/>kind: Secret<br/>metadata:<br/>  name: redis<br/>data:<br/>  redis-password: &lt;REPLACE WITH BASE64 ENCODED PASSWORD&gt;<br/>---<br/>apiVersion: dapr.io/v1alpha1<br/>kind: Component<br/>metadata:<br/>  name: statestore<br/>  namespace: default<br/>spec:<br/>  type: state.redis<br/>  version: v1<br/>  metadata:<br/>  - name: redisHost<br/>    value: localhost:6379<br/>  - name: redisPassword<br/>    secretKeyRef:<br/>      name: redis<br/>      key: redis-password</span></pre><p id="e719" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在这里，我们使用 redis 缓存为持久性和恢复创建一个状态存储组件。</p><p id="fb02" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="ly"> 5.2。部署到 Kubernetes 集群</em></p><pre class="lj lk ll lm gt ln lo lp lq aw lr bi"><span id="4866" class="ls lt in lo b gy lu lv l lw lx">deploy -f redis-pubsub.yaml apply</span></pre><p id="4958" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">6.使用它</p><p id="b7d9" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">6.1.将客户端添加到商店</p><pre class="lj lk ll lm gt ln lo lp lq aw lr bi"><span id="1da9" class="ls lt in lo b gy lu lv l lw lx">POST <a class="ae kt" href="http://localhost:5000/addClient" rel="noopener ugc nofollow" target="_blank">http://localhost:5000/addClient</a><br/>Content-Type: application/json</span><span id="077c" class="ls lt in lo b gy lz lv l lw lx">{<br/>    "Id": "1",<br/>    "FirstName" : "Evgeny",<br/>    "LastName" : "Grishchenko"<br/>}</span></pre><p id="2598" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">要验证 redis(商店):</p><pre class="lj lk ll lm gt ln lo lp lq aw lr bi"><span id="93f4" class="ls lt in lo b gy lu lv l lw lx">redis-cli -h localhost -a &lt;YOUR REDIS PASSWORD&gt;<br/>KEYS *<br/>HGET &lt;OUR KEY NAME&gt;</span></pre><p id="4000" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">是的，该值存储为哈希类型。在这种情况下，键的名称应该是<code class="fe ma mb mc lo b">controller||&lt;client id&gt;</code></p><p id="e1ff" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">6.2.从商店获得客户</p><pre class="lj lk ll lm gt ln lo lp lq aw lr bi"><span id="e344" class="ls lt in lo b gy lu lv l lw lx">GET <a class="ae kt" href="http://localhost:5000/getClient/1" rel="noopener ugc nofollow" target="_blank">http://localhost:5000/getClient/1</a><br/>Content-Type: application/json</span><span id="319a" class="ls lt in lo b gy lz lv l lw lx">{<br/>    "id": "1",<br/>    "firstName": "Evgeny",<br/>    "lastName": "Grishchenko"<br/>}</span></pre><p id="5113" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">6.3.从存储中删除客户端</p><pre class="lj lk ll lm gt ln lo lp lq aw lr bi"><span id="2ace" class="ls lt in lo b gy lu lv l lw lx">DELETE <a class="ae kt" href="http://localhost:5000/deleteClient/1" rel="noopener ugc nofollow" target="_blank">http://localhost:5000/deleteClient/1</a></span></pre><h1 id="ec5c" class="md lt in bd me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz bi translated"><strong class="ak">解释</strong></h1><p id="4218" class="pw-post-body-paragraph jv jw in jx b jy na ka kb kc nb ke kf kg nc ki kj kk nd km kn ko ne kq kr ks ig bi translated">在我们的 ubernetes 集群中，我们有类型为<code class="fe ma mb mc lo b">state.redis.</code>的 Dapr 组件<code class="fe ma mb mc lo b">statestore</code></p><p id="0ed1" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">为什么我们需要这额外的一层？我们可以直接从我们的 dotnet 核心项目中使用 redis。</p><p id="cf9c" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">但是如果我需要换成 Memcached、MongoDB 或者 Azure SQL 呢？</p><p id="3f95" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">使用 Dapr，您不需要更改源代码中的任何内容，您只需要使用另一个 Dapr 状态存储组件。</strong></p><p id="782a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><a class="ae kt" href="https://docs.dapr.io/operations/components/setup-state-store/supported-state-stores/" rel="noopener ugc nofollow" target="_blank">在这里</a>你可以找到受支持的州商店列表。</p></div></div>    
</body>
</html>