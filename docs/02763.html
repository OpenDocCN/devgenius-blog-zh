<html>
<head>
<title>DCF77 Time Sync: How Does it Work</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">DCF77时间同步:它是如何工作的</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/dcf77-time-sync-how-does-it-work-d4fb4dbe9941?source=collection_archive---------0-----------------------#2020-08-28">https://blog.devgenius.io/dcf77-time-sync-how-does-it-work-d4fb4dbe9941?source=collection_archive---------0-----------------------#2020-08-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="6c3d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">大概买了钟或者气象站的人都见过包装上的“电波钟”甚至“原子钟”的标识。自动时间同步非常方便，因为把时钟放在桌子上就够了，过一会儿就会自动调整到准确的时间。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi kl"><img src="../Images/a0fb72063a9662a198fd0a14b0be0a9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:914/format:webp/0*Q0zQoaSVouZ2PzyF.png"/></div></figure><p id="6fa3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们弄清楚它是如何工作的。</p><p id="8e99" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有不同的时间同步系统。欧洲最流行的是德国的<a class="ae kt" href="https://en.wikipedia.org/wiki/DCF77" rel="noopener ugc nofollow" target="_blank"> DCF-77 </a>系统，日本有自己的<a class="ae kt" href="https://en.wikipedia.org/wiki/JJY" rel="noopener ugc nofollow" target="_blank"> JJY </a>系统，美国有<a class="ae kt" href="https://en.wikipedia.org/wiki/WWVB" rel="noopener ugc nofollow" target="_blank"> WWVB </a>等等。此外，这个故事将是关于DCF77的，它与欧洲的接收最相关也最容易。其他地方的居民可能有相反的意见，但是，他们反过来可以接收和分析日本或美国的信号。</p><p id="0195" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们开始吧。</p><h1 id="be16" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">接收信号</h1><p id="71fc" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">DCF77是一个长波电台，工作频率为77.5千赫，发射调幅信号。该电站功率为50千瓦，位于法兰克福25公里处。它于1959年开始发送时间信号，1973年增加了日期信息。77 kHz频率的波长很长，所以天线场的大小也很大(图片来自维基百科):</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi lx"><img src="../Images/c3835995cfc1011f7c2d1d0fc786517b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Ulh8uuXPszMEnQPr.png"/></div></div></figure><p id="b4cd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有了这样的天线和发射功率，接收区域几乎覆盖整个欧洲，甚至白俄罗斯、乌克兰和部分俄罗斯和土耳其:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi mc"><img src="../Images/dd41d3c4ba76c6f051bf713890d0def6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1150/format:webp/0*S49dx2KlCXtuRTWm.png"/></div></figure><p id="c29a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">任何人都可以记录信号，即使没有任何特定的硬件。使用位于荷兰的<a class="ae kt" href="http://websdr.ewi.utwente.nl:8901/" rel="noopener ugc nofollow" target="_blank">在线接收器</a>很容易做到这一点。选择76.5KHz频率和USB调制。图片应该是这样的:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi md"><img src="../Images/97d71b0d52935793870f925c388bb36d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*JKEu239gMGG3o0p_.png"/></div></div></figure><p id="7229" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">按下“开始”按钮，然后记录和保存几分钟长的片段，WAV文件应该创建。当然，录音也可以使用真正的接收器，如Elad SDR或SDRPlay。</p><p id="072d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过互联网接收无线电信号，我们肯定不会获得真正准确的时间——信号传输有延迟。但是我们的目标仅仅是理解信号结构，这种类型的记录对于这个来说绰绰有余。当我们有了录音，让我们开始分析它。</p><h1 id="614b" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">解码</h1><p id="a1cf" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">首先，让我们使用Python加载文件:</p><pre class="km kn ko kp gt me mf mg mh aw mi bi"><span id="c1a0" class="mj kv iq mf b gy mk ml l mm mn">from scipy.io import wavfile<br/>from scipy import signal<br/>import matplotlib.pyplot as plt<br/>import numpy as np</span><span id="52c3" class="mj kv iq mf b gy mo ml l mm mn">sample_rate, data = wavfile.read("dcf_76.6kHz.wav")</span><span id="1c7b" class="mj kv iq mf b gy mo ml l mm mn">plt.plot(data[:100000])<br/>plt.show()</span></pre><p id="4810" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们看到调幅:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi mp"><img src="../Images/8809c89fbdaa0ca85178c9b50625ad03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*qxpfHT35aCeJ8n1h.png"/></div></div></figure><p id="da3d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们使用<a class="ae kt" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.signal.hilbert.html" rel="noopener ugc nofollow" target="_blank">希尔伯特变换</a>得到信号包络:</p><pre class="km kn ko kp gt me mf mg mh aw mi bi"><span id="a83f" class="mj kv iq mf b gy mk ml l mm mn">analytic_signal = signal.hilbert(data)<br/>A = np.abs(analytic_signal)<br/>plt.plot(A[:100000])</span></pre><p id="6e50" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">放大后的结果:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi mq"><img src="../Images/2d1df0a9ed25501972e76e111ecc83cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*bbRZ0lOr3WFd4DSO.png"/></div></div></figure><p id="56a7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以使用低通巴特沃兹T2滤波器来消除噪音。让我们也计算一下平均值，这对于后面的解析会很有用。</p><pre class="km kn ko kp gt me mf mg mh aw mi bi"><span id="52db" class="mj kv iq mf b gy mk ml l mm mn">b, a = signal.butter(2, 20.0/sample_rate)<br/>zi = signal.lfilter_zi(b, a)<br/>A, _ = signal.lfilter(b, a, A, zi=zi*A[0])<br/>avg = (np.amax(A) + np.amin(A))/2</span></pre><p id="1115" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">结果(黄线)是一个非常容易分析的近似方波:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi mr"><img src="../Images/84055184c88cedaa0296f7cf57ccc3e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Iov6hOZ8foXG83PY.png"/></div></div></figure><h1 id="5031" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">从语法上分析</h1><p id="4355" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">首先，我们需要得到位序列。信号结构本身非常简单。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi ms"><img src="../Images/b01801e4a32c043e53752d3eb57e799c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*4mtlWOHwh1jiBIgS.png"/></div></div></figure><p id="0716" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">脉冲被分成秒间隔。如果脉冲之间的距离是0.1s(即脉冲本身的长度是0.9s)，我们给比特序列加“0”，如果距离是0.2s(即长度0.8s)，我们加“1”。每一分钟的结束由一个更长的2s脉冲指示。然后，比特序列被重置为零，并且重新开始填充。</p><p id="b4c2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以上用Python写很容易。</p><pre class="km kn ko kp gt me mf mg mh aw mi bi"><span id="7649" class="mj kv iq mf b gy mk ml l mm mn">sig_start, sig_stop = 0, 0<br/>pos = 0<br/>bits_str = ""<br/>while pos &lt; cnt - 4:<br/>    if A[pos] &lt; avg and A[pos+1] &gt; avg:<br/>        <em class="mt"># Signal begin</em><br/>        sig_start = pos<br/>    if A[pos] &gt; avg and A[pos+1] &lt; avg:<br/>        <em class="mt"># Signal end</em><br/>        sig_stop = pos</span><span id="dbef" class="mj kv iq mf b gy mo ml l mm mn">        diff = sig_stop - sig_start<br/>    <br/>        if diff &lt; 0.85*sample_rate:<br/>            bits_str += "1"<br/>        if diff &gt; 0.85*sample_rate and diff &lt; 1.25*sample_rate:<br/>            bits_str += "0"<br/>        if diff &gt; 1.5*sample_rate:<br/>            print(bits_str)<br/>            bits_str = ""</span><span id="a5eb" class="mj kv iq mf b gy mo ml l mm mn">    pos += 1</span></pre><p id="0320" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">结果，我们得到一个比特序列，在我们两分钟的例子中，它看起来像这样:</p><p id="498c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mu mv mw mf b">0011110110111000001011000001010000100110010101100010011000<br/>0001111100110110001010100001010000100110010101100010011000</code></p><p id="bdd1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">顺便提一下，有趣的是信号还包含“第二层”数据DCF信号也是使用<a class="ae kt" href="https://en.wikipedia.org/wiki/DCF77#Phase_modulation" rel="noopener ugc nofollow" target="_blank">相位调制</a>编码的。即使在弱信号的情况下，这也应该提供更鲁棒的解码。</p><p id="61ee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们的最后一步是从bits中获取实际数据。它们每秒传输一次，因此我们只有59位，其中编码了不同的信息:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi mx"><img src="../Images/139a91034181d7527cc7560b8606a4ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1172/format:webp/0*jJ57i34klcua_5HZ.png"/></div></figure><p id="a2b4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">维基百科上描述了这些比特，它们非常有趣。前15位未被使用，尽管有计划将其用于公共警报系统。位<em class="mt"> A1 </em>表示时钟将在下一小时设置为夏令时。位<em class="mt"> A2 </em>表示下一个小时将多加一秒，有时用于根据地球自转修正时间。其余的位编码小时、分钟和日期。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi my"><img src="../Images/5c5ca11c358cafb55c5e790da155079a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*gmzoRZ_TBGmA9VBG.png"/></div></div></figure><p id="d792" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">其实这就是全部的魔力。这种系统的优点是解码极其简单，可以在任何微控制器上进行，甚至是最简单的微控制器。我们只是计算脉冲的长度，累积60位，在每一分钟结束时，我们得到精确的时间。与其他时间同步方法(GPS或互联网)相比，这种无线电同步几乎不需要电力——一个普通的气象站依靠两节AA电池可以工作大约一年。连接到WiFi并发出NTP请求的ESP32将在一周内耗尽电池。更有甚者，现在有些手表有无线电同步功能。</p><p id="0376" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">DCF的方便和简单也吸引了DIY爱好者。只需10-20美元，您就可以购买一个带有接收器和TTL输出的现成天线，它可以连接到Arduino或其他控制器:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/96fb4bcebddcfd31bcf97113408b6ff9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1292/format:webp/0*v9mjkpxHeg3Sm76L.png"/></div></figure><p id="5856" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">已经为Arduino编写了一些<a class="ae kt" href="https://github.com/udoklein/dcf77" rel="noopener ugc nofollow" target="_blank">库</a>。有了这样一个设备，获得精确的时间真的很容易，当然，如果你在信号覆盖区。嗯，在DIY设备上加上“原子钟”标签也是在给作者人气增加+100，可以给大家解释一下，这个设备真的是借助了一个原子钟同步的；)</p><p id="0e5a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">感兴趣的人甚至可以升级老祖母的时钟，在其中安装一个新的基于DCF的时钟机芯:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi na"><img src="../Images/c5886711a1d4751cccffadf06c0c069a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1338/format:webp/0*2HN4DbkbuKAHXZij.png"/></div></figure><p id="bff8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可以找到一个关于易贝的关键词“无线电控制运动”。</p><p id="1e9d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，给已经读到这里的人一个生活窍门。即使最近的一千公里内没有单一覆盖，也很容易产生这样的信号。Google Play有一个名为“DCF77 Emulator”的程序，将信号输出到耳机。根据描述，如果你全天候缠绕耳机线，他们将接收到信号(我想知道如何接收，因为智能手机声音输出很可能不会发出77KHz的信号，但接收很可能由于谐波而工作)。该程序在我的智能手机上根本不工作——完全没有声音(或者也许我只是没有听到——毕竟是77KHz:)，但也许有人会更幸运。甚至可以使用Arduino或ESP32制作一个成熟的DCF信号发生器:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi nb"><img src="../Images/a6fb066981238a4901f8ae9df962b5f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*or8bJUibDIKa3-PL.png"/></div></div></figure><p id="ef70" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">(来源<a class="ae kt" href="https://sgfantasytoys.wordpress.com/2015/05/13/synchronize-radio-controlled-watch-without-access/" rel="noopener ugc nofollow" target="_blank">sgfantasytoys . WordPress . com/2015/05/13/synchronize-radio-controlled-watch-without-access</a>)</p><h1 id="80e5" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">结论</h1><p id="d0f8" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">DCF系统被证明是非常有用和方便的。借助简单而廉价的接收器，我们可以在任何地方获得精确的时间，当然是在接待处。看起来，尽管数字化和“物联网”广泛存在，但这种简单的解决方案仍将有很长一段时间的需求。</p></div></div>    
</body>
</html>