<html>
<head>
<title>Provision Azure Infrastructure with Terraform and GitHub Action</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Terraform 和 GitHub 操作提供 Azure 基础架构</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/provision-azure-infrastructure-with-terraform-and-github-action-b36f7e55345f?source=collection_archive---------0-----------------------#2022-07-12">https://blog.devgenius.io/provision-azure-infrastructure-with-terraform-and-github-action-b36f7e55345f?source=collection_archive---------0-----------------------#2022-07-12</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/c415d71c779f6ee83693fe3b205cca38.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JB6UOyosibyt20MJuieRog.jpeg"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">工作流程</figcaption></figure><p id="8527" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">在这篇文章中，我将解释如何通过 GitHub Action 使用 Terraform 提供 Microsoft Azure 资源。</p><p id="84eb" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">先决条件:</strong></p><ol class=""><li id="0b26" class="kx ky in kb b kc kd kg kh kk kz ko la ks lb kw lc ld le lf bi translated">你有一个带有地形代码的 GitHub Repo</li><li id="63a3" class="kx ky in kb b kc lg kg lh kk li ko lj ks lk kw lc ld le lf bi translated">您拥有有效的 Azure 订阅</li><li id="0d8f" class="kx ky in kb b kc lg kg lh kk li ko lj ks lk kw lc ld le lf bi translated">您已经在本地计算机中配置了 Azure CLI</li></ol><p id="0545" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">安装 Azure CLI: </strong>按照<a class="ae ll" href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli" rel="noopener ugc nofollow" target="_blank">安装 Azure CLI </a>中提供的说明来设置您的 Azure CLI 环境。</p><h1 id="bec0" class="lm ln in bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">步骤:</h1><ol class=""><li id="a11e" class="kx ky in kb b kc mk kg ml kk mm ko mn ks mo kw lc ld le lf bi translated">使用以下命令创建服务主体并保存信息</li></ol><pre class="mp mq mr ms gt mt mu mv mw aw mx bi"><span id="7a85" class="my ln in mu b gy mz na l nb nc">az ad sp create-for-rbac --name myServicePrincipalName --role Contributor --scopes /subscriptions/mySubscriptionID</span></pre><p id="74f3" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">2.创建 GitHub 秘密</p><p id="80c0" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">进入你的 GitHub Repo →设置→秘密</p><figure class="mp mq mr ms gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nd"><img src="../Images/e1d2e6fb618526a547ed05a7091be711.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nyR03ElKWfYwj8_p2fflvw.jpeg"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">秘密屏幕</figcaption></figure><p id="b98c" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">单击 New repository secret，并使用之前创建的服务主体的值添加以下机密</p><figure class="mp mq mr ms gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ne"><img src="../Images/b73fae1ca71550f6d24207dab3caf1a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZvwsrRyrLHeRVHuSYjEWXw.jpeg"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">秘密</figcaption></figure><p id="c29f" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">3.创建 GitHub 工作流</p><p id="45ff" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">转到您的 GitHub Repo →操作</p><p id="77b2" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">点击<strong class="kb io">自行设置工作流程</strong></p><figure class="mp mq mr ms gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nf"><img src="../Images/0fa4b778ce19868ce858a1f56612b49c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-VR9q-soZC-5-WlHzGBVYg.jpeg"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">工作流程</figcaption></figure><p id="2caa" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">工作流配置详情:</strong></p><blockquote class="ng nh ni"><p id="884b" class="jz ka nj kb b kc kd ke kf kg kh ki kj nk kl km kn nl kp kq kr nm kt ku kv kw ig bi translated">工作流名称</p></blockquote><pre class="mp mq mr ms gt mt mu mv mw aw mx bi"><span id="46ac" class="my ln in mu b gy mz na l nb nc">name: 'Terraform'</span></pre><blockquote class="ng nh ni"><p id="8f1c" class="jz ka nj kb b kc kd ke kf kg kh ki kj nk kl km kn nl kp kq kr nm kt ku kv kw ig bi translated">Trigger —在这种情况下，我仅使用输入参数启用了手动触发</p></blockquote><pre class="mp mq mr ms gt mt mu mv mw aw mx bi"><span id="5e4a" class="my ln in mu b gy mz na l nb nc">on:<br/>  workflow_dispatch:<br/>    inputs:<br/>      TFAction:<br/>        description: "Terraform Action- Apply or Destroy"     <br/>        required: true<br/>        default: "apply"</span></pre><blockquote class="ng nh ni"><p id="32ca" class="jz ka nj kb b kc kd ke kf kg kh ki kj nk kl km kn nl kp kq kr nm kt ku kv kw ig bi translated">乔布斯— ${{机密。CLIENT_ID }}正在使用在机密和环境变量下创建的机密，以便在整个作业中使用</p></blockquote><pre class="mp mq mr ms gt mt mu mv mw aw mx bi"><span id="767f" class="my ln in mu b gy mz na l nb nc">jobs:<br/>  terraform:<br/>    name: 'Terraform'<br/>    runs-on: ubuntu-latest<br/>    environment: dev<br/>    env:<br/>      ARM_CLIENT_ID: ${{ secrets.CLIENT_ID }}<br/>      ARM_CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}<br/>      ARM_SUBSCRIPTION_ID: ${{ secrets.SUBSCRIPTION_ID }}<br/>      ARM_TENANT_ID: ${{ secrets.TENANT_ID }}<br/>      TerraformBackendStorageAccount: "mystgacount"<br/>      TerraformBackendResourceGroup: "myrg"<br/>      TerraformBackendStorageContainer: "state"</span></pre><h2 id="581b" class="my ln in bd lo nn no dn ls np nq dp lw kk nr ns ma ko nt nu me ks nv nw mi nx bi translated">步伐</h2><blockquote class="ng nh ni"><p id="c075" class="jz ka nj kb b kc kd ke kf kg kh ki kj nk kl km kn nl kp kq kr nm kt ku kv kw ig bi translated">检验</p></blockquote><pre class="mp mq mr ms gt mt mu mv mw aw mx bi"><span id="93fe" class="my ln in mu b gy mz na l nb nc">- name: Checkout<br/>  uses: actions/checkout@v3</span></pre><blockquote class="ng nh ni"><p id="6702" class="jz ka nj kb b kc kd ke kf kg kh ki kj nk kl km kn nl kp kq kr nm kt ku kv kw ig bi translated">安装地形</p></blockquote><pre class="mp mq mr ms gt mt mu mv mw aw mx bi"><span id="5adb" class="my ln in mu b gy mz na l nb nc">- name: Setup Terraform<br/>  uses: hashicorp/setup-terraform@v1</span></pre><blockquote class="ng nh ni"><p id="50a3" class="jz ka nj kb b kc kd ke kf kg kh ki kj nk kl km kn nl kp kq kr nm kt ku kv kw ig bi translated">地形初始化</p></blockquote><pre class="mp mq mr ms gt mt mu mv mw aw mx bi"><span id="4359" class="my ln in mu b gy mz na l nb nc">- name: Terraform Init<br/>  run: terraform init -backend-     config=storage_account_name=$TerraformBackendStorageAccount -backend-config=container_name=$TerraformBackendStorageContainer -backend-config=key=dev.tfstate -backend-config=resource_group_name=$TerraformBackendResourceGroup -backend-config=subscription_id="$ARM_SUBSCRIPTION_ID" -backend-config=tenant_id="$ARM_TENANT_ID" -backend-config=client_id="$ARM_CLIENT_ID" -backend-config=client_secret="$ARM_CLIENT_SECRET"</span></pre><blockquote class="ng nh ni"><p id="7f26" class="jz ka nj kb b kc kd ke kf kg kh ki kj nk kl km kn nl kp kq kr nm kt ku kv kw ig bi translated">地形图</p></blockquote><pre class="mp mq mr ms gt mt mu mv mw aw mx bi"><span id="571a" class="my ln in mu b gy mz na l nb nc">- name: Terraform Plan<br/>      run: terraform plan -out=plan.tfplan -input=false -var="location=eastus" -var="resource_group_name=tfdemo" -var="storage_account_name=tfdemoabcxxyg" -var="storage_account_tier=Standard" -var="virtual_network_name=myvnet"</span></pre><blockquote class="ng nh ni"><p id="3919" class="jz ka nj kb b kc kd ke kf kg kh ki kj nk kl km kn nl kp kq kr nm kt ku kv kw ig bi translated">Terraform 应用-基于 TFAction 输入参数</p></blockquote><pre class="mp mq mr ms gt mt mu mv mw aw mx bi"><span id="4614" class="my ln in mu b gy mz na l nb nc">- name: Terraform Apply<br/>      if: ${{ inputs.TFAction == 'apply'}}  <br/>      run: terraform apply -input=false -auto-approve plan.tfplan</span></pre><blockquote class="ng nh ni"><p id="7f12" class="jz ka nj kb b kc kd ke kf kg kh ki kj nk kl km kn nl kp kq kr nm kt ku kv kw ig bi translated">Terraform Destroy -基于 TFAction 输入参数</p></blockquote><pre class="mp mq mr ms gt mt mu mv mw aw mx bi"><span id="d039" class="my ln in mu b gy mz na l nb nc">- name: Terraform Destroy<br/>      if: ${{ inputs.TFAction == 'destroy' }} <br/>      run: terraform destroy -input=false -auto-approve</span></pre><h2 id="a59e" class="my ln in bd lo nn no dn ls np nq dp lw kk nr ns ma ko nt nu me ks nv nw mi nx bi translated">完整的 yaml 配置</h2><pre class="mp mq mr ms gt mt mu mv mw aw mx bi"><span id="85c7" class="my ln in mu b gy mz na l nb nc">name: 'Terraform'<br/>on:<br/>  workflow_dispatch:<br/>    inputs:<br/>      TFAction:<br/>        description: "Terraform Action- Apply or Destroy"     <br/>        required: true<br/>        default: "apply"</span><span id="b5df" class="my ln in mu b gy ny na l nb nc">permissions:<br/>  contents: read</span><span id="f025" class="my ln in mu b gy ny na l nb nc">jobs:<br/>  terraform:<br/>    name: 'Terraform'<br/>    runs-on: ubuntu-latest<br/>    environment: dev<br/>    env:<br/>      ARM_CLIENT_ID: ${{ secrets.CLIENT_ID }}<br/>      ARM_CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}<br/>      ARM_SUBSCRIPTION_ID: ${{ secrets.SUBSCRIPTION_ID }}<br/>      ARM_TENANT_ID: ${{ secrets.TENANT_ID }}<br/>      TerraformBackendStorageAccount: "mystgacount"<br/>      TerraformBackendResourceGroup: "myrg"<br/>      TerraformBackendStorageContainer: "state"           <br/>      <br/>    defaults:<br/>      run:<br/>        shell: bash</span><span id="e097" class="my ln in mu b gy ny na l nb nc">steps:<br/>    - name: Checkout<br/>      uses: actions/checkout@v3<br/>      <br/>    - name: Setup Terraform<br/>      uses: hashicorp/setup-terraform@v1</span><span id="e17d" class="my ln in mu b gy ny na l nb nc">- name: Terraform Init<br/>      run: terraform init -backend-config=storage_account_name=$TerraformBackendStorageAccount -backend-config=container_name=$TerraformBackendStorageContainer -backend-config=key=dev.tfstate -backend-config=resource_group_name=$TerraformBackendResourceGroup -backend-config=subscription_id="$ARM_SUBSCRIPTION_ID" -backend-config=tenant_id="$ARM_TENANT_ID" -backend-config=client_id="$ARM_CLIENT_ID" -backend-config=client_secret="$ARM_CLIENT_SECRET"</span><span id="ffdd" class="my ln in mu b gy ny na l nb nc">- name: Terraform Plan<br/>      run: terraform plan -out=plan.tfplan -input=false -var="location=eastus" -var="resource_group_name=tfdemo" -var="storage_account_name=tfdemoabcxxyg" -var="storage_account_tier=Standard" -var="virtual_network_name=myvnet"</span><span id="b4e6" class="my ln in mu b gy ny na l nb nc">- name: Terraform Apply<br/>      if: ${{ inputs.TFAction == 'apply'}}  <br/>      run: terraform apply -input=false -auto-approve plan.tfplan</span><span id="bbc0" class="my ln in mu b gy ny na l nb nc">- name: Terraform Destroy<br/>      if: ${{ inputs.TFAction == 'destroy' }} <br/>      run: terraform destroy -input=false -auto-approve</span></pre><p id="c33e" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">4.触发工作流</p><figure class="mp mq mr ms gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nz"><img src="../Images/e034877785e8ea65ca917348a0447a07.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z1RSbXPZIrPuTfSsZYRajg.jpeg"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">引发</figcaption></figure></div><div class="ab cl oa ob hr oc" role="separator"><span class="od bw bk oe of og"/><span class="od bw bk oe of og"/><span class="od bw bk oe of"/></div><div class="ig ih ii ij ik"><p id="8662" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">示例工作流结果</p><figure class="mp mq mr ms gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi oh"><img src="../Images/8ed3619a5c836d8ad54c7b5fdb4f2f06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9No9G-tBxGyg0jqnCfpkXQ.jpeg"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">结果</figcaption></figure><p id="6fd2" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">用于本演示的配置可在<a class="ae ll" href="https://github.com/babula000/TF" rel="noopener ugc nofollow" target="_blank">这里</a>找到</p><p id="d427" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">其他资源:</strong></p><div class="oi oj gp gr ok ol"><a href="https://docs.github.com/en/actions" rel="noopener  ugc nofollow" target="_blank"><div class="om ab fo"><div class="on ab oo cl cj op"><h2 class="bd io gy z fp oq fr fs or fu fw im bi translated">GitHub 操作文档- GitHub 文档</h2><div class="os l"><h3 class="bd b gy z fp oq fr fs or fu fw dk translated">使用 GitHub Actions 在您的存储库中自动化、定制和执行您的软件开发工作流。你…</h3></div><div class="ot l"><p class="bd b dl z fp oq fr fs or fu fw dk translated">docs.github.com</p></div></div><div class="ou l"><div class="ov l ow ox oy ou oz jt ol"/></div></div></a></div><div class="oi oj gp gr ok ol"><a href="https://github.com/babula000/TF" rel="noopener  ugc nofollow" target="_blank"><div class="om ab fo"><div class="on ab oo cl cj op"><h2 class="bd io gy z fp oq fr fs or fu fw im bi translated">GitHub - babula000/TF</h2><div class="os l"><h3 class="bd b gy z fp oq fr fs or fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="ot l"><p class="bd b dl z fp oq fr fs or fu fw dk translated">github.com</p></div></div><div class="ou l"><div class="pa l ow ox oy ou oz jt ol"/></div></div></a></div><p id="3d32" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">我希望你喜欢阅读这篇文章，随时添加你的评论、想法或反馈，不要忘记在 linkedin 上保持联系。</p></div></div>    
</body>
</html>