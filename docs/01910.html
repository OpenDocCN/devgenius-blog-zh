<html>
<head>
<title>C# client from multiple API versions using NSwag</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用NSwag的多个API版本的C#客户端</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/nswag-charp-client-from-multiple-api-versions-7c79a3de4622?source=collection_archive---------3-----------------------#2020-07-14">https://blog.devgenius.io/nswag-charp-client-from-multiple-api-versions-7c79a3de4622?source=collection_archive---------3-----------------------#2020-07-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><blockquote class="jn jo jp"><p id="b951" class="jq jr js jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ij bi translated"><em class="iq">其他类似文章:<br/> </em> <a class="ae kp" href="https://medium.com/dev-genius/nswag-csharp-client-with-generics-support-6ad6a09f81d6?source=your_stories_page---------------------------" rel="noopener"> <em class="iq"> C#客户端用泛型支持使用ns wag</em></a><em class="iq"><br/></em><a class="ae kp" href="https://medium.com/dev-genius/csharp-protecting-swagger-endpoints-82ae5cfc7eb1" rel="noopener">C #保护Swagger端点</a></p></blockquote><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div class="gh gi kq"><img src="../Images/cf8ea2068d9c2e1771577c1f858b7564.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*krtKWFlZlaXFN3oIFaQAqA.png"/></div></figure><p id="9861" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb ky kd ke kf kz kh ki kj la kl km kn ko ij bi translated">之前我分享了一个来自OpenAPI规范的关于C#客户端生成中泛型支持的解决方案。在这篇文章中，我将展示如何在C#客户端中安排API版本并支持它。</p></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><p id="853f" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb ky kd ke kf kz kh ki kj la kl km kn ko ij bi translated"><em class="js">在开始这篇文章之前，我强烈推荐访问</em> <a class="ae kp" href="https://medium.com/dev-genius/nswag-csharp-client-with-generics-support-6ad6a09f81d6" rel="noopener"> <em class="js">上一篇</em> </a> <em class="js">。</em></p><h1 id="b1ea" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">。νε版本控制</h1><p id="a3cf" class="pw-post-body-paragraph jq jr iq jt b ju mg jw jx jy mh ka kb ky mi ke kf kz mj ki kj la mk km kn ko ij bi translated">首先，我们需要我们的<em class="js"> App </em>带有API版本控制(<a class="ae kp" href="https://github.com/RicoSuter/NSwag/wiki/AspNetCore-Middleware#use-api-versioning" rel="noopener ugc nofollow" target="_blank"> <em class="js"> NSwag </em> wiki API版本控制</a>)。</p><p id="d0ed" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb ky kd ke kf kz kh ki kj la kl km kn ko ij bi translated"><em class="js">启动</em>类有变化:</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="ml mm l"/></div><figcaption class="mn mo gj gh gi mp mq bd b be z dk translated">更改后的Startup.cs</figcaption></figure><p id="ea78" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb ky kd ke kf kz kh ki kj la kl km kn ko ij bi translated">给控制器添加一些版本:</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="ml mm l"/></div><figcaption class="mn mo gj gh gi mp mq bd b be z dk translated">天气预报控制员V1</figcaption></figure><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="ml mm l"/></div><figcaption class="mn mo gj gh gi mp mq bd b be z dk translated">天气预报控制员V2</figcaption></figure><p id="4541" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb ky kd ke kf kz kh ki kj la kl km kn ko ij bi translated">以下是根据前面的步骤更新的swagger UI:</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi mr"><img src="../Images/5796f49658d97d8b87ea96f0bfed3eef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jFbhW91p7xQZBro6QicPmQ.png"/></div></div></figure><p id="d278" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb ky kd ke kf kz kh ki kj la kl km kn ko ij bi translated">有关API版本的更多信息，请点击此处:</p><ul class=""><li id="3645" class="mw mx iq jt b ju jv jy jz ky my kz mz la na ko nb nc nd ne bi translated"><a class="ae kp" href="https://github.com/microsoft/aspnet-api-versioning/wiki" rel="noopener ugc nofollow" target="_blank"><em class="js">https://github.com/microsoft/aspnet-api-versioning/wiki</em></a></li><li id="dc14" class="mw mx iq jt b ju nf jy ng ky nh kz ni la nj ko nb nc nd ne bi translated"><a class="ae kp" href="https://github.com/Microsoft/api-guidelines/blob/master/Guidelines.md#12-versioning" rel="noopener ugc nofollow" target="_blank"><em class="js">https://github . com/Microsoft/API-guidelines/blob/master/guidelines . MD # 12-版本控制</em> </a></li></ul><h1 id="16e6" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">C#客户端生成</h1><p id="361d" class="pw-post-body-paragraph jq jr iq jt b ju mg jw jx jy mh ka kb ky mi ke kf kz mj ki kj la mk km kn ko ij bi translated">现在我们应该意识到如何用这些东西制作一个C#客户端。</p><p id="2d1a" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb ky kd ke kf kz kh ki kj la kl km kn ko ij bi translated">客户端生成的第一个里程碑是模式。在我看来，有两种方法:</p><ul class=""><li id="c9e3" class="mw mx iq jt b ju jv jy jz ky my kz mz la na ko nb nc nd ne bi translated">一个模式中存在多个版本</li><li id="2667" class="mw mx iq jt b ju nf jy ng ky nh kz ni la nj ko nb nc nd ne bi translated">每个版本都有自己的模式</li></ul><p id="63ae" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb ky kd ke kf kz kh ki kj la kl km kn ko ij bi translated">创建模式后，我打算为每个版本生成API客户机，然后将它们包装在一个客户机中。</p><p id="66b7" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb ky kd ke kf kz kh ki kj la kl km kn ko ij bi translated">让我们检查两种解决方案。</p><h2 id="024b" class="nk lj iq bd lk nl nm dn lo nn no dp ls ky np nq lw kz nr ns ma la nt nu me nv bi translated">1.一个模式中存在多个版本</h2><p id="c1af" class="pw-post-body-paragraph jq jr iq jt b ju mg jw jx jy mh ka kb ky mi ke kf kz mj ki kj la mk km kn ko ij bi translated">如果我们选择第一种方法，那么我们应该为所有版本创建一个统一的模式，并从中生成客户机。</p><p id="e434" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb ky kd ke kf kz kh ki kj la kl km kn ko ij bi translated"><em class="js"> NSwag </em>配置<em class="js"> </em>有<em class="js"> </em>一个选项<em class="js"/><a class="ae kp" href="https://github.com/RicoSuter/NSwag/blob/85ae862fd6d68173a201a79e0ad06e0be2ec5de1/src/NSwag.Commands/Commands/CodeGeneration/OperationGenerationMode.cs" rel="noopener ugc nofollow" target="_blank"><em class="js">OperationGenerationMode</em></a><em class="js"/>指定如何生成操作名和客户端类/接口。有<em class="js">MultipleClientsFromFirstTagAndOperationId</em>可用值列表中有一个摘要:<em class="js">“来自第一个操作标签和操作Id(操作名=操作ID，客户端名=第一个操作标签)。”</em></p><p id="5271" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb ky kd ke kf kz kh ki kj la kl km kn ko ij bi translated">它非常适合这个问题，但是在这种情况下，另外，我们应该支持标记来根据版本对客户端进行分组。</p><p id="472f" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb ky kd ke kf kz kh ki kj la kl km kn ko ij bi translated">以下是我得到的信息:</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="ml mm l"/></div></figure><p id="5689" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb ky kd ke kf kz kh ki kj la kl km kn ko ij bi translated">新版本的<em class="js"> csproj </em>脚本几乎是一样的:</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="ml mm l"/></div></figure><p id="d43f" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb ky kd ke kf kz kh ki kj la kl km kn ko ij bi translated">修改了<em class="js"> nswag.json </em>和文件结构:</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="ml mm l"/></div></figure><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/f158729df9cc87847793888a624520c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:756/format:webp/1*WFDbZ6cutKkRE0__32_GKQ.png"/></div><figcaption class="mn mo gj gh gi mp mq bd b be z dk translated">已更改文件结构</figcaption></figure><p id="6035" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb ky kd ke kf kz kh ki kj la kl km kn ko ij bi translated">最后一步是包装客户端。随它去吧<a class="ae kp" href="https://docs.microsoft.com/en-us/visualstudio/modeling/design-time-code-generation-by-using-t4-text-templates?view=vs-2019" rel="noopener ugc nofollow" target="_blank"> T4模板</a>:</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="ml mm l"/></div></figure><p id="9244" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb ky kd ke kf kz kh ki kj la kl km kn ko ij bi translated">这是模板编译后的API客户端包装:</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="ml mm l"/></div></figure><p id="9524" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb ky kd ke kf kz kh ki kj la kl km kn ko ij bi translated">关于变更的几点说明:</p><ul class=""><li id="fa9f" class="mw mx iq jt b ju jv jy jz ky my kz mz la na ko nb nc nd ne bi translated"><em class="js">VersionTaggingOperationProcessor</em>为每个操作添加版本标签</li><li id="97fc" class="mw mx iq jt b ju nf jy ng ky nh kz ni la nj ko nb nc nd ne bi translated">在<em class="js"> nswag.json </em>中更改的<em class="js">clientClassAccessModifier</em>隐藏了不同版本的<em class="js"> ApiClients </em>以防止外部使用(仅暴露API客户端包装)</li><li id="462b" class="mw mx iq jt b ju nf jy ng ky nh kz ni la nj ko nb nc nd ne bi translated"><em class="js"> AppApiClientWrap.tt </em>模板解析结果<em class="js"> swagger.json </em>以获取其中呈现的版本</li></ul><p id="de31" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb ky kd ke kf kz kh ki kj la kl km kn ko ij bi translated">结果解决方案你可以在这里找到<a class="ae kp" href="https://github.com/Rynaret/SwagGenSample/tree/feature/api-versioning-clients-from-one-schema" rel="noopener ugc nofollow" target="_blank"/>。</p></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><h2 id="ebab" class="nk lj iq bd lk nl nm dn lo nn no dp ls ky np nq lw kz nr ns ma la nt nu me nv bi translated">2.每个版本都有自己的模式</h2><p id="303b" class="pw-post-body-paragraph jq jr iq jt b ju mg jw jx jy mh ka kb ky mi ke kf kz mj ki kj la mk km kn ko ij bi translated">由于每个版本都应该有自己的模式和自己的客户端，所以它的生成保持不变，但会多次出现:</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="ml mm l"/></div></figure><p id="7cee" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb ky kd ke kf kz kh ki kj la kl km kn ko ij bi translated">更改<em class="js"> nswag.json </em>配置:</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="ml mm l"/></div></figure><p id="ac86" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb ky kd ke kf kz kh ki kj la kl km kn ko ij bi translated">为API客户端创建入口点:</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="ml mm l"/></div></figure><p id="11b7" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb ky kd ke kf kz kh ki kj la kl km kn ko ij bi translated">这是模板编译后的API客户端包装:</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="ml mm l"/></div></figure><p id="b37b" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb ky kd ke kf kz kh ki kj la kl km kn ko ij bi translated">关于变更的几点说明:</p><ul class=""><li id="c565" class="mw mx iq jt b ju jv jy jz ky my kz mz la na ko nb nc nd ne bi translated"><a class="ae kp" href="https://docs.microsoft.com/en-us/visualstudio/msbuild/msbuild-batching?view=vs-2019" rel="noopener ugc nofollow" target="_blank"> <em class="js">项目组</em> </a>替换<em class="js"> csproj </em>中的<em class="js">属性组</em></li><li id="0042" class="mw mx iq jt b ju nf jy ng ky nh kz ni la nj ko nb nc nd ne bi translated"><em class="js"> nswag.json </em>有一个新的变量<em class="js"> ClientNamespace </em>，这是因为每个版本的API客户端都是独立的，不会因类名而冲突</li><li id="665e" class="mw mx iq jt b ju nf jy ng ky nh kz ni la nj ko nb nc nd ne bi translated"><em class="js"> nswag.json </em>有一个新变量<em class="js"> SwaggerPath </em>，它指定了在哪里可以找到特定版本的<em class="js"> swagger.json </em></li><li id="66bd" class="mw mx iq jt b ju nf jy ng ky nh kz ni la nj ko nb nc nd ne bi translated"><code class="fe nx ny nz oa b">dotnet orang replace</code> exec task得到<code class="fe nx ny nz oa b">IgnoreExitCode="true"</code>，因为如果目标文件中没有匹配项，工具会产生错误退出代码</li><li id="1cb5" class="mw mx iq jt b ju nf jy ng ky nh kz ni la nj ko nb nc nd ne bi translated"><em class="js"> AppApiClient.tt </em>模板解析<em class="js"> App.csproj </em>以获取<em class="js">项目组</em>中呈现的版本</li></ul><p id="5b49" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb ky kd ke kf kz kh ki kj la kl km kn ko ij bi translated">结果解决方案你可以在这里找到<a class="ae kp" href="https://github.com/Rynaret/SwagGenSample/tree/feature/api-versioning-multiple-clients" rel="noopener ugc nofollow" target="_blank"/>。</p></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><h1 id="ab4b" class="li lj iq bd lk ll ob ln lo lp oc lr ls lt od lv lw lx oe lz ma mb of md me mf bi translated">概述</h1><p id="01e3" class="pw-post-body-paragraph jq jr iq jt b ju mg jw jx jy mh ka kb ky mi ke kf kz mj ki kj la mk km kn ko ij bi translated">在本文中，我展示了如何使用<em class="js"> NSwag </em>在C#生成的客户端中支持版本控制。同样的方法可以应用于TypeScript客户端和其他客户端。</p><p id="31df" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb ky kd ke kf kz kh ki kj la kl km kn ko ij bi translated">这两个解决方案的最终代码可以在我的知识库中找到，链接在<strong class="jt ir">参考</strong>部分。</p><h1 id="1eef" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">参考</h1><div class="og oh gp gr oi oj"><a href="https://github.com/Rynaret/SwagGenSample/tree/feature/api-versioning-clients-from-one-schema" rel="noopener  ugc nofollow" target="_blank"><div class="ok ab fo"><div class="ol ab om cl cj on"><h2 class="bd ir gy z fp oo fr fs op fu fw ip bi translated">Rynaret/SwagGenSample(一个架构)</h2><div class="oq l"><h3 class="bd b gy z fp oo fr fs op fu fw dk translated">如何使用NSwag从具有泛型支持的OpenAPI规范生成C#客户端的示例…</h3></div><div class="or l"><p class="bd b dl z fp oo fr fs op fu fw dk translated">github.com</p></div></div><div class="os l"><div class="ot l ou ov ow os ox kw oj"/></div></div></a></div><div class="og oh gp gr oi oj"><a href="https://github.com/Rynaret/SwagGenSample/tree/feature/api-versioning-clients-from-multiple-schemas" rel="noopener  ugc nofollow" target="_blank"><div class="ok ab fo"><div class="ol ab om cl cj on"><h2 class="bd ir gy z fp oo fr fs op fu fw ip bi translated">Rynaret/SwagGenSample(多模式)</h2><div class="oq l"><h3 class="bd b gy z fp oo fr fs op fu fw dk translated">如何使用NSwag从具有泛型支持的OpenAPI规范生成C#客户端的示例…</h3></div><div class="or l"><p class="bd b dl z fp oo fr fs op fu fw dk translated">github.com</p></div></div><div class="os l"><div class="oy l ou ov ow os ox kw oj"/></div></div></a></div><div class="og oh gp gr oi oj"><a href="https://github.com/RicoSuter/NSwag/wiki" rel="noopener  ugc nofollow" target="_blank"><div class="ok ab fo"><div class="ol ab om cl cj on"><h2 class="bd ir gy z fp oo fr fs op fu fw ip bi translated">RicoSuter/NSwag</h2><div class="oq l"><h3 class="bd b gy z fp oo fr fs op fu fw dk translated">路线图| SDK开发| Contribute ASP.NET(核心)中间件:自动化/CLI:GUI:NSwagStudio(Windows GUI)编辑…</h3></div><div class="or l"><p class="bd b dl z fp oo fr fs op fu fw dk translated">github.com</p></div></div><div class="os l"><div class="oz l ou ov ow os ox kw oj"/></div></div></a></div><div class="og oh gp gr oi oj"><a href="https://medium.com/dev-genius/nswag-csharp-client-with-generics-support-6ad6a09f81d6" rel="noopener follow" target="_blank"><div class="ok ab fo"><div class="ol ab om cl cj on"><h2 class="bd ir gy z fp oo fr fs op fu fw ip bi translated">使用NSwag支持泛型的C#客户端</h2><div class="oq l"><h3 class="bd b gy z fp oo fr fs op fu fw dk translated">最近，我在使用NSwag生成C#客户端时遇到了泛型支持的困难。我做了一些研究…</h3></div><div class="or l"><p class="bd b dl z fp oo fr fs op fu fw dk translated">medium.com</p></div></div><div class="os l"><div class="pa l ou ov ow os ox kw oj"/></div></div></a></div><div class="og oh gp gr oi oj"><a href="https://github.com/microsoft/aspnet-api-versioning/wiki" rel="noopener  ugc nofollow" target="_blank"><div class="ok ab fo"><div class="ol ab om cl cj on"><h2 class="bd ir gy z fp oo fr fs op fu fw ip bi translated">Microsoft/aspnet-API-版本控制</h2><div class="oq l"><h3 class="bd b gy z fp oo fr fs op fu fw dk translated">版本控制是任何成熟web服务的一个重要方面。微软发布了REST API指南，要求…</h3></div><div class="or l"><p class="bd b dl z fp oo fr fs op fu fw dk translated">github.com</p></div></div><div class="os l"><div class="pb l ou ov ow os ox kw oj"/></div></div></a></div><div class="og oh gp gr oi oj"><a href="https://github.com/Microsoft/api-guidelines/blob/master/Guidelines.md#12-versioning" rel="noopener  ugc nofollow" target="_blank"><div class="ok ab fo"><div class="ol ab om cl cj on"><h2 class="bd ir gy z fp oo fr fs op fu fw ip bi translated">微软/api指南</h2><div class="oq l"><h3 class="bd b gy z fp oo fr fs op fu fw dk translated">文档编辑:约翰·戈斯曼(C+E)，克里斯·穆林斯(ASG)，加雷思·琼斯(ASG)，罗布·多林(C+E)，马克·斯塔福德(C+E)</h3></div><div class="or l"><p class="bd b dl z fp oo fr fs op fu fw dk translated">github.com</p></div></div><div class="os l"><div class="pc l ou ov ow os ox kw oj"/></div></div></a></div></div></div>    
</body>
</html>