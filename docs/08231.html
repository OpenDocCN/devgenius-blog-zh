<html>
<head>
<title>Kafka on Kubernetes: Using Strimzi — Part 6(Monitoring)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">库伯内特斯上的卡夫卡:使用斯特里姆齐——第六部分(监控)</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/kafka-on-kubernetes-using-strimzi-part-6-monitoring-709a43198bf5?source=collection_archive---------2-----------------------#2022-05-29">https://blog.devgenius.io/kafka-on-kubernetes-using-strimzi-part-6-monitoring-709a43198bf5?source=collection_archive---------2-----------------------#2022-05-29</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="cca1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这是博客系列的最后一部分，<strong class="jm io">库伯内特上的卡夫卡:使用</strong> <a class="ae ki" href="https://strimzi.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="jm io"> Strimzi </strong> </a> <strong class="jm io">。</strong>在<a class="ae ki" href="https://medium.com/@singh.amarendra/kafka-on-kubernetes-using-strimzi-part-5-security-fc878178cd04" rel="noopener">上一部分</a>中，我们已经讨论了 Strimzi 中的各种安全方面，以保护 Kubernetes 上的 Kafka 集群。在这一部分，我们将讨论群集可靠性的非常重要的部分，即监控。很多时候，人们只是忽略了为他们的 Kafka 集群设置监控，如果集群中出现任何问题，这将成为一场噩梦。</p><p id="88f0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">嗯，我想没有人希望在你不知道的情况下，你的 Kafka 集群在生产环境中不能正常工作。但是好处是你不需要在夜里醒来:P</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi kj"><img src="../Images/f50b1015379a7cb52899371689958ba2.png" data-original-src="https://miro.medium.com/v2/resize:fit:700/format:webp/1*Nm5Ri9AkyEn9VXGTclFvJw.png"/></div></figure><p id="8143" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">Kafka 是一个 Java 应用程序，它使用<a class="ae ki" href="https://www.oracle.com/technical-resources/articles/javase/jmx.html" rel="noopener ugc nofollow" target="_blank"> JMX </a> (Java 管理扩展)公开其指标，因此几乎所有 Kafka 监控工具都与 JMX 指标集成，并获得所有 Kafka 相关指标。这是 Kubernetes 上的一些卡夫卡监测工具</p><ol class=""><li id="ffed" class="kr ks in jm b jn jo jr js jv kt jz ku kd kv kh kw kx ky kz bi translated">普罗米修斯+格拉法纳</li><li id="f9d7" class="kr ks in jm b jn la jr lb jv lc jz ld kd le kh kw kx ky kz bi translated"><a class="ae ki" href="https://docs.newrelic.com/docs/infrastructure/host-integrations/host-integrations-list/kafka/kafka-integration/" rel="noopener ugc nofollow" target="_blank">新遗迹</a></li><li id="2281" class="kr ks in jm b jn la jr lb jv lc jz ld kd le kh kw kx ky kz bi translated"><a class="ae ki" href="https://www.datadoghq.com/blog/monitor-kafka-with-datadog/" rel="noopener ugc nofollow" target="_blank">数据狗</a>等。</li></ol><p id="9893" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">有三个主要部分来监控您的集群-</p><ul class=""><li id="bc11" class="kr ks in jm b jn jo jr js jv kt jz ku kd kv kh lf kx ky kz bi translated">收集和存储指标</li><li id="8678" class="kr ks in jm b jn la jr lb jv lc jz ld kd le kh lf kx ky kz bi translated">查询并在有意义的仪表板上显示它们</li><li id="28d7" class="kr ks in jm b jn la jr lb jv lc jz ld kd le kh lf kx ky kz bi translated">在任何违反条件的情况下发出警报</li></ul><p id="13ea" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">由于 Prometheus 已成为监控 Kubernetes 本机应用程序的标准，Strimzi 支持它开箱即用，并提供许多 Grafana 仪表板，便于为您的 Kafka 集群设置 Prometheus+Grafan+Alert Manager。</p><p id="1f2e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">用于抓取和存储</strong> — <a class="ae ki" href="https://prometheus.io/" rel="noopener ugc nofollow" target="_blank"> Prometheus </a>是一款开源监控解决方案，已经成为云原生世界中事实上的指标和警报标准。Prometheus 最棒的一点是，它从 Kafka 集群中抓取指标，并将其存储在时序数据库中，这与应用程序需要推送这些指标的其他监控工具不同。</p><p id="b012" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">用于查询和仪表板</strong> —一旦指标在 Prometheus DB 中可用，您就可以使用 PromQL 对其进行查询。许多工具支持 PromQL，如 Grafana、New Relic 等。</p><p id="2985" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">为了发出警报</strong> — Prometheus 将根据它正在搜集的指标评估规则，当任何规则匹配时，它将把它发送给<a class="ae ki" href="https://prometheus.io/docs/alerting/alertmanager/" rel="noopener ugc nofollow" target="_blank">警报管理器</a>。然后，AlertManager 将负责管理这些警报。您可以设置通知渠道，以防任何警报，如电子邮件，懈怠，传呼机责任等。</p><p id="593c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">Strimzi 使用两个开源项目从 Kafka 集群中获取所有指标，并将其发送给 Prometheus。</p><ul class=""><li id="5048" class="kr ks in jm b jn jo jr js jv kt jz ku kd kv kh lf kx ky kz bi translated"><a class="ae ki" href="https://github.com/prometheus/jmx_exporter" rel="noopener ugc nofollow" target="_blank">普罗米修斯 JMX 出口器</a>——阿帕奇卡夫卡默认不支持普罗米修斯度量。如上所述，它公开了 JMX 度量。普罗米修斯 JMX 出口项目采用 JMX 指标，并将其作为普罗米修斯端点。</li><li id="5ab9" class="kr ks in jm b jn la jr lb jv lc jz ld kd le kh lf kx ky kz bi translated">Kafka Exporter——Kafka 代理提供了许多与代理状态、使用和性能相关的有用指标。但是缺少一些重要的指标。例如，它不提供任何关于消费者滞后的指标或关于主题的信息。Kafka Exporter 作为客户端连接到 Kafka，收集关于主题、分区和消费群体的不同信息。然后，它将此信息公开为普罗米修斯度量端点。</li></ul><p id="5bc0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">所以我们要用普罗米修斯来监控以下事情-</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi lg"><img src="../Images/91bf0a57eb4b466d6a678cab7a3f2316.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TpugnaqxW-n_SI1YDAs-rw.png"/></div></div></figure><p id="88f4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们可以看到，除了监控 Kafka 指标、Strimzi 特定组件之外，我们还有 Strimzi Canary。</p><p id="db73" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> Strimzi Canary </strong> - Strimzi 团队创建了一个项目<a class="ae ki" href="https://github.com/strimzi/strimzi-canary" rel="noopener ugc nofollow" target="_blank"> Strimzi-Canary </a>来确定 Kafka 集群是否正常工作。这是通过创建一个 canary 主题来实现的，该主题的分区数量等于集群中代理的数量，并创建一个生产者和消费者来生产和消费来自 Canary 主题的数据。</p><p id="3240" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们可以通过在我们的 Kafka 资源中添加以下块并在<a class="ae ki" href="https://github.com/AmarendraSingh88/kafka-on-kubernetes/blob/main/kafka-demo/demo3-monitoring/kafka-metrics-config.yaml" rel="noopener ugc nofollow" target="_blank">Kafka-metrics-config . YAML</a>中添加规则来轻松启用 JMX 普罗米修斯导出器</p><pre class="kk kl km kn gt ll lm ln lo aw lp bi"><span id="e8af" class="lq lr in lm b gy ls lt l lu lv">spec:<br/>  kafka:<br/>    metricsConfig:<br/>      type: jmxPrometheusExporter<br/>      valueFrom:<br/>        configMapKeyRef:<br/>          name: kafka-metrics<br/>          key: kafka-metrics-config.yaml</span></pre><p id="0cb0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">要启用 Kafka Exporter，我们只需在 Kafka 定义中添加以下代码行-</p><pre class="kk kl km kn gt ll lm ln lo aw lp bi"><span id="1fa0" class="lq lr in lm b gy ls lt l lu lv">spec:<br/>  kafkaExporter:<br/>    topicRegex: ".*"<br/>    groupRegex: ".*"</span></pre><p id="5ca2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在让我们讨论如何在我们的设置中轻松地配置 Prometheus。这些步骤中使用的资源可以在<a class="ae ki" href="https://github.com/AmarendraSingh88/kafka-on-kubernetes/tree/main/kafka-demo/demo3-monitoring" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="8603" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">1-创建监控命名空间:</p><pre class="kk kl km kn gt ll lm ln lo aw lp bi"><span id="5961" class="lq lr in lm b gy ls lt l lu lv">kubectl create namespace monitoring</span></pre><p id="2f5e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">2-部署普罗米修斯操作员:</p><pre class="kk kl km kn gt ll lm ln lo aw lp bi"><span id="f0bb" class="lq lr in lm b gy ls lt l lu lv">kubectl apply -f prometheus-operator-deployment.yaml -n monitoring --force-conflicts=true --server-side</span></pre><p id="45d3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">3-为 jmx 度量创建配置映射:</p><pre class="kk kl km kn gt ll lm ln lo aw lp bi"><span id="d79f" class="lq lr in lm b gy ls lt l lu lv">kubectl apply -f kafka-metrics-config.yaml -n monitoring<br/>kubectl apply -f zookeeper-metrics.yaml -n monitoring</span></pre><p id="535a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">4-用 jmxPrometheusExporter 更新 Kafka 资源，以抓取 jmx 指标和 kafkaExporter，用于导出主题和消费者滞后指标</p><pre class="kk kl km kn gt ll lm ln lo aw lp bi"><span id="4de1" class="lq lr in lm b gy ls lt l lu lv">kubectl apply -f kafka.yaml -n kafka</span></pre><p id="ccc7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">部署普罗米修斯-</p><pre class="kk kl km kn gt ll lm ln lo aw lp bi"><span id="e3ed" class="lq lr in lm b gy ls lt l lu lv">kubectl apply -f prometheus.yaml -n monitoring</span></pre><p id="4cbc" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">6-部署吊舱监视器-</p><pre class="kk kl km kn gt ll lm ln lo aw lp bi"><span id="69d8" class="lq lr in lm b gy ls lt l lu lv">kubectl apply -f strimzi-pod-monitor.yaml -n monitoring</span></pre><p id="49e1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">7-部署 Grafana -</p><pre class="kk kl km kn gt ll lm ln lo aw lp bi"><span id="7cb7" class="lq lr in lm b gy ls lt l lu lv">kubectl apply -f grafana.yaml -n monitoring</span></pre><p id="4cf1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">普罗米修斯和格拉夫纳的 8 号左舷前锋-</p><pre class="kk kl km kn gt ll lm ln lo aw lp bi"><span id="c34b" class="lq lr in lm b gy ls lt l lu lv">kubectl port-forward svc/grafana 3000:3000 -n monitoring<br/>kubectl port-forward svc/prometheus-operated 9090:9090 -n monitoring</span></pre><p id="898a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">9-在 Grafana 中添加 Prometheus 数据源，并从<a class="ae ki" href="https://github.com/strimzi/strimzi-kafka-operator/tree/0.28.0/examples/metrics/grafana-dashboards" rel="noopener ugc nofollow" target="_blank"> Strimzi 为 Kafka、Zookeeper、Kafka Connect、MirrorMaker 等提供的仪表板</a>中上传 Grafana 仪表板。</p><p id="3459" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这是 Kafka overview 的 Grafana 仪表板示例-</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi lw"><img src="../Images/b0f79dee18ebb08649a0503b7c05241e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ubM2Fi-vlQf3rr-w5SJJJA.png"/></div></div><figcaption class="lx ly gj gh gi lz ma bd b be z dk translated"><a class="ae ki" href="https://grafana.com/blog/2021/07/26/get-comprehensive-monitoring-for-your-apache-kafka-ecosystem-instances-quickly-with-grafana-cloud/" rel="noopener ugc nofollow" target="_blank">来源</a></figcaption></figure><ul class=""><li id="eb96" class="kr ks in jm b jn jo jr js jv kt jz ku kd kv kh lf kx ky kz bi translated"><a class="ae ki" href="https://prometheus.io/docs/alerting/alertmanager/" rel="noopener ugc nofollow" target="_blank"> Prometheus Alertmanager </a>是一个插件，用于处理警报并将它们路由到通知服务。Alertmanager 支持监视的一个重要方面，即根据警报规则通知指示潜在问题的条件。</li></ul><p id="fb2d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">Strimzi 为 Prometheus Alertmanager 提供了<a class="ae ki" href="https://strimzi.io/docs/operators/0.21.1/full/deploying.html#ref-metrics-config-files-str" rel="noopener ugc nofollow" target="_blank">示例配置文件。</a></p><p id="e455" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">参见<a class="ae ki" href="https://strimzi.io/docs/operators/0.21.1/full/deploying.html#assembly-metrics-prometheus-alertmanager-str" rel="noopener ugc nofollow" target="_blank"> Strimzi 文档</a>设置警报管理器。</p><p id="a6fe" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">结论</strong>——这是系列<strong class="jm io">Kafka on Kubernetes:Using strim zi</strong>的第 6 部分也是最后一篇博客，在这里我们讨论了如何轻松地监控 Kafka 集群。在这个系列中，我们讨论了</p><ol class=""><li id="74a2" class="kr ks in jm b jn jo jr js jv kt jz ku kd kv kh kw kx ky kz bi translated"><a class="ae ki" href="https://medium.com/@singh.amarendra/kafka-on-kubernetes-using-strimzi-part-1-83d74564135e" rel="noopener">strim zi 在 Kubernetes 上设置和维护 Kafka 集群的基础知识</a></li><li id="99ae" class="kr ks in jm b jn la jr lb jv lc jz ld kd le kh kw kx ky kz bi translated"><a class="ae ki" href="https://medium.com/@singh.amarendra/kafka-on-kubernetes-using-strimzi-part-2-71a8ba8e9605" rel="noopener">如何使用 Strimzi 设置 Kafka 集群</a></li><li id="d6a9" class="kr ks in jm b jn la jr lb jv lc jz ld kd le kh kw kx ky kz bi translated"><a class="ae ki" href="https://medium.com/@singh.amarendra/kafka-on-kubernetes-using-strimzi-part-3-configuration-options-f8aa027e9ba0" rel="noopener">讨论生产就绪配置</a></li><li id="11c1" class="kr ks in jm b jn la jr lb jv lc jz ld kd le kh kw kx ky kz bi translated"><a class="ae ki" href="https://medium.com/@singh.amarendra/kafka-on-kubernetes-using-strimzi-part-4-scalability-59da50575fec" rel="noopener">见过如何使用 Keda </a>轻松扩展 Kafka 客户端</li><li id="b782" class="kr ks in jm b jn la jr lb jv lc jz ld kd le kh kw kx ky kz bi translated"><a class="ae ki" href="https://medium.com/@singh.amarendra/kafka-on-kubernetes-using-strimzi-part-5-security-fc878178cd04" rel="noopener">如何保护 Kafka 集群</a></li><li id="d5c4" class="kr ks in jm b jn la jr lb jv lc jz ld kd le kh kw kx ky kz bi translated">讨论了如何使用 Prometheus+Grafana+Alert Manager 轻松监控 Kafka 集群(这一部分)</li></ol><p id="fa50" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">因此，我们在 Kubernetes 上设置了<strong class="jm io">生产就绪的 Kafka 集群，它是可扩展的、安全的，并且具有监控和警报设置。</strong></p></div></div>    
</body>
</html>