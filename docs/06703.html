<html>
<head>
<title>Create Azure Automation Account (using managed identity) and Runbooks using Azure PowerShell and deploy via Azure DevOps Pipeline.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Azure PowerShell 创建 Azure Automation 帐户(使用托管身份)和 Runbooks，并通过 Azure DevOps 管道进行部署。</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/create-azure-automation-account-using-managed-identity-and-runbooks-using-azure-powershell-and-e43beafb6668?source=collection_archive---------10-----------------------#2022-01-26">https://blog.devgenius.io/create-azure-automation-account-using-managed-identity-and-runbooks-using-azure-powershell-and-e43beafb6668?source=collection_archive---------10-----------------------#2022-01-26</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/8ee676102840195fea5e532c4537c7bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kDv3j4fXbxcpcwjrtng6BA.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">Azure 自动化和操作手册</figcaption></figure><p id="8e8f" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">Azure Automation 是最受欢迎的自动化工具之一，专为解决流程自动化、配置管理和更新管理方面的日常运营挑战而设计。</p><p id="7fa6" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">Azure Automation 的一些有用场景是:</p><ul class=""><li id="fae2" class="kx ky in kb b kc kd kg kh kk kz ko la ks lb kw lc ld le lf bi translated">如果你想自动化在 Azure 上创建虚拟机的过程。</li><li id="5e87" class="kx ky in kb b kc lg kg lh kk li ko lj ks lk kw lc ld le lf bi translated">或者更新/修补虚拟机</li><li id="434f" class="kx ky in kb b kc lg kg lh kk li ko lj ks lk kw lc ld le lf bi translated">在一天结束时取消虚拟机的分配</li><li id="f0c2" class="kx ky in kb b kc lg kg lh kk li ko lj ks lk kw lc ld le lf bi translated">将各种 Azure 服务向下和向上扩展到不同的 SKU，以帮助您降低运营成本和节省时间。</li></ul><p id="92cf" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">这个清单还不止这些..</p><p id="3918" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">在这篇文章中，我将主要讨论流程自动化，这是一种使用 PowerShell 或 python 脚本自动化 azure 管理或编排流程的方法。创建的运行手册是用于编写逻辑的 PowerShell 或 python 脚本。微软文档中描述了几种类型的操作手册<a class="ae ll" href="https://docs.microsoft.com/en-us/azure/automation/automation-runbook-types" rel="noopener ugc nofollow" target="_blank"> Azure Automation 操作手册类型|微软文档</a></p><p id="559a" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">我将重点介绍如何使用<strong class="kb io">托管身份</strong>创建自动化帐户，以及如何以编程方式创建和运行<strong class="kb io">Azure Automation PowerShell run books</strong>。</p><p id="5bb7" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">PowerShell runbooks 基于 Windows PowerShell。您可以使用 Azure 门户中的文本编辑器直接编辑 runbook 的代码。您也可以使用任何离线文本编辑器，并将 runbook 导入 Azure Automation。</p><h1 id="3410" class="lm ln in bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">使用运行方式帐户与托管身份的 Azure 自动化帐户</h1><p id="4e0b" class="pw-post-body-paragraph jz ka in kb b kc mk ke kf kg ml ki kj kk mm km kn ko mn kq kr ks mo ku kv kw ig bi translated">无论何时创建运行方式帐户，都会在 Azure Ad 中的应用程序注册下注册一个新的应用程序，并将生成自签名证书，有效期为一年。</p><p id="37b4" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">因此，每年在证书到期前更新证书会产生开销，以防止自动化帐户停止工作。</p><p id="a0a8" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">运行方式帐户</strong>需要的一些权限是，</p><ol class=""><li id="0133" class="kx ky in kb b kc kd kg kh kk kz ko la ks lb kw mp ld le lf bi translated">订阅级别的用户访问管理员(创建运行方式帐户和续订证书时需要)</li><li id="b901" class="kx ky in kb b kc lg kg lh kk li ko lj ks lk kw mp ld le lf bi translated">在 Azure AD，应用程序管理员(用于创建服务主体)</li><li id="529b" class="kx ky in kb b kc lg kg lh kk li ko lj ks lk kw mp ld le lf bi translated">贡献者对自动化帐户的访问</li></ol><p id="94b0" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">现在，微软能够将自动化帐户配置为使用<strong class="kb io">托管身份</strong>，这是创建帐户时的默认选项。有了 is 功能，自动化帐户可以像它自己一样向 Azure 进行身份验证，而不需要交换任何凭据。并且这消除了更新证书或管理服务主体的开销。</p><p id="0e38" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">托管身份</strong>可以由系统分配，也可以由用户分配。现在，默认情况下，每当创建新的自动化帐户时，系统分配的受管身份都会启用。</p><figure class="mr ms mt mu gt jo gh gi paragraph-image"><div class="gh gi mq"><img src="../Images/e271971cc214c15672bbca5baaa7f3c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/0*vxn96VCeqa0THofx.png"/></div></figure><h1 id="cef2" class="lm ln in bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">以编程方式创建自动化帐户并导入运行手册</h1><p id="9ca3" class="pw-post-body-paragraph jz ka in kb b kc mk ke kf kg ml ki kj kk mm km kn ko mn kq kr ks mo ku kv kw ig bi translated">本节使用 Azure PowerShell 脚本创建以下内容:</p><ol class=""><li id="d3e8" class="kx ky in kb b kc kd kg kh kk kz ko la ks lb kw mp ld le lf bi translated">使用系统分配的托管身份创建自动化帐户</li><li id="5901" class="kx ky in kb b kc lg kg lh kk li ko lj ks lk kw mp ld le lf bi translated">创建角色分配以授予自动化帐户权限</li><li id="11a8" class="kx ky in kb b kc lg kg lh kk li ko lj ks lk kw mp ld le lf bi translated">创建自动化计划(一次/重复)</li><li id="0db0" class="kx ky in kb b kc lg kg lh kk li ko lj ks lk kw mp ld le lf bi translated">创建和导入操作手册</li><li id="5b72" class="kx ky in kb b kc lg kg lh kk li ko lj ks lk kw mp ld le lf bi translated">计划运行手册</li></ol><h1 id="35cf" class="lm ln in bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">GitHub 知识库</h1><p id="a32b" class="pw-post-body-paragraph jz ka in kb b kc mk ke kf kg ml ki kj kk mm km kn ko mn kq kr ks mo ku kv kw ig bi translated">您可以从我的 GitHub repo 访问所有代码和脚本:</p><p id="ca21" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><a class="ae ll" href="https://github.com/Pujago/AzureRunbooks" rel="noopener ugc nofollow" target="_blank">https://github.com/Pujago/AzureRunbooks</a></p><h1 id="1d67" class="lm ln in bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">使用系统分配的托管身份创建自动化帐户</h1><p id="5b18" class="pw-post-body-paragraph jz ka in kb b kc mk ke kf kg ml ki kj kk mm km kn ko mn kq kr ks mo ku kv kw ig bi translated">这可以简单地用一行代码完成:</p><blockquote class="mv mw mx"><p id="4943" class="jz ka my kb b kc kd ke kf kg kh ki kj mz kl km kn na kp kq kr nb kt ku kv kw ig bi translated"><strong class="kb io">New-AzAutomationAccount-Name＄automation account Name-Location＄Location-resource group Name＄resource group Name-AssignSystemIdentity</strong></p></blockquote><p id="5344" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">完整的脚本位于我的 GitHub 存储库中:</p><p id="5a26" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">完整的脚本位于我的 GitHub 存储库中:</p><p id="5ff1" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">【https://github.com/Pujago/AzureRunbooks/tree/main/templates T4】</p><p id="993b" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">脚本名:createAutomationAccount.ps1 </strong></p><p id="09af" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">以上脚本将创建启用了系统分配的受管身份的自动化帐户:</p><figure class="mr ms mt mu gt jo gh gi paragraph-image"><div class="gh gi mq"><img src="../Images/1d4da3d7e9b97473f9b680a4cbd809ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/0*NQaVFL0w805oD3l5.png"/></div></figure><h1 id="6eb0" class="lm ln in bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">创建角色分配以授予自动化帐户权限</h1><p id="e7f0" class="pw-post-body-paragraph jz ka in kb b kc mk ke kf kg ml ki kj kk mm km kn ko mn kq kr ks mo ku kv kw ig bi translated">在使用系统分配的托管身份进行身份验证之前，您需要在目标 Azure 资源上为该身份分配适当的角色。例如，为了启动或停止 Azure VM，托管身份应该被分配启动或停止 VM 的适当权限。</p><p id="cbf4" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">在前面的屏幕截图中，如果您单击“Azure 角色分配”，您将看到没有找到角色分配，如下图所示:</p><figure class="mr ms mt mu gt jo gh gi paragraph-image"><div class="gh gi mq"><img src="../Images/b0f3a10b3c8f4acfff8c758ff7c2b0cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/0*_MEBG0Uezgz3KdDM.png"/></div></figure><p id="f980" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">为了创建角色分配，我使用了下面的命令:</p><blockquote class="mv mw mx"><p id="f94c" class="jz ka my kb b kc kd ke kf kg kh ki kj mz kl km kn na kp kq kr nb kt ku kv kw ig bi translated"><strong class="kb io">New-azrole assignment-ObjectId $ automation object-role definition name $ role definition-Scope $ Scope</strong></p></blockquote><p id="e6e4" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">其中，可以使用下面的命令获得 objectId:</p><blockquote class="mv mw mx"><p id="511e" class="jz ka my kb b kc kd ke kf kg kh ki kj mz kl km kn na kp kq kr nb kt ku kv kw ig bi translated"><strong class="kb io">$ automation object =(Get-AzAutomationAccount-Name $ automation account Name-resource group Name $ resource group Name). identity . principal id</strong></p></blockquote><p id="06e4" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">例如，要授予参与者对资源组的访问权限，您可以使用:</p><blockquote class="mv mw mx"><p id="12bd" class="jz ka my kb b kc kd ke kf kg kh ki kj mz kl km kn na kp kq kr nb kt ku kv kw ig bi translated"><strong class="kb io">New-azrole assignment-ObjectId $ automation object-role definition name " Contributor "-Scope/subscriptions/&lt;subscription id&gt;/resource groups/&lt;您的资源组名称&gt; </strong></p></blockquote><p id="8496" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">注意:在实际场景中，遵循最低特权原则，谨慎分配仅执行您的操作手册所需的权限。</strong></p><p id="0651" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">完整的脚本位于我的 GitHub 存储库中:</p><p id="80e5" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><a class="ae ll" href="https://github.com/Pujago/AzureRunbooks/tree/main/templates" rel="noopener ugc nofollow" target="_blank">https://github.com/Pujago/AzureRunbooks/tree/main/templates</a></p><p id="2356" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">脚本名称:createRoleAssignment.ps1 </strong></p><p id="a2c6" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">一旦分配了角色，您将在 Azure 门户中看到该角色:</p><figure class="mr ms mt mu gt jo gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/82a8e2fcf262bc07fbf4313dc2f53f4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1274/format:webp/0*8Bg-IoWWVyy8MKDj.png"/></div></figure><h1 id="16ab" class="lm ln in bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">创建和导入操作手册</h1><p id="5769" class="pw-post-body-paragraph jz ka in kb b kc mk ke kf kg ml ki kj kk mm km kn ko mn kq kr ks mo ku kv kw ig bi translated">现在，为了创建操作手册，PowerShell 脚本中使用了 3 个命令:</p><p id="2e87" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">New-AzAutomationRunbook  —这将创建一个空的 Runbook。</p><p id="d8c6" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">Import-AzAutomationRunbook</strong>—这将导入包含 PowerShell 脚本命令的 Runbook</p><p id="965a" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">发布-AzAutomationRunbook </strong> —这将发布 Runbook</p><p id="4c62" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">下面的代码片段用于<strong class="kb io">从特定位置导入所有的操作手册:</strong></p><figure class="mr ms mt mu gt jo gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/1b6d30d22332eab15359fcc52c87dc80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1276/format:webp/0*G2FUKbBiCv768I0_.png"/></div></figure><p id="1f89" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">runbook 的名称将与 PowerShell 脚本的文件名相同。</p><p id="8c86" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">完整的脚本位于我的 GitHub 存储库中:</p><p id="5e7d" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><a class="ae ll" href="https://github.com/Pujago/AzureRunbooks/tree/main/templates" rel="noopener ugc nofollow" target="_blank">https://github.com/Pujago/AzureRunbooks/tree/main/templates</a></p><p id="4152" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">脚本名:createandimportrunbooks . PS1</strong></p><p id="43f7" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">在我的 GitHub 存储库示例中，我在 GitHub 存储库的位置<strong class="kb io"> runbooks/rgs </strong>创建了 2 个 PowerShell 脚本文件。<strong class="kb io">createandimportrunbooks . PS1</strong>将这些 PowerShell 脚本(GetAllResourceGroups.ps1 和 GetAResourceGroup.ps1)作为 Runbooks 从 runbooks/rgs 位置导入。runbooks 的名称将是— GetAllResourceGroups 和 GetAResourceGroup</p><p id="5ccc" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">在执行脚本时，可以在门户中查看操作手册，如下所示:</p><figure class="mr ms mt mu gt jo gh gi paragraph-image"><div class="gh gi mq"><img src="../Images/8e00f64236185cc828c71687943e3c5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/0*oaTgdtPTsycKh20-.png"/></div></figure><h1 id="3416" class="lm ln in bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">创建自动化计划(一次/重复)</h1><p id="d21e" class="pw-post-body-paragraph jz ka in kb b kc mk ke kf kg ml ki kj kk mm km kn ko mn kq kr ks mo ku kv kw ig bi translated">现在，自动化帐户已创建，并具有受管身份的适当权限。此外，还会创建、导入和发布运行手册。</p><p id="1ff5" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">接下来，让我们创建一个自动化计划，该计划将由在上一步中创建的运行手册使用。</p><p id="cc76" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">计划可以是“重复”或“一次”。</p><p id="2d4e" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">下面的代码片段创建了“重复”计划:</p><p id="6cde" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">这将创建一个从周一到周五每天晚上运行的计划。</p><figure class="mr ms mt mu gt jo gh gi paragraph-image"><div class="gh gi mq"><img src="../Images/0384793ffb44aecc6744e0d6a78807d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/0*YWPx6w5SjApJxpZH.png"/></div></figure><p id="9ad1" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">对于非重复计划，命令中仅提供小时间隔:</p><blockquote class="mv mw mx"><p id="760e" class="jz ka my kb b kc kd ke kf kg kh ki kj mz kl km kn na kp kq kr nb kt ku kv kw ig bi translated"><strong class="kb io">New-AzAutomationSchedule-automation account Name $ automation account Name-Name $ schedule Name-start time $ start time-hour interval 1-resource group Name $ resource group Name-time zone $ time zone</strong></p></blockquote><p id="eea6" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">完整的脚本位于我的 GitHub 存储库中:</p><p id="004f" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><a class="ae ll" href="https://github.com/Pujago/AzureRunbooks/tree/main/templates" rel="noopener ugc nofollow" target="_blank">https://github.com/Pujago/AzureRunbooks/tree/main/templates</a></p><p id="f2e8" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">名称:createSchedule.ps1 </strong></p><p id="ec3a" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">成功执行脚本后，将按如下方式创建重复计划:</p><figure class="mr ms mt mu gt jo gh gi paragraph-image"><div class="gh gi mq"><img src="../Images/8cdeece73ea2ad7b12c959d58de5b233.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/0*pQoobIA1magY3yD9.png"/></div></figure><h1 id="d103" class="lm ln in bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">将运行手册添加到计划中</h1><p id="2683" class="pw-post-body-paragraph jz ka in kb b kc mk ke kf kg ml ki kj kk mm km kn ko mn kq kr ks mo ku kv kw ig bi translated">最后一步是向时间表中添加一本操作手册。下面的脚本代码片段调用<strong class="kb io">Register-AzAutomationScheduledRunbook</strong>命令将 Runbook 添加到时间表中。</p><p id="6668" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">要将多个 runbooks 添加到计划中，请调用带有<strong class="kb io"> -RunbooksName </strong>参数的脚本，其名称用逗号分隔，如下所示:</p><p id="4586" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">-run books name " GetAllResourcegroups，getresourcegroup "</strong></p><figure class="mr ms mt mu gt jo gh gi paragraph-image"><div class="gh gi mq"><img src="../Images/c899867c1cf4de9edc9601341e708e4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/0*SO0gfpbCZc4MHtsU.png"/></div></figure><p id="cc42" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">完整的脚本位于我的 GitHub 存储库中:</p><p id="2474" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">【https://github.com/Pujago/AzureRunbooks/tree/main/templates T4】</p><p id="d643" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">脚本名:registerrunbookstoaschedule . PS1</strong></p><p id="a0a3" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">成功执行上述脚本会将运行手册添加到计划中，并可在门户网站中查看，如下所示:</p><figure class="mr ms mt mu gt jo gh gi paragraph-image"><div class="gh gi mq"><img src="../Images/e030df5c595e8a5c7eaa828582cdc523.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/0*ZEKj6A_z_lS3aRZW.png"/></div></figure><h1 id="2a97" class="lm ln in bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">使用 Azure DevOps 管道运行脚本</h1><p id="ec15" class="pw-post-body-paragraph jz ka in kb b kc mk ke kf kg ml ki kj kk mm km kn ko mn kq kr ks mo ku kv kw ig bi translated">虽然这些脚本可以从您的本地机器上执行，但我更喜欢通过管道自动运行脚本。</p><p id="8358" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">对于这一部分，我不得不假设，你对 Azure DevOps 管道很熟悉并且很有经验。</p><p id="e6ef" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">要创建管道:</p><ol class=""><li id="db34" class="kx ky in kb b kc kd kg kh kk kz ko la ks lb kw mp ld le lf bi translated">在 Azure DevOps 中创建存储库(或者您可以使用自己的 Git-Hub 存储库)</li><li id="baa8" class="kx ky in kb b kc lg kg lh kk li ko lj ks lk kw mp ld le lf bi translated">在 Azure DevOps 中创建服务连接</li><li id="a98e" class="kx ky in kb b kc lg kg lh kk li ko lj ks lk kw mp ld le lf bi translated">使用存储库创建 YAML 管道</li></ol><p id="bef2" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">我添加了一个 YAML 管道文件，用于在 GitHub 存储库中调用这些脚本:</p><p id="0f04" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">文件名:CreateRunBooks.yml </strong></p><p id="eb87" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">可以改进管道，使其在可重用性方面更加通用，我在这个演示中保持了简单。只需更新 variables.yml 文件中的服务连接和参数</p><p id="29c4" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">请随时在我的帖子上留下您的建议和评论:)</p></div><div class="ab cl ne nf hr ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ig ih ii ij ik"><p id="c6df" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><em class="my">原载于</em><a class="ae ll" href="https://www.leogether.com/2022/01/create-azure-automation-account-using.html" rel="noopener ugc nofollow" target="_blank"><em class="my">https://www.leogether.com</em></a><em class="my">。</em></p></div></div>    
</body>
</html>