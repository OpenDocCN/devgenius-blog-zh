<html>
<head>
<title>Apache ShardingSphere Enterprise User Case — Energy Monster</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Apache ShardingSphere 企业用户案例——能源怪兽</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/apache-shardingsphere-enterprise-user-case-energy-monster-5f7254c6b4c5?source=collection_archive---------9-----------------------#2022-09-06">https://blog.devgenius.io/apache-shardingsphere-enterprise-user-case-energy-monster-5f7254c6b4c5?source=collection_archive---------9-----------------------#2022-09-06</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="e51c" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated"><a class="ae kc" href="https://ir.enmonster.com/" rel="noopener ugc nofollow" target="_blank">能源怪兽</a>对<a class="ae kc" href="https://shardingsphere.apache.org/document/current/en/overview/#shardingsphere-jdbc" rel="noopener ugc nofollow" target="_blank">sharing sphere 的应用——JDBC</a></h2></div><p id="f026" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">能源怪兽是一家消费科技公司，其使命是为日常生活提供能源。该公司是亚洲最大的移动设备充电服务提供商。</p><p id="a7a1" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">随着公司业务并发量越来越大，产生的数据量(用户、订单、活动等。)与日俱增。传统的关系数据库已被证明不足以在单个数据库或表中支持数百万或数千万的数据量。</p><p id="c6b0" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">业绩已经无法满足业务发展的基准要求。在这种情况下，数据分片是解决问题的有效方法。</p><h2 id="68be" class="kz la in bd lb lc ld dn le lf lg dp lh km li lj lk kq ll lm ln ku lo lp lq lr bi translated">技术选择</h2><p id="07e3" class="pw-post-body-paragraph kd ke in kf b kg ls jo ki kj lt jr kl km lu ko kp kq lv ks kt ku lw kw kx ky ig bi translated">在<a class="ae kc" href="https://shardingsphere.apache.org/" rel="noopener ugc nofollow" target="_blank">数据库加</a>概念下，ShardingSphere 旨在异构数据库之上构建一个生态系统。目标是在最大化原始数据库计算能力的同时，提供全局可扩展和增强的计算能力。</p><p id="e1a3" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">应用程序和数据库之间的交互变得面向 Database Plus 标准，因此最小化了数据库碎片对上层服务的影响。</p><p id="5357" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">在 ShardingSphere 生态系统中，<a class="ae kc" href="https://shardingsphere.apache.org/document/current/en/overview/#shardingsphere-jdbc" rel="noopener ugc nofollow" target="_blank"> ShardingSphere-JDBC </a>被定位为一个轻量级 Java 框架，在 Java 的 JDBC 层提供额外的服务。</p><p id="ad88" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">它使用客户端直接连接数据库，以<code class="fe lx ly lz ma b">jar</code>包的形式提供服务，不需要额外的部署和依赖。可以理解为 JDBC 驱动的增强版，完全兼容 JDBC 和各种 ORM 框架。</p><p id="ba07" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">JDBC 通过协调数据分片下的数据读写，使开发人员能够只关注数据层之外的工作，而不是使用业务代码来手动选择数据库和表。</p><h2 id="6f21" class="kz la in bd lb lc ld dn le lf lg dp lh km li lj lk kq ll lm ln ku lo lp lq lr bi translated">商业案例</h2><p id="95ef" class="pw-post-body-paragraph kd ke in kf b kg ls jo ki kj lt jr kl km lu ko kp kq lv ks kt ku lw kw kx ky ig bi translated">UCS 是 Energy Monster 以用户为中心的服务，为服务器端的用户提供基本功能。2018 年从<a class="ae kc" href="https://www.php.net/" rel="noopener ugc nofollow" target="_blank"> PHP </a>服务器剥离，移至 Java 技术栈，实现微服务化。</p><p id="e612" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">它涉及新数据库和表格的设计以及数据清理和迁移。预计整个切换过程将确保以下功能:</p><ul class=""><li id="e4ce" class="mb mc in kf b kg kh kj kk km md kq me ku mf ky mg mh mi mj bi translated">稳定性:短时间内平稳释放，不停顿。</li></ul><p id="00a8" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">准确性:确保精确清理数千万个数据卷。</p><p id="9b55" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">可扩展性:解决数据量增加带来的性能问题，保证可扩展性。</p><blockquote class="mk ml mm"><p id="9dd9" class="kd ke mn kf b kg kh jo ki kj kk jr kl mo kn ko kp mp kr ks kt mq kv kw kx ky ig bi translated"><strong class="kf io"> <em class="in">数据清理和迁移解决方案</em> </strong></p></blockquote><ul class=""><li id="26bb" class="mb mc in kf b kg kh kj kk km md kq me ku mf ky mg mh mi mj bi translated">初始数据同步。</li><li id="68e0" class="mb mc in kf b kg mr kj ms km mt kq mu ku mv ky mg mh mi mj bi translated">应用程序的服务器切断入口(用户)。</li><li id="a5e1" class="mb mc in kf b kg mr kj ms km mt kq mu ku mv ky mg mh mi mj bi translated">数据同步(自上一时间点以来的更新和新用户)。</li><li id="16d6" class="mb mc in kf b kg mr kj ms km mt kq mu ku mv ky mg mh mi mj bi translated">数据清理。</li><li id="8a1c" class="mb mc in kf b kg mr kj ms km mt kq mu ku mv ky mg mh mi mj bi translated">用户中心发布。</li></ul><figure class="mx my mz na gt nb gh gi paragraph-image"><div class="gh gi mw"><img src="../Images/01417c321976139022d9a62db48c9a1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1034/format:webp/1*H7YjY4AlVbcSJdJGtogzpQ.png"/></div></figure><blockquote class="mk ml mm"><p id="6bef" class="kd ke mn kf b kg kh jo ki kj kk jr kl mo kn ko kp mp kr ks kt mq kv kw kx ky ig bi translated"><strong class="kf io"> <em class="in">数据分片策略</em> </strong></p></blockquote><p id="5f45" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">数据库采用数据库分片设计，分为 16 个数据库。默认分片键是<code class="fe lx ly lz ma b">user_id</code>，默认分片策略<code class="fe lx ly lz ma b">user_id</code>是 mod 16，比如用户表的<code class="fe lx ly lz ma b">${user_id % 16}</code>。对于不携带分片密钥的 SQL，使用广播路由。</p><figure class="mx my mz na gt nb gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/5944691a97e371158e1884e5681ed343.png" data-original-src="https://miro.medium.com/v2/resize:fit:1202/format:webp/1*ASkoEM3Wpp3V4LdcDdU3rw.png"/></div></figure><p id="4cf3" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated"><code class="fe lx ly lz ma b">user_id</code>作为分片键是因为<code class="fe lx ly lz ma b">user_id</code>可以覆盖大部分业务场景，其他字段可能为空。在本地测试中，shard key 策略(openId，mobile)的查询耗时 50ms 到 200ms。</p><blockquote class="mk ml mm"><p id="920e" class="kd ke mn kf b kg kh jo ki kj kk jr kl mo kn ko kp mp kr ks kt mq kv kw kx ky ig bi translated"><strong class="kf io"> <em class="in">使用分片算法</em> </strong></p></blockquote><p id="f9da" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">目前有三种可用的分片算法。</p><ul class=""><li id="3f03" class="mb mc in kf b kg kh kj kk km md kq me ku mf ky mg mh mi mj bi translated">标准分片算法。对应<code class="fe lx ly lz ma b">StandardShardingAlgorithm</code>，用于使用单键作为分片键的场景，比如=，IN，BETWEEN AND，&gt;，&lt;，&gt; =，&lt; =。</li><li id="995b" class="mb mc in kf b kg mr kj ms km mt kq mu ku mv ky mg mh mi mj bi translated">复杂的分片算法。对应<code class="fe lx ly lz ma b">ComplexKeysShardingAlgorithm</code>，用于使用多键作为分片键的场景。多个碎片键的逻辑很复杂，需要开发人员自己处理。</li><li id="f55f" class="mb mc in kf b kg mr kj ms km mt kq mu ku mv ky mg mh mi mj bi translated">提示分片算法。它对应于<code class="fe lx ly lz ma b">HintShardingAlgorithm</code>，用于提示行用于分片的场景。</li></ul><figure class="mx my mz na gt nb gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/772cb12c7d4a763baa5ad33cfaf25c88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1118/0*l7uaVFkDI00w8_Om"/></div></figure><h2 id="afdc" class="kz la in bd lb lc ld dn le lf lg dp lh km li lj lk kq ll lm ln ku lo lp lq lr bi translated">升级 ShardingSphere-JDBC</h2><p id="4544" class="pw-post-body-paragraph kd ke in kf b kg ls jo ki kj lt jr kl km lu ko kp kq lv ks kt ku lw kw kx ky ig bi translated">ShardingSphere-JDBC 用于多个业务场景，如订单、库存和财务。到 2021 年，R&amp;D 团体或团队使用不同版本的 ShardingSphere-JDBC，从 1。x 到 4。x，后期很难做到统一维护。</p><p id="f3ee" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">此外，早期版本中还有一些潜在的错误和缺失的功能。基于统一管理和可用性的要求，我们实施了一个项目来统一公司使用的 ShardingSphere-JDBC 版本，并在 2021 年 4 月将其升级到 4.1.1 稳定版本。</p><p id="4103" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated"><strong class="kf io">升级过程中遇到以下问题:</strong></p><p id="b835" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated"><strong class="kf io"> 1。升级后需要很长时间才能启动服务。</strong></p><p id="6ded" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">ShardingSphere-JDBC 在服务启动时检查子表的元数据一致性。配置项<code class="fe lx ly lz ma b">max.connections.size.per.quer</code>(每个查询可以打开的最大连接数)默认为 1。对于大量的表，加载过程会很慢。你需要参考连接池配置来提高加载速度。</p><p id="22e9" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated"><strong class="kf io"> 2。子表查询中没有分片键时没有响应。</strong></p><figure class="mx my mz na gt nb gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/920b135470b3bf72fee2e61883137720.png" data-original-src="https://miro.medium.com/v2/resize:fit:1120/0*VC1caFtfqIFcjk6_"/></div></figure><p id="8964" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">逻辑 SQL 查询不指定分片键，它根据广播路由中路由器的整个数据库表查询所有的表。</p><p id="352c" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">配置项在数据库中有 108 个实际表。根据<code class="fe lx ly lz ma b">maxConnectionsizeperquery=50</code>的配置，ShardingSphere-JDBC 使用连接限制模式，将查询请求分为三组，并将结果与内存合并。因此，一个查询需要 36 个数据库连接。但是<a class="ae kc" href="https://druid.apache.org/" rel="noopener ugc nofollow" target="_blank">德鲁伊</a>线程池配置的<code class="fe lx ly lz ma b">maxActive</code>设置为 20，导致死锁。</p><figure class="mx my mz na gt nb gh gi paragraph-image"><div role="button" tabindex="0" class="ni nj di nk bf nl"><div class="gh gi nh"><img src="../Images/078c73b8031e81464cd4d01aa9bccbf7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*P1peUZYHvCqwAbbR"/></div></div></figure><figure class="mx my mz na gt nb gh gi paragraph-image"><div role="button" tabindex="0" class="ni nj di nk bf nl"><div class="gh gi nm"><img src="../Images/ca8b62d977c0d6b4d38e697505d364c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*JgDB21Lw5Zwl6BNZ"/></div></div></figure><figure class="mx my mz na gt nb gh gi paragraph-image"><div role="button" tabindex="0" class="ni nj di nk bf nl"><div class="gh gi nn"><img src="../Images/d72ba590a33648cd0ab5a7231627c18e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*d7DDJpNNUE3GvdUY"/></div></div></figure><figure class="mx my mz na gt nb gh gi paragraph-image"><div role="button" tabindex="0" class="ni nj di nk bf nl"><div class="gh gi no"><img src="../Images/46190f54a5433622369b2c331df4ceba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ybFSQ9iROCirVQek"/></div></div></figure><p id="c62b" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated"><strong class="kf io">解决方案:</strong></p><ul class=""><li id="bfa0" class="mb mc in kf b kg kh kj kk km md kq me ku mf ky mg mh mi mj bi translated">结合<code class="fe lx ly lz ma b">check.table.metadata.enabled=true</code>(启动时检查子表中元数据的一致性)并正确配置<code class="fe lx ly lz ma b">maxConnectionSizePerQuery</code>(每次查询可以打开的最大连接数)。</li><li id="b495" class="mb mc in kf b kg mr kj ms km mt kq mu ku mv ky mg mh mi mj bi translated"><code class="fe lx ly lz ma b">maxConnectionSizePerQuery</code>应该小于 druid 线程池配置的最大活动线程数。</li></ul><p id="444d" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated"><strong class="kf io"> 3。从 1 升级后。x，SQL 执行中显示错误消息“无法更新分片键”，实际的分片键值没有更新。</strong></p><p id="3780" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">为了避免因更改分片键值而导致的数据查询失败，在 4 中的<code class="fe lx ly lz ma b">SQL update</code>中增加了分片键检测。x 版本。可以通过以下方式纠正错误:</p><ul class=""><li id="7873" class="mb mc in kf b kg kh kj kk km md kq me ku mf ky mg mh mi mj bi translated">更新时删除碎片密钥。</li><li id="9e73" class="mb mc in kf b kg mr kj ms km mt kq mu ku mv ky mg mh mi mj bi translated">shard 键被同步添加到<code class="fe lx ly lz ma b">where</code>语句中。</li></ul><p id="c3b1" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated"><strong class="kf io"> 4。使用</strong> <code class="fe lx ly lz ma b"><strong class="kf io">druid-spring-boot-starter</strong></code> <strong class="kf io">时导致启动失败，与</strong> <code class="fe lx ly lz ma b"><strong class="kf io">Sharding-datasource</strong></code> <strong class="kf io">不兼容。</strong></p><p id="de8a" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">druid 数据连接池启动器将加载并创建一个默认数据源。这将在 ShardingSphere-JDBC 创建数据源时导致冲突。</p><p id="52e4" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated"><strong class="kf io"> 5。</strong> <code class="fe lx ly lz ma b"><strong class="kf io">inline strategy</strong></code> <strong class="kf io">报告范围查询错误。</strong></p><p id="9ed3" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated"><code class="fe lx ly lz ma b">inline strategy</code>默认不支持范围查询，建议使用<code class="fe lx ly lz ma b">standard strategy</code>。如果范围查询需要<code class="fe lx ly lz ma b">inline strategy</code>，添加以下配置。</p><p id="d4d1" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated"><code class="fe lx ly lz ma b">spring.shardingsphere.props.allow.range.query.with.inline.sharding: true</code></p><p id="9aca" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated"><strong class="kf io">注意:</strong>这里所有的<code class="fe lx ly lz ma b">inline strategy</code>范围查询都会查询广播中的各个子表。</p><p id="1234" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated"><strong class="kf io"> 6。报告了“无法从表中找到所有者”错误。</strong></p><p id="2954" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">SQL(简体):</p><p id="6c8e" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated"><code class="fe lx ly lz ma b">select id from</code>(从 x 中选择 id)按 a.id 分组</p><p id="def4" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">四号。x 版本支持有限的子查询。这个问题是由中间表的名称引起的。删除<code class="fe lx ly lz ma b">select</code>或<code class="fe lx ly lz ma b">group order</code>或其他字段的表别名。</p><blockquote class="mk ml mm"><p id="0c42" class="kd ke mn kf b kg kh jo ki kj kk jr kl mo kn ko kp mp kr ks kt mq kv kw kx ky ig bi translated"><a class="ae kc" href="https://github.com/apache/shardingsphere/issues/4810" rel="noopener ugc nofollow" target="_blank"><em class="in">https://github.com/apache/shardingsphere/issues/4810</em></a></p></blockquote><p id="6399" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">7。该表的主键与 <a class="ae kc" href="https://programming.vip/docs/overview-of-snowflake-algorithm.html" rel="noopener ugc nofollow" target="_blank"> <strong class="kf io">雪花</strong> </a> <strong class="kf io">算法生成的主键冲突。</strong></p><p id="2c9f" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">ShardingSphere 提供了配置分布式主键生成策略的灵活方式。在分片规则配置模块中，您可以为每个表配置主键生成策略。</p><p id="5ef7" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">默认情况下，<a class="ae kc" href="https://programming.vip/docs/overview-of-snowflake-algorithm.html" rel="noopener ugc nofollow" target="_blank">雪花</a>算法用于生成 64 位长整数数据。雪花发生器需要配置:</p><p id="dccb" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated"><code class="fe lx ly lz ma b">spring.shardingsphere.sharding.tables.x.key-generator.props.worker.id = ${dcc.node.id}</code></p><figure class="mx my mz na gt nb gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/00fa3ded9676cc0821381662601a4d8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1120/0*a6udX7HoJif6XUGf"/></div></figure><p id="f675" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">该公司使用<a class="ae kc" href="https://www.apolloconfig.com/#/" rel="noopener ugc nofollow" target="_blank"> apollo </a>配置中心来交付服务实例的节点 id。该服务使用多数据源。如果使用 YAML 文件加载分片配置，则<code class="fe lx ly lz ma b">workId</code>不能自动加载到分片配置项中。</p><p id="870b" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated"><strong class="kf io">解决方案:</strong></p><figure class="mx my mz na gt nb gh gi paragraph-image"><div class="gh gi np"><img src="../Images/07ea5e8b0eb9755b6d50c764cea1161e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1116/0*IZb8_tcAyle83_kG"/></div></figure><p id="e4a7" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">使用基于内置<code class="fe lx ly lz ma b">SnowflakeShardingKeyGenerator</code>的自定义发生器类型。</p><p id="0f01" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">如果主键用作分片键，根据数据分片值配置<code class="fe lx ly lz ma b">max.vibration.offset</code>以增加振动范围。</p><figure class="mx my mz na gt nb gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/0bcfe597b980773e70b04f79779b0218.png" data-original-src="https://miro.medium.com/v2/resize:fit:1340/format:webp/1*k9h57gxqKFF3udtkRRsD1g.png"/></div></figure><p id="5309" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated"><strong class="kf io"> 8。三号。x 版本在执行</strong> <code class="fe lx ly lz ma b"><strong class="kf io">CASE WHEN</strong></code> <strong class="kf io">语句时报错。</strong></p><p id="3341" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">首先是 3。x 和 4。x 版本不支持<code class="fe lx ly lz ma b">case when</code>语句。</p><p id="3dd4" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">三号。x 和 4。x 版本在解析<code class="fe lx ly lz ma b">case when</code>的<code class="fe lx ly lz ma b">update</code>语句的分片键时有不同的逻辑。四号。X <code class="fe lx ly lz ma b">parserEngine.parse</code>方法会忽略<code class="fe lx ly lz ma b">case when</code>解析参数，导致与外部参数表不一致，当 3。x 执行普通的 SQL。</p><p id="1a3e" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">三号。x 版本之所以能正确工作，是因为在编写 SQL 时，<code class="fe lx ly lz ma b">case when</code>的第一个参数被有意设置为 shard 键，而<code class="fe lx ly lz ma b">case when</code>语句排在最前面。</p><blockquote class="mk ml mm"><p id="16bb" class="kd ke mn kf b kg kh jo ki kj kk jr kl mo kn ko kp mp kr ks kt mq kv kw kx ky ig bi translated">【https://github.com/apache/shardingsphere/issues/13233<em class="in">T21</em>T24】</p></blockquote><p id="f8a1" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated"><strong class="kf io">解决方案:</strong></p><ul class=""><li id="6a74" class="mb mc in kf b kg kh kj kk km md kq me ku mf ky mg mh mi mj bi translated">建议重写 SQL，因为不支持<code class="fe lx ly lz ma b">case when</code>。</li><li id="24be" class="mb mc in kf b kg mr kj ms km mt kq mu ku mv ky mg mh mi mj bi translated">按照 4.1.1 版本的分片键解析逻辑，<code class="fe lx ly lz ma b">case when</code>放在最后，分片键仍然是<code class="fe lx ly lz ma b">case when</code>的第一个参数。</li></ul><p id="e582" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">9。逻辑表 <code class="fe lx ly lz ma b"><strong class="kf io">actualDataNodes</strong></code> <strong class="kf io">已配置，主键无默认值错误报告。</strong></p><figure class="mx my mz na gt nb gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/b20159fd189ce18395777bbc2fc974cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1120/0*RjEe7Lpzp1rLX_Hp"/></div></figure><figure class="mx my mz na gt nb gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/b42b2eb536a7bed9a7f58a414766f885.png" data-original-src="https://miro.medium.com/v2/resize:fit:1120/0*GQBG0vPmnZwQxj2j"/></div></figure><p id="297d" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated"><code class="fe lx ly lz ma b">check.table.metadata.enabled=true</code>没有配置服务，默认不检查子表的元数据一致性。</p><p id="a091" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">服务配置的<code class="fe lx ly lz ma b">actualDataNodes</code>第一个表不存在，导致<code class="fe lx ly lz ma b">GenerateKeyContenxt</code>为空。</p><figure class="mx my mz na gt nb gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/8c2141aaa95a8f8cca039b2f5296b0bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1120/0*-ods0_sR8Q_J9A3t"/></div></figure><figure class="mx my mz na gt nb gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/f51dae3ff7f864b07e2ce9fe5284ac1c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1120/0*AlLCKPqWB4yLadEA"/></div></figure><p id="6a78" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated"><strong class="kf io">解决方案:</strong></p><ul class=""><li id="2a32" class="mb mc in kf b kg kh kj kk km md kq me ku mf ky mg mh mi mj bi translated">配置<code class="fe lx ly lz ma b">check.table.metadata.enabled=true</code>。启动时检测到不存在的表，并报告错误。</li><li id="f0d9" class="mb mc in kf b kg mr kj ms km mt kq mu ku mv ky mg mh mi mj bi translated">重写<code class="fe lx ly lz ma b">actualDataNodes inline</code>表达式以确保第一个表存在。</li></ul><p id="cf6f" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated"><strong class="kf io"> 10。在 3.0 版本中，全数据库和表路由器的高并发下存在死锁。</strong></p><p id="3511" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">默认情况下，ShardingSphere-JDBC 使用本地事务。在本地事务中，异步获得数据库连接。在高并发下，可能无法获得所有数据库连接，从而导致死锁。</p><figure class="mx my mz na gt nb gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/e8ebb0567f73311dc37520d516986aeb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1120/0*naxzRwK-5igeIlPI"/></div></figure><figure class="mx my mz na gt nb gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/1058d719ef93610daaee928ae64518b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1120/0*yK5-EV4Z5z-k4vKN"/></div></figure><figure class="mx my mz na gt nb gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/9b308fc9bafc45ba45352ced17f2bce7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1120/0*6pGfM0YkwnqJbMrt"/></div></figure><figure class="mx my mz na gt nb gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/cc6f93dbc8a7fb6802604763c79e2bee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1120/0*-PJ9iFRDQZ5svK9Z"/></div></figure><h1 id="c192" class="nr la in bd lb ns nt nu le nv nw nx lh jt ny ju lk jw nz jx ln jz oa ka lq ob bi translated">结论</h1><p id="fee2" class="pw-post-body-paragraph kd ke in kf b kg ls jo ki kj lt jr kl km lu ko kp kq lv ks kt ku lw kw kx ky ig bi translated">作为<a class="ae kc" href="https://shardingsphere.apache.org/" rel="noopener ugc nofollow" target="_blank"> ShardingSphere </a>的核心用户，<a class="ae kc" href="https://ir.enmonster.com/" rel="noopener ugc nofollow" target="_blank">能源怪兽</a>的升级过程也反映了社区用户在应用 ShardingSphere 时可能遇到的一些问题。</p><p id="cdff" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">目前，Apache ShardingSphere 的稳定版本已经更新到 5.1.2，并在功能、性能、测试、文档和示例方面进行了优化。</p><p id="50ad" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">更多信息可以参考<a class="ae kc" href="https://shardingsphere.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache ShardingSphere 官网</a>。如有任何问题或建议，也欢迎在<a class="ae kc" href="https://github.com/apache/shardingsphere" rel="noopener ugc nofollow" target="_blank"> Github </a>上反馈。社区会积极响应和讨论。</p><h1 id="9f13" class="nr la in bd lb ns nt nu le nv nw nx lh jt ny ju lk jw nz jx ln jz oa ka lq ob bi translated">项目链接:</h1><p id="decc" class="pw-post-body-paragraph kd ke in kf b kg ls jo ki kj lt jr kl km lu ko kp kq lv ks kt ku lw kw kx ky ig bi translated"><a class="ae kc" href="https://github.com/apache/shardingsphere/issues?page=1&amp;q=is%3Aopen+is%3Aissue+label%3A%22project%3A+OpenForce+2022%22" rel="noopener ugc nofollow" target="_blank"> ShardingSphere Github </a></p><p id="8988" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated"><a class="ae kc" href="https://twitter.com/ShardingSphere" rel="noopener ugc nofollow" target="_blank"> ShardingSphere Twitter </a></p><p id="9c98" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated"><a class="ae kc" href="https://join.slack.com/t/apacheshardingsphere/shared_invite/zt-sbdde7ie-SjDqo9~I4rYcR18bq0SYTg" rel="noopener ugc nofollow" target="_blank">切割球松弛度</a></p><p id="113d" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated"><a class="ae kc" href="https://shardingsphere.apache.org/community/cn/contribute/" rel="noopener ugc nofollow" target="_blank">投稿指南</a></p><p id="b6b2" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">GitHub 问题</p><p id="25bb" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated"><a class="ae kc" href="https://shardingsphere.apache.org/community/en/contribute/" rel="noopener ugc nofollow" target="_blank">投稿指南</a></p></div></div>    
</body>
</html>