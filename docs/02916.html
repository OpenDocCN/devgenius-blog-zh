<html>
<head>
<title>Cassandra Primary vs Partitioning vs Clustering Keys</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Cassandra 主键与分区键和聚集键</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/cassandra-primary-vs-partitioning-vs-clustering-keys-3b3fa0e317f4?source=collection_archive---------2-----------------------#2020-09-11">https://blog.devgenius.io/cassandra-primary-vs-partitioning-vs-clustering-keys-3b3fa0e317f4?source=collection_archive---------2-----------------------#2020-09-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/eddbb907be3fdfcfcb1b02c66ce42f7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*tfbwF_RRtnKz8ugy"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">照片由<a class="ae kc" href="https://unsplash.com/@sesambrotchen?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Sidorova Alice </a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="0a8a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">卡珊德拉有多种类型的钥匙。即:</p><ol class=""><li id="7ed2" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated">主关键字</li><li id="aab6" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">分区键</li><li id="8975" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">聚类键</li></ol><p id="cecf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们逐一查看一下，以便更好地理解它们。</p><h1 id="2a85" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">主关键字</h1><p id="36f1" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">每个表都需要一个主键。主键可以是一个字段，也可以是多个字段的组合。每个记录的主键必须是唯一的。否则，如果您试图添加主键已经存在的记录，Cassandra 将执行 upsert。</p><p id="7be8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们来看一个现实生活中的卡珊德拉表的例子:</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="ad3a" class="nb lq iq mx b gy nc nd l ne nf">CREATE TABLE player (<br/>   name text,<br/>   club text,<br/>   league text,<br/>   nationality text,<br/>	 kit_number text,<br/>   position text,<br/>	 goals int,<br/>   assists int,<br/>   appearences int,<br/>   PRIMARY KEY (club, league, name, kit_number, position, goals)<br/>)</span></pre><p id="821a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当一个表有多个字段作为主键时，我们称之为<strong class="kf ir">复合主键</strong>。该表也可以有一个字段作为其主键。</p><h1 id="289b" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">分区键</h1><p id="b7fa" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">对于单个字段主键，<strong class="kf ir">分区键</strong>是同一个字段。</p><p id="8cbc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于复合主键，默认情况下，<strong class="kf ir">分区键</strong>是主键的第一个字段。所以对于上面的例子，表的分区键是<code class="fe ng nh ni mx b">club</code>。</p><p id="b132" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">假设您想要定义一个由多个字段组成的分区键。你是怎么做到的？</p><p id="aa98" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">很简单，只要把你想成为分区键一部分的字段放在括号内。让我们来看看这是如何工作的。</p><p id="58a8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">继续我们当前的示例表，假设您希望将<code class="fe ng nh ni mx b">name</code>和<code class="fe ng nh ni mx b">club</code>的组合作为分区键。这是您所做的唯一更改:</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="c545" class="nb lq iq mx b gy nc nd l ne nf">PRIMARY KEY ((name, club), league, kit_number, position, goals)</span></pre><p id="f251" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们知道了如何定义不同的分区键，让我们来讨论一下分区键到底是什么。</p><p id="ac28" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Cassandra 是一个由多个节点组成的分布式数据库。数据存储在分区中。分区键将数据分组到同一个分区中。一台机器可以有多个分区。您希望<em class="nj">相似的</em>数据留在同一个分区中，以便更快地读取。</p><p id="cf2f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们来看一下我们最初的带有<code class="fe ng nh ni mx b">club</code>分区键的例子。这意味着，来自同一个俱乐部的球员将在同一个分区。Cassandra 将使用一致的散列法，以便对于一个给定的俱乐部，所有球员记录总是在同一个分区中结束。</p><p id="2dff" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后，让我们看一个使用复合分区键的例子，例如<code class="fe ng nh ni mx b">(position,league)</code>。在这种情况下，同一联盟中同一位置的所有球员都将处于同一分区。</p><p id="0e9d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如您所见，<strong class="kf ir">分区键</strong>“分块”数据，以便 Cassandra 知道扫描哪个分区(进而哪个节点)来查找传入的查询。</p><h1 id="1441" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">聚类键</h1><p id="7740" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">聚类键决定分区内数据的排序顺序。为了便于访问，下面是我们原始示例的另一个例子:</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="0341" class="nb lq iq mx b gy nc nd l ne nf">CREATE TABLE player (<br/>   name text,<br/>   club text,<br/>   league text,<br/>   nationality text,<br/>	 kit_number text,<br/>   position text,<br/>	 goals int,<br/>   assists int,<br/>   appearances int,<br/>   PRIMARY KEY (club, league, name, kit_number, position, goals)<br/>)</span></pre><p id="cd73" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">除分区键外，主键中的每个字段都是<strong class="kf ir">聚类键的一部分。</strong></p><p id="f913" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这种情况下，我们知道<code class="fe ng nh ni mx b">club</code>是分区键。</p><p id="84b9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所以<code class="fe ng nh ni mx b">league name kit_number position goals</code>是<strong class="kf ir">的聚类键。</strong>您可以为每个聚类键定义排序顺序。假设您可以按照递减的 kit_number 和递增的目标对其进行排序。</p><p id="3e08" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">排序顺序与主键中字段的顺序相同。在上面的例子中，数据是这样排列的:</p><ul class=""><li id="c1a2" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la nk lh li lj bi translated">来自同一个俱乐部的每个玩家最终都在同一个独特的分区中</li><li id="ec44" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la nk lh li lj bi translated">在一个分区内，玩家按照他们所属的联赛排序</li><li id="ce06" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la nk lh li lj bi translated">然后按他们的名字排序</li><li id="8807" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la nk lh li lj bi translated">其中，它们按 kit_number 排序</li><li id="20ed" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la nk lh li lj bi translated">…根据主键中字段的顺序依次类推</li></ul><p id="f015" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">因此，当涉及到模式设计时，主键中字段的顺序非常重要。</strong></p><p id="6dbd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">可以为不同字段的聚类关键字定义不同的排序顺序。例如</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="0bdc" class="nb lq iq mx b gy nc nd l ne nf">CREATE TABLE player (<br/>   name text,<br/>   club text,<br/>   league text,<br/>   nationality text,<br/>	 kit_number text,<br/>   position text,<br/>	 goals int,<br/>   assists int,<br/>   appearances int,<br/>   PRIMARY KEY (club, league, name, kit_number, position, goals)<br/>)<br/>WITH CLUSTERING ORDER BY (league ASC, name DESC, kit_number ASC, position DESC );</span></pre><p id="f68e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此，在这个示例中，在一个分区内，数据将首先按联赛升序排序，然后按姓名降序排序，再按 kit_number 升序排序，然后按位置降序排序，最后按默认顺序(即升序)按进球排序。</p><p id="7ccf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如您所见，这两件事都很重要:</p><ul class=""><li id="f652" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la nk lh li lj bi translated">您在主键中放置字段的顺序</li><li id="d2aa" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la nk lh li lj bi translated">为每个字段定义排序顺序的方式(如果不定义，默认为升序)</li></ul><h1 id="390b" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">最后的想法</h1><p id="e3a0" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">定义 Cassandra 模式的方式非常重要。在设计模式之前，您应该对自己的读写模式有所了解。这将确保您选择正确的分区和聚集键来正确地组织磁盘中的数据。这样，你的读写速度会非常快。</p></div></div>    
</body>
</html>