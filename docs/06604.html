<html>
<head>
<title>Create an Asset Tracker Map with Next.js and React Leaflet</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Next.js和React传单创建资产跟踪地图</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/create-an-asset-tracker-map-with-next-js-and-react-leaflet-7e9e6170f532?source=collection_archive---------5-----------------------#2022-01-19">https://blog.devgenius.io/create-an-asset-tracker-map-with-next-js-and-react-leaflet-7e9e6170f532?source=collection_archive---------5-----------------------#2022-01-19</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="8017" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">增量静态再生使用新数据更新静态页面变得轻而易举。</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi kc"><img src="../Images/c0db0c885ae74478cf43e9ba8f99f40e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1380/format:webp/0*c4Z135VgG1QunoTe.png"/></div></figure><p id="29b0" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">最近，我开始为一家物联网初创公司工作，<a class="ae lg" href="https://blues.io/?&amp;utm_source=paigeniedringhaus.com&amp;utm_medium=web&amp;utm_campaign=niedringhaus-effect&amp;utm_content=ep-2" rel="noopener ugc nofollow" target="_blank"> <strong class="km io"> Blues Wireless </strong> </a>，该公司旨在让物联网开发变得更容易——即使在可靠的互联网连接不可用的情况下。Blues通过<a class="ae lg" href="https://blues.io/products/notecard/?&amp;utm_source=paigeniedringhaus.com&amp;utm_medium=web&amp;utm_campaign=niedringhaus-effect&amp;utm_content=ep-2" rel="noopener ugc nofollow" target="_blank"> <strong class="km io"> Notecards </strong> </a>来实现这一点——可以嵌入任何“边缘”物联网设备的预付费蜂窝设备，以JSON的形式将传感器数据传输到安全的云:<a class="ae lg" href="https://notehub.io/?&amp;utm_source=paigeniedringhaus.com&amp;utm_medium=web&amp;utm_campaign=niedringhaus-effect&amp;utm_content=ep-2" rel="noopener ugc nofollow" target="_blank"> <strong class="km io"> Notehub </strong> </a>。</p><p id="76ce" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">由于web开发是我的主要专业领域(不是物联网开发)，我开始构建一个更简单的物联网项目:一个<a class="ae lg" href="https://www.hackster.io/paige-niedringhaus/low-code-gps-asset-tracker-and-map-display-b10419" rel="noopener ugc nofollow" target="_blank"> <strong class="km io">资产追踪器</strong> </a>，只使用一个Blues <a class="ae lg" href="https://shop.blues.io/products/note-nbgl-500/?&amp;utm_source=paigeniedringhaus.com&amp;utm_medium=web&amp;utm_campaign=niedringhaus-effect&amp;utm_content=ep-2" rel="noopener ugc nofollow" target="_blank"> <strong class="km io">记事本</strong> </a>，Blues <a class="ae lg" href="https://shop.blues.io/products/carr-al/?&amp;utm_source=paigeniedringhaus.com&amp;utm_medium=web&amp;utm_campaign=niedringhaus-effect&amp;utm_content=ep-2" rel="noopener ugc nofollow" target="_blank"> <strong class="km io">记事本，一个内置GPS天线的AL </strong> </a>，以及一个小型的<a class="ae lg" href="https://www.adafruit.com/product/328" rel="noopener ugc nofollow" target="_blank"> <strong class="km io">锂离子聚合物(LiPo)电池</strong> </a>。</p><p id="2aed" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">在Blues <a class="ae lg" href="https://dev.blues.io/guides-and-tutorials/notecard-guides/asset-tracking/?&amp;utm_source=paigeniedringhaus.com&amp;utm_medium=web&amp;utm_campaign=niedringhaus-effect&amp;utm_content=ep-2" rel="noopener ugc nofollow" target="_blank"> <strong class="km io">开发者体验文档</strong> </a>的帮助下，我很快就将GPS位置数据传送到了Notehub cloud。这很酷，但来自传感器的数据真正变得有用的方式是在某种UI中显示给用户，对吗？它可以是图表，表格，或者对我来说，是一张地图。</p><p id="f3d3" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">所以我想把我的数据从Notehub云中取出，放入一个定制的仪表板中，以跟踪和显示Notecard在现实世界中的位置。因为React是我目前选择的JavaScript框架，所以我决定构建一个Next.js- Typescript驱动的仪表板，在这个过程中我学到了很多东西，我打算在接下来的几个月里通过一系列博客文章与您分享。</p><p id="76e2" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated"><strong class="km io">在本文中，我将向您展示如何向Next.js应用程序添加地图，从第三方API源获取位置数据，并定期重新验证数据，以便在出现新的位置数据时更新地图。</strong></p><p id="101d" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">这是最终仪表板的样子——地图是这篇文章的重点:</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="lh li l"/></div><figcaption class="lj lk gj gh gi ll lm bd b be z dk translated">成品资产跟踪仪表板—地图是我们这个项目的重点。</figcaption></figure></div><div class="ab cl ln lo hr lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="ig ih ii ij ik"><h1 id="0567" class="lu lv in bd lw lx ly lz ma mb mc md me jt mf ju mg jw mh jx mi jz mj ka mk ml bi translated">在Next.js应用程序中设置地图组件</h1><p id="bc44" class="pw-post-body-paragraph kk kl in km b kn mm jo kp kq mn jr ks kt mo kv kw kx mp kz la lb mq ld le lf ig bi translated"><strong class="km io">请注意:</strong>本文不会介绍一个全新的Next.js应用程序的初始设置——那不在本文的讨论范围之内。如果你是从零开始，我建议你使用带有类型脚本文档的<a class="ae lg" href="https://nextjs.org/docs/basic-features/typescript" rel="noopener ugc nofollow" target="_blank"> Next.js starter应用程序</a>。</p><blockquote class="mr ms mt"><p id="e84b" class="kk kl mu km b kn ko jo kp kq kr jr ks mv ku kv kw mw ky kz la mx lc ld le lf ig bi translated"><em class="in">如果你愿意，你也可以从GitHub repo </em> <a class="ae lg" href="https://github.com/paigen11/react-gps-asset-tracker-dashboard" rel="noopener ugc nofollow" target="_blank"> <strong class="km io"> <em class="in">这里</em> </strong> </a> <em class="in">分叉并下载我的整个工作代码。</em></p></blockquote><h2 id="f41f" class="my lv in bd lw mz na dn ma nb nc dp me kt nd ne mg kx nf ng mi lb nh ni mk nj bi translated">安装地图项目依赖项</h2><p id="4f00" class="pw-post-body-paragraph kk kl in km b kn mm jo kp kq mn jr ks kt mo kv kw kx mp kz la lb mq ld le lf ig bi translated">这篇文章要做的第一件事，是给下一个项目添加一个地图。这将需要一些新的npm包添加到我们的项目中:<a class="ae lg" href="https://leafletjs.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="km io">传单</strong> </a>、<a class="ae lg" href="https://react-leaflet.js.org/" rel="noopener ugc nofollow" target="_blank"><strong class="km io">react-传单</strong> </a>和<a class="ae lg" href="https://github.com/ghybs/leaflet-defaulticon-compatibility" rel="noopener ugc nofollow" target="_blank"> <strong class="km io">传单-默认-兼容性</strong> </a>。</p><pre class="kd ke kf kg gt nk nl nm nn aw no bi"><span id="cad5" class="my lv in nl b gy np nq l nr ns">$ npm install leaflet react-leaflet leaflet-defaulticon-compatibility</span></pre><blockquote class="mr ms mt"><p id="8644" class="kk kl mu km b kn ko jo kp kq kr jr ks mv ku kv kw mw ky kz la mx lc ld le lf ig bi translated"><strong class="km io"> <em class="in">注意:</em> </strong> <em class="in">如果</em> <code class="fe nt nu nv nl b"><em class="in">react</em></code> <em class="in">和</em> <code class="fe nt nu nv nl b"><em class="in">react-dom</em></code> <em class="in">不在您的项目中，您还需要它们作为对等依赖项。</em></p></blockquote><ul class=""><li id="b90a" class="nw nx in km b kn ko kq kr kt ny kx nz lb oa lf ob oc od oe bi translated">传单是我们的基础，交互式地图的JavaScript库——它提供了我们其他包所依赖的基础。</li><li id="3c67" class="nw nx in km b kn of kq og kt oh kx oi lb oj lf ob oc od oe bi translated"><strong class="km io">react-传单</strong>为传单地图提供了更易于使用的React组件。它提供React和小叶之间的绑定，而不是替换小叶，而是利用它将小叶层抽象为React组件。如果你想了解更多关于React传单的信息，我建议你仔细阅读<a class="ae lg" href="https://react-leaflet.js.org/docs/start-introduction/" rel="noopener ugc nofollow" target="_blank">文档</a>。</li><li id="5878" class="nw nx in km b kn of kq og kt oh kx oi lb oj lf ob oc od oe bi translated"><strong class="km io">传单-默认图标-兼容性</strong>从CSS中检索所有传单默认图标选项，尤其是所有图标图像URL，以提高与修改CSS中URL的捆绑器和框架的兼容性。</li></ul><blockquote class="mr ms mt"><p id="6882" class="kk kl mu km b kn ko jo kp kq kr jr ks mv ku kv kw mw ky kz la mx lc ld le lf ig bi translated"><em class="in">构建引擎和框架修改CSS中的URL，经常会和传单内置默认图标图片自动管理冲突，这个包帮助处理。</em></p></blockquote><p id="de2b" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated"><strong class="km io">打字稿备注:</strong></p><p id="482e" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">如果您在项目中使用Typescript，您还会希望安装以下dev依赖项以避免Typescript错误:</p><pre class="kd ke kf kg gt nk nl nm nn aw no bi"><span id="d4fa" class="my lv in nl b gy np nq l nr ns">$ npm install @types/leaflet --save-dev</span></pre><p id="4e97" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">安装了新的地图库后，是时候继续配置项目以使用这些新资源了。</p><h2 id="1d5e" class="my lv in bd lw mz na dn ma nb nc dp me kt nd ne mg kx nf ng mi lb nh ni mk nj bi translated">为地图的显示样式生成地图框标记，并将其添加到工程中</h2><p id="b92d" class="pw-post-body-paragraph kk kl in km b kn mm jo kp kq mn jr ks kt mo kv kw kx mp kz la lb mq ld le lf ig bi translated">对于资产跟踪器将要打开的地图显示，我选择使用<a class="ae lg" href="https://www.mapbox.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="km io">地图框</strong> </a>样式。它有许多漂亮的<a class="ae lg" href="https://docs.mapbox.com/api/maps/styles/" rel="noopener ugc nofollow" target="_blank"> <strong class="km io">地图显示样式</strong> </a>可供选择，开发者可以创建自己的<a class="ae lg" href="https://docs.mapbox.com/help/getting-started/access-tokens/" rel="noopener ugc nofollow" target="_blank"> <strong class="km io"> Mapbox API令牌</strong> </a>通过注册一个免费的<a class="ae lg" href="https://account.mapbox.com/auth/signup/" rel="noopener ugc nofollow" target="_blank"> <strong class="km io"> Mapbox帐户</strong> </a>来访问这些样式。</p><p id="f088" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">注册并创建新的API令牌后，复制令牌值—它将在Next.js应用程序中使用。在项目根目录下的Next.js应用程序的<code class="fe nt nu nv nl b">next.config.js</code>文件中，添加API令牌，如下所示:</p><p id="36ad" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated"><code class="fe nt nu nv nl b"><strong class="km io">next.config.js</strong></code></p><pre class="kd ke kf kg gt nk nl nm nn aw no bi"><span id="2c2e" class="my lv in nl b gy np nq l nr ns">/**<em class="mu"> </em>@type<em class="mu"> </em>{<em class="mu">import('next').NextConfig</em>}<em class="mu"> </em>*/<br/>module<em class="mu">.</em>exports = {<br/>  reactStrictMode: true,<br/>  env: {<br/>    MAPBOX_ACCESS_TOKEN:<br/>      "[MAPBOX_TOKEN_HERE]",<br/>  },<br/>};</span></pre><p id="c342" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">从这个文件中，Next可以在需要调用Mapbox API端点时访问令牌。接下来，我们将在项目中创建<code class="fe nt nu nv nl b">&lt;Map /&gt;</code>组件。</p><h2 id="a7f8" class="my lv in bd lw mz na dn ma nb nc dp me kt nd ne mg kx nf ng mi lb nh ni mk nj bi translated">创建<code class="fe nt nu nv nl b">&lt;Map&gt;</code>组件</h2><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi kc"><img src="../Images/93182eb3bb422abb9298ff9ea0a78aee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1380/format:webp/0*icHgT1Rc7acqS5Ge.png"/></div><figcaption class="lj lk gj gh gi ll lm bd b be z dk translated">这是组件使用GPS数据呈现出来的样子。</figcaption></figure><p id="37a7" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">由于这是一个React项目，我喜欢使用独立的、可重用的组件，所以在项目内部，创建一个名为<code class="fe nt nu nv nl b">Map.tsx</code>的新文件，并粘贴以下代码。点击下面的文件标题即可获得实时代码。</p><p id="2af7" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated"><code class="fe nt nu nv nl b"><a class="ae lg" href="https://github.com/paigen11/react-gps-asset-tracker-dashboard/blob/main/src/components/Map.tsx" rel="noopener ugc nofollow" target="_blank"><strong class="km io">Map.tsx</strong></a></code></p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ol om di on bf oo"><div class="gh gi ok"><img src="../Images/1e0de6b4518c1c12cc57a56f7e9d34b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Wt19x0rA23eb5GXFw72uhA.png"/></div></div><figcaption class="lj lk gj gh gi ll lm bd b be z dk translated">Map.tsx组件的代码。</figcaption></figure><p id="e5db" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">现在，让我们来讨论一下这个组件中发生的所有事情。</p><p id="09c8" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">在文件的顶部:</p><ul class=""><li id="1852" class="nw nx in km b kn ko kq kr kt ny kx nz lb oa lf ob oc od oe bi translated">该组件所需的所有单个反应小叶组件都被导入，</li><li id="e41f" class="nw nx in km b kn of kq og kt oh kx oi lb oj lf ob oc od oe bi translated">原始传单CSS被导入，</li><li id="fc35" class="nw nx in km b kn of kq og kt oh kx oi lb oj lf ob oc od oe bi translated"><em class="mu">和</em>根据<a class="ae lg" href="https://www.npmjs.com/package/leaflet-defaulticon-compatibility#usage" rel="noopener ugc nofollow" target="_blank">使用说明</a>的规定，随后导入活页默认图标兼容性CSS和JS。</li></ul><p id="ae69" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">之后，是这个组件接受的道具:</p><ul class=""><li id="55f6" class="nw nx in km b kn ko kq kr kt ny kx nz lb oa lf ob oc od oe bi translated"><code class="fe nt nu nv nl b"><strong class="km io">coords</strong></code> -一个包含GPS经度和纬度的数组列表-它绘制了坐标之间的连接线。</li><li id="2ab3" class="nw nx in km b kn of kq og kt oh kx oi lb oj lf ob oc od oe bi translated"><code class="fe nt nu nv nl b"><strong class="km io">lastPosition</strong></code> -当用户点击地图上的图标时，在弹出窗口中显示的最新GPS纬度和经度。</li><li id="d3b7" class="nw nx in km b kn of kq og kt oh kx oi lb oj lf ob oc od oe bi translated"><code class="fe nt nu nv nl b"><strong class="km io">markers</strong></code> -另一个具有GPS纬度和经度的数组列表(是的，这些数组中的坐标顺序是相反的)显示了地图上追踪器之前位置的蓝色圆圈。</li><li id="fda0" class="nw nx in km b kn of kq og kt oh kx oi lb oj lf ob oc od oe bi translated"><code class="fe nt nu nv nl b"><strong class="km io">latestTimestamp</strong></code> -接收到的GPS坐标的最新时间戳(也用于显示在地图的弹出窗口中)。</li></ul><p id="e569" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们直接去JSX吧。</p><p id="aa22" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated"><code class="fe nt nu nv nl b"><strong class="km io">&lt;MapContainer /&gt;</strong></code>是负责创建传单地图实例并将其提供给其子组件的组件——没有该组件，地图将无法工作。在这个组件中，我们可以定义地图的<code class="fe nt nu nv nl b">center</code>坐标，它在地图上的默认缩放级别，以及组件正确显示的一些基本样式。</p><p id="1eab" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated"><code class="fe nt nu nv nl b"><strong class="km io">&lt;TileLayer /&gt;</strong></code> <strong class="km io"> </strong>组件是我们的Mapbox样式和新生成的API令牌发挥作用的地方。只需选择您喜欢的样式，用它替换字符串的<code class="fe nt nu nv nl b">streets-v11</code>部分，并确保地图框标记出现在<code class="fe nt nu nv nl b">next.config.js</code>文件中，我在上一步中已经展示过了。如果没有这个组件，就没有地图背景来显示坐标——相反，它只是一个空白的画布。</p><p id="64dd" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated"><code class="fe nt nu nv nl b"><strong class="km io">&lt;Marker /&gt;</strong></code>接受<code class="fe nt nu nv nl b">lastPosition</code>道具，在地图上显示跟踪器最后记录位置的图标，它包装了<code class="fe nt nu nv nl b">&lt;Popup /&gt;</code>组件、<code class="fe nt nu nv nl b">&lt;GeoJSON /&gt;</code>组件和<code class="fe nt nu nv nl b">&lt;CircleMarker /&gt;</code>组件列表。</p><p id="0162" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">组件<code class="fe nt nu nv nl b"><strong class="km io">&lt;Popup /&gt;</strong></code> <strong class="km io"> </strong>是一个风格优美的工具提示，可以显示任何想要的信息。当用户点击时，我的<code class="fe nt nu nv nl b">&lt;Popup /&gt;</code>显示跟踪器的最后GPS坐标和报告时间，但是它可以显示你想要的任何东西。</p><p id="643a" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated"><code class="fe nt nu nv nl b"><strong class="km io">&lt;GeoJson /&gt;</strong></code> <strong class="km io"> </strong>组件是传递GPS经度和纬度数组的<code class="fe nt nu nv nl b">coords</code>列表以绘制坐标之间的连接线的地方。输入坐标的<code class="fe nt nu nv nl b">geoJsonObj</code>中的<code class="fe nt nu nv nl b">type: "LineString"</code>就是处理它的部分。</p><p id="5a72" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">最后但同样重要的是，<code class="fe nt nu nv nl b"><strong class="km io">&lt;CircleMarker /&gt;</strong></code>组件，在该组件的JSX中显示为<code class="fe nt nu nv nl b">{mapMarkers}</code>。</p><blockquote class="mr ms mt"><p id="935b" class="kk kl mu km b kn ko jo kp kq kr jr ks mv ku kv kw mw ky kz la mx lc ld le lf ig bi translated"><em class="in">注意:为了将列表中的所有</em> <code class="fe nt nu nv nl b"><em class="in">markers</em></code> <em class="in">渲染为地图上的单个圆圈，我必须创建这个小函数来迭代列表并生成所有的圆圈，然后将其直接注入JSX。</em></p><p id="edca" class="kk kl mu km b kn ko jo kp kq kr jr ks mv ku kv kw mw ky kz la mx lc ld le lf ig bi translated"><em class="in">试图迭代JSX中的所有值是行不通的，我相信这是这个</em> <code class="fe nt nu nv nl b"><em class="in">react-leaflet</em></code> <em class="in">包与传统React代码行为不同的一个例子。</em></p></blockquote><p id="a34b" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">这就是这个组件中发生的所有事情，当它被分解成组成它的各个部分时，并不复杂，对吗？</p><h2 id="97b3" class="my lv in bd lw mz na dn ma nb nc dp me kt nd ne mg kx nf ng mi lb nh ni mk nj bi translated">在Next.js应用程序中渲染地图</h2><p id="bc8a" class="pw-post-body-paragraph kk kl in km b kn mm jo kp kq mn jr ks kt mo kv kw kx mp kz la lb mq ld le lf ig bi translated">我们在下一个应用程序中获得地图渲染的最后一步:用选项<code class="fe nt nu nv nl b">ssr:false</code>导入组件。</p><p id="29dd" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">由于<code class="fe nt nu nv nl b">react-leaflet</code>库只在浏览器中工作，我们不得不使用Next.js的<code class="fe nt nu nv nl b"><a class="ae lg" href="https://nextjs.org/docs/advanced-features/dynamic-import#with-no-ssr" rel="noopener ugc nofollow" target="_blank"><strong class="km io">dynamic import()</strong></a></code> <a class="ae lg" href="https://nextjs.org/docs/advanced-features/dynamic-import#with-no-ssr" rel="noopener ugc nofollow" target="_blank"> <strong class="km io">支持而不使用SSR </strong> </a>来告诉地图组件只在Next.js服务器端渲染发生后进行渲染。</p><p id="378b" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">因此，无论这个<code class="fe nt nu nv nl b">&lt;Map /&gt;</code>组件被注入到您的应用程序中的什么地方，都要使用下面详述的语法。在我的应用程序中，它在<code class="fe nt nu nv nl b">index.tsx</code>页面文件中，为了清晰起见，我将文件中的代码压缩了。点击文件标题查看完整代码。</p><p id="c8db" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated"><code class="fe nt nu nv nl b"><a class="ae lg" href="https://github.com/paigen11/react-gps-asset-tracker-dashboard/blob/main/pages/index.tsx" rel="noopener ugc nofollow" target="_blank"><strong class="km io">pages/index.tsx</strong></a></code></p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ol om di on bf oo"><div class="gh gi op"><img src="../Images/f867ce97261f30fd955c30177631ea51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rwJdvwvu09ylnTnpYuGFjA.png"/></div></div><figcaption class="lj lk gj gh gi ll lm bd b be z dk translated">index.tsx文件中的压缩代码将没有SSR的地图组件导入下一个项目。</figcaption></figure><p id="2ee1" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">一旦在禁用服务器端呈现的情况下动态导入了<code class="fe nt nu nv nl b">&lt;Map /&gt;</code>，就可以像应用程序中的其他组件一样使用该组件。就这么简单。</p><blockquote class="mr ms mt"><p id="fd8c" class="kk kl mu km b kn ko jo kp kq kr jr ks mv ku kv kw mw ky kz la mx lc ld le lf ig bi translated"><em class="in">在这一点上，可以随意模拟一些地图的硬编码数据，以确保它能够正确工作。在下一节中，我将介绍如何从我的资产跟踪器位置数据当前所在的Notehub云中获取实时数据。</em></p></blockquote></div><div class="ab cl ln lo hr lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="ig ih ii ij ik"><h1 id="eeee" class="lu lv in bd lw lx ly lz ma mb mc md me jt mf ju mg jw mh jx mi jz mj ka mk ml bi translated">为地图引入数据</h1><p id="98ae" class="pw-post-body-paragraph kk kl in km b kn mm jo kp kq mn jr ks kt mo kv kw kx mp kz la lb mq ld le lf ig bi translated">好了，地图已经在应用程序中设置好了，现在是时候给它一些数据来显示了。如果您想像我一样构建自己的资产追踪器，欢迎您——我将简要概述我使用的硬件，并向您介绍配置它的文档——与我用来设置我的资产追踪器的文档完全相同。</p><p id="b9bf" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">这是实现这个项目所需的设备:</p><ul class=""><li id="0b83" class="nw nx in km b kn ko kq kr kt ny kx nz lb oa lf ob oc od oe bi translated">蓝调无线<a class="ae lg" href="https://shop.blues.io/products/note-nbgl-500/?&amp;utm_source=paigeniedringhaus.com&amp;utm_medium=web&amp;utm_campaign=niedringhaus-effect&amp;utm_content=ep-2" rel="noopener ugc nofollow" target="_blank"><strong class="km io">n b-IoT&amp;LTE-M Notecard Global</strong></a></li><li id="75b3" class="nw nx in km b kn of kq og kt oh kx oi lb oj lf ob oc od oe bi translated">blues Wireless<a class="ae lg" href="https://shop.blues.io/products/carr-al/?&amp;utm_source=paigeniedringhaus.com&amp;utm_medium=web&amp;utm_campaign=niedringhaus-effect&amp;utm_content=ep-2" rel="noopener ugc nofollow" target="_blank"><strong class="km io">note carrier AL带LiPo电池连接器</strong> </a></li><li id="d880" class="nw nx in km b kn of kq og kt oh kx oi lb oj lf ob oc od oe bi translated"><a class="ae lg" href="https://www.adafruit.com/product/328" rel="noopener ugc nofollow" target="_blank"> <strong class="km io">脂电池</strong> </a>来自Adafruit这样的物联网供应商(我的是3.7v 2500mAh版本)</li></ul><h2 id="816a" class="my lv in bd lw mz na dn ma nb nc dp me kt nd ne mg kx nf ng mi lb nh ni mk nj bi translated">初始便笺和便笺载体配置</h2><p id="a995" class="pw-post-body-paragraph kk kl in km b kn mm jo kp kq mn jr ks kt mo kv kw kx mp kz la lb mq ld le lf ig bi translated">遵循Blues <a class="ae lg" href="https://dev.blues.io/start/quickstart/notecarrier-al/?&amp;utm_source=paigeniedringhaus.com&amp;utm_medium=web&amp;utm_campaign=niedringhaus-effect&amp;utm_content=ep-2" rel="noopener ugc nofollow" target="_blank"> <strong class="km io">快速入门指南</strong> </a>设置Notecard、Notecarrier和第一个Notehub项目，并遵循Blues <a class="ae lg" href="https://dev.blues.io/notecard/notecard-guides/asset-tracking/?&amp;utm_source=paigeniedringhaus.com&amp;utm_medium=web&amp;utm_campaign=niedringhaus-effect&amp;utm_content=ep-2" rel="noopener ugc nofollow" target="_blank"> <strong class="km io">资产跟踪指南</strong> </a>了解配置Notecard进行GPS位置跟踪所需的命令。</p><p id="5d2a" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">除了这些说明之外，还有一个重要的警告，以使这个资产追踪器为我们的目的工作。</p><ol class=""><li id="6763" class="nw nx in km b kn ko kq kr kt ny kx nz lb oa lf oq oc od oe bi translated">在最后的配置步骤:<code class="fe nt nu nv nl b"><a class="ae lg" href="https://dev.blues.io/notecard/notecard-guides/asset-tracking/#tracker-configuration-requests?&amp;utm_source=paigeniedringhaus.com&amp;utm_medium=web&amp;utm_campaign=niedringhaus-effect&amp;utm_content=ep-2" rel="noopener ugc nofollow" target="_blank">card.location.track</a></code>中，跟踪器开始运行，包括属性:<code class="fe nt nu nv nl b">"sync”: true</code>。这个属性意味着一旦Notecard获得一个新的事件(在本例中是一个新的GPS位置)，note card就会将该事件同步到Notehub，而不是等待其定期安排的<code class="fe nt nu nv nl b">outbound</code>时间。</li></ol><blockquote class="mr ms mt"><p id="14ee" class="kk kl mu km b kn ko jo kp kq kr jr ks mv ku kv kw mw ky kz la mx lc ld le lf ig bi translated"><em class="in">如果你好奇的话，这里有我用来从头到尾设置我的记事本的所有命令使用</em> <a class="ae lg" href="https://dev.blues.io/notecard-playground/?&amp;utm_source=paigeniedringhaus.com&amp;utm_medium=web&amp;utm_campaign=niedringhaus-effect&amp;utm_content=ep-2" rel="noopener ugc nofollow" target="_blank"> <strong class="km io"> <em class="in">内置web REPL </em> </strong> </a> <em class="in">在蓝调</em> <a class="ae lg" href="https://dev.blues.io/?&amp;utm_source=paigeniedringhaus.com&amp;utm_medium=web&amp;utm_campaign=niedringhaus-effect&amp;utm_content=ep-2" rel="noopener ugc nofollow" target="_blank"> <strong class="km io"> <em class="in">开发者体验网站</em> </strong> </a> <em class="in">。</em></p></blockquote><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ol om di on bf oo"><div class="gh gi or"><img src="../Images/b647d51759351ca72acb95df66253196.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_Qv20qFUE37XaxvdYV3ALg.png"/></div></div><figcaption class="lj lk gj gh gi ll lm bd b be z dk translated">用于配置资产跟踪便笺的所有命令。</figcaption></figure><p id="0a1a" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated"><a class="ae lg" href="https://dev.blues.io/reference/notehub-api/api-introduction/?&amp;utm_source=paigeniedringhaus.com&amp;utm_medium=web&amp;utm_campaign=niedringhaus-effect&amp;utm_content=ep-2" rel="noopener ugc nofollow" target="_blank"> Notehub API </a>可用于直接从Notehub获取<strong class="km io">事件</strong>(包含Notecard GPS坐标的数据)。Notehub API要求用户创建一个<a class="ae lg" href="https://dev.blues.io/reference/notehub-api/api-introduction/#authentication/?&amp;utm_source=paigeniedringhaus.com&amp;utm_medium=web&amp;utm_campaign=niedringhaus-effect&amp;utm_content=ep-2" rel="noopener ugc nofollow" target="_blank"> <strong class="km io">授权令牌</strong> </a>与请求一起传递，但是这个过程是有据可查的，正如获取所有事件 的<a class="ae lg" href="https://dev.blues.io/reference/notehub-api/event-api/#get-events-by-project/?&amp;utm_source=paigeniedringhaus.com&amp;utm_medium=web&amp;utm_campaign=niedringhaus-effect&amp;utm_content=ep-2" rel="noopener ugc nofollow" target="_blank"> <strong class="km io"> API一样。</strong></a></p><p id="339b" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated"><strong class="km io">生成一个Notehub认证令牌</strong></p><p id="fd16" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">下面是在命令行中运行以生成Notehub授权令牌的代码:</p><pre class="kd ke kf kg gt nk nl nm nn aw no bi"><span id="350a" class="my lv in nl b gy np nq l nr ns">$ curl -X POST <br/>-L 'https://api.notefile.net/auth/login' <br/>-d '{"username":"[<a class="ae lg" href="https://www.paigeniedringhaus.com/cdn-cgi/l/email-protection" rel="noopener ugc nofollow" target="_blank">[email protected]</a>]", "password": "[your_password]"}'</span></pre><p id="e75a" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">复制这个令牌，在Next.js项目中，在项目的根目录下，创建一个<code class="fe nt nu nv nl b">.env.local</code>文件——这是保存敏感信息的地方:秘密、项目信息以及任何你不想提交给GitHub让全世界看到的东西。这里有一个文件应该是什么样子的例子，以及它需要的两个秘密变量:</p><p id="80e9" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated"><code class="fe nt nu nv nl b"><a class="ae lg" href="https://github.com/paigen11/react-gps-asset-tracker-dashboard/blob/main/.env" rel="noopener ugc nofollow" target="_blank"><strong class="km io">.env.local</strong></a></code></p><pre class="kd ke kf kg gt nk nl nm nn aw no bi"><span id="c600" class="my lv in nl b gy np nq l nr ns">NOTEHUB_PROJECT_ID =APP_ID_GOES_HERE <br/>NOTEHUB_TOKEN =NOTEHUB_GENERATED_TOKEN_GOES_HERE</span></pre><blockquote class="mr ms mt"><p id="6c59" class="kk kl mu km b kn ko jo kp kq kr jr ks mv ku kv kw mw ky kz la mx lc ld le lf ig bi translated"><em class="in">这个</em> <code class="fe nt nu nv nl b"><em class="in">.env.local</em></code> <em class="in">文件就是如何</em> <a class="ae lg" href="https://nextjs.org/docs/basic-features/environment-variables#loading-environment-variables" rel="noopener ugc nofollow" target="_blank"> <em class="in"> Next.js自动读入在构建时或者在客户端使用的环境变量</em> </a> <em class="in">。您需要的所有变量都是构建时间变量，因此它们都不需要以</em> <code class="fe nt nu nv nl b"><em class="in">NEXT_PUBLIC_</em></code> <em class="in">为前缀，这允许在客户端访问变量。</em></p></blockquote><p id="aec2" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated"><strong class="km io">在Next.js </strong>中创建一个T4<strong class="km io">函数</strong></p><p id="6aaf" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">有了在<code class="fe nt nu nv nl b">.env.local</code>文件中指定的Notehub令牌和项目ID，现在我们可以通过Next的<code class="fe nt nu nv nl b"><a class="ae lg" href="https://nextjs.org/docs/basic-features/data-fetching/get-static-props" rel="noopener ugc nofollow" target="_blank"><strong class="km io">getStaticProps</strong></a></code>函数连接到Notehub。</p><p id="99ca" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">创建一个名为<code class="fe nt nu nv nl b">notecardData.ts</code>的新文件，这是从Notehub获取数据并过滤出我们想要的事件<code class="fe nt nu nv nl b">_track.qo</code>的函数所在的地方。</p><p id="9eef" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">下面是获取事件的代码——单击文件名可以看到我的实际repo中的代码。</p><p id="4501" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated"><code class="fe nt nu nv nl b"><a class="ae lg" href="https://github.com/paigen11/react-gps-asset-tracker-dashboard/blob/main/src/lib/notecardData.ts" rel="noopener ugc nofollow" target="_blank"><strong class="km io">notecardData.ts</strong></a></code></p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ol om di on bf oo"><div class="gh gi os"><img src="../Images/48ba1df74fbe10d26d5d02ef483e2dcc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8faGagT3RfIpollxASlffw.png"/></div></div><figcaption class="lj lk gj gh gi ll lm bd b be z dk translated">在Next.js应用程序中获取便笺数据的函数。</figcaption></figure><p id="553b" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">虽然这个文件乍一看很冗长，但实际上并没有那么复杂。</p><p id="a596" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">它首先设置一个<code class="fe nt nu nv nl b"><strong class="km io">baseUrl</strong></code>，定义到<a class="ae lg" href="https://dev.blues.io/reference/notehub-api/event-api/#get-events-by-project/?&amp;utm_source=paigeniedringhaus.com&amp;utm_medium=web&amp;utm_campaign=niedringhaus-effect&amp;utm_content=ep-2" rel="noopener ugc nofollow" target="_blank"> Notehub事件</a>的URL连接——这就是access<code class="fe nt nu nv nl b">NOTEHUB_PROJECT_ID</code>环境变量发挥作用的地方。</p><p id="888d" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">接下来是包含<code class="fe nt nu nv nl b">"X-SESSION-TOKEN"</code>的<code class="fe nt nu nv nl b"><strong class="km io">header</strong></code>对象，它被设置为等于我们生成的<code class="fe nt nu nv nl b">NOTEHUB_TOKEN</code>。</p><p id="1c28" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">之后，点击Notehub事件端点，它将自动取回它存储的前50个事件，如果有比刚才返回的更多的事件，JSON响应列表也将包括属性<code class="fe nt nu nv nl b"><strong class="km io">through</strong></code>和<code class="fe nt nu nv nl b"><strong class="km io">has_more</strong></code>。</p><p id="f275" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">如果<code class="fe nt nu nv nl b">has_more</code>存在，这个<code class="fe nt nu nv nl b">while</code>循环函数将继续使用<code class="fe nt nu nv nl b">through</code>值(返回事件数组中最后一个事件的全局唯一标识符)命中Notehub，直到没有更多事件添加到<code class="fe nt nu nv nl b">eventArray</code>列表中。</p><p id="c523" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">最后，所有收集到的事件都被过滤到只有<code class="fe nt nu nv nl b">_track.qo</code>类型，因为这些事件包含跟踪器的GPS坐标。</p><h2 id="1ef9" class="my lv in bd lw mz na dn ma nb nc dp me kt nd ne mg kx nf ng mi lb nh ni mk nj bi translated">调用页面上的<code class="fe nt nu nv nl b">fetchNotecardData()</code>功能</h2><p id="dd40" class="pw-post-body-paragraph kk kl in km b kn mm jo kp kq mn jr ks kt mo kv kw kx mp kz la lb mq ld le lf ig bi translated">我们的函数连接到Notehub并获得构造的事件数据，现在是时候在<code class="fe nt nu nv nl b">&lt;Map /&gt;</code>组件所在的页面中进行调用了。为此，我们将使用Next的<code class="fe nt nu nv nl b">getStaticProps</code>函数来获取服务器端的数据。</p><p id="f05f" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">在我们之前导入了<code class="fe nt nu nv nl b">&lt;Map /&gt;</code>组件的<code class="fe nt nu nv nl b">index.tsx</code>文件中，我们将在文件底部添加以下代码。为了清楚起见，我压缩了文件的其余部分，但是完整的文件链接在下面。</p><p id="2e64" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated"><code class="fe nt nu nv nl b"><a class="ae lg" href="https://github.com/paigen11/react-gps-asset-tracker-dashboard/blob/main/pages/index.tsx" rel="noopener ugc nofollow" target="_blank"><strong class="km io">pages/index.tsx</strong></a></code></p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ol om di on bf oo"><div class="gh gi ot"><img src="../Images/34817701d51b263b5d748ddabdaf01ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SV3ruKkYpDFCwqF1jBj0xw.png"/></div></div><figcaption class="lj lk gj gh gi ll lm bd b be z dk translated">index.tsx文件中的代码在组件中使用fetchNotecardData函数。</figcaption></figure><p id="8d91" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">为了在服务器端调用<code class="fe nt nu nv nl b">index.tsx</code>文件中的Notehub API，我们导入<code class="fe nt nu nv nl b">fetchNotecardData()</code>函数本身，从Next导入<code class="fe nt nu nv nl b">getStaticProps</code>函数，然后在文件末尾，从<code class="fe nt nu nv nl b">getStaticProps</code>函数内部调用<code class="fe nt nu nv nl b">fetchNotecardData()</code>。</p><p id="e3d8" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">最后，我们将来自Notehub的数据作为<code class="fe nt nu nv nl b">props</code>返回，该数据可以传递给<code class="fe nt nu nv nl b">Home</code>组件。</p><h2 id="76b4" class="my lv in bd lw mz na dn ma nb nc dp me kt nd ne mg kx nf ng mi lb nh ni mk nj bi translated">将数据整理成<code class="fe nt nu nv nl b">&lt;Map /&gt;</code>组件的形状。</h2><p id="88c7" class="pw-post-body-paragraph kk kl in km b kn mm jo kp kq mn jr ks kt mo kv kw kx mp kz la lb mq ld le lf ig bi translated">很好。我们已经从Notehub获得了数据，还有最后一件事要做:获取从Notehub返回的JSON数据，并对其进行重组以适应<code class="fe nt nu nv nl b">&lt;Map /&gt;</code>组件。我再次精简了逻辑，使这个文件更容易阅读，但你可以在GitHub上看到完整的文件。</p><p id="fa6a" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated"><code class="fe nt nu nv nl b"><a class="ae lg" href="https://github.com/paigen11/react-gps-asset-tracker-dashboard/blob/main/pages/index.tsx" rel="noopener ugc nofollow" target="_blank"><strong class="km io">pages/index.tsx</strong></a></code></p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ol om di on bf oo"><div class="gh gi ou"><img src="../Images/d6d0a21e1a4a7461c8a6701c21996c72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VO4WzLYB_qcHSVMkCGf_Lg.png"/></div></div><figcaption class="lj lk gj gh gi ll lm bd b be z dk translated">将Notehub数据转换为index.tsx文件中的映射数据的状态和逻辑</figcaption></figure><p id="6802" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">在这个函数中，一旦从Notehub获取数据并传递给组件，我们就设置一些新的React <code class="fe nt nu nv nl b">useState</code>变量来保存要传递给<code class="fe nt nu nv nl b">&lt;Map /&gt;</code>组件的数据。</p><ul class=""><li id="f83b" class="nw nx in km b kn ko kq kr kt ny kx nz lb oa lf ob oc od oe bi translated">有一个<code class="fe nt nu nv nl b"><strong class="km io">lngLatCoords</strong></code>列表——这是一个坐标列表，将用于在记录的GPS坐标之间画线(它必须作为<code class="fe nt nu nv nl b">[longitude, latitude]</code>传递给<code class="fe nt nu nv nl b">"LineString"</code> <code class="fe nt nu nv nl b">&lt;GeoJSON /&gt;</code>组件)。</li><li id="e83a" class="nw nx in km b kn of kq og kt oh kx oi lb oj lf ob oc od oe bi translated"><code class="fe nt nu nv nl b"><strong class="km io">lastPosition</strong></code>状态变量用于使地图居中，标记图标居中，并与<code class="fe nt nu nv nl b"><strong class="km io">latestTimestamp</strong></code>变量一起显示在<code class="fe nt nu nv nl b">&lt;Popup /&gt;</code>中。</li><li id="ba4f" class="nw nx in km b kn of kq og kt oh kx oi lb oj lf ob oc od oe bi translated">并且<code class="fe nt nu nv nl b"><strong class="km io">latLngMarkerPositions</strong></code>列表与<code class="fe nt nu nv nl b">lngLatCoords</code>变量类似，除了这里的坐标是按照<code class="fe nt nu nv nl b">[latitude, longitude]</code>的顺序。</li></ul><p id="2991" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">在<code class="fe nt nu nv nl b">useEffect()</code>函数内部，对Notehub事件的数组进行排序，然后进行迭代以提取所需形状的所有相关数据。一旦所有事件都被转换，它们就被设置为状态并传递给地图。</p></div><div class="ab cl ln lo hr lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="ig ih ii ij ik"><h1 id="2059" class="lu lv in bd lw lx ly lz ma mb mc md me jt mf ju mg jw mh jx mi jz mj ka mk ml bi translated">使用ISR定期更新数据</h1><p id="2bb4" class="pw-post-body-paragraph kk kl in km b kn mm jo kp kq mn jr ks kt mo kv kw kx mp kz la lb mq ld le lf ig bi translated">还有最后一件事我们还没有讨论，那就是在资产跟踪应用程序最初加载数据并呈现地图之后，如何处理发送到Notehub <strong class="km io">的新<code class="fe nt nu nv nl b">_track.qo</code>事件。</strong></p><p id="e32f" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">在我构建跟踪器的早期，我使用了一个简单的<code class="fe nt nu nv nl b">refreshData()</code>函数来强制Next.js每隔5分钟在服务器端重新提取Notehub数据，但后来我学到了一个更好的方法，它实际上内置于Next: <a class="ae lg" href="https://nextjs.org/docs/basic-features/data-fetching/incremental-static-regeneration" rel="noopener ugc nofollow" target="_blank"> <strong class="km io">增量静态再生</strong> </a> (ISR)。</p><p id="1d13" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">ISR使我们能够在每页的基础上使用静态生成，而不需要重建整个网站。这实际上意味着:<code class="fe nt nu nv nl b">getStaticProps</code>仍然被调用来获取数据，但是另外一个<code class="fe nt nu nv nl b">revalidate</code>选项被传递给<code class="fe nt nu nv nl b">return</code>语句，间隔时间以秒为单位。</p><p id="9aaa" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">每次到达该间隔时，Next.js将再次调用该函数，并尝试使用任何新数据重新生成页面，一旦页面重新生成，Next将用新页面替换旧页面。没有加载消息，没有screen jank，没有像WebSockets或长轮询这样的额外库，也没有手动强制服务器端刷新的额外函数——而是内置在Next中。</p><p id="de4e" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">因此，为了定期重新验证页面数据，我们将再次返回到<code class="fe nt nu nv nl b">index.tsx</code>页面。</p><p id="1cdb" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated"><code class="fe nt nu nv nl b"><a class="ae lg" href="https://github.com/paigen11/react-gps-asset-tracker-dashboard/blob/main/pages/index.tsx" rel="noopener ugc nofollow" target="_blank"><strong class="km io">pages/index.tsx</strong></a></code></p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ol om di on bf oo"><div class="gh gi ov"><img src="../Images/4ae866eeecd4e6e60c6b9f9186b0b4d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VfX96h5v7wfo9IYyFL_lkg.png"/></div></div><figcaption class="lj lk gj gh gi ll lm bd b be z dk translated">ISR实现重新提取数据服务器端，并在后台用新数据更新地图组件。</figcaption></figure><p id="5f97" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">新代码在这个文件中的<code class="fe nt nu nv nl b">getStaticProps()</code>函数的最底部——行<code class="fe nt nu nv nl b">return { props: { data }, revalidate: 120 };</code></p><p id="e012" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">这就是我们所需要的，这样每两分钟Next.js就会返回到Notehub，获取任何新数据，并在服务器端重新呈现页面。太牛逼了。</p><p id="30eb" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">这样，我们就有了一个用Next.js构建的资产跟踪图，并定期检查新数据。</p></div><div class="ab cl ln lo hr lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="ig ih ii ij ik"><h1 id="911b" class="lu lv in bd lw lx ly lz ma mb mc md me jt mf ju mg jw mh jx mi jz mj ka mk ml bi translated">结论</h1><p id="09f7" class="pw-post-body-paragraph kk kl in km b kn mm jo kp kq mn jr ks kt mo kv kw kx mp kz la lb mq ld le lf ig bi translated">在我于2021年7月加入一家物联网初创公司后，我开始用资产跟踪器尝试物联网开发。一旦我有了定期发送到云中的GPS数据，我就知道如何从云中提取数据，并将其显示在定制的仪表板地图中。</p><p id="76c1" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">在React支持的Next.js框架和React传单库的帮助下，我能够很容易地做到这一点，甚至利用Next的内置增量静态再生来重新获取任何新的数据服务器端，并用这些新数据重新渲染地图。挺酷的。</p><p id="c1d6" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">感恩节后的晚上，当我父母的车在车道上被偷时，这真的派上了用场。如果你想听完整个故事并建立自己的追踪器，看看我为蓝调无线制作的这篇<a class="ae lg" href="https://blues.io/blog/gps-asset-tracker-with-blues-wireless-and-react/?&amp;utm_source=medium.com&amp;utm_medium=web&amp;utm_campaign=niedringhaus-effect&amp;utm_content=ep-2" rel="noopener ugc nofollow" target="_blank"> <strong class="km io">博客文章和视频</strong></a>——它详细描述了从硬件到软件再到部署到网络的整个过程。</p><p id="25f2" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">过几周再来看看——我会写更多关于JavaScript、React、IoT或其他与web开发相关的东西。如果你想确保你不会错过我写的一篇文章，在这里注册我的时事通讯:<a class="ae lg" href="https://paigeniedringhaus.substack.com" rel="noopener ugc nofollow" target="_blank">https://paigeniedringhaus.substack.com</a></p><p id="ddd0" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">感谢阅读。我希望您喜欢学习如何在Next.js中设置地图，并将资产追踪器的位置数据渲染到该地图上——试想一下，这对于追踪个人车辆或整个车队有多么有用。从这里开始，你可以去很多很棒的地方做这个项目。追踪愉快！</p></div><div class="ab cl ln lo hr lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="ig ih ii ij ik"><h1 id="e4a3" class="lu lv in bd lw lx ly lz ma mb mc md me jt mf ju mg jw mh jx mi jz mj ka mk ml bi translated">参考资料和更多资源</h1><ul class=""><li id="05d3" class="nw nx in km b kn mm kq mn kt ow kx ox lb oy lf ob oc od oe bi translated"><a class="ae lg" href="https://www.hackster.io/paige-niedringhaus/low-code-gps-asset-tracker-and-map-display-b10419" rel="noopener ugc nofollow" target="_blank"> Hackster.io原始资产跟踪项目</a></li><li id="0ccb" class="nw nx in km b kn of kq og kt oh kx oi lb oj lf ob oc od oe bi translated"><a class="ae lg" href="https://github.com/paigen11/react-gps-asset-tracker-dashboard" rel="noopener ugc nofollow" target="_blank">资产追踪公司GitHub回购</a></li><li id="0d27" class="nw nx in km b kn of kq og kt oh kx oi lb oj lf ob oc od oe bi translated">传单<a class="ae lg" href="https://leafletjs.com/" rel="noopener ugc nofollow" target="_blank">文件</a></li><li id="e3f4" class="nw nx in km b kn of kq og kt oh kx oi lb oj lf ob oc od oe bi translated">反馈传单<a class="ae lg" href="https://react-leaflet.js.org/" rel="noopener ugc nofollow" target="_blank">文档</a></li><li id="d0c9" class="nw nx in km b kn of kq og kt oh kx oi lb oj lf ob oc od oe bi translated">地图框<a class="ae lg" href="https://www.mapbox.com/" rel="noopener ugc nofollow" target="_blank">站点</a></li><li id="72dc" class="nw nx in km b kn of kq og kt oh kx oi lb oj lf ob oc od oe bi translated">蓝调无线<a class="ae lg" href="https://blues.io/?&amp;utm_source=paigeniedringhaus.com&amp;utm_medium=web&amp;utm_campaign=niedringhaus-effect&amp;utm_content=ep-2" rel="noopener ugc nofollow" target="_blank">网站</a></li><li id="1da6" class="nw nx in km b kn of kq og kt oh kx oi lb oj lf ob oc od oe bi translated">蓝调无线<a class="ae lg" href="https://dev.blues.io/?&amp;utm_source=paigeniedringhaus.com&amp;utm_medium=web&amp;utm_campaign=niedringhaus-effect&amp;utm_content=ep-2" rel="noopener ugc nofollow" target="_blank">开发者体验网站</a></li><li id="ca0f" class="nw nx in km b kn of kq og kt oh kx oi lb oj lf ob oc od oe bi translated">Next.js <a class="ae lg" href="https://nextjs.org/docs/basic-features/data-fetching/incremental-static-regeneration" rel="noopener ugc nofollow" target="_blank">增量静态再生</a></li></ul></div><div class="ab cl ln lo hr lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="ig ih ii ij ik"><h1 id="3132" class="lu lv in bd lw lx ly lz ma mb mc md me jt mf ju mg jw mh jx mi jz mj ka mk ml bi translated">你可能喜欢的其他文章</h1><div class="oz pa gp gr pb pc"><a href="https://www.hackster.io/paige-niedringhaus/low-code-gps-asset-tracker-and-map-display-b10419" rel="noopener  ugc nofollow" target="_blank"><div class="pd ab fo"><div class="pe ab pf cl cj pg"><h2 class="bd io gy z fp ph fr fs pi fu fw im bi translated">低代码GPS资产跟踪器和地图显示</h2><div class="pj l"><h3 class="bd b gy z fp ph fr fs pi fu fw dk translated">最近，我作为一名软件工程师加入了物联网初创公司Blues Wireless。我没有物联网经验…</h3></div><div class="pk l"><p class="bd b dl z fp ph fr fs pi fu fw dk translated">www.hackster.io</p></div></div><div class="pl l"><div class="pm l pn po pp pl pq ki pc"/></div></div></a></div><div class="oz pa gp gr pb pc"><a href="https://blues.io/blog/reactjs-vs-blues-wireless-iot/" rel="noopener  ugc nofollow" target="_blank"><div class="pd ab fo"><div class="pe ab pf cl cj pg"><h2 class="bd io gy z fp ph fr fs pi fu fw im bi translated">Blues Wireless -与React类似，但适用于物联网</h2><div class="pj l"><h3 class="bd b gy z fp ph fr fs pi fu fw dk translated">2021年11月2日欢迎开始新的博客系列，我将尝试向其他人展示web开发…</h3></div><div class="pk l"><p class="bd b dl z fp ph fr fs pi fu fw dk translated">blues.io</p></div></div><div class="pl l"><div class="pr l pn po pp pl pq ki pc"/></div></div></a></div><div class="oz pa gp gr pb pc"><a href="https://blog.bitsrc.io/pure-css-to-make-a-button-shine-and-gently-change-colors-over-time-5b685d9c6a7e" rel="noopener  ugc nofollow" target="_blank"><div class="pd ab fo"><div class="pe ab pf cl cj pg"><h2 class="bd io gy z fp ph fr fs pi fu fw im bi translated">纯CSS使一个按钮“发光”,并随着时间的推移逐渐改变颜色</h2><div class="pj l"><h3 class="bd b gy z fp ph fr fs pi fu fw dk translated">因为CSS中的动画和渐变很讨人喜欢。</h3></div><div class="pk l"><p class="bd b dl z fp ph fr fs pi fu fw dk translated">blog.bitsrc.io</p></div></div><div class="pl l"><div class="ps l pn po pp pl pq ki pc"/></div></div></a></div></div><div class="ab cl ln lo hr lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="ig ih ii ij ik"><p id="ba37" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated"><em class="mu">原载于</em><a class="ae lg" href="https://www.paigeniedringhaus.com/blog/create-an-asset-tracker-map-with-next-js-and-react-leaflet" rel="noopener ugc nofollow" target="_blank"><em class="mu"/></a><em class="mu">。</em></p></div></div>    
</body>
</html>