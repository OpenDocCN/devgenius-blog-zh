<html>
<head>
<title>Measuring distance with Bluetooth in indoor environment using Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Python 实现室内环境下蓝牙测距</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/measuring-distance-with-bluetooth-in-indoor-environment-using-python-a36b344f9711?source=collection_archive---------1-----------------------#2022-06-29">https://blog.devgenius.io/measuring-distance-with-bluetooth-in-indoor-environment-using-python-a36b344f9711?source=collection_archive---------1-----------------------#2022-06-29</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div class="gh gi jk"><img src="../Images/2c82ba6c0ad963ac8b59e003484b41c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1288/format:webp/0*riL0CECntQwwv29Y.jpg"/></div></figure><p id="a07a" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">蓝牙测距技术非常流行。存在许多基于信标的定位系统。信标技术通常使用接收信号强度(RSSI)来估计设备之间的距离。</p><p id="d1f9" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">追踪某物时，蓝牙是在近距离缩小搜索范围的绝佳方式。这一特性可用于多个领域。例如建筑物和汽车的安全锁、资产定位和跟踪、室内导航等</p><p id="ef97" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">GPS 跟踪在提供近距离的精确测量方面并不出色，尤其是在室内环境中。另一方面，蓝牙在短距离内表现出色，因为电波可以穿透墙壁。这可能会填补 GPS 跟踪在室内空间跟踪设备时的空白。</p><p id="d059" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">然而，两个蓝牙设备之间的距离的大多数计算都是估计。很难确定两个蓝牙设备之间的准确距离，因为许多因素会影响计算。尽管存在挑战，但仍有方法可以确定两个蓝牙设备之间的距离，精确度至少为 80%。</p><p id="77b2" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">该测距方法实现简单，并且具有计算两个蓝牙设备之间距离的公式。顾名思义，这两种设备都需要在蓝牙范围内才能估计距离。</p><p id="eaa2" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">本文将分享一个简单的 python 脚本来确定附近的蓝牙设备及其距离(以米为单位)。</p><p id="8bb9" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">该脚本扫描附近的蓝牙设备，并通过使用众所周知的 RSSI 到距离公式获得距离的近似值。</p><p id="b2a7" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">阅读更多关于如何计算距离的信息</p><p id="b701" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated"><a class="ae kp" href="https://iotandelectronics.wordpress.com/2016/10/07/how-to-calculate-distance-from-the-rssi-value-of-the-ble-beacon/" rel="noopener ugc nofollow" target="_blank">如何根据 BLE 信标的 RSSI 值计算距离</a></p><h1 id="9b25" class="kq kr in bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">要求</h1><ul class=""><li id="9bbd" class="lo lp in jt b ju lq jy lr kc ls kg lt kk lu ko lv lw lx ly bi translated">【https://www.bleuio.com】蓝牙低能耗 USB 加密狗 BleuIO </li><li id="1fcc" class="lo lp in jt b ju lz jy ma kc mb kg mc kk md ko lv lw lx ly bi translated"><a class="ae kp" href="https://pypi.org/project/pyserial/" rel="noopener ugc nofollow" target="_blank"> Pyserial </a>。</li></ul><h1 id="e047" class="kq kr in bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">说明</h1><ul class=""><li id="e59e" class="lo lp in jt b ju lq jy lr kc ls kg lt kk lu ko lv lw lx ly bi translated">在<a class="ae kp" href="https://github.com/smart-sensor-devices-ab/python_bluetooth_device_distance_meter.git" rel="noopener ugc nofollow" target="_blank">https://GitHub . com/smart-sensor-devices-ab/python _ bluetooth _ device _ distance _ meter . git</a>从 GitHub 获取脚本</li><li id="52c6" class="lo lp in jt b ju lz jy ma kc mb kg mc kk md ko lv lw lx ly bi translated">将 BleuIO 连接到您的电脑。该脚本使用 pyserial 连接到蓝牙 USB 加密狗 BleuIO。</li><li id="15de" class="lo lp in jt b ju lz jy ma kc mb kg mc kk md ko lv lw lx ly bi translated">更新脚本并编写正确的 COM 端口，在该端口上连接加密狗。</li><li id="646a" class="lo lp in jt b ju lz jy ma kc mb kg mc kk md ko lv lw lx ly bi translated">连接到加密狗后，我们将加密狗置于中心角色，以便它可以扫描附近的蓝牙设备。</li><li id="f492" class="lo lp in jt b ju lz jy ma kc mb kg mc kk md ko lv lw lx ly bi translated">然后，我们使用 AT+GAPSCAN=3 命令进行简单的间隙扫描，扫描附近的蓝牙设备 3 秒钟。</li><li id="f6ee" class="lo lp in jt b ju lz jy ma kc mb kg mc kk md ko lv lw lx ly bi translated">之后，我们从串行端口读取输出，并使用我们的 RSSI 到距离公式来获得以米为单位的距离。</li><li id="33c6" class="lo lp in jt b ju lz jy ma kc mb kg mc kk md ko lv lw lx ly bi translated">最后，我们将结果按距离排序，然后在屏幕上打印出来。</li></ul><p id="3f81" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">这是最终的脚本文件。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="1e2a" class="mn kr in mj b gy mo mp l mq mr">import serial<br/>import time</span><span id="1f6e" class="mn kr in mj b gy ms mp l mq mr">your_com_port = "COM18"  # Change this to the com port your dongle is connected to.<br/>connecting_to_dongle = True</span><span id="4a2a" class="mn kr in mj b gy ms mp l mq mr">print("Connecting to dongle...")<br/># Trying to connect to dongle until connected. Make sure the port and baudrate is the same as your dongle.<br/># You can check in the device manager to see what port then right-click and choose properties then the Port Settings<br/># tab to see the other settings</span><span id="3cdf" class="mn kr in mj b gy ms mp l mq mr">while connecting_to_dongle:<br/>    try:<br/>        console = serial.Serial(<br/>            port=your_com_port,<br/>            baudrate=57600,<br/>            parity="N",<br/>            stopbits=1,<br/>            bytesize=8,<br/>            timeout=0,<br/>        )<br/>        if console.is_open.__bool__():<br/>            connecting_to_dongle = False<br/>    except:<br/>        print("Dongle not connected. Please reconnect Dongle.")<br/>        time.sleep(5)</span><span id="5d85" class="mn kr in mj b gy ms mp l mq mr">print("Connected to Dongle.")</span><span id="498b" class="mn kr in mj b gy ms mp l mq mr"># function to convert rssi to distance in meter<br/>def rssiToDistance(rssi):    <br/>  n=2<br/>  mp=-69<br/>  return round(10 ** ((mp - (int(rssi)))/(10 * n)),2)    </span><span id="e592" class="mn kr in mj b gy ms mp l mq mr">#put the dongle in dual role, so we can scan for nearby device<br/>console.write(str.encode("AT+CENTRAL"))<br/>console.write("\r".encode())<br/>print("Putting dongle in Central role.")<br/>time.sleep(0.1)<br/># Scan for nearby devices for 3 seconds<br/>console.write(str.encode("AT+GAPSCAN=3"))<br/>console.write("\r".encode())<br/>time.sleep(0.1)<br/>print("Looking for nearby Bluetooth devices ...")<br/>dongle_output2 = console.read(console.in_waiting)<br/>time.sleep(3)<br/>print("Scan Complete!")<br/>filtered = []<br/># Filter out unncecssary outputs and keep only the list of devices (also remove index)<br/>for dev in dongle_output2.decode().splitlines():<br/>    if len(dev)&gt;20:<br/>        filtered.append(dev.split(maxsplit=1)[1])<br/># Get unique device by device id and add distance to each raw        <br/>seen = set()<br/>out = []<br/>for elem in filtered:<br/>    prefix = elem.split(' ')[1]<br/>    if prefix not in seen:<br/>        seen.add(prefix)<br/>        out.append(elem + " Distance: "+str(rssiToDistance(elem.split()[3]))+" meter") </span><span id="0b64" class="mn kr in mj b gy ms mp l mq mr"># sort list by closest device<br/>out.sort(key=lambda x:int(x.split()[3]),reverse=True)</span><span id="c9dc" class="mn kr in mj b gy ms mp l mq mr"># print(out)<br/>for i in range(0, len(out)):<br/>    print (out[i]) </span><span id="d9da" class="mn kr in mj b gy ms mp l mq mr">time.sleep(0.1)<br/>console.close()</span></pre><h1 id="fd73" class="kq kr in bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">输出</h1><p id="b60f" class="pw-post-body-paragraph jr js in jt b ju lq jw jx jy lr ka kb kc mt ke kf kg mu ki kj kk mv km kn ko ig bi translated">运行脚本后，我们看到附近总共有 20 台设备。该列表以米为单位显示了它们与中央设备的距离。</p><figure class="me mf mg mh gt jo gh gi paragraph-image"><div class="gh gi mw"><img src="../Images/6cbb7e48ca2ea57cc60b102ff92fb41c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1150/format:webp/0*VFK4tGfYuG0fsPAY.png"/></div></figure></div></div>    
</body>
</html>