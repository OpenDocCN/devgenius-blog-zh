<html>
<head>
<title>Boost Root Cause Analysis Quickly With SkyWalking’s New Trace-Metrics Association Feature</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">借助 SkyWalking 的新跟踪指标关联功能，快速推进根本原因分析</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/boost-root-cause-analysis-quickly-with-skywalkings-new-trace-metrics-association-feature-64c1f4cf0691?source=collection_archive---------17-----------------------#2022-12-19">https://blog.devgenius.io/boost-root-cause-analysis-quickly-with-skywalkings-new-trace-metrics-association-feature-64c1f4cf0691?source=collection_archive---------17-----------------------#2022-12-19</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="d700" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">SkyWalking 9.3.0 引入了新的功能，可以帮助您快速可视化跟踪和相应指标之间的联系。</p><p id="3eb4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">由<strong class="jm io">吴声</strong></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/2d3d9f0f1e2da70c75da9748c090c3f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7Ej7SGM0PFEy15sn4zhoVA.png"/></div></div></figure><p id="c48f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现代分布式应用程序工作的可观测性对于理解它们在各种条件下的行为以及在出现问题时进行故障排除和解决问题是至关重要的。踪迹、度量和日志被认为是可观测性栈的基本部分。踪迹是分布式系统执行的足迹，同时，度量用时间线中的数字来度量系统性能。本质上，他们从两个维度来衡量绩效。能够快速可视化跟踪和相应度量之间的联系使得快速诊断哪些过程流与潜在的病理行为相关成为可能。这个强大的新功能现在<a class="ae ku" href="https://skywalking.apache.org/events/release-apache-skywalking-apm-9.3.0/" rel="noopener ugc nofollow" target="_blank">在天行者 9.3.0 </a>中可用。</p><p id="caa4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">天行项目从追踪开始，从 2018 年开始专注于 100%基于采样的度量和拓扑分析。当用户面对时间序列指标的异常趋势时，如折线图上的峰值，或直方图显示 p95 和 p99 之间的较大差距，直接的问题是，为什么会发生这种情况？SkyWalking 的最新功能之一，<strong class="jm io">轨迹度量协会</strong>，使得回答这个问题和解决根本原因变得更加容易。</p><h1 id="3595" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">指标是如何产生的？</h1><p id="95f4" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">天行道提供了三种计算指标的方法:</p><ol class=""><li id="3700" class="ly lz in jm b jn jo jr js jv ma jz mb kd mc kh md me mf mg bi translated">从跟踪跨度构建的度量，取决于跨度的层、种类和标签。</li><li id="a3d6" class="ly lz in jm b jn mh jr mi jv mj jz mk kd ml kh md me mf mg bi translated">从日志中提取的指标—一种基于关键字和标签的指标提取。</li><li id="3162" class="ly lz in jm b jn mh jr mi jv mj jz mk kd ml kh md me mf mg bi translated">来自成熟和主流度量/计量系统的度量报告，如 OpenTelemetry、Prometheus 和 Zabbix。</li></ol><p id="2006" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">跟踪跟踪应用程序服务之间的请求过程。大多数生成流量和性能相关指标的系统还会生成跟踪数据，这些数据要么来自服务器端基于跟踪的聚合，要么来自客户端 SDK。</p><h1 id="882d" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">使用天行道降低跟踪索引的传统成本</h1><p id="d6b6" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">跟踪数据和可视化对于开发人员和操作人员来说都是重要的故障排除工具，因为它们在定位问题边界方面非常有用。但是，因为传统上很难找到度量和轨迹之间的关联，团队已经向跨度中添加了越来越多的标签，并通过各种组合进行搜索。这种增加仪器和搜索的趋势要求增加基础设施投资来支持这种搜索。SkyWalking 的指标和追踪关联功能有助于降低索引和搜索这些数据的成本。</p><h1 id="9ab7" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">查找相关的跟踪</h1><p id="d24d" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">当寻找度量和跟踪之间的关联时，我们处理的度量的种类决定了它们与跟踪的关系。让我们回顾一下标准的请求<em class="mm">比率、错误和持续时间(红色)</em>指标，看看它是如何工作的。</p><h1 id="e93e" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">成功率指标</h1><p id="0004" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">成功率由返回代码、RPC 响应代码或进程异常决定。当成功率降低时，在这个服务或 pod 的痕迹中寻找错误是寻找线索的第一个地方。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mn"><img src="../Images/734ddf16a74ed8327d9ae4388f522e47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0wSBKqlZHnijYoBES9McDA.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated"><em class="ms">图 1:SkyWalking 9 . 3 . 0 仪表盘上的成功率图表，可以选择查看特定时间的相关跟踪。</em></figcaption></figure><p id="63ed" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">从成功率的峰值向下钻取，SkyWalking 列出了在这一特定分钟内收集的所有跟踪及其错误状态(图 2):</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mt"><img src="../Images/731f04a442b69de0f84a620c130d777b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N9KQKWxoTwoOhbzQMHQ2CQ.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated"><em class="ms">图 2: SkyWalking 显示了带有错误状态的相关踪迹。</em></figcaption></figure><p id="ad07" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">对<em class="mm"> /test </em>的请求可以从跟踪中定位，span 的标签指示 HTTP 请求的 404 响应代码。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mt"><img src="../Images/1d885533053c50733346e577a38cf79c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v8isvNxF9HqTB20UVBxYRA.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated"><em class="ms">图 3:对</em><a class="ae ku" href="http://frontend/test" rel="noopener ugc nofollow" target="_blank"><em class="ms">http://frontend/test</em></a><em class="ms">的请求的详细视图，显示 URI 不存在。</em></figcaption></figure><p id="b009" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">通过查看跟踪数据，很明显成功率的下降是由对不存在的 URI 的请求引起的。</p><h1 id="9ed9" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">平均响应时间</h1><p id="7a91" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">平均响应时间度量提供了服务性能的概述。当平均响应时间不稳定时，这通常意味着系统面临严重的性能影响。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mu"><img src="../Images/e4d2939dc68ca103bb0334d0159cca87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G2HjfrHulvyRgGwHR9F8Aw.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated"><em class="ms">图 4: SkyWalking 用于搜索相关跟踪的查询 UI，显示了超过特定持续时间阈值的请求的跟踪。</em></figcaption></figure><p id="f8f4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">当您从这个指标向下钻取时，这个查询条件(图 4)将揭示这个特定分钟内最慢的服务跟踪。请注意，至少 168 毫秒被自动添加为条件，以避免扫描数据库中的大量行。</p><h1 id="27c0" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">Apdex</h1><p id="9396" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">AP dex——应用程序性能指数——是根据设定的阈值来衡量响应时间的指标。它测量满意的响应时间与不满意的响应时间的比率(图 5)。响应时间是从资产请求到完成交付返回给请求者的时间。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mv"><img src="../Images/e09c9eb4be32b9dbe35149bdf04b990c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GBpTOP-OoNUQOKUMPcZHuQ.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated"><em class="ms">图 Apdex 公式</em></figcaption></figure><p id="bea9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">用户定义响应时间容许阈值<em class="mm"> T </em>。在<em class="mm"> T </em>或更短时间内处理的所有响应都令用户满意。</p><p id="46c0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">例如，如果<em class="mm"> T </em>是 1.2 秒，而一个响应在 0.5 秒内完成，那么用户是满意的。所有大于 1.2 秒的响应都令用户不满意。超过 4.8 秒的响应会让用户感到沮丧。</p><p id="eed2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">当 Apdex 分值降低时，我们需要从两个角度寻找相关痕迹:慢速痕迹和错误状态痕迹。SkyWalking 新的相关跟踪功能提供了一种直接从 Apdex 图中快速查看二者的方法(图 6)。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mw"><img src="../Images/e898d2aaaa4ebf2937cfc28eb3300f8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/format:webp/1*6MurZq1viFIHqUd2_A444w.png"/></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated"><em class="ms">图 6:显示来自 Apdex 图的慢速跟踪和错误状态跟踪</em></figcaption></figure><h1 id="bed1" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">服务响应时间</h1><p id="07a2" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">百分比指标百分比图(图 7)提供了 p50、p75、p90、p95 和 p99 延迟等级，用于衡量服务性能的长尾问题。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mx"><img src="../Images/079d41253ffc71fdd7adbf60eb4981c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*YDYtPCornICKDsuUnbFruQ.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated"><em class="ms">图 7:服务响应时间百分比图有助于突出服务性能的长尾问题。</em></figcaption></figure><p id="e340" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这个百分比图显示了一个典型的长尾问题。P99 的延迟比 P95 慢四倍。当我们使用这种关联时，我们会看到延迟在 P95 — P99 和 P99 —无穷大之间的轨迹。</p><p id="0f7a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">导致这种长尾现象的请求的踪迹会自动从那里列出来。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi my"><img src="../Images/90d162df84059c390d152f34a7891da8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_1OywIGYXmS6bNeW3UrKjg.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated"><em class="ms">图 8:基于延迟搜索踪迹的查询参数。</em></figcaption></figure><h1 id="cb28" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">是否有更多可用的关联？</h1><p id="7672" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">SkyWalking 提供的不仅仅是踪迹和度量之间的关联，它还可以帮助您找到可能的因果关系，避免大海捞针。</p><p id="9988" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">目前，SkyWalking 9.3.0 提供了另外两个关联:<strong class="jm io">度量到度量</strong>关联和<strong class="jm io">事件到度量</strong>关联。</p><h1 id="a3dc" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">度量到度量的关联</h1><p id="3179" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">仪表板上有几十个指标，这对于全面了解应用程序行为非常有用。在典型的性能问题中，多个指标的峰值同时受到影响。但是，尝试关联所有这些图中的峰值可能会很困难…</p><p id="3b8c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在，在 SkyWalking 9.3.0 中，当您单击一个图形的峰值时，弹出框会让您看到相关的指标。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mz"><img src="../Images/866b5c65f378aab5a5bbf41d011ecad3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1252/format:webp/1*qnuwk3raL39T1p2xZqLsVA.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated"><em class="ms">图 9: SkyWalking 查看相关指标的选项。</em></figcaption></figure><p id="04bb" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">当您选择该选项时，所有关联的度量图将在所有关联的图中显示轴指针(垂直虚线),如图 10 所示。这使得不同图表中的峰值更容易相互关联。通常，这些相关的峰值具有相同的根本原因。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mt"><img src="../Images/f24b1020024109132c4ac4c394ab6f60.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g47C8sLWlTMWi7LCb4DNVQ.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated"><em class="ms">图 10:轴指针(垂直虚线)显示了多个指标图的峰值之间的关联。</em></figcaption></figure><h1 id="40eb" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">事件与指标的关联</h1><p id="9724" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">SkyWalking 提供了事件概念来关联受基础设施影响的可能服务性能，例如甚至来自 k8s 的新部署。或者，异常已被警报或集成 AIOps 引擎检测到。</p><p id="585d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">事件与指标的关联也是自动的，它可以覆盖指标图上事件的时间范围(蓝色区域)。如果事件的面积和峰值相匹配，则该事件很可能覆盖了这一异常。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mt"><img src="../Images/6a86c54b9e9c684eac0896a31d022338.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vwzmKRlWvSvbcs6avx5N_Q.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated"><em class="ms">图 11: SkyWalking 的事件到度量关联视图。</em></figcaption></figure><h1 id="7853" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">空中行走使寻找根本原因变得更容易、更快</h1><p id="de89" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">SkyWalking 现在可以很容易地找到度量、事件和跟踪之间的关联，最终可以快速确定根本原因并修复问题。我们在本文中讨论的关联在 SkyWalking 9.3.0 版本中是现成可用的。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mn"><img src="../Images/77d0e81d1ffa6fd7e8c857ec3b9cb431.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tKxGM2cHBMnZ4_dcsuzSCw.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated"><em class="ms">图 12:只需点击圆点即可查看相关的跟踪和指标关联。</em></figcaption></figure><p id="3dcc" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">单击任何指标图上的点，如果该指标有逻辑映射跟踪，您将看到一个<em class="mm">视图相关跟踪</em>项目弹出。</p><h1 id="8cbb" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">结论</h1><p id="87cb" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">在这篇博客中，我们看了一下新添加的度量和跟踪之间的关联特性。有了这种新的可视化技术，现在可以更容易地找到关键痕迹来确定问题的根本原因。高空行走的关联甚至可以更深。从度量到跟踪的关联并不是诊断系统瓶颈的终点。在下一篇文章中，我们将介绍一个 eBPF 支持的跟踪增强，您将能够从网络概要中看到与跟踪范围相关的 HTTP 请求和响应细节。敬请关注。</p></div></div>    
</body>
</html>