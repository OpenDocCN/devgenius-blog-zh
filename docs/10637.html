<html>
<head>
<title>Elasticsearch in Action: Pinned and More Like This Queries</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Elasticsearch in Action: Pinned 和更多类似的查询</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/elasticsearch-in-action-pinned-and-more-like-this-queries-52f8a30e8f7c?source=collection_archive---------4-----------------------#2022-11-18">https://blog.devgenius.io/elasticsearch-in-action-pinned-and-more-like-this-queries-52f8a30e8f7c?source=collection_archive---------4-----------------------#2022-11-18</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jm jn jo jp gh gi paragraph-image"><div class="gh gi jl"><img src="../Images/95a3991b60dc7d79ed2993deb247df4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*nVXtNoFBzDjIvnz-Use6yg.png"/></div><figcaption class="js jt gj gh gi ju jv bd b be z dk translated">节选自我即将出版的书:弹性搜索在行动</figcaption></figure><p id="4a55" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">在接下来的几个月里，我将把这些短小精悍的文章以迷你系列的形式呈现在大家面前。节选自我的书<a class="ae kv" href="https://www.manning.com/books/elasticsearch-in-action-second-edition?utm_source=mkonda&amp;utm_medium=affiliate&amp;utm_campaign=book_konda_elasticsearch_7_23_21&amp;a_aid=mkonda&amp;a_bid=edbc50d4" rel="noopener ugc nofollow" target="_blank"><em class="ku">elastic search in Action，第二版</em> </a> <em class="ku">。代码在我的</em><a class="ae kv" href="https://github.com/madhusudhankonda" rel="noopener ugc nofollow" target="_blank"><em class="ku">GitHub</em></a><em class="ku">库中。您可以在存储库中找到可执行的 Kibana 脚本，这样您就可以直接在 Kibana 中运行命令。所有代码都根据 Elasticsearch 8.4 版本进行了测试。</em></p></div><div class="ab cl kw kx hr ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ig ih ii ij ik"><p id="51e0" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">Elasticsearch 有一些专门服务于特殊功能的高级查询。例如，使用<code class="fe ld le lf lg b">more_like_this</code>查询找到看起来相似的文档，或者使用<code class="fe ld le lf lg b">pinned</code>查询赋予一些文档更高的重要性，等等。在这篇短文中，我们将了解这两个查询。</p><h1 id="4f75" class="lh li in bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">固定查询</h1><p id="b591" class="pw-post-body-paragraph jw jx in jy b jz mf kb kc kd mg kf kg kh mh kj kk kl mi kn ko kp mj kr ks kt ig bi translated">当查询你最喜欢的电子商务网站如亚马逊时，你可能会看到一些赞助搜索结果出现在结果集的顶部。假设我们想使用 Elasticsearch 在应用程序中实现这样的功能。好吧，不要烦恼；一个<code class="fe ld le lf lg b">pinned</code>的疑问就在眼前。</p><p id="a8b3" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated"><code class="fe ld le lf lg b">pinned</code>查询有助于将选择的文档添加到结果集中，这样它们就会出现在列表的顶部。这是通过使他们的相关性得分高于其他人来实现的。让我们快速查看一个示例查询，在下面的清单中给出，它演示了这个功能。</p><pre class="mk ml mm mn gt mo lg mp bn mq mr bi"><span id="35e3" class="ms li in lg b be mt mu l mv mw">GET iphones/_search<br/>{<br/>  "query": {<br/>    "pinned":{ <br/>      "ids":["1","3"], <br/>      "organic":{ <br/>        "match":{ <br/>          "name":"iPhone 12"<br/>        }<br/>      }<br/>    }<br/>  }<br/>}</span></pre><p id="8510" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">清单中的<code class="fe ld le lf lg b">pinned</code>查询有几个移动部分:<code class="fe ld le lf lg b">organic</code>和<code class="fe ld le lf lg b">ids</code>块。</p><p id="339b" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">我们先来看一下<code class="fe ld le lf lg b">organic</code>块。它是容纳搜索查询的查询块；在本例中，我们在 iPhone 索引中搜索 iPhone 12。这个查询<em class="ku">理想情况下</em>应该返回两个文档:iPhone 12 和 iPhone 12 Mini。</p><p id="7098" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">但是，当您使用数据运行这个查询时(检查我的 GitHub repo 中的查询和数据)，您会收到文档 iPhone 和 iPhone 13(这两个是<em class="ku">而不是</em> iPhone 12！)除了 iPhone 12 和 iPhone 12 Mini。</p><p id="8409" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">原因在于<code class="fe ld le lf lg b">ids</code>字段。该字段包含必须附加到结果并显示在列表顶部的附加文档(由<em class="ku">赞助的</em>结果)，从而综合创建更高的相关性分数。</p><p id="49c1" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated"><code class="fe ld le lf lg b">pinned</code>查询有助于为结果集添加额外的高优先级文档。这些文档胜过列表位置中的其他文档来创建赞助结果。</p><p id="6209" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">您可能想知道固定的结果是否有任何得分:一个或一些固定的结果可以优先于其他结果吗？不幸的是，答案是否定的。这些文档按照我们在查询中输入的 id 顺序显示:例如:<code class="fe ld le lf lg b">"ids":["1", "3"]</code>。</p><p id="aa13" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">本文中的另一个查询是“更像这样”，这是下一节的主题。</p><h1 id="7104" class="lh li in bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">查看更像这样(more_like_this)查询</h1><p id="561e" class="pw-post-body-paragraph jw jx in jy b jz mf kb kc kd mg kf kg kh mh kj kk kl mi kn ko kp mj kr ks kt ig bi translated">你可能已经注意到，当你浏览其中一部电影时，网飞或亚马逊 Prime Video(或你最喜欢的流媒体应用程序之一)会向你展示更像这部的<em class="ku">电影。例如，图 12.13 显示了我访问帕丁顿 2 时所有类似的电影。</em></p><figure class="mk ml mm mn gt jp gh gi paragraph-image"><div class="gh gi mx"><img src="../Images/d8c564fd69ea5747e0eb6aa42e868c31.png" data-original-src="https://miro.medium.com/v2/resize:fit:630/format:webp/1*xYM9l4qq-4xof-beVKALag.png"/></div><figcaption class="js jt gj gh gi ju jv bd b be z dk translated"><strong class="bd lj">图 12.13 观看更多此类电影</strong></figcaption></figure><p id="1794" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">用户的需求之一是在一些文档中搜索“相似”或“类似”。比如研究类似 COVID 和 SARS 的论文，或者查询类似<em class="ku">教父</em>的电影。让我们直接看一个例子来更好地理解用例。</p><p id="9f7b" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">假设我们正在收集一些人的资料列表。为了创建一组概要文件，我们将样本文档索引到概要文件索引中，如下面清单中的代码所示。</p><pre class="mk ml mm mn gt mo lg mp bn mq mr bi"><span id="68b3" class="ms li in lg b be mt mu l mv mw">PUT profiles/_doc/1<br/>{<br/>  "name":"John Smith",<br/>  "profile":"John Smith is a capable carpenter"<br/>}<br/><br/>PUT profiles/_doc/2<br/>{<br/>  "name":"John Smith Patterson",<br/>  "profile":"John Smith Patterson is a pretty plumber"<br/>}<br/><br/>PUT profiles/_doc/3<br/>{<br/>  "name":"Smith Sotherby",<br/>  "profile":"Smith Sotherby is a gentle painter"<br/>}<br/>PUT profiles/_doc/4<br/>{<br/>  "name":"Frances Sotherby",<br/>  "profile":"Frances Sotherby is a gentleman"<br/>}</span></pre><p id="b948" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">这些文件没什么好奇怪的；它们只是一群普通人的侧写。现在我们已经索引了这些文档，让我们看看如何让 Elasticsearch 获取与文本<em class="ku">温柔的画家</em>或<em class="ku">能干的木匠</em>相似的文档，甚至检索具有相似名称的文档，Sotherby。</p><p id="cdfe" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">这正是<code class="fe ld le lf lg b">more_like_this</code>查询帮助我们的。下一个清单创建了一个查询来搜索更像 Sotherby 的概要文件。</p><pre class="mk ml mm mn gt mo lg mp bn mq mr bi"><span id="c844" class="ms li in lg b be mt mu l mv mw">GET profiles/_search<br/>{<br/>  "query": {<br/>    "more_like_this": { <br/>      "fields": ["name", "profile"], <br/>      "like": "Sotherby", <br/>      "min_term_freq": 1, <br/>      "max_query_terms": 12, <br/>      "min_doc_freq":1<br/>    }<br/>  }<br/>}</span></pre><p id="e67d" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated"><code class="fe ld le lf lg b">more_like_this</code>查询接受<code class="fe ld le lf lg b">like</code>参数中的文本，该输入文本与<code class="fe ld le lf lg b">fields</code>参数中提到的给定字段相匹配。该查询接受一些调优参数，比如查询应该选择的最小术语和文档频率(<code class="fe ld le lf lg b">min_term</code>)以及最大术语数量(<code class="fe ld le lf lg b">max_query_terms</code>)。如果我们想在显示相似文档时给用户更好的体验，那么<code class="fe ld le lf lg b">more_like_this</code>查询是正确的选择。</p><p id="f97f" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">这差不多就是关于<code class="fe ld le lf lg b">pinned</code>和<code class="fe ld le lf lg b">more_like_this</code>查询的内容。</p><p id="2080" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">不要鼓掌:)</p><p id="88b8" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated">还是<a class="ae kv" href="https://mkonda007.medium.com/" rel="noopener">不要跟着</a>我:)</p></div><div class="ab cl kw kx hr ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ig ih ii ij ik"><p id="ee58" class="pw-post-body-paragraph jw jx in jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ig bi translated"><em class="ku">这些短文节选自我的书</em><a class="ae kv" href="https://www.manning.com/books/elasticsearch-in-action-second-edition?utm_source=mkonda&amp;utm_medium=affiliate&amp;utm_campaign=book_konda_elasticsearch_7_23_21&amp;a_aid=mkonda&amp;a_bid=edbc50d4" rel="noopener ugc nofollow" target="_blank"><em class="ku">elastic search in Action，第二版</em> </a> <em class="ku">。代码在我的</em><a class="ae kv" href="https://github.com/madhusudhankonda" rel="noopener ugc nofollow" target="_blank"><em class="ku">GitHub</em></a><em class="ku">库中。</em></p><figure class="mk ml mm mn gt jp gh gi paragraph-image"><div class="gh gi jl"><img src="../Images/95a3991b60dc7d79ed2993deb247df4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*nVXtNoFBzDjIvnz-Use6yg.png"/></div><figcaption class="js jt gj gh gi ju jv bd b be z dk translated">行动中的弹性研究</figcaption></figure></div></div>    
</body>
</html>