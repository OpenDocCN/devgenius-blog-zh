<html>
<head>
<title>K8s — Why Use nerdctl for containerd</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">K8s —为什么对 containerd 使用 nerdctl</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/k8s-why-use-nerdctl-for-containerd-f4ea49bcf900?source=collection_archive---------1-----------------------#2022-11-14">https://blog.devgenius.io/k8s-why-use-nerdctl-for-containerd-f4ea49bcf900?source=collection_archive---------1-----------------------#2022-11-14</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><div class=""/><div class=""><h2 id="027e" class="pw-subtitle-paragraph jo iq ir bd b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dk translated">什么是 nerdctl？</h2></div><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div class="gi gj kg"><img src="../Images/1126a9908790df516d4e89af3c80cb78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1134/format:webp/0*b40KLN4klBguzya5.png"/></div></figure><p id="c8a8" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">在我的 K8s 文章——《<a class="ae lk" href="https://medium.com/nerd-for-tech/k8s-why-deprecating-docker-5d1eccde0775" rel="noopener">为什么弃用 Docker </a>》中，我解释了为什么 K8s 从 v1.24 开始弃用<code class="fe ll lm ln lo b">Docker</code>(准确的说是<code class="fe ll lm ln lo b">dockershim</code>)，而<code class="fe ll lm ln lo b">containerd</code>是新的默认容器运行时。因此，<code class="fe ll lm ln lo b">Docker</code>命令行工具不再起作用，需要一个新的工具来进行容器级故障排除。</p><h1 id="eb8b" class="lp lq ir bd lr ls lt lu lv lw lx ly lz jx ma jy mb ka mc kb md kd me ke mf mg bi translated">为什么 Docker CLI 不再工作？</h1><p id="0bb1" class="pw-post-body-paragraph ko kp ir kq b kr mh js kt ku mi jv kw kx mj kz la lb mk ld le lf ml lh li lj ik bi translated"><code class="fe ll lm ln lo b">containerd</code>支持容器运行时级别的名称空间。这些名称空间与 K8s 名称空间完全不同。<code class="fe ll lm ln lo b">containerd</code>名称空间用于隔离可能使用<code class="fe ll lm ln lo b">containerd</code>的不同应用程序，如 docker、kubelet 等。下面是两个众所周知的名称空间。</p><ul class=""><li id="cbf3" class="mm mn ir kq b kr ks ku kv kx mo lb mp lf mq lj mr ms mt mu bi translated">K8s.io :包含 kubelet 从 CRI 插件启动的所有容器，与 Kubernetes 中的名称空间无关</li><li id="2a3d" class="mm mn ir kq b kr mv ku mw kx mx lb my lf mz lj mr ms mt mu bi translated"><strong class="kq is"> moby </strong>:包含 docker 启动的所有容器</li></ul><p id="fd12" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">由于<code class="fe ll lm ln lo b">containerd</code>允许不同的应用使用不同的名称空间，所以在直接与<code class="fe ll lm ln lo b">containerd</code>交互时，必须提供<code class="fe ll lm ln lo b">k8s.io</code>作为名称空间。所有启动的容器都被添加到<code class="fe ll lm ln lo b">k8s.io</code>名称空间中。因此，CLI 无法再看到这些容器。</p><h1 id="cb2f" class="lp lq ir bd lr ls lt lu lv lw lx ly lz jx ma jy mb ka mc kb md kd me ke mf mg bi translated">为什么不是 CTR？</h1><p id="17dc" class="pw-post-body-paragraph ko kp ir kq b kr mh js kt ku mi jv kw kx mj kz la lb mk ld le lf ml lh li lj ik bi translated"><code class="fe ll lm ln lo b">containerd</code>已经有了自己的名为<code class="fe ll lm ln lo b">ctr</code>的 CLI，但是<code class="fe ll lm ln lo b">ctr</code>仅用于测试目的，用于测试<code class="fe ll lm ln lo b">containerd</code>的底层功能。<code class="fe ll lm ln lo b">ctr</code>的设计不太用户友好，缺少很多<code class="fe ll lm ln lo b">docker</code>的 CLI 特性，如<code class="fe ll lm ln lo b">docker run</code>、<code class="fe ll lm ln lo b">docker pull</code>、<code class="fe ll lm ln lo b">docker logs</code>等。如果你看一下<code class="fe ll lm ln lo b">ctr</code>的参数，你会发现它非常有限:</p><pre class="kh ki kj kk gu na lo nb nc aw nd bi"><span id="c619" class="ne lq ir lo b gz nf ng l nh ni">containerd CLI<br/></span><span id="6dd0" class="ne lq ir lo b gz nj ng l nh ni">USAGE:<br/>   ctr [global options] command [command options] [arguments...]</span><span id="6b04" class="ne lq ir lo b gz nj ng l nh ni">VERSION:<br/>   v1.6.8</span><span id="1bfd" class="ne lq ir lo b gz nj ng l nh ni">DESCRIPTION:</span><span id="a0c2" class="ne lq ir lo b gz nj ng l nh ni">ctr is an unsupported debug and administrative client for interacting<br/>with the containerd daemon. Because it is unsupported, the commands,<br/>options, and operations are not guaranteed to be backward compatible or<br/>stable from release to release of the containerd project.</span><span id="1f92" class="ne lq ir lo b gz nj ng l nh ni">COMMANDS:<br/>   plugins, plugin            provides information about containerd plugins<br/>   version                    print the client and server versions<br/>   containers, c, container   manage containers<br/>   content                    manage content<br/>   events, event              display containerd events<br/>   images, image, i           manage images<br/>   leases                     manage leases<br/>   namespaces, namespace, ns  manage namespaces<br/>   pprof                      provide golang pprof outputs for containerd<br/>   run                        run a container<br/>   snapshots, snapshot        manage snapshots<br/>   tasks, t, task             manage tasks<br/>   install                    install a new package<br/>   oci                        OCI tools<br/>   shim                       interact with a shim directly<br/>   help, h                    Shows a list of commands or help for one command</span></pre><p id="9752" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">甚至在它的帮助手册中也提到“<strong class="kq is"> ctr 是一个不支持的调试和管理客户端，用于与 containerd 守护进程</strong>交互”。所以不建议使用<code class="fe ll lm ln lo b">ctr</code>作为生产<code class="fe ll lm ln lo b">containerd</code>故障排除工具，除非真的不得已。</p><h1 id="0283" class="lp lq ir bd lr ls lt lu lv lw lx ly lz jx ma jy mb ka mc kb md kd me ke mf mg bi translated">为什么不是克里特？</h1><p id="16d9" class="pw-post-body-paragraph ko kp ir kq b kr mh js kt ku mi jv kw kx mj kz la lb mk ld le lf ml lh li lj ik bi translated"><code class="fe ll lm ln lo b">crictl</code>是一个符合 CRI 接口规范的命令行工具，通常用于检查和管理 kubelet 节点上的容器运行时和映像。</p><p id="9a2a" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">一般来说，你<a class="ae lk" rel="noopener ugc nofollow" target="_blank" href="/install-k8s-v1-25-on-amazon-linux-2-e2a717444736">在主机</a>上安装 k8s 后，命令行会有<code class="fe ll lm ln lo b">crictl</code>命令。而<code class="fe ll lm ln lo b">ctr</code>与 k8s 无关，你可以在你的主机上安装好<code class="fe ll lm ln lo b">containerd</code>服务后操作<code class="fe ll lm ln lo b">ctr</code>命令。</p><p id="f981" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">与<code class="fe ll lm ln lo b">ctr</code>相比，<code class="fe ll lm ln lo b">crictl</code>肯定更好，但是它的功能和 UI/UX 有类似于<code class="fe ll lm ln lo b">ctr</code>的限制。它与 Docker CLI 不兼容，对用户不友好，并且不支持非 CRI 功能。<code class="fe ll lm ln lo b">critcl</code>的帮助手册如下:</p><pre class="kh ki kj kk gu na lo nb nc aw nd bi"><span id="59b7" class="ne lq ir lo b gz nf ng l nh ni">NAME:<br/>   crictl - client for CRI</span><span id="a3ad" class="ne lq ir lo b gz nj ng l nh ni">USAGE:<br/>   crictl [global options] command [command options] [arguments...]</span><span id="6317" class="ne lq ir lo b gz nj ng l nh ni">VERSION:<br/>   v1.25.0</span><span id="2e70" class="ne lq ir lo b gz nj ng l nh ni">COMMANDS:<br/>   attach              Attach to a running container<br/>   create              Create a new container<br/>   exec                Run a command in a running container<br/>   version             Display runtime version information<br/>   images, image, img  List images<br/>   inspect             Display the status of one or more containers<br/>   inspecti            Return the status of one or more images<br/>   imagefsinfo         Return image filesystem info<br/>   inspectp            Display the status of one or more pods<br/>   logs                Fetch the logs of a container<br/>   port-forward        Forward local port to a pod<br/>   ps                  List containers<br/>   pull                Pull an image from a registry<br/>   run                 Run a new container inside a sandbox<br/>   runp                Run a new pod<br/>   rm                  Remove one or more containers<br/>   rmi                 Remove one or more images<br/>   rmp                 Remove one or more pods<br/>   pods                List pods<br/>   start               Start one or more created containers<br/>   info                Display information of the container runtime<br/>   stop                Stop one or more running containers<br/>   stopp               Stop one or more running pods<br/>   update              Update one or more running containers<br/>   config              Get and set crictl client configuration options<br/>   stats               List container(s) resource usage statistics<br/>   statsp              List pod resource usage statistics<br/>   completion          Output shell completion code<br/>   checkpoint          Checkpoint one or more running containers<br/>   help, h             Shows a list of commands or help for one command</span></pre><h1 id="7eb2" class="lp lq ir bd lr ls lt lu lv lw lx ly lz jx ma jy mb ka mc kb md kd me ke mf mg bi translated">为什么选择 NERDCTL？</h1><p id="da91" class="pw-post-body-paragraph ko kp ir kq b kr mh js kt ku mi jv kw kx mj kz la lb mk ld le lf ml lh li lj ik bi translated"><code class="fe ll lm ln lo b">nerdctl</code>是一个兼容 Docker 的 CLI，用于<code class="fe ll lm ln lo b">containerd</code>。<code class="fe ll lm ln lo b">nerdctl</code>的目标是方便试验<code class="fe ll lm ln lo b">containerd</code>的尖端特性，这些特性在 Docker 中是没有的。这种特性包括但不限于延迟拉取(stargz)和图像加密(ocicrypt)。</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="nl nm di nn bf no"><div class="gi gj nk"><img src="../Images/c3802b885a7a3f8ad50247e16d876cac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*w78gKMLDjncelJ_Z.png"/></div></div><figcaption class="np nq gk gi gj nr ns bd b be z dk translated">图片来自<a class="ae lk" href="https://miro.medium.com/max/828/1*LmweG-X0gfcWHjHJ-A-W3w.png" rel="noopener">须田昭宏</a></figcaption></figure><p id="85db" class="pw-post-body-paragraph ko kp ir kq b kr ks js kt ku kv jv kw kx ky kz la lb lc ld le lf lg lh li lj ik bi translated">快速浏览<code class="fe ll lm ln lo b">nerdctl</code>帮助手册:</p><pre class="kh ki kj kk gu na lo nb nc aw nd bi"><span id="8039" class="ne lq ir lo b gz nf ng l nh ni">nerdctl is a command line interface for containerd</span><span id="442f" class="ne lq ir lo b gz nj ng l nh ni">Config file ($NERDCTL_TOML): /etc/nerdctl/nerdctl.toml</span><span id="a828" class="ne lq ir lo b gz nj ng l nh ni">Usage: nerdctl [flags]</span><span id="d8a9" class="ne lq ir lo b gz nj ng l nh ni">Management commands:<br/>  apparmor   Manage AppArmor profiles<br/>  builder    Manage builds<br/>  container  Manage containers<br/>  image      Manage images<br/>  ipfs       Distributing images on IPFS<br/>  namespace  Manage containerd namespaces<br/>  network    Manage networks<br/>  system     Manage containerd<br/>  volume     Manage volumes</span><span id="b3ce" class="ne lq ir lo b gz nj ng l nh ni">Commands:<br/>  build       Build an image from a Dockerfile. Needs buildkitd to be running.<br/>  commit      Create a new image from a container's changes<br/>  completion  Generate the autocompletion script for the specified shell<br/>  compose     Compose<br/>  cp          Copy files/folders between a running container and the local filesystem.<br/>  create      Create a new container. Optionally specify "ipfs://" or "ipns://" scheme to pull image from IPFS.<br/>  events      Get real time events from the server<br/>  exec        Run a command in a running container<br/>  help        Help about any command<br/>  history     Show the history of an image<br/>  images      List images<br/>  info        Display system-wide information<br/>  inspect     Return low-level information on objects.<br/>  internal    DO NOT EXECUTE MANUALLY<br/>  kill        Kill one or more running containers<br/>  load        Load an image from a tar archive or STDIN<br/>  login       Log in to a container registry<br/>  logout      Log out from a container registry<br/>  logs        Fetch the logs of a container. Currently, only containers created with `nerdctl run -d` are supported.<br/>  pause       Pause all processes within one or more containers<br/>  port        List port mappings or a specific mapping for the container<br/>  ps          List containers<br/>  pull        Pull an image from a registry. Optionally specify "ipfs://" or "ipns://" scheme to pull image from IPFS.<br/>  push        Push an image or a repository to a registry. Optionally specify "ipfs://" or "ipns://" scheme to push image to IPFS.<br/>  rename      rename a container<br/>  restart     Restart one or more running containers<br/>  rm          Remove one or more containers<br/>  rmi         Remove one or more images<br/>  run         Run a command in a new container. Optionally specify "ipfs://" or "ipns://" scheme to pull image from IPFS.<br/>  save        Save one or more images to a tar archive (streamed to STDOUT by default)<br/>  start       Start one or more running containers<br/>  stats       Display a live stream of container(s) resource usage statistics.<br/>  stop        Stop one or more running containers<br/>  tag         Create a tag TARGET_IMAGE that refers to SOURCE_IMAGE<br/>  top         Display the running processes of a container<br/>  unpause     Unpause all processes within one or more containers<br/>  update      Update one or more running containers<br/>  version     Show the nerdctl version information<br/>  wait        Block until one or more containers stop, then print their exit codes.</span></pre><h1 id="8712" class="lp lq ir bd lr ls lt lu lv lw lx ly lz jx ma jy mb ka mc kb md kd me ke mf mg bi translated">要安装 nerdctl:</h1><p id="6925" class="pw-post-body-paragraph ko kp ir kq b kr mh js kt ku mi jv kw kx mj kz la lb mk ld le lf ml lh li lj ik bi translated">你可以从 github repo 下载<code class="fe ll lm ln lo b">nerdctl</code>二进制:<a class="ae lk" href="https://github.com/containerd/nerdctl/releases" rel="noopener ugc nofollow" target="_blank">https://github.com/containerd/nerdctl/releases</a>。但是，在开始使用它之前，应该满足以下先决条件:</p><ul class=""><li id="ed16" class="mm mn ir kq b kr ks ku kv kx mo lb mp lf mq lj mr ms mt mu bi translated"><code class="fe ll lm ln lo b">containerd</code>已安装并正在运行</li><li id="d997" class="mm mn ir kq b kr mv ku mw kx mx lb my lf mz lj mr ms mt mu bi translated"><code class="fe ll lm ln lo b">cni</code>为使用<code class="fe ll lm ln lo b">nerdctl run</code>而安装的插件(https://github.com/containernetworking/plugins)</li><li id="741a" class="mm mn ir kq b kr mv ku mw kx mx lb my lf mz lj mr ms mt mu bi translated">build kit(https://github . com/Moby/build kit):如果您想构建图像</li></ul><pre class="kh ki kj kk gu na lo nb nc aw nd bi"><span id="c269" class="ne lq ir lo b gz nf ng l nh ni"><em class="nt"># Download binary</em><br/>$ wget https://github.com/containerd/nerdctl/releases/download/v1.0.0/nerdctl-1.0.0-linux-amd64.tar.gz</span><span id="e084" class="ne lq ir lo b gz nj ng l nh ni"><em class="nt"># Unzip</em><br/>$ mkdir nerdctl-source<br/>$ mv nerdctl-1.0.0-linux-amd64.tar.gz nerdctl-source/<br/>$ cd nerdctl-source<br/>$ tar -xzvf nerdctl-1.0.0-linux-amd64.tar.gz<br/>$ mv nerdctl /usr/local/bin</span></pre><h1 id="0012" class="lp lq ir bd lr ls lt lu lv lw lx ly lz jx ma jy mb ka mc kb md kd me ke mf mg bi translated">命令参考</h1><p id="a2bf" class="pw-post-body-paragraph ko kp ir kq b kr mh js kt ku mi jv kw kx mj kz la lb mk ld le lf ml lh li lj ik bi translated">下面列出了一些<code class="fe ll lm ln lo b">docker</code>类似的命令参考，完整列表请访问<a class="ae lk" href="https://github.com/containerd/nerdctl." rel="noopener ugc nofollow" target="_blank">https://github.com/containerd/nerdctl.</a></p><ul class=""><li id="6ddf" class="mm mn ir kq b kr ks ku kv kx mo lb mp lf mq lj mr ms mt mu bi translated"><strong class="kq is"> nerdctl run </strong>:在新容器中运行命令</li><li id="1a54" class="mm mn ir kq b kr mv ku mw kx mx lb my lf mz lj mr ms mt mu bi translated">nerdctl exec :在运行容器中运行命令</li><li id="eab7" class="mm mn ir kq b kr mv ku mw kx mx lb my lf mz lj mr ms mt mu bi translated">创建一个新的容器</li><li id="7f8c" class="mm mn ir kq b kr mv ku mw kx mx lb my lf mz lj mr ms mt mu bi translated"><strong class="kq is"> nerdctl 日志</strong>:获取容器日志</li><li id="2fa7" class="mm mn ir kq b kr mv ku mw kx mx lb my lf mz lj mr ms mt mu bi translated"><strong class="kq is"> nerdctl start </strong>:启动一个或多个正在运行的容器。</li><li id="b508" class="mm mn ir kq b kr mv ku mw kx mx lb my lf mz lj mr ms mt mu bi translated"><strong class="kq is"> nerdctl stop </strong>:停止一个或多个正在运行的容器。</li><li id="73e4" class="mm mn ir kq b kr mv ku mw kx mx lb my lf mz lj mr ms mt mu bi translated"><strong class="kq is"> nerdctl 重启</strong>:重启一个或多个正在运行的容器。</li><li id="5a8d" class="mm mn ir kq b kr mv ku mw kx mx lb my lf mz lj mr ms mt mu bi translated">nerdctl rm/rmi :移除一个或多个容器/映像。</li><li id="5352" class="mm mn ir kq b kr mv ku mw kx mx lb my lf mz lj mr ms mt mu bi translated"><strong class="kq is"> nerdctl 容器清理</strong>:移除所有停止的容器。</li><li id="9cb8" class="mm mn ir kq b kr mv ku mw kx mx lb my lf mz lj mr ms mt mu bi translated"><strong class="kq is"> nerdctl 构建</strong>:从 Dockerfile 文件构建一个映像。</li><li id="9a26" class="mm mn ir kq b kr mv ku mw kx mx lb my lf mz lj mr ms mt mu bi translated"><strong class="kq is"> nerdctl 拉/推</strong>:从注册表中拉/推图像。</li></ul></div></div>    
</body>
</html>