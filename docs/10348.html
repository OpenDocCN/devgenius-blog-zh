<html>
<head>
<title>Django Model Relationships</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Django 模型关系</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/django-model-relationship-37da8f6f34e9?source=collection_archive---------2-----------------------#2022-10-26">https://blog.devgenius.io/django-model-relationship-37da8f6f34e9?source=collection_archive---------2-----------------------#2022-10-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/></div><div class="ab cl jn jo hu jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="ij ik il im in"><p id="045a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi ks translated">在本教程中，我们将学习 Django 中的 3 种模型关系。让我们用例子一个一个地来看。</p><h1 id="d47f" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">设置环境</h1><p id="7aa8" class="pw-post-body-paragraph ju jv iq jw b jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn md kp kq kr ij bi translated">首先，我们来创建项目环境。运行下面代码片段中的命令。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="735b" class="mn lc iq mj b gy mo mp l mq mr">#create project folder<br/>mkdir django_model_relationship</span><span id="2f9d" class="mn lc iq mj b gy ms mp l mq mr">cd django_model_relationship</span><span id="0b11" class="mn lc iq mj b gy ms mp l mq mr">#setup virtual environment<br/>python3 -m venv venv</span><span id="f0d8" class="mn lc iq mj b gy ms mp l mq mr">source venv/bin/activate</span><span id="27e2" class="mn lc iq mj b gy ms mp l mq mr">#install dependencies<br/>pip3 install Django djangorestframework psycopg2-binary</span><span id="4a97" class="mn lc iq mj b gy ms mp l mq mr"># create a Django project and application<br/>django-admin startproject backend .<br/>django-admin startapp app</span></pre><h1 id="bf23" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">一对一</h1><p id="ede4" class="pw-post-body-paragraph ju jv iq jw b jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn md kp kq kr ij bi translated">在<a class="ae mt" href="https://python.plainenglish.io/django-token-authentication-with-custom-user-model-2d780237bc4" rel="noopener ugc nofollow" target="_blank">上一篇教程</a>中，我们学习了通过创建一个定制的<code class="fe mu mv mw mj b"><strong class="jw ir">User</strong></code>模型来扩展用户模型。在本教程中，我们不会修改<code class="fe mu mv mw mj b"><strong class="jw ir">User</strong></code>模型，而是创建一个<code class="fe mu mv mw mj b"><strong class="jw ir">UserProfile</strong></code>模型来存储额外的字段，并使用<a class="ae mt" href="https://docs.djangoproject.com/en/4.1/topics/db/examples/one_to_one/" rel="noopener ugc nofollow" target="_blank"><strong class="jw ir"/><strong class="jw ir">一对一关系</strong> </a> <strong class="jw ir"> s </strong>将它们链接起来。</p><p id="0a0a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这个例子中，一个<code class="fe mu mv mw mj b"><strong class="jw ir">User</strong></code>只能与一个或者没有<code class="fe mu mv mw mj b"><strong class="jw ir">UserProfile</strong></code>对象相关联，但是一个<code class="fe mu mv mw mj b"><strong class="jw ir">UserProfile</strong></code>只能有一个<code class="fe mu mv mw mj b"><strong class="jw ir">User</strong></code>对象。定义一对多关系的关键字是<a class="ae mt" href="https://docs.djangoproject.com/en/4.1/ref/models/fields/#django.db.models.OneToOneField" rel="noopener ugc nofollow" target="_blank"><strong class="jw ir">one toone field</strong></a><strong class="jw ir">。</strong></p><p id="c209" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">导航到 models.py，并创建一个<code class="fe mu mv mw mj b"><strong class="jw ir">UserProfile</strong></code>模型。</p><figure class="me mf mg mh gt mx"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="a6d7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们在<code class="fe mu mv mw mj b"><strong class="jw ir">UserProfile</strong></code>中添加了 3 个额外的字段，分别是地址、出生日期和手机号码。随后，我们使用<a class="ae mt" href="https://docs.djangoproject.com/en/4.1/ref/models/fields/#django.db.models.OneToOneField" rel="noopener ugc nofollow" target="_blank"><strong class="jw ir">one toonefield</strong></a>将其与<code class="fe mu mv mw mj b"><strong class="jw ir">User</strong></code>模型关联起来。Django 将在用户配置文件表中自动创建一个'<strong class="jw ir"> user_id </strong>'字段，它将作为外键与用户记录绑定在一起。</p><p id="f0b4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">运行下面的命令来更新数据库。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="4556" class="mn lc iq mj b gy mo mp l mq mr">python3 manage.py makemigrations<br/>python3 manage.py migrate</span></pre><figure class="me mf mg mh gt mx gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi na"><img src="../Images/b9752ddcdb13dfce09d965815ad2abe7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hO5xxxFrwve4POtzEFd5gg.png"/></div></div><figcaption class="nh ni gj gh gi nj nk bd b be z dk translated">用户配置文件表。</figcaption></figure><p id="a1de" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在 app 文件夹中创建一个文件“serializers.py”。</p><figure class="me mf mg mh gt mx"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="db9b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">接下来，导航到 views.py 创建一个<code class="fe mu mv mw mj b"><strong class="jw ir">UserViewSet</strong></code>来自动生成 CRUD API。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="dd5b" class="mn lc iq mj b gy mo mp l mq mr">class UserViewSet(viewsets.ModelViewSet):<br/>    queryset = User.objects.all()<br/>    serializer_class = UserSerializer</span></pre><p id="d611" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在<strong class="jw ir"> app </strong>文件夹中创建一个 urls.py。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="44be" class="mn lc iq mj b gy mo mp l mq mr">from django.urls import path, include<br/>from rest_framework import routers<br/>from app import views</span><span id="c2d4" class="mn lc iq mj b gy ms mp l mq mr">router = routers.SimpleRouter()<br/>router.register(r'users', views.UserViewSet)</span><span id="6be2" class="mn lc iq mj b gy ms mp l mq mr">urlpatterns = []<br/>urlpatterns += router.urls</span></pre><p id="a53a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">接下来，将<strong class="jw ir">URL</strong>注册到主后端 URL 配置文件中。导航到<strong class="jw ir">后端</strong>文件夹下的 urls.py。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="5788" class="mn lc iq mj b gy mo mp l mq mr">from django.contrib import admin<br/>from django.urls import re_path, include</span><span id="c7b8" class="mn lc iq mj b gy ms mp l mq mr">urlpatterns = [<br/>  re_path('admin/', admin.site.urls),<br/>  re_path('<strong class="mj ir">api/</strong>', include('app.urls'))<br/>]</span></pre><p id="4b6f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创建的每个 API 将使用前缀'<strong class="jw ir"> api/' </strong>进行路由。</p><p id="344e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们使用 Postman 测试插入 API。创建用户的端点将是<a class="ae mt" href="http://localhost:8000/api/users/" rel="noopener ugc nofollow" target="_blank">http://localhost:8000/API/users/</a>(POST)</p><figure class="me mf mg mh gt mx gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi nl"><img src="../Images/9c66fc95c925e1adb6e374689f878419.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aTtsA4PcfZf5icReXdcqJg.png"/></div></div><figcaption class="nh ni gj gh gi nj nk bd b be z dk translated">用户记录创建成功。</figcaption></figure><p id="8055" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们尝试检索用户列表。检索用户列表的端点将是<a class="ae mt" href="http://localhost:8000/api/users/" rel="noopener ugc nofollow" target="_blank">http://localhost:8000/API/users/</a>(GET)</p><figure class="me mf mg mh gt mx gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi nm"><img src="../Images/acb01f1c3ddd46a339d30d29e12f34a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QXmDTamx0bioMoDAzgWm_A.png"/></div></div></figure><h1 id="a6bd" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">一对多</h1><p id="b140" class="pw-post-body-paragraph ju jv iq jw b jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn md kp kq kr ij bi translated">在这个例子中，一个<code class="fe mu mv mw mj b"><strong class="jw ir">User</strong></code>可以与许多<code class="fe mu mv mw mj b"><strong class="jw ir">Account</strong></code>对象相关联，但是一个<code class="fe mu mv mw mj b"><strong class="jw ir">Account</strong></code>只能有一个<code class="fe mu mv mw mj b"><strong class="jw ir">User</strong></code>对象。定义一对多关系的关键字是<a class="ae mt" href="https://docs.djangoproject.com/en/4.1/ref/models/fields/#django.db.models.ForeignKey" rel="noopener ugc nofollow" target="_blank"><strong class="jw ir">foreign key</strong></a><strong class="jw ir">。</strong></p><p id="0a93" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">导航到应用程序文件夹中的 models.py。创建一个<code class="fe mu mv mw mj b"><strong class="jw ir">Account</strong></code>类。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="65f1" class="mn lc iq mj b gy mo mp l mq mr">class Account(models.Model):<br/>  account_number = models.CharField(max_length=30)<br/>  account_type = models.CharField(max_length=20)<br/>  open_date = models.DateField()<br/>  balance = models.DecimalField(default=0, decimal_places=2, max_digits=12)<br/>  user = models.ForeignKey(User, related_name='accounts', on_delete=models.CASCADE)</span></pre><p id="7b6b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">导航到应用程序文件夹中的 serializers.py。创建一个<code class="fe mu mv mw mj b"><strong class="jw ir">AccountSerializer</strong></code>类。</p><figure class="me mf mg mh gt mx"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="0fa7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">导航到应用程序文件夹中的 views.py。创建一个<code class="fe mu mv mw mj b"><strong class="jw ir">AccountViewSet</strong></code>类。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="db09" class="mn lc iq mj b gy mo mp l mq mr">class AccountViewSet(viewsets.ModelViewSet):<br/>    queryset = Account.objects.all()<br/>    serializer_class = AccountSerializer</span></pre><p id="1e13" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">运行下面的命令来更新数据库。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="c359" class="mn lc iq mj b gy mo mp l mq mr">python3 manage.py makemigrations<br/>python3 manage.py migrate</span></pre><p id="a1c1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们使用 Postman 测试插入 API。创建帐户的端点将是<a class="ae mt" href="http://localhost:8000/api/users/" rel="noopener ugc nofollow" target="_blank">http://localhost:8000/API/accounts/</a>(POST)</p><figure class="me mf mg mh gt mx gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi nl"><img src="../Images/b347404aede83278fd5ba3809ab0f240.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1nwTjELcUxumm-6l8zdozg.png"/></div></div></figure><p id="f333" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">当访问<strong class="jw ir">用户</strong>时，我们可以检索账户对象。它将作为一个列表返回，因为我们在用户序列化程序中将 accounts 对象定义为 many <strong class="jw ir"> (many=True) </strong>。<em class="nn">参考上面</em>代码片段的第 18 行。</p><figure class="me mf mg mh gt mx gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi no"><img src="../Images/6ca09ff2f6ac8dc869fb3a4884f0b23e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_XbhNgXw-Ls1Qo8aoFiugQ.png"/></div></div></figure><h1 id="8723" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">多对多</h1><p id="5f22" class="pw-post-body-paragraph ju jv iq jw b jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn md kp kq kr ij bi translated">在这个例子中，一个<code class="fe mu mv mw mj b"><strong class="jw ir">Product</strong></code>可以与多个<code class="fe mu mv mw mj b"><strong class="jw ir">Order</strong></code>对象相关，一个<code class="fe mu mv mw mj b"><strong class="jw ir">Order</strong></code>可以包含多个<code class="fe mu mv mw mj b"><strong class="jw ir">Product</strong></code>对象。定义一对多关系的关键字是<a class="ae mt" href="https://docs.djangoproject.com/en/4.1/ref/models/fields/#manytomanyfield" rel="noopener ugc nofollow" target="_blank"><strong class="jw ir">ManyToManyField</strong></a><strong class="jw ir">。</strong></p><p id="d0de" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">导航到 app 文件夹中的 models.py 文件。添加以下代码片段来创建<code class="fe mu mv mw mj b"><strong class="jw ir">Product</strong></code>和<code class="fe mu mv mw mj b"><strong class="jw ir">Order</strong></code></p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="a247" class="mn lc iq mj b gy mo mp l mq mr">class Product(models.Model):<br/>    name = models.CharField(max_length=200)<br/>    sku = models.CharField(max_length=20)<br/>    price = models.DecimalField(default=0, decimal_places=2, max_digits=8)</span><span id="ccd7" class="mn lc iq mj b gy ms mp l mq mr">class Order(models.Model):<br/>    order_date = models.DateField()<br/>    status = models.CharField(max_length=20)<br/>    products = models.ManyToManyField(Product, related_name="products")</span></pre><p id="27ca" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">导航到 app 文件夹中的 serializers.py 文件。添加以下代码片段以创建<code class="fe mu mv mw mj b"><strong class="jw ir">ProductSerializer</strong></code>和<code class="fe mu mv mw mj b"><strong class="jw ir">OrderSerializer</strong></code></p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="3f85" class="mn lc iq mj b gy mo mp l mq mr">class ProductSerializer(serializers.ModelSerializer):<br/>    class Meta:<br/>        model = Product<br/>        fields = ('id', 'name', 'price', 'sku')</span><span id="335d" class="mn lc iq mj b gy ms mp l mq mr">class OrderSerializer(serializers.ModelSerializer):<br/>    # <strong class="mj ir"><em class="nn">To return products object instead of id</em></strong>  <br/>    products = ProductSerializer(read_only=True, many=True)</span><span id="5c77" class="mn lc iq mj b gy ms mp l mq mr">    class Meta:<br/>        model = Order<br/>        fields = ('id', 'order_date', 'status', 'products')</span></pre><p id="d9fb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">运行下面的命令来更新数据库。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="c66d" class="mn lc iq mj b gy mo mp l mq mr">python3 manage.py makemigrations<br/>python3 manage.py migrate</span></pre><p id="1e65" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在检查数据库时，我们发现创建了 3 个表。当使用 ManyToManyField 时，将再创建一个引用这两个表的表。我们称之为“直通”表。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="7f11" class="mn lc iq mj b gy mo mp l mq mr"># app_product<br/>SELECT id, name, sku, price FROM django.app_product;</span><span id="d5b1" class="mn lc iq mj b gy ms mp l mq mr"># app_order<br/>SELECT id, order_date, status FROM django.app_order;</span><span id="cde3" class="mn lc iq mj b gy ms mp l mq mr"># app_order_product<br/>SELECT id, order_id, product_id FROM django.app_order_products;</span></pre><p id="cf82" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">插入一些产品对象。创建产品的端点将是<a class="ae mt" href="http://localhost:8000/api/users/" rel="noopener ugc nofollow" target="_blank">http://localhost:8000/API/products/</a>(POST)</p><figure class="me mf mg mh gt mx gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi np"><img src="../Images/818125d1aec29857512a929fdace954a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5U2ROlvOu9haGN-KE7aw3A.png"/></div></div></figure><p id="707b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检索所有产品的端点将是<a class="ae mt" href="http://localhost:8000/api/users/" rel="noopener ugc nofollow" target="_blank">http://localhost:8000/API/products/</a>(GET)</p><figure class="me mf mg mh gt mx gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi nq"><img src="../Images/184ee1db7c987908d0ea7f9a2828c646.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4jSUG2HDW33vS_iCO7zguw.png"/></div></div></figure><p id="117a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">接下来，让我们创建一个订单对象。创建订单的端点将是<a class="ae mt" href="http://localhost:8000/api/users/" rel="noopener ugc nofollow" target="_blank">http://localhost:8000/API/orders/</a>(POST)</p><figure class="me mf mg mh gt mx gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi nr"><img src="../Images/b8defedbee8861cef4c2679e79a416f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o8dE9_87GkTPJDYoi9qd_g.png"/></div></div></figure><p id="3a8b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检索订单对象的端点将是<a class="ae mt" href="http://localhost:8000/api/users/" rel="noopener ugc nofollow" target="_blank">http://localhost:8000/API/orders/</a>{ id }(GET)</p><figure class="me mf mg mh gt mx gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi ns"><img src="../Images/c373e6dc6a133571f49d62201aa06e31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*No-0QWCf0Qn2fyJZjWptXQ.png"/></div></div></figure><h1 id="1466" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">额外的</h1><p id="f379" class="pw-post-body-paragraph ju jv iq jw b jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn md kp kq kr ij bi translated">在多对多关系中，有时我们可能需要额外的字段。例如，对于我们在订单中订购的每个产品，我们希望获取数量。在这种情况下，我们需要一个定制的模型和序列化程序来覆盖“直通”表。</p><p id="ffff" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在 models.py 中，我们创建了另一个模型<code class="fe mu mv mw mj b"><strong class="jw ir">Detail</strong></code> <strong class="jw ir">。</strong>在这个模型中，我们添加了两个外键来关联<code class="fe mu mv mw mj b"><strong class="jw ir">Product</strong></code>和<code class="fe mu mv mw mj b"><strong class="jw ir">Order</strong></code>，后跟额外的字段数量。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="3739" class="mn lc iq mj b gy mo mp l mq mr">class Product(models.Model):<br/>    name = models.CharField(max_length=200)<br/>    sku = models.CharField(max_length=20)<br/>    price = models.DecimalField(default=0, decimal_places=2, max_digits=8)</span><span id="c480" class="mn lc iq mj b gy ms mp l mq mr">class Order(models.Model):<br/>    order_date = models.DateField()<br/>    status = models.CharField(max_length=20)<br/>    products = models.ManyToManyField(Product, <strong class="mj ir">through</strong>="Detail")</span><span id="d75f" class="mn lc iq mj b gy ms mp l mq mr">class Detail(models.Model):<br/>    product = models.ForeignKey(Product, on_delete=models.CASCADE)<br/>    order = models.ForeignKey(Order, on_delete=models.CASCADE)<br/>    quantity = models.IntegerField(default=1)</span></pre><p id="9464" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在 serializers.py 中</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="44cd" class="mn lc iq mj b gy mo mp l mq mr">class ProductSerializer(serializers.ModelSerializer):<br/>    class Meta:<br/>        model = Product<br/>        fields = ('id', 'name', 'price', 'sku')</span><span id="072d" class="mn lc iq mj b gy ms mp l mq mr">class DetailSerializer(serializers.ModelSerializer):<br/>    product = ProductSerializer(many=False)<br/>    <br/>    class Meta:<br/>        model = Detail<br/>        fields = ('id', 'product', 'quantity')</span><span id="2463" class="mn lc iq mj b gy ms mp l mq mr">class OrderSerializer(serializers.ModelSerializer):</span><span id="f91e" class="mn lc iq mj b gy ms mp l mq mr">    # <strong class="mj ir"><em class="nn">here we use reverse relationship to extract the detail fields.</em></strong><br/>    products = DetailSerializer(source="detail<strong class="mj ir">_set</strong>", read_only=True, many=True)</span><span id="c80e" class="mn lc iq mj b gy ms mp l mq mr">    class Meta:<br/>        model = Order<br/>        fields = ('id', 'order_date', 'status', 'products')</span><span id="0e25" class="mn lc iq mj b gy ms mp l mq mr">    # add transaction.atomic so that if error happened, it will rollback<br/>    @transaction.atomic<br/>    def create(self, validated_data):<br/>        order = Order.objects.create(**validated_data)<br/>        if "products" in self.initial_data:<br/>            products = self.initial_data.get("products")<br/>            for product in products:<br/>                quantity = product.get("quantity")<br/>                product = Product.objects.get(pk=id)<br/>                Detail(order=order, product=product, quantity=quantity).save()<br/>        order.save()<br/>        return order</span></pre><p id="d190" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">再次重新测试 API 以创建订单，并检索订单以查看返回格式。</p><figure class="me mf mg mh gt mx gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi nt"><img src="../Images/eb7e2e02ba4defd1f46515cd2fd02246.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O6Mgu7JlSPbBBVVY3-V68g.png"/></div></div></figure><figure class="me mf mg mh gt mx gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi nu"><img src="../Images/0eb1dc69aa83245aa93e55f4d82c1331.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6Do7jqhSX1i6eWD_GNJTPw.png"/></div></div></figure><p id="377e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">太棒了！你可以在这里下载完整的源代码。</p></div><div class="ab cl jn jo hu jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="ij ik il im in"><div class="me mf mg mh gt nv"><a href="https://python.plainenglish.io/django-token-authentication-with-custom-user-model-2d780237bc4" rel="noopener  ugc nofollow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd ir gy z fp oa fr fs ob fu fw ip bi translated">使用自定义用户模型的 Django 令牌认证</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">学习 Django 认证系统，实现令牌认证，创建自定义用户，用户管理器等</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">python .平原英语. io</p></div></div><div class="oe l"><div class="of l og oh oi oe oj nf nv"/></div></div></a></div><div class="ok ol gp gr om nv"><a href="https://python.plainenglish.io/build-rest-apis-using-django-a004436b1589" rel="noopener  ugc nofollow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd ir gy z fp oa fr fs ob fu fw ip bi translated">使用 Django 构建 REST APIs</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">Django 是一个强大的 Python web 框架，允许您快速构建 REST APIs。</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">python .平原英语. io</p></div></div><div class="oe l"><div class="on l og oh oi oe oj nf nv"/></div></div></a></div></div></div>    
</body>
</html>