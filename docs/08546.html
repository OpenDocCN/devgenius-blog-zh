<html>
<head>
<title>Disk Logs : Simple Android Logger</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">磁盘日志:简单的 Android 记录器</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/disk-logs-simple-android-logger-778566726a76?source=collection_archive---------7-----------------------#2022-06-23">https://blog.devgenius.io/disk-logs-simple-android-logger-778566726a76?source=collection_archive---------7-----------------------#2022-06-23</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/7ac20ba5a53f456b6ff8d7333cbd0635.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7ngMCaMwuXq1kZsq"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">瓦迪姆·博古洛夫在<a class="ae jz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><blockquote class="ka kb kc"><p id="12dd" class="kd ke kf kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ig bi translated">“我只想用一种<strong class="kg io">简单的方式</strong>将日志写入一个<strong class="kg io">本地文件。”</strong>匿名同事</p></blockquote><p id="618f" class="pw-post-body-paragraph kd ke in kg b kh ki kj kk kl km kn ko lc kq kr ks ld ku kv kw le ky kz la lb ig bi translated">还有瓦拉！，旨在帮助我们识别<strong class="kg io"> <em class="kf">哪里出了问题，<br/> </em> </strong>一个基于 Kotlin 的记录器:</p><pre class="lf lg lh li gt lj lk ll lm aw ln bi"><span id="f52d" class="lo lp in lk b gy lq lr l ls lt">interface DiskLogger {<br/><br/>    <em class="kf">/**<br/>     * Log the [logContent] to a file on disk, any log written will<br/>     * be prefixed with a timestamp<br/>     */<br/>    </em>fun log(logContent: String)<br/><br/>    <em class="kf">/**<br/>     * Clean any logs files which are kept on the disk.<br/>     * @param from - the specified time which from this day and onto<br/>     * the past they will be deleted,<br/>     * must be at least from yesterday<br/>     * @throws IllegalStateException if the [from] days is less then<br/>     * 1 day<br/>     */<br/>    </em>fun cleanLogs(from: Date)<br/>}</span></pre><p id="71f8" class="pw-post-body-paragraph kd ke in kg b kh ki kj kk kl km kn ko lc kq kr ks ld ku kv kw le ky kz la lb ig bi translated">够简单吗，匿名同事？啊？！:)</p><h2 id="217d" class="lo lp in bd lu lv lw dn lx ly lz dp ma lc mb mc md ld me mf mg le mh mi mj mk bi translated">履行</h2><p id="25d0" class="pw-post-body-paragraph kd ke in kg b kh ml kj kk kl mm kn ko lc mn kr ks ld mo kv kw le mp kz la lb ig bi translated">为了理解即将到来的实现，你必须熟悉<a class="ae jz" href="https://kotlinlang.org/docs/coroutines-overview.html" rel="noopener ugc nofollow" target="_blank"> Kotlin-Coroutines </a>，<a class="ae jz" href="https://kotlinlang.org/docs/channels.html" rel="noopener ugc nofollow" target="_blank"> Kotlin 的通道</a>，<a class="ae jz" href="https://developer.android.com/reference/java/io/BufferedWriter" rel="noopener ugc nofollow" target="_blank"> BufferedWriter </a>，<a class="ae jz" href="https://developer.android.com/reference/java/io/File" rel="noopener ugc nofollow" target="_blank">文件</a>。否则你会浪费你的时间…</p><p id="e2eb" class="pw-post-body-paragraph kd ke in kg b kh ki kj kk kl km kn ko lc kq kr ks ld ku kv kw le ky kz la lb ig bi translated">首先，实现依赖关系:</p><pre class="lf lg lh li gt lj lk ll lm aw ln bi"><span id="ccae" class="lo lp in lk b gy lq lr l ls lt">class DiskLoggerImpl(<br/>    private val appContext: Context,<br/>    private val logsFileProvider: LogsFileProvider<br/>) : DiskLogger</span></pre><p id="cffc" class="pw-post-body-paragraph kd ke in kg b kh ki kj kk kl km kn ko lc kq kr ks ld ku kv kw le ky kz la lb ig bi translated">看起来，您必须提供一个 LogsFileProvider，它将告诉我们日志保存在哪个目录中，以及您保存日志的文件。(<a class="ae jz" href="https://medium.com/@itay.c14/disk-logs-separate-files-by-days-android-ebcc5406438a" rel="noopener">把这个当做实现的例子来读)</a></p><figure class="lf lg lh li gt jo"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="a8f2" class="pw-post-body-paragraph kd ke in kg b kh ki kj kk kl km kn ko lc kq kr ks ld ku kv kw le ky kz la lb ig bi translated">接下来，让我们思考一下全面实施:</p><figure class="lf lg lh li gt jo"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="8f58" class="pw-post-body-paragraph kd ke in kg b kh ki kj kk kl km kn ko lc kq kr ks ld ku kv kw le ky kz la lb ig bi translated">该实现基于两个主要思想:</p><ol class=""><li id="74fe" class="ms mt in kg b kh ki kl km lc mu ld mv le mw lb mx my mz na bi translated">Kotlin-Channel，它充当阻塞队列。从而使我们能够在通道入口将日志从多个线程发送到通道中，同时其输出在特定的协同作用域上工作，这将导致同步的顺序工作。</li><li id="2f5a" class="ms mt in kg b kh nb kl nc lc nd ld ne le nf lb mx my mz na bi translated">BufferredWriter 有自己的性能优势，它的底层<a class="ae jz" href="https://developer.android.com/reference/java/io/FileOutputStream" rel="noopener ugc nofollow" target="_blank"> FileOutputStream </a>在 2 分钟不活动后被关闭。</li></ol><p id="9dbc" class="pw-post-body-paragraph kd ke in kg b kh ki kj kk kl km kn ko lc kq kr ks ld ku kv kw le ky kz la lb ig bi translated">另外，请注意，写/删除操作是按顺序进行的，因此它们不会以并行方式执行。</p><p id="040b" class="pw-post-body-paragraph kd ke in kg b kh ki kj kk kl km kn ko lc kq kr ks ld ku kv kw le ky kz la lb ig bi translated">到目前为止还好吗？看起来我们已经完成了，但是…您能在下一张图中找出问题所在吗？</p><figure class="lf lg lh li gt jo gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/205ebac44e81f3e8812d08a993cc11a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:582/format:webp/1*MhIkjsWYht3qVikL-PcO-g.jpeg"/></div></figure><p id="72f5" class="pw-post-body-paragraph kd ke in kg b kh ki kj kk kl km kn ko lc kq kr ks ld ku kv kw le ky kz la lb ig bi translated">如果您的直觉告诉您两个实例的作者正在写入同一个文件，那么请更加相信您的直觉！为了解决这个问题，你有责任确保一个写者和一个文件之间有一对一的关系。我给大家分享一个使用 Dagger/Hilt DI(=依赖注入)库的解决方案。但是要确保你可以不用 DI 库自己写一个解决方案。</p><pre class="lf lg lh li gt lj lk ll lm aw ln bi"><span id="2698" class="lo lp in lk b gy lq lr l ls lt">@Module<br/>interface ApplicationBindsModule {</span><span id="61dd" class="lo lp in lk b gy nh lr l ls lt">    ...</span><span id="8d05" class="lo lp in lk b gy nh lr l ls lt">    @Binds <br/>    @LogsFileDaily<br/>    fun bindLogFileProviderDaily(<br/>        impl: LogsFileProviderDaily<br/>    ) : LogsFileProvider</span><span id="2ad0" class="lo lp in lk b gy nh lr l ls lt">}</span></pre><p id="91ea" class="pw-post-body-paragraph kd ke in kg b kh ki kj kk kl km kn ko lc kq kr ks ld ku kv kw le ky kz la lb ig bi translated">@LogsFileDaily 是一个 Dagger 限定符。在这里，我已经将我的 LogsFileProviderDaily 绑定到了 DiskLogger 接口并附加了限定符。这个记录器将为每一天提供新的文件(你可以<a class="ae jz" href="https://medium.com/@itay.c14/disk-logs-separate-files-by-days-android-ebcc5406438a" rel="noopener">阅读更多关于它的实现</a>)。<br/>这种依赖性是在:</p><pre class="lf lg lh li gt lj lk ll lm aw ln bi"><span id="adc5" class="lo lp in lk b gy lq lr l ls lt">@Module<br/>class ApplicationProvideModule {</span><span id="7379" class="lo lp in lk b gy nh lr l ls lt">    ...</span><span id="70b9" class="lo lp in lk b gy nh lr l ls lt">    @Provides<br/>    @DiskLoggerDaily<br/>    @Singleton <em class="kf">// Allow only this instance write to the file.<br/>    </em>fun provideDiskLoggerDaily(<br/>        appContext: Context,<br/>        @LogsFileDaily logsFileProvider: LogsFileProvider<br/>    ) : DiskLogger = DiskLoggerImpl(appContext, logsFileProvider)</span><span id="cf20" class="lo lp in lk b gy nh lr l ls lt">}</span></pre><p id="2c24" class="pw-post-body-paragraph kd ke in kg b kh ki kj kk kl km kn ko lc kq kr ks ld ku kv kw le ky kz la lb ig bi translated">同样,@DiskLoggerDaily 是一个限定词。<br/>现在，任何依赖于我的@DiskLoggerDaily 的类，都将获得相同的 DiskLogger 实例(@Singleton)，因此，只有一个 writer 将写入一个文件。</p><pre class="lf lg lh li gt lj lk ll lm aw ln bi"><span id="2c92" class="lo lp in lk b gy lq lr l ls lt">class MyViewModel1 @Inject constructor(<br/>    @DiskLoggerDaily private val dailyDiskLogger: DiskLogger,<br/>    ...<br/>) : ViewModel {...}</span><span id="ecdd" class="lo lp in lk b gy nh lr l ls lt">class MyViewModel2 @Inject constructor(<br/>    @DiskLoggerDaily private val dailyDiskLogger: DiskLogger,<br/>    ...<br/>) : ViewModel {...}</span></pre><p id="3064" class="pw-post-body-paragraph kd ke in kg b kh ki kj kk kl km kn ko lc kq kr ks ld ku kv kw le ky kz la lb ig bi translated">在注入时，两个视图模型将接收相同的实例。</p><p id="5375" class="pw-post-body-paragraph kd ke in kg b kh ki kj kk kl km kn ko lc kq kr ks ld ku kv kw le ky kz la lb ig bi translated">如果您想了解如何按天将日志保存到单独的文件中，请继续阅读:</p><div class="ni nj gp gr nk nl"><a href="https://medium.com/@itay.c14/disk-logs-separate-files-by-days-android-ebcc5406438a" rel="noopener follow" target="_blank"><div class="nm ab fo"><div class="nn ab no cl cj np"><h2 class="bd io gy z fp nq fr fs nr fu fw im bi translated">磁盘日志:按天分隔文件，Android</h2><div class="ns l"><h3 class="bd b gy z fp nq fr fs nr fu fw dk translated">本指南将介绍一种将信息记录到磁盘文件中的方法，每个文件代表 24 小时。此外，如何…</h3></div><div class="nt l"><p class="bd b dl z fp nq fr fs nr fu fw dk translated">medium.com</p></div></div><div class="nu l"><div class="nv l nw nx ny nu nz jt nl"/></div></div></a></div></div><div class="ab cl oa ob hr oc" role="separator"><span class="od bw bk oe of og"/><span class="od bw bk oe of og"/><span class="od bw bk oe of"/></div><div class="ig ih ii ij ik"><p id="594f" class="pw-post-body-paragraph kd ke in kg b kh ki kj kk kl km kn ko lc kq kr ks ld ku kv kw le ky kz la lb ig bi translated">如果你觉得我的文章有任何帮助，请分享并给它一个<strong class="kg io">掌声</strong>。但是如果你认为我可能会用更有价值的内容给你惊喜，你可以<a class="ae jz" href="https://medium.com/subscribe/@itay.c14" rel="noopener"> <strong class="kg io">订阅</strong> </a>或者<strong class="kg io">关注</strong>我来获得新内容的通知。</p><blockquote class="oh"><p id="81f1" class="oi oj in bd ok ol om on oo op oq lb dk translated">有一个伟大的一天，更大的知识和可怕的技能！</p></blockquote><p id="c83f" class="pw-post-body-paragraph kd ke in kg b kh or kj kk kl os kn ko lc ot kr ks ld ou kv kw le ov kz la lb ig bi translated"><a class="ae jz" href="https://www.linkedin.com/in/itay-cohen-b717b1107/" rel="noopener ugc nofollow" target="_blank">伊塔·科恩|领英</a></p></div></div>    
</body>
</html>