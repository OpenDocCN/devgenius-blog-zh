<html>
<head>
<title>Ingesting Data Into Snowflake (4): Stream and Task</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将数据摄取到雪花中(4):流和任务</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/ingesting-data-into-snowflake-4-stream-and-task-3725287c2755?source=collection_archive---------8-----------------------#2022-10-26">https://blog.devgenius.io/ingesting-data-into-snowflake-4-stream-and-task-3725287c2755?source=collection_archive---------8-----------------------#2022-10-26</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><div class=""/><figure class="gm go jp jq jr js gi gj paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="gi gj jo"><img src="../Images/cb32e4129c6648f3ebe4e9856a2c653d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CDEj_F8AfQvsOTrvFO1uEA.png"/></div></div><figcaption class="jz ka gk gi gj kb kc bd b be z dk translated">约翰尼湖，基拉尼省立公园，2022 年 9 月 9 日</figcaption></figure><p id="f186" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">我们在另一篇文章中谈到过<a class="ae lb" href="https://medium.com/@fengliplatform/ingesting-data-into-snowflake-2-snowpipe-6b68cc6ffed6" rel="noopener"> Snowpipe，它用于将数据接收到雪花中(来自 S3)——通常原始数据被放在一个“暂存表”中。接下来，将对原始数据进行更多的转换，然后将它们放入生产或最终表格中进行进一步分析。</a></p><p id="cba4" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">类似地，OLTP 系统中的事务记录可以被视为“暂存”表，这些表将被转换为 OLAP 操作的“最终”表。</p><p id="da14" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">这些是典型的 ELT 数据流——从 S3 中提取数据，加载到雪花状“暂存”表中，然后为最终表转换数据。雪花在这里能做什么？</p><p id="45d8" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">在这两种情况下，我们都需要监视新记录或记录修改的“暂存”表。我们需要捕捉更改，并将它们合并到“最终”表中，这样我们的 OLAP 系统就可以尽快分析最新的数据。如果所有这些捕获和合并都可以自动化，那就太好了。</p><p id="ad83" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">为了监视和转换“暂存”表，我们可以使用雪花流和任务。</p><p id="da56" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">雪花流是在表上定义的，用于自动监控和收集数据变化。流对象保存数据更改。当数据更改被消耗到最终表时，流对象将它们从流中删除。</p><p id="4d27" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">雪花任务是一个预定的动作，它可以消耗流中的数据变化并更新最终表。特别是，如果流中有数据更改到达，它会被触发。</p><p id="59d5" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">让我们使用样本数据集“dvdrental”来尝试一下这个用例——点击此链接查看更多信息<a class="ae lb" href="https://www.postgresqltutorial.com/postgresql-getting-started/postgresql-sample-database/" rel="noopener ugc nofollow" target="_blank">，点击此处</a>查看<a class="ae lb" href="https://www.postgresqltutorial.com/wp-content/uploads/2018/03/printable-postgresql-sample-database-diagram.pdf" rel="noopener ugc nofollow" target="_blank">ER 图表。如果你认为 DVD 租赁有点过时，你可以想象一下家得宝的工具租赁或企业或任何类似企业的汽车租赁。</a></p><p id="1c24" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">让我们看看租赁表和付款表。业务逻辑是:当一张 DVD 被租出时，一条新记录被插入到租金表和付款表中。付款表中的记录将根据租金每天改变金额。归还此 DVD 时，租赁表中的 return_date 将相应更新。付款表中的金额将是本次租赁的最终金额。</p><figure class="ld le lf lg gu js gi gj paragraph-image"><div class="gi gj lc"><img src="../Images/c6664a4ae2c769974c51b054a0382bcf.png" data-original-src="https://miro.medium.com/v2/resize:fit:410/format:webp/1*u1QPZzrZKuwErJ8xp8NhUw.png"/></div></figure><p id="78e7" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">在一天结束时，我们想分析这个行业，找出:哪些 DVD 是产生最多的利润？或者谁是最有价值的客户？还是有季节性的起伏？</p><p id="dd81" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">因此，我们可能希望有一个“最终”表，比如收入表，其中包括租赁标识、付款标识、库存标识、客户标识、金额、付款日期。使用这个收入表，我们可以应用所有的聚合——你知道 OLAP 的东西。</p><p id="ccf5" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">要做到这一点，我们可以创建一个流表支付。该流捕获插入和数量更新。我们还创建了一个任务，如果流获得新的数据更改，将会触发该任务。然后，该任务将连接租金和付款表，以向我们的最终收入表写入新记录。</p><p id="bcf3" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">详细步骤如下</p><pre class="ld le lf lg gu lh li lj lk aw ll bi"><span id="677e" class="lm ln ir li b gz lo lp l lq lr">// create our final table revenue<br/>create or replace table revenue (<br/>    rental_id integer,<br/>    payment_id integer,<br/>    inventory_id integer,<br/>    customer_id integer,<br/>    amount decimal(5,2),<br/>    payment_date timestamp<br/>);</span><span id="9661" class="lm ln ir li b gz ls lp l lq lr">// create stream on payment table<br/>create or replace stream payment_stream on table feng_database.feng_schema.payment;</span><span id="5b8c" class="lm ln ir li b gz ls lp l lq lr">// insert into rental and payment tables first time for a rental<br/>insert into rental values (26002, '2022-09-23 22:50:12.000', 2666, 393, null, 2, '2022-09-23 22:50:12.000');<br/>insert into payment values (42002, 393, 2, 26002, 3.99, '2022-09-23 22:50:12.000');</span><span id="7819" class="lm ln ir li b gz ls lp l lq lr">// look at what we have in payment stream<br/>select * from payment_stream;</span></pre><figure class="ld le lf lg gu js gi gj paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="gi gj lt"><img src="../Images/4e83574a2cfe1baadecbeee9ae210bd4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8afkRR6rV1puIpA7cG9vzg.png"/></div></div><figcaption class="jz ka gk gi gj kb kc bd b be z dk translated">在付款流中，我们捕获了一条插入记录</figcaption></figure><p id="be3d" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">正如我们看到的，付款流捕获了付款表中的新记录。现在，让我们消费这一数据变化…</p><p id="4e74" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">1 我们通过检查流中的 payment_id 是否与最终表中的 payment_id 匹配，从流数据中使用“merge into”最终表语句。</p><p id="3cec" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">2 如果流中的 payment_id 不在最终表中，我们会将此付款插入最终表中。</p><p id="2b69" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">3 如果 payment_id 已经在最终表中，我们将用流中最新金额数据更新最终表。</p><pre class="ld le lf lg gu lh li lj lk aw ll bi"><span id="ef60" class="lm ln ir li b gz lo lp l lq lr">merge into revenue rev<br/>using (select ren.rental_id, ren.inventory_id, ren.customer_id, p.payment_id, p.amount, p.payment_date, p.METADATA$ACTION, p.METADATA$ISUPDATE<br/>       from payment_stream p<br/>       join rental ren<br/>       on ren.rental_id=p.rental_id) rent<br/>on rev.payment_id = rent.payment_id<br/>when not matched<br/>  then insert<br/>  (rental_id, payment_id, inventory_id, customer_id, amount, payment_date)<br/>  values<br/>    (rent.rental_id,rent.payment_id, rent.inventory_id, rent.customer_id, rent.amount, rent.payment_date)<br/>when matched and rent.METADATA$ACTION='INSERT' and rent.METADATA$ISUPDATE='TRUE'<br/>then update <br/>set rev.amount = rent.amount;</span><span id="39e0" class="lm ln ir li b gz ls lp l lq lr">select * from revenue;</span></pre><figure class="ld le lf lg gu js gi gj paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="gi gj lu"><img src="../Images/18b238aa02ef5e5dfdacbda8b04cd90d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FnVkRmXgquHVJAv_YX0kIg.png"/></div></div></figure><p id="043b" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">消费付款流后，我们可以看到最终表收入有一个新的记录。支付流现在是空的。</p><p id="009a" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">接下来，让我们更新付款表以修改金额，因为此租赁成本会根据租赁费率增加。</p><pre class="ld le lf lg gu lh li lj lk aw ll bi"><span id="62c0" class="lm ln ir li b gz lo lp l lq lr">// updated amount in payment table<br/>update payment set amount=5.99 where payment_id=42002;</span><span id="743c" class="lm ln ir li b gz ls lp l lq lr">select * from payment_stream;</span></pre><figure class="ld le lf lg gu js gi gj paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="gi gj lv"><img src="../Images/4d5252a2d5a42c7ce46d83118a87d7b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HVnwu0ZxjnR-O41Q23QMyw.png"/></div></div><figcaption class="jz ka gk gi gj kb kc bd b be z dk translated">更新付款表时付款流中有什么</figcaption></figure><p id="d47f" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">更新记录被视为删除旧记录并在付款流中插入新记录。因此，我们在支付流中看到两个记录:METADATA$ACTION 告诉 INSERT 和 DELETE，以及 METADATA $ ISUPDATE，它表示真值，这表示在被监控的表中发生了记录更新的插入/删除。这两个记录在流中是耦合的。</p><p id="85e5" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">当我们在流中使用这些更改时，我们的合并部分发现流中的 payment_id 与最终表中现有的 payment_id 相匹配，并查找元数据列，因此它知道这是对最终表记录的更新。</p><p id="460a" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">因此，我们将再次执行上述“合并”代码…</p><figure class="ld le lf lg gu js gi gj paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="gi gj lw"><img src="../Images/951aad3835f343bea97616fa72f8ae97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rP1hikL1GRUbwTVxQo7Byg.png"/></div></div><figcaption class="jz ka gk gi gj kb kc bd b be z dk translated">根据付款流修改最终表中的金额</figcaption></figure><p id="9888" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">到目前为止，我们已经了解了 stream 如何捕获表的变化，以及如何将这些变化消费到最终的表中。</p><p id="a604" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">为了实现自动化，我们将使用雪花任务…每 1 分钟创建一个任务监控支付流，如果 steam 捕获到数据更改(当 SYSTEM $ STREAM _ HAS _ DATA(' feng _ database . feng _ schema . payment _ STREAM '))，则运行相同的“merge”代码！</p><pre class="ld le lf lg gu lh li lj lk aw ll bi"><span id="d33c" class="lm ln ir li b gz lo lp l lq lr">// Task<br/>CREATE OR REPLACE TASK final_table_revenue_task<br/>    WAREHOUSE = FENG_WH<br/>    SCHEDULE = '1 MINUTE'<br/>    WHEN SYSTEM$STREAM_HAS_DATA('feng_database.feng_schema.payment_stream')    AS <br/>merge into revenue rev<br/>using (select ren.rental_id, ren.inventory_id, ren.customer_id, p.payment_id, p.amount, p.payment_date, p.METADATA$ACTION, p.METADATA$ISUPDATE<br/>       from payment_stream p<br/>       join rental ren<br/>       on ren.rental_id=p.rental_id) rent<br/>on rev.rental_id = rent.rental_id<br/>when not matched<br/>  then insert<br/>  (rental_id, payment_id, inventory_id, customer_id, amount, payment_date)<br/>  values<br/>    (rent.rental_id,rent.payment_id, rent.inventory_id, rent.customer_id, rent.amount, rent.payment_date)<br/>when matched and rent.METADATA$ACTION='INSERT' and rent.METADATA$ISUPDATE='TRUE'<br/>then update <br/>set rev.amount = rent.amount;</span><span id="5aad" class="lm ln ir li b gz ls lp l lq lr">show tasks;<br/>alter task final_table_revenue_task resume;</span></pre><figure class="ld le lf lg gu js gi gj paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="gi gj lu"><img src="../Images/741b8a69e79d62cabe736f24ac5877e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5N44zPsGnQSNJEXaRFj4WA.png"/></div></div><figcaption class="jz ka gk gi gj kb kc bd b be z dk translated">创建任务是为了监视流并触发 merge 语句来更新最终表</figcaption></figure><p id="50bd" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">注意，任务创建后处于暂停状态。使用上面的“resume”语句启动任务。</p><p id="f1ec" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">让我们通过再次更新付款表来测试任务…</p><pre class="ld le lf lg gu lh li lj lk aw ll bi"><span id="553d" class="lm ln ir li b gz lo lp l lq lr">// Modify amount again in payment table<br/>update payment set amount=7.99 where payment_id=42002;</span><span id="82cc" class="lm ln ir li b gz ls lp l lq lr">// Check payment stream<br/>select * from payment_stream;</span><span id="cf4d" class="lm ln ir li b gz ls lp l lq lr">// Check final table revenue<br/>select * from revenue;</span><span id="4084" class="lm ln ir li b gz ls lp l lq lr">// Troubleshooting task - checking task history<br/>select * from table(information_schema.task_history())<br/>order by name asc, scheduled_time desc;</span></pre><figure class="ld le lf lg gu js gi gj paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="gi gj lx"><img src="../Images/d82f4422d1757cc5b1e8f2d0cbbc6877.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L9aJAb5GEBklI6ZoRlA0aA.png"/></div></div><figcaption class="jz ka gk gi gj kb kc bd b be z dk translated">任务已自动使用最新金额更新最终表格</figcaption></figure><figure class="ld le lf lg gu js gi gj paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="gi gj lv"><img src="../Images/a66ad2ae6f1aa918b7dad7b007712012.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZCkj9V_oMtGIdmT-zP3j8w.png"/></div></div><figcaption class="jz ka gk gi gj kb kc bd b be z dk translated">故障排除任务—检查任务历史记录</figcaption></figure><p id="5526" class="pw-post-body-paragraph kd ke ir kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">快乐阅读！</p><div class="ly lz gq gs ma mb"><a href="https://medium.com/@fengliplatform/membership" rel="noopener follow" target="_blank"><div class="mc ab fp"><div class="md ab me cl cj mf"><h2 class="bd is gz z fq mg fs ft mh fv fx iq bi translated">通过我的推荐链接-李冯加入媒体</h2><div class="mi l"><h3 class="bd b gz z fq mg fs ft mh fv fx dk translated">写作帮助我们自己，分享帮助很多人。从我自己的学习笔记开始，没有要求完美的压力…</h3></div><div class="mj l"><p class="bd b dl z fq mg fs ft mh fv fx dk translated">medium.com</p></div></div><div class="mk l"><div class="ml l mm mn mo mk mp jx mb"/></div></div></a></div></div></div>    
</body>
</html>