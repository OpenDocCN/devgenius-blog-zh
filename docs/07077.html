<html>
<head>
<title>Monitor Azure resources creation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">监控 Azure 资源创建</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/monitor-azure-resources-creation-and-deletion-fd841d514889?source=collection_archive---------7-----------------------#2022-02-23">https://blog.devgenius.io/monitor-azure-resources-creation-and-deletion-fd841d514889?source=collection_archive---------7-----------------------#2022-02-23</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="330e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">你可能已经注意到 Azure 中的一些资源类型不提供任何创建日期属性。例如，如果您查看虚拟机属性，您将看不到任何创建日期字段。您可以通过打开<em class="ki"> Azure Resource Explorer </em>服务并运行以下查询来检查这一点。当查看结果时，您不会发现任何创建日期。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi kj"><img src="../Images/6babd693b02677b68f9f85148662b497.png" data-original-src="https://miro.medium.com/v2/resize:fit:876/format:webp/1*G8J0Z8-YYf-ZsFqghaAUYA.png"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">仅返回一个虚拟机属性的查询。</figcaption></figure><h2 id="828f" class="kv kw in bd kx ky kz dn la lb lc dp ld jv le lf lg jz lh li lj kd lk ll lm ln bi translated">那么哪些资源类型包含创建日期呢？</h2><p id="e622" class="pw-post-body-paragraph jk jl in jm b jn lo jp jq jr lp jt ju jv lq jx jy jz lr kb kc kd ls kf kg kh ig bi translated">答案很简单:必须为每种资源类型分析资源属性。例如，VMs 属性记录在<a class="ae lt" href="https://docs.microsoft.com/en-us/azure/templates/microsoft.compute/virtualmachines?tabs=bicep#virtualmachineproperties" rel="noopener ugc nofollow" target="_blank">微软文档</a>中，正如您所见，没有创建日期字段！</p><p id="e979" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">文档是很棒的，但是有许多资源类型，所以更快的方法是使用<em class="ki"> Azure Resource Graph </em>服务，并寻找包含这两个字符串之一的资源属性:“日期”或“时间”。这不是一个 100%可靠的方法，因为，例如，<strong class="jm io">microsoft.web/sites/slots</strong>资源类型具有<strong class="jm io"> runtimeAvailabilityState </strong>属性，但是很明显，它不是一个创建日期字段。但是这个查询仍然是有用的，因为它过滤了所有没有“日期”或“时间”字符串的资源<em class="ki">，也就是说</em>可能没有创建日期字段。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi lu"><img src="../Images/19683b3d8b93332e87a13115cd194ecc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1118/format:webp/1*nWuldqBPBze0ZN3y4ZKa3w.png"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">属性中包含“时间”或“日期”的所有资源类型。</figcaption></figure><p id="f572" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">对于剩余的资源，我们需要手动检查是否确实有一个创建日期字段。通过手动检查多个资源的属性，我检索了创建日期字段的列表。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="gh gi lv"><img src="../Images/6e73ff4bd86894a6474f05852c4db75d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iAQKpgCcl8usWWzSWX7w0w.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">该查询返回具有这 12 个创建日期字段之一的资源量，以及没有创建日期字段的资源量。</figcaption></figure><p id="1db0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">令人惊讶吧？至少有 12 个不同的创建日期字段！为了回答我们最初的问题，我们可以修改这个请求来返回资源类型。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi ma"><img src="../Images/9571d4961a20b899c95bb3d0ff5c81bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1336/format:webp/1*XWgsXg1XikKBa5M5MTEcaw.png"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">该查询返回在其属性中具有创建日期字段的资源类型。</figcaption></figure><h2 id="8ab3" class="kv kw in bd kx ky kz dn la lb lc dp ld jv le lf lg jz lh li lj kd lk ll lm ln bi translated">我如何监控其他资源？</h2><p id="400a" class="pw-post-body-paragraph jk jl in jm b jn lo jp jq jr lp jt ju jv lq jx jy jz lr kb kc kd ls kf kg kh ig bi translated">对于属性中没有任何创建日期字段资源，您可以使用 Azure 策略。这是一项免费服务，允许您定义和应用多个策略。例如，您可以使用此类策略强制管理员仅部署特定规模的虚拟机，以优化成本。</p><p id="7067" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在我们的例子中，我们可以创建一个策略，在资源创建时动态地创建一个标签:当将我们的策略分配给一个范围时(例如将 T1 分配给一个订阅)，我们将我们的标签命名为<strong class="jm io"> creationDate </strong>。因此，每当我部署选定范围内的资源时，我的 Azure 策略将添加一个名为<strong class="jm io"> creationDate </strong>的标签，其值将是当前日期时间(多亏了<strong class="jm io"> utcNow() </strong>函数)。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi mb"><img src="../Images/cd66ef0d242467424f62a41506fa5424.png" data-original-src="https://miro.medium.com/v2/resize:fit:1152/format:webp/1*-itVx8MZVtca9GH5zFKvsw.png"/></div></figure><p id="36b8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">然后，我们可以修改前面的查询来收集所有的创建日期，包括存储在标记中的创建日期。在这个例子中，我将标签命名为<strong class="jm io"> creationDate </strong>。您可以看到在<em class="ki">行的第 14 </em>行上，列<strong class="jm io"> d13 </strong>存储了我的<strong class="jm io"> creationDate </strong>标签。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="gh gi mc"><img src="../Images/2096108e1f000b3e4a95136bb209eae9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5rVHuqVVZs5aQw1xAcflTA.png"/></div></div></figure><h2 id="f579" class="kv kw in bd kx ky kz dn la lb lc dp ld jv le lf lg jz lh li lj kd lk ll lm ln bi translated">我能找到一本工作手册来监控这个吗？</h2><p id="d4b6" class="pw-post-body-paragraph jk jl in jm b jn lo jp jq jr lp jt ju jv lq jx jy jz lr kb kc kd ls kf kg kh ig bi translated">是的，但我目前正在建设它可能会定期更改。可以在我的 Github 上找到:<a class="ae lt" href="https://github.com/Molx32/AwesomeAzureWorkbooks/blob/main/Workbooks/CreationDate" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="gh gi md"><img src="../Images/34f815bb5819a6d1c89c70ddd2480966.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*rClNJszph0IhwnxD.png"/></div></div></figure></div><div class="ab cl me mf hr mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="ig ih ii ij ik"><p id="239c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">感谢您的阅读，希望对您有所帮助！</p></div></div>    
</body>
</html>