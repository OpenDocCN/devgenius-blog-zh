<html>
<head>
<title>Upgrading to Kubernetes 1.16</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">升级到Kubernetes 1.16</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/upgrading-to-kubernetes-1-16-ad977933694d?source=collection_archive---------2-----------------------#2020-07-28">https://blog.devgenius.io/upgrading-to-kubernetes-1-16-ad977933694d?source=collection_archive---------2-----------------------#2020-07-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="4405" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Kubernetes 1.16中有哪些新增功能和不推荐使用的功能？使用<a class="ae kl" href="https://github.com/doitintl/kube-no-trouble" rel="noopener ugc nofollow" target="_blank"> kube-no-trouble </a>或<a class="ae kl" href="https://github.com/FairwindsOps/pluto" rel="noopener ugc nofollow" target="_blank"> pluto </a>在升级前找到并解决问题。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/245c82c51f70e4ecf83eb4ee4d045db5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zpN8rCOWyhKzJGyRivV-DQ.png"/></div></div></figure><p id="0eb2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://kubernetes.io/blog/2020/03/25/kubernetes-1-18-release-announcement/" rel="noopener ugc nofollow" target="_blank"> Kubernetes 1.18 </a>于今年早些时候发布，这意味着Kubernetes 1.16跨托管Kubernetes平台(即GKE、EKS、阿拉斯加)的推出即将到来(大多数提供商仅支持最近的三个次要版本)。<strong class="jp ir">升级到1.16意义重大，因为</strong> <strong class="jp ir">几个API最终被弃用并从Kubernetes </strong>中移除。这意味着任何创建或升级包含不赞成使用的API的Kubernetes资源的尝试都将失败。在这篇文章中，我们将重点介绍Kubernetes 1.16的一些新特性，指出所有被否决的API，并列出一些有助于升级过程的工具。</p><h1 id="54c2" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">Kubernetes 1.16的新特性</h1><p id="4eec" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">1.16版中的三大主题包括:</p><ol class=""><li id="e007" class="mb mc iq jp b jq jr ju jv jy md kc me kg mf kk mg mh mi mj bi translated">将自定义资源定义(CRD)升级到正式发布(CRD从1.7开始就处于测试阶段)。</li><li id="e6a4" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated">彻底检查Kubernetes指标:使指标符合官方的Kubernetes标准(例如，从cAdvisor指标中删除重复的<code class="fe mp mq mr ms b">pod_name</code>和<code class="fe mp mq mr ms b">container_name</code>，改变API延迟直方图桶，改变client-go指标)</li><li id="c6ca" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated">容器存储接口(CSI)升级到测试版，为扩展PersistentVolumeClaims (PVC)提供更多支持</li></ol><p id="be34" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可以阅读<a class="ae kl" href="https://kubernetes.io/blog/2019/09/18/kubernetes-1-16-release-announcement/" rel="noopener ugc nofollow" target="_blank">官方发布说明</a>、<a class="ae kl" href="https://www.cncf.io/wp-content/uploads/2019/10/CNCF-Webinar_-Kubernetes-1.16.pdf" rel="noopener ugc nofollow" target="_blank"> CNCF的演示文稿</a>，或者<a class="ae kl" href="https://sysdig.com/blog/whats-new-kubernetes-1-16/" rel="noopener ugc nofollow" target="_blank"> Sysdig的总结</a>来找到更多关于新特性和增强的信息。</p><h1 id="73db" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">Kubernetes 1.16移除了什么</h1><p id="9c78" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">更重要的是，1.16为了支持稳定的API版本，删除了以下API:</p><ul class=""><li id="5604" class="mb mc iq jp b jq jr ju jv jy md kc me kg mf kk mt mh mi mj bi translated"><strong class="jp ir">网络策略</strong> : <code class="fe mp mq mr ms b">extensions/v1beta1</code> → <code class="fe mp mq mr ms b">networking.k8s.io/v1</code></li><li id="cfa2" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mt mh mi mj bi translated"><strong class="jp ir">PodSecurityPolicy:</strong><code class="fe mp mq mr ms b">extensions/v1beta1</code>→<code class="fe mp mq mr ms b">policy/v1beta1</code></li><li id="79e2" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mt mh mi mj bi translated"><strong class="jp ir">达蒙塞特:</strong> <code class="fe mp mq mr ms b">extensions/v1beta1</code>、<code class="fe mp mq mr ms b">apps/v1beta1</code>、<code class="fe mp mq mr ms b">apps/v1beta2</code> → <code class="fe mp mq mr ms b">apps/v1</code></li><li id="db98" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mt mh mi mj bi translated"><strong class="jp ir">部署:</strong>、<code class="fe mp mq mr ms b">apps/v1beta1</code>、<code class="fe mp mq mr ms b">apps/v1beta2</code> → <code class="fe mp mq mr ms b">apps/v1</code></li><li id="1b86" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mt mh mi mj bi translated"><strong class="jp ir">状态设置</strong> : <code class="fe mp mq mr ms b">apps/v1beta1</code>和<code class="fe mp mq mr ms b">apps/v1beta2</code> → <code class="fe mp mq mr ms b">apps/v1</code></li><li id="f020" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mt mh mi mj bi translated"><strong class="jp ir">副本集</strong> : <code class="fe mp mq mr ms b">extensions/v1beta1</code>、<code class="fe mp mq mr ms b">apps/v1beta1</code>和<code class="fe mp mq mr ms b">apps/v1beta2</code> → <code class="fe mp mq mr ms b">apps/v1</code></li></ul><p id="fd66" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在大多数情况下，解决方法是简单地将API版本更新为稳定的API。但是，<code class="fe mp mq mr ms b">app/v1</code>在某些情况下的表现略有不同:</p><ul class=""><li id="2bfb" class="mb mc iq jp b jq jr ju jv jy md kc me kg mf kk mt mh mi mj bi translated"><strong class="jp ir">DaemonSet</strong>:spec . template generation已删除，spec.selector现在是必需的且不可变，spec.updateStrategy.type默认为RollingUpdate</li><li id="dbaf" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mt mh mi mj bi translated"><strong class="jp ir">部署:</strong> spec.rollbackTo被删除，spec.selector现在是必需的且不可变，spec.progressDeadlineSeconds默认为600s，spec.revisionHistoryLimit默认为10，maxSurge和maxUnavailable默认为25%</li><li id="38ce" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mt mh mi mj bi translated"><strong class="jp ir">StatefulSet:</strong>spec . selector现在是必需的且不可变的，spec.updateStrategy.type默认为RollingUpdate</li></ul><p id="2a5f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">记下这些行为(尤其是对于更改了updateStrategy的StatefulSets ),以确保对您的工作负载造成最小的中断。</p><h1 id="e952" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">如何找到不推荐使用的API</h1><p id="1bbb" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">如果您正在使用GKE，并且在集群上启用了Stackdriver日志记录，则可以使用以下过滤器来识别所有使用不推荐的API的工作负荷:</p><pre class="kn ko kp kq gt mu ms mv mw aw mx bi"><span id="9b42" class="my kz iq ms b gy mz na l nb nc">resource.type="k8s_cluster"<br/>resource.labels.cluster_name="$CLUSTER_NAME"<br/>protoPayload.authenticationInfo.principalEmail:("system:serviceaccount" OR "@")<br/>protoPayload.request.apiVersion=("extensions/v1beta1" OR "apps/v1beta1" OR "apps/v1beta2")<br/>protoPayload.request.kind!="Ingress"<br/>NOT ("kube-system")</span></pre><p id="470e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">否则，您可以使用一个名为<a class="ae kl" href="https://github.com/doitintl/kube-no-trouble" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir">Kube No Trouble</strong></a><strong class="jp ir">(</strong><code class="fe mp mq mr ms b"><strong class="jp ir">kubent</strong></code><strong class="jp ir">)</strong>by<a class="ae kl" href="https://www.doit-intl.com/" rel="noopener ugc nofollow" target="_blank">DoiT International</a>或<a class="ae kl" href="https://www.fairwinds.com/" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir">fairwindops的</strong></a><strong class="jp ir"/><a class="ae kl" href="https://github.com/FairwindsOps/pluto" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir">Pluto</strong></a>如果您正在使用其他工具，如<a class="ae kl" href="https://github.com/FairwindsOps/polaris" rel="noopener ugc nofollow" target="_blank"> polaris </a>或<a class="ae kl" href="https://github.com/FairwindsOps/goldilocks" rel="noopener ugc nofollow" target="_blank"> goldilocks </a>。这两个工具都与<code class="fe mp mq mr ms b">kubectl</code>和Helm一起工作，并列出不推荐使用的API:</p><h2 id="63a3" class="my kz iq bd la nd ne dn le nf ng dp li jy nh ni lm kc nj nk lq kg nl nm lu nn bi translated">kubent示例</h2><pre class="kn ko kp kq gt mu ms mv mw aw mx bi"><span id="fd98" class="my kz iq ms b gy mz na l nb nc">$./kubent<br/>6:25PM INF &gt;&gt;&gt; Kube No Trouble `kubent` &lt;&lt;&lt;<br/>6:25PM INF Initializing collectors and retrieving data<br/>6:25PM INF Retrieved 103 resources from collector name=Cluster<br/>6:25PM INF Retrieved 132 resources from collector name="Helm v2"<br/>6:25PM INF Retrieved 0 resources from collector name="Helm v3"<br/>6:25PM INF Loaded ruleset name=deprecated-1-16.rego<br/>6:25PM INF Loaded ruleset name=deprecated-1-20.rego<br/>__________________________________________________________________________________________<br/>&gt;&gt;&gt; 1.16 Deprecated APIs &lt;&lt;&lt;<br/>------------------------------------------------------------------------------------------<br/>KIND         NAMESPACE     NAME                    API_VERSION<br/>Deployment   default       nginx-deployment-old    apps/v1beta1<br/>Deployment   kube-system   event-exporter-v0.2.5   apps/v1beta1<br/>Deployment   kube-system   k8s-snapshots           extensions/v1beta1<br/>Deployment   kube-system   kube-dns                extensions/v1beta1<br/>__________________________________________________________________________________________<br/>&gt;&gt;&gt; 1.20 Deprecated APIs &lt;&lt;&lt;<br/>------------------------------------------------------------------------------------------<br/>KIND      NAMESPACE   NAME           API_VERSION<br/>Ingress   default     test-ingress   extensions/v1beta1</span></pre><h2 id="2405" class="my kz iq bd la nd ne dn le nf ng dp li jy nh ni lm kc nj nk lq kg nl nm lu nn bi translated">冥王星的例子</h2><pre class="kn ko kp kq gt mu ms mv mw aw mx bi"><span id="5bdc" class="my kz iq ms b gy mz na l nb nc">$ pluto detect-helm --helm-version 3 <br/>KIND          VERSION        DEPRECATED   RESOURCE NAME <br/>StatefulSet   apps/v1beta1   true         prod-rabbitmq-ha Deployment    apps/v1        false        goldilocks-controller Deployment    apps/v1        false        goldilocks-dashboard</span></pre><p id="47d9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦确定了不推荐使用的API，就可以使用<code class="fe mp mq mr ms b">kubectl convert</code>:</p><pre class="kn ko kp kq gt mu ms mv mw aw mx bi"><span id="af8d" class="my kz iq ms b gy mz na l nb nc">$ kubectl convert -f &lt;file&gt; --output-version &lt;group&gt;/&lt;version&gt;</span><span id="1795" class="my kz iq ms b gy no na l nb nc">(example)</span><span id="b624" class="my kz iq ms b gy no na l nb nc">$ kubectl convert -f deployment.yaml --output-version apps/v1</span></pre><p id="5a2a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">或者用新的apiVersions更新舵图并运行<code class="fe mp mq mr ms b">helm upgrade</code>。如果出于某种原因，您在迁移所有Helm图表之前升级了集群，或者如果Helm由于过时的API而失败，您可以使用<code class="fe mp mq mr ms b"><a class="ae kl" href="https://github.com/hickeyma/helm-mapkubeapis" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir">helm-mapkubeapis</strong></a></code> <strong class="jp ir"> </strong>工具来修补存储在configmap或secret中的Helm版本清单。</p><p id="01c7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，如果您在EKS或其他提供商上运行升级，而其他Kubernetes组件(如kube-proxy和CNI)不会自动升级，请确保也手动修补版本。</p></div></div>    
</body>
</html>