<html>
<head>
<title>Linux — CIDR Deep Dive</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Linux — CIDR 深度潜水</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/linux-cidr-deep-dive-ad31b69d846f?source=collection_archive---------2-----------------------#2022-06-18">https://blog.devgenius.io/linux-cidr-deep-dive-ad31b69d846f?source=collection_archive---------2-----------------------#2022-06-18</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><div class=""/><div class=""><h2 id="b24b" class="pw-subtitle-paragraph jo iq ir bd b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dk translated">先进的 CIDR 知识</h2></div><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj kg"><img src="../Images/3b7b4f57d567ea71d988cf3a57c65803.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8yw-hD2UbzsNQpGwladIPQ.png"/></div></div></figure><h1 id="105e" class="ks kt ir bd ku kv kw kx ky kz la lb lc jx ld jy le ka lf kb lg kd lh ke li lj bi translated">背景和历史</h1><p id="c7f6" class="pw-post-body-paragraph lk ll ir lm b ln lo js lp lq lr jv ls lt lu lv lw lx ly lz ma mb mc md me mf ik bi translated">如果你是 DevOps 工程师或者 SRE，你一定用过这两个命令中的一个:<code class="fe mg mh mi mj b">ifconfig</code>和<code class="fe mg mh mi mj b">ip addr</code>。对于网络故障排除，通常需要登录主机，通过运行以下命令来检查网络配置和状态:</p><pre class="kh ki kj kk gu mk mj ml mm aw mn bi"><span id="30e4" class="mo kt ir mj b gz mp mq l mr ms">root@test:~# ip addr<br/>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default <br/>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br/>    inet 127.0.0.1/8 scope host lo<br/>       valid_lft forever preferred_lft forever<br/>    inet6 ::1/128 scope host <br/>       valid_lft forever preferred_lft forever<br/>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000<br/>    link/ether fa:16:3e:c7:79:75 brd ff:ff:ff:ff:ff:ff<br/>    <strong class="mj is">inet 10.100.122.2/24</strong> brd 10.100.122.255 scope global eth0<br/>       valid_lft forever preferred_lft forever<br/>    inet6 fe80::f816:3eff:fec7:7975/64 scope link <br/>       valid_lft forever preferred_lft forever</span></pre><p id="596f" class="pw-post-body-paragraph lk ll ir lm b ln mt js lp lq mu jv ls lt mv lv lw lx mw lz ma mb mx md me mf ik bi translated">这个命令显示这台机器上的所有网卡。如你所见，每个网卡都有 IP 地址。IP 地址是网络世界中一个网卡的通信地址，相当于我们现实世界中的门牌号。</p><p id="7f16" class="pw-post-body-paragraph lk ll ir lm b ln mt js lp lq mu jv ls lt mv lv lw lx mw lz ma mb mx md me mf ik bi translated">既然是门牌号，就不能每个人都一样，否则会有冲突。比如大家都打电话№1001，6 单元，快递就无处可去了。所以有时候我们的电脑会弹出网络地址冲突，出现无法上网的情况，大部分都是 IP 地址冲突。</p><p id="ad7c" class="pw-post-body-paragraph lk ll ir lm b ln mt js lp lq mu jv ls lt mv lv lw lx mw lz ma mb mx md me mf ik bi translated">如上图，<code class="fe mg mh mi mj b">10.100.122.2</code>是 IP 地址。地址用点分隔成四部分，每部分 8 位，因此 IPv4 地址总共是 32 位。因为 IPv4 地址 it 不够，所以发明了 IPv6，也就是上面输出的<code class="fe mg mh mi mj b">inet6 fe80::f816:3eff:fec7:7975/64</code>。这个有 128 位，目前看起来足够了，但是谁知道以后会发生什么呢？</p><p id="e54e" class="pw-post-body-paragraph lk ll ir lm b ln mt js lp lq mu jv ls lt mv lv lw lx mw lz ma mb mx md me mf ik bi translated">原来 32 位 IP 地址不够用，分为 5 类。现在想想，当时分配地址是一种奢侈。</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div class="gi gj my"><img src="../Images/7884b801c43b76148bc03c88c223e2de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/0*V3u9ofxZn3QN8axc"/></div><figcaption class="mz na gk gi gj nb nc bd b be z dk translated">图片来自<a class="ae nd" href="https://knowledgeofthings.com/dividing-ip-addresses-part-i-classful-networking/" rel="noopener ugc nofollow" target="_blank">knowledgeofthings.com</a></figcaption></figure><p id="8896" class="pw-post-body-paragraph lk ll ir lm b ln mt js lp lq mu jv ls lt mv lv lw lx mw lz ma mb mx md me mf ik bi translated">在网络地址中，至少在设计的时候，对于 A、B、C 类主要有两部分，第一部分是网络号，后一部分是主机号。</p><p id="89b3" class="pw-post-body-paragraph lk ll ir lm b ln mt js lp lq mu jv ls lt mv lv lw lx mw lz ma mb mx md me mf ik bi translated">下表详细显示了三种类型的 A、B 和 C 地址中可以包含的主机数量。</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div class="gi gj ne"><img src="../Images/4cbc7ff6ad95d2e653cf86b795ea5927.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/0*OYXiinY2e-aH6ftP"/></div></figure><p id="f7cf" class="pw-post-body-paragraph lk ll ir lm b ln mt js lp lq mu jv ls lt mv lv lw lx mw lz ma mb mx md me mf ik bi translated">您可以看到，一个<code class="fe mg mh mi mj b">C</code>类地址所能容纳的最大主机数量太少，只有 254 台。而且一个<code class="fe mg mh mi mj b">B</code>类地址所能容纳的最大主机数量太多。一个网络下放 6 万多台机器，一般企业基本达不到这个规模，闲置地址浪费。</p><h1 id="f7d1" class="ks kt ir bd ku kv kw kx ky kz la lb lc jx ld jy le ka lf kb lg kd lh ke li lj bi translated">无类域内路由选择(Classless Inter-Domain Routing)</h1><p id="e46c" class="pw-post-body-paragraph lk ll ir lm b ln lo js lp lq lr jv ls lt lu lv lw lx ly lz ma mb mc md me mf ik bi translated">无类域间路由(CIDR)是一种分配 IP 地址和 IP 路由的方法。互联网协议(IP)标准的集合用于创建网络和单个设备的唯一标识符。</p><p id="d3ae" class="pw-post-body-paragraph lk ll ir lm b ln mt js lp lq mu jv ls lt mv lv lw lx mw lz ma mb mx md me mf ik bi translated">这种方法打破了原来设计的几种类型地址的惯例，将 32 位 IP 地址一分为二，前面是<strong class="lm is">网络号</strong>，后面是<strong class="lm is">主机号</strong>。</p><p id="55a3" class="pw-post-body-paragraph lk ll ir lm b ln mt js lp lq mu jv ls lt mv lv lw lx mw lz ma mb mx md me mf ik bi translated">在哪里分？如果你注意的话，可以看到<code class="fe mg mh mi mj b">10.100.122.2/24</code>，这个 IP 地址有一个斜杠，斜杠后面有一个数字 24。该地址表示为 CIDR。后 24 位是指在 32 位中，前 24 位是网络号，后 8 位是主机号。</p><p id="c431" class="pw-post-body-paragraph lk ll ir lm b ln mt js lp lq mu jv ls lt mv lv lw lx mw lz ma mb mx md me mf ik bi translated">CIDR 是在 1992 年引入的，这意味着路由表级别的网络“类”的概念已经被取消，取而代之的是“网络前缀”的概念。“无类型”意味着现在基于整个 32 位 IP 地址掩码做出路由决定。</p><p id="5f7a" class="pw-post-body-paragraph lk ll ir lm b ln mt js lp lq mu jv ls lt mv lv lw lx mw lz ma mb mx md me mf ik bi translated">它的 IP 地址是 A 类、B 类还是 C 类没什么区别，思路是:把很多 C 类地址组合起来进行 B 类地址分配。这种分配多个 IP 地址的方式可以将路由表中的许多条目总结成一个较小的数字。</p><p id="2899" class="pw-post-body-paragraph lk ll ir lm b ln mt js lp lq mu jv ls lt mv lv lw lx mw lz ma mb mx md me mf ik bi translated">要使用此合并，必须满足以下三个属性:</p><ul class=""><li id="20f0" class="nf ng ir lm b ln mt lq mu lt nh lx ni mb nj mf nk nl nm nn bi translated">当多个 IP 地址合并进行路由时，这些 IP 地址必须具有相同的高位地址位。</li><li id="5a48" class="nf ng ir lm b ln no lq np lt nq lx nr mb ns mf nk nl nm nn bi translated">路由表和路由算法必须扩展，以根据 32 位 IP 地址和 32 位掩码做出路由决策。</li><li id="5c46" class="nf ng ir lm b ln no lq np lt nq lx nr mb ns mf nk nl nm nn bi translated">除了 32 位地址之外，路由协议还必须扩展到 32 位掩码。</li></ul><p id="29e4" class="pw-post-body-paragraph lk ll ir lm b ln mt js lp lq mu jv ls lt mv lv lw lx mw lz ma mb mx md me mf ik bi translated">根据<a class="ae nd" href="https://datatracker.ietf.org/doc/html/rfc1466" rel="noopener ugc nofollow" target="_blank">RFC 1466【Gerich 1993】</a>将全球分为四个区域，每个区域被分配一个连续的 C 类地址:</p><ul class=""><li id="3430" class="nf ng ir lm b ln mt lq mu lt nh lx ni mb nj mf nk nl nm nn bi translated"><strong class="lm is">欧洲:</strong> <code class="fe mg mh mi mj b">194.0.0.0 ~ 195.255.255.255</code></li><li id="31dc" class="nf ng ir lm b ln no lq np lt nq lx nr mb ns mf nk nl nm nn bi translated"><strong class="lm is">北美:</strong>T2】</li><li id="d5cd" class="nf ng ir lm b ln no lq np lt nq lx nr mb ns mf nk nl nm nn bi translated"><strong class="lm is">中南美洲:</strong> <code class="fe mg mh mi mj b">200.0 .0.0 ~ 201.255.255.255</code></li><li id="7e64" class="nf ng ir lm b ln no lq np lt nq lx nr mb ns mf nk nl nm nn bi translated"><strong class="lm is">亚太:</strong>T4】</li></ul><p id="9031" class="pw-post-body-paragraph lk ll ir lm b ln mt js lp lq mu jv ls lt mv lv lw lx mw lz ma mb mx md me mf ik bi translated">这样每个区域大概有 3200 万个地址，另外 3200 万个地址<code class="fe mg mh mi mj b">204.0.0.0 ~ 223.255.255.255</code>留作备用。<br/>这种分配方式的优势显而易见:</p><ol class=""><li id="3ebf" class="nf ng ir lm b ln mt lq mu lt nh lx ni mb nj mf nt nl nm nn bi translated">地址的分配是连续的</li><li id="b505" class="nf ng ir lm b ln no lq np lt nq lx nr mb ns mf nt nl nm nn bi translated">CIDR 使路由表的设置变得更加容易</li></ol><p id="341d" class="pw-post-body-paragraph lk ll ir lm b ln mt js lp lq mu jv ls lt mv lv lw lx mw lz ma mb mx md me mf ik bi translated"><strong class="lm is">注:私有 IP CIDR 范围如下:</strong></p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj nu"><img src="../Images/854b63be3c013e0410444051ed414261.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*CJPvCaA-NnqpZZrg"/></div></div></figure><h1 id="ca61" class="ks kt ir bd ku kv kw kx ky kz la lb lc jx ld jy le ka lf kb lg kd lh ke li lj bi translated">CIDR 的例子</h1><p id="82e3" class="pw-post-body-paragraph lk ll ir lm b ln lo js lp lq lr jv ls lt lu lv lw lx ly lz ma mb mc md me mf ik bi translated">让我们来看看 CIDR 街区<code class="fe mg mh mi mj b">16.158.165.91/22</code>。您能找到该网络的首地址、子网掩码和广播地址吗？</p><p id="f6eb" class="pw-post-body-paragraph lk ll ir lm b ln mt js lp lq mu jv ls lt mv lv lw lx mw lz ma mb mx md me mf ik bi translated">如果您对第一个 IP 地址的回答是<code class="fe mg mh mi mj b">16.158.165.1</code>，那么这是错误的。我们来做一些分析。</p><p id="8320" class="pw-post-body-paragraph lk ll ir lm b ln mt js lp lq mu jv ls lt mv lv lw lx mw lz ma mb mx md me mf ik bi translated">由于<code class="fe mg mh mi mj b">/22</code>不是 8 的整数倍，所以不好处理。只能先转换成二进制。16.158 部分不动，占用前 16 位。中间的 165 变成了二进制的<code class="fe mg mh mi mj b">10100101</code>。除了前 16 位，还剩 6 位。所以，8 位中的前 6 位是网络号，<strong class="lm is"> 16.158。&lt; 101001 &gt; </strong>，<strong class="lm is"> &lt; 01 &gt; .91 </strong>为机器编号。</p><p id="012a" class="pw-post-body-paragraph lk ll ir lm b ln mt js lp lq mu jv ls lt mv lv lw lx mw lz ma mb mx md me mf ik bi translated">由于每个部分必须有 8 位，所以我们在网络号上再加两个<code class="fe mg mh mi mj b">0</code>,于是就变成了<strong class="lm is"> 16.158。&lt; 10100100 &gt; (16.158.164)。第一个可用的 IP 地址是 16.158.164.1。</strong>IP 地址范围为<strong class="lm is">16 . 158 . 164 . 0–16 . 158 . 167 . 255</strong>。</p><blockquote class="nv nw nx"><p id="4795" class="lk ll ny lm b ln mt js lp lq mu jv ls nz mv lv lw oa mw lz ma ob mx md me mf ik bi translated">注意，16.158.164.0 是网络地址，16.158.164.255 是网络广播地址。两个都是保留的。</p></blockquote><h1 id="0862" class="ks kt ir bd ku kv kw kx ky kz la lb lc jx ld jy le ka lf kb lg kd lh ke li lj bi translated">真实生活用例</h1><h2 id="8ab7" class="mo kt ir bd ku oc od dn ky oe of dp lc lt og oh le lx oi oj lg mb ok ol li om bi translated">要求:</h2><p id="4d77" class="pw-post-body-paragraph lk ll ir lm b ln lo js lp lq lr jv ls lt lu lv lw lx ly lz ma mb mc md me mf ik bi translated">一个企业需要 1000 个 IP 地址。ISP 有一个地址块<code class="fe mg mh mi mj b">200.0.64.0/18</code>。</p><h2 id="a4d0" class="mo kt ir bd ku oc od dn ky oe of dp lc lt og oh le lx oi oj lg mb ok ol li om bi translated">分析:</h2><p id="f048" class="pw-post-body-paragraph lk ll ir lm b ln lo js lp lq lr jv ls lt lu lv lw lx ly lz ma mb mc md me mf ik bi translated">因为 1000 个 IP 地址= <code class="fe mg mh mi mj b"> 2^10</code> = <code class="fe mg mh mi mj b">1024</code>，占用 10 个地址位。ISP 分配给企业的地址块可以是:<code class="fe mg mh mi mj b">200.0.68.0/22</code>(网络位 22，主机位 10)。</p><p id="770a" class="pw-post-body-paragraph lk ll ir lm b ln mt js lp lq mu jv ls lt mv lv lw lx mw lz ma mb mx md me mf ik bi translated">如果公司有四个子公司，每个子公司需要的 IP 地址是:</p><ul class=""><li id="8dfb" class="nf ng ir lm b ln mt lq mu lt nh lx ni mb nj mf nk nl nm nn bi translated">A 公司 500</li><li id="1de3" class="nf ng ir lm b ln no lq np lt nq lx nr mb ns mf nk nl nm nn bi translated">B 公司 250 英镑</li><li id="1524" class="nf ng ir lm b ln no lq np lt nq lx nr mb ns mf nk nl nm nn bi translated">C 公司 120 英镑</li><li id="3dde" class="nf ng ir lm b ln no lq np lt nq lx nr mb ns mf nk nl nm nn bi translated">D 公司 120</li></ul><p id="1520" class="pw-post-body-paragraph lk ll ir lm b ln mt js lp lq mu jv ls lt mv lv lw lx mw lz ma mb mx md me mf ik bi translated">我们先来分析一下地址块。</p><p id="bc85" class="pw-post-body-paragraph lk ll ir lm b ln mt js lp lq mu jv ls lt mv lv lw lx mw lz ma mb mx md me mf ik bi translated"><strong class="lm is"> ISP: 200.0.64.0/18 </strong></p><ul class=""><li id="fc33" class="nf ng ir lm b ln mt lq mu lt nh lx ni mb nj mf nk nl nm nn bi translated">第一个地址是:<code class="fe mg mh mi mj b">200.0.64.0 = 11001000.00000000.01000000.00000000</code></li><li id="addb" class="nf ng ir lm b ln no lq np lt nq lx nr mb ns mf nk nl nm nn bi translated">最后一个地址是:<code class="fe mg mh mi mj b">200.0.127.255 =11001000.00000000.01111111.11111111</code>T30】ISP 地址总数是<code class="fe mg mh mi mj b">2¹⁴ = 16384</code>。</li></ul><h2 id="993f" class="mo kt ir bd ku oc od dn ky oe of dp lc lt og oh le lx oi oj lg mb ok ol li om bi translated">企业 CIDRs</h2><p id="d850" class="pw-post-body-paragraph lk ll ir lm b ln lo js lp lq lr jv ls lt lu lv lw lx ly lz ma mb mc md me mf ik bi translated">该企业需要 1000 个 IP，因为<code class="fe mg mh mi mj b">2¹⁰ = 1024</code>所以我们可以计算出主机部分是 10 位，网络部分是 22 位。我们可以将<code class="fe mg mh mi mj b">200.0.64.0/22</code>分配给企业。</p><ul class=""><li id="a197" class="nf ng ir lm b ln mt lq mu lt nh lx ni mb nj mf nk nl nm nn bi translated">第一个地址:<code class="fe mg mh mi mj b">200.0.64.0 = 11001000.00000000.010000 00.00000000</code></li><li id="3b99" class="nf ng ir lm b ln no lq np lt nq lx nr mb ns mf nk nl nm nn bi translated">最后地址:<code class="fe mg mh mi mj b">200.0.67.255 = 11001000.00000000.010000 11.11111111</code></li></ul><p id="3d26" class="pw-post-body-paragraph lk ll ir lm b ln mt js lp lq mu jv ls lt mv lv lw lx mw lz ma mb mx md me mf ik bi translated">然后，我们可以计算每个子公司的网络部分:</p><ul class=""><li id="375a" class="nf ng ir lm b ln mt lq mu lt nh lx ni mb nj mf nk nl nm nn bi translated">公司 A，<code class="fe mg mh mi mj b">500 IPs = 2⁹ = 512 = 9 bits</code></li><li id="6718" class="nf ng ir lm b ln no lq np lt nq lx nr mb ns mf nk nl nm nn bi translated">B 公司，<code class="fe mg mh mi mj b">250 IPs = 2⁸ = 256 = 8 bits</code></li><li id="5e5f" class="nf ng ir lm b ln no lq np lt nq lx nr mb ns mf nk nl nm nn bi translated">C 公司，<code class="fe mg mh mi mj b">120 IPs = 2⁷ = 128 = 7 bits</code></li><li id="48cf" class="nf ng ir lm b ln no lq np lt nq lx nr mb ns mf nk nl nm nn bi translated">D 公司，<code class="fe mg mh mi mj b">120 IPs = 2⁷ = 128 = 7 bits</code></li></ul><p id="847a" class="pw-post-body-paragraph lk ll ir lm b ln mt js lp lq mu jv ls lt mv lv lw lx mw lz ma mb mx md me mf ik bi translated">因此，我们可以分配以下 CIDRs:</p><ul class=""><li id="4d9f" class="nf ng ir lm b ln mt lq mu lt nh lx ni mb nj mf nk nl nm nn bi translated">甲公司:<code class="fe mg mh mi mj b">200.0.64.0/23</code> ( <code class="fe mg mh mi mj b">200.0.64.0 ~ 200.0.65.255</code>)</li><li id="06aa" class="nf ng ir lm b ln no lq np lt nq lx nr mb ns mf nk nl nm nn bi translated">乙公司:<code class="fe mg mh mi mj b"> 200.0.66.0/24</code> ( <code class="fe mg mh mi mj b">200.0.66.0 ~ 200.0.66.255</code>)</li><li id="6638" class="nf ng ir lm b ln no lq np lt nq lx nr mb ns mf nk nl nm nn bi translated">丙公司:<code class="fe mg mh mi mj b">200.0.66.0/25</code> ( <code class="fe mg mh mi mj b">200.0.67.0 ~ 200.0.67.127</code>)</li><li id="9307" class="nf ng ir lm b ln no lq np lt nq lx nr mb ns mf nk nl nm nn bi translated">D 公司:<code class="fe mg mh mi mj b">200.0.67.128/25</code> ( <code class="fe mg mh mi mj b">200.0.67.128 ~ 200.0.67.255</code>)</li></ul><p id="5485" class="pw-post-body-paragraph lk ll ir lm b ln mt js lp lq mu jv ls lt mv lv lw lx mw lz ma mb mx md me mf ik bi translated">在现实生活中，你不需要做手工计算，有许多在线 CIDR 计算器你可以利用，如<a class="ae nd" href="https://www.ipaddressguide.com/cidr" rel="noopener ugc nofollow" target="_blank">https://www.ipaddressguide.com/cidr</a>。</p></div></div>    
</body>
</html>