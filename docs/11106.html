<html>
<head>
<title>How to Convert Kubernetes Manifests into Nomad Jobspecs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何将 Kubernetes 清单转换为 Nomad Jobspecs</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/how-to-convert-kubernetes-manifests-into-nomad-jobspecs-7a58d2fa07a0?source=collection_archive---------3-----------------------#2022-12-19">https://blog.devgenius.io/how-to-convert-kubernetes-manifests-into-nomad-jobspecs-7a58d2fa07a0?source=collection_archive---------3-----------------------#2022-12-19</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/51671d6b27bfbff4262b3744eda76ccf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*64xxAgjBbvhvXmsO"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">多伦多唐谷高尔夫球场的香蒲。Adri Villela 的照片。</figcaption></figure><p id="6da8" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">自从我开始<a class="ae jz" href="https://medium.com/@adri-v/list/justintime-nomad-cc5d249a172b" rel="noopener">探索 Nomad </a>以来，我喜欢做的事情之一就是获取<a class="ae jz" href="https://www.baeldung.com/ops/docker-compose" rel="noopener ugc nofollow" target="_blank"> Docker 撰写文件</a>和<a class="ae jz" href="https://stackoverflow.com/a/55132302" rel="noopener ugc nofollow" target="_blank"> Kubernetes 清单</a>，并将它们翻译成<a class="ae jz" href="https://nomadproject.io/" rel="noopener ugc nofollow" target="_blank">hashi corp Nomad</a><a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/job-specification" rel="noopener ugc nofollow" target="_blank">job spec</a>。我是在 2022 年 3 月为<a class="ae jz" href="https://medium.com/faun/just-in-time-nomad-running-temporal-on-nomad-5fee139f37ea" rel="noopener"> Temporal 做的，</a>也是在 2022 年夏天为一个<a class="ae jz" href="https://github.com/lightstep/tracetest-nomad" rel="noopener ugc nofollow" target="_blank">早期版本的 Tracetest 做的。</a></p><p id="1a4b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在我最新的 Nomadification 项目(TM)中，我得到了在 Nomad 上运行的<a class="ae jz" href="https://github.com/open-telemetry/opentelemetry-demo" rel="noopener ugc nofollow" target="_blank"> OpenTelemetry 演示应用</a>(当然还有<a class="ae jz" href="https://medium.com/@adri-v/list/hashiqube-bfdcb9c84e10" rel="noopener"> HashiQube </a>、<em class="ky"/>)。为此，我使用了<a class="ae jz" href="https://github.com/open-telemetry/opentelemetry-helm-charts/tree/main/charts/opentelemetry-demo" rel="noopener ugc nofollow" target="_blank"> OpenTelemetry 演示应用程序 Helm Chart </a>作为我的指南。在这样做的过程中，以及其他的 Nomadifications 中，我意识到我从来没有解释过从 Kubernetes 清单到 Nomad jobspecs 的转换过程。</p><p id="b3af" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">所以，你可能已经猜到了，今天，我将把 Kubernetes 清单转换成 Nomad 工作规范，这样，如果你发现自己处于这样一种情况，你会想，“哎呀，很高兴看到这个 Kubernetes 的东西在 Nomad 上运行，”你现在有一个过程了！</p><p id="93e2" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我将使用我最近将<a class="ae jz" href="https://github.com/open-telemetry/opentelemetry-helm-charts/tree/main/charts/opentelemetry-demo" rel="noopener ugc nofollow" target="_blank"> OpenTelemetry 演示应用 Helm Charts </a>转换为 Nomad jobspecs 的工作中的例子来说明这个过程。</p><p id="bea8" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">你准备好了吗？我们开始吧！</p><h1 id="aef7" class="kz la in bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">清单、舵表和工作规范…哦，我的天！</h1><p id="d9e0" class="pw-post-body-paragraph ka kb in kc b kd lx kf kg kh ly kj kk kl lz kn ko kp ma kr ks kt mb kv kw kx ig bi translated">虽然我喜欢与 Kubernetes 和 Nomad 一起工作，但我发现 Kubernetes 领域有一件事非常令人恼火:一个应用程序部署的 Kubernetes 清单是由各种 Kubernetes 对象的 YAML 定义的寻宝游戏组成的。然而，Nomad 采取了不同的方法，使用一个单一的<a class="ae jz" href="https://github.com/hashicorp/hcl" rel="noopener ugc nofollow" target="_blank"> HashiCorp 配置语言(HCL) </a> <a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/job-specification" rel="noopener ugc nofollow" target="_blank"> jobspec </a>文件作为定义你的应用的一站式商店。我个人觉得 Nomad HCL 更容易管理，因为移动部分更少，而且当涉及到将 Kubernetes 清单转换为 Nomad jobspecs 时，我发现使用单个文件会使事情简单很多。</p><p id="0389" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">为了将 Kubernetes 清单转换成 Nomad jobspec，我们首先需要从一个基本的 Nomad jobspec 开始。这将作为在 Nomad 中部署我们的应用程序的模板。</p><p id="b2e0" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">让我们从下面的模板 jobspec 开始。请记住，这是我们转换的起点。毕竟，有些服务比其他服务更复杂，因此对于有些服务，我们需要将下面的所有组件包含在我们的 jobspec 中，对于其他服务，我们可能最终会有一个更精简的 jobspec 版本。</p><pre class="mc md me mf gt mg mh mi bn mj mk bi"><span id="d25d" class="ml la in mh b be mm mn l mo mp">job "&lt;service_name&gt;" {<br/>  type        = "service"<br/>  datacenters = ["dc1"]<br/><br/>  group "&lt;service_name&gt;" {<br/>    count = 1<br/><br/>    network {<br/>      mode = "host"<br/><br/>      port "&lt;port_name&gt;" {<br/>        to = &lt;port_number&gt;<br/>      }<br/>    }<br/><br/>    service {<br/>      name = "&lt;service_name&gt;"<br/>      port = "&lt;port_name&gt;"<br/>      tags = [&lt;tags_here&gt;]<br/><br/>      check {<br/>        &lt;service_check_here&gt;<br/>      }<br/>    }<br/><br/> <br/>    task "&lt;service_name&gt;" {<br/>      driver = "docker"<br/> <br/>      config {<br/>        image = "&lt;image_name&gt;"<br/>        image_pull_timeout = "25m"<br/>        args = [&lt;args_go_here&gt;]<br/>        ports = ["&lt;port_name&gt;"]<br/>      }<br/><br/>      restart {<br/>        attempts = 10<br/>        delay    = "15s"<br/>        interval = "2m"<br/>        mode     = "delay"<br/>      }<br/><br/>      env {<br/>          &lt;env_vars_here&gt;<br/>      }      <br/><br/>      template {<br/>        data = &lt;&lt;EOF<br/>&lt;env_vars_derived_from_consul&gt;<br/>EOF<br/>        destination = "local/env"<br/>        env         = true<br/>      }<br/><br/>      resources {<br/>        cpu    = 60<br/>        memory = 650<br/>      }<br/><br/>    }<br/>  }<br/>}</span></pre><p id="02dd" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">太好了…现在我们有了 jobspec 模板。耶！但是我们需要填补空白，不是吗？那么…我们从哪里开始？</p><p id="baca" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">因为我们要从 Kubernetes 到 Nomad，所以我们需要查看应用程序的 Kubernetes 清单。幸运的是，我们可以很容易地从<a class="ae jz" href="https://github.com/open-telemetry/opentelemetry-helm-charts" rel="noopener ugc nofollow" target="_blank"> OTel 舵图报告</a>中获取这些信息，正如你可能已经猜到的，OTel 演示应用有一个<a class="ae jz" href="https://github.com/open-telemetry/opentelemetry-helm-charts/blob/main/charts/opentelemetry-demo" rel="noopener ugc nofollow" target="_blank">舵图。它还包含了我们可用的渲染 YAML 清单</a><a class="ae jz" href="https://github.com/open-telemetry/opentelemetry-helm-charts/blob/main/charts/opentelemetry-demo/examples/default/rendered/component.yaml" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><p id="88bc" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">OpenTelemetry 演示应用程序由许多服务组成。将每个服务的 Kubernetes 清单转换为其对应的 Nomad jobspec 的过程非常相似，因此为了不让您感到厌烦，我将选择一个服务来说明这种转换:featureflagservice。</p><h1 id="5741" class="kz la in bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">转化过程</h1><p id="ff47" class="pw-post-body-paragraph ka kb in kc b kd lx kf kg kh ly kj kk kl lz kn ko kp ma kr ks kt mb kv kw kx ig bi translated">有了 Nomad jobspec 模板和 Kubernetes 清单，我们就可以开始转换了！</p><blockquote class="mq mr ms"><p id="7f59" class="ka kb ky kc b kd ke kf kg kh ki kj kk mt km kn ko mu kq kr ks mv ku kv kw kx ig bi translated"><strong class="kc io">注:</strong> <em class="in">你可以在这里</em>  <em class="in">找到包含所有 OpenTelemetry Demo App jobspec 文件的回购。</em></p></blockquote><h2 id="3e36" class="mw la in bd lb mx my dn lf mz na dp lj kl nb nc ln kp nd ne lr kt nf ng lv nh bi translated">1-拿到库伯内特公司的货单</h2><p id="3e5a" class="pw-post-body-paragraph ka kb in kc b kd lx kf kg kh ly kj kk kl lz kn ko kp ma kr ks kt mb kv kw kx ig bi translated">正如我前面提到的，OpenTelemetry 演示应用程序的渲染 YAML 清单可以在这里获得。因为在本教程中，我们只关心<a class="ae jz" href="https://github.com/open-telemetry/opentelemetry-demo/tree/main/src/featureflagservice" rel="noopener ugc nofollow" target="_blank"> featureflagservice </a>的 Kubernetes 清单，所以我已经获取了与<a class="ae jz" href="https://github.com/open-telemetry/opentelemetry-demo/tree/main/src/featureflagservice" rel="noopener ugc nofollow" target="_blank"> featureflagservice </a>相关的清单，它由一个<a class="ae jz" href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/" rel="noopener ugc nofollow" target="_blank">部署</a>和一个<a class="ae jz" href="https://kubernetes.io/docs/concepts/services-networking/service/" rel="noopener ugc nofollow" target="_blank">服务</a>组成，如下所示。</p><p id="cfa1" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">下面是 YAML 的<a class="ae jz" href="https://github.com/open-telemetry/opentelemetry-helm-charts/blob/6fdb0d3d0e22e550c30c0d5c61f428bbe8ed3aa1/charts/opentelemetry-demo/examples/default/rendered/component.yaml#L829-L901" rel="noopener ugc nofollow" target="_blank">部署:</a></p><pre class="mc md me mf gt mg mh mi bn mj mk bi"><span id="b2ef" class="ml la in mh b be mm mn l mo mp">---<br/># Source: opentelemetry-demo/templates/component.yaml<br/>apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: example-featureflagservice<br/>  labels:<br/>    helm.sh/chart: opentelemetry-demo-0.14.3<br/>    app.kubernetes.io/name: example<br/>    app.kubernetes.io/instance: example<br/>    app.kubernetes.io/component: featureflagservice<br/>    app.kubernetes.io/version: "1.2.1"<br/>    app.kubernetes.io/part-of: opentelemetry-demo<br/>    app.kubernetes.io/managed-by: Helm<br/>spec:<br/>  selector:<br/>    matchLabels:<br/>      app.kubernetes.io/name: example<br/>      app.kubernetes.io/instance: example<br/>      app.kubernetes.io/component: featureflagservice<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app.kubernetes.io/name: example<br/>        app.kubernetes.io/instance: example<br/>        app.kubernetes.io/component: featureflagservice<br/>    spec:<br/>      containers:<br/>        - name: featureflagservice<br/>          image: 'ghcr.io/open-telemetry/demo:v1.2.1-featureflagservice'<br/>          imagePullPolicy: IfNotPresent<br/>          ports:<br/>          <br/>          - containerPort: 50053<br/>            name: grpc<br/>          - containerPort: 8081<br/>            name: http<br/>          env:<br/>          - name: OTEL_SERVICE_NAME<br/>            valueFrom:<br/>              fieldRef:<br/>                apiVersion: v1<br/>                fieldPath: metadata.labels['app.kubernetes.io/component']<br/>          - name: OTEL_K8S_NAMESPACE<br/>            valueFrom:<br/>              fieldRef:<br/>                apiVersion: v1<br/>                fieldPath: metadata.namespace<br/>          - name: OTEL_K8S_NODE_NAME<br/>            valueFrom:<br/>              fieldRef:<br/>                apiVersion: v1<br/>                fieldPath: spec.nodeName<br/>          - name: OTEL_K8S_POD_NAME<br/>            valueFrom:<br/>              fieldRef:<br/>                apiVersion: v1<br/>                fieldPath: metadata.name<br/>          - name: FEATURE_FLAG_GRPC_SERVICE_PORT<br/>            value: "50053"<br/>          - name: FEATURE_FLAG_SERVICE_PORT<br/>            value: "8081"<br/>          - name: OTEL_EXPORTER_OTLP_TRACES_PROTOCOL<br/>            value: grpc<br/>          - name: DATABASE_URL<br/>            value: ecto://ffs:ffs@example-ffspostgres:5432/ffs<br/>          - name: OTEL_EXPORTER_OTLP_ENDPOINT<br/>            value: http://example-otelcol:4317<br/>          - name: OTEL_RESOURCE_ATTRIBUTES<br/>            value: service.name=$(OTEL_SERVICE_NAME),k8s.namespace.name=$(OTEL_K8S_NAMESPACE),k8s.node.name=$(OTEL_K8S_NODE_NAME),k8s.pod.name=$(OTEL_K8S_POD_NAME)<br/>          resources:<br/>            limits:<br/>              memory: 175Mi</span></pre><p id="b333" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这里是<a class="ae jz" href="https://github.com/open-telemetry/opentelemetry-helm-charts/blob/6fdb0d3d0e22e550c30c0d5c61f428bbe8ed3aa1/charts/opentelemetry-demo/examples/default/rendered/component.yaml#L121-L147" rel="noopener ugc nofollow" target="_blank">服务 YAML </a>:</p><pre class="mc md me mf gt mg mh mi bn mj mk bi"><span id="b090" class="ml la in mh b be mm mn l mo mp">---<br/># Source: opentelemetry-demo/templates/component.yaml<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: example-featureflagservice<br/>  labels:<br/>    helm.sh/chart: opentelemetry-demo-0.14.3<br/>    app.kubernetes.io/name: example<br/>    app.kubernetes.io/instance: example<br/>    app.kubernetes.io/component: featureflagservice<br/>    app.kubernetes.io/version: "1.2.1"<br/>    app.kubernetes.io/part-of: opentelemetry-demo<br/>    app.kubernetes.io/managed-by: Helm<br/>spec:<br/>  type: ClusterIP<br/>  ports:<br/>    - port: 50053<br/>      name: grpc<br/>      targetPort: 50053<br/>    - port: 8081<br/>      name: http<br/>      targetPort: 8081<br/>  selector:<br/>    app.kubernetes.io/name: example<br/>    app.kubernetes.io/instance: example<br/>    app.kubernetes.io/component: featureflagservice</span></pre><p id="4344" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">呀！这一切看起来让人不知所措，不是吗？幸运的是，它没有看起来那么可怕。别担心…我会指引你的。我们继续吧。</p><h2 id="0719" class="mw la in bd lb mx my dn lf mz na dp lj kl nb nc ln kp nd ne lr kt nf ng lv nh bi translated">2-准备工作说明书</h2><p id="86c1" class="pw-post-body-paragraph ka kb in kc b kd lx kf kg kh ly kj kk kl lz kn ko kp ma kr ks kt mb kv kw kx ig bi translated">有了我们的 Kubernetes YAMLs，让我们回到前面的 jobspec 模板，并填充一些空白。因为我们知道我们正在使用的是<a class="ae jz" href="https://github.com/open-telemetry/opentelemetry-demo/tree/main/src/featureflagservice" rel="noopener ugc nofollow" target="_blank"> featureflagservice </a>，所以我将<code class="fe ni nj nk mh b">&lt;service_name&gt; </code>替换为<code class="fe ni nj nk mh b">featureflagservice</code>，这意味着现在我们的模板看起来像这样:</p><pre class="mc md me mf gt mg mh mi bn mj mk bi"><span id="31d3" class="ml la in mh b be mm mn l mo mp">job "featureflagservice" {<br/>  type        = "service"<br/>  datacenters = ["dc1"]<br/><br/>  group "featureflagservice" {<br/>    count = 1<br/><br/>    network {<br/>      mode = "host"<br/><br/>      port "&lt;port_name&gt;" {<br/>        to = &lt;port_number&gt;<br/>      }<br/>    }<br/><br/>    service {<br/>      name = "&lt;service_name&gt;"<br/>      port = "&lt;port_name&gt;"<br/>      tags = [&lt;tags_here&gt;]<br/><br/>      check {<br/>        &lt;service_check_here&gt;<br/>      }<br/>    }<br/><br/> <br/>    task "featureflagservice" {<br/>      driver = "docker"<br/> <br/>      config {<br/>        image = "&lt;image_name&gt;"<br/>        image_pull_timeout = "25m"<br/>        args = [&lt;args_go_here&gt;]<br/>        entrypoint = [&lt;entrypoints_go_here&gt;]<br/>        ports = ["&lt;port_name&gt;"]<br/>      }<br/><br/>      restart {<br/>        attempts = 10<br/>        delay    = "15s"<br/>        interval = "2m"<br/>        mode     = "delay"<br/>      }<br/><br/>      env {<br/>          &lt;env_vars_here&gt;<br/>      }      <br/><br/>      template {<br/>        data = &lt;&lt;EOF<br/>&lt;env_vars_derived_from_consul&gt;<br/>EOF<br/>        destination = "local/env"<br/>        env         = true<br/>      }<br/><br/>      resources {<br/>        cpu    = 60<br/>        memory = 650<br/>      }<br/><br/>    }<br/>  }<br/>}</span></pre><blockquote class="mq mr ms"><p id="2327" class="ka kb ky kc b kd ke kf kg kh ki kj kk mt km kn ko mu kq kr ks mv ku kv kw kx ig bi translated"><strong class="kc io">注意:</strong> <em class="in">从技术上讲，你可以给你的工作、任务和团队取不同的名字，比如</em> <code class="fe ni nj nk mh b"><em class="in">featureflagservice-job</em></code> <em class="in">，</em> <code class="fe ni nj nk mh b"><em class="in">featureflagservice-task</em></code> <em class="in">和</em> <code class="fe ni nj nk mh b"><em class="in">featureflagservice-group</em></code> <em class="in">(或者任何你想取的名字)，但是为了简单起见(有点缺乏创意)，我决定给它们取同一个名字:</em> <code class="fe ni nj nk mh b"><em class="in">featureflagservice</em></code> <em class="in">。</em></p></blockquote><p id="3268" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">一些有用的术语:</p><ul class=""><li id="d7d6" class="nl nm in kc b kd ke kh ki kl nn kp no kt np kx nq nr ns nt bi translated"><code class="fe ni nj nk mh b">job</code>是控制的单位。工作是你开始、停止和更新的事情。</li><li id="2b85" class="nl nm in kc b kd nu kh nv kl nw kp nx kt ny kx nq nr ns nt bi translated"><code class="fe ni nj nk mh b">group</code>是刻度的单位。该组定义了您正在运行的实例数量。</li><li id="0af8" class="nl nm in kc b kd nu kh nv kl nw kp nx kt ny kx nq nr ns nt bi translated"><code class="fe ni nj nk mh b">task</code>是工作的单位。任务是您实际想要运行的。</li></ul><h2 id="a675" class="mw la in bd lb mx my dn lf mz na dp lj kl nb nc ln kp nd ne lr kt nf ng lv nh bi translated">3 端口定义</h2><p id="e505" class="pw-post-body-paragraph ka kb in kc b kd lx kf kg kh ly kj kk kl lz kn ko kp ma kr ks kt mb kv kw kx ig bi translated">我们需要填充的下一组空白在<a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/job-specification/network" rel="noopener ugc nofollow" target="_blank">网络</a>节中。更具体地说，端口节中的<code class="fe ni nj nk mh b">&lt;port_name&gt;</code>和<code class="fe ni nj nk mh b">&lt;port_number&gt;</code>值。</p><p id="1ac7" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如果我们看看上面的<a class="ae jz" href="https://github.com/open-telemetry/opentelemetry-demo/tree/main/src/featureflagservice" rel="noopener ugc nofollow" target="_blank"> featureflagservice </a>的<a class="ae jz" href="https://github.com/open-telemetry/opentelemetry-helm-charts/blob/6fdb0d3d0e22e550c30c0d5c61f428bbe8ed3aa1/charts/opentelemetry-demo/examples/default/rendered/component.yaml#L121-L147" rel="noopener ugc nofollow" target="_blank">服务 YAML </a>，你会注意到它公开了两个端口:<code class="fe ni nj nk mh b">50053</code> (gRPC)和<code class="fe ni nj nk mh b">8081</code> (HTTP)，每个<code class="fe ni nj nk mh b">spec -&gt; ports -&gt; targetPort</code>。让我们将这些插入到我们的工作规范中:</p><pre class="mc md me mf gt mg mh mi bn mj mk bi"><span id="4c0a" class="ml la in mh b be mm mn l mo mp">network {<br/>  mode = "host"<br/><br/>  port "http" {<br/>    to = 8081<br/>  }<br/>  port "grpc" {<br/>    to = 50053<br/>  }<br/>}</span></pre><p id="5ce4" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">正如您在上面的片段中看到的，我们标记(命名)了我们的端口<code class="fe ni nj nk mh b">http</code>和<code class="fe ni nj nk mh b">grpc</code>。这些标签将允许我们用一个人性化的标签来指代这些端口，而不是用数字。这意味着，如果一个或两个端口号发生变化，我们只需要在一个地方进行更改。剧透:我们将在 jobspec 的其他地方提到这些端口。</p><blockquote class="mq mr ms"><p id="e16e" class="ka kb ky kc b kd ke kf kg kh ki kj kk mt km kn ko mu kq kr ks mv ku kv kw kx ig bi translated"><strong class="kc io">注意:</strong> <em class="in">你可以随意给你的端口贴上任何你想要的标签——只要确保它是合理的描述性的。</em></p></blockquote><h2 id="86dc" class="mw la in bd lb mx my dn lf mz na dp lj kl nb nc ln kp nd ne lr kt nf ng lv nh bi translated">4-服务定义</h2><p id="3421" class="pw-post-body-paragraph ka kb in kc b kd lx kf kg kh ly kj kk kl lz kn ko kp ma kr ks kt mb kv kw kx ig bi translated">既然我们已经定义了我们的端口，我们需要注册我们的服务，这是通过<a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/job-specification/service" rel="noopener ugc nofollow" target="_blank">服务</a>节来完成的。由于我们在上面的<a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/job-specification/network" rel="noopener ugc nofollow" target="_blank">网络</a>节中有两个端口，我们需要定义两个<a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/job-specification/service" rel="noopener ugc nofollow" target="_blank">服务</a>:每个端口一个。</p><p id="605f" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><code class="fe ni nj nk mh b">http</code>端口的<a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/job-specification/service" rel="noopener ugc nofollow" target="_blank">服务</a>定义如下:</p><pre class="mc md me mf gt mg mh mi bn mj mk bi"><span id="8e52" class="ml la in mh b be mm mn l mo mp">service {<br/>  name = "featureflagservice-http"<br/>  port = "http"<br/>  tags = [<br/>    "traefik.http.routers.otel-collector-http.rule=Host(`featureflag.localhost`)",<br/>    "traefik.http.routers.otel-collector-http.entrypoints=web",<br/>    "traefik.http.routers.otel-collector-http.tls=false",<br/>    "traefik.enable=true",<br/>  ]<br/><br/>  check {<br/>    type     = "tcp"<br/>    interval = "10s"<br/>    timeout  = "5s"<br/>  }<br/>}</span></pre><p id="3a7e" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">值得注意的事项:</p><ul class=""><li id="1831" class="nl nm in kc b kd ke kh ki kl nn kp no kt np kx nq nr ns nt bi translated">默认情况下，<a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/job-specification/service" rel="noopener ugc nofollow" target="_blank">服务</a>注册到<a class="ae jz" href="https://consul.io/" rel="noopener ugc nofollow" target="_blank">咨询</a>。虽然我们没有明确这样说，但这相当于给<a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/job-specification/service" rel="noopener ugc nofollow" target="_blank">服务</a>节添加了一个<code class="fe ni nj nk mh b">provider = “consul”</code>属性。你可以向 Nomad 或 Consul 注册你的服务。</li><li id="66d4" class="nl nm in kc b kd nu kh nv kl nw kp nx kt ny kx nq nr ns nt bi translated"><a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/job-specification/service#port" rel="noopener ugc nofollow" target="_blank">端口</a>属性是<a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/job-specification/service" rel="noopener ugc nofollow" target="_blank">服务</a>应用的<a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/job-specification/network" rel="noopener ugc nofollow" target="_blank">网络</a>端口标签。你完全可以使用你想要的端口号。</li><li id="722d" class="nl nm in kc b kd nu kh nv kl nw kp nx kt ny kx nq nr ns nt bi translated">这个<a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/job-specification/service" rel="noopener ugc nofollow" target="_blank">服务</a>叫做<code class="fe ni nj nk mh b">featureflagservice-http</code>。同样，您可以随意称呼它，尽管描述性的名称总是有帮助的。</li><li id="0a7d" class="nl nm in kc b kd nu kh nv kl nw kp nx kt ny kx nq nr ns nt bi translated">我们通过<a class="ae jz" href="https://traefik.io/" rel="noopener ugc nofollow" target="_blank"> Traefik </a>向外界公开这个<a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/job-specification/service" rel="noopener ugc nofollow" target="_blank">服务</a>，并且可以通过 URL:<a class="ae jz" href="http://featureflag.localhost/" rel="noopener ugc nofollow" target="_blank">http://feature flag . localhost</a>访问该服务(因为我是使用 HashiQube 在本地运行这个服务的<a class="ae jz" href="https://opentelemetry.io/blog/2022/otel-demo-app-nomad/" rel="noopener ugc nofollow" target="_blank">)。请记住，您还需要将</a><a class="ae jz" href="https://github.com/avillela/nomad-conversions/blob/main/otel-demo-app/jobspec/traefik.nomad" rel="noopener ugc nofollow" target="_blank"> Traefik jobspec </a>与<a class="ae jz" href="https://github.com/avillela/nomad-conversions/blob/main/otel-demo-app/jobspec/featureflagservice.nomad" rel="noopener ugc nofollow" target="_blank">featureflagservice job spec</a>一起部署，以便向外界公开该服务。要了解更多关于在 Nomad 上运行 Traefik 的信息，请查看<a class="ae jz" href="https://medium.com/@adri-v/just-in-time-nomad-running-traefik-on-hashiqube-7d6dfd8ef9d8" rel="noopener">这篇文章</a>和<a class="ae jz" href="https://medium.com/dev-genius/running-hashiqube-using-the-vagrant-docker-provider-3e551c0eca97" rel="noopener">这篇文章</a>。</li><li id="e1ee" class="nl nm in kc b kd nu kh nv kl nw kp nx kt ny kx nq nr ns nt bi translated"><a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/job-specification/check" rel="noopener ugc nofollow" target="_blank">检查</a>部分对服务进行健康检查，因为<a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/job-specification/service" rel="noopener ugc nofollow" target="_blank">服务</a>已注册到 Consul，所以健康检查在 Consul 上运行。上面的运行状况检查配置为每 10 秒运行一次，并且有 5 秒钟的时间让运行状况检查查询成功。Nomad 中的健康检查类似于<a class="ae jz" href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#define-a-liveness-command" rel="noopener ugc nofollow" target="_blank"> Kubernetes 活性探针</a>。设置<code class="fe ni nj nk mh b">on_update</code>属性创建了一个更接近于<a class="ae jz" href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#define-readiness-probes" rel="noopener ugc nofollow" target="_blank"> Kubernetes 就绪探测器</a>的东西。</li></ul><p id="c4c3" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><code class="fe ni nj nk mh b">grpc</code>端口的服务如下所示:</p><pre class="mc md me mf gt mg mh mi bn mj mk bi"><span id="7b86" class="ml la in mh b be mm mn l mo mp">service {<br/>  name = "featureflagservice-grpc"<br/>  port = "grpc"<br/><br/>  check {<br/>    type     = "tcp"<br/>    interval = "10s"<br/>    timeout  = "5s"<br/>  }<br/>}</span></pre><p id="4ce4" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">值得注意的事项:</p><ul class=""><li id="7570" class="nl nm in kc b kd ke kh ki kl nn kp no kt np kx nq nr ns nt bi translated">因为我们没有公开任何外部服务，所以 Traefik 配置不需要 tags 属性。</li><li id="8eb9" class="nl nm in kc b kd nu kh nv kl nw kp nx kt ny kx nq nr ns nt bi translated">port 属性指的是我们在前面的 network 小节中定义的 grpc 端口。</li><li id="3f26" class="nl nm in kc b kd nu kh nv kl nw kp nx kt ny kx nq nr ns nt bi translated">我们正在进行与对<code class="fe ni nj nk mh b">http</code>端口相同的运行状况检查。</li></ul><p id="dfec" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">有关健康检查的其他示例，请查看:</p><ul class=""><li id="99ae" class="nl nm in kc b kd ke kh ki kl nn kp no kt np kx nq nr ns nt bi translated"><a class="ae jz" href="https://github.com/avillela/nomad-conversions/blob/ed12ec3d4092a7816aadd2d761a98f9ef51dfb74/otel-demo-app/jobspec/recommendationservice.nomad#L25-L30" rel="noopener ugc nofollow" target="_blank">推荐服务工作规范</a>中的 gRPC 健康检查</li><li id="c2d1" class="nl nm in kc b kd nu kh nv kl nw kp nx kt ny kx nq nr ns nt bi translated">基于命令的健康检查，用于检查<a class="ae jz" href="https://github.com/avillela/nomad-conversions/blob/ed12ec3d4092a7816aadd2d761a98f9ef51dfb74/otel-demo-app/jobspec/ffspostgres.nomad#L63-L74" rel="noopener ugc nofollow" target="_blank"> ffspostgres 作业规范</a>中的数据库连接</li></ul><h2 id="2f30" class="mw la in bd lb mx my dn lf mz na dp lj kl nb nc ln kp nd ne lr kt nf ng lv nh bi translated">5-任务定义</h2><p id="6319" class="pw-post-body-paragraph ka kb in kc b kd lx kf kg kh ly kj kk kl lz kn ko kp ma kr ks kt mb kv kw kx ig bi translated">好了…现在我们准备定义我们的<a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/drivers/docker" rel="noopener ugc nofollow" target="_blank">任务</a>。因为我们正在运行容器化的工作负载，所以我们的任务使用了<a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/drivers/docker" rel="noopener ugc nofollow" target="_blank"> Docker 驱动程序</a>。</p><p id="7fa8" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">配置节</strong></p><p id="b16b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">由于我们使用的是<a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/drivers/docker" rel="noopener ugc nofollow" target="_blank"> Docker 驱动</a>，我们需要通过配置节向 Nomad 提供以下信息:</p><ul class=""><li id="c9ee" class="nl nm in kc b kd ke kh ki kl nn kp no kt np kx nq nr ns nt bi translated"><strong class="kc io">Docker 图像的名称。</strong>我们从<a class="ae jz" href="https://github.com/open-telemetry/opentelemetry-helm-charts/blob/6fdb0d3d0e22e550c30c0d5c61f428bbe8ed3aa1/charts/opentelemetry-demo/examples/default/rendered/component.yaml#L829-L901" rel="noopener ugc nofollow" target="_blank">部署 YAML </a>中的<a class="ae jz" href="https://github.com/open-telemetry/opentelemetry-helm-charts/blob/6fdb0d3d0e22e550c30c0d5c61f428bbe8ed3aa1/charts/opentelemetry-demo/examples/default/rendered/component.yaml#L858" rel="noopener ugc nofollow" target="_blank">规范- &gt;模板- &gt;规范- &gt;容器- &gt;图片</a>中获取此信息。在这种情况下，图像名称是<code class="fe ni nj nk mh b">ghcr.io/open-telemetry/demo:v1.2.1-featureflagservice</code>。</li><li id="3a67" class="nl nm in kc b kd nu kh nv kl nw kp nx kt ny kx nq nr ns nt bi translated"><strong class="kc io">Docker 映像正在使用的端口。</strong>我们从<a class="ae jz" href="https://github.com/open-telemetry/opentelemetry-helm-charts/blob/6fdb0d3d0e22e550c30c0d5c61f428bbe8ed3aa1/charts/opentelemetry-demo/examples/default/rendered/component.yaml#L829-L901" rel="noopener ugc nofollow" target="_blank">部署 YAML </a>中的<a class="ae jz" href="https://github.com/open-telemetry/opentelemetry-helm-charts/blob/6fdb0d3d0e22e550c30c0d5c61f428bbe8ed3aa1/charts/opentelemetry-demo/examples/default/rendered/component.yaml#L860-L865" rel="noopener ugc nofollow" target="_blank">规范- &gt;模板- &gt;规范- &gt;容器- &gt;端口</a>中获得此信息。在这种情况下，映像需要端口<code class="fe ni nj nk mh b">50053</code>和<code class="fe ni nj nk mh b">8081</code>，在我们的 jobspec 的<a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/job-specification/network" rel="noopener ugc nofollow" target="_blank"> network </a>节中，我们分别将其命名为 http 和 grpc</li></ul><pre class="mc md me mf gt mg mh mi bn mj mk bi"><span id="9f00" class="ml la in mh b be mm mn l mo mp">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: example-featureflagservice<br/>...<br/>spec:<br/>...<br/>    spec:<br/>      containers:<br/>        - name: featureflagservice<br/>          image: 'ghcr.io/open-telemetry/demo:v1.2.1-featureflagservice'<br/>...</span></pre><p id="774e" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这转化为<code class="fe ni nj nk mh b">featureflagservice</code> <a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/drivers/docker" rel="noopener ugc nofollow" target="_blank">任务</a>的<code class="fe ni nj nk mh b">config</code>节，如下所示:</p><pre class="mc md me mf gt mg mh mi bn mj mk bi"><span id="4687" class="ml la in mh b be mm mn l mo mp">config {<br/>  image = "ghcr.io/open-telemetry/demo:v1.2.1-featureflagservice"<br/>  image_pull_timeout = "25m"<br/>  ports = ["http", "grpc"]<br/>}</span></pre><p id="898b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">一些值得注意的事项:</p><ul class=""><li id="4301" class="nl nm in kc b kd ke kh ki kl nn kp no kt np kx nq nr ns nt bi translated">因为在<a class="ae jz" href="https://github.com/open-telemetry/opentelemetry-helm-charts/blob/6fdb0d3d0e22e550c30c0d5c61f428bbe8ed3aa1/charts/opentelemetry-demo/examples/default/rendered/component.yaml#L829-L901" rel="noopener ugc nofollow" target="_blank">部署 YAML </a>中没有<a class="ae jz" href="https://kubernetes.io/docs/tasks/inject-data-application/define-command-argument-container/#define-a-command-and-arguments-when-you-create-a-pod" rel="noopener ugc nofollow" target="_blank">参数</a>，所以我们在这个 jobspec 中省略了<code class="fe ni nj nk mh b">args</code>。如果你想看一个使用<code class="fe ni nj nk mh b">args</code>的 jobspec 示例，请查看<a class="ae jz" href="https://github.com/avillela/nomad-conversions/blob/ed12ec3d4092a7816aadd2d761a98f9ef51dfb74/otel-demo-app/jobspec/prometheus.nomad#L27-L40" rel="noopener ugc nofollow" target="_blank"> Prometheus jobspec </a>及其对应的<a class="ae jz" href="https://github.com/open-telemetry/opentelemetry-helm-charts/blob/2e467f23fdb6a236abc7effb037ef9330bbbb9f1/charts/opentelemetry-demo/examples/default/rendered/prometheus/deploy.yaml#L38-L46" rel="noopener ugc nofollow" target="_blank">部署 YAML </a>。</li><li id="0203" class="nl nm in kc b kd nu kh nv kl nw kp nx kt ny kx nq nr ns nt bi translated">由于在<a class="ae jz" href="https://github.com/open-telemetry/opentelemetry-helm-charts/blob/6fdb0d3d0e22e550c30c0d5c61f428bbe8ed3aa1/charts/opentelemetry-demo/examples/default/rendered/component.yaml#L829-L901" rel="noopener ugc nofollow" target="_blank">部署 YAML </a>中没有<a class="ae jz" href="https://kubernetes.io/docs/tasks/inject-data-application/define-command-argument-container/#define-a-command-and-arguments-when-you-create-a-pod" rel="noopener ugc nofollow" target="_blank">命令</a>，我们在此 jobspec 中省略了<code class="fe ni nj nk mh b">entrypoint</code>。如果您想查看使用<code class="fe ni nj nk mh b">entrypoint</code>的作业规范示例，请查看<a class="ae jz" href="https://github.com/avillela/nomad-conversions/blob/ed12ec3d4092a7816aadd2d761a98f9ef51dfb74/otel-demo-app/jobspec/otel-collector.nomad#L54-L58" rel="noopener ugc nofollow" target="_blank"> OTel 收集器作业规范</a>及其对应的<a class="ae jz" href="https://github.com/open-telemetry/opentelemetry-helm-charts/blob/6fdb0d3d0e22e550c30c0d5c61f428bbe8ed3aa1/charts/opentelemetry-demo/examples/default/rendered/opentelemetry-collector/deployment.yaml#L41-L46" rel="noopener ugc nofollow" target="_blank">部署 YAML </a>。</li><li id="c159" class="nl nm in kc b kd nu kh nv kl nw kp nx kt ny kx nq nr ns nt bi translated"><a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/drivers/docker#infra_image_pull_timeout" rel="noopener ugc nofollow" target="_blank"> image_pull_timeout </a>设置为 25 分钟。这是一个可选值，如果您忽略它，它默认为 5 分钟。我将它设置为一个较高的值，因为有时你永远不知道你的网络是否决定给你一根手指，并且<a class="ae jz" href="https://danielabaron.me/blog/nomad-tips-and-tricks/#increase-docker-pull-timeout" rel="noopener ugc nofollow" target="_blank">我不希望作业失败，因为它不能在分配的时间内提取图像</a>。</li></ul><p id="1b61" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io"> Env 节</strong></p><p id="0808" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们还没有完全配置完我们的 featureflagservice <a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/drivers/docker" rel="noopener ugc nofollow" target="_blank">任务</a>。如果您查看<a class="ae jz" href="https://github.com/open-telemetry/opentelemetry-helm-charts/blob/6fdb0d3d0e22e550c30c0d5c61f428bbe8ed3aa1/charts/opentelemetry-demo/examples/default/rendered/component.yaml#L829-L901" rel="noopener ugc nofollow" target="_blank">部署 YAML </a>，您会注意到在<code class="fe ni nj nk mh b">env</code>标签下有许多环境变量:</p><pre class="mc md me mf gt mg mh mi bn mj mk bi"><span id="ca3f" class="ml la in mh b be mm mn l mo mp">env:<br/>  - name: OTEL_SERVICE_NAME<br/>    valueFrom:<br/>      fieldRef:<br/>        apiVersion: v1<br/>        fieldPath: metadata.labels['app.kubernetes.io/component']<br/>  - name: OTEL_K8S_NAMESPACE<br/>    valueFrom:<br/>      fieldRef:<br/>        apiVersion: v1<br/>        fieldPath: metadata.namespace<br/>  - name: OTEL_K8S_NODE_NAME<br/>    valueFrom:<br/>      fieldRef:<br/>        apiVersion: v1<br/>        fieldPath: spec.nodeName<br/>  - name: OTEL_K8S_POD_NAME<br/>    valueFrom:<br/>      fieldRef:<br/>        apiVersion: v1<br/>        fieldPath: metadata.name<br/>  - name: FEATURE_FLAG_GRPC_SERVICE_PORT<br/>    value: "50053"<br/>  - name: FEATURE_FLAG_SERVICE_PORT<br/>    value: "8081"<br/>  - name: OTEL_EXPORTER_OTLP_TRACES_PROTOCOL<br/>    value: grpc<br/>  - name: DATABASE_URL<br/>    value: ecto://ffs:ffs@example-ffspostgres:5432/ffs<br/>  - name: OTEL_EXPORTER_OTLP_ENDPOINT<br/>    value: http://example-otelcol:4317<br/>  - name: OTEL_RESOURCE_ATTRIBUTES<br/>    value: service.name=$(OTEL_SERVICE_NAME),k8s.namespace.name=$(OTEL_K8S_NAMESPACE),k8s.node.name=$(OTEL_K8S_NODE_NAME),k8s.pod.name=$(OTEL_K8S_POD_NAME)</span></pre><p id="986b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">您可以忽略以<code class="fe ni nj nk mh b">OTEL_K8S_</code>开头的，因为它们是特定于 Kubernetes 的；然而，我们确实关心这些:</p><ul class=""><li id="9a79" class="nl nm in kc b kd ke kh ki kl nn kp no kt np kx nq nr ns nt bi translated"><code class="fe ni nj nk mh b">OTEL_SERVICE_NAME</code></li><li id="6fe3" class="nl nm in kc b kd nu kh nv kl nw kp nx kt ny kx nq nr ns nt bi translated"><code class="fe ni nj nk mh b">FEATURE_FLAG_GRPC_SERVICE_PORT</code></li><li id="76be" class="nl nm in kc b kd nu kh nv kl nw kp nx kt ny kx nq nr ns nt bi translated"><code class="fe ni nj nk mh b">FEATURE_FLAG_SERVICE_PORT</code></li><li id="102e" class="nl nm in kc b kd nu kh nv kl nw kp nx kt ny kx nq nr ns nt bi translated"><code class="fe ni nj nk mh b">OTEL_EXPORTER_OTLP_TRACES_PROTOCOL</code></li><li id="17a0" class="nl nm in kc b kd nu kh nv kl nw kp nx kt ny kx nq nr ns nt bi translated"><code class="fe ni nj nk mh b">DATABASE_URL</code></li><li id="6538" class="nl nm in kc b kd nu kh nv kl nw kp nx kt ny kx nq nr ns nt bi translated"><code class="fe ni nj nk mh b">OTEL_EXPORTER_OTLP_ENDPOINT</code></li><li id="cdca" class="nl nm in kc b kd nu kh nv kl nw kp nx kt ny kx nq nr ns nt bi translated"><code class="fe ni nj nk mh b">OTEL_RESOURCE_ATTRIBUTES</code></li></ul><p id="8988" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">那么我们如何在 Nomad 中配置这些呢？通过<a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/drivers/docker" rel="noopener ugc nofollow" target="_blank">任务</a>的<a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/job-specification/env" rel="noopener ugc nofollow" target="_blank"> env </a>节。这意味着我们的环境变量看起来像这样:</p><pre class="mc md me mf gt mg mh mi bn mj mk bi"><span id="dbb1" class="ml la in mh b be mm mn l mo mp">env {<br/>  FEATURE_FLAG_GRPC_SERVICE_PORT = "${NOMAD_PORT_grpc}"<br/>  FEATURE_FLAG_SERVICE_PATH_ROOT = "\"/feature\""<br/>  FEATURE_FLAG_SERVICE_PORT = "${NOMAD_PORT_http}"<br/>  OTEL_EXPORTER_OTLP_TRACES_PROTOCOL = "grpc"<br/>  OTEL_RESOURCE_ATTRIBUTES = "service.name=featureflagservice"<br/>}</span></pre><p id="2652" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">一些值得注意的事项:</p><ul class=""><li id="5f8d" class="nl nm in kc b kd ke kh ki kl nn kp no kt np kx nq nr ns nt bi translated">我们使用的是<code class="fe ni nj nk mh b">NOMAD_PORT_grpc</code>和<code class="fe ni nj nk mh b">NOMAD_PORT_http</code>，而不是将<code class="fe ni nj nk mh b">FEATURE_FLAG_GRPC_SERVICE_PORT</code>的值硬编码为<code class="fe ni nj nk mh b">50053</code>和<code class="fe ni nj nk mh b">8081</code>。这些实际上是<a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/runtime/environment" rel="noopener ugc nofollow" target="_blank">运行时环境变量</a>，遵循<code class="fe ni nj nk mh b">NOMAD_PORT_&lt;label&gt;</code>命名约定。这可以防止您对端口号进行硬编码，如果端口号因为任何原因在<a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/job-specification/network" rel="noopener ugc nofollow" target="_blank">网络</a>节中发生变化，这将非常方便，因为您只需要在一个地方更改端口号。</li><li id="d751" class="nl nm in kc b kd nu kh nv kl nw kp nx kt ny kx nq nr ns nt bi translated">如果你查看<a class="ae jz" href="https://github.com/open-telemetry/opentelemetry-helm-charts/blob/6fdb0d3d0e22e550c30c0d5c61f428bbe8ed3aa1/charts/opentelemetry-demo/examples/default/rendered/component.yaml#L829-L901" rel="noopener ugc nofollow" target="_blank">部署 YAML </a>，你会注意到<code class="fe ni nj nk mh b">OTEL_RESOURCE_ATTRIBUTES</code>被设置为<code class="fe ni nj nk mh b">service.name=$(OTEL_SERVICE_NAME),k8s.namespace.name=$(OTEL_K8S_NAMESPACE),k8s.node.name=$(OTEL_K8S_NODE_NAME),k8s.pod.name=$(OTEL_K8S_POD_NAME)</code>。但是我只设置了<code class="fe ni nj nk mh b">OTEL_RESOURCE_ATTRIBUTES</code>到<code class="fe ni nj nk mh b">service.name=featureflagservice</code>。为什么？因为<a class="ae jz" href="https://github.com/open-telemetry/opentelemetry-helm-charts/blob/6fdb0d3d0e22e550c30c0d5c61f428bbe8ed3aa1/charts/opentelemetry-demo/examples/default/rendered/component.yaml#L829-L901" rel="noopener ugc nofollow" target="_blank">部署 YAML </a>中的其他属性与 Kubernetes 相关，所以我省略了它们。</li></ul><p id="e479" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">模板节</strong></p><p id="9be0" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">等等…但是为什么<code class="fe ni nj nk mh b">DATABASE_URL</code>和<code class="fe ni nj nk mh b">OTEL_EXPORTER_OTLP_ENDPOINT</code>不见了？？如果您查看<a class="ae jz" href="https://github.com/open-telemetry/opentelemetry-helm-charts/blob/6fdb0d3d0e22e550c30c0d5c61f428bbe8ed3aa1/charts/opentelemetry-demo/examples/default/rendered/component.yaml#L829-L901" rel="noopener ugc nofollow" target="_blank">部署 YAML </a>，您会注意到上面两个环境变量的值分别是<code class="fe ni nj nk mh b">ecto://ffs:ffs@example-ffspostgres:5432/ffs</code>和<code class="fe ni nj nk mh b">http://example-otelcol:4317</code>。</p><p id="28d6" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这就引出了一个问题……这是如何翻译成游牧语言的？<code class="fe ni nj nk mh b">example-ffspostgres</code>和<code class="fe ni nj nk mh b">example-otelcol</code>，分别是 Kubernetes 中<a class="ae jz" href="https://www.postgresql.org/" rel="noopener ugc nofollow" target="_blank"> PostgreSQL </a>和<a class="ae jz" href="https://opentelemetry.io/docs/collector/" rel="noopener ugc nofollow" target="_blank"> OpenTelemetry Collector </a>的服务名，所以如果我们试图在我们的 jobspec 定义中使用相同的名称，您将会从 Nomad 得到一个严重的错误。</p><p id="1529" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们可以使用这些服务的 IP 地址，但这不是一个好主意，因为服务的 IP 地址肯定会改变，所以如果地址改变，您的 jobspec 将无法部署。</p><p id="7c7b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们需要的是一种在给定服务名称的情况下动态获取服务 IP 地址的方法。这就是<a class="ae jz" href="https://consul.io/" rel="noopener ugc nofollow" target="_blank">领事</a>的作用。除此之外，<a class="ae jz" href="https://developer.hashicorp.com/consul/docs/concepts/service-discovery" rel="noopener ugc nofollow" target="_blank"> Consul 提供了服务发现</a>，这正是我们所需要的。</p><p id="ccc7" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">要使用 Consul 服务发现，我们需要以下内容:</p><ol class=""><li id="caa7" class="nl nm in kc b kd ke kh ki kl nn kp no kt np kx nz nr ns nt bi translated">我们引用的<a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/job-specification/service" rel="noopener ugc nofollow" target="_blank">服务</a>的名称</li><li id="0336" class="nl nm in kc b kd nu kh nv kl nw kp nx kt ny kx nz nr ns nt bi translated"><a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/job-specification/template" rel="noopener ugc nofollow" target="_blank">游牧模板节</a></li></ol><p id="d6f4" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Nomad <a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/job-specification/template" rel="noopener ugc nofollow" target="_blank">模板</a>节很容易让人想起 Kubernetes 配置图。根据<a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/job-specification/template" rel="noopener ugc nofollow" target="_blank"> Nomad 文档</a>，模板可以让你“在一个 Nomad 任务中传送配置文件，这些文件是由环境变量、咨询数据、保险库机密或者仅仅是一般配置填充的。”在我们的例子中，我们使用一个模板来查询 Consul 服务，这样我们就可以找到这些服务的 IP 地址和端口号，这样我们就可以填充我们的来填充剩下的两个环境变量，<code class="fe ni nj nk mh b">DATABASE_URL</code>和<code class="fe ni nj nk mh b">OTEL_EXPORTER_OTLP_ENDPOINT</code>。其代码如下所示:</p><pre class="mc md me mf gt mg mh mi bn mj mk bi"><span id="196e" class="ml la in mh b be mm mn l mo mp">template {<br/>  data = &lt;&lt;EOF<br/>{{ range service "ffspostgres-service" }}<br/>DATABASE_URL = "ecto://ffs:ffs@{{ .Address }}:{{ .Port }}/ffs"<br/>{{ end }}<br/><br/>{{ range service "otelcol-grpc" }}<br/>OTEL_EXPORTER_OTLP_TRACES_ENDPOINT = "http://{{ .Address }}:{{ .Port }}"<br/>{{ end }}<br/>EOF<br/>  destination = "local/env"<br/>  env         = true<br/>}</span></pre><p id="d62d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">值得注意的事项:</p><ul class=""><li id="570d" class="nl nm in kc b kd ke kh ki kl nn kp no kt np kx nq nr ns nt bi translated"><a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/job-specification/template" rel="noopener ugc nofollow" target="_blank">模板</a>节在<a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/drivers/docker" rel="noopener ugc nofollow" target="_blank">任务</a>节中定义。</li><li id="c97c" class="nl nm in kc b kd nu kh nv kl nw kp nx kt ny kx nq nr ns nt bi translated">从技术上讲，<code class="fe ni nj nk mh b">destination = “local/env”</code>行可以是任何东西(它基本上是一个标签)，但是真正重要的是<code class="fe ni nj nk mh b">env = true</code>，它告诉 Nomad 将这些作为环境变量导出</li><li id="032a" class="nl nm in kc b kd nu kh nv kl nw kp nx kt ny kx nq nr ns nt bi translated">线路<code class="fe ni nj nk mh b">{{ range service “ffspostgres-service” }}</code>告诉 Nomad 在 Consul 中寻找一个名为<code class="fe ni nj nk mh b">ffspostgres-service</code>的服务。一旦它找到服务名，我们就可以分别使用<code class="fe ni nj nk mh b">{{ .Address }}</code>和<code class="fe ni nj nk mh b">{{ .Port }}</code>获取服务的 IP 地址和端口号。</li><li id="e5cd" class="nl nm in kc b kd nu kh nv kl nw kp nx kt ny kx nq nr ns nt bi translated">类似地，代码行<code class="fe ni nj nk mh b">{{ range service “otelcol-grpc” }}</code>告诉 Nomad 寻找一个名为<code class="fe ni nj nk mh b">otelcol-grpc</code>的服务。一旦它找到服务名，我们就可以分别使用<code class="fe ni nj nk mh b">{{ .Address }}</code>和<code class="fe ni nj nk mh b">{{ .Port }}</code>获取服务的 IP 地址和端口号。</li></ul><p id="3547" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">但是等等…这些服务名到底是从哪里来的？？嗯，还记得我们在上面的<strong class="kc io">步骤 4 </strong>中定义<a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/job-specification/service" rel="noopener ugc nofollow" target="_blank">服务</a>时，我们给每个服务取了一个名字吗？</p><p id="a1fa" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><code class="fe ni nj nk mh b">ffspostgres-service</code>是<a class="ae jz" href="https://github.com/avillela/nomad-conversions/blob/ed12ec3d4092a7816aadd2d761a98f9ef51dfb74/otel-demo-app/jobspec/ffspostgres.nomad#L59-L74" rel="noopener ugc nofollow" target="_blank"> PostgreSQL 服务</a>的名称。你可以在这里查看游牧服务的定义<a class="ae jz" href="https://github.com/avillela/nomad-conversions/blob/ed12ec3d4092a7816aadd2d761a98f9ef51dfb74/otel-demo-app/jobspec/ffspostgres.nomad#L59-L74" rel="noopener ugc nofollow" target="_blank"/>。(<strong class="kc io">暂且不提:</strong>注意<a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/job-specification/service" rel="noopener ugc nofollow" target="_blank">服务</a>的<a class="ae jz" href="https://github.com/avillela/nomad-conversions/blob/ed12ec3d4092a7816aadd2d761a98f9ef51dfb74/otel-demo-app/jobspec/ffspostgres.nomad#L63-L74" rel="noopener ugc nofollow" target="_blank">基于命令的健康检查，以检查数据库连接</a>。)</p><p id="98dc" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">类似地，<code class="fe ni nj nk mh b">otelcol-grpc</code>是 OpenTelemetry Collector 的<a class="ae jz" href="https://github.com/avillela/nomad-conversions/blob/ed12ec3d4092a7816aadd2d761a98f9ef51dfb74/otel-demo-app/jobspec/otel-collector.nomad#L190-L199" rel="noopener ugc nofollow" target="_blank"> gRPC 服务的名称。你可以在这里查看服务定义</a><a class="ae jz" href="https://github.com/avillela/nomad-conversions/blob/ed12ec3d4092a7816aadd2d761a98f9ef51dfb74/otel-demo-app/jobspec/otel-collector.nomad#L190-L199" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="c182" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">有关咨询服务发现的更多信息，请查看这个 HashiCorp 论坛。此外，Nomad 现在有本地服务发现无领事。欲了解更多信息，请点击查看文档<a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/networking/service-discovery" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="7697" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">关于配置文件使用<a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/job-specification/template" rel="noopener ugc nofollow" target="_blank">模板</a>节的例子，请点击查看 OpenTelemetry Collector 的工作规范<a class="ae jz" href="https://github.com/avillela/nomad-conversions/blob/ed12ec3d4092a7816aadd2d761a98f9ef51dfb74/otel-demo-app/jobspec/otel-collector.nomad#L89-L143" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="8a41" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">重启规则</strong></p><p id="21cc" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">与<a class="ae jz" href="https://docs.docker.com/compose/compose-file/compose-file-v3/#depends_on" rel="noopener ugc nofollow" target="_blank"> Docker Compose </a>不同，您不能在 Nomad 中指定服务依赖(Kubernetes 也是如此)。所以，为了确保<code class="fe ni nj nk mh b">Service X</code>不会因为依赖于还没有开始的<code class="fe ni nj nk mh b">Service Y</code>而死在你面前，你可以实施一个<a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/job-specification/restart" rel="noopener ugc nofollow" target="_blank">重启</a>策略。下面是我为<a class="ae jz" href="https://github.com/open-telemetry/opentelemetry-demo/tree/main/src/featureflagservice" rel="noopener ugc nofollow" target="_blank"> featureflagservice </a>配置的<a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/job-specification/restart" rel="noopener ugc nofollow" target="_blank">重启</a>策略:</p><pre class="mc md me mf gt mg mh mi bn mj mk bi"><span id="f242" class="ml la in mh b be mm mn l mo mp">restart {<br/> attempts = 10<br/> delay = "15s"<br/> interval = "2m"<br/> mode = "delay"<br/>}</span></pre><p id="7f0c" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">上面的<a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/job-specification/restart" rel="noopener ugc nofollow" target="_blank">重启</a>策略声明 Nomad 将在 2 分钟内尝试重启作业 10 次。它将在两次重启之间等待 15 秒。如果在 10 次重启尝试后。默认情况下，如果作业仍未成功启动，Nomad 将使部署失败，作业将被终止。这由<a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/job-specification/restart#mode-values" rel="noopener ugc nofollow" target="_blank">模式</a>属性决定，默认为<a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/job-specification/restart#fail" rel="noopener ugc nofollow" target="_blank">失败</a>。这不是我们想要的，因此我们必须将<a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/job-specification/restart#mode-values" rel="noopener ugc nofollow" target="_blank">模式</a>设置为<a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/job-specification/restart#delay-1" rel="noopener ugc nofollow" target="_blank">延迟</a>。这告诉 Nomad 再重新启动作业 10 次。这个循环一直持续到作业最终成功启动。</p><p id="8428" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">资源分配</strong></p><p id="4837" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如果你关注我写的关于 Nomad 的文章，你会知道我是一个超级粉丝，喜欢用 HashiQube 在我的本地机器上运行 Hashi 环境。当然，这意味着我的计算能力比我在数据中心的 Nomad 中运行时要少得多。这意味着我必须非常注意我使用的资源，包括 CPU 和内存。</p><p id="e8ad" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">为了获得 CPU 和内存使用的正确值，我必须做一些尝试。首先，我在没有任何资源分配的情况下开始部署 jobspecs，并在 Nomad 中检查这些作业，看看我是否分配了过多或过少的资源。</p><p id="457e" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">对于内存利用率，我查看了服务的分配仪表板下消耗的资源:</p><figure class="mc md me mf gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi oa"><img src="../Images/6aa3930169e77fa1b0fbb5a0a39f7158.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*625G90BvTghQm4IB"/></div></div></figure><p id="1b19" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如果你看一下上面的<a class="ae jz" href="https://github.com/open-telemetry/opentelemetry-demo/tree/main/src/featureflagservice" rel="noopener ugc nofollow" target="_blank"> featureflagservice </a>的屏幕截图，你可以看到我使用了分配给这个 jobspec 的大约 60%的内存，这相当不错。如果我部署了一个服务，并看到它接近 100%的内存使用率(80%或以上)，我会增加使用的内存量。</p><p id="3da4" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><a class="ae jz" href="https://developer.hashicorp.com/nomad/tutorials/manage-jobs/jobs-utilization" rel="noopener ugc nofollow" target="_blank">如果您喜欢命令行</a>，您可以运行:</p><pre class="mc md me mf gt mg mh mi bn mj mk bi"><span id="8f61" class="ml la in mh b be mm mn l mo mp">export ALLOCATION_ID=$(nomad job allocs -json featureflagservice | jq -r '.[0].ID')<br/>nomad alloc status -stats $ALLOCATION_ID</span></pre><p id="d4b5" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">样本输出:</p><pre class="mc md me mf gt mg mh mi bn mj mk bi"><span id="25e6" class="ml la in mh b be mm mn l mo mp">…<br/>Task "featureflagservice" is "running"<br/>Task Resources:<br/>CPU Memory Disk Addresses<br/>0/55 MHz 151 MiB/250 MiB 300 MiB <br/>Memory Stats<br/>Cache Swap Usage<br/>0 B 0 B 151 MiB<br/>CPU Stats<br/>Percent Throttled Periods Throttled Time<br/>2.89% 0 0<br/>…</span></pre><p id="ec18" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">从上面的打印输出中可以看到，CPU 利用率在<code class="fe ni nj nk mh b">55 MHz</code>的<code class="fe ni nj nk mh b">0 MHz</code>处，内存利用率在<code class="fe ni nj nk mh b">250 MiB</code>的<code class="fe ni nj nk mh b">151 MiB</code>处。</p><p id="5935" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">对于 CPU 利用率，我查看 Nomad 的<a class="ae jz" href="https://www.hashicorp.com/blog/see-your-entire-cluster-at-once-with-nomad-s-topology-visualization" rel="noopener ugc nofollow" target="_blank">拓扑仪表板</a>。</p><figure class="mc md me mf gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi oa"><img src="../Images/07ea14d8d42bcace7511124dbbb482eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*JLgBQorpXm-bWtM-"/></div></div></figure><p id="8668" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">根据上面的截屏，你可以看到，对于我的所有服务，我在分配给我的<code class="fe ni nj nk mh b">2 GHz</code>中，为我的所有 jobspecs(所有 OTel 演示应用 jobspecs)使用了总计<code class="fe ni nj nk mh b">1.21 GHz</code>的 CPU(如果你好奇，我在 HashiQube 中配置了这个设置<a class="ae jz" href="https://github.com/avillela/hashiqube/blob/9dd8e08febcb295b44d2a834e9f5e024841a9d00/hashicorp/nomad.sh#L59-L60" rel="noopener ugc nofollow" target="_blank">)。通过从分配的资源利用率仪表板查看我的服务的 CPU 利用率，并通过从拓扑仪表板查看我有多少计算能力，我可以调整 CPU 利用率，以达到不会耗尽我分配的资源的值。根据一般经验，我希望确保我的所有服务都使用了 60–75%的分配资源。</a></p><p id="fe7b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">因此，记住所有这些，下面是我对<a class="ae jz" href="https://github.com/open-telemetry/opentelemetry-demo/tree/main/src/featureflagservice" rel="noopener ugc nofollow" target="_blank"> featureflagservice </a>的<a class="ae jz" href="https://developer.hashicorp.com/nomad/docs/job-specification/resources" rel="noopener ugc nofollow" target="_blank">资源</a>设置，其中 CPU 以 GHz 为单位，内存以 MiB ( <a class="ae jz" href="https://www.majordifferences.com/2018/03/differences-between-megabyte-and.html" rel="noopener ugc nofollow" target="_blank"> mebibytes </a>)为单位。</p><pre class="mc md me mf gt mg mh mi bn mj mk bi"><span id="b205" class="ml la in mh b be mm mn l mo mp">resources {<br/> cpu = 55<br/> memory = 250<br/>}</span></pre><h2 id="bbb1" class="mw la in bd lb mx my dn lf mz na dp lj kl nb nc ln kp nd ne lr kt nf ng lv nh bi translated">6-将所有这些放在一起…</h2><p id="1445" class="pw-post-body-paragraph ka kb in kc b kd lx kf kg kh ly kj kk kl lz kn ko kp ma kr ks kt mb kv kw kx ig bi translated">现在我们已经准备好了所有的东西，我们最终的 jobspec 如下所示:</p><pre class="mc md me mf gt mg mh mi bn mj mk bi"><span id="779d" class="ml la in mh b be mm mn l mo mp">job "featureflagservice" {<br/>  type        = "service"<br/>  datacenters = ["dc1"]<br/><br/>  group "featureflagservice" {<br/>    count = 1<br/><br/>    network {<br/>      mode = "host"<br/><br/>      port "http" {<br/>        to = 8081<br/>      }<br/>      port "grpc" {<br/>        to = 50053<br/>      }<br/>    }<br/><br/>    service {<br/>      name = "featureflagservice-http"<br/>      port = "http"<br/>      tags = [<br/>        "traefik.http.routers.featureflagservice.rule=Host(`feature.localhost`)",<br/>        "traefik.http.routers.featureflagservice.entrypoints=web",<br/>        "traefik.http.routers.featureflagservice.tls=false",<br/>        "traefik.enable=true",<br/>      ]<br/><br/>      check {<br/>        type     = "tcp"<br/>        interval = "10s"<br/>        timeout  = "5s"<br/>      }<br/>    }<br/><br/>    service {<br/>      name = "featureflagservice-grpc"<br/>      port = "grpc"<br/><br/>      check {<br/>        type     = "tcp"<br/>        interval = "10s"<br/>        timeout  = "5s"<br/>      }<br/>    }<br/><br/>    task "featureflagservice" {<br/>      driver = "docker"<br/> <br/>      config {<br/>        image = "otel/demo:v1.1.0-featureflagservice"<br/>        image_pull_timeout = "10m"<br/>        ports = ["http", "grpc"]<br/>      }<br/><br/>      restart {<br/>        attempts = 10<br/>        delay    = "15s"<br/>        interval = "2m"<br/>        mode     = "delay"<br/>      }<br/><br/>      env {<br/>        FEATURE_FLAG_GRPC_SERVICE_PORT = "${NOMAD_PORT_grpc}"<br/>        FEATURE_FLAG_SERVICE_PATH_ROOT = "\"/feature\""<br/>        FEATURE_FLAG_SERVICE_PORT = "${NOMAD_PORT_http}"<br/>        OTEL_EXPORTER_OTLP_TRACES_PROTOCOL = "grpc"<br/>        OTEL_SERVICE_NAME = "featureflagservice"<br/>      }<br/><br/>      template {<br/>        data = &lt;&lt;EOF<br/>{{ range service "ffspostgres-service" }}<br/>DATABASE_URL = "ecto://ffs:ffs@{{ .Address }}:{{ .Port }}/ffs"<br/>{{ end }}<br/><br/>{{ range service "otelcol-grpc" }}<br/>OTEL_EXPORTER_OTLP_TRACES_ENDPOINT = "http://{{ .Address }}:{{ .Port }}"<br/>{{ end }}<br/>EOF<br/>        destination = "local/env"<br/>        env         = true<br/>      }<br/><br/>      resources {<br/>        cpu    = 55<br/>        memory = 250<br/>      }<br/><br/>    }<br/>  }<br/>}</span></pre><p id="b3d4" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">哒哒！！🎉</p><h1 id="14da" class="kz la in bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">最后的想法</h1><p id="ebf7" class="pw-post-body-paragraph ka kb in kc b kd lx kf kg kh ly kj kk kl lz kn ko kp ma kr ks kt mb kv kw kx ig bi translated">咻！我们今天谈了很多！在一天结束的时候，我希望这能让你明白，把一份 Kubernetes 清单转换成一份 Nomad jobspec 并不是什么难事！只需要一点点知识和耐心。</p><p id="fb52" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">虽然这绝不是一个彻底的转换，但我希望这个小教程能给你信心，让你从“我希望有一个如何在 Nomad 上运行它的例子”变成“我自己也能让它在 Nomad 上运行！”</p><p id="b8c3" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我现在要奖励你一张照片，照片上的菲比和我们亲爱的小兔子正从笼子里往外看。</p><figure class="mc md me mf gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/78e013587db96bf568ea2a59d1d9568b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*1v4t_Iv1g1zHufdL"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">兔子(左)和菲比(右)想打声招呼！Adri Villela 拍摄的照片。</figcaption></figure><p id="5f5f" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">和平、爱和准则。🦄 🌈 💫</p><figure class="mc md me mf gt jo gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/78aa5a77e3bdf841aa9087ac89ee80fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:388/0*tSk_26Q8eRprFiPf"/></div></figure></div><div class="ab cl oc od hr oe" role="separator"><span class="of bw bk og oh oi"/><span class="of bw bk og oh oi"/><span class="of bw bk og oh"/></div><div class="ig ih ii ij ik"><p id="a8a7" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">更多关于 Nomad 的博客文章，请查看我下面的阅读列表:</p><div class="oj ok gp gr ol"><div role="button" tabindex="0" class="ab bv gv cb fp om on bn oo jt ex"><div class="op l"><div class="ab q"><div class="l di"><img alt="Adri Villela" class="l de bw oq or fe" src="../Images/e70eedd2981b8eb48ebfa3602f42bc0f.png" width="20" height="20" loading="lazy" data-original-src="https://miro.medium.com/v2/resize:fill:40:40/1*rW45is0FCLsRpWvdMdSWpA@2x.jpeg"/><div class="fb bw l oq or fc n aw fd"/></div><div class="hh l fo"><p class="bd b dl z fp fq fr fs ft fu fv fw dk translated"><a class="ae af ag ah ai aj ak al am an ao ap aq ar as" href="https://adri-v.medium.com/?source=post_page-----7a58d2fa07a0--------------------------------" rel="noopener follow" target="_top">阿德里·维莱拉</a></p></div></div><div class="ou ov gw l"><h2 class="bd io ub nl fp uc fr fs ud fu fw im bi translated">适时游牧</h2></div><div class="ab q"><div class="l fo"><a class="bd b be z bi ue au uf ug uh qr ui an eh ei uj uk ul el em eo de bk ep" href="https://adri-v.medium.com/list/justintime-nomad-cc5d249a172b?source=post_page-----7a58d2fa07a0--------------------------------" rel="noopener follow" target="_top">View list</a></div><div class="um l fo"><span class="bd b dl z dk">11 stories</span></div></div></div><div class="ph dh pi fp ab pj fo di"><div class="di oz bv pa pb"><div class="dh l"><img alt="Picture of a mural featuring an astronaut surrounded by a circle." class="dh" src="../Images/de08af9cd14a133eb6337987debfb7a4.png" width="194" height="194" loading="lazy" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/1*aYXLK8H0V3vRvFeeuSVzdA@2x.jpeg"/></div></div><div class="di oz bv pc pd pe"><div class="dh l"><img alt="" class="dh" src="../Images/90c44c34a8748c582208823f9622fadb.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/1*BrHy6EIT4Qcy2N_h9mKYTg.png"/></div></div><div class="di bv pf pg pe"><div class="dh l"><img alt="The nomad logo on a dark Tucows blue background" class="dh" src="../Images/419df386114d12b8672112c7271b5df4.png" width="194" height="194" loading="lazy" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/1*G8wbr34pitzjc6AuBpGitA.png"/></div></div></div></div></div></div><div class="ab cl oc od hr oe" role="separator"><span class="of bw bk og oh oi"/><span class="of bw bk og oh oi"/><span class="of bw bk og oh"/></div><div class="ig ih ii ij ik"><p id="e9f9" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">对可观察性和/或<a class="ae jz" href="https://opentelemetry.io" rel="noopener ugc nofollow" target="_blank"> OpenTelemetry </a>有疑问吗？想要合作开发适用于 Nomad 的 OTel 演示应用程序吗？跟我说话！请随时通过<a class="ae jz" href="mailto:devrel@lightstep.com" rel="noopener ugc nofollow" target="_blank">电子邮件</a>联系我，或者通过<a class="ae jz" href="https://hachyderm.io/@adrianamvillela" rel="noopener ugc nofollow" target="_blank">乳齿象</a>或<a class="ae jz" href="https://www.linkedin.com/in/adrianavillela" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>联系我。希望收到你们的来信！</p></div></div>    
</body>
</html>