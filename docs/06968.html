<html>
<head>
<title>Writing Custom Operators and Hooks for MWAA</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为 MWAA 编写自定义操作符和钩子</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/writing-custom-operators-and-hooks-for-mwaa-c8a1b6052553?source=collection_archive---------3-----------------------#2022-02-15">https://blog.devgenius.io/writing-custom-operators-and-hooks-for-mwaa-c8a1b6052553?source=collection_archive---------3-----------------------#2022-02-15</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/2b75468cab903f06aaa54ae673bb560c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xXXyEMBwYmW3FYnN"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated"><a class="ae jz" href="https://unsplash.com/photos/IuGarrkgf10" rel="noopener ugc nofollow" target="_blank">图片</a>由<a class="ae jz" href="https://unsplash.com/@standsome" rel="noopener ugc nofollow" target="_blank">站在 Unsplash 上的</a>工作生活方式</figcaption></figure><p id="80b8" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">最近，我一直在研究<strong class="kc io"> MWAA </strong>又名<strong class="kc io">亚马逊管理的 Apache Airflow 工作流。</strong>为了使用亚马逊服务，我们使用<strong class="kc io"> Airflow 亚马逊提供商</strong> <code class="fe ky kz la lb b"><em class="lc">apache-airflow-backport-providers-amazon</em>==2021.3.3</code>，这为我们提供了具有以下功能的<code class="fe ky kz la lb b">EC2 Operator</code>和<code class="fe ky kz la lb b">EC2 Hooks</code>:</p><ul class=""><li id="2e27" class="ld le in kc b kd ke kh ki kl lf kp lg kt lh kx li lj lk ll bi translated"><strong class="kc io">EC2 startinstanceoperator</strong>帮助我们<strong class="kc io">启动</strong>一个<strong class="kc io"> EC2 </strong> <strong class="kc io">实例</strong>，因为<strong class="kc io">实例 id </strong>是已知的。</li></ul><pre class="lm ln lo lp gt lq lb lr ls aw lt bi"><span id="41da" class="lu lv in lb b gy lw lx l ly lz"><em class="lc">from </em>airflow.providers.amazon.aws.operators.ec2_start_instance <em class="lc">import </em>EC2StartInstanceOperator</span></pre><ul class=""><li id="a890" class="ld le in kc b kd ke kh ki kl lf kp lg kt lh kx li lj lk ll bi translated"><strong class="kc io">EC2 stoinstanceoperator</strong>帮助我们<strong class="kc io">停止</strong>一个<strong class="kc io"> EC2 </strong> <strong class="kc io">实例</strong>给定<strong class="kc io">实例 id </strong>已知。</li></ul><pre class="lm ln lo lp gt lq lb lr ls aw lt bi"><span id="f802" class="lu lv in lb b gy lw lx l ly lz"><em class="lc">from </em>airflow.providers.amazon.aws.operators.ec2_stop_instance <em class="lc">import </em>EC2StopInstanceOperator</span></pre><p id="3a46" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">以上操作员使用<strong class="kc io"> EC2Hook </strong>，遵循以下三种方法:</p><pre class="lm ln lo lp gt lq lb lr ls aw lt bi"><span id="89b9" class="lu lv in lb b gy lw lx l ly lz"><em class="lc">from </em>airflow.providers.amazon.aws.hooks.ec2 <em class="lc">import </em>EC2Hook</span></pre><ol class=""><li id="d127" class="ld le in kc b kd ke kh ki kl lf kp lg kt lh kx ma lj lk ll bi translated"><strong class="kc io"> get_instance，</strong>以<strong class="kc io"> instance-id </strong>为参数，返回<a class="ae jz" href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/ec2.html#EC2.Instance" rel="noopener ugc nofollow" target="_blank"> ec2。该实例 id 的实例</a>对象。</li></ol><p id="bca1" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">2.<strong class="kc io"> get_instance_state，</strong>以<strong class="kc io"> instance-id </strong>为自变量，返回<strong class="kc io">状态</strong>。</p><p id="9252" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">3.<strong class="kc io"> wait_for_state，</strong>以<strong class="kc io"> instance-id </strong>为自变量，等待所需状态激活。</p><p id="2e2b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">对于我们的用例，我们需要基于提供的一些参数旋转<strong class="kc io">EC2</strong>T53】实例的能力，目前还不支持。因此，我们决定编写自己的 C <strong class="kc io">自定义操作符</strong>来实现这一点。</p><p id="749f" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io"> MWAA </strong>(亚马逊管理的阿帕奇气流工作流<strong class="kc io"> ) </strong>能够通过<strong class="kc io"> S3 桶</strong>导入<strong class="kc io">定制插件</strong>。这些<strong class="kc io">插件</strong>可以以<strong class="kc io"> zip </strong>文件格式上传到 S3 桶，并且<strong class="kc io"> S3 URL </strong>可以在创建<strong class="kc io"> MWAA 集群</strong>时使用，或者稍后从<strong class="kc io">亚马逊 MWAA 服务页面</strong>更新。<strong class="kc io">插件</strong>目录需要采用以下格式:</p><pre class="lm ln lo lp gt lq lb lr ls aw lt bi"><span id="d468" class="lu lv in lb b gy lw lx l ly lz">└── plugins<br/>    ├── __init__.py<br/>    ├── hooks<br/>    │   ├── __init__.py<br/>    │   └── ec2_extended_instance_hooks.py<br/>    ├── operators<br/>    │   ├── __init__.py<br/>    │   ├── ec2_extended_create_instance.py<br/>    │   └── ec2_extended_terminate_instance.py<br/>    ├── ec2_extended_plugin.py<br/>    └── sensors<br/>       └── __init__.py</span></pre><ul class=""><li id="93e3" class="ld le in kc b kd ke kh ki kl lf kp lg kt lh kx li lj lk ll bi translated"><code class="fe ky kz la lb b">__init__.py</code>确保<strong class="kc io"> MWAA </strong>包含<strong class="kc io">插件</strong>目录中的文件夹及其内容。</li><li id="6f9d" class="ld le in kc b kd mb kh mc kl md kp me kt mf kx li lj lk ll bi translated"><strong class="kc io">插件</strong>目录<strong class="kc io"> </strong>下的<code class="fe ky kz la lb b">hooks </code>文件夹应该包含<strong class="kc io">自定义钩子</strong>。</li><li id="e27d" class="ld le in kc b kd mb kh mc kl md kp me kt mf kx li lj lk ll bi translated"><strong class="kc io">插件</strong>目录下的<code class="fe ky kz la lb b">operators </code>文件夹应该包含<strong class="kc io">自定义操作符</strong>。</li><li id="22a3" class="ld le in kc b kd mb kh mc kl md kp me kt mf kx li lj lk ll bi translated"><strong class="kc io">插件</strong>目录下的<code class="fe ky kz la lb b">sensors </code>文件夹应该包含<strong class="kc io">自定义传感器</strong>。</li><li id="b073" class="ld le in kc b kd mb kh mc kl md kp me kt mf kx li lj lk ll bi translated"><strong class="kc io">插件</strong>目录中的<code class="fe ky kz la lb b">ec2_extended_plugin.py</code>是<strong class="kc io">自定义操作器/挂钩/传感器</strong>的定义。从<code class="fe ky kz la lb b">airflow.plugins_manager</code>导入<code class="fe ky kz la lb b">AirflowPlugin</code>以继承插件功能。</li></ul><pre class="lm ln lo lp gt lq lb lr ls aw lt bi"><span id="4d8d" class="lu lv in lb b gy lw lx l ly lz"><em class="lc">from </em>airflow.plugins_manager <em class="lc">import </em>AirflowPlugin<br/><em class="lc">from </em>hooks.ec2_extended_instance_hooks <em class="lc">import </em>*<br/><em class="lc">from </em>operators.ec2_extended_create_instance <em class="lc">import </em>*<br/><em class="lc">from </em>operators.ec2_extended_terminate_instance <em class="lc">import </em>*<br/><br/><br/><em class="lc">class </em>EC2ExtendedPlugins(AirflowPlugin):<br/>    name = 'ec2_extended_plugins'<br/>    hooks = [EC2ExtendedHooks]<br/>    operators = [EC2ExtendedCreateInstance,<br/>EC2ExtendedTerminateInstance]</span></pre></div><div class="ab cl mg mh hr mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ig ih ii ij ik"><p id="edf6" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">再说说<code class="fe ky kz la lb b">hooks</code>。钩子是你可能需要的<code class="fe ky kz la lb b">Operator Class</code>的<strong class="kc io">方法</strong>的集合。所以我们的<code class="fe ky kz la lb b">ec2_extended_instance_hooks.py</code>包含以下内容:</p><pre class="lm ln lo lp gt lq lb lr ls aw lt bi"><span id="74c4" class="lu lv in lb b gy lw lx l ly lz"><em class="lc">import </em>logging<br/><em class="lc">import </em>boto3<br/><em class="lc">from </em>airflow.exceptions <em class="lc">import </em>AirflowException<br/><em class="lc">from </em>airflow.hooks.base_hook <em class="lc">import </em>BaseHook<br/><em class="lc">from </em>airflow.providers.amazon.aws.hooks.ec2 <em class="lc">import </em>EC2Hook<br/><em class="lc">from </em>typing <em class="lc">import </em>List, Set, Dict, Tuple, Optional<br/><em class="lc">from </em>botocore.exceptions <em class="lc">import </em>ClientError<br/><br/><br/><em class="lc">class </em>EC2ExtendedHooks(EC2Hook):<br/>    <em class="lc">def </em>__init__(<em class="lc">self</em>,<br/>                 *args,<br/>                 **kwargs):<br/>        super(EC2ExtendedHooks, <em class="lc">self</em>).__init__(resource_type="ec2", *args, **kwargs)<br/>        <em class="lc">self</em>.instance = <em class="lc">None<br/><br/>    # noinspection PyMethodMayBeStatic<br/>    def </em>create_instance(<em class="lc">self</em>,<br/>                        subnet_id: str,<br/>                        security_group_ids: List[str],<br/>                        image_id: str,<br/>                        instance_type: str,<br/>                        region_name: str,<br/>                        key_name: str,<br/>                        tags: List[Dict[str, str]],<br/>                        iam_instance_profile: Optional[Dict[str, str]] = <em class="lc">None</em>,<br/>                        user_data: Optional[str] = "",<br/>                        min_count: Optional[int] = 1,<br/>                        max_count: Optional[int] = 1,<br/>                        ):<br/>        <em class="lc">if </em>iam_instance_profile <em class="lc">is None</em>:<br/>            iam_instance_profile = {}<br/>        <em class="lc">if </em>subnet_id <em class="lc">is None</em>:<br/>            <em class="lc">raise </em>AirflowException("Required parameter missing %s", subnet_id)<br/>        <em class="lc">try</em>:<br/>            logging.info("Will spin the EC2 Instance on %s", subnet_id)<br/>            ec2 = boto3.resource('ec2', region_name=region_name)<br/>            instance = ec2.create_instances(<br/>                ImageId=image_id,<br/>                InstanceType=instance_type,<br/>                KeyName=key_name,<br/>                SubnetId=subnet_id,<br/>                MinCount=min_count,<br/>                MaxCount=max_count,<br/>                UserData=user_data,<br/>                IamInstanceProfile=iam_instance_profile,<br/>                TagSpecifications=[<br/>                    {<br/>                        'ResourceType': 'instance',<br/>                        'Tags': tags<br/>                    }<br/>                ],<br/>                SecurityGroupIds=security_group_ids)[0]<br/>            logging.info("Created instance [Instance iD = %s] and [IP Address = %s]", instance.id,<br/>                         instance.private_ip_address)<br/>        <em class="lc">except </em>ClientError:<br/>            logging.exception("Couldn't create instance with image %s, on subnet %s.", image_id, subnet_id)<br/>            <em class="lc">raise<br/>        else</em>:<br/>            <em class="lc">return </em>instance<br/><br/>    <em class="lc"># noinspection PyMethodMayBeStatic<br/>    def </em>terminate_instance(<em class="lc">self</em>, instance_id: str, region_name: str):<br/>        instance_id = instance_id<br/>        region_name = region_name<br/>        <em class="lc">if </em>instance_id <em class="lc">is None</em>:<br/>            <em class="lc">raise </em>AirflowException("instance id is required for termination, no instance id provided")<br/>        <em class="lc">try</em>:<br/>            ec2 = boto3.resource('ec2', region_name=region_name)<br/>            logging.info("Terminating %s instance", instance_id)<br/>            instance = ec2.Instance(instance_id)<br/>            instance.terminate()<br/>        <em class="lc">except </em>ClientError:<br/>            logging.exception("Couldn't Terminating instance %s", instance_id)<br/>            <em class="lc">raise</em></span></pre><p id="67c2" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><code class="fe ky kz la lb b">EC2ExtendedHooks</code>包含 2 种方法:</p><ul class=""><li id="0a73" class="ld le in kc b kd ke kh ki kl lf kp lg kt lh kx li lj lk ll bi translated"><code class="fe ky kz la lb b">create_instance</code></li><li id="f18f" class="ld le in kc b kd mb kh mc kl md kp me kt mf kx li lj lk ll bi translated"><code class="fe ky kz la lb b">terminate_instance</code></li></ul><p id="3c3d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">基于提供给<code class="fe ky kz la lb b">methods</code>的<code class="fe ky kz la lb b">arguments</code>，它们将执行较低级别的任务。</p></div><div class="ab cl mg mh hr mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ig ih ii ij ik"><p id="861b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">对于<code class="fe ky kz la lb b">Operator</code>，我有 2 个文件:</p><ul class=""><li id="836a" class="ld le in kc b kd ke kh ki kl lf kp lg kt lh kx li lj lk ll bi translated"><code class="fe ky kz la lb b">ec2_extended_create_instance.py</code></li><li id="dc80" class="ld le in kc b kd mb kh mc kl md kp me kt mf kx li lj lk ll bi translated"><code class="fe ky kz la lb b">ec2_extended_terminate_instance.py</code></li></ul><p id="3b12" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">顾名思义，一个用于<strong class="kc io">创建 EC2 实例</strong>，另一个用于<strong class="kc io">终止 EC2 实例</strong>。</p><p id="2c2d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">创建 EC2 实例:</strong></p><p id="9c1c" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><code class="fe ky kz la lb b">ec2_extended_create_instance.py</code>是<code class="fe ky kz la lb b">EC2ExtendedCreateInstance</code>类的定义，它收集参数作为<code class="fe ky kz la lb b">dag’s</code>任务的一部分。</p><pre class="lm ln lo lp gt lq lb lr ls aw lt bi"><span id="732c" class="lu lv in lb b gy lw lx l ly lz"><em class="lc">from </em>typing <em class="lc">import </em>List, Dict, Optional<br/><em class="lc">from </em>airflow.models <em class="lc">import </em>BaseOperator<br/><em class="lc">from </em>airflow.utils.decorators <em class="lc">import </em>apply_defaults<br/><em class="lc">from </em>airflow.providers.amazon.aws.hooks.ec2 <em class="lc">import </em>EC2Hook<br/><em class="lc">from </em>hooks.ec2_extended_instance_hooks <em class="lc">import </em>EC2ExtendedHooks<br/><br/><br/><em class="lc">class </em>EC2ExtendedCreateInstance(BaseOperator):<br/>    template_fields = ["subnet_id", "security_group_ids", "image_id", "instance_type", "key_name", "region_name"]<br/>    ui_color = "#ace1af"<br/>    ui_fgcolor = "#00563f"<br/><br/>    @apply_defaults<br/>    <em class="lc">def </em>__init__(<em class="lc">self</em>, subnet_id: str, security_group_ids: List[str], image_id: str, instance_type: str, key_name: str,<br/>                 tags: List[Dict[str, str]], min_count: Optional[int] = 1, max_count: Optional[int] = 1,<br/>                 aws_conn_id: str = "aws_default", region_name: Optional[str] = <em class="lc">None</em>, check_interval: float = 15,<br/>                 **kwargs):<br/>        super(EC2ExtendedCreateInstance, <em class="lc">self</em>).__init__(**kwargs)<br/>        <em class="lc">self</em>.subnet_id = subnet_id<br/>        <em class="lc">self</em>.security_group_ids = security_group_ids<br/>        <em class="lc">self</em>.image_id = image_id<br/>        <em class="lc">self</em>.instance_type = instance_type<br/>        <em class="lc">self</em>.security_group_ids = security_group_ids<br/>        <em class="lc">self</em>.key_name = key_name<br/>        <em class="lc">self</em>.tags = tags<br/>        <em class="lc">self</em>.max_count = max_count<br/>        <em class="lc">self</em>.min_count = min_count<br/>        <em class="lc">self</em>.aws_conn_id = aws_conn_id<br/>        <em class="lc">self</em>.region_name = region_name<br/>        <em class="lc">self</em>.check_interval = check_interval<br/><br/>    <em class="lc">def </em>execute(<em class="lc">self</em>, context: 'Context'):<br/>        EC2Instance = EC2ExtendedHooks(<br/>            aws_conn_id=<em class="lc">self</em>.aws_conn_id,<br/>            region_name=<em class="lc">self</em>.region_name<br/>        )<br/>        <em class="lc">self</em>.log.info("Creating EC2 instance with image id %s on subnet %s", <em class="lc">self</em>.image_id, <em class="lc">self</em>.subnet_id)<br/>        instance = EC2Instance.create_instance(<br/>            subnet_id=<em class="lc">self</em>.subnet_id,<br/>            security_group_ids=<em class="lc">self</em>.security_group_ids,<br/>            image_id=<em class="lc">self</em>.image_id,<br/>            instance_type=<em class="lc">self</em>.instance_type,<br/>            key_name=<em class="lc">self</em>.key_name,<br/>            region_name=<em class="lc">self</em>.region_name,<br/>            tags=<em class="lc">self</em>.tags,<br/>            min_count=<em class="lc">self</em>.min_count,<br/>            max_count=<em class="lc">self</em>.max_count<br/>        )<br/><br/>        ec2_hook = EC2Hook(aws_conn_id=<em class="lc">self</em>.aws_conn_id, region_name=<em class="lc">self</em>.region_name)<br/>        ec2_hook.wait_for_state(<br/>            instance_id=instance.id,<br/>            target_state="running",<br/>            check_interval=<em class="lc">self</em>.check_interval,<br/>        )<br/>        <em class="lc">return </em>instance.id, instance.private_ip_address</span></pre><p id="83bf" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><code class="fe ky kz la lb b">EC2ExtendedCreateInstance</code>继承<code class="fe ky kz la lb b">BaseOperator</code>。导入<code class="fe ky kz la lb b">EC2ExtendedHooks</code>使用<code class="fe ky kz la lb b">create_instance</code>方法创建<strong class="kc io"> EC2 实例</strong>，导入<code class="fe ky kz la lb b">EC2Hook</code>使用<code class="fe ky kz la lb b">wait_for_state</code>方法检查实例是否处于<strong class="kc io">运行</strong>状态。</p><p id="ecdf" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">终止 EC2 实例:</strong></p><p id="248b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><code class="fe ky kz la lb b">ec2_extended_terminate_instance.py</code>是定义<code class="fe ky kz la lb b">EC2ExtendedTerminateInstance</code>类，它收集参数作为<code class="fe ky kz la lb b">dag’s</code>任务的一部分，并从<code class="fe ky kz la lb b">EC2ExtendedHooks</code>导入<code class="fe ky kz la lb b">terminate_instance</code>方法以终止<strong class="kc io"> EC2 实例</strong>。</p><pre class="lm ln lo lp gt lq lb lr ls aw lt bi"><span id="bd7e" class="lu lv in lb b gy lw lx l ly lz"><em class="lc">from </em>typing <em class="lc">import </em>List, Dict, Optional<br/><em class="lc">from </em>airflow.models <em class="lc">import </em>BaseOperator<br/><em class="lc">from </em>airflow.utils.decorators <em class="lc">import </em>apply_defaults<br/><em class="lc">from </em>airflow.providers.amazon.aws.hooks.ec2 <em class="lc">import </em>EC2Hook<br/><em class="lc">from </em>hooks.ec2_extended_instance_hooks <em class="lc">import </em>EC2ExtendedHooks<br/><br/><br/><em class="lc">class </em>EC2ExtendedTerminateInstance(BaseOperator):<br/>    template_fields = ["instance_id", "region_name"]<br/>    ui_color = "#ace1af"<br/>    ui_fgcolor = "#00563f"<br/><br/>    @apply_defaults<br/>    <em class="lc">def </em>__init__(<em class="lc">self</em>, instance_id: str, aws_conn_id: str = "aws_default", region_name: Optional[str] = <em class="lc">None</em>, check_interval: float = 15, **kwargs):<br/>        super(EC2ExtendedTerminateInstance, <em class="lc">self</em>).__init__(**kwargs)<br/>        <em class="lc">self</em>.instance_id = instance_id<br/>        <em class="lc">self</em>.aws_conn_id = aws_conn_id<br/>        <em class="lc">self</em>.region_name = region_name<br/>        <em class="lc">self</em>.check_interval = check_interval<br/><br/>    <em class="lc">def </em>execute(<em class="lc">self</em>, context: 'Context'):<br/>        EC2Instance = EC2ExtendedHooks(<br/>            aws_conn_id=<em class="lc">self</em>.aws_conn_id,<br/>            region_name=<em class="lc">self</em>.region_name<br/>        )<br/>        <em class="lc">self</em>.log.info("Terminating instance %s", <em class="lc">self</em>.instance_id)<br/>        EC2Instance.terminate_instance(<em class="lc">self</em>.instance_id, <em class="lc">self</em>.region_name)</span></pre></div><div class="ab cl mg mh hr mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ig ih ii ij ik"><p id="15dc" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">最后，实际的<code class="fe ky kz la lb b">dag</code>代码:</p><pre class="lm ln lo lp gt lq lb lr ls aw lt bi"><span id="c385" class="lu lv in lb b gy lw lx l ly lz"><em class="lc">import </em>os<br/><em class="lc">from </em>datetime <em class="lc">import </em>timedelta, datetime<br/><em class="lc">from </em>airflow <em class="lc">import </em>DAG<br/><em class="lc">from </em>airflow.models <em class="lc">import </em>Variable<br/><em class="lc">from </em>airflow.utils.dates <em class="lc">import </em>days_ago<br/><em class="lc">from </em>operators.ec2_extended_create_instance <em class="lc">import </em>EC2ExtendedCreateInstance<br/><em class="lc">from </em>operators.ec2_extended_terminate_instance <em class="lc">import </em>EC2ExtendedTerminateInstance<br/><br/>DEFAULT_ARGS = {<br/>    'owner': 'airflow',<br/>    'depends_on_past': <em class="lc">False</em>,<br/>    'email': ['airflow@example.com'],<br/>    'email_on_failure': <em class="lc">False</em>,<br/>    'email_on_retry': <em class="lc">False</em>,<br/>    'start_date': datetime.now() - timedelta(minutes=20),<br/>    'retries': 1,<br/>    'retry_delay': timedelta(minutes=5),<br/>    'provide_context': <em class="lc">True</em>,<br/>}<br/><br/>DAG_ID = os.path.basename(__file__).replace(".py", "")<br/><br/>security_group_ids = ["sg-00112233445566", "sg-567380011234"]<br/>subnet = "subnet-0p9oui4th1"<br/><br/><em class="lc">with </em>DAG(<br/>        dag_id=DAG_ID,<br/>        description="Deploy and Terminate EC2 Instance in AWS",<br/>        default_args=DEFAULT_ARGS,<br/>        dagrun_timeout=timedelta(hours=2),<br/>        start_date=days_ago(1),<br/>        schedule_interval=<em class="lc">None</em>,<br/>        tags=["EC2Extended", "ec2", "CustomOperators"],<br/>) <em class="lc">as </em>dag:<br/>    create_ec2 = EC2ExtendedCreateInstance(<br/>        subnet_id=subnet,<br/>        security_group_ids=security_group_ids,<br/>        image_id='ami-123456789101112',<br/>        instance_type='t2.medium',<br/>        key_name='some-key.pem',<br/>        tags=[{"Key": "name", "Value": "AutoDeployed via MWAA Pipeline"}],<br/>        aws_conn_id='aws_default',<br/>        region_name='us-east-1',<br/>        task_id='create_ec2',<br/>    )<br/><br/>    terminate_ec2 = EC2ExtendedTerminateInstance(<br/>        instance_id="{{ task_instance.xcom_pull('create_ec2', dag_id=DAG_ID, key='return_value')[0] }}",<br/>        region_name='us-east-1',<br/>        task_id='terminate_ec2',<br/>    )<br/><br/>create_ec2 &gt;&gt; terminate_ec2</span></pre><p id="4393" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">需要注意的几件事:</strong></p><ul class=""><li id="c9b0" class="ld le in kc b kd ke kh ki kl lf kp lg kt lh kx li lj lk ll bi translated"><code class="fe ky kz la lb b">EC2ExtendedCreateInstance</code>有类似<code class="fe ky kz la lb b">template_fields = ["subnet_id", "security_group_ids", "image_id", "instance_type", "key_name", "region_name"]</code>的模板字段。因此，这些参数可以使用 Airflow Jinja 模板进行模板化。</li><li id="beb9" class="ld le in kc b kd mb kh mc kl md kp me kt mf kx li lj lk ll bi translated"><code class="fe ky kz la lb b">EC2ExtendedCreateInstance</code>也返回<code class="fe ky kz la lb b">instance.id, instance.private_ip_address</code>，它将被存储在<a class="ae jz" href="https://airflow.apache.org/docs/apache-airflow/stable/concepts/xcoms.html" rel="noopener ugc nofollow" target="_blank"> Airflow XCom </a>中，并且在将来需要的时候使用<a class="ae jz" href="https://airflow.apache.org/docs/apache-airflow/stable/_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.xcom_pull" rel="noopener ugc nofollow" target="_blank"> xcom_pull </a>。返回值存储为一个<strong class="kc io">键/值</strong>对<strong class="kc io">。</strong>因为我们没有使用<a class="ae jz" href="https://airflow.apache.org/docs/apache-airflow/stable/_api/airflow/models/taskinstance/index.html#airflow.models.taskinstance.TaskInstance.xcom_push" rel="noopener ugc nofollow" target="_blank"> xcom_push </a>机制来推送值，所以默认情况下，Airflow 将返回值存储在<strong class="kc io">键名</strong> : <code class="fe ky kz la lb b">return_value.</code>下</li></ul><p id="4f08" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><em class="lc">注:</em>请阅读<a class="ae jz" href="https://airflow.apache.org/docs/apache-airflow/stable/concepts/xcoms.html" rel="noopener ugc nofollow" target="_blank">气流 XCom </a>，用于在<strong class="kc io">Dag、Task </strong>等之间共享数据。</p><ul class=""><li id="0cb1" class="ld le in kc b kd ke kh ki kl lf kp lg kt lh kx li lj lk ll bi translated"><code class="fe ky kz la lb b">EC2ExtendedTerminateInstance</code>使用带有<code class="fe ky kz la lb b">key=’return_value’</code>的 Airflow Jinja 模板，从前面的任务<code class="fe ky kz la lb b">create_ec2</code>中获取值。为了提取<strong class="kc io">实例 id </strong>，它正在获取<code class="fe ky kz la lb b">[0]</code>元素。</li></ul><p id="7804" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">从 Airflow UI 看，它是这样的:</p><p id="1dfb" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">活动 Dag 视图</strong></p><figure class="lm ln lo lp gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mn"><img src="../Images/fb4165a8ae8b72f9c3a513e14a03724e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MSoi8XKi69CrC5CnZWCfkg.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">使用自定义运算符的活动 Dag</figcaption></figure><p id="9b8f" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">任务一成功完成</strong></p><figure class="lm ln lo lp gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mo"><img src="../Images/c12ea6deb26d8b6a01565fdf113f2a76.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6sF9NNc89-8xzUpih1k44Q.png"/></div></div></figure><p id="cd61" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">气流日志</strong></p><figure class="lm ln lo lp gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mp"><img src="../Images/0f81de36335461d8d288f4921512b819.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*c6gSBin_cSNUjFTgaEQl_g.png"/></div></div></figure><p id="8313" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">气流 XCOM 商店</strong></p><figure class="lm ln lo lp gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mq"><img src="../Images/2375dad740abb4c43d802897ee3f8a28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZW9r9LzFmSKS25cWp_HBjw.png"/></div></div></figure><p id="630a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">终止成功完成</strong></p><figure class="lm ln lo lp gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mq"><img src="../Images/a3aa9e65a04bd605c00d1c8a97605e2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XnDVieXrhjSE48zDhF-BbA.png"/></div></div></figure><p id="36ce" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><code class="fe ky kz la lb b">dag</code>顺利完成。它能够使用我们创建的<strong class="kc io">自定义操作符</strong>和<strong class="kc io">钩子</strong>来创建和销毁一个<strong class="kc io"> EC2 实例</strong>。</p></div></div>    
</body>
</html>