<html>
<head>
<title>dbt and BigQuery in Practice; A Use-Case of Transforming Stock Data</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">实践中的 dbt 和 BigQuery 转换股票数据的用例</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/dbt-and-bigquery-in-practice-transform-stock-data-1771e2393319?source=collection_archive---------4-----------------------#2022-06-02">https://blog.devgenius.io/dbt-and-bigquery-in-practice-transform-stock-data-1771e2393319?source=collection_archive---------4-----------------------#2022-06-02</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="44bf" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">更新于 2022 年 7 月 22 日:更新数据管道如下:</p><ul class=""><li id="de82" class="ki kj in jm b jn jo jr js jv kk jz kl kd km kh kn ko kp kq bi translated">创建一个额外的仓库来存储计算的投资组合价值<br/> - &gt;，以隔离每个数据集市，避免受到每个集市中的变化的影响</li></ul><p id="d7e2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">更新于 2022/6/11:将源代码推送到 GitHub:<a class="ae kr" href="https://github.com/koyaaarr/invest-analytics-model" rel="noopener ugc nofollow" target="_blank">https://github.com/koyaaarr/invest-analytics-model</a></p><h1 id="adb6" class="ks kt in bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">介绍</h1><p id="9cc8" class="pw-post-body-paragraph jk jl in jm b jn lq jp jq jr lr jt ju jv ls jx jy jz lt kb kc kd lu kf kg kh ig bi translated">本文解释了如何使用 dbt 和 BigQuery 来转换实际数据。</p><p id="95d2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">您可以使用 dbt 轻松创建数据湖、数据仓库和数据集市。它还使我们能够测试我们的数据质量。我将把 BigQuery 和 dbt 结合起来，将实际的股票数据转换成我的仪表板使用的数据集市。</p><p id="6a24" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这篇文章与下一篇有关，所以如果你有时间，请阅读它。</p><p id="d387" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><a class="ae kr" href="https://koyaaarr.medium.com/a-practical-use-case-of-cloud-native-and-secured-dashboard-with-google-cloud-and-python-streamlit-a66e60d62ca8" rel="noopener">https://koyaaarr . medium . com/a-practical-use-case-of-cloud-native-and-secured-dashboard-with-Google-cloud-and-python-streamlit-a 66 e 60d 62 ca 8</a></p><p id="3085" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">那么，我们开始吧。</p><h1 id="3135" class="ks kt in bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated"><strong class="ak">造型</strong></h1><p id="b6c1" class="pw-post-body-paragraph jk jl in jm b jn lq jp jq jr lr jt ju jv ls jx jy jz lt kb kc kd lu kf kg kh ig bi translated">在开始转换之前，我们需要定义每个表的数据模式。</p><p id="af1f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这是我们需要的表格的图像。</p><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi lv"><img src="../Images/2f624b6dc125d00d716c9792d8835123.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Gy4RE4DY28Zqla8KHB3suw.png"/></div></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">数据管道</figcaption></figure><p id="99d4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在数据集市方面，我希望看到我的投资组合的整体表现，每个股票比率都由它组成。因此，需要为这些目的创建两个数据集市。</p><p id="492b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">另一方面，每只股票数据(VOO、BTC-美元、BND)都存储在谷歌云存储中。它们的格式是 CSV，包含日期和值，如收盘价。</p><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi ml"><img src="../Images/ba3d0f619e98c4ab690d051a39047295.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Dpci8FRdFcN9WDgFY_JW3g.png"/></div></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">源股票数据</figcaption></figure><p id="da6b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">因此，我需要将这些数据源聚集到数据仓库中，并将它们转换到每个数据集市中。</p><p id="07e3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">每个数据模式将在下一节中描述。</p><h1 id="3b10" class="ks kt in bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated"><strong class="ak">介绍 dbt 和 BigQuery </strong></h1><p id="c6c2" class="pw-post-body-paragraph jk jl in jm b jn lq jp jq jr lr jt ju jv ls jx jy jz lt kb kc kd lu kf kg kh ig bi translated">以下是这个用例的先决条件。我将使用 dbt CLI 并使用 Python 安装。</p><pre class="lw lx ly lz gt mm mn mo mp aw mq bi"><span id="a583" class="mr kt in mn b gy ms mt l mu mv">Python: 3.9.11<br/>dbt-core: 1.1.0<br/>dbt-bigquery: 1.1.0</span></pre><p id="8300" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">首先，可以通过下面的命令初始化 dbt。</p><pre class="lw lx ly lz gt mm mn mo mp aw mq bi"><span id="446d" class="mr kt in mn b gy ms mt l mu mv">dbt init</span></pre><p id="5bc8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这个命令创建了许多文件和目录。</p><p id="d6bc" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这个命令创建了许多文件和目录。</p><p id="9c3a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">然后就可以在“dbt_project.yml”的同一个目录下制作“profiles.yml”了。该文件在“~/中生成。dbt ”,但是我建议您将它放在工作目录中，由 git 来控制。</p><p id="e389" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在开始的时候，你会编辑“models/”、“dbt_project.yml”和“profiles.yml”。</p><p id="8efd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让我们看一下每个文件。</p><p id="3061" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">“dbt_project.yml”定义了项目的配置。您将编辑该文件的底部。有我们创建的表，您可以指定每个表的物化类型。</p><pre class="lw lx ly lz gt mm mn mo mp aw mq bi"><span id="6c95" class="mr kt in mn b gy ms mt l mu mv">name: 'invest_analytics'<br/>version: '1.0.0'<br/>config-version: 2</span><span id="e714" class="mr kt in mn b gy mw mt l mu mv">~~~</span><span id="cac8" class="mr kt in mn b gy mw mt l mu mv">models:<br/>  invest_analytics:<br/>    invest_analytics_dev:<br/>    +materialized: view<br/>      warehouse-date:<br/>      warehouse-stock:<br/>      warehouse-num-hold:<br/>      warehouse-portfolio:<br/>      mart-portfolio-value:<br/>        +materialized: table<br/>      mart-portfolio-ratio:<br/>        +materialized: table</span></pre><p id="65bf" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">“profiles.yml”定义系统配置，包括与 BigQuery 的连接。如果您使用服务帐户进行身份验证，则需要指定密钥文件。</p><pre class="lw lx ly lz gt mm mn mo mp aw mq bi"><span id="9574" class="mr kt in mn b gy ms mt l mu mv">invest_analytics:</span><span id="c127" class="mr kt in mn b gy mw mt l mu mv">outputs:</span><span id="1e32" class="mr kt in mn b gy mw mt l mu mv">dev:<br/>  dataset: invest_analytics_dev<br/>  job_execution_timeout_seconds: 300<br/>  job_retries: 1<br/>  keyfile: ../service_account.json<br/>  location: asia-northeast1<br/>  method: service-account<br/>  priority: interactive<br/>  project: invest-analytics-347211<br/>  threads: 1<br/>  type: bigquery<br/>  target: dev</span></pre><p id="acdc" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">“模型”目录包含 SQL 和“schema.yaml”。</p><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div class="gh gi mx"><img src="../Images/b372952614e830a0ada57085c742617d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1104/format:webp/1*eGzrRWDTAJV-U3uQE8s_Lg.png"/></div></figure><p id="f323" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">可以用 dbt 编写标准 SQL，唯一不同的是它的源表。</p><p id="124c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">您需要像这样用 dbt 的格式定义被引用的表，而不是顺序格式。</p><pre class="lw lx ly lz gt mm mn mo mp aw mq bi"><span id="5d19" class="mr kt in mn b gy ms mt l mu mv">select<br/>    Date<br/>  , cast(close_voo as integer) as close_voo<br/>  , cast(close_btcusd as integer) as close_btcusd<br/>  , cast(close_bnd as integer) as close_bnd<br/>  , cast(close_total as integer) as close_total<br/>from<br/>  {{ ref('warehouse-stock') }} as st<br/>  left outer join {{ ref('warehouse-portfolio') }} as pf <br/>    on st.Date = pf.Date<br/>order by<br/>  Date</span></pre><p id="6f15" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果您的表是由 CSV 这样的源数据生成的，您可以像这样定义源数据。</p><pre class="lw lx ly lz gt mm mn mo mp aw mq bi"><span id="6999" class="mr kt in mn b gy ms mt l mu mv">select<br/>    max(case ticker when 'VOO' then num_of_hold else null end) as num_voo<br/>  , max(case ticker when 'BTC-USD' then num_of_hold else null end) as num_btcusd<br/>  , max(case ticker when 'BND' then num_of_hold else null end) as num_bnd<br/>from<br/>  {{ source('invest_analytics_dev', 'source-portfolio') }}</span></pre><p id="ec34" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">最后，您需要像这样定义“schema.yaml”中的数据模式。</p><pre class="lw lx ly lz gt mm mn mo mp aw mq bi"><span id="3ccb" class="mr kt in mn b gy ms mt l mu mv">version: 2<br/>sources:<br/>  - name: invest_analytics_dev<br/>    tables:<br/>      - name: source-voo<br/>      - name: source-btcusd<br/>      - name: source-bnd<br/>      - name: source-portfolio</span><span id="5c9b" class="mr kt in mn b gy mw mt l mu mv">models:<br/>  - name: mart-portfolio-ratio<br/>    description: ''<br/>    columns:<br/>      - name: ticker<br/>        description: ''<br/>        tests:<br/>          - unique<br/>          - not_null<br/>          - accepted_values:<br/>            values: ['voo', 'btcusd', 'bnd']<br/>      - name: close_percent<br/>        description: ''<br/>        tests:<br/>          - unique<br/>          - not_null</span></pre><p id="122a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果您有从 CSV 文件导入的数据源，您可以将它们写在“sources”部分。</p><p id="ad7e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">然后可以添加表的数据模式。此外，您可以为每列定义测试。此示例包含“唯一性测试”、“非空测试”和“可接受值测试”。</p><p id="d3af" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">定义完每个文件后，让我们用这个命令生成表格。</p><pre class="lw lx ly lz gt mm mn mo mp aw mq bi"><span id="cf0d" class="mr kt in mn b gy ms mt l mu mv">dbt run — full-refresh — profiles-dir .</span></pre><p id="f6c6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">然后你得到这样的结果。</p><pre class="lw lx ly lz gt mm mn mo mp aw mq bi"><span id="b0c6" class="mr kt in mn b gy ms mt l mu mv">12:11:02  Running with dbt=1.1.0<br/>12:11:02  Unable to do partial parsing because a project config has changed<br/>12:11:03  Found 5 models, 17 tests, 0 snapshots, 0 analyses, 191 macros, 0 operations, 0 seed files, 4 sources, 0 exposures, 0 metrics<br/>12:11:04  Concurrency: 1 threads (target='dev')<br/>12:11:04  1 of 5 START view model invest_analytics_dev.warehouse-date .................... [RUN]<br/>12:11:06  1 of 5 OK created view model invest_analytics_dev.warehouse-date ............... [OK in 1.61s]</span><span id="ef79" class="mr kt in mn b gy mw mt l mu mv">~~~</span><span id="d9f5" class="mr kt in mn b gy mw mt l mu mv">12:11:11  5 of 5 START table model invest_analytics_dev.mart-portfolio-ratio ............. [RUN]<br/>12:11:14  5 of 5 OK created table model invest_analytics_dev.mart-portfolio-ratio ........ [CREATE TABLE (3.0 rows, 62.7 KB processed) in 3.27s]<br/>12:11:14  Finished running 3 view models, 2 table models in 11.36s.<br/>12:11:14  Completed successfully<br/>12:11:14  Done. PASS=5 WARN=0 ERROR=0 SKIP=0 TOTAL=5</span></pre><p id="dc82" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">你可以看到每个表都是在谷歌云控制台中创建的。</p><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi my"><img src="../Images/d8fcce9115746d8d5c18cc8e3d6759f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o9--WU7ZwoaYsfwLxjIDWw.png"/></div></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">BigQuery 控制台</figcaption></figure><p id="da65" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果您想检查数据的质量，请运行以下命令。</p><pre class="lw lx ly lz gt mm mn mo mp aw mq bi"><span id="9771" class="mr kt in mn b gy ms mt l mu mv">dbt test — profiles-dir .</span></pre><p id="4282" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">然后，你得到这样的结果。</p><pre class="lw lx ly lz gt mm mn mo mp aw mq bi"><span id="6f49" class="mr kt in mn b gy ms mt l mu mv">10:04:03  Running with dbt=1.1.0<br/>10:04:03  Found 5 models, 17 tests, 0 snapshots, 0 analyses, 191 macros, 0 operations, 0 seed files, 4 sources, 0 exposures, 0 metrics<br/>10:04:04  Concurrency: 1 threads (target='dev')<br/>10:04:04  1 of 17 START test accepted_values_mart-portfolio-ratio_ticker__voo__btcusd__bnd  [RUN]<br/>10:04:06  1 of 17 PASS accepted_values_mart-portfolio-ratio_ticker__voo__btcusd__bnd ..... [[32mPASS[0m in 2.16s]</span><span id="fa19" class="mr kt in mn b gy mw mt l mu mv">~~~</span><span id="70be" class="mr kt in mn b gy mw mt l mu mv">10:04:31  17 of 17 START test unique_warehouse-stock_Date ................................ [RUN]<br/>10:04:32  17 of 17 PASS unique_warehouse-stock_Date ...................................... [[32mPASS[0m in 1.33s]<br/>10:04:32  Finished running 17 tests in 28.88s.<br/>10:04:32  Completed successfully<br/>10:04:32  Done. PASS=17 WARN=0 ERROR=0 SKIP=0 TOTAL=17</span></pre><p id="a6a9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">最后，让我们通过下面的命令生成表的文档。</p><pre class="lw lx ly lz gt mm mn mo mp aw mq bi"><span id="af71" class="mr kt in mn b gy ms mt l mu mv">dbt docs generate — profiles-dir .<br/>dbt docs serve — profiles-dir .</span></pre><p id="c206" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">然后您可以看到表定义和沿袭。</p><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi mz"><img src="../Images/4e1720d7d16dd61279fa4ce633732135.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vEYg8lKyyjz4vhxbTyHyCA.png"/></div></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">表格定义</figcaption></figure><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi na"><img src="../Images/eeedb26cec852f3cc98aae9a953e9f1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SjrUzJDJTuP_UHDlPE7k9Q.png"/></div></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">谱系图</figcaption></figure><h1 id="be75" class="ks kt in bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated"><strong class="ak">结论</strong></h1><p id="5382" class="pw-post-body-paragraph jk jl in jm b jn lq jp jq jr lr jt ju jv ls jx jy jz lt kb kc kd lu kf kg kh ig bi translated">希望这篇文章能对你有所帮助。我用股票数据解释了 dbt 和 BigQuery 的实际用例。您可以根据依赖关系创建表，测试数据质量，甚至生成定义文档。</p></div></div>    
</body>
</html>