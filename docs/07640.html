<html>
<head>
<title>Custom NodeJS server in NextJS application</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">NextJS 应用程序中的自定义 NodeJS 服务器</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/custom-nodejs-server-in-nextjs-application-879b6650fdf5?source=collection_archive---------2-----------------------#2022-04-12">https://blog.devgenius.io/custom-nodejs-server-in-nextjs-application-879b6650fdf5?source=collection_archive---------2-----------------------#2022-04-12</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="a875" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">NextJS 是基于 ReactJS 的最流行的 SSR(服务器端渲染)框架之一。这是一个伟大的框架，为我们提供自己的服务器。这非常有效，我一直在使用它，直到我不得不为我的 NextJS 资产和 CSS 文件添加一个自定义的资产路径。</p><p id="99d9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">为什么我们需要定制资产路径</strong></p><p id="3a93" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们需要自定义路径的原因之一是，如果我们需要在 CDN 中部署 CSS(<a class="ae ki" href="https://nextjs.org/docs/api-reference/next.config.js/cdn-support-with-asset-prefix" rel="noopener ugc nofollow" target="_blank">https://nextjs . org/docs/API-reference/next . config . js/CDN-support-with-asset-prefix</a></p><p id="6fcd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">当 NextJS 编译时，它会将所有文件编译并压缩到一个名为。下一个。当我们作为 nextJS 站点启动时，我们可以看到所有 JS / CSS 从一个公共目录 as _next 加载，如下所示</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/571382eb19bc1d78e9d856fd057bc57b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JDYNP_nPPEHk39CuSGWE4w.png"/></div></div></figure><p id="a3a7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在上面的例子中，我们可以看到 main.js 文件是从 _next/static 文件夹中加载的。</p><p id="1a2c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果我们有多个 NextJS 应用程序在同一个域中运行，我们不能基于 same _next 文件夹添加网络规则。我们也可以为每一个设置唯一的基本路径。</p><p id="e86e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在我的方法中，我使用的是资产路径方法。资产路径适用于 CSS。但是对于 JavaScript 文件，默认的 NextJs 服务器不起作用。所以我选择了使用 ExpressJS 的定制服务器。</p><p id="1d51" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们开始吧</p><ol class=""><li id="138f" class="kv kw in jm b jn jo jr js jv kx jz ky kd kz kh la lb lc ld bi translated">创建一个 NextJS 应用程序:<code class="fe le lf lg lh b">npx create-next-app@latest</code></li><li id="8993" class="kv kw in jm b jn li jr lj jv lk jz ll kd lm kh la lb lc ld bi translated">创建应用程序后，使用<em class="ln"> npm run dev 运行应用程序。</em> App 在<em class="ln"> </em> <a class="ae ki" href="http://localhost:300" rel="noopener ugc nofollow" target="_blank"> <em class="ln">中运行良好 http://localhost:300</em></a><em class="ln">0</em></li><li id="3b50" class="kv kw in jm b jn li jr lj jv lk jz ll kd lm kh la lb lc ld bi translated">为了更好的结构，让我们添加一个目录作为 src，并在其中移动页面、公共和样式文件夹。现在添加目录作为服务器。</li></ol><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi lo"><img src="../Images/d1c8f299e7d78ad4751f4765d9a2783b.png" data-original-src="https://miro.medium.com/v2/resize:fit:980/format:webp/1*0aIQvwHQotRM3Lxdpli1LQ.png"/></div></figure><p id="76db" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">4.修改 next.config.js 文件并添加资产路径，如下所示</p><blockquote class="lp lq lr"><p id="ae91" class="jk jl ln jm b jn jo jp jq jr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg kh ig bi translated">/** @type {import('next ')。NextConfig} */</p><p id="721b" class="jk jl ln jm b jn jo jp jq jr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg kh ig bi translated">const nextConfig = {</p><p id="e0ea" class="jk jl ln jm b jn jo jp jq jr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg kh ig bi translated">reactStrictMode: true，</p><p id="c720" class="jk jl ln jm b jn jo jp jq jr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg kh ig bi translated">asset prefix:“/nextjs _ custom _ server/”</p><p id="6585" class="jk jl ln jm b jn jo jp jq jr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg kh ig bi">}</p><p id="10f5" class="jk jl ln jm b jn jo jp jq jr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg kh ig bi translated">module.exports = nextConfig</p></blockquote><p id="f86e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">5.现在，在 server.js 文件中添加以下代码</p></div><div class="ab cl lv lw hr lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="ig ih ii ij ik"><blockquote class="lp lq lr"><p id="8f5a" class="jk jl ln jm b jn jo jp jq jr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg kh ig bi translated">const express = require('express ')</p><p id="f5ee" class="jk jl ln jm b jn jo jp jq jr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg kh ig bi translated">const next = require('next ')</p><p id="a77b" class="jk jl ln jm b jn jo jp jq jr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg kh ig bi translated">const compression = require(' compression ')；</p><p id="1635" class="jk jl ln jm b jn jo jp jq jr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg kh ig bi translated">const port = parse int(process . env . port，10) || 3000</p><p id="1069" class="jk jl ln jm b jn jo jp jq jr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg kh ig bi translated">const dev = process.env.NODE_ENV！== '生产'</p><p id="5cb7" class="jk jl ln jm b jn jo jp jq jr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg kh ig bi translated">const app = next({ dev })</p><p id="ee77" class="jk jl ln jm b jn jo jp jq jr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg kh ig bi translated">const handle = app . getrequesthandler()</p><p id="61ee" class="jk jl ln jm b jn jo jp jq jr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg kh ig bi translated">app.prepare()。然后(()=&gt; {</p><p id="96bb" class="jk jl ln jm b jn jo jp jq jr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg kh ig bi translated">const server = express()</p><p id="d0e8" class="jk jl ln jm b jn jo jp jq jr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg kh ig bi translated">server.use(compression())</p><p id="e989" class="jk jl ln jm b jn jo jp jq jr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg kh ig bi translated">server.use(function (req，res，next) {</p><p id="dd13" class="jk jl ln jm b jn jo jp jq jr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg kh ig bi translated">req . URL = req . original URL . replace('/nextjs _ custom _ server/_ next '，'/_ next ')；</p><p id="8130" class="jk jl ln jm b jn jo jp jq jr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg kh ig bi translated">next()；//一定要让下一个中间件处理修改后的请求。</p><p id="02fd" class="jk jl ln jm b jn jo jp jq jr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg kh ig bi">});</p><p id="a4ed" class="jk jl ln jm b jn jo jp jq jr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg kh ig bi translated">server.get('/_next/* '，(req，res) =&gt; {</p><p id="90d1" class="jk jl ln jm b jn jo jp jq jr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg kh ig bi translated">handle(req，RES)；</p><p id="404d" class="jk jl ln jm b jn jo jp jq jr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg kh ig bi">});</p><p id="5bc7" class="jk jl ln jm b jn jo jp jq jr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg kh ig bi translated">server.all('* '，(req，res) =&gt; {</p><p id="b84a" class="jk jl ln jm b jn jo jp jq jr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg kh ig bi translated">handle(req，RES)；</p><p id="5fc9" class="jk jl ln jm b jn jo jp jq jr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg kh ig bi">});</p><p id="03ed" class="jk jl ln jm b jn jo jp jq jr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg kh ig bi translated">server.listen(port，(err) =&gt; {</p><p id="9536" class="jk jl ln jm b jn jo jp jq jr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg kh ig bi translated">如果(错误)抛出错误</p><p id="9392" class="jk jl ln jm b jn jo jp jq jr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg kh ig bi translated">console.log(`在${port} `上服务器就绪)</p><p id="676b" class="jk jl ln jm b jn jo jp jq jr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg kh ig bi">})</p><p id="2c79" class="jk jl ln jm b jn jo jp jq jr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg kh ig bi">})</p></blockquote><p id="5cef" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">6.添加两个额外的脚本来运行 package.json 文件中的 server.js 文件，如下所示</p><blockquote class="lp lq lr"><p id="8d7f" class="jk jl ln jm b jn jo jp jq jr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg kh ig bi translated">" node-dev ":" node server/server . js "，</p><p id="fe7f" class="jk jl ln jm b jn jo jp jq jr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg kh ig bi translated">"节点开始":"节点服务器/服务器. js "</p></blockquote><p id="a5af" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">7.之后，再次运行应用程序，如下图所示</p><blockquote class="lp lq lr"><p id="2958" class="jk jl ln jm b jn jo jp jq jr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg kh ig bi translated">npm 运行节点-开发</p></blockquote><p id="cd3c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在同一个地址启动应用程序<a class="ae ki" href="http://localhost:3000" rel="noopener ugc nofollow" target="_blank"> http://localhost:3000 </a>并转到网络选项卡。</p><p id="4b30" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们会看到 main.js 是从<strong class="jm io"><em class="ln">next js _ custom _ server</em></strong>而不是根文件夹中提供的。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi mc"><img src="../Images/b544e01338cf04d3c207cdf19c8f806c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D99UBvGqhPWqLOq9r5zlfA.png"/></div></div></figure><p id="c88e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">上面使用的例子可以从下面的链接下载</p><div class="md me gp gr mf mg"><a href="https://github.com/codedaemon12/nextjs-custom-server.git" rel="noopener  ugc nofollow" target="_blank"><div class="mh ab fo"><div class="mi ab mj cl cj mk"><h2 class="bd io gy z fp ml fr fs mm fu fw im bi translated">GitHub-codedaemon 12/nextjs-custom-server</h2><div class="mn l"><h3 class="bd b gy z fp ml fr fs mm fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="mo l"><p class="bd b dl z fp ml fr fs mm fu fw dk translated">github.com</p></div></div><div class="mp l"><div class="mq l mr ms mt mp mu kt mg"/></div></div></a></div><p id="f820" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">高级提示:</p><p id="e598" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在 server.js 中，我们允许所有使用*的路由。但是，如果我们需要任何特定的路径，我们可以添加正则表达式或特定的路径和协议，以便更好地控制，这在生产中是理想的。</p><blockquote class="lp lq lr"><p id="0efa" class="jk jl ln jm b jn jo jp jq jr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg kh ig bi translated">server . get('/[a-zA-Z]{ 2 }/[a-zA-Z]{ 2 }/custom/web '，async (req，res) = &gt;</p><p id="ad62" class="jk jl ln jm b jn jo jp jq jr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg kh ig bi translated">返回句柄(请求，结果)</p><p id="5419" class="jk jl ln jm b jn jo jp jq jr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg kh ig bi">});</p></blockquote><p id="b68f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">以上将接受任何符合以上规则的 URI。</p><p id="817e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">编码快乐！！！</p></div></div>    
</body>
</html>