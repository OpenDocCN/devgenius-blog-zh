<html>
<head>
<title/>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1/>
<blockquote>原文：<a href="https://blog.devgenius.io/using-the-aws-cdk-to-send-a-serverless-slack-message-84e0df55e476?source=collection_archive---------12-----------------------#2020-07-19">https://blog.devgenius.io/using-the-aws-cdk-to-send-a-serverless-slack-message-84e0df55e476?source=collection_archive---------12-----------------------#2020-07-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/68205399b494502dc64e6a8198cdb16e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dnxmoaQRyRspGkDhf8Z1wg.png"/></div></div></figure><p id="84f3" class="pw-post-body-paragraph iz ja jb jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx ij bi translated">在这篇特别的教程中，我将分享我如何使用AWS SDK通过cron作业发送基本的Slack消息。</p><p id="85d5" class="pw-post-body-paragraph iz ja jb jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx ij bi translated">这是一个简单的概念验证，我计划通过将“发送时差消息”与我拥有的许多其他未来项目计划进行交换来进一步验证。</p><p id="9008" class="pw-post-body-paragraph iz ja jb jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx ij bi translated">为了跟进，您应该具备以下条件:</p><ol class=""><li id="7ae6" class="jy jz jb jc b jd je jh ji jl ka jp kb jt kc jx kd ke kf kg bi translated">对AWS有所了解，并对您的<a class="ae kh" href="https://docs.aws.amazon.com/sdk-for-java/v1/developer-guide/setup-credentials.html" rel="noopener ugc nofollow" target="_blank">配置设置</a>有所了解</li><li id="83d4" class="jy jz jb jc b jd ki jh kj jl kk jp kl jt km jx kd ke kf kg bi translated">要使用的<a class="ae kh" href="https://api.slack.com/messaging/webhooks" rel="noopener ugc nofollow" target="_blank">松紧网钩</a></li><li id="6c02" class="jy jz jb jc b jd ki jh kj jl kk jp kl jt km jx kd ke kf kg bi translated">基本熟悉<a class="ae kh" href="https://www.npmjs.com/" rel="noopener ugc nofollow" target="_blank"> npm </a></li></ol><h2 id="5ea9" class="kn ko jb bd kp kq kr dn ks kt ku dp kv jl kw kx ky jp kz la lb jt lc ld le lf bi translated">设置基础架构依赖关系</h2><p id="69da" class="pw-post-body-paragraph iz ja jb jc b jd lg jf jg jh lh jj jk jl li jn jo jp lj jr js jt lk jv jw jx ij bi translated">在一个新文件中，我们需要设置npm包:</p><figure class="ll lm ln lo gt is"><div class="bz fp l di"><div class="lp lq l"/></div></figure><h2 id="0e17" class="kn ko jb bd kp kq kr dn ks kt ku dp kv jl kw kx ky jp kz la lb jt lc ld le lf bi translated">Gitignore文件</h2><p id="40f3" class="pw-post-body-paragraph iz ja jb jc b jd lg jf jg jh lh jj jk jl li jn jo jp lj jr js jt lk jv jw jx ij bi translated">创建一个<code class="fe lr ls lt lu b">.gitignore</code>文件并添加以下内容:</p><figure class="ll lm ln lo gt is"><div class="bz fp l di"><div class="lp lq l"/></div></figure><h2 id="6d67" class="kn ko jb bd kp kq kr dn ks kt ku dp kv jl kw kx ky jp kz la lb jt lc ld le lf bi translated">设置类型脚本</h2><p id="e13d" class="pw-post-body-paragraph iz ja jb jc b jd lg jf jg jh lh jj jk jl li jn jo jp lj jr js jt lk jv jw jx ij bi translated">您可以用您喜欢的设置进行初始化，不过这是一个非常方便的设置，您可以在创建一个<code class="fe lr ls lt lu b">tsconfig.json</code>文件后添加:</p><figure class="ll lm ln lo gt is"><div class="bz fp l di"><div class="lp lq l"/></div></figure><p id="617a" class="pw-post-body-paragraph iz ja jb jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx ij bi translated">创建一个简单的<code class="fe lr ls lt lu b">index.ts</code>文件，并添加以下代码:</p><figure class="ll lm ln lo gt is"><div class="bz fp l di"><div class="lp lq l"/></div></figure><p id="dd96" class="pw-post-body-paragraph iz ja jb jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx ij bi translated">lambda函数的主要代码来自这里:</p><figure class="ll lm ln lo gt is"><div class="bz fp l di"><div class="lp lq l"/></div></figure><p id="f42a" class="pw-post-body-paragraph iz ja jb jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx ij bi translated">lambda代码本身是从以下代码片段中添加的:</p><figure class="ll lm ln lo gt is"><div class="bz fp l di"><div class="lp lq l"/></div></figure><p id="67db" class="pw-post-body-paragraph iz ja jb jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx ij bi translated">为了设置cron作业，我们有以下代码:</p><figure class="ll lm ln lo gt is"><div class="bz fp l di"><div class="lp lq l"/></div></figure><p id="3be9" class="pw-post-body-paragraph iz ja jb jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx ij bi translated">这里最后一点重要的是注意我们正在添加一个环境变量<code class="fe lr ls lt lu b">SLACK_CHANNEL</code>，它是从<code class="fe lr ls lt lu b">.env</code>文件通过<code class="fe lr ls lt lu b">require("dotenv").config()</code>加载到文件的开头。</p><p id="cab0" class="pw-post-body-paragraph iz ja jb jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx ij bi translated">我们在这里使用的env变量只是一个Slack webhook发送到我们文件中的URL。您可以在<a class="ae kh" href="https://api.slack.com/messaging/webhooks" rel="noopener ugc nofollow" target="_blank"> Slack API文档</a>中找到如何创建它。</p><p id="cc90" class="pw-post-body-paragraph iz ja jb jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx ij bi translated">创建<code class="fe lr ls lt lu b">.env</code>文件并添加webhook:</p><figure class="ll lm ln lo gt is"><div class="bz fp l di"><div class="lp lq l"/></div></figure><p id="9245" class="pw-post-body-paragraph iz ja jb jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx ij bi translated">创建一个新的<code class="fe lr ls lt lu b">lambda</code>文件夹来使用。然后，进入该文件夹，初始化一个新的<code class="fe lr ls lt lu b">npm</code>项目并添加<code class="fe lr ls lt lu b">axios</code>。</p><p id="6298" class="pw-post-body-paragraph iz ja jb jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx ij bi translated">我们将使用<a class="ae kh" href="https://github.com/axios/axios" rel="noopener ugc nofollow" target="_blank"> axios </a>向Slack webhook发送请求。这主要是为了演示如何将Lambda的npm包与CDK捆绑在一起。</p><figure class="ll lm ln lo gt is"><div class="bz fp l di"><div class="lp lq l"/></div></figure><figure class="ll lm ln lo gt is"><div class="bz fp l di"><div class="lp lq l"/></div></figure><figure class="ll lm ln lo gt is"><div class="bz fp l di"><div class="lp lq l"/></div></figure><p id="a126" class="pw-post-body-paragraph iz ja jb jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx ij bi translated"><code class="fe lr ls lt lu b">exports.handler</code>是我们希望Lambda在被调用时调用的函数。这里，我们将简单地调用<code class="fe lr ls lt lu b">sendText("Lambda Cron job message")</code>向Slack发送消息！</p><p id="8bde" class="pw-post-body-paragraph iz ja jb jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx ij bi translated">导出的名称也与我们的CDK设置中的<code class="fe lr ls lt lu b">handler: "slack-message.handler"</code>属性对齐(它基本上是<code class="fe lr ls lt lu b">file.exportedFunctionWeWantToInvoke</code>)。</p><h2 id="55e9" class="kn ko jb bd kp kq kr dn ks kt ku dp kv jl kw kx ky jp kz la lb jt lc ld le lf bi translated">运行CDK</h2><p id="b848" class="pw-post-body-paragraph iz ja jb jc b jd lg jf jg jh lh jj jk jl li jn jo jp lj jr js jt lk jv jw jx ij bi translated">我们现在准备运行CDK！</p><figure class="ll lm ln lo gt is"><div class="bz fp l di"><div class="lp lq l"/></div></figure><p id="35ef" class="pw-post-body-paragraph iz ja jb jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx ij bi translated">你可以运行<code class="fe lr ls lt lu b">cdk help</code>来获得更多信息，但是基本上我们想要做的是运行下面的:</p><figure class="ll lm ln lo gt is"><div class="bz fp l di"><div class="lp lq l"/></div></figure><p id="982d" class="pw-post-body-paragraph iz ja jb jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx ij bi translated">如果成功，我们现在将有我们的lambda函数部署到AWS！在接下来的一分钟左右检查松弛度，以确认事情按预期运行。</p><figure class="ll lm ln lo gt is gh gi paragraph-image"><div class="ab gu cl lv"><img src="../Images/9a6e62a0dd5342c13035248d9cc40f87.png" data-original-src="https://miro.medium.com/v2/0*bjc-Zz_fX8XaFn1L"/></div></figure><p id="631d" class="pw-post-body-paragraph iz ja jb jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx ij bi translated">恭喜你！您现在可以运行<code class="fe lr ls lt lu b">cdk destroy</code>来拆除AWS资源(除非您倾向于在Slack上每分钟都收到该消息并享受账单)。</p><p id="3e0b" class="pw-post-body-paragraph iz ja jb jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx ij bi translated">这可以重新适用于你做任何Cron工作，你想！生活是奇妙的。编码快乐！</p><p id="5f57" class="pw-post-body-paragraph iz ja jb jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx ij bi translated">在<a class="ae kh" href="https://github.com/okeeffed/lambda-cron-cdk-example" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上查看已完成的项目。</p><h2 id="b06b" class="kn ko jb bd kp kq kr dn ks kt ku dp kv jl kw kx ky jp kz la lb jt lc ld le lf bi translated">资源和进一步阅读</h2><p id="4210" class="pw-post-body-paragraph iz ja jb jc b jd lg jf jg jh lh jj jk jl li jn jo jp lj jr js jt lk jv jw jx ij bi translated">贯穿整篇文章的进一步阅读或参考资料清单。</p><ol class=""><li id="9d06" class="jy jz jb jc b jd je jh ji jl ka jp kb jt kc jx kd ke kf kg bi translated">【Zalando如何在Java中使用lambda cron</li><li id="3874" class="jy jz jb jc b jd ki jh kj jl kk jp kl jt km jx kd ke kf kg bi translated"><a class="ae kh" href="https://github.com/aws-samples/aws-cdk-examples/tree/master/typescript/lambda-cron" rel="noopener ugc nofollow" target="_blank">lambda-cron的AWS CDK GitHub示例</a></li><li id="d356" class="jy jz jb jc b jd ki jh kj jl kk jp kl jt km jx kd ke kf kg bi translated"><a class="ae kh" href="https://docs.aws.amazon.com/cdk/api/latest/docs/aws-lambda-readme.html" rel="noopener ugc nofollow" target="_blank"> AWS Lambda参考值</a></li><li id="388c" class="jy jz jb jc b jd ki jh kj jl kk jp kl jt km jx kd ke kf kg bi translated"><a class="ae kh" href="https://docs.aws.amazon.com/lambda/latest/dg/services-cloudwatchevents-expressions.html" rel="noopener ugc nofollow" target="_blank">AWS中的Cron示例</a></li><li id="a8ec" class="jy jz jb jc b jd ki jh kj jl kk jp kl jt km jx kd ke kf kg bi translated"><a class="ae kh" href="https://docs.aws.amazon.com/cdk/latest/guide/serverless_example.html" rel="noopener ugc nofollow" target="_blank">使用AWS CDK创建无服务器应用</a></li><li id="33a8" class="jy jz jb jc b jd ki jh kj jl kk jp kl jt km jx kd ke kf kg bi translated"><a class="ae kh" href="https://github.com/aws/aws-cdk/issues/3918" rel="noopener ugc nofollow" target="_blank">CDK环境变量解析警告</a></li><li id="3d25" class="jy jz jb jc b jd ki jh kj jl kk jp kl jt km jx kd ke kf kg bi translated"><a class="ae kh" href="https://docs.aws.amazon.com/cdk/latest/guide/hello_world.html" rel="noopener ugc nofollow" target="_blank">合成和破坏资源</a></li><li id="78d8" class="jy jz jb jc b jd ki jh kj jl kk jp kl jt km jx kd ke kf kg bi translated"><a class="ae kh" href="https://binx.io/blog/2020/01/30/building-an-aws-cdk-credential-provider/" rel="noopener ugc nofollow" target="_blank"> AWS CDK认证提供商</a></li><li id="6db2" class="jy jz jb jc b jd ki jh kj jl kk jp kl jt km jx kd ke kf kg bi translated"><a class="ae kh" href="https://www.npmjs.com/" rel="noopener ugc nofollow" target="_blank"> NPM网站</a></li><li id="c9c2" class="jy jz jb jc b jd ki jh kj jl kk jp kl jt km jx kd ke kf kg bi translated"><a class="ae kh" href="https://docs.aws.amazon.com/sdk-for-java/v1/developer-guide/setup-credentials.html" rel="noopener ugc nofollow" target="_blank">设置AWS凭证</a></li><li id="13cd" class="jy jz jb jc b jd ki jh kj jl kk jp kl jt km jx kd ke kf kg bi translated"><a class="ae kh" href="https://api.slack.com/messaging/webhooks" rel="noopener ugc nofollow" target="_blank">松紧网钩文档</a></li><li id="cffd" class="jy jz jb jc b jd ki jh kj jl kk jp kl jt km jx kd ke kf kg bi translated"><a class="ae kh" href="https://github.com/okeeffed/lambda-cron-cdk-example" rel="noopener ugc nofollow" target="_blank">okeeffed/lambda-cron-CDK项目回购-示例</a></li></ol><p id="4d5d" class="pw-post-body-paragraph iz ja jb jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx ij bi translated"><em class="lw">图片来源:</em> <a class="ae kh" href="https://unsplash.com/@casparrubin" rel="noopener ugc nofollow" target="_blank"> <em class="lw">卡斯帕卡米尔鲁宾</em> </a></p><p id="a8e9" class="pw-post-body-paragraph iz ja jb jc b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx ij bi translated"><em class="lw">原贴于我的</em> <a class="ae kh" href="https://blog.dennisokeeffe.com/blog/2020-06-22-cdk-lambda-to-send-slack-message/" rel="noopener ugc nofollow" target="_blank"> <em class="lw">博客</em> </a> <em class="lw">。</em></p></div></div>    
</body>
</html>