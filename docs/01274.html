<html>
<head>
<title>Google Sign-In with SwiftUI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 SwiftUI 登录 Google</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/google-sign-in-with-swiftui-63f8e1deeae6?source=collection_archive---------1-----------------------#2020-06-29">https://blog.devgenius.io/google-sign-in-with-swiftui-63f8e1deeae6?source=collection_archive---------1-----------------------#2020-06-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/d3c7eb6606eb49a4c8269f5489271ae0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*l7JouyJ1J-6Uotuj"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">马库斯·温克勒在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="6983" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="lb">原贴于我的</em> <a class="ae kc" href="https://www.andrewmin.info/blog/google-sign-in/" rel="noopener ugc nofollow" target="_blank"> <em class="lb">博客</em> </a></p><h1 id="ed34" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">概观</h1><p id="05b7" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated">谷歌提供了一个简单的 SDK，通过一个有用的<a class="ae kc" href="https://developers.google.com/identity/sign-in/ios/start-integrating" rel="noopener ugc nofollow" target="_blank">指南</a>将谷歌登录与 iOS 应用集成在一起。然而，该指南介绍了使用 UIKit 的代码示例，因此我将展示如何使用 SwiftUI 和管理状态来使用 Google Sign-In(这是<strong class="kf ir">而不是</strong>旨在取代该指南，这只是展示了使用 SwiftUI 的示例)。</p><h1 id="e715" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">装置</h1><p id="4542" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated"><a class="ae kc" href="https://developers.google.com/identity/sign-in/ios/start-integrating" rel="noopener ugc nofollow" target="_blank">指南</a>中有几页是关于为你的项目设置<code class="fe mf mg mh mi b">GoogleSignIn</code>的。总而言之，您需要:</p><ul class=""><li id="7c49" class="mj mk iq kf b kg kh kk kl ko ml ks mm kw mn la mo mp mq mr bi translated">用 CocoaPods ( <code class="fe mf mg mh mi b">pod 'GoogleSignIn'</code>)将<code class="fe mf mg mh mi b">GoogleSignIn</code>包添加到您的项目中。</li><li id="32a8" class="mj mk iq kf b kg ms kk mt ko mu ks mv kw mw la mo mp mq mr bi translated">去谷歌的开发者控制台创建一个新项目，然后获取你的 OAuth 2.0 客户端 ID 证书。</li><li id="bd62" class="mj mk iq kf b kg ms kk mt ko mu ks mv kw mw la mo mp mq mr bi translated">在 Xcode 项目目标的“信息”选项卡下的“URL 类型”中添加一个条目。URL 方案可以在开发人员控制台的“iOS URL 方案”下找到(这只是您的“客户端 ID”，域名颠倒了)。添加 URL 方案允许登录网页重定向回你的应用。</li></ul><h1 id="f9c7" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">谷歌代表</h1><p id="1ea2" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated">Google 建议在你的<code class="fe mf mg mh mi b">AppDelegate</code>中实现<code class="fe mf mg mh mi b">GIDSignInDelegate</code>，但是相反，我们将创建一个单独的<code class="fe mf mg mh mi b">GoogleDelegate</code>，这将使得管理 SwiftUI 状态更加容易。<code class="fe mf mg mh mi b">GoogleDelegate</code>也将实现<code class="fe mf mg mh mi b">ObservableObject</code>并包含一个已发布的属性— <code class="fe mf mg mh mi b">signedIn</code>。处理登录的视图可以通过观察<code class="fe mf mg mh mi b">signedIn</code>属性自动更新。</p><pre class="mx my mz na gt nb mi nc nd aw ne bi"><span id="5be9" class="nf ld iq mi b gy ng nh l ni nj">import GoogleSignIn</span><span id="8b22" class="nf ld iq mi b gy nk nh l ni nj">class GoogleDelegate: NSObject, GIDSignInDelegate, ObservableObject {</span><span id="d832" class="nf ld iq mi b gy nk nh l ni nj">    @Published var signedIn: Bool = false</span><span id="14dc" class="nf ld iq mi b gy nk nh l ni nj">    ...<br/>}</span></pre><p id="a737" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，我们必须实现用户登录时调用的<code class="fe mf mg mh mi b">sign(_:didSignInFor:withError:)</code>方法。该指南提供了一个示例实现，但是如果登录成功，我们将添加一行来将我们的<code class="fe mf mg mh mi b">signedIn</code>属性设置为<code class="fe mf mg mh mi b">true</code>。</p><pre class="mx my mz na gt nb mi nc nd aw ne bi"><span id="68f1" class="nf ld iq mi b gy ng nh l ni nj">func sign(_ signIn: GIDSignIn!, didSignInFor user: GIDGoogleUser!, withError error: Error!) {<br/>    if let error = error {<br/>        if (error as NSError).code == GIDSignInErrorCode.hasNoAuthInKeychain.rawValue {<br/>            print("The user has not signed in before or they have since signed out.")<br/>        } else {<br/>            print("\(error.localizedDescription)")<br/>        }<br/>        return<br/>    }</span><span id="ed0e" class="nf ld iq mi b gy nk nh l ni nj">    // If the previous `error` is null, then the sign-in was succesful<br/>    print("Successful sign-in!")<br/>    signedIn = true<br/>}</span></pre><p id="5fff" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">注意:如果您决定用一种不同于打印错误的方式来处理错误，一定要检查错误不是<code class="fe mf mg mh mi b">GIDSignInErrorCode.canceled</code>。如果用户点击登录按钮，然后关闭登录页面，<code class="fe mf mg mh mi b">sign(_:didSignInFor:withError:)</code>将被调用，并显示一个<code class="fe mf mg mh mi b">GIDSignInErrorCode.canceled</code>错误，您很可能想忽略这个错误。</p><h1 id="b269" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">应用和场景代表</h1><p id="2d41" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated">现在<code class="fe mf mg mh mi b">GoogleDelegate</code>已经完成，我们需要给<code class="fe mf mg mh mi b">AppDelegate</code>和<code class="fe mf mg mh mi b">SceneDelegate</code>添加更多的设置。</p><p id="b7e5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先，在我们的<code class="fe mf mg mh mi b">AppDelegate</code>的<code class="fe mf mg mh mi b">application(_:didFinishLaunchingWithOptions:</code>(应用程序入口点)中，我们将设置我们的:</p><ul class=""><li id="9f1a" class="mj mk iq kf b kg kh kk kl ko ml ks mm kw mn la mo mp mq mr bi translated">客户端 ID —客户端 ID 位于开发人员控制台中。</li><li id="ff77" class="mj mk iq kf b kg ms kk mt ko mu ks mv kw mw la mo mp mq mr bi translated">代表—我们的<code class="fe mf mg mh mi b">GoogleDelegate</code>班。</li><li id="3e15" class="mj mk iq kf b kg ms kk mt ko mu ks mv kw mw la mo mp mq mr bi translated">范围——您的应用程序需要请求的任何额外的<a class="ae kc" href="https://developers.google.com/identity/protocols/oauth2/scopes" rel="noopener ugc nofollow" target="_blank">范围</a>。</li></ul><pre class="mx my mz na gt nb mi nc nd aw ne bi"><span id="28f9" class="nf ld iq mi b gy ng nh l ni nj">// GIDSignIn's delegate is a weak property, so we have to define our GoogleDelegate outside the function to prevent it from being deallocated.<br/>let googleDelegate = GoogleDelegate()</span><span id="1719" class="nf ld iq mi b gy nk nh l ni nj">func application(_ application: UIApplication, didFinishLaunchingWithOptions launchOptions [UIApplication.LaunchOptionsKey: Any]?) -&gt; Bool {</span><span id="39df" class="nf ld iq mi b gy nk nh l ni nj">    GIDSignIn.sharedInstance().clientID = "...googleusercontent.com"<br/>    GIDSignIn.sharedInstance().delegate = googleDelegate<br/>    GIDSignIn.sharedInstance().scopes = Constants.GS.scopes</span><span id="c11a" class="nf ld iq mi b gy nk nh l ni nj">    return true<br/>}</span></pre><p id="11ca" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们还必须实现<code class="fe mf mg mh mi b">application(_:open:options:)</code>，它在登录页面重定向回我们的应用程序时被调用。</p><pre class="mx my mz na gt nb mi nc nd aw ne bi"><span id="b5dc" class="nf ld iq mi b gy ng nh l ni nj">func application(_ app: UIApplication, open url: URL, options [UIApplication.OpenURLOptionsKey : Any]) -&gt; Bool {<br/>    return GIDSignIn.sharedInstance().handle(url)<br/>}</span></pre><p id="ea57" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，我们必须给<code class="fe mf mg mh mi b">SceneDelegate</code>中的<code class="fe mf mg mh mi b">scene(_:willConnectTo:options:)</code>方法添加一些东西。首先，我们将把我们的<code class="fe mf mg mh mi b">googleDelegate</code>设置为<code class="fe mf mg mh mi b">EnvironmentObject</code>，这样我们的视图可以很容易地访问它。其次，我们还需要设置<code class="fe mf mg mh mi b">GIDSignIn.sharedInstance().presentingViewController</code>。通常，我们会将<code class="fe mf mg mh mi b">presentingViewController</code>设置为<code class="fe mf mg mh mi b">UIViewController</code>拥有的任何登录视图，但是因为我们没有任何视图控制器，所以我们将它设置为<code class="fe mf mg mh mi b">rootViewController</code>。</p><pre class="mx my mz na gt nb mi nc nd aw ne bi"><span id="16a5" class="nf ld iq mi b gy ng nh l ni nj">func scene(_ scene: UIScene, willConnectTo session: UISceneSession, options connectionOptions: UIScene.ConnectionOptions) {</span><span id="48aa" class="nf ld iq mi b gy nk nh l ni nj">    // Get the googleDelegate from AppDelegate<br/>    let googleDelegate = (UIApplication.shared.delegate as! AppDelegate).googleDelegate</span><span id="dc99" class="nf ld iq mi b gy nk nh l ni nj">    // Add googleDelegate as an environment object<br/>    let contentView = ContentView()<br/>        .environmentObject(googleDelegate)</span><span id="787c" class="nf ld iq mi b gy nk nh l ni nj">    if let windowScene = scene as? UIWindowScene {<br/>        let window = UIWindow(windowScene: windowScene)<br/>        window.rootViewController = UIHostingController(rootView: contentView)</span><span id="84bb" class="nf ld iq mi b gy nk nh l ni nj">        // Set presentingViewControll to rootViewController<br/>        GIDSignIn.sharedInstance().presentingViewController = window.rootViewController</span><span id="7017" class="nf ld iq mi b gy nk nh l ni nj">        self.window = window<br/>        window.makeKeyAndVisible()<br/>    }<br/>}</span></pre><h1 id="f17f" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">登录按钮</h1><p id="895c" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated">最后，完成所有设置后，我们可以创建我们的登录页面了。我们将设计我们的页面，如果用户没有登录，我们会显示一个简单的登录按钮。如果用户已登录，我们将显示他们的姓名和电子邮件以及一个注销按钮。请注意，这里关注的是功能，而不是漂亮的 UI。</p><p id="d394" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于登录按钮，Google 提供了<code class="fe mf mg mh mi b">GIDSignInButton</code>类，它已经有了一个标准的 Google 外观并处理点击动作。由于按钮是一个<code class="fe mf mg mh mi b">UIControl</code>，我们需要将它包装在一个<code class="fe mf mg mh mi b">UIViewRepresentable</code>中，以便在 SwiftUI 主体中使用它。</p><pre class="mx my mz na gt nb mi nc nd aw ne bi"><span id="9615" class="nf ld iq mi b gy ng nh l ni nj">import GoogleSignIn<br/>import SwiftUI</span><span id="2218" class="nf ld iq mi b gy nk nh l ni nj">struct SignInButton: UIViewRepresentable {</span><span id="967d" class="nf ld iq mi b gy nk nh l ni nj">    func makeUIView(context: Context) -&gt; GIDSignInButton {<br/>        let button = GIDSignInButton()<br/>        // Customize button here<br/>        button.colorScheme = .light<br/>        return button<br/>    }</span><span id="5540" class="nf ld iq mi b gy nk nh l ni nj">    func updateUIView(_ uiView: UIViewType, context: Context) {}   <br/>}</span><span id="c9dc" class="nf ld iq mi b gy nk nh l ni nj">struct ContentView: View {</span><span id="2b17" class="nf ld iq mi b gy nk nh l ni nj">    @EnvironmentObject var googleDelegate: GoogleDelegate</span><span id="e950" class="nf ld iq mi b gy nk nh l ni nj">    var body: some View {<br/>        SignInButton()<br/>    }<br/>}</span></pre><p id="271d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">或者，您可以创建自己的按钮，并在点击时调用<code class="fe mf mg mh mi b">GIDSignIn.sharedInstance().signIn()</code>。</p><pre class="mx my mz na gt nb mi nc nd aw ne bi"><span id="c960" class="nf ld iq mi b gy ng nh l ni nj">var body: some View {<br/>    Button(action: {<br/>        GIDSignIn.sharedInstance().signIn()<br/>    }) {<br/>        Text("Sign In")<br/>    }<br/>}</span></pre><p id="f912" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">太好了，现在我们的用户可以登录了。然而，<code class="fe mf mg mh mi b">GoogleDelegate</code>的全部目的是在用户登录后更新我们的视图，所以让我们显示一些用户登录后的信息。个人资料可以在<code class="fe mf mg mh mi b">GIDSignIn.sharedInstance().currentUser!.profile</code>中找到。</p><p id="0f2d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们还需要一个注销按钮。当它被按下时，我们调用<code class="fe mf mg mh mi b">GIDSignIn.sharedInstance().signOut()</code>,并将我们的 GoogleDelegate 中的<code class="fe mf mg mh mi b">signedIn</code>设置为<code class="fe mf mg mh mi b">false</code>,以再次显示登录按钮。</p><pre class="mx my mz na gt nb mi nc nd aw ne bi"><span id="e413" class="nf ld iq mi b gy ng nh l ni nj">// To use if/else in our body, we need to wrap the view in a Group<br/>var body: some View {<br/>    Group {<br/>        if googleDelegate.signedIn {<br/>            VStack {<br/>                Text(GIDSignIn.sharedInstance().currentUser!.profile.name)<br/>                Text(GIDSignIn.sharedInstance().currentUser!.profile.email)<br/>                Button(action: {<br/>                    GIDSignIn.sharedInstance().signOut()<br/>                    googleDelegate.signedIn = false<br/>                }) {<br/>                    Text("Sign Out")<br/>                }<br/>            }<br/>        } else {<br/>            Button(action: {<br/>                GIDSignIn.sharedInstance().signIn()<br/>            }) {<br/>                Text("Sign In")<br/>            }<br/>        }<br/>    }<br/>}</span></pre><p id="1448" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，如果我们运行我们的应用程序，我们会看到一个登录按钮。按下时，谷歌登录模式将弹出。请注意，如果您请求了敏感范围(可以访问个人信息的范围)，您将看到一个警告，上面写着“此应用程序未经验证”。为了摆脱这一点，你需要让你的应用程序<a class="ae kc" href="https://support.google.com/cloud/answer/7454865?hl=en" rel="noopener ugc nofollow" target="_blank">得到验证</a>。但是对于测试，您可以只按左下角的“高级”，然后“转到*App*(不安全)”。</p><p id="3f8b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">登录后，模式应该消失，视图现在应该显示您的姓名和电子邮件地址，以及一个注销按钮。按注销将刷新视图，并再次显示登录按钮。</p><figure class="mx my mz na gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/af38ae5b5d2fb94b8a85a03735eefd89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*NeqIZ6Utn040tK6X.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">用户登录后，视图会显示他们的姓名和电子邮件。</figcaption></figure><p id="177f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后，为了在用户关闭并重新打开应用程序时自动登录，我们需要在用户打开登录页面时调用<code class="fe mf mg mh mi b">GIDSignIn.sharedInstance().restorePreviousSignIn()</code>。</p><pre class="mx my mz na gt nb mi nc nd aw ne bi"><span id="0356" class="nf ld iq mi b gy ng nh l ni nj">var body: some View {<br/>    Group {<br/>        ...<br/>    }<br/>    .onAppear {<br/>        GIDSignIn.sharedInstance().restorePreviousSignIn()<br/>    }<br/>}</span></pre><h1 id="0de7" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">摘要</h1><p id="6f9f" class="pw-post-body-paragraph kd ke iq kf b kg ma ki kj kk mb km kn ko mc kq kr ks md ku kv kw me ky kz la ij bi translated">使用 SwiftUI 的<code class="fe mf mg mh mi b">ObservableObject</code>来管理状态使得我们的视图在用户登录或退出时自动更新变得非常容易。使用 UIKit，当用户登录或退出时，你必须管理混乱的<code class="fe mf mg mh mi b">NotificationCenter</code>帖子来更新 UI。</p><p id="024d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用 Google Sign-In 做一些有用的事情，比如进行 API 调用或者向您自己的后端验证用户，这超出了本文的范围，但是 Google 提供了许多他们自己的指南。</p><p id="e131" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="lb">原发于我的</em> <a class="ae kc" href="https://www.andrewmin.info/blog/google-sign-in/" rel="noopener ugc nofollow" target="_blank"> <em class="lb">博客</em> </a></p></div></div>    
</body>
</html>