<html>
<head>
<title>Scale API calls from DB using Apache Nifi</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Apache Nifi 从数据库扩展 API 调用</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/scale-api-calls-from-db-using-apache-nifi-81a006aad90c?source=collection_archive---------5-----------------------#2021-07-20">https://blog.devgenius.io/scale-api-calls-from-db-using-apache-nifi-81a006aad90c?source=collection_archive---------5-----------------------#2021-07-20</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="8eca" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如今，为了将应用程序扩展到小型建筑组件，分解一个整体并开发微服务要容易得多。这些服务通常使用 API 相互通信。</p><blockquote class="ki kj kk"><p id="bbdf" class="jk jl kl jm b jn jo jp jq jr js jt ju km jw jx jy kn ka kb kc ko ke kf kg kh ig bi translated">一个<strong class="jm io">应用编程接口</strong> ( <strong class="jm io"> API </strong>)是<a class="ae kp" href="https://en.wikipedia.org/wiki/Computer" rel="noopener ugc nofollow" target="_blank">计算机</a>之间或者<a class="ae kp" href="https://en.wikipedia.org/wiki/Computer_program" rel="noopener ugc nofollow" target="_blank">计算机程序</a>之间的连接。它是一种软件<a class="ae kp" href="https://en.wikipedia.org/wiki/Interface_(computing)" rel="noopener ugc nofollow" target="_blank">接口</a>，为其他<a class="ae kp" href="https://en.wikipedia.org/wiki/Software" rel="noopener ugc nofollow" target="_blank">软件</a>提供服务。<a class="ae kp" href="https://en.wikipedia.org/wiki/API#cite_note-1" rel="noopener ugc nofollow" target="_blank">【1】</a>描述如何构建这种连接或接口的文档或标准称为<em class="in"> API 规范</em>。符合这个标准的计算机系统被称为<em class="in">实现</em>或<em class="in">公开</em>一个 API。术语 API 既可以指规范，也可以指实现。</p></blockquote><p id="8dab" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">API 已经改变了我们在代码开发中的操作方式，非常易于使用，并且在需要获取数据时被广泛传播。</p><p id="d0fe" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如今，组织使用 API 连接公开共享信息给:</p><ol class=""><li id="8b57" class="kq kr in jm b jn jo jr js jv ks jz kt kd ku kh kv kw kx ky bi translated">不同的监管机构</li><li id="581f" class="kq kr in jm b jn kz jr la jv lb jz lc kd ld kh kv kw kx ky bi translated">与其他公司的整合</li></ol><p id="3b39" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">API 内部的另一个重要用例是内部操作和支持。如今，每家公司都有不同层次的支持:</p><p id="bea9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">1.第 1 层 2。第二层<br/> 3。三级+四级</p><p id="88a6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">每个支持级别都需要使用内部后台系统的内部工具在数据库中运行查询，以调查和缓解问题。</p><p id="bb80" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">尤其是第 3 层和第 4 层，更像是一个技术团队，对公司的架构结构有更全面的方法。他们知道哪些组件相互关联，以及如何解决问题。他们使用的工具之一是使用 API 调用内部应用程序。</p><p id="95ad" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这是一种模拟应用程序流程并以适当和有文档记录的方式解决问题的强大方法。</p><h1 id="3106" class="le lf in bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">贸易工具</h1><p id="a61a" class="pw-post-body-paragraph jk jl in jm b jn mc jp jq jr md jt ju jv me jx jy jz mf kb kc kd mg kf kg kh ig bi translated">调用 API 的方法有很多，从简单的使用浏览器到编写脚本和使用现成的工具，比如 Postman。</p><p id="76e4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">以上都很棒，可以由团队的每个成员单独运行，没有任何干扰。</p><p id="9231" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">但是，如果前面的一行让您有点畏缩，那么您心里有一些安全感&amp;审计。</p><p id="66ea" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">调用内部 API 时，我们需要遵循以下准则:</p><p id="4fc8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> A .安全性。</strong>我们不能允许任何人调用内部 API。我们需要阻止该选项被组织中受信任的人使用。这是通过分配对特定 IP/Mac 地址的访问来实现的。<br/>另一种选择是完全阻止访问，只有应用程序可以相互调用，即只有来自该 vlan 环境中的应用程序的调用可以进行 API 调用。第三种选择是使用 VPN 来控制它，但是这需要大量的处理。</p><p id="2c06" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> B .审计。</strong>如果一个团队成员在自己的工作站上运行脚本，会有人知道吗？我们如何监督这种行为？</p><p id="b4dd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> C .一致性。假设我们同意用一个脚本来运行我们的代码。<br/>如果我需要做一点点改变，那么现在我打的每个电话都有不同的足迹，该怎么办？</strong></p><p id="5633" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">今天最常用的工具是邮递员。它非常轻便，易于使用，只有一点不足:适当的审计。</p><p id="0d0b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">因此，我们需要找到一种方法来使这些大摇大摆的调用更加包容、安全，并且能够在以后进行询问。介绍<strong class="jm io">阿皮尔。</strong></p></div><div class="ab cl mh mi hr mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ig ih ii ij ik"><h1 id="b364" class="le lf in bd lg lh mo lj lk ll mp ln lo lp mq lr ls lt mr lv lw lx ms lz ma mb bi translated">阿帕奇 NIFI</h1><blockquote class="ki kj kk"><p id="f1fa" class="jk jl kl jm b jn jo jp jq jr js jt ju km jw jx jy kn ka kb kc ko ke kf kg kh ig bi translated">Apache NiFi 支持强大且可伸缩的数据路由、转换和系统中介逻辑的有向图</p></blockquote><p id="f805" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">Nifi 是一个强大数据传输和丰富工具，可以用于多种目的，可以在几秒钟内处理数千个流文件。这就是我们选择它作为这个流程的原因，因为它可以:</p><p id="41b8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">1.HTTP/S 调用。<br/> 2。从数据库获取数据。<br/> 3。更新数据库。<br/> 4。处理负载。<br/> 5。流量控制可用于许多属性。</p></div><div class="ab cl mh mi hr mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ig ih ii ij ik"><h1 id="e690" class="le lf in bd lg lh mo lj lk ll mp ln lo lp mq lr ls lt mr lv lw lx ms lz ma mb bi translated">解决方案架构</h1><p id="1496" class="pw-post-body-paragraph jk jl in jm b jn mc jp jq jr md jt ju jv me jx jy jz mf kb kc kd mg kf kg kh ig bi translated">下图说明了总体架构:</p><figure class="mu mv mw mx gt my gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi mt"><img src="../Images/0b16e00ee16226ce75cfc3b9e7178912.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_yXvfkzlRXjhdnvF4fnLxw.jpeg"/></div></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">阿皮尔建筑</figcaption></figure><p id="db0e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">1.支持团队收到一张关于需要修复的不良群体的罚单。<br/> 2。他们调查并找到所需的人口。他们将数据放入 DB 中的一个专用表中(下面 git 中的完整 sql 模式):<br/> 4。Nifi 总是监听那个表，一旦监听到，它就会找到状态为“0”的群体[新的和就绪的]，并将群体提取到流文件中，并将数据库更新回状态为“1”的群体[传输中]。<br/> 5。基于该表中的数据，它执行 API 调用(下面有更详细的流程)并返回调用的响应代码。<br/> 6。然后，Nifi 用每个调用的响应更新 DB。</p><h1 id="d696" class="le lf in bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">NIFI 流</h1><p id="349c" class="pw-post-body-paragraph jk jl in jm b jn mc jp jq jr md jt ju jv me jx jy jz mf kb kc kd mg kf kg kh ig bi translated">使用上面的流程，我们可以通过一种清晰的方式来跟踪所有的呼叫，并统计有多少呼叫成功以及到达哪个端点，从而极大地扩展我们的呼叫。为了更好的理解，我们用 Grafana 来形象化它。<br/>一些统计:<br/> 1。开始于 2019-01-23，自(908 天)<br/> 2 开始运行。迄今已创建 8760046 个呼叫，其中 6894019 个成功<br/> 3。由不同的 20 个用户使用(有些是自动化流程)<br/> 4。打电话给 30 个不同的内部服务机构</p><figure class="mu mv mw mx gt my gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi nj"><img src="../Images/dfc4f2892b0dac71478ff7856ad1ce4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r9nLQsxzAndj3EvN1hfaAg.jpeg"/></div></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">格拉夫纳的阿皮尔统计</figcaption></figure><p id="c371" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">为了了解原因，我们将所有的 nifi 日志收集到 ELK 堆栈中，以创建关于不成功调用的警报。</p><figure class="mu mv mw mx gt my gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi nk"><img src="../Images/153ba5c57dd0040081d3324f27d6d744.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*esncBLRS3XCPGj29OL4D5A.jpeg"/></div></div></figure><h1 id="60d2" class="le lf in bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">SQL 模式</h1><p id="26b3" class="pw-post-body-paragraph jk jl in jm b jn mc jp jq jr md jt ju jv me jx jy jz mf kb kc kd mg kf kg kh ig bi translated">在专用的 sql 表“APIer”中:</p><pre class="mu mv mw mx gt nl nm nn no aw np bi"><span id="6363" class="nq lf in nm b gy nr ns l nt nu">[ID] [int] IDENTITY(1,1) NOT NULL,<br/>[MethodID] [int] NOT NULL, // method connect as for FK to APIerMethods. can control the CRUD type<br/>[Body] [nvarchar](max) NULL,<br/>[Headers] [nvarchar](max) NULL,<br/>[DelayInMiliseconds] [int] NULL, <br/>[URI] [nvarchar](1000) NOT NULL, // The End Point the nifi will call <br/>[StatusID] [int] NOT NULL, <br/>[CreateDate] [datetime2](7) NOT NULL,<br/>[UpdateDate] [datetime2](7) NOT NULL,<br/>[Ticket] [nvarchar](200) NULL, // Ticket id of the request<br/>[RequestedUser] [varchar](250) NOT NULL,<br/>[ResponseBody] [nvarchar](max) NULL // the status of call will be update here</span></pre><p id="00f0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">完整的 APIer 模板可以在下面的 GitHub 资源库中找到，包括:<br/> 1。SQL 文件夹，包含所有必需的表和 SP <br/> 2。Nifi XML(和 JSON)模板。</p><p id="d437" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">https://github.com/mormor83/APIer<a class="ae kp" href="https://github.com/mormor83/APIer" rel="noopener ugc nofollow" target="_blank"/></p><h1 id="f266" class="le lf in bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">结论</h1><p id="2593" class="pw-post-body-paragraph jk jl in jm b jn mc jp jq jr md jt ju jv me jx jy jz mf kb kc kd mg kf kg kh ig bi translated">这个流程已经成为我们支持团队(和一些开发团队:)直接从数据库运行多个 API 调用的主要来源。通过内置在“控制速率”处理器中的 Nifi，我们可以根据一些参数来调节流文件。然后，我们可以按我们想要的方式扩展它，最重要的是，我们可以记录和跟踪每个调用。</p></div></div>    
</body>
</html>