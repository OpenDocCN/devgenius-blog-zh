<html>
<head>
<title>How To…Increasing your Database Performance</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何…提高数据库性能</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/how-to-increasing-your-database-performance-2f5157d0c010?source=collection_archive---------9-----------------------#2022-01-19">https://blog.devgenius.io/how-to-increasing-your-database-performance-2f5157d0c010?source=collection_archive---------9-----------------------#2022-01-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/071bec1863449900af7417e71683a1ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*isBO1tPYHo6DnWah"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated"><a class="ae kc" href="https://unsplash.com/@nci?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">国家癌症研究所</a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="2f66" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在每个开发人员的生活中，总会有这样一个时刻，你会面临这样一个问题“为什么数据库这么慢？”。稍微调查一下之后，你会注意到“嘿，那真的很慢”。为了避免这种情况，我将为您的SQL查询提供一些最佳实践。</p><h1 id="997f" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">一般提示</h1><h1 id="304e" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">分析执行计划</h1><p id="5dc3" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">当我们执行SQL语句时，我们的数据库引擎首先分析没有语法错误。然后，它计算执行语句的最佳方式。结果就是执行计划</p><p id="41e0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以使用这个SQL执行计划来分析SQL语句是如何执行的，并搜索性能问题。在SQL Server中，存在一种图形方式或表格方式。你可以选择你可能使用的。我将向你展示图形化的方式。为此，您必须首先执行以下命令:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="144d" class="mn lc iq mj b gy mo mp l mq mr">SET STATISTICS XML ON</span></pre><p id="0f53" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们执行查询本身，例如，这个查询:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="1f08" class="mn lc iq mj b gy mo mp l mq mr">select (select Title from tasks where id=taskid),* from TaskUsers where userLogin ='DCCBF20E-3CF9-4DDE-9E68-A05CAD3D1111'</span></pre><p id="c525" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，它将在表中显示执行计划</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ms"><img src="../Images/3028a354003b8af2b65d0928b9979523.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Gii3bPRLaDVcNFGswwyYVg.png"/></div></div></figure><p id="20fb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您会立即看到大部分时间(成本)将受到影响的部分。这样，我们就可以做我们的优化。</p><h1 id="daba" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">避免编码循环</h1><p id="cb98" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">使用循环在表中进行插入是个坏主意，因为我们不让数据库引擎优化<em class="mt">插入</em>。我经常在代码中看到循环插入数百行，而不是使用其他更优化的方式。</p><p id="dd06" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用for循环:</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="25c9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此时，您可以准备您的查询来生成一批插入，或者更好的方法是使用实体框架的批量操作</p><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mw"><img src="../Images/dd165a3c53ae7ac20b3ed6853889e972.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*LswoNXUMlLSJG9AQ.png"/></div></div></figure><p id="5822" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这将允许在数据库中执行大量的插入/更新/删除操作。这个工具包将使您能够在很短的时间内将数据大量加载到数据库中。</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mu mv l"/></div></figure><h1 id="4915" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">避免相关的SQL子查询</h1><p id="6ec2" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">相关子查询是使用父查询中的值的查询。除非SQL引擎优化器用连接重写相关子查询。然后，它将对外部查询的每一行执行一次该连接，从而降低SQL查询的整体性能。</p><p id="3d4c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们以这个查询为例:</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="d352" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">正如我们在这里看到的，问题是内部查询(SELECT c.name…)对外部查询(SELECT r.id，..)并对外部查询处理的每一行重复同样的操作。所以这会降低性能。更好的方法是对表使用连接，在这种情况下，我们也使用左连接来产生空行。</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="39f5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这将更有效地执行查询</p><h1 id="8173" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">检查索引</h1><p id="168a" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">当然，每个开发人员都使用索引来加快查询速度。但是过多的(重叠的)索引可能会降低查询性能。</p><p id="aa65" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所以一个经验法则。仅为where子句中使用的字段创建索引(以及使用包含的列)。</p><p id="6ffd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">还要检查你的索引是否会被使用，否则就和他们说再见，删除它。这将释放磁盘空间，并且SQL Server不得维护/填充不再使用的索引。</p><h1 id="6049" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">对自动完成的事情使用全文</h1><p id="e872" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我经常看到许多开发人员使用Like子句来获得自动完成功能(例如为客户)。根据数据大小，这可能会非常慢。为此，您可以利用SQL Server的全文搜索功能。在这种情况下，您可以组合不同的文本列，并可以快速搜索。</p><h1 id="cd38" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">选择合适的数据类型</h1><p id="da91" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">并不是所有的类型都占据相同的位置，当我们使用一个具体的数据类型时，我们也可以根据我们存储的内容来限制它的大小。</p><p id="112b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此，请确保使用正确的数据类型和正确的大小。如果使用name列，那么使用varchar(50)而不是varchar(400)字段会有所不同。这将花费您更少的空间，并且SQL server不需要分析太多的开销。</p><h1 id="f137" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">处理</h1><p id="bc7c" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">保持短时间的转换开放。因为在处理表数据时可以锁定事务。结果可能会出现死锁。</p><h1 id="de56" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">仅选择您需要的字段</h1><p id="850d" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">不要用<code class="fe mx my mz mj b">Select *...</code>。从技术上来说，SQL Server通过查询来获取所选表中的所有列。然后它会自己运行查询。此外，这会给我们带来以下问题:</p><ol class=""><li id="4813" class="na nb iq kf b kg kh kk kl ko nc ks nd kw ne la nf ng nh ni bi translated">可以添加或删除列，或者修改表中的列名。因此，对于SELECT *我们可能会得到意外的结果</li><li id="c31a" class="na nb iq kf b kg nj kk nk ko nl ks nm kw nn la nf ng nh ni bi translated">SELECT *返回的列的顺序可能不同。</li></ol><h1 id="6b82" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="b877" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">要获得最大的性能不是一次表演。它必须被视为一个持续的过程。所以请关注你的数据库的可维护性。</p><p id="3921" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">把以上几点作为解决即将到来的问题的建议。</p><p id="e11c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当然，这篇文章不能展示所有的可能性，但集中在主要问题上。</p><p id="baa3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你认为我错过了许多主题，请关注我，获取更多这样的提示，并让我知道。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="fa27" class="mn lc iq mj b gy mo mp l mq mr"><strong class="mj ir"><em class="mt">Hi there 👋</em></strong></span><span id="f062" class="mn lc iq mj b gy no mp l mq mr"><em class="mt">I'm Sascha, a software engineer </em>💻, currently working at <a class="ae kc" href="https://www.realcore.de" rel="noopener ugc nofollow" target="_blank">RealCore</a><br/>Father ,Developer (MS stuff), IOT passionist, urban beekeper 🍯🐝</span><span id="971c" class="mn lc iq mj b gy no mp l mq mr"><em class="mt">Say Hello 🙌 on:<br/></em><a class="ae kc" href="https://www.linkedin.com/in/sascha-peter-bajonczak-32a17a2a/" rel="noopener ugc nofollow" target="_blank"><em class="mt">LinkedIn</em></a><em class="mt"> <br/></em><a class="ae kc" href="https://github.com/sbajonczak" rel="noopener ugc nofollow" target="_blank"><em class="mt">GitHub</em></a><em class="mt"><br/></em><a class="ae kc" href="https://blog.bajonczak.com/" rel="noopener ugc nofollow" target="_blank"><em class="mt">Blog</em></a></span><span id="1270" class="mn lc iq mj b gy no mp l mq mr">Subscribe to my Newsletter <a class="ae kc" href="https://medium.com/subscribe/@beejayherne" rel="noopener">here</a>.</span></pre></div></div>    
</body>
</html>