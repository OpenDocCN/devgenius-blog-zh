<html>
<head>
<title>Connecting to Cloud SQL Instance from BigQuery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从 BigQuery 连接到云 SQL 实例</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/connecting-to-cloud-sql-instance-from-bigquery-807fc186b314?source=collection_archive---------10-----------------------#2022-09-10">https://blog.devgenius.io/connecting-to-cloud-sql-instance-from-bigquery-807fc186b314?source=collection_archive---------10-----------------------#2022-09-10</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="9b91" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">将两者联系起来再容易不过了。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/352219bbce078dcf20b855b53022893c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BkEurazZhXs_6qOi9ocQhg.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">照片由 Brett Sayles 从<a class="ae ky" href="https://www.pexels.com/photo/golden-gate-bridge-over-body-of-water-3186163/" rel="noopener ugc nofollow" target="_blank">https://www . pexels . com/photo/golden-gate-bridge-over-the-body-of-water-3186163/</a></figcaption></figure></div><div class="ab cl kz la hr lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="ig ih ii ij ik"><p id="48b1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">最初，我的公司在 Cloud SQL 中使用 PostgreSQL 实例来存储我们所有的数据。随着时间的推移，我们的要求和愿望越来越多，我们扩展到 BigQuery，同时仍然使用云 SQL。因此，我需要找到一种方法来连接这两个地方的数据。</p><p id="3fb9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在本文的第一部分，我将讨论最初的一次性设置，它允许您在每次需要访问存储在云 SQL 中的任何数据时，只需使用 EXTERNAL_QUERY()函数。然后，我将向您展示如何连接 BigQuery 和云数据库之间的表，以及如何在 where 子句的子查询中使用来自云 SQL 的表。此外，我将阐明使用联邦查询的缺点。</p></div><div class="ab cl kz la hr lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="ig ih ii ij ik"><h2 id="3d3a" class="lg lh in bd li lj lk dn ll lm ln dp lo jv lp lq lr jz ls lt lu kd lv lw lx ly bi translated">A.从 BigQuery 创建到云 SQL 的连接</h2><p id="60f7" class="pw-post-body-paragraph jk jl in jm b jn lz jp jq jr ma jt ju jv mb jx jy jz mc kb kc kd md kf kg kh ig bi translated">(确保<a class="ae ky" href="https://console.cloud.google.com/apis/library/bigqueryconnection.googleapis.com?_ga=2.132575502.1890669153.1662665769-20160393.1626291283&amp;_gac=1.118873467.1660848669.Cj0KCQjwxveXBhDDARIsAI0Q0x0nb1KkNDwqyJwrtyHXA6YmymrRPVoORvhWzKKqLCPD0O1yEXwu7WoaAtM1EALw_wcB&amp;project=distribution-engine" rel="noopener ugc nofollow" target="_blank">启用了 BigQuery 连接 API</a>&amp;连接资源在与云 SQL 实例相同的项目中创建)</p><ol class=""><li id="c976" class="me mf in jm b jn jo jr js jv mg jz mh kd mi kh mj mk ml mm bi translated">点击谷歌云控制台中的 BigQuery:</li></ol><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mn"><img src="../Images/70b87b5a5ddb45d83680dfce53e9c250.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9f78OabHuXdla34H9jFCIQ.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">作者截图—访问 BigQuery 页面</figcaption></figure><p id="b9e6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">2.接下来，单击+添加数据并选择一个外部数据源:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mo"><img src="../Images/69d65a4e6698384e21bdfb80d2c45142.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7xX2aNam_4VFLa_Up6KcJg.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">作者截图-添加数据</figcaption></figure><p id="7cba" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">3.用要求的信息填写打开的对话框:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mp"><img src="../Images/dd64cef8733b339439603cef52bbdb9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SjJ2zmcDJu9-V6d0abxWEA.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">作者截图—创建连接 ID</figcaption></figure><p id="4c34" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">4.创建后，您的连接 ID 可以在您的外部连接下找到；只需扩展您的外部连接，然后单击提供给您的选项:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mq"><img src="../Images/11af6d2424c52083b9641eb5bbdcba08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1-9Stgrdy2FRbCL_15w3ww.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">作者截图—可重用的连接 ID</figcaption></figure></div><div class="ab cl kz la hr lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="ig ih ii ij ik"><h2 id="2ae0" class="lg lh in bd li lj lk dn ll lm ln dp lo jv lp lq lr jz ls lt lu kd lv lw lx ly bi translated">B.利用存储在云 SQL 中的数据</h2><p id="26e1" class="pw-post-body-paragraph jk jl in jm b jn lz jp jq jr ma jt ju jv mb jx jy jz mc kb kc kd md kf kg kh ig bi translated">一旦建立了连接，就可以根据需要多次重用它。请遵循以下逻辑来访问云 SQL 中的数据:</p><pre class="kj kk kl km gt mr ms mt mu aw mv bi"><span id="c958" class="lg lh in ms b gy mw mx l my mz">EXTERNAL_QUERY(</span><span id="8a3b" class="lg lh in ms b gy na mx l my mz">"connection ID",</span><span id="3ea9" class="lg lh in ms b gy na mx l my mz">"""</span><span id="5f4e" class="lg lh in ms b gy na mx l my mz">your query that is extracting data from the tables stored in Cloud SQL</span><span id="fc6c" class="lg lh in ms b gy na mx l my mz">"""</span><span id="b447" class="lg lh in ms b gy na mx l my mz">)</span></pre><ol class=""><li id="dbec" class="me mf in jm b jn jo jr js jv mg jz mh kd mi kh mj mk ml mm bi translated">加入存储在云 SQL 中的表:</li></ol><p id="af73" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在第一个例子中，我使用左连接来访问存储在 PostgreSQL 中的数据。我使用外部查询函数，该函数由连接 ID 组成，连接 ID 由实际查询中的 coma 分隔。</p><pre class="kj kk kl km gt mr ms mt mu aw mv bi"><span id="9db6" class="lg lh in ms b gy mw mx l my mz">SELECT</span><span id="1e84" class="lg lh in ms b gy na mx l my mz">   interval_date,</span><span id="697d" class="lg lh in ms b gy na mx l my mz">   round(earnings*cad,2) as revenue_cad</span><span id="5735" class="lg lh in ms b gy na mx l my mz">FROM `distribution.facebook`   as pmd</span><span id="077b" class="lg lh in ms b gy na mx l my mz">   LEFT JOIN  EXTERNAL_QUERY(</span><span id="5c58" class="lg lh in ms b gy na mx l my mz">             "connectionID",</span><span id="9c07" class="lg lh in ms b gy na mx l my mz">             """</span><span id="9c1a" class="lg lh in ms b gy na mx l my mz">             SELECT</span><span id="8fc2" class="lg lh in ms b gy na mx l my mz">                   date,</span><span id="3a12" class="lg lh in ms b gy na mx l my mz">                   cad</span><span id="cc1c" class="lg lh in ms b gy na mx l my mz">             FROM exchange_rates</span><span id="b882" class="lg lh in ms b gy na mx l my mz">                  order by date DESC</span><span id="5771" class="lg lh in ms b gy na mx l my mz">             """</span><span id="07b2" class="lg lh in ms b gy na mx l my mz">                 ) AS exchange on pmd.interval_date  = exchange.date</span><span id="3ff9" class="lg lh in ms b gy na mx l my mz">    ORDER BY interval_date DESC;</span></pre><p id="ec43" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">2.在 WHERE 子句中使用 EXTERNAL_QUERY()作为子查询的一部分:</p><p id="898f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">尽管 where 子句中的 EXTERNAL_QUERY()的结构是相同的，但我花了几分钟才弄明白如何使用它。因此，我想与你分享我的例子:</p><pre class="kj kk kl km gt mr ms mt mu aw mv bi"><span id="9680" class="lg lh in ms b gy mw mx l my mz">SELECT <br/>    interval_est, <br/>    date_est ,<br/>    sessions,<br/>FROM `distribution.facebook_hourly` <br/>    where content_id in (SELECT <br/>                             content_id <br/>                         FROM EXTERNAL_QUERY(<br/>                              "connectionID",<br/>                              """SELECT <br/>                                     distinct content_id<br/>                                 FROM fb_categories"""))</span></pre></div><div class="ab cl kz la hr lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="ig ih ii ij ik"><h2 id="08f8" class="lg lh in bd li lj lk dn ll lm ln dp lo jv lp lq lr jz ls lt lu kd lv lw lx ly bi translated">C.缺点</h2><ol class=""><li id="87dc" class="me mf in jm b jn lz jr ma jv nb jz nc kd nd kh mj mk ml mm bi translated">最大的缺点是性能——它不会像查询存储在 BigQuery 中的数据那样快。</li><li id="c53e" class="me mf in jm b jn ne jr nf jv ng jz nh kd ni kh mj mk ml mm bi translated">此外，您无法从云 SQL 访问存储在 BigQuery 中的数据。</li></ol></div><div class="ab cl kz la hr lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="ig ih ii ij ik"><h2 id="c8cf" class="lg lh in bd li lj lk dn ll lm ln dp lo jv lp lq lr jz ls lt lu kd lv lw lx ly bi translated">D.资源</h2><ol class=""><li id="5e8b" class="me mf in jm b jn lz jr ma jv nb jz nc kd nd kh mj mk ml mm bi translated">关于如何从 BigQuery 访问云 SQL 的官方文档</li></ol></div></div>    
</body>
</html>