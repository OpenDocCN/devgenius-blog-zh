<html>
<head>
<title>When Less is More: Serverless NAT Gateway — Part 1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">当少即是多:无服务器 NAT 网关—第 1 部分</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/when-less-is-more-serverless-nat-gateway-part-1-b2c2cd2555f6?source=collection_archive---------11-----------------------#2022-01-20">https://blog.devgenius.io/when-less-is-more-serverless-nat-gateway-part-1-b2c2cd2555f6?source=collection_archive---------11-----------------------#2022-01-20</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><figure class="im in gp gr io ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi il"><img src="../Images/2e3e6dbb5e186d0e25335409dcd9e242.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*noLHD1KHw5WmVw7-Qdk2Gg.png"/></div></div></figure><div class=""/><p id="12ac" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">无服务器架构为开发人员提供了各种优势，这些优势在大型可伸缩应用程序的开发中证明是有吸引力的。让我们回顾一下 3 大优势:</p><ol class=""><li id="76d6" class="kt ku iy jx b jy jz kc kd kg kv kk kw ko kx ks ky kz la lb bi translated">它提供了编写代码和部署到云的能力，而不用担心基础设施。</li><li id="6238" class="kt ku iy jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">它增强了为你所使用的东西付费或<strong class="jx iz">只执行计费的经济意义。</strong></li><li id="796c" class="kt ku iy jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">能够<strong class="jx iz">用您选择的语言/框架编写应用程序</strong>，快速完成生产就绪设置。</li></ol><p id="a026" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">第三方服务的集成是开发生命周期中不可避免的一部分。如果您使用的是具有安全意识的第三方服务，那么一个常见的需求就是将一个 IP 列入白名单，以利用这些服务。</p><p id="ab22" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在这个由两部分组成的教程系列中，我们将通过一些额外的 AWS 资源来完成 AWS lambda 函数的创建<strong class="jx iz">,这些资源将允许您<strong class="jx iz">为第三方服务提供用于白名单通信的静态 IP </strong>。</strong></p><p id="dc9f" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">让我们从本教程的第 1 部分开始，您将:</p><ul class=""><li id="3d50" class="kt ku iy jx b jy jz kc kd kg kv kk kw ko kx ks lh kz la lb bi translated">使用 webpack 的无服务器框架创建一个无服务器应用程序和所有必需的 AWS 资源。</li><li id="86c7" class="kt ku iy jx b jy lc kc ld kg le kk lf ko lg ks lh kz la lb bi translated">为静态 IP 集成 NAT 网关和弹性 IP。</li></ul><p id="f9c5" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在本系列的下一部分(即第 2 部分)中，您将，</p><ul class=""><li id="8c32" class="kt ku iy jx b jy jz kc kd kg kv kk kw ko kx ks lh kz la lb bi translated">使用 GitHub Actions 作为 CD 管道来验证和部署到 AWS。</li></ul><h1 id="0ca9" class="li lj iy bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">建筑</h1><p id="b6fc" class="pw-post-body-paragraph jv jw iy jx b jy mg ka kb kc mh ke kf kg mi ki kj kk mj km kn ko mk kq kr ks ig bi translated">本教程假设您对以下 AWS 服务有专家级的理解:</p><ul class=""><li id="dfa9" class="kt ku iy jx b jy jz kc kd kg kv kk kw ko kx ks lh kz la lb bi translated"><a class="ae ml" href="https://docs.aws.amazon.com/vpc/latest/userguide/vpc-nat-gateway.html" rel="noopener ugc nofollow" target="_blank"> NAT 网关</a></li><li id="53dc" class="kt ku iy jx b jy lc kc ld kg le kk lf ko lg ks lh kz la lb bi translated"><a class="ae ml" href="https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Subnets.html" rel="noopener ugc nofollow" target="_blank"> VPC </a></li><li id="4309" class="kt ku iy jx b jy lc kc ld kg le kk lf ko lg ks lh kz la lb bi translated"><a class="ae ml" href="https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Scenario2.html" rel="noopener ugc nofollow" target="_blank">公共/私有子网</a></li><li id="51ce" class="kt ku iy jx b jy lc kc ld kg le kk lf ko lg ks lh kz la lb bi translated"><a class="ae ml" href="https://docs.aws.amazon.com/vpc/latest/userguide/egress-only-internet-gateway.html" rel="noopener ugc nofollow" target="_blank">互联网网关</a></li><li id="24d7" class="kt ku iy jx b jy lc kc ld kg le kk lf ko lg ks lh kz la lb bi translated"><a class="ae ml" href="https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Route_Tables.html" rel="noopener ugc nofollow" target="_blank">路由表</a></li><li id="551a" class="kt ku iy jx b jy lc kc ld kg le kk lf ko lg ks lh kz la lb bi translated"><a class="ae ml" href="https://docs.aws.amazon.com/lambda/latest/dg/getting-started-create-function.html" rel="noopener ugc nofollow" target="_blank">λ</a></li></ul><p id="3cd5" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们还将使用无服务器框架来本地创建、设置、测试和部署应用程序。无服务器框架是开始使用无服务器架构和系统的绝佳工具。</p><p id="48c0" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">请访问链接<a class="ae ml" href="https://www.serverless.com/framework/docs" rel="noopener ugc nofollow" target="_blank">https://www.serverless.com/framework/docs</a>了解更多。</p><p id="38bd" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们的设置如下所示:</p><figure class="mn mo mp mq gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi mm"><img src="../Images/7cfd2bc3bb39af335781c08ba17d39ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ZsAOA9On2vRVSD4F.png"/></div></div></figure><p id="5f68" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在本教程中，我们将帮助您完成一个 Lambda 函数的部署，该函数具有与弹性 IP 相关联的正确连接。</p><h1 id="142c" class="li lj iy bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">让我们开始建造吧</h1><h1 id="dc1c" class="li lj iy bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">启动项目</h1><p id="db16" class="pw-post-body-paragraph jv jw iy jx b jy mg ka kb kc mh ke kf kg mi ki kj kk mj km kn ko mk kq kr ks ig bi translated">简单介绍一下我们的产品。设置中最重要的部分是<strong class="jx iz"> serverless.yml </strong>文件。在里面你会发现:</p><p id="93ea" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">1.服务名:目前，它从 env 文件中读取。请随意使用您选择的一个。</p><p id="62a6" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">2.插件:</p><ul class=""><li id="0905" class="kt ku iy jx b jy jz kc kd kg kv kk kw ko kx ks lh kz la lb bi translated"><a class="ae ml" href="https://www.npmjs.com/package/serverless-webpack" rel="noopener ugc nofollow" target="_blank"><em class="mr">-web pack</em></a>插件，用于捆绑功能、依赖项等。点击这里查看<a class="ae ml" href="https://github.com/wednesday-solutions/sls-nat-gateway-eip-starter/blob/sls-starter/webpack.config.js" rel="noopener ugc nofollow" target="_blank"> webpack </a>配置。</li><li id="5ff4" class="kt ku iy jx b jy lc kc ld kg le kk lf ko lg ks lh kz la lb bi translated"><a class="ae ml" href="https://www.npmjs.com/package/serverless-offline" rel="noopener ugc nofollow" target="_blank">用于本地测试的无服务器离线</a>插件。</li></ul><p id="6e9e" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们将把这部分教程分成两个部分</p><ul class=""><li id="f9b7" class="kt ku iy jx b jy jz kc kd kg kv kk kw ko kx ks lh kz la lb bi translated">创建 AWS 资源</li><li id="1d94" class="kt ku iy jx b jy lc kc ld kg le kk lf ko lg ks lh kz la lb bi translated">λ函数的加法</li></ul><h1 id="52bf" class="li lj iy bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">创建 AWS 资源</h1><h1 id="529f" class="li lj iy bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">步骤 1-更新无服务器文件</h1><p id="01f0" class="pw-post-body-paragraph jv jw iy jx b jy mg ka kb kc mh ke kf kg mi ki kj kk mj km kn ko mk kq kr ks ig bi translated">在 serverless.yml 文件的最后几行下面添加以下几行:</p><pre class="mn mo mp mq gt ms mt mu mv aw mw bi"><span id="45f9" class="mx lj iy mt b gy my mz l na nb">...<br/>functions: ${file(./resources/functions.yml)}<br/>resources:<br/>  - ${file(./resources/iam.yml)}<br/>  - ${file(./resources/vpc.yml)}<br/>  - ${file(./resources/security-groups.yml)}<br/>  - ${file(./resources/internet-gateway.yml)}<br/>  - ${file(./resources/elastic-ip.yml)}<br/>  - ${file(./resources/nat-gateway.yml)}<br/>  - ${file(./resources/route-private.yml)}<br/>  - ${file(./resources/route-public.yml)}</span></pre><p id="d565" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi">‍</p><p id="6937" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在这里，我们指出了设置这一切所需的功能(lambdas)和资源(AWS 基础设施)。我们将在此过程中添加这些文件。很刺激吗？</p><pre class="mn mo mp mq gt ms mt mu mv aw mw bi"><span id="7a2d" class="mx lj iy mt b gy my mz l na nb">YAML syntax maybe problematic for some people.<br/>Please take the <strong class="mt iz">help</strong> <strong class="mt iz">of</strong> lint <strong class="mt iz">plugin</strong> <strong class="mt iz">or</strong> a service <br/><strong class="mt iz">like</strong> <a class="ae ml" href="http://www.yamllint.com/" rel="noopener ugc nofollow" target="_blank"><strong class="mt iz">http</strong>://www.yamllint.com/</a></span></pre><p id="3e46" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi">‍</p><h1 id="0b66" class="li lj iy bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">步骤 2-添加 VPC</h1><pre class="mn mo mp mq gt ms mt mu mv aw mw bi"><span id="fcc3" class="mx lj iy mt b gy my mz l na nb"><strong class="mt iz">vi</strong> touch resources/vpc.yml</span></pre><p id="b462" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">让我们添加资源。首先，在 resources 文件夹中创建一个<strong class="jx iz"> vpc.yml </strong>文件。这是您将创建 AWS vpc 资源的地方。将以下代码复制并粘贴到<strong class="jx iz"> vpc.yml </strong>中。不要忘记检查缩进，并根据需要更改名称和标签。</p><p id="af8a" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">资源:</p><pre class="mn mo mp mq gt ms mt mu mv aw mw bi"><span id="87f0" class="mx lj iy mt b gy my mz l na nb"><strong class="mt iz">Resources</strong>:<br/>  <strong class="mt iz">ServerlessVPC</strong>:<br/>    <strong class="mt iz">Type</strong>: <strong class="mt iz">AWS</strong>::<strong class="mt iz">EC2</strong>::VPC<br/>    <strong class="mt iz">Properties</strong>:<br/>      <strong class="mt iz">CidrBlock</strong>: "10.0.0.0/16"<br/>      <strong class="mt iz">Tags</strong>:<br/>        - <strong class="mt iz">Key</strong>: 'Name'<br/>          <strong class="mt iz">Value</strong>: 'ServerlessVPC'</span></pre><p id="0c5a" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">‍:很基本的东西，对吧？我们有一个资源类型和一个 CIDR 块(一个 IP 地址范围)。</p><p id="7504" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们稍后将需要回到这个文件。我们继续吧。</p><h1 id="6a05" class="li lj iy bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">步骤 3 —添加弹性 IP 和互联网网关</h1><p id="fb8d" class="pw-post-body-paragraph jv jw iy jx b jy mg ka kb kc mh ke kf kg mi ki kj kk mj km kn ko mk kq kr ks ig bi translated">我们将在 resources 文件夹中创建两个名为<strong class="jx iz"> internet-gateway.yml </strong>和<strong class="jx iz"> elastic-ip.yml </strong>的文件。将以下资源添加到<strong class="jx iz"> elastic-ip.yml </strong>中提到的文件中</p><pre class="mn mo mp mq gt ms mt mu mv aw mw bi"><span id="230e" class="mx lj iy mt b gy my mz l na nb"><strong class="mt iz">vi</strong> touch resources/elastic-ip.yml</span><span id="4ddb" class="mx lj iy mt b gy nc mz l na nb">## Elastic IP<br/>Resources:<br/>  ElasticIpLambda:<br/>    Type: AWS::EC2::EIP<br/>    Properties:<br/>      Domain: vpc</span></pre><p id="6eb8" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi">‍</p><p id="1b6f" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在让我们创建<strong class="jx iz"> internet-gateway.yml </strong>文件。</p><pre class="mn mo mp mq gt ms mt mu mv aw mw bi"><span id="34ed" class="mx lj iy mt b gy my mz l na nb"><strong class="mt iz">vi</strong> touch resources/internet-gateway.yml</span><span id="1533" class="mx lj iy mt b gy nc mz l na nb">## Internet GW<br/>Resources:<br/>  SlsTutorialIGW:<br/>    Type: AWS::EC2::InternetGateway<br/>    Properties:<br/>      Tags:<br/>        - Key: Name<br/>          Value: SlsTutorialIGW</span></pre><p id="b18e" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">‍:我们又创造了两种资源。允许我们从 AWS VPC 连接到外部互联网的互联网网关和弹性 IP 是将作为我们的服务 IP 地址提供给第三方的公共静态 IP。域是一个字段，指示弹性 IP 地址是否用于 VPC 中的实例(确实如此！).</p><p id="c35c" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">此时，您的文件夹结构将如下所示:</p><figure class="mn mo mp mq gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi nd"><img src="../Images/4ecdf51dddca1b97134a49b427473cc4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*s_jHP0q1b2rAh-BH.png"/></div></div></figure><h1 id="6d32" class="li lj iy bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">步骤 4 —添加 NAT 网关资源和子网</h1><pre class="mn mo mp mq gt ms mt mu mv aw mw bi"><span id="f1b4" class="mx lj iy mt b gy my mz l na nb"><strong class="mt iz">vi</strong> touch resources/nat-gateway.yml</span></pre><p id="40bc" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在参考资料中创建一个<strong class="jx iz"> nat-gateway.yml </strong>文件。添加以下资源。</p><pre class="mn mo mp mq gt ms mt mu mv aw mw bi"><span id="d5c2" class="mx lj iy mt b gy my mz l na nb">#nat-gateway.yml<br/>Resources:<br/>  ServerlessNatGateway:<br/>    Type: AWS::EC2::NatGateway<br/>    Properties: <br/>      AllocationId:<br/>        Fn::GetAtt:<br/>         - ElasticIpLambda<br/>         - AllocationId<br/>      SubnetId:<br/>        Ref: ServerlessPublicSubnet1<br/>  ServerlessPublicSubnet1: <br/>    DependsOn: <br/>      - ServerlessVPC<br/>    Type: AWS::EC2::Subnet<br/>    Properties:<br/>      VpcId:<br/>        Ref: ServerlessVPC<br/>      CidrBlock: '10.0.2.0/24'<br/>      AvailabilityZone: ${self:provider.region}a<br/>      Tags:<br/>        - Key: Name<br/>          Value: ServerlessPublicSubnet1<br/>  ServerlessPrivateSubnet1:<br/>    DependsOn: <br/>      - ServerlessVPC<br/>    Type: AWS::EC2::Subnet<br/>    Properties:<br/>      VpcId:<br/>        Ref: ServerlessVPC<br/>      CidrBlock: '10.0.1.0/24'<br/>      AvailabilityZone: ${self:provider.region}a<br/>      Tags:<br/>        - Key: Name<br/>          Value: ServerlessPrivateSubnet1</span></pre><p id="fb84" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">nat 网关是这场秀的主角。NAT 是一种服务，允许 vpc 内部的实例连接到外部资源或系统，但禁止外部连接到内部 vpc 系统。AllocationId 是一个函数，它获取我们创建的弹性 IP 资源的 AllocationId。Nat 有一个与之相连的公共子网。看建筑的图。</p><p id="7413" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">其他资源是子网。一个连接到 vpc 中的资源的私有接口。一个将重新路由并连接到互联网网关的公共网关。点击阅读更多关于子网<a class="ae ml" href="https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Subnets.html#subnet-basics" rel="noopener ugc nofollow" target="_blank">的信息。</a></p><h1 id="824c" class="li lj iy bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">步骤 5 —路由表</h1><p id="6c52" class="pw-post-body-paragraph jv jw iy jx b jy mg ka kb kc mh ke kf kg mi ki kj kk mj km kn ko mk kq kr ks ig bi translated">作为此设置的一部分，我们将有两个路由表。一个用于<strong class="jx iz">私有子网</strong>，另一个用于<strong class="jx iz">公共子网</strong>。创建两个文件<strong class="jx iz"> route-private.yml </strong>和<strong class="jx iz"> route-public.yml </strong>并正确添加以下资源。让我们在路线上工作-首先是私人的</p><pre class="mn mo mp mq gt ms mt mu mv aw mw bi"><span id="2b2f" class="mx lj iy mt b gy my mz l na nb">vi touch resources/route-<strong class="mt iz">private</strong>.yml</span><span id="b14a" class="mx lj iy mt b gy nc mz l na nb">#route-private.yml<br/>Resources:<br/>  DefaultPrivateRouteTable:<br/>    Type: AWS::EC2::RouteTable<br/>    Properties:<br/>      VpcId:<br/>        Ref: ServerlessVPC<br/>      Tags:<br/>        - Key: Name<br/>          Value: DefaultPrivateRouteTable<br/>  DefaultPrivateRoute:<br/>    Type: AWS::EC2::Route<br/>    Properties:<br/>      RouteTableId:<br/>        Ref: DefaultPrivateRouteTable<br/>      DestinationCidrBlock: 0.0.0.0/0<br/>      NatGatewayId:<br/>        Ref: ServerlessNatGateway<br/>  SubnetRouteTableLambdaAssociation:<br/>    Type: AWS::EC2::SubnetRouteTableAssociation<br/>    Properties:<br/>      RouteTableId:<br/>        Ref: DefaultPrivateRouteTable<br/>      SubnetId:<br/>        Ref: ServerlessPrivateSubnet1</span></pre><p id="ad4c" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在路由公共文件和资源</p><pre class="mn mo mp mq gt ms mt mu mv aw mw bi"><span id="ca72" class="mx lj iy mt b gy my mz l na nb">vi touch resources/route-<strong class="mt iz">public</strong>.yml</span><span id="4ef5" class="mx lj iy mt b gy nc mz l na nb">#route-public.yml<br/>Resources:<br/>  DefaultPublicRouteTable:<br/>    Type: AWS::EC2::RouteTable<br/>    Properties:<br/>      VpcId:<br/>        Ref: ServerlessVPC<br/>      Tags:<br/>        - Key: Name<br/>          Value: DefaultPublicRouteTable<br/>  DefaultPublicRoute:<br/>    Type: AWS::EC2::Route<br/>    Properties:<br/>      RouteTableId:<br/>        Ref: DefaultPublicRouteTable<br/>      DestinationCidrBlock: 0.0.0.0/0<br/>      GatewayId: <br/>        Ref: SlsTutorialIGW<br/>  IGWRouteTableLambdaAssociation:<br/>    Type: AWS::EC2::SubnetRouteTableAssociation<br/>    Properties:<br/>      RouteTableId:<br/>        Ref: DefaultPublicRouteTable<br/>      SubnetId:<br/>        Ref: ServerlessPublicSubnet1</span></pre><p id="0c84" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi">‍</p><p id="4029" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">路由表是一组规则，用于确定网络流量的流向。它可以与子网相关联。它有一个目的地和目标网关。对于专用路由表，我们添加了一个路由表规则，通过 NAT 网关路由所有流量。我们还在路由表和我们的私有子网之间创建了一个关联。</p><figure class="mn mo mp mq gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi nd"><img src="../Images/918d10d391bb9407cf539075932e2697.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*s6DNm1TszqFgVDVy.png"/></div></div></figure><p id="1cd7" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这是创建后的布线表。别担心，我们会到达那里的。</p><p id="dcb4" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">公共路由表也遵循同样的模式。唯一的区别是它与我们在步骤 2 中创建的 IG 相关联。</p><h1 id="aeac" class="li lj iy bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">步骤 6 — VPC 网关连接</h1><p id="8303" class="pw-post-body-paragraph jv jw iy jx b jy mg ka kb kc mh ke kf kg mi ki kj kk mj km kn ko mk kq kr ks ig bi translated">现在让我们回到 vpc 资源上来。是时候了。返回到<strong class="jx iz"> vpc.yml </strong>文件，添加以下几行</p><pre class="mn mo mp mq gt ms mt mu mv aw mw bi"><span id="ecd6" class="mx lj iy mt b gy my mz l na nb"><strong class="mt iz">vi</strong> resources/vpc.yml</span><span id="3ac5" class="mx lj iy mt b gy nc mz l na nb">#vpc.yml<br/>.<br/>.<br/>.<br/>ServerlessVPCGA:<br/>    Type: AWS::EC2::VPCGatewayAttachment<br/>    Properties:<br/>      VpcId:<br/>        Ref: ServerlessVPC<br/>      InternetGatewayId:<br/>        Ref: SlsTutorialIGW</span></pre><p id="dae6" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi">‍</p><p id="00ed" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这将因特网网关连接到 vpc，使得能够通过 vpc 与因特网通信。</p><p id="41d1" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">记住这是 vpc 文件中的一个新资源。我知道有些人不喜欢代码图片，但我想尝试碳。所以<strong class="jx iz"> vpc.yml </strong>看起来会像这样:</p><figure class="mn mo mp mq gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi ne"><img src="../Images/7cfda0dbbe2d1263fb6a97eaab320e95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*zmfllMQK1SEUkUd4.png"/></div></div></figure><h1 id="4631" class="li lj iy bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">步骤 7-添加 IAM 资源</h1><p id="cc22" class="pw-post-body-paragraph jv jw iy jx b jy mg ka kb kc mh ke kf kg mi ki kj kk mj km kn ko mk kq kr ks ig bi">‍</p><pre class="mn mo mp mq gt ms mt mu mv aw mw bi"><span id="c828" class="mx lj iy mt b gy my mz l na nb"><strong class="mt iz">vi</strong> touch resources/iam.yml</span><span id="6f75" class="mx lj iy mt b gy nc mz l na nb">Resources:<br/>  TestRoleForSLSNATGateway:<br/>    Type: AWS::IAM::Role<br/>    Properties:<br/>      Description: This is an example role for SLS NAT Gateway<br/>      RoleName: ${self:service.name}-nat-gateway-role<br/>      AssumeRolePolicyDocument:<br/>        Version: '2012-10-17'<br/>        Statement:<br/>          - Effect: Allow<br/>            Principal:<br/>              Service:<br/>                - lambda.amazonaws.com<br/>            Action:<br/>              - sts:AssumeRole<br/>      ManagedPolicyArns:<br/>          - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole</span></pre><p id="cb6a" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi">‍</p><p id="b3d3" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们正在添加一个 IAM 角色，它将允许我们访问 CloudWatch 中的 lambda 和相关的 lambda 日志。现在我们有了所有的资源。所有的文件结构应该是这样的。</p><figure class="mn mo mp mq gt ip gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/85387831b67086d82d99242187e11230.png" data-original-src="https://miro.medium.com/v2/resize:fit:712/format:webp/0*aW0tMJWo2xK8bcI3.png"/></div></figure><p id="b857" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi">‍</p><h1 id="f423" class="li lj iy bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">步骤 8:添加安全组</h1><p id="623e" class="pw-post-body-paragraph jv jw iy jx b jy mg ka kb kc mh ke kf kg mi ki kj kk mj km kn ko mk kq kr ks ig bi translated">我们将为我们的体系结构设置添加一个安全组。</p><pre class="mn mo mp mq gt ms mt mu mv aw mw bi"><span id="d791" class="mx lj iy mt b gy my mz l na nb"><strong class="mt iz">vi</strong> touch resources/security-groups.yml</span><span id="fe7d" class="mx lj iy mt b gy nc mz l na nb">#security-groups.yml<br/>Resources:<br/>  ServerlessSecurityGroup:<br/>    DependsOn:<br/>      - ServerlessVPC<br/>    Type: AWS::EC2::SecurityGroup<br/>    Properties:<br/>      GroupDescription: SecurityGroup for Serverless Functions<br/>      VpcId:<br/>        Ref: ServerlessVPC<br/>      Tags:<br/>        - Key: 'Name'<br/>          Value: 'sls-tutorial-sg'</span></pre><p id="ec44" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi">‍</p><p id="4f6e" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们添加一个安全组，并将其添加到我们使用模板中的 VpcId 密钥创建的 VPC 中。这对控制进出子网的流量非常重要。默认情况下，它有一组与流经该组的流量相关联的规则。</p><h1 id="6ddd" class="li lj iy bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">添加功能</h1><h1 id="dad3" class="li lj iy bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">步骤 1:添加函数资源</h1><p id="0874" class="pw-post-body-paragraph jv jw iy jx b jy mg ka kb kc mh ke kf kg mi ki kj kk mj km kn ko mk kq kr ks ig bi translated">我们将在这一步添加一个函数或一个 lambda。在 resources 文件夹中创建一个名为<strong class="jx iz"> functions.yml </strong>的文件，并向其中添加以下代码。这只是指向一个我们会添加的功能，没什么花哨的。</p><pre class="mn mo mp mq gt ms mt mu mv aw mw bi"><span id="bfc3" class="mx lj iy mt b gy my mz l na nb"><strong class="mt iz">vi</strong> touch resources/functions.yml</span><span id="1a43" class="mx lj iy mt b gy nc mz l na nb">#functions.yml<br/>slsNatTutorialFunction:<br/>  handler: functions/tutorial-function/index.handler<br/>  role: TestRoleForSLSNATGateway<br/>  events:<br/>    - http<br/>        method: GET<br/>        path: /say-hello<br/>        cors: true</span></pre><p id="4d77" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi">‍</p><p id="c81b" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们有函数名和它指向的处理程序。</p><h1 id="1f80" class="li lj iy bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">添加功能</h1><p id="eb47" class="pw-post-body-paragraph jv jw iy jx b jy mg ka kb kc mh ke kf kg mi ki kj kk mj km kn ko mk kq kr ks ig bi translated">在 functions 文件夹中，创建一个名为 tutorial-function 的文件夹和一个<strong class="jx iz"> index.js </strong>。将以下函数添加到处理程序中</p><pre class="mn mo mp mq gt ms mt mu mv aw mw bi"><span id="361a" class="mx lj iy mt b gy my mz l na nb">mkdir -p functions/tutorial-function<br/>vi touch functions/tutorial-function/index.js</span><span id="a26d" class="mx lj iy mt b gy nc mz l na nb"><strong class="mt iz">import</strong> { apiSuccess, apiFailure } <strong class="mt iz">from</strong> '@utils';<br/><strong class="mt iz">import</strong> axios <strong class="mt iz">from</strong> 'axios';</span><span id="f6b4" class="mx lj iy mt b gy nc mz l na nb">exports.handler = <strong class="mt iz">async</strong> (event, context, callback) =&gt; {<br/>	console.log(JSON.stringify(event));<br/>	<strong class="mt iz">try</strong> {<br/>		<strong class="mt iz">const</strong> response = <strong class="mt iz">await</strong> axios.get('https://httpbin.org/ip');<br/>		<strong class="mt iz">const</strong> data = response.data;<br/>		console.log(data);<br/>		<strong class="mt iz">return</strong> apiSuccess(callback, data);<br/>	} <strong class="mt iz">catch</strong> (error) {<br/>		<strong class="mt iz">return</strong> apiFailure(callback, error);<br/>	}<br/>};</span></pre><p id="9d44" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这个函数是非常基本的，其思想是只点击一个外部服务，该服务返回发出请求的服务器的 IP 地址。这将有助于我们看到我们已经为 lambda 分配了一个 NAT 网关弹性 IP。</p><h1 id="d7b3" class="li lj iy bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">步骤 3 —将资源附加到函数</h1><p id="cc4e" class="pw-post-body-paragraph jv jw iy jx b jy mg ka kb kc mh ke kf kg mi ki kj kk mj km kn ko mk kq kr ks ig bi translated">这是一切汇集的地方。我们已经创建了许多资源，我们需要把它们拼凑在一起，这样我们创建的 lambda 就可以附加这些资源。我们在<strong class="jx iz"> serverless.yml </strong>文件中这样做。</p><pre class="mn mo mp mq gt ms mt mu mv aw mw bi"><span id="60e1" class="mx lj iy mt b gy my mz l na nb"><strong class="mt iz">vi</strong> <strong class="mt iz">serverless</strong>.yml</span><span id="67df" class="mx lj iy mt b gy nc mz l na nb">.<br/>.<br/>.<br/>versionFunctions: false<br/>vpc:<br/>    securityGroupIds:<br/>      - Fn::GetAtt:<br/>          - ServerlessSecurityGroup<br/>          - GroupId<br/>    subnetIds:<br/>      - Ref: ServerlessPrivateSubnet1</span></pre><p id="6a72" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们应该将从<em class="mr"> vpc </em>开始的行添加到文件中。确保你得到正确的缩进。我们将我们的 Lambda 函数与 vpc、安全组和私有子网联系起来。请记住，Lambda 位于专用子网中。</p><h1 id="1046" class="li lj iy bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">步骤 4 —在本地测试</h1><p id="5709" class="pw-post-body-paragraph jv jw iy jx b jy mg ka kb kc mh ke kf kg mi ki kj kk mj km kn ko mk kq kr ks ig bi translated">现在作为这个设置的一部分，我们有一个非常有趣的方法来本地测试我们的函数。我们已经添加了一个名为<a class="ae ml" href="https://www.npmjs.com/package/serverless-offline" rel="noopener ugc nofollow" target="_blank"> <strong class="jx iz">的无服务器离线</strong> </a>插件，以便在本地轻松启动。</p><p id="3d61" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">要开始，请转到您的安装程序的工作目录，并运行以下命令。</p><pre class="mn mo mp mq gt ms mt mu mv aw mw bi"><span id="0ebd" class="mx lj iy mt b gy my mz l na nb">yarn <strong class="mt iz">start</strong>-<strong class="mt iz">offline</strong></span></pre><p id="efac" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这应该会启动一个使用 webpack 的服务器，公开以下 API。</p><figure class="mn mo mp mq gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi nd"><img src="../Images/58606b806b2007edb6e000e341cd7ca7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*sLlG5GDkwfVmw3A8.png"/></div></div></figure><p id="6b61" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">您可以看到服务器公开的 GET 方法。要验证 API，您现在只需进入像 postman 这样的 API 测试资源，并尝试访问这个端点。</p><pre class="mn mo mp mq gt ms mt mu mv aw mw bi"><span id="153a" class="mx lj iy mt b gy my mz l na nb">#here is a cURL for you to copy paste.<br/><strong class="mt iz">curl</strong> --location --request GET <br/>'http://localhost:3000/local/say-hello'</span></pre><p id="0600" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi">‍</p><p id="c0fd" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">结果应该是这样的。</p><figure class="mn mo mp mq gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi ng"><img src="../Images/6946f11122348b011826364c5c70b306.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*fkWKg7xUvEphPPWa.png"/></div></div></figure><p id="e2a0" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">不错吧？现在让我们把它部署到 AWS 上，这样整个<strong class="jx iz">世界</strong>都可以对你的 API 说<strong class="jx iz">你好</strong>。那很糟糕。我们继续前进。</p><h1 id="7c39" class="li lj iy bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">从这里去哪里？</h1><p id="8489" class="pw-post-body-paragraph jv jw iy jx b jy mg ka kb kc mh ke kf kg mi ki kj kk mj km kn ko mk kq kr ks ig bi translated">这有点长了，不是吗？如果您遇到任何问题或想要参考资源，请在此随意参考可用的完成设置<a class="ae ml" href="https://github.com/wednesday-solutions/sls-nat-gateway-eip" rel="noopener ugc nofollow" target="_blank"/></p><p id="4cb0" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在创建所有这些资源并将它们联系起来方面，我们确实取得了长足的进步。如果你从<em class="mr">一直走到</em>这里的终点，干得好！</p><p id="76ed" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">让我们总结一下，部署我们在本系列教程的第 2 部分中使用 GitHub Actions 创建的所有资源。会在那里见到你！</p><p id="ec6e" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">喜欢你看到的吗？觉得有帮助？传播消息。</p><p id="677a" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">有反馈/评论吗？在这里发推特给我们<a class="ae ml" href="https://twitter.com/wednesdaysol" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="7b39" class="pw-post-body-paragraph jv jw iy jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">最初出现在:<a class="ae ml" href="https://www.wednesday.is/writing-tutorials/when-less-is-more-serverless-nat-gateway-part-1" rel="noopener ugc nofollow" target="_blank">https://www . Wednesday . is/writing-tutorials/when-less-is-more-server less-NAT-gateway-part-1</a></p></div></div>    
</body>
</html>