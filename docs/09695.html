<html>
<head>
<title>Grouping By Calendar Week Using Entity Framework Core And PostgreSQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用实体框架核心和 PostgreSQL 按日历周分组</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/grouping-by-calendar-week-using-entity-framework-core-and-postgresql-49d24412e0e5?source=collection_archive---------17-----------------------#2022-09-05">https://blog.devgenius.io/grouping-by-calendar-week-using-entity-framework-core-and-postgresql-49d24412e0e5?source=collection_archive---------17-----------------------#2022-09-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/4398a1da75ee2db7fd04a59b242c76e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qVRpmKWqoRYRm1LpVdoShA.jpeg"/></div></div></figure><p id="8a2a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在本文中，我们将研究如何使用自定义数据库函数映射的实体框架特性，按日历周(或日期的其他部分，如按年或按月)对数据库行进行分组。</p><p id="53d1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">本文中展示的代码示例假设您正在 PostgreSQL 数据库之上使用实体框架核心，使用的是<a class="ae kw" href="https://www.nuget.org/packages/Npgsql.EntityFrameworkCore.PostgreSQL/" rel="noopener ugc nofollow" target="_blank"> Npgsql。PostgreSQL </a>包，但是一般的方法也适用于其他数据库。</p><p id="f2bf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们假设你正在实现你自己的博客平台，并想提供一个功能，让你看到每年有多少博客文章被写。下面的代码将允许您直接从数据库中获取这种聚合统计数据:</p><figure class="kx ky kz la gt jr"><div class="bz fp l di"><div class="lb lc l"/></div></figure><p id="53d5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">上面显示的代码是可行的，因为 Npgsql 附带了一个定制的数据库函数映射，它将把第<code class="fe ld le lf lg b">12</code>行的<code class="fe ld le lf lg b">GroupBy</code>子句转换成使用 PostgreSQL <code class="fe ld le lf lg b">date_part</code>函数，只从<code class="fe ld le lf lg b">PublishedOn</code>列中提取年份。你可以在这里看到做这个<a class="ae kw" href="https://github.com/npgsql/efcore.pg/blob/4f2da8baabc6c5d28e6a16d14878aa954972b9b0/src/EFCore.PG/Query/ExpressionTranslators/Internal/NpgsqlDateTimeMemberTranslator.cs#L107" rel="noopener ugc nofollow" target="_blank">的代码。</a></p><p id="472e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">不幸的是，如果你也想按日历周分组，那你就不走运了。一个原因是用于列的<code class="fe ld le lf lg b">DateTimeOffset</code>类型没有日历周的属性——您必须使用<a class="ae kw" href="https://docs.microsoft.com/en-us/dotnet/api/system.globalization.isoweek.getweekofyear?view=net-6.0#system-globalization-isoweek-getweekofyear(system-datetime)" rel="noopener ugc nofollow" target="_blank"> ISOWeek 类</a>来代替。第二个原因是 Npgsql 没有为此提供定制的数据库函数映射。因此，如果不添加一些自定义代码，您将需要从数据库中加载所有帖子，并在内存中进行分组——讨厌！</p><p id="aa88" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">幸运的是，添加自定义数据库函数映射很容易。</p><figure class="kx ky kz la gt jr"><div class="bz fp l di"><div class="lb lc l"/></div></figure><p id="36d5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">上面显示的代码向 DataContext 类添加了一个类型化的 C#方法，并将其映射到 PostgreSQL 数据库提供的<code class="fe ld le lf lg b">date_trunc</code>函数。第 16 行中 C#方法的实现并不重要——它从未真正执行过，因为实体框架会将它的任何用法转换成直接在数据库中执行的 date <code class="fe ld le lf lg b">date_trunc</code>函数。同样，代码也映射了<code class="fe ld le lf lg b">date_part</code>函数。</p><p id="b44a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一旦我们做到了这一点，我们就可以利用这些方法以一种类型安全的方式按日历周进行分组:</p><figure class="kx ky kz la gt jr"><div class="bz fp l di"><div class="lb lc l"/></div></figure><p id="835c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这段代码现在使用了我们上面定义的<code class="fe ld le lf lg b">DateTrunc</code>和<code class="fe ld le lf lg b">DatePart</code>方法:</p><ul class=""><li id="21b3" class="lh li iq ka b kb kc kf kg kj lj kn lk kr ll kv lm ln lo lp bi translated">映射到<code class="fe ld le lf lg b">date_trunc</code>函数的<code class="fe ld le lf lg b">DateTrunc</code>将返回每周星期一的日期，因此我们通过第 4 行的<code class="fe ld le lf lg b">GroupBy</code>调用得到的分组键将是代表这些星期一的<code class="fe ld le lf lg b">DateTimeOffset</code></li><li id="23ca" class="lh li iq ka b kb lq kf lr kj ls kn lt kr lu kv lm ln lo lp bi translated">第 5–11 行中的<code class="fe ld le lf lg b">Select</code>语句现在将从这些星期一中提取<code class="fe ld le lf lg b">Year</code>(利用 Npgsql 提供的函数映射)，并使用映射到<code class="fe ld le lf lg b">date_part</code>函数的<code class="fe ld le lf lg b">DatePart</code>方法提取日历周数。</li></ul><p id="a3a5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">瞧，您现在有了一种按日历周对数据库中的数据进行分组的类型安全的方法。</p></div><div class="ab cl lv lw hu lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="ij ik il im in"><p id="a685" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">觉得这篇文章有用？在 Medium 上关注我(<a class="ae kw" href="https://medium.com/@christian.johann.eder" rel="noopener"> Christian Eder </a>)并查看我下面关于 Azure、作为代码的基础设施和物联网的文章！不要忘记👏这篇文章分享一下吧！</p><ul class=""><li id="7f3e" class="lh li iq ka b kb kc kf kg kj lj kn lk kr ll kv lm ln lo lp bi translated"><a class="ae kw" href="https://medium.com/@christian.johann.eder/using-newtonsoft-json-in-asp-net-core-and-signalr-55b0fa4645aa" rel="noopener">使用 Newtonsoft。ASP.NET 的 JSON Core 和 SignalR </a></li><li id="a4e4" class="lh li iq ka b kb lq kf lr kj ls kn lt kr lu kv lm ln lo lp bi translated"><a class="ae kw" href="https://awstip.com/deploying-an-asp-net-core-api-to-aws-fargate-using-cdk-dab10bef51a1" rel="noopener ugc nofollow" target="_blank">使用 CDK 将 ASP.NET 核心 API 部署到 AWS Fargate</a></li><li id="d4fc" class="lh li iq ka b kb lq kf lr kj ls kn lt kr lu kv lm ln lo lp bi translated"><a class="ae kw" href="https://medium.com/@christian.johann.eder/consumer-driven-contract-testing-hosting-a-mocked-api-using-azure-functions-a42d634c47fd" rel="noopener">消费者驱动的契约测试——使用 Azure 函数托管模拟 API</a></li></ul></div></div>    
</body>
</html>