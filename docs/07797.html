<html>
<head>
<title>Kafka on Kubernetes: Using Strimzi — Part 2 (Setup and Deployment)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes 上的卡夫卡:使用 Strimzi —第 2 部分(设置和部署)</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/kafka-on-kubernetes-using-strimzi-part-2-71a8ba8e9605?source=collection_archive---------0-----------------------#2022-04-24">https://blog.devgenius.io/kafka-on-kubernetes-using-strimzi-part-2-71a8ba8e9605?source=collection_archive---------0-----------------------#2022-04-24</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="8793" class="pw-post-body-paragraph jl jm in jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ig bi translated">这是系列的第二部分<strong class="jn io">卡夫卡论库伯内特:使用</strong> <a class="ae kj" href="https://strimzi.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="jn io"> Strimzi </strong> </a> <strong class="jn io">。本系列的第 1 部分讨论了 Strimzi 为在 Kubernetes 上部署和维护 Kafka 提供了什么。在这一部分中，我们将看到如何使用 Strimzi 在 Kubernetes 上部署和设置 Kafka。</strong></p><p id="2c3a" class="pw-post-body-paragraph jl jm in jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ig bi translated"><strong class="jn io">使用 Strimzi 的 Kafka 部署:</strong></p><figure class="kl km kn ko gt kp gh gi paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="gh gi kk"><img src="../Images/b80fa064b8d52bfd7d9e0d70a5204a55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Jzt3RGzVhCVSP8hkNbXP3Q.png"/></div></div><figcaption class="kw kx gj gh gi ky kz bd b be z dk translated">Kafka 使用 Strimzi 在 Kubernetes 上快速入门</figcaption></figure><p id="ce9c" class="pw-post-body-paragraph jl jm in jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ig bi translated">下面是在 Kubernetes 上部署 Strimzi 操作符和 Kafka 集群的步骤</p><ol class=""><li id="a01d" class="la lb in jn b jo jp js jt jw lc ka ld ke le ki lf lg lh li bi translated"><strong class="jn io">部署 Strimzi 操作员-</strong>strim zi 掌舵图包含所有必需的<a class="ae kj" href="https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/" rel="noopener ugc nofollow" target="_blank">CRD</a>(如上图所示，如 Kafka、KafkaConnect 等。)来轻松部署和维护 Kafka 集群。</li></ol><ul class=""><li id="3bb0" class="la lb in jn b jo jp js jt jw lc ka ld ke le ki lj lg lh li bi translated">首先添加 Strimzi 图表存储库</li></ul><pre class="kl km kn ko gt lk ll lm ln aw lo bi"><span id="d93c" class="lp lq in ll b gy lr ls l lt lu">helm repo <strong class="ll io">add</strong> strimzi https://strimzi.io/charts/</span></pre><ul class=""><li id="8a8e" class="la lb in jn b jo jp js jt jw lc ka ld ke le ki lj lg lh li bi translated">然后，您可以安装一个版本的 Strimzi 集群操作符</li></ul><pre class="kl km kn ko gt lk ll lm ln aw lo bi"><span id="c18f" class="lp lq in ll b gy lr ls l lt lu">helm <strong class="ll io">install</strong> strimzi/strimzi-kafka-<strong class="ll io">operator</strong> \ --name my-strimzi-release \ --namespace kafka \ --version 0.28.0</span></pre><p id="e535" class="pw-post-body-paragraph jl jm in jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ig bi translated">我们还可以使用 terraform 的<a class="ae kj" href="https://registry.terraform.io/providers/hashicorp/helm/latest/docs/resources/release" rel="noopener ugc nofollow" target="_blank"> helm_release </a>来轻松部署 Strimzi 操作符。</p><pre class="kl km kn ko gt lk ll lm ln aw lo bi"><span id="30dc" class="lp lq in ll b gy lr ls l lt lu">resource "helm_release" "strimzi" {<br/>  chart = "strimzi-kafka-operator"<br/>  name = "strimzi"<br/>  namespace = "kafka"<br/>  repository = "<a class="ae kj" href="https://strimzi.io/charts/" rel="noopener ugc nofollow" target="_blank">https://strimzi.io/charts/</a>"<br/>  version = "0.28.0"<br/>  values = [yamlencode({<br/> resources = {<br/>   requests = {<br/>     memory = "512Mi"<br/>     cpu = "250m"<br/>   }<br/>   limits = {<br/>     memory = "1536Mi"<br/>     cpu = "1000m"<br/>   }<br/>  }<br/> })]<br/>}</span></pre><p id="47c7" class="pw-post-body-paragraph jl jm in jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ig bi translated">Strimzi 集群操作符协调各种定制资源，如 Kafka、KafkaConnect 等。在特定或所有命名空间中。如果在名称空间中添加/更新/删除了任何定制资源，Strimzi 集群操作符将在集群中对其执行相同的操作。</p><p id="a436" class="pw-post-body-paragraph jl jm in jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ig bi translated"><strong class="jn io"> 2。部署 Kafka 定制资源</strong>——正如我们在<a class="ae kj" href="https://medium.com/@singh.amarendra/kafka-on-kubernetes-using-strimzi-part-1-83d74564135e" rel="noopener">第一部分</a>中讨论的，Strimzi 集群操作员可以管理多个 Kafka 集群。作为第二步的一部分，我们将添加一个 Kafka <a class="ae kj" href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/" rel="noopener ugc nofollow" target="_blank">自定义资源(CR) </a>。Kafka CR 可以部署以下组件-</p><ul class=""><li id="881c" class="la lb in jn b jo jp js jt jw lc ka ld ke le ki lj lg lh li bi translated">卡夫卡</li><li id="26d3" class="la lb in jn b jo lv js lw jw lx ka ly ke lz ki lj lg lh li bi translated">动物园管理员</li><li id="dc04" class="la lb in jn b jo lv js lw jw lx ka ly ke lz ki lj lg lh li bi translated">主题运算符</li><li id="4df0" class="la lb in jn b jo lv js lw jw lx ka ly ke lz ki lj lg lh li bi translated">用户操作员</li><li id="30ce" class="la lb in jn b jo lv js lw jw lx ka ly ke lz ki lj lg lh li bi translated">卡夫卡出口商</li><li id="78d3" class="la lb in jn b jo lv js lw jw lx ka ly ke lz ki lj lg lh li bi translated">巡航控制</li></ul><p id="73c4" class="pw-post-body-paragraph jl jm in jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ig bi translated">对于这一部分，我们将只部署 Kafka、Zookeeper 和实体操作符(主题和用户操作符)。</p><pre class="kl km kn ko gt lk ll lm ln aw lo bi"><span id="0c24" class="lp lq in ll b gy lr ls l lt lu">apiVersion: kafka.strimzi.io/v1beta2<br/>kind: Kafka<br/>metadata:<br/>  name: my-cluster<br/>spec:<br/>  kafka:<br/>    replicas: 3<br/>    listeners:<br/>      - name: plain<br/>        port: 9092<br/>        type: internal<br/>        tls: false<br/>    storage:<br/>      type: jbod<br/>      volumes:<br/>      - id: 0<br/>        type: persistent-claim<br/>        size: 100Gi<br/>        deleteClaim: false<br/>    config:<br/>      offsets.topic.replication.factor: 1<br/>      transaction.state.log.replication.factor: 1<br/>      transaction.state.log.min.isr: 1<br/>      default.replication.factor: 3<br/>      min.insync.replicas: 2<br/>  zookeeper:<br/>    replicas: 3<br/>    storage:<br/>      type: persistent-claim<br/>      size: 100Gi<br/>      deleteClaim: false<br/>  entityOperator:<br/>    topicOperator: {}<br/>    userOperator: {}</span></pre><p id="c7ea" class="pw-post-body-paragraph jl jm in jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ig bi translated">我们把这个存成<em class="ma"> kafka-resource.yaml </em>。正如我们在上面的配置中看到的，我们可以指定以下内容-</p><p id="fa47" class="pw-post-body-paragraph jl jm in jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ig bi translated">对卡夫卡来说:</p><ul class=""><li id="2e0a" class="la lb in jn b jo jp js jt jw lc ka ld ke le ki lj lg lh li bi translated">经纪人的数量</li><li id="71ec" class="la lb in jn b jo lv js lw jw lx ka ly ke lz ki lj lg lh li bi translated">侦听器(内部的或外部的，在第 5 部分中会有更多的介绍)</li><li id="4bce" class="la lb in jn b jo lv js lw jw lx ka ly ke lz ki lj lg lh li bi translated">存储(<a class="ae kj" href="https://strimzi.io/blog/2019/03/07/strimzi-0.11.0-release/" rel="noopener ugc nofollow" target="_blank"> JBOD </a>(仅适用于卡夫卡)或持续索赔)</li><li id="ae52" class="la lb in jn b jo lv js lw jw lx ka ly ke lz ki lj lg lh li bi translated">覆盖默认的 Kafka 配置，如复制因子等。</li><li id="e625" class="la lb in jn b jo lv js lw jw lx ka ly ke lz ki lj lg lh li bi translated">在本系列的以下部分中有更多配置</li></ul><p id="3753" class="pw-post-body-paragraph jl jm in jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ig bi translated">对于动物园管理员:</p><ul class=""><li id="9559" class="la lb in jn b jo jp js jt jw lc ka ld ke le ki lj lg lh li bi translated">Zookeeper 服务器数量</li><li id="36b5" class="la lb in jn b jo lv js lw jw lx ka ly ke lz ki lj lg lh li bi translated">储存；储备</li><li id="6593" class="la lb in jn b jo lv js lw jw lx ka ly ke lz ki lj lg lh li bi translated">在本系列的以下部分中有更多配置</li></ul><p id="805a" class="pw-post-body-paragraph jl jm in jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ig bi translated">对于 EntityOperator:</p><ul class=""><li id="701a" class="la lb in jn b jo jp js jt jw lc ka ld ke le ki lj lg lh li bi translated">主题操作符——部署主题操作符</li><li id="2078" class="la lb in jn b jo lv js lw jw lx ka ly ke lz ki lj lg lh li bi translated">userOperator-部署用户操作员</li></ul><p id="f1bd" class="pw-post-body-paragraph jl jm in jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ig bi translated">现在只需部署这个文件-</p><pre class="kl km kn ko gt lk ll lm ln aw lo bi"><span id="f8a0" class="lp lq in ll b gy lr ls l lt lu">&gt; kubectl apply -f kafka-resource.yaml -n kafka</span></pre><p id="f8a2" class="pw-post-body-paragraph jl jm in jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ig bi translated">我们将在这些部分以及 KafkaExporter、CruiseControl 等其他部分看到更多配置。在以下部分。我们还可以部署其他定制资源，如 KafkaConnect、KafkaConnector、MirrorMaker 等。，如果需要。</p><p id="55a9" class="pw-post-body-paragraph jl jm in jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ig bi translated"><strong class="jn io"> 3。创建一个主题- </strong>现在集群(my-cluster)已经准备好了，我们可以使用它将数据从生产者传递到消费者。让我们首先创建一个包含 3 个分区和 1 个副本的简单主题-</p><pre class="kl km kn ko gt lk ll lm ln aw lo bi"><span id="96d8" class="lp lq in ll b gy lr ls l lt lu">cat &lt;&lt; EOF | kubectl create -n my-kafka-project -f -<br/>apiVersion: kafka.strimzi.io/v1beta2<br/>kind: KafkaTopic<br/>metadata:<br/>  name: my-topic<br/>  labels:<br/>    strimzi.io/cluster: "my-cluster"<br/>spec:<br/>  partitions: 3<br/>  replicas: 1<br/>EOF</span></pre><p id="9d50" class="pw-post-body-paragraph jl jm in jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ig bi translated"><strong class="jn io"> 4。启动控制台生成器- </strong>现在我们可以从 Kafka broker pod 内部启动<a class="ae kj" href="http://cloudurable.com/blog/kafka-tutorial-kafka-from-command-line/index.html#:~:text=Run%20Kafka%20Producer%20Console&amp;text=Kafka%20provides%20the%20utility%20kafka,console.sh%20and%20run%20it." rel="noopener ugc nofollow" target="_blank">控制台生成器</a>(因为控制台生成器随 Kafka 二进制文件一起提供)并将数据发送到上一步创建的主题。我们还可以在本地机器上安装 Kafka 并连接到这个集群(但是我们必须添加外部监听器，比如 loadBalancer 或 nodePort，我们将在第 5 部分讨论 Kafka 安全性时讨论这个问题)。</p><pre class="kl km kn ko gt lk ll lm ln aw lo bi"><span id="8884" class="lp lq in ll b gy lr ls l lt lu">&gt;kubectl exec -i -t my-cluster-kafka-0 -- /bin/bash</span></pre><p id="659c" class="pw-post-body-paragraph jl jm in jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ig bi translated">现在让我们启动控制台制作程序-</p><pre class="kl km kn ko gt lk ll lm ln aw lo bi"><span id="f1b9" class="lp lq in ll b gy lr ls l lt lu">&gt; bin/kafka-console-producer.sh --bootstrap-server <em class="ma">localhost:9092</em> --topic my-topic<br/>Hello<br/>My name is Amarendra</span></pre><p id="3ceb" class="pw-post-body-paragraph jl jm in jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ig bi translated"><strong class="jn io"> 5。启动消费者- </strong>我们现在可以启动消费者，并分配它来监听上面创建的主题。我们应该会收到生成的信息-</p><pre class="kl km kn ko gt lk ll lm ln aw lo bi"><span id="960a" class="lp lq in ll b gy lr ls l lt lu">&gt;bin/kafka-console-consumer.sh --bootstrap-server --group consumer-group-a <em class="ma">localhost:9092</em> --topic my-topic --from-beginning<br/>Hello<br/>My name is Amarendra</span></pre><p id="2110" class="pw-post-body-paragraph jl jm in jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ig bi translated">我们得到了消费者群体中产生的信息。同一消费群体中的任何其他消费者都将无法再次获得这些消息(这就像卡夫卡的共享消息队列行为)。现在，如果其他一些消费者也想要这些消息，它仍然可以通过使用不同的组来获得(就像发布-订阅机制)。消费者群体给了 Kafka 灵活性，可以同时拥有消息队列和发布-订阅模式的优点。</p><pre class="kl km kn ko gt lk ll lm ln aw lo bi"><span id="9fe2" class="lp lq in ll b gy lr ls l lt lu">&gt;bin/kafka-console-consumer.sh --bootstrap-server --group consumer-group-b <em class="ma">localhost:9092</em> --topic my-topic --from-beginning<br/>Hello<br/>My name is Amarendra</span></pre><figure class="kl km kn ko gt kp gh gi paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="gh gi mb"><img src="../Images/034e15d21bffd7b1359b274005ed2817.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m_URulS_7Zli2dRmVognuw.png"/></div></div></figure><p id="1699" class="pw-post-body-paragraph jl jm in jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ig bi translated"><strong class="jn io">结论- </strong>我们已经看到了如何部署 Strimzi 集群操作器，以及它如何轻松地部署和管理 Kafka 集群。我们还创建了一个主题，并使用 Kafka 控制台生产者将数据传送给它，使用 Kafka 控制台消费者来消费它。</p><p id="30fe" class="pw-post-body-paragraph jl jm in jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ig bi translated">在下一部分中，我们将看到在 Kubernetes 上部署高可用性 Kafka 集群的其他重要配置。</p></div></div>    
</body>
</html>