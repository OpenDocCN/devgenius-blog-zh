<html>
<head>
<title>Pinterest System Design Interview (2020): Follow Pins</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Pinterest系统设计面试(2020):跟随图钉</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/2020-pinterest-system-design-interview-1-37f3a721f3e?source=collection_archive---------0-----------------------#2020-12-26">https://blog.devgenius.io/2020-pinterest-system-design-interview-1-37f3a721f3e?source=collection_archive---------0-----------------------#2020-12-26</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jk jl jm jn"><div class="bz fp l di"><div class="jo jp l"/></div></figure><p id="c76c" class="pw-post-body-paragraph jq jr in js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ig bi translated">今天又为大家准备了一篇Pinterest技术面试教程。从上一个教程开始，我复习了从<a class="ae ko" href="https://intuting.medium.com/pinterest-technical-phone-interview-2020-6d211ab74dd1" rel="noopener">第一次电话屏幕面试</a>收到的算法问题。那次面试后，我被邀请去做<strong class="js io">远程现场面试</strong>(由于Covid..)</p><p id="f949" class="pw-post-body-paragraph jq jr in js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ig bi translated">以下是我收到的远程现场面试的<strong class="js io">邀请邮件</strong>:</p><figure class="kq kr ks kt gt jn gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi kp"><img src="../Images/7356eee251a138595aa511b4c5445d3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5pjHouqL0o72s8dyQ9CODQ.png"/></div></div></figure><p id="0e06" class="pw-post-body-paragraph jq jr in js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ig bi translated">需要注意的一点是，因为这是远程现场面试，他们给你一个小时的时间进行系统设计面试，因为通过<strong class="js io">代码板</strong>解释事情会更困难。</p><h1 id="d0ff" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">系统设计面试问题</h1><figure class="kq kr ks kt gt jn gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ly"><img src="../Images/ed82f7fd6af6624cf275b3f15bf5f4e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Lt-zO400rN2GFozMXWzlJQ.png"/></div></div></figure><p id="9ee7" class="pw-post-body-paragraph jq jr in js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ig bi translated">面试问题是为Pinterest中的新功能提出一个系统设计，用户<strong class="js io">可以跟踪pin或用户更新</strong>。例如，让我们说我跟随上面的大头针。每当这个pin码有更新，我都会收到通知。如果我关注某个用户，当他/她发布或编辑pin时，我应该会收到通知。</p><h1 id="801d" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">你自己试试</h1><p id="f248" class="pw-post-body-paragraph jq jr in js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn ig bi me translated"><span class="l mf mg mh bm mi mj mk ml mm di"> S </span>这样你会学到更多！！</p><figure class="kq kr ks kt gt jn gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mn"><img src="../Images/57772596a8a1e28bd47dff40a7539aad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*pY6T3sxqXPED-R43"/></div></div></figure><h1 id="34a0" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated"><strong class="ak">了解问题&amp;范围</strong></h1><p id="7336" class="pw-post-body-paragraph jq jr in js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn ig bi translated">在开始设计之前，我们应该通过向面试官提出适当的问题来充分了解问题及其范围。</p><p id="d21f" class="pw-post-body-paragraph jq jr in js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ig bi translated"><strong class="js io">功能需求:</strong></p><ul class=""><li id="b2db" class="mo mp in js b jt ju jx jy kb mq kf mr kj ms kn mt mu mv mw bi translated">用户应该能够关注不同的用户或pin。</li><li id="e899" class="mo mp in js b jt mx jx my kb mz kf na kj nb kn mt mu mv mw bi translated">应通知用户他们关注的用户/pin。</li></ul><p id="3569" class="pw-post-body-paragraph jq jr in js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ig bi translated"><strong class="js io">利益相关方&amp;用户:</strong></p><ul class=""><li id="a581" class="mo mp in js b jt ju jx jy kb mq kf mr kj ms kn mt mu mv mw bi translated">对于任何Pinterest用户来说。</li></ul><h1 id="ff5d" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated"><strong class="ak">了解模式/规模</strong></h1><p id="4d58" class="pw-post-body-paragraph jq jr in js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn ig bi translated">然后，我们应该尝试了解我们正在处理的是哪种请求/数据量。你可以问这样的问题:</p><ul class=""><li id="b4b2" class="mo mp in js b jt ju jx jy kb mq kf mr kj ms kn mt mu mv mw bi translated">Pinterest的用户数量是多少？</li><li id="a810" class="mo mp in js b jt mx jx my kb mz kf na kj nb kn mt mu mv mw bi translated">我们正在处理多少请求？</li><li id="a4fc" class="mo mp in js b jt mx jx my kb mz kf na kj nb kn mt mu mv mw bi translated">读写操作的比率？</li></ul><p id="b689" class="pw-post-body-paragraph jq jr in js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ig bi translated">如果你在面试前做了一些调查，你应该能得出一个大概的数字。</p><ul class=""><li id="dd26" class="mo mp in js b jt ju jx jy kb mq kf mr kj ms kn mt mu mv mw bi translated"><strong class="js io"/>用户数量:几百万用户。</li><li id="f769" class="mo mp in js b jt mx jx my kb mz kf na kj nb kn mt mu mv mw bi translated"><strong class="js io"/>引脚数:几十亿个引脚。</li><li id="001f" class="mo mp in js b jt mx jx my kb mz kf na kj nb kn mt mu mv mw bi translated"><strong class="js io"> QPS: </strong>假设有100万QPS(某个合理的大数字)</li></ul><p id="0309" class="pw-post-body-paragraph jq jr in js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ig bi translated">此外，Pinterest的应用性质决定了它必须处理更多的读取操作。你还可以问其他问题，但你应该在完成初始设计后再跟进，比如:</p><ul class=""><li id="dbdc" class="mo mp in js b jt ju jx jy kb mq kf mr kj ms kn mt mu mv mw bi translated">理想的SLA</li><li id="f0ba" class="mo mp in js b jt mx jx my kb mz kf na kj nb kn mt mu mv mw bi translated">安全需要。</li></ul><h1 id="841f" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">系统设计</h1><p id="21e0" class="pw-post-body-paragraph jq jr in js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn ig bi translated">我们可以将设计分成几个部分:</p><ul class=""><li id="17a8" class="mo mp in js b jt ju jx jy kb mq kf mr kj ms kn mt mu mv mw bi translated">关注实体(用户或pin)</li><li id="417e" class="mo mp in js b jt mx jx my kb mz kf na kj nb kn mt mu mv mw bi translated">为pin更新创建通知</li><li id="7095" class="mo mp in js b jt mx jx my kb mz kf na kj nb kn mt mu mv mw bi translated">向用户发送通知</li><li id="6db1" class="mo mp in js b jt mx jx my kb mz kf na kj nb kn mt mu mv mw bi translated">处理太多关注者的更新(例如，100万关注者)</li></ul><h1 id="d477" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated"><strong class="ak"> 1。跟随实体</strong></h1><p id="b86e" class="pw-post-body-paragraph jq jr in js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn ig bi me translated"><span class="l mf mg mh bm mi mj mk ml mm di">问</span>这里的主要问题是，当用户点击pin或用户上的“关注”按钮时会发生什么？</p><p id="4a50" class="pw-post-body-paragraph jq jr in js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ig bi translated">我们应该在后端服务器上创建一个端点来存储追随者关系。当前端(移动或web)点击这个端点时，它会在数据库中持久化追随者关系，并将成功响应返回给用户。其他错误响应(例如，网络问题或无效响应)</p><figure class="kq kr ks kt gt jn gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nc"><img src="../Images/6cabcd8d35b9af5ae1aae43277319cab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4NYfwHouX0McQnYk"/></div></div></figure><p id="fa0e" class="pw-post-body-paragraph jq jr in js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ig bi translated">这里，我们使用一个关系数据库来存储追随者关系。面试官肯定会问你为什么不使用其他类型的数据库(例如，基于图形或文档的数据库)。</p><ul class=""><li id="d5c6" class="mo mp in js b jt ju jx jy kb mq kf mr kj ms kn mt mu mv mw bi translated"><strong class="js io">非关系数据库(如MongoDB) </strong>:不太适合存储关系。它适用于存储不经常更改的一对一映射数据。</li><li id="033f" class="mo mp in js b jt mx jx my kb mz kf na kj nb kn mt mu mv mw bi translated"><strong class="js io">图形数据库(例如Neo4j): </strong>当我们需要处理实体之间的深度关系时，图形数据库非常有用(例如，在脸书的社交网络中，我们希望找到朋友的朋友的朋友)。然而，在我们的例子中，我们只是指用户和实体之间的关系(一对多)。</li></ul><p id="b440" class="pw-post-body-paragraph jq jr in js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ig bi translated">因此，在这里使用关系数据库是有意义的。此外，我在采访前做了一些研究，Pinterest使用关系数据库来存储pin，因此使用另一种类型的数据库来存储追随者关系是没有意义的。</p><p id="58a1" class="pw-post-body-paragraph jq jr in js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ig bi translated">以下是follower表的示例数据模式:</p><figure class="kq kr ks kt gt jn gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/ba66707443f9e8d60e7c98bda97441cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:514/format:webp/1*7HByjiJOK7Sz2mVKHrQAJQ.png"/></div></figure><p id="2d10" class="pw-post-body-paragraph jq jr in js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ig bi translated">用于用户和实体uuids的列。另一列指定实体的类型(PIN与用户)。最后，用户开始关注实体时的时间戳列。</p><h1 id="b45d" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">2.创建通知</h1><p id="602a" class="pw-post-body-paragraph jq jr in js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn ig bi translated">现在我们有了数据库中持久的追随者关系，我们需要找出一种方法来创建通知，无论何时被跟踪的pins用户进行更新。</p><figure class="kq kr ks kt gt jn gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nc"><img src="../Images/a25e498c4770146e95cb119f6a546cd9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*BfqXMsSYnl_ut790"/></div></div></figure><p id="6cbd" class="pw-post-body-paragraph jq jr in js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ig bi translated">每个创建或编辑pin的请求都将通过调用后端服务器中的端点来完成。后端服务器会将更新保存在数据库中(Pinterest使用关系数据库来存储pin)。</p><p id="241e" class="pw-post-body-paragraph jq jr in js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ig bi translated">我们可以选择异步<strong class="js io">或同步</strong>或<strong class="js io">创建通知:</strong></p><ul class=""><li id="09a4" class="mo mp in js b jt ju jx jy kb mq kf mr kj ms kn mt mu mv mw bi translated"><strong class="js io">同步方法:</strong>在数据库中持久化更新后，后端服务器会在将成功响应发送回用户之前向相关关注者显式发送通知。这并不理想，因为这会显著增加写操作的延迟。</li><li id="1568" class="mo mp in js b jt mx jx my kb mz kf na kj nb kn mt mu mv mw bi translated"><strong class="js io">异步方法:</strong>在数据库中保存更新后，后端服务器将创建一个任务来发送通知，并将成功响应发送回用户，而无需等待通知完成。</li></ul><p id="4964" class="pw-post-body-paragraph jq jr in js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ig bi translated"><strong class="js io">异步方法</strong>对于通知来说更有意义，因为它对于用户请求来说并不重要。我们不应该让用户等这么久才创建或编辑pin。</p><p id="1fa6" class="pw-post-body-paragraph jq jr in js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ig bi translated">一种方法是在<strong class="js io"> pins表上注册一个触发器，</strong>监听任何更新，并向Kafka(一个消息代理)发布更新消息。我们可以使用类似<a class="ae ko" href="https://docs.confluent.io/platform/current/connect/index.html#:~:text=Kafka%20Connect%20is%20a%20free,Kafka%20Connect%20for%20Confluent%20Platform." rel="noopener ugc nofollow" target="_blank">卡夫卡连接</a>的东西来设置事情。另一种方法是在发送成功响应之前，根据用户请求向Kafka显式发布消息。</p><p id="5235" class="pw-post-body-paragraph jq jr in js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ig bi translated">然后，我们可以创建订阅该主题的工人，并在有关于该主题的消息时创建通知。在创建通知之前，工作人员必须查找followers表来检索关注更新pin的用户列表。</p><h1 id="745e" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">3.发送通知</h1><p id="ccb1" class="pw-post-body-paragraph jq jr in js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn ig bi me translated"><span class="l mf mg mh bm mi mj mk ml mm di">问</span>我们实际上如何向用户发送通知？在采访的开始，他们告诉我要把通知服务当作一个黑盒。但是在最初的设计讨论之后，我们又回去讨论了它的实现。</p><p id="bf7b" class="pw-post-body-paragraph jq jr in js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ig bi translated">在像Pinterest这样的大公司，最有可能有一个集中的通知服务。</p><figure class="kq kr ks kt gt jn gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ne"><img src="../Images/581b6323e091f72a7c542cccf75aca93.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PxRlF5u4aGEZ9G4Z"/></div></div></figure><p id="dfc0" class="pw-post-body-paragraph jq jr in js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ig bi translated">通常，通知是异步发送的，它们有不同的优先级。为了处理不同种类的通知，不同的优先级会有不同的队列。</p><p id="b4de" class="pw-post-body-paragraph jq jr in js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ig bi translated">除非另有规定，否则我们可以将通知视为低优先级，并在低优先级队列中发布通知。</p><p id="82d0" class="pw-post-body-paragraph jq jr in js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ig bi translated">一旦我们在队列中发布了通知消息，就会有通知工作器订阅队列并尝试向用户发送通知。这些工作者必须找到与用户有开放连接的后端实例，并转发通知。</p><h2 id="d3a1" class="nf lb in bd lc ng nh dn lg ni nj dp lk kb nk nl lo kf nm nn ls kj no np lw nq bi translated"><span class="l mf mg mh bm mi mj mk ml mm di">问</span>用户连接是如何工作的？</h2><p id="eeea" class="pw-post-body-paragraph jq jr in js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn ig bi translated">一个移动/web用户设备可以剥离一个后台服务来创建一个与我们的通知后端实例之一的web套接字连接。我们将把这个连接信息保存在键值对DB中(例如，userID -&gt; machineID)。</p><p id="9973" class="pw-post-body-paragraph jq jr in js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ig bi translated">当一个worker试图向一个特定的用户发送通知时，它必须通过在键值对DB (userID -&gt; machineID)中查找来找到管理与该用户的连接的后端实例，并转发请求。</p><p id="e274" class="pw-post-body-paragraph jq jr in js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ig bi translated">我推荐你观看“<a class="ae ko" href="https://www.youtube.com/watch?v=6w6E_B55p0E&amp;ab_channel=InfoQ" rel="noopener ugc nofollow" target="_blank">网飞数百万设备的缩放推送消息”youtube视频</a>。这个人用漂亮的幻灯片很好地解释了通知服务。</p><h1 id="14b4" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated"><strong class="ak"> 4。手柄&gt; 1M从动件… </strong></h1><p id="04f3" class="pw-post-body-paragraph jq jr in js b jt lz jv jw jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn ig bi translated">当追随者的数量相对较少时，当前的设计工作良好。然而，让我们考虑一个例子，有超过100万的用户在关注一个名人。试图向超过100万的粉丝发送通知只会让系统崩溃。</p><p id="29a9" class="pw-post-body-paragraph jq jr in js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ig bi translated">我们应该对有太多追随者的用户/pin进行特殊处理。我们可以采用类似Twitter的混合方法。</p><figure class="kq kr ks kt gt jn gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nr"><img src="../Images/6c3df7213a54c2a6a8bb393f55cb34c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ha7YqILpnpY2vJl3"/></div></div></figure><p id="ab00" class="pw-post-body-paragraph jq jr in js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ig bi translated">对于具有太多追随者的更新，我们可以使客户端(用户)周期性地(例如，每5分钟)呼叫端点(例如，syncNotification)以获得关于具有太多追随者的实体的更新，而不是发送突发通知。您需要确保不是所有设备都同时调用此端点。为了防止这种情况，我们可以随机化呼叫该端点的周期(例如，random(0，5分钟))。</p></div><div class="ab cl ns nt hr nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="ig ih ii ij ik"><figure class="kq kr ks kt gt jn gh gi paragraph-image"><div class="gh gi nz"><img src="../Images/13db40bec7928c76f857c52959736ec9.png" data-original-src="https://miro.medium.com/v2/resize:fit:996/0*K8jzFyupe7KqB-ij"/></div></figure><p id="07e9" class="pw-post-body-paragraph jq jr in js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ig bi translated">好了，我们完成了。当然，我们还可以讨论这个系统设计的其他方面，但这应该足以完成一个小时的面试。如果您想讨论任何其他组件，或者对我们刚刚检查过的设计有任何问题或建议，请在下面评论。</p><p id="5a51" class="pw-post-body-paragraph jq jr in js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ig bi translated">我很乐意讨论进一步的改进或替代方案。此外，我想听听你会如何设计这个。</p></div></div>    
</body>
</html>