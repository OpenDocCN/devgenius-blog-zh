<html>
<head>
<title>Full Link Online Stress Testing for Production Database: Apache ShardingSphere Shadow Database Feature Upgrade</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">生产数据库的全链接在线压力测试:Apache ShardingSphere影子数据库功能升级</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/full-link-online-stress-testing-for-production-database-apache-shardingsphere-shadow-database-84f7cba56f99?source=collection_archive---------7-----------------------#2022-01-09">https://blog.devgenius.io/full-link-online-stress-testing-for-production-database-apache-shardingsphere-shadow-database-84f7cba56f99?source=collection_archive---------7-----------------------#2022-01-09</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><h1 id="60f2" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">什么是全链路压力测试？</h1><p id="05d5" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">随着互联网行业的快速发展，处理大量数据的企业也在快速扩张。</p><p id="30c4" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">可以预见，不断变化的客户需求会对整个系统的稳定性产生重大影响。例如，在线食品交付平台在中午和晚上接收大部分客户订单。网上购物狂欢和限时促销也是很好的例子。</p><p id="66ff" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">所有业务都由一系列业务系统提供服务，这些系统分布在不同的机器上。“数据规划”不仅能确保系统的稳定性，还能节省成本，这是技术团队面临的一些主要问题。</p><p id="c1d3" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">为了从特定的机器上精确地获得正确的服务，压力测试应该在生产环境中进行。这样可以保证环境和数据的真实性，显著提高“数据规划”的精度。</p><h1 id="c0f9" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">影子数据库和全链路压力测试</h1><p id="e298" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">对在线业务系统进行压力测试显然是有风险的。例如，可能会出现数据损坏或性能问题。</p><p id="5757" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">想象一下，如果客户发现他们的订单丢失或弹出一个未付款的订单，这将如何影响客户体验？</p><p id="a7a5" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">全链路在线压力测试意味着大量复杂的工作，需要微服务和中间件之间的合作。<a class="ae ll" href="https://shardingsphere.apache.org" rel="noopener ugc nofollow" target="_blank"> Apache ShardingSphere </a>专注于全链路压力测试中的数据库级解决方案。</p><p id="c4a7" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">借助ShardingSphere强大的SQL解析能力，Apache ShardingSphere发布了影子数据库压力测试功能，通过执行SQL来确定影子数据库，并通过影子算法的灵活配置来满足复杂业务场景下的在线压力测试需求。通过将压力测试流量路由到影子数据库，将正常在线流量路由到生产数据库，压力测试数据将被隔离，数据损坏问题将得到解决。</p><h1 id="d8ab" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">影子数据库功能升级</h1><p id="af33" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">影子数据库功能最初是在4.1.0版本中通过添加逻辑影子列实现的。通过解析、执行、路由和重写SQL，Apache ShardingSphere删除了影子列和列值。在此过程中，用户不需要进行任何设置或操作。他们只需要相应地修改SQL，添加影子字段和相应的配置。</p><h2 id="df53" class="lm jl in bd jm ln lo dn jq lp lq dp ju kt lr ls jy kx lt lu kc lb lv lw kg lx bi translated">添加影子列时会出现两个棘手问题:</h2><ol class=""><li id="cbe8" class="ly lz in kk b kl km kp kq kt ma kx mb lb mc lf md me mf mg bi translated">在进行压力测试之前，用户需要根据实际业务需求修改测试相关的SQL。</li><li id="fa12" class="ly lz in kk b kl mh kp mi kt mj kx mk lb ml lf md me mf mg bi translated">SQL修改会增加实现损害，降低压力测试结果的准确性。在ShardingSphere社区讨论之后，我们决定升级影子数据库功能。Apache ShardingSphere 4.1.1 GA影子数据库API具有相对简单的功能。是否打开影子数据库由logicColumn的相应值决定。</li></ol><pre class="mm mn mo mp gt mq mr ms mt aw mu bi"><span id="a1cc" class="lm jl in mr b gy mv mw l mx my">rules:<br/>- !SHADOW<br/> column: # <!-- -->shadow field nam<br/> shadowMappings:<br/> ds: shadow_ds # <!-- -->production data source name list: shadow database name list</span></pre><p id="aeb6" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">5.0.0 GA升级后的影子数据库API更加强大。用户可以通过“启用”属性确定是否启用影子数据库功能。可配置的影子表可以通过表格的方式确定需要进行压力测试的内容，并支持多种影子算法。比如列值匹配算法，正则表达式匹配，SQL注释匹配算法。</p><pre class="mm mn mo mp gt mq mr ms mt aw mu bi"><span id="2e85" class="lm jl in mr b gy mv mw l mx my">rules:<br/>- !SHADOW<br/>  enable: true # shadow databasepn-off switch. Optional value: true/false, default false<br/>  dataSources:<br/>    shadowDataSource:<br/>      sourceDataSourceName: ds # productionDataSourceName<br/>      shadowDataSourceName: shadow_ds # shadowDataSourceName<br/>  tables:<br/>    &lt;shadow-table-name&gt;:<br/>      dataSourceNames: shadowDataSource # #NameListOfShadowDataSourcesRelatedtoShadowDatabases (separate multiple values with ",")<br/>      shadowAlgorithmNames: <br/>        - &lt;shadow-algorithm-name&gt; # #NameListOfShadowAlgorithmsRelatedtoShadowDatabases<br/>  shadowAlgorithms:<br/>    &lt;shadow-algorithm-name&gt;:<br/>      type: # shadowAlgorithmType<br/>      props: <br/>        xxx: xxx # shadowAlgorithmAttributeConfiguration</span></pre><h1 id="ff64" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">实践中的影子数据库</h1><p id="9b17" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">在线全链路压力测试图:</p><figure class="mm mn mo mp gt na gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi mz"><img src="../Images/d9ac5633fd617f3c93329d96b63f2c09.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Mz1x9IqrqghLKHhzLg5Atg.jpeg"/></div></div></figure><h2 id="892c" class="lm jl in bd jm ln lo dn jq lp lq dp ju kt lr ls jy kx lt lu kc lb lv lw kg lx bi translated">准备压力测试环境:</h2><p id="e821" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">假设一个电子商务网站需要对一个订单进行在线压力测试(演示如何使用独立部署)。假设压力测试表<code class="fe nh ni nj mr b">t_order</code>是一个订单表，测试用户ID为0。</p><p id="e63a" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">测试用户订单生成的数据在ds_shadow影子数据库上执行，生产数据在ds生产数据库上执行。</p><p id="1d04" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated"><strong class="kk io">准备测试环境:</strong></p><ol class=""><li id="dffa" class="ly lz in kk b kl lg kp lh kt nk kx nl lb nm lf md me mf mg bi translated">从<a class="ae ll" href="https://shardingsphere.apache.org/document/5.0.0/en/downloads/" rel="noopener ugc nofollow" target="_blank">下载页面</a>下载ShardingSphere-Proxy 5.0.0 GA，安装配置详情请参考<a class="ae ll" href="https://shardingsphere.apache.org/document/current/en/quick-start/shardingsphere-proxy-quick-start/" rel="noopener ugc nofollow" target="_blank">sharding sphere-Proxy-Quick-Start</a>。</li><li id="e045" class="ly lz in kk b kl mh kp mi kt mj kx mk lb ml lf md me mf mg bi translated">在上面提到的假设压力测试场景中配置ShardingSphere-Proxy:</li></ol><p id="ba11" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated"><strong class="kk io"> server.yaml </strong></p><pre class="mm mn mo mp gt mq mr ms mt aw mu bi"><span id="6f35" class="lm jl in mr b gy mv mw l mx my">rules:<br/>  - !AUTHORITY<br/>    users:<br/>      - root@%:root<br/>      - sharding@:sharding<br/>    provider:<br/>      type: NATIVE<br/>  - !TRANSACTION<br/>    defaultType: XA<br/>    providerType: Atomikos</span><span id="91c0" class="lm jl in mr b gy nn mw l mx my">props:<br/>  max-connections-size-per-query: 1<br/>  executor-size: 16  # Infinite by default.<br/>  proxy-frontend-flush-threshold: 128  # The default value is 128.<br/>  proxy-opentracing-enabled: false<br/>  proxy-hint-enabled: false<br/>  sql-show: true<br/>  check-table-metadata-enabled: false<br/>  lock-wait-timeout-milliseconds: 50000 # The maximum time to wait for a lock<br/>  show-process-list-enabled: false<br/>    # Proxy backend query fetch size. A larger value may increase the memory usage of ShardingSphere Proxy.<br/>    # The default value is -1, which means set the minimum value for different JDBC drivers.<br/>  proxy-backend-query-fetch-size: -1<br/>  check-duplicate-table-enabled: false<br/>  sql-comment-parse-enabled: true<br/>  proxy-frontend-executor-size: 0 # Proxy frontend executor size. The default value is 0, which means let Netty decide.<br/>    # Available options of proxy backend executor suitable: OLAP(default), OLTP. The OLTP option may reduce time cost of writing packets to client, but it may increase the latency of SQL execution<br/>    # if client connections are more than proxy-frontend-netty-executor-size, especially executing slow SQL.<br/>  proxy-backend-executor-suitable: OLAP</span></pre><p id="0a71" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated"><strong class="kk io"> config-shadow.yaml </strong></p><pre class="mm mn mo mp gt mq mr ms mt aw mu bi"><span id="a28f" class="lm jl in mr b gy mv mw l mx my">schemaName: shadow_poc_database</span><span id="d2db" class="lm jl in mr b gy nn mw l mx my">dataSources:<br/>  ds:<br/>    url: jdbc:mysql://127.0.0.1:3306/ds?serverTimezone=UTC&amp;useSSL=false<br/>    username: root<br/>    password:<br/>    connectionTimeoutMilliseconds: 30000<br/>    idleTimeoutMilliseconds: 60000<br/>    maxLifetimeMilliseconds: 1800000<br/>    maxPoolSize: 50<br/>    minPoolSize: 1<br/>  ds_shadow:<br/>    url: jdbc:mysql://127.0.0.1:3306/ds_shadow?serverTimezone=UTC&amp;useSSL=false<br/>    username: root<br/>    password:<br/>    connectionTimeoutMilliseconds: 30000<br/>    idleTimeoutMilliseconds: 60000<br/>    maxLifetimeMilliseconds: 1800000<br/>    maxPoolSize: 50<br/>    minPoolSize: 1</span><span id="f495" class="lm jl in mr b gy nn mw l mx my">rules:<br/>- !SHADOW<br/>  enable: true<br/>  dataSources:<br/>    shadowDataSource:<br/>      sourceDataSourceName: ds<br/>      shadowDataSourceName: ds_shadow</span><span id="185e" class="lm jl in mr b gy nn mw l mx my">  tables:<br/>    t_order:<br/>      dataSourceNames:<br/>        - shadowDataSource<br/>      shadowAlgorithmNames:<br/>        - user-id-insert-match-algorithm<br/>        - simple-note-algorithm</span><span id="f4cf" class="lm jl in mr b gy nn mw l mx my">  shadowAlgorithms:<br/>    user-id-insert-match-algorithm:<br/>      type: COLUMN_REGEX_MATCH<br/>      props:<br/>        operation: insert<br/>        column: user_id<br/>        regex: "[0]"<br/>    simple-note-algorithm:<br/>      type: SIMPLE_NOTE<br/>      props:<br/>        foo: bar</span></pre><p id="b9bc" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">3.订单服务</p><p id="2926" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">这里不讨论订单相关的业务。以最简单的请求获取和订单表插入为例，订单表结构如下:</p><ul class=""><li id="60be" class="ly lz in kk b kl lg kp lh kt nk kx nl lb nm lf no me mf mg bi translated">订单表结构</li></ul><pre class="mm mn mo mp gt mq mr ms mt aw mu bi"><span id="3400" class="lm jl in mr b gy mv mw l mx my">CREATE TABLE `t_order` (<br/>    `id` INT(11) AUTO_INCREMENT COMMENT 'Order ID',<br/>    `user_id` VARCHAR(32) NOT NULL COMMENT 'User ID',<br/>    `sku` VARCHAR(32) NOT NULL COMMENT 'Product ordered sku',<br/>    PRIMARY KEY (`id`)<br/>)ENGINE = InnoDB COMMENT = 'order table';</span></pre><h2 id="5c7e" class="lm jl in bd jm ln lo dn jq lp lq dp ju kt lr ls jy kx lt lu kc lb lv lw kg lx bi translated">压力测试过程模拟</h2><ul class=""><li id="3e85" class="ly lz in kk b kl km kp kq kt ma kx mb lb mc lf no me mf mg bi translated">使用<code class="fe nh ni nj mr b">postman</code>模拟测试用户创建的订单，如下所示:</li></ul><figure class="mm mn mo mp gt na gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi np"><img src="../Images/1df88f5546d337df702423d6836b8f01.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EiGEo1CWppglnH-lA1bacA.png"/></div></div></figure><ul class=""><li id="dbbf" class="ly lz in kk b kl lg kp lh kt nk kx nl lb nm lf no me mf mg bi translated">路由到影子数据库并在其中执行的SQL执行器可以在ShardingSphere-Proxy执行日志中看到:</li></ul><figure class="mm mn mo mp gt na gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi nq"><img src="../Images/e509fe0180e05ad20903d75790f4560b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*txYe_EhCa7fo5D47IfH33Q.png"/></div></div></figure><h2 id="9ca9" class="lm jl in bd jm ln lo dn jq lp lq dp ju kt lr ls jy kx lt lu kc lb lv lw kg lx bi translated">验证压力测试结果:</h2><ul class=""><li id="57da" class="ly lz in kk b kl km kp kq kt ma kx mb lb mc lf no me mf mg bi translated">影子数据库<code class="fe nh ni nj mr b">ds_shadow</code>执行查询语句<code class="fe nh ni nj mr b">SELECT * FROM t_order;</code></li></ul><p id="0465" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">查询结果:</p><figure class="mm mn mo mp gt na gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi nq"><img src="../Images/75921505bf3ca949d5f12758915eb41f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V9CokxukmXBKxmflUkZLGw.png"/></div></div></figure><ul class=""><li id="ef06" class="ly lz in kk b kl lg kp lh kt nk kx nl lb nm lf no me mf mg bi translated">生产数据库ds执行查询语句<code class="fe nh ni nj mr b">SELECT * FROM t_order;</code>查询结果:</li></ul><figure class="mm mn mo mp gt na gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi nq"><img src="../Images/a13acb03426a00567f40b18e327be08c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5HUJLBZOsFAUemyIyT7ddw.png"/></div></div></figure><p id="7974" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">从测试用户订单创建中生成的数据将被发送到影子数据库。对于更复杂的配置，请参考<a class="ae ll" href="https://shardingsphere.apache.org/document/5.0.0/cn/features/shadow/" rel="noopener ugc nofollow" target="_blank"> ShardingSphere官方文档</a>中的影子数据库压力测试。</p><h2 id="b437" class="lm jl in bd jm ln lo dn jq lp lq dp ju kt lr ls jy kx lt lu kc lb lv lw kg lx bi translated">全链路在线压力测试的完整解决方案—cyborflow</h2><p id="78b3" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">如简介中所述，全链路在线压力测试是一项复杂的任务，需要微服务和中间件之间的协作，以满足不同流量和压力测试标签传输的需求。</p><p id="3073" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">另外，测试服务应该是无状态的，并且可以立即使用。<a class="ae ll" href="https://github.com/SphereEx/CyborgFlow" rel="noopener ugc nofollow" target="_blank">由Apache ShardingSphere、Apache APISIX和Apache SkyWalking共同维护的cyborflow</a>，提供开箱即用(OoTB)的解决方案，在你的在线系统中运行负载测试。</p><p id="0734" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated"><a class="ae ll" href="https://apisix.apache.org" rel="noopener ugc nofollow" target="_blank"> Apache APISIX </a>负责在网关层对测试数据做标签，而<a class="ae ll" href="https://skywalking.apache.org" rel="noopener ugc nofollow" target="_blank"> Apache SkyWalking </a>负责通过整个调度链路进行传输，最后Apache ShardingSphere-Proxy会隔离数据并将测试数据路由到影子数据库。</p><p id="d61f" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">CyborgFlow的0.1.0版本已经<a class="ae ll" href="https://github.com/SphereEx/CyborgFlow/releases" rel="noopener ugc nofollow" target="_blank">发布，可供下载。</a></p><h1 id="4d53" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">Apache ShardingSphere开源项目链接:</h1><p id="442f" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated"><a class="ae ll" href="https://github.com/apache/shardingsphere" rel="noopener ugc nofollow" target="_blank"> ShardingSphere Github </a></p><p id="f175" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated"><a class="ae ll" href="https://twitter.com/ShardingSphere" rel="noopener ugc nofollow" target="_blank"> ShardingSphere Twitter </a></p><p id="0921" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated"><a class="ae ll" href="https://join.slack.com/t/apacheshardingsphere/shared_invite/zt-sbdde7ie-SjDqo9%7EI4rYcR18bq0SYTg" rel="noopener ugc nofollow" target="_blank">切割球松弛通道</a></p><p id="b353" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated"><a class="ae ll" href="https://shardingsphere.apache.org/community/cn/contribute/" rel="noopener ugc nofollow" target="_blank">投稿指南</a></p><p id="bf9b" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated"><strong class="kk io">作者</strong></p><p id="622d" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">后洋</p><blockquote class="nr ns nt"><p id="f7fa" class="ki kj nu kk b kl lg kn ko kp lh kr ks nv li kv kw nw lj kz la nx lk ld le lf ig bi translated"><em class="in"> SphereEx中间件开发者，Apache ShardingSphere贡献者。</em></p><p id="ee6a" class="ki kj nu kk b kl lg kn ko kp lh kr ks nv li kv kw nw lj kz la nx lk ld le lf ig bi translated">目前，他专注于ShadowDB和全链路压力测试的设计和开发。</p></blockquote><figure class="mm mn mo mp gt na gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi ny"><img src="../Images/83f0fd04946358a1bee042da2d33ec1c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uU7AoQ6TOTf9TSC-CsiSuw.png"/></div></div></figure></div></div>    
</body>
</html>