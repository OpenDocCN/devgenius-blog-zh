<html>
<head>
<title>Dependency Injection: Guice for Unit Testing - Part 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">依赖注入:单元测试指南-第 2 部分</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/dependency-injection-google-guice-for-unit-testing-part-2-32ee351ec09f?source=collection_archive---------1-----------------------#2022-07-05">https://blog.devgenius.io/dependency-injection-google-guice-for-unit-testing-part-2-32ee351ec09f?source=collection_archive---------1-----------------------#2022-07-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><h1 id="40a8" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated"><strong class="ak">概述</strong></h1><p id="252b" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在之前的<a class="ae lj" href="https://medium.com/@techisbeautiful/dependency-injection-design-pattern-and-google-guice-examples-part-1-534d248025d2" rel="noopener">第 1 部分</a>中，我们探讨了依赖注入(DI)的基本功能以及如何用 Guice 实现 DI。在本文中，我们将探讨 Guice 如何帮助更容易地实现单元测试。</p><h1 id="e8db" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">使用 DI 的单元测试示例</h1><p id="023d" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在更详细地讨论实现之前，我们应该考虑一下为什么单元测试会因为依赖注入而变得更简单？因为一个类的依赖关系都是通过它们的构造函数传递的，所以我们可以在单元测试用例中传递这些依赖关系的模仿或伪造。</p><p id="b31b" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">让我们回顾一下<a class="ae lj" href="https://medium.com/@techisbeautiful/dependency-injection-design-pattern-and-google-guice-examples-part-1-534d248025d2" rel="noopener">第一部分</a>中的例子，如果动物园管理员类必须直接构造一个狮子实例，那么我们就没有办法在没有狮子的情况下测试动物园管理员。在真实的项目中，Lion 类可能会有错误，或者创建一个新的实例非常昂贵。使用 Guice，因为 ZooKeeper 在其构造函数中采用了 Animal 接口，所以它不依赖于具体的 Animal 实现。在 ZooKeeper 的单元测试中，我们并不依赖于动物实现，而是创建一个非常简单的 MockAnimal 类，并将其传递给 ZooKeeper 的构造函数。例如，这是 ZooKeeperTest:</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="8186" class="ly jo iq lu b gy lz ma l mb mc"><strong class="lu ir">import </strong>org.junit.Test;<br/><strong class="lu ir">import </strong>org.junit.runner.RunWith;<br/><strong class="lu ir">import </strong>org.junit.runners.JUnit4;<br/><br/>@RunWith(JUnit4.<strong class="lu ir">class</strong>)<br/><strong class="lu ir">public final class </strong>ZooKeeperTest {<br/>  @Test<br/>  <strong class="lu ir">public void </strong>ownerTest() <strong class="lu ir">throws </strong>Exception {<br/>    ZooKeeper zooKeeper = <strong class="lu ir">new </strong>ZooKeeper(<strong class="lu ir">new </strong>MockAnimal());<br/><br/>  }<br/>}</span></pre><p id="cae0" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">MockAnimal 类很简单:</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="bbfd" class="ly jo iq lu b gy lz ma l mb mc"><strong class="lu ir">public class </strong>MockAnimal <strong class="lu ir">implements </strong>Animal {<br/><br/>  @Override<br/>  <strong class="lu ir">public </strong>String voice() {<br/>    <strong class="lu ir">return "This is a mock animal"</strong>;<br/>  }<br/>}</span></pre><p id="100a" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">如上例，我们可以创建一个简单的单元测试类，不需要任何框架或库。这是编写单元测试用例时的最佳实践模式。然而，对于更复杂的项目，我们应该使用 Guice 为我们创建类实例。简单的方法是创建一个包含测试用例所需绑定的 AbstractModule，并调用 getInstance()方法来实例化测试用例下的类。这是一个如何使用提供 MockAnimal 绑定的 AnimalTestModule 编写一个测试的例子，该测试将 MockAnimal 类注入 ZooKeeper。</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="dece" class="ly jo iq lu b gy lz ma l mb mc"><strong class="lu ir">import </strong>com.google.inject.AbstractModule;<br/><br/><strong class="lu ir">public final class </strong>AnimalTestModule <strong class="lu ir">extends </strong>AbstractModule {<br/><br/>  @Override<br/>  <strong class="lu ir">protected void </strong>configure() {<br/>    bind(Animal.<strong class="lu ir">class</strong>).to(MockAnimal.<strong class="lu ir">class</strong>);<br/>  }<br/>}</span></pre><p id="610b" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">MockAnimal 类实现了第 1 部分示例中的 Animal 接口:</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="5947" class="ly jo iq lu b gy lz ma l mb mc"><strong class="lu ir">import </strong>javax.inject.Inject;<br/><br/><strong class="lu ir">public class </strong>MockAnimal <strong class="lu ir">implements </strong>Animal {<br/><br/>  @Inject<br/>  MockAnimal() {}<br/><br/>  @Override<br/>  <strong class="lu ir">public </strong>String voice() {<br/>    <strong class="lu ir">return "This is a mock animal"</strong>;<br/>  }<br/>}</span></pre><p id="298d" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">这是真正的动画课:</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="a1e3" class="ly jo iq lu b gy lz ma l mb mc"><strong class="lu ir">import </strong>com.google.inject.Guice;<br/><strong class="lu ir">import </strong>javax.inject.Inject;<br/><strong class="lu ir">import </strong>org.junit.Assert;<br/><strong class="lu ir">import </strong>org.junit.Before;<br/><strong class="lu ir">import </strong>org.junit.Test;<br/><strong class="lu ir">import </strong>org.junit.runner.RunWith;<br/><strong class="lu ir">import </strong>org.junit.runners.JUnit4;<br/><strong class="lu ir">import static </strong>org.hamcrest.CoreMatchers.<em class="md">instanceOf</em>;<br/><strong class="lu ir">import static </strong>org.junit.Assert.<em class="md">assertThat</em>;</span><span id="17f0" class="ly jo iq lu b gy me ma l mb mc">@RunWith(JUnit4.<strong class="lu ir">class</strong>)<br/><strong class="lu ir">public final class </strong>AnimalTest {<br/>  @Inject ZooKeeper <strong class="lu ir">zooKeeper</strong>;<br/><br/>  @Before<br/>  <strong class="lu ir">public void </strong>setup() {<br/>    Guice.<em class="md">createInjector</em>(<strong class="lu ir">new </strong>AnimalTestModule()).injectMembers(<strong class="lu ir">this</strong>);<br/>  }<br/><br/>  @Test<br/>  <strong class="lu ir">public void </strong>testAnimal() <strong class="lu ir">throws </strong>Exception {<br/>    Assert.<em class="md">assertNotNull</em>( <strong class="lu ir">"This object should not be null"</strong>, <strong class="lu ir">zooKeeper</strong>);<br/>    <em class="md">assertThat</em>(<strong class="lu ir">zooKeeper</strong>.getAnimal(), <em class="md">instanceOf</em>(MockAnimal.<strong class="lu ir">class</strong>));<br/>  }<br/>}</span></pre><p id="e27a" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">AnimalTest 类的输出:</p><figure class="lp lq lr ls gt mg gh gi paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="gh gi mf"><img src="../Images/51ea403d6f3a126354259869bf502dd9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wPkJBZXXk894dBbdeNctEw.png"/></div></div><figcaption class="mn mo gj gh gi mp mq bd b be z dk translated">测试用例通过</figcaption></figure><h1 id="b1d5" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">摘要</h1><p id="c6ba" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">本系列第 1 部分和第 2 部分中涉及的 Guice 功能足以支持真实项目中的大多数用例。当然，Guice 还有其他一些特性。然而，这将增加一些复杂性，所以如果我们可以避免他们，如果可能的话。这些是 Guice 的一些高级功能，可以考虑未来的学习:Guice 中的<a class="ae lj" href="https://github.com/google/guice/wiki/AssistedInject" rel="noopener ugc nofollow" target="_blank">辅助对象</a>，多绑定<a class="ae lj" href="https://github.com/google/guice/wiki/Multibindings" rel="noopener ugc nofollow" target="_blank">等。</a></p></div><div class="ab cl mr ms hu mt" role="separator"><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw"/></div><div class="ij ik il im in"><p id="5399" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">如果你喜欢这个故事，请<a class="ae lj" href="https://medium.com/@techisbeautiful" rel="noopener">关注</a>，<a class="ae lj" href="https://medium.com/subscribe/@techisbeautiful" rel="noopener">订阅我</a>成为第一个收到我下一个故事的电子邮件的人。</p><p id="9af3" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated"><a class="ae lj" href="https://medium.com/@techisbeautiful/membership" rel="noopener">你可以在这里</a>成为媒介会员，就可以<strong class="kn ir">无限制访问</strong>媒介平台上的每一个故事。如果你使用上面的链接，它也支持我，因为我有一个来自 Medium 的小佣金。谢谢大家！</p><h1 id="184d" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated"><strong class="ak">参考文献</strong></h1><p id="6cd3" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">[1]<a class="ae lj" href="https://github.com/google/guice" rel="noopener ugc nofollow" target="_blank">https://github.com/google/guice</a></p></div></div>    
</body>
</html>