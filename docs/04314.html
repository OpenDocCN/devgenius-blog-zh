<html>
<head>
<title>Server-Side Development with Fastify — Event and Error Hooks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Fastify进行服务器端开发——事件和错误挂钩</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/server-side-development-with-fastify-event-and-error-hooks-19852a848aed?source=collection_archive---------1-----------------------#2021-02-26">https://blog.devgenius.io/server-side-development-with-fastify-event-and-error-hooks-19852a848aed?source=collection_archive---------1-----------------------#2021-02-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/517ffc9b31efef29e83945c88041e06e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*iNDKj_AvRwL2f409"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated"><a class="ae kc" href="https://unsplash.com/@productschool?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">产品学校</a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="7329" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Fastify是一个用于开发后端web应用程序的小型节点框架。</p><p id="af85" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将了解如何使用Fastify创建后端应用程序。</p><h1 id="3759" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">翁森</h1><p id="7714" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以用<code class="fe me mf mg mh b">onSend</code>钩子改变发送的响应负载。</p><p id="2a99" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="fedb" class="mq lc iq mh b gy mr ms l mt mu">const fastify = require('fastify')({})</span><span id="74ff" class="mq lc iq mh b gy mv ms l mt mu">fastify.addHook('onSend', (request, reply, payload, done) =&gt; {<br/>  const err = null;<br/>  const newPayload = payload.replace('some-text', 'some-new-text')<br/>  done(err, newPayload)<br/>})<br/>const start = async () =&gt; {<br/>  try {<br/>    fastify.get('/', function (request, reply) {<br/>      reply.send('some-text')<br/>    })<br/>    await fastify.listen(3000, '0.0.0.0')  <br/>  } catch (err) {<br/>    fastify.log.error(err)    <br/>    process.exit(1)<br/>  }<br/>}<br/>start()</span></pre><p id="1975" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们用<code class="fe me mf mg mh b">'some-new-text'</code>代替<code class="fe me mf mg mh b">'some-text'</code>响应。</p><p id="1bea" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，当我们向<code class="fe me mf mg mh b">/</code>发出GET请求时，我们看到<code class="fe me mf mg mh b">'some-new-text’</code>被返回。</p><p id="5d4a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">同样，我们可以用一个<code class="fe me mf mg mh b">async</code>函数做同样的事情:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="6c78" class="mq lc iq mh b gy mr ms l mt mu">const fastify = require('fastify')({})</span><span id="7049" class="mq lc iq mh b gy mv ms l mt mu">fastify.addHook('onSend', async (request, reply, payload) =&gt; {<br/>  const newPayload = payload.replace('some-text', 'some-new-text')<br/>  return newPayload<br/>})</span><span id="1d73" class="mq lc iq mh b gy mv ms l mt mu">const start = async () =&gt; {<br/>  try {<br/>    fastify.get('/', function (request, reply) {<br/>      reply.send('some-text')<br/>    })<br/>    await fastify.listen(3000, '0.0.0.0')  <br/>  } catch (err) {<br/>    fastify.log.error(err)    <br/>    process.exit(1)<br/>  }<br/>}<br/>start()</span></pre><p id="ac8e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们还可以使用以下命令删除响应负载:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="e080" class="mq lc iq mh b gy mr ms l mt mu">const fastify = require('fastify')({})</span><span id="217b" class="mq lc iq mh b gy mv ms l mt mu">fastify.addHook('onSend', (request, reply, payload, done) =&gt; {<br/>  reply.code(304)<br/>  const newPayload = null<br/>  done(null, newPayload)<br/>})</span><span id="652b" class="mq lc iq mh b gy mv ms l mt mu">const start = async () =&gt; {<br/>  try {<br/>    fastify.get('/', function (request, reply) {<br/>      reply.send('some-text')<br/>    })<br/>    await fastify.listen(3000, '0.0.0.0')  <br/>  } catch (err) {<br/>    fastify.log.error(err)    <br/>    process.exit(1)<br/>  }<br/>}<br/>start()</span></pre><h1 id="9a2b" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">响应时</h1><p id="985b" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">当一个响应被发送时,<code class="fe me mf mg mh b">onResponse</code>钩子让我们运行代码。</p><p id="716f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是一个收集统计数据的有用地方。</p><p id="fc62" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="fcbd" class="mq lc iq mh b gy mr ms l mt mu">const fastify = require('fastify')({})</span><span id="720a" class="mq lc iq mh b gy mv ms l mt mu">fastify.addHook('onResponse', (request, reply, done) =&gt; {  <br/>  console.log(reply)<br/>  done()<br/>})</span><span id="19ec" class="mq lc iq mh b gy mv ms l mt mu">const start = async () =&gt; {<br/>  try {<br/>    fastify.get('/', function (request, reply) {<br/>      reply.send('some-text')<br/>    })<br/>    await fastify.listen(3000, '0.0.0.0')  <br/>  } catch (err) {<br/>    fastify.log.error(err)    <br/>    process.exit(1)<br/>  }<br/>}<br/>start()</span></pre><p id="1fa2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">来记录<code class="fe me mf mg mh b">reply</code>。</p><p id="c496" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们也可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="51b7" class="mq lc iq mh b gy mr ms l mt mu">const fastify = require('fastify')({})</span><span id="703c" class="mq lc iq mh b gy mv ms l mt mu">fastify.addHook('onResponse', async (request, reply) =&gt; {<br/>  console.log(reply)  <br/>  return<br/>})</span><span id="adcd" class="mq lc iq mh b gy mv ms l mt mu">const start = async () =&gt; {<br/>  try {<br/>    fastify.get('/', function (request, reply) {<br/>      reply.send('some-text')<br/>    })<br/>    await fastify.listen(3000, '0.0.0.0')  <br/>  } catch (err) {<br/>    fastify.log.error(err)    <br/>    process.exit(1)<br/>  }<br/>}<br/>start()</span></pre><p id="756d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">做同样的事情。</p><h1 id="c512" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">准时结束</h1><p id="858d" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated"><code class="fe me mf mg mh b">onTimeout</code>钩子让我们监控请求超时。</p><p id="5e3d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以这样使用它:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="0b9b" class="mq lc iq mh b gy mr ms l mt mu">const fastify = require('fastify')({})</span><span id="190f" class="mq lc iq mh b gy mv ms l mt mu">fastify.addHook('onTimeout', (request, reply, done) =&gt; {<br/>  console.log('timed out')<br/>  done()<br/>})</span><span id="cbc3" class="mq lc iq mh b gy mv ms l mt mu">const start = async () =&gt; {<br/>  try {<br/>    fastify.get('/', function (request, reply) {<br/>      reply.send('some-text')<br/>    })<br/>    await fastify.listen(3000, '0.0.0.0')  <br/>  } catch (err) {<br/>    fastify.log.error(err)    <br/>    process.exit(1)<br/>  }<br/>}<br/>start()</span></pre><p id="854e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">或者:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="0e1f" class="mq lc iq mh b gy mr ms l mt mu">const fastify = require('fastify')({})</span><span id="c66c" class="mq lc iq mh b gy mv ms l mt mu">fastify.addHook('onTimeout', async (request, reply) =&gt; {<br/>  console.log('timed out')<br/>  return<br/>})</span><span id="49f7" class="mq lc iq mh b gy mv ms l mt mu">const start = async () =&gt; {<br/>  try {<br/>    fastify.get('/', function (request, reply) {<br/>      reply.send('some-text')<br/>    })<br/>    await fastify.listen(3000, '0.0.0.0')  <br/>  } catch (err) {<br/>    fastify.log.error(err)    <br/>    process.exit(1)<br/>  }<br/>}<br/>start()</span></pre><p id="f92c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">记录任何请求超时。</p><h1 id="ea5f" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">管理钩子中的错误</h1><p id="e9bf" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以在钩子中抛出错误，如果有任何错误，就返回错误响应。</p><p id="5a30" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="3ab4" class="mq lc iq mh b gy mr ms l mt mu">const fastify = require('fastify')({})</span><span id="7a9c" class="mq lc iq mh b gy mv ms l mt mu">fastify.addHook('preHandler', (request, reply, done) =&gt; {<br/>  reply.code(400)<br/>  done(new Error('Some error'))<br/>})</span><span id="bf03" class="mq lc iq mh b gy mv ms l mt mu">const start = async () =&gt; {<br/>  try {<br/>    fastify.get('/', function (request, reply) {<br/>      reply.send('some-text')<br/>    })<br/>    await fastify.listen(3000, '0.0.0.0')  <br/>  } catch (err) {<br/>    fastify.log.error(err)    <br/>    process.exit(1)<br/>  }<br/>}<br/>start()</span></pre><p id="18b4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">添加<code class="fe me mf mg mh b">preHandler</code>钩子并返回400个错误。</p><p id="02a6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们还可以在<code class="fe me mf mg mh b">done</code>函数中传递一个<code class="fe me mf mg mh b">Error</code>实例。</p><p id="a36e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="72b6" class="mq lc iq mh b gy mr ms l mt mu">const fastify = require('fastify')({})</span><span id="7ac2" class="mq lc iq mh b gy mv ms l mt mu">fastify.addHook('onResponse', async (request, reply) =&gt; {<br/>  throw new Error('Some error')<br/>})</span><span id="ac49" class="mq lc iq mh b gy mv ms l mt mu">const start = async () =&gt; {<br/>  try {<br/>    fastify.get('/', function (request, reply) {<br/>      reply.send('some-text')<br/>    })<br/>    await fastify.listen(3000, '0.0.0.0')  <br/>  } catch (err) {<br/>    fastify.log.error(err)    <br/>    process.exit(1)<br/>  }<br/>}<br/>start()</span></pre><p id="d515" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">用<code class="fe me mf mg mh b">async</code>功能做同样的事情。</p><h1 id="5e8a" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="1507" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以用Fastify添加各种钩子来处理事件和错误。</p></div></div>    
</body>
</html>