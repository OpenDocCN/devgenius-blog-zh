<html>
<head>
<title>How to Connect Database to a Flask App -Part 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何将数据库连接到 Flask 应用程序——第 2 部分</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/how-to-connect-database-to-a-flask-app-part-2-a7e948cbb8dd?source=collection_archive---------5-----------------------#2022-05-13">https://blog.devgenius.io/how-to-connect-database-to-a-flask-app-part-2-a7e948cbb8dd?source=collection_archive---------5-----------------------#2022-05-13</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="e80a" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">通过 SQLAlchemy |集成 Flask WTForms 将 SQLite 数据库连接到 Flask 应用程序</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/d137848d57193b941b8fd0ad782ce121.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ieXaavHBhInXJiKyK4RTEA.jpeg"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk translated">埃米尔·佩龙在<a class="ae ks" href="https://unsplash.com/s/photos/code?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><h1 id="096f" class="kt ku in bd kv kw kx ky kz la lb lc ld jt le ju lf jw lg jx lh jz li ka lj lk bi translated">介绍</h1><p id="5961" class="pw-post-body-paragraph ll lm in ln b lo lp jo lq lr ls jr lt lu lv lw lx ly lz ma mb mc md me mf mg ig bi translated">这是本系列的第 2 部分，在本文中，我将从第 1 部分停止的地方完成其余的验证。如果你错过了前面的部分，请在继续之前，点击下面的链接并参考它。</p><div class="mh mi gp gr mj mk"><a rel="noopener  ugc nofollow" target="_blank" href="/how-to-connect-database-to-a-flask-app-part-1-60611deea17a"><div class="ml ab fo"><div class="mm ab mn cl cj mo"><h2 class="bd io gy z fp mp fr fs mq fu fw im bi translated">如何将数据库连接到 Flask 应用程序——第 1 部分</h2><div class="mr l"><h3 class="bd b gy z fp mp fr fs mq fu fw dk translated">通过 SQLAlchemy 将 SQLite 数据库连接到 Flask 应用程序</h3></div><div class="ms l"><p class="bd b dl z fp mp fr fs mq fu fw dk translated">blog.devgenius.io</p></div></div><div class="mt l"><div class="mu l mv mw mx mt my km mk"/></div></div></a></div><p id="6792" class="pw-post-body-paragraph ll lm in ln b lo mz jo lq lr na jr lt lu nb lw lx ly nc ma mb mc nd me mf mg ig bi translated">正如我在上一篇文章中提到的，我将安装<strong class="ln io"> Flask WTForms </strong>并创建单独的<code class="fe ne nf ng nh b">forms</code>和<code class="fe ne nf ng nh b">models</code>配置文件。但在此之前，我将在应用程序的根目录中创建一个与根目录同名的新目录。</p><pre class="kd ke kf kg gt ni nh nj nk aw nl bi"><span id="fa2d" class="nm ku in nh b gy nn no l np nq">root directory -&gt; Flask_DB</span><span id="195d" class="nm ku in nh b gy nr no l np nq">directory inside -&gt; Flask_DB</span></pre></div><div class="ab cl ns nt hr nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="ig ih ii ij ik"><h1 id="1c4e" class="kt ku in bd kv kw nz ky kz la oa lc ld jt ob ju lf jw oc jx lh jz od ka lj lk bi translated">将现有文件移动到新目录</h1><p id="f391" class="pw-post-body-paragraph ll lm in ln b lo lp jo lq lr ls jr lt lu lv lw lx ly lz ma mb mc md me mf mg ig bi translated">我们需要将现有的<code class="fe ne nf ng nh b">statis</code>、<code class="fe ne nf ng nh b">templates</code>目录和<code class="fe ne nf ng nh b">sqlite DB</code>目录移动到新创建的<code class="fe ne nf ng nh b">Flask_DB</code>目录中。</p><p id="6869" class="pw-post-body-paragraph ll lm in ln b lo mz jo lq lr na jr lt lu nb lw lx ly nc ma mb mc nd me mf mg ig bi translated">之后，我们需要在这个目录中创建 3 个 python 配置文件，如<code class="fe ne nf ng nh b">forms.py</code>、<code class="fe ne nf ng nh b">models.py</code>和<code class="fe ne nf ng nh b">routes.py</code>。</p><p id="663d" class="pw-post-body-paragraph ll lm in ln b lo mz jo lq lr na jr lt lu nb lw lx ly nc ma mb mc nd me mf mg ig bi translated">然后，我们在目录中创建另一个名为<code class="fe ne nf ng nh b">__init__.py</code>的 python 配置文件。现在我们已经将所有需要的配置文件添加到目录中，当您运行<code class="fe ne nf ng nh b">tree</code>命令时，它应该看起来像这样。</p><pre class="kd ke kf kg gt ni nh nj nk aw nl bi"><span id="8f1e" class="nm ku in nh b gy nn no l np nq">.<br/>├── __init__.py<br/>├── db.sqlite3<br/>├── forms.py<br/>├── models.py<br/>├── routes.py<br/>├── static<br/>└── templates<br/>    ├── base.html<br/>    ├── home.html<br/>    ├── login.html<br/>    └── register.html</span></pre><p id="56ba" class="pw-post-body-paragraph ll lm in ln b lo mz jo lq lr na jr lt lu nb lw lx ly nc ma mb mc nd me mf mg ig bi translated">但是我们的<code class="fe ne nf ng nh b">app.py</code>配置文件仍然在根目录中，我们需要将其重命名为<code class="fe ne nf ng nh b">run.py</code>。现在我们几乎完成了配置文件的移动和重命名。因此，我们可以开始更新现有的文件，以完成我们的应用程序的验证部分。</p></div><div class="ab cl ns nt hr nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="ig ih ii ij ik"><h1 id="e462" class="kt ku in bd kv kw nz ky kz la oa lc ld jt ob ju lf jw oc jx lh jz od ka lj lk bi translated">更新<code class="fe ne nf ng nh b">run.py file</code></h1><p id="b177" class="pw-post-body-paragraph ll lm in ln b lo lp jo lq lr ls jr lt lu lv lw lx ly lz ma mb mc md me mf mg ig bi translated">这里，我们需要将这个文件设置为起点，并将其他配置移动到我们新创建的配置文件中。因此，新的<code class="fe ne nf ng nh b">run.py</code>文件如下所示。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="oe of l"/></div></figure><p id="5dde" class="pw-post-body-paragraph ll lm in ln b lo mz jo lq lr na jr lt lu nb lw lx ly nc ma mb mc nd me mf mg ig bi translated">[如果您在应用程序中设置了一个<code class="fe ne nf ng nh b">.flaskenv</code>文件，它也需要修改如下]</p><pre class="kd ke kf kg gt ni nh nj nk aw nl bi"><span id="4c7b" class="nm ku in nh b gy nn no l np nq">FLASK_ENV=development<br/>FLASK_APP=run.py</span></pre></div><div class="ab cl ns nt hr nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="ig ih ii ij ik"><h1 id="c265" class="kt ku in bd kv kw nz ky kz la oa lc ld jt ob ju lf jw oc jx lh jz od ka lj lk bi translated">正在更新 __init__。py 文件</h1><p id="37fa" class="pw-post-body-paragraph ll lm in ln b lo lp jo lq lr ls jr lt lu lv lw lx ly lz ma mb mc md me mf mg ig bi translated">新的<code class="fe ne nf ng nh b">__init__.py</code>配置文件如下所示，这里我们已经将所有的<code class="fe ne nf ng nh b">models</code>和<code class="fe ne nf ng nh b">routes</code>移动到不同的配置文件中，其余的将驻留在这里。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="oe of l"/></div></figure></div><div class="ab cl ns nt hr nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="ig ih ii ij ik"><h1 id="7639" class="kt ku in bd kv kw nz ky kz la oa lc ld jt ob ju lf jw oc jx lh jz od ka lj lk bi translated">更新 models.py 文件</h1><p id="75a5" class="pw-post-body-paragraph ll lm in ln b lo lp jo lq lr ls jr lt lu lv lw lx ly lz ma mb mc md me mf mg ig bi translated">之前，我们在<code class="fe ne nf ng nh b">app.py</code>配置文件中创建了用户模型。我们可以直接将该部分移动到<code class="fe ne nf ng nh b">models.py</code>配置文件中，并导入必要的包，如下面的代码片段所示。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="oe of l"/></div></figure></div><div class="ab cl ns nt hr nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="ig ih ii ij ik"><h1 id="92b3" class="kt ku in bd kv kw nz ky kz la oa lc ld jt ob ju lf jw oc jx lh jz od ka lj lk bi translated">安装烧瓶 WTForms</h1><p id="c1d6" class="pw-post-body-paragraph ll lm in ln b lo lp jo lq lr ls jr lt lu lv lw lx ly lz ma mb mc md me mf mg ig bi translated">使用 Flask WTForms，我们可以很容易地创建表单并在<code class="fe ne nf ng nh b">HTML</code>配置文件中显示它们。之前，我们使用通用的<code class="fe ne nf ng nh b">HTML</code>元素和<code class="fe ne nf ng nh b">Bootstrap</code>配置了我们的<code class="fe ne nf ng nh b">registration</code>和<code class="fe ne nf ng nh b">login</code>页面。但是当您安装 Flask WTForms 时，您可以非常容易地生成它们。</p><p id="146b" class="pw-post-body-paragraph ll lm in ln b lo mz jo lq lr na jr lt lu nb lw lx ly nc ma mb mc nd me mf mg ig bi translated">因此，首先，您需要在您的虚拟环境中安装 Flask WTForms，然后我们可以开始在<code class="fe ne nf ng nh b">forms.py</code>文件中创建我们自己的表单。要安装 Flask WTForms，请使用下面的命令。</p><pre class="kd ke kf kg gt ni nh nj nk aw nl bi"><span id="4969" class="nm ku in nh b gy nn no l np nq">pip install Flask-WTF </span></pre><p id="0c4f" class="pw-post-body-paragraph ll lm in ln b lo mz jo lq lr na jr lt lu nb lw lx ly nc ma mb mc nd me mf mg ig bi translated">然后将下面的代码添加到您的<code class="fe ne nf ng nh b">forms.py</code>配置文件中。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="oe of l"/></div></figure><p id="ebef" class="pw-post-body-paragraph ll lm in ln b lo mz jo lq lr na jr lt lu nb lw lx ly nc ma mb mc nd me mf mg ig bi translated">现在我们已经成功创建了表单，接下来我们需要根据表单修改<code class="fe ne nf ng nh b">register.html</code>和<code class="fe ne nf ng nh b">login.html</code>文件。使用下面的代码片段<em class="og">【你可以通过</em> <a class="ae ks" href="https://flask-wtf.readthedocs.io/en/1.0.x/" rel="noopener ugc nofollow" target="_blank"> <em class="og">这个网站</em> </a> <em class="og">找到更多关于 Flask WTForms 的信息】。</em></p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="oe of l"/></div></figure><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="oe of l"/></div></figure></div><div class="ab cl ns nt hr nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="ig ih ii ij ik"><h1 id="f281" class="kt ku in bd kv kw nz ky kz la oa lc ld jt ob ju lf jw oc jx lh jz od ka lj lk bi translated">添加验证</h1><p id="fdcd" class="pw-post-body-paragraph ll lm in ln b lo lp jo lq lr ls jr lt lu lv lw lx ly lz ma mb mc md me mf mg ig bi translated">在我们的 Flask 应用程序中，我们需要确保一个<strong class="ln io">用户名或一个</strong>电子邮件不能在两个用户之间重复。简单地说，用户名和电子邮件是唯一的字段，在数据库中不能重复。</p><p id="c5b4" class="pw-post-body-paragraph ll lm in ln b lo mz jo lq lr na jr lt lu nb lw lx ly nc ma mb mc nd me mf mg ig bi translated">为了确保这一点，我们可以在<code class="fe ne nf ng nh b">forms.py</code>文件中应用以下函数来验证这两个条件，如下所示。</p><pre class="kd ke kf kg gt ni nh nj nk aw nl bi"><span id="e9e0" class="nm ku in nh b gy nn no l np nq">def validate_username(self, username):<br/>  user = User.query.filter_by(username=username.data).first()<br/>  if user:<br/>    raise ValidationError('That username is taken. Please choose a different one.')<br/></span><span id="4a02" class="nm ku in nh b gy nr no l np nq">def validate_email(self, email):<br/>  user = User.query.filter_by(email=email.data).first()<br/>  if user:<br/>    raise ValidationError('That email is taken. Please choose a different one.')</span></pre><p id="17cf" class="pw-post-body-paragraph ll lm in ln b lo mz jo lq lr na jr lt lu nb lw lx ly nc ma mb mc nd me mf mg ig bi translated">因此，完成的<code class="fe ne nf ng nh b">forms.py</code>文件如下所示。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="oe of l"/></div></figure></div><div class="ab cl ns nt hr nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="ig ih ii ij ik"><h1 id="4bc8" class="kt ku in bd kv kw nz ky kz la oa lc ld jt ob ju lf jw oc jx lh jz od ka lj lk bi translated">更新 routes.py 文件</h1><p id="a357" class="pw-post-body-paragraph ll lm in ln b lo lp jo lq lr ls jr lt lu lv lw lx ly lz ma mb mc md me mf mg ig bi translated">最后，我们来到了我们的<code class="fe ne nf ng nh b">routes.py</code>文件，这是一个配置文件，其中包含了我们在应用程序中的所有路线。该文件包含与之前相同的路线，但是我们需要修改该文件中的<code class="fe ne nf ng nh b">login</code>和<code class="fe ne nf ng nh b">register</code>路线。</p><p id="d78c" class="pw-post-body-paragraph ll lm in ln b lo mz jo lq lr na jr lt lu nb lw lx ly nc ma mb mc nd me mf mg ig bi translated">让我们先创建我们的<code class="fe ne nf ng nh b">register</code>路线。</p><pre class="kd ke kf kg gt ni nh nj nk aw nl bi"><span id="83fe" class="nm ku in nh b gy nn no l np nq">@app.route('/register', methods=['GET', 'POST'])<br/>def register():<br/>  form = RegistrationForm()<br/>  if form.validate_on_submit():<br/>    username = form.username.data<br/>    email = form.email.data<br/>    password = form.password.data</span><span id="5752" class="nm ku in nh b gy nr no l np nq">    new_user = User(username=username, email=email, password=password)</span><span id="32be" class="nm ku in nh b gy nr no l np nq">    db.session.add(new_user)<br/>    db.session.commit()</span><span id="2dc2" class="nm ku in nh b gy nr no l np nq">    flash('Successfully Registered!, You are now able to log in', 'success') <br/>    return redirect(url_for('login'))</span><span id="e819" class="nm ku in nh b gy nr no l np nq">return render_template('register.html', title='Register', form=form)</span></pre><p id="929a" class="pw-post-body-paragraph ll lm in ln b lo mz jo lq lr na jr lt lu nb lw lx ly nc ma mb mc nd me mf mg ig bi translated">然后我们可以开始修改<code class="fe ne nf ng nh b">login</code>路线</p><pre class="kd ke kf kg gt ni nh nj nk aw nl bi"><span id="1b59" class="nm ku in nh b gy nn no l np nq">@app.route('/login', methods=['GET', 'POST'])<br/>def login():<br/>  form = LoginForm()</span><span id="0fca" class="nm ku in nh b gy nr no l np nq">  if form.validate_on_submit():<br/>    user = User.query.filter_by(email=form.email.data).first()<br/>    if user and user.password == form.password.data:<br/>      return redirect(url_for('home'))<br/>    else: <br/>      flash('Login Unsuccessful. Please check username and password', 'danger')</span><span id="7d27" class="nm ku in nh b gy nr no l np nq">return render_template('login.html', title='Login', form=form)</span></pre><p id="d930" class="pw-post-body-paragraph ll lm in ln b lo mz jo lq lr na jr lt lu nb lw lx ly nc ma mb mc nd me mf mg ig bi translated">因此，我们完成的<code class="fe ne nf ng nh b">routes.py</code>文件如下所示。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="oe of l"/></div></figure><p id="9a15" class="pw-post-body-paragraph ll lm in ln b lo mz jo lq lr na jr lt lu nb lw lx ly nc ma mb mc nd me mf mg ig bi translated">您已成功完成剩余的验证，您的数据库和路线将正常工作。</p></div><div class="ab cl ns nt hr nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="ig ih ii ij ik"><h1 id="a780" class="kt ku in bd kv kw nz ky kz la oa lc ld jt ob ju lf jw oc jx lh jz od ka lj lk bi translated">参考</h1><ul class=""><li id="ad28" class="oh oi in ln b lo lp lr ls lu oj ly ok mc ol mg om on oo op bi translated"><a class="ae ks" href="https://flask-wtf.readthedocs.io/en/1.0.x/" rel="noopener ugc nofollow" target="_blank">烧瓶 WTForms </a></li><li id="ec05" class="oh oi in ln b lo oq lr or lu os ly ot mc ou mg om on oo op bi translated"><a class="ae ks" href="https://www.digitalocean.com/community/tutorials/how-to-use-and-validate-web-forms-with-flask-wtf" rel="noopener ugc nofollow" target="_blank">如何通过 Flask-WTF 使用和验证 Web 表单</a></li></ul></div><div class="ab cl ns nt hr nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="ig ih ii ij ik"><p id="73ef" class="pw-post-body-paragraph ll lm in ln b lo mz jo lq lr na jr lt lu nb lw lx ly nc ma mb mc nd me mf mg ig bi translated"><strong class="ln io">感谢您的阅读！</strong></p><p id="239f" class="pw-post-body-paragraph ll lm in ln b lo mz jo lq lr na jr lt lu nb lw lx ly nc ma mb mc nd me mf mg ig bi translated"><strong class="ln io">快乐编码！</strong>👨🏻‍💻</p></div></div>    
</body>
</html>