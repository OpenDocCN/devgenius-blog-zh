<html>
<head>
<title>AWS Parameters Store: Alternative to storing secret values</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS 参数存储:存储秘密值的替代方法</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/aws-parameters-store-another-way-to-store-secret-values-e586d7013a9b?source=collection_archive---------3-----------------------#2020-06-03">https://blog.devgenius.io/aws-parameters-store-another-way-to-store-secret-values-e586d7013a9b?source=collection_archive---------3-----------------------#2020-06-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/f7377ab5897fb308aa2c9483cef65680.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*oOiaSRW13siD3t14"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">照片由<a class="ae kc" href="https://unsplash.com/@jordanharrison?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">乔丹·哈里森</a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="cc78" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这篇文章并不是说 AWS 参数存储(PS)是存储项目秘密值的最安全的方式。这只是一个关于存储值的另一种(相对安全的)方法的简介。</p><p id="1c36" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您必须已经将项目秘密值存储在某个文件夹中，或者在执行 run 命令时将其导出，或者最糟糕的是，将它们存储在您的代码中。AWS PS 允许您实时获取这些值。</p><p id="78f3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Parameters Store 是一个非常简单的设置和获取服务，您可以通过控制台或 cli 直接在 AWS 上添加参数，然后通过 aws-sdk 或 cli 获取参数。让我们看一个存储 PostgreSQL 凭据的示例:</p><h1 id="cff8" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">设置参数</h1><p id="908e" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">登录 AWS 控制台，在“服务”下，转到“系统管理器”。在左侧面板的应用程序管理下，您会看到参数存储。选择后，点击创建参数。</p><p id="b881" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们在这里添加数据库主机 URL。我们将在这里选择类型为<strong class="kf ir">字符串</strong>，数据类型为<strong class="kf ir">文本</strong></p><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div class="gh gi me"><img src="../Images/2b5ae24ddaeb036c7c6b11a7fae8ec06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/format:webp/1*sfMZIbpQ-mksGck-1nwXKQ.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">添加数据库的主机 URL</figcaption></figure><p id="85d8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们将密码设置为一个<strong class="kf ir">安全字符串</strong>，它将使用 AWS KMS 密钥将密码存储为加密文本。</p><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div class="gh gi me"><img src="../Images/b8d1795697af377ac0ed540bb53f9d16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/format:webp/1*dLEOjpHsCe6ulgkLpswHCA.png"/></div></figure><p id="50e2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">添加参数后，您的控制台将如下所示。当我们获取它时，键的命名将更有意义。</p><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mj"><img src="../Images/5ade57e210237f350e279a28d851b27a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_CtSogUe9E_GaF7uvRuZEw.png"/></div></div></figure><h1 id="5d3b" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">获取参数</h1><p id="8e53" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">您可以在代码中使用 aws cli 或 aws-sdk 获取这些参数。现在，我们将使用 aws cli。</p><p id="426f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将使用以下命令获取我的 postgre 生产数据库的所有参数:</p><pre class="mf mg mh mi gt mk ml mm mn aw mo bi"><span id="8670" class="mp lc iq ml b gy mq mr l ms mt"><em class="mu">aws ssm get-parameters-by-path --path “/production/postgre/” <br/>--recursive —-output text</em></span></pre><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mv"><img src="../Images/9fce6367ee23fc1509fa3587f01f9946.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gYchlVX2ZlUcG3Gr2xotpA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">带有加密密码文本的结果</figcaption></figure><h1 id="a218" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">我们做了什么，得到了什么？</h1><h2 id="c5df" class="mp lc iq bd ld mw mx dn lh my mz dp ll ko na nb lp ks nc nd lt kw ne nf lx ng bi translated"><strong class="ak">输入</strong></h2><p id="b1a4" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated"><strong class="kf ir"> aws ssm </strong>:使用 aws cli 访问 Systems Manager 服务。</p><p id="f523" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> get-parameters-by-path </strong>:我们提到我们想要获得路径下的所有键名。我们将键命名为路径，这样一个环境的所有子键名都可以在一个路径下。</p><p id="0419" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">—Path "/production/postgre/"</strong>:我们要从中提取的路径</p><p id="d12d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> —递归</strong>:检索一个层次内的所有参数</p><p id="dead" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> <em class="mu"> — </em>输出文本</strong> <em class="mu"> : </em>明确提到输出应该显示为文本而不是 json。这将覆盖 aws 配置文件中的输出设置。</p><h2 id="992c" class="mp lc iq bd ld mw mx dn lh my mz dp ll ko na nb lp ks nc nd lt kw ne nf lx ng bi translated"><strong class="ak">输出</strong></h2><p id="2538" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">在上面的截图中，我只显示了相关的信息，包括键名、数据类型和键值。如果你注意到，我们设置我们的密码为<em class="mu"> PASSWORD_12345 </em>但是我们得到了一个加密文本<em class="mu"> Lmp……Ji== </em>。为了获取解密值，我们在命令<strong class="kf ir"> <em class="mu"> — with-decryption </em> </strong>中增加了一个选项</p><p id="5c85" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所以我们最后的命令是:</p><pre class="mf mg mh mi gt mk ml mm mn aw mo bi"><span id="1883" class="mp lc iq ml b gy mq mr l ms mt"><em class="mu">aws ssm get-parameters-by-path --path “/production/postgre/” <br/>--recursive —-output text —-with-decryption</em></span></pre><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nh"><img src="../Images/c3ad104d3aee6cf7a12d97ce3c48c88f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6OevsrmMyyG4srmtGyFr7w.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">使用解密的密码文本提取的结果</figcaption></figure><h2 id="9f0c" class="mp lc iq bd ld mw mx dn lh my mz dp ll ko na nb lp ks nc nd lt kw ne nf lx ng bi translated">我们如何利用这些？</h2><p id="12b1" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我认为有两种方法可以使用参数存储。</p><ol class=""><li id="8206" class="ni nj iq kf b kg kh kk kl ko nk ks nl kw nm la nn no np nq bi translated">在应用程序的入口文件中，在启动主应用程序之前，调用一个使用 aws-sdk 的方法来获取这些参数并在代码中使用。</li></ol><pre class="mf mg mh mi gt mk ml mm mn aw mo bi"><span id="747f" class="mp lc iq ml b gy mq mr l ms mt">const result = await ssm.getParametersByPath({</span><span id="8257" class="mp lc iq ml b gy nr mr l ms mt">                            Path: fetchPath,</span><span id="b3ed" class="mp lc iq ml b gy nr mr l ms mt">                            WithDecryption: true,</span><span id="0be5" class="mp lc iq ml b gy nr mr l ms mt">                            MaxResults: 10,</span><span id="31d9" class="mp lc iq ml b gy nr mr l ms mt">                            NextToken: token</span><span id="e9d3" class="mp lc iq ml b gy nr mr l ms mt">               }).promise();</span></pre><p id="3a70" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">2.编写一个 shell 脚本，获取这些参数，并在启动之前将其导出到您的应用程序中。</p><pre class="mf mg mh mi gt mk ml mm mn aw mo bi"><span id="291e" class="mp lc iq ml b gy mq mr l ms mt"># Prints result of aws command</span><span id="0faf" class="mp lc iq ml b gy nr mr l ms mt">for result_row in $(aws ssm get-parameters-by-path — path “$path” — recursive — with-decryption — output text); do</span><span id="dc6b" class="mp lc iq ml b gy nr mr l ms mt">    echo $result_row<br/>done</span></pre><h1 id="d1b7" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">注意:</h1><p id="1d7b" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">这只是一个设置和获取的例子。命名密钥、获取技术、加密和解密有不同的方式，每种方式都取决于特定的应用程序部署过程。</p><p id="2c13" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae kc" href="https://aws.amazon.com/secrets-manager/" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir"> AWS 秘密管理器</strong> </a>你可能也会感兴趣。</p></div></div>    
</body>
</html>