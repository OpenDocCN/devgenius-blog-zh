<html>
<head>
<title>Tutorial: Building a Golang application Docker image</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">教程:构建 Golang 应用程序 Docker 映像</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/tutorial-building-a-golang-application-docker-image-78e36d437c70?source=collection_archive---------1-----------------------#2022-05-06">https://blog.devgenius.io/tutorial-building-a-golang-application-docker-image-78e36d437c70?source=collection_archive---------1-----------------------#2022-05-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="92d5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Golang 应用程序的 Docker 图像</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/c94baec860bf73658836c065c9dde629.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aOvJGH0SPwkXnKP_T0OFTA.jpeg"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">杰斯·贝利在<a class="ae lb" href="https://unsplash.com/s/photos/desk?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="5130" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我们经过几个月的努力写出了应用之后，如何部署呢？我们用一个简单的<code class="fe lc ld le lf b">Hello World</code>的例子来学习一下。</p><p id="2567" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">项目结构如下:</p><pre class="km kn ko kp gt lg lf lh li aw lj bi"><span id="15e4" class="lk ll iq lf b gy lm ln l lo lp">.</span><span id="197f" class="lk ll iq lf b gy lq ln l lo lp">├── go.mod</span><span id="9348" class="lk ll iq lf b gy lq ln l lo lp">└── hello.go</span></pre><p id="01f4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe lc ld le lf b">hello.go</code>的代码内容如下:</p><pre class="km kn ko kp gt lg lf lh li aw lj bi"><span id="afb5" class="lk ll iq lf b gy lm ln l lo lp">package main</span><span id="6a61" class="lk ll iq lf b gy lq ln l lo lp">func main() {<br/>    println("hello world!")<br/>}</span></pre><p id="3360" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了跟上潮流，我们这里选择使用 Docker 部署。</p></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><p id="ecd6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">初次尝试。</strong></p><p id="15ce" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了方便起见，我们准备将所有内容放入 Docker 进行编译，经过一番研究，我们得到如下<code class="fe lc ld le lf b">Dockerfile</code>文件:</p><pre class="km kn ko kp gt lg lf lh li aw lj bi"><span id="3bc5" class="lk ll iq lf b gy lm ln l lo lp">FROM golang:alpine</span><span id="cf98" class="lk ll iq lf b gy lq ln l lo lp">WORKDIR /build</span><span id="3a8d" class="lk ll iq lf b gy lq ln l lo lp">COPY hello.go .</span><span id="1d77" class="lk ll iq lf b gy lq ln l lo lp">RUN go build -o hello hello.go</span><span id="e689" class="lk ll iq lf b gy lq ln l lo lp">CMD ["./hello"]</span></pre><p id="9804" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下一步开始建设。</p><pre class="km kn ko kp gt lg lf lh li aw lj bi"><span id="b501" class="lk ll iq lf b gy lm ln l lo lp">$ docker build -t hello:v1 .</span><span id="8c6e" class="lk ll iq lf b gy lq ln l lo lp">$ docker run -it --rm hello:v1 ls -l /build</span><span id="7333" class="lk ll iq lf b gy lq ln l lo lp">total 1260</span><span id="21b5" class="lk ll iq lf b gy lq ln l lo lp">-rwxr-xr-x    1 root     root       1281547 Mar  6 15:54 hello</span><span id="7466" class="lk ll iq lf b gy lq ln l lo lp">-rw-r--r--    1 root     root            55 Mar  6 14:59 hello.go</span><span id="cce4" class="lk ll iq lf b gy lq ln l lo lp"><em class="ly"><br/># </em>try to run it</span><span id="8414" class="lk ll iq lf b gy lq ln l lo lp">$ docker run -it --rm hello:v1</span><span id="cb0f" class="lk ll iq lf b gy lq ln l lo lp">hello world!</span></pre><p id="9563" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它运行成功，然后我们看看图像的大小。</p><pre class="km kn ko kp gt lg lf lh li aw lj bi"><span id="db81" class="lk ll iq lf b gy lm ln l lo lp">$ docker images | grep hello</span><span id="583d" class="lk ll iq lf b gy lq ln l lo lp">hello         v1    2783ee221014   44 minutes ago   314MB</span></pre><p id="1f8c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">震惊了我，整个图像居然有<strong class="jp ir"> 314MB </strong>，只是<code class="fe lc ld le lf b">docker build</code>，怎么回事？</p><p id="6d2d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">虽然可以运行，但是这个图像的大小太吓人了，我们只是简单的打印了一行<code class="fe lc ld le lf b">hello world</code>，图像大小超过<strong class="jp ir"> 300 MB </strong>，太不合理，需要优化。</p></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><p id="fd9f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">第二次尝试。</strong></p><p id="3e0b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">找资料后发现我们用的基图太大了。</p><pre class="km kn ko kp gt lg lf lh li aw lj bi"><span id="3006" class="lk ll iq lf b gy lm ln l lo lp">$ docker images | grep golang</span><span id="3b12" class="lk ll iq lf b gy lq ln l lo lp">golang    alpine     d026981a7165   2 days ago          313MB</span></pre><p id="33b1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有朋友告诉我可以先把代码编译好，然后再复制进去，这样就不需要那个巨大的基础镜像了，不过说起来容易，我还是花了一些时间学习，最后的<code class="fe lc ld le lf b">Dockerfile</code>是这样的:</p><pre class="km kn ko kp gt lg lf lh li aw lj bi"><span id="bd03" class="lk ll iq lf b gy lm ln l lo lp">FROM alpine</span><span id="638f" class="lk ll iq lf b gy lq ln l lo lp">WORKDIR /build</span><span id="c3b8" class="lk ll iq lf b gy lq ln l lo lp">COPY hello .</span><span id="b325" class="lk ll iq lf b gy lq ln l lo lp">CMD ["./hello"]</span></pre><p id="c393" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们重建图像:</p><pre class="km kn ko kp gt lg lf lh li aw lj bi"><span id="a762" class="lk ll iq lf b gy lm ln l lo lp">$ docker build -t hello:v2 .</span><span id="72a7" class="lk ll iq lf b gy lq ln l lo lp">...</span><span id="ea7a" class="lk ll iq lf b gy lq ln l lo lp">=&gt; ERROR [3/3] COPY hello .                         0.0s</span><span id="97dc" class="lk ll iq lf b gy lq ln l lo lp">------</span><span id="4c15" class="lk ll iq lf b gy lq ln l lo lp">&gt; [3/3] COPY hello .:</span><span id="1293" class="lk ll iq lf b gy lq ln l lo lp">------</span><span id="04ab" class="lk ll iq lf b gy lq ln l lo lp">failed to compute cache key: "/hello" not found: not found</span></pre><p id="9f16" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">哦呼，错误的报告。找不到提示<code class="fe lc ld le lf b">hello</code>，忘记先编译<code class="fe lc ld le lf b">hello.go</code>再执行。</p><pre class="km kn ko kp gt lg lf lh li aw lj bi"><span id="7531" class="lk ll iq lf b gy lm ln l lo lp">$ go build -o hello hello.go</span><span id="0ef7" class="lk ll iq lf b gy lq ln l lo lp">$ docker run -it --rm hello:v2</span><span id="4964" class="lk ll iq lf b gy lq ln l lo lp">standard_init_linux.go:228: exec user process caused: exec format error</span></pre><p id="9199" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">呜呜，又失败了。</p><p id="39ea" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">嗯，格式不对，原来我们的开发机不是<code class="fe lc ld le lf b">linux</code>，不要放弃，再来一次。</p><pre class="km kn ko kp gt lg lf lh li aw lj bi"><span id="ae3f" class="lk ll iq lf b gy lm ln l lo lp">$ GOOS=linux go build -o hello hello.go</span><span id="33cd" class="lk ll iq lf b gy lq ln l lo lp">$ docker build -t hello:v2 .</span><span id="ed47" class="lk ll iq lf b gy lq ln l lo lp"><em class="ly"># ...</em></span><span id="7c9e" class="lk ll iq lf b gy lq ln l lo lp">Successfully</span></pre><p id="602e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，构建成功，让我们尝试一下。</p><pre class="km kn ko kp gt lg lf lh li aw lj bi"><span id="2571" class="lk ll iq lf b gy lm ln l lo lp">$ docker run -it --rm hello:v2</span><span id="68e1" class="lk ll iq lf b gy lq ln l lo lp">hello world!</span></pre><p id="37c1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">没问题，我们来看看内容和大小。</p><pre class="km kn ko kp gt lg lf lh li aw lj bi"><span id="2631" class="lk ll iq lf b gy lm ln l lo lp">$ docker run -it --rm hello:v2 ls -l /build</span><span id="c28f" class="lk ll iq lf b gy lq ln l lo lp">total 1252</span><span id="7fed" class="lk ll iq lf b gy lq ln l lo lp">-rwxr-xr-x    1 root     root       1281587 Mar  6 16:18 hello</span><span id="f17b" class="lk ll iq lf b gy lq ln l lo lp"><br/>$ docker images | grep hello</span><span id="ee05" class="lk ll iq lf b gy lq ln l lo lp">hello    v2   0dd53f016c93   53 seconds ago      6.61MB</span><span id="969b" class="lk ll iq lf b gy lq ln l lo lp">hello    v1   ac0e37173b85   25 minutes ago      314MB</span></pre><p id="d7f3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">哇，这次才<strong class="jp ir"> 6.61MB </strong>，还行！</p></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><p id="ce59" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">第三次尝试。</strong></p><p id="a3ec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">虽然上面的图像可以成功构建，但还是有一些不足。它不是一个多阶段的构建。</p><p id="8f59" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们需要能够从<code class="fe lc ld le lf b">Go</code>代码构建一个<code class="fe lc ld le lf b">docker</code>图像，这分为三个步骤:</p><ul class=""><li id="dd0d" class="lz ma iq jp b jq jr ju jv jy mb kc mc kg md kk me mf mg mh bi translated">原生编译<code class="fe lc ld le lf b">Go</code>代码，如果涉及到<code class="fe lc ld le lf b">cgo</code>跨平台编译会比较麻烦。</li><li id="f075" class="lz ma iq jp b jq mi ju mj jy mk kc ml kg mm kk me mf mg mh bi translated">用编译后的可执行文件构建一个<code class="fe lc ld le lf b">docker</code>映像。</li><li id="e01d" class="lz ma iq jp b jq mi ju mj jy mk kc ml kg mm kk me mf mg mh bi translated">编写一个<code class="fe lc ld le lf b">shell</code>脚本或<code class="fe lc ld le lf b">makefile</code>，在一个命令中完成这些步骤。</li></ul><p id="0d06" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">多阶段构建就是将所有内容都放在一个<code class="fe lc ld le lf b">Dockerfile</code>中，没有源代码泄漏，没有用于跨平台编译的脚本，以及最小的映像。</p><p id="40da" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">热爱学习，追求完美，最后写了下面的<code class="fe lc ld le lf b">Dockerfile</code>。</p><pre class="km kn ko kp gt lg lf lh li aw lj bi"><span id="5b86" class="lk ll iq lf b gy lm ln l lo lp">FROM golang:alpine AS builder</span><span id="3ac8" class="lk ll iq lf b gy lq ln l lo lp">WORKDIR /build</span><span id="b8ab" class="lk ll iq lf b gy lq ln l lo lp">ADD go.mod .</span><span id="d24c" class="lk ll iq lf b gy lq ln l lo lp">COPY . .</span><span id="6a91" class="lk ll iq lf b gy lq ln l lo lp">RUN go build -o hello hello.go<br/></span><span id="8eea" class="lk ll iq lf b gy lq ln l lo lp">FROM alpine</span><span id="3e96" class="lk ll iq lf b gy lq ln l lo lp">WORKDIR /build</span><span id="7e51" class="lk ll iq lf b gy lq ln l lo lp">COPY --from=builder /build/hello /build/hello</span><span id="1cb3" class="lk ll iq lf b gy lq ln l lo lp">CMD ["./hello"]</span></pre><p id="969f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第一个<code class="fe lc ld le lf b">FROM</code>从构建一个<code class="fe lc ld le lf b">builder</code>映像开始，可执行文件<code class="fe lc ld le lf b">hello</code>在这个映像中被编译。</p><p id="b228" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从第二个<code class="fe lc ld le lf b">FROM</code>开始的部分是从第一个图像开始<code class="fe lc ld le lf b">copy</code>可执行文件<code class="fe lc ld le lf b">hello</code>，并使用尽可能小的基础图像<code class="fe lc ld le lf b">alpine</code>以确保最终图像尽可能小。</p><p id="00af" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">至于为什么不用小一点的<code class="fe lc ld le lf b">scratch</code>，那是因为<code class="fe lc ld le lf b">scratch</code>里真的什么都没有，有问题也没机会看一眼，而且<code class="fe lc ld le lf b">alpine</code>也才<strong class="jp ir"> 5MB </strong>，对我们服务好不会有太大影响。</p><p id="30ed" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们先运行它来验证:</p><pre class="km kn ko kp gt lg lf lh li aw lj bi"><span id="841a" class="lk ll iq lf b gy lm ln l lo lp">$ docker run -it --rm hello:v3</span><span id="903e" class="lk ll iq lf b gy lq ln l lo lp">hello world!</span></pre><p id="3a57" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">没问题，意料之中！看看大小是什么样的:</p><pre class="km kn ko kp gt lg lf lh li aw lj bi"><span id="4e4a" class="lk ll iq lf b gy lm ln l lo lp">$ docker images | grep hello</span><span id="50f4" class="lk ll iq lf b gy lq ln l lo lp">hello    v3     f51e1116be11   8 hours ago    6.61MB</span><span id="4369" class="lk ll iq lf b gy lq ln l lo lp">hello    v2     0dd53f016c93   8 hours ago    6.61MB</span><span id="4fdb" class="lk ll iq lf b gy lq ln l lo lp">hello    v1     ac0e37173b85   8 hours ago    314MB</span></pre><p id="2342" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第二种方法构建的图像大小完全相同。看看镜子里的内容:</p><pre class="km kn ko kp gt lg lf lh li aw lj bi"><span id="929a" class="lk ll iq lf b gy lm ln l lo lp">$ docker run -it --rm hello:v3 ls -l /build</span><span id="bb02" class="lk ll iq lf b gy lq ln l lo lp">total 1252</span><span id="5240" class="lk ll iq lf b gy lq ln l lo lp">-rwxr-xr-x    1 root     root       1281547 Mar  6 16:32 hello</span></pre><p id="97e6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此外，只有一个可执行文件<code class="fe lc ld le lf b">hello</code>可以完美构建！</p></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><p id="9fe3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">感谢您阅读这篇文章。如果你在这篇文章中发现任何错误，请告诉我。</p></div></div>    
</body>
</html>