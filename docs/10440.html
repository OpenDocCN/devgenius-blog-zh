<html>
<head>
<title>Indexing on MongoDB Collection - Part 1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">MongoDB 集合的索引-第 1 部分</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/indexing-on-nosql-collection-part-1-59f3fe577110?source=collection_archive---------16-----------------------#2022-11-01">https://blog.devgenius.io/indexing-on-nosql-collection-part-1-59f3fe577110?source=collection_archive---------16-----------------------#2022-11-01</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><figure class="im in gp gr io ip gh gi paragraph-image"><div class="gh gi il"><img src="../Images/2cdd546390ccbc626a3c92020b1c7ddc.png" data-original-src="https://miro.medium.com/v2/resize:fit:634/format:webp/1*yjfAPXMz9mJNzuu_K3PVbg.png"/></div></figure><div class=""/><p id="46e5" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">索引使读取查询更快。我们可以对文档中的任何字段应用索引，包括嵌入字段。当文档被索引时，mongo DB 将首先使用过滤后的偏移量进行搜索，而不是对所有文档进行 COLLSCAN ( column-span ),然后对其应用过滤标准。</p><p id="7463" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">让我们通过创建现有集合的索引并比较应用索引前后的查询执行统计来理解这一点。</p><p id="69b9" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">顺便说一下，我在这个演练中使用了 Mongo DB Atlas Free cluster。Mongo 亚多拉斯是一个基于云的解决方案，用于托管和管理 NoSQL 数据，它还提供了一个用于学习目的的免费集群，只需点击一下即可将样本数据集加载到您的免费集群中。我喜欢了:)</p><p id="2432" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">为了连接到 Atlas 集群，我使用了 VS 代码扩展“MongoDB VS Code”。还有其他方法，如使用 mongo shell、mongo Atlas UI。请参考下面的链接【https://www.mongodb.com/docs/atlas/getting-started/ T2</p><p id="8dc5" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">我正在使用加载到我的 Atlas 帐户中的“sample_airbnb”数据集，并使用 MongoDB for VS 代码扩展来查询它们。</p><blockquote class="kr ks kt"><p id="3870" class="jr js kp jt b ju jv jw jx jy jz ka kb ku kd ke kf kv kh ki kj kw kl km kn ko ig bi translated"><strong class="jt iv">请注意，以防图片截图不清晰可见。请在新的标签中打开它们，或者点击图片描述。</strong></p></blockquote><figure class="ky kz la lb gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="gh gi kx"><img src="../Images/a9c0bbccca8922c1129d37334cd72252.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hvVmMt7e0M2NkABcZsLV8g.png"/></div></div><figcaption class="lg lh gj gh gi li lj bd b be z dk translated"><a class="ae kq" href="https://cdn-images-1.medium.com/max/800/1*hvVmMt7e0M2NkABcZsLV8g.png" rel="noopener">在“listingAndReview”集合上没有任何索引的情况下获取属性类型的查询</a></figcaption></figure><blockquote class="kr ks kt"><p id="76ef" class="jr js kp jt b ju jv jw jx jy jz ka kb ku kd ke kf kv kh ki kj kw kl km kn ko ig bi translated">在上面的查询中，我对集合“listingAndReviews”执行查找查询，其中 property_type 是 house。我还使用 regex 获取结果，忽略大小写，并使用 explain('executionStats ')函数获取查询计划。</p></blockquote><p id="7682" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">在有索引的情况下，<strong class="jt iv"> <em class="kp"> winningPlan 部分将把 inputStage.stage 作为 IXSCAN </em> </strong></p><figure class="ky kz la lb gt ip gh gi paragraph-image"><div class="gh gi lk"><img src="../Images/558660fe92ae014e524913137cf901ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1018/format:webp/1*VlYEObu2eitowhNYEDEMJA.png"/></div><figcaption class="lg lh gj gh gi li lj bd b be z dk translated"><a class="ae kq" href="https://cdn-images-1.medium.com/max/800/1*VlYEObu2eitowhNYEDEMJA.png" rel="noopener">带索引</a>的“listingandReview”的执行统计。</figcaption></figure><p id="0a81" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">我从“listingAndReviews”集合中删除所有预先创建的索引，并重新执行相同的查询。我们可以看到<strong class="jt iv"> winningPlan.stage 为“coll span”</strong>而<strong class="jt iv">execution stats . execution time millis 为 118。totaldocsexaminas 5555 找到了符合我们搜索条件的 606 条记录。</strong></p><figure class="ky kz la lb gt ip gh gi paragraph-image"><div class="gh gi lk"><img src="../Images/e2283b74dbed65dd52045e85963359de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1018/format:webp/1*Xit3qUXVVkcQP5Iqnr7J_Q.png"/></div><figcaption class="lg lh gj gh gi li lj bd b be z dk translated">不将索引应用于“listingAndReviews”集合的执行统计信息</figcaption></figure><p id="3e10" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">让我们在字段“property_ type”上创建一个索引，以便更快地获取结果。</p><figure class="ky kz la lb gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="gh gi ll"><img src="../Images/ec5c58ca2e768f3b193c535834a6af89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dKqX8j4Jppvr4EnzkJoJhg.png"/></div></div><figcaption class="lg lh gj gh gi li lj bd b be z dk translated"><a class="ae kq" href="https://cdn-images-1.medium.com/max/1200/1*dKqX8j4Jppvr4EnzkJoJhg.png" rel="noopener">在属性类型字段上创建单个索引</a></figcaption></figure><figure class="ky kz la lb gt ip gh gi paragraph-image"><div class="gh gi lm"><img src="../Images/b8103239167111526a1bbd1f5127eab5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1296/format:webp/1*HUbuCRAr-TIvjLsoaLgkPQ.png"/></div><figcaption class="lg lh gj gh gi li lj bd b be z dk translated">对“property_type”应用索引后获取查询的执行统计信息</figcaption></figure><blockquote class="kr ks kt"><p id="03d4" class="jr js kp jt b ju jv jw jx jy jz ka kb ku kd ke kf kv kh ki kj kw kl km kn ko ig bi translated">要定义一个索引，我们需要了解所需的查询以及将要对集合执行的读写操作的数量。索引会对写操作造成一定的负担，这就是为什么我们不应该对所有的文档字段应用索引的原因。</p><p id="82fb" class="jr js kp jt b ju jv jw jx jy jz ka kb ku kd ke kf kv kh ki kj kw kl km kn ko ig bi translated"><strong class="jt iv">注意*在 fetch 查询将返回集合中接近所有文档的字段上创建索引没有帮助，事实上还会降低查询的执行速度。基于查询用例创建索引，以便查询结果应该只返回有限的获取结果。</strong></p></blockquote><h2 id="d8c8" class="ln lo iu bd lp lq lr dn ls lt lu dp lv kc lw lx ly kg lz ma mb kk mc md me mf bi translated">复合指数</h2><p id="9a35" class="pw-post-body-paragraph jr js iu jt b ju mg jw jx jy mh ka kb kc mi ke kf kg mj ki kj kk mk km kn ko ig bi translated">上面的例子是关于单指数领域的。还有另一种称为“复合索引”的索引类型，其中两个或多个字段被认为是按照与它们被添加到 相同的<strong class="jt iv"> <em class="kp">顺序进行索引。</em></strong></p><p id="ba53" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">如果我们添加了两个字段作为复合索引，优先级将从左到右开始。例如，让我们使用“beds and address.country_code”(嵌入式文档)字段在“listingAndReviews”集合上创建一个复合索引。</p><figure class="ky kz la lb gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="gh gi ll"><img src="../Images/0a679f96c2482905ad5968e6e8a4b548.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bl9XOk2JVgJQzofxWAJtRg.png"/></div></div><figcaption class="lg lh gj gh gi li lj bd b be z dk translated">使用床位数和地址国家代码的复合索引</figcaption></figure><p id="bf1c" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">这里字段的顺序很重要，优先顺序是从左到右。即，字段 beds 获得第一优先权，然后是 address.country_code。</p><figure class="ky kz la lb gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="gh gi ml"><img src="../Images/b82558ce42eb87f2ebbd27c738d4333f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JbP3X7gzP3svZxO0Ns6oYw.png"/></div></div></figure><p id="c875" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">在上面的查询中，尽管我们在 find 查询中使用了两个过滤器来获取床位数为 1 并且可以容纳 4 个人的结果。这里的“容纳”字段不是我们索引键的一部分。Mongo DB 执行 IXSCAN，即索引扫描，而不是跨越集合中所有文档的 COLLSPAN 列，因为我们将“beds”添加为键索引的一部分，并且优先级是从左到右的。</p><p id="fa03" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">如果我们只查询容纳的字段，Mongo DB 会执行 COLLSPAN 并检查总数为 5555 的所有文档</p><figure class="ky kz la lb gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="gh gi mm"><img src="../Images/32fc77fc77d272b4f178a07c7e6a8e25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dqSIeZPKTAaaoqNlgcb54Q.png"/></div></div></figure><p id="4963" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">到目前为止执行的 MongoDB 读取查询</p><pre class="ky kz la lb gt mn mo mp mq aw mr bi"><span id="21ca" class="ln lo iu mo b gy ms mt l mu mv">// Select the database to use.<br/>use('sample_airbnb');</span><span id="59b0" class="ln lo iu mo b gy mw mt l mu mv">db.listingsAndReviews.find({}).count()</span><span id="f000" class="ln lo iu mo b gy mw mt l mu mv">db.listingsAndReviews.find({"property_type":{$eq:"House"}})// { '$regex':/^yourValue$/i}</span><span id="1432" class="ln lo iu mo b gy mw mt l mu mv">db.listingsAndReviews.find({"property_type":{$regex:/^house$/i}}).explain('executionStats')</span><span id="20e0" class="ln lo iu mo b gy mw mt l mu mv">//Create index on field property_type 1 denotes ascending and -1 descending<br/>db.listingsAndReviews.createIndex({"property_type":1})</span><span id="a0d8" class="ln lo iu mo b gy mw mt l mu mv">//Create compound index on beds and address.country_code<br/>db.listingsAndReviews.createIndex({'beds':1 ,'address.country_code':1}, {'name':'ixd_bed_addr.country'})</span><span id="cd14" class="ln lo iu mo b gy mw mt l mu mv">db.listingsAndReviews.find({'beds':1,'accommodates': {$eq:4}}).explain('executionStats')</span><span id="94db" class="ln lo iu mo b gy mw mt l mu mv">db.listingsAndReviews.find({'accommodates': {$eq:4}}).explain('executionStats')</span><span id="0a21" class="ln lo iu mo b gy mw mt l mu mv">db.listingsAndReviews.find({'accommodates': {$eq:4}}).sort({'maximum_nights':1}).explain('executionStats')</span></pre><p id="95a2" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated"><strong class="jt iv">定义指数的规则</strong></p><p id="2c42" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated"><a class="ae kq" href="https://www.mongodb.com/docs/manual/tutorial/equality-sort-range-rule/#std-label-esr-indexing-rule" rel="noopener ugc nofollow" target="_blank"> <strong class="jt iv">使用 ESR(相等、排序、范围)规则</strong> </a></p><p id="59f1" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated"><a class="ae kq" href="https://www.mongodb.com/docs/manual/tutorial/create-indexes-to-support-queries/#std-label-create-indexes-to-support-queries" rel="noopener ugc nofollow" target="_blank"> <strong class="jt iv">创建索引来支持您的查询</strong> </a></p><p id="3d56" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated"><a class="ae kq" href="https://www.mongodb.com/docs/manual/tutorial/sort-results-with-indexes/#std-label-sorting-with-indexes" rel="noopener ugc nofollow" target="_blank"> <strong class="jt iv">使用索引对查询结果进行排序</strong> </a></p><pre class="ky kz la lb gt mn mo mp mq aw mr bi"><span id="20bf" class="ln lo iu mo b gy ms mt l mu mv">We need index not only for fetching the results quickly but also to use sorting. In case of non indexed document, Mongo DB has limit of 32 MB in memory and this will time out in case sorting (Default in- memory sorting) of huge millions of document without indexing.</span></pre><ol class=""><li id="5369" class="mx my iu jt b ju jv jy jz kc mz kg na kk nb ko nc nd ne nf bi translated"><a class="ae kq" href="https://www.mongodb.com/docs/manual/tutorial/ensure-indexes-fit-ram/#std-label-indexes-ensure-indexes-fit-ram" rel="noopener ugc nofollow" target="_blank"> <strong class="jt iv">保证指标适合 RAM </strong> </a></li><li id="dfb7" class="mx my iu jt b ju ng jy nh kc ni kg nj kk nk ko nc nd ne nf bi translated"><a class="ae kq" href="https://www.mongodb.com/docs/manual/tutorial/create-queries-that-ensure-selectivity/#std-label-index-selectivity" rel="noopener ugc nofollow" target="_blank"> <strong class="jt iv">创建确保选择性的查询</strong> </a></li></ol><p id="85cf" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">在本系列的下一部分中，我们将深入研究其他类型的索引以及创建索引时要遵循的最佳实践。</p><p id="9cdc" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated"><strong class="jt iv">地理空间索引:</strong></p><p id="5107" class="pw-post-body-paragraph jr js iu jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">Mongo DB 允许我们保存地理空间数据</p></div></div>    
</body>
</html>