<html>
<head>
<title>Implement Excel’s eomonth() in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用 Python 实现 Excel 的 eomonth()</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/implement-excels-eomonth-in-python-c81afb70165e?source=collection_archive---------10-----------------------#2022-01-24">https://blog.devgenius.io/implement-excels-eomonth-in-python-c81afb70165e?source=collection_archive---------10-----------------------#2022-01-24</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="e4f3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><em class="ki">Python 实现挑战，参考答案</em></p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/17ad785dd4ae30f5dc8c5f5808aff496.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P3YXoDD-VJAdiBSHKJV0cw.png"/></div></div></figure><blockquote class="kv kw kx"><p id="f9bd" class="jk jl ki jm b jn jo jp jq jr js jt ju ky jw jx jy kz ka kb kc la ke kf kg kh ig bi translated">摘录:在本文中，我们尝试在 Excel <code class="fe lb lc ld le b">eomonth</code>中复制一个日期函数，并一步一步地提出一个 Python 实现。然后，我们将尝试通过迭代来优化 Python 版本，并设计出一个在各个方面都优于 Excel 的 Python 实现。</p></blockquote><h1 id="a1eb" class="lf lg in bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">灵感的来源</h1><p id="8c51" class="pw-post-body-paragraph jk jl in jm b jn md jp jq jr me jt ju jv mf jx jy jz mg kb kc kd mh kf kg kh ig bi translated">我碰巧看到 Sergio Yahni 的文章<a class="ae mi" href="https://medium.com/@sergioyahni/automate-ms-excel-python-code-for-the-most-useful-microsoft-excel-formulas-28bb8f1d4460" rel="noopener"> Automate MS-Excel:最有用的 Microsoft Excel 公式的 Python 代码</a><a class="mj mk ep" href="https://medium.com/u/29c721494018?source=post_page-----c81afb70165e--------------------------------" rel="noopener" target="_blank">并且碰巧这些年来我已经用 Python 重新实现了许多 Excel 公式，其中许多甚至比它们的 Excel 对等物更加通用和健壮。</a></p><p id="e18f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">正如我在下面的前一篇博客中提到的，我在 20 年后放弃了 Excel VBA，转向了 Python，但我最看重的 Excel 专家(未被微软认可:-)的知识确实在我的 Python 学习道路上帮助很大。</p><div class="ml mm gp gr mn mo"><a rel="noopener  ugc nofollow" target="_blank" href="/no-code-or-low-code-90c2f0d93596"><div class="mp ab fo"><div class="mq ab mr cl cj ms"><h2 class="bd io gy z fp mt fr fs mu fu fw im bi translated">无代码还是低代码？</h2><div class="mv l"><h3 class="bd b gy z fp mt fr fs mu fu fw dk translated">我们真的想走这条路吗？</h3></div><div class="mw l"><p class="bd b dl z fp mt fr fs mu fu fw dk translated">blog.devgenius.io</p></div></div><div class="mx l"><div class="my l mz na nb mx nc kt mo"/></div></div></a></div><h1 id="af1e" class="lf lg in bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">Excel 版本</h1><p id="dcc2" class="pw-post-body-paragraph jk jl in jm b jn md jp jq jr me jt ju jv mf jx jy jz mg kb kc kd mh kf kg kh ig bi translated">Excel 的数据操作能力非常强大，尤其是当涉及到它的大量内置函数时(但是，也有一些限制，例如，缺少 count distinct 函数)。</p><p id="311c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><code class="fe lb lc ld le b">eomonth(start_date, months)</code>函数是<code class="fe lb lc ld le b">end of month</code>的缩写，它取一个开始日期并返回指定月份的月末日期。</p><ol class=""><li id="9b20" class="nd ne in jm b jn jo jr js jv nf jz ng kd nh kh ni nj nk nl bi translated">比如<code class="fe lb lc ld le b">=EOMONTH(“2022–1–24”, 1)</code>会返回<code class="fe lb lc ld le b">2022-02-28</code>；<code class="fe lb lc ld le b">=EOMONTH(“2022–1–24”, 2)</code>将返回<code class="fe lb lc ld le b">2022-03–31</code>。</li><li id="3b12" class="nd ne in jm b jn nm jr nn jv no jz np kd nq kh ni nj nk nl bi translated"><code class="fe lb lc ld le b">months</code>可以为零，表示返回当月的最后一天，即<code class="fe lb lc ld le b">=EOMONTH(“2022–1–24”, 0)</code>将返回<code class="fe lb lc ld le b">2022-01-31</code>。</li><li id="34df" class="nd ne in jm b jn nm jr nn jv no jz np kd nq kh ni nj nk nl bi translated"><code class="fe lb lc ld le b">months</code>甚至可以是负数，表示返回前几个月的最后一天，即<code class="fe lb lc ld le b">=EOMONTH(“2022–1–24”, -1)</code>将返回<code class="fe lb lc ld le b">2021-12-31</code>。</li></ol><p id="6b06" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">当我们使用 Python 处理数据值时，同样的需求经常出现。让我们先进行详细的需求分析。</p><h1 id="a42a" class="lf lg in bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">需求分析和迭代</h1><h2 id="34ac" class="nr lg in bd lh ns nt dn ll nu nv dp lp jv nw nx lt jz ny nz lx kd oa ob mb oc bi translated">第一步，基本要求</h2><ol class=""><li id="f4a8" class="nd ne in jm b jn md jr me jv od jz oe kd of kh ni nj nk nl bi translated">实现一个 Python 函数:<code class="fe lb lc ld le b">def eomonth(start_date, months)</code>。</li><li id="9262" class="nd ne in jm b jn nm jr nn jv no jz np kd nq kh ni nj nk nl bi translated">它应该能够添加(或减去)<code class="fe lb lc ld le b">months</code>月数到<code class="fe lb lc ld le b">start_date</code>，并返回结果的月末日期。</li><li id="dca9" class="nd ne in jm b jn nm jr nn jv no jz np kd nq kh ni nj nk nl bi translated"><code class="fe lb lc ld le b">months</code>应为整数，可以是负数、正数或零。</li></ol><h2 id="8600" class="nr lg in bd lh ns nt dn ll nu nv dp lp jv nw nx lt jz ny nz lx kd oa ob mb oc bi translated">第二步，检查参数的有效性，避免误用</h2><ol class=""><li id="47b2" class="nd ne in jm b jn md jr me jv od jz oe kd of kh ni nj nk nl bi translated">检查<code class="fe lb lc ld le b">start_date</code>是否为日期格式。</li><li id="4154" class="nd ne in jm b jn nm jr nn jv no jz np kd nq kh ni nj nk nl bi translated">检查<code class="fe lb lc ld le b">start_date</code>的有效性，例如<code class="fe lb lc ld le b">2021-2-29</code>无效。</li><li id="0909" class="nd ne in jm b jn nm jr nn jv no jz np kd nq kh ni nj nk nl bi translated">检查<code class="fe lb lc ld le b">months</code>是否为有效整数。</li></ol><h2 id="3716" class="nr lg in bd lh ns nt dn ll nu nv dp lp jv nw nx lt jz ny nz lx kd oa ob mb oc bi translated">步骤 3，为函数设置默认值，以简化函数调用</h2><ol class=""><li id="a9d5" class="nd ne in jm b jn md jr me jv od jz oe kd of kh ni nj nk nl bi translated">将<code class="fe lb lc ld le b">start_date</code>的默认值设置为<code class="fe lb lc ld le b">None</code>，这意味着取当前日期(<code class="fe lb lc ld le b">today</code>)代替。</li><li id="bc28" class="nd ne in jm b jn nm jr nn jv no jz np kd nq kh ni nj nk nl bi translated">将<code class="fe lb lc ld le b">months</code>的默认值设置为<code class="fe lb lc ld le b">0</code>。</li></ol><h2 id="26f7" class="nr lg in bd lh ns nt dn ll nu nv dp lp jv nw nx lt jz ny nz lx kd oa ob mb oc bi translated">步骤 4，扩展功能以接受日期列表</h2><ol class=""><li id="502a" class="nd ne in jm b jn md jr me jv od jz oe kd of kh ni nj nk nl bi translated">允许一个<code class="fe lb lc ld le b">list</code>或一个<code class="fe lb lc ld le b">pandas.Series</code>作为<code class="fe lb lc ld le b">start_date</code>传入，在这种情况下，返回相同长度的日期列表。</li><li id="6104" class="nd ne in jm b jn nm jr nn jv no jz np kd nq kh ni nj nk nl bi translated">确保当<code class="fe lb lc ld le b">start_date</code>是单个日期时，它仍然返回单个日期。</li></ol><h2 id="8e2a" class="nr lg in bd lh ns nt dn ll nu nv dp lp jv nw nx lt jz ny nz lx kd oa ob mb oc bi translated">第五步，尝试适应更多的现实生活场景</h2><ol class=""><li id="ec6e" class="nd ne in jm b jn md jr me jv od jz oe kd of kh ni nj nk nl bi translated">尝试解析一个字符串格式<code class="fe lb lc ld le b">start_date</code>来修正日期，如果失败抛出异常。</li><li id="f8d9" class="nd ne in jm b jn nm jr nn jv no jz np kd nq kh ni nj nk nl bi translated">如果<code class="fe lb lc ld le b">start_date</code>是一个列表，尝试解析每一项，如果有几项失败，就返回一个<code class="fe lb lc ld le b">None</code>。</li></ol><h2 id="4cc8" class="nr lg in bd lh ns nt dn ll nu nv dp lp jv nw nx lt jz ny nz lx kd oa ob mb oc bi translated">第六步，其他已知或未知的情况</h2><ol class=""><li id="385f" class="nd ne in jm b jn md jr me jv od jz oe kd of kh ni nj nk nl bi translated">Python 中有很多 DateTime 格式，常见的有<code class="fe lb lc ld le b">datetime.datetime</code>、<code class="fe lb lc ld le b">datetime.date</code>、<code class="fe lb lc ld le b">timestamp</code>、<code class="fe lb lc ld le b">datetime64[ns, UTC]</code>等。它们的问题是它们通常彼此不兼容，并且有不同的方法。</li><li id="ec4f" class="nd ne in jm b jn nm jr nn jv no jz np kd nq kh ni nj nk nl bi translated">Excel 中的日期格式实际上是基于<code class="fe lb lc ld le b">1900-1-1</code>的，这意味着像<code class="fe lb lc ld le b">2021-7-30</code>这样的日期在某些情况下会被解释为<code class="fe lb lc ld le b">44407</code>，如果必要的话需要翻译。</li><li id="4696" class="nd ne in jm b jn nm jr nn jv no jz np kd nq kh ni nj nk nl bi translated">时区在某些情况下可能是个问题，例如，<code class="fe lb lc ld le b">2021/7/31 16:00:00</code>可能读作<code class="fe lb lc ld le b">2021/8/1 0:00:00</code>。</li><li id="68e8" class="nd ne in jm b jn nm jr nn jv no jz np kd nq kh ni nj nk nl bi translated">如果需要处理大量的数据，例如十亿行，如何确保效率？</li></ol><h1 id="5c51" class="lf lg in bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">结论和警告</h1><p id="3fb6" class="pw-post-body-paragraph jk jl in jm b jn md jp jq jr me jt ju jv mf jx jy jz mg kb kc kd mh kf kg kh ig bi translated">在上面的步骤中，我们实际上已经实现了与 Excel 完全相同的功能，并且利用 Python 相对于 Excel 效率低下的优势，它至少是一个更快的解决方案。</p><p id="cf35" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">步骤 2 到步骤 5 在可用性、健壮性和应用范围方面将实现带到了更高的层次，这就是<strong class="jm io">需求分析的真正价值</strong>。</p><p id="e4fe" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">第六步并不容易，除非你有大量的实践经验，通过反复试验。您使用和更新自己的函数越多，它就越健壮。例如，在我的<code class="fe lb lc ld le b">pandas</code>包升级后，我最近才发现<code class="fe lb lc ld le b">pandas.to_datetime</code>和<code class="fe lb lc ld le b">datetime.datetime</code>之间的不兼容问题。<strong class="jm io">在大多数情况下，这一步没有必要考虑</strong>。除非你的<code class="fe lb lc ld le b">eomonth</code>功能是要用在飞船上。</p><p id="6662" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">总而言之:</p><ol class=""><li id="9233" class="nd ne in jm b jn jo jr js jv nf jz ng kd nh kh ni nj nk nl bi translated">如果它满足用户的所有基本需求，我们认为它是一个足够好的需求分析。</li><li id="add4" class="nd ne in jm b jn nm jr nn jv no jz np kd nq kh ni nj nk nl bi translated">如果我们添加一些额外的功能，比如接受列表，我们认为这是一个优化的需求分析。</li><li id="76e4" class="nd ne in jm b jn nm jr nn jv no jz np kd nq kh ni nj nk nl bi translated">我们认为这是一种过度杀戮，例如:</li></ol><ul class=""><li id="ac86" class="nd ne in jm b jn jo jr js jv nf jz ng kd nh kh og nj nk nl bi translated"><code class="fe lb lc ld le b">months</code>可以是十进制数值，也可以是月份列表。</li><li id="4060" class="nd ne in jm b jn nm jr nn jv no jz np kd nq kh og nj nk nl bi translated">考虑到史前的日期，或者宇宙的灭绝。</li><li id="e532" class="nd ne in jm b jn nm jr nn jv no jz np kd nq kh og nj nk nl bi translated">让对 Python 一无所知的人也能接触到。</li></ul><h1 id="5ffb" class="lf lg in bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">参考答案</h1><p id="4e9c" class="pw-post-body-paragraph jk jl in jm b jn md jp jq jr me jt ju jv mf jx jy jz mg kb kc kd mh kf kg kh ig bi translated">下面是我多年前写的 Python 库中的一个片段，供你参考。如果你有不同或更好的解决方案，请不要犹豫，留下你的评论。</p><pre class="kk kl km kn gt oh le oi oj aw ok bi"><span id="da03" class="nr lg in le b gy ol om l on oo">def eomonth(d, months=0):<br/>    months = int(months)<br/>    if isinstance(d, list):<br/>        return [eomonth(d0, months) for d0 in d]<br/>    elif isinstance(d, pd.Series):<br/>        return d.map(lambda d0: eomonth(d0, months))<br/>    else:<br/>        y, m = divmod(d.month + months + 1, 12)<br/>        # y, m = int(y), int(m)<br/>        if m==0:<br/>            y -= 1<br/>            m = 12<br/>        return pytz.UTC.localize(datetime.datetime(d.year + y, m, 1) - datetime.timedelta(days=1))</span></pre></div></div>    
</body>
</html>