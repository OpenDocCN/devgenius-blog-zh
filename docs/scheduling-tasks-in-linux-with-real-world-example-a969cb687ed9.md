# Linux ä¸­è°ƒåº¦ä»»åŠ¡çš„çœŸå®ä¾‹å­

> åŸæ–‡ï¼š<https://blog.devgenius.io/scheduling-tasks-in-linux-with-real-world-example-a969cb687ed9?source=collection_archive---------12----------------------->

N å†°é‡è§ä½ ï¼Œå¥½å¥‡çš„å¿ƒï¼âœŒï¸:åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘æƒ³åˆ†è§£ä½ å¦‚ä½•åœ¨ linux ä¸­è°ƒåº¦ä»»åŠ¡ã€‚

åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šæœ‰ä¸¤ç§æ–¹æ³•: **cron & systemd timers** ã€‚è™½ç„¶æˆ‘å°†æŠŠæ‰€æœ‰çš„æ—¶é—´èŠ±åœ¨å‰è€…ä¸Šï¼Œä½†åè€…ä¹Ÿæ˜¯ä¸€ä¸ªä½ å¯ä»¥è‡ªå·±æ¢ç´¢çš„é€‰æ‹©ã€‚ğŸ•º

æ­¤å¤–ï¼Œæˆ‘å°†å±•ç¤ºæˆ‘ä»¬ç”¨æ¥åœ¨ [Picklang](https://picklang.ml) å®ç° **cron** æ¥ä¸ºç”¨æˆ·è¿è¡Œæ¨é€é€šçŸ¥çš„æ¦‚å¿µã€‚

â€¼ï¸Before æ½œæ°´ inâ€¼ï¸ï¼Œæˆ‘æƒ³åšä¸€ä¸ª discalimerï¼Œæˆ‘ä¸æ˜¯ä¸€ä¸ªé¡¶å°–çš„ç³»ç»Ÿç®¡ç†å‘˜ï¼Œä½†æ˜¯ä¸€ä¸ªè½¯ä»¶å·¥ç¨‹å¸ˆï¼Œä»–æœ‰ Linux çš„ç»éªŒï¼Œå¹¶ä¸”ç”¨å®ƒåšäº†å¾ˆå¤šäº‹æƒ…ã€‚è¿™ç¯‡æ–‡ç« ä¸­çš„çŸ¥è¯†æ¥è‡ªæˆ‘è‡ªå·±çš„ç»éªŒ/ä¹¦ç±/æ–‡ç« /åŒäº‹

> **é¡ºä¾¿è¯´ä¸€ä¸‹**ï¼Œå¦‚æœä½ æƒ³å€ŸåŠ© AI å­¦ä¹ å¤–è¯­ï¼Œè¯·è®¿é—® [https://picklang.ml](https://picklang.ml) äº†è§£æ›´å¤š
> 
> **ä¸æ˜¯**å¥½ç©çš„äº‹å®ğŸ˜©:æˆ‘èŠ±äº†å¤§çº¦ä¸€ä¸ªæœˆçš„æ—¶é—´æ¶‰çŒ cron &å®ƒæ˜¯ä¸ Docker çš„äº¤äº’ã€‚å¦‚æœæˆ‘æ—©ä¸€ç‚¹é˜…è¯»[å¤§å«Â·æŸ¯æ—é¡¿çš„ä¹¦](https://medium.com/u/9b247ed89b9d?source=post_page-----a969cb687ed9--------------------------------) [Linux in Action](https://www.manning.com/books/linux-in-action) ï¼Œæˆ‘ä¼šèŠ‚çœå‡ åä¸ªå°æ—¶

**æ–‡ç« ç»“æ„:**

*   cron æ¦‚è¿°
*   cron çš„ç±»å‹
*   éå¸¸é‡è¦çš„è¯´æ˜
*   åœ¨ä¸€ä¸ª docker æ–‡ä»¶ä¸­è¿è¡Œ cron + Gunicorn çš„ç¤ºä¾‹
*   æœ€åçš„è¯

![](img/d92d70b76bd6922f542f7a5d0abefb1f.png)

åŠ å¸ƒé‡ŒåŸƒå°”Â·æµ·å› ç­–åœ¨ [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) ä¸Šæ‹æ‘„çš„ç…§ç‰‡

## cron æ¦‚è¿°

ä»€ä¹ˆæ˜¯ **cron** ï¼Œæ€»è€Œè¨€ä¹‹ï¼Ÿå®ƒæ˜¯ä¸€ä¸ªå†…ç½®çš„ linux è°ƒåº¦ç¨‹åºï¼Œå¦‚æœæ‚¨éœ€è¦å®šæœŸè¿è¡Œä¸€äº›æ“ä½œï¼Œå¯ä»¥åˆ©ç”¨å®ƒã€‚â°

å…‹æœ—ä½åœ¨å“ªé‡Œï¼Ÿä½ å¯èƒ½çŸ¥é“ï¼Œæ‰€æœ‰çš„ linux ç³»ç»Ÿéƒ½æºäºå¼ºå¤§çš„**æ ¹:/** ã€‚é‚£ä¹ˆï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ **linux æ–‡ä»¶ç³»ç»Ÿ**çš„æ¦‚è¿°:

```
 / - root
       - /etc - **here everything cron related lives**
       - /var
       - /home
       - /sbin
       - /bin
       - /lib
       - /usr
```

ç›®å½•ä¸­æœ‰å„ç§ç›®å½•å’Œæ–‡ä»¶ã€‚

è¿è¡Œ`ls /etc | grep cron`ï¼Œå®ƒä¼šåå‡ºå„ç§ç±»å‹çš„&å‘³é“

## cron çš„ç±»å‹

**æ–‡ä»¶å¤¹**

è¿˜æœ‰åƒ`cron.daily`ã€`cron.hourly`ã€`cron.monthly`ã€`cron.weekly`ã€&æœ€åæ˜¯`cron.d`è¿™æ ·çš„æ–‡ä»¶å¤¹ã€‚ä½ éœ€è¦æŠŠä½ çš„ cron æ–‡ä»¶æ”¾åœ¨é‡Œé¢ï¼Œlinux ä¼šæ‰§è¡Œå®ƒä»¬ã€‚

ä½†æ˜¯`{.daily, .hourly, .monthly, .weekly}`æœ‰å‡ ä¸ªé™åˆ¶:

1.  æ–‡ä»¶å¿…é¡»æ²¡æœ‰æ‰©å±•å
2.  ä½ éœ€è¦æŠŠ`**#! /bin/bash**` æ”¾åœ¨æ–‡ä»¶çš„å¼€å¤´
3.  æ–‡ä»¶å¿…é¡»æ˜¯å¯æ‰§è¡Œçš„:`chmod +x file`

åœï¼ŒLinux æ€ä¹ˆä¼šè‡ªå·±æ‰§è¡Œæ–‡ä»¶ï¼ŸğŸ§

è®©æˆ‘ä»¬å†æ¥çœ‹çœ‹æ–‡ä»¶å¤¹çš„æ‰©å±•:æ”¾å…¥å¸¦æœ‰`daily`ã€`hourly`ç­‰çš„æ–‡ä»¶ï¼Œä¼šä½¿æ–‡ä»¶æŒ‰ç…§æ—¶é—´æ‰§è¡Œã€‚

åœ¨è¿™é‡Œï¼Œæˆ‘å¸Œæœ›ä½ å¾—åˆ°äº†è¦ç‚¹ã€‚ä½†æ˜¯`cron.d`å‘¢ï¼Ÿå•Šï¼Œåœ¨è¿™é‡Œä½ æŠŠä½ çš„æ–‡ä»¶å’Œå…·ä½“æ—¶é—´ã€‚æ€ä¹ˆä¼šï¼Ÿ

é¦–å…ˆå‚è§‚åä¸º**å…‹æœ—å¡”å¸ƒå¤é²**:[https://www.manning.com/books/linux-in-action](https://www.manning.com/books/linux-in-action)çš„å®ä¼Ÿé—å€

æ˜ç™½æš—ç¤ºäº†å—ï¼Ÿæ‚¨å¯ä»¥æŒ‡å®šå¸Œæœ›ä»»åŠ¡è¿è¡Œçš„é¢‘ç‡ã€‚

ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥è¾“å…¥`cron.d`:

`*/5 * * * * root apt update && apt upgrade`æ¯äº”åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ã€‚

> **è‡³å…³é‡è¦:**ä¸è¦æ·»åŠ ä»»ä½•æ‰©å±•åã€‚ä»…ä»…æ˜¯`touch some_file`è€Œå·²

è€Œä¸”ï¼Œå¾ˆæ˜æ˜¾ï¼Œå¦‚æœæ”¾åœ¨æœ‰`daily`ç­‰çš„æ–‡ä»¶å¤¹é‡Œâ€”â€”>å°±ä¸éœ€è¦é‚£äº›`*`

**æ–‡ä»¶**

è¿˜æœ‰ 2 ä¸ªæ–‡ä»¶:`crontab` & `anacron`

1.  `crontab`ç±»ä¼¼äº`cron.d`æ–‡ä»¶å¤¹

*   åªç©`/etc`æ–‡ä»¶å¤¹ä¸­çš„`crontab`ï¼Œå› ä¸ºå®ƒæ˜¯å½“å‰ç”¨æˆ·çš„`crontab`ã€‚
*   å¦‚æœæ‚¨æƒ³åˆ©ç”¨å®ƒæ¥è¿è¡Œæ‚¨çš„ä»»åŠ¡ï¼Œæ‚¨å¯ä»¥åƒæˆ‘ä»¬åœ¨å¯åŠ¨æ—¶é‚£æ ·åšã€‚æ‚¨åœ¨`crontab`ä¸­æŒ‡å®šæ–‡ä»¶å‘¨æœŸï¼Œå°±åƒåœ¨æ™®é€š cron ä¸­ä¸€æ ·ï¼Œç„¶åæŒ‡å®šè¦æ‰§è¡Œå“ªäº›æ–‡ä»¶:

```
01 * * * * root run-parts /etc/cron.hourly
```

2.`anacrontab`æ˜¯æœ‰ç‚¹ä¸åŒç±»å‹çš„é‡å…½ã€‚ä¸‹é¢æˆ‘æ¥å†™ä¸€ä¸‹ã€‚

å¦‚æœæ‚¨ä¸ç¡®å®šæ‚¨çš„æœåŠ¡å™¨/æœºå™¨æ˜¯å¦ä¼šåœ¨ cron æ–‡ä»¶ä¸­æŒ‡å®šçš„æ—¶é—´å¯åŠ¨å¹¶è¿è¡Œï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿä¸å¥½â€¦ğŸ˜®â€ğŸ’¨ä½†å¹¶éä¸å¯æ”¶æ‹¾ã€‚æ•‘æ´æ¥äº†ã€‚å®ƒå…è®¸åœ¨å¯åŠ¨çš„ç‰¹å®šæ—¶é—´åè¿è¡ŒæŸäº›ä¸œè¥¿**ã€‚**

ğŸ˜¶â€ğŸŒ«ï¸ **é¢˜å¤–è¯**:æ‚¨å¯ä»¥åœ¨`crontab` & `anacrontab`æ–‡ä»¶ä¸­ä¸ºä¸Šè¿°ç›®å½•æŒ‡å®šç‰¹å®šçš„é€»è¾‘:

```
*/1 * * * * root run-parts /etc/cron.hourly
```

æ‰€ä»¥ï¼Œ`cron.hourly`é‡Œé¢çš„æ–‡ä»¶ä¼šè¢«è¿è¡Œ

ç„¶åï¼Œä½ å¯ä»¥åˆ—å‡ºæ‰€æœ‰ç°å­˜çš„å…‹éš†äºº`crontab -l` &ç¼–è¾‘ä»–ä»¬`crontab -e`

ğŸ˜¶â€ğŸŒ«ï¸

å›åˆ°`anacrontab`:æœ‰ 2 ä¸ªæ•°å­—ï¼Œè€Œä¸æ˜¯ 5 ä¸ªã€‚å½“æˆ‘ä»¬è°ˆåˆ°å¼€æœºåçš„æ—¶é—´**æ—¶ï¼Œæ‚¨éœ€è¦æŒ‡å®š:**

*   é—´éš”å¤©æ•°:`0 || 7`æ˜¯æ˜ŸæœŸå¤©ï¼Œæ˜ŸæœŸä¸€æ˜¯`1`
*   å¯åŠ¨åçš„æ—¶é—´é—´éš”:åˆ†é’Ÿ

`1 10 someJob /home/user_name/some_script.sh`:æ¯å‘¨ä¸€å¼€æœºååˆ†é’Ÿåè¿è¡Œã€‚`someJob`æ˜¯ä¸€ä¸ª**ä½œä¸šæ ‡è¯†ç¬¦**ï¼Œå®ƒå¯¹äºæ¯ä¸ª cron å¿…é¡»æ˜¯å”¯ä¸€çš„ã€‚

æ‚¨å¯èƒ½ä¼šå”±åè°ƒï¼Œè¯´:â€œå¦‚æœæˆ‘ä»¬åœ¨**anacrontab**&**crontab**ä¸­æ”¾ä¸¤ä¸ªç›¸åŒçš„è¡Œä¼šæ€ä¹ˆæ ·ï¼Ÿâ€æˆ‘ä¼šåŠæ—¶ç»™ä½ ç­”æ¡ˆ:" **Anacrontab** *æ¯”æ™®é€š **crontab** æ›´æµè¡Œ*"

## éå¸¸é‡è¦çš„è¯´æ˜

å¦‚æœä½ æƒ³ç”¨æ—¶é—´è¿è¡Œä¸€äº›ä¸œè¥¿:è¾“å…¥`cron.d`ã€‚å¦‚æœä½ æƒ³æœ‰`.daily`ã€`.weekly`ç­‰ç­‰:æ”¾åœ¨ç›¸åº”çš„æ–‡ä»¶å¤¹é‡Œã€‚

ç„¶åï¼Œå¦‚æœæ‚¨æƒ³è®©æ–‡ä»¶åœ¨å¼•å¯¼åä»¥ç‰¹å®šçš„é—´éš”è¿è¡Œ:`anacrontab`ã€‚æ‚¨å¯ä»¥åœ¨å…¶ä»–ç›®å½•ä¸­æŒ‡å®šæ–‡ä»¶/è„šæœ¬ã€‚

å¦å¤–ï¼Œè¯·é˜…è¯»ä¸‹é¢å…³äºâ€œserverfaultâ€çš„å…³äº`cron.d`çš„å¸–å­ï¼Œä»¥åŠ Linux å¦‚ä½•åœ¨ä¸ä½¿ç”¨`crontab`çš„æƒ…å†µä¸‹å‘ç°é‚£é‡Œçš„æ–‡ä»¶:

[](https://serverfault.com/a/358430) [## cron.d å¦‚ä½•é€šçŸ¥ç³»ç»Ÿï¼Ÿ

### æ„Ÿè°¢æ‚¨å¯¹æœåŠ¡å™¨æ•…éšœçš„å›ç­”ï¼è¯·åŠ¡å¿…å›ç­”é—®é¢˜ã€‚æä¾›è¯¦ç»†ä¿¡æ¯å¹¶åˆ†äº«â€¦

serverfault.com](https://serverfault.com/a/358430) 

å’Œå¦ä¸€ä¸ªå…³äºâ€œunix.stackexchangeâ€ä¸Šçš„`crontab` & `cron.d`çš„åŒºåˆ«:

[](https://unix.stackexchange.com/a/417327) [## cron.d(å¦‚/etc/cron.d/)å’Œ crontab æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

### æ„Ÿè°¢æ‚¨å¯¹ Unix & Linux å †æ ˆäº¤æ¢çš„å›ç­”ï¼è¯·åŠ¡å¿…å›ç­”é—®é¢˜ã€‚æä¾›â€¦

unix.stackexchange.com](https://unix.stackexchange.com/a/417327) 

## ä½¿ç”¨ Dockerfile è¿è¡Œ cron çš„ Picklang ç¤ºä¾‹

åœ¨å¯åŠ¨é˜¶æ®µï¼Œæˆ‘ä»¬å†³å®šç»“åˆ Django ç®¡ç†å‘½ä»¤å’Œ cron å‘ç”¨æˆ·å‘é€æ¨é€ã€‚æ€ä¹ˆåšåˆ°çš„ï¼ŸğŸ¤”

> PS:æˆ‘ä¸èƒ½é€éœ²çœŸæ­£çš„ä»£ç æˆ–ç‰‡æ®µï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘åœ¨è¿™é‡Œå°†ä½¿ç”¨åˆ†ç¦»çš„ä¾‹å­

1.  `management/commands`ä¸­çš„`.py`æ–‡ä»¶ç°åœ¨è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªå¯è¡Œçš„ç®¡ç†å‘½ä»¤ã€‚åœ¨æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬æœ‰æ ¹æ®æ ‡å‡†é€‰æ‹©ç”¨æˆ·çš„é€»è¾‘ã€‚ç„¶åæˆ‘ä»¬åˆ©ç”¨ APNS æ¥æ¨åŠ¨ã€‚
2.  åˆ›å»º**çº¯æ–‡æœ¬**æ–‡ä»¶ï¼Œæˆ‘åœ¨å…¶ä¸­æ”¾ç½® cron çš„é€»è¾‘:

*   è¿™é‡Œ`*`çš„å†…å®¹æ˜¯æ¯ 45 åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ cronã€‚
*   ç„¶åï¼Œè¾“å…¥`app` dirã€‚ä¸ºä»€ä¹ˆï¼Ÿ- >åœ¨ **Dockerfile** ä¸­é»˜è®¤å…¨éƒ¨ä½¿ç”¨`app`
*   æ¥ä¸‹æ¥ï¼Œåˆ©ç”¨ Dockerfile python3 ä¸­å®‰è£…çš„
*   `python3 manage.py send_push`æ˜¯è°ƒç”¨ä¸€ä¸ª *Django ç®¡ç†å‘½ä»¤*
*   é‚£ä¸ªå¥‡æ•°`> /proc` â€¦æ˜¯æ ‡å‡†è¾“å‡ºæˆ–æ ‡å‡†è¾“å‡º

3.Dockerfile ç¤ºä¾‹:

1.  å°†çº¯æ–‡æœ¬æ–‡ä»¶å¤åˆ¶åˆ°`cron.d`:ç¬¬ 3 è¡Œ
2.  æŒ‡å®šæƒé™å¹¶å‘ crontab æ³¨å†Œæˆ‘ä»¬çš„ cron
3.  ç”¨&åœ¨åå°è¿è¡Œ cron
4.  ç”¨&&æŠŠå®ƒå’Œ gunicorn ç²˜åœ¨ä¸€èµ·è¿è¡Œ app

## æœ€åçš„è¯ğŸ™Œ

æˆ‘å¸Œæœ›ä½ èƒ½å¾—åˆ°ä¸€äº›å¯¹ä½ çš„å·¥ä½œæœ‰å¸®åŠ©çš„ä¸œè¥¿& side-projectsâš¡ï¸

æ­¤å¤–ï¼Œæ‚¨å¯ä»¥ç ”ç©¶æ‰€è°“çš„`systemd timer`ï¼Œå®ƒæ˜¯ **cron** çš„æ¨¡æ‹Ÿï¼Œä½†æ˜¯å…·æœ‰æ›´å¤§çš„çµæ´»æ€§ã€‚ğŸ¤¸â€â™‚ï¸

ä½ èƒ½æ‰¾åˆ°æˆ‘ğŸ”ï¼š

*   é¢†è‹±:[www.linkedin.com/in/sleeplesschallenger](http://www.linkedin.com/in/sleeplesschallenger)
*   GitHub:[https://github.com/SleeplessChallenger](https://github.com/SleeplessChallenger)
*   leet code:[https://leetcode.com/SleeplessChallenger/](https://leetcode.com/SleeplessChallenger/)
*   ç”µæŠ¥:@æ— çœ æŒ‘æˆ˜è€…