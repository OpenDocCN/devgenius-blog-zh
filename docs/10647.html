<html>
<head>
<title>How to write unit tests easily with Gtest(C++) (Part 2)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用 Gtest(C++)轻松编写单元测试(第 2 部分)</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/how-to-write-unit-tests-easily-with-gtest-c-part-2-bb6b8fd0b3db?source=collection_archive---------7-----------------------#2022-11-19">https://blog.devgenius.io/how-to-write-unit-tests-easily-with-gtest-c-part-2-bb6b8fd0b3db?source=collection_archive---------7-----------------------#2022-11-19</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div class="gh gi jk"><img src="../Images/fb2f5234976612b661848722363d44b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1250/format:webp/1*8wklSO-gVik7ky6Xxr3K3A.jpeg"/></div></figure><h1 id="dc8d" class="jr js in bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">介绍</h1><p id="9e27" class="pw-post-body-paragraph kp kq in kr b ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">正如我们在上一部分中看到的，我们设置了 Gtest，讨论了我们想要做的事情，并在运行第一个测试之前了解了我们需要知道的内容。</p><div class="ln lo gp gr lp lq"><a href="https://medium.com/@miladv33/how-to-write-unit-tests-easily-with-gtest-c-part-1-2399f36693e6" rel="noopener follow" target="_blank"><div class="lr ab fo"><div class="ls ab lt cl cj lu"><h2 class="bd io gy z fp lv fr fs lw fu fw im bi translated">如何用 Gtest(C++)轻松编写单元测试(第 1 部分)</h2><div class="lx l"><h3 class="bd b gy z fp lv fr fs lw fu fw dk translated">介绍</h3></div><div class="ly l"><p class="bd b dl z fp lv fr fs lw fu fw dk translated">medium.com</p></div></div><div class="lz l"><div class="ma l mb mc md lz me jp lq"/></div></div></a></div><p id="32c2" class="pw-post-body-paragraph kp kq in kr b ks mf ku kv kw mg ky kz la mh lc ld le mi lg lh li mj lk ll lm ig bi translated">作为第一步，我们将编写一个非常简单的单元测试。要查看完整的代码库，请查看这个库。</p><div class="ln lo gp gr lp lq"><a href="https://github.com/miladv33/TestGmock" rel="noopener  ugc nofollow" target="_blank"><div class="lr ab fo"><div class="ls ab lt cl cj lu"><h2 class="bd io gy z fp lv fr fs lw fu fw im bi translated">GitHub - miladv33/TestGmock</h2><div class="lx l"><h3 class="bd b gy z fp lv fr fs lw fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="ly l"><p class="bd b dl z fp lv fr fs lw fu fw dk translated">github.com</p></div></div><div class="lz l"><div class="mk l mb mc md lz me jp lq"/></div></div></a></div><h1 id="3cba" class="jr js in bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">测试什么？</h1><p id="72fe" class="pw-post-body-paragraph kp kq in kr b ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">“服务”是我们想要的类的名称。这个类从服务器获取当前的计时器。首先，我们必须编写测试函数，然后我们将根据我们在测试函数中想要的内容编写“生产代码”。(你好 TDD)</p><figure class="mm mn mo mp gt jo gh gi paragraph-image"><div class="gh gi ml"><img src="../Images/39f5f8e730ef26ea01b39709533420e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*XDaurgJJK8KfgXtwSZ13IQ.jpeg"/></div></figure><h1 id="37ce" class="jr js in bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">第一步</h1><p id="7e09" class="pw-post-body-paragraph kp kq in kr b ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">在项目中创建一个名为“Test”的新文件夹。所有测试类都将包含在该文件夹中。</p><figure class="mm mn mo mp gt jo gh gi paragraph-image"><div class="gh gi mq"><img src="../Images/8650a69f64b635f73f0fab0c68ec4525.png" data-original-src="https://miro.medium.com/v2/resize:fit:872/format:webp/1*V6_BpjgKX33Ak2hS6JAyJg.png"/></div></figure><p id="ca80" class="pw-post-body-paragraph kp kq in kr b ks mf ku kv kw mg ky kz la mh lc ld le mi lg lh li mj lk ll lm ig bi translated">在“Test”文件夹中，应该有另一个名为“Service”的文件夹。这个文件夹将包含 ServiceTest.cpp。现在是我添加我们在上一节中讨论的头的时候了。</p><h1 id="4111" class="jr js in bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">测试用例名称和测试套件名称</h1><p id="4044" class="pw-post-body-paragraph kp kq in kr b ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">正如我所说的，这里我们想要测试一个服务类。那么这个测试套件的名称是什么呢？是“ServiceTest”。然后我们应该考虑我们的测试用例的名字。我们想从服务器获取时间，所以姑且称之为“get time”。</p><h1 id="e4f3" class="jr js in bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">TEST(g TEST 关键字)</h1><p id="f681" class="pw-post-body-paragraph kp kq in kr b ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">当你在 Gtest 中编写一个测试函数时，你做的和你定义它时有一点不同。我们的第一个测试应该定义如下:</p><pre class="mm mn mo mp gt mr ms mt bn mu mv bi"><span id="da31" class="mw js in ms b be mx my l mz na">#include &lt;gtest/gtest.h&gt;<br/><br/>TEST(ServiceTest, GetTime) {<br/>//arrange<br/><br/>//act<br/><br/>//assert<br/><br/>}</span></pre><p id="815b" class="pw-post-body-paragraph kp kq in kr b ks mf ku kv kw mg ky kz la mh lc ld le mi lg lh li mj lk ll lm ig bi translated">我想在“排列”部分定义我想测试的类。这是“服务”类。</p><pre class="mm mn mo mp gt mr ms mt bn mu mv bi"><span id="df99" class="mw js in ms b be mx my l mz na">#include &lt;gtest/gtest.h&gt;<br/><br/>TEST(ServiceTest, GetTime) {<br/>//arrange<br/> Service service;<br/>//act<br/><br/>//assert<br/><br/>}</span></pre><p id="a8e4" class="pw-post-body-paragraph kp kq in kr b ks mf ku kv kw mg ky kz la mh lc ld le mi lg lh li mj lk ll lm ig bi translated">我们的生产代码里有没有一个叫“服务”的类？<strong class="kr io">否</strong>。我们来写吧。这是。h 文件:</p><pre class="mm mn mo mp gt mr ms mt bn mu mv bi"><span id="5f7c" class="mw js in ms b be mx my l mz na">class Service<br/>{<br/>public:<br/> <br/>};</span></pre><p id="8883" class="pw-post-body-paragraph kp kq in kr b ks mf ku kv kw mg ky kz la mh lc ld le mi lg lh li mj lk ll lm ig bi translated">和 cpp 文件:</p><pre class="mm mn mo mp gt mr ms mt bn mu mv bi"><span id="a8b3" class="mw js in ms b be mx my l mz na">#include "Service.h"</span></pre><p id="e22e" class="pw-post-body-paragraph kp kq in kr b ks mf ku kv kw mg ky kz la mh lc ld le mi lg lh li mj lk ll lm ig bi translated">现在我们可以继续编写下一部分，而不会在 IDE 中看到任何错误。</p><pre class="mm mn mo mp gt mr ms mt bn mu mv bi"><span id="e02c" class="mw js in ms b be mx my l mz na">#include &lt;gtest/gtest.h&gt;<br/>#include "Service.h"<br/><br/>TEST(ServiceTest, GetTime) {<br/>//arrange<br/> Service service;<br/>//act<br/> long number = service.getNumber();<br/>//assert<br/><br/>}</span></pre><p id="b5a1" class="pw-post-body-paragraph kp kq in kr b ks mf ku kv kw mg ky kz la mh lc ld le mi lg lh li mj lk ll lm ig bi translated">我们再次面临一个熟悉的问题。在“服务”类中，有没有一个叫“getNumber”的方法？<strong class="kr io">没有</strong>。现在就写吧。(熟悉的回答也是)。</p><pre class="mm mn mo mp gt mr ms mt bn mu mv bi"><span id="b33b" class="mw js in ms b be mx my l mz na">class Service<br/>{<br/>public:<br/>   long getNumber();<br/>};</span></pre><p id="1bc0" class="pw-post-body-paragraph kp kq in kr b ks mf ku kv kw mg ky kz la mh lc ld le mi lg lh li mj lk ll lm ig bi translated">再一次，没有错误。发生了什么事？TDD 引导我们写代码。在 TDD 中，你不会有任何代码，除了它被测试。</p><p id="0960" class="pw-post-body-paragraph kp kq in kr b ks mf ku kv kw mg ky kz la mh lc ld le mi lg lh li mj lk ll lm ig bi translated">让我们完成我们的测试:</p><pre class="mm mn mo mp gt mr ms mt bn mu mv bi"><span id="e824" class="mw js in ms b be mx my l mz na">#include &lt;gtest/gtest.h&gt;<br/>#include "Service.h"<br/><br/>TEST(ServiceTest, GetTime) {<br/>//arrange<br/> Service service;<br/>//act<br/> long number = service.getNumber();<br/>//assert<br/> EXPECT_EQ(number, 0);<br/>}</span></pre><p id="48cf" class="pw-post-body-paragraph kp kq in kr b ks mf ku kv kw mg ky kz la mh lc ld le mi lg lh li mj lk ll lm ig bi translated">EXPECT_EQ 是一个给定参数的 Gtest 函数。第一个参数是我们想要检查的值，第二个参数是我们期望第一个参数必须是的值。所以在这种情况下，我们要检查“数字”是否等于“0”。</p><p id="578f" class="pw-post-body-paragraph kp kq in kr b ks mf ku kv kw mg ky kz la mh lc ld le mi lg lh li mj lk ll lm ig bi translated">这是我们第一个简单的测试案例。现在，我将运行它来查看结果。</p><h1 id="10fc" class="jr js in bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">如何运行测试？</h1><p id="3525" class="pw-post-body-paragraph kp kq in kr b ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">我将在项目的主函数中添加以下代码行:</p><pre class="mm mn mo mp gt mr ms mt bn mu mv bi"><span id="869f" class="mw js in ms b be mx my l mz na">#include &lt;gtest/gtest.h&gt;<br/>using ::testing::_;<br/><br/>int main(int argc, char** argv) {<br/>    testing::InitGoogleTest(&amp;argc, argv);<br/>    return RUN_ALL_TESTS();<br/>}</span></pre><p id="d242" class="pw-post-body-paragraph kp kq in kr b ks mf ku kv kw mg ky kz la mh lc ld le mi lg lh li mj lk ll lm ig bi translated">现在可以运行测试来看看会发生什么。</p><figure class="mm mn mo mp gt jo gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/c3f28223bb349100451284839870add1.png" data-original-src="https://miro.medium.com/v2/resize:fit:996/format:webp/1*V0kOZGXi-2JYN9iE__3TdA.png"/></div></figure><h1 id="5f83" class="jr js in bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">模拟的</h1><p id="314d" class="pw-post-body-paragraph kp kq in kr b ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">现在嘲讽服务类的目的是返回别的东西来代替。我想返回“1”而不是“0”。然而，我只想嘲弄它，我不想改变“服务”。cpp”。</p><p id="a6ab" class="pw-post-body-paragraph kp kq in kr b ks mf ku kv kw mg ky kz la mh lc ld le mi lg lh li mj lk ll lm ig bi translated">因此，我将创建一个名为“MockService.cpp”的新文件</p><pre class="mm mn mo mp gt mr ms mt bn mu mv bi"><span id="1bf0" class="mw js in ms b be mx my l mz na">#include "Service.h"<br/><br/>class MockService :public Service {<br/>public:<br/> MOCK_METHOD0(getNumber, long());<br/>};</span></pre><p id="8c62" class="pw-post-body-paragraph kp kq in kr b ks mf ku kv kw mg ky kz la mh lc ld le mi lg lh li mj lk ll lm ig bi translated">因为嘲讽，我应该改变服务类的一些东西。</p><pre class="mm mn mo mp gt mr ms mt bn mu mv bi"><span id="595a" class="mw js in ms b be mx my l mz na">class Service<br/>{<br/>public:<br/> virtual long getNumber();<br/>};</span></pre><p id="e750" class="pw-post-body-paragraph kp kq in kr b ks mf ku kv kw mg ky kz la mh lc ld le mi lg lh li mj lk ll lm ig bi translated">这允许 Gtest 覆盖“getNumber”函数。所以我们可以尽情嘲笑。</p><pre class="mm mn mo mp gt mr ms mt bn mu mv bi"><span id="a43b" class="mw js in ms b be mx my l mz na">#include &lt;gtest/gtest.h&gt;<br/>#include "MockMyService.h"<br/><br/>TEST(ServiceTest, GetTime) {<br/>//arrange<br/> MockService serviceTest;<br/>//act<br/> long number = service.getNumber();<br/>//assert<br/> EXPECT_EQ(number, 0);<br/>}</span></pre><p id="f6f4" class="pw-post-body-paragraph kp kq in kr b ks mf ku kv kw mg ky kz la mh lc ld le mi lg lh li mj lk ll lm ig bi translated">现在我们使用的是“MockMyService”而不是“Service”，您可以看到不同之处。</p><pre class="mm mn mo mp gt mr ms mt bn mu mv bi"><span id="6556" class="mw js in ms b be mx my l mz na">#include &lt;gtest/gtest.h&gt;<br/>#include &lt;gmock/gmock.h&gt;<br/>#include "MockMyService.h"<br/><br/>TEST(ServiceTest, ServiceTestWithMock) {<br/> //arrange<br/> MockService serviceTest;<br/> EXPECT_CALL(serviceTest, getNumber()).Times(1).WillOnce(Return(1));<br/> //act <br/> long number = serviceTest.getNumber();<br/> //assert<br/> EXPECT_EQ(number, 1);<br/>}</span></pre><h1 id="fc28" class="jr js in bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">期望 _ 呼叫</h1><p id="eb32" class="pw-post-body-paragraph kp kq in kr b ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">什么是 Expect_call Gtest？</p><blockquote class="nc nd ne"><p id="849f" class="kp kq nf kr b ks mf ku kv kw mg ky kz ng mh lc ld nh mi lg lh ni mj lk ll lm ig bi translated">EXPECT_CALL <strong class="kr io">不仅定义了行为，还设置了一个期望，即该方法将以给定的参数调用给定的次数</strong>(当您指定顺序时，也以给定的顺序)</p></blockquote><div class="ln lo gp gr lp lq"><a href="https://stackoverflow.com/questions/13933475/gmock-setting-default-actions-on-call-vs-expect-call" rel="noopener  ugc nofollow" target="_blank"><div class="lr ab fo"><div class="ls ab lt cl cj lu"><h2 class="bd io gy z fp lv fr fs lw fu fw im bi translated">Gmock 设置默认操作/ ON_CALL 与 EXPECT_CALL</h2><div class="lx l"><h3 class="bd b gy z fp lv fr fs lw fu fw dk translated">这两种说法之间有细微但重要的区别。EXPECT_CALL 在模拟调用上设置期望…</h3></div><div class="ly l"><p class="bd b dl z fp lv fr fs lw fu fw dk translated">stackoverflow.com</p></div></div><div class="lz l"><div class="nj l mb mc md lz me jp lq"/></div></div></a></div><p id="8a37" class="pw-post-body-paragraph kp kq in kr b ks mf ku kv kw mg ky kz la mh lc ld le mi lg lh li mj lk ll lm ig bi translated">因此，我们知道如何使用 TDD 编写一个简单的单元测试。</p><figure class="mm mn mo mp gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="nl nm di nn bf no"><div class="gh gi nk"><img src="../Images/30de989b300873e564bca773be8882a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m5-elFkVFSTsx7lcs1OKkw.jpeg"/></div></div></figure></div></div>    
</body>
</html>