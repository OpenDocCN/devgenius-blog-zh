<html>
<head>
<title>Laravel works with Large database records using the chunk method</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Laravel 使用 chunk 方法处理大型数据库记录</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/laravel-works-with-large-database-records-using-the-chunk-method-9b69f41264da?source=collection_archive---------0-----------------------#2022-10-18">https://blog.devgenius.io/laravel-works-with-large-database-records-using-the-chunk-method-9b69f41264da?source=collection_archive---------0-----------------------#2022-10-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="5be5" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">Laravel 分块数据库查询结果</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/128f8500843363dfee86b798f54748ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hYgj8SFeQBGLps5C"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://unsplash.com/@seffen99?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">斯文·布兰德斯马</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="9847" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您的应用程序数据库记录每天都会增加。作为一名开发人员，在处理大型表记录时，我们面临着性能和服务器内存问题。在这篇博客中，我们将处理大型表记录，并解释雄辩的<a class="ae kv" href="https://laravel.com/docs/9.x/queries#chunking-results" rel="noopener ugc nofollow" target="_blank"> chunk </a>方法的重要性。</p><p id="175e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们需要一个演示应用程序来处理大量记录。</p><h2 id="9b37" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated"><strong class="ak"> 1。Laravel 安装</strong></h2><p id="6a72" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">像往常一样，我们将在本地安装<a class="ae kv" href="https://github.com/balajidharma/basic-laravel-admin-panel" rel="noopener ugc nofollow" target="_blank">基本的 Laravel 管理面板</a>。这种基本的管理员是由具有角色和权限的用户提供的。</p><p id="d20f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://github.com/balajidharma/basic-laravel-admin-panel" rel="noopener ugc nofollow" target="_blank">基本 Laravel 管理面板</a>基于<a class="ae kv" href="https://github.com/laravel/sail" rel="noopener ugc nofollow" target="_blank"> Laravel Sail </a>。什么是帆？<a class="ae kv" href="https://laravel.com/docs/8.x/sail" rel="noopener ugc nofollow" target="_blank"> Sail </a>是一个内置的解决方案，用于使用<a class="ae kv" href="https://www.docker.com/" rel="noopener ugc nofollow" target="_blank"> Docker </a>运行您的 Laravel 项目。</p><p id="ae29" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">参考<a class="ae kv" href="https://github.com/balajidharma/basic-laravel-admin-panel#installation" rel="noopener ugc nofollow" target="_blank">https://github . com/balajidharma/basic-laravel-admin-panel #安装</a>步骤，完成安装。</p></div><div class="ab cl mq mr hu ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="ij ik il im in"><h2 id="ba3d" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">2.演示数据</h2><p id="86be" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">对于演示记录，我们将使用 Laravel <a class="ae kv" href="https://laravel.com/docs/9.x/seeding#writing-seeders" rel="noopener ugc nofollow" target="_blank">播种器</a>在用户表上创建虚拟用户。要生成一个播种机，执行<code class="fe mx my mz na b">make:seeder</code> <a class="ae kv" href="https://laravel.com/docs/9.x/artisan" rel="noopener ugc nofollow" target="_blank"> Artisan 命令</a>。</p><pre class="kg kh ki kj gt nb na nc nd aw ne bi"><span id="189a" class="ls lt iq na b gy nf ng l nh ni">./vendor/bin/sail php artisan make:seeder UserSeeder</span><span id="f5e9" class="ls lt iq na b gy nj ng l nh ni">INFO  Seeder [database/seeders/UserSeeder.php] created successfully.</span></pre><p id="caa0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">打开位于<code class="fe mx my mz na b">database/seeders/UserSeeder.php</code>上的生成的种子文件，用下面的代码更新。</p><pre class="kg kh ki kj gt nb na nc nd aw ne bi"><span id="4720" class="ls lt iq na b gy nf ng l nh ni">&lt;?php</span><span id="0499" class="ls lt iq na b gy nj ng l nh ni">namespace Database\Seeders;</span><span id="d8ab" class="ls lt iq na b gy nj ng l nh ni">use Illuminate\Database\Seeder;<br/>use Illuminate\Support\Facades\DB;<br/>use Illuminate\Support\Facades\Hash;<br/>use Illuminate\Support\Str;</span><span id="ef1a" class="ls lt iq na b gy nj ng l nh ni">class UserSeeder extends Seeder<br/>{<br/>    /**<br/>     * Run the database seeds.<br/>     *<br/>     * @return void<br/>     */<br/>    public function run()<br/>    {<br/>        for ($i=0; $i &lt; 1000; $i++) { <br/>            DB::table('users')-&gt;insert([<br/>                'name' =&gt; Str::random(10),<br/>                'email' =&gt; Str::random(10).'@gmail.com',<br/>                'password' =&gt; Hash::make('password'),<br/>            ]);<br/>        }<br/>    }<br/>}</span></pre><p id="3c62" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在使用下面的 Artisan 命令运行播种机。完成播种需要额外的时间。</p><pre class="kg kh ki kj gt nb na nc nd aw ne bi"><span id="69a7" class="ls lt iq na b gy nf ng l nh ni">./vendor/bin/sail php artisan db:seed --class=UserSeeder</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nk"><img src="../Images/4c4cc4404d58b2f1cdcd979817c1da11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KRP1GWjakFk4uXz1F2e3Fg.png"/></div></div></figure><p id="42ce" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在 Artisan 命令之后，在用户列表页面<a class="ae kv" href="http://localhost/admin/user" rel="noopener ugc nofollow" target="_blank">http://localhost/admin/user</a>上验证创建的用户</p></div><div class="ab cl mq mr hu ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="ij ik il im in"><h2 id="ad5f" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">3.处理大量记录</h2><p id="d55f" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">现在我们要处理大量的用户记录。假设我们需要向所有用户发送黑色星期五优惠通知电子邮件。通常，我们生成新的<a class="ae kv" href="https://laravel.com/docs/9.x/artisan#generating-commands" rel="noopener ugc nofollow" target="_blank"> Artisan 命令</a>并通过使用调度器任务发送电子邮件。</p><h2 id="48c9" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">内存问题</h2><p id="337f" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">我们将获取所有用户，并在每个循环内发送电子邮件。</p><pre class="kg kh ki kj gt nb na nc nd aw ne bi"><span id="c07b" class="ls lt iq na b gy nf ng l nh ni">$users = User::all();<br/>$users-&gt;each(function ($user, $key) {<br/>    echo $user-&gt;name;<br/>});</span></pre><p id="a510" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您有数百万条记录，或者如果您的结果集合有许多关系数据，您的服务器将抛出<strong class="ky ir">允许的内存字节数用尽</strong>错误。</p><p id="6537" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了解决这个问题，我们将通过在数据库或缓存中保存限制来处理有限的数据。</p><p id="0a2c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">示例:</strong>我们第一次获取 100 条记录，并将这 100 条记录保存在数据库表中。<br/>下次获取 100 到 200 条记录，并将这 200 条记录保存在数据库中。所以这种方法涉及额外的获取和更新。此外，我们需要在处理完所有记录后停止作业。</p><p id="232b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Laravel 提供了雄辩块方法的内置解决方案来处理大记录</p></div><div class="ab cl mq mr hu ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="ij ik il im in"><h2 id="baa7" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">4.拉勒维尔雄辩组块法</h2><p id="5589" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">Laravel 雄辩检查方法一次检索一小部分结果，并将每一部分结果送入闭包进行处理。</p><pre class="kg kh ki kj gt nb na nc nd aw ne bi"><span id="300f" class="ls lt iq na b gy nf ng l nh ni">User::chunk(100, function ($users) {<br/>    foreach ($users as $user) {<br/>        echo $user-&gt;name;<br/>    }<br/>});</span></pre></div><div class="ab cl mq mr hu ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="ij ik il im in"><h2 id="94ec" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">5.理解组块法</h2><p id="b829" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">我将在用户控制器中创建一个函数，并详细解释检查方法。</p><p id="6b95" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">打开 routes/admin.php 并添加以下路由</p><pre class="kg kh ki kj gt nb na nc nd aw ne bi"><span id="e52e" class="ls lt iq na b gy nf ng l nh ni">Route::get('send_emails', 'UserController@sendEmails');</span></pre><p id="c78f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在打开 app/Http/Controllers/Admin/user controller . PHP，添加<code class="fe mx my mz na b">sendEmails</code>方法。</p><p id="2697" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">不带块:<br/> </strong>添加以下代码后，打开<a class="ae kv" href="http://localhost/admin/send_emails" rel="noopener ugc nofollow" target="_blank">http://localhost/admin/send _ emails</a>页面</p><pre class="kg kh ki kj gt nb na nc nd aw ne bi"><span id="a266" class="ls lt iq na b gy nf ng l nh ni">public function sendEmails()<br/>{<br/>    $users = User::all();<br/>    $users-&gt;each(function ($user, $key) {<br/>        echo $user-&gt;name;<br/>    });<br/>}</span></pre><p id="c1c0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">打开 Laravel Debugbar 查询面板。<code class="fe mx my mz na b"><strong class="ky ir">select</strong> * <strong class="ky ir">from</strong> `users`</code>将获取所有 1000+记录。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nl"><img src="../Images/3c68dffe8ca249f61a12c0dca8edea89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xGV72jYERSP_GFYh2Za7Rg.png"/></div></div></figure><p id="8718" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">用组块法:<br/> </strong>用下面的代码替换相同的函数，在浏览器中查看页面。</p><pre class="kg kh ki kj gt nb na nc nd aw ne bi"><span id="772d" class="ls lt iq na b gy nf ng l nh ni">public function sendEmails()<br/>{<br/>    User::chunk(100, function ($users) {<br/>        foreach ($users as $user) {<br/>            echo $user-&gt;name;<br/>        }<br/>    });<br/>}</span></pre><p id="3974" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">chunk 方法添加限制并处理所有记录。因此，如果使用 chunk，它当时会处理 100 个记录集合。所以没有更多的内存问题。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nm"><img src="../Images/f660b7667c9e2a58b6f1c58dfc4694cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4Kjf-cFAk9BlWmyd2T7Q4A.png"/></div></div></figure></div><div class="ab cl mq mr hu ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="ij ik il im in"><h2 id="d86b" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">6.什么是<code class="fe mx my mz na b">chunkById</code>？</h2><p id="9461" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">这个<code class="fe mx my mz na b">chunkById</code>方法将根据记录的主键自动对结果进行分页。为了理解它，再次用下面的代码更新<code class="fe mx my mz na b">sendEmails</code>方法</p><pre class="kg kh ki kj gt nb na nc nd aw ne bi"><span id="ab55" class="ls lt iq na b gy nf ng l nh ni">public function sendEmails()<br/>{<br/>    User::chunkById(100, function ($users) {<br/>        foreach ($users as $user) {<br/>            echo $user-&gt;name;<br/>        }<br/>    });<br/>}</span></pre><p id="d098" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在用户<code class="fe mx my mz na b">id</code>在<code class="fe mx my mz na b">where</code>条件下加上 100 的限制。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nn"><img src="../Images/4cf483b00ff15cc0068437fbaa932d5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wcyHzuV-0Ik7xOE9m2guAQ.png"/></div></div></figure><pre class="kg kh ki kj gt nb na nc nd aw ne bi"><span id="9016" class="ls lt iq na b gy nf ng l nh ni">// <!-- -->chunkById<br/>select * from `users` where `id` &gt; 100 order by `id` asc limit 100<br/>select * from `users` where `id` &gt; 200 order by `id` asc limit 100<br/>select * from `users` where `id` &gt; 300 order by `id` asc limit 100</span><span id="699c" class="ls lt iq na b gy nj ng l nh ni">// <!-- -->chunk<br/>select * from `users` order by `users`.`id` asc limit 100 offset 0<br/>select * from `users` order by `users`.`id` asc limit 100 offset 100<br/>select * from `users` order by `users`.`id` asc limit 100 offset 200</span></pre><p id="c8ff" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当更新或删除<code class="fe mx my mz na b">closure</code>中的记录时，建议使用<code class="fe mx my mz na b">chunkById</code>(在循环中)。</p></div><div class="ab cl mq mr hu ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="ij ik il im in"><h2 id="2375" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">7.结论</h2><p id="17c9" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">当您处理大量记录时，雄辩的<a class="ae kv" href="https://laravel.com/docs/9.x/queries#chunking-results" rel="noopener ugc nofollow" target="_blank"> chunk </a>方法是一个非常有用的方法。还有，读一下收集<a class="ae kv" href="https://laravel.com/docs/9.x/collections#method-chunk" rel="noopener ugc nofollow" target="_blank">检查</a>的方法。</p></div><div class="ab cl mq mr hu ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="ij ik il im in"><p id="d368" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">感谢您的阅读。</p><p id="13d0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">敬请关注更多内容！</p><p id="8cf5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">【balajidharma.medium.com】跟我来<a class="ae kv" href="https://balajidharma.medium.com/" rel="noopener"><strong class="ky ir"><em class="no"/></strong></a>。</p></div></div>    
</body>
</html>