<html>
<head>
<title>How to build a streaming pipeline for Twitter Sentiment Analysis with GCE, Pub/Sub, Dataflow, BigQuery and the Natural Language API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用 GCE、Pub/Sub、Dataflow、BigQuery 和自然语言 API 为 Twitter 情感分析构建一个流管道</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/how-to-build-a-streaming-pipeline-for-twitter-sentiment-analysis-with-gce-pub-sub-dataflow-2e204115c81?source=collection_archive---------5-----------------------#2022-10-26">https://blog.devgenius.io/how-to-build-a-streaming-pipeline-for-twitter-sentiment-analysis-with-gce-pub-sub-dataflow-2e204115c81?source=collection_archive---------5-----------------------#2022-10-26</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/afb0ab2365156aca49134ca841aaa36f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*raOuPAhOVN7pszBMxbgSGQ.png"/></div></div></figure><p id="dc2a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">大约三年前，当我开始从事数据工程时，我非常渴望建立并运行我的第一条管道。我听说 GCP 很流行，我知道流式数据是游戏的名字。所以我着手建立 Twitter 情绪分析管道。接下来是大约两个月的沮丧和心痛。我几乎跨过了终点线，但由于某种原因(依赖地狱)无法让它在我的本地机器之外工作，我最终决定继续前进。</p><p id="4923" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">幸运的是，我现在对为什么以及如何使用管道中的组件有了更好的理解，并决定从头开始重新构建它。不时重温旧的项目想法是很有意义的。尤其是当你有更多经验的时候。</p><p id="446f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这是 GitHub 回购协议的链接。</p><h1 id="068d" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">范围和架构</h1><p id="afd3" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">在本教程结束时，我们将建立必要的资源，以便:</p><ol class=""><li id="c9ff" class="lx ly in jx b jy jz kc kd kg lz kk ma ko mb ks mc md me mf bi translated">与 Twitter API 通信</li><li id="5b3d" class="lx ly in jx b jy mg kc mh kg mi kk mj ko mk ks mc md me mf bi translated">向发布/订阅主题发送推文</li><li id="9c72" class="lx ly in jx b jy mg kc mh kg mi kk mj ko mk ks mc md me mf bi translated">订阅 Pub / Sub 主题，清理 tweets 并调用 Cloud NL API，使用数据流中的 Apache Beam worker 获得情感分数</li><li id="bfb6" class="lx ly in jx b jy mg kc mh kg mi kk mj ko mk ks mc md me mf bi translated">向 BigQuery 发送原始和干净的推文以及它们的情感分数</li></ol><p id="63f4" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">管道步骤如下所示:</p><figure class="mm mn mo mp gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ml"><img src="../Images/ffc320ddec9018976c5c0bfbd1c700a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sxsCIfmCAYzXNJPEXJnWJA.png"/></div></div></figure><h1 id="5bb7" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">入门指南</h1><h2 id="5f53" class="mq kv in bd kw mr ms dn la mt mu dp le kg mv mw li kk mx my lm ko mz na lq nb bi translated"><strong class="ak"> 1。Twitter API 证书</strong></h2><p id="4cef" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">首先，我们需要申请一个 Twitter 开发人员帐户，以便与 API 进行通信。前往 developer.twitter.com，注册您的帐户，创建一个应用程序，并将相关密钥保存在您的本地计算机上，因为您很快就会需要它们:</p><ul class=""><li id="8f7e" class="lx ly in jx b jy jz kc kd kg lz kk ma ko mb ks nc md me mf bi translated">API 密钥</li><li id="d5fe" class="lx ly in jx b jy mg kc mh kg mi kk mj ko mk ks nc md me mf bi translated">API 密钥机密</li><li id="69b9" class="lx ly in jx b jy mg kc mh kg mi kk mj ko mk ks nc md me mf bi translated">访问令牌</li><li id="8a8b" class="lx ly in jx b jy mg kc mh kg mi kk mj ko mk ks nc md me mf bi translated">访问令牌秘密</li></ul><h1 id="5907" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated"><strong class="ak"> 2。GCP 服务账户</strong></h1><p id="72e8" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">需要一个服务帐户来验证我们的 GCP 服务，并允许它们相互通信。转到云控制台中的 Admin &amp; IAM 窗格，创建一个新的服务帐户并添加以下角色:</p><figure class="mm mn mo mp gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nd"><img src="../Images/054cab688e92945d63f4856f2ba22938.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3n6XJvLr8OeavtV3VtOqSw.png"/></div></div></figure><ul class=""><li id="e3e5" class="lx ly in jx b jy jz kc kd kg lz kk ma ko mb ks nc md me mf bi translated"><em class="ne">“发布/订阅用户”</em></li><li id="adea" class="lx ly in jx b jy mg kc mh kg mi kk mj ko mk ks nc md me mf bi translated"><em class="ne"> "BigQuery 数据编辑器"</em></li><li id="7bd1" class="lx ly in jx b jy mg kc mh kg mi kk mj ko mk ks nc md me mf bi translated"><em class="ne">“存储管理员”</em></li><li id="f735" class="lx ly in jx b jy mg kc mh kg mi kk mj ko mk ks nc md me mf bi translated"><em class="ne">“服务账户用户”</em></li><li id="eb4c" class="lx ly in jx b jy mg kc mh kg mi kk mj ko mk ks nc md me mf bi translated"><em class="ne">“数据流管理”</em></li></ul><p id="5fff" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">创建完成后，单击服务帐户并生成一个. json 密钥。将它保存到您的本地环境中，因为您稍后将需要引用它。</p><h1 id="a728" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated"><strong class="ak"> 3。发布/订阅</strong></h1><p id="697d" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">到目前为止一切顺利。现在，我们将返回云控制台，设置我们的发布/订阅主题和订阅:</p><figure class="mm mn mo mp gt jo gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/81b5031f757dc1dcb31bcd80e9a8c0f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1106/format:webp/1*kNqxeKeANNpXZPFxkLoETQ.png"/></div></figure><figure class="mm mn mo mp gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ng"><img src="../Images/d8d13634aff9f9000ffa914d26aa1c1c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IKuOC6Gnjfmq8LjUrTaZdQ.png"/></div></div></figure><h1 id="2332" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">4.BigQuery</h1><p id="41ca" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">在 BigQuery 中，创建一个新的数据集和一个关联表。确保在创建表时添加模式:</p><pre class="mm mn mo mp gt nh ni nj nk aw nl bi"><span id="acab" class="mq kv in ni b gy nm nn l no np">text:STRING, id:STRING, created_at:STRING, timestamp:TIMESTAMP, tweet:STRING, sentiment_score:FLOAT, magnitude_score:FLOAT</span></pre><figure class="mm mn mo mp gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nq"><img src="../Images/0bfef44b003cbc9a7b4baf2def30056d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UEkivUMGhuOJ5paSIAJwUw.png"/></div></div></figure><h1 id="d53d" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">5.数据流</h1><p id="a8f0" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">在您的本地机器上打开一个终端，克隆 Twitter-Streamer repo 并启动您的 IDE:</p><pre class="mm mn mo mp gt nh ni nj nk aw nl bi"><span id="f9e0" class="mq kv in ni b gy nm nn l no np">git clone <a class="ae kt" href="https://github.com/sharisiri/twitter-streamer-GCP.git" rel="noopener ugc nofollow" target="_blank">https://github.com/sharisiri/twitter-streamer-GCP.git</a><br/>cd twitter-streamer-GCP<br/>code .</span></pre><p id="c338" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">导航到 Dataflow 文件夹并运行以下命令。注意，根据<a class="ae kt" href="https://googleapis.dev/python/language/latest/UPGRADING.html#enums-and-types" rel="noopener ugc nofollow" target="_blank"> GCP 迁移指南</a>，google-cloud-language 被设置为高于 v2(尽管我自己没有测试过任何其他版本)。</p><pre class="mm mn mo mp gt nh ni nj nk aw nl bi"><span id="f62f" class="mq kv in ni b gy nm nn l no np">pip install ‘apache-beam[gcp]’<br/>pip install google-cloud-language==2.6.1</span></pre><p id="2603" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">修改 beamtwittersentiment.py 中的凭据</p><pre class="mm mn mo mp gt nh ni nj nk aw nl bi"><span id="e6b3" class="mq kv in ni b gy nm nn l no np">#!/usr/bin/env python<br/>import argparse<br/>import json<br/>import os<br/>import logging<br/>import apache_beam as beam<br/>from apache_beam.options.pipeline_options import PipelineOptions, StandardOptions<br/>import re</span><span id="5f19" class="mq kv in ni b gy nr nn l no np">logging.basicConfig(level=logging.INFO)<br/>logging.getLogger().setLevel(logging.INFO)</span><span id="39d8" class="mq kv in ni b gy nr nn l no np">os.environ["GOOGLE_APPLICATION_CREDENTIALS"] = '&lt;YOUR_CREDS.JSON_FILE&gt;'<br/>INPUT_SUBSCRIPTION = "projects/&lt;PROJECT_ID&gt;/subscriptions/&lt;YOUR_PUBSUB_SUBSCRIPTION&gt;"<br/>BIGQUERY_TABLE = "&lt;PROJECT_ID&gt;:&lt;DATASET_ID&gt;.&lt;TABLE_NAME&gt;"<br/>BIGQUERY_SCHEMA = "text:STRING, id:STRING, created_at:STRING, timestamp:TIMESTAMP, tweet:STRING, sentiment_score:FLOAT, magnitude_score:FLOAT"</span><span id="bf01" class="mq kv in ni b gy nr nn l no np">class CustomParsing(beam.DoFn):<br/>    """ Custom ParallelDo class to apply a custom transformation """</span><span id="791b" class="mq kv in ni b gy nr nn l no np">def to_runner_api_parameter(self, unused_context):<br/>        return "beam:transforms:custom_parsing:custom_v0", None</span><span id="2c1f" class="mq kv in ni b gy nr nn l no np">def process(self, element: bytes, timestamp=beam.DoFn.TimestampParam, window=beam.DoFn.WindowParam):<br/>        # Super important to keep this import here and not at the top.<br/>        from google.cloud import language_v1<br/>        parsed = json.loads(element.decode("utf-8"))<br/>        text = parsed["text"]<br/>        # Removes website URLs<br/>        text = re.sub('<a class="ae kt" href="http://\S+|https://\S+'" rel="noopener ugc nofollow" target="_blank">http://\S+|https://\S+'</a>, '', text)<br/>        # Removes mentions<br/>        text = re.sub(r"@[A-Za-z0-9]+", "", text)<br/>        # Removes mentions where username has underscores<br/>        text = re.sub(r"@[A-Za-z0-9]+_", "", text)<br/>        # Removes hashtags<br/>        text = re.sub(r"#[A-Za-z0-9]+", "", text)<br/>        # Removes punctuation<br/>        text = re.sub(r'[^\w\s]', '', text)<br/>        # Removes retweets<br/>        text = text.replace("RT", "")<br/>        text = text.lower()<br/>        text = text.strip()<br/>        parsed["tweet"] = text<br/>        parsed["timestamp"] = timestamp.to_rfc3339()</span><span id="0c92" class="mq kv in ni b gy nr nn l no np"># Instantiates the Language API client<br/>        client = language_v1.LanguageServiceClient()<br/>        # Analyzes the input text<br/>        document = language_v1.Document(<br/>            content=text, type_=language_v1.Document.Type.PLAIN_TEXT<br/>        )</span><span id="e7eb" class="mq kv in ni b gy nr nn l no np"># Detects sentiment<br/>        sentiment = client.analyze_sentiment(<br/>            request={"document": document}<br/>        ).document_sentiment<br/>        parsed["sentiment_score"] = sentiment.score<br/>        parsed["magnitude_score"] = sentiment.magnitude</span><span id="43c4" class="mq kv in ni b gy nr nn l no np">yield parsed</span><span id="26b1" class="mq kv in ni b gy nr nn l no np">def run():<br/>    # Parsing arguments<br/>    parser = argparse.ArgumentParser()<br/>    parser.add_argument(<br/>        "--input_subscription",<br/>        help='Input PubSub subscription of the form "projects/&lt;PROJECT_ID&gt;/subscriptions/&lt;YOUR_PUBSUB_SUBSCRIPTION&gt;."',<br/>        default=INPUT_SUBSCRIPTION,<br/>    )<br/>    parser.add_argument(<br/>        "--output_table", help="Output BigQuery Table", default=BIGQUERY_TABLE<br/>    )<br/>    parser.add_argument(<br/>        "--output_schema",<br/>        help="Output BigQuery Schema in text format",<br/>        default=BIGQUERY_SCHEMA,<br/>    )<br/>    known_args, pipeline_args = parser.parse_known_args()</span><span id="7a34" class="mq kv in ni b gy nr nn l no np"># Creating pipeline options<br/>    pipeline_options = PipelineOptions(pipeline_args)<br/>    pipeline_options.view_as(StandardOptions).streaming = True</span><span id="1e23" class="mq kv in ni b gy nr nn l no np"># Defining our pipeline and its steps<br/>    with beam.Pipeline(options=pipeline_options) as p:<br/>        (<br/>            p<br/>            | "ReadFromPubSub" &gt;&gt; beam.io.gcp.pubsub.ReadFromPubSub(<br/>                subscription=known_args.input_subscription, timestamp_attribute=None<br/>            )<br/>            | "CustomParse" &gt;&gt; beam.ParDo(CustomParsing())<br/>            | "WriteToBigQuery" &gt;&gt; beam.io.WriteToBigQuery(<br/>                known_args.output_table,<br/>                schema=known_args.output_schema,<br/>                write_disposition=beam.io.BigQueryDisposition.WRITE_APPEND<br/>           )<br/>        )</span><span id="7071" class="mq kv in ni b gy nr nn l no np">if __name__ == "__main__":<br/>    run()</span></pre><p id="56c6" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">保存文件，从终端运行以下命令，在数据流上启动光束运行器:</p><pre class="mm mn mo mp gt nh ni nj nk aw nl bi"><span id="dfed" class="mq kv in ni b gy nm nn l no np">python3 beamtwittersentiment.py \<br/>    --project "&lt;YOUR_PROJECT_ID&gt;" \<br/>    --input_topic "projects/&lt;PROJECT_ID&gt;/subscriptions/&lt;YOUR_PUBSUB_SUBSCRIPTION&gt;" \<br/>    --runner DataflowRunner \<br/>    --staging_location "gs://&lt;YOUR_BEAM_BUCKET&gt;/stg" \<br/>    --temp_location "gs://YOUR_BEAM_BUCKET/temp" \<br/>    --region europe-north1 \<br/>    --save_main_session True \<br/>    --streaming \<br/>    --max_num_workers 1</span></pre><p id="646a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">确认数据流运行程序启动并运行，准备接收消息。</p><figure class="mm mn mo mp gt jo gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/257b1b74d5663e7528492d59d728515e.png" data-original-src="https://miro.medium.com/v2/resize:fit:530/format:webp/1*tTQeh5qj-w69tZ25-bnCtA.png"/></div></figure><h1 id="ff1d" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated"><strong class="ak"> 6。计算引擎</strong></h1><p id="7f17" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">计算引擎 VM 将充当 Twitter API 和 Pub / Sub 主题之间的中继，并基于一个关键字持续流式传输 tweets。</p><p id="b597" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在本地 repo 的 GCE/PubSub 文件夹中，有几个文件可以帮助我们设置必要的资源。</p><p id="dbdd" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">首先，将服务帐户密钥文件(json)复制到 repo，并在<strong class="jx io"> tweetstreamer.py </strong>中引用它，与前面步骤中的其他凭证放在一起。另外，请确保更改下面您想要跟踪的关键字。</p><pre class="mm mn mo mp gt nh ni nj nk aw nl bi"><span id="7757" class="mq kv in ni b gy nm nn l no np">#!/usr/bin/env python<br/>import json<br/>import tweepy<br/>from google.cloud import pubsub_v1<br/>from google.oauth2 import service_account</span><span id="66dd" class="mq kv in ni b gy nr nn l no np"># Service Account File<br/>key_path = "&lt;YOUR_CREDS.JSON_FILE&gt;"<br/>credentials = service_account.Credentials.from_service_account_file(<br/>    key_path,<br/>    scopes=["<a class="ae kt" href="https://www.googleapis.com/auth/cloud-platform" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/auth/cloud-platform</a>"]<br/>)</span><span id="6fd4" class="mq kv in ni b gy nr nn l no np"># Pub/Sub Client<br/>pubsub_client = pubsub_v1.PublisherClient(credentials=credentials)</span><span id="eb8d" class="mq kv in ni b gy nr nn l no np"># Pub/Sub Topic(ID, Topic)<br/>topic_path = pubsub_client.topic_path(<br/>    '&lt;YOUR_PUBSUB_ID&gt;', '&lt;YOUR_PUBSUB_TOPIC&gt;')</span><span id="e747" class="mq kv in ni b gy nr nn l no np"># # Twitter API Key / Access Token<br/>twitter_api_key = 'YOUR_API_KEY'<br/>twitter_api_secret_key = 'YOUR_API_SECRET_KEY'<br/>twitter_access_token = 'YOUR_ACCESS_TOKEN'<br/>twitter_access_token_secret = 'YOUR_ACCESS_TOKEN_SECRET'</span><span id="1a12" class="mq kv in ni b gy nr nn l no np">class TweetStreamer(tweepy.Stream):</span><span id="c2f7" class="mq kv in ni b gy nr nn l no np">def on_status(self, status):<br/>        tweet = json.dumps(<br/>            {'id': status.id, 'created_at': status.created_at, 'text': status.text}, default=str)<br/>        print(tweet)<br/>        pubsub_client.publish(topic_path, data=tweet.encode('utf-8'))</span><span id="7862" class="mq kv in ni b gy nr nn l no np">def on_error(self, status_code):<br/>        print(status_code)<br/>        if status_code == 420:<br/>            return False</span><span id="23a8" class="mq kv in ni b gy nr nn l no np"># Initialize steamer instance<br/>streamer = TweetStreamer(<br/>    consumer_key, consumer_secret,<br/>    access_token, access_token_secret<br/>)</span><span id="1fc1" class="mq kv in ni b gy nr nn l no np"># Filter real-time Tweets by keyword<br/>streamer.filter(languages=["en"], track=["Keyword-To-Track"])</span></pre><p id="272b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">然后在<strong class="jx io"> startup-script.sh </strong>中做同样的操作</p><pre class="mm mn mo mp gt nh ni nj nk aw nl bi"><span id="c534" class="mq kv in ni b gy nm nn l no np">#!/bin/bash<br/>cd /home/$USER<br/>apt -qq update<br/>apt-get install -yq python3 python3-pip<br/>gsutil cp gs://&lt;BUCKET_NAME&gt;/pubsub_creds.json .<br/>gsutil cp gs://&lt;BUCKET_NAME&gt;/requirements.txt .<br/>gsutil cp gs://&lt;BUCKET_NAME&gt;/tweetstreamer.py .<br/>pip3 install -r requirements.txt<br/>python3 tweetstreamer.py</span></pre><p id="800e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我强烈推荐下载<a class="ae kt" href="https://cloud.google.com/sdk/docs/install-sdk" rel="noopener ugc nofollow" target="_blank"> gcloud CLI 工具</a>，这将使创建资源和与云环境同步变得更加容易。</p><p id="115a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">使用控制台或使用 gsutil 命令将<strong class="jx io"> pubsub_creds.json </strong>、<strong class="jx io"> requirements.txt </strong>、<strong class="jx io"> </strong>和<strong class="jx io"> tweetstreamer.py </strong>上传到上述存储桶:</p><pre class="mm mn mo mp gt nh ni nj nk aw nl bi"><span id="0edb" class="mq kv in ni b gy nm nn l no np">gsutil cp pubsub_creds.json gs://&lt;BUCKET_NAME&gt;/ \<br/>gsutil cp tweetstreamer.py gs://&lt;BUCKET_NAME&gt;/ \<br/>gsutil cp requirements.txt gs://&lt;BUCKET_NAME&gt;/</span></pre><p id="cf91" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">最后，从 GCP 云 Shell 或通过您的本地终端运行以下命令:</p><pre class="mm mn mo mp gt nh ni nj nk aw nl bi"><span id="13ec" class="mq kv in ni b gy nm nn l no np">gcloud compute instances create &lt;VM_NAME&gt; \<br/>--project=&lt;YOUR_PROJECT_ID&gt; \<br/>--zone=&lt;YOUR_ZONE&gt; \<br/>--machine-type=&lt;INSTANCE_TYPE&gt; \<br/>--service-account=&lt;SERVICE_ACCOUNT_EMAIL&gt; \<br/>--create-disk=auto-delete=yes,boot=yes,device-name=&lt;VM-NAME&gt;,image=projects/debian-cloud/global/images/debian-11-bullseye-v20220920,mode=rw,size=10 \<br/>--metadata=startup-script-url=gs://&lt;BUCKET_NAME&gt;/startup-script.sh</span></pre><p id="d887" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如果您不想 SSH 到虚拟机并检查进度，您可以在本地或在云 Shell 中运行以下命令来查看启动进度:</p><pre class="mm mn mo mp gt nh ni nj nk aw nl bi"><span id="a6c9" class="mq kv in ni b gy nm nn l no np">gcloud compute instances get-serial-port-output &lt;VM_NAME&gt; --zone=&lt;YOUR_ZONE&gt;</span></pre><p id="ac2f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">一两分钟后，您应该开始在发布/订阅中看到消息:</p><figure class="mm mn mo mp gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nt"><img src="../Images/91b9e28647d0f8aae920a375a7a095bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_mN20N8R6XIbtRsqUDrlbw.png"/></div></div></figure><p id="3574" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在数据流中:</p><figure class="mm mn mo mp gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nu"><img src="../Images/99c039fcabf064f2d300db1591d9d7ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NfxTESt78et4r5JtH17C7g.png"/></div></div></figure><p id="d906" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">最后是 BigQuery 中的输出:</p><figure class="mm mn mo mp gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nv"><img src="../Images/49aff3356a33acfa08aa501cf86b5313.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uiwsBdOSE3O3EVNgCxww5A.png"/></div></div></figure><h1 id="4832" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">结论</h1><p id="1647" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">你有它！一个用于实时情绪分析的漂亮的小流管道。</p><p id="8a8f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在关闭之前，我运行了大约四天的管道。它跟踪了关键词特斯拉(因为目前对这个话题的看法似乎变化很大)，管道最终收集了大约 30 万条推文。</p><p id="8fb3" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我遇到的唯一主要问题是自然语言 API 仅限于一系列受支持的语言。尽管在 API 获取阶段将语言设置为英语作为过滤器，但一些 tweets 设法通过，随后数据流中出现错误。但是，这些消息会被丢弃，不会影响 BigQuery 的整体性能或吞吐量。</p><p id="507a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">确保对代码进行试验，尝试不同的关键字、语言等。但是请记住，如果你选择了某些被大量讨论的话题，你可能最终会触及 API 比率的极限！</p></div></div>    
</body>
</html>