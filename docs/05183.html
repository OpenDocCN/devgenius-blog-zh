<html>
<head>
<title>Debugging with Dashbird: Lambda Task Timed Out After X Seconds</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Dashbird进行调试:Lambda任务在X秒后超时</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/debugging-with-dashbird-lambda-task-timed-out-after-x-seconds-ab873016c0b4?source=collection_archive---------5-----------------------#2021-06-28">https://blog.devgenius.io/debugging-with-dashbird-lambda-task-timed-out-after-x-seconds-ab873016c0b4?source=collection_archive---------5-----------------------#2021-06-28</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/cecd540f3efd7e32c33edf26a9883ff8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*jcT56JoYqLC014g1.png"/></div></div></figure><p id="8782" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">当构建无服务器应用程序时，Lambda函数通常构成系统的主干。他们可能只提供了几行代码，但是这些行通常将由许多托管服务组成的整个架构联系在一起。</p><p id="1995" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这种风格被称为事件驱动架构，它在无服务器应用中最为流行。API网关<strong class="jx io">从你的用户那里收集</strong>请求，<strong class="jx io">将</strong>请求转换成事件，<strong class="jx io">沿途发送</strong>这些请求。有时，上游服务，如DynamoDB或SQS，可以直接处理这样的事件来节省Lambda调用成本。</p><p id="2430" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">通常情况下，我们需要<strong class="jx io">对事件</strong>应用一些验证和转换，以便服务可以处理它。这就是Lambda发挥作用的地方，也是我们超时的一个来源。</p><h1 id="e687" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">等待其他服务</h1><p id="1bcf" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated"><strong class="jx io">初学者在实现Lambda函数时的一个主要错误是等待该函数中的其他服务。</strong></p><p id="65ab" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">通常是这样的:</p><p id="5301" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">您创建了一个需要向多个其他服务读取或写入数据的函数；这可以是S3，Kinesis，甚至是另一个λ函数。因此，您选择这些服务中的一个作为Lambda的<strong class="jx io">事件源，然后尝试在您的函数中调用其他服务</strong>。它们都是通过网络连接的，所以你的函数等待它们的所有响应。</p><p id="7d66" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">根据你正在做的事情和涉及的服务数量，这个等待时间将会累加，迟早，Lambda超时会关闭你的功能。</p><h1 id="eb34" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">Lambda函数的默认最大超时是多少？</h1><p id="d50a" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">Lambda函数的默认超时是<strong class="jx io">三秒</strong>。这意味着，如果您不显式配置超时，您的函数调用将在三秒钟后暂停。</p><p id="ba7a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在，如果您调用几个服务，其中一些服务目前已满负荷，一个请求本身就很可能需要一秒钟。所以很快达到三秒钟的超时也就不足为奇了。</p><h1 id="1ad9" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">如何增加Lambda超时限制？</h1><p id="8352" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated"><strong class="jx io">这个问题的简单解决方案是在功能配置中增加超时</strong>。毕竟Lambda的超时上限是15分钟，所以跑道还是蛮有的。</p><p id="48f8" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这个解决方案的问题在于<strong class="jx io">它不是自由的</strong>。您为您的功能等待并无所作为的每一毫秒付费。这包括网络另一端的错误。如果某项服务有问题并且没有回答您，您仍然需要为等待支付费用，只是为了得到服务超时的通知，并且您没有得到任何您想要的东西。更不用说，如果这个功能直接影响到最终用户，这是一个主要的UX问题。</p><p id="c087" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">重构您的架构是一个更好的主意。</p><h1 id="fdb3" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">链接事件流</h1><figure class="ly lz ma mb gt jo gh gi paragraph-image"><div class="gh gi lx"><img src="../Images/b50562c01f40ad996d8f8c64b759f255.png" data-original-src="https://miro.medium.com/v2/resize:fit:482/format:webp/0*EohPOK26qre7AI8H.png"/></div></figure><p id="d4df" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如果您有一个Lambda函数因为等待多个服务的时间太长而超时，您可以<strong class="jx io">尝试使用这些服务作为新Lambda调用的事件源</strong>。例如，不要让一个Lambda函数调用十个服务，如图1所示；让它只调用一个，但是这个服务在完成后会触发一个新的Lambda函数，如图2所示。</p><figure class="ly lz ma mb gt jo gh gi paragraph-image"><div class="gh gi mc"><img src="../Images/9f3d3fc426bbaba6546c4f33c2b039d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:642/format:webp/0*At5wkeuVZw4njqEy.png"/></div></figure><p id="478d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这样，<strong class="jx io">您可以链接多个服务</strong>和Lambda函数，而<strong class="jx io">不必为Lambda调用时间</strong>付费，而其他服务可以工作。</p><h1 id="65a5" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">使用排队服务</h1><p id="20ab" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated"><strong class="jx io">你不应该用Lambda函数来编排</strong>。当您的工作负载足够复杂时，您应该<strong class="jx io">使用排队服务</strong>来协调它。AWS提供了大量的受管队列，而且大部分都是无服务器的。<strong class="jx io"> SQS、SNS、运动学和Step函数</strong>是在Lambda函数之外管理架构中数据流的方法。</p><figure class="ly lz ma mb gt jo gh gi paragraph-image"><div class="gh gi md"><img src="../Images/16fa74c8fe47311413ab026c97b5e15e.png" data-original-src="https://miro.medium.com/v2/resize:fit:722/format:webp/0*hrdG5gGuyJ2RjU3K.png"/></div></figure><p id="c67d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io"> Step Functions可以等待数周</strong>等待事件解决，甚至使用人工交互处理的手动解决器。在上面的图3中，您看到了架构是什么样子的。首先，API Gateway调用Step函数，然后Step函数负责编排其他服务，比如Lambda和DynamoDB。</p><h1 id="705e" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">构建复杂功能</h1><p id="910a" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">超时的下一个原因是复杂的Lambda函数，它一次做的事情太多了。<strong class="jx io">如果您来自一个更单一的应用架构，您可能会倾向于将尽可能多的逻辑放入一个函数中</strong>。这可能会增加完成所需的时间。</p><h1 id="d402" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">增加超时限制</h1><p id="5b21" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">Lambda的默认超时时间为三秒，但它允许您更改此配置。最多15分钟，但请记住，您必须为此付费。如果您真的有无法减少的长时间运行的流程，<strong class="jx io">也许Lambda不是正确的解决方案</strong>，您应该研究EC2或ECS。</p><p id="0e7e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">此外，API Gateway有30秒的硬限制。因此，即使您可以将您的Lambda函数配置为运行15分钟，当您使用API Gateway 调用您的Lambda函数时，您也会达到一个极限。</p><h1 id="b0fc" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">增加内存分配</h1><p id="dbac" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">如果你增加Lambda函数的内存，它也会获得更多的CPU能力。<strong class="jx io">更强的计算能力意味着更快的执行速度，进而意味着更短的执行时间</strong>。但是随着超时时间的增加，这并不总是免费的。有时更多的内存加速了功能，使它更便宜，但有时它甚至变得更贵。</p><p id="17db" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">你应该使用Lambda Power Tuner这样的工具来充分利用你的函数。否则，你很可能会把钱和业绩留在桌面上。</p><h1 id="746a" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">简化你的功能</h1><p id="1003" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">这里最安全的方法是<strong class="jx io">简化你的Lambda函数</strong>。例如，<strong class="jx io">不要写一个用3分钟完成10项任务的函数，而是试着把它拆分开来</strong>。十个功能每个只需要20秒，比<strong class="jx io">更加灵活</strong>。此外，它允许更多的集成选项(参见30秒API网关限制)，并且您可以单独调优这些任务中的每一个。</p><p id="af34" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">也许，一个任务占用了大部分时间，你可以为它分配更多的内存。其他任务可以用更低的内存运行，这样会更便宜。</p><h1 id="2edd" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">Dashbirds如何帮助超时</h1><p id="4395" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated"><strong class="jx io"> Dashbird向您展示了所有Lambda误差的中心位置</strong>。因此，即使你的AWS帐户中有数百个Lambda函数，你也只需查看一个地方就能知道发生了什么。</p><p id="55d7" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">Dashbird应用程序将向您显示您的AWS帐户中最近的错误。下面的图4显示了一个列表，其中包含了我们刚才谈到的超时错误。</p><figure class="ly lz ma mb gt jo gh gi paragraph-image"><div class="gh gi me"><img src="../Images/6270ce4e9ebcc49afdc95ac4f1e8ae99.png" data-original-src="https://miro.medium.com/v2/resize:fit:808/format:webp/0*WfGMoy_j6qOHsLe_.png"/></div></figure><p id="980d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">如果您点击超时错误，您将直接进入相关事件的详细视图</strong>，如图5所示。它包括事件和相关调用的所有指标。</p><figure class="ly lz ma mb gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mf"><img src="../Images/d80e0497c54e123168d41fe2255dc468.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Dn0CaJVux2XhU2oE.png"/></div></div></figure><p id="c112" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如果您想了解更多，那么您可以点击occurrences下面底部的一个调用，您将看到图6中的视图。</p><figure class="ly lz ma mb gt jo gh gi paragraph-image"><div class="gh gi mg"><img src="../Images/f021f64afa75e89e8327db31d31471b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1390/format:webp/0*aoSiCJDGvMoPplzN.png"/></div></figure><p id="b8f6" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在这里，您可以找到与超时调用相关的所有内容——持续时间、错误和日志。如果您为您的功能启用了X射线追踪，您甚至可以检查与其他服务通信需要多长时间。在图7中，您可以看到它的样子。</p><figure class="ly lz ma mb gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mh"><img src="../Images/5aaff00ed469211c3d2f012aa8d14cff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Eu09NTTbqZbluxry.png"/></div></div></figure><p id="b6a2" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">有了traces，你马上就能看到你是否为等待其他服务付费。</p><p id="af29" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><a class="ae kt" href="https://app.dashbird.io/auth/register" rel="noopener ugc nofollow" target="_blank">免费试用dash bird</a>——这是无服务器可观测性的行业标准，将帮助你调试那些讨厌的超时。</p></div></div>    
</body>
</html>