<html>
<head>
<title>ShardingSphere-Proxy Front-End Protocol Troubleshooting Guide and Examples</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">sharding sphere-代理前端协议故障排除指南和示例</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/shardingsphere-proxy-front-end-protocol-troubleshooting-guide-and-examples-f3037d840e7c?source=collection_archive---------6-----------------------#2022-07-08">https://blog.devgenius.io/shardingsphere-proxy-front-end-protocol-troubleshooting-guide-and-examples-f3037d840e7c?source=collection_archive---------6-----------------------#2022-07-08</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="18cb" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">定位为透明数据库代理的 ShardingSphere-Proxy ，是<a class="ae ki" href="https://shardingsphere.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache ShardingSphere </a>的访问点之一。</p><p id="f552" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">ShardingSphere-Proxy 实现了一个数据库协议，任何使用<a class="ae ki" href="https://www.mysql.com/" rel="noopener ugc nofollow" target="_blank">MySQL</a>/<a class="ae ki" href="https://www.postgresql.org/" rel="noopener ugc nofollow" target="_blank">PostgreSQL</a>/<a class="ae ki" href="https://opengauss.org/en/" rel="noopener ugc nofollow" target="_blank">open gauss</a>协议或与之兼容的客户端都可以访问该协议。ShardingSphere-Proxy 相对于<a class="ae ki" href="https://shardingsphere.apache.org/document/current/en/overview/#shardingsphere-jdbc" rel="noopener ugc nofollow" target="_blank"> ShardingSphere-JDBC </a>的优势在于对异构语言的支持以及 DBA 进入数据库集群的可操作入口点。</p><p id="eaf7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">类似于 ShardingSphere 的 SQL 解析模块，建立 ShardingSphere-Proxy 对数据库协议的支持是一个长期的过程，需要开发者不断完善数据库协议部署。</p><p id="428c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这篇文章将向您介绍数据库协议开发中常用的工具，通过提供一个 ShardingSphere-Proxy MySQL 协议问题的故障排除指南作为案例研究。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/59c179de6f1dad8356df652bc9c7e248.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xBHxd7_KyKobRi44"/></div></div></figure><h1 id="087c" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">1.使用 Wireshark 分析网络协议</h1><p id="cdbf" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated"><a class="ae ki" href="https://www.wireshark.org/" rel="noopener ugc nofollow" target="_blank"> Wireshark </a>是一款流行的网络协议分析工具，内置了对数百种协议(包括与本文相关的 MySQL / PostgreSQL 协议)的解析支持，并且能够读取许多不同类型的数据包捕获格式。</p><p id="7541" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">Wireshark 的完整功能、安装和其他详细信息可以在 Wireshark 官方文档中找到。</p><h2 id="2580" class="ly kw in bd kx lz ma dn lb mb mc dp lf jv md me lj jz mf mg ln kd mh mi lr mj bi translated">1.1 使用 Wireshark 或<a class="ae ki" href="https://www.bing.com/ck/a?!&amp;&amp;p=59c98df665abf4ae96c59d71ce8241351b538ec6a61efe940bad8c1c419b6a15JmltdHM9MTY1NzI0NzgxNiZpZ3VpZD0xZjZlODVkMS0wNmNkLTRlODMtYWRhMS0wOWIzM2RjYTJiNjEmaW5zaWQ9NTE3OQ&amp;ptn=3&amp;fclid=d57892b9-fe66-11ec-9844-e4d3b8466c04&amp;u=a1aHR0cHM6Ly93d3cudGNwZHVtcC5vcmcv&amp;ntb=1" rel="noopener ugc nofollow" target="_blank"> tcpdump </a>等工具捕获数据包</h2><h2 id="2ac8" class="ly kw in bd kx lz ma dn lb mb mc dp lf jv md me lj jz mf mg ln kd mh mi lr mj bi translated">Wireshark</h2><p id="978d" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">Wireshark 本身具有捕获数据包的能力，所以如果连接到 ShardingSphere-Proxy 的环境可以运行 Wireshark，你就可以用它直接捕获数据包。</p><p id="a9bb" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">启动 Wireshark 后，首先选择正确的网卡。</p><p id="5de3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">例如，如果您在本地运行 ShardingSphere-Proxy，客户端将连接到 127.0.0.1 上的端口 3307 上的 ShardingSphere-Proxy，流量将通过被选为数据包捕获目标的环回 NIC。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/21e21ffb02bf89fd0020830dc97bd9a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xXiHyXmrRK4mLmXX"/></div></div></figure><p id="9656" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">选择网卡后，Wireshark 开始捕获数据包。由于网卡上可能有来自其他进程的大量流量，因此有必要过滤掉来自指定端口的流量。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/bda969d8093560bb67dbf4a9526cf6c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*78zxObATP04sINMx"/></div></div></figure><h2 id="2785" class="ly kw in bd kx lz ma dn lb mb mc dp lf jv md me lj jz mf mg ln kd mh mi lr mj bi translated">1.1.2 <a class="ae ki" href="https://www.tcpdump.org/" rel="noopener ugc nofollow" target="_blank"> tcpdump </a></h2><p id="a839" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">如果 ShardingSphere-Proxy 部署在在线环境中，或者当您无法使用 Wireshark 捕获数据包时，请考虑使用 tcpdump 或其他工具。</p><p id="a8b0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">NIC eth0 作为目标，过滤 TCP 端口 3307，将结果写入/path/to/dump.cap .命令示例:</p><pre class="kk kl km kn gt mk ml mm mn aw mo bi"><span id="cf38" class="ly kw in ml b gy mp mq l mr ms">tcpdump -i eth0 -w /path/to/dump.cap tcp port 3307</span></pre><p id="3a6b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">要知道如何使用 tcpdump，可以去 man tcpdump。tcpdump 的数据包捕获结果文件可以通过 Wireshark 打开。</p><h2 id="d986" class="ly kw in bd kx lz ma dn lb mb mc dp lf jv md me lj jz mf mg ln kd mh mi lr mj bi translated">注意事项</h2><p id="f419" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">当客户端连接到 MySQL 时，SSL 加密可能会自动启用，导致数据包捕获结果无法直接解析协议内容。您可以通过使用 MySQL 客户端命令行和以下命令指定参数来禁用 SSL:</p><pre class="kk kl km kn gt mk ml mm mn aw mo bi"><span id="b1b2" class="ly kw in ml b gy mp mq l mr ms">mysql --ssl-mode=disable</span></pre><p id="a93c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">可以使用带有以下参数的 JDBC 添加参数:</p><pre class="kk kl km kn gt mk ml mm mn aw mo bi"><span id="468b" class="ly kw in ml b gy mp mq l mr ms">jdbc:mysql://127.0.0.1:3306/db?useSSL=false</span></pre><h1 id="9001" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">1.2 使用 Wireshark 读取数据包捕获结果</h1><p id="b14d" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">Wireshark 支持读取多种数据包捕获文件格式，包括 tcpdump 的捕获格式。</p><p id="2439" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">默认情况下，Wireshark 将端口 3306 解码为 MySQL 协议，将端口 5432 解码为 PostgreSQL 协议。对于 ShardingSphere-Proxy 可能使用不同端口的情况，您可以在<code class="fe mt mu mv ml b">Decode As…</code>中为指定端口配置协议</p><p id="9428" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">比如 ShardingSphere-Proxy MySQL 使用 3307 端口，可以按照以下步骤解析为 SQL 协议:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/6869feaba32edf5716fe27520349c67d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*yjoBuZbXAoPxtzZV"/></div></div></figure><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi mw"><img src="../Images/231ec95dcc8ae0bf4946774c1a73fbb0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*U_gaUYhg5xBGeTy6"/></div></div></figure><p id="e534" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">一旦 Wireshark 能够解析出 MySQL 协议，我们就可以添加过滤器来仅显示 MySQL 协议数据:</p><pre class="kk kl km kn gt mk ml mm mn aw mo bi"><span id="93b7" class="ly kw in ml b gy mp mq l mr ms">tcp.port == 3307 and mysql</span></pre><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/ef1ef453e1b6261989af6dc62cc658ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*GDmPoQnX-dNxeNvH"/></div></div></figure><p id="7a86" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">为指定端口选择正确的协议后，您可以在 Wireshark 窗口中看到内容。</p><p id="7a71" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">例如，客户端与服务器建立 TCP 连接后，MySQL 服务器向客户端发起一个<code class="fe mt mu mv ml b">Greeting</code>,如下所示:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/49de8ee558af802a146659c3ef65afe4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*VGWdBL7RS3k38JO2"/></div></div></figure><p id="bb97" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">示例:客户端执行 SQL select 版本()，协议如下所示:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/50cd40b6c5de9fa3075058a91bec7b66.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*AraP7mZzJCsRJFM-"/></div></div></figure><h1 id="1145" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">2.协议故障排除案例研究:ShardingSphere-Proxy MySQL 支持超大数据包</h1><h1 id="875d" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">2.1 问题描述</h1><p id="9fd2" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">使用 MySQL Connector/J 8.0.28 作为客户端连接 ShardingSphere-Proxy 5.1.1，执行时提示批量插入错误。</p><p id="5664" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">更换驱动 MySQL 连接器/J 5.1.38 后问题解决。</p><pre class="kk kl km kn gt mk ml mm mn aw mo bi"><span id="8792" class="ly kw in ml b gy mp mq l mr ms">[INFO ] 2022-05-21 17:32:22.375 [main] o.a.s.p.i.BootstrapInitializer - Database name is `MySQL`, version is `8.0.28`<br/>[INFO ] 2022-05-21 17:32:22.670 [main] o.a.s.p.frontend.ShardingSphereProxy - ShardingSphere-Proxy start success<br/>[ERROR] 2022-05-21 17:37:57.925 [Connection-143-ThreadExecutor] o.a.s.p.f.c.CommandExecutorTask - Exception occur: <br/>java.lang.IllegalArgumentException: Sequence ID of MySQL command packet must be `0`.<br/> at com.google.common.base.Preconditions.checkArgument(Preconditions.java:142)<br/> at org.apache.shardingsphere.db.protocol.mysql.packet.command.MySQLCommandPacketTypeLoader.getCommandPacketType(MySQLCommandPacketTypeLoader.java:38)<br/> at org.apache.shardingsphere.proxy.frontend.mysql.command.MySQLCommandExecuteEngine.getCommandPacketType(MySQLCommandExecuteEngine.java:50)<br/> at org.apache.shardingsphere.proxy.frontend.mysql.command.MySQLCommandExecuteEngine.getCommandPacketType(MySQLCommandExecuteEngine.java:46)<br/> at org.apache.shardingsphere.proxy.frontend.command.CommandExecutorTask.executeCommand(CommandExecutorTask.java:95)<br/> at org.apache.shardingsphere.proxy.frontend.command.CommandExecutorTask.run(CommandExecutorTask.java:72)<br/> at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)<br/> at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)<br/> at java.base/java.lang.Thread.run(Thread.java:834)<br/>[ERROR] 2022-05-21 17:44:24.926 [Connection-317-ThreadExecutor] o.a.s.p.f.c.CommandExecutorTask - Exception occur: <br/>java.lang.IllegalArgumentException: Sequence ID of MySQL command packet must be `0`.<br/> at com.google.common.base.Preconditions.checkArgument(Preconditions.java:142)<br/> at org.apache.shardingsphere.db.protocol.mysql.packet.command.MySQLCommandPacketTypeLoader.getCommandPacketType(MySQLCommandPacketTypeLoader.java:38)<br/> at org.apache.shardingsphere.proxy.frontend.mysql.command.MySQLCommandExecuteEngine.getCommandPacketType(MySQLCommandExecuteEngine.java:50)<br/> at org.apache.shardingsphere.proxy.frontend.mysql.command.MySQLCommandExecuteEngine.getCommandPacketType(MySQLCommandExecuteEngine.java:46)<br/> at org.apache.shardingsphere.proxy.frontend.command.CommandExecutorTask.executeCommand(CommandExecutorTask.java:95)<br/> at org.apache.shardingsphere.proxy.frontend.command.CommandExecutorTask.run(CommandExecutorTask.java:72)<br/> at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)<br/> at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)<br/> at java.base/java.lang.Thread.run(Thread.java:834)</span></pre><h1 id="c614" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">2.2 故障排除</h1><p id="1233" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">错误发生在代理的前端，不包括后端 JDBC 驱动程序，并且与协议实现相关。</p><h2 id="a59b" class="ly kw in bd kx lz ma dn lb mb mc dp lf jv md me lj jz mf mg ln kd mh mi lr mj bi translated">2.2.1 分析</h2><p id="b301" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">直接在源代码中确定，如果序列 ID 不等于 0，则报错。</p><pre class="kk kl km kn gt mk ml mm mn aw mo bi"><span id="05da" class="ly kw in ml b gy mp mq l mr ms">public final class MySQLCommandPacketTypeLoader {<br/>    <br/>    <em class="mx">/**</em><br/><em class="mx">     * Get command packet type.</em><br/><em class="mx">     *</em><br/><em class="mx">     * @param payload packet payload for MySQL</em><br/><em class="mx">     * @return command packet type for MySQL</em><br/><em class="mx">     */</em><br/>    public static MySQLCommandPacketType getCommandPacketType(final MySQLPacketPayload payload) {<br/>        Preconditions.checkArgument(0 == payload.readInt1(), "Sequence ID of MySQL command packet must be `0`.");<br/>        return MySQLCommandPacketType.valueOf(payload.readInt1());<br/>    }<br/>}</span></pre><p id="daa0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">代码链接:</strong><a class="ae ki" href="https://github.com/apache/shardingsphere/blob/d928165ea4f6ecf2983b2a3a8670ff66ffe63647/shardingsphere-db-protocol/shardingsphere-db-protocol-mysql/src/main/java/org/apache/shardingsphere/db/protocol/mysql/packet/command/MySQLCommandPacketTypeLoader.java#L38" rel="noopener ugc nofollow" target="_blank">https://github . com/Apache/sharding sphere/blob/d 928165 ea 4 f 6 ECF 2983 B2 a3 a 8670 ff 66 FFE 63647/sharding sphere-d b-protocol/sharding sphere-d b-protocol-MySQL/src/main/Java/org/Apache/sharding sphere/db/protocol/MySQL/packet/command . Java # L38</a></p><p id="dd3d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">根据 MySQL 协议文档，考虑序列 ID 何时不等于 0 [2]。</p><ul class=""><li id="5a85" class="my mz in jm b jn jo jr js jv na jz nb kd nc kh nd ne nf ng bi translated">服务器向客户端响应多条消息。</li><li id="04ae" class="my mz in jm b jn nh jr ni jv nj jz nk kd nl kh nd ne nf ng bi translated">客户端发送多个连续的消息。</li><li id="0bbe" class="my mz in jm b jn nh jr ni jv nj jz nk kd nl kh nd ne nf ng bi">……</li></ul><p id="83cd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在这种情况下，MySQL 数据包的消息头由 3 字节长度+ 1 字节序列 ID [3]组成，因此有效载荷部分的最大长度为 16 MB — 1。</p><p id="bccf" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">考虑到该错误是在大容量插入期间生成的，问题可能是客户端发送的数据超过了单个 MySQL 数据包的长度限制，并被分割成多个连续的 MySQL 数据包，代理无法处理这些数据包。</p><h2 id="06e3" class="ly kw in bd kx lz ma dn lb mb mc dp lf jv md me lj jz mf mg ln kd mh mi lr mj bi translated">2.2.2 试图重现问题</h2><p id="c7c5" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">使用<code class="fe mt mu mv ml b"> longtext </code>类型字段。最初的想法是构造一个长度超过 16 MB 的 SQL，但是不经意间我们发现，当 SQL 长度超过 8 MB 时也会报告错误。该代码复制如下:</p><pre class="kk kl km kn gt mk ml mm mn aw mo bi"><span id="542e" class="ly kw in ml b gy mp mq l mr ms">try (Connection connection = DriverManager.getConnection("jdbc:mysql://127.0.0.1:13306/bmsql", "root", "root")) {<br/>    try (Statement statement = connection.createStatement()) {<br/>        statement.execute("drop table if exists foo");<br/>        statement.execute("create table foo (id bigint primary key, str0 longtext)");<br/>        long id = ThreadLocalRandom.current().nextLong();<br/>        String str0 = RandomStringUtils.randomAlphanumeric(1 &lt;&lt; 23);<br/>        String sql = "insert into foo (id, str0) values (" + id + ", '" + str0 + "')";<br/>        System.out.println(sql.length());<br/>        statement.execute(sql);<br/>    }<br/>}</span></pre><p id="8b48" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">错误报告如下:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/984372e82a4a3bb90b14785197ebf43f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3EZGCoDzj_pYvNGA"/></div></div></figure><p id="4689" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">Wireshark 数据包捕获结果显示，数据包长度 0x80003C == 8388668，只有一个 MySQL 数据包，序列 ID 只有 0:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/d96e3494781c6d85694acabe67dbd470.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*BYsTt9rMt16Nm6oH"/></div></div></figure><p id="cb5f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">调试代码发现代理使用的<code class="fe mt mu mv ml b"> readMediumLE()</code>方法是一个有符号的数字，数据包长度被读取为负数。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/1cda9be2ec63fa402b12510f6e373cd8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8_85olYD_3iMUpx8"/></div></div></figure><p id="76f9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这个问题相对容易修复，只需更换相应的<code class="fe mt mu mv ml b">readUnsignedMediumLE()</code>方法即可。</p><p id="768d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">尽管错误消息与问题描述一致，但它并没有完全解决潜在的问题。</p><p id="587e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">长度超出问题解决后，继续对问题进行故障排除。使用以下代码向 ShardingSphere-Proxy 发送大约 64 MB 的数据:</p><pre class="kk kl km kn gt mk ml mm mn aw mo bi"><span id="54e0" class="ly kw in ml b gy mp mq l mr ms">try (Connection connection = DriverManager.getConnection("jdbc:mysql://127.0.0.1:13306/bmsql", "root", "root")) {<br/>    try (Statement statement = connection.createStatement()) {<br/>        statement.execute("drop table if exists foo");<br/>        statement.execute("create table foo (id bigint primary key, str0 longtext)");<br/>        long id = ThreadLocalRandom.current().nextLong();<br/>        String str0 = RandomStringUtils.randomAlphanumeric(1 &lt;&lt; 26);<br/>        String sql = "insert into foo (id, str0) values (" + id + ", '" + str0 + "')";<br/>        statement.execute(sql);<br/>    }<br/>}</span></pre><p id="a797" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">出现错误:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/cdef5013240115da8dce232e523d7dba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*i2kXpFkTuL9OB1PR"/></div></div></figure><p id="8ccf" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">分析数据包捕获结果:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/52a6ded3f49368ded81b7b956e28eec0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*GKpTTngcK-PAaD0n"/></div></div></figure><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/3609592f865ef8292bf5fe5b437905ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*sfjsR-57t-fnCCDR"/></div></div></figure><p id="e54a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">结果表明，客户端发送了多个 16MB 的数据包，Wireshark 无法正确解析 MySQL 长数据包，但我们可以使用搜索功能找到 MySQL 数据包的报头。</p><p id="7e41" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">与 ShardingSphere-Proxy MySQL 解码逻辑相关联:</p><pre class="kk kl km kn gt mk ml mm mn aw mo bi"><span id="499a" class="ly kw in ml b gy mp mq l mr ms">int payloadLength = in.markReaderIndex().readUnsignedMediumLE();<br/>int remainPayloadLength = SEQUENCE_LENGTH + payloadLength;<br/>if (in.readableBytes() &lt; remainPayloadLength) {<br/>    in.resetReaderIndex();<br/>    return;<br/>}<br/>out.add(in.readRetainedSlice(SEQUENCE_LENGTH + payloadLength));</span></pre><p id="36f4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">问题很明显:因为 ShardingSphere-Proxy 没有聚合包，所以多个包被代理作为多个命令分别解析，并且因为后续包的<code class="fe mt mu mv ml b">Sequence ID</code>大于 0，所以代理的序列 ID 的内部断言逻辑报告了一个错误。</p><h1 id="8634" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">2.3 故障排除和维修</h1><p id="e70a" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">故障排除后，报告的错误为:</p><ul class=""><li id="df48" class="my mz in jm b jn jo jr js jv na jz nb kd nc kh nd ne nf ng bi translated">(直接原因)ShardingSphere-Proxy MySQL 协议解包逻辑没有正确处理长度符号[4]。</li><li id="80a5" class="my mz in jm b jn nh jr ni jv nj jz nk kd nl kh nd ne nf ng bi translated">(根本原因)ShardingSphere-Proxy MySQL 不聚合大于 16 MB 的数据包[5]。</li></ul><p id="0d2f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">首先重要的是理解 MySQL 协议如何处理很长的数据包[6]。</p><ul class=""><li id="a980" class="my mz in jm b jn jo jr js jv na jz nb kd nc kh nd ne nf ng bi translated">当总数据长度超过 16 MB — 1 时，协议会将数据拆分为多个长度为 16 MB — 1 的数据包，直到最终数据长度小于 16 MB — 1，如下图所示:</li></ul><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/dd6095086b854c2871c29724926e70d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*RiY8wSY68pWsxOUs"/></div></div></figure><ul class=""><li id="4190" class="my mz in jm b jn jo jr js jv na jz nb kd nc kh nd ne nf ng bi translated">当数据长度正好等于 16 MB — 1 或其倍数时，发送一个或多个长度为 16 MB — 1 的数据包，后跟一个长度为 0 的数据包，如下图所示:</li></ul><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/890a35e85285cb7af4059eb580d0c9d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qHnZURr0dqvYxfI-"/></div></div></figure><p id="acf8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">解决方案:</strong>为了让 ShardingSphere-Proxy MySQL 的协议实现不关心处理多长的数据包，最好在数据解码逻辑中聚合数据包。</p><p id="e2f2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在 ShardingSphere-Proxy 前端<a class="ae ki" href="https://netty.io/" rel="noopener ugc nofollow" target="_blank"> Netty </a>解码逻辑中，当遇到一个长度为<code class="fe mt mu mv ml b">0xFFFFFF</code>的数据包时，多个 MySQL 包的净荷部分通过 CompositeByteBuf 进行聚合。</p><p id="53a2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">有关特定代码，请参见参考文档中的拉请求。</p><p id="4d6a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">以下问题目前已修复:</p><ul class=""><li id="6a73" class="my mz in jm b jn jo jr js jv na jz nb kd nc kh nd ne nf ng bi translated">正确处理数据包长度数字符号[7]。</li><li id="39c9" class="my mz in jm b jn nh jr ni jv nj jz nk kd nl kh nd ne nf ng bi translated">MySQL 协议解码逻辑支持超过 16 MB 的数据包[8]。</li></ul><p id="3e35" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">以后要解决的潜在问题，包括但不限于:</p><ul class=""><li id="ea6f" class="my mz in jm b jn jo jr js jv na jz nb kd nc kh nd ne nf ng bi translated">MySQL 协议编码逻辑不支持响应大于 16 MB 的数据包。</li></ul><h1 id="54ad" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">3.总结 Shardingsphere 前端协议的故障排除方法</h1><p id="8496" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">对于基于协议的故障排除，您首先需要熟悉相应的协议和数据库协议，包括但不限于:</p><p id="c1f8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">通过数据包捕获工具观察客户端直接连接到数据库的协议。</p><p id="5cd7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">根据数据库协议文件，读取官方客户端数据库的协议编码逻辑源代码(如 JDBC 驱动)。</p><p id="dd5b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">一旦您基本掌握了数据包捕获工具和协议，您就可以开始排除 sharing sphere-Proxy 前端协议问题了。</p><p id="8827" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">ShardingSphere-Proxy 与客户端建立连接的代码条目位于 org . Apache . sharding sphere . Proxy . frontend . netty . serverhandlerinitializer[9]中，可以用作识别问题的起点。</p><p id="0141" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">本文中介绍的解决方案已经在 Apache ShardingSphere 5.1.2 中发布[10]。</p><h1 id="576e" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">相关链接:</h1><p id="b539" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">[1]<a class="ae ki" href="https://www.wireshark.org/" rel="noopener ugc nofollow" target="_blank">https://www.wireshark.org/</a></p><p id="4957" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><a class="ae ki" href="https://dev.mysql.com/doc/internals/en/sequence-id.html" rel="noopener ugc nofollow" target="_blank">https://dev.mysql.com/doc/internals/en/sequence-id.html</a></p><p id="bedc" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">[3]<a class="ae ki" href="https://dev.mysql.com/doc/internals/en/mysql-packet.html" rel="noopener ugc nofollow" target="_blank">https://dev.mysql.com/doc/internals/en/mysql-packet.html</a></p><p id="1a5b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">[4]https://github.com/apache/shardingsphere/issues/17891<a class="ae ki" href="https://github.com/apache/shardingsphere/issues/17891" rel="noopener ugc nofollow" target="_blank"/></p><p id="1f92" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">[5]https://github.com/apache/shardingsphere/issues/17907<a class="ae ki" href="https://github.com/apache/shardingsphere/issues/17907" rel="noopener ugc nofollow" target="_blank"/></p><p id="dfee" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">[6]<a class="ae ki" href="https://dev.mysql.com/doc/internals/en/sending-more-than-16mbyte.html" rel="noopener ugc nofollow" target="_blank">https://dev . MySQL . com/doc/internals/en/sending-more-16 mbyte . html</a></p><p id="0dba" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><a class="ae ki" href="https://github.com/apache/shardingsphere/pull/17898" rel="noopener ugc nofollow" target="_blank">https://github.com/apache/shardingsphere/pull/17898</a></p><p id="baa5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><a class="ae ki" href="https://github.com/apache/shardingsphere/pull/17914" rel="noopener ugc nofollow" target="_blank">https://github.com/apache/shardingsphere/pull/17914</a></p><p id="f13a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">[9]<a class="ae ki" href="https://github.com/apache/shardingsphere/blob/2c9936497214b8a654cb56d43583f62cd7a6b76b/shardingsphere-proxy/shardingsphere-proxy-frontend/shardingsphere-proxy-frontend-core/src/main/java/org/apache/shardingsphere/proxy/frontend/netty/ServerHandlerInitializer.java" rel="noopener ugc nofollow" target="_blank">https://github . com/Apache/sharding sphere/blob/2c 9936497214 b 8 a 654 CB 56d 43583 f 62 CD 7 a6b 76b/sharding sphere-proxy-frontend/sharding sphere-proxy-frontend-core/src/main/Java/org/Apache/sharding sphere/proxy/frontend/netty/serverhandlerinitializer . Java</a></p><p id="bdc0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">[10]<a class="ae ki" href="https://shardingsphere.apache.org/document/current/cn/downloads/" rel="noopener ugc nofollow" target="_blank">https://sharding sphere . Apache . org/document/current/cn/downloads/</a></p><p id="f38b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><a class="ae ki" href="https://github.com/apache/shardingsphere/issues" rel="noopener ugc nofollow" target="_blank"> GitHub 问题</a></p><p id="c04e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><a class="ae ki" href="https://shardingsphere.apache.org/community/en/contribute/" rel="noopener ugc nofollow" target="_blank">投稿指南</a></p><p id="a4cb" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">推特</p><p id="8c5f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><a class="ae ki" href="https://join.slack.com/t/apacheshardingsphere/shared_invite/zt-sbdde7ie-SjDqo9~I4rYcR18bq0SYTg" rel="noopener ugc nofollow" target="_blank">切割球松弛度</a></p><p id="8da9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><a class="ae ki" href="https://community.sphere-ex.com/" rel="noopener ugc nofollow" target="_blank">华人社区</a></p><h1 id="7ea1" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">作者</h1><p id="2c1b" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">吴伟杰，Apache ShardingSphere PMC，R&amp;D,<a class="ae ki" href="https://www.sphere-ex.com/en/" rel="noopener ugc nofollow" target="_blank">spherex</a>基础设施工程师。韦杰专注于 Apache ShardingSphere 访问端和 sharing sphere 子项目<a class="ae ki" href="https://shardingsphere.apache.org/elasticjob/" rel="noopener ugc nofollow" target="_blank"> ElasticJob </a>。</p></div></div>    
</body>
</html>