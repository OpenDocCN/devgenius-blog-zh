<html>
<head>
<title>Testing a Rails API with RSpec</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用 RSpec 测试 Rails API</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/testing-a-rails-api-with-rspec-82dedc9f15df?source=collection_archive---------1-----------------------#2022-02-08">https://blog.devgenius.io/testing-a-rails-api-with-rspec-82dedc9f15df?source=collection_archive---------1-----------------------#2022-02-08</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/652f01fd898864099a36a5b38c94d32f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*P9iQIqnrcSFAsklJ"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">昆顿·库切在<a class="ae jz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="aa51" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在本教程中，我将展示如何使用最流行的 Ruby 测试框架 RSpec 来测试 Ruby on Rails 纯 API 应用程序的 GET、POST 和 DELETE 方法。</p><p id="ae2d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">首先，我将编写会失败的测试，然后编写控制器的代码来解决这些测试。换句话说，我将使用<a class="ae jz" href="https://en.wikipedia.org/wiki/Test-driven_development#:~:text=Test%2Ddriven%20development%20(TDD),software%20against%20all%20test%20cases." rel="noopener ugc nofollow" target="_blank"> TDD </a>方法。</p><p id="c58f" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们来编码吧！</p></div><div class="ab cl ky kz hr la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ig ih ii ij ik"><h1 id="3d59" class="lf lg in bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">第一步。创建一个 Rails API</h1><p id="1b93" class="pw-post-body-paragraph ka kb in kc b kd md kf kg kh me kj kk kl mf kn ko kp mg kr ks kt mh kv kw kx ig bi translated">一开始，从头开始创建一个简单的 Rails API 专用应用程序。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="2aec" class="mr lg in mn b gy ms mt l mu mv">rails new post-api --api <!-- -->-T<br/>cd post-api</span></pre><p id="8c3e" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">旗帜<code class="fe mw mx my mn b">--api</code>继承了<code class="fe mw mx my mn b">ActionController::API</code>的<code class="fe mw mx my mn b">ApplicationController</code>而不是<code class="fe mw mx my mn b">ActionController::Base</code>。这意味着 Action Controller 提供了浏览器应用程序使用的模块，并跳过了生成我们不需要的视图、助手和资源。</p><p id="d672" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们将使用<em class="mz"> RSpec </em>而不是<em class="mz"> MiniTest </em>。命令<code class="fe mw mx my mn b">-T</code>跳过<code class="fe mw mx my mn b">Minitest::Unit</code>文件和文件夹的生成。</p></div><div class="ab cl ky kz hr la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ig ih ii ij ik"><h1 id="1dc6" class="lf lg in bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">第二步。安装 gems</h1><p id="eb3d" class="pw-post-body-paragraph ka kb in kc b kd md kf kg kh me kj kk kl mf kn ko kp mg kr ks kt mh kv kw kx ig bi translated">将<code class="fe mw mx my mn b">rspec-rails</code>添加到应用程序<code class="fe mw mx my mn b">Gemfile</code>的<code class="fe mw mx my mn b">:development</code>和<code class="fe mw mx my mn b">:test</code>组中。另外，在<code class="fe mw mx my mn b">:test</code>环境中添加一个<code class="fe mw mx my mn b">factory_bot_rails</code> gem 用于设置测试数据对象，添加<code class="fe mw mx my mn b">faker</code>用于生成假数据。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="54ed" class="mr lg in mn b gy ms mt l mu mv">group :development, :test do<br/>  gem 'rspec-rails'<br/>end</span><span id="86ec" class="mr lg in mn b gy na mt l mu mv">group :test do<br/>    gem 'factory_bot_rails'<br/>    <!-- -->gem 'faker'<br/>end</span></pre><p id="795b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">安装。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="35ae" class="mr lg in mn b gy ms mt l mu mv">bundle</span></pre></div><div class="ab cl ky kz hr la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ig ih ii ij ik"><h1 id="9389" class="lf lg in bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">第三步。设置测试环境</h1><p id="a652" class="pw-post-body-paragraph ka kb in kc b kd md kf kg kh me kj kk kl mf kn ko kp mg kr ks kt mh kv kw kx ig bi translated">要完成 RSpec 安装，请使用下面的命令。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="c5f7" class="mr lg in mn b gy ms mt l mu mv">rails generate rspec:install</span></pre><p id="e36e" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">该命令生成一个包含<code class="fe mw mx my mn b">rails_helper.rb</code>和<code class="fe mw mx my mn b">spec_helper.rb</code>文件的<em class="mz">规格</em>文件夹。</p><p id="fb12" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">接下来，用<code class="fe mw mx my mn b">spec/factories.rb</code>中的假数据创建<em class="mz"> Post </em>工厂。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="3fb6" class="mr lg in mn b gy ms mt l mu mv">FactoryBot.define do<br/>  factory :post do<br/>    title { Faker::Lorem.sentence }<br/>    content { Faker::Lorem.paragraph }<br/>  end<br/>end</span></pre><p id="c4b8" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">为了最小化代码，我将编写一个<code class="fe mw mx my mn b">json</code>方法。它只是解析响应体字符串。还是写在<code class="fe mw mx my mn b">spec/support/api_helpers.rb</code>吧。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="3780" class="mr lg in mn b gy ms mt l mu mv">module ApiHelpers<br/>  def json<br/>    JSON.parse(response.body)<br/>  end<br/>end</span></pre><p id="d9aa" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">最后要做的是要求所有的支持文件，并在<code class="fe mw mx my mn b">spec/rails_helper.rb</code>中包含<em class="mz"> ApiHelpers </em>模块。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="90c2" class="mr lg in mn b gy ms mt l mu mv">Dir[Rails.root.join("spec/support/**/*.rb")].each { |f| require f }</span><span id="9e02" class="mr lg in mn b gy na mt l mu mv">RSpec.configure do |config|<br/>  # ...<br/>  config.include ApiHelpers<br/>end</span></pre></div><div class="ab cl ky kz hr la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ig ih ii ij ik"><h1 id="d0f3" class="lf lg in bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">第四步。API 规格</h1><p id="5e20" class="pw-post-body-paragraph ka kb in kc b kd md kf kg kh me kj kk kl mf kn ko kp mg kr ks kt mh kv kw kx ig bi translated">我将使用<a class="ae jz" href="https://www.freecodecamp.org/news/how-to-version-a-rest-api/#:~:text=so%20let's%20recap%3A-,API%20versioning%20is%20the%20practice%20of%20transparently%20managing%20changes%20to,effective%20API%20change%20management%20principles." rel="noopener ugc nofollow" target="_blank"> REST API 版本控制</a>。当在 API 中识别出需要的变更时，它<strong class="kc io">帮助我们更快地迭代。这是最佳实践。</strong></p><h2 id="736f" class="mr lg in bd lh nb nc dn ll nd ne dp lp kl nf ng lt kp nh ni lx kt nj nk mb nl bi translated">得到</h2><p id="9d05" class="pw-post-body-paragraph ka kb in kc b kd md kf kg kh me kj kk kl mf kn ko kp mg kr ks kt mh kv kw kx ig bi translated">创建<code class="fe mw mx my mn b">spec/requests/get_posts_spec.rb</code>并插入以下代码:</p><figure class="mi mj mk ml gt jo"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="ee0c" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">开始时，我使用 FactoryBot 方法<code class="fe mw mx my mn b">create_list</code>创建 10 个帖子，然后调用一个 HTTP GET。接下来，我检查创建的帖子的大小和 HTTP 状态代码。</p><h2 id="7ac6" class="mr lg in bd lh nb nc dn ll nd ne dp lp kl nf ng lt kp nh ni lx kt nj nk mb nl bi translated">邮政</h2><p id="a0f7" class="pw-post-body-paragraph ka kb in kc b kd md kf kg kh me kj kk kl mf kn ko kp mg kr ks kt mh kv kw kx ig bi translated">接下来，创建<code class="fe mw mx my mn b">spec/requests/post_posts_spec.rb</code>并插入它:</p><figure class="mi mj mk ml gt jo"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="12d6" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我在<code class="fe mw mx my mn b">let!</code>方法内部写了一个 post 实例。通常，如果我需要使用下面的实例，我会使用<code class="fe mw mx my mn b">let!</code>，否则使用<code class="fe mw mx my mn b">before</code>。</p><h2 id="308f" class="mr lg in bd lh nb nc dn ll nd ne dp lp kl nf ng lt kp nh ni lx kt nj nk mb nl bi translated">删除</h2><p id="8405" class="pw-post-body-paragraph ka kb in kc b kd md kf kg kh me kj kk kl mf kn ko kp mg kr ks kt mh kv kw kx ig bi translated">而最后一个就是创建<code class="fe mw mx my mn b">spec/requests/delete_posts_spec.rb</code>并插入下面的代码。</p><figure class="mi mj mk ml gt jo"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="da74" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">进行测试。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="cfc9" class="mr lg in mn b gy ms mt l mu mv">rspec</span></pre><p id="fd51" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">测试肯定会失败，让我们在下一步解决。</p></div><div class="ab cl ky kz hr la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ig ih ii ij ik"><h1 id="802b" class="lf lg in bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">第五步。通过测试</h1><p id="fe8f" class="pw-post-body-paragraph ka kb in kc b kd md kf kg kh me kj kk kl mf kn ko kp mg kr ks kt mh kv kw kx ig bi translated">通过测试的第一步是<strong class="kc io">生成一个模型<em class="mz">后</em> </strong>。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="1c6e" class="mr lg in mn b gy ms mt l mu mv">rails g model Post title:string content:text --no-test-framework<br/>rails db:migrate</span></pre><p id="1ca5" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><code class="fe mw mx my mn b">--no-test-framework</code>标志不创建模型测试。如果您需要模型测试，您可以移除该标志。</p><p id="f700" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">下一步是<strong class="kc io">验证模型</strong>。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="caab" class="mr lg in mn b gy ms mt l mu mv">class Post &lt; ApplicationRecord<br/>  validates :title, :content, presence: true<br/>end</span></pre><p id="e3a8" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">仅对属性的存在进行验证。</p><p id="758e" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">建造<em class="mz">岗位</em>控制器</strong>以满足所有测试要求。</p><p id="cfa7" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">创建<code class="fe mw mx my mn b">app/controllers/api/v1/posts_controller.rb</code>文件并插入以下代码:</p><figure class="mi mj mk ml gt jo"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="25dc" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">更新<code class="fe mw mx my mn b">routes.rb</code>。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="561d" class="mr lg in mn b gy ms mt l mu mv">Rails.application.routes.draw do<br/>  namespace :api do<br/>    namespace :v1 do<br/>      resources :posts<br/>    end<br/>  end <br/>end</span></pre><p id="6398" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">再次进行测试。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="acf5" class="mr lg in mn b gy ms mt l mu mv">rspec</span></pre></div><div class="ab cl ky kz hr la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ig ih ii ij ik"><p id="ae2e" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">有用！🥳:这是一个非常简单的例子，它将为你的 API 应用程序编写新的测试提供一个起点。祝你好运！</p></div></div>    
</body>
</html>