<html>
<head>
<title>Azure MySQL with AAD and Managed Identity</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">具有AAD和托管身份的Azure MySQL</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/azure-mysql-with-aad-and-managed-identity-698128dc53fa?source=collection_archive---------5-----------------------#2020-06-04">https://blog.devgenius.io/azure-mysql-with-aad-and-managed-identity-698128dc53fa?source=collection_archive---------5-----------------------#2020-06-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="b71c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我不喜欢手动管理服务器。所以，PaaS是我在公有云中重点关注的。说到数据库，微软Azure有各种各样的PaaS产品，包括<a class="ae kl" href="https://docs.microsoft.com/en-us/azure/mysql/" rel="noopener ugc nofollow" target="_blank"> MySQL </a>。为了在PaaS上运行你的web API或者web app，Azure给你<a class="ae kl" href="https://docs.microsoft.com/en-us/azure/app-service/" rel="noopener ugc nofollow" target="_blank"> App服务</a>。如果您想安全地连接两种服务而无需管理密码，<a class="ae kl" href="https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview" rel="noopener ugc nofollow" target="_blank">托管身份</a>是您的好朋友。Azure docs包含一篇文章，给出了一些关于使用托管身份和MySQL的指导，但它不是很详细，也没有涵盖应用服务。因此，我想在这篇文章中演示如何一起使用所有这些PaaS产品。</p><h1 id="c0e8" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">概念</h1><p id="9011" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">不熟悉使用MySQL进行Azure Active Directory (AAD)身份验证的基础知识的读者应该在深入下面的代码示例之前阅读<a class="ae kl" href="https://docs.microsoft.com/en-us/azure/mysql/concepts-azure-ad-authentication" rel="noopener ugc nofollow" target="_blank">这篇文档文章</a>以理解基本概念。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi lp"><img src="../Images/5c2c895ef8a4f630a2daef1dd0c3589e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RkX2GSmR1MNtk6uEcelTKA.png"/></div></div><figcaption class="mb mc gj gh gi md me bd b be z dk translated">图片来源:<a class="ae kl" href="https://docs.microsoft.com/en-us/azure/mysql/concepts-azure-ad-authentication#architecture" rel="noopener ugc nofollow" target="_blank">微软</a></figcaption></figure><h1 id="a75d" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">手臂模板</h1><p id="6101" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">首先，我们需要一个ARM模板来部署一些Azure资源。在本例中，我决定设置以下演示环境:</p><ul class=""><li id="2c30" class="mf mg iq jp b jq jr ju jv jy mh kc mi kg mj kk mk ml mm mn bi translated"><a class="ae kl" href="https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview#how-does-the-managed-identities-for-azure-resources-work" rel="noopener ugc nofollow" target="_blank"> <em class="mo">用户分配的</em>托管身份</a></li><li id="65ab" class="mf mg iq jp b jq mp ju mq jy mr kc ms kg mt kk mk ml mm mn bi translated">具有网站的基于Windows的应用服务计划(将运行. NET核心示例应用)</li><li id="64cd" class="mf mg iq jp b jq mp ju mq jy mr kc ms kg mt kk mk ml mm mn bi translated">托管MySQL服务器</li></ul><p id="135d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是我为这个例子创建的ARM模板。没什么特别的。有趣的部分会在后面。</p><pre class="lq lr ls lt gt mu mv mw mx aw my bi"><span id="11d0" class="mz kn iq mv b gy na nb l nc nd">{<br/>  "$schema": "<a class="ae kl" href="https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#" rel="noopener ugc nofollow" target="_blank">https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#</a>",<br/>  "contentVersion": "1.0.0.0",<br/>  "parameters": {<br/>    "baseName": {<br/>      "type": "string",<br/>      "defaultValue": "mysql-msi-poc"<br/>    },<br/>    "appServiceSku": {<br/>      "type": "string",<br/>      "defaultValue": "P1"<br/>    },<br/>    "mySqlVersion": {<br/>      "type": "string",<br/>      "defaultValue": "5.7"<br/>    },<br/>    "mySqlAdminName": {<br/>      "type": "securestring",<br/>      "defaultValue": "mySqlAdmin"<br/>    },<br/>    "mySqlAdminPassword": {<br/>      "type": "securestring"<br/>    },<br/>    "mySqlStorageAmountMB": {<br/>      "type": "int",<br/>      "defaultValue": 5120<br/>    },<br/>    "mySqlBackupRetentionDays": {<br/>      "type": "int",<br/>      "defaultValue": 7<br/>    },<br/>    "mySqlGeoRedundantBackups": {<br/>      "type": "string",<br/>      "defaultValue": "Disabled"<br/>    },<br/>    "mySqlSku": {<br/>      "type": "string",<br/>      "defaultValue": "GP_Gen5_8"<br/>    },<br/>    "identityName": {<br/>      "type": "securestring",<br/>      "defaultValue": "mySqlIdentity"<br/>    },<br/>    "mySqlDB": {<br/>      "type": "string",<br/>      "defaultValue": "mysql"<br/>    },<br/>    "mySqlMsiUser": {<br/>      "type": "string",<br/>      "defaultValue": "msiuser"<br/>    }<br/>  },<br/>  "functions": [<br/>  ],<br/>  "variables": {<br/>    "appServiceName": "[concat('asp-', parameters('baseName'))]",<br/>    "webAppName": "[concat('webapp-', parameters('baseName'))]",<br/>    "mySqlName": "[concat('mysql-', parameters('baseName'))]"<br/>  },<br/>  "resources": [<br/>    {<br/>      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",<br/>      "name": "[parameters('identityName')]",<br/>      "apiVersion": "2018-11-30",<br/>      "location": "[resourceGroup().location]"<br/>    },<br/>    {<br/>      "name": "[variables('appServiceName')]",<br/>      "type": "Microsoft.Web/serverfarms",<br/>      "apiVersion": "2018-02-01",<br/>      "location": "[resourceGroup().location]",<br/>      "sku": {<br/>        "name": "[parameters('appServiceSku')]",<br/>        "capacity": 1<br/>      },<br/>      "tags": {<br/>        "displayName": "[variables('appServiceName')]"<br/>      },<br/>      "properties": {<br/>        "name": "[variables('appServiceName')]"<br/>      }<br/>    },<br/>    {<br/>      "name": "[variables('webAppName')]",<br/>      "type": "Microsoft.Web/sites",<br/>      "apiVersion": "2018-11-01",<br/>      "location": "[resourceGroup().location]",<br/>      "tags": {<br/>        "[concat('hidden-related:', resourceGroup().id, '/providers/Microsoft.Web/serverfarms/', variables('appServiceName'))]": "Resource",<br/>        "displayName": "[variables('webAppName')]"<br/>      },<br/>      "dependsOn": [<br/>        "[resourceId('Microsoft.Web/serverfarms', variables('appServiceName'))]"<br/>      ],<br/>      "identity": {<br/>        "type": "UserAssigned",<br/>        "userAssignedIdentities": {<br/>          "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('identityName'))]": {<br/>          }<br/>        }<br/>      },<br/>      "properties": {<br/>        "name": "[variables('webAppName')]",<br/>        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('appServiceName'))]",<br/>        "siteConfig": {<br/>          "appSettings": [<br/>            {<br/>              "name": "MySqlConnection",<br/>              "value": "[concat('Server=', variables('mySqlName'), '.mysql.database.azure.com; Port=3306; Database=', parameters('mySqlDB'), '; Uid=', parameters('mySqlAdminName'), '@', variables('mySqlName'), '; Pwd=', parameters('mySqlAdminPassword'), '; SslMode=Preferred;persistsecurityinfo=True;')]"<br/>            },<br/>            {<br/>              "name": "Host",<br/>              "value": "[concat(variables('mySqlName'), '.mysql.database.azure.com')]"<br/>            },<br/>            {<br/>              "name": "User",<br/>              "value": "[concat(parameters('mySqlMsiUser'), '@', variables('mySqlName'))]"<br/>            },<br/>            {<br/>              "name": "Database",<br/>              "value": "[parameters('mySqlDB')]"<br/>            }<br/>          ]<br/>        }<br/>      }<br/>    },<br/>    {<br/>      "apiVersion": "2017-12-01",<br/>      "type": "Microsoft.DBforMySQL/servers",<br/>      "name": "[variables('mySqlName')]",<br/>      "location": "[resourceGroup().location]",<br/>      "tags": {<br/>        "displayName": "[variables('mySqlName')]"<br/>      },<br/>      "properties": {<br/>        "createMode": "Default",<br/>        "version": "[parameters('mySqlVersion')]",<br/>        "sslEnforcement": "Enabled",<br/>        "administratorLogin": "[parameters('mySqlAdminName')]",<br/>        "administratorLoginPassword": "[parameters('mySqlAdminPassword')]",<br/>        "storageProfile": {<br/>          "storageMB": "[parameters('mySqlStorageAmountMB')]",<br/>          "backupRetentionDays": "[parameters('mySqlBackupRetentionDays')]",<br/>          "geoRedundantBackup": "[parameters('mySqlGeoRedundantBackups')]"<br/>        }<br/>      },<br/>      "sku": {<br/>        "name": "[parameters('mySqlSku')]"<br/>      },<br/>      "resources": [<br/>        {<br/>          "type": "firewallrules",<br/>          "apiVersion": "2017-12-01",<br/>          "dependsOn": [<br/>            "[concat('Microsoft.DBforMySQL/servers/', variables('mySqlName'))]"<br/>          ],<br/>          "location": "[resourceGroup().location]",<br/>          "name": "AllowAzureIPs",<br/>          "properties": {<br/>            "startIpAddress": "0.0.0.0",<br/>            "endIpAddress": "255.255.255.255"<br/>          }<br/>        }<br/>      ]<br/>    }<br/>  ],<br/>  "outputs": {<br/>  }<br/>}</span></pre><p id="5cfb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意，上面的模板向我们的web应用程序添加了一个常规的连接字符串。这仅用于演示目的。这个例子的要点是<strong class="jp ir"> <em class="mo">而不是</em> </strong>有一个带有用户名和密码的连接字符串。因此，在您的实际代码中，删除连接字符串，直接使用托管身份！</p><p id="c4e1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以使用Azure CLI部署上面显示的模板，如下所示:</p><pre class="lq lr ls lt gt mu mv mw mx aw my bi"><span id="a6ed" class="mz kn iq mv b gy na nb l nc nd"># Resoure Group Name<br/>RG="MySql-with-MSI"</span><span id="7fd9" class="mz kn iq mv b gy ne nb l nc nd"># Base name; Azure ressource names will be derived from it<br/># (e.g. mysql-$BASE, webapp-$BASE, etc.)<br/>BASE="mysql-msi-poc"</span><span id="4b45" class="mz kn iq mv b gy ne nb l nc nd"># Login and set subscription<br/>az login --use-device-code<br/>az account set --subscription "..."</span><span id="7830" class="mz kn iq mv b gy ne nb l nc nd"># Deploy resource group<br/>az deployment group create --resource-group $RG --template-file deploy.json --parameters mySqlAdminPassword=Sup3rSecuePazzw0rd identityName=mySqlIdentity baseName=mysql-msi-poc</span></pre><h1 id="8da8" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">托管身份</h1><p id="0087" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">上面显示的ARM模板在AAD中创建了一个名为<code class="fe nf ng nh mv b">mySqlIdentity</code>的用户分配的托管身份。web应用程序需要托管身份的<em class="mo">客户端ID </em>又名<em class="mo">应用程序ID </em>。不幸的是，我还没有找到在ARM模板中直接获得这个ID的方法。如果你知道如何做到这一点，请与我联系。然而，在ARM模板已经部署之后，只需两行Azure CLI代码就可以轻松设置它:</p><pre class="lq lr ls lt gt mu mv mw mx aw my bi"><span id="0a6a" class="mz kn iq mv b gy na nb l nc nd">CLIENT_ID=$(az identity list --resource-group $RG --query "[?name=='mySqlIdentity'].clientId" --output tsv)</span><span id="3517" class="mz kn iq mv b gy ne nb l nc nd">az functionapp config appsettings set --name webapp-$BASE --resource-group $RG --settings "ClientID=$CLIENT_ID"</span></pre><h1 id="c7d6" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">MySQL AAD管理</h1><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi ni"><img src="../Images/9beeeebc4897278d9411d176578c5a4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pgmM-XbKNhmyrRkZChloDw.png"/></div></div><figcaption class="mb mc gj gh gi md me bd b be z dk translated">图片来源:<a class="ae kl" href="https://docs.microsoft.com/en-us/azure/mysql/concepts-azure-ad-authentication#administrator-structure" rel="noopener ugc nofollow" target="_blank">微软</a></figcaption></figure><p id="5958" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们需要在MySQL中创建一个用户来代表我们的托管身份。遗憾的是，普通MySQL管理员帐户无法做到这一点。我们需要一个具有MySQL管理权限的AAD帐户。该帐户可以为托管身份创建MySQL用户。</p><p id="3536" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你已经有一个想要使用的AAD用户(<em class="mo"> no </em> Microsoft Account或类似的东西)，你就可以了。如果没有，您可以使用Azure CLI轻松创建一个:</p><pre class="lq lr ls lt gt mu mv mw mx aw my bi"><span id="9062" class="mz kn iq mv b gy na nb l nc nd">AAD_DOMAIN="yourdomain.onmicrosoft.com"<br/>AAD_USER="mysqladmin"<br/>AAD_ADMIN=$AAD_USER@$AAD_DOMAIN</span><span id="727b" class="mz kn iq mv b gy ne nb l nc nd">az ad user create --display-name $AAD_USER --password Sup3rSecuePazzw0rd --user-principal-name $AAD_ADMIN</span></pre><p id="9853" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们需要获得AAD用户的对象ID:</p><pre class="lq lr ls lt gt mu mv mw mx aw my bi"><span id="a980" class="mz kn iq mv b gy na nb l nc nd"># Get ID and Email of specified AAD Admin<br/>AAD_ADMIN_ID=$(az ad user show --id $AAD_ADMIN --query "objectId" --output tsv)<br/>AAD_ADMIN_EMAIL=$(az ad user show --id $AAD_ADMIN --query "userPrincipalName" --output tsv)</span></pre><p id="98eb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，我们可以将我们的AAD用户指定为MySQL数据库的AAD管理员:</p><pre class="lq lr ls lt gt mu mv mw mx aw my bi"><span id="427d" class="mz kn iq mv b gy na nb l nc nd">az mysql server ad-admin create --server-name mysql-$BASE -g $RG --display-name $AAD_ADMIN_EMAIL --object-id $AAD_ADMIN_ID</span></pre><p id="e9e3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果这些步骤都能直接在ARM模板中完成就太好了。不幸的是，我还没有找到这样做的方法。如果你知道一个，请让我知道。</p><h1 id="ffa5" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">为托管身份创建MySQL用户</h1><p id="794a" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">借助AAD MySQL administrator，我们可以为web应用的托管身份创建一个MySQL用户。为此，我建议打开一个<a class="ae kl" href="https://docs.microsoft.com/en-us/azure/cloud-shell/overview" rel="noopener ugc nofollow" target="_blank">云壳</a>。请注意，您必须使用我们之前创建的AAD MySQL管理员进行<strong class="jp ir">登录。</strong></p><p id="bc82" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们启动MySQL CLI，并通过AAD MySQL管理员进行身份验证:</p><pre class="lq lr ls lt gt mu mv mw mx aw my bi"><span id="dd9b" class="mz kn iq mv b gy na nb l nc nd">DB_ID=mysql-$BASE.mysql.database.azure.com</span><span id="a8ec" class="mz kn iq mv b gy ne nb l nc nd">mysql -h $DB_ID --user $AAD_ADMIN@mysql-$BASE --enable-cleartext-plugin --password=`az account get-access-token --resource-type oss-rdbms --output tsv --query accessToken`</span></pre><p id="1765" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我推荐单独试试<code class="fe nf ng nh mv b">az account get-access-token...</code>。复制令牌并使用例如<a class="ae kl" href="https://jwt.io/" rel="noopener ugc nofollow" target="_blank">https://jwt.io/</a>进行检查。您可能会对MySQL的AAD认证如何工作有更多的了解。</p><p id="2dfb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行MySQL CLI后，创建MySQL用户并赋予其必要的权限(注意<code class="fe nf ng nh mv b">$CLIENT_ID</code>必须替换为托管身份的客户端ID；请参见上面所示的Azure CLI脚本中的相应变量):</p><pre class="lq lr ls lt gt mu mv mw mx aw my bi"><span id="d2fa" class="mz kn iq mv b gy na nb l nc nd">SET aad_auth_validate_oids_in_tenant = OFF;<br/>CREATE AADUSER 'msiuser' IDENTIFIED BY '$CLIENT_ID';<br/>GRANT SELECT ON *.* TO 'msiuser';</span></pre><h1 id="c24a" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">C#示例</h1><p id="472a" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">Azure配置部分到此为止。我们有:</p><ul class=""><li id="4f60" class="mf mg iq jp b jq jr ju jv jy mh kc mi kg mj kk mk ml mm mn bi translated">托管身份。它也已经在MySQL中创建并被赋予适当的权限。</li><li id="8062" class="mf mg iq jp b jq mp ju mq jy mr kc ms kg mt kk mk ml mm mn bi translated">Web应用程序的应用程序服务。我们为其分配了托管身份。</li></ul><p id="7e5f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在让我们创建一个简单的C#客户端，我们可以用它来验证一切正常。注意，这个客户端使用了<a class="ae kl" href="https://www.nuget.org/packages/MySqlConnector/" rel="noopener ugc nofollow" target="_blank"><em class="mo">MySQL connector</em></a>nu get包。注意<a class="ae kl" href="https://docs.microsoft.com/en-us/azure/mysql/howto-configure-sign-in-azure-ad-authentication#compatibility-with-application-drivers" rel="noopener ugc nofollow" target="_blank">不是所有的驱动都兼容【MySQL AAD集成。</a><a class="ae kl" href="https://www.nuget.org/packages/MySqlConnector/" rel="noopener ugc nofollow" target="_blank"> <em class="mo"> MySqlConnector </em> </a>是。</p><pre class="lq lr ls lt gt mu mv mw mx aw my bi"><span id="6e37" class="mz kn iq mv b gy na nb l nc nd">using System;<br/>using System.Collections.Generic;<br/>using System.IO;<br/>using System.Linq;<br/>using System.Net;<br/>using System.Text.Json;<br/>using System.Threading.Tasks;<br/>using Microsoft.AspNetCore.Mvc;<br/>using Microsoft.Extensions.Configuration;<br/>using Microsoft.Extensions.Logging;<br/>using MySql.Data.MySqlClient;</span><span id="1a59" class="mz kn iq mv b gy ne nb l nc nd">namespace MySqlTest.Controllers<br/>{<br/>    [ApiController]<br/>    [Route("[controller]")]<br/>    public class MySqlController : ControllerBase<br/>    {<br/>        private readonly ILogger&lt;MySqlController&gt; _logger;<br/>        private readonly IConfiguration _configuration;</span><span id="18a6" class="mz kn iq mv b gy ne nb l nc nd">public MySqlController(ILogger&lt;MySqlController&gt; logger, IConfiguration configuration)<br/>        {<br/>            _logger = logger;<br/>            _configuration = configuration;<br/>        }</span><span id="52eb" class="mz kn iq mv b gy ne nb l nc nd">[HttpGet]<br/>        [Route("withAdmin")]<br/>        public async Task&lt;string&gt; GetWithAdmin()<br/>        {<br/>            using var conn = new MySqlConnection(_configuration["MySqlConnection"]);<br/>            await conn.OpenAsync();<br/>            using var cmd = conn.CreateCommand();<br/>            cmd.CommandText = "SELECT 1 AS X";<br/>            return (await cmd.ExecuteScalarAsync()).ToString();<br/>        }</span><span id="e7ce" class="mz kn iq mv b gy ne nb l nc nd">[HttpGet]<br/>        [Route("withManagedIdentity")]<br/>        public async Task&lt;string&gt; GetWithManagedIdentity()<br/>        {<br/>            var builder = new MySqlConnectionStringBuilder<br/>            {<br/>                Server = _configuration["Host"],<br/>                Database = _configuration["Database"],<br/>                UserID = _configuration["User"],<br/>                Password = await GetAccessToken(),<br/>                SslMode = MySqlSslMode.Required,<br/>            };</span><span id="8ae9" class="mz kn iq mv b gy ne nb l nc nd">using var conn = new MySqlConnection(builder.ConnectionString);<br/>            try<br/>            {<br/>                await conn.OpenAsync();</span><span id="6309" class="mz kn iq mv b gy ne nb l nc nd">using var cmd = conn.CreateCommand();<br/>                cmd.CommandText = "SELECT 1 AS X";<br/>                return (await cmd.ExecuteScalarAsync()).ToString();<br/>            }<br/>            catch (Exception ex)<br/>            {<br/>                return ex.Message;<br/>            }<br/>        }</span><span id="5c63" class="mz kn iq mv b gy ne nb l nc nd">[HttpGet]<br/>        [Route("token")]<br/>        public async Task&lt;string&gt; GetToken()<br/>        {<br/>            return await GetAccessToken();<br/>        }</span><span id="1637" class="mz kn iq mv b gy ne nb l nc nd">private async Task&lt;string&gt; GetAccessToken()<br/>        {<br/>            var clientID = _configuration["ClientID"];<br/>            var request = (HttpWebRequest)WebRequest.Create($"{_configuration["MSI_ENDPOINT"]}?api-version=2019-08-01&amp;resource=https%3A%2F%2Fossrdbms-aad.database.windows.net&amp;client_id=" + clientID);<br/>            request.Headers["Metadata"] = "true";<br/>            request.Headers["X-IDENTITY-HEADER"] = _configuration["MSI_SECRET"];<br/>            request.Method = "GET";</span><span id="b7aa" class="mz kn iq mv b gy ne nb l nc nd">// Call managed identities for Azure resources endpoint.<br/>            var response = (HttpWebResponse)request.GetResponse();</span><span id="24fa" class="mz kn iq mv b gy ne nb l nc nd">// Pipe response Stream to a StreamReader and extract access token.<br/>            StreamReader streamResponse = new StreamReader(response.GetResponseStream());<br/>            var stringResponse = await streamResponse.ReadToEndAsync();<br/>            var list = JsonSerializer.Deserialize&lt;Dictionary&lt;string, string&gt;&gt;(stringResponse);<br/>            return list["access_token"];<br/>        }<br/>    }<br/>}</span></pre><p id="802b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意，这是目前为止<strong class="jp ir"> <em class="mo">而不是</em> </strong>生产就绪代码。这只是一个演示一般如何做的示例。这里有一些注意事项:</p><ul class=""><li id="d026" class="mf mg iq jp b jq jr ju jv jy mh kc mi kg mj kk mk ml mm mn bi translated"><em class="mo">getwithdmin()</em>演示使用用户名和密码访问MySQL的常用方法。</li><li id="4077" class="mf mg iq jp b jq mp ju mq jy mr kc ms kg mt kk mk ml mm mn bi translated"><em class="mo">getaccessstoken()</em>展示了如何使用托管身份获取访问令牌。注意，实际上你将<strong class="jp ir"> <em class="mo">永远不会</em> </strong>暴露那个信息。然而，出于学习的目的，我创建了一个路由，通过它您可以通过浏览器获得访问令牌。再次，我建议分析它，以更深入地了解此事。</li><li id="6fb6" class="mf mg iq jp b jq mp ju mq jy mr kc ms kg mt kk mk ml mm mn bi translated">最后，<em class="mo">GetWithManagedIdentity()</em>演示了如何使用托管身份检索的访问令牌向MySQL进行身份验证。</li></ul><p id="4ff3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">构建它，部署到我们ARM模板创建的App Service Web App，尝试<em class="mo">https://your site . azure websites . net/MySQL/withManagedIdentity</em>。它应该成功返回<em class="mo"> 1 </em>。</p><h1 id="776b" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">结论</h1><p id="63b5" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">托管身份增强了系统的安全性，因为您不必手动设置和定期更改数据库密码。托管身份与MySQL的集成并不简单，但是一旦你搞清楚了上面提到的事情，它就能很好地工作。希望这篇文章对你有用。</p></div></div>    
</body>
</html>