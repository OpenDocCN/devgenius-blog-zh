<html>
<head>
<title>Location-based application using Django, PostGIS and Leaflet</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Django、PostGIS 和传单的基于位置的应用程序</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/location-based-application-using-django-postgis-and-leaflet-9469845579c9?source=collection_archive---------4-----------------------#2022-03-16">https://blog.devgenius.io/location-based-application-using-django-postgis-and-leaflet-9469845579c9?source=collection_archive---------4-----------------------#2022-03-16</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/6adea266b10b3c3c3724db7aeaefdfd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kTYRN9YQkHOulM0KmHevBg.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">一个空间指向另一个——水手大力水手。</figcaption></figure><p id="f7b3" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">在之前的一篇文章中，关于<a class="ae kx" href="https://pyblog.medium.com/hybrid-spatial-data-structure-based-on-kd-tree-and-quadtree-8c0c5eebdbbf" rel="noopener">混合空间索引</a>查找空间数据点的实验是值得探索的，但是内存实现和缺乏伸缩能力使得在现实应用中使用它几乎毫无意义。</p><p id="fddb" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">在一个需要存储和访问空间数据(坐标)的 web 应用程序中，Django、PostgreSQL (PostGIS)、GeoDjango 和 Leaflet(或 Google Maps)的组合解决了大多数初步用例。</p><h1 id="81a8" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">当地的组织</h1><ul class=""><li id="a49a" class="lw lx in kb b kc ly kg lz kk ma ko mb ks mc kw md me mf mg bi translated">安装依赖项</li><li id="1729" class="lw lx in kb b kc mh kg mi kk mj ko mk ks ml kw md me mf mg bi translated">启动 PostgreSQL 服务器</li><li id="5c07" class="lw lx in kb b kc mh kg mi kk mj ko mk ks ml kw md me mf mg bi translated">配置 Django 应用程序</li></ul><h1 id="4c86" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">安装虚拟</h1><p id="019b" class="pw-post-body-paragraph jz ka in kb b kc ly ke kf kg lz ki kj kk mm km kn ko mn kq kr ks mo ku kv kw ig bi translated">和往常一样，在处理 python 项目时，总是使用<code class="fe mp mq mr ms b">virtualenv</code>或<code class="fe mp mq mr ms b">conda env</code>。如果你还没有安装<code class="fe mp mq mr ms b">virtualenv</code>，安装它(<a class="ae kx" href="https://packaging.python.org/en/latest/guides/installing-using-pip-and-virtual-environments/" rel="noopener ugc nofollow" target="_blank">参考</a>):</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="e2f0" class="nb kz in ms b gy nc nd l ne nf">python3 -m pip install --user --upgrade pip<br/>python3 -m pip --version<br/>python3 -m pip install --user virtualenv</span></pre><h1 id="39f5" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">安装依赖项</h1><p id="1974" class="pw-post-body-paragraph jz ka in kb b kc ly ke kf kg lz ki kj kk mm km kn ko mn kq kr ks mo ku kv kw ig bi translated">为项目创建一个环境，用适当的名称替换<code class="fe mp mq mr ms b">env</code>:</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="fa04" class="nb kz in ms b gy nc nd l ne nf">python3 -m venv env<br/>source env/bin/activate<br/>python3 -m pip install -r requirements.txt</span></pre><p id="748b" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><code class="fe mp mq mr ms b">requirements.txt</code>:</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="c5dd" class="nb kz in ms b gy nc nd l ne nf">Django==4.0.2<br/>django-leaflet==0.28.2<br/>psycopg2-binary==2.9.3<br/>gunicorn==20.1.0</span></pre><p id="3e75" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">当然，这里不需要<code class="fe mp mq mr ms b">gunicorn</code>，只是一个练习，记住不要在生产中使用开发服务器(这是我经常在其他博文中看到的)。</p><h1 id="985f" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">安装必备组件</h1><p id="a9c1" class="pw-post-body-paragraph jz ka in kb b kc ly ke kf kg lz ki kj kk mm km kn ko mn kq kr ks mo ku kv kw ig bi translated">PostGIS 是 PostgreSQL 对象关系数据库的空间数据库扩展器。它支持地理对象，允许在 SQL 中运行位置查询。</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="c914" class="nb kz in ms b gy nc nd l ne nf">brew install postgresql<br/>brew install postgis<br/>brew install gdal<br/>brew install libgeoip</span></pre><p id="3693" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">确保已经按照<code class="fe mp mq mr ms b">requirements.txt</code>中所述安装了<code class="fe mp mq mr ms b">psycopg2-binary</code></p><h1 id="6ff3" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">启动 PostgreSQL 服务器</h1><p id="6b95" class="pw-post-body-paragraph jz ka in kb b kc ly ke kf kg lz ki kj kk mm km kn ko mn kq kr ks mo ku kv kw ig bi translated">虽然您可以在本地安装<code class="fe mp mq mr ms b">PostgreSQL</code>服务器，但是使用 docker 会使它更加容易，除了确保安装 docker 之外没有任何麻烦。</p><p id="d2fa" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">在本地机器上启动 docker 并运行:</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="c98f" class="nb kz in ms b gy nc nd l ne nf">docker run --name=postgis -d -e POSTGRES_USER=&lt;database-username&gt; -e POSTGRES_PASS=&lt;database-password&gt; -e POSTGRES_DBNAME=&lt;database-name&gt; -p 5432:5432 kartoza/postgis:14-3.2</span></pre><p id="78f5" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">并根据需要更换<code class="fe mp mq mr ms b">&lt;database-username&gt;</code>和<code class="fe mp mq mr ms b">&lt;database-password&gt;</code>、<code class="fe mp mq mr ms b">&lt;database-name&gt;</code>。</p><h1 id="3f45" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">Django 项目设置</h1><p id="775a" class="pw-post-body-paragraph jz ka in kb b kc ly ke kf kg lz ki kj kk mm km kn ko mn kq kr ks mo ku kv kw ig bi translated">在<code class="fe mp mq mr ms b">settings.py</code>中配置 PostGIS 数据库、INSTALLED_APPS 和传单</p><h1 id="b993" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">数据库</h1><p id="fac4" class="pw-post-body-paragraph jz ka in kb b kc ly ke kf kg lz ki kj kk mm km kn ko mn kq kr ks mo ku kv kw ig bi translated">假设您手边已经有一个 Django 项目，在<code class="fe mp mq mr ms b">settings.py</code>中，<code class="fe mp mq mr ms b">database</code>:</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="f8c1" class="nb kz in ms b gy nc nd l ne nf">DATABASES = {<br/>    'default': {<br/>        'ENGINE': 'django.contrib.gis.db.backends.postgis',<br/>        'NAME': config('DATABASE_NAME'),<br/>        'USER': config('DATABASE_USER'),<br/>        'PASSWORD': config('DATABASE_PASSWORD'),<br/>        'HOST': config('HOST_ENDPOINT'),<br/>        'PORT': '5432',<br/>    }<br/>}</span></pre><p id="555f" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">如果您使用的是 Mac M1，您需要添加到<code class="fe mp mq mr ms b">gdal</code>的完整路径，对于本地设置，只需在<code class="fe mp mq mr ms b">settings.py</code>中添加以下两个文件</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="527a" class="nb kz in ms b gy nc nd l ne nf">GDAL_LIBRARY_PATH = '/opt/homebrew/opt/gdal/lib/libgdal.dylib'<br/>GEOS_LIBRARY_PATH = '/opt/homebrew/opt/geos/lib/libgeos_c.dylib'</span></pre><h1 id="f23e" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">已安装的应用程序</h1><p id="5e4e" class="pw-post-body-paragraph jz ka in kb b kc ly ke kf kg lz ki kj kk mm km kn ko mn kq kr ks mo ku kv kw ig bi translated">将<code class="fe mp mq mr ms b">settings.py</code>中的<code class="fe mp mq mr ms b">django.contrib.gis</code>增加到<code class="fe mp mq mr ms b">INSTALLED_APPS</code>。如果使用活页，安装<code class="fe mp mq mr ms b">django-leaflet</code>并在<code class="fe mp mq mr ms b">settings.py</code>中的<code class="fe mp mq mr ms b">INSTALLED_APPS</code>处添加<code class="fe mp mq mr ms b">leaflet</code>。</p><h1 id="7b50" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">传单 _ 配置</h1><p id="3d73" class="pw-post-body-paragraph jz ka in kb b kc ly ke kf kg lz ki kj kk mm km kn ko mn kq kr ks mo ku kv kw ig bi translated">在<code class="fe mp mq mr ms b">settings.py</code>中增加<code class="fe mp mq mr ms b">LEAFLET_CONFIG</code>配置</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="c123" class="nb kz in ms b gy nc nd l ne nf">LEAFLET_CONFIG = {<br/>    'DEFAULT_CENTER': (44.638569, -63.586262),<br/>    'DEFAULT_ZOOM': 18,<br/>    'MAX_ZOOM': 20,<br/>    'MIN_ZOOM': 3,<br/>    'SCALE': 'both',<br/>    'ATTRIBUTION_PREFIX': 'Location Tracker'<br/>}</span></pre><p id="66b8" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">最后，传单可能需要<code class="fe mp mq mr ms b">static</code>；确保在<code class="fe mp mq mr ms b">settings.py</code>中添加路径:</p><h1 id="c7e0" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">静电</h1><p id="f4ce" class="pw-post-body-paragraph jz ka in kb b kc ly ke kf kg lz ki kj kk mm km kn ko mn kq kr ks mo ku kv kw ig bi translated">根目录中静态文件的相对路径:</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="2360" class="nb kz in ms b gy nc nd l ne nf">STATIC_URL = '/static/'<br/>STATIC_ROOT = os.path.join(BASE_DIR, 'static')</span></pre><h1 id="052a" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">Django 模型</h1><p id="ca18" class="pw-post-body-paragraph jz ka in kb b kc ly ke kf kg lz ki kj kk mm km kn ko mn kq kr ks mo ku kv kw ig bi translated">假设您有一个名为<code class="fe mp mq mr ms b">Trip</code>的模型，它有源地址和目的地址(坐标:纬度和经度)。</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="45db" class="nb kz in ms b gy nc nd l ne nf">class Trip(models.Model):<br/>    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)<br/>    source_location = models.PointField(null=True)<br/>    destination_location = models.PointField(null=True)</span></pre><p id="2079" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">在<code class="fe mp mq mr ms b">admin.py</code>中:</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="41ed" class="nb kz in ms b gy nc nd l ne nf">from leaflet.admin import LeafletGeoAdmin<br/>from .models import Trip</span><span id="68e1" class="nb kz in ms b gy ng nd l ne nf">class TripAdmin(LeafletGeoAdmin):<br/>    list_display = ('source_location', 'destination_location')</span><span id="0bfe" class="nb kz in ms b gy ng nd l ne nf">admin.site.register(Trip, TripAdmin)</span></pre><h1 id="5aef" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">运行迁移，创建超级用户，并启动开发服务器</h1><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="2d46" class="nb kz in ms b gy nc nd l ne nf">python3 manage.py makemigrations<br/>python3 manage.py migrate</span><span id="2453" class="nb kz in ms b gy ng nd l ne nf">python3 manage.py createsuperuser</span><span id="8ee8" class="nb kz in ms b gy ng nd l ne nf">python3 manage.py runserver</span></pre><p id="3350" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">最后，转到<code class="fe mp mq mr ms b">http://localhost:8000/admin</code>，输入用户名和密码，并导航到具有位置字段的模型(<code class="fe mp mq mr ms b">Trip</code>，以创建一个条目。</p><h1 id="13c5" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">代码片段</h1><p id="f94a" class="pw-post-body-paragraph jz ka in kb b kc ly ke kf kg lz ki kj kk mm km kn ko mn kq kr ks mo ku kv kw ig bi translated">在半径范围内搜索<code class="fe mp mq mr ms b">source_location</code>的行程</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="e172" class="nb kz in ms b gy nc nd l ne nf">from django.contrib.gis.geos import Point<br/>from django.contrib.gis.measure import Distance<br/>from .models import Trip</span><span id="287e" class="nb kz in ms b gy ng nd l ne nf">def get_trips(latitude, longitude, radius):<br/>    point = Point(latitude, longitude)<br/>    trips = Trip.objects.filter(source_location__distance_lt=(point, Distance(km=radius)))<br/>    return trips</span></pre><p id="34c3" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">差不多就是这样！虽然这不是 GeoDjango 功能的完整列表，但请参考此处的文档:<a class="ae kx" href="https://docs.djangoproject.com/en/4.0/ref/contrib/gis/tutorial/#" rel="noopener ugc nofollow" target="_blank">https://docs . django project . com/en/4.0/ref/contrib/GIS/tutorial/#</a>了解更多详细信息。</p><p id="745b" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">参考代号:<a class="ae kx" href="https://github.com/addu390/dedo" rel="noopener ugc nofollow" target="_blank">https://github.com/addu390/dedo</a>一如既往</p></div></div>    
</body>
</html>