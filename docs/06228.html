<html>
<head>
<title>ArgoCD with Kustomize and ksops</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">与Kustomize和ksops的ArgoCD</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/argocd-with-kustomize-and-ksops-2d43472e9d3b?source=collection_archive---------0-----------------------#2021-12-23">https://blog.devgenius.io/argocd-with-kustomize-and-ksops-2d43472e9d3b?source=collection_archive---------0-----------------------#2021-12-23</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/df6503770e191e8ad1d8d1242346c259.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8OSdMQhgfrdAWHFQSP3VgQ.jpeg"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">锁定在Git Repo中的秘密:)</figcaption></figure><h1 id="1852" class="jz ka in bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">介绍</h1><p id="ab06" class="pw-post-body-paragraph kx ky in kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu ig bi translated">Kustomize让您自定义原始的，无模板的YAML文件的多种用途，留下原来的YAML原封不动和可用。当与ArgoCD for gitops结合使用时，该组合可以真正成为一个优秀的设置。</p><h1 id="c0c0" class="jz ka in bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">描述</h1><p id="542a" class="pw-post-body-paragraph kx ky in kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu ig bi translated">我们不能将私钥或密码作为秘密推送给git repo来使用gitops。这可以通过诸如Vault、Keycloak、sop等秘密管理工具来解决。最简单的是SOPS，因为它用PGP密钥加密内容，而秘密由kustomize在集群内用相同的PGP密钥解密。</p><h1 id="33b0" class="jz ka in bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">问题</h1><p id="37c4" class="pw-post-body-paragraph kx ky in kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu ig bi translated">与FluxCD不同，ArgoCD没有内置的机密管理。但是ArgoCD提供了灵活性，可以与任何秘密管理工具集成。这里<a class="ae lv" href="https://argo-cd.readthedocs.io/en/stable/operator-manual/secret-management/" rel="noopener ugc nofollow" target="_blank">解释了一些支持的解决方案</a>:大部分的文档都是通过云提供的秘密解决方案来设置sop与ArgoCD一起工作。</p><h1 id="71f2" class="jz ka in bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">解决办法</h1><p id="4506" class="pw-post-body-paragraph kx ky in kz b la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu ig bi translated">有两种方法可以用sop设置ArgoCD。</p><ul class=""><li id="af92" class="lw lx in kz b la ly le lz li ma lm mb lq mc lu md me mf mg bi translated">使用kustomize和sops创建自定义ArgoCD docker映像，并使用自定义docker映像。问题是ArgoCD的每个新版本都需要更新图像。所以我更喜欢第二种选择</li><li id="d076" class="lw lx in kz b la mh le mi li mj lm mk lq ml lu md me mf mg bi translated">在ArgoCD repo服务器部署中创建一个init容器，以获得带有sops的kustomize插件，如这里的<a class="ae lv" href="https://github.com/viaduct-ai/kustomize-sops#argo-cd-integration" rel="noopener ugc nofollow" target="_blank">中所述，并在pod中使用它。即使ArgoCD版本更新了，插件也不需要更新，除非插件版本和ArgoCD版本存在兼容性问题。</a></li></ul><p id="c7fb" class="pw-post-body-paragraph kx ky in kz b la ly lc ld le lz lg lh li mm lk ll lm mn lo lp lq mo ls lt lu ig bi translated">因此，按照选项2，考虑ArgoCD已经在集群中的<code class="fe mp mq mr ms b">argocd</code>名称空间中运行。</p><p id="c8ca" class="pw-post-body-paragraph kx ky in kz b la ly lc ld le lz lg lh li mm lk ll lm mn lo lp lq mo ls lt lu ig bi translated">首先生成一个GPG键:</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="f926" class="nb ka in ms b gy nc nd l ne nf">export GPG_NAME="k3s.argotest.cluster"<br/>export GPG_COMMENT="argocd secrets"<br/><br/>gpg --batch --full-generate-key &lt;&lt;EOF<br/>%no-protection<br/>Key-Type: 1<br/>Key-Length: 4096<br/>Subkey-Type: 1<br/>Subkey-Length: 4096<br/>Expire-Date: 0<br/>Name-Comment: ${GPG_COMMENT}<br/>Name-Real: ${GPG_NAME}<br/>EOF</span></pre><p id="0fd1" class="pw-post-body-paragraph kx ky in kz b la ly lc ld le lz lg lh li mm lk ll lm mn lo lp lq mo ls lt lu ig bi translated">上面的代码将创建一个4096位的RSA密钥。有关创建GPG键的完整配置，请检查<a class="ae lv" href="https://www.gnupg.org/documentation/manuals/gnupg/Unattended-GPG-key-generation.html" rel="noopener ugc nofollow" target="_blank">此</a>链接</p><p id="5470" class="pw-post-body-paragraph kx ky in kz b la ly lc ld le lz lg lh li mm lk ll lm mn lo lp lq mo ls lt lu ig bi translated">检索密钥名称</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="4856" class="nb ka in ms b gy nc nd l ne nf">gpg --list-secret-keys "${GPG_NAME}"</span><span id="fb0e" class="nb ka in ms b gy ng nd l ne nf">sec   rsa4096 2021-12-23 [SCEA]<br/>      7AD1E449E7DDD762C7FCFAFA0D177809067B3970<br/>uid           [ultimate] k3s.argotest.cluster (argocd secrets)</span></pre><p id="605e" class="pw-post-body-paragraph kx ky in kz b la ly lc ld le lz lg lh li mm lk ll lm mn lo lp lq mo ls lt lu ig bi translated">将GPG键指纹存储为环境变量</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="4f1d" class="nb ka in ms b gy nc nd l ne nf">export GPG_ID=7AD1E449E7DDD762C7FCFAFA0D177809067B3970</span></pre><p id="83a8" class="pw-post-body-paragraph kx ky in kz b la ly lc ld le lz lg lh li mm lk ll lm mn lo lp lq mo ls lt lu ig bi translated">从GPG密钥导出公钥和私钥对，并为ArgoCD创建一个kubernetes秘密来读取它们</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="f917" class="nb ka in ms b gy nc nd l ne nf">gpg --export-secret-keys --armor "${GPG_ID} |<br/>kubectl create secret generic sops-gpg <strong class="ms io">\<br/></strong>--namespace=argocd <strong class="ms io">\<br/></strong>--from-file=sops.asc=/dev/stdin</span></pre><p id="fc31" class="pw-post-body-paragraph kx ky in kz b la ly lc ld le lz lg lh li mm lk ll lm mn lo lp lq mo ls lt lu ig bi translated">从本地机器上删除本地创建的私钥，因为密钥现在在集群上。</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="d2c3" class="nb ka in ms b gy nc nd l ne nf">gpg --delete-secret-keys "${GPG_ID}"</span></pre><p id="b57e" class="pw-post-body-paragraph kx ky in kz b la ly lc ld le lz lg lh li mm lk ll lm mn lo lp lq mo ls lt lu ig bi translated">如果一个团队正在进行回购，并且他们需要使用sop在本地加密机密，那么导出公钥并将其存储在回购中是一个好主意，这样他们就可以下载并使用该密钥来加密机密</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="9b63" class="nb ka in ms b gy nc nd l ne nf">gpg --export --armor "${GPG_ID}" &gt; .sops.pub.asc</span></pre><p id="146c" class="pw-post-body-paragraph kx ky in kz b la ly lc ld le lz lg lh li mm lk ll lm mn lo lp lq mo ls lt lu ig bi translated">这个公钥可以被导入并用于在本地加密机密，然后推送到git repos</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="18f2" class="nb ka in ms b gy nc nd l ne nf">gpg --import .sops.pub.asc</span></pre><p id="6c82" class="pw-post-body-paragraph kx ky in kz b la ly lc ld le lz lg lh li mm lk ll lm mn lo lp lq mo ls lt lu ig bi translated">让我们创造一个虚假的秘密</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="c9d8" class="nb ka in ms b gy nc nd l ne nf">kubectl -n myapp create secret generic app-secret \<br/>--from-literal=token=4BD1CE23-E3C0-4BBF-A75E-ABA103EE95C9 \<br/>--dry-run=client \<br/>-o yaml &gt; secret.yaml</span></pre><p id="3450" class="pw-post-body-paragraph kx ky in kz b la ly lc ld le lz lg lh li mm lk ll lm mn lo lp lq mo ls lt lu ig bi translated">导出的secret yaml将如下所示</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="04c3" class="nb ka in ms b gy nc nd l ne nf">apiVersion: v1<br/>data:<br/>  token: NEJEMUNFMjMtRTNDMC00QkJGLUE3NUUtQUJBMTAzRUU5NUM5<br/>kind: Secret<br/>metadata:<br/>  name: app-secret<br/>  namespace: myapp</span></pre><p id="2bc6" class="pw-post-body-paragraph kx ky in kz b la ly lc ld le lz lg lh li mm lk ll lm mn lo lp lq mo ls lt lu ig bi translated">用sop加密secret.yaml</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="dcc0" class="nb ka in ms b gy nc nd l ne nf">sops --encrypt --in-place secret.yaml</span></pre><p id="b76b" class="pw-post-body-paragraph kx ky in kz b la ly lc ld le lz lg lh li mm lk ll lm mn lo lp lq mo ls lt lu ig bi translated">如果有多个GPG密钥，那么使用导出的GPG ID环境变量或GPG密钥ID用特定的密钥加密</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="de5c" class="nb ka in ms b gy nc nd l ne nf">sops --encrypt --in-place \<br/>-p <!-- -->7AD1E449E7DDD762C7FCFAFA0D177809067B3970<!-- --> basic-auth.yaml</span></pre><p id="46d1" class="pw-post-body-paragraph kx ky in kz b la ly lc ld le lz lg lh li mm lk ll lm mn lo lp lq mo ls lt lu ig bi translated">现在secret.yaml的内容将如下所示:</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="5592" class="nb ka in ms b gy nc nd l ne nf">❯ cat secret.yaml<br/>apiVersion: ENC[AES256_GCM,data:ges=,iv:bkleuf27QnbKQTqLdCnawJ4oJOnj/EA3sVVSLDNdRHo=,tag:BGZaPAV8maLId+KH/YFV0g==,type:str]<br/>data:<br/>    token: ENC[AES256_GCM,data:GdQcwyBNvMPxzrwQUNI6IKdvt3djCRR37mckZ+N6oDqfoCCa0FNILRAWJeT0BIQ5,iv:5ZCMiZpAGIkR5qaj1DdHvTY4K5mki5n2Q0QK8T5WtoA=,tag:sl+NG6u86QEMwth9eWhzBQ==,type:str]<br/>kind: ENC[AES256_GCM,data:gD6BgdIS,iv:7bF7ViYyBxYYQE6WDgxEN/Vi+3qLSh3TzDIzZcFCjeM=,tag:60Ytp9Ec5ERVEXTH2CS/6w==,type:str]<br/>metadata:<br/>    creationTimestamp: null<br/>    name: ENC[AES256_GCM,data:J224lqhNHkLLjg==,iv:gfENh1kucL0H9Tm/5cIiN8RRyiHTWPsX9j7/tbf9ffc=,tag:H4t+z664L05ExGBo9ZuyGA==,type:str]<br/>    namespace: ENC[AES256_GCM,data:Jz6qCfc+3w==,iv:XoqLmWZibTxOkEwbsY86ygd0+oAfVzyMbNMCw9KsiOY=,tag:OIJabS57TlbjXAkce48BtA==,type:str]<br/>sops:<br/>    kms: []<br/>    gcp_kms: []<br/>    azure_kv: []<br/>    hc_vault: []<br/>    age: []<br/>    lastmodified: "2021-12-23T10:09:26Z"<br/>    mac: ENC[AES256_GCM,data:9pL458Y1TZ0g4LXqc1puif9eGz3uK5jkIRYQKECoAUBAkBlv9nbVN/DpZYpdGYfRSHuLNTJ9ASXSInSJqT4EXp9CegRDYnEEpcPq+PBV0a3wPuoPYeGMVXBax1JFSdmzakzVsBL0HcsyPWrU4YLoAc5Rl5kxO1NEBsMNQBl+mXg=,iv:UTETLuqmUG1SebwHjJP8lOKKBJQMSBPlIZjoiREPtj4=,tag:1YM6KpjzPX4vmkA6LSN+0w==,type:str]<br/>    pgp:<br/>        - created_at: "2021-12-23T10:09:25Z"<br/>          enc: |<br/>            -----BEGIN PGP MESSAGE-----</span><span id="f89d" class="nb ka in ms b gy ng nd l ne nf">hQIMA55I+RFb4Yu5AQ/9F/1eBWZccqsvbI53cIMT4gkrQ1p+p1n0PHIWW2VJKu6f<br/>            6hC4OkbrJIcum87PgCCg8xxsUyDaUgd891/G7+KMGC8pl6fcEDMOqyEUR3tz12S0<br/>            zIBWYx3mIniNmZrp6xnBFbokKahO6iALBlQJ9s4DsSMWqdonuDJtO6ILZI8U7v0k<br/>            4H0abk1F3Eb7808IQ3w4BZhsnV1x/yxAghvsjQNOAHyBxIny8F74GmnRnkGLQqMc<br/>            txRPKCs17eUhUMoMJ5rkXYzgTdbFqA/fMDRubgQ2eD9E8GfRE2rskEM4ednKg1A3<br/>            VaTCeIXCazqxVpmxBYCqOGks5hfTrgY6WqW/aK8GIysusStXs/N5O8J4jgAy4pYt<br/>            SZFy8wILBd6jozYLeJZO7jVsdZuDC0btxNwxK5fTnUnZeRySkUJDEEeyOeJOIwbt<br/>            UaRe3B/Lu3wXY4PKD7F3sWsRKJXEP61MMDVc0hCH07g/U2bbq3+ucGnOMfNXIilb<br/>            YfSPBR91TAyaB4B7MvlYjPdL9BIiJPAoddE7pEFh7iQSS29GnphYDC+uis84i8ET<br/>            YWVvMm0NEymDlpROToczpN/yvQ29EvkSJX1qPmEol3vE+gB+Z6C9Gi6/KGy+sW1F<br/>            ziot0887LWcYSPIZZNSk2Rc9sDoTAx6Q6JAN2Fthdb89yhL6oPWa8ZhicRgQ8cTU<br/>            aAEJAhDZjpuTM/sNdNMstIX+OMeHVT0eiECAqNNtSNoXwXvRqhjubY6soXcXqtRR<br/>            vSZ1TlPH+985ukG57fhV3zgfCpaxMmEfpQx5p2LtE98dQtkLUVwfx59113rVTDJu<br/>            6VeWUKAYWPjf<br/>            =moTo<br/>            -----END PGP MESSAGE-----<br/>          fp: 7AD1E449E7DDD762C7FCFAFA0D177809067B3970<br/>    unencrypted_suffix: _unencrypted<br/>    version: 3.7.1</span></pre><p id="c1f8" class="pw-post-body-paragraph kx ky in kz b la ly lc ld le lz lg lh li mm lk ll lm mn lo lp lq mo ls lt lu ig bi translated">这个秘密文件可以推送到回购。</p><p id="dc04" class="pw-post-body-paragraph kx ky in kz b la ly lc ld le lz lg lh li mm lk ll lm mn lo lp lq mo ls lt lu ig bi translated">现在对于ArgoCD部分，如前所述，我将使用<code class="fe mp mq mr ms b">init-containers</code>作为ArgoCD回购服务器。</p><p id="82c5" class="pw-post-body-paragraph kx ky in kz b la ly lc ld le lz lg lh li mm lk ll lm mn lo lp lq mo ls lt lu ig bi translated">在修改repo server的部署之前，我们需要通过configMap进行kustomize以启用ksops。这需要通过替换当前的<code class="fe mp mq mr ms b">argocd-cm</code>配置图来完成。配置图如下所示:</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="02b9" class="nb ka in ms b gy nc nd l ne nf">apiVersion: v1<br/>kind: ConfigMap<br/>metadata:<br/>  name: argocd-cm<br/>  namespace: argocd<br/>data:<br/>  # For KSOPs versions &lt; v2.5.0, use the old kustomize flag style<br/>  # kustomize.buildOptions: "--enable_alpha_plugins"<br/>  kustomize.buildOptions: "--enable-alpha-plugins"</span></pre><p id="e2dc" class="pw-post-body-paragraph kx ky in kz b la ly lc ld le lz lg lh li mm lk ll lm mn lo lp lq mo ls lt lu ig bi translated">repo-server-deployment的补丁如下所示</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="081f" class="nb ka in ms b gy nc nd l ne nf">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: argocd-repo-server<br/>  namespace: argocd<br/>spec:<br/>  template:<br/>    spec:<br/>      initContainers:<br/>        - name: install-ksops<br/>          image: viaductoss/ksops:v3.0.1<br/>          command: ["/bin/sh", "-c"]<br/>          args:<br/>            - echo "Installing KSOPS...";<br/>              export PKG_NAME=ksops;<br/>              mv ${PKG_NAME}.so /custom-tools/;<br/>              mv $GOPATH/bin/kustomize /custom-tools/;<br/>              echo "Done.";<br/>          volumeMounts:<br/>            - mountPath: /custom-tools<br/>              name: custom-tools<br/>        - name: import-gpg-key<br/>          image: argoproj/argocd:v2.1.7<br/>          command: ["gpg", "--import","/sops-gpg/sops.asc"]<br/>          env:<br/>            - name: GNUPGHOME<br/>              value: /gnupg-home/.gnupg<br/>          volumeMounts:<br/>            - mountPath: /sops-gpg<br/>              name: sops-gpg<br/>            - mountPath: /gnupg-home<br/>              name: gnupg-home<br/>      containers:<br/>      - name: argocd-repo-server<br/>        env:<br/>          - name: XDG_CONFIG_HOME<br/>            value: /.config<br/>          - name: GNUPGHOME<br/>            value: /home/argocd/.gnupg<br/>        volumeMounts:<br/>        - mountPath: /home/argocd/.gnupg<br/>          name: gnupg-home<br/>          subPath: .gnupg<br/>        - mountPath: /usr/local/bin/kustomize<br/>          name: custom-tools<br/>          subPath: kustomize<br/>        - mountPath: /.config/kustomize/plugin/viaduct.ai/v1/ksops/ksops<br/>          name: custom-tools<br/>          subPath: ksops<br/>      volumes:<br/>      - name: custom-tools<br/>        emptyDir: {}<br/>      - name: gnupg-home<br/>        emptyDir: {}<br/>      - name: sops-gpg<br/>        secret:<br/>          secretName: sops-gpg</span></pre><p id="3163" class="pw-post-body-paragraph kx ky in kz b la ly lc ld le lz lg lh li mm lk ll lm mn lo lp lq mo ls lt lu ig bi translated">并为repo server应用配置映射和补丁</p><pre class="mt mu mv mw gt mx ms my mz aw na bi"><span id="deb5" class="nb ka in ms b gy nc nd l ne nf">kubectl apply -f cm.yaml<br/>kubectl patch deployment -n argocd argocd-repo-server --patch "$(cat repo-deploy-patch.yaml)</span></pre><p id="7822" class="pw-post-body-paragraph kx ky in kz b la ly lc ld le lz lg lh li mm lk ll lm mn lo lp lq mo ls lt lu ig bi translated">现在ArgoCD可以使用定制的<code class="fe mp mq mr ms b">kustomize</code>插件来解密秘密，这个插件是用sop加密的，使用的是集群中作为秘密安装的GPG密钥的私钥。</p><p id="fc6a" class="pw-post-body-paragraph kx ky in kz b la ly lc ld le lz lg lh li mm lk ll lm mn lo lp lq mo ls lt lu ig bi translated">享受使用ArgoCD在GitOps中加密的乐趣！！</p></div></div>    
</body>
</html>