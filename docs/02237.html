<html>
<head>
<title>Node.js Tips — Mongoose Updates, HTML Emails, and Stubbing Dependencies</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Node.js 提示——mongose 更新、HTML 电子邮件和存根依赖</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/node-js-tips-mongoose-updates-html-emails-and-stubbing-dependencies-1f15b509aa81?source=collection_archive---------19-----------------------#2020-07-24">https://blog.devgenius.io/node-js-tips-mongoose-updates-html-emails-and-stubbing-dependencies-1f15b509aa81?source=collection_archive---------19-----------------------#2020-07-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/08f581a0140061a3caceab51d1d25db0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*tKDxKQhgjhCL2rWe"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">丹·缪尔在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="85ea" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">像任何类型的应用程序一样，当我们编写节点应用程序时，有一些困难的问题需要解决。</p><p id="96a1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将研究一些编写节点应用程序时常见问题的解决方案。</p><h1 id="68b0" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">通过 async/await 使用 Mongoose 承诺</h1><p id="26a9" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">猫鼬方法返回承诺。</p><p id="db93" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所以我们可以用它们搭配<code class="fe me mf mg mh b">async</code>和<code class="fe me mf mg mh b">await</code>。</p><p id="34fd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="acfa" class="mq lc iq mh b gy mr ms l mt mu">const orderEmployees = async(companyID) =&gt; {<br/>  try {<br/>    const employees = await User.find({ company: companyID }).exec();<br/>    console.log(employees);<br/>    return employees;<br/>  } catch (err) {<br/>    return 'error occured';<br/>  }<br/>}</span></pre><p id="a4b9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以通过查询<code class="fe me mf mg mh b">User.find</code>。</p><p id="01fd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它返回一个带有解析结果的承诺。</p><p id="ee01" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们也可以用<code class="fe me mf mg mh b">catch</code>捕捉错误。</p><h1 id="99f8" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">将变量传递给 nodemailer 中的 HTML 模板</h1><p id="6be4" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">Nodemailer 接受 HTML 作为内容。</p><p id="94a3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了使创建 HTML 电子邮件更容易，我们可以使用像 Handlebars 这样的模板引擎。</p><p id="869a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="eea1" class="mq lc iq mh b gy mr ms l mt mu">const nodemailer = require('nodemailer');<br/>const smtpTransport = require('nodemailer-smtp-transport');<br/>const handlebars = require('handlebars');<br/>const path= require('path');<br/>const fs = require('fs');</span><span id="06e7" class="mq lc iq mh b gy mv ms l mt mu">const readHTMLFile = (path, callback) =&gt; {<br/>  fs.readFile(path, {<br/>    encoding: 'utf-8'<br/>  }, (err, html) =&gt; {<br/>    if (err) {<br/>      throw err;<br/>      callback(err);<br/>    } else {<br/>      callback(null, html);<br/>    }<br/>  });<br/>};</span><span id="8370" class="mq lc iq mh b gy mv ms l mt mu">smtpTransport = nodemailer.createTransport(smtpTransport({<br/>  host: mailConfig.host,<br/>  secure: mailConfig.secure,<br/>  port: mailConfig.port,<br/>  auth: {<br/>    user: mailConfig.auth.user,<br/>    pass: mailConfig.auth.pass<br/>  }<br/>}));</span><span id="5575" class="mq lc iq mh b gy mv ms l mt mu">readHTMLFile(path.join(__dirname, '/template.html'), (err, html) =&gt; {<br/>  const template = handlebars.compile(html);<br/>  const replacements = {<br/>    username: "joe"<br/>  };<br/>  const htmlToSend = template(replacements);<br/>  const mailOptions = {<br/>    from: 'from@email.com',<br/>    to: 'to@email.com',<br/>    subject: 'test',<br/>    html: htmlToSend<br/>  };<br/>  smtpTransport.sendMail(mailOptions, (error, response) =&gt; {<br/>    if (error) {<br/>      console.log(error);<br/>      callback(error);<br/>    }<br/>  });<br/>});</span></pre><p id="5034" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们导入车把库，用模板调用<code class="fe me mf mg mh b">compiler</code>。</p><p id="e5f7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">模板从使用<code class="fe me mf mg mh b">fs</code>读取文件的<code class="fe me mf mg mh b">readHTMLFile</code>函数中读取。</p><p id="e8ae" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后传递给回调。</p><p id="1aff" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们得到带有<code class="fe me mf mg mh b">html</code>参数的模板。</p><p id="b0d5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦我们编译了模板，我们就用带有属性的对象调用<code class="fe me mf mg mh b">template</code>,将属性插入到模板中，得到最终的电子邮件。</p><p id="02f1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们调用<code class="fe me mf mg mh b">smptTransport.sendMail</code>发送邮件。</p><p id="20d1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们用 HTML 内容设置了<code class="fe me mf mg mh b">html</code>属性。</p><p id="b222" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">htmlToSend</code>是一个 HTML 字符串。</p><h1 id="6bd0" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">从 MongoDB 格式化 ISODate</h1><p id="0d65" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以用<code class="fe me mf mg mh b">toTimeString</code>方法格式化 MongoDB 中的 date 对象。</p><p id="7e19" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们只是写信给 ut:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="ae51" class="mq lc iq mh b gy mr ms l mt mu">const date = new Date("2019-07-14T01:00:00+01:00")<br/>consr str = date.toTimeString();</span></pre><p id="aac8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">MongoDB 也有<code class="fe me mf mg mh b">ISODate</code>函数来简化 ISO 日期字符串的处理。</p><p id="eb9a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="f07e" class="mq lc iq mh b gy mr ms l mt mu">ISODate("2019-07-14T01:00:00+01:00").toLocaleTimeString()</span></pre><p id="916f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">解析 ISO 日期字符串并将其转换为区分区域设置的时间字符串。</p><p id="aff0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们还可以得到小时和分钟:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="b88c" class="mq lc iq mh b gy mr ms l mt mu">ISODate("2019-07-14T01:00:00+01:00").getHours()<br/>ISODate("2019-07-14T01:00:00+01:00").getMinutes()</span></pre><h1 id="c9b8" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">测试期间 Stub Node.js 内置 fs</h1><p id="e247" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们想要模仿<code class="fe me mf mg mh b">fs</code>模块，这样测试就不会进行真正的文件操作。</p><p id="7e53" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为此，我们使用<code class="fe me mf mg mh b">rewire</code>来剔除所需的模块。</p><p id="73b5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，如果我们真正的代码是:</p><p id="6e3e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">reader.js</code></p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="25e3" class="mq lc iq mh b gy mr ms l mt mu">const fs = require('fs');<br/>const findFile = (path, callback) =&gt; {<br/>  fs.readdir(path, (err, files) =&gt; {<br/>     //...<br/>  })<br/>}</span></pre><p id="0c5c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以使用<code class="fe me mf mg mh b">rewire</code>来删除测试代码中的<code class="fe me mf mg mh b">readdir</code>,方法是:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="d710" class="mq lc iq mh b gy mr ms l mt mu">const rewire = require('rewire')<br/>const <!-- -->reader <!-- -->= rewire('./<!-- -->reader<!-- -->')<br/><br/>const fsStub = {<br/>  readdir(path, callback){<br/>    callback(null, [])<br/>  }<br/>}</span><span id="b0ea" class="mq lc iq mh b gy mv ms l mt mu">reader<!-- -->.__set__('fs', fsStub)<br/><br/>reader<!-- -->()</span></pre><p id="042c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们可以使用<code class="fe me mf mg mh b">reader</code>而不用真正调用<code class="fe me mf mg mh b">readdir</code>，因为我们调用了<code class="fe me mf mg mh b">__set__</code>来设置<code class="fe me mf mg mh b">fs</code>模块到我们的存根，而不是读取<code class="fe me mf mg mh b">fs</code>模块。</p><h1 id="1213" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">用猫鼬返回更新的集合</h1><p id="094b" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以在 Mongoose 中返回一个更新的集合，然后我们可以通过将<code class="fe me mf mg mh b">new</code>选项设置为<code class="fe me mf mg mh b">true</code>从<code class="fe me mf mg mh b">findOneAndUpdate</code>中获取它。</p><p id="110a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="0b69" class="mq lc iq mh b gy mr ms l mt mu">Model<br/>  .findOneAndUpdate({<br/>    user_id: data.userId<br/>  }, {<br/>    $set: {<br/>      session_id: id<br/>    }<br/>  }, {<br/>    "new": true<br/>  })<br/>  .exec()<br/>  .then(data =&gt; {<br/>    return {<br/>      sid: data.session_id<br/>    }<br/>  })</span></pre><p id="0bff" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们调用<code class="fe me mf mg mh b">findOneAndUpdate</code>，然后使用<code class="fe me mf mg mh b">$set</code>来更新一个字段，</p><p id="7d80" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们传入一个属性设置为<code class="fe me mf mg mh b">true</code>的对象，在<code class="fe me mf mg mh b">then</code>回调中返回最新的数据。</p><p id="1057" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="60b8" class="mq lc iq mh b gy mr ms l mt mu">Lists.findByIdAndUpdate(listId, {<br/>  $push: {<br/>    items: taskId<br/>  }<br/>}, (err, list) =&gt; {<br/>  ...<br/>});</span></pre><p id="3fea" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们用<code class="fe me mf mg mh b">list</code>得到最新的名单。</p><p id="2b63" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">$push</code>在文档的<code class="fe me mf mg mh b">items</code>列表中追加一个项目。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mw"><img src="../Images/a1e4956e99b250f338f9816c469321ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*M5iRDgPcNaLAIlu4"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">照片由<a class="ae kc" href="https://unsplash.com/@rubyschmank?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Ruby Schmank </a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><h1 id="dba1" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="ae08" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以在更新后得到最新的列表。</p><p id="c0a7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以用<code class="fe me mf mg mh b">rewire</code>来存根依赖关系。</p><p id="8fee" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以在 Nodemailer 中使用 HTML 模板。</p><p id="9985" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">猫鼬方法返回承诺。</p></div></div>    
</body>
</html>