<html>
<head>
<title>Linting SQLs with dbt and SQLfluff</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带有 dbt 和 SQLfluff 的林挺 SQL</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/linting-sqls-with-dbt-and-sqlfluff-ceb45836a2ca?source=collection_archive---------3-----------------------#2022-10-17">https://blog.devgenius.io/linting-sqls-with-dbt-and-sqlfluff-ceb45836a2ca?source=collection_archive---------3-----------------------#2022-10-17</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/8f1142252d1f056ec0609f2941be10ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4ZyDPxh70m364m8DdGJnSQ.jpeg"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">劳伦·曼克在<a class="ae jz" href="https://unsplash.com/photos/aOC7TSLb1o8" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="0125" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">当在一个由数据分析师和工程师组成的大团队中工作时，您是否曾经为不同的 SQL 风格而苦恼过？上/下关键字、前导/尾随逗号、缩进、别名规则等。</p><p id="4725" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">随着模型数量的增长，拥有一致的风格变得有益，以便于代码审查、新成员的加入等。<br/>这里来了 SQLfluff 拯救，这是一个 SQL 文件的 CLI linter。它可以突出显示并经常修复违反样式的情况。</p><p id="abcf" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">dbt 是另一个令人惊奇的工具，可以简化数据建模，跟踪模型之间的依赖关系，减少样板代码的数量。</p><p id="f313" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在这篇文章中，我想分享将这两种工具结合起来并在团队中采用的方法。</p><p id="2338" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">团队结盟。</strong></p><p id="00b4" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">首先，你需要和团队交流，解释为什么有特定的风格规则很重要。<br/>这一步极其重要，因为没有人会乐意看到一份公关在没有清楚了解为什么需要它的情况下被搁置。</p><p id="8680" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这次谈话的一个好结果将是你同意遵守的一套初始规则。此外，如果项目很大并且/或者由多个 dbt 项目组成，您可能希望只在项目的某个区域进行推广。</p><p id="9e11" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">集成到开发工作流程中。</strong></p><p id="f928" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">下一步是将 SQLfluff 集成到开发工作流中。<br/>最简单的方法是使用预提交钩子。<br/>如果你已经在使用它们，只需添加几个新的挂钩<code class="fe ky kz la lb b">sqlfliff fix</code>、<code class="fe ky kz la lb b">sqlfluff lint</code>就简单多了。</p><p id="f560" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">否则，您可能需要额外的时间来采用预提交挂钩。值得一提的是，这一步可能是可选的，尽管强烈建议这样做，以便使开发工作流程更加顺畅。</p><p id="0208" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">整合到 CI/CD 中。</strong> <br/>下一步是通过将 SQLfluff 集成到 CI/CD 中来执行规则。这可能是软的也可能是硬的。<br/>在第一种情况下，它应该只发出警告，但不阻止 PRs 被合并。<br/>在第二种情况下，请购单应在合并前通过 SQLfluff 检查。</p><p id="6b89" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io"> <em class="lc">性能注意事项。如果您有许多 SQL 文件，并且正在努力进行长时间的检查，那么可以考虑使用参数<code class="fe ky kz la lb b">— parallel</code>。<br/>此外，我强烈建议利用<strong class="kc io"> <em class="lc"> dbt slim CI </em> </strong>，以便在运行 CI/CD 检查时只检查已更改的文件，而不是所有文件(这需要存储部署到生产环境的 dbt 模型的最后状态)。</em></strong></p><p id="df7f" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">该练习了！</strong></p><p id="411f" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在，让我们动手创建一个演示项目，看看 SQLfluff 如何提供帮助。</p><p id="f9de" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">为此，我将在 GCP BigQuery 上使用一个开放数据集。<br/>源代码可在<a class="ae jz" href="https://github.com/eskarimov/demo-dbt-sqlfluff" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上获得。</p><p id="6a9a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">让我们先安装必要的软件包:</p><pre class="ld le lf lg gt lh lb li lj aw lk bi"><span id="f31a" class="ll lm in lb b gy ln lo l lp lq">pip3 install dbt-bigquery==1.3.0 sqlfluff==1.3.2 sqlfluff-templater-dbt==1.3.2 pre-commit==2.20.0</span></pre><p id="6a49" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">并用<code class="fe ky kz la lb b">dbt init</code>创建一个新项目。</p><p id="c3e8" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">它将创建几个标准的 dbt 模型。<br/>我们还将使用公共堆栈溢出数据集创建另一个模型。<br/>让我们先在<code class="fe ky kz la lb b">schema.yml</code>中添加一个信号源:</p><pre class="ld le lf lg gt lh lb li lj aw lk bi"><span id="a6de" class="ll lm in lb b gy ln lo l lp lq">sources:<br/>  — name: stackoverflow<br/>    database: bigquery-public-data<br/>    schema: stackoverflow<br/>    tables:<br/>      — name: posts_questions</span></pre><p id="bc8e" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">让我们统计一下历年来回答问题的百分比:</p><pre class="ld le lf lg gt lh lb li lj aw lk bi"><span id="db94" class="ll lm in lb b gy ln lo l lp lq">SELECT<br/> EXTRACT(YEAR FROM creation_date) AS Year,<br/> COUNT(*) AS Number_of_Questions,<br/> ROUND(100 * SUM(IF(answer_count &gt; 0, 1, 0)) / COUNT(*), 1) AS Percent_Questions_with_Answers<br/>FROM<br/> {{ source(‘stackoverflow’, ‘posts_questions’) }}<br/>GROUP BY<br/> Year<br/>ORDER BY<br/> Year</span></pre><p id="af7b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在我们需要告诉 SQLfluff 使用哪种方言，并为我们的规则调优所需的参数。<br/>在本教程中，我们将强制使用前导逗号、关键字和函数名的大写字母。<br/>我们将创建一个文件<code class="fe ky kz la lb b">.sqlfluff</code>，内容如下:</p><pre class="ld le lf lg gt lh lb li lj aw lk bi"><span id="a350" class="ll lm in lb b gy ln lo l lp lq">[sqlfluff]<br/>templater = dbt<br/>dialect = bigquery</span><span id="e7c7" class="ll lm in lb b gy lr lo l lp lq">[sqlfluff:templater:dbt]<br/>project_dir = ./</span><span id="f8dd" class="ll lm in lb b gy lr lo l lp lq">[sqlfluff:rules]<br/>comma_style = leading</span><span id="a496" class="ll lm in lb b gy lr lo l lp lq">[sqlfluff:rules:L010]<br/>capitalisation_policy = upper</span><span id="1687" class="ll lm in lb b gy lr lo l lp lq">[sqlfluff:rules:L030]<br/>capitalisation_policy = upper</span></pre><p id="41af" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们还需要忽略编译期间 dbt 生成的某些文件。我们将向<code class="fe ky kz la lb b">.sqlfluffignore</code>添加以下文件夹:</p><pre class="ld le lf lg gt lh lb li lj aw lk bi"><span id="afd0" class="ll lm in lb b gy ln lo l lp lq">target/<br/>dbt_packages/<br/>macros/</span></pre><p id="1d4a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">让我们运行<code class="fe ky kz la lb b">sqlfluff lint</code>并检查输出:</p><pre class="ld le lf lg gt lh lb li lj aw lk bi"><span id="c709" class="ll lm in lb b gy ln lo l lp lq">=== [dbt templater] Sorting Nodes…<br/>=== [dbt templater] Compiling dbt project…<br/>=== [dbt templater] Project Compiled.<br/>== [/example-dbt-sqlfluff/models/stackoverflow/percent_questions_answered_per_year.sql] FAIL<br/>L: 1 | P: 1 | L010 | Keywords must be lower case.<br/>L: 2 | P: 3 | L003 | Expected 1 indentation, found less than 1 [compared to<br/> | line 01]<br/>L: 2 | P: 11 | L010 | Keywords must be lower case.<br/>L: 2 | P: 16 | L010 | Keywords must be lower case.<br/>L: 2 | P: 36 | L010 | Keywords must be lower case.<br/>L: 2 | P: 39 | L014 | Unquoted identifiers must be consistently lower case.<br/>L: 2 | P: 43 | L019 | Found trailing comma. Expected only leading.<br/>L: 3 | P: 3 | L003 | Expected 1 indentation, found less than 1 [compared to<br/> | line 01]<br/>L: 3 | P: 12 | L010 | Keywords must be lower case.<br/>L: 3 | P: 15 | L014 | Unquoted identifiers must be consistently lower case.<br/>L: 3 | P: 34 | L019 | Found trailing comma. Expected only leading.<br/>L: 4 | P: 3 | L003 | Expected 1 indentation, found less than 1 [compared to<br/> | line 01]<br/>L: 4 | P: 62 | L010 | Keywords must be lower case.<br/>L: 4 | P: 65 | L014 | Unquoted identifiers must be consistently lower case.<br/>L: 4 | P: 95 | L016 | Line is too long.<br/>L: 5 | P: 1 | L010 | Keywords must be lower case.<br/>L: 6 | P: 3 | L003 | Expected 1 indentation, found less than 1 [compared to<br/> | line 05]<br/>L: 7 | P: 1 | L010 | Keywords must be lower case.<br/>L: 7 | P: 7 | L010 | Keywords must be lower case.<br/>L: 8 | P: 3 | L003 | Expected 1 indentation, found less than 1 [compared to<br/> | line 07]<br/>L: 8 | P: 3 | L014 | Unquoted identifiers must be consistently lower case.<br/>L: 9 | P: 1 | L010 | Keywords must be lower case.<br/>L: 9 | P: 7 | L010 | Keywords must be lower case.<br/>L: 10 | P: 3 | L003 | Expected 1 indentation, found less than 1 [compared to<br/> | line 09]<br/>L: 10 | P: 3 | L014 | Unquoted identifiers must be consistently lower case.<br/>L: 10 | P: 7 | L009 | Files must end with a single trailing newline.</span></pre><p id="5b8c" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">相当多的违规，不是吗？我们一会儿就把它们修好。<br/>您可以使用默认规则，找到最适合您的规则和/或使用<code class="fe ky kz la lb b">.sqlfluff</code>中的<code class="fe ky kz la lb b">exclude_rules</code>键禁用不必要的规则。</p><p id="32e0" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在让我们变些魔术，尝试用<code class="fe ky kz la lb b">sqlfluff fix.<br/></code>来修复文件。这里我将初始文件(左栏)与新文件(右栏)进行比较:</p><figure class="ld le lf lg gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ls"><img src="../Images/630b6911729deea5e8ffcdac8d6cfdcd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JP6eZ6Djo-_QwfNfR5K-6Q.jpeg"/></div></div></figure><p id="b4c5" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">最后一步，让我们看看如何将它集成到预提交钩子中，并自动检查文件:<br/>用以下内容创建文件<code class="fe ky kz la lb b">.pre-commit-config.yaml</code>:</p><pre class="ld le lf lg gt lh lb li lj aw lk bi"><span id="ceb6" class="ll lm in lb b gy ln lo l lp lq">repos:<br/>  - repo: <a class="ae jz" href="https://github.com/sqlfluff/sqlfluff" rel="noopener ugc nofollow" target="_blank">https://github.com/sqlfluff/sqlfluff</a><br/>    rev: 1.3.2<br/>    hooks:<br/>      — id: sqlfluff-fix<br/>        additional_dependencies : [‘dbt-bigquery==1.3.0’, ‘sqlfluff-templater-dbt==1.3.2’]<br/>      — id: sqlfluff-lint<br/>        additional_dependencies : [‘dbt-bigquery==1.3.0’, ‘sqlfluff-templater-dbt==1.3.2’]</span></pre><p id="55ef" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">运行<code class="fe ky kz la lb b">pre-commit install</code>和<code class="fe ky kz la lb b">pre-commit run --all-files</code>以确保其正常工作。</p><p id="3e10" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在，每当你改变你的 SQL 并想要提交它们时，SQLfluff 将首先尝试自动修复任何发现的冲突并突出显示无法修复的冲突。<br/>进一步的步骤可能包括将这些检查与 CI/CD 工具集成，例如 GitHub 状态检查。</p><p id="1281" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">今天就到这里，编码快乐！</p><p id="836d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">参考文献</strong> <br/> 1。<a class="ae jz" href="https://console.cloud.google.com/marketplace/product/stack-exchange/stack-overflow" rel="noopener ugc nofollow" target="_blank">https://console . cloud . Google . com/market place/product/stack-exchange/stack-overflow</a>T5】2 .<a class="ae jz" href="https://docs.sqlfluff.com/en/stable/rules.html" rel="noopener ugc nofollow" target="_blank">https://docs.sqlfluff.com/en/stable/rules.html</a><br/>3。<a class="ae jz" href="https://github.com/sqlfluff/sqlfluff" rel="noopener ugc nofollow" target="_blank">https://github.com/sqlfluff/sqlfluff</a></p></div></div>    
</body>
</html>