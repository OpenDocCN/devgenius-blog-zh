<html>
<head>
<title>Apache Kafka on Kubernetes using Strimzi</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Strimzi的Kubernetes上的Apache Kafka</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/apache-kafka-on-kubernetes-using-strimzi-27d47b6b13bc?source=collection_archive---------3-----------------------#2022-01-06">https://blog.devgenius.io/apache-kafka-on-kubernetes-using-strimzi-27d47b6b13bc?source=collection_archive---------3-----------------------#2022-01-06</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/fd57d5fc0783d73cdf4364becdcb6f05.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YccTB937MJDhq5F5PQDCnA.png"/></div></div></figure><p id="299a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><a class="ae kt" href="https://kafka.apache.org" rel="noopener ugc nofollow" target="_blank"> Apache Kafka </a>是一个开源分布式事件流平台，被数千家公司用于高性能数据管道、流分析、数据集成和关键任务应用。这是一个非常可扩展和高性能的系统。然而，集群的管理被认为在操作上是复杂的。</p><p id="5767" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在撰写本文时，Strimzi 是一个CNCF沙盒项目。Strimzi使用Kubernetes中的Operator模式，并帮助在各种部署配置中运行Apache Kafka集群。这有助于将整个Kafka集群作为IaC(基础设施即代码)。</p><p id="a5ec" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">使用Strimzi，您可以简化:</p><ul class=""><li id="0adc" class="ku kv in jx b jy jz kc kd kg kw kk kx ko ky ks kz la lb lc bi translated">部署和运行Kafka集群</li><li id="a7a8" class="ku kv in jx b jy ld kc le kg lf kk lg ko lh ks kz la lb lc bi translated">部署和运行Kafka组件</li><li id="d22e" class="ku kv in jx b jy ld kc le kg lf kk lg ko lh ks kz la lb lc bi translated">配置对Kafka的访问</li><li id="5a9b" class="ku kv in jx b jy ld kc le kg lf kk lg ko lh ks kz la lb lc bi translated">保护对卡夫卡的访问</li><li id="315d" class="ku kv in jx b jy ld kc le kg lf kk lg ko lh ks kz la lb lc bi translated">升级卡夫卡</li><li id="b842" class="ku kv in jx b jy ld kc le kg lf kk lg ko lh ks kz la lb lc bi translated">管理经纪人</li><li id="8774" class="ku kv in jx b jy ld kc le kg lf kk lg ko lh ks kz la lb lc bi translated">创建和管理主题</li><li id="fdd9" class="ku kv in jx b jy ld kc le kg lf kk lg ko lh ks kz la lb lc bi translated">创建和管理用户</li></ul><p id="3220" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">Strimzi是在Apache License 2下开发的，作为一个支持该项目的CNCF，它提供了一个保证，不会被局限于特定于供应商的生态系统。</p><p id="7c17" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在本文中，我们将记录在Kubernetes集群中部署两个kafka集群的步骤。我们将不使用舵图，而是使用将由<code class="fe li lj lk ll b">kubectl</code>执行的YAML文件。</p><blockquote class="lm ln lo"><p id="9508" class="jv jw lp jx b jy jz ka kb kc kd ke kf lq kh ki kj lr kl km kn ls kp kq kr ks ig bi translated">如果您没有访问Kubernetes集群的权限，并且想知道如何在本地机器上安装它，那么请阅读文章—<a class="ae kt" href="https://pratimsc.medium.com/kubernetes-on-local-machine-e061a30a2bbe" rel="noopener">Kubernetes on Local Machine</a>。</p></blockquote><p id="7af7" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">对于本文，我假设您使用的是Linux或Mac机器。</p><blockquote class="lm ln lo"><p id="91a3" class="jv jw lp jx b jy jz ka kb kc kd ke kf lq kh ki kj lr kl km kn ls kp kq kr ks ig bi translated"><strong class="jx io"> <em class="in">相关文章列表</em> </strong>:</p><p id="f2a0" class="jv jw lp jx b jy jz ka kb kc kd ke kf lq kh ki kj lr kl km kn ls kp kq kr ks ig bi translated"><a class="ae kt" rel="noopener ugc nofollow" target="_blank" href="/apache-kafka-on-kubernetes-using-strimzi-27d47b6b13bc">第1部分——使用Strimzi的Kubernetes上的Apache Kafka</a></p><p id="4f44" class="jv jw lp jx b jy jz ka kb kc kd ke kf lq kh ki kj lr kl km kn ls kp kq kr ks ig bi translated"><a class="ae kt" rel="noopener ugc nofollow" target="_blank" href="/simple-authn-and-authz-on-kafka-for-users-a557066a097c">第2部分—针对外部用户的Kafka上的简单authN和authZ</a></p></blockquote></div><div class="ab cl lt lu hr lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ig ih ii ij ik"><h1 id="bc71" class="ma mb in bd mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx bi translated">Strimzi项目人工制品</h1><p id="8b95" class="pw-post-body-paragraph jv jw in jx b jy my ka kb kc mz ke kf kg na ki kj kk nb km kn ko nc kq kr ks ig bi translated">Strimzi的Git存储库位于—<a class="ae kt" href="https://github.com/strimzi/strimzi-kafka-operator/" rel="noopener ugc nofollow" target="_blank">https://github.com/strimzi/strimzi-kafka-operator/</a></p><p id="a20f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">你可以复制一份代码，然后按照指令编译它。但是您不熟悉Java，那么使用团队的发布包会更容易。</p><p id="dd15" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">所有被释放的文物都位于—<a class="ae kt" href="https://github.com/strimzi/strimzi-kafka-operator/releases" rel="noopener ugc nofollow" target="_blank">https://github.com/strimzi/strimzi-kafka-operator/releases</a>。</p></div><div class="ab cl lt lu hr lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ig ih ii ij ik"><h1 id="5949" class="ma mb in bd mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx bi translated">Strimzi自定义资源定义</h1><p id="4268" class="pw-post-body-paragraph jv jw in jx b jy my ka kb kc mz ke kf kg na ki kj kk nb km kn ko nc kq kr ks ig bi translated">在Kubernetes API中，资源是存储某种API对象集合的端点。例如，内置的Pod资源包含一组Pod对象。</p><p id="f175" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">一个<em class="lp">定制资源</em>是一个扩展Kubernetes API的对象，或者允许一个人将他们自己的API引入到一个项目或集群中。</p><p id="5ec2" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">一个<em class="lp">定制资源定义</em> (CRD)定义了定制对象种类，并让Kubernetes API服务器处理资源的整个生命周期。</p><p id="dca1" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">执行以下命令下载<code class="fe li lj lk ll b">0.32.0</code>版本的<a class="ae kt" href="https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/" rel="noopener ugc nofollow" target="_blank"> CRD(自定义资源定义)</a>:</p><pre class="nd ne nf ng gt nh ll ni nj aw nk bi"><span id="9a4a" class="nl mb in ll b gy nm nn l no np">curl -L https://github.com/strimzi/strimzi-kafka-operator/releases/download/0.32.0/strimzi-crds-0.32.0.yaml -o strimzi-crds-0.032.0.yaml</span></pre><p id="9abf" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">CRD具有群集范围，因此安装它们需要群集管理权限。执行以下命令来执行下载的CRD文件:</p><pre class="nd ne nf ng gt nh ll ni nj aw nk bi"><span id="5187" class="nl mb in ll b gy nm nn l no np">kubectl apply -f strimzi-crds-0.32.0.yaml</span></pre><p id="f300" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这将向Kubernetes服务器注册CRD定义。执行以下命令以验证所有定义都已注册:</p><pre class="nd ne nf ng gt nh ll ni nj aw nk bi"><span id="238d" class="nl mb in ll b gy nm nn l no np">kubectl get customresourcedefinition.apiextensions.k8s.io -o name | grep -i strimzi</span></pre><p id="5738" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">您应该看到类似下面的内容，确认创建了十个CRD:</p><pre class="nd ne nf ng gt nh ll ni nj aw nk bi"><span id="95d6" class="nl mb in ll b gy nm nn l no np">customresourcedefinition.apiextensions.k8s.io/kafkas.kafka.strimzi.io<br/>customresourcedefinition.apiextensions.k8s.io/kafkaconnects.kafka.strimzi.io<br/>customresourcedefinition.apiextensions.k8s.io/strimzipodsets.core.strimzi.io<br/>customresourcedefinition.apiextensions.k8s.io/kafkatopics.kafka.strimzi.io<br/>customresourcedefinition.apiextensions.k8s.io/kafkausers.kafka.strimzi.io<br/>customresourcedefinition.apiextensions.k8s.io/kafkamirrormakers.kafka.strimzi.io<br/>customresourcedefinition.apiextensions.k8s.io/kafkabridges.kafka.strimzi.io<br/>customresourcedefinition.apiextensions.k8s.io/kafkaconnectors.kafka.strimzi.io<br/>customresourcedefinition.apiextensions.k8s.io/kafkamirrormaker2s.kafka.strimzi.io<br/>customresourcedefinition.apiextensions.k8s.io/kafkarebalances.kafka.strimzi.io</span></pre></div><div class="ab cl lt lu hr lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ig ih ii ij ik"><h1 id="cd85" class="ma mb in bd mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx bi translated">Strimzi Kafka聚类算子</h1><p id="d4ce" class="pw-post-body-paragraph jv jw in jx b jy my ka kb kc mz ke kf kg na ki kj kk nb km kn ko nc kq kr ks ig bi translated">在Kubernetes中，操作者是利用<em class="lp">定制资源</em>来管理应用程序及其组件的软件扩展。</p><p id="c7b5" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><a class="ae kt" href="https://kubernetes.io/docs/concepts/extend-kubernetes/operator/" rel="noopener ugc nofollow" target="_blank">操作员模式</a>旨在捕捉管理一个或一组服务的操作员的关键目标。负责特定应用程序和服务的操作员对系统应该如何运行、如何部署以及出现问题时如何反应有着深刻的了解。</p><h2 id="3fa5" class="nl mb in bd mc nq nr dn mg ns nt dp mk kg nu nv mo kk nw nx ms ko ny nz mw oa bi translated">创建集群角色</h2><p id="20ff" class="pw-post-body-paragraph jv jw in jx b jy my ka kb kc mz ke kf kg na ki kj kk nb km kn ko nc kq kr ks ig bi translated">只需创建少量集群角色，Strimzi操作员就可以管理集群中的各种Kafka资源。让我们执行下面的命令来下载<em class="lp">集群角色</em>的资源定义。</p><pre class="nd ne nf ng gt nh ll ni nj aw nk bi"><span id="f11b" class="nl mb in ll b gy nm nn l no np"># Cluster role - strimzi-cluster-operator-namespaced<br/>curl -L https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/release-0.32.x/cluster-operator/src/main/resources/cluster-roles/020-ClusterRole-strimzi-cluster-operator-role.yaml -o 020-ClusterRole-strimzi-cluster-operator-role.yaml</span><span id="88c1" class="nl mb in ll b gy ob nn l no np"># Cluster role - strimzi-cluster-operator-global<br/>curl -L https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/release-0.32.x/cluster-operator/src/main/resources/cluster-roles/021-ClusterRole-strimzi-cluster-operator-role.yaml -o 021-ClusterRole-strimzi-cluster-operator-role.yaml</span><span id="2140" class="nl mb in ll b gy ob nn l no np"># Cluster role - strimzi-cluster-operator-leader-election<br/>curl -L <a class="ae kt" href="https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/release-0.32.x/cluster-operator/src/main/resources/cluster-roles/021-ClusterRole-strimzi-cluster-operator-role.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/release-0.32.x/cluster-operator/src/main/resources/cluster-roles/</a>022-ClusterRole-strimzi-cluster-operator-role.yaml -o 022-ClusterRole-strimzi-cluster-operator-role.yaml</span><span id="8cee" class="nl mb in ll b gy ob nn l no np"># Cluster role - strimzi-cluster-operator-watched<br/>curl -L <a class="ae kt" href="https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/release-0.32.x/cluster-operator/src/main/resources/cluster-roles/021-ClusterRole-strimzi-cluster-operator-role.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/release-0.32.x/cluster-operator/src/main/resources/cluster-roles/</a>023-ClusterRole-strimzi-cluster-operator-role.yaml -o 023-ClusterRole-strimzi-cluster-operator-role.yaml</span><span id="1610" class="nl mb in ll b gy ob nn l no np"># Cluster role - strimzi-kafka-broker<br/>curl -L https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/release-0.32.x/cluster-operator/src/main/resources/cluster-roles/030-ClusterRole-strimzi-kafka-broker.yaml -o 030-ClusterRole-strimzi-kafka-broker.yaml</span><span id="a990" class="nl mb in ll b gy ob nn l no np"># Cluster role - strimzi-entity-operator<br/>curl -L https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/release-0.32.x/cluster-operator/src/main/resources/cluster-roles/031-ClusterRole-strimzi-entity-operator.yaml -o 031-ClusterRole-strimzi-entity-operator.yaml</span><span id="0ddd" class="nl mb in ll b gy ob nn l no np"># Cluster role - strimzi-kafka-client<br/>curl -L https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/release-0.32.x/cluster-operator/src/main/resources/cluster-roles/033-ClusterRole-strimzi-kafka-client.yaml -o 033-ClusterRole-strimzi-kafka-client.yaml</span></pre><p id="4409" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在，以集群管理员访问权限执行以下命令，在Kubernetes集群中创建<em class="lp"> ClusterRole </em>:</p><pre class="nd ne nf ng gt nh ll ni nj aw nk bi"><span id="0ec9" class="nl mb in ll b gy nm nn l no np">kubectl create -f 020-ClusterRole-strimzi-cluster-operator-role.yaml  -f 021-ClusterRole-strimzi-cluster-operator-role.yaml -f 022-ClusterRole-strimzi-cluster-operator-role.yaml -f 023-ClusterRole-strimzi-cluster-operator-role.yaml -f 030-ClusterRole-strimzi-kafka-broker.yaml  -f 031-ClusterRole-strimzi-entity-operator.yaml -f 033-ClusterRole-strimzi-kafka-client.yaml</span></pre><p id="c10e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">执行以下命令，验证所需的群集角色是否存在:</p><pre class="nd ne nf ng gt nh ll ni nj aw nk bi"><span id="461f" class="nl mb in ll b gy nm nn l no np">kubectl get clusterroles.rbac.authorization.k8s.io  -o name | grep -i strimzi</span></pre><p id="20e8" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">它应该显示创建了五个集群角色:</p><pre class="nd ne nf ng gt nh ll ni nj aw nk bi"><span id="bcae" class="nl mb in ll b gy nm nn l no np">clusterrole.rbac.authorization.k8s.io/strimzi-cluster-operator-namespaced<br/>clusterrole.rbac.authorization.k8s.io/strimzi-cluster-operator-global<br/>clusterrole.rbac.authorization.k8s.io/strimzi-kafka-broker<br/>clusterrole.rbac.authorization.k8s.io/strimzi-entity-operator<br/>clusterrole.rbac.authorization.k8s.io/strimzi-kafka-client<br/>clusterrole.rbac.authorization.k8s.io/strimzi-cluster-operator-watched<br/>clusterrole.rbac.authorization.k8s.io/strimzi-cluster-operator-leader-election</span></pre><h2 id="d51d" class="nl mb in bd mc nq nr dn mg ns nt dp mk kg nu nv mo kk nw nx ms ko ny nz mw oa bi translated">操作员名称空间</h2><p id="6a2b" class="pw-post-body-paragraph jv jw in jx b jy my ka kb kc mz ke kf kg na ki kj kk nb km kn ko nc kq kr ks ig bi translated">我们希望集群操作符驻留在与实际Kafka集群不同的位置。以便有明确的角色分离，例如平台开发者可以管理操作者，而应用开发者在他们自己的名称空间中管理Kafka资源。让我们执行下面的命令来创建一个命名空间来托管所有的操作员资源:</p><pre class="nd ne nf ng gt nh ll ni nj aw nk bi"><span id="dc1d" class="nl mb in ll b gy nm nn l no np">kubectl create namespace strimzi</span></pre><h2 id="c4ed" class="nl mb in bd mc nq nr dn mg ns nt dp mk kg nu nv mo kk nw nx ms ko ny nz mw oa bi translated">运营商服务帐户</h2><p id="b54c" class="pw-post-body-paragraph jv jw in jx b jy my ka kb kc mz ke kf kg na ki kj kk nb km kn ko nc kq kr ks ig bi translated">操作员的所有操作都将使用遵循最低特权原则的服务帐户来完成。执行以下命令创建服务帐户“strimzi-cluster-operator ”:</p><pre class="nd ne nf ng gt nh ll ni nj aw nk bi"><span id="bc05" class="nl mb in ll b gy nm nn l no np">cat &lt;&lt;EOF | kubectl create -n strimzi -f - <br/>apiVersion: v1<br/>kind: ServiceAccount<br/>metadata:<br/>  name: strimzi-cluster-operator<br/>  labels:<br/>    app: strimzi<br/>EOF</span></pre><h2 id="227a" class="nl mb in bd mc nq nr dn mg ns nt dp mk kg nu nv mo kk nw nx ms ko ny nz mw oa bi translated">群集角色绑定</h2><p id="e1dd" class="pw-post-body-paragraph jv jw in jx b jy my ka kb kc mz ke kf kg na ki kj kk nb km kn ko nc kq kr ks ig bi translated">让我们将服务帐户<code class="fe li lj lk ll b">strimzi-cluster-operator</code>绑定到所需的集群角色，执行范围限于名称空间<code class="fe li lj lk ll b">strimzi</code>，在这里将创建与操作者相关的所有资源。</p><blockquote class="lm ln lo"><p id="3a6c" class="jv jw lp jx b jy jz ka kb kc kd ke kf lq kh ki kj lr kl km kn ls kp kq kr ks ig bi translated">如果您使用不同于<code class="fe li lj lk ll b">strimzi</code>的名称空间，用您的名称空间的名称替换<code class="fe li lj lk ll b">-n strimzi</code>和<code class="fe li lj lk ll b">namespace: strimzi</code>中的值。</p></blockquote><p id="14f2" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">绑定到集群角色<code class="fe li lj lk ll b">strimzi-cluster-operator-global</code>:</p><pre class="nd ne nf ng gt nh ll ni nj aw nk bi"><span id="1de1" class="nl mb in ll b gy nm nn l no np">cat &lt;&lt;EOF | kubectl create -n strimzi -f - <br/>apiVersion: rbac.authorization.k8s.io/v1<br/>kind: ClusterRoleBinding<br/>metadata:<br/>  name: strimzi-cluster-operator<br/>  labels:<br/>    app: strimzi<br/>subjects:<br/>  - kind: ServiceAccount<br/>    name: strimzi-cluster-operator<br/>    namespace: strimzi<br/>roleRef:<br/>  kind: ClusterRole<br/>  name: strimzi-cluster-operator-global<br/>  apiGroup: rbac.authorization.k8s.io<br/>EOF</span></pre><p id="1d74" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">绑定到集群角色<code class="fe li lj lk ll b">strimzi-kafka-broker</code>:</p><pre class="nd ne nf ng gt nh ll ni nj aw nk bi"><span id="2fc1" class="nl mb in ll b gy nm nn l no np">cat &lt;&lt;EOF | kubectl create -n strimzi -f -<br/>apiVersion: rbac.authorization.k8s.io/v1<br/>kind: ClusterRoleBinding<br/>metadata:<br/>  name: strimzi-cluster-operator-kafka-broker-delegation<br/>  labels:<br/>    app: strimzi<br/><em class="lp"># The Kafka broker cluster role must be bound to the cluster operator service account so that it can delegate the cluster role to the Kafka brokers.<br/># This must be done to avoid escalating privileges which would be blocked by Kubernetes.<br/></em>subjects:<br/>  - kind: ServiceAccount<br/>    name: strimzi-cluster-operator<br/>    namespace: strimzi<br/>roleRef:<br/>  kind: ClusterRole<br/>  name: strimzi-kafka-broker<br/>  apiGroup: rbac.authorization.k8s.io<br/>EOF</span></pre><p id="a611" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">绑定到集群角色<code class="fe li lj lk ll b">strimzi-kafka-client</code>:</p><pre class="nd ne nf ng gt nh ll ni nj aw nk bi"><span id="059e" class="nl mb in ll b gy nm nn l no np">cat &lt;&lt;EOF | kubectl create -n strimzi -f -<br/>apiVersion: rbac.authorization.k8s.io/v1<br/>kind: ClusterRoleBinding<br/>metadata:<br/>  name: strimzi-cluster-operator-kafka-client-delegation<br/>  labels:<br/>    app: strimzi<br/><em class="lp"># The Kafka clients cluster role must be bound to the cluster operator service account so that it can delegate the<br/># cluster role to the Kafka clients using it for consuming from closest replica.<br/># This must be done to avoid escalating privileges which would be blocked by Kubernetes.<br/></em>subjects:<br/>  - kind: ServiceAccount<br/>    name: strimzi-cluster-operator<br/>    namespace: strimzi<br/>roleRef:<br/>  kind: ClusterRole<br/>  name: strimzi-kafka-client<br/>  apiGroup: rbac.authorization.k8s.io<br/>EOF</span></pre><h2 id="50a1" class="nl mb in bd mc nq nr dn mg ns nt dp mk kg nu nv mo kk nw nx ms ko ny nz mw oa bi translated">操作员配置</h2><p id="432e" class="pw-post-body-paragraph jv jw in jx b jy my ka kb kc mz ke kf kg na ki kj kk nb km kn ko nc kq kr ks ig bi translated">所有操作员将使用可观察性、日志等配置。因此，让我们创建一个<em class="lp"> ConfigMap </em>定义，其中包含操作者将使用的属性文件。根据您的需要进行调整:</p><pre class="nd ne nf ng gt nh ll ni nj aw nk bi"><span id="93f9" class="nl mb in ll b gy nm nn l no np">cat &lt;&lt;EOF | kubectl create -n strimzi -f - <br/>kind: ConfigMap<br/>apiVersion: v1<br/>metadata:<br/>  name: strimzi-cluster-operator<br/>  labels:<br/>    app: strimzi<br/>data:<br/>  log4j2.properties: |<br/>    name=COConfig<br/>    monitorInterval=30<br/><br/>    appender.console.type=Console<br/>    appender.console.name=STDOUT<br/>    appender.console.layout.type=PatternLayout<br/>    appender.console.layout.pattern=%d{yyyy-MM-dd HH:mm:ss} %-5p %c{1}:%L - %m%n<br/><br/>    rootLogger.level=${env:STRIMZI_LOG_LEVEL:-INFO}<br/>    rootLogger.appenderRefs=stdout<br/>    rootLogger.appenderRef.console.ref=STDOUT<br/>    rootLogger.additivity=false<br/><br/>    # Kafka AdminClient logging is a bit noisy at INFO level<br/>    logger.kafka.name=org.apache.kafka<br/>    logger.kafka.level=WARN<br/>    logger.kafka.additivity=false<br/><br/>    # Zookeeper is very verbose even on INFO level -&gt; We set it to WARN by default<br/>    logger.zookeepertrustmanager.name=org.apache.zookeeper<br/>    logger.zookeepertrustmanager.level=WARN<br/>    logger.zookeepertrustmanager.additivity=false<br/><br/>    # Keeps separate level for Netty logging -&gt; to not be changed by the root logger<br/>    logger.netty.name=io.netty<br/>    logger.netty.level=INFO<br/>    logger.netty.additivity=false</span><span id="8366" class="nl mb in ll b gy ob nn l no np">EOF</span></pre><p id="eefb" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如果您已经到达这里，没有任何问题，那么您已经为Strimzi Operator准备好了Kubernetes集群。我们现在可以开始创建Kafka集群和相关资源。</p></div><div class="ab cl lt lu hr lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ig ih ii ij ik"><h1 id="40ba" class="ma mb in bd mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx bi translated">Strimzi管理的Kafka集群</h1><h2 id="d4d5" class="nl mb in bd mc nq nr dn mg ns nt dp mk kg nu nv mo kk nw nx ms ko ny nz mw oa bi translated">Kafka集群名称空间</h2><p id="6537" class="pw-post-body-paragraph jv jw in jx b jy my ka kb kc mz ke kf kg na ki kj kk nb km kn ko nc kq kr ks ig bi translated">我们希望将所有与Kafka集群相关的资源托管到自己的名称空间，比如说<code class="fe li lj lk ll b">kafka-cluster-1</code>。在Kubernetes集群中，我们将有多个Kafka集群，管理它们的操作员都将在名称空间<code class="fe li lj lk ll b">strimzi</code>中创建，但是每个Kafka集群可以存在于单独的名称空间中。这有助于细粒度的访问控制。</p><p id="23f1" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">让我们为Kafka集群创建一个名称空间:</p><pre class="nd ne nf ng gt nh ll ni nj aw nk bi"><span id="3982" class="nl mb in ll b gy nm nn l no np">kubectl create namespace <!-- -->kafka-cluster-1</span></pre><h2 id="ec79" class="nl mb in bd mc nq nr dn mg ns nt dp mk kg nu nv mo kk nw nx ms ko ny nz mw oa bi translated">向操作员提供许可</h2><p id="38eb" class="pw-post-body-paragraph jv jw in jx b jy my ka kb kc mz ke kf kg na ki kj kk nb km kn ko nc kq kr ks ig bi translated">Strimzi服务帐户<code class="fe li lj lk ll b">strimzi-cluster-operator</code>需要被授予明确的权限，以便它可以管理名称空间<code class="fe li lj lk ll b">kafka-cluster-1</code>中的Kafka资源</p><p id="87d9" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">绑定到集群角色<code class="fe li lj lk ll b">strimzi-cluster-operator-namespaced</code>:</p><pre class="nd ne nf ng gt nh ll ni nj aw nk bi"><span id="21f9" class="nl mb in ll b gy nm nn l no np">cat &lt;&lt;EOF | kubectl create -n kafka-cluster-1 -f - <br/>apiVersion: rbac.authorization.k8s.io/v1<br/>kind: RoleBinding<br/>metadata:<br/>  name: strimzi-cluster-operator<br/>  labels:<br/>    app: strimzi<br/>subjects:<br/>  - kind: ServiceAccount<br/>    name: strimzi-cluster-operator<br/>    namespace: strimzi<br/>roleRef:<br/>  kind: ClusterRole<br/>  name: strimzi-cluster-operator-namespaced<br/>  apiGroup: rbac.authorization.k8s.io<br/>EOF</span></pre><p id="ac2a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">绑定到集群角色<code class="fe li lj lk ll b">strimzi-entity-operator</code>:</p><pre class="nd ne nf ng gt nh ll ni nj aw nk bi"><span id="d192" class="nl mb in ll b gy nm nn l no np">cat &lt;&lt;EOF | kubectl create -n kafka-cluster-1 -f -<br/>apiVersion: rbac.authorization.k8s.io/v1<br/>kind: RoleBinding<br/>metadata:<br/>  name: strimzi-cluster-operator-entity-operator-delegation<br/>  labels:<br/>    app: strimzi<br/><em class="lp"># The Entity Operator cluster role must be bound to the cluster operator service account so that it can delegate the cluster role to the Entity Operator.<br/># This must be done to avoid escalating privileges which would be blocked by Kubernetes.<br/></em>subjects:<br/>  - kind: ServiceAccount<br/>    name: strimzi-cluster-operator<br/>    namespace: strimzi<br/>roleRef:<br/>  kind: ClusterRole<br/>  name: strimzi-entity-operator<br/>  apiGroup: rbac.authorization.k8s.io<br/>EOF</span></pre><p id="8f56" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">绑定到群集角色“strim zi-cluster-operator-watched ”:</p><pre class="nd ne nf ng gt nh ll oc bn od oe bi"><span id="f544" class="of mb in ll b be og oh l oi np">cat &lt;&lt;EOF | kubectl create -n kafka-cluster-1 -f -<br/>apiVersion: rbac.authorization.k8s.io/v1<br/>kind: RoleBinding<br/>metadata:<br/>  name: strimzi-cluster-operator-watched<br/>  labels:<br/>    app: strimzi<br/>subjects:<br/>  - kind: ServiceAccount<br/>    name: strimzi-cluster-operator<br/>    namespace: strimzi<br/>roleRef:<br/>  kind: ClusterRole<br/>  name: strimzi-cluster-operator-watched<br/>  apiGroup: rbac.authorization.k8s.io<br/>EOF</span></pre><p id="0ea3" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">绑定到名称空间<code class="fe li lj lk ll b">strimzi</code>中操作员窗格的集群角色<code class="fe li lj lk ll b">strimzi-cluster-operator-leader-election</code>:</p><pre class="nd ne nf ng gt nh ll oc bn od oe bi"><span id="4efc" class="of mb in ll b be og oh l oi np">cat &lt;&lt;EOF | kubectl create -n strimzi -f -<br/>apiVersion: rbac.authorization.k8s.io/v1<br/>kind: RoleBinding<br/>metadata:<br/>  name: strimzi-cluster-operator-leader-election<br/>  labels:<br/>    app: strimzi<br/>subjects:<br/>  - kind: ServiceAccount<br/>    name: strimzi-cluster-operator<br/>    namespace: strimzi<br/>roleRef:<br/>  kind: ClusterRole<br/>  name: strimzi-cluster-operator-leader-election<br/>  apiGroup: rbac.authorization.k8s.io<br/>EOF</span></pre><h2 id="48ab" class="nl mb in bd mc nq nr dn mg ns nt dp mk kg nu nv mo kk nw nx ms ko ny nz mw oa bi translated">创建Strimzi运算符</h2><p id="d8a7" class="pw-post-body-paragraph jv jw in jx b jy my ka kb kc mz ke kf kg na ki kj kk nb km kn ko nc kq kr ks ig bi translated">现在，我们需要创建一个Strimzi操作符来管理名称空间<code class="fe li lj lk ll b">kafka-cluster-1</code>中的Kafka集群资源。该操作符将被托管在名称空间<code class="fe li lj lk ll b">strimzi</code>中。必须使用环境关键字<code class="fe li lj lk ll b">STRIMZI_NAMESPACE</code>向操作员传递它将管理的名称空间。</p><p id="d9dd" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">执行以下命令创建一个可以支持Kafka 3 . 3 . 1版的操作员:</p><pre class="nd ne nf ng gt nh ll ni nj aw nk bi"><span id="9ef8" class="nl mb in ll b gy nm nn l no np">cat &lt;&lt;EOF | kubectl create -n strimzi -f - <br/>apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: strimzi-cluster-operator-kafka-cluster-1<br/>  labels:<br/>    app: strimzi<br/>spec:<br/>  replicas: 1<br/>  selector:<br/>    matchLabels:<br/>      name: strimzi-cluster-operator<br/>      strimzi.io/kind: cluster-operator<br/>  template:<br/>    metadata:<br/>      labels:<br/>        name: strimzi-cluster-operator<br/>        strimzi.io/kind: cluster-operator<br/>    spec:<br/>      serviceAccountName: strimzi-cluster-operator<br/>      volumes:<br/>        - name: strimzi-tmp<br/>          emptyDir:<br/>            medium: Memory<br/>            sizeLimit: 1Mi<br/>        - name: co-config-volume<br/>          configMap:<br/>            name: strimzi-cluster-operator<br/>      containers:<br/>        - name: strimzi-cluster-operator<br/>          image: quay.io/strimzi/operator:0.32.0<br/>          ports:<br/>            - containerPort: 8080<br/>              name: http<br/>          args:<br/>            - /opt/strimzi/bin/cluster_operator_run.sh<br/>          volumeMounts:<br/>            - name: strimzi-tmp<br/>              mountPath: /tmp<br/>            - name: co-config-volume<br/>              mountPath: /opt/strimzi/custom-config/<br/>          env:<br/>            - name: STRIMZI_NAMESPACE<br/># Explicitly mention the namespace whose Kafka clusters will be managed<br/>              value: kafka-cluster-1<br/>            - name: STRIMZI_FULL_RECONCILIATION_INTERVAL_MS<br/>              value: "120000"<br/>            - name: STRIMZI_OPERATION_TIMEOUT_MS<br/>              value: "300000"<br/>            - name: STRIMZI_DEFAULT_TLS_SIDECAR_ENTITY_OPERATOR_IMAGE<br/>              value: quay.io/strimzi/kafka:0.32.0-kafka-3.3.1<br/>            - name: STRIMZI_DEFAULT_KAFKA_EXPORTER_IMAGE<br/>              value: quay.io/strimzi/kafka:0.32.0-kafka-3.3.1<br/>            - name: STRIMZI_DEFAULT_CRUISE_CONTROL_IMAGE<br/>              value: quay.io/strimzi/kafka:0.32.0-kafka-3.3.1<br/>            - name: STRIMZI_KAFKA_IMAGES<br/>              value: |<br/>                3.2.0=quay.io/strimzi/kafka:0.32.0-kafka-3.2.0<br/>                3.2.1=quay.io/strimzi/kafka:0.32.0-kafka-3.2.1<br/>                3.2.3=quay.io/strimzi/kafka:0.32.0-kafka-3.2.3<br/>                3.3.1=quay.io/strimzi/kafka:0.32.0-kafka-3.3.1<br/>            - name: STRIMZI_KAFKA_CONNECT_IMAGES<br/>              value: |<br/>                3.2.0=quay.io/strimzi/kafka:0.32.0-kafka-3.2.0<br/>                3.2.1=quay.io/strimzi/kafka:0.32.0-kafka-3.2.1<br/>                3.2.3=quay.io/strimzi/kafka:0.32.0-kafka-3.2.3<br/>                3.3.1=quay.io/strimzi/kafka:0.32.0-kafka-3.3.1<br/>            - name: STRIMZI_KAFKA_MIRROR_MAKER_IMAGES<br/>              value: |<br/>                3.2.0=quay.io/strimzi/kafka:0.32.0-kafka-3.2.0<br/>                3.2.1=quay.io/strimzi/kafka:0.32.0-kafka-3.2.1<br/>                3.2.3=quay.io/strimzi/kafka:0.32.0-kafka-3.2.3<br/>                3.3.1=quay.io/strimzi/kafka:0.32.0-kafka-3.3.1<br/>            - name: STRIMZI_KAFKA_MIRROR_MAKER_2_IMAGES<br/>              value: |<br/>                3.2.0=quay.io/strimzi/kafka:0.32.0-kafka-3.2.0<br/>                3.2.1=quay.io/strimzi/kafka:0.32.0-kafka-3.2.1<br/>                3.2.3=quay.io/strimzi/kafka:0.32.0-kafka-3.2.3<br/>                3.3.1=quay.io/strimzi/kafka:0.32.0-kafka-3.3.1<br/>            - name: STRIMZI_DEFAULT_TOPIC_OPERATOR_IMAGE<br/>              value: quay.io/strimzi/operator:0.32.0<br/>            - name: STRIMZI_DEFAULT_USER_OPERATOR_IMAGE<br/>              value: quay.io/strimzi/operator:0.32.0<br/>            - name: STRIMZI_DEFAULT_KAFKA_INIT_IMAGE<br/>              value: quay.io/strimzi/operator:0.32.0<br/>            - name: STRIMZI_DEFAULT_KAFKA_BRIDGE_IMAGE<br/>              value: quay.io/strimzi/kafka-bridge:0.22.3<br/>            - name: STRIMZI_DEFAULT_JMXTRANS_IMAGE<br/>              value: quay.io/strimzi/jmxtrans:0.32.0<br/>            - name: STRIMZI_DEFAULT_KANIKO_EXECUTOR_IMAGE<br/>              value: quay.io/strimzi/kaniko-executor:0.32.0<br/>            - name: STRIMZI_DEFAULT_MAVEN_BUILDER<br/>              value: quay.io/strimzi/maven-builder:0.32.0<br/>            - name: STRIMZI_OPERATOR_NAMESPACE<br/>              valueFrom:<br/>                fieldRef:<br/>                  fieldPath: metadata.namespace<br/># Enabling support for Zookeeper less Kafka<br/># Topic Operator is not supported in KRaft mode, yet.<br/>            - name: STRIMZI_FEATURE_GATES<br/>              value: "+UseKRaft,+UseStrimziPodSets"<br/>            - name: STRIMZI_LEADER_ELECTION_ENABLED<br/>              value: "true"<br/>            - name: STRIMZI_LEADER_ELECTION_LEASE_NAME<br/>              value: "strimzi-cluster-operator"<br/>            - name: STRIMZI_LEADER_ELECTION_LEASE_NAMESPACE<br/>              valueFrom:<br/>                fieldRef:<br/>                  fieldPath: metadata.namespace<br/>            - name: STRIMZI_LEADER_ELECTION_IDENTITY<br/>              valueFrom:<br/>                fieldRef:<br/>                  fieldPath: metadata.name<br/>          livenessProbe:<br/>            httpGet:<br/>              path: /healthy<br/>              port: http<br/>            initialDelaySeconds: 10<br/>            periodSeconds: 30<br/>          readinessProbe:<br/>            httpGet:<br/>              path: /ready<br/>              port: http<br/>            initialDelaySeconds: 10<br/>            periodSeconds: 30<br/>          resources:<br/>            limits:<br/>              cpu: 2000m<br/>              memory: 4096Mi<br/>            requests:<br/>              cpu: 200m<br/>              memory: 384Mi<br/>  strategy:<br/>    type: Recreate<br/>EOF</span></pre><p id="3450" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">您可以通过执行以下命令来检查操作员面板的状态:</p><pre class="nd ne nf ng gt nh ll ni nj aw nk bi"><span id="0d4b" class="nl mb in ll b gy nm nn l no np">kubectl -n strimzi get pods -o wide --watch</span></pre><p id="fd70" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">一旦operator pod处于<code class="fe li lj lk ll b">running</code>状态，您就可以在目标名称空间<code class="fe li lj lk ll b">kafka-cluster-1</code>中创建Kafka集群和相关资源。</p><h2 id="be41" class="nl mb in bd mc nq nr dn mg ns nt dp mk kg nu nv mo kk nw nx ms ko ny nz mw oa bi translated">创建Kafka集群</h2><p id="f151" class="pw-post-body-paragraph jv jw in jx b jy my ka kb kc mz ke kf kg na ki kj kk nb km kn ko nc kq kr ks ig bi translated">我们将创建一个简单的Kafka集群，它具有短暂的存储，并通过Zookeeper和Kafka Broker的3个实例来满足弹性。</p><p id="63bb" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">让我们在名称空间<code class="fe li lj lk ll b">kafka-cluster-1</code>中创建一个<code class="fe li lj lk ll b">kafka.kafka.strimzi.io</code>，即Kafka v3.3.1集群资源。</p><pre class="nd ne nf ng gt nh ll ni nj aw nk bi"><span id="ac40" class="nl mb in ll b gy nm nn l no np">cat &lt;&lt;EOF | kubectl create -n kafka-cluster-1 -f -<br/>apiVersion: kafka.strimzi.io/v1beta2<br/>kind: Kafka<br/>metadata:<br/>  name: kafka<br/>spec:<br/>  kafka:<br/>    version: 3.3.1<br/>    replicas: 3<br/>    listeners:<br/>      - name: plain<br/>        port: 9092<br/>        type: internal<br/>        tls: false<br/>      - name: tls<br/>        port: 9093<br/>        type: internal<br/>        tls: true<br/>        authentication:<br/>          type: tls<br/>      - name: external<br/>        port: 9094<br/>        type: nodeport<br/>        tls: false<br/>    storage:<br/>      type: ephemeral<br/>    config:<br/>      offsets.topic.replication.factor: 2<br/>      transaction.state.log.replication.factor: 2<br/>      transaction.state.log.min.isr: 2<br/>      default.replication.factor: 2<br/>      min.insync.replicas: 2<br/>      inter.broker.protocol.version: "3.3"<br/># The entry for Zookeeper is required even in Kraft mode. However, they are ignore by the Operator.<br/>  zookeeper:<br/>    replicas: 1<br/>    storage:<br/>      type: ephemeral<br/># The entity operator will allow managing of the Topics and Users in the Kafka by the Operator.<br/>  entityOperator:<br/># If Kraft mode is enabled for operator, remove entry for `topicOperator`. Ref: <a class="ae kt" href="https://strimzi.io/docs/operators/latest/configuring.html#type-EntityTopicOperatorSpec-reference" rel="noopener ugc nofollow" target="_blank">https://strimzi.io/docs/operators/latest/configuring.html#type-EntityTopicOperatorSpec-reference</a> <br/>    topicOperator: {}<br/>    userOperator: {}<br/>EOF</span></pre><p id="c919" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在，通过执行下面的命令，观察名为<code class="fe li lj lk ll b">kafka</code>的Kafka集群的创建，并等待所有pod被标记为<code class="fe li lj lk ll b">running</code>:</p><pre class="nd ne nf ng gt nh ll ni nj aw nk bi"><span id="ca7b" class="nl mb in ll b gy nm nn l no np">kubectl -n kafka-cluster-1 get pods -o wide --watch</span></pre><p id="67f7" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">当Zookeeper和Kafka broker的3个pod处于<code class="fe li lj lk ll b">running</code>状态时，那么集群就可以使用了。</p></div><div class="ab cl lt lu hr lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ig ih ii ij ik"><h1 id="4dcb" class="ma mb in bd mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx bi translated">使用Kafka集群</h1><h2 id="0567" class="nl mb in bd mc nq nr dn mg ns nt dp mk kg nu nv mo kk nw nx ms ko ny nz mw oa bi translated">创建主题</h2><p id="1eb2" class="pw-post-body-paragraph jv jw in jx b jy my ka kb kc mz ke kf kg na ki kj kk nb km kn ko nc kq kr ks ig bi translated">让我们在集群中创建一个主题<code class="fe li lj lk ll b">tweets</code>，命名为<code class="fe li lj lk ll b">kafka</code>，命名空间为<code class="fe li lj lk ll b">kafka-cluster-1</code>，其中有两个分区，数据复制两次。</p><pre class="nd ne nf ng gt nh ll ni nj aw nk bi"><span id="1528" class="nl mb in ll b gy nm nn l no np">cat &lt;&lt;EOF | kubectl create -n kafka-cluster-1 -f -<br/>apiVersion: kafka.strimzi.io/v1beta2<br/>kind: KafkaTopic<br/>metadata:<br/>  name: tweets<br/>  labels:<br/>    strimzi.io/cluster: kafka<br/>spec:<br/>  partitions: 2<br/>  replicas: 1<br/>  config:<br/>    retention.ms: 900000<br/>    segment.bytes: 1073741824<br/>EOF</span></pre><p id="22fa" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">当就绪状态为<code class="fe li lj lk ll b">true</code>时，主题<code class="fe li lj lk ll b">tweets</code>即可使用，并且可以通过执行以下命令来验证:</p><pre class="nd ne nf ng gt nh ll ni nj aw nk bi"><span id="fac8" class="nl mb in ll b gy nm nn l no np">kubectl -n kafka-cluster-1 get kafkatopic -o wide --watch</span></pre><h2 id="55bb" class="nl mb in bd mc nq nr dn mg ns nt dp mk kg nu nv mo kk nw nx ms ko ny nz mw oa bi translated">发布到主题</h2><p id="9ada" class="pw-post-body-paragraph jv jw in jx b jy my ka kb kc mz ke kf kg na ki kj kk nb km kn ko nc kq kr ks ig bi translated">本文中创建的Kafka集群将端口<code class="fe li lj lk ll b">9094</code>公开为<code class="fe li lj lk ll b">NodePort</code>，以允许来自Kubernetes集群之外的系统的流量。这是通过我们的<code class="fe li lj lk ll b">Kafka</code>资源<code class="fe li lj lk ll b">kafka.kafka.strimzi.io/kafka</code>的定义中的以下代码块实现的。</p><pre class="nd ne nf ng gt nh ll ni nj aw nk bi"><span id="328e" class="nl mb in ll b gy nm nn l no np">.....<br/>      - name: external<br/>        port: 9094<br/>        type: nodeport<br/>        tls: false<br/>.....</span></pre><p id="459f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">执行以下命令，找出您的Kubernetes的IP地址和端口号:</p><pre class="nd ne nf ng gt nh ll ni nj aw nk bi"><span id="0a83" class="nl mb in ll b gy nm nn l no np">kubectl -n kafka-cluster-1 describe kafka kafka</span></pre><p id="a16b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">您应该会看到与集群相关的所有详细信息，但是我们对以下部分的信息感兴趣:</p><pre class="nd ne nf ng gt nh ll ni nj aw nk bi"><span id="fbfa" class="nl mb in ll b gy nm nn l no np">.....<br/>    Addresses:<br/>      Host:             192.168.64.23<br/>      Port:             31363<br/>    Bootstrap Servers:  192.168.64.23:31363<br/>    Type:               external<br/>.....</span></pre><blockquote class="lm ln lo"><p id="8a61" class="jv jw lp jx b jy jz ka kb kc kd ke kf lq kh ki kj lr kl km kn ls kp kq kr ks ig bi translated">注意，根据您的Kubernetes集群信息，信息看起来会有所不同。对于本文，我使用在我的机器上创建的Kubernetes集群。</p></blockquote><p id="3d17" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">Kafka集群可以在<code class="fe li lj lk ll b">192.168.64.23:31363</code>上连接，这是引导服务器监听的地方。根据集群的创建方式，您的情况会有所不同。在本文的其余部分，我将使用上面的地址。</p><p id="29f7" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如果你还没有Kafka客户端，请从https://kafka.apache.org/downloads下载。</p><pre class="nd ne nf ng gt nh ll ni nj aw nk bi"><span id="aa68" class="nl mb in ll b gy nm nn l no np">$ curl -L "<a class="ae kt" href="https://dlcdn.apache.org/kafka/3.0.0/kafka_2.13-3.0.0.tgz" rel="noopener ugc nofollow" target="_blank">https://dlcdn.apache.org/kafka/3.3.1/kafka_2.13-3.3.1.tgz</a>" -o kafka_2.13-3.3.1.tgz<br/>$ tar -xvf kafka_2.13-3.3.1.tgz<br/>$ cd kafka_2.13-3.3.1</span></pre><p id="4728" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在，从机器上的终端连接到集群，执行以下命令:</p><pre class="nd ne nf ng gt nh ll ni nj aw nk bi"><span id="b060" class="nl mb in ll b gy nm nn l no np">./bin/kafka-console-producer.sh --broker-list 192.168.64.23:31363 --topic tweets</span></pre><p id="cb8b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">一旦接通，键入任何消息。根据主题<code class="fe li lj lk ll b">kafkatopic.kafka.strimzi.io/tweets</code>在创建过程中的配置，消息将可用15分钟:</p><pre class="nd ne nf ng gt nh ll ni nj aw nk bi"><span id="d2ce" class="nl mb in ll b gy nm nn l no np">.....<br/>retention.ms: 900000<br/>.....</span></pre><h2 id="77e2" class="nl mb in bd mc nq nr dn mg ns nt dp mk kg nu nv mo kk nw nx ms ko ny nz mw oa bi translated">从主题消费</h2><p id="3d4e" class="pw-post-body-paragraph jv jw in jx b jy my ka kb kc mz ke kf kg na ki kj kk nb km kn ko nc kq kr ks ig bi translated">现在，在另一个终端中执行下面的命令来启动一个消费者会话，并接收生产者输入的消息。</p><pre class="nd ne nf ng gt nh ll ni nj aw nk bi"><span id="b4ea" class="nl mb in ll b gy nm nn l no np">bin/kafka-console-consumer.sh --bootstrap-server 192.168.64.23:31363 --topic tweets --from-beginning</span></pre><p id="2613" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这将显示在主题<code class="fe li lj lk ll b">tweets</code>上发布的所有消息。</p></div><div class="ab cl lt lu hr lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ig ih ii ij ik"><h1 id="e0de" class="ma mb in bd mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx bi translated">结论</h1><p id="ea50" class="pw-post-body-paragraph jv jw in jx b jy my ka kb kc mz ke kf kg na ki kj kk nb km kn ko nc kq kr ks ig bi translated">您可以看到，使用Strimzi可以使用Kubernetes客户资源定义来定义和管理Kafka集群和资源，从而为整个集群启用IaC。CI/CD流程可以使用Git和Helm图表来管理集群和其中的资源。</p><p id="95c4" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">本文涵盖了最简单的场景。Strimzi允许用共享租用所需的更复杂的配置来定义Kafka集群。</p></div></div>    
</body>
</html>