<html>
<head>
<title>Laravel CRUD access control based on role and permission</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基于角色和权限的访问控制</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/laravel-crud-access-control-based-on-role-and-permission-f190d03f1fa2?source=collection_archive---------1-----------------------#2022-04-17">https://blog.devgenius.io/laravel-crud-access-control-based-on-role-and-permission-f190d03f1fa2?source=collection_archive---------1-----------------------#2022-04-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="8436" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">Laravel 从头开始创建一个管理面板——第 5 部分</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/bf58e8039056c089c1a30899740026b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jKrkRQLlO8_61K60"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@kylejglenn?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">凯尔·格伦</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="117e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这一部分，我们将把基于权限的访问限制添加到我们的权限 CRUD 中。</p><ul class=""><li id="4634" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">1.创建许可播种者</li><li id="b298" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">2.重新迁移并植入数据库</li><li id="ccc5" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">3.授予超级管理员访问权限</li><li id="434f" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">4.添加权限检查</li></ul><h2 id="7853" class="mg mh iq bd mi mj mk dn ml mm mn dp mo lf mp mq mr lj ms mt mu ln mv mw mx my bi translated">1.创建许可播种者</h2><p id="b166" class="pw-post-body-paragraph kw kx iq ky b kz mz jr lb lc na ju le lf nb lh li lj nc ll lm ln nd lp lq lr ij bi translated">我们需要一些角色。权限和用户控制对我们的管理应用程序的访问。因此，我们将为我们的表创建一个<a class="ae kv" href="https://laravel.com/docs/seeding" rel="noopener ugc nofollow" target="_blank">播种机</a>。</p><p id="2fcc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ne nf ng nh b">/database/seeders/PermissionsDemoSeeder.php</code>新建一个文件，如下面的代码</p><pre class="kg kh ki kj gt ni nh nj bn nk nl bi"><span id="7eaf" class="nm mh iq nh b be nn no l np nq">&lt;?php<br/>namespace Database\Seeders;<br/>use Illuminate\Database\Seeder;<br/>use Spatie\Permission\Models\Permission;<br/>use Spatie\Permission\Models\Role;<br/>use Spatie\Permission\PermissionRegistrar;<br/>class BasicAdminPermissionSeeder extends Seeder<br/>{<br/>    /**<br/>     * Create the initial roles and permissions.<br/>     *<br/>     * @return void<br/>     */<br/>    public function run()<br/>    {<br/>        // Reset cached roles and permissions<br/>        app()[PermissionRegistrar::class]-&gt;forgetCachedPermissions();<br/>        // create permissions<br/>        $permissions = [<br/>            'permission list',<br/>            'permission create',<br/>            'permission edit',<br/>            'permission delete',<br/>            'role list',<br/>            'role create',<br/>            'role edit',<br/>            'role delete',<br/>            'user list',<br/>            'user create',<br/>            'user edit',<br/>            'user delete'<br/>         ];<br/>        foreach ($permissions as $permission) {<br/>            Permission::create(['name' =&gt; $permission]);<br/>        }<br/>        // create roles and assign existing permissions<br/>        $role1 = Role::create(['name' =&gt; 'writer']);<br/>        $role1-&gt;givePermissionTo('permission list');<br/>        $role1-&gt;givePermissionTo('role list');<br/>        $role1-&gt;givePermissionTo('user list');<br/>        $role2 = Role::create(['name' =&gt; 'admin']);<br/>        foreach ($permissions as $permission) {<br/>            $role2-&gt;givePermissionTo($permission);<br/>        }<br/>        $role3 = Role::create(['name' =&gt; 'super-admin']);<br/>        // gets all permissions via Gate::before rule; see AuthServiceProvider<br/>        // create demo users<br/>        $user = \App\Models\User::factory()-&gt;create([<br/>            'name' =&gt; 'Super Admin',<br/>            'email' =&gt; 'superadmin@example.com',<br/>        ]);<br/>        $user-&gt;assignRole($role3);<br/>        $user = \App\Models\User::factory()-&gt;create([<br/>            'name' =&gt; 'Admin User',<br/>            'email' =&gt; 'admin@example.com',<br/>        ]);<br/>        $user-&gt;assignRole($role2);<br/>        $user = \App\Models\User::factory()-&gt;create([<br/>            'name' =&gt; 'Example User',<br/>            'email' =&gt; 'test@example.com',<br/>        ]);<br/>        $user-&gt;assignRole($role1);<br/>    }<br/>}</span></pre><p id="28a2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">用户工厂的默认密码是“password”。</p><p id="52bb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ne nf ng nh b">$user-&gt;assignRole</code>用于给用户分配角色。在用户模型中包含 Spatie \ Permission \ Traits \ has roles 特征。</p><pre class="kg kh ki kj gt ni nh nj bn nk nl bi"><span id="57ff" class="nm mh iq nh b be nn no l np nq">+++ b/app/Models/User.php<br/>@@ -7,10 +7,11 @@ use Illuminate\Database\Eloquent\Factories\HasFactory;<br/> use Illuminate\Foundation\Auth\User as Authenticatable;<br/> use Illuminate\Notifications\Notifiable;<br/> use Laravel\Sanctum\HasApiTokens;<br/>+use Spatie\Permission\Traits\HasRoles;<br/>class User extends Authenticatable<br/> {<br/>-    use HasApiTokens, HasFactory, Notifiable;<br/>+    use HasApiTokens, HasFactory, Notifiable, HasRoles;<br/>     /**<br/>      * The attributes that are mass assignable.</span></pre></div><div class="ab cl nr ns hu nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="ij ik il im in"><h2 id="2d62" class="mg mh iq bd mi mj mk dn ml mm mn dp mo lf mp mq mr lj ms mt mu ln mv mw mx my bi translated">2.重新迁移并植入数据库</h2><p id="f024" class="pw-post-body-paragraph kw kx iq ky b kz mz jr lb lc na ju le lf nb lh li lj nc ll lm ln nd lp lq lr ij bi translated">以下命令将删除您的所有数据。它将删除所有表，并再次运行所有迁移，最后，我们的种子将运行。</p><pre class="kg kh ki kj gt ni nh nj bn nk nl bi"><span id="03b1" class="nm mh iq nh b be nn no l np nq">sail artisan migrate:fresh --seed --seeder=BasicAdminPermissionSeeder</span></pre><p id="6633" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您不想删除您的数据，请运行以下命令。它只会运行播种机</p><pre class="kg kh ki kj gt ni nh nj bn nk nl bi"><span id="1907" class="nm mh iq nh b be nn no l np nq">sail artisan db:seed --class=BasicAdminPermissionSeeder</span></pre></div><div class="ab cl nr ns hu nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="ij ik il im in"><h2 id="ca9e" class="mg mh iq bd mi mj mk dn ml mm mn dp mo lf mp mq mr lj ms mt mu ln mv mw mx my bi translated">3.授予超级管理员访问权限</h2><p id="b0b5" class="pw-post-body-paragraph kw kx iq ky b kz mz jr lb lc na ju le lf nb lh li lj nc ll lm ln nd lp lq lr ij bi translated">超级管理员将拥有对应用程序的所有访问权限。所以当超级管理员登录时，需要为所有的权限检查函数<code class="fe ne nf ng nh b">can()</code>或<code class="fe ne nf ng nh b">@can()</code>返回 true</p><p id="321b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在下面添加一个<code class="fe ne nf ng nh b">Gate::before</code>检查你的<code class="fe ne nf ng nh b">AuthServiceProvider</code>启动功能。</p><pre class="kg kh ki kj gt ni nh nj bn nk nl bi"><span id="d10d" class="nm mh iq nh b be nn no l np nq">public function boot()<br/>    {<br/>        $this-&gt;registerPolicies();<br/>        <br/>        // Implicitly grant "Super-Admin" role all permission checks using can()<br/>       Gate::before(function ($user, $ability) {<br/>           if ($user-&gt;hasRole('super-admin')) {<br/>               return true;<br/>           }<br/>       });<br/>    }</span></pre></div><div class="ab cl nr ns hu nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="ij ik il im in"><h2 id="a481" class="mg mh iq bd mi mj mk dn ml mm mn dp mo lf mp mq mr lj ms mt mu ln mv mw mx my bi translated">4.添加权限检查</h2><p id="2af8" class="pw-post-body-paragraph kw kx iq ky b kz mz jr lb lc na ju le lf nb lh li lj nc ll lm ln nd lp lq lr ij bi translated">现在，所有用户都可以完全访问该应用程序。因为我们没有添加检查 Laravel 默认<code class="fe ne nf ng nh b">can</code>函数的权限。</p><pre class="kg kh ki kj gt ni nh nj bn nk nl bi"><span id="1185" class="nm mh iq nh b be nn no l np nq">$user-&gt;can('permission create');</span></pre><pre class="ny ni nh nj bn nk nl bi"><span id="5853" class="nm mh iq nh b be nn no l np nq">In Blade directives:<br/>@can('permission create')<br/>...<br/>@endcan</span></pre><p id="3419" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">已经使用中间件在控制器构造器中检查了权限。</p><p id="66f3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">将以下代码添加到控制器<code class="fe ne nf ng nh b">app/Http/Controllers/Admin/PermissionController.php</code></p><pre class="kg kh ki kj gt ni nh nj bn nk nl bi"><span id="e475" class="nm mh iq nh b be nn no l np nq">function __construct()<br/>    {<br/>         $this-&gt;middleware('can:permission list', ['only' =&gt; ['index','show']]);<br/>         $this-&gt;middleware('can:permission create', ['only' =&gt; ['create','store']]);<br/>         $this-&gt;middleware('can:permission edit', ['only' =&gt; ['edit','update']]);<br/>         $this-&gt;middleware('can:permission delete', ['only' =&gt; ['destroy']]);<br/>    }</span></pre><p id="033d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">作为一个作者创建权限时，您将获得 403。因为作者只有列表访问权限。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nz"><img src="../Images/55b50acccdb4f5e6c4deb1f8735d849a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LOpSpgAJjVNB7h7ae0sLkA.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">许可列表</figcaption></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oa"><img src="../Images/e02af52ebb6b6cf39c79674bbbc25db8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dFDtYDU6aWQww9sfUpKV5A.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">权限创建</figcaption></figure><p id="a583" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">通过使用 Blade 指令，我们将隐藏列表页面上的创建、编辑和删除按钮。</p><pre class="kg kh ki kj gt ni nh nj bn nk nl bi"><span id="efaf" class="nm mh iq nh b be nn no l np nq">diff --git a/resources/views/admin/permission/index.blade.php b/resources/views/admin/permission/index.blade.php<br/>index 5f31bab..90d4086 100644<br/>--- a/resources/views/admin/permission/index.blade.php<br/>+++ b/resources/views/admin/permission/index.blade.php<br/>@@ -10,9 +10,11 @@<br/>             &lt;div class="bg-white overflow-hidden shadow-sm sm:rounded-lg"&gt;<br/>                 &lt;div class="p-6 bg-white border-b border-gray-200"&gt;<br/>                     &lt;div class="flex flex-col mt-8"&gt;<br/>+                    @can('permission create')<br/>                     &lt;div class="d-print-none with-border mb-8"&gt;<br/>                         &lt;a href="{{ route('permission.create') }}" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center mr-2 mb-2 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800"&gt;{{ __('Add Permission') }}&lt;/a&gt;  <br/>                     &lt;/div&gt;<br/>+                    @endcan<br/>                         &lt;div class="py-2"&gt;<br/>                         @if(session()-&gt;has('message'))<br/>                             &lt;div class="mb-8 text-green-400 font-bold"&gt;<br/>@@ -26,9 +28,11 @@<br/>                                             &lt;th class="py-4 px-6 bg-grey-lightest font-bold uppercase text-sm text-grey-dark border-b border-grey-light text-left"&gt;<br/>                                                 {{ __('Name') }}<br/>                                             &lt;/th&gt;<br/>+                                            @canany(['permission edit', 'permission delete'])<br/>                                             &lt;th class="py-4 px-6 bg-grey-lightest font-bold uppercase text-sm text-grey-dark border-b border-grey-light text-left"&gt;<br/>                                                 {{ __('Actions') }}<br/>                                             &lt;/th&gt;<br/>+                                            @endcanany<br/>                                         &lt;/tr&gt;<br/>                                     &lt;/thead&gt;<br/>@@ -40,21 +44,25 @@<br/>                                                     &lt;a href="{{route('permission.show', $permission-&gt;id)}}" class="no-underline hover:underline text-cyan-600 dark:text-cyan-400"&gt;{{ $permission-&gt;name }}&lt;/a&gt;  <br/>                                                 &lt;/div&gt;<br/>                                             &lt;/td&gt;<br/>-<br/>+                                            @canany(['permission edit', 'permission delete'])<br/>                                             &lt;td class="border-b border-slate-100 dark:border-slate-700 <br/>p-4 pl-8 text-slate-500 dark:text-slate-400"&gt;<br/>                                                 &lt;form action="{{ route('permission.destroy', $permission-&gt;id) }}" method="POST"&gt;<br/>+                                                    @can('permission edit')<br/>                                                     &lt;a href="{{route('permission.edit', $permission-&gt;id)}}" class="px-4 py-2 text-white mr-4 bg-blue-600"&gt;<br/>                                                         {{ __('Edit') }}<br/>                                                     &lt;/a&gt;<br/>+                                                    @endcan<br/>+                                                    @can('permission delete')<br/>                                                     @csrf<br/>                                                     @method('DELETE')<br/>                                                     &lt;button class="px-4 py-2 text-white bg-red-600"&gt;   <br/>                                                         {{ __('Delete') }}<br/>                                                     &lt;/button&gt;<br/>+                                                    @endcan<br/>                                                 &lt;/form&gt;<br/>                                             &lt;/td&gt;<br/>-<br/>+                                            @endcanany<br/>                                         &lt;/tr&gt;<br/>                                         @endforeach<br/>                                     &lt;/tbody&gt;</span></pre><p id="a16f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在<code class="fe ne nf ng nh b">index.blade.php</code>更新之后，writer 用户的索引页面</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ob"><img src="../Images/7c062c1d6dd310f9cead243a19c1e80d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y9NXiF7VrJ7Z23jRXw6phg.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">仅具有列表访问权限的用户</figcaption></figure><p id="d749" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们成功地为我们的权限 CRUD 添加了基于权限的访问控制。</p><p id="ec51" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下一部分，我们将把搜索添加到我们的索引页面。并创建剩余的角色和用户 CRUD。</p></div><div class="ab cl nr ns hu nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="ij ik il im in"><h2 id="09ba" class="mg mh iq bd mi mj mk dn ml mm mn dp mo lf mp mq mr lj ms mt mu ln mv mw mx my bi translated">GitHub 知识库</h2><p id="438c" class="pw-post-body-paragraph kw kx iq ky b kz mz jr lb lc na ju le lf nb lh li lj nc ll lm ln nd lp lq lr ij bi translated">许可代码可在<a class="ae kv" href="https://github.com/balajidharma/basic-laravel-admin-panel/tree/archive/1.0.3" rel="noopener ugc nofollow" target="_blank"> 1.0.3 </a>分支上获得</p></div><div class="ab cl nr ns hu nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="ij ik il im in"><p id="3e91" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">上一部分—第四部分:<a class="ae kv" rel="noopener ugc nofollow" target="_blank" href="/basic-laravel-admin-panel-basic-laravel-crud-creation-for-permission-management-6bd93fb0e1a2">权限管理的基础 Laravel CRUD 创建</a></p><p id="1d28" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下一部分——第 6 部分:<a class="ae kv" rel="noopener ugc nofollow" target="_blank" href="/implements-a-basic-search-filter-and-column-sort-with-pagination-in-laravel-crud-5e3c70fb12ac">在 Laravel </a>中实现了基本的搜索过滤器和带有分页的列排序</p></div></div>    
</body>
</html>