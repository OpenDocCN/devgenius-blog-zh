<html>
<head>
<title>Securing Kubernetes Dashboard on EKS with Pomerium</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用 Pomerium 固定 EKS 上的 Kubernetes 仪表板</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/securing-kubernetes-dashboard-on-eks-with-pomerium-e98c47610e2f?source=collection_archive---------1-----------------------#2020-08-10">https://blog.devgenius.io/securing-kubernetes-dashboard-on-eks-with-pomerium-e98c47610e2f?source=collection_archive---------1-----------------------#2020-08-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="8d89" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用 Pomerium 和 Traefik 通过身份识别访问代理保护 Kubernetes 应用程序访问。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/a3a21984cb66c1a31a7a52994c32f6a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*low7iYz4tQUXF_zb_D3XkQ.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">Traefik + Pomerium 确保对 Kubernetes 应用程序的访问</figcaption></figure><p id="85b6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">身份识别代理(IAP)是一种安全的方法，可以在不使用 VPN 的情况下提供对内部应用程序的访问。这种零信任安全模式建立在谷歌的<a class="ae lb" href="https://cloud.google.com/beyondcorp/" rel="noopener ugc nofollow" target="_blank"> BeyondCorp </a>实现的基础上，将安全从网络边界转移到个人用户，根据用户的上下文确定访问。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lc"><img src="../Images/f8a62cdadcde105ded56f23c371d91b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*d7J4tqGhn81xQU4r"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">图片来源:<a class="ae lb" href="https://security.googleblog.com/2019/10/how-google-adopted-beyondcorp-part-4.html" rel="noopener ugc nofollow" target="_blank">谷歌安全博客</a></figcaption></figure><p id="aac6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在 Google Cloud 上，这可以通过<a class="ae lb" href="https://cloud.google.com/iap/" rel="noopener ugc nofollow" target="_blank"> Cloud IAP </a>轻松实现(参见<a class="ae lb" href="https://medium.com/google-cloud/practical-monitoring-with-prometheus-grafana-part-iv-d4f3f995cc78" rel="noopener">在 GKE </a>保护 Grafana 的示例部署)。在 GCP 之外，有两个很好的开源解决方案:</p><ul class=""><li id="4e3a" class="ld le iq jp b jq jr ju jv jy lf kc lg kg lh kk li lj lk ll bi translated"><a class="ae lb" href="https://github.com/pomerium/pomerium" rel="noopener ugc nofollow" target="_blank">梨果</a></li><li id="52fe" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk li lj lk ll bi translated"><a class="ae lb" href="https://github.com/ory/oathkeeper" rel="noopener ugc nofollow" target="_blank">奥里·奥茨基珀</a></li></ul><p id="a0c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用 Pomerium 等 IAP 的一个常见用例是保护对内部应用程序/工具的访问(例如 Kubernetes dashboard、ArgoCD、Kibana)。尤其是 Kubernetes dashboard，它是 Pomerium 的绝佳选择，因为除了 GKE 之外，没有任何 Kubernetes 服务提供托管仪表板。不安全的 Kubernetes 仪表盘在 2018 年成为头条新闻，当时黑客在特斯拉的云实例上安装了<a class="ae lb" href="https://redlock.io/blog/cryptojacking-tesla" rel="noopener ugc nofollow" target="_blank">加密挖掘恶意软件</a>，通过仪表盘获得访问权限。默认安装现在大大限制了访问，但让用户在使用<code class="fe lr ls lt lu b">kubectl proxy</code>后输入令牌仍然是一个繁琐的过程。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lv"><img src="../Images/7f93c98d3178fbaeb95bdd3ce07e950f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1286/format:webp/0*Glsu-pVpr7FtzMWl.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">图片来源:<a class="ae lb" href="https://www.wired.com/story/cryptojacking-tesla-amazon-cloud/" rel="noopener ugc nofollow" target="_blank">有线</a></figcaption></figure><p id="c6c0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">本文将通过 Pomerium 和 Traefik 的一个示例设置向 Kubernetes 仪表板添加身份验证和授权。用户可以通过身份提供商(例如 Google、Github、Okta)进行身份验证，而不是发布<code class="fe lr ls lt lu b">kubectl proxy</code>，从而轻松访问仪表盘。</p><h1 id="ba69" class="lw lx iq bd ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt bi translated">先决条件</h1><ul class=""><li id="5298" class="ld le iq jp b jq mu ju mv jy mw kc mx kg my kk li lj lk ll bi translated">Kubernetes 集群(例如 EKS、阿拉斯加)</li><li id="68d1" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk li lj lk ll bi translated">头盔 v3</li><li id="6556" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk li lj lk ll bi translated">DNS 提供商(例如 Cloudflare)</li><li id="7eb6" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk li lj lk ll bi translated">入口控制器(如 Traefik)</li><li id="0556" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk li lj lk ll bi translated">证书管理员(例如证书管理员)</li></ul><p id="581e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> <em class="mz">注</em> </strong> <em class="mz">:您可以用自己选择的入口控制器(如 nginx、envoy、ambassador)替换 Traefik。根据需要部署入口控制器，并替换入口注释。所有代码也托管在 Github 上:</em></p><div class="na nb gp gr nc nd"><a href="https://github.com/Yitaek/pomerium-iap-traefik" rel="noopener  ugc nofollow" target="_blank"><div class="ne ab fo"><div class="nf ab ng cl cj nh"><h2 class="bd ir gy z fp ni fr fs nj fu fw ip bi translated">Yitaek/pomerium-iap-traefik</h2><div class="nk l"><h3 class="bd b gy z fp ni fr fs nj fu fw dk translated">身份识别代理(IAP)是一种安全的方法，可以在不使用 VPN 的情况下提供对内部应用程序的访问。的…</h3></div><div class="nl l"><p class="bd b dl z fp ni fr fs nj fu fw dk translated">github.com</p></div></div><div class="nm l"><div class="nn l no np nq nm nr kv nd"/></div></div></a></div><h1 id="85a9" class="lw lx iq bd ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt bi translated">高层架构</h1><p id="62f0" class="pw-post-body-paragraph jn jo iq jp b jq mu js jt ju mv jw jx jy ns ka kb kc nt ke kf kg nu ki kj kk ij bi translated">Pomerium 由四个逻辑组件组成:</p><ul class=""><li id="6fca" class="ld le iq jp b jq jr ju jv jy lf kc lg kg lh kk li lj lk ll bi translated"><strong class="jp ir">代理服务</strong>:指导用户建立身份的主代理</li><li id="2a8d" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk li lj lk ll bi translated"><strong class="jp ir">认证服务</strong> (AuthN):通过身份提供者(IdP)验证身份</li><li id="85dc" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk li lj lk ll bi translated"><strong class="jp ir">授权服务</strong> (AuthZ):决定权限</li><li id="3ae8" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk li lj lk ll bi translated"><strong class="jp ir">缓存服务</strong>:存储和刷新 IdP 访问和令牌</li></ul><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nv"><img src="../Images/a757637f5a1e727aea7d54ad395e6ed5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lfrXTGoGY6i-M3X0Q6sJNA.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">图片来源:<a class="ae lb" href="https://www.pomerium.io/docs/" rel="noopener ugc nofollow" target="_blank">石榴文件</a></figcaption></figure><p id="6d3d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">虽然 Pomerium 也可以充当<a class="ae lb" href="https://www.pomerium.io/reference/#forward-auth" rel="noopener ugc nofollow" target="_blank">转发身份验证提供者</a>(将每个请求的身份验证和授权委托给 Pomerium)，但我们将把重点放在使用 Pomerium 作为独立的身份感知代理，因为我们的目标是使对 Kubernetes 仪表板的访问变得简单和安全。</p><h1 id="208e" class="lw lx iq bd ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt bi translated">部署指南</h1><p id="6846" class="pw-post-body-paragraph jn jo iq jp b jq mu js jt ju mv jw jx jy ns ka kb kc nt ke kf kg nu ki kj kk ij bi translated">假设一个准系统 EKS 安装，让我们从部署<code class="fe lr ls lt lu b">metrics-server</code>和<code class="fe lr ls lt lu b">kubernetes-dashboard</code>开始。</p><h2 id="d924" class="nw lx iq bd ly nx ny dn mc nz oa dp mg jy ob oc mk kc od oe mo kg of og ms oh bi translated">Kubernetes 仪表板</h2><p id="66d2" class="pw-post-body-paragraph jn jo iq jp b jq mu js jt ju mv jw jx jy ns ka kb kc nt ke kf kg nu ki kj kk ij bi translated">安装<code class="fe lr ls lt lu b">metrics-server</code>:</p><pre class="km kn ko kp gt oi lu oj ok aw ol bi"><span id="a231" class="nw lx iq lu b gy om on l oo op">$ kubectl apply -f <a class="ae lb" href="https://github.com/kubernetes-sigs/metrics-server/releases/download/v0.3.7/components.yaml" rel="noopener ugc nofollow" target="_blank">https://github.com/kubernetes-sigs/metrics-server/releases/download/v0.3.7/components.yaml</a></span></pre><p id="a9dc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">安装<code class="fe lr ls lt lu b">kubernetes-dashboard</code>:</p><pre class="km kn ko kp gt oi lu oj ok aw ol bi"><span id="3b9a" class="nw lx iq lu b gy om on l oo op">$ kubectl apply -f <a class="ae lb" href="https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.3/aio/deploy/recommended.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.3/aio/deploy/recommended.yaml</a></span></pre><p id="3c4d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在部署这些组件的同时，创建一个<code class="fe lr ls lt lu b">eks-admin</code>服务帐户和集群角色绑定，用一个令牌连接到仪表板:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="oq or l"/></div></figure><p id="ebbc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">应用服务帐户和群集角色绑定:</p><pre class="km kn ko kp gt oi lu oj ok aw ol bi"><span id="083c" class="nw lx iq lu b gy om on l oo op">$ kubectl apply -f eks-admin-service-account.yaml</span></pre><p id="3a80" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在让我们验证我们可以登录:</p><ol class=""><li id="b1bb" class="ld le iq jp b jq jr ju jv jy lf kc lg kg lh kk os lj lk ll bi translated">启动<code class="fe lr ls lt lu b">kubectl proxy</code>:</li></ol><pre class="km kn ko kp gt oi lu oj ok aw ol bi"><span id="8ae6" class="nw lx iq lu b gy om on l oo op">$ kubectl proxy</span></pre><p id="c0ef" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.抓住令牌:</p><pre class="km kn ko kp gt oi lu oj ok aw ol bi"><span id="0d29" class="nw lx iq lu b gy om on l oo op">$ kubectl -n kube-system get secret $(kubectl -n kube-system get secret | grep eks-admin | awk '{print $1}') --template={{.data.token}} | base64 -D | pbcopy</span></pre><p id="5cbd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.打开链接并粘贴令牌:</p><pre class="km kn ko kp gt oi lu oj ok aw ol bi"><span id="a809" class="nw lx iq lu b gy om on l oo op"><a class="ae lb" href="http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/#!/login" rel="noopener ugc nofollow" target="_blank">http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/#!/login</a></span></pre><h1 id="e737" class="lw lx iq bd ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt bi translated">特拉菲克</h1><p id="0da3" class="pw-post-body-paragraph jn jo iq jp b jq mu js jt ju mv jw jx jy ns ka kb kc nt ke kf kg nu ki kj kk ij bi translated">本指南将在高可用性(HA)中部署 Traefik v2，并使用<a class="ae lb" href="https://github.com/jetstack/cert-manager" rel="noopener ugc nofollow" target="_blank"> cert-manager </a>来生成和管理 TLS 证书。如果不需要 HA，您也可以选择使用 Traefik CRDs 来集成 Let's Encrypt。要深入了解该设置，请查看:</p><ul class=""><li id="f74e" class="ld le iq jp b jq jr ju jv jy lf kc lg kg lh kk li lj lk ll bi translated"><a class="ae lb" href="https://medium.com/dev-genius/setup-traefik-v2-for-ha-on-kubernetes-20311204fa6f" rel="noopener">在 Kubernetes 上为 HA 设置 Traefik v2</a></li><li id="d229" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk li lj lk ll bi translated"><a class="ae lb" href="https://medium.com/dev-genius/quickstart-with-traefik-v2-on-kubernetes-e6dff0d65216" rel="noopener">Kubernetes 上 Traefik v2 的快速入门</a></li></ul><p id="ec15" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，创建<code class="fe lr ls lt lu b">traefik</code>名称空间:</p><pre class="km kn ko kp gt oi lu oj ok aw ol bi"><span id="9115" class="nw lx iq lu b gy om on l oo op">$ kubectl create namespace traefik</span></pre><p id="a0e2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用 3 个副本部署 Traefik，并在 AWS 上使用 NLB:</p><pre class="km kn ko kp gt oi lu oj ok aw ol bi"><span id="09ec" class="nw lx iq lu b gy om on l oo op">$ helm repo add traefik https://containous.github.io/traefik-helm-chart</span><span id="d761" class="nw lx iq lu b gy ot on l oo op">$ helm install -n traefik traefik traefik/traefik -f traefik/traefik-values.yaml<!-- --> </span></pre><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="oq or l"/></div></figure><h1 id="c63f" class="lw lx iq bd ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt bi translated">证书管理器</h1><p id="437e" class="pw-post-body-paragraph jn jo iq jp b jq mu js jt ju mv jw jx jy ns ka kb kc nt ke kf kg nu ki kj kk ij bi translated">此示例使用 Cloudflare 来完成 DNS 挑战，但是可以随意使用任何其他<a class="ae lb" href="https://cert-manager.io/docs/configuration/acme/" rel="noopener ugc nofollow" target="_blank">支持的配置</a>来与 cert-manager/Let's Encrypt 一起工作。</p><p id="4672" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建<code class="fe lr ls lt lu b">cert-manager</code>名称空间:</p><pre class="km kn ko kp gt oi lu oj ok aw ol bi"><span id="61fb" class="nw lx iq lu b gy om on l oo op">$ kubectl create namespace cert-manager</span></pre><p id="2b43" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">部署证书管理器:</p><pre class="km kn ko kp gt oi lu oj ok aw ol bi"><span id="3ff6" class="nw lx iq lu b gy om on l oo op">$ helm repo add jetstack https://charts.jetstack.io</span><span id="c75b" class="nw lx iq lu b gy ot on l oo op">$ helm install \<br/>  cert-manager jetstack/cert-manager \<br/>  --namespace cert-manager \<br/>  --version v0.16.0 \<br/>  --set installCRDs=true</span></pre><p id="464c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">cert-manager 启动并运行后，使用 Cloudflare 创建一个颁发者。首先，创建一个具有区域-DNS-Edit、区域-区域-Read 权限的新 API 令牌，并将其作为一个秘密装载。配置适当的 DNS 区域，让我们加密电子邮件:</p><pre class="km kn ko kp gt oi lu oj ok aw ol bi"><span id="4070" class="nw lx iq lu b gy om on l oo op">$ kubectl create secret generic cloudflare-token --from-literal=dns-token=&lt;my-api-token&gt; -n cert-manager</span><span id="5813" class="nw lx iq lu b gy ot on l oo op">$ kubectl apply -f cert-manager/cluster-issuer.yaml<!-- --> </span></pre><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="oq or l"/></div></figure><p id="fe97" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在为该域创建一个通配符证书:</p><pre class="km kn ko kp gt oi lu oj ok aw ol bi"><span id="45f6" class="nw lx iq lu b gy om on l oo op">$ kubectl apply -f cert-manager/wildcard-cert.yaml<!-- --> </span></pre><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="oq or l"/></div></figure><p id="ae47" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">验证证书已经颁发:</p><pre class="km kn ko kp gt oi lu oj ok aw ol bi"><span id="974f" class="nw lx iq lu b gy om on l oo op">$ kubectl describe certificate wildcard-cert</span></pre><h1 id="98fe" class="lw lx iq bd ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt bi translated">身份提供者</h1><p id="365a" class="pw-post-body-paragraph jn jo iq jp b jq mu js jt ju mv jw jx jy ns ka kb kc nt ke kf kg nu ki kj kk ij bi translated">现在，我们需要配置一个身份提供者来确定用户访问。<a class="ae lb" href="https://www.pomerium.io/docs/identity-providers/" rel="noopener ugc nofollow" target="_blank"> Pomerium 支持</a> Azure AD、AWS Cognito、GitHub、GitLab、Google / GSuite、Okta、OneLogin。在这个例子中，我将使用 Google，但是根据您的提供商的需要进行配置:</p><ol class=""><li id="d4eb" class="ld le iq jp b jq jr ju jv jy lf kc lg kg lh kk os lj lk ll bi translated">登录谷歌云，进入<a class="ae lb" href="https://console.developers.google.com/projectselector/apis/credentials?pli=1" rel="noopener ugc nofollow" target="_blank">API&amp;服务</a>。选择一个项目来生成 OAuth 令牌。</li><li id="783d" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk os lj lk ll bi translated">点击左侧菜单上的<code class="fe lr ls lt lu b">Credentials</code>，点击<code class="fe lr ls lt lu b">Create credentials</code>-&gt;-T3</li><li id="0513" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk os lj lk ll bi translated">配置<code class="fe lr ls lt lu b">Consent Screen</code>，选择<code class="fe lr ls lt lu b">Internal</code>，设置支持邮箱</li><li id="e8c7" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk os lj lk ll bi translated">创建一个 OAuth 客户端 ID，将<code class="fe lr ls lt lu b">Web application</code>设置为应用程序类型</li><li id="f4b8" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk os lj lk ll bi translated">在<code class="fe lr ls lt lu b">Authorized redirect URIs</code>下输入以下内容:<code class="fe lr ls lt lu b">https://authenticate.&lt;my-domain&gt;/oauth2/callback</code>(用您为其生成通配符证书的域替换 my-domain)</li><li id="3088" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk os lj lk ll bi translated">点击<code class="fe lr ls lt lu b">Create</code>并记下<code class="fe lr ls lt lu b">client ID</code>和<code class="fe lr ls lt lu b">client secret</code></li></ol><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ou"><img src="../Images/aed34f28d2d7c424e43bc4a5af995ad5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*WMEz8MmRSni4mGMn.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">图片来源:<a class="ae lb" href="https://www.pomerium.io/docs/identity-providers/google.html" rel="noopener ugc nofollow" target="_blank">梨树</a></figcaption></figure><h1 id="e150" class="lw lx iq bd ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt bi translated">梨木属</h1><p id="1a41" class="pw-post-body-paragraph jn jo iq jp b jq mu js jt ju mv jw jx jy ns ka kb kc nt ke kf kg nu ki kj kk ij bi translated">最后，我们可以配置 Pomerium 作为 IAP 来访问 Kubernetes 仪表板。将上面的 clientID 和 clientSecret 添加到<code class="fe lr ls lt lu b">idp</code>部分。生成<code class="fe lr ls lt lu b">sharedSecret</code>和<code class="fe lr ls lt lu b">cookieSecret</code>:</p><pre class="km kn ko kp gt oi lu oj ok aw ol bi"><span id="3410" class="nw lx iq lu b gy om on l oo op">$(head -c32 /dev/urandom | base64)</span></pre><p id="ced7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将<code class="fe lr ls lt lu b">rootDomain</code>配置为我们为其生成通配符证书的域。值得注意的是，我们将<code class="fe lr ls lt lu b">generateTLS</code>设置为<strong class="jp ir">假</strong>并将<code class="fe lr ls lt lu b">insecure</code>设置为<strong class="jp ir">真</strong>，以允许 Traefik 进行 SSL 终止，并允许 Pomerium 接受 Kubernetes dashboard 的自签名证书。</p><p id="b1cc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将从第一步开始为访问 Kubernetes 仪表板而生成的 EKS 令牌添加到授权头中。更新值文件后，通过 Helm 部署 Pomerium:</p><pre class="km kn ko kp gt oi lu oj ok aw ol bi"><span id="92d1" class="nw lx iq lu b gy om on l oo op">$ helm repo add pomerium https://helm.pomerium.io</span><span id="b07d" class="nw lx iq lu b gy ot on l oo op">$ helm install pomerium pomerium/pomerium -f pomerium/pomerium-values.yaml</span></pre><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="oq or l"/></div></figure><h1 id="86df" class="lw lx iq bd ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt bi translated">DNS 设置</h1><p id="2494" class="pw-post-body-paragraph jn jo iq jp b jq mu js jt ju mv jw jx jy ns ka kb kc nt ke kf kg nu ki kj kk ij bi translated">Pomerium pods 运行并创建入口后，获取 Traefik 创建的 NLB 的 URL。将子域<code class="fe lr ls lt lu b">authenticate</code>的 CNAME 和用于仪表板的名称指向 NLB。</p><p id="4002" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，一旦您点击仪表板的 URL，您将被重定向到身份提供商的登录页面(在我们的例子中是 Google)。如果用户在我们的域中并成功登录，Pomerium 会将无记名令牌转发到仪表板，用户无需输入令牌就可以访问仪表板。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi ov"><img src="../Images/2eb2773df65fa772eafb6defe28c98c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*l7kmb5NO1qmm5vjnUdQx4A.gif"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">视频致谢:<a class="ae lb" href="https://www.pomerium.io/guides/kubernetes-dashboard.html#conclusion" rel="noopener ugc nofollow" target="_blank">梨木</a></figcaption></figure><p id="4d69" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以使用 Pomerium 来保护其他内部应用程序。根据使用案例，将 Pomerium 配置为 IAP 或 forward-auth 提供商，并为没有 VPN 的用户安全地公开内部工具。</p></div></div>    
</body>
</html>