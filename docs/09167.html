<html>
<head>
<title>How I Test My Big Data Pipeline In Apache Beam?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在 Apache Beam 中测试我的大数据管道？</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/how-i-test-my-big-data-pipeline-in-apache-beam-28d2f7e6d311?source=collection_archive---------7-----------------------#2022-08-03">https://blog.devgenius.io/how-i-test-my-big-data-pipeline-in-apache-beam-28d2f7e6d311?source=collection_archive---------7-----------------------#2022-08-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="7a98" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph">大数据工程之旅</h2><div class=""/><div class=""><h2 id="8cd8" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated">如何在 Apache Beam 中测试我的大数据管道？</h2></div><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/f927304cd4cf8a0073a8845e7b289ace.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*tRirEAHkh4ainoDF"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated"><a class="ae le" href="https://unsplash.com/@flowforfrank" rel="noopener ugc nofollow" target="_blank">un splash 上 Ferenc Almasi 的照片</a></figcaption></figure><h1 id="6ab6" class="lf lg iq bd lh li lj lk ll lm ln lo lp kf lq kg lr ki ls kj lt kl lu km lv lw bi translated">概观</h1><p id="d3e3" class="pw-post-body-paragraph lx ly iq lz b ma mb ka mc md me kd mf mg mh mi mj mk ml mm mn mo mp mq mr ms ij bi translated">在软件开发中，单元测试是一个重要的步骤，它使您的项目提高质量，并确保您的项目在部署产品之前没有任何错误，因此我们将其视为编程阶段的一部分。如果我们在编码中执行一个功能，我们还会通过对该功能使用单元测试来创建测试用例。在本文中，我将分享我如何在 Apache Beam 中为我的大数据工作编写单元测试。</p><h2 id="88eb" class="mt lg iq bd lh mu mv dn ll mw mx dp lp mg my mz lr mk na nb lt mo nc nd lv iw bi translated">针对单个转换的#1 测试</h2><p id="7ac1" class="pw-post-body-paragraph lx ly iq lz b ma mb ka mc md me kd mf mg mh mi mj mk ml mm mn mo mp mq mr ms ij bi translated">要测试一个单独的转换，您将一步一步地进行:</p><ul class=""><li id="981f" class="ne nf iq lz b ma ng md nh mg ni mk nj mo nk ms nl nm nn no bi translated">创建测试管道</li><li id="d3e0" class="ne nf iq lz b ma np md nq mg nr mk ns mo nt ms nl nm nn no bi translated">创建一些静态的测试输入数据</li><li id="908c" class="ne nf iq lz b ma np md nq mg nr mk ns mo nt ms nl nm nn no bi translated">创建转换</li><li id="44f2" class="ne nf iq lz b ma np md nq mg nr mk ns mo nt ms nl nm nn no bi translated">使用 PAssert 验证输出 PCollection 包含您期望的元素</li></ul><p id="f7ef" class="pw-post-body-paragraph lx ly iq lz b ma ng ka mc md nh kd mf mg nu mi mj mk nv mm mn mo nw mq mr ms ij bi translated"><strong class="lz ja">创建测试管道</strong></p><p id="2909" class="pw-post-body-paragraph lx ly iq lz b ma ng ka mc md nh kd mf mg nu mi mj mk nv mm mn mo nw mq mr ms ij bi translated">TestPipeline 是一个专门用于测试转换的 Apache Beam Java SDK 类。</p><p id="df2c" class="pw-post-body-paragraph lx ly iq lz b ma ng ka mc md nh kd mf mg nu mi mj mk nv mm mn mo nw mq mr ms ij bi translated">在创建管道对象时，我们使用 TestPipeline 来代替管道。与 Pipeline.create 不同，TestPipeline.create 在内部处理 PipelineOptions 的设置。</p><p id="73c3" class="pw-post-body-paragraph lx ly iq lz b ma ng ka mc md nh kd mf mg nu mi mj mk nv mm mn mo nw mq mr ms ij bi translated">参见测试管道示例:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nx ny l"/></div></figure><p id="3316" class="pw-post-body-paragraph lx ly iq lz b ma ng ka mc md nh kd mf mg nu mi mj mk nv mm mn mo nw mq mr ms ij bi translated"><strong class="lz ja">创建测试输入数据</strong></p><p id="07d2" class="pw-post-body-paragraph lx ly iq lz b ma ng ka mc md nh kd mf mg nu mi mj mk nv mm mn mo nw mq mr ms ij bi translated">请参见下面的代码:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nx ny l"/></div></figure><p id="4b13" class="pw-post-body-paragraph lx ly iq lz b ma ng ka mc md nh kd mf mg nu mi mj mk nv mm mn mo nw mq mr ms ij bi translated"><strong class="lz ja">创建变换</strong></p><p id="467f" class="pw-post-body-paragraph lx ly iq lz b ma ng ka mc md nh kd mf mg nu mi mj mk nv mm mn mo nw mq mr ms ij bi translated">我们通过从一个标准的内存集合类(比如 List)创建一个 PCollection 来创建输入转换。见下文:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nx ny l"/></div></figure><p id="f4da" class="pw-post-body-paragraph lx ly iq lz b ma ng ka mc md nh kd mf mg nu mi mj mk nv mm mn mo nw mq mr ms ij bi translated">之后，我们将转换应用于输入 PCollection，并保存结果输出 PCollection</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nx ny l"/></div></figure><p id="d1f3" class="pw-post-body-paragraph lx ly iq lz b ma ng ka mc md nh kd mf mg nu mi mj mk nv mm mn mo nw mq mr ms ij bi translated"><strong class="lz ja">路人</strong></p><p id="2bd5" class="pw-post-body-paragraph lx ly iq lz b ma ng ka mc md nh kd mf mg nu mi mj mk nv mm mn mo nw mq mr ms ij bi translated">PAssert 是 Apache Beam Java SDK 中包含的一个类，它是对 PCollection 内容的断言。我们使用 PAssert 来验证包含一组特定预期元素的 PCollection。</p><p id="da4c" class="pw-post-body-paragraph lx ly iq lz b ma ng ka mc md nh kd mf mg nu mi mj mk nv mm mn mo nw mq mr ms ij bi translated">以下 Java 代码示例使用 PAssert 类来检查正确的输出形式:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nx ny l"/></div></figure><p id="5866" class="pw-post-body-paragraph lx ly iq lz b ma ng ka mc md nh kd mf mg nu mi mj mk nv mm mn mo nw mq mr ms ij bi translated">以下代码显示了测试转换的完整测试:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nx ny l"/></div></figure><h2 id="a36c" class="mt lg iq bd lh mu mv dn ll mw mx dp lp mg my mz lr mk na nb lt mo nc nd lv iw bi translated">#2 复合转换测试</h2><p id="c102" class="pw-post-body-paragraph lx ly iq lz b ma mb ka mc md me kd mf mg mh mi mj mk ml mm mn mo mp mq mr ms ij bi translated">我们使用测试复合转换，以防我们代码中的转换可以具有嵌套结构(就嵌套类而言)，其中一个复杂的转换执行多个较简单的转换(例如多个 ParDo、Combine 或者甚至其他复合转换)。这些转换称为复合转换。在单个复合转换中嵌套多个转换可以使代码更加模块化，更容易理解。</p><p id="8636" class="pw-post-body-paragraph lx ly iq lz b ma ng ka mc md nh kd mf mg nu mi mj mk nv mm mn mo nw mq mr ms ij bi translated">以下代码显示了复合转换的完整测试:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nx ny l"/></div></figure><p id="a268" class="pw-post-body-paragraph lx ly iq lz b ma ng ka mc md nh kd mf mg nu mi mj mk nv mm mn mo nw mq mr ms ij bi translated">正如您在上面看到的，代码适用于“<strong class="lz ja"> SumNumbers </strong>”转换子类，它由一个名为“<strong class="lz ja"> SumInts </strong>”子类的嵌套转换组成。在嵌套 transform " <strong class="lz ja"> SumInts </strong>"子类<strong class="lz ja">，</strong>中，我们覆盖了"<strong class="lz ja"> apply </strong>方法来实现实际的处理逻辑。</p><p id="431e" class="pw-post-body-paragraph lx ly iq lz b ma ng ka mc md nh kd mf mg nu mi mj mk nv mm mn mo nw mq mr ms ij bi translated">就通过上面的例子创建复合转换而言，我们可以认为"<strong class="lz ja"> Combine </strong>"本身就是一个复合转换；"<strong class="lz ja"> SumNumbers </strong>和"<strong class="lz ja"> SumInts </strong>"也是嵌套的复合转换。</p><h2 id="098f" class="mt lg iq bd lh mu mv dn ll mw mx dp lp mg my mz lr mk na nb lt mo nc nd lv iw bi translated">#3 整个管道的测试</h2><p id="2205" class="pw-post-body-paragraph lx ly iq lz b ma mb ka mc md me kd mf mg mh mi mj mk ml mm mn mo mp mq mr ms ij bi translated">测试整个管道被称为端到端测试。在上面的例子中，我们从静态输入数据创建了两个 p collection，然后使用 PAssert 来验证管道生成的两个 p collection 的内容是否与静态输出数据中的预期值相匹配。</p><p id="d576" class="pw-post-body-paragraph lx ly iq lz b ma ng ka mc md nh kd mf mg nu mi mj mk nv mm mn mo nw mq mr ms ij bi translated">下面的代码显示了一个测试整个转换的完整测试:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nx ny l"/></div></figure><h1 id="9372" class="lf lg iq bd lh li lj lk ll lm ln lo lp kf lq kg lr ki ls kj lt kl lu km lv lw bi translated">摘要</h1><p id="0139" class="pw-post-body-paragraph lx ly iq lz b ma mb ka mc md me kd mf mg mh mi mj mk ml mm mn mo mp mq mr ms ij bi translated">本文向您介绍了如何在 Apache Beam 中运行单元测试的方法，并帮助您在使用 Apache Beam 时快速实现这一实践。</p><h1 id="7cb7" class="lf lg iq bd lh li lj lk ll lm ln lo lp kf lq kg lr ki ls kj lt kl lu km lv lw bi translated">参考</h1><ul class=""><li id="6d2d" class="ne nf iq lz b ma mb md me mg nz mk oa mo ob ms nl nm nn no bi translated"><a class="ae le" href="https://beam.apache.org/documentation/pipelines/test-your-pipeline/#testing-transforms" rel="noopener ugc nofollow" target="_blank">测试您的管道(apache.org)</a></li><li id="23ee" class="ne nf iq lz b ma np md nq mg nr mk ns mo nt ms nl nm nn no bi translated"><a class="ae le" href="https://cloud.google.com/architecture/building-production-ready-data-pipelines-using-dataflow-developing-and-testing#unit_tests" rel="noopener ugc nofollow" target="_blank">使用数据流构建生产就绪数据管道:开发和测试数据管道|云架构中心|谷歌云</a></li></ul></div></div>    
</body>
</html>