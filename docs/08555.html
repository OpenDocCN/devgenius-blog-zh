<html>
<head>
<title>From Zero to Production in less than a day</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">不到一天的时间从零到生产</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/from-zero-to-production-in-less-than-a-day-f4e16f628f15?source=collection_archive---------16-----------------------#2022-06-23">https://blog.devgenius.io/from-zero-to-production-in-less-than-a-day-f4e16f628f15?source=collection_archive---------16-----------------------#2022-06-23</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="013d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在 Media Distillery，我们充分利用微服务范式。我们的每一款产品都由大量微服务提供支持，这些微服务提供的功能包括(语义)搜索、数据存储、仪表盘、EPG 校正、人脸识别、人脸聚类、文本识别、缩略图选择、主题检测、主题分割等等。</p><p id="cc18" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们平台中的微服务可以分为两组:Java 服务和 Python 服务。后者满足了我们大部分的 ML 需求；也是本文的重点。我们将回顾如何创建一个新的 Python 服务，这样的服务看起来像什么，以及我们使用哪些工具和技术来创建和部署它。</p><h1 id="d4fa" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">一个普通的 Python 服务</h1><p id="1928" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">在最简单的情况下，我们产品背后的管道被分成两个服务:一个 Java 服务和一个 Python 服务。前者负责集群、负载平衡、数据存储等等。后者托管相关的机器学习模型，负责通过模型传递输入(如图像或一段文本)以及输入和输出的预处理和后处理。Java 和 Python 服务通过简单的 HTTP REST API 进行通信。</p><p id="a8f3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">由于这种设置，我们可以利用 Java 环境的成熟性和稳定性，同时给予 ML 方灵活性和自由度，以跟上快速变化和缓慢成熟的 Python 环境的发展。</p><h1 id="8616" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">工具工具工具！(和技术)</h1><p id="3598" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">为了创建和维护 Python 服务，我们使用了大量开源工具。为了简单起见，我们将我们使用的工具分为两组:一方面，我们有用于创建服务的工具，另一方面，我们有用于将服务放到我们的平台上的工具。</p><figure class="lm ln lo lp gt lq gh gi paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="gh gi ll"><img src="../Images/e987687755ec1459b3ca4f439411c196.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SN2hRUlAgB37vYzvI3295Q.png"/></div></div></figure><h1 id="e5c6" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">创建服务</h1><h2 id="efe6" class="lx kj in bd kk ly lz dn ko ma mb dp ks jv mc md kw jz me mf la kd mg mh le mi bi translated">FastAPI</h2><p id="ad21" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">对于我们的 HTTP REST 框架，我们使用 FastAPI。这个框架在最近几年越来越受欢迎，当我们在寻找替代品时，FastAPI 似乎是一个很好的替代品。引起我们注意的主要是框架的高性能，但整体特性集和设计理念也在我们的列表中得分很高。</p><p id="3b00" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">FastAPI 是一个最佳的候选，但是我们还没有充分利用框架的异步方面。</p><h2 id="11f9" class="lx kj in bd kk ly lz dn ko ma mb dp ks jv mc md kw jz me mf la kd mg mh le mi bi translated">棉花糖/花生糖</h2><p id="f6f2" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">对于数据序列化和验证，我们多年来主要使用棉花糖，没有任何抱怨。事实证明，它不仅提高了我们服务的整体质量，还提高了我们的原型制作、评估和其他调查的质量。尽管它是一个很棒的图书馆，但我们最近一直在考虑转向 Pydantic。仅仅因为 FastAPI 支持开箱即用的 Pydantic 模型(而不是棉花糖)。</p><h2 id="36fd" class="lx kj in bd kk ly lz dn ko ma mb dp ks jv mc md kw jz me mf la kd mg mh le mi bi translated">YAML</h2><p id="00b4" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">出于配置目的，我们使用 YAML 文件。这并不太令人兴奋，但是它与另一个在部署阶段发挥作用的配置工具相关联。</p><h2 id="6c74" class="lx kj in bd kk ly lz dn ko ma mb dp ks jv mc md kw jz me mf la kd mg mh le mi bi translated">诗意</h2><p id="6db4" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">与 FastAPI 类似，这个 setup.py 的替代品近年来越来越受欢迎。虽然 setup.py 和 setuptools 对我们来说工作得很好，但它们慢慢变得过时了，是时候让我们开始寻找一个新的依赖和包管理工具了。最后，我们选定了诗歌，我们发现诗歌非常容易使用，而且由于社区的活跃，它还在不断改进。</p><h2 id="85cb" class="lx kj in bd kk ly lz dn ko ma mb dp ks jv mc md kw jz me mf la kd mg mh le mi bi translated">Pytest</h2><p id="ba83" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">自然，我们也需要对代码进行单元测试。为此，我们使用 Pytest，它似乎是 Python 中单元测试的事实上的标准。</p><h2 id="93e0" class="lx kj in bd kk ly lz dn ko ma mb dp ks jv mc md kw jz me mf la kd mg mh le mi bi translated">关系</h2><p id="98dd" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">因为我们需要构建大量的内部 Python 库，所以将它们存储在一个共享位置是非常合理的。为此，我们使用 Nexus，它提供了现成的 PyPI 存储库。它也用于 Maven 仓库，很好地与我们的 Java 和 Python 服务保持一致。</p><h2 id="93ce" class="lx kj in bd kk ly lz dn ko ma mb dp ks jv mc md kw jz me mf la kd mg mh le mi bi translated">黑色</h2><p id="c65e" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">黑色是我们工具列表中最近的一个条目。过去我们没有使用代码格式化程序，但是对它们的需求一直在增长。最近发布了第一个稳定版本的 Black 正在慢慢成为 Python 代码格式化的标准。到目前为止，我们的第一印象很好，将来我们可能会更经常地使用它。</p><h1 id="1e52" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">部署服务</h1><h2 id="3c44" class="lx kj in bd kk ly lz dn ko ma mb dp ks jv mc md kw jz me mf la kd mg mh le mi bi translated">库伯内特斯</h2><p id="9147" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">我们所有的服务都作为容器部署到 Kubernetes 的本地安装中。主要是我们后端部门管理。</p><h2 id="73ee" class="lx kj in bd kk ly lz dn ko ma mb dp ks jv mc md kw jz me mf la kd mg mh le mi bi translated">码头工人</h2><p id="5b4f" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">为了创建可部署的容器，我们使用 Docker。对于 ML 服务的每个新版本，我们创建一个新的 docker 映像来公开 API。</p><h2 id="45ff" class="lx kj in bd kk ly lz dn ko ma mb dp ks jv mc md kw jz me mf la kd mg mh le mi bi translated">舵</h2><p id="40f0" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">Helm 本质上是 Kubernetes 之上的一个层，用于简化服务的部署和管理。对于每个服务，除了封装服务的 Docker 映像之外，还需要创建一个新的 Helm“chart ”,它定义了 Docker 映像应该如何部署在 Kubernetes 上。</p><h2 id="0232" class="lx kj in bd kk ly lz dn ko ma mb dp ks jv mc md kw jz me mf la kd mg mh le mi bi translated">詹金斯</h2><p id="0d1d" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">Jenkins 提供了一种自动化任意开发任务的方法。对于 ML 服务，我们定义了各种自动化管道来构建，例如，服务快照和发布新版本。这些管道不仅加快了我们的开发时间，还简化了不同团队和产品之间的协作。</p><h2 id="3e9a" class="lx kj in bd kk ly lz dn ko ma mb dp ks jv mc md kw jz me mf la kd mg mh le mi bi translated">春季云配置</h2><p id="f2f9" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">如前所述，我们使用 YAML 文件进行配置。为了使服务易于配置，最好不要将它们的配置文件打包成 Docker 映像的一部分，而是将它们托管在一个单独的位置。为了实现这一点，我们使用 Spring Cloud Config，这是一个连接到托管我们所有配置文件的 Git 存储库的服务，使它们可以通过 HTTP REST API 轻松访问。</p><h2 id="82ff" class="lx kj in bd kk ly lz dn ko ma mb dp ks jv mc md kw jz me mf la kd mg mh le mi bi translated">普罗米修斯</h2><p id="32a4" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">为了创建我们正在运行的服务的状态的可见性，我们需要公开该服务的度量并监控它们。为了达到这个目的，我们使用了普罗米修斯。在每个服务中使用 Prometheus 客户端创建和公开指标。这是通过一个单独的 Prometheus 服务器完成的，该服务器从所有客户端服务中提取这些指标。Prometheus 服务器也会根据这些指标配置警报。</p><h2 id="2687" class="lx kj in bd kk ly lz dn ko ma mb dp ks jv mc md kw jz me mf la kd mg mh le mi bi translated">格拉夫纳</h2><p id="b59d" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">Grafana 是普罗米修斯之上的一层，允许我们创建更好的普罗米修斯度量可视化仪表板。</p><h1 id="adf9" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">把这一切联系在一起</h1><p id="add8" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">所有这些工具都很棒，但最终，最重要的是它们如何形成一个成熟的服务。为了帮助实现这一目标，我们创建了一个服务模板。</p><h2 id="ec87" class="lx kj in bd kk ly lz dn ko ma mb dp ks jv mc md kw jz me mf la kd mg mh le mi bi translated">我们的方法</h2><p id="bd98" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">在相当长的一段时间里，每当我们需要构建一些新的服务时，我们要么从头开始，要么复制一个现有的服务。虽然后者可能是一个节省时间的选择，但经常发生的情况是，一个给定的复制服务落后于当前的标准，转移到新的服务并产生更多的技术债务。此外，由于我们在多个团队中工作，每个团队负责采用不同标准的不同服务。这最终会导致团队之间更多的偏差，并从整体上降低我们服务的可维护性。</p><p id="47d9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">为了解决这些问题，我们创建了一个服务模板，改编自现有的<a class="ae mj" href="https://github.com/4OH4/kubernetes-fastapi" rel="noopener ugc nofollow" target="_blank"> FastAPI 模板</a>。本质上只不过是一个包含形成适当服务的文件结构的文件夹；使用正确的工具。如果我们想引入一些新工具，可以将它们添加到服务模板中，以确保所有新服务始终符合当前标准。</p><h2 id="1afc" class="lx kj in bd kk ly lz dn ko ma mb dp ks jv mc md kw jz me mf la kd mg mh le mi bi translated">回馈社会</h2><p id="7e04" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">服务模板给了我们很大的帮助，加快了开发速度，提高了代码库的整体质量和一致性。</p><p id="dfaf" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">由于我们使用了许多开源工具，我们希望通过开源我们的服务模板来回馈社区。无论您是对直接使用该模板感兴趣，还是仅仅想了解更多关于产品级 Python 服务的信息，我们都希望该模板对您和我们一样有用。</p><p id="74c3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">服务模板可在<a class="ae mj" href="https://github.com/mediadistillery/ExampleTemplateService" rel="noopener ugc nofollow" target="_blank"> Github </a>上获得。您可以简单地复制模板，调整命名并实现新的逻辑。</p><h2 id="45a0" class="lx kj in bd kk ly lz dn ko ma mb dp ks jv mc md kw jz me mf la kd mg mh le mi bi translated">结束语</h2><p id="0721" class="pw-post-body-paragraph jk jl in jm b jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd lk kf kg kh ig bi translated">在本文中，我们回顾了用于 Python 服务的工具以及将它们联系在一起的服务模板。虽然它对我们来说非常有效，但我们一直在寻找如何进一步改进的方法。例如，服务模板不能追溯工作，这意味着对现有服务应用新标准仍然需要手动完成。</p><p id="58b8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们最近还着眼于提高我们的测试标准，例如纳入测试自动化工具，如 Tox 或 Nox。在 ML 方面，我们最近从像 NVIDIA Triton 这样的推理服务器的使用中受益匪浅，这可能会极大地影响我们的服务模板的外观。</p><p id="b57d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">总而言之，我们看到有几个方面需要进一步研究和改进，所以请关注我们关于技术改进和补充的出版物。</p><p id="5f61" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">以下是工具 GitHub 页面的链接:</p><ul class=""><li id="ec19" class="mk ml in jm b jn jo jr js jv mm jz mn kd mo kh mp mq mr ms bi translated"><a class="ae mj" href="https://github.com/tiangolo/fastapi" rel="noopener ugc nofollow" target="_blank"> FastAPI </a></li><li id="4bc4" class="mk ml in jm b jn mt jr mu jv mv jz mw kd mx kh mp mq mr ms bi translated"><a class="ae mj" href="https://github.com/marshmallow-code/marshmallow" rel="noopener ugc nofollow" target="_blank">棉花糖</a></li><li id="ad99" class="mk ml in jm b jn mt jr mu jv mv jz mw kd mx kh mp mq mr ms bi translated"><a class="ae mj" href="https://github.com/samuelcolvin/pydantic" rel="noopener ugc nofollow" target="_blank"> Pydantic </a></li><li id="70e1" class="mk ml in jm b jn mt jr mu jv mv jz mw kd mx kh mp mq mr ms bi translated"><a class="ae mj" href="https://github.com/yaml/pyyaml" rel="noopener ugc nofollow" target="_blank"> Yaml </a></li><li id="257f" class="mk ml in jm b jn mt jr mu jv mv jz mw kd mx kh mp mq mr ms bi translated"><a class="ae mj" href="https://github.com/python-poetry/poetry" rel="noopener ugc nofollow" target="_blank">诗歌</a></li><li id="a23b" class="mk ml in jm b jn mt jr mu jv mv jz mw kd mx kh mp mq mr ms bi translated"><a class="ae mj" href="https://github.com/pytest-dev/pytest" rel="noopener ugc nofollow" target="_blank"> Pytest </a></li><li id="f24a" class="mk ml in jm b jn mt jr mu jv mv jz mw kd mx kh mp mq mr ms bi translated"><a class="ae mj" href="https://github.com/sonatype/nexus-public" rel="noopener ugc nofollow" target="_blank">联系</a></li><li id="0ac7" class="mk ml in jm b jn mt jr mu jv mv jz mw kd mx kh mp mq mr ms bi translated"><a class="ae mj" href="https://github.com/psf/black" rel="noopener ugc nofollow" target="_blank">黑色</a></li><li id="f9a6" class="mk ml in jm b jn mt jr mu jv mv jz mw kd mx kh mp mq mr ms bi translated"><a class="ae mj" href="https://github.com/kubernetes/kubernetes" rel="noopener ugc nofollow" target="_blank"> Kubernetes </a></li><li id="ace8" class="mk ml in jm b jn mt jr mu jv mv jz mw kd mx kh mp mq mr ms bi translated"><a class="ae mj" href="https://github.com/docker/cli" rel="noopener ugc nofollow" target="_blank">码头工人</a></li><li id="1615" class="mk ml in jm b jn mt jr mu jv mv jz mw kd mx kh mp mq mr ms bi translated"><a class="ae mj" href="https://github.com/helm/helm" rel="noopener ugc nofollow" target="_blank">掌舵人</a></li><li id="f9bb" class="mk ml in jm b jn mt jr mu jv mv jz mw kd mx kh mp mq mr ms bi translated">詹金斯</li><li id="84f5" class="mk ml in jm b jn mt jr mu jv mv jz mw kd mx kh mp mq mr ms bi translated">春天的云</li><li id="51be" class="mk ml in jm b jn mt jr mu jv mv jz mw kd mx kh mp mq mr ms bi translated"><a class="ae mj" href="https://github.com/prometheus/prometheus" rel="noopener ugc nofollow" target="_blank">普罗米修斯</a></li><li id="aa65" class="mk ml in jm b jn mt jr mu jv mv jz mw kd mx kh mp mq mr ms bi translated"><a class="ae mj" href="https://github.com/grafana/grafana" rel="noopener ugc nofollow" target="_blank">格拉夫纳</a></li><li id="3dbc" class="mk ml in jm b jn mt jr mu jv mv jz mw kd mx kh mp mq mr ms bi translated"><a class="ae mj" href="https://github.com/mediadistillery/ExampleTemplateService" rel="noopener ugc nofollow" target="_blank">示例 _ 模板 _ 服务</a></li><li id="db37" class="mk ml in jm b jn mt jr mu jv mv jz mw kd mx kh mp mq mr ms bi translated"><a class="ae mj" href="https://github.com/4OH4/kubernetes-fastapi" rel="noopener ugc nofollow" target="_blank">原始服务模板</a></li></ul></div></div>    
</body>
</html>