<html>
<head>
<title>Automating Your Monthly Azure Cloud Cost Reports</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">自动化您的每月 Azure 云成本报告</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/automating-your-monthly-azure-cloud-cost-spends-a51257a6564f?source=collection_archive---------9-----------------------#2022-01-25">https://blog.devgenius.io/automating-your-monthly-azure-cloud-cost-spends-a51257a6564f?source=collection_archive---------9-----------------------#2022-01-25</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="dd71" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这篇博客是我们从零开始讨论<strong class="jm io">云</strong>概念的系列文章的一部分，面向的是入门知识有限的读者。这篇文章属于<em class="ki">中级</em>系列，因为它涉及到理解<a class="ae kj" href="https://docs.microsoft.com/en-us/azure/cost-management-billing/cost-management-billing-overview" rel="noopener ugc nofollow" target="_blank"> <strong class="jm io"> Azure 成本管理</strong> </a>的工作以及自动化月度支出报告。</p><p id="f22c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">云系列中的一些早期博客如下。</p><p id="705c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><a class="ae kj" rel="noopener ugc nofollow" target="_blank" href="/gcp-big-query-writing-my-first-python-connector-1140b022b88a"> <strong class="jm io"> GCP 大查询第一 Python 连接器</strong></a><strong class="jm io"><br/></strong><a class="ae kj" href="https://medium.com/r?url=https%3A%2F%2Fblog.devgenius.io%2Fcustom-docker-bridge-networks-how-to-run-containers-b8d40c51bab2" rel="noopener"><strong class="jm io">AWS-安全-自动化</strong></a><strong class="jm io"><br/></strong><a class="ae kj" rel="noopener ugc nofollow" target="_blank" href="/custom-docker-bridge-networks-how-to-run-containers-b8d40c51bab2"><strong class="jm io">自定义 Docker 桥接网络</strong> </a></p><h1 id="daf9" class="kk kl in bd km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh bi translated">成本管理—概述</h1><p id="0cfc" class="pw-post-body-paragraph jk jl in jm b jn li jp jq jr lj jt ju jv lk jx jy jz ll kb kc kd lm kf kg kh ig bi translated">随着空间与业务需求成比例增加，云部署不断增长的一个关键因素是优化云资源利用率的需求。未跟踪的每月 Azure 云部署订阅对长期预算计划和组织范围的卓越运营都是潜在的风险。因此，使用<em class="ki">成本警报</em>和<em class="ki"> Copex 仪表板</em>来跟踪每月支出是至关重要的，以便通过自动化管道<em class="ki"> Azure 默认仪表板</em>或<em class="ki">定制聚合仪表板</em>来跟踪基于资源利用率的异常值，从而获得长期收益。</p><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="gh gi ln"><img src="../Images/eb3dfc8a1796a77cd00bf8a42b1b78be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZvfsLoe-5ymmmhyAJs0_Sw.png"/></div></div></figure><h1 id="9c25" class="kk kl in bd km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh bi translated">关键成本指标</h1><ul class=""><li id="f7cb" class="lz ma in jm b jn li jr lj jv mb jz mc kd md kh me mf mg mh bi translated"><strong class="jm io">总预算- </strong>给定时间段内给定项目的总预算云成本。</li><li id="0041" class="lz ma in jm b jn mi jr mj jv mk jz ml kd mm kh me mf mg mh bi translated"><strong class="jm io">总消耗- </strong>给定项目在给定年份的总消耗云成本。</li><li id="d9f2" class="lz ma in jm b jn mi jr mj jv mk jz ml kd mm kh me mf mg mh bi translated"><strong class="jm io">成本利用率- </strong>给定年度实际支出与预算值的比率。小于&lt; 1 的比率被认为是健康的。</li><li id="b210" class="lz ma in jm b jn mi jr mj jv mk jz ml kd mm kh me mf mg mh bi translated"><strong class="jm io">超支概率- </strong>对于给定项目是否会超出其给定年度的云支出，回答是或否。如果<em class="ki">(到目前为止的总消耗+上个完成月的消耗率*剩余月数&gt;总预算)</em>，该值将为真</li></ul><h1 id="6d13" class="kk kl in bd km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh bi translated">创建一个简单的 Azure 成本模块</h1><p id="2ce4" class="pw-post-body-paragraph jk jl in jm b jn li jp jq jr lj jt ju jv lk jx jy jz ll kb kc kd lm kf kg kh ig bi translated">Azure 提供了不同的自动化 SDK，可以用来在我们选择的编程语言中创建模块。对于成本管理自动化，这两种方法都可以使用-</p><p id="dbfe" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我)<strong class="jm io">蔚蓝 Cli-</strong>https://docs.microsoft.com/en-us/cli/azure/costmanagement?<a class="ae kj" href="https://docs.microsoft.com/en-us/cli/azure/costmanagement?view=azure-cli-latest" rel="noopener ugc nofollow" target="_blank">view = Azure-CLI-最新</a> <br/> ii) <strong class="jm io">成本管理模块-</strong><a class="ae kj" href="https://pypi.org/project/azure-mgmt-costmanagement/" rel="noopener ugc nofollow" target="_blank">https://pypi.org/project/azure-mgmt-costmanagement/</a><br/>iii)<strong class="jm io">Azure Management Rest API—</strong><a class="ae kj" href="https://docs.microsoft.com/en-us/rest/api/cost-management/" rel="noopener ugc nofollow" target="_blank">https://docs.microsoft.com/en-us/rest/api/cost-management/</a></p><p id="8abd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">出于这个博客的目的，我们将使用上面的第三个选项。</p><h2 id="bc67" class="mn kl in bd km mo mp dn kq mq mr dp ku jv ms mt ky jz mu mv lc kd mw mx lg my bi translated">用 Python 创建 Rest 客户端</h2><p id="7918" class="pw-post-body-paragraph jk jl in jm b jn li jp jq jr lj jt ju jv lk jx jy jz ll kb kc kd lm kf kg kh ig bi translated">这个类构建在 python 请求模块之上，提供了简单的静态方法，可以根据功能对 Azure 管理 API 进行<strong class="jm io"> GET </strong>或<strong class="jm io"> POST </strong>调用。</p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="mz na l"/></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated"><strong class="ak"> Rest 客户端类</strong></figcaption></figure><h2 id="93ab" class="mn kl in bd km mo mp dn kq mq mr dp ku jv ms mt ky jz mu mv lc kd mw mx lg my bi translated">一个简单的认证模块。</h2><p id="6d9e" class="pw-post-body-paragraph jk jl in jm b jn li jp jq jr lj jt ju jv lk jx jy jz ll kb kc kd lm kf kg kh ig bi translated">要调用任何 Azure 管理 API，必须将令牌作为授权承载请求头传递给实际的 API。为此，必须对以下 URL 发出一个<strong class="jm io"> GET </strong>调用，请求体如下所示-<a class="ae kj" href="https://login.microsoftonline.com/8f12c261-6dbf-47c3-918f-1d15198a3b3b/oauth2/token" rel="noopener ugc nofollow" target="_blank"><em class="ki">https://log in . Microsoft online . com/8f12c 261–6 DBF-47c 3–918 f-1d 15198 a3b3b/oauth 2/token</em></a></p><p id="42e0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">要在 Azure AD 中创建客户端，可以使用以下步骤—<a class="ae kj" href="https://docs.microsoft.com/en-us/azure/active-directory/develop/howto-create-service-principal-portal" rel="noopener ugc nofollow" target="_blank">https://docs . Microsoft . com/en-us/Azure/active-directory/develop/how to-create-service-principal-portal</a></p><p id="f121" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">代码片段</strong></p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="mz na l"/></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated"><strong class="ak">为 Azure AD 令牌生成请求正文</strong></figcaption></figure><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="mz na l"/></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated"><strong class="ak">生成不记名令牌的样本代码</strong></figcaption></figure><h2 id="342f" class="mn kl in bd km mo mp dn kq mq mr dp ku jv ms mt ky jz mu mv lc kd mw mx lg my bi translated">配置使用模块</h2><p id="746f" class="pw-post-body-paragraph jk jl in jm b jn li jp jq jr lj jt ju jv lk jx jy jz ll kb kc kd lm kf kg kh ig bi translated">Azure 提供的<a class="ae kj" href="https://docs.microsoft.com/en-us/rest/api/cost-management/query/usage" rel="noopener ugc nofollow" target="_blank"> <strong class="jm io">查询用法</strong> </a> <strong class="jm io"> </strong> API 是一个 POST 调用，允许查询不同范围的资源，根据客户需求，可以是<em class="ki">资源组/资源，也可以是订阅级别</em>。主体后的有效载荷主要包括定义成本数据粒度的细节、资源的聚合/分组，以便为报告的成本数据提供更好的维度。</p><p id="7757" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">代码片段</strong></p><figure class="lo lp lq lr gt ls"><div class="bz fp l di"><div class="mz na l"/></div></figure><h1 id="3ba3" class="kk kl in bd km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh bi translated">默认 Azure 成本仪表板</h1><p id="c724" class="pw-post-body-paragraph jk jl in jm b jn li jp jq jr lj jt ju jv lk jx jy jz ll kb kc kd lm kf kg kh ig bi translated">对于没有上述定制需求的团队，可以使用默认的 Azure 成本仪表板。要访问默认仪表盘，请访问链接<a class="ae kj" href="https://portal.azure.com/#blade/Microsoft_Azure_GTM/ModernBillingMenuBlade/BillingAccounts" rel="noopener ugc nofollow" target="_blank">https://portal . Azure . com/# blade/Microsoft _ Azure _ GTM/modernbilling menu blade/billing accounts</a>，点击左侧导航上的<strong class="jm io">成本管理选项</strong>，并选择<strong class="jm io">成本分析</strong>选项。</p><figure class="lo lp lq lr gt ls gh gi paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="gh gi nf"><img src="../Images/bc1d0a8356d01ad344063559d4c45ab3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yF9kvDa3ecxBkZcmPWuBvQ.png"/></div></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated"><strong class="bd km">默认 Azure 计费仪表板</strong></figcaption></figure><h1 id="535d" class="kk kl in bd km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh bi translated">额外资源</h1><div class="ng nh gp gr ni nj"><a href="https://github.com/amit894/copex-dashboards" rel="noopener  ugc nofollow" target="_blank"><div class="nk ab fo"><div class="nl ab nm cl cj nn"><h2 class="bd io gy z fp no fr fs np fu fw im bi translated">GitHub-Amit 894/copex-Dashboards:跟踪 AWS/Azure/GCP 成本的仪表板</h2><div class="nq l"><h3 class="bd b gy z fp no fr fs np fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="nr l"><p class="bd b dl z fp no fr fs np fu fw dk translated">github.com</p></div></div><div class="ns l"><div class="nt l nu nv nw ns nx lx nj"/></div></div></a></div><p id="d265" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><em class="ki">如需反馈，请留言至</em><strong class="jm io"><em class="ki">Amit[dot]894[at]Gmail[dot]com</em></strong><em class="ki">或联系</em><a class="ae kj" href="https://about.me/amit_raj" rel="noopener ugc nofollow" target="_blank"><em class="ki">https://about.me/amit_raj</em></a><em class="ki">的任何链接。</em></p></div></div>    
</body>
</html>