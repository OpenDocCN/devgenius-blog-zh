<html>
<head>
<title>Testing a React Application Integrating MSW with Vitest</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">测试集成 MSW 和 Vitest 的 React 应用程序</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/testing-a-react-application-integrating-msw-with-vitest-a9542defb1c0?source=collection_archive---------8-----------------------#2022-05-04">https://blog.devgenius.io/testing-a-react-application-integrating-msw-with-vitest-a9542defb1c0?source=collection_archive---------8-----------------------#2022-05-04</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/50a01d76843269fc4ff67bb690fbd3d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8HNDuK18-uBU_t_I"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated"><a class="ae jz" href="https://unsplash.com/@jeriden94?utm_source=Hashnode&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">杰瑞登·维尔加斯</a>在<a class="ae jz" href="https://unsplash.com/?utm_source=Hashnode&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="8ca4" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这是我正在进行的关于如何测试现代 React 应用程序的系列文章的第五部分。这次我将介绍如何将 MSW 与我们的单元测试框架<a class="ae jz" href="https://vitest.dev/" rel="noopener ugc nofollow" target="_blank"> Vitest </a>集成。大多数应用程序必须从后端服务器获取数据。为了全面覆盖，我们应该模拟这些请求。但是，什么是嘲讽呢？</p><blockquote class="ky kz la"><p id="8a9b" class="ka kb lb kc b kd ke kf kg kh ki kj kk lc km kn ko ld kq kr ks le ku kv kw kx ig bi translated">制作某物的复制品或仿制品</p></blockquote><p id="00e7" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><em class="lb">牛津语言</em></p><p id="2984" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这个想法是创建一个来自后端的请求的模拟。这有其自身的优势。我们可以直接操纵我们想要的<em class="lb">响应</em>来测试更多的场景。在我们之前创建的应用程序中，我们可以测试获取 0 个帖子、100 个帖子、没有文本的帖子等等。</p><p id="b2fe" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">有问题的应用程序:</p><figure class="lg lh li lj gt jo gh gi paragraph-image"><div class="gh gi lf"><img src="../Images/147915a826d554820536636fb95e051b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1186/0*kwUHXqfJRYhBc240.gif"/></div></figure><p id="2e2b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这个很厉害！我们可以测试用户可能遇到的常见用例或边缘用例。最后，最重要的是对我们的测试有信心。</p><h1 id="46a5" class="lk ll in bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">什么是都市固体废物？</h1><p id="004f" class="pw-post-body-paragraph ka kb in kc b kd mi kf kg kh mj kj kk kl mk kn ko kp ml kr ks kt mm kv kw kx ig bi translated">MSW 是一个非常简单易用的模仿库。</p><blockquote class="ky kz la"><p id="9ef7" class="ka kb lb kc b kd ke kf kg kh ki kj kk lc km kn ko ld kq kr ks le ku kv kw kx ig bi translated"><em class="in">通过在网络层面拦截请求来模仿。无缝重用相同的模拟定义进行测试、开发和调试。</em></p></blockquote><p id="e84a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">通常，这是预期的交互:</p><figure class="lg lh li lj gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mn"><img src="../Images/45bb88a973981bc5864b7eafbdebeffd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*VE7DUUsmMhr1awzk.png"/></div></div></figure><p id="1b3d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">但是，随着城市固体废物的增加，我们将增加一个新的步骤。</p><figure class="lg lh li lj gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mo"><img src="../Images/955e03dc13462983f4debb45c9e3421b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*OcOSrAD4zb9bz22p.png"/></div></div></figure><p id="175e" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">厉害！😎让我们用我们的应用程序来设置这个。作为参考<a class="ae jz" href="https://github.com/diballesteros/react-testing" rel="noopener ugc nofollow" target="_blank">这是我们到目前为止一直在使用的项目</a>。</p><h1 id="0462" class="lk ll in bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">MSW 的配置文件</h1><p id="44c0" class="pw-post-body-paragraph ka kb in kc b kd mi kf kg kh mj kj kk kl mk kn ko kp ml kr ks kt mm kv kw kx ig bi translated">首先，让我们安装新的库:</p><pre class="lg lh li lj gt mp mq mr ms aw mt bi"><span id="8afe" class="mu ll in mq b gy mv mw l mx my">npm install msw --save-dev yarn add msw --dev</span></pre><p id="c54d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在我们的<code class="fe mz na nb mq b">src</code>目录中，让我们创建一个<code class="fe mz na nb mq b">mocks</code>文件夹，我们将在其中保存请求的处理程序。MSW 团队称之为<em class="lb">模拟定义</em>。在<code class="fe mz na nb mq b">mocks</code>文件夹中创建一个<code class="fe mz na nb mq b">handlers.js</code>。</p><p id="e2ca" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这里我们可以导出我们的处理函数。因为我们正在做正常的 REST 请求，所以让我们从 MSW 导入<code class="fe mz na nb mq b">rest</code>。</p><pre class="lg lh li lj gt mp mq mr ms aw mt bi"><span id="aad6" class="mu ll in mq b gy mv mw l mx my">import { rest } from 'msw';</span></pre><p id="54da" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">为了让 MSW 识别请求，我们必须提供准确的<em class="lb">方法</em>和<em class="lb">路径</em>并从数组中导出。</p><pre class="lg lh li lj gt mp mq mr ms aw mt bi"><span id="82d5" class="mu ll in mq b gy mv mw l mx my">export const handlers = [<br/>    rest.get('https://jsonplaceholder.typicode.com/posts', null), <br/>];</span></pre><p id="d652" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这里我们可以用我们实际希望 MSW 返回给我们的内容来替换<code class="fe mz na nb mq b">null</code>。这是一个被称为<em class="lb">响应解析器</em>的功能。返回以下内容:</p><ul class=""><li id="8f95" class="nc nd in kc b kd ke kh ki kl ne kp nf kt ng kx nh ni nj nk bi translated"><code class="fe mz na nb mq b">req</code>，关于匹配请求的信息；</li><li id="f2f0" class="nc nd in kc b kd nl kh nm kl nn kp no kt np kx nh ni nj nk bi translated"><code class="fe mz na nb mq b">res</code>，一个功能性的效用创造出了嘲弄的反应；</li><li id="177b" class="nc nd in kc b kd nl kh nm kl nn kp no kt np kx nh ni nj nk bi translated"><code class="fe mz na nb mq b">ctx</code>，帮助设置状态码、标题、正文等的一组功能。嘲笑的回应。</li></ul><p id="66a1" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">让我们为这些帖子返回我们自己的自定义响应。</p><pre class="lg lh li lj gt mp mq mr ms aw mt bi"><span id="8b59" class="mu ll in mq b gy mv mw l mx my">import { rest } from 'msw';</span><span id="31a7" class="mu ll in mq b gy nq mw l mx my">export const handlers = [<br/> rest.get('<a class="ae jz" href="https://jsonplaceholder.typicode.com/posts'" rel="noopener ugc nofollow" target="_blank">https://jsonplaceholder.typicode.com/posts'</a>, (req, res, ctx) =&gt; {<br/>  return res(<br/>   ctx.status(200),<br/>   ctx.json([<br/>    {<br/>     body: 'This is a body',<br/>     id: 1,<br/>     title: 'Title',<br/>     userId: 1,<br/>    },<br/>   ])<br/>  );<br/> }),<br/>];</span></pre><p id="1f2d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">太好了，现在我们已经为 MSW 设置了处理程序🚀。</p><h1 id="2d02" class="lk ll in bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">Vitest 的配置文件</h1><p id="9920" class="pw-post-body-paragraph ka kb in kc b kd mi kf kg kh mj kj kk kl mk kn ko kp ml kr ks kt mm kv kw kx ig bi translated">MSW 为我们设置了一个服务器来拦截请求。但是我们必须创建一个服务器实例。在我们的<code class="fe mz na nb mq b">mocks</code>文件夹中创建一个<code class="fe mz na nb mq b">server.js</code>文件:</p><pre class="lg lh li lj gt mp mq mr ms aw mt bi"><span id="01a7" class="mu ll in mq b gy mv mw l mx my">import { setupServer } from 'msw/node';<br/>import { handlers } from './handlers';</span><span id="02ad" class="mu ll in mq b gy nq mw l mx my">// Here we import the handler created!<br/>export const server = setupServer(...handlers);</span></pre><p id="d41b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在我们的<code class="fe mz na nb mq b">vite.config.js</code>中，让我们在<code class="fe mz na nb mq b">test</code>对象中为我们的设置文件添加一个条目:</p><pre class="lg lh li lj gt mp mq mr ms aw mt bi"><span id="4c5a" class="mu ll in mq b gy mv mw l mx my">setupFiles: ['./src/setup.js'],</span></pre><p id="d98c" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">让我们在我们的<code class="fe mz na nb mq b">src</code>目录中创建这个<code class="fe mz na nb mq b">setup.js</code>文件。这是为了在每次测试执行时正确重置服务器:</p><pre class="lg lh li lj gt mp mq mr ms aw mt bi"><span id="536e" class="mu ll in mq b gy mv mw l mx my">import { server } from './mocks/server';</span><span id="2b2a" class="mu ll in mq b gy nq mw l mx my">beforeAll(() =&gt; server.listen({ onUnhandledRequest: 'error' }));<br/>afterAll(() =&gt; server.close());<br/>afterEach(() =&gt; server.resetHandlers());</span></pre><p id="93ae" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在我们都设置好了，准备测试！让我们在**Vitest **测试中实现它。</p><h1 id="947f" class="lk ll in bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">在 Vitest 中模仿我们的 API 请求</h1><p id="29b3" class="pw-post-body-paragraph ka kb in kc b kd mi kf kg kh mj kj kk kl mk kn ko kp ml kr ks kt mm kv kw kx ig bi translated">让我们修改我们的测试文件:</p><pre class="lg lh li lj gt mp mq mr ms aw mt bi"><span id="9327" class="mu ll in mq b gy mv mw l mx my">import React from 'react';<br/>import {<br/> render,<br/> screen,<br/> waitForElementToBeRemoved,<br/>} from '<a class="ae jz" href="http://twitter.com/testing" rel="noopener ugc nofollow" target="_blank">@testing</a>-library/react';<br/>import userEvent from '<a class="ae jz" href="http://twitter.com/testing" rel="noopener ugc nofollow" target="_blank">@testing</a>-library/user-event';<br/>import App from './App';</span><span id="2c0c" class="mu ll in mq b gy nq mw l mx my">describe('Testing our React application', () =&gt; {<br/> it('Fetch posts', async () =&gt; {<br/>  render(&lt;App /&gt;);</span><span id="a1ce" class="mu ll in mq b gy nq mw l mx my">expect(screen.getByText(/Modern React Testing/i)).toBeDefined();</span><span id="5f9a" class="mu ll in mq b gy nq mw l mx my">userEvent.click(screen.getByRole('button', { name: 'Fetch Posts' }));</span><span id="45e8" class="mu ll in mq b gy nq mw l mx my">await waitForElementToBeRemoved(() =&gt;<br/>   screen.queryByLabelText('loading')<br/>  );</span><span id="b015" class="mu ll in mq b gy nq mw l mx my">expect(screen.getByRole('heading', { level: 3 })).toBeDefined();<br/> });<br/>});</span></pre><p id="c8d7" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们移除了<code class="fe mz na nb mq b">@testing-library/jest-dom</code>的库，因为它不再需要。但是，现在我们的测试应该是绿色通过！</p><figure class="lg lh li lj gt jo gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/4757b7480f48b9593ac215676024e9cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:742/format:webp/0*AcIlWcqVjPoqvGIO.png"/></div></figure><p id="6f21" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">此外，由于我们的测试是在一个节点环境中运行的，我们需要在原来的<code class="fe mz na nb mq b">App.jsx</code>中填充我们的 fetch 函数</p><pre class="lg lh li lj gt mp mq mr ms aw mt bi"><span id="4270" class="mu ll in mq b gy mv mw l mx my">npm install cross-fetch</span></pre><p id="1221" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">只需在最顶端导入它:</p><pre class="lg lh li lj gt mp mq mr ms aw mt bi"><span id="aff7" class="mu ll in mq b gy mv mw l mx my">import fetch from 'cross-fetch';</span></pre><h1 id="10a5" class="lk ll in bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">旁注</h1><p id="068c" class="pw-post-body-paragraph ka kb in kc b kd mi kf kg kh mj kj kk kl mk kn ko kp ml kr ks kt mm kv kw kx ig bi translated">如果您一直关注我的其他文章，您可能已经注意到我更改了一个依赖项的版本:<code class="fe mz na nb mq b">@testing-library/user-event</code>。我在点击按钮时遇到了一个问题。</p><p id="b1f4" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我把它降级到 13.5.0，直接从<code class="fe mz na nb mq b">userEvent</code>调用 click 事件。</p><p id="3b71" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">您可以在这个<a class="ae jz" href="https://github.com/diballesteros/react-testing" rel="noopener ugc nofollow" target="_blank">存储库中找到整个项目以及更新后的依赖关系列表</a>。</p><h1 id="dbcf" class="lk ll in bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">包装它</h1><p id="7e47" class="pw-post-body-paragraph ka kb in kc b kd mi kf kg kh mj kj kk kl mk kn ko kp ml kr ks kt mm kv kw kx ig bi translated">随着我们继续创建单元测试，我们现在有了一个强大的工具来模拟请求！在下一篇文章中，我们将讨论如何设置 Cypress.io。</p><p id="a5af" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">更多内容见<a class="ae jz" href="https://relatablecode.com" rel="noopener ugc nofollow" target="_blank">相关代码</a></p><p id="8cf1" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如果你喜欢这个，请随时在 LinkedIn 或 Twitter 上与我联系</p><p id="2c80" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在我的<a class="ae jz" href="https://relatablecode.substack.com/" rel="noopener ugc nofollow" target="_blank">时事通讯</a>中查看我的免费开发者路线图和每周科技行业新闻。</p></div><div class="ab cl ns nt hr nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="ig ih ii ij ik"><p id="2760" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><em class="lb">原载于 2022 年 5 月 4 日</em><a class="ae jz" href="https://relatablecode.com/testing-a-react-application-integrating-msw-with-vitest" rel="noopener ugc nofollow" target="_blank"><em class="lb">【https://relatablecode.com】</em></a><em class="lb">。</em></p></div></div>    
</body>
</html>