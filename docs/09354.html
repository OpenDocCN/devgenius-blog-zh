<html>
<head>
<title>MongoDB Sharded Cluster on Ubuntu</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Ubuntu 上的 MongoDB 分片集群</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/mongodb-sharded-cluster-on-ubuntu-7522f20c9c6d?source=collection_archive---------3-----------------------#2022-08-16">https://blog.devgenius.io/mongodb-sharded-cluster-on-ubuntu-7522f20c9c6d?source=collection_archive---------3-----------------------#2022-08-16</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="f33c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在这篇博客中，我将解释 MongoDB 分片集群。</p><h1 id="e1a1" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">那么，什么是 MongoDB 呢？</h1><figure class="lh li lj lk gt ll gh gi paragraph-image"><div class="gh gi lg"><img src="../Images/dc5b2b5ee8c479b382123382388df4d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1024/format:webp/0*G75OfVQ_-xixqYN_.png"/></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated"><a class="ae ls" href="https://www.mongodb.com/" rel="noopener ugc nofollow" target="_blank">https://www.mongodb.com/</a></figcaption></figure><p id="66ed" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">MongoDB 是一个开源的<a class="ae ls" href="https://en.wikipedia.org/wiki/Cross-platform" rel="noopener ugc nofollow" target="_blank">跨平台</a> <a class="ae ls" href="https://en.wikipedia.org/wiki/Document-oriented_database" rel="noopener ugc nofollow" target="_blank">面向文档的数据库</a>程序。被归类为一个<a class="ae ls" href="https://en.wikipedia.org/wiki/NoSQL" rel="noopener ugc nofollow" target="_blank"> NoSQL </a>数据库程序，MongoDB 使用带有可选模式的<a class="ae ls" href="https://en.wikipedia.org/wiki/JSON" rel="noopener ugc nofollow" target="_blank"> JSON </a>类文档。</p><h1 id="5499" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">什么是 MongoDB 分片，我们什么时候必须使用？</h1><p id="6f7d" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">随着时间的推移，你在 Mongodb 中的数据会开始大量增长。当你在大数据上查询时，你会观察到它使用了大量的 CPU。要消除这个问题，需要使用 MongoDB 分片。</p><h1 id="bcaf" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">MongoDB 分片集群架构</h1><figure class="lh li lj lk gt ll gh gi paragraph-image"><div class="gh gi ly"><img src="../Images/6139e0bf89502b348fc5d4ed4f72bedb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1358/format:webp/1*R7PAEZBeLUMg3a1XiP9fEA.png"/></div></figure><p id="be1a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在 MongoDB 中，分片集群包括:</p><ul class=""><li id="da57" class="lz ma in jm b jn jo jr js jv mb jz mc kd md kh me mf mg mh bi translated">陶瓷或玻璃碎片</li><li id="bdfa" class="lz ma in jm b jn mi jr mj jv mk jz ml kd mm kh me mf mg mh bi translated">蒙哥斯</li><li id="7fb1" class="lz ma in jm b jn mi jr mj jv mk jz ml kd mm kh me mf mg mh bi translated">配置服务器</li></ul><p id="f6c1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">碎片是包含集群数据子集的副本集。</p><p id="8c56" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">mongos 充当客户端应用程序的查询路由器，处理读写操作。它将客户端请求分派给相关的碎片，并将碎片的结果聚合成一致的客户端响应。</p><blockquote class="mn mo mp"><p id="3233" class="jk jl mq jm b jn jo jp jq jr js jt ju mr jw jx jy ms ka kb kc mt ke kf kg kh ig bi translated">注意:客户端连接到 mongos，而不是单独的碎片。</p></blockquote><p id="398f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">配置服务器是分片元数据的权威来源。分片元数据反映了分片数据的状态和组织。元数据包含分片集合列表、路由信息等。</p><h1 id="ae2f" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">让我们使用 Ubuntu 开始部署 MongoDb 分片集群</h1><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi mu"><img src="../Images/6f16bce8bcc2a7568b23442ca58a8680.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*J7rF7KJ0wNlyfnkk-JHNZg.png"/></div></div></figure><p id="ece9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在这次试验中，我将使用 3 台服务器:</p><ul class=""><li id="f69c" class="lz ma in jm b jn jo jr js jv mb jz mc kd md kh me mf mg mh bi">127.0.0.1</li><li id="e266" class="lz ma in jm b jn mi jr mj jv mk jz ml kd mm kh me mf mg mh bi">127.0.0.2</li><li id="01af" class="lz ma in jm b jn mi jr mj jv mk jz ml kd mm kh me mf mg mh bi">127.0.0.3</li></ul><p id="71eb" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在每台服务器上安装 MongoDB:</p><div class="mz na gp gr nb nc"><a href="https://www.mongodb.com/docs/v4.4/tutorial/install-mongodb-on-ubuntu/" rel="noopener  ugc nofollow" target="_blank"><div class="nd ab fo"><div class="ne ab nf cl cj ng"><h2 class="bd io gy z fp nh fr fs ni fu fw im bi translated">在 Ubuntu 上安装 MongoDB 社区版</h2><div class="nj l"><h3 class="bd b gy z fp nh fr fs ni fu fw dk translated">MongoDB Atlas 是一个托管在云中的 MongoDB 服务选项，不需要安装开销，并提供免费的…</h3></div><div class="nk l"><p class="bd b dl z fp nh fr fs ni fu fw dk translated">www.mongodb.com</p></div></div><div class="nl l"><div class="nm l nn no np nl nq lm nc"/></div></div></a></div><p id="98dd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><a class="ae ls" href="https://hevodata.com/learn/mongodb-sharding/#steps" rel="noopener ugc nofollow" target="_blank">设置 MongoDB 分片的步骤</a></p><ul class=""><li id="53af" class="lz ma in jm b jn jo jr js jv mb jz mc kd md kh me mf mg mh bi translated"><em class="mq">第一步:配置 MongoDB 配置服务器</em></li><li id="4d00" class="lz ma in jm b jn mi jr mj jv mk jz ml kd mm kh me mf mg mh bi translated"><em class="mq">第二步:MongoDB 分片服务器的配置</em></li><li id="bee9" class="lz ma in jm b jn mi jr mj jv mk jz ml kd mm kh me mf mg mh bi translated"><em class="mq">步骤 MongoDB 查询路由器(Mongos)的配置</em></li></ul><h1 id="5029" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">MongoDB 配置服务器集群的配置</h1><p id="052f" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">对所有服务器重复这些步骤</p><h2 id="c7b0" class="nr kj in bd kk ns nt dn ko nu nv dp ks jv nw nx kw jz ny nz la kd oa ob le oc bi translated">1-转到/var/lib/mongodb 并运行下面的命令:</h2><blockquote class="mn mo mp"><p id="cdfa" class="jk jl mq jm b jn jo jp jq jr js jt ju mr jw jx jy ms ka kb kc mt ke kf kg kh ig bi translated">sudo mkdirmongoConfigServer</p></blockquote><h2 id="9e4c" class="nr kj in bd kk ns nt dn ko nu nv dp ks jv nw nx kw jz ny nz la kd oa ob le oc bi translated">2-转到/var/log/mongodb 并运行下面的命令:</h2><blockquote class="mn mo mp"><p id="1356" class="jk jl mq jm b jn jo jp jq jr js jt ju mr jw jx jy ms ka kb kc mt ke kf kg kh ig bi translated"><em class="in">sudo touch</em>mongoconfigserver . log</p></blockquote><h2 id="2fde" class="nr kj in bd kk ns nt dn ko nu nv dp ks jv nw nx kw jz ny nz la kd oa ob le oc bi translated">3-转到/etc/systemd/system 并运行下面的命令:</h2><blockquote class="mn mo mp"><p id="2c00" class="jk jl mq jm b jn jo jp jq jr js jt ju mr jw jx jy ms ka kb kc mt ke kf kg kh ig bi translated"><em class="in">sudo nano mongoconfigserver . service</em></p></blockquote><pre class="lh li lj lk gt od oe of og aw oh bi"><span id="3b74" class="nr kj in oe b gy oi oj l ok ol">[Unit]<br/>Description=MongoDB Database Server<br/>Documentation=<a class="ae ls" href="https://docs.mongodb.org/manual" rel="noopener ugc nofollow" target="_blank">https://docs.mongodb.org/manual</a><br/>After=network-online.target<br/>Wants=network-online.target</span><span id="1099" class="nr kj in oe b gy om oj l ok ol">[Service]<br/>User=mongodb<br/>Group=mongodb<br/>EnvironmentFile=-/etc/default/mongod<br/>ExecStart=/usr/bin/mongod --config /etc/<em class="mq">mongoConfigServer</em>.conf<br/>PIDFile=/var/run/mongodb/mongod.pid<br/># file size<br/>LimitFSIZE=infinity<br/># cpu time<br/>LimitCPU=infinity<br/># virtual memory size<br/>LimitAS=infinity<br/># open files<br/>LimitNOFILE=64000<br/># processes/threads<br/>LimitNPROC=64000<br/># locked memory<br/>LimitMEMLOCK=infinity<br/># total threads (user+kernel)<br/>TasksMax=infinity<br/>TasksAccounting=false</span><span id="ed32" class="nr kj in oe b gy om oj l ok ol"># Recommended limits for mongod as specified in<br/># <a class="ae ls" href="https://docs.mongodb.com/manual/reference/ulimit/#recommended-ulimit-settings" rel="noopener ugc nofollow" target="_blank">https://docs.mongodb.com/manual/reference/ulimit/#recommended-ulimit-settings</a></span><span id="6bd7" class="nr kj in oe b gy om oj l ok ol">[Install]<br/>WantedBy=multi-user.target</span></pre><h2 id="e574" class="nr kj in bd kk ns nt dn ko nu nv dp ks jv nw nx kw jz ny nz la kd oa ob le oc bi translated">4-转到/etc 并运行下面的命令:</h2><blockquote class="mn mo mp"><p id="d79b" class="jk jl mq jm b jn jo jp jq jr js jt ju mr jw jx jy ms ka kb kc mt ke kf kg kh ig bi translated"><em class="in">$ sudo nano/etc/mongoconfigserver . conf</em></p></blockquote><pre class="lh li lj lk gt od oe of og aw oh bi"><span id="2fad" class="nr kj in oe b gy oi oj l ok ol">storage:<br/>  dbPath: /var/lib/mongodb/mongoConfigServer<br/>  journal:<br/>    enabled: true<br/>#  engine:<br/>#  mmapv1:<br/>#  wiredTiger:<br/># where to write logging data.</span><span id="6ee7" class="nr kj in oe b gy om oj l ok ol">systemLog:<br/>  destination: file<br/>  logAppend: true<br/>  path: /var/log/mongodb/mongoConfigServer.log</span><span id="daff" class="nr kj in oe b gy om oj l ok ol"># network interfaces<br/>net:<br/>  port: 27018 #same on all server<br/>  bindIp: 127.0.0.1  <strong class="oe io"><em class="mq">#NOTE: Change Ip</em></strong><br/>     <br/>#write ip of server<br/># how the process runs</span><span id="3b1c" class="nr kj in oe b gy om oj l ok ol">processManagement:<br/>  timeZoneInfo: /usr/share/zoneinfo<br/>#security:<br/>#operationProfiling:<br/>replication:<br/>  replSetName: repl</span><span id="8fdf" class="nr kj in oe b gy om oj l ok ol">sharding:<br/>  clusterRole: configsvr</span></pre><h2 id="15d5" class="nr kj in bd kk ns nt dn ko nu nv dp ks jv nw nx kw jz ny nz la kd oa ob le oc bi translated">5-在所有 mongoDB 服务器上重新启动 mongoConfigServer 服务。</h2><blockquote class="mn mo mp"><p id="0386" class="jk jl mq jm b jn jo jp jq jr js jt ju mr jw jx jy ms ka kb kc mt ke kf kg kh ig bi translated"><em class="in"> $ sudo systemctl 重启 mongoConfigServer </em></p></blockquote><h2 id="1247" class="nr kj in bd kk ns nt dn ko nu nv dp ks jv nw nx kw jz ny nz la kd oa ob le oc bi translated">6-连接到 mongo</h2><blockquote class="mn mo mp"><p id="1510" class="jk jl mq jm b jn jo jp jq jr js jt ju mr jw jx jy ms ka kb kc mt ke kf kg kh ig bi translated">【172.0.0.1:27018 T2】$蒙戈</p></blockquote><p id="880f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">是时候发出集群配置服务器集的命令了。这意味着，MongoDB 配置服务器是集群化的，共享主要和次要成员。在这里，您可以使用与上面定义的相同的副本集名称。</p><pre class="lh li lj lk gt od oe of og aw oh bi"><span id="3035" class="nr kj in oe b gy oi oj l ok ol">rs.initiate(<br/>{<br/>_id: "repl",<br/>configsvr: true,<br/>members: [<br/>{ _id : 0, host : "127.0.0.1:27018" },<br/>{ _id : 1, host : "127.0.0.2:27018" },<br/>{ _id : 2, host : "127.0.0.3:27018" }]<br/>}<br/>)</span></pre><p id="6d63" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">注:执行此 6。只踩 1 台服务器</strong></p><h1 id="089e" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">MongoDB 分片服务器的配置</h1><p id="f3b0" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">对所有服务器重复这些步骤</p><h2 id="cbb1" class="nr kj in bd kk ns nt dn ko nu nv dp ks jv nw nx kw jz ny nz la kd oa ob le oc bi translated">1-转到/var/lib/mongodb 并运行下面的命令:</h2><blockquote class="mn mo mp"><p id="c206" class="jk jl mq jm b jn jo jp jq jr js jt ju mr jw jx jy ms ka kb kc mt ke kf kg kh ig bi translated">sudo mkdirmongoshard 01 mongoshard 02 mongoshard 03</p></blockquote><h2 id="9186" class="nr kj in bd kk ns nt dn ko nu nv dp ks jv nw nx kw jz ny nz la kd oa ob le oc bi translated">2-转到/var/log/mongodb 并运行下面的命令:</h2><blockquote class="mn mo mp"><p id="08e0" class="jk jl mq jm b jn jo jp jq jr js jt ju mr jw jx jy ms ka kb kc mt ke kf kg kh ig bi translated"><em class="in">sudo touch</em>mongoshard 01 . log mongoshard 02 . log mongoshard 03 . log</p></blockquote><h2 id="e528" class="nr kj in bd kk ns nt dn ko nu nv dp ks jv nw nx kw jz ny nz la kd oa ob le oc bi translated">3-转到/etc/systemd/system 并运行下面的命令:</h2><blockquote class="mn mo mp"><p id="cadc" class="jk jl mq jm b jn jo jp jq jr js jt ju mr jw jx jy ms ka kb kc mt ke kf kg kh ig bi translated"><em class="in">须藤纳米</em> mongoShard01.service</p></blockquote><pre class="lh li lj lk gt od oe of og aw oh bi"><span id="9cbd" class="nr kj in oe b gy oi oj l ok ol">[Unit]<br/>Description=MongoDB Database Server<br/>Documentation=<a class="ae ls" href="https://docs.mongodb.org/manual" rel="noopener ugc nofollow" target="_blank">https://docs.mongodb.org/manual</a><br/>After=network-online.target<br/>Wants=network-online.target</span><span id="8764" class="nr kj in oe b gy om oj l ok ol">[Service]<br/>User=mongodb<br/>Group=mongodb<br/>EnvironmentFile=-/etc/default/mongod<br/>ExecStart=/usr/bin/mongod --config /etc/<em class="mq">mongoShard01</em>.conf<br/>PIDFile=/var/run/mongodb/mongod.pid<br/># file size<br/>LimitFSIZE=infinity<br/># cpu time<br/>LimitCPU=infinity<br/># virtual memory size<br/>LimitAS=infinity<br/># open files<br/>LimitNOFILE=64000<br/># processes/threads<br/>LimitNPROC=64000<br/># locked memory<br/>LimitMEMLOCK=infinity<br/># total threads (user+kernel)<br/>TasksMax=infinity<br/>TasksAccounting=false</span><span id="aefa" class="nr kj in oe b gy om oj l ok ol"># Recommended limits for mongod as specified in<br/># <a class="ae ls" href="https://docs.mongodb.com/manual/reference/ulimit/#recommended-ulimit-settings" rel="noopener ugc nofollow" target="_blank">https://docs.mongodb.com/manual/reference/ulimit/#recommended-ulimit-settings</a></span><span id="5d9e" class="nr kj in oe b gy om oj l ok ol">[Install]<br/>WantedBy=multi-user.target</span></pre><blockquote class="mn mo mp"><p id="21c6" class="jk jl mq jm b jn jo jp jq jr js jt ju mr jw jx jy ms ka kb kc mt ke kf kg kh ig bi translated">sudo nano mongoshard 02 . service</p></blockquote><pre class="lh li lj lk gt od oe of og aw oh bi"><span id="bb57" class="nr kj in oe b gy oi oj l ok ol">[Unit]<br/>Description=MongoDB Database Server<br/>Documentation=<a class="ae ls" href="https://docs.mongodb.org/manual" rel="noopener ugc nofollow" target="_blank">https://docs.mongodb.org/manual</a><br/>After=network-online.target<br/>Wants=network-online.target</span><span id="1ffa" class="nr kj in oe b gy om oj l ok ol">[Service]<br/>User=mongodb<br/>Group=mongodb<br/>EnvironmentFile=-/etc/default/mongod<br/>ExecStart=/usr/bin/mongod --config /etc/<em class="mq">mongoShard02</em>.conf<br/>PIDFile=/var/run/mongodb/mongod.pid<br/># file size<br/>LimitFSIZE=infinity<br/># cpu time<br/>LimitCPU=infinity<br/># virtual memory size<br/>LimitAS=infinity<br/># open files<br/>LimitNOFILE=64000<br/># processes/threads<br/>LimitNPROC=64000<br/># locked memory<br/>LimitMEMLOCK=infinity<br/># total threads (user+kernel)<br/>TasksMax=infinity<br/>TasksAccounting=false</span><span id="433e" class="nr kj in oe b gy om oj l ok ol"># Recommended limits for mongod as specified in<br/># <a class="ae ls" href="https://docs.mongodb.com/manual/reference/ulimit/#recommended-ulimit-settings" rel="noopener ugc nofollow" target="_blank">https://docs.mongodb.com/manual/reference/ulimit/#recommended-ulimit-settings</a></span><span id="34a7" class="nr kj in oe b gy om oj l ok ol">[Install]<br/>WantedBy=multi-user.target</span></pre><blockquote class="mn mo mp"><p id="a138" class="jk jl mq jm b jn jo jp jq jr js jt ju mr jw jx jy ms ka kb kc mt ke kf kg kh ig bi translated">sudo nano mongoshard 03 . service</p></blockquote><pre class="lh li lj lk gt od oe of og aw oh bi"><span id="4d60" class="nr kj in oe b gy oi oj l ok ol">[Unit]<br/>Description=MongoDB Database Server<br/>Documentation=<a class="ae ls" href="https://docs.mongodb.org/manual" rel="noopener ugc nofollow" target="_blank">https://docs.mongodb.org/manual</a><br/>After=network-online.target<br/>Wants=network-online.target</span><span id="817e" class="nr kj in oe b gy om oj l ok ol">[Service]<br/>User=mongodb<br/>Group=mongodb<br/>EnvironmentFile=-/etc/default/mongod<br/>ExecStart=/usr/bin/mongod --config /etc/<em class="mq">mongoShard03</em>.conf<br/>PIDFile=/var/run/mongodb/mongod.pid<br/># file size<br/>LimitFSIZE=infinity<br/># cpu time<br/>LimitCPU=infinity<br/># virtual memory size<br/>LimitAS=infinity<br/># open files<br/>LimitNOFILE=64000<br/># processes/threads<br/>LimitNPROC=64000<br/># locked memory<br/>LimitMEMLOCK=infinity<br/># total threads (user+kernel)<br/>TasksMax=infinity<br/>TasksAccounting=false</span><span id="685e" class="nr kj in oe b gy om oj l ok ol"># Recommended limits for mongod as specified in<br/># <a class="ae ls" href="https://docs.mongodb.com/manual/reference/ulimit/#recommended-ulimit-settings" rel="noopener ugc nofollow" target="_blank">https://docs.mongodb.com/manual/reference/ulimit/#recommended-ulimit-settings</a></span><span id="a11b" class="nr kj in oe b gy om oj l ok ol">[Install]<br/>WantedBy=multi-user.target</span></pre><h2 id="3c70" class="nr kj in bd kk ns nt dn ko nu nv dp ks jv nw nx kw jz ny nz la kd oa ob le oc bi translated">4-转到/etc 并运行下面的命令:</h2><blockquote class="mn mo mp"><p id="9de2" class="jk jl mq jm b jn jo jp jq jr js jt ju mr jw jx jy ms ka kb kc mt ke kf kg kh ig bi translated"><em class="in">$ sudo nano/etc/mongoshard 01 . conf</em></p></blockquote><pre class="lh li lj lk gt od oe of og aw oh bi"><span id="8701" class="nr kj in oe b gy oi oj l ok ol">storage:<br/>  dbPath: /var/lib/mongodb/mongoShard01<br/>  journal:<br/>    enabled: true<br/>#  engine:<br/>#  mmapv1:<br/>#  wiredTiger:<br/># where to write logging data.</span><span id="f48c" class="nr kj in oe b gy om oj l ok ol">systemLog:<br/>  destination: file<br/>  logAppend: true<br/>  path: /var/log/mongodb/mongoShard01.log</span><span id="1977" class="nr kj in oe b gy om oj l ok ol"># network interfaces<br/>net:<br/>  port: 27019 #same on all server<br/>  bindIp: 127.0.0.1  <strong class="oe io"><em class="mq">#NOTE: Change Ip</em></strong><br/>     <br/># how the process runs</span><span id="7ecd" class="nr kj in oe b gy om oj l ok ol">processManagement:<br/>  timeZoneInfo: /usr/share/zoneinfo<br/>#security:<br/>#operationProfiling:<br/>replication:<br/>  replSetName: shardreplica01</span><span id="486d" class="nr kj in oe b gy om oj l ok ol">sharding:<br/>  clusterRole: shardsvr</span></pre><blockquote class="mn mo mp"><p id="4536" class="jk jl mq jm b jn jo jp jq jr js jt ju mr jw jx jy ms ka kb kc mt ke kf kg kh ig bi translated"><em class="in">$ sudo nano/etc/mongoshard 02 . conf</em></p></blockquote><pre class="lh li lj lk gt od oe of og aw oh bi"><span id="0edc" class="nr kj in oe b gy oi oj l ok ol">storage:<br/>  dbPath: /var/lib/mongodb/mongoShard02<br/>  journal:<br/>    enabled: true<br/>#  engine:<br/>#  mmapv1:<br/>#  wiredTiger:<br/># where to write logging data.</span><span id="eb62" class="nr kj in oe b gy om oj l ok ol">systemLog:<br/>  destination: file<br/>  logAppend: true<br/>  path: /var/log/mongodb/mongoShard02.log</span><span id="6444" class="nr kj in oe b gy om oj l ok ol"># network interfaces<br/>net:<br/>  port: 27020 #same on all server<br/>  bindIp: 127.0.0.1  <strong class="oe io"><em class="mq">#NOTE: Change Ip</em></strong><br/>     <br/>#write ip of server<br/># how the process runs</span><span id="acb3" class="nr kj in oe b gy om oj l ok ol">processManagement:<br/>  timeZoneInfo: /usr/share/zoneinfo<br/>#security:<br/>#operationProfiling:<br/>replication:<br/>  replSetName: shardreplica02</span><span id="3ed2" class="nr kj in oe b gy om oj l ok ol">sharding:<br/>  clusterRole: shardsvr</span></pre><blockquote class="mn mo mp"><p id="c7b6" class="jk jl mq jm b jn jo jp jq jr js jt ju mr jw jx jy ms ka kb kc mt ke kf kg kh ig bi translated"><em class="in">$ sudo nano/etc/mongoshard 03 . conf</em></p></blockquote><pre class="lh li lj lk gt od oe of og aw oh bi"><span id="4e0d" class="nr kj in oe b gy oi oj l ok ol">storage:<br/>  dbPath: /var/lib/mongodb/mongoShard03<br/>  journal:<br/>    enabled: true<br/>#  engine:<br/>#  mmapv1:<br/>#  wiredTiger:<br/># where to write logging data.</span><span id="700f" class="nr kj in oe b gy om oj l ok ol">systemLog:<br/>  destination: file<br/>  logAppend: true<br/>  path: /var/log/mongodb/mongoShard03.log</span><span id="1c9f" class="nr kj in oe b gy om oj l ok ol"># network interfaces<br/>net:<br/>  port: 27021 #same on all server<br/>  bindIp: 127.0.0.1  <strong class="oe io"><em class="mq">#NOTE: Change Ip</em></strong><br/>     <br/># how the process runs</span><span id="121c" class="nr kj in oe b gy om oj l ok ol">processManagement:<br/>  timeZoneInfo: /usr/share/zoneinfo<br/>#security:<br/>#operationProfiling:<br/>replication:<br/>  replSetName: shardreplica03</span><span id="1543" class="nr kj in oe b gy om oj l ok ol">sharding:<br/>  clusterRole: shardsvr</span></pre><h2 id="9ec6" class="nr kj in bd kk ns nt dn ko nu nv dp ks jv nw nx kw jz ny nz la kd oa ob le oc bi translated">5-重启所有 mongoDB 服务器上的服务。</h2><blockquote class="mn mo mp"><p id="cce7" class="jk jl mq jm b jn jo jp jq jr js jt ju mr jw jx jy ms ka kb kc mt ke kf kg kh ig bi translated"><em class="in">$ sudo system CTL restart mongoshard 01 mongoshard 02 mongoshard 03</em></p></blockquote><h2 id="94dd" class="nr kj in bd kk ns nt dn ko nu nv dp ks jv nw nx kw jz ny nz la kd oa ob le oc bi translated">6-连接到碎片</h2><blockquote class="mn mo mp"><p id="9761" class="jk jl mq jm b jn jo jp jq jr js jt ju mr jw jx jy ms ka kb kc mt ke kf kg kh ig bi translated"><em class="in"> $蒙戈 172.0.0.1:27019</em></p></blockquote><pre class="lh li lj lk gt od oe of og aw oh bi"><span id="2eee" class="nr kj in oe b gy oi oj l ok ol">rs.initiate(<br/>{<br/>_id : shardreplica01,<br/>members: [<br/>{ _id : 0, host : "172.0.0.1:27019" },<br/>{ _id : 1, host : "172.0.0.2:27019" },<br/>{ _id : 2, host : "172.0.0.3:27019" }]<br/>}<br/>)</span></pre><blockquote class="mn mo mp"><p id="3fa4" class="jk jl mq jm b jn jo jp jq jr js jt ju mr jw jx jy ms ka kb kc mt ke kf kg kh ig bi translated"><em class="in"> $蒙戈 172.0.0.2:27020</em></p></blockquote><pre class="lh li lj lk gt od oe of og aw oh bi"><span id="4df5" class="nr kj in oe b gy oi oj l ok ol">rs.initiate(<br/>{<br/>_id : shardreplica02,<br/>members: [<br/>{ _id : 0, host : "172.0.0.1:27020" },<br/>{ _id : 1, host : "172.0.0.2:27020" },<br/>{ _id : 2, host : "172.0.0.3:27020" }]<br/>}<br/>)</span></pre><blockquote class="mn mo mp"><p id="1036" class="jk jl mq jm b jn jo jp jq jr js jt ju mr jw jx jy ms ka kb kc mt ke kf kg kh ig bi translated"><em class="in"> $蒙戈 172.0.0.3:27021</em></p></blockquote><pre class="lh li lj lk gt od oe of og aw oh bi"><span id="2962" class="nr kj in oe b gy oi oj l ok ol">rs.initiate(<br/>{<br/>_id : shardreplica03,<br/>members: [<br/>{ _id : 0, host : "172.0.0.1:27021" },<br/>{ _id : 1, host : "172.0.0.2:27021" },<br/>{ _id : 2, host : "172.0.0.3:27021" }]<br/>}<br/>)</span></pre><h1 id="e6a3" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">MongoDB 查询路由器(MONGOS)的配置</h1><p id="ed50" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">对所有服务器重复这些步骤</p><p id="f97e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">部署多个 mongos 路由器支持高可用性和可伸缩性</p><h2 id="b11d" class="nr kj in bd kk ns nt dn ko nu nv dp ks jv nw nx kw jz ny nz la kd oa ob le oc bi translated">1-转到/var/log/mongodb 并运行下面的命令:</h2><blockquote class="mn mo mp"><p id="0bde" class="jk jl mq jm b jn jo jp jq jr js jt ju mr jw jx jy ms ka kb kc mt ke kf kg kh ig bi translated"><em class="in"> sudo touch mongos.log </em></p></blockquote><h2 id="f8ad" class="nr kj in bd kk ns nt dn ko nu nv dp ks jv nw nx kw jz ny nz la kd oa ob le oc bi translated">2-转到/etc/systemd/system 并运行下面的命令:</h2><blockquote class="mn mo mp"><p id="f317" class="jk jl mq jm b jn jo jp jq jr js jt ju mr jw jx jy ms ka kb kc mt ke kf kg kh ig bi translated"><em class="in">须藤纳米</em> mongos.service</p></blockquote><pre class="lh li lj lk gt od oe of og aw oh bi"><span id="f8fe" class="nr kj in oe b gy oi oj l ok ol">[Unit]<br/>Description=MongoDB Database Server<br/>Documentation=<a class="ae ls" href="https://docs.mongodb.org/manual" rel="noopener ugc nofollow" target="_blank">https://docs.mongodb.org/manual</a><br/>After=network-online.target<br/>Wants=network-online.target</span><span id="71b7" class="nr kj in oe b gy om oj l ok ol">[Service]<br/>User=mongodb<br/>Group=mongodb<br/>EnvironmentFile=-/etc/default/mongod<br/>ExecStart=/usr/bin/mongos --config /etc/<em class="mq">mongos</em>.conf<br/>PIDFile=/var/run/mongodb/mongod.pid<br/># file size<br/>LimitFSIZE=infinity<br/># cpu time<br/>LimitCPU=infinity<br/># virtual memory size<br/>LimitAS=infinity<br/># open files<br/>LimitNOFILE=64000<br/># processes/threads<br/>LimitNPROC=64000<br/># locked memory<br/>LimitMEMLOCK=infinity<br/># total threads (user+kernel)<br/>TasksMax=infinity<br/>TasksAccounting=false</span><span id="8d7d" class="nr kj in oe b gy om oj l ok ol"># Recommended limits for mongod as specified in<br/># <a class="ae ls" href="https://docs.mongodb.com/manual/reference/ulimit/#recommended-ulimit-settings" rel="noopener ugc nofollow" target="_blank">https://docs.mongodb.com/manual/reference/ulimit/#recommended-ulimit-settings</a></span><span id="f642" class="nr kj in oe b gy om oj l ok ol">[Install]<br/>WantedBy=multi-user.target</span></pre><h2 id="5d1e" class="nr kj in bd kk ns nt dn ko nu nv dp ks jv nw nx kw jz ny nz la kd oa ob le oc bi translated">3-转到/etc 并运行下面的命令:</h2><blockquote class="mn mo mp"><p id="cbc5" class="jk jl mq jm b jn jo jp jq jr js jt ju mr jw jx jy ms ka kb kc mt ke kf kg kh ig bi translated"><em class="in">$ sudo nano/etc/mongos . conf</em></p></blockquote><pre class="lh li lj lk gt od oe of og aw oh bi"><span id="2ce3" class="nr kj in oe b gy oi oj l ok ol">#  engine:<br/>#  mmapv1:<br/>#  wiredTiger:<br/># where to write logging data.</span><span id="53f3" class="nr kj in oe b gy om oj l ok ol">systemLog:<br/>  destination: file<br/>  logAppend: true<br/>  path: /var/log/mongodb/mongos.log</span><span id="97bf" class="nr kj in oe b gy om oj l ok ol"># network interfaces<br/>net:<br/>  port: 27017 #same on all server<br/>  bindIp: 127.0.0.1  <strong class="oe io"><em class="mq">#NOTE: Change Ip</em></strong><br/>     <br/># how the process runs</span><span id="d103" class="nr kj in oe b gy om oj l ok ol">processManagement:<br/>  timeZoneInfo: /usr/share/zoneinfo<br/>#security:<br/>#operationProfiling:</span><span id="ddc1" class="nr kj in oe b gy om oj l ok ol">sharding:<br/>  configDB: repl/172.0.0.1:27018,172.0.0.2:27018,172.0.0.3:27018<br/>#<!-- --> configDB: &lt;configReplSetName&gt;/cfg1.example.net:27019, cfg2.example.net:27019,</span></pre><h2 id="76cf" class="nr kj in bd kk ns nt dn ko nu nv dp ks jv nw nx kw jz ny nz la kd oa ob le oc bi translated">4-重启 Mongos 服务</h2><blockquote class="mn mo mp"><p id="f44c" class="jk jl mq jm b jn jo jp jq jr js jt ju mr jw jx jy ms ka kb kc mt ke kf kg kh ig bi translated"><em class="in"> $ sudo systemctl 重启 mongos </em></p></blockquote><h2 id="1111" class="nr kj in bd kk ns nt dn ko nu nv dp ks jv nw nx kw jz ny nz la kd oa ob le oc bi translated">5-给 Mongos 添加碎片</h2><blockquote class="mn mo mp"><p id="c29e" class="jk jl mq jm b jn jo jp jq jr js jt ju mr jw jx jy ms ka kb kc mt ke kf kg kh ig bi translated"><em class="in"> $蒙戈 172.0.0.1:27017</em></p></blockquote><p id="3fc8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">sh . addshard(" shardreplica 01/172 . 0 . 0 . 1:27019，172.0.0.2:27019，172.0.0.3:27019 ")</p><p id="2fb1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">sh . addshard(" shardreplica 02/172 . 0 . 0 . 1:27020，172.0.0.2:27020，172.0.0.3:27020 ")</p><p id="9482" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">sh . addshard(" shardreplica 03/172 . 0 . 0 . 1:27021，172.0.0.2:27021，172.0.0.3:27021 ")</p><p id="b6c6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">完成后，您就部署了分片集群。</p></div></div>    
</body>
</html>