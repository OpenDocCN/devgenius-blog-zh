<html>
<head>
<title>Debezium Postgres Signaling</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Debezium Postgres 信号</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/debezium-postgres-signaling-3475ffb48aa?source=collection_archive---------1-----------------------#2022-10-15">https://blog.devgenius.io/debezium-postgres-signaling-3475ffb48aa?source=collection_archive---------1-----------------------#2022-10-15</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><h1 id="d282" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">为什么发信号？</h1><p id="4222" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">由于不断变化的业务需求，将会有表被频繁地添加到您从中捕获事件的数据库中。如果你是在一个成长中的和关键的创业公司，这是相当高的。此外，您可能会在新表发布到生产中之后，但在需要对新表进行一些分析之前收到通知。</p><p id="1048" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">您将有一个 Debezium Kafka 连接器用于一个数据库监控表。您不能监视数据库的所有表，因为有些表不是分析所需要的。例如，不需要将如下表格纳入您的数据平台:</p><ol class=""><li id="fa1c" class="ll lm in kk b kl lg kp lh kt ln kx lo lb lp lf lq lr ls lt bi translated">管理、用户的 Django 相关表</li><li id="ccdb" class="ll lm in kk b kl lu kp lv kt lw kx lx lb ly lf lq lr ls lt bi translated">丝绸相关的桌子。</li><li id="0461" class="ll lm in kk b kl lu kp lv kt lw kx lx lb ly lf lq lr ls lt bi translated">飞轮相关表格。</li><li id="1260" class="ll lm in kk b kl lu kp lv kt lw kx lx lb ly lf lq lr ls lt bi translated">一些内部团队活动的临时表，如数据更正或迁移。</li></ol><p id="cd85" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">因此，我们将使用 Debezium 连接器配置的<code class="fe lz ma mb mc b">tables.included.list</code>配置[ <a class="ae md" href="https://debezium.io/documentation/reference/stable/connectors/postgresql.html#postgresql-connector-properties" rel="noopener ugc nofollow" target="_blank"> 1 </a> ]来监控分析所需的表。由于上述原因，这个列表将随着时间不断变化。</p><p id="d954" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">因此，我们需要将新表添加到<code class="fe lz ma mb mc b">tables.included.list</code>属性中。一旦我们这样做了，Debezium 将捕获表中发生的新更新，但它不会对表进行快照。这意味着新表中已经存在的数据不会被吸收到 Kafka 主题中。如果表是刚刚创建的，并且是空的，没有行，这是可以的。不幸的是，在大多数情况下并非如此。该表将包含已经在生产中使用的数据，这些数据不会出现在 Kafka 主题中。我们可以尝试通过为带有新表的同一个数据库部署新的 Debezium 连接器来解决这个问题，但是这很快就会变得很糟糕，因为:</p><ol class=""><li id="56df" class="ll lm in kk b kl lg kp lh kt ln kx lo lb lp lf lq lr ls lt bi translated">Debezium 说“一个数据库一个连接器”。</li><li id="3c7e" class="ll lm in kk b kl lu kp lv kt lw kx lx lb ly lf lq lr ls lt bi translated">同一个源将有不同的主题名称前缀，这将影响下游数据管道。</li><li id="edd2" class="ll lm in kk b kl lu kp lv kt lw kx lx lb ly lf lq lr ls lt bi translated">随着数据库中每个新表的增加，数据库的连接器数量将线性增加，这将增加维护开销和额外的处理。</li></ol><p id="180d" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">所以，不要试图走这条简单的路，因为随着时间的推移，事情肯定会变得丑陋。别担心。Debezium 向救援发出信号！</p><h1 id="8c57" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">设置</h1><p id="c5c9" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我在本地机器上使用 docker-compose 安装了所有组件。这是我使用的 docker-compose 文件:</p><blockquote class="me mf mg"><p id="ef81" class="ki kj mh kk b kl lg kn ko kp lh kr ks mi li kv kw mj lj kz la mk lk ld le lf ig bi translated">注意:我没有使用默认的 Debezium docker 映像，因为它通常是预先配置好的，我可能会忽略一些在生产中设置时需要注意的配置。</p></blockquote><figure class="ml mm mn mo gt mp"><div class="bz fp l di"><div class="mq mr l"/></div><figcaption class="ms mt gj gh gi mu mv bd b be z dk translated">Debezium Postgres 连接器的 Docker 编写设置</figcaption></figure><p id="3bd5" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">以下是 docker-compose 文件中不同服务的简要概述:</p><p id="e209" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated"><strong class="kk io">动物园管理员和卡夫卡</strong></p><p id="fbec" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">具有一个代理和一个动物园管理员的 Kafka 集群的最小设置。</p><p id="7fcb" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated"><strong class="kk io">模式注册中心</strong></p><p id="6c0f" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">我痴迷于 Avro 和 schema registry 来加强模式管理和减少 Kafka 消息大小。在[ <a class="ae md" href="https://docs.confluent.io/platform/current/schema-registry/index.html" rel="noopener ugc nofollow" target="_blank"> 2 </a> ]中了解更多信息。没有它就没有测试。</p><p id="79b5" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated"><strong class="kk io"> Debezium 连接器</strong></p><p id="d7d2" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">这是风云人物。以下是我做的一些额外的事情:</p><ol class=""><li id="328e" class="ll lm in kk b kl lg kp lh kt ln kx lo lb lp lf lq lr ls lt bi translated">我用的图片是 confluent Inc/CP-Kafka-connect:6 . 2 . 4</li><li id="0651" class="ll lm in kk b kl lu kp lv kt lw kx lx lb ly lf lq lr ls lt bi translated">为 Debezium Postgres 连接器插件附加了一个卷。</li></ol><p id="713f" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated"><strong class="kk io">卡夫卡 UI </strong></p><p id="b668" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">目前镇上最好的 Kafka UI。我需要很容易地想象我的卡夫卡中发生了什么。在[ <a class="ae md" href="https://github.com/provectus/kafka-ui" rel="noopener ugc nofollow" target="_blank"> 3 </a>中了解更多相关信息。</p><p id="f125" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated"><strong class="kk io"> Postgres </strong></p><p id="1e31" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">这将是 Debezium 捕获事件的来源。以下是我做的一些额外的事情:</p><ol class=""><li id="2ae0" class="ll lm in kk b kl lg kp lh kt ln kx lo lb lp lf lq lr ls lt bi translated">用于填充初始数据的附加卷，包括信令收集。</li><li id="9128" class="ll lm in kk b kl lu kp lv kt lw kx lx lb ly lf lq lr ls lt bi translated">将<code class="fe lz ma mb mc b">wal_level</code>设置为<code class="fe lz ma mb mc b">logical</code>的命令，以便 Debezium 连接器工作。</li></ol><p id="470f" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">下面是我的 Postgres 信令表的结构:</p><pre class="ml mm mn mo gt mw mc mx my aw mz bi"><span id="c175" class="na jl in mc b gy nb nc l nd ne">CREATE TABLE debezium_signal (</span><span id="fb37" class="na jl in mc b gy nf nc l nd ne"> id VARCHAR(50) PRIMARY KEY,</span><span id="0d86" class="na jl in mc b gy nf nc l nd ne"> type VARCHAR(50) NOT NULL,</span><span id="36a8" class="na jl in mc b gy nf nc l nd ne"> data VARCHAR(2048) NULL</span><span id="dc6a" class="na jl in mc b gy nf nc l nd ne">);</span></pre><p id="aabe" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">现在我们已经准备好测试这个设置了！</p><h1 id="5c6b" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">运转</h1><ol class=""><li id="bb20" class="ll lm in kk b kl km kp kq kt ng kx nh lb ni lf lq lr ls lt bi translated">克隆存储库:</li></ol><pre class="ml mm mn mo gt mw mc mx my aw mz bi"><span id="8a93" class="na jl in mc b gy nb nc l nd ne">git clone <a class="ae md" href="https://github.com/athultr1997/data_engineering" rel="noopener ugc nofollow" target="_blank">https://github.com/athultr1997/data_engineering</a><br/>cd data_engineering</span></pre><p id="a44d" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">2.运行 docker-compose 命令来设置基础结构:</p><pre class="ml mm mn mo gt mw mc mx my aw mz bi"><span id="008a" class="na jl in mc b gy nb nc l nd ne">docker compose up</span></pre><p id="cb2f" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">3.等待几秒钟，直到所有容器都启动并运行。观察日志，看看是否一切正常。确保 Kafka 连接器正在接受请求，如图 1 所示。</p><figure class="ml mm mn mo gt mp gh gi paragraph-image"><div role="button" tabindex="0" class="nk nl di nm bf nn"><div class="gh gi nj"><img src="../Images/88b630462fd9f3c675cc5ac760aaf787.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sm3o35YljaAnNYCIhqbYxw.png"/></div></div><figcaption class="ms mt gj gh gi mu mv bd b be z dk translated">[1] Kafka Connect 准备就绪</figcaption></figure><p id="704f" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">4.查看 Postgres 中的数据:</p><pre class="ml mm mn mo gt mw mc mx my aw mz bi"><span id="dc8f" class="na jl in mc b gy nb nc l nd ne">docker exec -it dp-postgres psql -U postgres</span><span id="49a8" class="na jl in mc b gy nf nc l nd ne"># Inside psql</span><span id="376a" class="na jl in mc b gy nf nc l nd ne">&gt;&gt; \l (To list the databases)</span><span id="f1e0" class="na jl in mc b gy nf nc l nd ne">&gt;&gt; \c test;</span><span id="7fac" class="na jl in mc b gy nf nc l nd ne">&gt;&gt; select * from mock1;</span></pre><p id="6cb7" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">您将看到类似于图 2 的输出。</p><figure class="ml mm mn mo gt mp gh gi paragraph-image"><div role="button" tabindex="0" class="nk nl di nm bf nn"><div class="gh gi nq"><img src="../Images/f654b0bc59eb46595fe51c41997a5ea8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VEyZD-IQq8CNAZoeD7ExuA.png"/></div></div><figcaption class="ms mt gj gh gi mu mv bd b be z dk translated">[2] Postgres 就绪</figcaption></figure><p id="2892" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">5.打开一个新的终端并运行以下命令来注册启用了信令的 Debezium Postgres 连接器:</p><pre class="ml mm mn mo gt mw mc mx my aw mz bi"><span id="ec45" class="na jl in mc b gy nb nc l nd ne">curl --location --request POST 'localhost:8083/connectors/' \<br/>--header 'Content-Type: application/json' \<br/>--data-raw '{<br/>    "name": "orders-connector",<br/>    "config": {<br/>        "connector.class": "io.debezium.connector.postgresql.PostgresConnector",<br/>        "plugin.name": "pgoutput",<br/>        "slot.name": "debezium",<br/>        "publication.name": "debezium",<br/>        "database.hostname": "postgres",<br/>        "database.user": "postgres",<br/>        "database.password": "password",<br/>        "database.dbname": "test",<br/>        "database.server.name": "test",<br/>        "tombstones.on.delete": "false",<br/>        "table.include.list": "public.mock1,public.debezium_signal",<br/>        "key.converter": "io.confluent.connect.avro.AvroConverter",<br/>        "value.converter": "io.confluent.connect.avro.AvroConverter",<br/>        "key.converter.schema.registry.url": "<a class="ae md" href="http://schema-registry:8081" rel="noopener ugc nofollow" target="_blank">http://schema-registry:8081</a>",<br/>        "value.converter.schema.registry.url": "<a class="ae md" href="http://schema-registry:8081" rel="noopener ugc nofollow" target="_blank">http://schema-registry:8081</a>",<br/>        "value.subject.name.strategy": "io.confluent.kafka.serializers.subject.TopicRecordNameStrategy",<br/>        "signal.data.collection": "public.debezium_signal"<br/>    }<br/>}'</span></pre><p id="689c" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">6.通过转到 Kafka UI 的<a class="ae md" href="http://localhost:8084/ui/clusters/dataplatform/connects/debezium/connectors/orders-connector" rel="noopener ugc nofollow" target="_blank">http://localhost:8084/UI/clusters/data platform/connects/debezium/connectors/orders-connector</a>检查连接器是否已正确启动。您将看到类似于图 3 的输出。</p><p id="9a29" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">您也应该看到在 localhost:8084/connectors 中列出的连接器。等待几秒钟，为表 mock1 拍摄快照并创建主题。它目前将有 3 条消息。该话题可在<a class="ae md" href="http://localhost:8084/ui/clusters/dataplatform/topics/test.public.mock1." rel="noopener ugc nofollow" target="_blank">http://localhost:8084/ui/clusters/data platform/topics/test . public . mock 1 .</a></p><figure class="ml mm mn mo gt mp gh gi paragraph-image"><div role="button" tabindex="0" class="nk nl di nm bf nn"><div class="gh gi nr"><img src="../Images/71f80099f57d07a0a95ee0fd84f8c2bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WqWSDQToL1onJsyYFm1RCg.png"/></div></div><figcaption class="ms mt gj gh gi mu mv bd b be z dk translated">[3]Kafka UI 中的 Debezium 连接器</figcaption></figure><p id="5c5b" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">7.为临时快照发送信号:</p><pre class="ml mm mn mo gt mw mc mx my aw mz bi"><span id="13b7" class="na jl in mc b gy nb nc l nd ne">docker exec -it dp-postgres psql -U postgres<br/># Inside psql<br/>&gt;&gt; \c test;<br/>&gt;&gt; INSERT INTO debezium_signal<br/>(id, type, data)<br/>VALUES (<br/>'ad110',<br/>'execute-snapshot',<br/>'{"data-collections": ["public.mock1"]}'<br/>);</span></pre><p id="ec4e" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">8.等待几秒钟，让快照开始。您可以通过检查 debezium_signal 表中的条目来检查快照是否正在进行，如图 4 所示。</p><figure class="ml mm mn mo gt mp gh gi paragraph-image"><div role="button" tabindex="0" class="nk nl di nm bf nn"><div class="gh gi ns"><img src="../Images/c5dbb314dc06933b5740d91826cb2b8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iU49pZL1jZD_5qZ4akMGgg.png"/></div></div><figcaption class="ms mt gj gh gi mu mv bd b be z dk translated">[4] Debezium 信号表</figcaption></figure><p id="edef" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">9.在<a class="ae md" href="http://localhost:8084/ui/clusters/dataplatform/topics/test.public.mock1" rel="noopener ugc nofollow" target="_blank">http://localhost:8084/UI/clusters/data platform/topics/test . public . mock 1</a>查看 Kafka UI。现在应该有 6 条消息，因为我们使用如图 5 所示的信令再次拍摄了同一个表。</p><figure class="ml mm mn mo gt mp gh gi paragraph-image"><div role="button" tabindex="0" class="nk nl di nm bf nn"><div class="gh gi nt"><img src="../Images/0a288aab363990bc187d27e69527fb26.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1zY9sqVLvXC6KFk_lX4_lA.png"/></div></div><figcaption class="ms mt gj gh gi mu mv bd b be z dk translated">[5]临时快照后的 Kafka 用户界面</figcaption></figure><p id="dcb5" class="pw-post-body-paragraph ki kj in kk b kl lg kn ko kp lh kr ks kt li kv kw kx lj kz la lb lk ld le lf ig bi translated">10.一旦你核实了一切，你就完成了，拆掉 docker-compose:</p><pre class="ml mm mn mo gt mw mc mx my aw mz bi"><span id="43f9" class="na jl in mc b gy nb nc l nd ne">docker-compose down --remove-orphans</span></pre><h1 id="134d" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">密码</h1><p id="980d" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">可以在<a class="ae md" href="https://github.com/athultr1997/data_engineering/tree/main/debezium/001_postgres_signaling" rel="noopener ugc nofollow" target="_blank">https://github . com/athultr 1997/data _ engineering/tree/main/debezium/001 _ postgres _ signaling</a>找到代码和详细说明。</p><h1 id="399a" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated"><strong class="ak"> <em class="nu">参考文献</em> </strong></h1><ol class=""><li id="348f" class="ll lm in kk b kl km kp kq kt ng kx nh lb ni lf lq lr ls lt bi translated"><a class="ae md" href="https://docs.confluent.io/platform/current/schema-registry/index.html" rel="noopener ugc nofollow" target="_blank">https://docs . confluent . io/platform/current/schema-registry/index . html</a></li><li id="3015" class="ll lm in kk b kl lu kp lv kt lw kx lx lb ly lf lq lr ls lt bi translated"><a class="ae md" href="https://debezium.io/documentation/reference/stable/connectors/postgresql.html" rel="noopener ugc nofollow" target="_blank">https://debezium . io/documentation/reference/stable/connectors/PostgreSQL . html</a></li><li id="1d6d" class="ll lm in kk b kl lu kp lv kt lw kx lx lb ly lf lq lr ls lt bi translated"><a class="ae md" href="https://github.com/provectus/kafka-ui" rel="noopener ugc nofollow" target="_blank">https://github.com/provectus/kafka-ui</a></li></ol></div></div>    
</body>
</html>