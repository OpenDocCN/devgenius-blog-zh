<html>
<head>
<title>Azure Container Apps (ACA) and Cloudflare</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Azure 容器应用(ACA)和 Cloudflare</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/azure-container-apps-aca-and-cloudflare-e63e16ae1c64?source=collection_archive---------0-----------------------#2022-11-21">https://blog.devgenius.io/azure-container-apps-aca-and-cloudflare-e63e16ae1c64?source=collection_archive---------0-----------------------#2022-11-21</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="64b0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在本文中，我们将配置并使用 Cloudflare 来保护运行在 Azure 容器应用程序上的面向客户端的 web 应用程序。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es jc"><img src="../Images/cd6092794ee99e9eed0abdb2f0cbc683.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*33u5OjofMj56eNJK5-D1_Q.png"/></div></div></figure><p id="a57c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">您将需要以下:<br/> -域名<br/> -运行在 ACA <br/>上的 Web 应用程序- Cloudflare 帐户</p><h2 id="94a5" class="jo jp hh bd jq jr js jt ju jv jw jx jy ip jz ka kb it kc kd ke ix kf kg kh ki bi translated">1.启动并运行您的 web 应用程序</h2><p id="3f3f" class="pw-post-body-paragraph ie if hh ig b ih kj ij ik il kk in io ip kl ir is it km iv iw ix kn iz ja jb ha bi translated">在 ACA 中运行容器化的 web 应用程序非常简单和灵活。如果你是 ACA 的新手，跟随这个快速入门是一个很好的起点:<br/><a class="ae ko" href="https://learn.microsoft.com/en-us/azure/container-apps/quickstart-portal" rel="noopener ugc nofollow" target="_blank">https://learn . Microsoft . com/en-us/azure/container-apps/quick start-portal</a></p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es kp"><img src="../Images/f966834e45283846f2401af21209380f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*G_88KuSrTKNNjTWu.png"/></div></div><figcaption class="kq kr et er es ks kt bd b be z dx translated">图 1: ACA 快速入门</figcaption></figure><p id="ec97" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一旦您的 web 应用程序启动并运行，导航到<strong class="ig hi">自定义域</strong>页面，并点击<strong class="ig hi">添加</strong>按钮<strong class="ig hi">。<br/> </strong>在这里，我们将输入我们的域名，并记下<strong class="ig hi">域名验证</strong>记录。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es ku"><img src="../Images/31147aa013febc1c081e2e74ff20af91.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JZsAh-cUiHa4Hta3bmoVfQ.png"/></div></div><figcaption class="kq kr et er es ks kt bd b be z dx translated">图 2:添加自定义域</figcaption></figure><h2 id="06c6" class="jo jp hh bd jq jr js jt ju jv jw jx jy ip jz ka kb it kc kd ke ix kf kg kh ki bi translated">2.将您的网站添加到 Cloudflare</h2><p id="e7e4" class="pw-post-body-paragraph ie if hh ig b ih kj ij ik il kk in io ip kl ir is it km iv iw ix kn iz ja jb ha bi translated">将您的网站添加到 Cloudflare 后，导航到 SSL/TLS 页面。为了从可用选项中启用端到端加密，我们将选择完整(严格)模式。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es kv"><img src="../Images/c97c8abdc652832fca679481a0478085.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8cdPeEc4JZdkf5_chEP8fQ.png"/></div></div><figcaption class="kq kr et er es ks kt bd b be z dx translated">图 3: SSL/TLS 配置 Cloudflare</figcaption></figure><p id="166c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">启用完全 SSL/TLS 加密模式后，导航至<strong class="ig hi">原始证书</strong>页面，并点击<strong class="ig hi">创建证书</strong>按钮。在这里，我们将创建将在 Azure 中使用的可信数字证书。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es ku"><img src="../Images/11cd2705add75bcf69e2b4587ea2362e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HjnhQ4NzZlFqRU1STHQkBg.png"/></div></div><figcaption class="kq kr et er es ks kt bd b be z dx translated">图 4:原始服务器证书</figcaption></figure><p id="66e1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">保留默认设置。</p><ul class=""><li id="6852" class="kw kx hh ig b ih ii il im ip ky it kz ix la jb lb lc ld le bi translated">使用 Cloudflare 生成私钥和 CSR</li><li id="0fa5" class="kw kx hh ig b ih lf il lg ip lh it li ix lj jb lb lc ld le bi translated">私钥类型 RSA (2048)</li><li id="6fbc" class="kw kx hh ig b ih lf il lg ip lh it li ix lj jb lb lc ld le bi translated">主机名列表—您域名的顶点(<strong class="ig hi">example.com</strong>)和通配符(<strong class="ig hi"> *.example.com </strong>)。</li></ul><p id="5096" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">点击<strong class="ig hi">创建</strong>后，您将看到一个生成了您的原始证书和私钥的页面。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es lk"><img src="../Images/cb5c0ed3d7aa461463970a037513d957.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gywO1laOYxXS4B4YACqqzQ.png"/></div></div><figcaption class="kq kr et er es ks kt bd b be z dx translated">图 5:原始服务器-密钥和证书</figcaption></figure><p id="c370" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">将此文件保存在您的本地计算机上。用扩展名<strong class="ig hi">保存原产地证书。pem </strong>和扩展名为<strong class="ig hi">的私钥。按键</strong></p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es ll"><img src="../Images/e6f9734ae8cb5838cc95cb571a760867.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Mkph0bJYATwpz4wGpz_mcg.png"/></div></div><figcaption class="kq kr et er es ks kt bd b be z dx translated">图 5:本地存储的证书</figcaption></figure><p id="c9f8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">接下来，我们将使用密码保护我们的证书，并生成<strong class="ig hi">。pfx </strong>通过运行<a class="ae ko" href="https://www.openssl.org/docs/man1.1.1/man1/openssl-pkcs12.html" rel="noopener ugc nofollow" target="_blank"> openssl pkcs12 </a>命令。</p><pre class="jd je jf jg fd lm ln lo bn lp lq bi"><span id="f0af" class="lr jp hh ln b be ls lt l lu lv">openssl pkcs12 -inkey cloudflare.key -in cloudflare.pem -export -out cloudflare.pfx</span></pre><p id="083f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">的。我们生成的 pfx 文件将在 Azure 容器应用程序门户中使用，以完成设置，但首先，我们将更新 Cloudflare 中的 DNS 记录，以指向 Azure 容器应用程序。</p><p id="3196" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">导航到 Cloudflare 中的 DNS 页面，并按照 Azure 容器应用程序门户的<strong class="ig hi">域验证</strong>部分中的说明添加 A 记录和 TXT 记录。(参见- &gt;图 2:添加自定义域)</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es kv"><img src="../Images/b8efe8bda8c98ac6c814c594d8d121f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MX22B3D6x9FKND5-TcuGpA.png"/></div></div><figcaption class="kq kr et er es ks kt bd b be z dx translated">图 6: DNS 配置— Cloudflare</figcaption></figure><h1 id="1ddd" class="lw jp hh bd jq lx ly lz ju ma mb mc jy md me mf kb mg mh mi ke mj mk ml kh mm bi translated">3.将自定义域和证书添加到 ACA</h1><p id="877e" class="pw-post-body-paragraph ie if hh ig b ih kj ij ik il kk in io ip kl ir is it km iv iw ix kn iz ja jb ha bi translated">导航回 Azure 门户，让我们从上次停止的地方继续。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es ku"><img src="../Images/31147aa013febc1c081e2e74ff20af91.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JZsAh-cUiHa4Hta3bmoVfQ.png"/></div></div><figcaption class="kq kr et er es ks kt bd b be z dx translated">图 7:添加自定义域— ACA</figcaption></figure><p id="c777" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">单击 Validate 按钮后，您应该会看到一条验证通过的消息。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es mn"><img src="../Images/5e72989b1ad4cedede4061d7d5f5e3b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bbvcVi43ZTxJfqeWvZzdkw.png"/></div></div><figcaption class="kq kr et er es ks kt bd b be z dx translated">图 8:域验证— ACA</figcaption></figure><p id="ab45" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果您在 Cloudflare DNS 配置中为 A 记录选择了代理选项，您将看到 A 记录的错误状态。您可以忽略此状态，并通过单击“下一步”按钮继续证书配置步骤。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es mo"><img src="../Images/7e7241261e5ffc93c115731b163cbb04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zzPioe0DGGZpwvaYOpFklg.png"/></div></div><figcaption class="kq kr et er es ks kt bd b be z dx translated">图 9:域验证— ACA — Cloudflare 代理</figcaption></figure><p id="0674" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在下一步中，屏幕将提示您选择证书。由于我们没有要绑定的任何证书，我们将单击<strong class="ig hi">创建新的</strong>链接，在下一个屏幕中，我们将添加<strong class="ig hi">。我们之前生成的 pfx </strong>证书。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es mp"><img src="../Images/bc36dcef6655140e19ef327874ac8d92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GIIB-7LDLQgOn3Kg0aHoig.png"/></div></div><figcaption class="kq kr et er es ks kt bd b be z dx translated">图 10:添加证书 ACA</figcaption></figure><p id="6993" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">验证证书后，我们将添加它。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es mq"><img src="../Images/09b678decf84dadaaf18ef66bbd1eecb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*txTBX-MDLAitmvpZbZgt5Q.png"/></div></div><figcaption class="kq kr et er es ks kt bd b be z dx translated">图 11:添加自定义域— ACA</figcaption></figure><p id="3e84" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">完成上述步骤后，我们将在自定义域列表中看到我们的域。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es mr"><img src="../Images/ba63f0df72b974be88fc316b30b0e21d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TNHnz1gx720K7TxvgE43YQ.png"/></div></div><figcaption class="kq kr et er es ks kt bd b be z dx translated">图 12:列出自定义域— ACA</figcaption></figure><p id="1080" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">至此，我们完成了。通过在浏览器中输入我们的域，可以访问我们的 web 应用程序。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es ms"><img src="../Images/f88729cf3aa9057b23dc0db286e0ee49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vLYH3a4OlA5_SKd57GgmXA.png"/></div></div><figcaption class="kq kr et er es ks kt bd b be z dx translated">图 13:结束</figcaption></figure><p id="ef47" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果您想使用任何其他子域，如 www，您可以使用相同的证书重复上述步骤。</p><h1 id="9d48" class="lw jp hh bd jq lx ly lz ju ma mb mc jy md me mf kb mg mh mi ke mj mk ml kh mm bi translated">原产地限制</h1><p id="2b27" class="pw-post-body-paragraph ie if hh ig b ih kj ij ik il kk in io ip kl ir is it km iv iw ix kn iz ja jb ha bi translated">上述场景中的 Azure 容器应用入口在公共 IP 地址上公开。这为绕过 Cloudflare 的流量打开了大门。目前，ACA 不提供可用于防止请求绕过 Cloudflare 的高级访问限制。<br/>要解决这一问题，您需要修改应用程序代码，通过检查请求的来源，只允许来自 Cloudflare 的流量。</p><h1 id="9cec" class="lw jp hh bd jq lx ly lz ju ma mb mc jy md me mf kb mg mh mi ke mj mk ml kh mm bi translated">进一步阅读</h1><ul class=""><li id="e80c" class="kw kx hh ig b ih kj il kk ip mt it mu ix mv jb lb lc ld le bi translated"><a class="ae ko" rel="noopener" href="/@gjoshevski/container-based-applications-on-azure-simple-and-kubernetesless-2d3cc17f6c8">Azure 上基于容器的应用——Simple 和 KuberneteslessTo 要了解更多可用选项，请访问</a></li><li id="33cb" class="kw kx hh ig b ih lf il lg ip lh it li ix lj jb lb lc ld le bi translated"><a class="ae ko" href="https://learn.microsoft.com/en-us/azure/container-apps/custom-domains-certificates" rel="noopener ugc nofollow" target="_blank">Azure 容器应用中的自定义域名和证书</a></li></ul></div></div>    
</body>
</html>