<html>
<head>
<title>Evaluate arithmetic expressions without values using BigQuery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 BigQuery 计算不带值的算术表达式</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/evaluate-arithmetic-expressions-without-values-using-bigquery-a4abd99f0932?source=collection_archive---------7-----------------------#2022-03-18">https://blog.devgenius.io/evaluate-arithmetic-expressions-without-values-using-bigquery-a4abd99f0932?source=collection_archive---------7-----------------------#2022-03-18</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="3205" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">用列名代替值来计算算术表达式怎么样？以一种可扩展的方式？而使用 SQL 呢？</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/88448d56f3c0052c8163e613a52fbc88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Mx6FoSke-HdNo9TR"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk translated">由<a class="ae ks" href="https://unsplash.com/@gmalhotra?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Gayatri Malhotra </a>在<a class="ae ks" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="3ce1" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">对于一些编程语言如 Scala、Python、Java 等。，没什么大问题，也不难处理。但是对于 SQL 来说，这并不容易，尤其是当我们需要扩展的时候。</p><p id="509a" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><strong class="kv io">本文的目的是向您展示如何以可扩展的方式实现这一点。</strong></p><p id="03ae" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">当然，有几种方法可以解决这个问题，如果能看到其他人指出这些方法，那就太好了。</p></div><div class="ab cl lp lq hr lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="ig ih ii ij ik"><h2 id="7661" class="lw lx in bd ly lz ma dn mb mc md dp me lc mf mg mh lg mi mj mk lk ml mm mn mo bi translated"><strong class="ak">让我们从一个简单的例子开始</strong></h2><p id="f4ef" class="pw-post-body-paragraph kt ku in kv b kw mp jo ky kz mq jr lb lc mr le lf lg ms li lj lk mt lm ln lo ig bi translated">假设您有一个包含字符串列的表，其中包含一个表达式，其他列作为变量引入，目标是用各自的值替换列名，并在运行时计算表达式。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi mu"><img src="../Images/d7cb18a18a8c56e144b78f39f07bd1b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:424/format:webp/1*1nrNDwu1n3PeS57omR1P0A.png"/></div></figure><p id="417d" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">根据上面的例子，预期的结果应该是这样的:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/6b9fa23e8a544024d506866b045837da.png" data-original-src="https://miro.medium.com/v2/resize:fit:706/format:webp/1*xZxlO82Mfp9XUC_1JWnsdw.png"/></div></figure><p id="507d" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">现在想象一个有数百万行的表，每一行都有不同的表达式，只需运行一个 SQL 查询，就能很快得到所有结果。<strong class="kv io">使用 BigQuery </strong>是可能的。</p></div><div class="ab cl lp lq hr lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="ig ih ii ij ik"><h1 id="f41c" class="mw lx in bd ly mx my mz mb na nb nc me jt nd ju mh jw ne jx mk jz nf ka mn ng bi translated">解决方案</h1><p id="917b" class="pw-post-body-paragraph kt ku in kv b kw mp jo ky kz mq jr lb lc mr le lf lg ms li lj lk mt lm ln lo ig bi translated">在我们的方法中，我们使用 BigQuery <a class="ae ks" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/introduction" rel="noopener ugc nofollow" target="_blank">标准 SQL </a>、<a class="ae ks" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/user-defined-functions" rel="noopener ugc nofollow" target="_blank"> SQL 和 JavaScript UDF</a>。我们创建了两个函数来支持我们的解决方案:</p><ul class=""><li id="d729" class="nh ni in kv b kw kx kz la lc nj lg nk lk nl lo nm nn no np bi translated"><code class="fe nq nr ns nt b"><strong class="kv io">fn_render_values_in_expression</strong></code>:用相应行中的值替换列名。输出是一个字符串表达式。我们应该提到这篇<a class="ae ks" href="https://stackoverflow.com/questions/65048929/bigquery-extract-keys-from-json-object-convert-json-from-object-to-key-value-a" rel="noopener ugc nofollow" target="_blank"> StackOverflow 帖子</a>作为将 JSON 转换成键值表的代码的灵感；</li><li id="12fc" class="nh ni in kv b kw nu kz nv lc nw lg nx lk ny lo nm nn no np bi translated"><code class="fe nq nr ns nt b"><strong class="kv io">fn_evaluate_expression</strong></code>:对渲染后的表达式求值并输出结果。</li></ul><h2 id="8019" class="lw lx in bd ly lz ma dn mb mc md dp me lc mf mg mh lg mi mj mk lk ml mm mn mo bi translated"><strong class="ak">功能逻辑</strong></h2><ol class=""><li id="9f12" class="nh ni in kv b kw mp kz mq lc nz lg oa lk ob lo oc nn no np bi translated">将表列转换为<a class="ae ks" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/json_functions#to_json_string" rel="noopener ugc nofollow" target="_blank"> JSON 字符串</a>，并作为函数参数传递；</li><li id="a823" class="nh ni in kv b kw nu kz nv lc nw lg nx lk ny lo oc nn no np bi translated">将表达式列作为函数参数传递；</li><li id="0cad" class="nh ni in kv b kw nu kz nv lc nw lg nx lk ny lo oc nn no np bi translated">将 JSON 转换成键值表(<code class="fe nq nr ns nt b">kv</code>)；</li><li id="3237" class="nh ni in kv b kw nu kz nv lc nw lg nx lk ny lo oc nn no np bi translated"><a class="ae ks" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/string_functions#split" rel="noopener ugc nofollow" target="_blank">将</a>表达式元素拆分成表格的行(<code class="fe nq nr ns nt b">ex</code>)；</li><li id="9aea" class="nh ni in kv b kw nu kz nv lc nw lg nx lk ny lo oc nn no np bi translated">将<code class="fe nq nr ns nt b">ex</code>表与<code class="fe nq nr ns nt b">kv</code>表映射:<strong class="kv io">如果匹配则返回</strong> <code class="fe nq nr ns nt b"><strong class="kv io">kv.value</strong></code> <strong class="kv io">否则返回</strong><code class="fe nq nr ns nt b"><strong class="kv io">ex.value</strong></code>；</li><li id="a82c" class="nh ni in kv b kw nu kz nv lc nw lg nx lk ny lo oc nn no np bi translated">将最终输出聚合为单个字符串；</li><li id="8c5d" class="nh ni in kv b kw nu kz nv lc nw lg nx lk ny lo oc nn no np bi translated">计算表达式字符串。</li></ol><h2 id="31c0" class="lw lx in bd ly lz ma dn mb mc md dp me lc mf mg mh lg mi mj mk lk ml mm mn mo bi translated"><strong class="ak">代码</strong></h2><p id="dd27" class="pw-post-body-paragraph kt ku in kv b kw mp jo ky kz mq jr lb lc mr le lf lg ms li lj lk mt lm ln lo ig bi translated">我们邀请您访问<a class="ae ks" href="https://github.com/brbep/bigquery-cool-features-standard-sql/blob/main/examples/evaluate-arithmetic-expressions.md" rel="noopener ugc nofollow" target="_blank"> GitHub </a>以获取您可能感兴趣的内容。</p><pre class="kd ke kf kg gt od nt oe of aw og bi"><span id="0d67" class="lw lx in nt b gy oh oi l oj ok">CREATE TEMP FUNCTION fn_evaluate_expression(expr STRING) RETURNS FLOAT64 LANGUAGE js AS <br/>R"""<br/>  return eval(expr);<br/>""";</span><span id="970e" class="lw lx in nt b gy ol oi l oj ok">CREATE TEMP FUNCTION fn_render_values_in_expression(json_values STRING, expression STRING) AS (<br/>(<br/>    /*<br/>      json_values = columns/values converted to JSON format<br/>      expression = expression with the column name to be mapped<br/>    */    <br/>    <br/>    /* <br/>      Transform JSON into TABULAR format<br/>      StackOverflow code inspiration: <a class="ae ks" href="https://stackoverflow.com/questions/65048929/bigquery-extract-keys-from-json-object-convert-json-from-object-to-key-value-a" rel="noopener ugc nofollow" target="_blank">https://stackoverflow.com/questions/65048929/bigquery-extract-keys-from-json-object-convert-json-from-object-to-key-value-a</a><br/>    */<br/>    WITH kv_table AS (<br/>      SELECT<br/>        ARRAY(<br/>            SELECT AS STRUCT <br/>              LOWER(TRIM(SPLIT(kv, ':')[OFFSET(0)])) as key, <br/>              TRIM(SPLIT(kv, ':')[OFFSET(1)]) as value<br/>            FROM t.kv AS kv<br/>          ) AS key_value  <br/>      FROM UNNEST([STRUCT(SPLIT(TRANSLATE(json_values, '{}"', '')) AS kv)]) AS t<br/>    ),<br/>    <br/>    kv_table_col_values AS (<br/>      SELECT<br/>        kv.key,<br/>        IF(LOWER(kv.value) = 'null', NULL, kv.value) AS value<br/>      FROM kv_table<br/>      CROSS JOIN UNNEST(key_value) AS kv<br/>    ),</span><span id="aec4" class="lw lx in nt b gy ol oi l oj ok">/* Transform EXPRESSION into TABULAR format */<br/>    expression_table AS (<br/>      SELECT <br/>        TRIM(col) AS col<br/>      FROM UNNEST(SPLIT(REGEXP_REPLACE(REPLACE(expression, ',', ' '), r'\b', ','), ',')) AS col<br/>    )<br/>    <br/>    /* Render VALUES in EXPRESSION */<br/>    SELECT<br/>      REPLACE(STRING_AGG(IF(c.key IS NULL, m.col, c.value)), ',', '')<br/>    FROM expression_table AS m<br/>    LEFT JOIN kv_table_col_values as c<br/>      ON LOWER(m.col) = c.key<br/>    WHERE<br/>      NULLIF(TRIM(m.col), '') IS NOT NULL<br/>)<br/>);</span><span id="9702" class="lw lx in nt b gy ol oi l oj ok">WITH base_table AS (<br/>  SELECT 15.5 AS a, 2 AS b, 9 AS c, 'a+b' AS exp<br/>  UNION ALL SELECT 27, 6, 3, 'a+b/c'<br/>  UNION ALL SELECT 65, 8, 6, 'c*b'<br/>  UNION ALL SELECT 98, 12, 8, 'a*b-c/15'<br/>  UNION ALL SELECT 98, 12, 8, 'a*(b-c)/15'<br/>)</span><span id="1340" class="lw lx in nt b gy ol oi l oj ok">SELECT <br/>  * ,<br/>  fn_render_values_in_expression(TO_JSON_STRING(t), exp) AS exp_rendered_values,<br/>  fn_evaluate_expression(fn_render_values_in_expression(TO_JSON_STRING(t), exp)) AS expected_result<br/>FROM base_table AS t</span></pre><p id="6ed1" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">该代码将产生以下结果:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi om"><img src="../Images/097e6d56ac2bf5293edfe14e0bd53c66.png" data-original-src="https://miro.medium.com/v2/resize:fit:940/format:webp/1*S2vgjd-8EptY5cTMhYZ1DQ.png"/></div></figure><h2 id="8643" class="lw lx in bd ly lz ma dn mb mc md dp me lc mf mg mh lg mi mj mk lk ml mm mn mo bi translated"><strong class="ak">现在，让我们扩展我们的查询</strong></h2><p id="1540" class="pw-post-body-paragraph kt ku in kv b kw mp jo ky kz mq jr lb lc mr le lf lg ms li lj lk mt lm ln lo ig bi translated">在本例中，基表已经扩展到 1M 行。下图显示了查询结果和执行细节。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi on"><img src="../Images/90997aaa8522430b50dcf74ed89fa623.png" data-original-src="https://miro.medium.com/v2/resize:fit:908/format:webp/1*7DMljTz4btY5V2wGyF9oWw.png"/></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk translated">查询结果</figcaption></figure><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi oo"><img src="../Images/979b01a90f03f7ac648b1abdf32164e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d7sDerM4dtW54wL5RN-4Pg.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk translated">执行细节</figcaption></figure><p id="4edb" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">您可以用以下代码重现它:</p><pre class="kd ke kf kg gt od nt oe of aw og bi"><span id="a9f2" class="lw lx in nt b gy oh oi l oj ok">CREATE TEMP FUNCTION fn_evaluate_expression(expr STRING) RETURNS FLOAT64 LANGUAGE js AS <br/>R"""<br/>  return eval(expr);<br/>""";</span><span id="e962" class="lw lx in nt b gy ol oi l oj ok">CREATE TEMP FUNCTION fn_render_values_in_expression(json_values STRING, expression STRING) AS (<br/>(<br/>    /*<br/>      json_values = columns/values converted to JSON format<br/>      expression = expression with the column name to be mapped<br/>    */    <br/>    <br/>    /* <br/>      Transform JSON into TABULAR format<br/>      StackOverflow code inspiration: <a class="ae ks" href="https://stackoverflow.com/questions/65048929/bigquery-extract-keys-from-json-object-convert-json-from-object-to-key-value-a" rel="noopener ugc nofollow" target="_blank">https://stackoverflow.com/questions/65048929/bigquery-extract-keys-from-json-object-convert-json-from-object-to-key-value-a</a><br/>    */<br/>    WITH kv_table AS (<br/>      SELECT<br/>        ARRAY(<br/>            SELECT AS STRUCT <br/>              LOWER(TRIM(SPLIT(kv, ':')[OFFSET(0)])) as key, <br/>              TRIM(SPLIT(kv, ':')[OFFSET(1)]) as value<br/>            FROM t.kv AS kv<br/>          ) AS key_value  <br/>      FROM UNNEST([STRUCT(SPLIT(TRANSLATE(json_values, '{}"', '')) AS kv)]) AS t<br/>    ),<br/>    <br/>    kv_table_col_values AS (<br/>      SELECT<br/>        kv.key,<br/>        IF(LOWER(kv.value) = 'null', NULL, kv.value) AS value<br/>      FROM kv_table<br/>      CROSS JOIN UNNEST(key_value) AS kv<br/>    ),</span><span id="f0e4" class="lw lx in nt b gy ol oi l oj ok">/* Transform EXPRESSION into TABULAR format */<br/>    expression_table AS (<br/>      SELECT <br/>        TRIM(col) AS col<br/>      FROM UNNEST(SPLIT(REGEXP_REPLACE(REPLACE(expression, ',', ' '), r'\b', ','), ',')) AS col<br/>    )<br/>    <br/>    /* Render VALUES in EXPRESSION */<br/>    SELECT<br/>      REPLACE(STRING_AGG(IF(c.key IS NULL, m.col, c.value)), ',', '')<br/>    FROM expression_table AS m<br/>    LEFT JOIN kv_table_col_values as c<br/>      ON LOWER(m.col) = c.key<br/>    WHERE<br/>      NULLIF(TRIM(m.col), '') IS NOT NULL<br/>)<br/>);</span><span id="a733" class="lw lx in nt b gy ol oi l oj ok">WITH base_table AS (<br/>    SELECT<br/>      id,<br/>      CAST(RAND()*100 AS INT64) AS a, <br/>      CAST(RAND()*10 AS INT64) AS b, <br/>      CAST(RAND()*10 AS INT64) AS c,<br/>      CASE <br/>        WHEN MOD(id, 6) = 0 THEN 'a+b' <br/>        WHEN MOD(id, 5) = 0 THEN 'a+b/c' <br/>        WHEN MOD(id, 4) = 0 THEN 'c*b' <br/>        WHEN MOD(id, 3) = 0 THEN 'a*b-c/15' <br/>        WHEN MOD(id, 2) = 0 THEN 'a*(b-c)/15' <br/>        ELSE 'a+b'<br/>        END AS exp<br/>    FROM UNNEST(GENERATE_ARRAY(1, 100)) AS id --Increase the range to scale<br/>)</span><span id="b2a6" class="lw lx in nt b gy ol oi l oj ok">SELECT <br/>  * ,<br/>  fn_render_values_in_expression(TO_JSON_STRING(t), exp) AS exp_rendered_values,<br/>  fn_evaluate_expression(fn_render_values_in_expression(TO_JSON_STRING(t), exp)) AS expected_result<br/>FROM base_table AS t</span></pre><p id="3b3e" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">我们希望这些信息是有用的！</p></div><div class="ab cl lp lq hr lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="ig ih ii ij ik"><blockquote class="op"><p id="2795" class="oq or in bd os ot ou ov ow ox oy lo dk translated">特别感谢<a class="ae ks" href="https://www.linkedin.com/in/vilaresantonio" rel="noopener ugc nofollow" target="_blank">安东尼奥·维拉斯</a>，他为此内容做出了贡献。</p></blockquote></div></div>    
</body>
</html>