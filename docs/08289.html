<html>
<head>
<title>Reverse Engineering Discord’s Party Mode</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">逆向工程 Discord 的聚会模式</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/reverse-engineering-discords-party-mode-d9c9dcaf0be4?source=collection_archive---------13-----------------------#2022-06-02">https://blog.devgenius.io/reverse-engineering-discords-party-mode-d9c9dcaf0be4?source=collection_archive---------13-----------------------#2022-06-02</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="e6b0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果你还没有注意到，Discord 增加了一个“派对模式”，因为他们正在庆祝他们的 7 岁生日。当一个朋友说服我启用它时，我做了最初的几个挑战，但很快注意到它们确实是重复的。</p><p id="bc50" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">所以我做了唯一合理的事情:<strong class="jm io">自动化它</strong>。我的朋友使用<a class="ae ki" href="https://github.com/puppeteer/puppeteer" rel="noopener ugc nofollow" target="_blank">木偶师</a>来自动化任务，但是我决定检查他们的源代码，找到处理这些成就的代码。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/2cd4f2bb2f62b162286765ba887bd599.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*eJ_2yx2xMUqkODzm.png"/></div></div></figure><h1 id="1399" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">从哪里开始？</h1><p id="c13c" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">当你只有一个用户界面时，总是不知道从哪里开始。有很多地方可以找。由于 Discord 使用的是电子，我们可以浏览磁盘上的文件，也可以在浏览器中浏览。如果我们知道该特性只能在桌面应用程序上使用，我们只会选择第一个选项。不和谐叠加就是一个例子。但是由于派对模式也适用于浏览器，我们可以从那里开始。</p><p id="e4e6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在检查了 party 模式的 HTML 元素后，我看不到任何对 JavaScript 函数的引用。我还检查了网络选项卡，但没有传出或传入的请求。最后，我检查了控制台，但也没有输出。</p><p id="d2e2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">因为我们所有的尝试都没有让我们更接近搞清楚派对模式是如何工作的，所以让我们试试别的。Discord 有一个资产文件夹，里面有他们所有的捆绑代码。捆绑器编译所有的 JavaScript 文件，缩小，有时甚至混淆它们。幸运的是，这些只是被缩小了，所以我们可以右击<code class="fe ly lz ma mb b">assets</code>文件夹并搜索其中的所有文件。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi mc"><img src="../Images/f1526daed70f63c34723ec9f2062724e.png" data-original-src="https://miro.medium.com/v2/resize:fit:432/format:webp/0*AdJjq4J4IB5auOn5.png"/></div></figure><p id="5810" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们现在可以搜索某些关键字，看看会出现什么。我试着输入关键字<code class="fe ly lz ma mb b">party</code>、<code class="fe ly lz ma mb b">combo</code>、<code class="fe ly lz ma mb b">confetti</code>，很快就找到了相应的文件。</p><h1 id="2196" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">逆向工程 it</h1><p id="2586" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">有很多参考文献，都包含了这样的映射。它们对我们来说并不真正有用，因为它们只是将某些变量映射到它们的 HTML 标识符。</p><pre class="kk kl km kn gt md mb me mf aw mg bi"><span id="9f9c" class="mh kw in mb b gy mi mj l mk ml">440313: e=&gt;{<br/>	e.exports = {<br/>		combo: "combo-2aK5O7",<br/>		comboValue: "comboValue-1MDc9T",<br/>		comboNameplate: "comboNameplate-2LHfRI",<br/>		comboMultiplier: "comboMultiplier-YkNec8",<br/>		comboSquare: "comboSquare-12yWYj",<br/>		left: "left-2uQTLJ",<br/>		right: "right-1c_YIP",<br/>		confettiIcon: "confettiIcon-1nMd5V",<br/>		tip: "tip-WcKlNf",<br/>		messageComboScore: "messageComboScore-1cWPCc",<br/>		comboScore: "comboScore-38MG6A"<br/>	}<br/>}</span></pre><p id="421c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">但是还有另一个文件(<code class="fe ly lz ma mb b">78a38cf0ea7963a0711a.js</code>)，处理聚会模式逻辑。只要看看字符串和变量名，我们就已经能猜到它在做什么了。例如，您认为这段代码有什么作用？</p><pre class="kk kl km kn gt md mb me mf aw mg bi"><span id="25cb" class="mh kw in mb b gy mi mj l mk ml">!function(e) {<br/>	e[e.ENABLE_POGGERMODE = 0] = "ENABLE_POGGERMODE";<br/>	e[e.DISABLE_POGGERMODE = 1] = "DISABLE_POGGERMODE";<br/>	e[e.PING_SOMEONE = 2] = "PING_SOMEONE";<br/>	e[e.PING_ME = 3] = "PING_ME";<br/>	e[e.COMBO_MULTI_LEVEL_1 = 4] = "COMBO_MULTI_LEVEL_1";<br/>	e[e.COMBO_MULTI_LEVEL_2 = 5] = "COMBO_MULTI_LEVEL_2";<br/>	e[e.COMBO_MULTI_LEVEL_3 = 6] = "COMBO_MULTI_LEVEL_3";<br/>	e[e.COMBO_MULTI_LEVEL_4 = 7] = "COMBO_MULTI_LEVEL_4";<br/>	e[e.TOTAL_SCORE_LEVEL_1 = 8] = "TOTAL_SCORE_LEVEL_1";<br/>	e[e.TOTAL_SCORE_LEVEL_2 = 9] = "TOTAL_SCORE_LEVEL_2";<br/>	e[e.TOTAL_SCORE_LEVEL_3 = 10] = "TOTAL_SCORE_LEVEL_3";<br/>	e[e.TOTAL_SCORE_LEVEL_4 = 11] = "TOTAL_SCORE_LEVEL_4";<br/>	e[e.TOTAL_SCORE_LEVEL_5 = 12] = "TOTAL_SCORE_LEVEL_5";<br/>	e[e.VISITOR_100 = 13] = "VISITOR_100";<br/>	e[e.CUSTOMIZE_CONFETTI = 14] = "CUSTOMIZE_CONFETTI";<br/>	e[e.MORE = 15] = "MORE";<br/>	e[e.COMBO_VALUE_LEVEL_1 = 16] = "COMBO_VALUE_LEVEL_1";<br/>	e[e.COMBO_VALUE_LEVEL_2 = 17] = "COMBO_VALUE_LEVEL_2";<br/>	e[e.COMBO_VALUE_LEVEL_3 = 18] = "COMBO_VALUE_LEVEL_3";<br/>	e[e.COMBO_VALUE_LEVEL_4 = 19] = "COMBO_VALUE_LEVEL_4"<br/>}(o || (t.PoggermodeAchievementId = o = {}));</span></pre><p id="322c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果您知道有哪些成就，您会立即意识到这是存储关于它们的一些数据的数组。向下滚动一点，您会发现正好 19 个代码块，看起来都有点像这样:</p><pre class="kk kl km kn gt md mb me mf aw mg bi"><span id="d116" class="mh kw in mb b gy mi mj l mk ml">a[o.DISABLE_POGGERMODE] = {<br/>	id: o.DISABLE_POGGERMODE,<br/>	name: function() {<br/>		return s.default.Messages.POGGERMODE_ACHIEVEMENT_DISABLE_POGGERMODE_NAME<br/>	},<br/>	description: function() {<br/>		return s.default.Messages.POGGERMODE_ACHIEVEMENT_DISABLE_POGGERMODE_DESCRIPTION<br/>	},<br/>	rarity: i.UNCOMMON,<br/>	hideDescriptionUntilUnlock: !1<br/>},</span></pre><p id="5fe7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">甚至有一个传奇成就有一个事件处理器。你能猜出他们正在打开哪个视频吗？</p><pre class="kk kl km kn gt md mb me mf aw mg bi"><span id="67e4" class="mh kw in mb b gy mi mj l mk ml">a[o.VISITOR_100] = {<br/>	id: o.VISITOR_100,<br/>	name: function() {<br/>		return s.default.Messages.POGGERMODE_ACHIEVEMENT_VISITOR_100_NAME<br/>	},<br/>	description: function() {<br/>		return s.default.Messages.POGGERMODE_ACHIEVEMENT_VISITOR_100_DESCRIPTION<br/>	},<br/>	rarity: i.LEGENDARY,<br/>	hideDescriptionUntilUnlock: !0,<br/>	onAction: function() {<br/>		window.open("https://www.youtube.com/watch?v=dQw4w9WgXcQ", "_blank")<br/>	}<br/>},</span></pre><p id="f388" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">So now we know where the achievement logic is located, can we figure out whether it’s stored? I initially did some achievements by hand on the Desktop client, but when I opened the browser client, all of them were gone. Since there were also no outgoing or incoming requests when looking at the networking, we can be certain that the data is just stored locally.</p><p id="0c1c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">You could now either go through the file and search for references to storage APIs or look through <code class="fe ly lz ma mb b">LocalStorage</code>. Since there's not that many options, the <code class="fe ly lz ma mb b">PoggermodeAchievementStore</code> key might stand out. When you look at the stored value, you can clearly see the unlocked achievements. Nice!</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi mm"><img src="../Images/5bac5bc667c37bcc68c547176db03300.png" data-original-src="https://miro.medium.com/v2/resize:fit:1192/format:webp/0*rw90WbaE0PYuoF2-.png"/></div></figure><h1 id="0603" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">Patching it</h1><p id="5ca4" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">Now that we know where the achievements are stored, we can easily modify it. I wanted to write a simple JavaScript program for that, but for whatever reason, <code class="fe ly lz ma mb b">window.localStorage</code> wasn't defined. So instead of wasting more time to find a workaround, I decided to manually replace it.</p><p id="60b4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">Since we already found the achievement array, we know that there’s 19 of them. We can just write it out like this and replace the value. The <code class="fe ly lz ma mb b">dateUnlocked</code> value is a epoch timestamp. You can create your own timestamp on <a class="ae ki" href="https://www.epochconverter.com/" rel="noopener ugc nofollow" target="_blank">this website</a>.</p><pre class="kk kl km kn gt md mb me mf aw mg bi"><span id="3c12" class="mh kw in mb b gy mi mj l mk ml">{<br/>    "_state": {<br/>        "unlockedAchievements": {<br/>            "0": {<br/>                "achievementId": 0,<br/>                "dateUnlocked": -19975457838000<br/>            },<br/>            "1": {<br/>                "achievementId": 1,<br/>                "dateUnlocked": -19975457838000<br/>            },<br/>            "2": {<br/>                "achievementId": 2,<br/>                "dateUnlocked": -19975457838000<br/>            },<br/>            // Skipped...<br/>            "18": {<br/>                "achievementId": 18,<br/>                "dateUnlocked": -19975457838000<br/>            },<br/>            "19": {<br/>                "achievementId": 19,<br/>                "dateUnlocked": -19975457838000<br/>            }<br/>        }<br/>    },<br/>    "_version": 0<br/>}</span></pre><p id="b8dd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">After reloading the client, we got all the achievements. Now I can brag to all of you about how cool I am. :)</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/df06acf8c8322a6f844e85847a18d387.png" data-original-src="https://miro.medium.com/v2/resize:fit:1378/format:webp/0*o9l2cMOD8vIRIgD3.png"/></div></figure><h1 id="a18e" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">What did we learn?</h1><p id="a5c0" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">This was only a small project, but we still learned quite a lot. We now know how we can start reversing websites or Electron applications. I’m using Firefox for all my personal browsing, but I decided to spin up Chrome because I know how good their DevTools are. So make sure to <strong class="jm io">use the right tool for the job</strong>.</p></div><div class="ab cl mo mp hr mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="ig ih ii ij ik"><p id="4640" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">I’m a big fan of <a class="ae ki" href="https://www.urbandictionary.com/define.php?term=productive+procrastination" rel="noopener ugc nofollow" target="_blank">structured procrastination</a> and <a class="ae ki" href="https://invidious.namazso.eu/watch?v=AMMOErxtahk" rel="noopener ugc nofollow" target="_blank">learning new things by starting a project</a>. So if you catch yourself procrastinating or wasting time, try to turn it into a fun side project.</p><p id="3ae3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">After all, it is never a waste of time to learn something new.</strong></p></div><div class="ab cl mo mp hr mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="ig ih ii ij ik"><p id="298f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><em class="mv">Originally published at </em><a class="ae ki" href="https://not-matthias.github.io/posts/discord-party-mode/" rel="noopener ugc nofollow" target="_blank"><em class="mv">https://not-matthias.github.io</em></a><em class="mv">.</em></p></div></div>    
</body>
</html>