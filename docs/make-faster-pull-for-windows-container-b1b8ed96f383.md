# 对 Windows 容器进行更快的拉取

> 原文：<https://blog.devgenius.io/make-faster-pull-for-windows-container-b1b8ed96f383?source=collection_archive---------1----------------------->

![](img/0e3a88ef33a72902395d8efa2e2ef24b.png)

尼克·艾布拉姆斯在 [Unsplash](https://unsplash.com/s/photos/slow?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) 拍摄的照片

你可能想知道为什么 Windows 容器启动这么慢。因为您从未固定过容器映像的精确基础映像版本。在这篇文章中，我将解释在引擎盖下发生了什么，以及如何正确处理它。

# 了解基础图像发布规则

当 Microsoft 推出更新的 Windows Server 安全修补程序和热修复程序时，会定期发布更新的 Windows Server 容器映像。例如，当 Microsoft 为 20H2 发布 KB4598242 时，容器基础映像也随之发布。

当新的基础映像部署到 mcr.microsoft.com 时，新映像由两部分组成。第一部分是 Windows Server 容器的基本映像，它永远不会改变。而移动的部分是后面的部分，包括了热修复。

# 这是怎么回事？

如果您使用类似“2004”的标签构建您的映像，正如您可能猜到的那样，它将选择 20H1 服务器容器映像的最新版本。但这是一个相对选项，所以会有错配。

从开发人员的角度来看，每次构建映像时，都会选择不同的基础映像。三个月前，你的选择可能是`10.0.19041.264-amd64`，但此时，你的选择会`10.0.19042.746-amd64`，因为`2004`会有规律的变化。您可能知道，这是现有 Docker 用户的一个实践，说明了为什么您不应该使用缩写标签。

然后，我们把视线转移到服务器上。假设您是 Windows Kubernetes 节点的管理员。大多数托管 Kubernetes 提供程序并没有在节点中指定 Windows 容器的特定基本映像版本。无论您是否需要，您都应该获取 Windows 节点的匹配基础映像，以加快启动速度。

但是有一个问题。即使您缓存了 Windows server 核心映像的基本映像，Windows Server 映像的每个修补程序也有不同的层，大约消耗 300 ~ 400 兆字节。如果不指定映像的确切版本，每个 Windows 节点都将消耗额外的磁盘空间、网络流量和启动时间。

让我们仔细看看。您可以将图像标签`10.0.19041.264-amd64`预拉到您的节点。但是开发者并没有用那个映像构建应用容器映像。他或她使用了`2004`标签，而镜像标签指向了`10.0.19042.746-amd64`镜像标签，所以当镜像部署到节点时，大约会额外消耗 300 ~ 400MiB 的磁盘空间、网络流量，再加上启动时间只需扩展两三分钟。(除了 3 ~ 4GiB 的`10.0.19042`。)

# 解决方案——在任何地方都尽可能明确

解决方案很简单。从头到尾，宣布您想要用于所有其他团队的确切的容器基础映像版本。

只要你使用进程隔离，容器版本标签就不会影响你的容器运行时间。因此，您可以选择最早的公共图像标记来分别构建应用程序容器图像和预部署到您的节点。

例如，如果您为 Kubernetes 集群管理 Windows Server 版本 20H1，那么您可以将所需的容器版本标记固定为最早的图像标记`10.0.18363.476-amd64`。(为了将来证明，最好指定确切的架构名称。)

但是如果你使用 Hyper-V 隔离，你需要额外的费用来定期改变和传播标签版本。即使考虑到这一点，也不建议使用 Hyper-V 容器隔离，因为操作成本非常高。

如果您选择正确且固定的图像标记，您可以确保您的节点将提取应用程序层的一小部分，而不是整个基础图像。以我的经验来看，这种调让我们的冷启动时间从 7 分钟降到了 1 分钟。

# 结论

由于操作系统的架构，您应该考虑您的选择意味着什么，以及它如何影响您在 Windows 容器世界中的工作负载。对于几乎所有的工作负载，您可能会使用进程隔离，这样这个解决方案就可以很好地工作。尽可能明确地选择图像标签，以节省您的金钱和时间。