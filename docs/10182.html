<html>
<head>
<title>Beginner’s Guide To Using Terraform For Azure</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Terraform For Azure 的初学者指南</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/beginners-guide-to-using-terraform-for-azure-90861bc8b9cf?source=collection_archive---------4-----------------------#2022-10-13">https://blog.devgenius.io/beginners-guide-to-using-terraform-for-azure-90861bc8b9cf?source=collection_archive---------4-----------------------#2022-10-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/e34962354b5a8c22687768a3aac08ecc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d99lkhUeCzQ1cA-of5Xxxg.png"/></div></div></figure><p id="550b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们一起来看看开始使用 Terraform 在 Microsoft Azure 中创建和管理资源所需的步骤。</p><p id="a871" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">本文中概述的许多步骤也适用于 AWS 用户，或者在构建 AWS 解决方案时可能非常相似。然而，下面的代码示例是特定于 Azure 的。</p><h1 id="2261" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">获得所需的工具</h1><p id="a507" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">您需要在系统上安装两个不同的 CLI 工具，以便能够在本地运行本文中使用的命令:</p><ul class=""><li id="84ae" class="lz ma iq ka b kb kc kf kg kj mb kn mc kr md kv me mf mg mh bi translated">你可以在这里下载<a class="ae mi" href="https://www.terraform.io/downloads" rel="noopener ugc nofollow" target="_blank">。下面的代码片段假设您将<code class="fe mj mk ml mm b">Terraform.exe</code>放在了<code class="fe mj mk ml mm b">PATH</code>环境变量中。如果没有，就需要通过提供相对路径来扩展代码片段。</a></li><li id="8638" class="lz ma iq ka b kb mn kf mo kj mp kn mq kr mr kv me mf mg mh bi translated">Azure CLI，你可以在这里下载<a class="ae mi" href="https://learn.microsoft.com/de-de/cli/azure/install-azure-cli" rel="noopener ugc nofollow" target="_blank"/></li></ul><p id="73a3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">请注意:通常，出于开发目的，您只想在本地执行这些。最后，您会希望在构建管道中运行这些工具。幸运的是，<a class="ae mi" href="https://marketplace.visualstudio.com/items?itemName=ms-devlabs.custom-terraform-tasks" rel="noopener ugc nofollow" target="_blank"> Terraform </a>和<a class="ae mi" href="https://learn.microsoft.com/en-us/azure/devops/pipelines/tasks/reference/azure-cli-v2?view=azure-pipelines" rel="noopener ugc nofollow" target="_blank"> Azure CLI </a>都已经作为预打包任务出现在 Azure DevOps 中。</p><h1 id="f4cb" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">使用 Terraform 为部署设置 Azure 订阅</h1><p id="a852" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">假设您已经在 Azure Active Directory 中拥有一个 Azure 订阅，您可以在其中创建服务主体，您将需要执行一些步骤来准备您的订阅(每个步骤将在后面更详细地描述):</p><ul class=""><li id="e309" class="lz ma iq ka b kb kc kf kg kj mb kn mc kr md kv me mf mg mh bi translated">创建服务主体。Terraform 将在向您的订阅部署资源时使用此信息进行自我验证。创建服务主体时，您需要确保授予它所需的权限</li><li id="547a" class="lz ma iq ka b kb mn kf mo kj mp kn mq kr mr kv me mf mg mh bi translated">创建 Azure 存储帐户。我们将指示 Terraform 将它的状态存储在那里。</li></ul><h2 id="c937" class="ms kx iq bd ky mt mu dn lc mv mw dp lg kj mx my lk kn mz na lo kr nb nc ls nd bi translated">创建服务主体</h2><p id="4451" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">这一步要求您在您的订阅所分配到的 Azure AD 中拥有<code class="fe mj mk ml mm b">Application administrator</code>角色。如果你没有这个角色，你可能需要让你的 Azure 广告管理员参与进来。</p><p id="9b5c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，你需要使用 Azure CLI 登录到正确的订阅。你可以通过打开一个终端并运行<code class="fe mj mk ml mm b">az login</code>命令来实现。这将要求您登录，然后打印出您有权访问的所有订阅的信息。通过运行<code class="fe mj mk ml mm b">az account set -s &lt;your subscription id&gt;</code>，选择您想要部署到的订阅。您可以通过运行<code class="fe mj mk ml mm b">az account show</code>来验证您当前使用的套餐。</p><p id="68fa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，您需要通过运行<code class="fe mj mk ml mm b">az ad sp create-for-rbac --role="Contributor" -- scopes="/subscriptions/&lt;your subscription id&gt;"</code>来创建服务主体(或者如果您想将 Terraforms 访问限制到特定的资源组，则运行<code class="fe mj mk ml mm b">create-for-rbac --role="Contributor" -- scopes="/subscriptions/&lt;your subscription id&gt;/resourceGroups/&lt;your resource group&gt;"</code>)。这个命令将打印出一些您在下一步中需要的信息，所以请记下来。</p><p id="9f46" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要让 Terraform 使用此服务主体进行身份验证，您需要导出一些关于服务主体、您的订阅和 Azure AD 的信息作为环境变量(代码片段假设您使用的是 PowerShell):</p><p id="be95" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mj mk ml mm b">$ENV:ARM_CLIENT_ID="&lt;the app id printed above&gt;" ; $ENV:ARM_CLIENT_SECRET="&lt;the password printed above&gt;" ; $ENV:ARM_SUBSCRIPTION_ID="&lt;your subscription id&gt;" ; $ENV:ARM_TENANT_ID="&lt;your tenant id&gt;"</code></p><p id="d41c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">请注意，该命令只会为当前进程临时设置环境变量。</p><h2 id="e8d3" class="ms kx iq bd ky mt mu dn lc mv mw dp lg kj mx my lk kn mz na lo kr nb nc ls nd bi translated">创建存储帐户</h2><p id="f4b6" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">Terraform 使用状态文件来了解在对现有资源集应用更新的<code class="fe mj mk ml mm b">.tf</code>文件时需要做出哪些更改。</p><p id="b034" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">虽然您可以将这些状态文件存储在本地计算机上，但不建议这样做——它们可能会丢失，您团队中的其他开发人员将无法访问这些文件。此外，一旦您开始自动化基础设施资源的创建，您的 CI/CD 管道将需要这些状态文件。</p><p id="c27c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">获取共享状态文件的一种方式是使用 Terraforms 付费服务<a class="ae mi" href="https://cloud.hashicorp.com/products/terraform" rel="noopener ugc nofollow" target="_blank"> Terraform Cloud </a>。</p><p id="94d6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在本文中，我将向您展示如何使用通过 Azure 存储帐户共享的状态文件。为了准备后面的步骤，您需要在 Azure 门户中手动或使用 Azure CLI 创建一个 Azure 存储帐户和一个容器。在这两种情况下，这都是一次性步骤:虽然 Terraform 将使用此存储帐户，但它不是 Terraform 管理的资源之一。</p><ul class=""><li id="6cdc" class="lz ma iq ka b kb kc kf kg kj mb kn mc kr md kv me mf mg mh bi translated">如果您还没有想要在其中拥有存储帐户的资源组，那么通过运行<code class="fe mj mk ml mm b">az group create --name &lt;name for your group&gt; --location westeurope</code>来创建它(您可能想要根据需要调整位置)</li><li id="4015" class="lz ma iq ka b kb mn kf mo kj mp kn mq kr mr kv me mf mg mh bi translated">然后运行<code class="fe mj mk ml mm b">az storage account create --resource-group &lt;name for your group&gt; --name &lt;name for your tf state storage account&gt; --sku Standard_LRS --encryption-services blob</code>来创建存储帐户</li><li id="b65e" class="lz ma iq ka b kb mn kf mo kj mp kn mq kr mr kv me mf mg mh bi translated">最后，通过运行<code class="fe mj mk ml mm b">az storage container create --name tfstate --account-name &lt;name for your tf state storage account&gt;</code>在这个帐户中创建一个容器</li></ul><p id="31b5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建存储帐户后，您需要将帐户密钥作为环境变量提供给 Terraform。您可以通过运行<code class="fe mj mk ml mm b">az storage account keys list --resource-group &lt;name for your group&gt; --account-name &lt;name for your tf state storage account&gt; --query '[0].value' -o tsv</code>来检索那个键，并通过运行<code class="fe mj mk ml mm b">$ENV:ARM_ACCESS_KEY="&lt;the access key retrieved by the last command&gt;"</code>来设置环境变量。</p><h1 id="0b83" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">开始创建 Azure 资源</h1><p id="2398" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">现在，您已经设置了所有需要的工具，可以开始使用 Terraform 创建和管理基础设施了。为此，在存储库的文件夹中创建一个新的<code class="fe mj mk ml mm b">main.tf</code>文件，并将以下内容放入其中:</p><figure class="ne nf ng nh gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="eb53" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这个片段将告诉 Terraform</p><ul class=""><li id="465e" class="lz ma iq ka b kb kc kf kg kj mb kn mc kr md kv me mf mg mh bi translated">使用 Azure 资源管理器提供程序插件来管理资源(第 2–7 行)</li><li id="f8af" class="lz ma iq ka b kb mn kf mo kj mp kn mq kr mr kv me mf mg mh bi translated">将状态文件存储在前面创建的存储帐户容器中(第 9–14 行)</li><li id="3fbc" class="lz ma iq ka b kb mn kf mo kj mp kn mq kr mr kv me mf mg mh bi translated">依赖于特定的 Terraform 可执行版本(第 16 行)</li><li id="b803" class="lz ma iq ka b kb mn kf mo kj mp kn mq kr mr kv me mf mg mh bi translated">配置 Azure 资源管理器提供程序插件的一些属性(第 19–27 行)</li></ul><p id="51b4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，您应该能够在您的<code class="fe mj mk ml mm b">main.tf</code>文件所在的文件夹中运行<code class="fe mj mk ml mm b">terraform init</code>。这将下载 Azure 资源管理器提供程序插件，并在您配置的存储帐户中创建状态文件的初始版本。</p><p id="6882" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在你已经准备好创建真正的 Azure 资源了。以下代码片段显示了创建资源组的示例，以及该资源组中的 Azure 容器注册表和 Azure IoT Hub:</p><figure class="ne nf ng nh gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="a142" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可以在这里找到如何定义<code class="fe mj mk ml mm b">azurerm</code>提供者<a class="ae mi" href="https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs" rel="noopener ugc nofollow" target="_blank">所有支持的资源类型的文档。</a></p><p id="791f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，离提供<code class="fe mj mk ml mm b">main.tf</code>文件中定义的资源只差最后两步了:</p><ul class=""><li id="cbef" class="lz ma iq ka b kb kc kf kg kj mb kn mc kr md kv me mf mg mh bi translated">运行<code class="fe mj mk ml mm b">terraform plan</code>查看 Terraform 希望应用于您的订阅的更改</li><li id="8e21" class="lz ma iq ka b kb mn kf mo kj mp kn mq kr mr kv me mf mg mh bi translated">运行<code class="fe mj mk ml mm b">terraform apply</code>将更改实际应用到您的订阅</li></ul><p id="0c15" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">就这样，你现在可以使用🥳.平台管理 Azure 资源了如果你对更详细的教程、更深入的信息和其他例子感兴趣，可以考虑跟随 Terraform 提供的<a class="ae mi" href="https://learn.hashicorp.com/collections/terraform/azure-get-started" rel="noopener ugc nofollow" target="_blank">这个教程</a>。</p></div><div class="ab cl nk nl hu nm" role="separator"><span class="nn bw bk no np nq"/><span class="nn bw bk no np nq"/><span class="nn bw bk no np"/></div><div class="ij ik il im in"><p id="0558" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">觉得这篇文章有用？在 Medium 上关注我(<a class="ae mi" href="https://medium.com/@christian.johann.eder" rel="noopener"> Christian Eder </a>)并查看我下面关于 Azure、AWS、基础设施代码和物联网的文章！不要忘记👏这篇文章分享一下吧！</p><ul class=""><li id="f5a8" class="lz ma iq ka b kb kc kf kg kj mb kn mc kr md kv me mf mg mh bi translated"><a class="ae mi" href="https://awstip.com/authoring-polyglot-aws-cdk-constructs-using-jsii-be0ed66e9910" rel="noopener ugc nofollow" target="_blank">使用 JSII 创作多语言 AWS CDK 构造</a></li><li id="2bd8" class="lz ma iq ka b kb mn kf mo kj mp kn mq kr mr kv me mf mg mh bi translated"><a class="ae mi" href="https://medium.com/@christian.johann.eder/using-custom-pulumi-state-storage-in-the-cloud-e2737f2528e3" rel="noopener">在云中使用自定义 Pulumi 状态存储</a></li><li id="2404" class="lz ma iq ka b kb mn kf mo kj mp kn mq kr mr kv me mf mg mh bi translated"><a class="ae mi" href="https://awstip.com/deploying-an-asp-net-core-api-to-aws-fargate-using-cdk-dab10bef51a1" rel="noopener ugc nofollow" target="_blank">使用 CDK 将 ASP.NET 核心 API 部署到 AWS Fargate</a></li><li id="c1e0" class="lz ma iq ka b kb mn kf mo kj mp kn mq kr mr kv me mf mg mh bi translated"><a class="ae mi" href="https://medium.com/@christian.johann.eder/deploying-azure-functions-using-pulumi-net-bfaad97ff9dd" rel="noopener">使用 Pulumi 部署 Azure 功能&amp;。网络</a></li></ul><p id="580a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">另外，如果你还不是中等会员，可以考虑在这里加入<a class="ae mi" href="https://medium.com/@christian.johann.eder/membership" rel="noopener"/>。</p></div></div>    
</body>
</html>