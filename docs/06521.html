<html>
<head>
<title>An Introduction to Terragrunt</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Terragrunt简介</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/an-introduction-to-terragrunt-dfe9921f5e48?source=collection_archive---------1-----------------------#2022-01-14">https://blog.devgenius.io/an-introduction-to-terragrunt-dfe9921f5e48?source=collection_archive---------1-----------------------#2022-01-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="fefc" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">关于如何使用Terragrunt和Terraform注册模块部署基本AWS资源的教程</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/240f09acba200e021ed2c23d0e870a06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jM4Mi4Hqc6qo1o_sZsrQ-A.png"/></div></div></figure><h1 id="8cf0" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">欢迎</h1><p id="6dc3" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">这是我们Terragrunt系列的第二部分。我们将学习如何使用Terragrunt在AWS中管理基础设施和部署资源的基础知识。这篇文章专门针对初级到中级用户，提供了整个过程的逐步演练。如果你想知道<a class="ae mf" href="https://medium.com/@marcus.tse_70031/why-use-terragrunt-in-2022-5e97c61cc539" rel="noopener">为什么在2022年</a>使用Terragrunt，请查看第一部分。</p><h1 id="4320" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">Terragrunt &amp; Terraform注册表</h1><p id="e62e" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">官方文件描述:</p><blockquote class="mg mh mi"><p id="2efc" class="lj lk mj ll b lm mk jr lo lp ml ju lr mm mn lu lv mo mp ly lz mq mr mc md me ij bi translated">Terragrunt是一个瘦包装器，它提供了额外的工具来保持您的配置干燥，使用多个Terraform模块，以及管理远程状态。</p></blockquote><p id="3957" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated">【https://terragrunt.gruntwork.io/】来源:<a class="ae mf" href="https://terragrunt.gruntwork.io/" rel="noopener ugc nofollow" target="_blank"><em class="mj"/></a></p><p id="0741" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated"><a class="ae mf" href="https://terragrunt.gruntwork.io/" rel="noopener ugc nofollow" target="_blank"> Terragrunt </a>是一个开源工具，作为Terraform的扩展而存在，用于保持代码<a class="ae mf" href="https://en.wikipedia.org/wiki/Don%27t_repeat_yourself" rel="noopener ugc nofollow" target="_blank">干燥</a>，并在使用多个Terraform模块时管理Terraform状态以及其他<a class="ae mf" href="https://terragrunt.gruntwork.io/docs/#features" rel="noopener ugc nofollow" target="_blank">漂亮的功能</a>，这些功能集成在Terragrunt中。Terragrunt还解决了一个主要问题:在存储远程状态时，Terraform不允许为其后端类型使用变量或路径插值，比如s3 bucket。</p><h2 id="7ea2" class="ms ks iq bd kt mt mu dn kx mv mw dp lb ls mx my ld lw mz na lf ma nb nc lh nd bi translated">地形注册表</h2><blockquote class="mg mh mi"><p id="a73d" class="lj lk mj ll b lm mk jr lo lp ml ju lr mm mn lu lv mo mp ly lz mq mr mc md me ij bi translated">经验证的模块由HashiCorp审查，并由贡献者积极维护，以保持最新并与Terraform及其各自的提供商兼容。</p></blockquote><p id="d8ac" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated"><em class="mj">来源:</em><a class="ae mf" href="https://www.terraform.io/registry/modules/verified" rel="noopener ugc nofollow" target="_blank"><em class="mj">https://www.terraform.io/registry/modules/verified</em></a></p><p id="25a0" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated">Terraform registry 同时拥有验证模块和社区模块。社区模块可以具有高质量，并且可以被积极地管理。该术语仅表示社区模块不是由HashiCorp合作伙伴创建的。注册中心充当创建和运行基础设施的模板存储库。</p><p id="4a5c" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated">所有模块都必须遵守<a class="ae mf" href="https://www.terraform.io/docs/language/modules/develop/index.html" rel="noopener ugc nofollow" target="_blank">官方文件</a>中规定的代码标准。</p><h1 id="2080" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">先决条件</h1><ol class=""><li id="8b0e" class="ne nf iq ll b lm ln lp lq ls ng lw nh ma ni me nj nk nl nm bi translated">创建一个<a class="ae mf" href="https://aws.amazon.com/premiumsupport/knowledge-center/create-and-activate-aws-account/" rel="noopener ugc nofollow" target="_blank"> AWS账户</a></li><li id="15a8" class="ne nf iq ll b lm nn lp no ls np lw nq ma nr me nj nk nl nm bi translated">下载<a class="ae mf" href="https://terragrunt.gruntwork.io/docs/getting-started/install/" rel="noopener ugc nofollow" target="_blank">地形和地形地貌</a></li></ol><h1 id="e020" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">1.创建AWS帐户</h1><p id="4650" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated"><a class="ae mf" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank"> Terraform </a>是一个开源的基础设施，作为一个代码工具，兼容众多的云提供商:AWS，Azure，GCP，阿里云<a class="ae mf" href="https://registry.terraform.io/browse/providers" rel="noopener ugc nofollow" target="_blank">和更多的</a>。对于本教程，选择<a class="ae mf" href="https://aws.amazon.com/?nc2=h_lg&amp;aws-products-analytics.sort-by=item.additionalFields.productNameLowercase&amp;aws-products-analytics.sort-order=asc&amp;aws-products-business-apps.sort-by=item.additionalFields.productNameLowercase&amp;aws-products-business-apps.sort-order=asc&amp;aws-products-containers.sort-by=item.additionalFields.productNameLowercase&amp;aws-products-containers.sort-order=asc&amp;aws-products-compute.sort-by=item.additionalFields.productNameLowercase&amp;aws-products-compute.sort-order=asc&amp;aws-products-databases.sort-by=item.additionalFields.productNameLowercase&amp;aws-products-databases.sort-order=asc&amp;aws-products-fe-mobile.sort-by=item.additionalFields.productNameLowercase&amp;aws-products-fe-mobile.sort-order=asc&amp;aws-products-game-tech.sort-by=item.additionalFields.productNameLowercase&amp;aws-products-game-tech.sort-order=asc&amp;aws-products-iot.sort-by=item.additionalFields.productNameLowercase&amp;aws-products-iot.sort-order=asc&amp;aws-products-ml.sort-by=item.additionalFields.productNameLowercase&amp;aws-products-ml.sort-order=asc&amp;aws-products-mgmt-govern.sort-by=item.additionalFields.productNameLowercase&amp;aws-products-mgmt-govern.sort-order=asc&amp;aws-products-migration.sort-by=item.additionalFields.productNameLowercase&amp;aws-products-migration.sort-order=asc&amp;aws-products-network.sort-by=item.additionalFields.productNameLowercase&amp;aws-products-network.sort-order=asc&amp;aws-products-security.sort-by=item.additionalFields.productNameLowercase&amp;aws-products-security.sort-order=asc&amp;aws-products-storage.sort-by=item.additionalFields.productNameLowercase&amp;aws-products-storage.sort-order=asc" rel="noopener ugc nofollow" target="_blank">亚马逊网络服务(AWS) </a>是因为:</p><ul class=""><li id="9529" class="ne nf iq ll b lm mk lp ml ls ns lw nt ma nu me nv nk nl nm bi translated">它是世界上最全面、最广泛采用的云平台</li><li id="1f30" class="ne nf iq ll b lm nn lp no ls np lw nq ma nr me nv nk nl nm bi translated">AWS提供了一个免费层，允许免费体验一系列AWS服务</li></ul><h1 id="0466" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">2.下载Terraform和Terragrunt</h1><p id="f032" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">遵循先决条件中的说明，并使用以下命令检查是否安装了Terraform和Terragrunt:</p><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="2c07" class="ms ks iq nx b gy ob oc l od oe">$ terraform <br/>terraform<br/>Usage: terraform [global options] &lt;subcommand&gt; [args]</span><span id="2f49" class="ms ks iq nx b gy of oc l od oe">(...)</span><span id="bac8" class="ms ks iq nx b gy of oc l od oe">$ terragrunt </span><span id="e90e" class="ms ks iq nx b gy of oc l od oe">DESCRIPTION:<br/>   terragrunt - Terragrunt is a thin wrapper for Terraform that provides extra tools for working with multiple<br/>   Terraform modules, remote state, and locking. For documentation, see <a class="ae mf" href="https://github.com/gruntwork-io/terragrunt/" rel="noopener ugc nofollow" target="_blank">https://github.com/gruntwork-io/terragrunt/</a>.</span><span id="bc6d" class="ms ks iq nx b gy of oc l od oe">(...)</span></pre><h1 id="8943" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">辅导的</h1><p id="79ca" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">完成先决条件后，按照下面列出的指南创建资源。由于本指南旨在从Terraform过渡到Terragrunt，因此一些关于云的先验知识将是有益的。下面是这个过程的分解:</p><ol class=""><li id="766f" class="ne nf iq ll b lm mk lp ml ls ns lw nt ma nu me nj nk nl nm bi translated">创建IAM帐户</li><li id="31f0" class="ne nf iq ll b lm nn lp no ls np lw nq ma nr me nj nk nl nm bi translated">将密钥和访问密钥作为环境变量导出</li><li id="f9c8" class="ne nf iq ll b lm nn lp no ls np lw nq ma nr me nj nk nl nm bi translated">创建一个terragrunt.hcl文件，并将内容粘贴到模块的根级别</li><li id="9645" class="ne nf iq ll b lm nn lp no ls np lw nq ma nr me nj nk nl nm bi translated">遵循项目结构</li><li id="7afa" class="ne nf iq ll b lm nn lp no ls np lw nq ma nr me nj nk nl nm bi translated">通过运行Terragrunt命令创建S3桶和VPC</li><li id="5044" class="ne nf iq ll b lm nn lp no ls np lw nq ma nr me nj nk nl nm bi translated">继续创建AWS资源(负载平衡器、web服务器)</li><li id="e3ee" class="ne nf iq ll b lm nn lp no ls np lw nq ma nr me nj nk nl nm bi translated">启动网络服务器集群</li><li id="1305" class="ne nf iq ll b lm nn lp no ls np lw nq ma nr me nj nk nl nm bi translated">在单独的区域启动web服务器</li><li id="1712" class="ne nf iq ll b lm nn lp no ls np lw nq ma nr me nj nk nl nm bi translated">清理资源</li></ol><h2 id="ac47" class="ms ks iq bd kt mt mu dn kx mv mw dp lb ls mx my ld lw mz na lf ma nb nc lh nd bi translated">您可以在这里找到本教程的源代码:</h2><p id="238f" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated"><a class="ae mf" href="https://github.com/marwai/medium-terragrunt" rel="noopener ugc nofollow" target="_blank">https://github.com/marwai/medium-terragrunt</a></p><h1 id="58a6" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">我们开始吧！</h1><h1 id="0622" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">1.创建IAM帐户</h1><p id="97df" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">首次设置AWS帐户后，您将被分配一个名为root用户的身份。root用户使您能够拥有对AWS服务和资源的所有访问权限。建议创建一个具有有限权限的IAM帐户。当给予用户执行其功能所需的最低权限时，遵循最低权限原则是最佳实践。</p><p id="9fe8" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated"><strong class="ll ir">注</strong>:本教程不赘述IAM。拥有完全访问权限的IAM用户就足够了。</p><p id="8ac3" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated">要加强IAM访问，您可以只将以下权限附加给用户:</p><ul class=""><li id="458f" class="ne nf iq ll b lm mk lp ml ls ns lw nt ma nu me nv nk nl nm bi translated"><code class="fe og oh oi nx b">AmazonEC2FullAccess</code></li><li id="7ad5" class="ne nf iq ll b lm nn lp no ls np lw nq ma nr me nv nk nl nm bi translated"><code class="fe og oh oi nx b">AmazonS3FullAccess</code></li><li id="3629" class="ne nf iq ll b lm nn lp no ls np lw nq ma nr me nv nk nl nm bi translated"><code class="fe og oh oi nx b">IAMFullAccess</code></li></ul><p id="e592" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated">在控制台中，搜索<strong class="ll ir"> IAM </strong>。在下一页中，导航至<strong class="ll ir">用户</strong>和<strong class="ll ir">添加用户</strong>。输入适合项目的<strong class="ll ir">用户名</strong>并选择<strong class="ll ir">访问键—编程访问* </strong></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oj"><img src="../Images/340cca6f439e84c0ceb0b4775725e909.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PZmduDru2uWnrnG-16-WhA.png"/></div></div><figcaption class="ok ol gj gh gi om on bd b be z dk translated">在搜索栏中键入IAM</figcaption></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oo"><img src="../Images/8ac15d0dc9d32b5db1761f06d2536321.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UQj2xpbD9OpBxG65GyjU-g.png"/></div></div><figcaption class="ok ol gj gh gi om on bd b be z dk translated">单击IAM控制台页面右侧的“添加用户”按钮</figcaption></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi op"><img src="../Images/f78302c5d6104eaf7c096b1e441368c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UqhfhT53PUUy81Smwv5CYw.png"/></div></div></figure><h1 id="1f8a" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">2.将密钥和访问密钥作为环境变量导出</h1><p id="92be" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">访问您的终端并复制AWS凭证文件中的内容，或者直接使用<a class="ae mf" href="https://docs.aws.amazon.com/cli/latest/reference/configure/" rel="noopener ugc nofollow" target="_blank"> AWS configure </a>命令进行配置，并将访问密钥和秘密密钥作为环境变量保存到您的机器中。</p><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="2cc2" class="ms ks iq nx b gy ob oc l od oe">$ nano ~/.aws/credentials </span><span id="0f6b" class="ms ks iq nx b gy of oc l od oe">[terragrunt]<br/>aws_access_key_id=&lt;access_key&gt;<br/>aws_secret_access_key=&lt;secret_key&gt;</span><span id="8309" class="ms ks iq nx b gy of oc l od oe"># create a profile with a name of your choice, paste the format as shown and replace &lt;access_key&gt; and &lt;secret_key&gt; with the details created in AWS<br/></span><span id="507d" class="ms ks iq nx b gy of oc l od oe"># Navigate back to your project and export the profile</span><span id="e431" class="ms ks iq nx b gy of oc l od oe">$ cd ~/Documents/terragrunt-medium</span><span id="e8f8" class="ms ks iq nx b gy of oc l od oe">$ export AWS_PROFILE=terragrunt </span></pre><p id="ea2d" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated">使用你选择的文本编辑器，vim或nano输入你的密码和访问密钥。</p><h1 id="3658" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">3.创建一个terragrunt.hcl文件，并将内容粘贴到模块的根级别</h1><p id="3819" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">Terragrunt保持后端配置干燥。它是在根级别定义的，子模块使用<code class="fe og oh oi nx b">.hcl</code>继承配置</p><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="ef2e" class="ms ks iq nx b gy ob oc l od oe">$ touch terragrunt.hcl</span><span id="c8b7" class="ms ks iq nx b gy of oc l od oe"># Copy the contents below into the file <br/>remote_state {<br/>  backend = "s3"<br/>  config = {<br/>    bucket  = "medium-terragrunt-example"<br/>    key     = "terragrunted/${path_relative_to_include()}.tfstate"<br/>    region  = "eu-west-1"<br/>    encrypt = true<br/>  }<br/>}</span><span id="68e5" class="ms ks iq nx b gy of oc l od oe">terraform {<br/>  extra_arguments "common_vars" {<br/>    commands = get_terraform_commands_that_need_vars()<br/>    optional_var_files = [<br/>      find_in_parent_folders("regional.tfvars"),<br/>    ]<br/>  }<br/>}</span><span id="b530" class="ms ks iq nx b gy of oc l od oe">generate "providers" {<br/>  path      = "providers.tf"<br/>  if_exists = "overwrite"<br/>  contents  = &lt;&lt;EOF<br/>provider "aws" {<br/>  region = var.aws_region<br/>}</span><span id="d7d5" class="ms ks iq nx b gy of oc l od oe">variable "aws_region" {<br/>  description = "AWS region to create infrastructure in"<br/>  type        = string<br/>}</span><span id="1550" class="ms ks iq nx b gy of oc l od oe">terraform {<br/>  backend "s3" {<br/>  }<br/>}</span><span id="db4a" class="ms ks iq nx b gy of oc l od oe">EOF<br/>}</span></pre><p id="9408" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated">复制上面的代码，并确保区域是适当的，并且bucket名称是全局唯一的。</p><ul class=""><li id="5bc3" class="ne nf iq ll b lm mk lp ml ls ns lw nt ma nu me nv nk nl nm bi translated"><code class="fe og oh oi nx b">remote state</code> : Terraform将状态数据存储在远程数据存储中，可以在团队的所有成员之间共享。该工具支持在<a class="ae mf" href="https://www.hashicorp.com/products/terraform/" rel="noopener ugc nofollow" target="_blank">地形云</a>、<a class="ae mf" href="https://www.consul.io/" rel="noopener ugc nofollow" target="_blank">哈希公司咨询</a>、亚马逊S3等存储状态。在本例中，远程状态存储在一个名为<em class="mj"> medium-terragrunt-example、</em>的S3桶中，密钥<em class="mj">terra grunt/relative _ file _ path、</em>位于<em class="mj"> eu-west-1区域</em>中，最后确保被加密。</li><li id="c91e" class="ne nf iq ll b lm nn lp no ls np lw nq ma nr me nv nk nl nm bi translated"><code class="fe og oh oi nx b">generate</code>:这可用于生成多个Terraform模块共享的通用terraform配置。在这个例子中，可以通过将代码块放在根级别来一致地创建提供者块</li><li id="1428" class="ne nf iq ll b lm nn lp no ls np lw nq ma nr me nv nk nl nm bi translated"><code class="fe og oh oi nx b">S3</code>:将“中型-地形起伏-示例”改为全球唯一的<strong class="ll ir"/>，见下图:</li></ul><blockquote class="mg mh mi"><p id="63ea" class="lj lk mj ll b lm mk jr lo lp ml ju lr mm mn lu lv mo mp ly lz mq mr mc md me ij bi translated">全局唯一，命名空间由所有AWS帐户共享。这意味着在创建一个存储桶后，该存储桶的名称不能被任何AWS区域中的其他AWS帐户使用，直到该存储桶被删除。</p></blockquote><p id="c8fe" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated"><em class="mj">来源:</em><a class="ae mf" href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/UsingBucket.html" rel="noopener ugc nofollow" target="_blank"><em class="mj">https://docs . AWS . Amazon . com/Amazon S3/latest/user guide/using bucket . html</em></a></p><h1 id="b7d2" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">4.遵循项目结构</h1><p id="d2c8" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">本教程将遵循一个相对扁平的模块结构来实现可重用的基础设施。模块可以用来创建更轻的抽象和独立的服务，而不是像一个整体一样有一个中心的main.tf或terragrunt.hcl。</p><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="6fc5" class="ms ks iq nx b gy ob oc l od oe">├── Medium<br/>│   └── eu-west-1<br/>│       ├── infrastructure<br/>│       │   └── vpc<br/>│       └── regional.tfvars<br/>├── modules<br/>└── terragrunt.hcl</span></pre><p id="19f2" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated">要创建上面的结构，请复制下面的代码:</p><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="75f4" class="ms ks iq nx b gy ob oc l od oe">$ mkdir -p medium/eu-west-1/infrastructure/vpc &amp;&amp; touch medium/eu-west-1/regional.tfvars &amp;&amp; mkdir modules </span><span id="ed28" class="ms ks iq nx b gy of oc l od oe">$ touch README.md </span><span id="46c0" class="ms ks iq nx b gy of oc l od oe">$ cd medium/eu-west-1/infrastructure/vpc &amp;&amp; touch terragrunt.hcl</span></pre><p id="e50d" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated">导航到<strong class="ll ir">Medium/eu-west-1/infra structure/VPC:</strong>中的terragrunt.hcl文件</p><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="8741" class="ms ks iq nx b gy ob oc l od oe">$ cd Medium/eu-west-1/infrastructure/vpc</span><span id="2601" class="ms ks iq nx b gy of oc l od oe"># Copy contents below </span><span id="d8ff" class="ms ks iq nx b gy of oc l od oe">include {<br/>  path = find_in_parent_folders()<br/>}</span><span id="9acb" class="ms ks iq nx b gy of oc l od oe">terraform {<br/>  source = "git::https://github.com/terraform-aws-modules/terraform-aws-vpc.git//?ref=v3.11.0"</span><span id="b6e5" class="ms ks iq nx b gy of oc l od oe">  extra_arguments "init_args" {<br/>    commands = [<br/>      "init"<br/>    ]</span><span id="ff6b" class="ms ks iq nx b gy of oc l od oe">    arguments = [<br/>    ]<br/>  }<br/>}</span><span id="2fee" class="ms ks iq nx b gy of oc l od oe">inputs = {<br/>  name = "Main"<br/>  cidr = "10.0.0.0/16"</span><span id="8645" class="ms ks iq nx b gy of oc l od oe">  azs             = ["eu-west-1a", "eu-west-1b", "eu-west-1c"]<br/>  private_subnets = ["10.0.1.0/24", "10.0.2.0/24", "10.0.3.0/24"]<br/>  public_subnets    = ["10.0.101.0/24", "10.0.102.0/24", "10.0.103.0/24"]</span><span id="306b" class="ms ks iq nx b gy of oc l od oe">  enable_nat_gateway    = true<br/>  single_nat_gateway    = true<br/>  enable_dns_hostnames  = true<br/>  enable_dns_support    = true</span><span id="45a0" class="ms ks iq nx b gy of oc l od oe">  tags = {<br/>    Name        = "VPC" <br/>    Owner       = ""<br/>    Contact     = ""<br/>    Project     = "Terragrunt Medium"<br/>    Environment = "Development"<br/>  }<br/>}</span></pre><blockquote class="mg mh mi"><p id="eeff" class="lj lk mj ll b lm mk jr lo lp ml ju lr mm mn lu lv mo mp ly lz mq mr mc md me ij bi translated">默认VPC可供您使用，因此您无需创建和配置自己的VPC。您可以立即将Amazon EC2实例启动到您的默认VPC中。</p></blockquote><p id="9629" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated"><em class="mj">来源:</em><a class="ae mf" href="https://docs.aws.amazon.com/vpc/latest/userguide/default-vpc.html" rel="noopener ugc nofollow" target="_blank"><em class="mj">https://docs . AWS . Amazon . com/VPC/latest/user guide/default-VPC . html</em></a></p><p id="b872" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated">自2013年12月4日起，创建AWS帐户将自动生成一个配置到路由表和互联网网关的默认VPC。它可以很容易地启动EC2实例以及AWS服务。在本教程中，我们将创建一个自定义VPC来进行实践。为了网络和安全，建议使用新的VPC。用户可以准确管理哪些流量可以通过网络。</p><p id="9a7c" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated">导航到<strong class="ll ir">Medium/eu-west-1/regional . TF vars</strong>中的terragrunt.hcl文件，以复制静态值:</p><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="a152" class="ms ks iq nx b gy ob oc l od oe">aws_region = "eu-west-1"</span></pre><h1 id="d2c5" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">5.通过运行Terragrunt命令创建S3桶和VPC</h1><p id="52f9" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">本教程将使用基本的<a class="ae mf" href="https://terragrunt.gruntwork.io/docs/reference/cli-options/#cli-commands" rel="noopener ugc nofollow" target="_blank"> CLI Terragrunt命令</a>。首先，制定一个执行计划，将基础架构的当前状态与期望状态进行比较:</p><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="d11b" class="ms ks iq nx b gy ob oc l od oe"># navigate to <strong class="nx ir">medium/eu-west-1/infrastructure/vpc</strong> and run the following </span><span id="36f7" class="ms ks iq nx b gy of oc l od oe">$ terragrunt plan </span><span id="e6cf" class="ms ks iq nx b gy of oc l od oe">Remote state S3 bucket medium-terragrunt-example does not exist or you don't have permissions to access it. Would you like Terragrunt to create it? (y/n)</span><span id="b0bd" class="ms ks iq nx b gy of oc l od oe"># Terragrunt automatically creates a bucket for you if one hasn’t been created.</span><span id="5151" class="ms ks iq nx b gy of oc l od oe">$ y</span><span id="d059" class="ms ks iq nx b gy of oc l od oe">Initializing the backend...</span><span id="30c0" class="ms ks iq nx b gy of oc l od oe">Successfully configured the backend "s3"! Terraform will automatically<br/>use this backend unless the backend configuration changes.</span><span id="37b8" class="ms ks iq nx b gy of oc l od oe">(...)</span><span id="f7ea" class="ms ks iq nx b gy of oc l od oe">Plan: 20 to add, 0 to change, 0 to destroy.</span><span id="2862" class="ms ks iq nx b gy of oc l od oe">(...)</span></pre><p id="6c74" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated">如上面的代码所示，不需要手动初始化文件。Terragrunt具有自动初始化功能，如官方文档<a class="ae mf" href="https://terragrunt.gruntwork.io/docs/features/auto-init/" rel="noopener ugc nofollow" target="_blank">中所述</a>:</p><blockquote class="mg mh mi"><p id="adaf" class="lj lk mj ll b lm mk jr lo lp ml ju lr mm mn lu lv mo mp ly lz mq mr mc md me ij bi translated">自动初始化是Terragrunt的一个特性，它使得<code class="fe og oh oi nx b">terragrunt init</code>不需要在其他Terragrunt命令之前被显式调用。</p></blockquote><p id="ef94" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated"><em class="mj">来源:</em><a class="ae mf" href="https://terragrunt.gruntwork.io/docs/features/auto-init/" rel="noopener ugc nofollow" target="_blank"><em class="mj">https://terragrunt.gruntwork.io/docs/features/auto-init/</em></a></p><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="d714" class="ms ks iq nx b gy ob oc l od oe">$ terragrunt apply </span><span id="8029" class="ms ks iq nx b gy of oc l od oe">...<br/> vpc_ipv6_cidr_block                         = (known after apply)<br/>  + vpc_main_route_table_id                     = (known after apply)<br/>  + vpc_owner_id                                = (known after apply)<br/>  + vpc_secondary_cidr_blocks                   = []</span><span id="e735" class="ms ks iq nx b gy of oc l od oe">Do you want to perform these actions?<br/>  Terraform will perform the actions described above.<br/>  Only 'yes' will be accepted to approve.</span><span id="c783" class="ms ks iq nx b gy of oc l od oe">Enter a value: <strong class="nx ir">yes</strong></span></pre><p id="4d32" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated"><em class="mj">提示:首次创建VPC需要几分钟时间。</em></p><h1 id="858e" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">6.设置应用程序负载平衡器</h1><p id="39c7" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">导航至<strong class="ll ir">/基础设施</strong>并设置以下模块:</p><ul class=""><li id="8edd" class="ne nf iq ll b lm mk lp ml ls ns lw nt ma nu me nv nk nl nm bi translated">负载平衡器/外部-alb</li><li id="5eba" class="ne nf iq ll b lm nn lp no ls np lw nq ma nr me nv nk nl nm bi translated">负载平衡器/外部安全组</li></ul><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="7dd4" class="ms ks iq nx b gy ob oc l od oe">$ pwd </span><span id="4218" class="ms ks iq nx b gy of oc l od oe">terragrunt-medium/Medium/eu-west-1/infrastructure/vpc</span><span id="d81f" class="ms ks iq nx b gy of oc l od oe"># Navigate to the infrastructure <br/>$ cd ../infrastructure <br/></span><span id="b652" class="ms ks iq nx b gy of oc l od oe">$ mkdir -p load-balancer/external-alb load-balancer/external-security-group</span></pre><h2 id="e947" class="ms ks iq bd kt mt mu dn kx mv mw dp lb ls mx my ld lw mz na lf ma nb nc lh nd bi translated">创建外部安全组</h2><p id="3077" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">导航到<strong class="ll ir">外部安全组</strong>并为外部安全组模块创建一个<strong class="ll ir"> terragrunt.hcl </strong>。</p><p id="740f" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated">在terragrunt.hcl中，复制以下内容:</p><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="85dd" class="ms ks iq nx b gy ob oc l od oe">include {<br/>  path = find_in_parent_folders()<br/>}</span><span id="5c42" class="ms ks iq nx b gy of oc l od oe">terraform {<br/>  source = "git::<a class="ae mf" href="https://github.com/terraform-aws-modules/terraform-aws-security-group.git//?ref=v4.3.0" rel="noopener ugc nofollow" target="_blank">https://github.com/terraform-aws-modules/terraform-aws-security-group.git//?ref=v4.3.0</a>"</span><span id="4f36" class="ms ks iq nx b gy of oc l od oe">extra_arguments "init_args" {<br/>    commands = [<br/>      "init"<br/>    ]</span><span id="fb14" class="ms ks iq nx b gy of oc l od oe">arguments = [<br/>    ]<br/>  }</span><span id="2186" class="ms ks iq nx b gy of oc l od oe">}</span><span id="49df" class="ms ks iq nx b gy of oc l od oe">dependency "vpc" {<br/>  config_path = "../..//vpc"<br/>}</span><span id="ef89" class="ms ks iq nx b gy of oc l od oe">inputs = {<br/>  name        = "external-security-group"<br/>  description = "SG to use with external ALB, allow specific traffic internally but limit based on route based rules"<br/>  vpc_id      = dependency.vpc.outputs.vpc_id<br/>  ingress_cidr_blocks = concat(<br/>    ["&lt;INSERT-YOUR-OWN-IP&gt;/32"]<br/>  )<br/> <br/>  ingress_rules = ["http-80-tcp"]<br/>  egress_with_cidr_blocks = [<br/>    {<br/>      from_port   = 0<br/>      to_port     = 0<br/>      protocol    = "-1"<br/>      description = "All egress"<br/>      cidr_blocks = "0.0.0.0/0"<br/>    }<br/>  ]</span><span id="d3f0" class="ms ks iq nx b gy of oc l od oe">tags = {<br/>    Name        = "external-lb-security-group"<br/>    Owner       = "&lt;INSERT-COMPANY-NAME&gt;"<br/>    Contact     = "&lt;INSERT-NAME&gt;"<br/>    Project     = "Terragrunt Medium"<br/>    Environment = "Development"<br/>  }<br/>}</span></pre><p id="ce91" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated">用您的IP和详细信息更新第28、44、45行(可选)。IP应该包括/32前缀长度。</p><p id="40b0" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated">部署应用程序负载平衡器</p><p id="76aa" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated">导航到<strong class="ll ir">负载平衡器/外部-alb </strong>到<strong class="ll ir"> </strong>将以下内容复制到terragrunt.hcl:</p><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="c4bf" class="ms ks iq nx b gy ob oc l od oe">include {<br/>  path = find_in_parent_folders()<br/>}</span><span id="999a" class="ms ks iq nx b gy of oc l od oe">terraform {<br/>  source = "git::<a class="ae mf" href="https://github.com/terraform-aws-modules/terraform-aws-alb.git//?ref=v6.6.1" rel="noopener ugc nofollow" target="_blank">https://github.com/terraform-aws-modules/terraform-aws-alb.git//?ref=v6.6.1</a>"</span><span id="970e" class="ms ks iq nx b gy of oc l od oe">extra_arguments "init_args" {<br/>    commands = [<br/>      "init"<br/>    ]</span><span id="3c5b" class="ms ks iq nx b gy of oc l od oe">arguments = [<br/>    ]<br/>  }</span><span id="360b" class="ms ks iq nx b gy of oc l od oe">}</span><span id="57d2" class="ms ks iq nx b gy of oc l od oe">dependency "vpc" {<br/>  config_path = "../../vpc"<br/>}</span><span id="628e" class="ms ks iq nx b gy of oc l od oe">dependency "external-security-group" {<br/>  config_path = "../external-security-group/"<br/>}</span><span id="643d" class="ms ks iq nx b gy of oc l od oe">inputs = {<br/>  name               = "external-alb"<br/>  load_balancer_type = "application"<br/>  vpc_id             = dependency.vpc.outputs.vpc_id<br/>  subnets            = dependency.vpc.outputs.public_subnets<br/>  security_groups    = [dependency.external-security-group.outputs.security_group_id]<br/>  internal           = false<br/>  target_groups = [<br/>    {<br/>      name             = "external-route-to-nothing"<br/>      backend_protocol = "HTTP"<br/>      backend_port     = "80"<br/>    }<br/>  ]<br/>  http_tcp_listeners = [<br/>    {<br/>      port     = "80"<br/>      protocol = "HTTP"<br/>    }<br/>  ]<br/>  tags = {<br/>    Service     = "external-alb"<br/>    Owner       = "&lt;INSERT-COMPANY-NAME&gt;"<br/>    Contact     = "&lt;INSERT-NAME&gt;"<br/>    Project     = "Terragrunt Medium"<br/>    Environment = "Development"<br/>  }<br/>}</span></pre><h2 id="161a" class="ms ks iq bd kt mt mu dn kx mv mw dp lb ls mx my ld lw mz na lf ma nb nc lh nd bi translated">Terragrunt运行-全部适用</h2><p id="72a1" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">运行以下命令，在提示三次后输入<strong class="ll ir"> y </strong>。run-all命令可用于跨多个模块应用各种更改，而不是像使用terraform一样单独运行“terraform apply”或“terragrunt apply”。</p><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="15b2" class="ms ks iq nx b gy ob oc l od oe">$ terragrunt run-all apply</span><span id="e804" class="ms ks iq nx b gy of oc l od oe">Are you sure you want to run 'terragrunt apply' in each folder of the stack described above? (y/n) y</span><span id="a929" class="ms ks iq nx b gy of oc l od oe">$ y </span><span id="0c26" class="ms ks iq nx b gy of oc l od oe">(...)</span><span id="69d1" class="ms ks iq nx b gy of oc l od oe">lb_dns_name = "external-alb-419927666.eu-west-1.elb.amazonaws.com"</span></pre><p id="2574" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated">复制lb_dns_name的输出，供以后使用。</p><h1 id="89b1" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">7.启动网络服务器集群</h1><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="c6c4" class="ms ks iq nx b gy ob oc l od oe">$ cd ../../../../../modules/<br/>$ mkdir web-server<br/>$ cd web-server<br/>$ mkdir lib &amp;&amp; touch main.tf</span></pre><p id="b0ec" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated">首先，创建一个名为lib/ <strong class="ll ir"> web_server.sh.tpl </strong>的文件，内容如下:</p><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="37c0" class="ms ks iq nx b gy ob oc l od oe">#!/bin/bash<br/>apt update -y<br/>apt install apache2 -y<br/>systemctl start apache2<br/>bash -c 'echo The webpage is fully functioning! &gt; /var/www/html/index.html'</span></pre><p id="e76b" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated">这是一个bash脚本，写着“网页功能齐全！”去index.html。</p><p id="2fc0" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated">接下来，将以下内容插入main.tf:</p><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="828f" class="ms ks iq nx b gy ob oc l od oe">####################################################################<br/>##                       Data sources                             ##                      <br/>####################################################################<br/>data "aws_iam_account_alias" "current" {<br/>}</span><span id="a149" class="ms ks iq nx b gy of oc l od oe">####################################################################<br/>##                        EC2                                     ##                      <br/>####################################################################<br/>data "aws_iam_policy_document" "ec2_role_trust" {<br/>  statement {<br/>    actions = ["sts:AssumeRole"]<br/>    effect  = "Allow"<br/>    principals {<br/>      type        = "Service"<br/>      identifiers = ["ec2.amazonaws.com"]<br/>    }<br/>  }<br/>}<br/>data "aws_ami" "ec2" {<br/>  most_recent = true<br/>filter {<br/>    name   = "name"<br/>    values = ["ubuntu/images/hvm-ssd/ubuntu-focal-20.04-amd64-server-*"]<br/>  }<br/>filter {<br/>    name   = "virtualization-type"<br/>    values = ["hvm"]<br/>  }<br/>owners = ["099720109477"]<br/>}<br/>####################################################################<br/>##                             IAM                                ##                      <br/>####################################################################<br/>resource "aws_iam_instance_profile" "instance_profile" {<br/>  name = "${var.environment}-${var.service}"<br/>  role = aws_iam_role.iam_role.name<br/>}<br/># IAM Role<br/>resource "aws_iam_role" "iam_role" {<br/>  name               = "${var.environment}-${var.service}"<br/>  assume_role_policy = data.aws_iam_policy_document.ec2_role_trust.json<br/>}<br/>####################################################################<br/>##                       Autoscaling Group                        ##                      <br/>####################################################################<br/>resource "aws_autoscaling_group" "dev" {<br/>  name                      = "${var.environment}-${var.service}-asg"<br/>  max_size                  = var.max<br/>  min_size                  = var.min<br/>  desired_capacity          = var.desired_capacity<br/>  health_check_grace_period = 300<br/>  health_check_type         = "EC2"<br/># EC2 instead of ELB, now load balancer only serves when ec2 is healthy<br/>  force_delete         = true<br/>  launch_configuration = aws_launch_configuration.dev.name<br/>  vpc_zone_identifier  = var.private_subnet_ids<br/>  target_group_arns    = [aws_lb_target_group.web_server.arn]<br/>  lifecycle {<br/>    create_before_destroy = true<br/>  }<br/>}<br/>####################################################################<br/>##                        Launch Configuration                    ##                      <br/>####################################################################<br/>resource "aws_launch_configuration" "dev" {<br/>  name_prefix          = "${var.environment}-${var.service}-web-config"<br/>  image_id             = data.aws_ami.ec2.id<br/>  instance_type        = var.instance_type<br/>  security_groups      = [aws_security_group.security_group.id]<br/>  iam_instance_profile = aws_iam_instance_profile.instance_profile.id<br/>  enable_monitoring    = true<br/>  user_data = templatefile("${path.module}/lib/web_server.sh.tpl",<br/>    {<br/>      service_name     = var.service<br/>      environment      = var.environment<br/>      aws_account_name = data.aws_iam_account_alias.current.account_alias<br/>  })<br/>  root_block_device {<br/>    encrypted = true<br/>  }<br/>  lifecycle {<br/>    create_before_destroy = true<br/>  }<br/>}<br/>####################################################################<br/>##                             Listener Rule                      ##         <br/>####################################################################<br/>resource "aws_lb_listener_rule" "external_forwarder_rule" {<br/>  listener_arn = var.external_lb_listener_arn<br/>  action {<br/>    type             = "forward"<br/>    target_group_arn = aws_lb_target_group.web_server.arn<br/>  }<br/>  condition {<br/>    path_pattern {<br/>      values = ["/"]<br/>    }<br/>  }<br/>  priority = 1<br/>}</span><span id="8a2c" class="ms ks iq nx b gy of oc l od oe">####################################################################<br/>##                                Security Group                  ##<br/>####################################################################</span><span id="1f53" class="ms ks iq nx b gy of oc l od oe">resource "aws_security_group" "security_group" {<br/>  name   = "${var.environment}-${var.service}-instance-sg"<br/>  vpc_id = var.vpc_id</span><span id="5e48" class="ms ks iq nx b gy of oc l od oe">tags = {<br/>    Name = "web-security-group"<br/>  }<br/>}</span><span id="eb84" class="ms ks iq nx b gy of oc l od oe">####################################################################<br/>##                          Security Group Rules                  ##            <br/>####################################################################<br/># Inbound HTTP Port<br/>resource "aws_security_group_rule" "external_port" {<br/>  description       = "Ingress port - 80"<br/>  from_port         = 80<br/>  protocol          = "tcp"<br/>  security_group_id = aws_security_group.security_group.id<br/>  # security_group_id        = <br/>  to_port                  = 80<br/>  type                     = "ingress"<br/>  source_security_group_id = var.external_lb_security_group_id<br/>}<br/># egress all<br/>resource "aws_security_group_rule" "egress_all" {<br/>  description       = "Egress all"<br/>  type              = "egress"<br/>  to_port           = 0<br/>  from_port         = 0<br/>  protocol          = "-1"<br/>  security_group_id = aws_security_group.security_group.id<br/>  cidr_blocks       = ["0.0.0.0/0"]<br/>}<br/>####################################################################<br/>##                          Target Group                          ##            <br/>####################################################################<br/>resource "aws_lb_target_group" "web_server" {<br/>  health_check {<br/>    interval            = 20<br/>    path                = "/"<br/>    protocol            = "HTTP"<br/>    timeout             = 10<br/>    healthy_threshold   = 3<br/>    unhealthy_threshold = 5<br/>  }</span><span id="7f27" class="ms ks iq nx b gy of oc l od oe">name        = "${var.environment}-http"<br/>  port        = 80<br/>  protocol    = "HTTP"<br/>  vpc_id      = var.vpc_id<br/>  target_type = "instance"</span><span id="7bcf" class="ms ks iq nx b gy of oc l od oe">tags = {<br/>    Name = "${var.environment}-${var.service}-http-target-group"<br/>  }</span><span id="704d" class="ms ks iq nx b gy of oc l od oe">lifecycle {<br/>    create_before_destroy = true<br/>  }<br/>}</span><span id="af34" class="ms ks iq nx b gy of oc l od oe">####################################################################<br/>##                             Variables                          ##<br/>####################################################################</span><span id="bb07" class="ms ks iq nx b gy of oc l od oe">variable "environment" {<br/>  default     = "tools"<br/>  type        = string<br/>  description = "Environment name"<br/>}</span><span id="ab4f" class="ms ks iq nx b gy of oc l od oe">variable "service" {<br/>  default     = "web-server"<br/>  type        = string<br/>  description = "Service name"<br/>}</span><span id="9b35" class="ms ks iq nx b gy of oc l od oe">variable "instance_type" {<br/>  default     = "t2.micro"<br/>  type        = string<br/>  description = "type of instance"<br/>}</span><span id="9c18" class="ms ks iq nx b gy of oc l od oe">variable "vpc_id" {<br/>  type        = string<br/>  description = "ID of the VPC"<br/>}</span><span id="9155" class="ms ks iq nx b gy of oc l od oe">variable "private_subnet_ids" {<br/>  type        = list(string)<br/>  description = "ID of the private subnet"<br/>}</span><span id="22b2" class="ms ks iq nx b gy of oc l od oe">variable "public_subnet_ids" {<br/>  type        = list(string)<br/>  description = "ID of the subnet subnet"<br/>}</span><span id="642f" class="ms ks iq nx b gy of oc l od oe">variable "max" {<br/>  default     = 6<br/>  type        = number<br/>  description = "Maximum number of autoscaling group instances"<br/>}</span><span id="995e" class="ms ks iq nx b gy of oc l od oe">variable "min" {<br/>  default     = 3<br/>  type        = number<br/>  description = "Minimum number of autoscaling groups instances"<br/>}</span><span id="cfc5" class="ms ks iq nx b gy of oc l od oe">variable "desired_capacity" {<br/>  default     = 3<br/>  type        = number<br/>  description = "Desired number of Autoscaling Groups"<br/>}</span><span id="07ea" class="ms ks iq nx b gy of oc l od oe">variable "log_expire_days" {<br/>  default     = 7<br/>  type        = number<br/>  description = "value"<br/>}</span><span id="23c5" class="ms ks iq nx b gy of oc l od oe">variable "available_zones" {<br/>  type = list(string)<br/>}</span><span id="34cd" class="ms ks iq nx b gy of oc l od oe">variable "company_name" {<br/>  default     = "Change this to the client"<br/>  type        = string<br/>  description = "Name of the company"<br/>}</span><span id="d768" class="ms ks iq nx b gy of oc l od oe">variable "lb_ingress_rules" {<br/>  default     = ["null"]<br/>  type        = list(string)<br/>  description = "allowed ips to web-server"<br/>}</span><span id="f135" class="ms ks iq nx b gy of oc l od oe">variable "create_load_balancer" {<br/>  default     = true<br/>  type        = bool<br/>  description = "whether to create resource"<br/>}</span><span id="d6e6" class="ms ks iq nx b gy of oc l od oe">variable "external_target_group_arns" {<br/>  type    = list(string)<br/>  default = []<br/>}</span><span id="8810" class="ms ks iq nx b gy of oc l od oe">variable "project_name" {<br/>  type    = string<br/>  default = "Medium"<br/>}</span><span id="59ea" class="ms ks iq nx b gy of oc l od oe">variable "external_lb_listener_arn" {<br/>  type        = string<br/>  default     = ""<br/>  description = "Listener arn for the external load balancer"<br/>}</span><span id="c5b7" class="ms ks iq nx b gy of oc l od oe">variable "external_lb_name" {<br/>  type        = string<br/>  description = "Name of external load balancer"<br/>  default     = "medium-lb"<br/>}</span><span id="82e5" class="ms ks iq nx b gy of oc l od oe">variable "external_lb_zone_id" {<br/>  type        = string<br/>  description = "Zone ID of external load balancer"<br/>}</span><span id="9d86" class="ms ks iq nx b gy of oc l od oe">variable "external_lb_security_group_id" {<br/>  type        = string<br/>  description = "Security group of external load balancer"<br/>}</span><span id="95b6" class="ms ks iq nx b gy of oc l od oe">####################################################################<br/>##                          Output                                ##                                        <br/>####################################################################<br/>output "asg_arn" {<br/>  value = aws_autoscaling_group.dev.arn<br/>}</span></pre><p id="9a53" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated">一旦您复制了上面的配置，您将需要调用顶层的模块。然后，导航到<strong class="ll ir"> Medium/eu-west-1/ </strong>，创建一个新文件夹<strong class="ll ir"> services/web-server/ </strong>，并再次创建一个<strong class="ll ir"> terragrunt.hcl </strong>文件。</p><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="d27f" class="ms ks iq nx b gy ob oc l od oe">$ cd Medium/eu-west-1/ &amp;&amp; mkdir services/web-server/<br/>$ touch terragrunt.hcl</span></pre><p id="f8f7" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated">在terragrunt.hcl文件中，复制以下内容:</p><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="dab1" class="ms ks iq nx b gy ob oc l od oe">include {<br/>  path = find_in_parent_folders()<br/>}</span><span id="2d3d" class="ms ks iq nx b gy of oc l od oe">terraform {<br/>  source = "../../../../modules//web-server"</span><span id="c115" class="ms ks iq nx b gy of oc l od oe">extra_arguments "init_args" {<br/>    commands = [<br/>      "init"<br/>    ]</span><span id="46f4" class="ms ks iq nx b gy of oc l od oe">arguments = [<br/>    ]<br/>  }</span><span id="5fe8" class="ms ks iq nx b gy of oc l od oe">}</span><span id="34d6" class="ms ks iq nx b gy of oc l od oe">dependency "vpc" {<br/>  config_path = "../../infrastructure/vpc"<br/>}</span><span id="f678" class="ms ks iq nx b gy of oc l od oe">dependency "external_alb" {<br/>  config_path = "../../infrastructure/load-balancer/external-alb"<br/>}</span><span id="ae8d" class="ms ks iq nx b gy of oc l od oe">dependency "external_security_group" {<br/>  config_path = "../../infrastructure/load-balancer/external-security-group"<br/>}</span><span id="ed53" class="ms ks iq nx b gy of oc l od oe">inputs = {</span><span id="3625" class="ms ks iq nx b gy of oc l od oe"># VPC<br/>  available_zones    = dependency.vpc.outputs.azs<br/>  vpc_id             = dependency.vpc.outputs.vpc_id<br/>  private_subnet_ids = dependency.vpc.outputs.private_subnets<br/>  public_subnet_ids  = dependency.vpc.outputs.public_subnets</span><span id="6e8d" class="ms ks iq nx b gy of oc l od oe"># Set Inputs<br/>  company_name     = "and"<br/>  lb_ingress_rules = [&lt;YOUR-IP&gt;/32] # CHANGE THIS TO YOUR IP<br/>  project_name     = "Terragrunt Medium"</span><span id="22a0" class="ms ks iq nx b gy of oc l od oe"># listener configuration <br/>  external_lb_security_group_id = dependency.external_security_group.outputs.security_group_id<br/>  external_lb_listener_arn      = dependency.external_alb.outputs.http_tcp_listener_arns[0]<br/>  external_lb_name              = dependency.external_alb.outputs.lb_dns_name<br/>  external_lb_zone_id           = dependency.external_alb.outputs.lb_zone_id<br/>  external_target_group_arns    = dependency.external_alb.outputs.target_group_arns</span><span id="a92c" class="ms ks iq nx b gy of oc l od oe">tags = {<br/>    Name        = "Terragrunt-VPC"<br/>    Owner       = "&lt;INSERT-COMPANY-NAME&gt;"<br/>    Contact     = "&lt;INSERT-NAME&gt;"<br/>    Project     = "Terragrunt Medium"<br/>    Environment = "Development"<br/>  }<br/>}</span></pre><p id="d001" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated">整体结构应该是这样的:</p><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="100b" class="ms ks iq nx b gy ob oc l od oe">├── Medium<br/>│   ├── eu-west-1<br/>│      ├── infrastructure<br/>│      │   ├── load-balancer<br/>│      │   │   ├── external-alb<br/>│      │   │   │   └── terragrunt.hcl<br/>│      │   │   └── external-security-group<br/>│      │   │       └── terragrunt.hcl<br/>│      │   └── vpc<br/>│      │       └── terragrunt.hcl<br/>│      ├── regional.tfvars<br/>│      └── services<br/>│          └── web-server<br/>│              └── terragrunt.hcl<br/>├── README.md<br/>├── modules<br/>│   └── web-server<br/>│       ├── README.md<br/>│       ├── lib<br/>│       │   └── web_server.sh.tpl<br/>│       └── main.tf<br/>└── terragrunt.hcl</span></pre><p id="0eab" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated">现在，检查计划并应用更改。应用更改后，您可以转到AWS控制台，查看自动缩放组、启动配置、安全组和目标组中更新的配置。</p><p id="7de2" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated">Terragrunt应用:</p><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="13d2" class="ms ks iq nx b gy ob oc l od oe"># Run terragrunt apply and read through the output. Type "yes" and hit enter.</span><span id="130e" class="ms ks iq nx b gy of oc l od oe">$ terragrunt apply <br/>(...)</span><span id="4e46" class="ms ks iq nx b gy of oc l od oe"># aws_security_group_rule.external_port will be created<br/>  + resource "aws_security_group_rule" "external_port" {<br/>      + description              = "Ingress port - 80"<br/>      + from_port                = 80<br/>      + id                       = (known after apply)<br/>      + protocol                 = "tcp"<br/>      + security_group_id        = (known after apply)<br/>      + self                     = false<br/>      + source_security_group_id = "sg-097110dc519ca5ef7"<br/>      + to_port                  = 80<br/>      + type                     = "ingress"<br/>    }</span><span id="3534" class="ms ks iq nx b gy of oc l od oe">Plan: 9 to add, 0 to change, 0 to destroy.</span><span id="c37b" class="ms ks iq nx b gy of oc l od oe">Changes to Outputs:<br/>  + asg_arn = (known after apply)</span></pre><p id="7dd6" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated">将之前的dns名称粘贴到您的浏览器中，或将以下内容粘贴到终端中:</p><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="fd8e" class="ms ks iq nx b gy ob oc l od oe">lb_dns_name = "external-alb-419927666.eu-west-1.elb.amazonaws.com"</span><span id="b762" class="ms ks iq nx b gy of oc l od oe">$ curl external-alb-419927666.eu-west-1.elb.amazonaws.com<br/>The webpage is fully functioning!</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oq"><img src="../Images/422cf08ef94a8db8ce356f792ca86175.png" data-original-src="https://miro.medium.com/v2/resize:fit:1394/format:webp/1*5PsqoRIwHSoul4XrU2juHg.png"/></div></figure><p id="b960" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated">恭喜你，你已经用Terragrunt创建了你的第一个web服务器集群！您可以通过终止实例来测试ASG。为此，转到<strong class="ll ir">实例</strong> &gt;点击<strong class="ll ir">实例状态</strong>按钮&gt; <strong class="ll ir">终止实例</strong>。ASG将检测到更改，并启动替换实例来维护该组所需的容量。</p><h2 id="d1c5" class="ms ks iq bd kt mt mu dn kx mv mw dp lb ls mx my ld lw mz na lf ma nb nc lh nd bi translated">8.在单独的区域启动网络服务器</h2><p id="ca4b" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">网络服务器目前仅在eu-west-1中可用，要复制eu-west-2中的基础架构，请遵循以下步骤:</p><ul class=""><li id="0f5d" class="ne nf iq ll b lm mk lp ml ls ns lw nt ma nu me nv nk nl nm bi translated">复制并粘贴eu-west-1的整个配置</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi or"><img src="../Images/a4aea4b28ae426fe92d773a040b791fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:734/format:webp/1*SCiwBc01hSdXCauUpH1BvA.png"/></div></div></figure><ul class=""><li id="6e72" class="ne nf iq ll b lm mk lp ml ls ns lw nt ma nu me nv nk nl nm bi translated">将名称重命名为<code class="fe og oh oi nx b">eu-west-2</code></li></ul><p id="4a74" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated">在<strong class="ll ir">medium/eu-west-2/infra structure/VPC/terra grunt . HCl</strong>中，更改以下内容:</p><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="3828" class="ms ks iq nx b gy ob oc l od oe">azs = ["eu-west-1a", "eu-west-1b", "eu-west-1c"]</span></pre><p id="9173" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated">收件人:</p><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="e816" class="ms ks iq nx b gy ob oc l od oe">azs = ["eu-west-2a", "eu-west-2b", "eu-west-2c"]</span></pre><p id="dfcd" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated">terragrunt.hcl文件应该如下所示:</p><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="9aa4" class="ms ks iq nx b gy ob oc l od oe">include {<br/>  path = find_in_parent_folders()<br/>}</span><span id="f8a7" class="ms ks iq nx b gy of oc l od oe">terraform {<br/>  source = "git::<a class="ae mf" href="https://github.com/terraform-aws-modules/terraform-aws-vpc.git//?ref=v3.11.0" rel="noopener ugc nofollow" target="_blank">https://github.com/terraform-aws-modules/terraform-aws-vpc.git//?ref=v3.11.0</a>"</span><span id="1fc1" class="ms ks iq nx b gy of oc l od oe">extra_arguments "init_args" {<br/>    commands = [<br/>      "init"<br/>    ]<br/>    arguments = [<br/>    ]<br/>  }<br/>}</span><span id="d5e5" class="ms ks iq nx b gy of oc l od oe">inputs = {<br/>  name = "Main"<br/>  cidr = "10.0.0.0/16"</span><span id="0025" class="ms ks iq nx b gy of oc l od oe">azs             = ["eu-west-2a", "eu-west-2b", "eu-west-2c"]<br/>...</span></pre><p id="7483" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated">对<strong class="ll ir">medium/eu-west-2/services/we B- server/terra grunt . HCl</strong>重复上述步骤</p><p id="979f" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated">改变:</p><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="d8f2" class="ms ks iq nx b gy ob oc l od oe">environment = "tools-eu-1"</span></pre><p id="d7c8" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated">收件人:</p><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="65eb" class="ms ks iq nx b gy ob oc l od oe">environment = "tools-eu-2"</span></pre><p id="19f5" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated">像之前一样使用<code class="fe og oh oi nx b">terragrunt run-all apply</code>应用更改，在eu-west-2中出现提示时按“y”应用更改。现在，将eu-west-2(伦敦)中的新dns名称复制到您的浏览器中，查看配置是否正常工作。</p><h2 id="2da7" class="ms ks iq bd kt mt mu dn kx mv mw dp lb ls mx my ld lw mz na lf ma nb nc lh nd bi translated">最终项目结构</h2><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="ff6a" class="ms ks iq nx b gy ob oc l od oe">├── Medium<br/>│   ├── eu-west-1<br/>│   │   ├── infrastructure<br/>│   │   │   ├── load-balancer<br/>│   │   │   │   ├── external-alb<br/>│   │   │   │   │   └── terragrunt.hcl<br/>│   │   │   │   └── external-security-group<br/>│   │   │   │       └── terragrunt.hcl<br/>│   │   │   └── vpc<br/>│   │   │       └── terragrunt.hcl<br/>│   │   ├── regional.tfvars<br/>│   │   └── services<br/>│   │       └── web-server<br/>│   │           └── terragrunt.hcl<br/>│   ├── eu-west-2<br/>│       ├── infrastructure<br/>│       │   ├── load-balancer<br/>│       │   │   ├── external-alb<br/>│       │   │   │   └── terragrunt.hcl<br/>│       │   │   └── external-security-group<br/>│       │   │       └── terragrunt.hcl<br/>│       │   └── vpc<br/>│       │       └── terragrunt.hcl<br/>│       ├── regional.tfvars<br/>│       └── services<br/>│           └── web-server<br/>│               └── terragrunt.hcl<br/>├── README.md<br/>├── modules<br/>│   └── web-server<br/>│       ├── README.md<br/>│       ├── lib<br/>│       │   └── web_server.sh.tpl<br/>│       └── main.tf<br/>└── terragrunt.hcl</span></pre><p id="c468" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated">这是取自GitHub的Terragrunt项目的最终树形图。</p><h1 id="9481" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">清理资源</h1><p id="66f1" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">一旦你完成了教程，最好删除所有的资源，这样AWS就不会向你收费。这是一个简单的过程，您可以运行以下命令:</p><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="d017" class="ms ks iq nx b gy ob oc l od oe">$ pwd                       <br/>~/documents/terragrunt-medium</span><span id="8b16" class="ms ks iq nx b gy of oc l od oe">$ terragrunt run-all destroy <br/></span></pre><p id="e47f" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated">出现提示时，按并输入“y”。<strong class="ll ir">terra grunt run-all destroy</strong>可用于销毁整个模块和两个区域中的所有依赖项。</p><h1 id="dfaf" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">结论</h1><p id="aa93" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">现在您应该对Terragrunt和Terraform注册模块有了基本的了解。两者的结合使代码保持干爽，并消除了使用社区/验证模块从头创建模块的需要。</p><p id="a948" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated">请注意，本教程只是触及了Terragrunt的皮毛。为了更透彻地理解这个主题，请访问官方文档获取更多信息。</p><p id="2460" class="pw-post-body-paragraph lj lk iq ll b lm mk jr lo lp ml ju lr ls mn lu lv lw mp ly lz ma mr mc md me ij bi translated">如果你遵循了教程，请在评论中告诉我你的想法！如果你遇到任何问题，请联系我，我会尽力帮助你。</p></div></div>    
</body>
</html>