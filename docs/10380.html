<html>
<head>
<title>Azure Machine Learning Web Service with Python and Azure DSVM</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Python 和 Azure DSVM 的 Azure 机器学习 Web 服务</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/azure-machine-learning-web-service-with-python-and-azure-dsvm-845b50966fca?source=collection_archive---------7-----------------------#2022-10-28">https://blog.devgenius.io/azure-machine-learning-web-service-with-python-and-azure-dsvm-845b50966fca?source=collection_archive---------7-----------------------#2022-10-28</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><blockquote class="jk jl jm"><p id="b257" class="jn jo jp jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ig bi translated"><em class="in">Azure Machine Learning operational ization 是 Azure CLI 的一个组件，支持您通过 Vienna 使用 CNTK、SPARK 和 Python 机器学习平台创建的模型的可操作性。</em></p></blockquote><h2 id="e215" class="km kn in bd ko kp kq dn kr ks kt dp ku kv kw kx ky kz la lb lc ld le lf lg lh bi translated">入门指南</h2><p id="bd10" class="pw-post-body-paragraph jn jo in jq b jr li jt ju jv lj jx jy kv lk kb kc kz ll kf kg ld lm kj kk kl ig bi translated">要开始 Azure 机器学习操作化，您需要以下内容:</p><ol class=""><li id="ec0d" class="ln lo in jq b jr js jv jw kv lp kz lq ld lr kl ls lt lu lv bi translated">Azure 账户(如果你没有，你可以在这里获得免费试用<a class="ae lw" href="https://azure.microsoft.com/en-us/free/" rel="noopener ugc nofollow" target="_blank"/></li><li id="38b8" class="ln lo in jq b jr lx jv ly kv lz kz ma ld mb kl ls lt lu lv bi translated">azure Data Science Virtual Machine(DSVM)——虽然这并不是必须的，但我认为这是最快最简单的入门方式。你可以在这里查看文档<a class="ae lw" href="https://docs.microsoft.com/en-us/azure/machine-learning/machine-learning-data-science-provision-vm" rel="noopener ugc nofollow" target="_blank">来创建一个。</a></li></ol><h2 id="f562" class="km kn in bd ko kp kq dn kr ks kt dp ku kv kw kx ky kz la lb lc ld le lf lg lh bi translated">更新(实际上是重新安装)Azure CLI 包</h2><p id="b128" class="pw-post-body-paragraph jn jo in jq b jr li jt ju jv lj jx jy kv lk kb kc kz ll kf kg ld lm kj kk kl ig bi translated">一旦你创建了 Azure DSVM，我们要做的第一件事就是通过卸载和安装来更新我们的<code class="fe mc md me mf b">azure-cli</code>、<code class="fe mc md me mf b">azure-cli-ml</code>和<code class="fe mc md me mf b">azure-ml-api-sdk</code>包。</p><pre class="mg mh mi mj gt mk mf ml mm aw mn bi"><span id="b93c" class="km kn in mf b gy mo mp l mq mr">$ pip uninstall azure-cli azure-cli-ml azure-ml-api-sdk<br/>$ pip install azure-cli azure-cli-ml azure-ml-api-sdk</span></pre><p id="f8d0" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy kv ka kb kc kz ke kf kg ld ki kj kk kl ig bi translated">以前，我尝试用<code class="fe mc md me mf b">pip install</code>中的<code class="fe mc md me mf b">--upgrade</code>选项更新软件包，但我一直在升级软件包时出错。因此，卸载并安装它可以解决问题，因为稍后，我们将使用这些包来生成一个模式，并将我们训练好的模型部署到我们的 web 服务中。</p><h2 id="3304" class="km kn in bd ko kp kq dn kr ks kt dp ku kv kw kx ky kz la lb lc ld le lf lg lh bi translated">构建性别分类器模型</h2><p id="e902" class="pw-post-body-paragraph jn jo in jq b jr li jt ju jv lj jx jy kv lk kb kc kz ll kf kg ld lm kj kk kl ig bi translated">接下来，我们将使用<code class="fe mc md me mf b">scikit-learn</code>机器学习库创建一个模型，该模型将根据给定的身体指标(<em class="jp">身高、宽度和鞋码</em>)来预测这个人是男是女。创建一个名为<code class="fe mc md me mf b">train.py</code>的文件，您可以复制下面的代码:</p><pre class="mg mh mi mj gt mk mf ml mm aw mn bi"><span id="abed" class="km kn in mf b gy mo mp l mq mr">from sklearn.svm import SVC<br/>import pickle</span><span id="238f" class="km kn in mf b gy ms mp l mq mr"># height, width, shoe size<br/>X = [[181, 80, 44], [177, 70, 43], [160, 60, 38], [154, 54, 37],<br/>     [166, 65, 40], [190, 90, 47], [175, 64, 39], [177, 70, 40], <br/>     [159, 55, 37], [171, 75, 42], [181, 85, 43]]</span><span id="ee42" class="km kn in mf b gy ms mp l mq mr">Y = ['male', 'male', 'female', 'female', 'male', 'male', 'female',<br/>     'female', 'female', 'male', 'male']</span><span id="2f2e" class="km kn in mf b gy ms mp l mq mr">clf = SVC()<br/>clf = clf.fit(X, Y)</span><span id="bc1e" class="km kn in mf b gy ms mp l mq mr">print('Predicted value:', clf.predict([[190, 70, 43]]))<br/>print('Accuracy', clf.score(X,Y))</span><span id="5c27" class="km kn in mf b gy ms mp l mq mr">print('Export the model to model.pkl')<br/>f = open('model.pkl', 'wb')<br/>pickle.dump(clf, f)<br/>f.close()</span><span id="a3f7" class="km kn in mf b gy ms mp l mq mr">print('Import the model from model.pkl')<br/>f2 = open('model.pkl', 'rb')<br/>clf2 = pickle.load(f2)</span><span id="d5f7" class="km kn in mf b gy ms mp l mq mr">X_new = [[154, 54, 35]]<br/>print('New Sample:', X_new)<br/>print('Predicted class:', clf2.predict(X_new))</span></pre><p id="7860" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy kv ka kb kc kz ke kf kg ld ki kj kk kl ig bi translated">运行代码，它应该会在您的项目文件夹中创建一个<code class="fe mc md me mf b">model.pkl</code>。</p><h2 id="c445" class="km kn in bd ko kp kq dn kr ks kt dp ku kv kw kx ky kz la lb lc ld le lf lg lh bi translated">创建 score.py</h2><p id="bec0" class="pw-post-body-paragraph jn jo in jq b jr li jt ju jv lj jx jy kv lk kb kc kz ll kf kg ld lm kj kk kl ig bi translated">要将我们的模型部署为 web 服务，我们需要创建一个用于生成模式 JSON 文件的<code class="fe mc md me mf b">score.py</code>。</p><pre class="mg mh mi mj gt mk mf ml mm aw mn bi"><span id="78d9" class="km kn in mf b gy mo mp l mq mr">def init():<br/>    from sklearn.externals import joblib</span><span id="32ee" class="km kn in mf b gy ms mp l mq mr">    global model<br/>    model = joblib.load('model.pkl')</span><span id="c85e" class="km kn in mf b gy ms mp l mq mr">def run(input_df):<br/>    import json<br/>    pred = model.predict(input_df)<br/>    return json.dumps(str(pred[0]))</span><span id="2387" class="km kn in mf b gy ms mp l mq mr">def main():<br/>  from azureml.api.schema.dataTypes import DataTypes<br/>  from azureml.api.schema.sampleDefinition import SampleDefinition<br/>  from azureml.api.realtime.services import generate_schema<br/>  import pandas</span><span id="3b55" class="km kn in mf b gy ms mp l mq mr">  df = pandas.DataFrame(data=[[190, 60, 38]], <br/>                      columns=['height', 'width', 'shoe_size'])</span><span id="1a72" class="km kn in mf b gy ms mp l mq mr">  # Test the functions' output<br/>  init()<br/>  input1 = pandas.DataFrame([[190, 60, 38]])<br/>  print("Result: " + run(input1))<br/>  <br/>  inputs = {"input_df": SampleDefinition(DataTypes.PANDAS, df)}</span><span id="86f8" class="km kn in mf b gy ms mp l mq mr">  # Generate the service_schema.json<br/>  generate_schema(run_func=run, inputs=inputs,<br/>                  filepath='service_schema.json')<br/>  print("Schema generated")</span><span id="0b96" class="km kn in mf b gy ms mp l mq mr">if __name__ == "__main__":<br/>    main()</span></pre><p id="e116" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy kv ka kb kc kz ke kf kg ld ki kj kk kl ig bi translated">运行<code class="fe mc md me mf b">score.py</code>，您应该会看到<code class="fe mc md me mf b">service_schema.json</code>已经创建。现在，我们的项目文件夹应该包含以下文件:</p><pre class="mg mh mi mj gt mk mf ml mm aw mn bi"><span id="d6d5" class="km kn in mf b gy mo mp l mq mr">PROJECT_FOLDER<br/>- train.py<br/>- score.py<br/>- model.pkl<br/>- service_schema.json</span></pre><h2 id="0a2d" class="km kn in bd ko kp kq dn kr ks kt dp ku kv kw kx ky kz la lb lc ld le lf lg lh bi translated">使用 Azure CLI 创建和部署 Web 服务</h2><p id="4ca8" class="pw-post-body-paragraph jn jo in jq b jr li jt ju jv lj jx jy kv lk kb kc kz ll kf kg ld lm kj kk kl ig bi translated">现在我们已经设置好了一切，我们现在将通过执行以下操作来创建我们的 web 服务并部署模型:</p><h2 id="346d" class="km kn in bd ko kp kq dn kr ks kt dp ku kv kw kx ky kz la lb lc ld le lf lg lh bi translated">在 Azure CLI 中验证您的帐户</h2><p id="3213" class="pw-post-body-paragraph jn jo in jq b jr li jt ju jv lj jx jy kv lk kb kc kz ll kf kg ld lm kj kk kl ig bi translated">为了能够使用<code class="fe mc md me mf b">azure cli</code>创建我们的<em class="jp">环境</em>和<em class="jp">模型管理账户</em>，我们首先需要使用以下命令进行认证:</p><pre class="mg mh mi mj gt mk mf ml mm aw mn bi"><span id="7ff4" class="km kn in mf b gy mo mp l mq mr">$ az login</span></pre><p id="5ca2" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy kv ka kb kc kz ke kf kg ld ki kj kk kl ig bi translated">这将显示一条信息，提示您需要打开网络浏览器，进入<a class="ae lw" href="https://aka.ms/devicelogin" rel="noopener ugc nofollow" target="_blank">https://aka.ms/devicelogin</a>并输入终端中提供的代码。</p><h2 id="00d2" class="km kn in bd ko kp kq dn kr ks kt dp ku kv kw kx ky kz la lb lc ld le lf lg lh bi translated">创造环境</h2><p id="7463" class="pw-post-body-paragraph jn jo in jq b jr li jt ju jv lj jx jy kv lk kb kc kz ll kf kg ld lm kj kk kl ig bi translated">一旦您能够使用<code class="fe mc md me mf b">azure cli</code>验证您的帐户，请键入以下命令来创建我们的环境:</p><pre class="mg mh mi mj gt mk mf ml mm aw mn bi"><span id="c42c" class="km kn in mf b gy mo mp l mq mr">$  az ml env setup -c -n YOUR_CLUSTER_NAME -l YOUR_LOCATION</span></pre><p id="74ba" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy kv ka kb kc kz ke kf kg ld ki kj kk kl ig bi translated">这是我在本教程中使用的:</p><pre class="mg mh mi mj gt mk mf ml mm aw mn bi"><span id="6f60" class="km kn in mf b gy mo mp l mq mr">$ az ml env setup -c -n azmldemo -l australiaeast</span></pre><p id="8ec3" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy kv ka kb kc kz ke kf kg ld ki kj kk kl ig bi translated">记住现在支持的位置是<code class="fe mc md me mf b">westcentralus</code>、<code class="fe mc md me mf b">eastus2</code>和<code class="fe mc md me mf b">australiaeast</code>也很重要。</p><h2 id="278e" class="km kn in bd ko kp kq dn kr ks kt dp ku kv kw kx ky kz la lb lc ld le lf lg lh bi translated">创建模型管理帐户</h2><p id="9de4" class="pw-post-body-paragraph jn jo in jq b jr li jt ju jv lj jx jy kv lk kb kc kz ll kf kg ld lm kj kk kl ig bi translated">我们的环境至少需要 10-20 分钟才能完成配置，因此在等待的同时，我们现在可以创建我们的模型管理帐户，这是一个<strong class="jq io">一次性设置</strong>的事情。</p><pre class="mg mh mi mj gt mk mf ml mm aw mn bi"><span id="7b40" class="km kn in mf b gy mo mp l mq mr">$ az ml account modelmanagement create -l YOUR_LOCATION -n YOUR_MODEL_MANAGEMENT_ACCOUNT_NAME -g YOUR_RESOURCE_GROUP</span></pre><p id="a8c3" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy kv ka kb kc kz ke kf kg ld ki kj kk kl ig bi translated">这是我在本教程中使用的:</p><pre class="mg mh mi mj gt mk mf ml mm aw mn bi"><span id="ad6d" class="km kn in mf b gy mo mp l mq mr">$ az ml account modelmanagement create -l australiaeast -n azmldemoacc -g azmldemorg</span></pre><p id="d307" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy kv ka kb kc kz ke kf kg ld ki kj kk kl ig bi translated">如果您想知道，<code class="fe mc md me mf b">azmldemorg</code>资源组是在我们之前创建环境时自动创建的，它基本上是在我们的集群名称<code class="fe mc md me mf b">azmldemo</code>上添加了一个<strong class="jq io"> rg </strong>。</p><h2 id="11bf" class="km kn in bd ko kp kq dn kr ks kt dp ku kv kw kx ky kz la lb lc ld le lf lg lh bi translated">设置模型管理帐户和环境</h2><p id="eada" class="pw-post-body-paragraph jn jo in jq b jr li jt ju jv lj jx jy kv lk kb kc kz ll kf kg ld lm kj kk kl ig bi translated">一旦成功创建了模型管理帐户和您的环境，我们现在将使用以下命令设置模型管理帐户和环境:</p><pre class="mg mh mi mj gt mk mf ml mm aw mn bi"><span id="ffe4" class="km kn in mf b gy mo mp l mq mr">$ az ml account modelmanagement set -n YOUR_MODEL_MANAGEMENT_ACCOUNT_NAME -g YOUR_RESOURCE_GROUP<br/>$ az ml env set -n YOUR_CLUSTER_NAME -g YOUR_RESOURCE_GROUP</span></pre><p id="4bd3" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy kv ka kb kc kz ke kf kg ld ki kj kk kl ig bi translated">这是我在本教程中使用的:</p><pre class="mg mh mi mj gt mk mf ml mm aw mn bi"><span id="6465" class="km kn in mf b gy mo mp l mq mr">$ az ml account modelmanagement set -n azmldemoacc -g azmldemorg<br/>$ az ml env set -n azmldemo -g azmldemorg</span></pre><p id="d13f" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy kv ka kb kc kz ke kf kg ld ki kj kk kl ig bi translated">同样重要的是要记住，您的环境<em class="jp">供应状态</em>应该显示<em class="jp">成功</em>，以便您能够成功设置它。您可以使用以下命令检查资源调配状态:</p><pre class="mg mh mi mj gt mk mf ml mm aw mn bi"><span id="6b2f" class="km kn in mf b gy mo mp l mq mr">$ az ml env show -g YOUR_RESOURCE_GROUP -n YOUR_CLUSTER_NAME</span></pre><h2 id="268a" class="km kn in bd ko kp kq dn kr ks kt dp ku kv kw kx ky kz la lb lc ld le lf lg lh bi translated">创建 Web 服务</h2><p id="ad5d" class="pw-post-body-paragraph jn jo in jq b jr li jt ju jv lj jx jy kv lk kb kc kz ll kf kg ld lm kj kk kl ig bi translated">一旦您能够成功设置您的模型管理帐户和环境，我们现在将通过以下方式创建 web 服务:</p><ol class=""><li id="6555" class="ln lo in jq b jr js jv jw kv lp kz lq ld lr kl ls lt lu lv bi translated">转到我们已经创建了性别分类器模型和 JSON 模式的项目文件夹</li><li id="e855" class="ln lo in jq b jr lx jv ly kv lz kz ma ld mb kl ls lt lu lv bi translated">键入以下命令创建 web 服务:</li></ol><pre class="mg mh mi mj gt mk mf ml mm aw mn bi"><span id="7294" class="km kn in mf b gy mo mp l mq mr">$ az ml service create realtime -f score.py --m model.pkl -s service_schema.json -n genderclassifier -r python<br/>or you can also use --help or -h to know the other arguments available<br/>$ az ml service create realtime -h</span></pre><h2 id="3739" class="km kn in bd ko kp kq dn kr ks kt dp ku kv kw kx ky kz la lb lc ld le lf lg lh bi translated">测试 Web 服务</h2><p id="6f17" class="pw-post-body-paragraph jn jo in jq b jr li jt ju jv lj jx jy kv lk kb kc kz ll kf kg ld lm kj kk kl ig bi translated">一旦成功地创建了 web 服务，您就可以使用下面的命令来获取可以用来测试 web 服务的所有重要细节(例如示例 CLI 命令、Swagger URL、授权载体密钥等等):</p><pre class="mg mh mi mj gt mk mf ml mm aw mn bi"><span id="0d40" class="km kn in mf b gy mo mp l mq mr">$ az ml service usage realtime -i YOUR_SERVICE_ID</span></pre><p id="ddc5" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy kv ka kb kc kz ke kf kg ld ki kj kk kl ig bi translated">您可以使用以下命令获得您的<em class="jp">服务 Id </em>:</p><pre class="mg mh mi mj gt mk mf ml mm aw mn bi"><span id="877e" class="km kn in mf b gy mo mp l mq mr">$ az ml service list realtime</span></pre><h2 id="ec53" class="km kn in bd ko kp kq dn kr ks kt dp ku kv kw kx ky kz la lb lc ld le lf lg lh bi translated">运行示例 CLI 命令</h2><pre class="mg mh mi mj gt mk mf ml mm aw mn bi"><span id="f629" class="km kn in mf b gy mo mp l mq mr">$ az ml service run realtime -i YOUR_SERVICE_ID -d "{\"input_df\": [{\"width\": 60, \"shoe_size\": 38, \"height\": 190}]}"</span></pre><p id="3e9a" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy kv ka kb kc kz ke kf kg ld ki kj kk kl ig bi translated">当您在终端中运行时，应该是这样的:</p><figure class="mg mh mi mj gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi mt"><img src="../Images/e629d26c209948d98fecbd1d95472923.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vcctwAQhn4x9nYhT.gif"/></div></div></figure><h2 id="9332" class="km kn in bd ko kp kq dn kr ks kt dp ku kv kw kx ky kz la lb lc ld le lf lg lh bi translated">通过邮递员测试</h2><p id="a074" class="pw-post-body-paragraph jn jo in jq b jr li jt ju jv lj jx jy kv lk kb kc kz ll kf kg ld lm kj kk kl ig bi translated">这里有一个关于如何通过<code class="fe mc md me mf b">Scoring URL</code>测试 web 服务的例子</p><figure class="mg mh mi mj gt mu gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/2f1a459ee40e0b14b36e43f70a1e1a0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qGMbphZl-5w-0J4R.gif"/></div></figure><p id="abbf" class="pw-post-body-paragraph jn jo in jq b jr js jt ju jv jw jx jy kv ka kb kc kz ke kf kg ld ki kj kk kl ig bi translated">我们已经完成了，那么你对 Azure 机器学习的可操作性有什么看法？</p></div></div>    
</body>
</html>