<html>
<head>
<title>Lists in UITextView</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">UITextView 中的列表</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/lists-in-uitextview-756fe2b1407a?source=collection_archive---------4-----------------------#2020-07-03">https://blog.devgenius.io/lists-in-uitextview-756fe2b1407a?source=collection_archive---------4-----------------------#2020-07-03</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="8820" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">您是否希望在 UITextView 中实现如下功能:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/2f4a897635caf3fcca18bf7998068462.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*FV-UiuimLNgWqJzJ-SALOQ.gif"/></div></div></figure><p id="5596" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">非常奇怪的是，一个被广泛使用的东西，却没有被 iOS 上的 UITextView 所支持。当我遇到一个场景时(稍后会有更多内容——请务必阅读到最后🙂)当我需要在 UITextView 中实现一个函数列表时，似乎遇到了障碍。从一开始，我就知道我唯一的选择是在 NSAttributeString 中使用自定义属性。然而，事实证明，我不得不尝试多种方法才能最终创建出我所寻找的实现。</p><h1 id="7dd7" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">第一次尝试</h1><p id="d184" class="pw-post-body-paragraph jk jl in jm b jn ls jp jq jr lt jt ju jv lu jx jy jz lv kb kc kd lw kf kg kh ig bi translated">我尝试的第一种方法如下:</p><ol class=""><li id="e658" class="lx ly in jm b jn jo jr js jv lz jz ma kd mb kh mc md me mf bi translated">创建一个名为<code class="fe mg mh mi mj b">listItem</code>的自定义 NSAttributedString 属性。</li><li id="6e01" class="lx ly in jm b jn mk jr ml jv mm jz mn kd mo kh mc md me mf bi translated">只要选择了一个区域来应用列表格式，就用换行符分隔所有的行，并在每行之前用项目符号添加额外的文本。另外，更新<code class="fe mg mh mi mj b">paragraphStyle</code>属性来添加缩进。</li></ol><p id="e21c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这种方法有很多问题:</p><ol class=""><li id="04d9" class="lx ly in jm b jn jo jr js jv lz jz ma kd mb kh mc md me mf bi translated">当添加文本(表示项目符号/编号)时，文本的整个范围发生了变化，使得很难循环通过用户最初选择的范围内的行。</li><li id="8d79" class="lx ly in jm b jn mk jr ml jv mm jz mn kd mo kh mc md me mf bi translated">跟踪表示项目符号/编号的索引是很棘手的，尤其是当项目在中间被删除/添加时。</li><li id="9422" class="lx ly in jm b jn mk jr ml jv mm jz mn kd mo kh mc md me mf bi translated">段落缩进需要考虑项目符号/数字的宽度，这反过来又需要右对齐。</li><li id="f67c" class="lx ly in jm b jn mk jr ml jv mm jz mn kd mo kh mc md me mf bi translated">控制列表项第一级之外的缩进变得非常棘手。</li></ol><p id="f6ae" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">虽然这种方法在您试图在一个<code class="fe mg mh mi mj b">UILabel</code>(内容不变)中显示列表的情况下可以相对较好地工作，但是对于用户可能改变文本并且列表需要动态调整的<code class="fe mg mh mi mj b">UITextView</code>来说，使用同样的方法就远非完美了。</p><h1 id="6193" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">NSLayoutManager 前来救援</h1><p id="8fb2" class="pw-post-body-paragraph jk jl in jm b jn ls jp jq jr lt jt ju jv lu jx jy jz lv kb kc kd lw kf kg kh ig bi translated">从第一次尝试中最大的收获是，我不能使用通过编程来改变文本的方法来包含列表的标记，如项目符号/数字等。经过进一步思考和遍历 TextKit 关键部分的文档，我发现定制 NSLayoutManager 可能是使它工作的最佳选择。</p><p id="c241" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在很高的层面上，行之有效的方法是:</p><ol class=""><li id="2902" class="lx ly in jm b jn jo jr js jv lz jz ma kd mb kh mc md me mf bi translated">子类<code class="fe mg mh mi mj b">NSLayoutManager</code>覆盖<a class="ae mp" href="https://developer.apple.com/documentation/uikit/nslayoutmanager/1403158-drawglyphs" rel="noopener ugc nofollow" target="_blank"> drawGlyphs </a>函数。</li><li id="0d8a" class="lx ly in jm b jn mk jr ml jv mm jz mn kd mo kh mc md me mf bi translated">在内容中循环查找<code class="fe mg mh mi mj b">layoutManager.textStorage</code>中是否存在自定义属性<code class="fe mg mh mi mj b">.listItem</code>，用户可以通过选择文本范围来应用该属性。</li><li id="d7f5" class="lx ly in jm b jn mk jr ml jv mm jz mn kd mo kh mc md me mf bi translated">使用<code class="fe mg mh mi mj b">enumerateLineFragments</code>，遍历<code class="fe mg mh mi mj b">layoutManager</code>中的线段。需要注意的是，行片段是 UITextView 中实际布局的行，而不是由新行字符分隔的行。使用这个函数的目的是为了让我们得到每一行的<code class="fe mg mh mi mj b">rect</code>，并使用它在给定的位置定位自定义绘制的字形(项目符号/数字)。</li><li id="94f7" class="lx ly in jm b jn mk jr ml jv mm jz mn kd mo kh mc md me mf bi translated">对于每个被识别为段落的内容范围(即由新的行字符分隔)，创建一个<code class="fe mg mh mi mj b">NSParagraphStyle</code>的副本并更新<code class="fe mg mh mi mj b">firstLineHeadIndent</code>和<code class="fe mg mh mi mj b">headIndent</code>。</li><li id="78b9" class="lx ly in jm b jn mk jr ml jv mm jz mn kd mo kh mc md me mf bi translated">将上面更新的<code class="fe mg mh mi mj b">paragraphStyle</code>重新应用到相同的范围。如果您更改了现有属性，则需要一个副本，它将应用于该样式的整个范围，该范围可能超出一行文本(以换行符结尾)。</li><li id="d449" class="lx ly in jm b jn mk jr ml jv mm jz mn kd mo kh mc md me mf bi translated">使用我们从<code class="fe mg mh mi mj b">enumerateLineFragments</code>获得的线段 rect，计算位置以绘制表示列表标记的自定义图像/文本，即项目符号/编号。</li></ol><p id="8abb" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">使用这种方法的好处是，因为 layoutManager 在每次按键时都会被有效地触发，所以更容易维护对列表项进行编号的索引。即，当在列表中间添加/删除项目时，它会根据布局自动重新索引。</p><p id="cd6b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">但是，这种方法只处理选定文本范围内的列表项。使用列表时，用户期望的不仅仅是这些。文本视图应支持以下内容:</p><ol class=""><li id="be0e" class="lx ly in jm b jn jo jr js jv lz jz ma kd mb kh mc md me mf bi translated">选择文本范围并应用列表样式。这将自动创建与所选范围中的行数一样多的列表项。</li><li id="5635" class="lx ly in jm b jn mk jr ml jv mm jz mn kd mo kh mc md me mf bi translated">当用户按下回车键时，它应该在用户所在的同一级别创建一个新的列表项。</li><li id="0573" class="lx ly in jm b jn mk jr ml jv mm jz mn kd mo kh mc md me mf bi translated">用户还应该能够使用 tab/shift-tab (macOS Catalyst)来缩进/突出列表项。</li><li id="3e59" class="lx ly in jm b jn mk jr ml jv mm jz mn kd mo kh mc md me mf bi translated">在最后一个列表项上按两次 enter 应该会退出列表。</li></ol><p id="49ed" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">上述行为可以通过使用 UITextViewDelegate 函数拦截按键并在给定范围内更新<code class="fe mg mh mi mj b">listItem</code>属性来实现。为了拦截 shift-Tab，可以使用<code class="fe mg mh mi mj b">UIKeyCommand</code>。然后，这可以再次由被覆盖的<code class="fe mg mh mi mj b">drawGlyphs</code>中的<code class="fe mg mh mi mj b">LayoutManager</code>读取，并按照预期进行布局。</p><h1 id="52b9" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">简单的出路</h1><p id="1174" class="pw-post-body-paragraph jk jl in jm b jn ls jp jq jr lt jt ju jv lu jx jy jz lv kb kc kd lw kf kg kh ig bi translated">正如开始提到的，我需要创建列表——这是一个开源项目的需求— <a class="ae mp" href="https://github.com/rajdeep/proton/" rel="noopener ugc nofollow" target="_blank"> Proton </a>。质子是一个项目，我在业余时间工作。开发<a class="ae mp" href="https://github.com/rajdeep/proton/" rel="noopener ugc nofollow" target="_blank"> Proton </a>的动机来自于这样一个事实，即虽然 UITextView 非常强大，但它开箱后只暴露了很少一部分功能。你真的需要将相当多的部分(TextKit)放在一起，以实现一个能够支持不同类型文本格式的原生 iOS/macOS Catalyst 文本编辑器。质子有助于使这部分变得更容易。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mq"><img src="../Images/b9be0a67245a5eae11eb64757de4fc29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*47_BkChF6mpSnqOSBGaRQQ.png"/></div></div></figure><p id="f952" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">你在上面的例子中看到的来自<a class="ae mp" href="https://github.com/rajdeep/proton/" rel="noopener ugc nofollow" target="_blank"> Proton </a>，它封装了<code class="fe mg mh mi mj b">TextKit</code>组件以提供丰富的文本编辑功能。宝腾能够通过以下方式实现列表:</p><ol class=""><li id="6734" class="lx ly in jm b jn jo jr js jv lz jz ma kd mb kh mc md me mf bi translated"><code class="fe mg mh mi mj b">EditorView</code>:可编辑的文本视图，内部使用一个带有自定义<code class="fe mg mh mi mj b">NSTextStorage</code>和<code class="fe mg mh mi mj b">NSLayoutManager</code>的 UITextView。</li><li id="5954" class="lx ly in jm b jn mk jr ml jv mm jz mn kd mo kh mc md me mf bi translated"><code class="fe mg mh mi mj b">ListCommand</code>:质子有一个可以在<code class="fe mg mh mi mj b">EditorView</code>上调用的命令的概念。命令可以在内部创建，并用<code class="fe mg mh mi mj b">EditorView</code>注册。</li><li id="a8e1" class="lx ly in jm b jn mk jr ml jv mm jz mn kd mo kh mc md me mf bi translated">文本处理器是当用户改变文本时执行的一段代码。这样，就更容易拦截特殊的按键输入，如 Enter、Tab 等。以及 Ctrl、Alt、Shift 等组合键。像命令一样，这些只需要注册。</li><li id="a0da" class="lx ly in jm b jn mk jr ml jv mm jz mn kd mo kh mc md me mf bi translated"><code class="fe mg mh mi mj b">EditorListFormattingProvider</code>:需要在<code class="fe mg mh mi mj b">editorView.listFormattingProvider</code>上实现和设置的协议。这用于查询每个索引的编号/项目符号。您可以返回一个文本值，甚至可以返回一个图像作为列表标记。</li></ol><h2 id="db3f" class="mr kv in bd kw ms mt dn la mu mv dp le jv mw mx li jz my mz lm kd na nb lq nc bi translated">用质子编码</h2><p id="9853" class="pw-post-body-paragraph jk jl in jm b jn ls jp jq jr lt jt ju jv lu jx jy jz lv kb kc kd lw kf kg kh ig bi translated">当使用<a class="ae mp" href="https://github.com/rajdeep/proton/" rel="noopener ugc nofollow" target="_blank">质子</a>T10】时，您只需要添加以下内容即可获得列表功能:</p><pre class="kj kk kl km gt nd mj ne nf aw ng bi"><span id="3ffe" class="mr kv in mj b gy nh ni l nj nk">let command = ListCommand()<br/>let attributeValue: Any? = "anyValue"<br/>command.execute(on: editor, attributeValue: attributeValue)</span></pre><p id="1293" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><code class="fe mg mh mi mj b">attributeValue</code>可以是您可以添加到列表项中的任何值。该值与项目的索引一起返回到<code class="fe mg mh mi mj b">EditorListFormattingProvider</code>，并可用于保存上下文，比如列表是项目符号列表还是编号列表。</p><p id="f0f9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">要获得处理(Shift) Enter、(Shift) Tab 和 backspace 的功能，您只需要:</p><pre class="kj kk kl km gt nd mj ne nf aw ng bi"><span id="dd3d" class="mr kv in mj b gy nh ni l nj nk">editor.registerProcessor(ListTextProcessor())</span></pre><p id="27b5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">当用户在列表中键入文本时，负责所有的格式设置，包括创建新项目、缩进和突出列表以及退出列表。</p><p id="c0ca" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在 macOS Catalyst 应用程序上运行的 Proton 中的更多列表示例:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nl"><img src="../Images/a29d0c94a54a7c5a13ea7469deece802.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*rWu1DU50-DvRgmqvSPKulA.gif"/></div></div><figcaption class="nm nn gj gh gi no np bd b be z dk translated">根据键入的文本创建列表</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nl"><img src="../Images/77c2f0cea4c843dbfbe7f3c8a265f337.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*PdOnsnq5Bb-RT2eLNibQFQ.gif"/></div></div><figcaption class="nm nn gj gh gi no np bd b be z dk translated">从现有文本创建列表</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nl"><img src="../Images/7737b04cbb7671a2d47cf826b87ff45f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*dQUqIMmi7r3wdhOymgGj0A.gif"/></div></div><figcaption class="nm nn gj gh gi no np bd b be z dk translated">使用 Tab/Shift-Tab 缩进/突出显示</figcaption></figure><p id="3b9e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">感谢您抽出时间阅读本文。这是我计划写的关于<a class="ae mp" href="https://github.com/rajdeep/proton/" rel="noopener ugc nofollow" target="_blank">质子</a>的系列文章的第一篇，讲述了成功的和失败的方法以及我的学习。我期待在下一篇文章中见到您。</p><p id="616d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在那之前，请注意安全！🙂</p></div></div>    
</body>
</html>