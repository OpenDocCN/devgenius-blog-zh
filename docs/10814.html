<html>
<head>
<title>Connecting NODEJS to MS SQL Server Database Using TEDIOUS Package</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用繁琐的包将 NODEJS 连接到 MS SQL Server 数据库</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/connecting-nodejs-to-ms-sql-server-database-8518bf54598?source=collection_archive---------0-----------------------#2022-12-02">https://blog.devgenius.io/connecting-nodejs-to-ms-sql-server-database-8518bf54598?source=collection_archive---------0-----------------------#2022-12-02</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="90d7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">使用异步等待异步编程方法</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/4e4a028ae74c0f8d220b7d821ce99451.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Ih-V-UH1T0ooBKGc"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@choys_?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">康尼·施耐德</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</figcaption></figure><p id="21b9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">微软目前贡献并支持 Node.js (NODEJS)中的开源繁琐(繁琐)模块，用于使用 JavaScript 连接到 SQL Server(参考<a class="ae ky" href="https://learn.microsoft.com/en-us/sql/connect/connect-history" rel="noopener ugc nofollow" target="_blank">微软 SQL Server 的驱动历史</a>)。繁琐的模块是 TDS 协议的 JavaScript 实现，所有现代版本的 SQL Server 都支持(参考<a class="ae ky" href="https://learn.microsoft.com/en-us/sql/connect/node-js/node-js-driver-for-sql-server" rel="noopener ugc nofollow" target="_blank">SQL Server 的 Node.js 驱动</a>)。微软在他们的<a class="ae ky" href="https://learn.microsoft.com/en-us/sql/connect/node-js/node-js-driver-for-sql-server?view=sql-server-ver16#get-started" rel="noopener ugc nofollow" target="_blank">入门页面</a>提供了一个简单的指南。</p><p id="d790" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这篇文章演示了以下内容:</p><ol class=""><li id="b1e8" class="kz la in jm b jn jo jr js jv lb jz lc kd ld kh le lf lg lh bi translated">典型的表相关 T-SQL 语句。</li><li id="7c11" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">乏味的输出类型，如 JSON 数组和对象。</li><li id="b239" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">NodeJS 命令行参数。</li><li id="07ec" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">Async-Await 方法处理到数据库服务器的异步连接。</li></ol><h1 id="1ab5" class="ln lo in bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">(0)先决条件</h1><p id="8c0a" class="pw-post-body-paragraph jk jl in jm b jn ml jp jq jr mm jt ju jv mn jx jy jz mo kb kc kd mp kf kg kh ig bi translated">NODEJS 要求在主机(Windows、Linux 或 Mac)上安装运行时和包管理器。开发者可以<a class="ae ky" href="https://nodejs.org/en/download/" rel="noopener ugc nofollow" target="_blank">直接安装</a>或者使用<a class="ae ky" href="https://community.chocolatey.org/packages/nodejs.install" rel="noopener ugc nofollow" target="_blank"> Chocolatey 包管理器</a>。</p><p id="493e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这篇文章使用可视代码作为代码编辑器。安装可视化代码有三种方式:<br/> (1) <a class="ae ky" href="https://code.visualstudio.com/download" rel="noopener ugc nofollow" target="_blank">直接安装</a>。<br/> (2) <a class="ae ky" href="https://community.chocolatey.org/packages/vscode" rel="noopener ugc nofollow" target="_blank">巧克力</a>包装。<br/> (3) <a class="ae ky" href="https://portapps.io/app/vscode-portable/" rel="noopener ugc nofollow" target="_blank">波塔普斯</a>。</p><p id="a667" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">最方便的方式是 Chocolatey 套餐；使用<code class="fe mq mr ms mt b">choco uninstall</code>命令可以轻松移除已安装的软件包。</p><p id="2af2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这篇文章是上一篇关于 MS SQL Server Docker 版本的文章的继续。首先按照帖子中的说明为下面的练习设置一个 MS SQL Server。</p><h2 id="e003" class="mu lo in bd lp mv mw dn lt mx my dp lx jv mz na mb jz nb nc mf kd nd ne mj nf bi translated">(一)建立开发环境</h2><p id="0141" class="pw-post-body-paragraph jk jl in jm b jn ml jp jq jr mm jt ju jv mn jx jy jz mo kb kc kd mp kf kg kh ig bi translated">在可视代码程序中，选择菜单文件/[将文件夹添加到工作区]。例如，创建一个文件夹 C:\ZNODES。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/e519b3364ad288400af6fa96705966aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:808/format:webp/1*KKwzJaBaLSb00uE6QLcBCg.png"/></div></figure><p id="59e0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在浏览器面板中，选择 ZNODES 文件夹，右键单击并选择[在集成终端中打开]。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/aab991bb1088643678a40670674c0e53.png" data-original-src="https://miro.medium.com/v2/resize:fit:936/format:webp/1*VJqnj_IWf9-OpCNi6IMuhA.png"/></div></figure><p id="5f3e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在下面的示例中,“终端”窗口包含 Power Shell 控制台。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ni"><img src="../Images/354e5624672ad436268117b3d75c2b87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-6xhkrz9Cf0cQsn_K5RKdg.png"/></div></div></figure><h2 id="f4ef" class="mu lo in bd lp mv mw dn lt mx my dp lx jv mz na mb jz nb nc mf kd nd ne mj nf bi translated"><strong class="ak"> (b)安装繁琐的软件包</strong></h2><p id="07c2" class="pw-post-body-paragraph jk jl in jm b jn ml jp jq jr mm jt ju jv mn jx jy jz mo kb kc kd mp kf kg kh ig bi translated">键入以下命令安装繁琐。</p><pre class="kj kk kl km gt nj mt nk bn nl nm bi"><span id="941d" class="nn lo in mt b be no np l nq nr">npm install tedious  </span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/a986f98d0fbab24e2ce5ae09b1c91e57.png" data-original-src="https://miro.medium.com/v2/resize:fit:734/format:webp/1*UuNUzM0mHqiingKOP_7QCw.png"/></div></figure><h1 id="a335" class="ln lo in bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated"><strong class="ak"> (1) </strong>典型的与表相关的 T-SQL 语句。</h1><p id="7ce1" class="pw-post-body-paragraph jk jl in jm b jn ml jp jq jr mm jt ju jv mn jx jy jz mo kb kc kd mp kf kg kh ig bi translated">典型的与表相关的 T-SQL 是:(1)创建表，(2)获取表描述，(3)插入记录，(4)从表中获取记录，(5)删除表中的记录，以及(6)删除表。</p><p id="e04e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">下面的语句定义了一组包含在数组<code class="fe mq mr ms mt b">arrySql</code>中的 T-SQL 字符串。反勾号，即`字符用于保留多个字符串行。</p><pre class="kj kk kl km gt nj mt nk bn nl nm bi"><span id="f60b" class="nn lo in mt b be no np l nt nr">arrySql=[<br/>    `<br/>    CREATE TABLE "MyCustomers" (<br/>        "CustomerID" int IDENTITY(1,1),<br/>        "CompanyName" nvarchar (40) NOT NULL ,<br/>        "ContactName" nvarchar (30) NULL ,<br/>        "ContactTitle" nvarchar (30) NULL ,<br/>        "Address" nvarchar (60) NULL ,<br/>        "City" nvarchar (15) NULL ,<br/>        "Region" nvarchar (15) NULL ,<br/>        "PostalCode" nvarchar (10) NULL ,<br/>        "Country" nvarchar (15) NULL)<br/>        ;<br/>    `,<br/>    `<br/>    SELECT <br/>        ordinal_position, <br/>        column_name, <br/>        data_type <br/>    FROM <br/>        information_schema.columns <br/>    WHERE <br/>        table_name = 'MyCustomers'<br/>    ;<br/>    `,<br/>    `<br/>    INSERT INTO MyCustomers (CompanyName, ContactName, ContactTitle, Address, City, Region, PostalCode, Country)<br/>    OUTPUT INSERTED.CustomerID         <br/>    VALUES ('COM', 'John', 'Mr', 'Malaysia', 'KL', 'Federal', '50000', 'Malaysia')<br/>    ;<br/>    `,<br/>    `<br/>    SELECT * FROM MyCustomers<br/>    ;<br/>    `,<br/>    `<br/>    DELETE FROM MyCustomers<br/>    ;<br/>    `,<br/>    `<br/>    DROP TABLE MyCustomers<br/>    ;<br/>    `                <br/>];</span></pre><p id="2370" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这个程序根据用户输入以 JavaScript 数组或对象的形式生成输出数据。输入选项被定义为一组包含在数组<code class="fe mq mr ms mt b">arryOpt</code>中的字符串。</p><pre class="kj kk kl km gt nj mt nk bn nl nm bi"><span id="5f22" class="nn lo in mt b be no np l nq nr">arryOpt=['array','object'];</span></pre><p id="1775" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">为了在数据库处理之前获得<code class="fe mq mr ms mt b">arrySql</code>和<code class="fe mq mr ms mt b">arryOpt</code>的索引值，程序要求用户输入两个整数参数。然后，程序将读取参数，并在数组中选取相应的值，如下所示。</p><pre class="kj kk kl km gt nj mt nk bn nl nm bi"><span id="800c" class="nn lo in mt b be no np l nq nr">const myArgs = process.argv.slice(2);<br/>strgSql=arryStrgSql[myArgs[0]];<br/>console.log('selected arryStrgSql: ',strgSql);<br/>strgOpt=arryStrgOpt[myArgs[1]]||'array';<br/>console.log('selected arryStrgOpt: ',strgOpt);</span></pre><p id="bbe9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">至此，上述语句可以一起写成如下形式。</p><pre class="kj kk kl km gt nj mt nk bn nl nm bi"><span id="f3f1" class="nn lo in mt b be no np l nt nr"><br/>/* filename: inputtest.js */<br/>arryStrgSql=[<br/>    `<br/>    CREATE TABLE "MyCustomers" (<br/>        "CustomerID" int IDENTITY(1,1),<br/>        "CompanyName" nvarchar (40) NOT NULL ,<br/>        "ContactName" nvarchar (30) NULL ,<br/>        "ContactTitle" nvarchar (30) NULL ,<br/>        "Address" nvarchar (60) NULL ,<br/>        "City" nvarchar (15) NULL ,<br/>        "Region" nvarchar (15) NULL ,<br/>        "PostalCode" nvarchar (10) NULL ,<br/>        "Country" nvarchar (15) NULL)<br/>        ;<br/>    `,<br/>    `<br/>    SELECT <br/>        ordinal_position, <br/>        column_name, <br/>        data_type <br/>    FROM <br/>        information_schema.columns <br/>    WHERE <br/>        table_name = 'MyCustomers'<br/>    ;<br/>    `,<br/>    `<br/>    INSERT INTO MyCustomers (CompanyName, ContactName, ContactTitle, Address, City, Region, PostalCode, Country)<br/>    OUTPUT INSERTED.CustomerID         <br/>    VALUES ('COM', 'John', 'Mr', 'Malaysia', 'KL', 'Federal', '50000', 'Malaysia')<br/>    ;<br/>    `,<br/>    `<br/>    SELECT * FROM MyCustomers<br/>    ;<br/>    `,<br/>    `<br/>    DELETE FROM MyCustomers<br/>    ;<br/>    `,<br/>    `<br/>    DROP TABLE MyCustomers<br/>    ;<br/>    `                <br/>];<br/><br/>arryStrgOpt=['array','object'];<br/><br/>const myArgs = process.argv.slice(2);<br/>strgSql=arryStrgSql[myArgs[0]];<br/>console.log('selected arryStrgSql: ',strgSql);<br/>strgOpt=arryStrgOpt[myArgs[1]]||'array';<br/>console.log('selected arryStrgOpt: ',strgOpt);</span></pre><p id="3955" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">以下是上述代码的控制台输入/输出示例。这里，对程序<code class="fe mq mr ms mt b">inputtest.js</code>的调用带有两个参数，即第一个参数 3 (select 语句)和第二个参数 0(数组输出)。</p><pre class="kj kk kl km gt nj mt nk bn nl nm bi"><span id="5a16" class="nn lo in mt b be no np l nq nr">PS C:\ZNODES&gt; node inputtest.js 3 0<br/>selected arryStrgSql:  <br/>    SELECT * FROM MyCustomers<br/>    ;<br/>    <br/>selected arryStrgOpt:  array<br/>PS C:\ZNODES&gt; </span></pre><h1 id="c3e7" class="ln lo in bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">(2)繁琐的输出类型，即 JSON 数组和对象。</h1><p id="f91d" class="pw-post-body-paragraph jk jl in jm b jn ml jp jq jr mm jt ju jv mn jx jy jz mo kb kc kd mp kf kg kh ig bi translated">繁琐的包以由值和元数据对象组成的对象的形式从表中检索每一行。如果程序用户喜欢将一行作为数组返回，则只选取对象值，例如:<code class="fe mq mr ms mt b">data: [[1,”COM”,”John”,”Mr”,”Malaysia”,”KL”,”Federal”,”50000",”Malaysia”]]</code></p><p id="fd62" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">否则，如果程序用户希望将一行作为对象返回，元数据对象的 colName 属性将被用作对象值的键，例如:<br/> <code class="fe mq mr ms mt b">data: [{“CustomerID”:1,”CompanyName”:”COM”,”ContactName”:”John”,”ContactTitle”:”Mr”,”Address”:”Malaysia”,”City”:”KL”,”Region”:”Federal”,”PostalCode”:”50000",”Country”:”Malaysia”}]</code></p><p id="31b5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">处理检索到的数据的代码如下:</p><pre class="kj kk kl km gt nj mt nk bn nl nm bi"><span id="fcc9" class="nn lo in mt b be no np l nq nr">    request.on('row', columns =&gt; { <br/>        if (strgOpt=="array"){<br/>            var arry=[];<br/>            columns.forEach(column =&gt; {<br/>                arry.push(column.value);<br/>            });<br/>            result.push(arry);<br/>            //console.log(result);  <br/>        }<br/>        if (strgOpt=="object"){<br/>            var objt={};<br/>            columns.forEach(column =&gt; {<br/>                objt[column.metadata.colName]=column.value;<br/>            });<br/>            result.push(objt);<br/>            //console.log(result);  <br/>        }        <br/>    });</span></pre><p id="c171" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">上面的代码将成为下面一个繁琐的相关功能的一部分，即<code class="fe mq mr ms mt b">executeSQL</code>。</p><pre class="kj kk kl km gt nj mt nk bn nl nm bi"><span id="a898" class="nn lo in mt b be no np l nq nr">var Request = require('tedious').Request;<br/><br/>const executeSQL = (connection,strgSql,strgOpt) =&gt; new Promise((resolve, reject) =&gt; {<br/>    var result =[];    <br/>    const request = new Request(strgSql, (err,rowCount) =&gt; {<br/>        if (err) {<br/>            reject(err);<br/>        } else {<br/>            //console.log("rowCount:",rowCount);<br/>            if ((result == "" || result == null || result == "null")) result = "[]";  <br/>            //console.log("result:",result);<br/>            resolve(result);<br/>        }   <br/>        connection.close();    <br/>    });    <br/>    request.on('row', columns =&gt; { <br/>        if (strgOpt=="array"){<br/>            var arry=[];<br/>            columns.forEach(column =&gt; {<br/>                arry.push(column.value);<br/>            });<br/>            result.push(arry);<br/>            //console.log(result);  <br/>        }<br/>        if (strgOpt=="object"){<br/>            var objt={};<br/>            columns.forEach(column =&gt; {<br/>                objt[column.metadata.colName]=column.value;<br/>            });<br/>            result.push(objt);<br/>            //console.log(result);  <br/>        }        <br/>    });<br/>    connection.on('connect', err =&gt; {<br/>        if (err) {<br/>            reject(err);<br/>        }<br/>        else {<br/>            connection.execSql(request);<br/>        }<br/>    });   <br/>    connection.connect();    <br/>});</span></pre><p id="f959" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><code class="fe mq mr ms mt b">executeSQL</code>函数返回一个<strong class="jm io">承诺</strong>对象。它需要三个参数，即连接对象(<code class="fe mq mr ms mt b">connection</code>)、SQL 语句(<code class="fe mq mr ms mt b">strgSql</code>)和输出类型(strgOpt)。为了处理一个 Promise 对象，对<code class="fe mq mr ms mt b">executeSQL</code>函数的调用应该包含在一个<strong class="jm io">异步模式</strong>中，如下所示。关键字<strong class="jm io"> await </strong>表示希望由<code class="fe mq mr ms mt b">executeSQl</code>函数返回一个承诺对象。</p><pre class="kj kk kl km gt nj mt nk bn nl nm bi"><span id="2c19" class="nn lo in mt b be no np l nq nr">const taskDbseCmmd = async() =&gt; {<br/>    try {<br/>        const data = await executeSQL(connection,strgSql,strgOpt);<br/>        console.log("data:",JSON.stringify(data));<br/>        //return data;<br/>    } catch (error) {<br/>        throw(error)<br/>    }<br/>};<br/><br/>taskDbseCmmd();</span></pre><p id="e198" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">数据库处理需要一个如下所示声明的连接对象。</p><pre class="kj kk kl km gt nj mt nk bn nl nm bi"><span id="779e" class="nn lo in mt b be no np l nq nr">var config = {  <br/>    server: 'localhost',<br/>    authentication: {<br/>        type: 'default',<br/>        options: {<br/>            userName: 'sa',<br/>            password: 'P@ssw0rd'<br/>        }<br/>    },<br/>    options: {<br/>        // If you are on Microsoft Azure, you need encryption:<br/>        encrypt: true,<br/>        database: 'master',<br/>        port:1433,<br/>        trustServerCertificate: true        <br/>    }<br/>};     <br/><br/>var Connection = require('tedious').Connection;<br/>const connection = new Connection(config);</span></pre><h1 id="f47e" class="ln lo in bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">(3)将所有这些放在一起</h1><p id="3a45" class="pw-post-body-paragraph jk jl in jm b jn ml jp jq jr mm jt ju jv mn jx jy jz mo kb kc kd mp kf kg kh ig bi translated">以上代码的完整脚本如下所示。</p><pre class="kj kk kl km gt nj mt nk bn nl nm bi"><span id="1367" class="nn lo in mt b be no np l nq nr">/* filename: appdbse.js */<br/><br/>var Request = require('tedious').Request;<br/>const executeSQL = (connection,strgSql,strgOpt) =&gt; new Promise((resolve, reject) =&gt; {<br/>    var result =[];    <br/>    const request = new Request(strgSql, (err,rowCount) =&gt; {<br/>        if (err) {<br/>            reject(err);<br/>        } else {<br/>            //console.log("rowCount:",rowCount);<br/>            if ((result == "" || result == null || result == "null")) result = "[]";  <br/>            //console.log("result:",result);<br/>            resolve(result);<br/>        }   <br/>        connection.close();    <br/>    });    <br/>    request.on('row', columns =&gt; { <br/>        if (strgOpt=="array"){<br/>            var arry=[]<br/>            columns.forEach(column =&gt; {<br/>                arry.push(column.value);<br/>            });<br/>            result.push(arry);<br/>            //console.log(result);  <br/>        }<br/>        if (strgOpt=="object"){<br/>            var objt={}<br/>            columns.forEach(column =&gt; {<br/>                objt[column.metadata.colName]=column.value;<br/>            });<br/>            result.push(objt);<br/>            //console.log(result);  <br/>        }        <br/>    });<br/>    connection.on('connect', err =&gt; {<br/>        if (err) {<br/>            reject(err);<br/>        }<br/>        else {<br/>            connection.execSql(request);<br/>        }<br/>    });   <br/>    connection.connect();    <br/>});<br/><br/><br/>arryStrgSql=[<br/>    `<br/>    CREATE TABLE "MyCustomers" (<br/>        "CustomerID" int IDENTITY(1,1),<br/>        "CompanyName" nvarchar (40) NOT NULL ,<br/>        "ContactName" nvarchar (30) NULL ,<br/>        "ContactTitle" nvarchar (30) NULL ,<br/>        "Address" nvarchar (60) NULL ,<br/>        "City" nvarchar (15) NULL ,<br/>        "Region" nvarchar (15) NULL ,<br/>        "PostalCode" nvarchar (10) NULL ,<br/>        "Country" nvarchar (15) NULL)<br/>        ;<br/>    `,<br/>    `<br/>    SELECT <br/>        ordinal_position, <br/>        column_name, <br/>        data_type <br/>    FROM <br/>        information_schema.columns <br/>    WHERE <br/>        table_name = 'MyCustomers'<br/>    ;<br/>    `,<br/>    `<br/>    INSERT INTO MyCustomers (CompanyName, ContactName, ContactTitle, Address, City, Region, PostalCode, Country)<br/>    OUTPUT INSERTED.CustomerID         <br/>    VALUES ('COM', 'John', 'Mr', 'Malaysia', 'KL', 'Federal', '50000', 'Malaysia')<br/>    ;<br/>    `,<br/>    `<br/>    SELECT * FROM MyCustomers<br/>    ;<br/>    `,<br/>    `<br/>    DELETE FROM MyCustomers<br/>    ;<br/>    `,<br/>    `<br/>    DROP TABLE MyCustomers<br/>    ;<br/>    `                <br/>];<br/><br/>arryStrgOpt=['array','object'];<br/><br/>const myArgs = process.argv.slice(2);<br/>strgSql=arryStrgSql[myArgs[0]];<br/>console.log('selected arryStrgSql: ',strgSql);<br/>strgOpt=arryStrgOpt[myArgs[1]]||'array';<br/>console.log('selected arryStrgOpt: ',strgOpt);<br/><br/>var config = {  <br/>    server: 'localhost',<br/>    authentication: {<br/>        type: 'default',<br/>        options: {<br/>            userName: 'sa',<br/>            password: 'P@ssw0rd'<br/>        }<br/>    },<br/>    options: {<br/>        // If you are on Microsoft Azure, you need encryption:<br/>        encrypt: true,<br/>        database: 'master',<br/>        port:1433,<br/>        trustServerCertificate: true        <br/>    }<br/>};     <br/><br/>var Connection = require('tedious').Connection;<br/>const connection = new Connection(config);<br/><br/>const taskDbseCmmd = async() =&gt; {<br/>    try {<br/>        const data = await executeSQL(connection,strgSql,strgOpt);<br/>        console.log("data:",JSON.stringify(data));<br/>        //return data;<br/>    } catch (error) {<br/>        throw(error)<br/>    }<br/>};<br/><br/>taskDbseCmmd();</span></pre><p id="82c3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">上述代码的控制台输入/输出示例如下。</p><pre class="kj kk kl km gt nj mt nk bn nl nm bi"><span id="4797" class="nn lo in mt b be no np l nq nr">PS C:\ZNODES&gt; node appdbse.js 0 0<br/>selected arryStrgSql:  <br/>    CREATE TABLE "MyCustomers" (<br/>        "CustomerID" int IDENTITY(1,1),<br/>        "CompanyName" nvarchar (40) NOT NULL ,<br/>        "ContactName" nvarchar (30) NULL ,<br/>        "ContactTitle" nvarchar (30) NULL ,<br/>        "Address" nvarchar (60) NULL ,<br/>        "City" nvarchar (15) NULL ,<br/>        "Region" nvarchar (15) NULL ,<br/>        "PostalCode" nvarchar (10) NULL ,<br/>        "Country" nvarchar (15) NULL)<br/>        ;<br/><br/>selected arryStrgOpt:  array<br/>data: "[]"<br/>PS C:\ZNODES&gt; node appdbse.js 1 0<br/>selected arryStrgSql:  <br/>    SELECT<br/>        ordinal_position,<br/>        column_name,<br/>        data_type<br/>    FROM<br/>        information_schema.columns<br/>    WHERE<br/>        table_name = 'MyCustomers'<br/>    ;<br/><br/>selected arryStrgOpt:  array<br/>data: [[1,"CustomerID","int"],[2,"CompanyName","nvarchar"],[3,"ContactName","nvarchar"],[4,"ContactTitle","nvarchar"],[5,"Address","nvarchar"],[6,"City","nvarchar"],[7,"Region","nvarchar"],[8,"PostalCode","nvarchar"],[9,"Country","nvarchar"]]<br/>PS C:\ZNODES&gt; node appdbse.js 2 0<br/>selected arryStrgSql:  <br/>    INSERT INTO MyCustomers (CompanyName, ContactName, ContactTitle, Address, City, Region, PostalCode, Country)<br/>    OUTPUT INSERTED.CustomerID<br/>    VALUES ('COM', 'John', 'Mr', 'Malaysia', 'KL', 'Federal', '50000', 'Malaysia')<br/>    ;<br/><br/>selected arryStrgOpt:  array<br/>data: [[1]]<br/>PS C:\ZNODES&gt; node appdbse.js 3 0<br/>selected arryStrgSql:  <br/>    SELECT * FROM MyCustomers<br/>    ;<br/><br/>selected arryStrgOpt:  array<br/>data: [[1,"COM","John","Mr","Malaysia","KL","Federal","50000","Malaysia"]]<br/>PS C:\ZNODES&gt; node appdbse.js 4 0<br/>selected arryStrgSql:<br/>    DELETE FROM MyCustomers<br/>    ;<br/><br/>selected arryStrgOpt:  array<br/>data: "[]"<br/>PS C:\ZNODES&gt; node appdbse.js 5 0<br/>selected arryStrgSql:<br/>    DROP TABLE MyCustomers<br/>    ;<br/><br/>selected arryStrgOpt:  array<br/>data: "[]"</span></pre><h1 id="88e0" class="ln lo in bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">(4)程序分解</h1><p id="6cba" class="pw-post-body-paragraph jk jl in jm b jn ml jp jq jr mm jt ju jv mn jx jy jz mo kb kc kd mp kf kg kh ig bi translated">为了提高代码的可读性和可维护性，可以将上述程序脚本文件拆分成几个脚本文件，即<code class="fe mq mr ms mt b">progArguments.js</code>、<code class="fe mq mr ms mt b">dbseConfig.js</code>、<code class="fe mq mr ms mt b">dbseService.js</code>和<code class="fe mq mr ms mt b">appMain.js</code>。<code class="fe mq mr ms mt b">appMain.js</code>将是首先启动的主程序。来自其他脚本文件的代码块在运行时通过<code class="fe mq mr ms mt b">module.exports</code>和<code class="fe mq mr ms mt b">require</code>技术集成到<code class="fe mq mr ms mt b">appMain.js</code>中。</p><p id="4bef" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">文件名:progArguments.js</p><pre class="kj kk kl km gt nj mt nk bn nl nm bi"><span id="1698" class="nn lo in mt b be no np l nq nr">/* filename: progArguments.js */<br/>const arrySql=[<br/>    `<br/>    CREATE TABLE "MyCustomers" (<br/>        "CustomerID" int IDENTITY(1,1),<br/>        "CompanyName" nvarchar (40) NOT NULL ,<br/>        "ContactName" nvarchar (30) NULL ,<br/>        "ContactTitle" nvarchar (30) NULL ,<br/>        "Address" nvarchar (60) NULL ,<br/>        "City" nvarchar (15) NULL ,<br/>        "Region" nvarchar (15) NULL ,<br/>        "PostalCode" nvarchar (10) NULL ,<br/>        "Country" nvarchar (15) NULL)<br/>        ;<br/>    `,<br/>    `<br/>    SELECT <br/>        ordinal_position, <br/>        column_name, <br/>        data_type <br/>    FROM <br/>        information_schema.columns <br/>    WHERE <br/>        table_name = 'MyCustomers'<br/>    ;<br/>    `,<br/>    `<br/>    INSERT INTO MyCustomers (CompanyName, ContactName, ContactTitle, Address, City, Region, PostalCode, Country)<br/>    OUTPUT INSERTED.CustomerID         <br/>    VALUES ('COM', 'John', 'Mr', 'Malaysia', 'KL', 'Federal', '50000', 'Malaysia')<br/>    ;<br/>    `,<br/>    `<br/>    SELECT * FROM MyCustomers<br/>    ;<br/>    `,<br/>    `<br/>    DELETE FROM MyCustomers<br/>    ;<br/>    `,<br/>    `<br/>    DROP TABLE MyCustomers<br/>    ;<br/>    `                <br/>];<br/><br/>const arryOpt=['array','object'];<br/><br/>module.exports ={arrySql,arryOpt};</span></pre><p id="61c2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">文件名:dbseConfig.js。</p><pre class="kj kk kl km gt nj mt nk bn nl nm bi"><span id="bded" class="nn lo in mt b be no np l nq nr">/* filename: dbseConfig.js */<br/>var config = {  <br/>    server: 'localhost',<br/>    authentication: {<br/>        type: 'default',<br/>        options: {<br/>            userName: 'sa',<br/>            password: 'P@ssw0rd'<br/>        }<br/>    },<br/>    options: {<br/>        // If you are on Microsoft Azure, you need encryption:<br/>        encrypt: true,<br/>        database: 'master',<br/>        port:1433,<br/>        trustServerCertificate: true        <br/>    }<br/>}     ;<br/><br/>module.exports = config;</span></pre><p id="bb93" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">文件名:dbseService.js。</p><pre class="kj kk kl km gt nj mt nk bn nl nm bi"><span id="9446" class="nn lo in mt b be no np l nq nr">/* filename: dbseService.js */<br/>var Request = require('tedious').Request;<br/><br/>const executeSQL = (connection,strgSql,strgOpt) =&gt; <br/>    new Promise((resolve, reject) =&gt; {<br/>        var result =[];    <br/>        const request = new Request(strgSql, (err,rowCount) =&gt; {<br/>            if (err) {<br/>                reject(err);<br/>            } else {<br/>                //console.log("rowCount:",rowCount);<br/>                if ((result == "" || result == null || result == "null")) result = "[]";  <br/>                //console.log("result:",result);<br/>                resolve(result);<br/>            }   <br/>            connection.close();    <br/>        });    <br/>        request.on('row', columns =&gt; { <br/>            if (strgOpt=="array"){<br/>                var arry=[]<br/>                columns.forEach(column =&gt; {<br/>                    arry.push(column.value);<br/>                });<br/>                result.push(arry);<br/>                //console.log(result);  <br/>            }<br/>            if (strgOpt=="object"){<br/>                var objt={}<br/>                columns.forEach(column =&gt; {<br/>                    objt[column.metadata.colName]=column.value;<br/>                });<br/>                result.push(objt);<br/>                //console.log(result);  <br/>            }        <br/>        });<br/>        connection.on('connect', err =&gt; {<br/>            if (err) {<br/>                reject(err);<br/>            }<br/>            else {<br/>                connection.execSql(request);<br/>            }<br/>        });   <br/>        connection.connect();    <br/>    });<br/><br/>module.exports ={executeSQL};</span></pre><p id="f7a8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">文件名:appMain.js。</p><pre class="kj kk kl km gt nj mt nk bn nl nm bi"><span id="2cae" class="nn lo in mt b be no np l nq nr">/* filename: appMain.js */<br/>var config = require('./dbseConfig');<br/>var Connection = require('tedious').Connection;<br/>const connection = new Connection(config);<br/>var dbseService= require ('./dbseService');<br/>var objtProgArguments = require('./progArguments');<br/><br/>const myArgs = process.argv.slice(2);<br/>strgSql=objtProgArguments.arrySql[myArgs[0]];<br/>console.log('selected arryStrgSql: ',strgSql);<br/>strgOpt=objtProgArguments.arryOpt[myArgs[1]]||'array';<br/>console.log('selected arryStrgOpt: ',strgOpt);<br/><br/>const taskDbseCmmd = async() =&gt; {<br/>    try {<br/>        const data = await dbseService.executeSQL(connection,strgSql,strgOpt);<br/>        console.log("data:",JSON.stringify(data));<br/>        //return data;<br/>    } catch (error) {<br/>        throw(error)<br/>    }<br/>};<br/><br/>taskDbseCmmd();</span></pre></div></div>    
</body>
</html>