<html>
<head>
<title>How to add logging to your Dropwizard application using Sematext</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用 Sematext 将日志添加到 Dropwizard 应用程序中</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/add-logging-to-your-dropwizard-application-using-sematext-d65f1cad6f48?source=collection_archive---------2-----------------------#2020-07-06">https://blog.devgenius.io/add-logging-to-your-dropwizard-application-using-sematext-d65f1cad6f48?source=collection_archive---------2-----------------------#2020-07-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/b29fa078d66b7d050d1135212d7e4bef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*DWQRDCJ_AuDsjV1T"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated"><a class="ae kc" href="https://unsplash.com/@desola?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">德索拉·兰若洛贡</a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</figcaption></figure><p id="7af8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们从一开始就使用 Sematext 作为日志提供者，我们对此非常满意。他们还通过他们的 web 界面使用 Kibana 提供日志可视化。在这篇文章中，我们将看看如何将它与你的 Dropwizard 应用程序集成。</p><p id="88ba" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Sematext 的另一个好处是，他们在免费层提供了一个非常好的交易，所以初创公司可以使用它快速免费地开始。</p><p id="8ae0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是我们将在本文中涉及的技术和产品的总结:</p><ul class=""><li id="2540" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated"><a class="ae kc" href="http://dropwizard.io/" rel="noopener ugc nofollow" target="_blank"> Dropwizard </a></li><li id="f9b4" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated"><a class="ae kc" href="https://sematext.com/" rel="noopener ugc nofollow" target="_blank">语义文本</a></li><li id="d04b" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated"><a class="ae kc" href="https://maven.apache.org/" rel="noopener ugc nofollow" target="_blank">美文</a></li><li id="f16e" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated"><a class="ae kc" href="https://www.docker.com/" rel="noopener ugc nofollow" target="_blank">码头工人</a></li><li id="9ad0" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated"><a class="ae kc" href="https://www.elastic.co/kibana" rel="noopener ugc nofollow" target="_blank">基巴纳</a></li></ul><h1 id="bc9e" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">什么是 Dropwizard？</h1><p id="0792" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">Dropwizard 是一个非常好的构建基于 Java 的 web 服务的小框架。从某种意义上来说，它是固执己见的，因为它引入了许多非常适合构建微服务的库，比如 HTTP 的 Jetty、JSON 编组的 Jackson 和日志记录的 Logback/SLF4J。然而，它并没有给你的应用程序添加太多的框架，这意味着没有 Spring 应用程序或 Java EE 应用程序那么神奇。</p><p id="bd77" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们喜欢 Dropwizard 如何平衡一组好的库，而又不太像一个框架。多年来，它一直是我们构建 Java 服务的默认选择。</p><h1 id="ff13" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">Dropwizard 的默认日志系统</h1><p id="68dc" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">默认情况下，Dropwizard 提供了人/机可读格式的组合。看起来是这样的:</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="45ad" class="nb lq iq mx b gy nc nd l ne nf">WARN [ 2010-04-06 06:42:35,275] com.example.dw.Thing: Doing a thing ERROR [ 2010-04-06 06:42:35,275] com.example.dw.Thing: This may get ugly. ! java.lang.RuntimeException: oh noes! ! at com.example.dw.Thing.run(Thing.java:16) !</span></pre><p id="9296" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了向 Sematext 等外部服务提供日志，我们需要修改输出目的地和格式。Dropwizard 支持通过改变<code class="fe ng nh ni mx b">Configuration</code>类中的底层<code class="fe ng nh ni mx b">LoggingFactory</code>来扩展它的日志系统。我们将实现我们自己的<code class="fe ng nh ni mx b">LogbackAutoConfigLoggingFactory</code>,它将 Logback 的自动配置功能添加到 Dropwizard，这样我们就可以定制 Logback 配置，这样它将产生一种 Sematext 可以解释的格式，并通过 Syslog 转发日志。</p><h1 id="a297" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">创建 Sematext 日志记录应用程序</h1><p id="1a8c" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">首先，你需要注册一个新的 Sematext 日志应用程序。他们提供一个免费层，所以去<a class="ae kc" href="https://sematext.com" rel="noopener ugc nofollow" target="_blank">https://sematext.com</a>，注册并创建一个新的应用程序。</p><p id="cdfd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您将获得一个应用程序令牌，我们将在下面的日志配置中使用它。</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nj"><img src="../Images/98c1af85bbf6b783bcaef9ce9d1006da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m-0O83pFFJEP6uFUE9aMlQ.png"/></div></div></figure><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nk"><img src="../Images/f187810dbbe7457ec8dcfaec61a0c61d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BBVM2nJAng7YU_ZEyC2G_g.png"/></div></div></figure><h1 id="18cf" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">通过系统日志转发日志</h1><p id="6997" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">在您的项目中创建以下类。当它被配置时，它将自动发现项目的<code class="fe ng nh ni mx b">resources</code>文件夹中的日志配置文件，这样您就可以覆盖 Dropwizard 的默认设置。</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="1fab" class="nb lq iq mx b gy nc nd l ne nf">public class LogbackAutoConfigLoggingFactory implements LoggingFactory {</span><span id="4ea7" class="nb lq iq mx b gy nl nd l ne nf"><a class="ae kc" href="http://twitter.com/JsonIgnore" rel="noopener ugc nofollow" target="_blank">@JsonIgnore</a><br/>  private LoggerContext loggerContext;</span><span id="8dca" class="nb lq iq mx b gy nl nd l ne nf"><a class="ae kc" href="http://twitter.com/JsonIgnore" rel="noopener ugc nofollow" target="_blank">@JsonIgnore</a><br/>  private final ContextInitializer contextInitializer;</span><span id="3c10" class="nb lq iq mx b gy nl nd l ne nf">public LogbackAutoConfigLoggingFactory() {<br/>    this.loggerContext = LoggingUtil.getLoggerContext();<br/>    this.contextInitializer = new ContextInitializer(loggerContext);<br/>  }</span><span id="d127" class="nb lq iq mx b gy nl nd l ne nf"><a class="ae kc" href="http://twitter.com/Override" rel="noopener ugc nofollow" target="_blank">@Override</a><br/>  public void configure(MetricRegistry metricRegistry, String name) {<br/>    try {<br/>      contextInitializer.autoConfig();<br/>    } catch (JoranException e) {<br/>      throw new RuntimeException(e);<br/>    }<br/>  }</span><span id="79d5" class="nb lq iq mx b gy nl nd l ne nf"><a class="ae kc" href="http://twitter.com/Override" rel="noopener ugc nofollow" target="_blank">@Override</a><br/>  public void stop() {<br/>    loggerContext.stop();<br/>  }</span><span id="765c" class="nb lq iq mx b gy nl nd l ne nf"><a class="ae kc" href="http://twitter.com/Override" rel="noopener ugc nofollow" target="_blank">@Override</a><br/>  public void reset() {<br/>    loggerContext.reset();<br/>  }</span><span id="40ec" class="nb lq iq mx b gy nl nd l ne nf">}</span></pre><p id="e38a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，我们需要覆盖 Dropwizard 配置类中的<code class="fe ng nh ni mx b">getLoggingFactory()</code>方法来使用我们的新类。</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="9b76" class="nb lq iq mx b gy nc nd l ne nf">public class SematextDropwizardLoggingConfiguration extends Configuration {</span><span id="f362" class="nb lq iq mx b gy nl nd l ne nf"><a class="ae kc" href="http://twitter.com/Override" rel="noopener ugc nofollow" target="_blank">@Override</a><br/>  public LoggingFactory getLoggingFactory() {<br/>    return new LogbackAutoConfigLoggingFactory();<br/>  }</span><span id="0c9e" class="nb lq iq mx b gy nl nd l ne nf">}</span></pre><p id="fc45" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，向<code class="fe ng nh ni mx b">src/main/resources</code>添加一个<code class="fe ng nh ni mx b">logback.xml</code>文件，它包含以下内容。注意<code class="fe ng nh ni mx b">{{TOKEN}}</code>,这是您将添加 Sematext 应用程序令牌的地方:</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="623a" class="nb lq iq mx b gy nc nd l ne nf">&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br/>&lt;configuration&gt;</span><span id="fa56" class="nb lq iq mx b gy nl nd l ne nf">&lt;appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender"&gt;<br/>    &lt;encoder&gt;<br/>      &lt;pattern&gt;%date %level %logger %thread - %message%n&lt;/pattern&gt;<br/>    &lt;/encoder&gt;<br/>  &lt;/appender&gt;</span><span id="296d" class="nb lq iq mx b gy nl nd l ne nf">&lt;appender name="SYSLOG" class="ch.qos.logback.classic.net.SyslogAppender"&gt;<br/>    &lt;syslogHost&gt;logsene-syslog-receiver.eu.sematext.com&lt;/syslogHost&gt;<br/>    &lt;port&gt;514&lt;/port&gt;<br/>    &lt;facility&gt;LOCAL0&lt;/facility&gt;<br/>    &lt;suffixPattern&gt;{{TOKEN}}:<a class="ae kc" href="http://twitter.com/cee" rel="noopener ugc nofollow" target="_blank">@cee</a>: {"thread":"%thread", "logger":"%logger",<br/>      "message":"%message", "throwable":"%throwable"}<br/>    &lt;/suffixPattern&gt;<br/>  &lt;/appender&gt;</span><span id="14fe" class="nb lq iq mx b gy nl nd l ne nf">&lt;root level="info"&gt;<br/>    &lt;appender-ref ref="SYSLOG"/&gt;<br/>    &lt;appender-ref ref="STDOUT"/&gt;<br/>  &lt;/root&gt;</span><span id="ac0c" class="nb lq iq mx b gy nl nd l ne nf">&lt;/configuration&gt;</span></pre><p id="d637" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">注意:</strong>我们在上面的 Sematext 中使用<code class="fe ng nh ni mx b"><strong class="kf ir">eu.sematext.com</strong></code>表示欧洲地区。您需要对此进行修改，以便使用不同的区域。</p><h1 id="3f44" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">测试集成</h1><p id="c980" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">通过运行以下命令启动 Dropwizard 应用程序:</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="33c6" class="nb lq iq mx b gy nc nd l ne nf">java -Duser.timezone=UTC -jar target/sematext-dropwizard-logging-1.0-SNAPSHOT.jar server config.yml</span></pre><p id="5d31" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">注意:</strong> <code class="fe ng nh ni mx b">-Duser.timezone=UTC</code>将 Java 应用程序设置为以 UTC 作为时区运行，这样您将在 Sematext 中获得 UTC 格式的应用程序日志。</p><p id="40e3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，我们使用 Sematext 为 Dropwizard 应用程序提供了全功能日志记录。</p><h1 id="2fd6" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">解决纷争</h1><p id="399e" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">如果您在查找日志时遇到问题，请仔细检查以下内容:</p><ul class=""><li id="b067" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated">您的<code class="fe ng nh ni mx b">pom.xml</code>中的依赖项</li><li id="a5a5" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">时间戳。尽量不要在 Kibana/Sematext 中使用基于时间的过滤，并且</li></ul><h1 id="ae43" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">从 Docker 容器转发日志</h1><p id="54b2" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">如果您将应用程序部署为 Kubernetes 集群中的一个<a class="ae kc" href="https://docker.io" rel="noopener ugc nofollow" target="_blank"> Docker </a>容器，Sematext 提供了一个<a class="ae kc" href="https://github.com/sematext/sematext-agent-docker" rel="noopener ugc nofollow" target="_blank">agent，安装在您的 as 集群中非常简单。如果您使用 Docker 代理来发送日志，它将转发从您的应用程序附加到控制台的日志。您可以直接将日志写入控制台，而不是将其发送到 Syslog，代理将获取这些日志并将其转发到 Sematext</a></p><h1 id="792a" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">完整的代码示例</h1><p id="0ea7" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">这种设置的完整项目示例可以在我们的 Github 帐户中找到:</p><ul class=""><li id="4a23" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated"><a class="ae kc" href="https://github.com/serialized-io/sematext-dropwizard-example" rel="noopener ugc nofollow" target="_blank">带语义日志记录的 Dropwizard 项目</a></li></ul><p id="ce8a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">祝你伐木好运！</p></div><div class="ab cl nm nn hu no" role="separator"><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr"/></div><div class="ij ik il im in"><p id="f33d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="nt">最初发布于</em><a class="ae kc" href="https://serialized.io/blog/logging-dropwizard-sematext/" rel="noopener ugc nofollow" target="_blank"><em class="nt">https://serialized . io</em></a><em class="nt">。</em></p></div></div>    
</body>
</html>