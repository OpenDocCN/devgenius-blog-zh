<html>
<head>
<title>Automating Bitbucket Pipelines with Lambda and Slack</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">利用Lambda和Slack实现位桶流水线自动化</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/automating-bitbucket-pipelines-with-lambda-and-slack-3f645eab6a57?source=collection_archive---------9-----------------------#2022-01-20">https://blog.devgenius.io/automating-bitbucket-pipelines-with-lambda-and-slack-3f645eab6a57?source=collection_archive---------9-----------------------#2022-01-20</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/69d9394c4f1aa37e0c0b703bf35164bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eEnhMcE_dA__eAZRflx1Xg.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated"><a class="ae jz" href="https://ajike.github.io/lambda-to-slack/" rel="noopener ugc nofollow" target="_blank">https://ajike.github.io/lambda-to-slack/</a></figcaption></figure><p id="f1fc" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Bitbucket管道功能非常丰富，您可以根据需要定制和自动化一切。但是，在某些情况下，您需要手动触发管道。在一些开发过程之后，创建一个发布候选(RC)版本就是其中之一。如果测试环境中一切正常，您可以手动触发RC管道。在这篇文章中，我将谈论如何在不离开你最喜欢的消息应用程序的情况下实现这一点。</p></div><div class="ab cl ky kz hr la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ig ih ii ij ik"><p id="712f" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io"> 1位桶API </strong></p><p id="ac55" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Atlassian提供了一个很棒的REST API和文档来执行您在存储库中用鼠标点击就可以完成的任何操作。但是首先，我们需要一个应用程序密码来使用这个API。</p><figure class="lg lh li lj gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi lf"><img src="../Images/77abab7890662029c7a5ecdb76e6beba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FVVREpgS2jx3Rv6B09fK_g.png"/></div></div></figure><p id="50a0" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">出于安全考虑，此app密码只允许使用管道权限。获得密码后，我们可以使用Bitbucket API以编程方式触发管道(或任何其他操作)。来自API文档:<a class="ae jz" href="https://developer.atlassian.com/cloud/bitbucket/rest/api-group-pipelines/#api-repositories-workspace-repo-slug-pipelines-post" rel="noopener ugc nofollow" target="_blank">https://developer . atlassian . com/cloud/bit bucket/rest/API-group-pipelines/# API-repositories-workspace-repo-slug-pipelines-post</a></p><pre class="lg lh li lj gt lk ll lm ln aw lo bi"><span id="c9d2" class="lp lq in ll b gy lr ls l lt lu">$ curl -X POST -is -u username:password <br/>-H 'Content-Type: application/json' https://api.bitbucket.org/2.0/repositories/jeroendr/meat-demo2/pipelines/ <br/>-d '  { "target": <br/>{"ref_type": "branch", "type": "pipeline_ref_target",<br/>"ref_name": "master"}}'</span></pre><p id="7bce" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">使用Python</p><figure class="lg lh li lj gt jo"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="afde" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在json payload中，“pattern”是管道的<strong class="kc io">名称，“ref_name”是管道</strong>的<strong class="kc io">源分支。</strong></p><p id="1a8b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">2-AWSλ</strong></p><p id="0c0a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们有工作的Python代码来触发管道，但我们需要一个端点来在需要时执行这段代码。换句话说，我们需要一个存放代码的地方。由于这项任务不需要一台一直处于运行状态的服务器，因此无服务器解决方案是最佳选择。我会选择AWS Lambda。</p><p id="c949" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">创建一个简单的Lambda函数非常简单。只有3件事值得一提:</p><ul class=""><li id="32b6" class="lx ly in kc b kd ke kh ki kl lz kp ma kt mb kx mc md me mf bi translated">外部库</li></ul><p id="94eb" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在这段代码中，我们只需要Python的请求库。在Lambda函数中，管理外部依赖关系的最佳方式之一是创建层。创建一个包含请求库的层，并将它附加到我们的函数中，这样就可以工作了。</p><ul class=""><li id="b3f7" class="lx ly in kc b kd ke kh ki kl lz kp ma kt mb kx mc md me mf bi translated">互联网接入</li></ul><p id="3659" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">默认情况下，Lambda函数在VPC内部没有公共internet访问。为了从我们的函数与Bitbucket API通信，我们需要一个。我们必须创建VPC、公私子网、NAT网关，并相应地配置路由表。这看起来有点复杂，但AWS的文档让一切变得非常简单:<a class="ae jz" href="https://aws.amazon.com/tr/premiumsupport/knowledge-center/internet-access-lambda-function/" rel="noopener ugc nofollow" target="_blank">https://AWS . Amazon . com/tr/premium support/knowledge-center/internet-access-lambda-function/</a></p><ul class=""><li id="bd89" class="lx ly in kc b kd ke kh ki kl lz kp ma kt mb kx mc md me mf bi translated">API网关</li></ul><p id="5df9" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">当我们的Lamba函数准备好了，我们需要一个端点从我们的Slack Bot调用这个函数。从函数的添加触发器部分，我们可以添加一个API端点。我选择了HTTP API。</p><figure class="lg lh li lj gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mg"><img src="../Images/369f2bc345f1a2f3191e1e460bc8a734.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bvYozRI6i84PKtLuMJ6FCQ.png"/></div></div></figure><p id="05c7" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在我们有了一个端点，每次我们发出请求时，它都会运行我们的Lambda函数。通过这个函数，我们触发了我们的比特桶流水线。</p><p id="4acb" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io"> 3-松弛</strong></p><p id="4e33" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">作为最后一步，我们需要一个Slack bot来调用我们的API网关。不赘述，这篇文章解释的很好:<a class="ae jz" href="https://medium.com/geekculture/trigger-pipe-via-slack-command-8990fe707609" rel="noopener">https://medium . com/geek culture/trigger-pipe-via-slack-command-8990 Fe 707609</a></p><p id="1c08" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">唯一的区别是，我们必须提供API网关URL作为Slack应用程序的请求URL。所以每次执行斜杠命令时，我们的API网关和Lambda函数都会被调用。</p></div><div class="ab cl ky kz hr la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ig ih ii ij ik"><p id="1212" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">当您有很多项目时，每天手动触发定制管道可能会非常乏味。使用Slack自动化这个过程可能会非常有帮助。</p></div><div class="ab cl ky kz hr la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ig ih ii ij ik"><p id="c06f" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">参考文献:</strong></p><ul class=""><li id="b39e" class="lx ly in kc b kd ke kh ki kl lz kp ma kt mb kx mc md me mf bi translated"><a class="ae jz" href="https://medium.com/geekculture/trigger-pipe-via-slack-command-8990fe707609" rel="noopener">https://medium . com/geek culture/trigger-pipe-via-slack-command-8990 Fe 707609</a></li><li id="e2a6" class="lx ly in kc b kd mh kh mi kl mj kp mk kt ml kx mc md me mf bi translated"><a class="ae jz" href="https://aws.amazon.com/tr/premiumsupport/knowledge-center/internet-access-lambda-function/" rel="noopener ugc nofollow" target="_blank">https://AWS . Amazon . com/tr/premium support/knowledge-center/internet-access-lambda-function/</a></li></ul></div></div>    
</body>
</html>