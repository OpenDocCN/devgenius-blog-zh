<html>
<head>
<title>SQL Window Functions translated into pandas</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">SQL 窗口函数翻译成熊猫</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/sql-window-functions-translated-into-pandas-2d0f5090f38a?source=collection_archive---------11-----------------------#2022-12-23">https://blog.devgenius.io/sql-window-functions-translated-into-pandas-2d0f5090f38a?source=collection_archive---------11-----------------------#2022-12-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="d7c3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将首先描述窗口函数的抽象逻辑，然后看看它们是如何在 SQL 和 pandas 中实现的。如果您想将 SQL 知识扩展到 pandas，或者相反，这篇文章可以帮助您。在 pandas 中，SQL 中的每个命令后面都会跟有类似的操作。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/2dff509bb18a9679ec189ba90aa30ff3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*G7Iz8DGXETZaIP7E"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">照片由<a class="ae lb" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的<a class="ae lb" href="https://unsplash.com/fr/@sunder_2k25?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Sunder Muthukumaran </a>拍摄</figcaption></figure><p id="d0c3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将使用<a class="ae lb" href="https://www.kaggle.com/datasets/unsdsn/world-happiness?resource=download" rel="noopener ugc nofollow" target="_blank">世界幸福报告</a>作为我们的数据集。你可以阅读<a class="ae lb" rel="noopener ugc nofollow" target="_blank" href="/import-excel-spreadsheets-to-database-with-pandas-2d7af5faee4f">我的文章</a>如何快速扭转你的。csv 文件导入到数据库表中。</p><h2 id="c4f8" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">什么是 SQL 窗口函数</h2><p id="4cf9" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">GROUP BY 语句返回每个组的聚合值。窗口函数也返回聚合值，但是它们为表中的每一行赋值。</p><h2 id="1cc2" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">对分区中的示例进行计数的 SQL 窗口函数</h2><p id="4331" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">我们会将每个地区的示例数量添加到每个记录中。我们将使用<strong class="jp ir"> PARTITION BY </strong>表达式，它类似于<strong class="jp ir"> GROUP BY </strong>确定我们对数据分组的值。</p><pre class="km kn ko kp gt ma mb mc bn md me bi"><span id="43ce" class="mf ld iq mb b be mg mh l mi mj">SELECT Country, Region,<br/>count(*) OVER(PARTITION BY Region) as number_of_examples<br/>FROM test.world_happiness;<br/></span></pre><p id="28e6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们使用<strong class="jp ir"> COUNT </strong>聚合函数来获取示例的数量。其他聚合函数如<strong class="jp ir"> AVG、总和、最小值、最大值</strong>等也适用。下面的结果显示，同一分区中的每个示例都具有相同的聚合值。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi mk"><img src="../Images/f5dffd680956445ad4a5636f5881e564.png" data-original-src="https://miro.medium.com/v2/resize:fit:774/format:webp/1*_Gcg9RYqp0Ui9zh72C-Weg.png"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">窗口函数的 MySQL 结果</figcaption></figure><h2 id="ad51" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">熊猫变换函数分组计数示例</h2><p id="297b" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated"><strong class="jp ir"> SQL </strong>不允许<strong class="jp ir"> GROUP BY </strong>语句和窗口函数出现在同一个查询中。在 pandas 窗口中，操作遵循分组功能。<a class="ae lb" href="https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.transform.html" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir">。变换</strong>后使用</a>功能<strong class="jp ir">。groupby </strong>确保为每一行计算一个值。我们在转换中使用了 len 函数。</p><pre class="km kn ko kp gt ma mb mc bn md me bi"><span id="0228" class="mf ld iq mb b be mg mh l mi mj">number_of_examples = df.groupby("Region")["Region"].transform(len)<br/>df.loc[:, ["Country", "Region"]].assign(number_of_examples=number_of_examples)</span></pre><p id="05cd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">其他聚合函数如<strong class="jp ir"> sum、max、min </strong>和可定制的<a class="ae lb" href="https://realpython.com/python-lambda/" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir"> lambda 函数</strong> </a>也适用。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi ml"><img src="../Images/3480ad29c9b0731afd2e677a679a9d27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1096/format:webp/1*bscDOXv1AVcdCqVdDsleiQ.png"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">熊猫分组结果—转化</figcaption></figure><h2 id="bef9" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">在 SQL 中对分区内的行进行排序</h2><p id="65e7" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">我们将使用<strong class="jp ir"> SQL </strong> <strong class="jp ir"> RANK </strong>函数来确定一个国家在他们所在地区内的特定指标(如自由度)的排名。</p><pre class="km kn ko kp gt ma mb mc bn md me bi"><span id="ce65" class="mf ld iq mb b be mg mh l mi mj">SELECT Country, Region, Freedom,<br/>rank() OVER(PARTITION BY Region ORDER BY Freedom DESC) as freedom_rank<br/>FROM test.world_happiness;</span></pre><p id="1792" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在划分之后，我们需要使用<strong class="jp ir"> ORDER BY </strong>来确定度量及其方向，在我们的例子中是降序。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi mm"><img src="../Images/2048cdae115796ecb9d02545a7a3d529.png" data-original-src="https://miro.medium.com/v2/resize:fit:820/format:webp/1*Uo2ZipTuUbP4_2XnuZh0BQ.png"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">使用 RANK 的窗口函数的 MySQL 结果</figcaption></figure><p id="70b7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另一种选择是过滤掉在各自分区中排名前 3 的所有国家。我们需要使用嵌套查询来完成这项工作，因为直接过滤窗口函数的结果是不可能的。</p><pre class="km kn ko kp gt ma mb mc bn md me bi"><span id="2f61" class="mf ld iq mb b be mg mh l mi mj">SELECT Country, Region, Freedom, freedom_rank from<br/>(SELECT Country, Region, Freedom,<br/>rank() OVER(PARTITION BY Region ORDER BY Freedom DESC) as freedom_rank<br/>FROM test.world_happiness) as window_table<br/>WHERE freedom_rank &lt;=3;</span></pre><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/2ed6d5f93ed60a9a1835945086299db6.png" data-original-src="https://miro.medium.com/v2/resize:fit:816/format:webp/1*t4dM2-DOBvrUaUNJ8zGdNg.png"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">使用 RANK 的窗口函数的 MySQL 结果(过滤)</figcaption></figure><h2 id="618d" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">使用熊猫在组内排列行</h2><p id="05f8" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated"><strong class="jp ir"> </strong> <a class="ae lb" href="https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.rank.html" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir">。rank() </strong> </a>函数在<strong class="jp ir"> groupby </strong>之后应用，并返回每行在各自组中的排名。</p><pre class="km kn ko kp gt ma mb mc bn md me bi"><span id="cde7" class="mf ld iq mb b be mg mh l mi mj">freedom_rank = df.groupby("Region")["Freedom"].rank()<br/>df.loc[:,["Region", "Country"]].assign(freedom_rank=freedom_rank)</span></pre><p id="9b15" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">默认顺序与 SQL 中的顺序略有不同，但是我们可以很容易地对其进行排序，并过滤出每个地区的前 3 名。</p><pre class="km kn ko kp gt ma mb mc bn md me bi"><span id="167e" class="mf ld iq mb b be mg mh l mi mj">df.loc[:,["Region", "Country"]]\<br/>  .assign(freedom_rank=freedom_rank)\<br/>  .query("freedom_rank&lt;=3")\<br/>  .sort_values(by=["Region", "freedom_rank"])</span></pre><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi mo"><img src="../Images/861f26ad6e133b3fabfc52d1ea44af98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1098/format:webp/1*LFe0LegI15kBcn4epme7pQ.png"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">大熊猫分组结果—排名</figcaption></figure><h2 id="5b7f" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">结论</h2><p id="2d0b" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">我们希望您对 SQL 窗口函数及其在 pandas 中的对应项有了更好的理解。另一篇使用时间排序数据的窗口函数的文章将很快发布。</p><p id="f76b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">谢谢你读了这个故事！</p></div></div>    
</body>
</html>