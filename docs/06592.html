<html>
<head>
<title>Easy Node-Discovery with Consul</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">利用 Consul 轻松发现节点</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/easy-node-discovery-with-consul-8b6f3c4b5116?source=collection_archive---------14-----------------------#2022-01-18">https://blog.devgenius.io/easy-node-discovery-with-consul-8b6f3c4b5116?source=collection_archive---------14-----------------------#2022-01-18</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/356577a0499733530ed9fdbaf8a8e7de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Cz3Q1LA8Uj6lNqgWwQ3Oew.png"/></div></div></figure><p id="52bf" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi kt translated">有时，要跟上生态系统中所有不同的服务器真的很难。无论你是一个主机商，一个有很多不同测试服务器的代理机构，还是一个非常积极的自由职业者。当涉及到 IP 地址和可用系统时，只有一个真实的来源不是很好吗？Consul 节点发现解决您的问题！</p><p id="b83d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">让我们面对现实吧！您在服务器方面获得的经验越多，您就拥有越多！越来越多的系统意味着您的节点需要更高的安全级别。</p><p id="2011" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">无论您是否使用 NAGIOS、RUNDECK 或任何其他工具来监控和维护您的服务器，它们都有一个共同点。他们通常需要节点及其 IP 地址的列表。如果它与工具无关，那么拥有一份最新的服务器列表仍然是一件好事。</p><p id="0cc7" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">所以你的任务简单明了:</p><blockquote class="lc"><p id="4416" class="ld le in bd lf lg lh li lj lk ll ks dk translated">获取可用节点及其 IP 地址的单一列表！</p></blockquote></div><div class="ab cl lm ln hr lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="ig ih ii ij ik"><p id="769a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">领事给你的正是这个。<br/>事实上，它做得更多，比如服务发现等。<br/>但是今天，我们只关注一个<strong class="jx io">简单的即插即用设置来访问可用节点列表。</strong></p><p id="1715" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">一旦你深入了解，事情就变得棘手了，但是这篇文章实际上只是关于一个简单的安装。我们也将跳过防火墙和更多的设置(但请仍然使用它)。</p><p id="6643" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">对于 Consul，我们将使用带有官方 Docker 映像的简单 Docker 设置，但是我们的客户机节点将直接在主机系统上配置(即使您在这些主机系统上运行 Docker 容器)。</p><p id="24dd" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们开始吧！</p><h1 id="015e" class="lt lu in bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">咨询主服务器</h1><p id="8013" class="pw-post-body-paragraph jv jw in jx b jy mr ka kb kc ms ke kf kg mt ki kj kk mu km kn ko mv kq kr ks ig bi translated">我们现在将创建一个领事主节点。为此，我们显然需要一台新服务器…</p><p id="470f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">一旦订购和运行，请安装 Docker，并确保它的工作。</p><p id="7049" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在我们需要做的就是，创建一个"<em class="mw"> docker-compose.yml" </em>文件并配置我们的 Consul 容器。</p><pre class="mx my mz na gt nb nc nd ne aw nf bi"><span id="0d0e" class="ng lu in nc b gy nh ni l nj nk">version: "3.0"</span><span id="4b85" class="ng lu in nc b gy nl ni l nj nk">services:<br/>   consul:<br/>    container_name: consul<br/>    image: consul:latest<br/>    ports:<br/>      — "80:8500"<br/>      — "8300:8300"<br/>      — "8600:8600/tcp"<br/>      — "8600:8600/udp"<br/>      — "8301:8301/udp"<br/>      — "8301:8301/tcp"<br/>      — "8302:8302/udp"<br/>      — "8302:8302/tcp"<br/>    volumes:<br/>      — "./consul/config.json:/etc/consul.d/bootstrap/config.json"<br/>    command: “agent -server -config-file /etc/consul.d/bootstrap/config.json”</span></pre><p id="6aac" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">Consul 需要几个<strong class="jx io">端口</strong>用于主节点和客户端节点之间的握手。如果使用的话，UI 可以通过端口 8500 获得。我们只需将端口 80 映射到它，这样我们就有了一个很好的 HTTP 体验。尽管如此，请随意使用 HTTPS，NGINX 代理或任何你需要的东西。</p><p id="64ef" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">当新客户端加入主客户端时，将使用其他端口。<em class="mw"> tcp </em>和<em class="mw"> udp </em>条目的分离是故意的！</p><p id="0804" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">最后但同样重要的是，我们为我们的<strong class="jx io">配置文件</strong>使用一个 bind-mount，并确保 Consul 是以服务器模式启动的，并且在<strong class="jx io">命令</strong>部分中使用我们挂载的配置文件。</p><p id="8fb2" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在我们的<strong class="jx io">配置文件</strong>在我们的子目录<em class="mw">下。/consul/config.json </em>”。<br/>这个包含了我们数据中心所需的一切。<br/>请为其提供一个<strong class="jx io">名称</strong>，使用您的服务器公共主机 IP 作为<strong class="jx io"> advertise_addr </strong>，并分配您的<strong class="jx io">加密令牌</strong>。</p><pre class="mx my mz na gt nb nc nd ne aw nf bi"><span id="67df" class="ng lu in nc b gy nh ni l nj nk">{<br/> "datacenter": "my-data-center",<br/> "data_dir": "/var/consul",<br/> "bootstrap": true,<br/> "server": true,<br/> "ui" : true,<br/> "encrypt": "xxx",<br/> "client_addr" : "0.0.0.0",<br/> "advertise_addr" : "x.x.x.x"<br/>}</span></pre><p id="ac7d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">但是嘿？！您从哪里获得加密令牌？</p><p id="843f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">加密令牌基本上是访问数据中心的密码。但是你不能在那里粘贴任何字符串。它必须是领事创造的<strong class="jx io">。这就是我们现在要做的初始设置。</strong></p><pre class="mx my mz na gt nb nc nd ne aw nf bi"><span id="6b1a" class="ng lu in nc b gy nh ni l nj nk">docker run consul:latest keygen</span></pre><p id="55bc" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">好了，现在我们有了令牌，只要把它粘贴到配置文件中，最后<strong class="jx io">启动我们的 Docker 容器</strong>。</p><blockquote class="nm nn no"><p id="f548" class="jv jw mw jx b jy jz ka kb kc kd ke kf np kh ki kj nq kl km kn nr kp kq kr ks ig bi translated">恭喜你，你的领事大师现在应该可以运行了。<br/>你应该可以用你的 IP 或域名通过 HTTP 访问它，如果也设置了的话。</p></blockquote><figure class="mx my mz na gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ns"><img src="../Images/5d3ff01a8ed53c4305f7a7171f75b105.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PKwLHlCaBSk7CqlpH8BNfA.png"/></div></div></figure><blockquote class="nm nn no"><p id="594d" class="jv jw mw jx b jy jz ka kb kc kd ke kf np kh ki kj nq kl km kn nr kp kq kr ks ig bi translated">如果 Consul 没有正确启动，您可以随时查看日志输出，以获得有关任何配置问题的更多信息。只需在我们的样本中使用“docker 日志咨询”。</p></blockquote><p id="7ee7" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">谈到<strong class="jx io">防火墙</strong>需要考虑什么？总的来说，要时刻注意 Docker、UFW 和 IPTABLES 的问题。<br/>这意味着，码头港口仍可能暴露，即使 UFW 会阻止它。请谷歌 DOCKER-USER chain 了解更多，因为这可能很多，真的超出了这里的范围:)</p><p id="adb8" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">但是一旦完成(以任何方式)，这里是客户端在加入您的 consul 数据中心时需要访问的端口。</p><pre class="mx my mz na gt nb nc nd ne aw nf bi"><span id="2766" class="ng lu in nc b gy nh ni l nj nk">8600, 8300, 8301, 8302</span></pre><blockquote class="nm nn no"><p id="1ee4" class="jv jw mw jx b jy jz ka kb kc kd ke kf np kh ki kj nq kl km kn nr kp kq kr ks ig bi translated">你现在不需要这么做，继续就可以了，风险自担；)</p></blockquote><h1 id="281c" class="lt lu in bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">添加您的第一个客户端节点</h1><p id="4639" class="pw-post-body-paragraph jv jw in jx b jy mr ka kb kc ms ke kf kg mt ki kj kk mu km kn ko mv kq kr ks ig bi translated">终于到了将您的第一个客户端节点添加到我们的数据中心的时候了。再次重申，订购新的服务器或使用现有的服务器。</p><p id="6915" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">之后，我们需要在服务器上安装 Consul。<br/>这个安装脚本是基于 UBUNTU 20 的(应该是 20 吧，我觉得……至少是 UBUNTU)。</p><pre class="mx my mz na gt nb nc nd ne aw nf bi"><span id="a4ad" class="ng lu in nc b gy nh ni l nj nk">curl -fsSL <a class="ae nt" href="https://apt.releases.hashicorp.com/gpg" rel="noopener ugc nofollow" target="_blank">https://apt.releases.hashicorp.com/gpg</a> | sudo apt-key add -</span><span id="4461" class="ng lu in nc b gy nl ni l nj nk">sudo apt-add-repository "deb [arch=amd64] <a class="ae nt" href="https://apt.releases.hashicorp.com" rel="noopener ugc nofollow" target="_blank">https://apt.releases.hashicorp.com</a> $(lsb_release -cs) main"</span><span id="b6f7" class="ng lu in nc b gy nl ni l nj nk">sudo apt-get update <br/>sudo apt-get install consul</span></pre><p id="ba36" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">安装后，您已经可以使用此命令加入您的数据中心。</p><pre class="mx my mz na gt nb nc nd ne aw nf bi"><span id="d569" class="ng lu in nc b gy nh ni l nj nk">sudo consul agent -retry-join "x.x.x.x" -bind=0.0.0.0 -advertise=$(hostname -I | cut -d' ' -f1) -datacenter="my-data-center" -encrypt="xxx" -data-dir=/var/www/src/consul</span></pre><p id="51ea" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">使用<strong class="jx io">-重试-加入</strong>的咨询主管、正确的<strong class="jx io">数据中心名称</strong>和<strong class="jx io">加密令牌</strong>。<strong class="jx io">通告 IP </strong>地址应该已经从 hostname 命令中提取出来。</p><p id="6902" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">特别是广告 IP 是重要的，因为这是一个，将在 Consul 内部使用，以显示该节点的公共 IP 地址。</p><p id="3d48" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">请记住，这个一行程序不会在本文中使用额外的配置，尽管这是可能的。所以像用过的服务之类的东西不传输，只传输我们的基本节点和 IP 地址。</p><blockquote class="nm nn no"><p id="2166" class="jv jw mw jx b jy jz ka kb kc kd ke kf np kh ki kj nq kl km kn nr kp kq kr ks ig bi translated">如果你已经做了所有正确的事情，你现在应该在 Consul 的 web UI 中看到你的新节点。祝贺你！</p></blockquote><figure class="mx my mz na gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nu"><img src="../Images/dca034307b2b51d513208fe5af74ea9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NhRC9eLjmMDFANtjh4ZUFw.png"/></div></div></figure><p id="d527" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如果你还想改进的话，我再次建议你试试防火墙。确保在这些端口上只允许来自您的领事大师 IP 的来电(如果您愿意)</p><pre class="mx my mz na gt nb nc nd ne aw nf bi"><span id="585f" class="ng lu in nc b gy nh ni l nj nk">8300, 8301, 8302</span></pre><p id="7b34" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如果你现在使用 Puppet 之类的东西，或者其他任何东西来创建新的服务器，你可能想要<strong class="jx io">自动开始加入过程</strong>。这就是为什么在我的示例中它只是基于一行代码的原因。<br/>最简单的方法是创建一个 cronjob。每 x 分钟加入一次(反正只有第一次有效)。但是其他更好的方法也是可能的，比如启动脚本、超级监视器或者任何你想到的方法。这取决于你！</p><h1 id="22e7" class="lt lu in bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">使用 API 提取节点</h1><p id="35ba" class="pw-post-body-paragraph jv jw in jx b jy mr ka kb kc ms ke kf kg mt ki kj kk mu km kn ko mv kq kr ks ig bi translated">终于到了使用节点实现自动化的时候了！<br/>有些系统可能已经有了用于 Consul 集成的插件，但如果没有，你可以自己调用 API，通过生成自己的配置来施展你的魔法；)</p><p id="3dc8" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">那么为什么不为 Rundeck 生成一个<em class="mw"> resources.yml </em>？还是其他应用？</p><p id="59bc" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这是一个基于 PHP 的脚本，用于获取 consul master 的可用成员节点。它应该可以帮助你开始。</p><p id="1696" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">只需提供带有<strong class="jx io">加密令牌</strong>的<strong class="jx io"> URL </strong>，就可以开始了。</p><pre class="mx my mz na gt nb nc nd ne aw nf bi"><span id="8dea" class="ng lu in nc b gy nh ni l nj nk">$url = '<a class="ae nt" href="http://consul.mydomain.com/v1/agent/members'" rel="noopener ugc nofollow" target="_blank">http://consul.mydomain.com/v1/agent/members'</a>;<br/>$encyptionToken = 'xxx';</span><span id="46e8" class="ng lu in nc b gy nl ni l nj nk">$headers = array();<br/>$headers[] = 'X-Consul-Token:' . $encyptionToken;</span><span id="d764" class="ng lu in nc b gy nl ni l nj nk">$ch = curl_init();<br/>curl_setopt($ch, CURLOPT_URL, $url);<br/>curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);<br/>curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);</span><span id="59f9" class="ng lu in nc b gy nl ni l nj nk">$result = curl_exec($ch);<br/>curl_close($ch);</span><span id="31f4" class="ng lu in nc b gy nl ni l nj nk">$nodes = json_decode($result, true);</span></pre><p id="b3d2" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">输出是所有节点的数组，包括它们的名称、状态、IP 地址和更多有趣的信息。</p><h1 id="92dd" class="lt lu in bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">结论</h1><p id="7c48" class="pw-post-body-paragraph jv jw in jx b jy mr ka kb kc ms ke kf kg mt ki kj kk mu km kn ko mv kq kr ks ig bi translated">使用 Consul 进行节点发现是一个非常简单的即插即用选项。</p><p id="5462" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">请记住，这只是您可以做的很小一部分事情，但是拥有一个可用节点的列表会很有帮助，包括用任何编程语言获取这些节点的选项。</p><p id="0e78" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">把安全放在心上，你会很高兴领事在你的堆栈里！</p></div></div>    
</body>
</html>