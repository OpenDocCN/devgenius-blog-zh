<html>
<head>
<title>Develop AWS Glue ETL pipeline with Python shell</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用 Python shell 开发 AWS Glue ETL 管道</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/develop-aws-glue-etl-pipeline-with-python-shell-fe6f66763e9d?source=collection_archive---------3-----------------------#2022-06-30">https://blog.devgenius.io/develop-aws-glue-etl-pipeline-with-python-shell-fe6f66763e9d?source=collection_archive---------3-----------------------#2022-06-30</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="8bd2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">使用 AWS、Python </strong></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/62ccee5f5cef4c93b964f3fa3ec30767.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BWKEIIf3XH95hTBqYFxycw.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">AWS 用 Python 粘合 ETL</figcaption></figure><p id="595f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">AWS Glue 是来自 Amazon Web Services 的一个完全托管的 ETL 服务。它提供了各种执行 ETL 任务的环境。我们可以选择 AWS Glue Spark，也可以使用 Python Shell 作业。对于处理小型或中型数据集，最后一种类型的作业可能是更经济的选择。此外，如果你的团队精通 Python，那就不用费脑子了。</p><p id="6a85" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">Python shell 作业与 Python 版本 2 和 3 兼容，运行时预配置了最流行的版本，如 Numpy、pandas 等。在 Glue 中，我们还可以安装脚本所依赖的其他附加库。</p><p id="b6cd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">完整代码可在<a class="ae ky" href="https://github.com/hnawaz007/pythondataanalysis/tree/main/AWS%20Glue%20ETL%20Python%20Shell" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上获得。在<a class="ae ky" href="https://www.youtube.com/watch?v=nAWUGfjAIaA" rel="noopener ugc nofollow" target="_blank"> YouTube </a>上可以找到代码演练。</p><p id="63d9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">Python shell 使我们能够:</p><ul class=""><li id="64ad" class="kz la in jm b jn jo jr js jv lb jz lc kd ld kh le lf lg lh bi translated">用我们最喜欢的语言构建结构良好的 ETL 管道</li><li id="c0df" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">Python 的易用性和预构建库的强大功能</li><li id="d8bd" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">以 Python 代码形式创建和管理脚本化数据管道</li><li id="70aa" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">通过 AWS 控制台跟踪、监控和管理您的 ETL 管道</li></ul><p id="4f09" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">先决条件</strong></p><p id="c720" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">Python shell 没有什么先决条件。我们需要一个 S3 桶来存放我们的脚本。另外，我们需要在开发人员的机器上安装和配置 AWS CLI。您可以从该 URL 下载适用于您的操作系统的 AWS CLI。我会在下面的描述中留下链接。安装后，您可以使用访问密钥和秘密密钥对此进行配置。</p><p id="682e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们可以通过发出 AWS dash dash version 命令来确认 AWS CLI 是否正确安装。如果安装，这将返回 AWS CLI 版本。</p><p id="a6c6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">打造。whl 文件</strong></p><p id="317b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">第一步是生成一个 Python。包含所需库的 whl 文件。我们可以在命令行界面(CLI)创建一个。我们将创建一个名为<code class="fe ln lo lp lq b">aws_glue_python_shell</code>的目录，并在这个目录中创建一个名为<code class="fe ln lo lp lq b">setup.py</code>的文件。我们在<code class="fe ln lo lp lq b">setup.py</code>文件中有以下代码。在这个文件中，我们可以列出脚本所需的库。</p><pre class="kj kk kl km gt lr lq ls lt aw lu bi"><span id="dc37" class="lv lw in lq b gy lx ly l lz ma">from setuptools import setup</span><span id="94df" class="lv lw in lq b gy mb ly l lz ma">setup(<br/>    name="glue_python_shell_sample_module",<br/>    version="0.1",<br/>    install_requires=[<br/>  "psycopg2"<br/>    ]<br/>)</span></pre><p id="b5c6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">为了创建文件，我们在终端中输入以下代码。</p><pre class="kj kk kl km gt lr lq ls lt aw lu bi"><span id="148c" class="lv lw in lq b gy lx ly l lz ma">python setup.py bdist under wheel</span></pre><p id="4507" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">该命令将生成。whl 文件和各种文件夹。我们将关注<em class="mc"> dist </em>文件夹。这是我们将生成 ETL 脚本的地方。</p><p id="17d4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">ETL 脚本</strong></p><p id="31ff" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在<em class="mc"> dist </em>文件夹中，让我们创建名为 e <em class="mc"> tl.py </em>的 ETL 脚本。这个文件将包含 ETL 脚本。我们在顶部导入 psycopg2 库。使用 psycopg2，我们创建了一个到红移数据库的连接。</p><p id="06a8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们将使用复制命令将 S3 数据复制到红移表中。我们调用 copy 命令，然后指定表和列。在 from 子句中，我们提供了 S3 对象名。然后，我们以 IAM 角色的形式提供凭证。请确保此角色与红移群集相关联。这是一个逗号分隔的文件，我们跳过第一行。</p><p id="350d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们从连接变量创建一个游标，并执行 copy 命令。这将从 S3 物体中读取数据并存储在指定的红移表中。一旦我们执行完脚本，我们就关闭光标和连接。</p><pre class="kj kk kl km gt lr lq ls lt aw lu bi"><span id="39dd" class="lv lw in lq b gy lx ly l lz ma">#Obtaining the connection to RedShift<br/>con=psycopg2.connect(dbname= 'dev', host='redshift.amazonaws.com', port= '5439', user= 'awsuser', password= '*****')</span><span id="22fa" class="lv lw in lq b gy mb ly l lz ma">#Copy Command as Variable<br/>copy_command="""copy  src_dimproductsubcategory (productsubcategorykey ,productsubcategoryalternatekey ,englishproductsubcategoryname ,spanishproductsubcategorysame,frenchproductsubcategorysame ,productcategorykey )<br/>from 's3://your-s3-bukcet-name/public/DimProductSubcategory/DimProductSubcategory.csv' <br/>iam_role 'arn:aws:iam::8040854000:role/'<br/>DELIMITER ','<br/>IGNOREHEADER 1;"""</span><span id="cd35" class="lv lw in lq b gy mb ly l lz ma">#Opening a cursor and run copy query<br/>cur = con.cursor()<br/>cur.execute("truncate table src_dimproductsubcategory;")<br/>cur.execute(copy_command)<br/>con.commit()</span><span id="dc39" class="lv lw in lq b gy mb ly l lz ma">#Close the cursor and the connection<br/>cur.close()<br/>con.close()</span></pre><p id="d717" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">上传脚本到 S3 </strong></p><p id="df48" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们已经准备好部署我们的脚本。让我们将脚本复制到目标 S3 存储桶。我们将复制。<em class="mc"> whl </em>文件到<em class="mc"> lib </em>文件夹，<em class="mc"> etl.py </em>到 S<em class="mc">scripts</em>文件夹。在终端中，我们发出复制命令。</p><pre class="kj kk kl km gt lr lq ls lt aw lu bi"><span id="80a4" class="lv lw in lq b gy lx ly l lz ma">aws s3 cp glue_python_shell_sample_module-0.1-py3-none-any.whl s3://your-s3-bukcet-name/lib/</span></pre><p id="3ff7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们可以通过进入 s3 存储桶并刷新页面来确认。我们的文件被复制了。类似地，我们可以将 etl.py 复制到 s3 bucket 中的 Scripts 文件夹。</p><pre class="kj kk kl km gt lr lq ls lt aw lu bi"><span id="2438" class="lv lw in lq b gy lx ly l lz ma">aws s3 cp etl.py s3://your-s3-bukcet-name/scripts/</span></pre><p id="4aab" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> AWS 涂胶作业</strong></p><p id="e15e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在 AWS Glue 控制台中，我们现在可以使用我们的脚本创建一个作业。那么，让我们单击“Add Job”。为此作业提供一个名称，我们需要提供一个 IAM 角色。在“type”下，我们选择 Python shell，并将为此作业提供一个现有脚本。这里我们将选择我们的<em class="mc"> etl.py </em>文件的 S3 路径，它位于<em class="mc">脚本</em>文件夹中。</p><p id="1ab1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在安全性和配置下，我们将设置 python 库路径。再次单击文件夹图标，导航至<em class="mc"> lib </em>文件夹，并选择。<em class="mc"> whl </em>文件。让我们保住这份工作。它将调出脚本。在这里，我们可以检查一下，以确保一切正常。我将继续更新主机和密码，并提供实际的 IAM 角色的 ARN。我们的工作保住了。然而，在运行它之前，让我们确保我们试图填充的表存在于数据库中。如果没有，我们将需要创建它。</p><p id="b8a7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">回到 AWS Glue，让我们选择作业并运行它。作业正在排队。我们可以再次选择作业，UI 将显示作业状态。我们可以单击刷新图标来查看更新。根据您的数据大小，这可能需要一段时间。二十多秒后，该作业返回成功状态。</p><p id="7cf7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们可以通过跟踪作业状态旁边的日志 URL 来查看日志。为了验证数据，我们可以转到红移控制台，对表执行 select 语句。select 语句返回数据，因此我们已经在 AWS Glue 中使用 Python Shell 作业成功地将 S3 数据加载到 redshift 中。在 CloudWatch 日志中，我们可以看到我们执行了。<em class="mc"> whl </em>文件，下载<em class="mc"> psycopg2 </em>库并安装。</p><p id="f8e0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">结论</strong></p><ul class=""><li id="0418" class="kz la in jm b jn jo jr js jv lb jz lc kd ld kh le lf lg lh bi translated">我们已经使用 Python shell 成功地在 AWS Glue 中实现了 ETL。</li><li id="c7ac" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">我们展示了如何创建一个包含包依赖关系的. whl 文件。</li><li id="860b" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">我们使用 Python 和 AWS Glue 实现了 ETL(提取、转换和加载)管道。</li><li id="3468" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">完整的代码可以在<a class="ae ky" href="https://github.com/hnawaz007/pythondataanalysis/tree/main/AWS%20Glue%20ETL%20Python%20Shell" rel="noopener ugc nofollow" target="_blank">这里</a>找到</li></ul></div></div>    
</body>
</html>