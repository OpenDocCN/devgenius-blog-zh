# 声明式测试

> 原文：<https://blog.devgenius.io/testing-declaratively-2bd825503426?source=collection_archive---------5----------------------->

## 节省大脑周期，使写作测试**有趣**！

![](img/583fbdc0da0a2f40773c955dfcbdfd04.png)

照片由[罗斯·斯奈登](https://unsplash.com/@rosssneddon?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 拍摄

**TL；博士**

实现一个让你以声明方式编写测试的框架使得
编写测试变得简单、快速和有趣。开发人员讨厌写测试，不要给他们不做的借口。

如果你不确定测试代码意味着什么，或者需要快速回顾一下，那么
看看[什么是测试？](https://medium.com/@codytowstik/what-is-testing-code-56b82d329fea)

本文将涉及:

*   声明式测试意味着什么，用一些真实的例子来说明这个问题。
*   这种方法对您有何益处。
*   如何着手实现声明式测试？

我们还将借此机会讨论一些干净的代码实践，因为它与我们试图实现的目标紧密相关:编写性感、干净的测试。

如果您想跳到任何部分，或者需要稍后快速访问它们，下面是详细信息:

1.  [什么是‘声明式测试’](#0e35)
2.  [为什么这个有用？](#8b86)
3.  [一种实用的方法](#d064)
4.  [概述](#3343)

# 序💃

你刚刚发现了一个闪亮的新的开源项目，多么有趣！浏览完所有未解决的问题后，你找到了一个你想解决的问题。

在花了几个小时弄清楚了新代码库的复杂性并做了一些修改后，您就可以让您的代码接受评审了。首先，让我们围绕新特性添加一些测试。你可能应该在写代码的时候测试你的代码，但是现在*总比*永远不*好，对吗？*

所以你四处搜索，找到了相关测试的文件，然后…哦，我的天啊。这是什么？这个谜，这个令人困惑的陈述的集合体正在测试…什么？

我们以前都见过这样的试验基地。“至少，”你安慰自己，“有任何测试。”

> 几乎比没有测试更糟糕的是不知道正在测试什么，或者在哪里测试。
> 
> - [什么是测试？](https://medium.com/@codytowstik/what-is-testing-code-56b82d329fea)

## 分析

那么，这个示例实现有什么问题呢？

**字符串文字用于通过** `class` **或** `data-testid`抓取 HTML 元素

*   无论您是在创建一个新的测试还是试图理解一个现有的测试，您都需要非常熟悉项目背后的标记。你必须**交叉引用 HTML** (或者任何生成它的东西)来找出你正在交互的每个元素的`class`或者`data-testid`。你最好希望每个标识符都遵循干净代码的原则，并被恰当地命名，否则你会陷入一些困惑。
*   对于如何检索每个元素，没有一致性。有时使用类，有时使用测试 id。
*   您选择的 IDE**不能为您自动完成**标识符。你需要把`[data-testid=”note-option-favorite-button”]`的每个用法都打出来或者复制粘贴
*   长字符串弄脏了代码，使得**难以阅读**，分散了对意图的注意力。

有许多重复的代码。

*   大脑循环被浪费在重新解析每个重复的实例上，比如:

不清楚每一行是做什么的。

`cy.get(‘.note-list-each.active .note-options’).click()`是要开辟菜单吗？会不会换一个选项？

哪几组动作相关？每次想用`[data-testid=”note-option-*]`选择一个元素都需要`cy.get(‘.note-list-each.active .note-options’).click()`吗？

注释和空格在这里可能会有帮助，但它只会增加混乱，并被字符串文字的大量使用所混淆(见第 1 点)。

# 什么是“声明式测试”

> 声明式编程是指你以这样一种方式编写代码，它描述了你想要做什么，而不是你想要如何做。由编译器来决定如何实现。
> 
> - 1 800 信息，[堆栈溢出](https://stackoverflow.com/a/129639)

测试声明性地遵循相同的原则。然而，您的任务不是让编译器完成所有的工作，而是编写一个允许类似抽象的简单框架。

例如，公共代码的每个重复实例可以很容易地抽象为人类可读的、可自动完成的、经过良好测试的函数:

我们继续抽象共同的模式，直到我们几乎可以在我们的测试中建立一个叙述。

现在你可能只需要输入`clickOp`，你的 IDE 会自动完成剩下的部分。

抽象是可组合的。这使得每个用户动作成为它自己的原子抽象变得容易，并且使得编写测试就像写一本书一样。

具体细节将在稍后的 [**实用方法**](#d064) 中分析，但是请看一个已经被重构为更具声明性风格的示例测试的并排比较。

请注意，声明式方法还增加了对该特性更广泛的测试。这是因为测试更多的功能是如此有趣，如此容易，以至于很难停止编写测试。

在对“是什么”的简短分析中，一些“为什么”应该是显而易见的。
再明确一点，进一步分解收益。

# 这为什么有用？

让我们来看看声明性的测试方法如何帮助改进我们在前面的分析中发现的三个问题。

**字符串文字用于通过** `class` **或** `data-testid`抓取 HTML 元素

我们的抽象已经封装了执行每个动作的所有业务逻辑。代码可读性更好:我们不需要在每次测试中都丢弃`[data-testid=”note-option-favorite-button”]`。现在，我们不必担心在每次新提交时强制执行好的测试框架特定实践。

**有很多重复的代码。**

因为现在只有一种方法可以到达`clickNoteOptions()`，所以可以彻底测试它的单一实现。另外，如果您想找到所有使用该函数的地方，像 IntelliJ 这样的 IDE 可以帮助您通过点击一个按钮来实现。这是一个简单的方法，可以看到做类似事情的其他测试目前是如何使用这个函数的。最棒的是，我们可以轻松地重构抽象背后的代码。如果我们改变一个`data-testid`或者甚至决定一起使用一个新的测试框架，像`cy.get( ‘[data-testid=”Create new note”]’ ).click()`这样的框架特定代码只需要在它存在的地方改变。

不清楚每一行都在做什么。

代码是自文档化的，因为您已经为每个函数选择了长的描述性名称。不需要交叉引用任何`class`或`data-testid`。任何有助于阐明测试实现的注释都不会被冗长、复杂的字符串文字所占据。不要忘记在整个测试中增加逻辑间距。简而言之，我们正努力使我们的测试变得健壮，使之难以引入错误，并易于识别现有的错误。

# 实用的方法

那么，我们在多大程度上采用了 [**什么是‘声明式测试’**](#0e35)中涵盖的一般原则，并将它们综合成一种实用的方法呢？

抽象每一个小动作是不合理的，尤其是在复杂的应用程序中。另外，仅仅提取重复的代码是不够的。让我们整体看看如何保持我们的测试看起来新鲜。

这是声明性地完全重构的原始实现，分析如下。

> 简而言之，我们试图通过使引入错误变得困难，并容易识别现有错误来使我们的测试变得健壮。

## 抽象

应该在有重复代码的地方进行抽象，必要时采用枚举参数。

对于每一个原子动作，您可能希望每个动作都有一个单独的函数:

```
*navigateToAll()

navigateToFavorites()

navigateToTrash()*
```

假设您希望添加单击元素左侧或右侧的功能，那么这些功能中的每一个都可以有一个可选参数。

```
navigateToAll(‘left’)navigateToFavorites(‘right’)navigateToTrash(‘center’)
```

断言和类似的代码应该清楚它们断言的是什么，并接受一个**预期的**和**实际的**值。

```
testIDShouldContain(TestIDEnum.NOTE_OPTION_TRASH, TextEnum.MOVE_TO_TRASH)assertNoteListLengthEquals(1)
```

将所有测试使用的抽象分离到一个文件中，并考虑一种逻辑方法来组织跨较小测试子集的共享抽象。

## 列举

不可避免的是，我们不能(也不应该)回避每个测试的实现细节。

作为一种标准做法，您应该已经在一个单独的属性文件中枚举了所有程序的字符串。继续对每个`data-testid`进行同样的操作。

使用 Typescript，这可能如下所示。对于原生 javascript 实现，只需将每个属性键对存储在一个映射中。

类似于我们将代码移入方法时，将字符串移入枚举让开发人员自动完成，使得编写测试更有趣。ide 通常为未使用的属性提供语法突出显示。只要每个 DOM 元素都被一致地赋予了一个枚举的`data-testid`，那么如果有任何元素没有被使用，从而没有被测试，这将是非常明显的。

因为字符串的所有实例现在都应该被这些枚举替换，所以如果我们改变任何值，就不必进行任何搜索。方便、健壮且易于调试。

顺便说一下，在命名属性时，有一个从更广泛的描述符到更具体的描述符的命名方案会很有帮助。它很好地按字母顺序排列，并且很容易找到相关的属性。如果你只是在寻找笔记菜单选项，你可以输入`NOTE_OPTION`，期望的自动完成建议将会弹出。

## 最后一句话

你可能听说过**函数式**编程，或者在你的软件开发过程中偶然遇到过。函数式编程最吸引人的地方之一是它需要一种声明式的方法，这与我们在本文中讨论的优点是一样的。大多数现代语言都有一些标准化的“高阶函数”的实现。

你可以看到代码很容易阅读，每个人都在说同一种语言。`map`、`filter`和`reduce`的行为已被很好地记录并达成一致。

不要试图把我们在整个过程中发现的东西记成一个行项目列表。相反，考虑每条指导原则背后的目的以及每条指导原则试图解决的问题。使用这些原则不仅可以考虑测试代码，还可以考虑开发人员生活中的其他方面。

> 不要把这些指导方针视为阻碍你创造力的“规则”，要意识到其中的权衡。

# 概观

有了创建一个框架的工具，你就可以创建一个干净的、有组织的、声明性的测试系统，你的团队会‘哦！’“啊！”在他们新发现的娱乐时间。测试从未如此愉快，现在就投资吧！

*   抽象重复代码
*   枚举字符串文字
*   保持物品整洁有序

编码快乐！

更多相关阅读:

*   [什么是测试代码？](https://medium.com/@codytowstik/what-is-testing-code-56b82d329fea)——它如何让你不花钱？

谢谢，祝你愉快。💃