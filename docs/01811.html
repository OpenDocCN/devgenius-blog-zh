<html>
<head>
<title>All you need to know to get started with ETCD in kubernetes.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">所有你需要知道的开始与ETCD在库伯内特斯。</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/all-you-need-to-know-to-get-started-with-etcd-in-kubernetes-6755dbce8748?source=collection_archive---------18-----------------------#2020-07-12">https://blog.devgenius.io/all-you-need-to-know-to-get-started-with-etcd-in-kubernetes-6755dbce8748?source=collection_archive---------18-----------------------#2020-07-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="4352" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们来谈谈ETCD在《库伯内特》中的角色。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/7a0e30ee5604463e9fc2e8b089cea493.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vBSsFWYATub9i29UmeJAsg.png"/></div></div></figure><p id="28c0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">ETCD数据存储存储有关集群组件的信息，例如:</p><ul class=""><li id="470d" class="kx ky iq jp b jq jr ju jv jy kz kc la kg lb kk lc ld le lf bi translated">节点</li><li id="a502" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated">分离舱</li><li id="6357" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated">配置</li><li id="6e38" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated">秘密</li><li id="00ff" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated">帐目</li><li id="8d60" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated">角色</li><li id="8eb9" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated">粘合剂</li></ul><p id="2f70" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行“kubectl get”命令时显示的所有信息都来自ETCD服务器。您对集群所做的每一个更改，比如添加额外的节点、部署pod或副本集，都会在ETCD服务器中更新。只有当信息在ETCD服务器中更新时，更改才被视为完成。</p><p id="139d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">根据您设置集群的方式，ETCD的部署会有所不同。在本节中，我们将讨论两种类型的kubernetes部署。</p><ol class=""><li id="34c5" class="kx ky iq jp b jq jr ju jv jy kz kc la kg lb kk ll ld le lf bi translated">从头开始部署</li><li id="1b0b" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk ll ld le lf bi translated">使用kubeadm工具进行第二次部署。</li></ol><p id="ce1a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">知道这两种方法的区别是很好的。</p><p id="3a4f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您从头开始设置您的集群，那么您可以通过自己下载ETCD二进制文件、安装二进制文件并将ETCD配置为主节点中的服务来部署ETCD。</p><pre class="km kn ko kp gt lm ln lo lp aw lq bi"><span id="530d" class="lr ls iq ln b gy lt lu l lv lw">kubectl exec etcd-master -n kube-system -- sh -c "ETCDCTL_API=3 etcdctl get / --prefix --keys-only --limit=10 --cacert /etc/kubernetes/pki/etcd/ca.crt --cert /etc/kubernetes/pki/etcd/server.crt --key /etc/kubernetes/pki/etcd/server.key"</span></pre><p id="220d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">传递给服务的选项有很多。其中一些与证书有关。我们将在另一节中了解关于这些证书的更多信息。</p><p id="4936" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">其他是关于将ETCD配置为一个集群。当我们在kubernetes中设置高可用性时，我们将考虑这些选项。</p><p id="cd09" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在唯一需要注意的选项是广告的客户端url。这是ETCD监听的地址。它恰好位于服务器的IP地址和端口2379上，这是ETCD监听的默认端口。这是当kube-api服务器试图访问etcd服务器时应该在其上配置的URL。</p><p id="3d12" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您使用kubeadm设置集群，那么它会将ETCD服务器作为一个POD部署到kube-system名称空间中。您可以使用此窗格中的“etcdctl实用程序”来浏览etcd数据库。要列出kubernetes存储的所有密钥，请运行:</p><pre class="km kn ko kp gt lm ln lo lp aw lq bi"><span id="77ac" class="lr ls iq ln b gy lt lu l lv lw">kubectl exec etcd-master -n kube-system etcdctl get / --prefix -keys-only</span></pre><p id="41bb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Kubernetes将数据存储在特定的目录结构中。根目录是一个注册表，在它下面有各种各样的kubernetes结构，比如minions、nodes、pods、replicasets、deployments等等。</p><h1 id="8273" class="lx ls iq bd ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt bi translated">高可用性环境中的ETCD</h1><p id="f761" class="pw-post-body-paragraph jn jo iq jp b jq mu js jt ju mv jw jx jy mw ka kb kc mx ke kf kg my ki kj kk ij bi translated">在高可用性环境中，集群中有多个主节点，还将有多个ETCD实例分布在主节点上。</p><p id="add8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这种情况下，通过在ETCD服务配置中设置正确的参数，确保ETCD实例相互了解。</p><p id="1a96" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">初始群集选项是您必须指定ETCD服务的不同实例的地方。</p><pre class="km kn ko kp gt lm ln lo lp aw lq bi"><span id="6ed2" class="lr ls iq ln b gy lt lu l lv lw">--initial-cluster controller-0=https://${CONTROLLER0_IP}:2380,controller-1=https://${CONTROLLER1_IP}:2380 \\</span></pre><p id="02fc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将在本系列的后面更详细地讨论高可用性，但是现在这个概述应该足够了。</p><h1 id="00b8" class="lx ls iq bd ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt bi translated">有用的ETCD命令</h1><p id="01e7" class="pw-post-body-paragraph jn jo iq jp b jq mu js jt ju mv jw jx jy mw ka kb kc mx ke kf kg my ki kj kk ij bi translated">ETCDCTL是用于与ETCD交互的CLI工具。</p><p id="74dd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">ETCDCTL可以使用两个API版本(版本2和版本3)与ETCD服务器进行交互。默认情况下，它设置为使用版本2。每个版本都有不同的命令集。</p><p id="d91b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">ETCDCTL V2支持以下命令:</p><pre class="km kn ko kp gt lm ln lo lp aw lq bi"><span id="1f03" class="lr ls iq ln b gy lt lu l lv lw">etcdctl backup etcdctl cluster-health etcdctl mk etcdctl mkdir etcdctl set</span></pre><p id="15d7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另一方面，V3中的命令有所不同:</p><pre class="km kn ko kp gt lm ln lo lp aw lq bi"><span id="c200" class="lr ls iq ln b gy lt lu l lv lw">etcdctl snapshot save etcdctl endpoint health etcdctl get etcdctl put</span></pre><p id="9de8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要设置API的版本，请将环境变量ETCDCTL_API设置为:</p><pre class="km kn ko kp gt lm ln lo lp aw lq bi"><span id="17f5" class="lr ls iq ln b gy lt lu l lv lw">export ETCDCTL_API=3</span></pre><p id="f356" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">除此之外，您还必须指定证书文件的路径，以便ETCDCTL可以对ETCD API服务器进行身份验证。证书文件可在etcd-master的以下路径中找到。我们将在安全性一节中讨论更多关于证书的内容。因此，如果这看起来很复杂，也不用担心:</p><pre class="km kn ko kp gt lm ln lo lp aw lq bi"><span id="4b99" class="lr ls iq ln b gy lt lu l lv lw">--cacert /etc/kubernetes/pki/etcd/ca.crt --cert /etc/kubernetes/pki/etcd/server.crt --key /etc/kubernetes/pki/etcd/server.key</span></pre></div><div class="ab cl mz na hu nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="ij ik il im in"><p id="28b3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="ng">最初发布于</em><a class="ae nh" href="https://static-blog-gamma.vercel.app/posts/kubernetes/core-concepts/etcd-pt-2" rel="noopener ugc nofollow" target="_blank">https://static-blog-gamma . vercel . app/posts/kubernetes/core-concepts/etcd-pt-2</a></p></div></div>    
</body>
</html>