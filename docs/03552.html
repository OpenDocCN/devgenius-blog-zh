<html>
<head>
<title>How it optimize the disk usage in the Prometheus database?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">它是如何优化Prometheus数据库中的磁盘使用的？</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/how-it-optimize-the-disk-usage-in-the-prometheus-database-ef8151d201db?source=collection_archive---------0-----------------------#2020-11-17">https://blog.devgenius.io/how-it-optimize-the-disk-usage-in-the-prometheus-database-ef8151d201db?source=collection_archive---------0-----------------------#2020-11-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="93bd" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">了解一些技巧来分析和优化TSDB的使用情况，并节省云部署的资金。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/a9613e22aaf56ee29a6d58e3a4d308ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*wWFIlrq8NBUxxX8g"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">马库斯·斯皮斯克在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="3211" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在以前的帖子中，我们讨论了存储层如何为Prometheus工作，以及它有多有效。但在当前时代，我们是云计算的一员，我们知道每项技术优化也是成本优化，这就是为什么我们需要非常谨慎地对待我们使用的任何优化选项。</p><p id="3afc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们知道，通常当我们使用Prometheus进行监控时，我们有如此多的出口商可供我们使用，而且每个出口商都暴露了许多非常相关的指标，我们需要这些指标来跟踪我们需要的一切。但是，我们也应该意识到，还有一些我们目前不需要或者不打算使用的指标。那么，如果我们不打算使用，为什么我们要浪费磁盘空间来存储它们呢？</p><p id="848f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">那么，让我们开始看看我们系统中的一个出口商。在我的例子中，我想使用一个BusinessWorks容器应用程序，它公开了关于其利用率的指标。如果您检查他们的指标端点，您会看到类似这样的内容:</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="8cd0" class="lx ly iq lt b gy lz ma l mb mc"># HELP jvm_info JVM version info<br/># TYPE jvm_info gauge<br/>jvm_info{version="1.8.0_221-b27",vendor="Oracle Corporation",runtime="Java(TM) SE Runtime Environment",} 1.0<br/># HELP jvm_memory_bytes_used Used bytes of a given JVM memory area.<br/># TYPE jvm_memory_bytes_used gauge<br/>jvm_memory_bytes_used{area="heap",} 1.0318492E8<br/>jvm_memory_bytes_used{area="nonheap",} 1.52094712E8<br/># HELP jvm_memory_bytes_committed Committed (bytes) of a given JVM memory area.<br/># TYPE jvm_memory_bytes_committed gauge<br/>jvm_memory_bytes_committed{area="heap",} 1.35266304E8<br/>jvm_memory_bytes_committed{area="nonheap",} 1.71302912E8<br/># HELP jvm_memory_bytes_max Max (bytes) of a given JVM memory area.<br/># TYPE jvm_memory_bytes_max gauge<br/>jvm_memory_bytes_max{area="heap",} 1.073741824E9<br/>jvm_memory_bytes_max{area="nonheap",} -1.0<br/># HELP jvm_memory_bytes_init Initial bytes of a given JVM memory area.<br/># TYPE jvm_memory_bytes_init gauge<br/>jvm_memory_bytes_init{area="heap",} 1.34217728E8<br/>jvm_memory_bytes_init{area="nonheap",} 2555904.0<br/># HELP jvm_memory_pool_bytes_used Used bytes of a given JVM memory pool.<br/># TYPE jvm_memory_pool_bytes_used gauge<br/>jvm_memory_pool_bytes_used{pool="Code Cache",} 3.3337536E7<br/>jvm_memory_pool_bytes_used{pool="Metaspace",} 1.04914136E8<br/>jvm_memory_pool_bytes_used{pool="Compressed Class Space",} 1.384304E7<br/>jvm_memory_pool_bytes_used{pool="G1 Eden Space",} 3.3554432E7<br/>jvm_memory_pool_bytes_used{pool="G1 Survivor Space",} 1048576.0<br/>jvm_memory_pool_bytes_used{pool="G1 Old Gen",} 6.8581912E7<br/># HELP jvm_memory_pool_bytes_committed Committed bytes of a given JVM memory pool.<br/># TYPE jvm_memory_pool_bytes_committed gauge<br/>jvm_memory_pool_bytes_committed{pool="Code Cache",} 3.3619968E7<br/>jvm_memory_pool_bytes_committed{pool="Metaspace",} 1.19697408E8<br/>jvm_memory_pool_bytes_committed{pool="Compressed Class Space",} 1.7985536E7<br/>jvm_memory_pool_bytes_committed{pool="G1 Eden Space",} 4.6137344E7<br/>jvm_memory_pool_bytes_committed{pool="G1 Survivor Space",} 1048576.0<br/>jvm_memory_pool_bytes_committed{pool="G1 Old Gen",} 8.8080384E7<br/># HELP jvm_memory_pool_bytes_max Max bytes of a given JVM memory pool.<br/># TYPE jvm_memory_pool_bytes_max gauge<br/>jvm_memory_pool_bytes_max{pool="Code Cache",} 2.5165824E8<br/>jvm_memory_pool_bytes_max{pool="Metaspace",} -1.0<br/>jvm_memory_pool_bytes_max{pool="Compressed Class Space",} 1.073741824E9<br/>jvm_memory_pool_bytes_max{pool="G1 Eden Space",} -1.0<br/>jvm_memory_pool_bytes_max{pool="G1 Survivor Space",} -1.0<br/>jvm_memory_pool_bytes_max{pool="G1 Old Gen",} 1.073741824E9<br/># HELP jvm_memory_pool_bytes_init Initial bytes of a given JVM memory pool.<br/># TYPE jvm_memory_pool_bytes_init gauge<br/>jvm_memory_pool_bytes_init{pool="Code Cache",} 2555904.0<br/>jvm_memory_pool_bytes_init{pool="Metaspace",} 0.0<br/>jvm_memory_pool_bytes_init{pool="Compressed Class Space",} 0.0<br/>jvm_memory_pool_bytes_init{pool="G1 Eden Space",} 7340032.0<br/>jvm_memory_pool_bytes_init{pool="G1 Survivor Space",} 0.0<br/>jvm_memory_pool_bytes_init{pool="G1 Old Gen",} 1.26877696E8<br/># HELP jvm_buffer_pool_used_bytes Used bytes of a given JVM buffer pool.<br/># TYPE jvm_buffer_pool_used_bytes gauge<br/>jvm_buffer_pool_used_bytes{pool="direct",} 148590.0<br/>jvm_buffer_pool_used_bytes{pool="mapped",} 0.0<br/># HELP jvm_buffer_pool_capacity_bytes Bytes capacity of a given JVM buffer pool.<br/># TYPE jvm_buffer_pool_capacity_bytes gauge<br/>jvm_buffer_pool_capacity_bytes{pool="direct",} 148590.0<br/>jvm_buffer_pool_capacity_bytes{pool="mapped",} 0.0<br/># HELP jvm_buffer_pool_used_buffers Used buffers of a given JVM buffer pool.<br/># TYPE jvm_buffer_pool_used_buffers gauge<br/>jvm_buffer_pool_used_buffers{pool="direct",} 19.0<br/>jvm_buffer_pool_used_buffers{pool="mapped",} 0.0<br/># HELP jvm_classes_loaded The number of classes that are currently loaded in the JVM<br/># TYPE jvm_classes_loaded gauge<br/>jvm_classes_loaded 16993.0<br/># HELP jvm_classes_loaded_total The total number of classes that have been loaded since the JVM has started execution<br/># TYPE jvm_classes_loaded_total counter<br/>jvm_classes_loaded_total 17041.0<br/># HELP jvm_classes_unloaded_total The total number of classes that have been unloaded since the JVM has started execution<br/># TYPE jvm_classes_unloaded_total counter<br/>jvm_classes_unloaded_total 48.0<br/># HELP bwce_activity_stats_list BWCE Activity Statictics list<br/># TYPE bwce_activity_stats_list gauge<br/># HELP bwce_activity_counter_list BWCE Activity related Counters list<br/># TYPE bwce_activity_counter_list gauge<br/># HELP all_activity_events_count BWCE All Activity Events count by State<br/># TYPE all_activity_events_count counter<br/>all_activity_events_count{StateName="CANCELLED",} 0.0<br/>all_activity_events_count{StateName="COMPLETED",} 0.0<br/>all_activity_events_count{StateName="STARTED",} 0.0<br/>all_activity_events_count{StateName="FAULTED",} 0.0<br/># HELP activity_events_count BWCE All Activity Events count by Process, Activity State<br/># TYPE activity_events_count counter<br/># HELP activity_total_evaltime_count BWCE Activity EvalTime  by Process and Activity <br/># TYPE activity_total_evaltime_count counter<br/># HELP activity_total_duration_count BWCE Activity DurationTime by Process and Activity <br/># TYPE activity_total_duration_count counter<br/># HELP bwpartner_instance:total_request Total Request for the partner invocation which mapped from the activities<br/># TYPE bwpartner_instance:total_request counter<br/># HELP bwpartner_instance:total_duration_ms Total Duration for the partner invocation which mapped from the activities (execution or latency) <br/># TYPE bwpartner_instance:total_duration_ms counter<br/># HELP bwce_process_stats BWCE Process Statistics list<br/># TYPE bwce_process_stats gauge<br/># HELP bwce_process_counter_list BWCE Process related Counters list<br/># TYPE bwce_process_counter_list gauge<br/># HELP all_process_events_count BWCE All Process Events count by State<br/># TYPE all_process_events_count counter<br/>all_process_events_count{StateName="CANCELLED",} 0.0<br/>all_process_events_count{StateName="COMPLETED",} 0.0<br/>all_process_events_count{StateName="STARTED",} 0.0<br/>all_process_events_count{StateName="FAULTED",} 0.0<br/># HELP process_events_count BWCE Process Events count by Operation<br/># TYPE process_events_count counter<br/># HELP process_duration_seconds_total BWCE Process Events duration by Operation in seconds<br/># TYPE process_duration_seconds_total counter<br/># HELP process_duration_milliseconds_total BWCE Process Events duration by Operation in milliseconds<br/># TYPE process_duration_milliseconds_total counter<br/># HELP bwdefinitions:partner BWCE Process Events count by Operation<br/># TYPE bwdefinitions:partner counter<br/>bwdefinitions:partner{ProcessName="t1.module.item.getTransactionData",ActivityName="FTLPublisher",ServiceName="GetCustomer360",OperationName="GetDataOperation",PartnerService="TransactionService",PartnerOperation="GetTransactionsOperation",Location="internal",PartnerMiddleware="MW",} 1.0<br/>bwdefinitions:partner{ProcessName=" t1.module.item.auditProcess",ActivityName="KafkaSendMessage",ServiceName="GetCustomer360",OperationName="GetDataOperation",PartnerService="AuditService",PartnerOperation="AuditOperation",Location="internal",PartnerMiddleware="MW",} 1.0<br/>bwdefinitions:partner{ProcessName="t1.module.item.getCustomerData",ActivityName="JMSRequestReply",ServiceName="GetCustomer360",OperationName="GetDataOperation",PartnerService="CustomerService",PartnerOperation="GetCustomerDetailsOperation",Location="internal",PartnerMiddleware="MW",} 1.0<br/># HELP bwdefinitions:binding BW Design Time Repository - binding/transport definition<br/># TYPE bwdefinitions:binding counter<br/>bwdefinitions:binding{ServiceName="GetCustomer360",OperationName="GetDataOperation",ServiceInterface="GetCustomer360:GetDataOperation",Binding="/customer",Transport="HTTP",} 1.0<br/># HELP bwdefinitions:service BW Design Time Repository - Service definition<br/># TYPE bwdefinitions:service counter<br/>bwdefinitions:service{ProcessName="t1.module.sub.item.getCustomerData",ServiceName="GetCustomer360",OperationName="GetDataOperation",ServiceInstance="GetCustomer360:GetDataOperation",} 1.0<br/>bwdefinitions:service{ProcessName="t1.module.sub.item.auditProcess",ServiceName="GetCustomer360",OperationName="GetDataOperation",ServiceInstance="GetCustomer360:GetDataOperation",} 1.0<br/>bwdefinitions:service{ProcessName="t1.module.sub.orchestratorSubFlow",ServiceName="GetCustomer360",OperationName="GetDataOperation",ServiceInstance="GetCustomer360:GetDataOperation",} 1.0<br/>bwdefinitions:service{ProcessName="t1.module.Process",ServiceName="GetCustomer360",OperationName="GetDataOperation",ServiceInstance="GetCustomer360:GetDataOperation",} 1.0<br/># HELP bwdefinitions:gateway BW Design Time Repository - Gateway definition<br/># TYPE bwdefinitions:gateway counter<br/>bwdefinitions:gateway{ServiceName="GetCustomer360",OperationName="GetDataOperation",ServiceInstance="GetCustomer360:GetDataOperation",Endpoint="bwce-demo-mon-orchestrator-bwce",InteractionType="ISTIO",} 1.0<br/># HELP process_cpu_seconds_total Total user and system CPU time spent in seconds.<br/># TYPE process_cpu_seconds_total counter<br/>process_cpu_seconds_total 1956.86<br/># HELP process_start_time_seconds Start time of the process since unix epoch in seconds.<br/># TYPE process_start_time_seconds gauge<br/>process_start_time_seconds 1.604712447107E9<br/># HELP process_open_fds Number of open file descriptors.<br/># TYPE process_open_fds gauge<br/>process_open_fds 763.0<br/># HELP process_max_fds Maximum number of open file descriptors.<br/># TYPE process_max_fds gauge<br/>process_max_fds 1048576.0<br/># HELP process_virtual_memory_bytes Virtual memory size in bytes.<br/># TYPE process_virtual_memory_bytes gauge<br/>process_virtual_memory_bytes 3.046207488E9<br/># HELP process_resident_memory_bytes Resident memory size in bytes.<br/># TYPE process_resident_memory_bytes gauge<br/>process_resident_memory_bytes 4.2151936E8<br/># HELP jvm_gc_collection_seconds Time spent in a given JVM garbage collector in seconds.<br/># TYPE jvm_gc_collection_seconds summary<br/>jvm_gc_collection_seconds_count{gc="G1 Young Generation",} 540.0<br/>jvm_gc_collection_seconds_sum{gc="G1 Young Generation",} 4.754<br/>jvm_gc_collection_seconds_count{gc="G1 Old Generation",} 2.0<br/>jvm_gc_collection_seconds_sum{gc="G1 Old Generation",} 0.563<br/># HELP jvm_threads_current Current thread count of a JVM<br/># TYPE jvm_threads_current gauge<br/>jvm_threads_current 98.0<br/># HELP jvm_threads_daemon Daemon thread count of a JVM<br/># TYPE jvm_threads_daemon gauge<br/>jvm_threads_daemon 43.0<br/># HELP jvm_threads_peak Peak thread count of a JVM<br/># TYPE jvm_threads_peak gauge<br/>jvm_threads_peak 98.0<br/># HELP jvm_threads_started_total Started thread count of a JVM<br/># TYPE jvm_threads_started_total counter<br/>jvm_threads_started_total 109.0<br/># HELP jvm_threads_deadlocked Cycles of JVM-threads that are in deadlock waiting to acquire object monitors or ownable synchronizers<br/># TYPE jvm_threads_deadlocked gauge<br/>jvm_threads_deadlocked 0.0<br/># HELP jvm_threads_deadlocked_monitor Cycles of JVM-threads that are in deadlock waiting to acquire object monitors<br/># TYPE jvm_threads_deadlocked_monitor gauge<br/>jvm_threads_deadlocked_monitor 0.0</span></pre><p id="bd98" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可以看到许多指标，但老实说，我并没有在我的控制面板中使用其中的大部分来生成我的警报。我可以使用关于每个BusinessWorks进程及其活动的应用程序性能的指标，也可以使用JVM内存性能和线程数量，但像JVM GC如何为JVM的每一层工作(G1年轻一代，G1老一代)之类的东西，我根本不会使用它们。</p><p id="79a1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因此，如果我显示相同的指标端点，突出显示我没有使用的东西，它将是这样的:</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="890d" class="lx ly iq lt b gy lz ma l mb mc"><strong class="lt ir"><em class="md"># HELP jvm_info JVM version info<br/># TYPE jvm_info gauge<br/>jvm_info{version="1.8.0_221-b27",vendor="Oracle Corporation",runtime="Java(TM) SE Runtime Environment",} 1.0</em></strong><br/># HELP jvm_memory_bytes_used Used bytes of a given JVM memory area.<br/># TYPE jvm_memory_bytes_used gauge<br/>jvm_memory_bytes_used{area="heap",} 1.0318492E8<br/>jvm_memory_bytes_used{area="nonheap",} 1.52094712E8<br/># HELP jvm_memory_bytes_committed Committed (bytes) of a given JVM memory area.<br/># TYPE jvm_memory_bytes_committed gauge<br/>jvm_memory_bytes_committed{area="heap",} 1.35266304E8<br/>jvm_memory_bytes_committed{area="nonheap",} 1.71302912E8<br/># HELP jvm_memory_bytes_max Max (bytes) of a given JVM memory area.<br/># TYPE jvm_memory_bytes_max gauge<br/>jvm_memory_bytes_max{area="heap",} 1.073741824E9<br/>jvm_memory_bytes_max{area="nonheap",} -1.0<br/><strong class="lt ir"><em class="md"># HELP jvm_memory_bytes_init Initial bytes of a given JVM memory area.<br/># TYPE jvm_memory_bytes_init gauge<br/>jvm_memory_bytes_init{area="heap",} 1.34217728E8<br/>jvm_memory_bytes_init{area="nonheap",} 2555904.0</em></strong><br/><strong class="lt ir"><em class="md"># HELP jvm_memory_pool_bytes_used Used bytes of a given JVM memory pool.<br/># TYPE jvm_memory_pool_bytes_used gauge<br/>jvm_memory_pool_bytes_used{pool="Code Cache",} 3.3337536E7<br/>jvm_memory_pool_bytes_used{pool="Metaspace",} 1.04914136E8<br/>jvm_memory_pool_bytes_used{pool="Compressed Class Space",} 1.384304E7<br/>jvm_memory_pool_bytes_used{pool="G1 Eden Space",} 3.3554432E7<br/>jvm_memory_pool_bytes_used{pool="G1 Survivor Space",} 1048576.0<br/>jvm_memory_pool_bytes_used{pool="G1 Old Gen",} 6.8581912E7<br/># HELP jvm_memory_pool_bytes_committed Committed bytes of a given JVM memory pool.<br/># TYPE jvm_memory_pool_bytes_committed gauge<br/>jvm_memory_pool_bytes_committed{pool="Code Cache",} 3.3619968E7<br/>jvm_memory_pool_bytes_committed{pool="Metaspace",} 1.19697408E8<br/>jvm_memory_pool_bytes_committed{pool="Compressed Class Space",} 1.7985536E7<br/>jvm_memory_pool_bytes_committed{pool="G1 Eden Space",} 4.6137344E7<br/>jvm_memory_pool_bytes_committed{pool="G1 Survivor Space",} 1048576.0<br/>jvm_memory_pool_bytes_committed{pool="G1 Old Gen",} 8.8080384E7<br/># HELP jvm_memory_pool_bytes_max Max bytes of a given JVM memory pool.<br/># TYPE jvm_memory_pool_bytes_max gauge<br/>jvm_memory_pool_bytes_max{pool="Code Cache",} 2.5165824E8<br/>jvm_memory_pool_bytes_max{pool="Metaspace",} -1.0<br/>jvm_memory_pool_bytes_max{pool="Compressed Class Space",} 1.073741824E9<br/>jvm_memory_pool_bytes_max{pool="G1 Eden Space",} -1.0<br/>jvm_memory_pool_bytes_max{pool="G1 Survivor Space",} -1.0<br/>jvm_memory_pool_bytes_max{pool="G1 Old Gen",} 1.073741824E9<br/># HELP jvm_memory_pool_bytes_init Initial bytes of a given JVM memory pool.<br/># TYPE jvm_memory_pool_bytes_init gauge<br/>jvm_memory_pool_bytes_init{pool="Code Cache",} 2555904.0<br/>jvm_memory_pool_bytes_init{pool="Metaspace",} 0.0<br/>jvm_memory_pool_bytes_init{pool="Compressed Class Space",} 0.0<br/>jvm_memory_pool_bytes_init{pool="G1 Eden Space",} 7340032.0<br/>jvm_memory_pool_bytes_init{pool="G1 Survivor Space",} 0.0<br/>jvm_memory_pool_bytes_init{pool="G1 Old Gen",} 1.26877696E8<br/># HELP jvm_buffer_pool_used_bytes Used bytes of a given JVM buffer pool.<br/># TYPE jvm_buffer_pool_used_bytes gauge<br/>jvm_buffer_pool_used_bytes{pool="direct",} 148590.0<br/>jvm_buffer_pool_used_bytes{pool="mapped",} 0.0<br/># HELP jvm_buffer_pool_capacity_bytes Bytes capacity of a given JVM buffer pool.<br/># TYPE jvm_buffer_pool_capacity_bytes gauge<br/>jvm_buffer_pool_capacity_bytes{pool="direct",} 148590.0<br/>jvm_buffer_pool_capacity_bytes{pool="mapped",} 0.0<br/># HELP jvm_buffer_pool_used_buffers Used buffers of a given JVM buffer pool.<br/># TYPE jvm_buffer_pool_used_buffers gauge<br/>jvm_buffer_pool_used_buffers{pool="direct",} 19.0<br/>jvm_buffer_pool_used_buffers{pool="mapped",} 0.0<br/># HELP jvm_classes_loaded The number of classes that are currently loaded in the JVM<br/># TYPE jvm_classes_loaded gauge<br/>jvm_classes_loaded 16993.0<br/># HELP jvm_classes_loaded_total The total number of classes that have been loaded since the JVM has started execution<br/># TYPE jvm_classes_loaded_total counter<br/>jvm_classes_loaded_total 17041.0<br/># HELP jvm_classes_unloaded_total The total number of classes that have been unloaded since the JVM has started execution<br/># TYPE jvm_classes_unloaded_total counter<br/>jvm_classes_unloaded_total 48.0</em></strong><br/># HELP bwce_activity_stats_list BWCE Activity Statictics list<br/># TYPE bwce_activity_stats_list gauge<br/># HELP bwce_activity_counter_list BWCE Activity related Counters list<br/># TYPE bwce_activity_counter_list gauge<br/># HELP all_activity_events_count BWCE All Activity Events count by State<br/># TYPE all_activity_events_count counter<br/>all_activity_events_count{StateName="CANCELLED",} 0.0<br/>all_activity_events_count{StateName="COMPLETED",} 0.0<br/>all_activity_events_count{StateName="STARTED",} 0.0<br/>all_activity_events_count{StateName="FAULTED",} 0.0<br/># HELP activity_events_count BWCE All Activity Events count by Process, Activity State<br/># TYPE activity_events_count counter<br/># HELP activity_total_evaltime_count BWCE Activity EvalTime  by Process and Activity <br/># TYPE activity_total_evaltime_count counter<br/># HELP activity_total_duration_count BWCE Activity DurationTime by Process and Activity <br/># TYPE activity_total_duration_count counter<br/># HELP bwpartner_instance:total_request Total Request for the partner invocation which mapped from the activities<br/># TYPE bwpartner_instance:total_request counter<br/># HELP bwpartner_instance:total_duration_ms Total Duration for the partner invocation which mapped from the activities (execution or latency) <br/># TYPE bwpartner_instance:total_duration_ms counter<br/># HELP bwce_process_stats BWCE Process Statistics list<br/># TYPE bwce_process_stats gauge<br/># HELP bwce_process_counter_list BWCE Process related Counters list<br/># TYPE bwce_process_counter_list gauge<br/># HELP all_process_events_count BWCE All Process Events count by State<br/># TYPE all_process_events_count counter<br/>all_process_events_count{StateName="CANCELLED",} 0.0<br/>all_process_events_count{StateName="COMPLETED",} 0.0<br/>all_process_events_count{StateName="STARTED",} 0.0<br/>all_process_events_count{StateName="FAULTED",} 0.0<br/># HELP process_events_count BWCE Process Events count by Operation<br/># TYPE process_events_count counter<br/># HELP process_duration_seconds_total BWCE Process Events duration by Operation in seconds<br/># TYPE process_duration_seconds_total counter<br/># HELP process_duration_milliseconds_total BWCE Process Events duration by Operation in milliseconds<br/># TYPE process_duration_milliseconds_total counter<br/># HELP bwdefinitions:partner BWCE Process Events count by Operation<br/># TYPE bwdefinitions:partner counter<br/>bwdefinitions:partner{ProcessName="t1.module.item.getTransactionData",ActivityName="FTLPublisher",ServiceName="GetCustomer360",OperationName="GetDataOperation",PartnerService="TransactionService",PartnerOperation="GetTransactionsOperation",Location="internal",PartnerMiddleware="MW",} 1.0<br/>bwdefinitions:partner{ProcessName=" t1.module.item.auditProcess",ActivityName="KafkaSendMessage",ServiceName="GetCustomer360",OperationName="GetDataOperation",PartnerService="AuditService",PartnerOperation="AuditOperation",Location="internal",PartnerMiddleware="MW",} 1.0<br/>bwdefinitions:partner{ProcessName="t1.module.item.getCustomerData",ActivityName="JMSRequestReply",ServiceName="GetCustomer360",OperationName="GetDataOperation",PartnerService="CustomerService",PartnerOperation="GetCustomerDetailsOperation",Location="internal",PartnerMiddleware="MW",} 1.0<br/># HELP bwdefinitions:binding BW Design Time Repository - binding/transport definition<br/># TYPE bwdefinitions:binding counter<br/>bwdefinitions:binding{ServiceName="GetCustomer360",OperationName="GetDataOperation",ServiceInterface="GetCustomer360:GetDataOperation",Binding="/customer",Transport="HTTP",} 1.0<br/># HELP bwdefinitions:service BW Design Time Repository - Service definition<br/># TYPE bwdefinitions:service counter<br/>bwdefinitions:service{ProcessName="t1.module.sub.item.getCustomerData",ServiceName="GetCustomer360",OperationName="GetDataOperation",ServiceInstance="GetCustomer360:GetDataOperation",} 1.0<br/>bwdefinitions:service{ProcessName="t1.module.sub.item.auditProcess",ServiceName="GetCustomer360",OperationName="GetDataOperation",ServiceInstance="GetCustomer360:GetDataOperation",} 1.0<br/>bwdefinitions:service{ProcessName="t1.module.sub.orchestratorSubFlow",ServiceName="GetCustomer360",OperationName="GetDataOperation",ServiceInstance="GetCustomer360:GetDataOperation",} 1.0<br/>bwdefinitions:service{ProcessName="t1.module.Process",ServiceName="GetCustomer360",OperationName="GetDataOperation",ServiceInstance="GetCustomer360:GetDataOperation",} 1.0<br/># HELP bwdefinitions:gateway BW Design Time Repository - Gateway definition<br/># TYPE bwdefinitions:gateway counter<br/>bwdefinitions:gateway{ServiceName="GetCustomer360",OperationName="GetDataOperation",ServiceInstance="GetCustomer360:GetDataOperation",Endpoint="bwce-demo-mon-orchestrator-bwce",InteractionType="ISTIO",} 1.0<br/># HELP process_cpu_seconds_total Total user and system CPU time spent in seconds.<br/># TYPE process_cpu_seconds_total counter<br/>process_cpu_seconds_total 1956.86<br/># HELP process_start_time_seconds Start time of the process since unix epoch in seconds.<br/># TYPE process_start_time_seconds gauge<br/>process_start_time_seconds 1.604712447107E9<br/># HELP process_open_fds Number of open file descriptors.<br/># TYPE process_open_fds gauge<br/>process_open_fds 763.0<br/># HELP process_max_fds Maximum number of open file descriptors.<br/># TYPE process_max_fds gauge<br/>process_max_fds 1048576.0<br/># HELP process_virtual_memory_bytes Virtual memory size in bytes.<br/># TYPE process_virtual_memory_bytes gauge<br/>process_virtual_memory_bytes 3.046207488E9<br/># HELP process_resident_memory_bytes Resident memory size in bytes.<br/># TYPE process_resident_memory_bytes gauge<br/>process_resident_memory_bytes 4.2151936E8<br/><strong class="lt ir"><em class="md"># HELP jvm_gc_collection_seconds Time spent in a given JVM garbage collector in seconds.<br/># TYPE jvm_gc_collection_seconds summary<br/>jvm_gc_collection_seconds_count{gc="G1 Young Generation",} 540.0<br/>jvm_gc_collection_seconds_sum{gc="G1 Young Generation",} 4.754<br/>jvm_gc_collection_seconds_count{gc="G1 Old Generation",} 2.0<br/>jvm_gc_collection_seconds_sum{gc="G1 Old Generation",} 0.563</em></strong><br/># HELP jvm_threads_current Current thread count of a JVM<br/># TYPE jvm_threads_current gauge<br/>jvm_threads_current 98.0<br/># HELP jvm_threads_daemon Daemon thread count of a JVM<br/># TYPE jvm_threads_daemon gauge<br/>jvm_threads_daemon 43.0<br/># HELP jvm_threads_peak Peak thread count of a JVM<br/># TYPE jvm_threads_peak gauge<br/>jvm_threads_peak 98.0<br/><strong class="lt ir"><em class="md"># HELP jvm_threads_started_total Started thread count of a JVM<br/># TYPE jvm_threads_started_total counter<br/>jvm_threads_started_total 109.0<br/># HELP jvm_threads_deadlocked Cycles of JVM-threads that are in deadlock waiting to acquire object monitors or ownable synchronizers<br/># TYPE jvm_threads_deadlocked gauge<br/>jvm_threads_deadlocked 0.0<br/># HELP jvm_threads_deadlocked_monitor Cycles of JVM-threads that are in deadlock waiting to acquire object monitors<br/># TYPE jvm_threads_deadlocked_monitor gauge<br/>jvm_threads_deadlocked_monitor 0.0</em></strong></span></pre><p id="6f94" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因此，它可能是50%的指标端点响应，这是我没有使用的部分，那么，为什么我要使用我花钱购买的磁盘空间来存储它呢？这只是针对一个“关键出口商”，我试图使用尽可能多的信息，但想想你有多少出口商，你为他们每个人使用多少信息。</p><p id="160f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">好了，现在这篇文章的目的和动机很清楚了，但是我们能做些什么呢？</p><h1 id="3de9" class="me ly iq bd mf mg mh mi mj mk ml mm mn jw mo jx mp jz mq ka mr kc ms kd mt mu bi translated">发现REST API</h1><p id="516e" class="pw-post-body-paragraph kw kx iq ky b kz mv jr lb lc mw ju le lf mx lh li lj my ll lm ln mz lp lq lr ij bi translated">Prometheus有一个很棒的REST API，可以公开你想要的所有信息。如果你曾经使用过Prometheus的图形界面(如下所示),你正在使用REST API，因为这是它背后的原因。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi na"><img src="../Images/5421e214c26e37f5e4bcf953b76d92cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aN1wocYkT5lqsdv9yTu4xg.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">普罗米修斯图形界面的目标视图</figcaption></figure><p id="cfc2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们在Prometheus官方文档中有关于REST API的所有文档:</p><div class="nb nc gp gr nd ne"><a href="https://prometheus.io/docs/prometheus/latest/querying/api/" rel="noopener  ugc nofollow" target="_blank"><div class="nf ab fo"><div class="ng ab nh cl cj ni"><h2 class="bd ir gy z fp nj fr fs nk fu fw ip bi translated">HTTP API</h2><div class="nl l"><h3 class="bd b gy z fp nj fr fs nk fu fw dk translated">当前稳定的HTTP API可以在Prometheus服务器上的/api/v1下访问。任何不间断的添加都将被添加…</h3></div><div class="nm l"><p class="bd b dl z fp nj fr fs nk fu fw dk translated">普罗米修斯</p></div></div></div></a></div><p id="229c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">但是根据普罗米修斯使用的时间序列数据库TSDB，这个API给我们提供了什么呢？</p><h1 id="98ae" class="me ly iq bd mf mg mh mi mj mk ml mm mn jw mo jx mp jz mq ka mr kc ms kd mt mu bi translated">TSDB管理API</h1><p id="7063" class="pw-post-body-paragraph kw kx iq ky b kz mv jr lb lc mw ju le lf mx lh li lj my ll lm ln mz lp lq lr ij bi translated">我们有一个特定的API来管理TSDB数据库的性能，但是为了能够使用它，我们需要启用Admin API。这是通过在我们启动Prometheus服务器的地方提供以下标志来完成的<code class="fe nn no np lt b">--web.enable-admin-api.</code></p><p id="60f8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果我们使用Prometheus操作员舵图来部署它，我们需要在我们的values.yaml中使用以下项目</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="e242" class="lx ly iq lt b gy lz ma l mb mc">## EnableAdminAPI enables Prometheus the administrative HTTP API which includes functionality such as deleting time series.    <br/>## This is disabled by default.    <br/>## ref: https://prometheus.io/docs/prometheus/latest/querying/api/#tsdb-admin-apis    <br/>##    enableAdminAPI: true</span></pre><p id="1198" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当我们启用这个管理API时，我们有很多选项可以启用，但是今天我们将重点关注一个REST操作，即“stats”。这是与TSDB相关的唯一一个不需要启用管理API的方法。正如我们在Prometheus文档中所看到的，该操作返回以下项目:</p><p id="ae3e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> headStats </strong>:这提供了关于TSDB的垫块的以下数据:</p><ul class=""><li id="64ba" class="nq nr iq ky b kz la lc ld lf ns lj nt ln nu lr nv nw nx ny bi translated"><strong class="ky ir"> numSeries </strong>:级数。</li><li id="b4df" class="nq nr iq ky b kz nz lc oa lf ob lj oc ln od lr nv nw nx ny bi translated"><strong class="ky ir"> chunkCount </strong>:组块数量。</li><li id="82c6" class="nq nr iq ky b kz nz lc oa lf ob lj oc ln od lr nv nw nx ny bi translated"><strong class="ky ir"> minTime </strong>:当前最小时间戳，以毫秒为单位。</li><li id="a710" class="nq nr iq ky b kz nz lc oa lf ob lj oc ln od lr nv nw nx ny bi translated"><strong class="ky ir"> maxTime </strong>:当前最大时间戳，单位为毫秒。</li></ul><p id="5863" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">seriesCountByMetricName:</strong>这将提供指标名称及其系列计数的列表。</p><p id="653f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">labelValueCountByLabelName:</strong>这将提供标签名称及其值计数的列表。</p><p id="820e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">memoryInBytesByLabelName</strong>这将提供标签名称和所用内存(以字节为单位)的列表。通过将给定标签名称的所有值的长度相加来计算内存使用量。</p><p id="78fd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> seriesCountByLabelPair </strong>这将提供标签值对及其系列计数的列表。</p><p id="10f7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要访问该API，我们需要访问以下端点:</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="d222" class="lx ly iq lt b gy lz ma l mb mc">GET /api/v1/status/tsdb</span></pre><p id="b152" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因此，当我在我的普罗米修斯部署中这样做时，我得到了类似这样的内容:</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="bf9f" class="lx ly iq lt b gy lz ma l mb mc">{<br/>   "status":"success",<br/>   "data":{<br/>      "seriesCountByMetricName":[<br/>         {<br/>            "name":"apiserver_request_duration_seconds_bucket",<br/>            "value":34884<br/>         },<br/>         {<br/>            "name":"apiserver_request_latencies_bucket",<br/>            "value":7344<br/>         },<br/>         {<br/>            "name":"etcd_request_duration_seconds_bucket",<br/>            "value":6000<br/>         },<br/>         {<br/>            "name":"apiserver_response_sizes_bucket",<br/>            "value":3888<br/>         },<br/>         {<br/>            "name":"apiserver_request_latencies_summary",<br/>            "value":2754<br/>         },<br/>         {<br/>            "name":"etcd_request_latencies_summary",<br/>            "value":1500<br/>         },<br/>         {<br/>            "name":"apiserver_request_count",<br/>            "value":1216<br/>         },<br/>         {<br/>            "name":"apiserver_request_total",<br/>            "value":1216<br/>         },<br/>         {<br/>            "name":"container_tasks_state",<br/>            "value":1140<br/>         },<br/>         {<br/>            "name":"apiserver_request_latencies_count",<br/>            "value":918<br/>         }<br/>      ],<br/>      "labelValueCountByLabelName":[<br/>         {<br/>            "name":"__name__",<br/>            "value":2374<br/>         },<br/>         {<br/>            "name":"id",<br/>            "value":210<br/>         },<br/>         {<br/>            "name":"mountpoint",<br/>            "value":208<br/>         },<br/>         {<br/>            "name":"le",<br/>            "value":195<br/>         },<br/>         {<br/>            "name":"type",<br/>            "value":185<br/>         },<br/>         {<br/>            "name":"name",<br/>            "value":181<br/>         },<br/>         {<br/>            "name":"resource",<br/>            "value":170<br/>         },<br/>         {<br/>            "name":"secret",<br/>            "value":168<br/>         },<br/>         {<br/>            "name":"image",<br/>            "value":107<br/>         },<br/>         {<br/>            "name":"container_id",<br/>            "value":97<br/>         }<br/>      ],<br/>      "memoryInBytesByLabelName":[<br/>         {<br/>            "name":"__name__",<br/>            "value":97729<br/>         },<br/>         {<br/>            "name":"id",<br/>            "value":21450<br/>         },<br/>         {<br/>            "name":"mountpoint",<br/>            "value":18123<br/>         },<br/>         {<br/>            "name":"name",<br/>            "value":13831<br/>         },<br/>         {<br/>            "name":"image",<br/>            "value":8005<br/>         },<br/>         {<br/>            "name":"container_id",<br/>            "value":7081<br/>         },<br/>         {<br/>            "name":"image_id",<br/>            "value":6872<br/>         },<br/>         {<br/>            "name":"secret",<br/>            "value":5054<br/>         },<br/>         {<br/>            "name":"type",<br/>            "value":4613<br/>         },<br/>         {<br/>            "name":"resource",<br/>            "value":3459<br/>         }<br/>      ],<br/>      "seriesCountByLabelValuePair":[<br/>         {<br/>            "name":"namespace=default",<br/>            "value":72064<br/>         },<br/>         {<br/>            "name":"service=kubernetes",<br/>            "value":70921<br/>         },<br/>         {<br/>            "name":"endpoint=https",<br/>            "value":70917<br/>         },<br/>         {<br/>            "name":"job=apiserver",<br/>            "value":70917<br/>         },<br/>         {<br/>            "name":"component=apiserver",<br/>            "value":57992<br/>         },<br/>         {<br/>            "name":"instance=192.168.185.199:443",<br/>            "value":40343<br/>         },<br/>         {<br/>            "name":"__name__=apiserver_request_duration_seconds_bucket",<br/>            "value":34884<br/>         },<br/>         {<br/>            "name":"version=v1",<br/>            "value":31152<br/>         },<br/>         {<br/>            "name":"instance=192.168.112.31:443",<br/>            "value":30574<br/>         },<br/>         {<br/>            "name":"scope=cluster",<br/>            "value":29713<br/>         }<br/>      ]<br/>   }<br/>}</span></pre><p id="f73b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果我们在以下端点上使用新的和实验性的React用户界面，我们也可以检查相同的信息:</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="c4ca" class="lx ly iq lt b gy lz ma l mb mc">/new/tsdb-status</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi na"><img src="../Images/c6bf7d3ee5c0ea4271b042337a4d4fb1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IFumBAKX7bRbOeCrNnOPPA.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">在新的Prometheus UI中，按指标名称显示前10个系列计数的可视化图形</figcaption></figure><p id="c497" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这样，你将得到你的时间序列数据库中的前10个序列和标签，如果其中一些没有用，你可以用正常的方法去掉它们。这很好，但是如果这里显示的都是相关的，我们能做些什么呢？</p><p id="1719" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Mmmm，也许我们可以用PromQL来监控这个(dogfodding方法)。因此，如果我们希望提取相同的信息，但使用PromQL，我们可以使用以下查询:</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="1c06" class="lx ly iq lt b gy lz ma l mb mc">topk(10, count by (__name__)({__name__=~".+"}))</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi na"><img src="../Images/584892d41edc48bc16fe37258a2a643d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WEhwUdxvVhHav782qbrTmA.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">生成并存储在时间序列数据库中的前10个指标序列</figcaption></figure><p id="53b6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在我掌握了所有的权力。例如，让我们看看不是10个更相关的，而是100个更相关的或我们需要应用的任何其他过滤器。例如，让我们看看我们在开始时讨论的关于JVM的指标。我们将通过下面的PromQL查询来实现这一点:</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="b4da" class="lx ly iq lt b gy lz ma l mb mc">topk(100, count by (__name__)({__name__=~"jvm.+"}))</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi na"><img src="../Images/4586ee98eac4945b7d663718f1b9db09.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uvTH7JXSX2keTT7Jp_b2PA.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">关于JVM指标的指标系列前100名</figcaption></figure><p id="0e89" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因此，我们可以看到，至少有150个系列的指标我根本没有使用。但让我们做得更好，让我们来看一看相同但按工作名称分组的情况:</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="6daa" class="lx ly iq lt b gy lz ma l mb mc">topk(10, count by (job,__name__)({__name__=~".+"}))</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi na"><img src="../Images/fa05a4bbe402d8c03bb9aecede31bf83.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EDJ9Gn_p_ISb1RAC92nttQ.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">使用生成前10个指标系列计数的作业检查这些计数的结果</figcaption></figure></div></div>    
</body>
</html>