<html>
<head>
<title>Secure AKS Ingress with LetsEncrypt</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 LetsEncrypt 保护 AKS 入口</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/secure-aks-ingress-with-letsencrypt-f56f698ec6b5?source=collection_archive---------2-----------------------#2022-03-03">https://blog.devgenius.io/secure-aks-ingress-with-letsencrypt-f56f698ec6b5?source=collection_archive---------2-----------------------#2022-03-03</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/a242aeeb24aa987d36f295f8d7999db6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mHFCEK29ee-74Y4ZXyxSvw.png"/></div></div></figure><p id="c067" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">本文展示了如何在 Azure Kubernetes 服务(AKS)集群中部署 NGINX 入口控制器。入口控制器在 Azure 标准负载平衡器上配置有静态公共 IP 地址。cert-manager 项目用于自动生成和配置 Let's Encrypt 证书。自定义域将与证书集成，以公开运行应用程序。</p><h1 id="900e" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">要执行的步骤:</h1><ul class=""><li id="5548" class="lr ls in jx b jy lt kc lu kg lv kk lw ko lx ks ly lz ma mb bi translated">为入口控制器创建一个名称空间 ingress-basic，其中将创建所有与入口控制器相关的资源。</li><li id="d4c4" class="lr ls in jx b jy mc kc md kg me kk mf ko mg ks ly lz ma mb bi translated">为自定义域创建 DNS 区域和别名记录。</li><li id="e39b" class="lr ls in jx b jy mc kc md kg me kk mf ko mg ks ly lz ma mb bi translated">使用 Helm 在 ingress-basic 命名空间中安装 SSL 证书的 cert-manager。</li><li id="ed82" class="lr ls in jx b jy mc kc md kg me kk mf ko mg ks ly lz ma mb bi translated">创建用于颁发证书的 CA 群集颁发者。</li><li id="8c25" class="lr ls in jx b jy mc kc md kg me kk mf ko mg ks ly lz ma mb bi translated">创建第一个应用和服务。</li><li id="213a" class="lr ls in jx b jy mc kc md kg me kk mf ko mg ks ly lz ma mb bi translated">创建第二个应用和服务。</li><li id="d673" class="lr ls in jx b jy mc kc md kg me kk mf ko mg ks ly lz ma mb bi translated">创建入口路由，以配置将流量路由到两个应用程序之一的规则。</li><li id="5112" class="lr ls in jx b jy mc kc md kg me kk mf ko mg ks ly lz ma mb bi translated">验证自动创建的证书。</li><li id="035c" class="lr ls in jx b jy mc kc md kg me kk mf ko mg ks ly lz ma mb bi translated">使用自定义域测试应用程序。</li></ul><h1 id="47e1" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">创建入口控制器</h1><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="2cd8" class="mq ku in mm b gy mr ms l mt mu"># Create a namespace for ingress resources<br/>kubectl create namespace ingress-basic<br/><br/># Add the Helm repository<br/>helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx<br/>helm repo update<br/><br/># Use Helm to deploy an NGINX ingress controller<br/>helm install ingress-nginx ingress-nginx/ingress-nginx \<br/>    --namespace ingress-basic \<br/>    --set controller.replicaCount=2</span></pre><h1 id="9f31" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">创建 DNS 区域和记录</h1><p id="b50e" class="pw-post-body-paragraph jv jw in jx b jy lt ka kb kc lu ke kf kg mv ki kj kk mw km kn ko mx kq kr ks ig bi translated">自定义域的记录将是入口控制器的公共 IP。</p><figure class="mh mi mj mk gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi my"><img src="../Images/70b8badbafe8b30bc0cdd672cd60a6a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E3eFBh2yOQlrMMprxqZ1LQ.png"/></div></div></figure><h1 id="73b4" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">安装证书管理器</h1><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="7940" class="mq ku in mm b gy mr ms l mt mu"># Label the cert-manager namespace to disable resource validation<br/>kubectl label namespace ingress-basic cert-manager.io/disable-validation=true</span><span id="c5d5" class="mq ku in mm b gy mz ms l mt mu"># Add the Jetstack Helm repository<br/>helm repo add jetstack https://charts.jetstack.io</span><span id="75e0" class="mq ku in mm b gy mz ms l mt mu"># Update your local Helm chart repository cache<br/>helm repo update</span><span id="f49a" class="mq ku in mm b gy mz ms l mt mu"># Install CRDs with kubectl<br/>kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.7.1/cert-manager.crds.yaml</span><span id="e3e4" class="mq ku in mm b gy mz ms l mt mu"># Install the cert-manager Helm chart<br/>helm install cert-manager jetstack/cert-manager \<br/>  --namespace ingress-basic \<br/>  --version v1.7.1</span></pre><h1 id="4fc1" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">创建 CA 群集颁发者</h1><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="3353" class="mq ku in mm b gy mr ms l mt mu">apiVersion: cert-manager.io/v1<br/>kind: ClusterIssuer<br/>metadata:<br/>  name: letsencrypt<br/>spec:<br/>  acme:<br/>    server: https://acme-v02.api.letsencrypt.org/directory<br/>    email: shailender.choudhary@gmail.com<br/>    privateKeySecretRef:<br/>      name: letsencrypt<br/>    solvers:<br/>    - http01:<br/>        ingress:<br/>          class: nginx<br/>          podTemplate:<br/>            spec:<br/>              nodeSelector:<br/>                "kubernetes.io/os": linux</span></pre><p id="e7c4" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">要创建发行者，请使用 kubectl 命令。</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="6df7" class="mq ku in mm b gy mr ms l mt mu">kubectl apply -f cluster-issuer.yaml --namespace ingress-basic</span></pre><h1 id="d50d" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">运行演示应用程序</h1><p id="a4d5" class="pw-post-body-paragraph jv jw in jx b jy lt ka kb kc lu ke kf kg mv ki kj kk mw km kn ko mx kq kr ks ig bi translated">创建一个<em class="na"> aks-helloworld-one.yaml </em>文件，并在以下示例中复制 yaml:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="6560" class="mq ku in mm b gy mr ms l mt mu">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: aks-helloworld-one<br/>spec:<br/>  replicas: 1<br/>  selector:<br/>    matchLabels:<br/>      app: aks-helloworld-one<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: aks-helloworld-one<br/>    spec:<br/>      containers:<br/>      - name: aks-helloworld-one<br/>        image: mcr.microsoft.com/azuredocs/aks-helloworld:v1<br/>        ports:<br/>        - containerPort: 80<br/>        env:<br/>        - name: TITLE<br/>          value: "Welcome to Azure Kubernetes Service (AKS)"<br/>---<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: aks-helloworld-one<br/>spec:<br/>  type: ClusterIP<br/>  ports:<br/>  - port: 80<br/>  selector:<br/>    app: aks-helloworld-one</span></pre><p id="a522" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">创建一个<em class="na"> aks-helloworld-two.yaml </em>文件，并在以下示例中复制 yaml:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="e2d5" class="mq ku in mm b gy mr ms l mt mu">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: aks-helloworld-two<br/>spec:<br/>  replicas: 1<br/>  selector:<br/>    matchLabels:<br/>      app: aks-helloworld-two<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: aks-helloworld-two<br/>    spec:<br/>      containers:<br/>      - name: aks-helloworld-two<br/>        image: mcr.microsoft.com/azuredocs/aks-helloworld:v1<br/>        ports:<br/>        - containerPort: 80<br/>        env:<br/>        - name: TITLE<br/>          value: "AKS Ingress Demo"<br/>---<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: aks-helloworld-two<br/>spec:<br/>  type: ClusterIP<br/>  ports:<br/>  - port: 80<br/>  selector:<br/>    app: aks-helloworld-two</span></pre><p id="4d0d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">使用 kubectl 运行两个演示应用程序:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="c641" class="mq ku in mm b gy mr ms l mt mu">kubectl apply -f aks-helloworld-one.yaml --namespace ingress-basic<br/>kubectl apply -f aks-helloworld-two.yaml --namespace ingress-basic</span></pre><h1 id="b337" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">创建入口路由</h1><p id="ebbe" class="pw-post-body-paragraph jv jw in jx b jy lt ka kb kc lu ke kf kg mv ki kj kk mw km kn ko mx kq kr ks ig bi translated">入口资源配置将流量路由到两个应用之一的规则。</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="2cd2" class="mq ku in mm b gy mr ms l mt mu">apiVersion: networking.k8s.io/v1<br/>kind: Ingress<br/>metadata:<br/>  name: hello-world-ingress<br/>  annotations:<br/>    kubernetes.io/ingress.class: nginx<br/>    cert-manager.io/cluster-issuer: letsencrypt<br/>    nginx.ingress.kubernetes.io/rewrite-target: /$1<br/>    nginx.ingress.kubernetes.io/use-regex: "true"<br/>spec:<br/>  tls:<br/>  - hosts:<br/>    - mydevsecops.com<br/>    secretName: tls-secret<br/>  rules:<br/>  - host: mydevsecops.com<br/>    http:<br/>      paths:<br/>      - path: /hello-world-one(/|$)(.*)<br/>        pathType: Prefix<br/>        backend:<br/>          service:<br/>            name: aks-helloworld-one<br/>            port:<br/>              number: 80<br/>      - path: /hello-world-two(/|$)(.*)<br/>        pathType: Prefix<br/>        backend:<br/>          service:<br/>            name: aks-helloworld-two<br/>            port:<br/>              number: 80<br/>      - path: /(.*)<br/>        pathType: Prefix<br/>        backend:<br/>          service:<br/>            name: aks-helloworld-one<br/>            port:<br/>              number: 80</span></pre><p id="c15a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">使用 kubectl 创建入口资源:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="bc01" class="mq ku in mm b gy mr ms l mt mu">kubectl apply -f hello-world-ingress.yaml --namespace ingress-basic</span></pre><h1 id="32fc" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">验证证书</h1><p id="153e" class="pw-post-body-paragraph jv jw in jx b jy lt ka kb kc lu ke kf kg mv ki kj kk mw km kn ko mx kq kr ks ig bi translated">要验证证书是否创建成功，请使用<code class="fe nb nc nd mm b">kubectl describe certificate tls-secret --namespace ingress-basic</code>命令。</p><h1 id="a75b" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">测试入口配置</h1><p id="f4d1" class="pw-post-body-paragraph jv jw in jx b jy lt ka kb kc lu ke kf kg mv ki kj kk mw km kn ko mx kq kr ks ig bi translated">打开网络浏览器，打开 Kubernetes 入口控制器的 FQDN，例如<code class="fe nb nc nd mm b"><a class="ae ne" href="https://demo-aks-ingress.eastus.cloudapp.azure.com." rel="noopener ugc nofollow" target="_blank"><em class="na">https://</em></a>mydevsecops.com/hello-world-one </code>和<code class="fe nb nc nd mm b"><a class="ae ne" href="https://demo-aks-ingress.eastus.cloudapp.azure.com." rel="noopener ugc nofollow" target="_blank"><em class="na">https://</em></a>mydevsecops.com/hello-world-two</code></p><p id="35a1" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在，应用程序使用 TLS 证书进行保护，并且可以使用自定义域进行访问。应用程序也使用入口控制器获得基于主机的路由。</p></div></div>    
</body>
</html>