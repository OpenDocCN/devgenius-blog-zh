<html>
<head>
<title>How to create a Date Dimension using Databricks?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用数据块创建日期维度？</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/how-to-create-a-date-dimension-using-databricks-4867858eb20f?source=collection_archive---------6-----------------------#2022-12-25">https://blog.devgenius.io/how-to-create-a-date-dimension-using-databricks-4867858eb20f?source=collection_archive---------6-----------------------#2022-12-25</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="e9b5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在创建数据湖解决方案时，考虑数据模型的所有对应表是很重要的，无论我们是采用星型模式还是雪花模式，其中一个需要的重要维度是日期维度。</p><p id="f438" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">本文将展示如何在 Databricks 中使用 Spark Scala 构建日期维度表的扩展版本。</p><ul class=""><li id="0002" class="ki kj in jm b jn jo jr js jv kk jz kl kd km kh kn ko kp kq bi translated">登录社区数据库:<a class="ae kr" href="https://community.cloud.databricks.com/" rel="noopener ugc nofollow" target="_blank">https://community.cloud.databricks.com/</a></li><li id="a90e" class="ki kj in jm b jn ks jr kt jv ku jz kv kd kw kh kn ko kp kq bi translated">通过点击左侧面板上<strong class="jm io">计算</strong>选项中的<strong class="jm io">创建集群</strong>选项来创建集群。</li></ul><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="gh gi kx"><img src="../Images/2b107662fbc5254bd429b2262fa51036.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h2m6V11p9r9Nu3tY8g6MBQ.png"/></div></div></figure></div><div class="ab cl lj lk hr ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="ig ih ii ij ik"><figure class="ky kz la lb gt lc"><div class="bz fp l di"><div class="lq lr l"/></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">最终样本数据</figcaption></figure><ul class=""><li id="90f1" class="ki kj in jm b jn jo jr js jv kk jz kl kd km kh kn ko kp kq bi translated">下一步是为日期维度列创建基本模板。为此，我们要创建一个 scala case 类，你可以在同一个主笔记本中创建它，也可以作为一个单独的笔记本。<a class="ae kr" href="https://tinyurl.com/dim-date" rel="noopener ugc nofollow" target="_blank">https://tinyurl.com/dim-date</a></li></ul><pre class="ky kz la lb gt lw lx ly bn lz ma bi"><span id="4324" class="mb mc in lx b be md me l mf mg">case class dim_date_schema(<br/>                       date_key: Int,<br/>                       date: String,<br/>                       day: Int,<br/>                       day_suffix: String,<br/>                       week_day: Int,<br/>                       week_day_name: String,<br/>                       week_day_name_short: String,<br/>                       week_day_name_first_letter: String,<br/>                       day_of_year: Int,<br/>                       week_of_month: Int,<br/>                       week_of_year: Int,<br/>                       month: Int,<br/>                       month_name: String,<br/>                       month_name_short: String,<br/>                       month_name_first_letter: String,<br/>                       quarter: Int,<br/>                       quarter_name: String,<br/>                       year: Int,<br/>                       yyyymm: String,<br/>                       month_year: String,<br/>                       is_weekend: Int,<br/>                       is_holiday: Int,<br/>                       first_date_of_year: String,<br/>                       last_date_of_year: String,<br/>                       first_date_of_quarter: String,<br/>                       last_date_of_quarter: String,<br/>                       first_date_of_month: String,<br/>                       last_date_of_month: String,<br/>                       first_date_of_week: String,<br/>                       last_date_of_week: String,<br/>                       last_12_month_flag: Int,<br/>                       last_6_month_flag: Int,<br/>                       last_month_flag: Int<br/>                     )</span></pre><ul class=""><li id="f8d9" class="ki kj in jm b jn jo jr js jv kk jz kl kd km kh kn ko kp kq bi translated">一旦我们为表格准备好了模板，我们将开始编写逻辑来填充各个列。为此，我们将创建一个 utils 对象<a class="ae kr" href="https://tinyurl.com/date-time-utils" rel="noopener ugc nofollow" target="_blank">https://tinyurl.com/date-time-utils</a></li></ul><pre class="ky kz la lb gt lw lx ly bn lz ma bi"><span id="5a41" class="mb mc in lx b be md me l mf mg">import java.time.LocalDate<br/>import java.time.format.DateTimeFormatter<br/>import scala.collection.mutable.ListBuffer<br/><br/>object date_time_utils {<br/>  val default_format = "yyyy-MM-dd"<br/><br/>  def check(start_date: String, end_date: String): Boolean = {<br/>    val start = LocalDate.parse(start_date, DateTimeFormatter.ofPattern(default_format))<br/>    val end = LocalDate.parse(end_date, DateTimeFormatter.ofPattern(default_format))<br/>    end.isAfter(start)<br/>  }<br/><br/><br/>  def convert_string_to_date(current_date: String, input_format: String, output_format: String) = {<br/>    val input_formatter = DateTimeFormatter.ofPattern(input_format)<br/>    val output_formatter = DateTimeFormatter.ofPattern(output_format)<br/>    output_formatter.format(input_formatter.parse(current_date))<br/>  }<br/><br/>  def get_day_suffix(current_date: String) = {<br/>    val day = convert_string_to_date(current_date, default_format, "d").toInt<br/>    day match {<br/>      case 1 =&gt; "st"<br/>      case 21 =&gt; "st"<br/>      case 31 =&gt; "st"<br/>      case 2 =&gt; "nd"<br/>      case 22 =&gt; "nd"<br/>      case 3 =&gt; "rd"<br/>      case 23 =&gt; "rd"<br/>      case _ =&gt; "th"<br/>    }<br/>  }<br/><br/>  def get_quater_name(current_date: String) = {<br/>    val quater = convert_string_to_date(current_date, default_format, "Q").toInt<br/>    quater match {<br/>      case 1 =&gt; "Q1"<br/>      case 2 =&gt; "Q2"<br/>      case 3 =&gt; "Q3"<br/>      case 4 =&gt; "Q4"<br/>    }<br/>  }<br/><br/>  def is_weekend(current_date: String) = {<br/>    val week_day_name = convert_string_to_date(current_date, default_format, "EEEE")<br/>    week_day_name match {<br/>      case "Saturday" =&gt; 1<br/>      case "Sunday" =&gt; 1<br/>      case _ =&gt; 0<br/>    }<br/>  }<br/><br/>  def get_date_of_year(current_date: String, position: String) = {<br/>    val year = convert_string_to_date(current_date, default_format, "u")<br/>    position match {<br/>      case "first" =&gt; year + "-01-01"<br/>      case "last" =&gt; year + "-12-31"<br/>    }<br/>  }<br/><br/>  def get_first_date_of_quarter(current_date: String) = {<br/>    val quater = convert_string_to_date(current_date, default_format, "QQ")<br/>    val year = convert_string_to_date(current_date, default_format, "u")<br/>    quater match {<br/>      case "01" =&gt; year + "-01-01"<br/>      case "02" =&gt; year + "-04-01"<br/>      case "03" =&gt; year + "-07-01"<br/>      case "04" =&gt; year + "-10-01"<br/>    }<br/>  }<br/><br/>  def get_last_date_of_quarter(current_date: String) = {<br/>    val quater = convert_string_to_date(current_date, default_format, "QQ")<br/>    val year = convert_string_to_date(current_date, default_format, "u")<br/>    quater match {<br/>      case "01" =&gt; year + "-03-31"<br/>      case "02" =&gt; year + "-06-30"<br/>      case "03" =&gt; year + "-09-30"<br/>      case "04" =&gt; year + "-12-31"<br/>    }<br/>  }<br/><br/>  def get_first_date_of_month(current_date: String) = {<br/>    val month = convert_string_to_date(current_date, default_format, "MM")<br/>    val year = convert_string_to_date(current_date, default_format, "u")<br/>    year + "-" + month + "-01"<br/>  }<br/><br/>  def get_last_date_of_month(current_date: String) = {<br/>    val converted_date = LocalDate.parse(current_date, DateTimeFormatter.ofPattern(default_format))<br/>    val last_day_of_month = converted_date.withDayOfMonth(converted_date.getMonth.length(converted_date.isLeapYear))<br/>    last_day_of_month.toString<br/>  }<br/><br/>  def get_first_date_of_week(current_date: String) = {<br/>    val converted_date = LocalDate.parse(current_date, DateTimeFormatter.ofPattern(default_format))<br/>    val day_backward = convert_string_to_date(current_date, default_format, "e").toInt - 1<br/>    converted_date.minusDays(day_backward).toString<br/>  }<br/><br/>  def get_last_date_of_week(current_date: String) = {<br/>    val converted_date = LocalDate.parse(current_date, DateTimeFormatter.ofPattern(default_format))<br/>    val day_forward = 7 - convert_string_to_date(current_date, default_format, "e").toInt<br/>    converted_date.plusDays(day_forward).toString<br/>  }<br/>  <br/>  def get_last_12_month_list() = {<br/>    var last_12_month_list = ListBuffer[String]()<br/>    var i = 0<br/>    for( i &lt;- 1 to 12){<br/>      last_12_month_list += DateTimeFormatter.ofPattern("yyyyMM").format(LocalDate.now.minusMonths(i))<br/>    }<br/>    last_12_month_list<br/>  }<br/>  <br/>  <br/>  def get_last_12_month_flag(yyyyMM: String) = {<br/>    if (get_last_12_month_list().contains(yyyyMM)) 1 else 0<br/>  }<br/>  <br/>  def get_last_6_month_flag(yyyyMM: String) = {    <br/>    if (get_last_12_month_list().slice(0,6).contains(yyyyMM)) 1 else 0<br/>  }<br/>  <br/>  def get_last_month_flag(yyyyMM: String) = {<br/>    if (get_last_12_month_list()(0).equals(yyyyMM)) 1 else 0<br/>  }<br/>  <br/>  def get_calendar_end_date(plus_month:Int) = {<br/>    get_last_date_of_month(DateTimeFormatter.ofPattern("yyyy-MM-dd").format(LocalDate.now.plusMonths(plus_month)))<br/>  }<br/>}</span></pre><ul class=""><li id="6cc9" class="ki kj in jm b jn jo jr js jv kk jz kl kd km kh kn ko kp kq bi translated">现在，当我们定义了为日期维度生成行的所有基本函数后，我们将创建 dim 日期生成器记事本<a class="ae kr" href="https://tinyurl.com/dim-date-generator" rel="noopener ugc nofollow" target="_blank">https://tinyurl.com/dim-date-generator</a></li></ul><pre class="ky kz la lb gt lw lx ly bn lz ma bi"><span id="ea47" class="mb mc in lx b be md me l mf mg">def dim_date_generator(current_date: String): dim_date_schema ={<br/>  val default_format = "yyyy-MM-dd"<br/>  val date_key = date_time_utils.convert_string_to_date(current_date, default_format, "yyyyMMdd").toInt<br/>  val date = current_date<br/>  val day = date_time_utils.convert_string_to_date(current_date, default_format, "d").toInt<br/>  val day_suffix = date_time_utils.get_day_suffix(current_date)<br/>  val week_day = date_time_utils.convert_string_to_date(current_date, default_format, "e").toInt<br/>  val week_day_name = date_time_utils.convert_string_to_date(current_date, default_format, "EEEE")<br/>  val week_day_name_short = date_time_utils.convert_string_to_date(current_date, default_format, "E").toUpperCase<br/>  val week_day_name_first_letter = date_time_utils.convert_string_to_date(current_date, default_format, "E").substring(0, 1)<br/>  val day_of_year = date_time_utils.convert_string_to_date(current_date, default_format, "D").toInt<br/>  val week_of_month = date_time_utils.convert_string_to_date(current_date, default_format, "W").toInt<br/>  val week_of_year = date_time_utils.convert_string_to_date(current_date, default_format, "w").toInt<br/>  val month = date_time_utils.convert_string_to_date(current_date, default_format, "M").toInt<br/>  val month_name = date_time_utils.convert_string_to_date(current_date, default_format, "MMMM")<br/>  val month_name_short = date_time_utils.convert_string_to_date(current_date, default_format, "MMM").toUpperCase<br/>  val month_name_first_letter = date_time_utils.convert_string_to_date(current_date, default_format, "MMM").substring(0, 1)<br/>  val quarter = date_time_utils.convert_string_to_date(current_date, default_format, "Q").toInt<br/>  val quarter_name = date_time_utils.get_quater_name(current_date)<br/>  val year = date_time_utils.convert_string_to_date(current_date, default_format, "u").toInt<br/>  val yyyyMM = date_time_utils.convert_string_to_date(current_date, default_format, "yyyyMM")<br/>  val month_year = date_time_utils.convert_string_to_date(current_date, default_format, "yyyy MMM").toUpperCase<br/>  val is_weekend = date_time_utils.is_weekend(current_date)<br/>  val is_holiday = 0<br/>  val first_date_of_year = date_time_utils.get_date_of_year(current_date, "first")<br/>  val last_date_of_year = date_time_utils.get_date_of_year(current_date, "last")<br/>  val first_date_of_quarter = date_time_utils.get_first_date_of_quarter(current_date)<br/>  val last_date_of_quarter = date_time_utils.get_last_date_of_quarter(current_date)<br/>  val first_date_of_month = date_time_utils.get_first_date_of_month(current_date)<br/>  val last_date_of_month = date_time_utils.get_last_date_of_month(current_date)<br/>  val first_date_of_week = date_time_utils.get_first_date_of_week(current_date)<br/>  val last_date_of_week = date_time_utils.get_last_date_of_week(current_date)<br/>  val last_12_month_flag = date_time_utils.get_last_12_month_flag(yyyyMM)<br/>  val last_6_month_flag = date_time_utils.get_last_6_month_flag(yyyyMM)<br/>  val last_month_flag = date_time_utils.get_last_month_flag(yyyyMM)<br/>  dim_date_schema(date_key, date, day, day_suffix, week_day, week_day_name, week_day_name_short, week_day_name_first_letter,<br/>    day_of_year, week_of_month, week_of_year, month, month_name, month_name_short, month_name_first_letter, quarter,<br/>    quarter_name, year, yyyyMM, month_year, is_weekend, is_holiday, first_date_of_year, last_date_of_year, first_date_of_quarter,<br/>    last_date_of_quarter, first_date_of_month, last_date_of_month, first_date_of_week, last_date_of_week, last_12_month_flag, last_6_month_flag, last_month_flag)<br/>}</span></pre><ul class=""><li id="4ee9" class="ki kj in jm b jn jo jr js jv kk jz kl kd km kh kn ko kp kq bi translated">最后一步是创建最终笔记本，我们将从“2017–01–01”开始我们的维度开始日期，直到当前年份+ 5，<a class="ae kr" href="https://tinyurl.com/dim-date-t" rel="noopener ugc nofollow" target="_blank">https://tinyurl.com/dim-date-t</a></li></ul><pre class="ky kz la lb gt lw lx ly bn lz ma bi"><span id="9ad4" class="mb mc in lx b be md me l mf mg">import org.apache.spark.sql.functions._<br/>import org.apache.spark.sql.DataFrame<br/><br/>def create_final_df(): DataFrame = {<br/><br/>  //Start Date<br/>  var start_date = "2017-01-01"<br/><br/>  //End Date<br/>  val end_date = date_time_utils.get_calendar_end_date(60)<br/><br/>  //Mutable list to store dim date<br/>  var dim_date_mutable_list = new ListBuffer[dim_date_schema]()<br/><br/>  while (date_time_utils.check(start_date, end_date)) {<br/>    val dim_date_schema_object = dim_date_generator(start_date)<br/>    dim_date_mutable_list += dim_date_schema_object<br/>    start_date = LocalDate.parse(start_date, DateTimeFormatter.ofPattern("yyyy-MM-dd")).plusDays(1).toString<br/>  }<br/><br/>  val dim_date_list = dim_date_mutable_list.toList<br/>  val dim_date_df = spark.createDataset(dim_date_list)<br/>  dim_date_df.select(col("date_key")<br/>    , col("date").cast("date")<br/>    , col("day")<br/>    , col("day_suffix")<br/>    , col("week_day")<br/>    , col("week_day_name")<br/>    , col("week_day_name_short")<br/>    , col("week_day_name_first_letter")<br/>    , col("day_of_year")<br/>    , col("week_of_month")<br/>    , col("week_of_year")<br/>    , col("month")<br/>    , col("month_name")<br/>    , col("month_name_short")<br/>    , col("month_name_first_letter")<br/>    , col("quarter")<br/>    , col("quarter_name")<br/>    , col("year")<br/>    , col("yyyymm")<br/>    , col("month_year")<br/>    , col("is_weekend")<br/>    , col("is_holiday")<br/>    , col("first_date_of_year").cast("date")<br/>    , col("last_date_of_year").cast("date")<br/>    , col("first_date_of_quarter").cast("date")<br/>    , col("last_date_of_quarter").cast("date")<br/>    , col("first_date_of_month").cast("date")<br/>    , col("last_date_of_month").cast("date")<br/>    , col("first_date_of_week").cast("date")<br/>    , col("last_date_of_week").cast("date")<br/>    , col("last_12_month_flag")<br/>    , col("last_6_month_flag")<br/>    , col("last_month_flag")<br/>    , current_timestamp().as("load_date"))<br/>}</span></pre><ul class=""><li id="6b96" class="ki kj in jm b jn jo jr js jv kk jz kl kd km kh kn ko kp kq bi translated">你可以从 git 库<a class="ae kr" href="https://github.com/aakashjainiitg/date-dimension" rel="noopener ugc nofollow" target="_blank">https://github.com/aakashjainiitg/date-dimension</a>下载整套笔记本</li></ul><p id="c1be" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">为了在基于 PowerBI、Tableau 或 QlikView 构建的前端仪表板上创建过滤器，创建日期维度对于数据分析解决方案非常重要。</p></div></div>    
</body>
</html>