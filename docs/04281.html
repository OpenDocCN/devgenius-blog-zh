<html>
<head>
<title>Server-Side Development with Fastify — Async and Await and Route Prefixes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Fastify 进行服务器端开发——异步、等待和路由前缀</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/server-side-development-with-fastify-async-and-await-and-route-prefixes-d5704eb5206?source=collection_archive---------2-----------------------#2021-02-20">https://blog.devgenius.io/server-side-development-with-fastify-async-and-await-and-route-prefixes-d5704eb5206?source=collection_archive---------2-----------------------#2021-02-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/4c13c52356221329929340c959b43c6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PpqCKgYctGIjiN7I"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated"><a class="ae kc" href="https://unsplash.com/@harleydavidson?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">哈雷戴维森</a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="77f4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Fastify 是一个用于开发后端 web 应用程序的小型节点框架。</p><p id="af85" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将了解如何使用 Fastify 创建后端应用程序。</p><h1 id="f753" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">异步等待</h1><p id="7086" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以在路由处理程序中使用<code class="fe me mf mg mh b">async</code>和<code class="fe me mf mg mh b">await</code>。</p><p id="e393" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="73ec" class="mq lc iq mh b gy mr ms l mt mu">const fastify = require('fastify')()</span><span id="daed" class="mq lc iq mh b gy mv ms l mt mu">const getData = () =&gt; Promise.resolve('foo')<br/>const processData = (data) =&gt; Promise.resolve(data)</span><span id="ca7d" class="mq lc iq mh b gy mv ms l mt mu">const opts = {<br/>  schema: {<br/>    response: {<br/>      200: {<br/>        type: 'string'<br/>      }<br/>    }<br/>  }<br/>}</span><span id="2370" class="mq lc iq mh b gy mv ms l mt mu">fastify.get('/', opts, async function (request, reply) {<br/>  const data = await getData()<br/>  const processed = await processData(data)<br/>  return processed<br/>})</span><span id="bacb" class="mq lc iq mh b gy mv ms l mt mu">const start = async () =&gt; {<br/>  try {<br/>    await fastify.listen(3000, '0.0.0.0')  <br/>  } catch (err) {<br/>    fastify.log.error(err)    <br/>    process.exit(1)<br/>  }<br/>}<br/>start()</span></pre><p id="569d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们使用异步函数作为路由处理器。</p><p id="d8ab" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们可以在处理程序中使用<code class="fe me mf mg mh b">await</code>来运行承诺。</p><p id="1733" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们也可以使用<code class="fe me mf mg mh b">reply.send</code>发送回数据。</p><p id="9d3a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="5bc0" class="mq lc iq mh b gy mr ms l mt mu">const fastify = require('fastify')()</span><span id="e797" class="mq lc iq mh b gy mv ms l mt mu">const getData = () =&gt; Promise.resolve('foo')<br/>const processData = (data) =&gt; Promise.resolve(data)</span><span id="977a" class="mq lc iq mh b gy mv ms l mt mu">const opts = {<br/>  schema: {<br/>    response: {<br/>      200: {<br/>        type: 'string'<br/>      }<br/>    }<br/>  }<br/>}</span><span id="57e8" class="mq lc iq mh b gy mv ms l mt mu">fastify.get('/', opts, async function (request, reply) {<br/>  const data = await getData()<br/>  const processed = await processData(data)<br/>  reply.send(processed)<br/>})</span><span id="337f" class="mq lc iq mh b gy mv ms l mt mu">const start = async () =&gt; {<br/>  try {<br/>    await fastify.listen(3000, '0.0.0.0')  <br/>  } catch (err) {<br/>    fastify.log.error(err)    <br/>    process.exit(1)<br/>  }<br/>}<br/>start()</span></pre><p id="6ad8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">打电话给<code class="fe me mf mg mh b">reply.send</code>发回回复。</p><p id="eaf0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果我们在异步回调中调用<code class="fe me mf mg mh b">reply.send</code>，我们也可以等待我们的回复。</p><p id="ead9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="0162" class="mq lc iq mh b gy mr ms l mt mu">const fastify = require('fastify')()</span><span id="ba25" class="mq lc iq mh b gy mv ms l mt mu">const getData = () =&gt; Promise.resolve('foo')<br/>const processData = (data) =&gt; Promise.resolve(data)</span><span id="b03e" class="mq lc iq mh b gy mv ms l mt mu">const opts = {<br/>  schema: {<br/>    response: {<br/>      200: {<br/>        type: 'object',<br/>        properties: {<br/>          hello: {<br/>            type: 'string'<br/>          }<br/>        }<br/>      }<br/>    }<br/>  }<br/>}</span><span id="9517" class="mq lc iq mh b gy mv ms l mt mu">fastify.get('/', opts, async function (request, reply) {<br/>  setImmediate(() =&gt; {<br/>    reply.send({ hello: 'world' })<br/>  })<br/>  await reply<br/>})</span><span id="280b" class="mq lc iq mh b gy mv ms l mt mu">const start = async () =&gt; {<br/>  try {<br/>    await fastify.listen(3000, '0.0.0.0')  <br/>  } catch (err) {<br/>    fastify.log.error(err)    <br/>    process.exit(1)<br/>  }<br/>}<br/>start()</span></pre><p id="f846" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">等待我们的<code class="fe me mf mg mh b">reply</code>，因为我们在<code class="fe me mf mg mh b">setImmediate</code>回调中调用了<code class="fe me mf mg mh b">reply.send</code>。</p><p id="de97" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">同时使用<code class="fe me mf mg mh b">return value</code>和<code class="fe me mf mg mh b">reply.send(value)</code>时，先发生的优先。</p><p id="9b11" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果我们将<code class="fe me mf mg mh b">async</code>和<code class="fe me mf mg mh b">await</code>与<code class="fe me mf mg mh b">reply.send</code>一起使用，那么我们不应该返回任何值。</p><p id="d120" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果我们使用带有承诺的<code class="fe me mf mg mh b">async</code>和<code class="fe me mf mg mh b">await</code>，那么我们应该返回值，不要使用<code class="fe me mf mg mh b">reply.send</code>或返回<code class="fe me mf mg mh b">undefined</code>。</p><h1 id="26fd" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">路由前缀</h1><p id="db67" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以给路由添加前缀。</p><p id="6703" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><p id="a247" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">index.js</code></p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="4579" class="mq lc iq mh b gy mr ms l mt mu">const fastify = require('fastify')()</span><span id="df7c" class="mq lc iq mh b gy mv ms l mt mu">fastify.register(require('./routes/v1/users'), { prefix: '/v1' })<br/>fastify.register(require('./routes/v2/users'), { prefix: '/v2' })</span><span id="0d82" class="mq lc iq mh b gy mv ms l mt mu">const start = async () =&gt; {<br/>  try {<br/>    await fastify.listen(3000, '0.0.0.0')  <br/>  } catch (err) {<br/>    fastify.log.error(err)    <br/>    process.exit(1)<br/>  }<br/>}<br/>start()</span></pre><p id="59cc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">routes/v1/users.js</code></p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="a28e" class="mq lc iq mh b gy mr ms l mt mu">module.exports = function (fastify, opts, done) {<br/>  fastify.get('/user', async () =&gt; 'v1')<br/>  done()<br/>}</span></pre><p id="8730" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">routes/v2/users.js</code></p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="ef74" class="mq lc iq mh b gy mr ms l mt mu">module.exports = function (fastify, opts, done) {<br/>  fastify.get('/user', async () =&gt; 'v2')<br/>  done()<br/>}</span></pre><p id="a02c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后当我们转到/v1/user 时，我们看到了<code class="fe me mf mg mh b">v1</code>。</p><p id="0d24" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当我们转到/v2/user 时，我们会看到<code class="fe me mf mg mh b">v2</code>。</p><h1 id="141b" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="ce47" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以添加异步函数作为路由处理器。</p><p id="907c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以用 Fastify 添加路由前缀。</p></div></div>    
</body>
</html>