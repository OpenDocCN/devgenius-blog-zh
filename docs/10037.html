<html>
<head>
<title>K8s — Nginx Ingress Controller</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">K8s — Nginx 入口控制器</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/k8s-nginx-ingress-controller-36bb06f95ac2?source=collection_archive---------3-----------------------#2022-10-02">https://blog.devgenius.io/k8s-nginx-ingress-controller-36bb06f95ac2?source=collection_archive---------3-----------------------#2022-10-02</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><div class=""/><div class=""><h2 id="7681" class="pw-subtitle-paragraph jo iq ir bd b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dk translated">如何部署和使用 Nginx 入口控制器</h2></div><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj kg"><img src="../Images/07f8220bf0224249ac45f57d248eab50.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0AAHTYZeivPNauLH7kUElA.png"/></div></div></figure><p id="46d1" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">从我以前的“<a class="ae lo" href="https://tonylixu.medium.com/k8s-ingress-introduction-part-one-696deeff6908" rel="noopener"> K8s — Ingress </a>”文章中，我们了解到 Ingress 实际上是从 K8s 集群外部进入集群的入口，并将外部请求转发到集群中的不同服务。</p><p id="6265" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">实际上相当于一个<code class="fe lp lq lr ls b">nginx</code>、<code class="fe lp lq lr ls b">haproxy</code>之类的负载均衡代理服务器。你可能认为我们可以直接使用<code class="fe lp lq lr ls b">nginx</code>来实现。，但是只使用<code class="fe lp lq lr ls b">nginx</code>有一个很大的缺点。</p><p id="d92d" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">如何在每次添加新服务时更改<code class="fe lp lq lr ls b">nginx</code>配置？我们不可能手动更改或滚动更新前端<code class="fe lp lq lr ls b">nginx</code>吊舱，对吗？那么我们添加一个服务发现工具，比如<code class="fe lp lq lr ls b">consul</code>，怎么样？Ingress 其实就是这样实现的，只是服务发现功能是自己实现的，不需要使用第三方服务，然后增加一个域名规则定义。路由信息的刷新由入口控制器提供。</p><p id="1f78" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">入口控制器可以理解为一个监听器。通过不断的监控<code class="fe lp lq lr ls b">kube-apiserver</code>，它可以<strong class="ku is">实时感知后端</strong><code class="fe lp lq lr ls b"><strong class="ku is">Service</strong></code><strong class="ku is"/><code class="fe lp lq lr ls b"><strong class="ku is">Pod</strong></code><strong class="ku is"/>的变化。</p><p id="3523" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">当信息发生变化时，入口控制器结合入口的配置更新反向代理负载均衡器，实现服务发现的作用。事实上，这与服务发现工具 consul 和 consul-template 非常相似。如下图所示:</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj lt"><img src="../Images/396420a6d2da1ac7e66946fe66407f90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*3HUeg2sQp5OdtHTA.png"/></div></div></figure><p id="e912" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">有很多入口控制器大家都可以用，比如<code class="fe lp lq lr ls b">traefik</code>、<code class="fe lp lq lr ls b">nginx-controller</code>、<code class="fe lp lq lr ls b">K8s Ingress Controller for Kong</code>、<code class="fe lp lq lr ls b">HAProxy Ingress controller</code>。当然，你也可以自己实现一个入口控制器。</p><p id="3b92" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">在本文中，我们将重点介绍<code class="fe lp lq lr ls b">nginx-controller</code>和<code class="fe lp lq lr ls b">traefik</code>的用法。</p><h1 id="8968" class="lu lv ir bd lw lx ly lz ma mb mc md me jx mf jy mg ka mh kb mi kd mj ke mk ml bi translated">NGINX 入口控制器</h1><p id="d6ba" class="pw-post-body-paragraph ks kt ir ku b kv mm js kx ky mn jv la lb mo ld le lf mp lh li lj mq ll lm ln ik bi translated">Nginx 入口控制器是使用 K8s 入口资源对象构建的入口控制器实现，使用<code class="fe lp lq lr ls b">ConfigMap</code>存储 Nginx 配置。</p><p id="0ef1" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">要使用 Ingress 向外界公开服务，需要提前安装一个 Ingress 控制器。我们将首先安装 NGINX 入口控制器。</p><p id="a9e2" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">由于<code class="fe lp lq lr ls b">nginx-ingress</code>所在的节点需要能够访问外网，域名可以解析到这些节点，直接使用，所以需要将<code class="fe lp lq lr ls b">nginx-ingress</code>绑定到节点的 80 和 443 端口，这样就可以使用 hostPort 访问了。</p><h2 id="19e2" class="mr lv ir bd lw ms mt dn ma mu mv dp me lb mw mx mg lf my mz mi lj na nb mk nc bi translated">装置</h2><p id="81c8" class="pw-post-body-paragraph ks kt ir ku b kv mm js kx ky mn jv la lb mo ld le lf mp lh li lj mq ll lm ln ik bi translated">安装 Nginx 入口控制器的最佳方式是使用 Helm3，如果您有 Helm3，可以使用以下命令安装:</p><pre class="kh ki kj kk gu nd ls ne nf aw ng bi"><span id="e9fe" class="mr lv ir ls b gz nh ni l nj nk">$ helm upgrade --install ingress-nginx ingress-nginx   --repo <a class="ae lo" href="https://kubernetes.github.io/ingress-nginx" rel="noopener ugc nofollow" target="_blank">https://kubernetes.github.io/ingress-nginx</a>   --namespace ingress-nginx --create-namespace<br/>Release "ingress-nginx" does not exist. Installing it now.<br/>NAME: ingress-nginx<br/>LAST DEPLOYED: Sat Sep 17 19:12:21 2022<br/>NAMESPACE: ingress-nginx<br/>STATUS: deployed<br/>REVISION: 1<br/>TEST SUITE: None<br/>NOTES:<br/>The ingress-nginx controller has been installed.<br/>...</span></pre><p id="7c07" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">检查安装:</p><pre class="kh ki kj kk gu nd ls ne nf aw ng bi"><span id="fb2a" class="mr lv ir ls b gz nh ni l nj nk">$ helm list -n ingress-nginx<br/>NAME          NAMESPACE     REVISION UPDATED                                STATUS   CHART               APP VERSION<br/>ingress-nginx ingress-nginx 1        2022-09-17 19:12:21.98451221 +0000 UTC deployed ingress-nginx-4.2.5 1.3.1</span></pre><p id="bd96" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated"><strong class="ku is">飞行前检查</strong></p><p id="4595" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">一些豆荚应该从<code class="fe lp lq lr ls b">ingress-nginx</code>命名空间开始:</p><pre class="kh ki kj kk gu nd ls ne nf aw ng bi"><span id="0a51" class="mr lv ir ls b gz nh ni l nj nk">$ kubectl get pods --namespace=ingress-nginx</span></pre><p id="23db" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">过一会儿，他们应该都在跑。以下命令将等待入口控制器盒启动、运行并就绪:</p><pre class="kh ki kj kk gu nd ls ne nf aw ng bi"><span id="e1d0" class="mr lv ir ls b gz nh ni l nj nk">$ kubectl wait --namespace ingress-nginx   --for=condition=ready pod   --selector=app.kubernetes.io/component=controller   --timeout=120s<br/>pod/ingress-nginx-controller-7bf78659d-zp4s2 condition met</span></pre><p id="41d0" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated"><strong class="ku is">本地测试</strong></p><p id="5a2c" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">让我们创建一个简单的 web 服务器和相关的服务:</p><pre class="kh ki kj kk gu nd ls ne nf aw ng bi"><span id="bfb4" class="mr lv ir ls b gz nh ni l nj nk">$ kubectl create deployment demo --image=httpd --port=80<br/>$ kubectl expose deployment demo</span></pre><p id="3725" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">然后创建一个入口资源。以下示例使用映射到 localhost 的主机:</p><pre class="kh ki kj kk gu nd ls ne nf aw ng bi"><span id="9f51" class="mr lv ir ls b gz nh ni l nj nk">$ kubectl create ingress demo-localhost --class=nginx --rule="demo.localdev.me/*=demo:80"<br/>ingress.networking.k8s.io/demo-localhost created</span></pre><p id="78c0" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">现在，将本地端口转发到入口控制器:</p><pre class="kh ki kj kk gu nd ls ne nf aw ng bi"><span id="98d5" class="mr lv ir ls b gz nh ni l nj nk">$ kubectl port-forward — namespace=ingress-nginx service/ingress-nginx-controller 8080:80</span></pre><p id="7e48" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">此时，如果你访问<a class="ae lo" href="http://demo.localdev.me:8080/" rel="noopener ugc nofollow" target="_blank">http://demo.localdev.me:8080/</a>，你应该会看到一个 HTML 页面告诉你“它工作了！”。</p><pre class="kh ki kj kk gu nd ls ne nf aw ng bi"><span id="ea26" class="mr lv ir ls b gz nh ni l nj nk">$ curl <a class="ae lo" href="http://demo.localdev.me:8080/" rel="noopener ugc nofollow" target="_blank">http://demo.localdev.me:8080/</a><br/>&lt;html&gt;&lt;body&gt;&lt;h1&gt;It works!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;</span></pre><p id="8a6f" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">这证明 Nginx 入口控制器已经成功安装。</p><h2 id="6f0a" class="mr lv ir bd lw ms mt dn ma mu mv dp me lb mw mx mg lf my mz mi lj na nb mk nc bi translated">请求流程</h2><p id="3a1d" class="pw-post-body-paragraph ks kt ir ku b kv mm js kx ky mn jv la lb mo ld le lf mp lh li lj mq ll lm ln ik bi translated">下图显示了客户端通过入口控制器连接到其中一个 pod 的过程。客户端首先执行<code class="fe lp lq lr ls b">demo.localdev.me</code>，获取入口控制器所在节点的 IP。</p><p id="4049" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">然后客户端向入口控制器发送 HTTP 请求，然后根据入口对象描述匹配域名，找到对应的服务对象，获得关联的端点列表，将客户端的请求转发到其中一个 Pods。</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj nl"><img src="../Images/afd05172d6c8e2370eca0a204e0b4025.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EPG42uQ48IDaqnE7ggcpFw.png"/></div></div></figure><h2 id="d22d" class="mr lv ir bd lw ms mt dn ma mu mv dp me lb mw mx mg lf my mz mi lj na nb mk nc bi translated">URL 重写</h2><p id="4a19" class="pw-post-body-paragraph ks kt ir ku b kv mm js kx ky mn jv la lb mo ld le lf mp lh li lj mq ll lm ln ik bi translated">NGINX Ingress 控制器的很多高级用法都可以<code class="fe lp lq lr ls b">annotation</code>，比如常用的 URL 重写功能。例如，我们有一个演示前端应用程序，对应的入口资源对象如下:</p><pre class="kh ki kj kk gu nd ls ne nf aw ng bi"><span id="dfcb" class="mr lv ir ls b gz nh ni l nj nk">apiVersion: extensions/v1beta1<br/>kind: Ingress<br/>metadata:<br/>  name: test<br/>  namespace: default<br/>  annotations:<br/>    kubernetes.io/ingress.class: "nginx"<br/>spec:<br/>  rules:<br/>  - host: demo.localdev.com<br/>    http:<br/>      paths:<br/>      - backend:<br/>          serviceName: test<br/>          servicePort: 3000<br/>        path: /</span></pre><p id="4ba3" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">它是一个非常常规的<code class="fe lp lq lr ls b">Ingress</code>物体。部署对象后，解析域名后可以正常访问应用程序。</p><h1 id="e5c8" class="lu lv ir bd lw lx ly lz ma mb mc md me jx mf jy mg ka mh kb mi kd mj ke mk ml bi translated">演示应用程序</h1><p id="dd46" class="pw-post-body-paragraph ks kt ir ku b kv mm js kx ky mn jv la lb mo ld le lf mp lh li lj mq ll lm ln ik bi translated">让我们做一个完整的演示应用程序。首先，让我们准备以下 3 个 YAML 文件。</p><h2 id="c4f2" class="mr lv ir bd lw ms mt dn ma mu mv dp me lb mw mx mg lf my mz mi lj na nb mk nc bi translated">部署. yml</h2><pre class="kh ki kj kk gu nd ls ne nf aw ng bi"><span id="2a9d" class="mr lv ir ls b gz nh ni l nj nk">kind: Deployment<br/>metadata:<br/>  name: hello<br/>spec:<br/>  selector:<br/>    matchLabels:<br/>      app: hello<br/>  replicas: 1<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: hello<br/>    spec:<br/>      containers:<br/>      - name: hello<br/>        image: "gcr.io/google-samples/hello-app:2.0"</span></pre><h2 id="f459" class="mr lv ir bd lw ms mt dn ma mu mv dp me lb mw mx mg lf my mz mi lj na nb mk nc bi translated">service.yml</h2><pre class="kh ki kj kk gu nd ls ne nf aw ng bi"><span id="d0dd" class="mr lv ir ls b gz nh ni l nj nk">apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: hello<br/>  labels:<br/>    app: hello<br/>spec:<br/>  type: ClusterIP<br/>  selector:<br/>    app: hello<br/>  ports:<br/>  - port: 80<br/>    targetPort: 8080<br/>    protocol: TCP</span></pre><h2 id="cd48" class="mr lv ir bd lw ms mt dn ma mu mv dp me lb mw mx mg lf my mz mi lj na nb mk nc bi translated">ingress.yml</h2><pre class="kh ki kj kk gu nd ls ne nf aw ng bi"><span id="bdd8" class="mr lv ir ls b gz nh ni l nj nk">apiVersion: networking.k8s.io/v1<br/>kind: Ingress<br/>metadata:<br/>  name: hello<br/>spec:<br/>  ingressClassName: nginx<br/>  rules:<br/>  - host: "demo.hello-localdev.com"<br/>    http:<br/>      paths:<br/>        - pathType: Prefix<br/>          path: "/"<br/>          backend:<br/>            service:<br/>              name: hello<br/>              port:<br/>                number: 80</span></pre><p id="4267" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">现在让我们创建所有三个对象:</p><pre class="kh ki kj kk gu nd ls ne nf aw ng bi"><span id="19f6" class="mr lv ir ls b gz nh ni l nj nk">$ k create -f hellodeployment.yml<br/>deployment.apps/hello created</span><span id="9775" class="mr lv ir ls b gz nm ni l nj nk">$ k create -f hello-service.yml<br/>service/hello created</span><span id="1f0a" class="mr lv ir ls b gz nm ni l nj nk">$ k create -f hello-ingress.yml<br/>ingress.networking.k8s.io/hello created</span></pre><p id="2bc0" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">让我们检查入口状态:</p><pre class="kh ki kj kk gu nd ls ne nf aw ng bi"><span id="07ce" class="mr lv ir ls b gz nh ni l nj nk">$ kubectl describe ing hello<br/>Name:             hello<br/>Labels:           &lt;none&gt;<br/>Namespace:        default<br/>Address:<br/>Ingress Class:    nginx<br/>Default backend:  &lt;default&gt;<br/>Rules:<br/>  Host                     Path  Backends<br/>  ----                     ----  --------<br/>  demo.hello-localdev.com<br/>                           /   hello:80 (10.244.137.85:8080)<br/>Annotations:               &lt;none&gt;<br/>Events:<br/>  Type    Reason  Age   From                      Message<br/>  ----    ------  ----  ----                      -------<br/>  Normal  Sync    9s    nginx-ingress-controller  Scheduled for sync</span></pre><p id="5978" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">可以看到主机<code class="fe lp lq lr ls b">demo.hello-localdev.com</code>指向后端<code class="fe lp lq lr ls b">hello:80</code>。</p><p id="1cd2" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">现在让我们进行端口转发，这样我们就可以进行本地测试:</p><pre class="kh ki kj kk gu nd ls ne nf aw ng bi"><span id="f315" class="mr lv ir ls b gz nh ni l nj nk">$ kubectl port-forward --namespace=ingress-nginx service/ingress-nginx-controller 8080:80</span></pre><p id="eee8" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">尝试访问服务:</p><pre class="kh ki kj kk gu nd ls ne nf aw ng bi"><span id="d638" class="mr lv ir ls b gz nh ni l nj nk">$ curl --resolve demo.hello-localdev.com:8080:127.0.0.1 <a class="ae lo" href="http://demo.hello-localdev.com:8080" rel="noopener ugc nofollow" target="_blank">http://demo.hello-localdev.com:8080</a><br/>Hello, world!<br/>Version: 2.0.0<br/>Hostname: hello-8987f46f8-z5vhn</span></pre><h1 id="ef01" class="lu lv ir bd lw lx ly lz ma mb mc md me jx mf jy mg ka mh kb mi kd mj ke mk ml bi translated">结论</h1><p id="a8ad" class="pw-post-body-paragraph ks kt ir ku b kv mm js kx ky mn jv la lb mo ld le lf mp lh li lj mq ll lm ln ik bi translated">在本文中，我向您展示了如何设置 Nginx 入口控制器。入门非常容易。然而，对于项目实施来说，要确保你已经完成了所有 Nginx 配置，并根据需求对它们进行了<strong class="ku is">调优。</strong></p><p id="4fab" class="pw-post-body-paragraph ks kt ir ku b kv kw js kx ky kz jv la lb lc ld le lf lg lh li lj lk ll lm ln ik bi translated">我希望你喜欢这篇文章。</p></div></div>    
</body>
</html>