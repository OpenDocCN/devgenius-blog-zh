<html>
<head>
<title>Creating a re usable Firebase Phone Authentication Android code</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">创建一个可重用的Firebase手机认证Android代码</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/creating-a-re-usable-firebase-phone-authentication-android-code-cfbdedab6cdd?source=collection_archive---------11-----------------------#2020-05-29">https://blog.devgenius.io/creating-a-re-usable-firebase-phone-authentication-android-code-cfbdedab6cdd?source=collection_archive---------11-----------------------#2020-05-29</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/7ffc156a262df027881f7cbf5f12126b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lZlEGHuJu-ku8cq6gMelZA.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">图片来自<a class="ae jz" href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=99223" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>的<a class="ae jz" href="https://pixabay.com/users/OpenIcons-28911/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=99223" rel="noopener ugc nofollow" target="_blank"> OpenIcons </a></figcaption></figure><p id="a41f" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们不得不在不同的项目中一遍又一遍地使用一些代码，这是很常见的，将这些代码分成它们自己的类总是很好的，这样它们可以被重用，也可以与其他可重用的代码一起放在一个库模块中。</p><p id="ed31" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我使用LiveData创建了一个可重用的Firebase phone身份验证类来与其他组件通信。我将使用一个ViewModel，它将为需要监听这些事件的活动/片段提供Firebase事件。让我们看看代码。</p><pre class="ky kz la lb gt lc ld le lf aw lg bi"><span id="7a83" class="lh li in ld b gy lj lk l ll lm">class FirebasePhoneAuth {<br/>    private val firebaseAuth = FirebaseAuth.getInstance()<em class="ln"><br/>    </em>val verificationIdLiveEvent = SingleLiveEvent&lt;String&gt;()<br/>    val phoneAuthSuccessLiveEvent = SingleLiveEvent&lt;FirebaseUser&gt;()<br/>    val phoneAuthFailureLiveEvent = SingleLiveEvent&lt;String&gt;()<br/><br/>    private val callbacks = object : PhoneAuthProvider.OnVerificationStateChangedCallbacks() {<br/><br/>        override fun onVerificationCompleted(credential: PhoneAuthCredential) {<br/>            // This callback will be invoked in two situations:<br/>            // 1 - Instant verification. In some cases the phone number can be instantly<br/>            //     verified without needing to send or enter a verification code.<br/>            // 2 - Auto-retrieval. On some devices Google Play services can automatically<br/>            //     detect the incoming verification SMS and perform verification without<br/>            //     user action.<br/>            signInWithPhoneAuthCredential(credential)<br/>        }<br/><br/>        override fun onVerificationFailed(e: FirebaseException) {<br/>            // This callback is invoked in an invalid request for verification is made,<br/>            // for instance if the the phone number format is not valid.<br/>            phoneAuthFailureLiveEvent.<em class="ln">value </em>= e.message ?: "FirebaseException"<br/><br/>            if(e is FirebaseAuthInvalidCredentialsException) {<br/>                phoneAuthFailureLiveEvent.<em class="ln">value </em>= e.message ?: "Invalid request"<br/>            }<br/>            else if(e is FirebaseTooManyRequestsException) {<br/>                phoneAuthFailureLiveEvent.<em class="ln">value </em>= e.message ?: "The SMS quota for the project has been exceeded"<br/>            }<br/>        }<br/><br/>        override fun onCodeSent(<br/>            verificationId: String,<br/>            token: PhoneAuthProvider.ForceResendingToken<br/>        ) {<br/>            // The SMS verification code has been sent to the provided phone number, we<br/>            // now need to ask the user to enter the code and then construct a credential<br/>            // by combining the code with a verification ID.<br/>            verificationIdLiveEvent.<em class="ln">value </em>= verificationId<br/>        }<br/>    }<br/><br/>    fun verifyPhoneNumber(<br/>        prefix: String,<br/>        phone: String<br/>    ) {<br/>        PhoneAuthProvider.getInstance().verifyPhoneNumber(<br/>            prefix + phone,<br/>            <em class="ln">PHONE_TIMEOUT</em>, // Timeout duration<br/>            TimeUnit.SECONDS, // Unit of timeout<br/>            TaskExecutors.<em class="ln">MAIN_THREAD</em>,<br/>            callbacks<br/>        )<br/>    }<br/><br/>    fun signInWithPhoneAuthCredential(credential: PhoneAuthCredential) {<br/>        firebaseAuth.signInWithCredential(credential)<br/>            .addOnCompleteListener <strong class="ld io">{<br/>                </strong>if(<strong class="ld io">it</strong>.<em class="ln">isSuccessful</em>) {<br/>                    // Sign in success, update UI with the signed-in user's information<br/>                    val user = <strong class="ld io">it</strong>.<em class="ln">result</em>?.<em class="ln">user<br/>                    </em>phoneAuthSuccessLiveEvent.<em class="ln">value </em>= user<br/>                }<br/>                else {<br/>                    // Sign in failed, display a message and update the UI<br/>                    if(<strong class="ld io">it</strong>.<em class="ln">exception </em>is FirebaseAuthInvalidCredentialsException) {<br/>                        // The verification code entered was invalid<br/>                        phoneAuthFailureLiveEvent.<em class="ln">value </em>= <strong class="ld io">it</strong>.<em class="ln">exception</em>?.message ?: "FirebaseAuthInvalidCredentialsException"<br/>                    }<br/>                    else {<br/>                        phoneAuthFailureLiveEvent.<em class="ln">value </em>= <strong class="ld io">it</strong>.<em class="ln">exception</em>?.message ?: "Task failed"<br/>                    }<br/>                }<br/>            <strong class="ld io">}<br/>    </strong>}<br/>}</span></pre><p id="efbc" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><a class="ae jz" href="https://github.com/android/architecture-samples/blob/dev-todo-mvvm-live/todoapp/app/src/main/java/com/example/android/architecture/blueprints/todoapp/SingleLiveEvent.java" rel="noopener ugc nofollow" target="_blank">singliveevent</a>是一个生命周期感知的可观察对象，在订阅后只发送新的更新。你可以从谷歌在Github的Android样本中得到。</p><p id="1dd1" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">让我们检查视图模型代码</p><pre class="ky kz la lb gt lc ld le lf aw lg bi"><span id="85be" class="lh li in ld b gy lj lk l ll lm">class AuthViewModel : ViewModel() {<br/>    val firebasePhoneAuthUtils = FirebasePhoneAuth()<br/>    // phone auth init event observable<br/>    val phoneAuthLiveEvent = SingleLiveEvent&lt;Unit&gt;()<br/>    // code entered event observable<br/>    val codeEnteredAuthLiveEvent = SingleLiveEvent&lt;Unit&gt;()<br/>    val codeObservableField = ObservableField("")<br/>}</span></pre><p id="d896" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在活动端，我从FirebasePhoneAuth观察事件。下面是代码。</p><pre class="ky kz la lb gt lc ld le lf aw lg bi"><span id="4a28" class="lh li in ld b gy lj lk l ll lm">class AuthActivity : AppCompatActivity() {<br/>    private lateinit var authViewModel: AuthViewModel<br/><br/>    override fun onCreate(savedInstanceState: Bundle?) {<br/>        super.onCreate(savedInstanceState)<br/>        val activityAuthBinding: ActivityAuthBinding = DataBindingUtil.setContentView(<br/>            this,<br/>            R.layout.<em class="ln">activity_auth<br/>        </em>)<br/>        authViewModel = ViewModelProvider(<br/>            this<br/>        ).get(AuthViewModel::class.<em class="ln">java</em>)<br/>        observeObservables()<br/>    }</span><span id="e45a" class="lh li in ld b gy lo lk l ll lm">private fun observeObservables() {<br/>    // observe required observables here<br/><br/>    authViewModel.phoneAuthLiveEvent.observe(<br/>        this,<br/>        <em class="ln">Observer </em><strong class="ld io">{<br/>            </strong>// this will execute when user enters number, call verifyPhoneNumber now<br/>            authViewModel.firebasePhoneAuthUtils.verifyPhoneNumber(<br/>                getString(R.string.<em class="ln">phone_prefix</em>), // +880<br/>                authViewModel.loginObservable.phoneLoginObservable // phone number<br/>            )<br/>        <strong class="ld io">}<br/>    </strong>)<br/>    authViewModel.codeEnteredAuthLiveEvent.observe(<br/>        this,<br/>        <em class="ln">Observer </em><strong class="ld io">{<br/>            </strong>// this will execute when user enters sms code, call signInWithPhoneAuthCredential now<br/>            authViewModel.firebasePhoneAuthUtils.signInWithPhoneAuthCredential(<br/>                PhoneAuthProvider.getCredential(<br/>                    authViewModel.firebasePhoneAuthUtils.verificationIdLiveEvent.<em class="ln">value</em>!!,<br/>                    authViewModel.codeObservableField.get()!!<br/>                )<br/>            )<br/>        <strong class="ld io">}<br/>    </strong>)<br/>    authViewModel.firebasePhoneAuthUtils.phoneAuthSuccessLiveEvent.observe(<br/>        this,<br/>        <em class="ln">Observer </em><strong class="ld io">{ </strong>firebaseUser <strong class="ld io">-&gt;<br/>            </strong>authViewModel.postLogin(firebaseUser?.<em class="ln">phoneNumber</em>!!).observe(<br/>                this,<br/>                <em class="ln">Observer </em><strong class="ld io">{<br/>                    </strong>// phone auth succeed<br/>                <strong class="ld io">}<br/>            </strong>)<br/>        <strong class="ld io">}<br/>    </strong>)<br/>    authViewModel.firebasePhoneAuthUtils.phoneAuthFailureLiveEvent.observe(<br/>        this,<br/>        <em class="ln">Observer </em><strong class="ld io">{<br/>            </strong>// phone auth failed<br/>        <strong class="ld io">}<br/>    </strong>)<br/>}</span><span id="eaff" class="lh li in ld b gy lo lk l ll lm">}</span></pre><p id="156f" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这里，当用户输入电话号码时，phoneAuthLiveEvent被触发。当用户输入代码时，将触发codeEnteredAuthLiveEvent。然后用PhoneAuthProvider调用signInWithPhoneAuthCredential。使用用户输入的验证Id和代码创建的PhoneAuthCredentials对象。最后，当电话认证成功时触发firebasephone authutils . phoneauthsuccesslivedata，否则当电话认证失败时触发firebasephone authutils . phoneauthfailurelivedata。</p><p id="c471" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">今天到此为止。希望这对你有所帮助。感谢您的阅读。</p></div></div>    
</body>
</html>