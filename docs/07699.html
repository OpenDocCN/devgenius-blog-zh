<html>
<head>
<title>Detecting Memory Leaks in iOS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">检测 iOS 中的内存泄漏</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/detecting-memory-leaks-in-ios-25360e6ee51f?source=collection_archive---------0-----------------------#2022-04-17">https://blog.devgenius.io/detecting-memory-leaks-in-ios-25360e6ee51f?source=collection_archive---------0-----------------------#2022-04-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="0552" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">了解内存泄漏以及如何使用工具和内存图来捕获它们</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/7691f405b1a8b8765579e4407c055316.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PaQsuErfW_0z0chN"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">阿姆扎·安德烈在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="e68d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">iOS 开发并不总是给屏幕添加漂亮的颜色和实现 dope 动画。为了确保给用户最好的体验，工程师必须确保不在他们的源代码中引入任何内存泄漏。</p><h1 id="04e6" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">什么是内存泄漏</h1><p id="8873" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">基本上，内存泄漏是指应该从内存中释放的对象没有被初始化，它仍然像幽灵一样徘徊不去。当内存不能被释放时，这是存在保留周期的标志。</p><p id="a012" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">保持循环是指两个或更多的对象持有彼此的强引用。因此，这些对象在内存中相互保留，因为它们的保留计数永远不会递减到 0。这阻止了调用 deinit 和释放内存。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mp"><img src="../Images/00214ea4b4f6a27db48b7b09ffd71ca0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rVkOwZ2fbFc8oE5p-WPKcw.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">当一个对象强引用另一个对象时，这意味着存在一个保留周期</figcaption></figure><h1 id="3296" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">但是我为什么要关心内存泄漏呢？</h1><p id="e099" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">现在的内存容易存取，价格便宜，而且数量巨大。我们不再需要使用只有大约 1 兆存储空间的软盘。那么，我为什么要关心我的应用程序是否有一两次内存泄漏呢？我可以利用其他可用的空间！</p><p id="cf50" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">嗯，操作系统(OS)关心有多少内存正在被使用。如果应用程序接近分配空间的尽头，iOS 将向应用程序发出警告。如果应用程序没有及时处理它，那么操作系统将会退出应用程序，因为内存不足而崩溃，以便为其他进程回收内存。</p><p id="e5ea" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在应用程序崩溃之前，用户看不到内存问题。这破坏了应用程序的稳定性，并造成了糟糕的用户体验。这导致用户不高兴，并可能失去业务客户。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mq"><img src="../Images/a4a5df86746e185c9a46b3def25fe755.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mFchqKzJOrO8KVFfb6H5Nw.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">崩溃会造成糟糕的用户体验，从而导致不愉快的客户</figcaption></figure><h1 id="88df" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">如何防止内存泄漏？</h1><p id="4e11" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">防止内存泄漏的最好方法是根本不引起内存泄漏。当您移动到下一个屏幕/显示一个新的视图控制器时，请务必仔细检查您创建的对象是否已被取消初始化。</p><p id="66b3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">确保保留周期中断的一个方法是使用<strong class="ky ir">弱</strong>关键字。我将展示两个关于如何对一个对象应用弱引用的例子。</p><h2 id="f71e" class="mr lt iq bd lu ms mt dn ly mu mv dp mc lf mw mx me lj my mz mg ln na nb mi nc bi translated">委托模式</h2><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nd"><img src="../Images/653a07af79a9aefce567f4673a66e07b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rbOR7MZYnymrWWeMqKb9bw.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">委托/协议模式的代码示例</figcaption></figure><p id="d882" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当您希望一个对象符合一个协议时，一定要在协议声明中添加一个<a class="ae kv" href="https://github.com/apple/swift-evolution/blob/master/proposals/0156-subclass-existentials.md" rel="noopener ugc nofollow" target="_blank"> AnyObject </a>约束。如果不添加类约束，编译器默认会给你一个错误。委托模式中的代理应该被声明为<strong class="ky ir">弱</strong>，并且应该被声明为可选的。问号是使变量成为可选变量的语法，这意味着该变量可以有值，也可以为空或为零。确保委托是可选的，可以确保在视图被取消初始化时释放值。</p><h2 id="2e36" class="mr lt iq bd lu ms mt dn ly mu mv dp mc lf mw mx me lj my mz mg ln na nb mi nc bi translated">关闭</h2><p id="bff6" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">默认情况下，将函数用作闭包会保持强引用。如果您必须将一个对象传入您的闭包，您必须使用捕获列表来保存一个对该对象的<strong class="ky ir">弱</strong>引用。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ne"><img src="../Images/8af1fb344000bf6c68f4e6b804a9d6ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GSSAO_4m0B3hcYyrX8MYVg.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">向闭包内使用的对象添加 weak 的代码示例</figcaption></figure><p id="23cb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这个例子中，对象<em class="nf"> someModelVC </em>保存了对函数<em class="nf"> actionHandler </em>的引用。如果我们在这里没有 weak 关键字，那么 actionHandler 在默认情况下也会在这个闭包内有一个对 someModelVC 的强引用。所以<strong class="ky ir">弱</strong>关键词打破了这个保留循环。</p><h1 id="41be" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">如何检测内存泄漏</h1><p id="f70f" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">Apple 为开发人员提供了一些工具来帮助捕捉内存泄漏，等等！</p><h2 id="78ce" class="mr lt iq bd lu ms mt dn ly mu mv dp mc lf mw mx me lj my mz mg ln na nb mi nc bi translated">工具</h2><p id="79e5" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">Instruments 是一个可以让您查看各种性能数据的软件。这是一个性能分析器和可视化工具，如果你有 Xcode，它会自动安装到你的机器上。在下面的截图中，您可以看到许多评测不同事物的评测模板。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ng"><img src="../Images/e1f224d5c340c7794c526f6b152bd0a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QLhyRzJ3trIrc3GKTynhzw.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">仪器中可用的模板，泄漏模板突出显示</figcaption></figure><h2 id="2cb3" class="mr lt iq bd lu ms mt dn ly mu mv dp mc lf mw mx me lj my mz mg ln na nb mi nc bi translated">运行仪器</h2><ol class=""><li id="20ca" class="nh ni iq ky b kz mk lc ml lf nj lj nk ln nl lr nm nn no np bi translated">打开 Xcode</li><li id="3ed6" class="nh ni iq ky b kz nq lc nr lf ns lj nt ln nu lr nm nn no np bi translated">插入您的设备</li><li id="509b" class="nh ni iq ky b kz nq lc nr lf ns lj nt ln nu lr nm nn no np bi translated">在设备/模拟器下拉菜单中选择您的设备，并启用自动签名</li><li id="6c06" class="nh ni iq ky b kz nq lc nr lf ns lj nt ln nu lr nm nn no np bi translated">产品→配置文件(Cmd + I)</li><li id="4bb8" class="nh ni iq ky b kz nq lc nr lf ns lj nt ln nu lr nm nn no np bi translated">仪器启动时，按顶部的红色按钮</li><li id="4979" class="nh ni iq ky b kz nq lc nr lf ns lj nt ln nu lr nm nn no np bi translated">点击设备上的应用程序</li></ol><p id="9456" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">仪器每 10 秒运行一次泄漏检查。这是可配置的，您可以更改任何给定仪器的首选项。然而，就 RAM 和 CPU 时间而言，泄漏检查是非常昂贵的，所以我建议将其保持在 10 秒。</p><h2 id="49ee" class="mr lt iq bd lu ms mt dn ly mu mv dp mc lf mw mx me lj my mz mg ln na nb mi nc bi translated">Xcode 的内存图形调试器</h2><p id="b30a" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">iOS 开发人员可能更熟悉的工具是内存图调试器。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/59b10f7d898fad126e258c9a95273012.png" data-original-src="https://miro.medium.com/v2/resize:fit:676/format:webp/1*H1wGiO8B5ApSTxUcJM_SSQ.png"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">Xcode 上用红色圈出的内存图形调试器按钮</figcaption></figure><p id="1092" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您还没有使用过这个工具，那么在开发时很容易访问它。点击图标将暂停您的应用程序，并生成一个对象图，其中包含这些对象对其他对象的引用。如果检测到内存泄漏，您会在 Xcode 的左侧面板上看到紫色图标。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/0e27a96c6a4095002f787ab394dd388e.png" data-original-src="https://miro.medium.com/v2/resize:fit:936/format:webp/1*fQ84d7cq5XvjnOPHl4KsFQ.png"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">Xcode 从一个闭包泄漏内存警告</figcaption></figure><h2 id="61f6" class="mr lt iq bd lu ms mt dn ly mu mv dp mc lf mw mx me lj my mz mg ln na nb mi nc bi translated">使用 Xcode 的内存图形调试器</h2><ol class=""><li id="5fcd" class="nh ni iq ky b kz mk lc ml lf nj lj nk ln nl lr nm nn no np bi translated">打开 Xcode</li><li id="e7b4" class="nh ni iq ky b kz nq lc nr lf ns lj nt ln nu lr nm nn no np bi translated">在设备/模拟器下拉菜单中选择您的设备，并启用自动管理签名</li><li id="90cb" class="nh ni iq ky b kz nq lc nr lf ns lj nt ln nu lr nm nn no np bi translated">从 Xcode (Cmd + R)运行代码</li><li id="677f" class="nh ni iq ky b kz nq lc nr lf ns lj nt ln nu lr nm nn no np bi translated">点击设备上的应用程序</li><li id="e19e" class="nh ni iq ky b kz nq lc nr lf ns lj nt ln nu lr nm nn no np bi translated">点击 Xcode 上的内存图形调试器</li></ol><p id="e006" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Instruments 不是内存图调试器的替代品，而是检查内存泄漏的伴侣。两者各有利弊。一个工具可以发现另一个工具可能遗漏的东西。Instruments 的一个优点是，我不需要停止应用程序就可以看到有什么泄漏。当我运行应用程序时，我可以看到所有这些数据。不过 Xcode 里的内存图是直截了当的。我可以看到运行时错误以及哪个对象泄漏了。</p><h1 id="b175" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">技巧</h1><ul class=""><li id="7ae4" class="nh ni iq ky b kz mk lc ml lf nj lj nk ln nl lr nx nn no np bi translated">添加到您的开发习惯中的一个好的实践是在特性开发期间检查内存泄漏，这样您就不会在以后遇到任何意外。<br/>–运行仪器以在开发前收集内存数据<br/>–实现您的功能<br/>–在发出拉取请求前再次运行泄漏跟踪</li><li id="d1a2" class="nh ni iq ky b kz nq lc nr lf ns lj nt ln nu lr nx nn no np bi translated">永远记住在物理设备上运行和测试你的应用，尤其是当你检查性能和内存使用时。因为模拟器使用 Mac 的处理能力，所以在模拟器上运行代码看起来一切都很好，直到应用程序在生产中开始崩溃。</li></ul><h1 id="ef08" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">最后的想法</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/d41eaa308a7bbc956cf7eada44c5074c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1024/format:webp/1*W8Qdz0fMK3sLilgYBMfI0w.png"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">什么是内存泄漏？我忘记了</figcaption></figure><p id="7369" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当两个或更多的对象持有对彼此的强引用时，就会发生内存泄漏，这会导致一个保留循环。打破保持循环将修复内存泄漏。</p><p id="da25" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">将工具和内存图调试器都添加到您的工具带中可以帮助尽早发现棘手的问题。开发人员有责任确保他们的代码是高性能的，这样用户就可以有无缝的体验。</p><p id="6d80" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">更多 iOS 开发内容，一定要关注我的 Medium！</p><h1 id="f725" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">参考</h1><ul class=""><li id="4328" class="nh ni iq ky b kz mk lc ml lf nj lj nk ln nl lr nx nn no np bi translated"><a class="ae kv" href="https://docs.swift.org/swift-book/LanguageGuide/Deinitialization.html" rel="noopener ugc nofollow" target="_blank">Swift 中的去初始化</a></li><li id="d335" class="nh ni iq ky b kz nq lc nr lf ns lj nt ln nu lr nx nn no np bi translated"><a class="ae kv" href="https://developer.apple.com/videos/play/wwdc2019/411" rel="noopener ugc nofollow" target="_blank"> WWDC19:乐器入门</a></li><li id="2e85" class="nh ni iq ky b kz nq lc nr lf ns lj nt ln nu lr nx nn no np bi translated"><a class="ae kv" href="https://www.raywenderlich.com/16126261-instruments-tutorial-with-swift-getting-started" rel="noopener ugc nofollow" target="_blank">雷·温德里希:Swift 乐器教程</a></li><li id="3787" class="nh ni iq ky b kz nq lc nr lf ns lj nt ln nu lr nx nn no np bi translated"><a class="ae kv" href="https://www.hackingwithswift.com/read/30/overview" rel="noopener ugc nofollow" target="_blank">利用 Swift: Instruments 进行黑客攻击</a></li><li id="9c61" class="nh ni iq ky b kz nq lc nr lf ns lj nt ln nu lr nx nn no np bi translated"><a class="ae kv" href="https://www.hackingwithswift.com/example-code/language/how-to-restrict-a-protocol-to-classes" rel="noopener ugc nofollow" target="_blank">利用 Swift 进行黑客攻击:如何将协议限制在类内</a></li><li id="4abe" class="nh ni iq ky b kz nq lc nr lf ns lj nt ln nu lr nx nn no np bi translated"><a class="ae kv" href="https://doordash.engineering/2019/05/22/ios-memory-leaks-and-retain-cycle-detection-using-xcodes-memory-graph-debugger/" rel="noopener ugc nofollow" target="_blank"> DoorDash 工程:如何使用 Xcode 的内存图调试器检测 iOS 内存泄漏并保留周期</a></li></ul></div></div>    
</body>
</html>