<html>
<head>
<title>Go (Golang): Testing tools &amp; tips to step up your game</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Go (Golang):测试工具和技巧，提升您的游戏水平</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/go-golang-testing-tools-tips-to-step-up-your-game-4ed165a5b3b5?source=collection_archive---------5-----------------------#2022-01-13">https://blog.devgenius.io/go-golang-testing-tools-tips-to-step-up-your-game-4ed165a5b3b5?source=collection_archive---------5-----------------------#2022-01-13</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><figure class="im in gp gr io ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi il"><img src="../Images/46eb1ea2895e36059833e58c762b4ca7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*HFiFdPZIR-F_rJ8I"/></div></div><figcaption class="iw ix gj gh gi iy iz bd b be z dk translated"><a class="ae ja" href="https://unsplash.com/@freestocks?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">自由股票</a>在<a class="ae ja" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><div class=""/><p id="ac63" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我在个人项目中使用了这篇文章中提到的所有工具和技巧。更多详情，请看这里:【https://github.com/rafael-piovesan/go-rocket-ride<a class="ae ja" href="https://github.com/rafael-piovesan/go-rocket-ride" rel="noopener ugc nofollow" target="_blank"/></p></div><div class="ab cl ky kz hr la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ig ih ii ij ik"><h1 id="fcf5" class="lf lg jd bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">#1 测试容器</h1><p id="50e5" class="pw-post-body-paragraph ka kb jd kc b kd md kf kg kh me kj kk kl mf kn ko kp mg kr ks kt mh kv kw kx ig bi translated">当我想到写这篇文章的时候，首先想到的工具是<strong class="kc je"><em class="mi">test containers-Go</em></strong>(<a class="ae ja" href="https://golang.testcontainers.org/" rel="noopener ugc nofollow" target="_blank">https://golang.testcontainers.org/</a>)<em class="mi">。</em>根据自己的文档:</p><blockquote class="mj mk ml"><p id="c5ab" class="ka kb mi kc b kd ke kf kg kh ki kj kk mm km kn ko mn kq kr ks mo ku kv kw kx ig bi translated">(…)是一个 Go 包，它简化了为自动化集成/冒烟测试创建和清理基于容器的依赖项。干净、易于使用的 API 使开发人员能够以编程方式定义应该作为测试的一部分运行的容器，并在测试完成时清理这些资源。</p></blockquote><p id="fdcf" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这意味着您可以在应用程序的集成和/或冒烟测试最需要的时间和地点，以某种无缝的方式，在不依赖外部资源的情况下，以编程方式创建、交互和处置容器。实际上，不再需要保存和维护各种 docker-compose 文件、复杂的 shell 脚本等等。您可以根据需要生成任意多的容器，每个容器用于一个特定的场景，并在运行测试所需的时间内保存它们。</p><p id="b598" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">下面是我如何建立一个 Postgres 容器，并在我的集成测试中使用它(更多细节见<a class="ae ja" href="https://github.com/rafael-piovesan/go-rocket-ride" rel="noopener ugc nofollow" target="_blank">https://github.com/rafael-piovesan/go-rocket-ride</a>):</p><figure class="mp mq mr ms gt ip"><div class="bz fp l di"><div class="mt mu l"/></div><figcaption class="iw ix gj gh gi iy iz bd b be z dk translated">创建 Postgres 测试容器的实用程序代码</figcaption></figure><p id="b62a" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如果你觉得这很有趣，那么也来看看另外两个项目:</p><ul class=""><li id="6b07" class="mv mw jd kc b kd ke kh ki kl mx kp my kt mz kx na nb nc nd bi translated"><strong class="kc je"><em class="mi">docker test</em></strong>(<a class="ae ja" href="https://github.com/ory/dockertest" rel="noopener ugc nofollow" target="_blank">https://github.com/ory/dockertest</a>)，旨在提供与<em class="mi"> Testcontainers-Go 相同的易用、更广泛和通用的 API</em></li><li id="1657" class="mv mw jd kc b kd ne kh nf kl ng kp nh kt ni kx na nb nc nd bi translated"><strong class="kc je"><em class="mi">Gnomock</em></strong>(<a class="ae ja" href="https://github.com/orlangure/gnomock" rel="noopener ugc nofollow" target="_blank">https://github.com/orlangure/gnomock</a>)，专注于少数几个专业的，但却被很多项目普遍使用的流行预置。</li></ul><h1 id="a0a9" class="lf lg jd bd lh li nj lk ll lm nk lo lp lq nl ls lt lu nm lw lx ly nn ma mb mc bi translated">#2 作证</h1><p id="fb17" class="pw-post-body-paragraph ka kb jd kc b kd md kf kg kh me kj kk kl mf kn ko kp mg kr ks kt mh kv kw kx ig bi translated"><strong class="kc je"> <em class="mi">作证</em></strong>(【https://github.com/stretchr/testify】)<strong class="kc je"><em class="mi"/></strong>到现在已经这么长时间了，几乎不需要任何介绍。但是，因为这是一个有用工具的列表&amp;提高测试质量的技巧，所以不能被遗漏。最流行的特性包括用于创建模拟对象的简单断言和机制，这些模拟对象也可用于检查对它们的期望。</p><figure class="mp mq mr ms gt ip"><div class="bz fp l di"><div class="mt mu l"/></div><figcaption class="iw ix gj gh gi iy iz bd b be z dk translated">断言示例摘自:<a class="ae ja" href="https://github.com/stretchr/testify" rel="noopener ugc nofollow" target="_blank">https://github.com/stretchr/testify</a></figcaption></figure><figure class="mp mq mr ms gt ip"><div class="bz fp l di"><div class="mt mu l"/></div><figcaption class="iw ix gj gh gi iy iz bd b be z dk translated">模拟示例摘自:<a class="ae ja" href="https://github.com/stretchr/testify" rel="noopener ugc nofollow" target="_blank">https://github.com/stretchr/testify</a></figcaption></figure><h1 id="85de" class="lf lg jd bd lh li nj lk ll lm nk lo lp lq nl ls lt lu nm lw lx ly nn ma mb mc bi translated">#3 嘲弄</h1><p id="74a4" class="pw-post-body-paragraph ka kb jd kc b kd md kf kg kh me kj kk kl mf kn ko kp mg kr ks kt mh kv kw kx ig bi translated"><strong class="kc je"><em class="mi">mock</em></strong>(<a class="ae ja" href="https://github.com/vektra/mockery" rel="noopener ugc nofollow" target="_blank">https://github.com/vektra/mockery</a>)是一个补充工具，与<strong class="kc je"><em class="mi">evidence 的 Mock </em> </strong>包一起使用，利用其创建 Mock 对象和自动生成 Golang 接口 Mock 的功能，这些功能可以在您的项目源代码中找到。它有助于减少(大量)样板编码任务。</p><figure class="mp mq mr ms gt ip"><div class="bz fp l di"><div class="mt mu l"/></div><figcaption class="iw ix gj gh gi iy iz bd b be z dk translated">模拟对象示例摘自:<a class="ae ja" href="https://github.com/vektra/mockery" rel="noopener ugc nofollow" target="_blank">https://github.com/vektra/mockery</a></figcaption></figure><h1 id="5eca" class="lf lg jd bd lh li nj lk ll lm nk lo lp lq nl ls lt lu nm lw lx ly nn ma mb mc bi translated">#4 Gofakeit</h1><p id="38c1" class="pw-post-body-paragraph ka kb jd kc b kd md kf kg kh me kj kk kl mf kn ko kp mg kr ks kt mh kv kw kx ig bi translated"><strong class="kc je"><em class="mi">Gofakeit</em></strong>(<a class="ae ja" href="https://github.com/brianvoe/gofakeit" rel="noopener ugc nofollow" target="_blank">https://github.com/brianvoe/gofakeit</a>)是一个随机数据生成器。目前，它提供了 160 多种功能，涵盖了一些不同的主题/类别，如<em class="mi">人物</em>、<em class="mi">动物</em>、<em class="mi">地址</em>、<em class="mi">游戏</em>、<em class="mi">汽车</em>、<em class="mi">啤酒</em>等等。这里的关键词是<em class="mi">随机</em>。在计划和编写测试时，随机性是需要考虑的一个重要方面。比起在测试用例中使用常量值，使用随机生成的值通常是更好的选择，这样我们就更有信心，即使面对未知的(随机)输入，我们的代码仍然会按照我们期望的方式运行。</p><figure class="mp mq mr ms gt ip"><div class="bz fp l di"><div class="mt mu l"/></div><figcaption class="iw ix gj gh gi iy iz bd b be z dk translated">例子摘自:<a class="ae ja" href="https://github.com/brianvoe/gofakeit" rel="noopener ugc nofollow" target="_blank">https://github.com/brianvoe/gofakeit</a></figcaption></figure><h1 id="cc67" class="lf lg jd bd lh li nj lk ll lm nk lo lp lq nl ls lt lu nm lw lx ly nn ma mb mc bi translated">#5 Gock</h1><p id="5be1" class="pw-post-body-paragraph ka kb jd kc b kd md kf kg kh me kj kk kl mf kn ko kp mg kr ks kt mh kv kw kx ig bi translated"><strong class="kc je"><em class="mi">Gock</em></strong>(<a class="ae ja" href="https://github.com/h2non/gock" rel="noopener ugc nofollow" target="_blank">https://github.com/h2non/gock</a>)是一个针对 Golang 的 HTTP 服务器嘲讽和期望库，它的灵感很大程度上来自于其流行的和更老的等效物 NodeJs，名为<a class="ae ja" href="https://github.com/nock/nock" rel="noopener ugc nofollow" target="_blank"><strong class="kc je"><em class="mi">Nock</em></strong></a>。与<strong class="kc je"><em class="mi">Pact-go</em></strong>(<a class="ae ja" href="https://github.com/pact-foundation/pact-go" rel="noopener ugc nofollow" target="_blank">https://github.com/pact-foundation/pact-go</a>)不同，它是一个轻量级的解决方案，通过拦截任何<code class="fe no np nq nr b">http.Client</code>使用的<code class="fe no np nq nr b">http.DefaultTransport</code>或<code class="fe no np nq nr b">http.Transport</code>发出的请求来工作。</p><figure class="mp mq mr ms gt ip"><div class="bz fp l di"><div class="mt mu l"/></div><figcaption class="iw ix gj gh gi iy iz bd b be z dk translated">如何使用 Gock 的示例</figcaption></figure><h1 id="0fb1" class="lf lg jd bd lh li nj lk ll lm nk lo lp lq nl ls lt lu nm lw lx ly nn ma mb mc bi translated">#6 测试夹具</h1><p id="2410" class="pw-post-body-paragraph ka kb jd kc b kd md kf kg kh me kj kk kl mf kn ko kp mg kr ks kt mh kv kw kx ig bi translated"><strong class="kc je"><em class="mi">test fixtures</em></strong>(<a class="ae ja" href="https://github.com/go-testfixtures/testfixtures" rel="noopener ugc nofollow" target="_blank">https://github.com/go-testfixtures/testfixtures</a>)模仿了为数据库应用程序编写测试的<a class="ae ja" href="http://guides.rubyonrails.org/testing.html#the-test-database" rel="noopener ugc nofollow" target="_blank">“Ruby on Rails’way”</a>，其中样本数据保存在 fixtures 文件中。在执行每个测试之前，测试数据库被清理，夹具数据被加载到数据库中。以下是我如何在我的项目中使用的一个例子(详见<a class="ae ja" href="https://github.com/rafael-piovesan/go-rocket-ride" rel="noopener ugc nofollow" target="_blank">https://github.com/rafael-piovesan/go-rocket-ride</a>):</p><figure class="mp mq mr ms gt ip"><div class="bz fp l di"><div class="mt mu l"/></div><figcaption class="iw ix gj gh gi iy iz bd b be z dk translated">将测试夹具加载到 Postgres 实例中的实用程序代码</figcaption></figure><p id="d41b" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">此外，当与<strong class="kc je"><em class="mi">test containers-Go</em></strong>以及可选的任何迁移工具结合时，这是一个很好的匹配，因为您可以在您的测试中以编程方式编排所有这些工具，如下所示:</p><figure class="mp mq mr ms gt ip"><div class="bz fp l di"><div class="mt mu l"/></div><figcaption class="iw ix gj gh gi iy iz bd b be z dk translated">测试夹具样本文件</figcaption></figure><figure class="mp mq mr ms gt ip"><div class="bz fp l di"><div class="mt mu l"/></div><figcaption class="iw ix gj gh gi iy iz bd b be z dk translated">把所有东西放在一起</figcaption></figure><h1 id="99bd" class="lf lg jd bd lh li nj lk ll lm nk lo lp lq nl ls lt lu nm lw lx ly nn ma mb mc bi translated">#7 测试主要功能</h1><p id="6de7" class="pw-post-body-paragraph ka kb jd kc b kd md kf kg kh me kj kk kl mf kn ko kp mg kr ks kt mh kv kw kx ig bi translated">你有没有想过如何测试<code class="fe no np nq nr b">main</code>你的应用程序的功能？假设您想检查代码在缺少任何环境变量的情况下的行为。假设您至少有一个简单的日志来告诉我们发生了什么，一种可能的方法是实际检查您的应用程序的输出，并查找所述日志，就像这样(参见<a class="ae ja" href="https://github.com/rafael-piovesan/go-rocket-ride" rel="noopener ugc nofollow" target="_blank">https://github.com/rafael-piovesan/go-rocket-ride</a>的更多细节):</p><figure class="mp mq mr ms gt ip"><div class="bz fp l di"><div class="mt mu l"/></div></figure><h1 id="f3a6" class="lf lg jd bd lh li nj lk ll lm nk lo lp lq nl ls lt lu nm lw lx ly nn ma mb mc bi translated">#8 使用构建标签的独立测试</h1><p id="e7e6" class="pw-post-body-paragraph ka kb jd kc b kd md kf kg kh me kj kk kl mf kn ko kp mg kr ks kt mh kv kw kx ig bi translated">这个想法是根据类型(即单元、集成、冒烟和 e2e)或者任何其他你认为合适的标准来分离测试，因为我们使用的是 Go 的内置机制，叫做<a class="ae ja" href="https://pkg.go.dev/cmd/go#hdr-Build_constraints" rel="noopener ugc nofollow" target="_blank"> <strong class="kc je"> <em class="mi">构建约束</em> </strong> </a>，也就是众所周知的<strong class="kc je"> <em class="mi">构建标签</em> </strong>。您可以利用它的功能，在您的测试文件中有这样的内容:</p><figure class="mp mq mr ms gt ip"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="1bb0" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">然后，要选择您想要运行的测试，只需调用指定了<code class="fe no np nq nr b">-tags</code>标志的<code class="fe no np nq nr b">go test</code>命令:</p><pre class="mp mq mr ms gt ns nr nt nu aw nv bi"><span id="69cf" class="nw lg jd nr b gy nx ny l nz oa"># run all unit tests<br/>go test -tags=unit ./...</span><span id="6d2a" class="nw lg jd nr b gy ob ny l nz oa"># run only use case related tests<br/>go test -tags=usecase ./...</span></pre><h2 id="9bd3" class="nw lg jd bd lh oc od dn ll oe of dp lp kl og oh lt kp oi oj lx kt ok ol mb om bi translated">参考</h2><ul class=""><li id="e711" class="mv mw jd kc b kd md kh me kl on kp oo kt op kx na nb nc nd bi translated"><a class="ae ja" href="https://github.com/rafael-piovesan/go-rocket-ride" rel="noopener ugc nofollow" target="_blank">https://github.com/rafael-piovesan/go-rocket-ride</a></li><li id="e2ba" class="mv mw jd kc b kd ne kh nf kl ng kp nh kt ni kx na nb nc nd bi translated"><a class="ae ja" href="https://go.dev/doc/code#Testing" rel="noopener ugc nofollow" target="_blank">https://go.dev/doc/code#Testing</a></li><li id="297c" class="mv mw jd kc b kd ne kh nf kl ng kp nh kt ni kx na nb nc nd bi translated"><a class="ae ja" href="https://bmuschko.com/blog/go-testing-frameworks/" rel="noopener ugc nofollow" target="_blank">https://bmuschko.com/blog/go-testing-frameworks/</a></li><li id="0cbe" class="mv mw jd kc b kd ne kh nf kl ng kp nh kt ni kx na nb nc nd bi translated"><a class="ae ja" href="https://github.com/orlangure/gnomock" rel="noopener ugc nofollow" target="_blank">https://github.com/orlangure/gnomock</a></li><li id="a8eb" class="mv mw jd kc b kd ne kh nf kl ng kp nh kt ni kx na nb nc nd bi translated"><a class="ae ja" href="https://github.com/ory/dockertest" rel="noopener ugc nofollow" target="_blank">https://github.com/ory/dockertest</a></li><li id="adb3" class="mv mw jd kc b kd ne kh nf kl ng kp nh kt ni kx na nb nc nd bi translated"><a class="ae ja" href="https://github.com/testcontainers/testcontainers-go" rel="noopener ugc nofollow" target="_blank">https://github.com/testcontainers/testcontainers-go</a></li><li id="bbae" class="mv mw jd kc b kd ne kh nf kl ng kp nh kt ni kx na nb nc nd bi translated"><a class="ae ja" href="https://github.com/stretchr/testify" rel="noopener ugc nofollow" target="_blank">https://github.com/stretchr/testify</a></li><li id="e8e7" class="mv mw jd kc b kd ne kh nf kl ng kp nh kt ni kx na nb nc nd bi translated"><a class="ae ja" href="https://github.com/vektra/mockery" rel="noopener ugc nofollow" target="_blank">https://github.com/vektra/mockery</a></li><li id="a99f" class="mv mw jd kc b kd ne kh nf kl ng kp nh kt ni kx na nb nc nd bi translated"><a class="ae ja" href="https://github.com/brianvoe/gofakeit" rel="noopener ugc nofollow" target="_blank">https://github.com/brianvoe/gofakeit</a></li><li id="1955" class="mv mw jd kc b kd ne kh nf kl ng kp nh kt ni kx na nb nc nd bi translated"><a class="ae ja" href="https://github.com/h2non/gock" rel="noopener ugc nofollow" target="_blank">https://github.com/h2non/gock</a></li><li id="9c09" class="mv mw jd kc b kd ne kh nf kl ng kp nh kt ni kx na nb nc nd bi translated"><a class="ae ja" href="https://mickey.dev/posts/go-build-tags-testing/" rel="noopener ugc nofollow" target="_blank">https://mickey.dev/posts/go-build-tags-testing/</a></li></ul></div></div>    
</body>
</html>