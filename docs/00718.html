<html>
<head>
<title>Using fetch to update the database and DOM without refreshing the page</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 fetch 更新数据库和 DOM，而不刷新页面</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/using-fetch-to-update-the-database-and-dom-without-refreshing-the-page-3f05c343166b?source=collection_archive---------1-----------------------#2020-06-15">https://blog.devgenius.io/using-fetch-to-update-the-database-and-dom-without-refreshing-the-page-3f05c343166b?source=collection_archive---------1-----------------------#2020-06-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="4012" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在过去的一周里，我学习了如何使用 fetch 通过 JavaScript 操作 DOM。随着我的进展，我很难在不需要刷新页面的情况下，在页面和数据库中提交新数据或更新现有数据。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/e3fc4b4b4c08a5bbc7d9b11c5a85f7d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*LTmx0SmCEwvJFavW"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">亚历克斯·纪尧姆在<a class="ae lc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="3759" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我讨论我的解决方案之前，我想谈谈使用 fetch 的基础知识，这是我在学习中的经验。</p><p id="7903" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第一步是学习一个简单的 GET 请求，以 JSON 格式从数据库或端点接收信息。我使用 fetch 注释和所需的端点 URL 作为参数。这返回了一个 Promise“object”，我们需要将它转换成 JSON，然后根据需要进行处理。在本例中，我们将 console.log 放在控制台中查看:</p><pre class="kn ko kp kq gt ld le lf lg aw lh bi"><span id="8e44" class="li lj iq le b gy lk ll l lm ln">fetch("http://example.com/books.json")       // desired endpoint URL<br/>.then(response =&gt; response.json())       // convert response to JSON<br/>.then(json =&gt; console.log(json));      // console.log converted JSON</span></pre><p id="f782" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在理解了 GET 请求之后，我转到了 PATCH 和 POST，这允许我在 JSON 数据库中添加或更新条目。这需要向 fetch 命令添加第二个参数，它是一个<code class="fe lo lp lq le b">init</code>或<code class="fe lo lp lq le b">config object</code>，包含关于我们想要对 API 调用做什么的详细信息。</p><pre class="kn ko kp kq gt ld le lf lg aw lh bi"><span id="f003" class="li lj iq le b gy lk ll l lm ln">let configObject = {<br/>  method: "POST",                    // declares HTTP request method<br/>  headers: {<br/>    "Content-Type": "application/json"    // declares format of data<br/>  },<br/>  body: JSON.stringify(               // turns data into JSON string<br/>    {<br/>      "key": "value",              // keys and values we want to add<br/>      "key2": "value2"<br/>    }<br/>  )<br/>};</span></pre><p id="e173" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">综上所述，假设我们想要将一本书的“喜欢”更新为“5”。获取补丁请求可能如下所示:</p><pre class="kn ko kp kq gt ld le lf lg aw lh bi"><span id="51ef" class="li lj iq le b gy lk ll l lm ln">fetch("http://www.example.com/books/1", { // note we are going to /1<br/>  method: "PATCH",<br/>  headers: {<br/>      "Content-Type" : "application/json"<br/>    },<br/>  body: JSON.stringify(<br/>    {<br/>      "likes": 5           // we are changing the "likes" value to 5<br/>    }<br/>  )<br/>});</span></pre><p id="6164" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">非常好。现在我们已经更新了数据库，但我们还想更改页面上显示的赞数。让我们假设显示“4 个赞”的<code class="fe lo lp lq le b">&lt;span&gt;</code>有一个“已显示赞”的 id，即:<code class="fe lo lp lq le b">&lt;span id="likes-displayed"&gt;</code>。我们想要获取该元素，因此我们可以将它的<code class="fe lo lp lq le b">InnerText</code>值从“4 个喜欢”更改为“5 个喜欢”:</p><pre class="kn ko kp kq gt ld le lf lg aw lh bi"><span id="0f22" class="li lj iq le b gy lk ll l lm ln">let likesContainer = document.getElementById("likes-displayed");</span></pre><p id="7422" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，我们可以使用从补丁请求中获得的响应来更新这个变量的<code class="fe lo lp lq le b">innerText</code>!让我们添加上面的代码:</p><pre class="kn ko kp kq gt ld le lf lg aw lh bi"><span id="e498" class="li lj iq le b gy lk ll l lm ln">let likesContainer = document.getElementById("likes-displayed");</span><span id="6c4a" class="li lj iq le b gy lr ll l lm ln">fetch("http://www.example.com/books/1", {<br/>  method: "PATCH",<br/>  headers: {<br/>      "Content-Type" : "application/json"<br/>    },<br/>  body: JSON.stringify(<br/>    {<br/>      "likes": 5<br/>    }<br/>  )<br/>})<br/>.then(response =&gt; response.json())<br/>.then(json =&gt; {<br/>  likesContainer.innerText = `${json.likes} likes`;<br/>});</span></pre><p id="4f66" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以上，我们是:</p><ol class=""><li id="99f8" class="ls lt iq jp b jq jr ju jv jy lu kc lv kg lw kk lx ly lz ma bi translated">将 likesContainer 声明为变量，这是我们的 id 为<code class="fe lo lp lq le b">"likes-displayed"</code>的<code class="fe lo lp lq le b">&lt;span&gt;</code>，它内置在 HTML 中。</li><li id="1e4f" class="ls lt iq jp b jq mb ju mc jy md kc me kg mf kk lx ly lz ma bi translated">向<code class="fe lo lp lq le b"><a class="ae lc" href="http://www.example.com/books/1" rel="noopener ugc nofollow" target="_blank">http://www.example.com/books/1</a></code>发送获取请求</li><li id="37fc" class="ls lt iq jp b jq mb ju mc jy md kc me kg mf kk lx ly lz ma bi translated">指定我们要打补丁，即更新现有信息</li><li id="b830" class="ls lt iq jp b jq mb ju mc jy md kc me kg mf kk lx ly lz ma bi translated">指定我们发送的内容类型是 JSON</li><li id="cc40" class="ls lt iq jp b jq mb ju mc jy md kc me kg mf kk lx ly lz ma bi translated">指定新值，在本例中，将“likes”更新为 5。</li><li id="7af9" class="ls lt iq jp b jq mb ju mc jy md kc me kg mf kk lx ly lz ma bi translated">然后，我们获取响应，将其转换为 JSON，然后使用<code class="fe lo lp lq le b">json.likes</code>(现在是 5)的值来更新<code class="fe lo lp lq le b">likesContainer.innerText</code>的字符串值。</li></ol><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mg"><img src="../Images/f5b2d36b5d32cbca09b446233939c248.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NJwVR92EWecCdD_l"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated"><a class="ae lc" href="https://unsplash.com/@markkoenig?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">马克·柯尼希</a>在<a class="ae lc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="b4f1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">太棒了。fetch 和它的 config 对象更新数据库中的信息，或者使用响应 JSON 更新 DOM，这些都是在不刷新页面的情况下完成的，但是还有最后一个问题需要解决:我们需要一种动态增加 likes 的方法。目前，我们明确地将它改为“5”，但是我们怎样才能写得更动态，并且不管喜欢的数量是多少，都增加 1？</p><p id="6631" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们回到我们的<code class="fe lo lp lq le b">likesContainer</code>变量。我们可以用 JavaScript 做的一件很酷的事情是为变量创建属性。让我们尝试给 likesContainer 一个“potato”属性:</p><pre class="kn ko kp kq gt ld le lf lg aw lh bi"><span id="5ac2" class="li lj iq le b gy lk ll l lm ln">let likesContainer = document.getElementById("likes-displayed");</span><span id="9f48" class="li lj iq le b gy lr ll l lm ln">likesContainer.potato = "Holy potatoes!";</span><span id="e9de" class="li lj iq le b gy lr ll l lm ln">likesContainer.potato;<br/> // "Holy potatoes!"</span></pre><p id="374c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">天哪…好吧，回到我们的增量问题，让我们创建一个名为“likes”的自定义属性，以整数形式跟踪我们当前的赞数:</p><pre class="kn ko kp kq gt ld le lf lg aw lh bi"><span id="d9dd" class="li lj iq le b gy lk ll l lm ln">likesContainer.likes = 4;</span></pre><p id="1f69" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，让我们将上面的获取请求封装到一个函数中，以增加赞数。在这个函数中，在获取之前，让我们递增<code class="fe lo lp lq le b">.likes</code>属性。我们将使用<code class="fe lo lp lq le b">likesContainer.likes ++</code>，它的作用与<code class="fe lo lp lq le b">+= 1</code>相同，将当前值增加 1:</p><pre class="kn ko kp kq gt ld le lf lg aw lh bi"><span id="aa70" class="li lj iq le b gy lk ll l lm ln">let likesContainer = document.getElementById("likes-displayed");</span><span id="9dac" class="li lj iq le b gy lr ll l lm ln">function incrementLikes() {<br/>  likesContainer.likes ++;<br/>  fetch("http://www.example.com/books/1", {<br/>    method: "PATCH",<br/>    headers: {<br/>        "Content-Type" : "application/json"<br/>      },<br/>    body: JSON.stringify(<br/>      {<br/>        "likes": 5<br/>      }<br/>    )<br/>  })<br/>  .then(response =&gt; response.json())<br/>  .then(json =&gt; {<br/>    likesContainer.innerText = `${json.likes} likes`;<br/>  });<br/>}</span></pre><p id="0d88" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，让我们换出<code class="fe lo lp lq le b">"likes": 5</code>来使用<code class="fe lo lp lq le b">likesContainer.likes:</code>的当前值</p><pre class="kn ko kp kq gt ld le lf lg aw lh bi"><span id="c3a6" class="li lj iq le b gy lk ll l lm ln">let likesContainer = document.getElementById("likes-displayed");</span><span id="dec7" class="li lj iq le b gy lr ll l lm ln">function incrementLikes() {<br/>  likesContainer.likes ++;<br/>  fetch("http://www.example.com/books/1", {<br/>    method: "PATCH",<br/>    headers: {<br/>        "Content-Type" : "application/json"<br/>      },<br/>    body: JSON.stringify(<br/>      {<br/>        "likes": likesContainer.likes<br/>      }<br/>    )<br/>  })<br/>  .then(response =&gt; response.json())<br/>  .then(json =&gt; {<br/>    likesContainer.innerText = `${json.likes} likes`;<br/>  });<br/>}</span></pre><p id="f4c5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，当我们运行<code class="fe lo lp lq le b">incrementLikes</code>函数时，我们:</p><ol class=""><li id="75eb" class="ls lt iq jp b jq jr ju jv jy lu kc lv kg lw kk lx ly lz ma bi translated">将<code class="fe lo lp lq le b">likesContainer.likes</code>值增加 1</li><li id="f40a" class="ls lt iq jp b jq mb ju mc jy md kc me kg mf kk lx ly lz ma bi translated">使用 fetch 发送补丁请求，将<code class="fe lo lp lq le b">"likes"</code>的值更改为<code class="fe lo lp lq le b">likesContainer.likes</code>的当前值</li><li id="9bb2" class="ls lt iq jp b jq mb ju mc jy md kc me kg mf kk lx ly lz ma bi translated">使用包含来自数据库的更新的 JSON 信息的响应，更新<code class="fe lo lp lq le b">likesContainer.innerText</code>以表示新增加的值</li></ol><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/3c9141062b2cab76ede2c9241d2e3431.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*aV__WE_D_ut9YwoL"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">照片由<a class="ae lc" href="https://unsplash.com/@valentinjrl?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">瓦伦丁·乔雷尔</a>在<a class="ae lc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="aa14" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">哇，我们成功了！我们现在可以向我们的数据库<em class="kl">发布和修补更新的信息，并且</em>更新 DOM(页面)而不需要刷新！太棒了。</p></div></div>    
</body>
</html>