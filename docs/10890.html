<html>
<head>
<title>Integrate Kubernetes Models into KCL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将 Kubernetes 模型集成到 KCL 中</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/integrate-kubernetes-models-into-kcl-bb2d562ad81a?source=collection_archive---------21-----------------------#2022-12-05">https://blog.devgenius.io/integrate-kubernetes-models-into-kcl-bb2d562ad81a?source=collection_archive---------21-----------------------#2022-12-05</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><h1 id="0a79" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated"><strong class="ak">什么是 KCL </strong></h1><p id="b5de" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated"><a class="ae lg" href="https://github.com/KusionStack/KCLVM" rel="noopener ugc nofollow" target="_blank"> KCL (Kusion 配置语言)</a>是一种开源的基于约束的记录和函数语言。KCL 通过成熟的编程语言技术和实践，改进大量复杂配置的编写，致力于围绕配置构建更好的模块化、可扩展性和稳定性，逻辑编写更简单，自动化速度快，生态扩展性好。</p><p id="e4bb" class="pw-post-body-paragraph ki kj in kk b kl lh kn ko kp li kr ks kt lj kv kw kx lk kz la lb ll ld le lf ig bi translated">更多关于 KCL 的文件在 https://medium.com/p/f03ee820c7a4 的最后一个博客<a class="ae lg" href="https://medium.com/p/f03ee820c7a4" rel="noopener">和 KCL 网站</a><a class="ae lg" href="https://github.com/KusionStack/KCLVM" rel="noopener ugc nofollow" target="_blank">https://github.com/KusionStack/KCLVM</a></p><h1 id="6583" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">来自 Kubernetes</h1><h1 id="d65f" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">1.Kubernetes OpenAPI 规范<a class="ae lg" href="https://kcl-lang.github.io/docs/user_docs/guides/working-with-k8s/from_kubernetes#1-kubernetes-openapi-spec" rel="noopener ugc nofollow" target="_blank"> </a></h1><p id="c97b" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">从 Kubernetes 1.4 开始，引入了对 OpenAPI 规范的 alpha 支持(在捐赠给 OpenAPI 计划之前称为 Swagger 2.0)，API 描述遵循<a class="ae lg" href="https://github.com/OAI/OpenAPI-Specification/blob/main/versions/2.0.md" rel="noopener ugc nofollow" target="_blank"> OpenAPI 规范 2.0 </a>。而且从 Kubernetes 1.5 开始，Kubernetes 支持<a class="ae lg" href="https://github.com/kubernetes/kube-openapi" rel="noopener ugc nofollow" target="_blank">直接从源代码中提取模型，然后生成 OpenAPI 规范文件</a>，自动保持规范和文档与操作和模型保持最新。</p><p id="a27f" class="pw-post-body-paragraph ki kj in kk b kl lh kn ko kp li kr ks kt lj kv kw kx lk kz la lb ll ld le lf ig bi translated">此外，Kubernetes CRD 使用[open API v 3.0 validation](<a class="ae lg" href="https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/#validation" rel="noopener ugc nofollow" target="_blank">https://Kubernetes . io/docs/tasks/extend-Kubernetes/custom-resources/custom-resource-definitions/# validation</a>)来描述自定义模式(除了内置属性 apiVersion、Kind 和 metadata 之外)，APIServer 使用该模式在资源创建和更新阶段验证 CR。</p><h1 id="1ee0" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">2.KCL OpenAPI 支持<a class="ae lg" href="https://kcl-lang.github.io/docs/user_docs/guides/working-with-k8s/from_kubernetes#2-kcl-openapi-support" rel="noopener ugc nofollow" target="_blank"> </a></h1><p id="5df3" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated"><code class="fe lm ln lo lp b">kcl-openapi</code>工具支持从 Kubernetes OpenAPI/CRD 中提取和生成 KCL 模式。<a class="ae lg" href="https://kcl-lang.github.io/docs/tools/cli/openapi/spec" rel="noopener ugc nofollow" target="_blank"> KCL OpenAPI 规范</a>定义了 OpenAPI 规范和 KCL 语言特性之间的映射。有关该工具的快速入门，请参见<a class="ae lg" href="https://kcl-lang.github.io/docs/tools/cli/openapi/" rel="noopener ugc nofollow" target="_blank"> KCL OpenAPI 工具</a></p><h1 id="da08" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">3.从 Kubernetes 迁移到 KCL <a class="ae lg" href="https://kcl-lang.github.io/docs/user_docs/guides/working-with-k8s/from_kubernetes#3-migrate-from-kubernetes-to-kcl" rel="noopener ugc nofollow" target="_blank"> </a></h1><p id="af02" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">Kubernetes 内置模型的完整 OpenAPI 定义存储在<a class="ae lg" href="https://github.com/kubernetes/kubernetes/blob/master/api/openapi-spec/swagger.json" rel="noopener ugc nofollow" target="_blank"> Kubernetes OpenAPI-Spec 文件</a>中。以这个文件作为输入，KCL OpenAPI 工具可以生成相应版本的所有模型模式。在接下来的小节中，我们将以一个部署发布场景为例，介绍如何从 Kubernetes 迁移到 KCL。假设您的项目使用[Kubernetes Deployment](<a class="ae lg" href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/" rel="noopener ugc nofollow" target="_blank">https://Kubernetes . io/docs/concepts/workloads/controllers/Deployment/</a>)来定义部署配置，迁移到 KCL 只需要以下步骤:</p><h1 id="e6f9" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">3.1 根据型号<a class="ae lg" href="https://kcl-lang.github.io/docs/user_docs/guides/working-with-k8s/from_kubernetes#31-write-config-based-on-the-models" rel="noopener ugc nofollow" target="_blank"> </a>编写配置</h1><p id="b8f3" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们提供开箱即用的<code class="fe lm ln lo lp b">kusion_models</code>包供您快速启动。它包含一个精心设计的前端模型，名为<code class="fe lm ln lo lp b"><a class="ae lg" href="https://github.com/KusionStack/konfig/blob/main/base/pkg/kusion_models/kube/frontend/server.k" rel="noopener ugc nofollow" target="_blank">Server schema</a></code>。您可以通过初始化<code class="fe lm ln lo lp b">Server schema</code>来声明它们的配置。关于模式及其属性的描述和用法，请参考<a class="ae lg" href="https://kusionstack.io/docs/reference/model/kusion_models/kube/frontend/doc_server" rel="noopener ugc nofollow" target="_blank">服务器模式文档</a>。</p><h1 id="988c" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">3.2 构建您的自定义前端模型<a class="ae lg" href="https://kcl-lang.github.io/docs/user_docs/guides/working-with-k8s/from_kubernetes#32-build-your-custom-frontend-models" rel="noopener ugc nofollow" target="_blank"> </a></h1><p id="47cc" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">现有的 KCL 模型可能无法满足您的特定业务需求，那么您也可以设计自己的定制前端模型包。在<code class="fe lm ln lo lp b">kusion_kubernetes</code>目录中(<a class="ae lg" href="https://github.com/KusionStack/konfig/tree/main/base/pkg/kusion_kubernetes" rel="noopener ugc nofollow" target="_blank">https://github . com/KusionStack/konfig/tree/main/base/pkg/ku sion _ Kubernetes</a>)，有一份生成的 Kubernetes 1.22 模型的副本，你可以基于它设计你的定制模型。您还可以开发您的定制脚本来迁移您的配置数据，就像<code class="fe lm ln lo lp b">kube2kcl</code>工具所做的那样。</p><h2 id="4098" class="lq jl in bd jm lr ls dn jq lt lu dp ju kt lv lw jy kx lx ly kc lb lz ma kg mb bi translated">3.2.1 将 Kubernetes 部署转换成 KCL 模式<a class="ae lg" href="https://kcl-lang.github.io/docs/user_docs/guides/working-with-k8s/from_kubernetes#321-convert-kubernetes-deployment-into-kcl-schema" rel="noopener ugc nofollow" target="_blank"> </a></h2><p id="e3cf" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">在 Konfig 存储库中的<code class="fe lm ln lo lp b">base/pkg/kusion_kubernetes</code>目录下，我们已经有了一个<a class="ae lg" href="https://github.com/kcl-lang/konfig/blob/main/base/pkg/kusion_kubernetes/api/apps/v1/deployment.k" rel="noopener ugc nofollow" target="_blank">生成的 Kubernetes 1.22 模型</a>的副本。您可以跳过这一步，使用现有的模型，或者如果需要，您可以生成其他版本的模型。</p><p id="3c97" class="pw-post-body-paragraph ki kj in kk b kl lh kn ko kp li kr ks kt lj kv kw kx lk kz la lb ll ld le lf ig bi translated">现在让我们生成一个 1.23 版本的 Kubernetes 模型。从<a class="ae lg" href="https://github.com/kubernetes/kubernetes/blob/release-1.23/api/openapi-spec/swagger.json" rel="noopener ugc nofollow" target="_blank">Kubernetes v 1.23 open API Spec</a>中，我们可以找到<code class="fe lm ln lo lp b">apps/v1.Deployment</code>模型的定义，以下是部分摘录:</p><pre class="mc md me mf gt mg lp mh bn mi mj bi"><span id="7cc4" class="mk jl in lp b be ml mm l mn mo">{<br/>    "definitions": {<br/>        "io.k8s.api.apps.v1.Deployment": {<br/>            "description": "Deployment enables declarative updates for Pods and ReplicaSets.",<br/>            "properties": {<br/>                "apiVersion": {<br/>                    "description": "APIVersion defines the versioned schema of this representation of an object. Servers should convert recognized schemas to the latest internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources",<br/>                    "type": "string"<br/>                },<br/>                "kind": {<br/>                    "description": "Kind is a string value representing the REST resource this object represents. Servers may infer this from the endpoint the client submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds",<br/>                    "type": "string"<br/>                },<br/>                "metadata": {<br/>                    "$ref": "#/definitions/io.k8s.apimachinery.pkg.apis.meta.v1.ObjectMeta",<br/>                    "description": "Standard object's metadata. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata"<br/>                },<br/>                "spec": {<br/>                    "$ref": "#/definitions/io.k8s.api.apps.v1.DeploymentSpec",<br/>                    "description": "Specification of the desired behavior of the Deployment."<br/>                },<br/>                "status": {<br/>                    "$ref": "#/definitions/io.k8s.api.apps.v1.DeploymentStatus",<br/>                    "description": "Most recently observed status of the Deployment."<br/>                }<br/>            },<br/>            "type": "object",<br/>            "x-kubernetes-group-version-kind": [<br/>                {<br/>                    "group": "apps",<br/>                    "kind": "Deployment",<br/>                    "version": "v1"<br/>                }<br/>            ]<br/>        }<br/>    },<br/>    "info": {<br/>        "title": "Kubernetes",<br/>        "version": "unversioned"<br/>    },<br/>    "paths": {},<br/>    "swagger": "2.0"<br/>}</span></pre><p id="3b4b" class="pw-post-body-paragraph ki kj in kk b kl lh kn ko kp li kr ks kt lj kv kw kx lk kz la lb ll ld le lf ig bi translated">您可以将上面的规范保存为<code class="fe lm ln lo lp b">deployment.json</code>并运行<code class="fe lm ln lo lp b">kcl-openapi generate model -f deployment.json</code>，KCL 模式将会生成并输出到您当前的工作区。其他 Kubernetes 模型也可以保存在这个 spec 文件中，并且可以类似地生成。</p><h2 id="50c1" class="lq jl in bd jm lr ls dn jq lt lu dp ju kt lv lw jy kx lx ly kc lb lz ma kg mb bi translated">3.2.2 设计定制前端型号<a class="ae lg" href="https://kcl-lang.github.io/docs/user_docs/guides/working-with-k8s/from_kubernetes#322-design-custom-frontend-models" rel="noopener ugc nofollow" target="_blank"> </a></h2><p id="a7f3" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">由于 Kubernetes 内置模型是原子性的，对初学者来说有点复杂，我们建议将 Kubernetes 的本机模型作为后端输出模型，并设计一批前端模型，这些模型可以成为更抽象、更友好和更简单的用户界面。可以参考<code class="fe lm ln lo lp b"><a class="ae lg" href="https://github.com/kcl-lang/konfig/blob/main/base/pkg/kusion_models/kube/frontend/server.k" rel="noopener ugc nofollow" target="_blank">Server Schema in the Konfig repo</a></code>中的设计模式。</p><h2 id="fe2b" class="lq jl in bd jm lr ls dn jq lt lu dp ju kt lv lw jy kx lx ly kc lb lz ma kg mb bi translated">3.2.3 迁移配置数据<a class="ae lg" href="https://kcl-lang.github.io/docs/user_docs/guides/working-with-k8s/from_kubernetes#323-migrate-the-configuration-data" rel="noopener ugc nofollow" target="_blank"> </a></h2><p id="db17" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">您可以开发自定义脚本来自动迁移配置数据。KCL 稍后将为这个脚本提供编写框架和编写指南。</p><h1 id="77d2" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">4.从库伯内斯迁移到 CRD <a class="ae lg" href="https://kcl-lang.github.io/docs/user_docs/guides/working-with-k8s/from_kubernetes#4-migrate-from-kubernetes-crd" rel="noopener ugc nofollow" target="_blank"> </a></h1><p id="482e" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">如果您开发了 CRDs，那么您可以生成 CRD 模式的 KCL 版本，并在此基础上声明 CRs。</p><ul class=""><li id="e9d6" class="mp mq in kk b kl lh kp li kt mr kx ms lb mt lf mu mv mw mx bi translated">从 CRD 生成 KCL 模式</li></ul><pre class="mc md me mf gt mg lp mh bn mi mj bi"><span id="c76a" class="mk jl in lp b be ml mm l mn mo">kcl-openapi generate model --crd --skip-validation -f &lt;your_crd.yaml&gt;</span></pre><h1 id="9004" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">5.CRD 至 KCL 示例</h1><ul class=""><li id="9296" class="mp mq in kk b kl km kp kq kt my kx mz lb na lf mu mv mw mx bi translated">命令</li></ul><pre class="mc md me mf gt mg lp mh bn mi mj bi"><span id="2bbc" class="mk jl in lp b be ml mm l mn mo">kcl-openapi generate model --crd -f ${your_CRD.yaml} -t ${the_kcl_files_output_di} --skip-validation</span></pre><ul class=""><li id="377e" class="mp mq in kk b kl lh kp li kt mr kx ms lb mt lf mu mv mw mx bi translated">test_crontab_CRD.yaml:</li></ul><pre class="mc md me mf gt mg lp mh bn mi mj bi"><span id="aa69" class="mk jl in lp b be ml mm l mn mo"># Deprecated in v1.16 in favor of apiextensions.k8s.io/v1<br/>apiVersion: apiextensions.k8s.io/v1beta1<br/>kind: CustomResourceDefinition<br/>metadata:<br/>  # name must match the spec fields below, and be in the form: &lt;plural&gt;.&lt;group&gt;<br/>  name: crontabs.stable.example.com<br/>spec:<br/>  # group name to use for REST API: /apis/&lt;group&gt;/&lt;version&gt;<br/>  group: stable.example.com<br/>  # list of versions supported by this CustomResourceDefinition<br/>  versions:<br/>    - name: v1<br/>      # Each version can be enabled/disabled by Served flag.<br/>      served: true<br/>      # One and only one version must be marked as the storage version.<br/>      storage: true<br/>  # either Namespaced or Cluster<br/>  scope: Namespaced<br/>  names:<br/>    # plural name to be used in the URL: /apis/&lt;group&gt;/&lt;version&gt;/&lt;plural&gt;<br/>    plural: crontabs<br/>    # singular name to be used as an alias on the CLI and for display<br/>    singular: crontab<br/>    # kind is normally the CamelCased singular type. Your resource manifests use this.<br/>    kind: CronTab<br/>    # shortNames allow shorter string to match your resource on the CLI<br/>    shortNames:<br/>      - ct<br/>  preserveUnknownFields: false<br/>  validation:<br/>    openAPIV3Schema:<br/>      type: object<br/>      properties:<br/>        spec:<br/>          type: object<br/>          properties:<br/>            cronSpec:<br/>              type: string<br/>            image:<br/>              type: string<br/>            replicas:<br/>              type: integer</span></pre><ul class=""><li id="9ef2" class="mp mq in kk b kl lh kp li kt mr kx ms lb mt lf mu mv mw mx bi translated">命令</li></ul><pre class="mc md me mf gt mg lp mh bn mi mj bi"><span id="7410" class="mk jl in lp b be ml mm l mn mo">kcl-openapi generate model -f test_crontab_CRD.yaml -t ~/ --skip-validation --crd</span></pre><ul class=""><li id="f955" class="mp mq in kk b kl lh kp li kt mr kx ms lb mt lf mu mv mw mx bi translated">output ` ~/models/stable _ example _ com _ v1 _ cron _ tab . k '</li></ul><pre class="mc md me mf gt mg lp mh bn mi mj bi"><span id="f23a" class="mk jl in lp b be ml mm l mn mo">"""<br/>This file was generated by the KCL auto-gen tool. DO NOT EDIT.<br/>Editing this file might prove futile when you re-run the KCL auto-gen generate command.<br/>"""<br/>import kusion_kubernetes.apimachinery.apis<br/><br/>schema CronTab:<br/>    """stable example com v1 cron tab<br/>    Attributes<br/>    ----------<br/>    __settings__ : {str:str}, default is {"output_type": "STANDALONE"}, optional<br/>         existence of this attribute indicates that the model will be treated standalone by KCLVM.<br/>    apiVersion : str, default is "stable.example.com/v1", required<br/>         APIVersion defines the versioned schema of this representation of an object. Servers should convert recognized schemas to the latest internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources<br/>    kind : str, default is "CronTab", required<br/>         Kind is a string value representing the REST resource this object represents. Servers may infer this from the endpoint the client submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds<br/>    metadata : apis.ObjectMeta, default is Undefined, optional<br/>        metadata<br/>    spec : StableExampleComV1CronTabSpec, default is Undefined, optional<br/>        spec<br/>    """<br/><br/>    apiVersion: "stable.example.com/v1" = "stable.example.com/v1"<br/>    kind: "CronTab" = "CronTab"<br/>    metadata?: apis.ObjectMeta<br/>    spec?: StableExampleComV1CronTabSpec<br/><br/>schema StableExampleComV1CronTabSpec:<br/>    """stable example com v1 cron tab spec<br/>    Attributes<br/>    ----------<br/>    cronSpec : str, default is Undefined, optional<br/>        cron spec<br/>    image : str, default is Undefined, optional<br/>        image<br/>    replicas : int, default is Undefined, optional<br/>        replicas<br/>    """<br/><br/>    cronSpec?: str<br/>    image?: str<br/>    replicas?: int</span></pre><h1 id="77db" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">然后</h1><p id="bf8c" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">更多信息，请访问(如果你喜欢，你可以开始，谢谢😊):</p><ul class=""><li id="7b2a" class="mp mq in kk b kl lh kp li kt mr kx ms lb mt lf mu mv mw mx bi translated">KCL:【https://github.com/KusionStack/KCLVM T4】</li><li id="c801" class="mp mq in kk b kl nb kp nc kt nd kx ne lb nf lf mu mv mw mx bi translated">库辛:<a class="ae lg" href="https://github.com/KusionStack/kusion" rel="noopener ugc nofollow" target="_blank">https://github.com/KusionStack/kusion</a></li><li id="1dfb" class="mp mq in kk b kl nb kp nc kt nd kx ne lb nf lf mu mv mw mx bi translated">konfig:<a class="ae lg" href="https://github.com/KusionStack/Konfig" rel="noopener ugc nofollow" target="_blank">https://github.com/KusionStack/Konfig</a></li></ul><p id="1775" class="pw-post-body-paragraph ki kj in kk b kl lh kn ko kp li kr ks kt lj kv kw kx lk kz la lb ll ld le lf ig bi translated">欢迎加入我们的交流社区:</p><ul class=""><li id="9401" class="mp mq in kk b kl lh kp li kt mr kx ms lb mt lf mu mv mw mx bi translated"><a class="ae lg" href="https://github.com/KusionStack/community" rel="noopener ugc nofollow" target="_blank">https://github.com/KusionStack/community</a></li></ul></div></div>    
</body>
</html>