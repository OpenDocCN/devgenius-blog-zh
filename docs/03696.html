<html>
<head>
<title>How to force change App Language programmatically without breaking your app</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在不破坏应用程序的情况下，以编程方式强制更改应用程序语言</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/how-to-force-change-app-language-programmatically-without-breaking-your-app-1c73be9608e0?source=collection_archive---------0-----------------------#2020-12-05">https://blog.devgenius.io/how-to-force-change-app-language-programmatically-without-breaking-your-app-1c73be9608e0?source=collection_archive---------0-----------------------#2020-12-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="dee3" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">鉴于你的应用程序支持多种本地化，当我们在iOS 13和14中强制设置<code class="fe kf kg kh ki b">UserDefaults </code>键“AppleLanguage”及其副作用时，我们也应该小心</h2></div><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/9101bf8c673254a066689609eca1ceff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*oGZfTC1A8vRLQWdp"/></div></div><figcaption class="kv kw gj gh gi kx ky bd b be z dk translated">照片由<a class="ae kz" href="https://unsplash.com/@greg_rosenke?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">格雷格·罗森克</a>在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure></div><div class="ab cl la lb hu lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ij ik il im in"><h1 id="b7a4" class="lh li iq bd lj lk ll lm ln lo lp lq lr jw ls jx lt jz lu ka lv kc lw kd lx ly bi translated">设置应用程序语言的方法数量</h1><ol class=""><li id="8641" class="lz ma iq mb b mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">设置<code class="fe kf kg kh ki b">UserDefaults</code>键<strong class="mb ir">苹果语言</strong>(单数)</li><li id="b8ba" class="lz ma iq mb b mc mr me ms mg mt mi mu mk mv mm mn mo mp mq bi translated">设置<code class="fe kf kg kh ki b">UserDefaults</code>键<strong class="mb ir"> AppleLanguages </strong>(复数)<strong class="mb ir"> (Apple PreferredLanguages数组)</strong></li><li id="9021" class="lz ma iq mb b mc mr me ms mg mt mi mu mk mv mm mn mo mp mq bi translated">创建自定义<code class="fe kf kg kh ki b">AppLanguageManager</code></li></ol></div><div class="ab cl la lb hu lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ij ik il im in"><h1 id="3400" class="lh li iq bd lj lk ll lm ln lo lp lq lr jw ls jx lt jz lu ka lv kc lw kd lx ly bi translated">安装</h1><p id="b93e" class="pw-post-body-paragraph mw mx iq mb b mc md jr my me mf ju mz mg na nb nc mi nd ne nf mk ng nh ni mm ij bi translated">在我们开始研究设置应用程序语言的每种方法之前，我们需要一些助手函数，这些函数在所有这些方法中都是相同的。</p><blockquote class="nj nk nl"><p id="4f2d" class="mw mx nm mb b mc nn jr my me no ju mz np nq nb nc nr ns ne nf nt nu nh ni mm ij bi translated">注意:这个扩展只是为了这个演示，在iOS社区中你会发现很多不错的助手扩展</p></blockquote><ul class=""><li id="bded" class="lz ma iq mb b mc nn me no mg nv mi nw mk nx mm ny mo mp mq bi translated"><strong class="mb ir">捆绑扩展</strong></li></ul><figure class="kk kl km kn gt ko"><div class="bz fp l di"><div class="nz oa l"/></div></figure></div><div class="ab cl la lb hu lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ij ik il im in"><h1 id="babf" class="lh li iq bd lj lk ll lm ln lo lp lq lr jw ls jx lt jz lu ka lv kc lw kd lx ly bi translated">1.设置<code class="fe kf kg kh ki b">UserDefaults</code>键<strong class="ak">苹果语言</strong></h1><pre class="kk kl km kn gt ob ki oc od aw oe bi"><span id="b65f" class="of li iq ki b gy og oh l oi oj">let lang = "th"<br/>let defaults = UserDefaults.standard<br/>defaults.set(lang, forKey: "AppleLanguage")<br/>defaults.synchronize()<br/>Bundle.setLanguage(lang)<br/>// Restart your app by setting window rootViewcontroller</span></pre><h1 id="eccb" class="lh li iq bd lj lk ok lm ln lo ol lq lr jw om jx lt jz on ka lv kc oo kd lx ly bi translated">优势</h1><ol class=""><li id="adc8" class="lz ma iq mb b mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">没有副作用。</li><li id="8a8c" class="lz ma iq mb b mc mr me ms mg mt mi mu mk mv mm mn mo mp mq bi translated">你可以在你的应用程序中添加功能，让用户选择应用程序语言，而不是改变系统语言，然后看到结果，这对用户来说是一个不错的UX。</li></ol><h1 id="1fd3" class="lh li iq bd lj lk ok lm ln lo ol lq lr jw om jx lt jz on ka lv kc oo kd lx ly bi translated">不足之处</h1><ol class=""><li id="2a78" class="lz ma iq mb b mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">每次启动应用程序时，您必须设置最后一个应用程序语言代码以保存语言设置，为此，您必须将语言代码保存在另一个<code class="fe kf kg kh ki b">UserDefaults</code>键中。</li><li id="390a" class="lz ma iq mb b mc mr me ms mg mt mi mu mk mv mm mn mo mp mq bi translated">您的应用程序不会改变或检测到操作系统或系统语言的变化，但让我们从用户的角度考虑这是不太可能发生的。</li></ol></div><div class="ab cl la lb hu lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ij ik il im in"><h1 id="cee5" class="lh li iq bd lj lk ll lm ln lo lp lq lr jw ls jx lt jz lu ka lv kc lw kd lx ly bi translated">2.设置<code class="fe kf kg kh ki b">UserDefaults</code>键“<strong class="ak">苹果语言</strong> s”(首选语言)</h1><p id="8fc6" class="pw-post-body-paragraph mw mx iq mb b mc md jr my me mf ju mz mg na nb nc mi nd ne nf mk ng nh ni mm ij bi translated">还有其他几种类似的方法来强制设置应用程序语言，让我们考虑一下basic one。此外，本文的目的是了解这样做的副作用。</p><p id="8973" class="pw-post-body-paragraph mw mx iq mb b mc nn jr my me no ju mz mg nq nb nc mi ns ne nf mk nu nh ni mm ij bi translated">当你使用下面这段代码时，你的应用语言会发生变化，在这种情况下是泰语。</p><pre class="kk kl km kn gt ob ki oc od aw oe bi"><span id="90ce" class="of li iq ki b gy og oh l oi oj">let lang = "th"<br/>let defaults = UserDefaults.standard<br/>defaults.set([lang], forKey: "AppleLanguages")<br/>defaults.synchronize()<br/>Bundle.setLanguage(lang)<br/>// Restart your app by setting window rootViewcontroller</span></pre></div><div class="ab cl la lb hu lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ij ik il im in"><h1 id="818c" class="lh li iq bd lj lk ll lm ln lo lp lq lr jw ls jx lt jz lu ka lv kc lw kd lx ly bi translated">优势</h1><ol class=""><li id="2084" class="lz ma iq mb b mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">您没有在应用启动时设置语言代码</li><li id="353e" class="lz ma iq mb b mc mr me ms mg mt mi mu mk mv mm mn mo mp mq bi translated">你不需要像我们在前一个键中那样在其他键中保存语言代码</li><li id="7432" class="lz ma iq mb b mc mr me ms mg mt mi mu mk mv mm mn mo mp mq bi translated">你可以在你的应用程序中添加功能，让用户选择应用程序语言，而不是改变系统语言，然后看到结果，这对用户来说是一个不错的UX。</li></ol><h1 id="2649" class="lh li iq bd lj lk ok lm ln lo ol lq lr jw om jx lt jz on ka lv kc oo kd lx ly bi translated">不足之处</h1><p id="fdf4" class="pw-post-body-paragraph mw mx iq mb b mc md jr my me mf ju mz mg na nb nc mi nd ne nf mk ng nh ni mm ij bi translated">以下是一些主要问题</p><ol class=""><li id="d19e" class="lz ma iq mb b mc nn me no mg nv mi nw mk nx mm mn mo mp mq bi translated">您的应用程序不会改变或检测到操作系统或系统语言的变化，但让我们从用户的角度考虑这是不太可能发生的。</li><li id="9cd4" class="lz ma iq mb b mc mr me ms mg mt mi mu mk mv mm mn mo mp mq bi translated">严重的日期格式副作用。(<strong class="mb ir"/></li></ol><p id="0649" class="pw-post-body-paragraph mw mx iq mb b mc nn jr my me no ju mz mg nq nb nc mi ns ne nf mk nu nh ni mm ij bi translated">这一点很重要，假设你的应用程序使用<code class="fe kf kg kh ki b">DateFormatter</code>将日期从字符串转换过来，这就出现了一个大问题，因为现在事情开始变得奇怪了</p><p id="ec75" class="pw-post-body-paragraph mw mx iq mb b mc nn jr my me no ju mz mg nq nb nc mi ns ne nf mk nu nh ni mm ij bi translated">假设您将应用程序语言设置为"<strong class="mb ir"> th </strong> "( <strong class="mb ir">泰语</strong>)，当前系统日历设置为"<strong class="mb ir">公历"</strong>"，现在您正在尝试一个简单的任务，用<code class="fe kf kg kh ki b">DateFormatter</code>从字符串中获取日期，让我们看看输出</p><blockquote class="nj nk nl"><p id="a5f2" class="mw mx nm mb b mc nn jr my me no ju mz np nq nb nc nr ns ne nf nt nu nh ni mm ij bi translated">注意:你会发现泰国的用户同时使用“公历”和“佛教历”</p></blockquote><pre class="kk kl km kn gt ob ki oc od aw oe bi"><span id="be91" class="of li iq ki b gy og oh l oi oj">let format = <!-- -->DateFormatter()<br/>print(format.date(from: "2020-11-22"))</span><span id="ac41" class="of li iq ki b gy op oh l oi oj">// Output<br/>1477-11-22 // Weird</span></pre><p id="2c8a" class="pw-post-body-paragraph mw mx iq mb b mc nn jr my me no ju mz mg nq nb nc mi ns ne nf mk nu nh ni mm ij bi translated">我不确定为什么会给出错误的日历，因为这个苹果API的结果因操作系统而异。但这是促使我思考深入这个问题的主要原因。</p><p id="7682" class="pw-post-body-paragraph mw mx iq mb b mc nn jr my me no ju mz mg nq nb nc mi ns ne nf mk nu nh ni mm ij bi translated">以下是打印以下属性时的输出</p><ol class=""><li id="0157" class="lz ma iq mb b mc nn me no mg nv mi nw mk nx mm mn mo mp mq bi translated"><code class="fe kf kg kh ki b">Locale.current</code>它给你一个<strong class="mb ir"> th </strong>作为标识符</li><li id="ed19" class="lz ma iq mb b mc mr me ms mg mt mi mu mk mv mm mn mo mp mq bi translated"><code class="fe kf kg kh ki b">Calendar.current.dictionary?[“identifier”]</code>它给了你<strong class="mb ir">佛教</strong>，即使你用的是<strong class="mb ir">公历</strong>日历</li></ol><p id="9dcc" class="pw-post-body-paragraph mw mx iq mb b mc nn jr my me no ju mz mg nq nb nc mi ns ne nf mk nu nh ni mm ij bi translated">现在你可能会说，我们可以设置<code class="fe kf kg kh ki b">DateFormatter</code>的区域设置、时区和其他属性，并获得所需的输出，但从用户的角度来看，使用系统区域设置、日历和其他属性，而不是硬编码这些属性，这是一个很好的实践，而且如果你的应用程序针对使用不止一个日历的国家进行了本地化，这也是一个巨大的副作用。</p></div><div class="ab cl la lb hu lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ij ik il im in"><h1 id="8a4f" class="lh li iq bd lj lk ll lm ln lo lp lq lr jw ls jx lt jz lu ka lv kc lw kd lx ly bi translated">3.创建自定义<code class="fe kf kg kh ki b">AppLanguageManager</code></h1><p id="8438" class="pw-post-body-paragraph mw mx iq mb b mc md jr my me mf ju mz mg na nb nc mi nd ne nf mk ng nh ni mm ij bi translated">为此，我们需要以下东西</p><ol class=""><li id="f492" class="lz ma iq mb b mc nn me no mg nv mi nw mk nx mm mn mo mp mq bi translated"><code class="fe kf kg kh ki b">AppLanguageManager</code>维护当前语言和包路径的类。</li><li id="1ac5" class="lz ma iq mb b mc mr me ms mg mt mi mu mk mv mm mn mo mp mq bi translated">在<code class="fe kf kg kh ki b">UserDefaults</code>中设置语言代码，以保留上次保存的语言，当应用程序重启或重新启动时，我们会显示更新的语言</li><li id="0f44" class="lz ma iq mb b mc mr me ms mg mt mi mu mk mv mm mn mo mp mq bi translated">获取当前语言本地化字符串的帮助函数</li></ol><h1 id="b8fa" class="lh li iq bd lj lk ok lm ln lo ol lq lr jw om jx lt jz on ka lv kc oo kd lx ly bi translated">我们开始吧</h1><ol class=""><li id="df01" class="lz ma iq mb b mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">下面是<code class="fe kf kg kh ki b">AppLanguageManager</code>代码，它将保持当前语言和包路径，它也有助于在<code class="fe kf kg kh ki b">UserDefaults</code>中设置语言代码，以保留上次保存的语言。</li></ol><figure class="kk kl km kn gt ko"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="e683" class="pw-post-body-paragraph mw mx iq mb b mc nn jr my me no ju mz mg nq nb nc mi ns ne nf mk nu nh ni mm ij bi translated">2.获取本地化字符串的助手<code class="fe kf kg kh ki b">String</code>扩展</p><pre class="kk kl km kn gt ob ki oc od aw oe bi"><span id="135f" class="of li iq ki b gy og oh l oi oj">extension String {<br/>        fileprivate func localized(bundle: Bundle = AppLanguageManager.shared.bundle, tableName: String = "Localizable") -&gt; String {<br/>        return NSLocalizedString(self,<br/>                                 tableName: tableName,<br/>                                 bundle: bundle,<br/>                                 comment: "")<br/>    }<br/>}</span></pre><p id="2ee6" class="pw-post-body-paragraph mw mx iq mb b mc nn jr my me no ju mz mg nq nb nc mi ns ne nf mk nu nh ni mm ij bi translated">3.助手<code class="fe kf kg kh ki b">Localizable</code> propertyWrapper和<code class="fe kf kg kh ki b">Strings</code> enum</p><pre class="kk kl km kn gt ob ki oc od aw oe bi"><span id="88ab" class="of li iq ki b gy og oh l oi oj">@propertyWrapper<br/>struct Localizable {<br/> private let key: String<br/> var wrappedValue: String {<br/>      return key.localized()<br/> }</span><span id="23e6" class="of li iq ki b gy op oh l oi oj"> init(wrappedValue: String) {<br/>   key = wrappedValue<br/> }<br/>}</span><span id="7b75" class="of li iq ki b gy op oh l oi oj">enum Strings {                         <br/>  @Localizable static var featureOneTitle = "featureOneTitle"                               <br/>  @Localizable static var featureTwoTitle = "featureTwoTitle"                       }</span></pre><p id="1212" class="pw-post-body-paragraph mw mx iq mb b mc nn jr my me no ju mz mg nq nb nc mi ns ne nf mk nu nh ni mm ij bi translated">这一切帮助我们消除了对AppleLanguage <code class="fe kf kg kh ki b">UserDefaults</code>键的依赖，并且更加灵活和可伸缩，没有任何副作用。</p><h1 id="a008" class="lh li iq bd lj lk ok lm ln lo ol lq lr jw om jx lt jz on ka lv kc oo kd lx ly bi translated">最终产量和用途</h1><pre class="kk kl km kn gt ob ki oc od aw oe bi"><span id="b4a2" class="of li iq ki b gy og oh l oi oj">print("\(Strings.featureOneTitle)")<br/>// Output in current app language set in this case english<br/>featureOneTitle</span></pre></div><div class="ab cl la lb hu lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ij ik il im in"><h1 id="3609" class="lh li iq bd lj lk ll lm ln lo lp lq lr jw ls jx lt jz lu ka lv kc lw kd lx ly bi translated"><strong class="ak">结论</strong></h1><p id="3fd1" class="pw-post-body-paragraph mw mx iq mb b mc md jr my me mf ju mz mg na nb nc mi nd ne nf mk ng nh ni mm ij bi translated">我相信，如果我们试图用黑客来解决问题，总会有不利的一面。</p><p id="5e1e" class="pw-post-body-paragraph mw mx iq mb b mc nn jr my me no ju mz mg nq nb nc mi ns ne nf mk nu nh ni mm ij bi translated">设置<code class="fe kf kg kh ki b">UserDefaults</code><strong class="mb ir">“apple language”</strong>和<strong class="mb ir">apple language</strong>键对我来说感觉不太对，在最近的iOS版本中也有自己的缺点。</p><p id="d8d5" class="pw-post-body-paragraph mw mx iq mb b mc nn jr my me no ju mz mg nq nb nc mi ns ne nf mk nu nh ni mm ij bi translated">此外，如果您使用<code class="fe kf kg kh ki b">UserDefaults</code> <strong class="mb ir">“苹果语言”</strong>和“<strong class="mb ir">苹果语言</strong>”键在您的应用程序中实现了语言更改功能，如果您发现除了<strong class="mb ir">日期</strong>之外的任何其他问题，请在本文回复部分告诉我。</p><p id="c21b" class="pw-post-body-paragraph mw mx iq mb b mc nn jr my me no ju mz mg nq nb nc mi ns ne nf mk nu nh ni mm ij bi translated">感谢您的阅读。希望这篇文章能帮助你制作自己的定制语言管理器。</p></div></div>    
</body>
</html>