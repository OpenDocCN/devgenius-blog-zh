<html>
<head>
<title>Secure Your APIs with Firebase + AWS API Gateway</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Firebase + AWS API Gateway保护您的API</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/secure-your-apis-with-firebase-aws-api-gateway-199b1eda1da3?source=collection_archive---------0-----------------------#2020-09-30">https://blog.devgenius.io/secure-your-apis-with-firebase-aws-api-gateway-199b1eda1da3?source=collection_archive---------0-----------------------#2020-09-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="bd4b" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">轻松保护API</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/d371779b90e3859a77c90e7cec638f35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Z5aBA_DTjRD2UebQ"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">Georg Bommeli 在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="2a23" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi ls translated"><span class="l lt lu lv bm lw lx ly lz ma di"> A </span> <strong class="ky ir"> PI </strong>近年来被誉为一个新的利润丰厚的渠道，许多公司通过API公开他们的服务来赚钱。由于数字应用和大数据的激增，API如今在交付令人惊叹的功能方面发挥着至关重要的作用。虽然商业案例是API成功的关键，但是安全性是最重要的。如果没有适当的安全保护，API将是一个灾难，导致无休止的诉讼和严重违反安全的巨额罚款。</p><p id="2864" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">什么是API？</strong></p><p id="d9f2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">应用程序接口用于计算机系统之间的通信。API本身并不能为最终用户提供价值，而是客户端应用程序使用多个API来提供有意义的业务功能。一般来说，移动应用程序是典型的例子，它们依靠API与后端系统通信，以进行数据检索和请求提交。许多创业公司提供API作为服务，如通过人工智能分析提供实时股市数据。</p><p id="5fcd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">什么问题？</strong></p><p id="3c37" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">尽管安全保护很重要，但是许多API开发者为了节省更多的时间在业务功能上，跳过了安全控制或者仅仅构建了一个简单的保护。事实上，API保护的实现可以简单地通过设置API网关和认证服务等基础设施组件来完成，而开发人员仍然可以专注于业务功能的开发。</p></div><div class="ab cl mb mc hu md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ij ik il im in"><p id="22bc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本文中，我将概述API安全的常见实践，并说明如何通过采用流行的基于云的服务来实现安全措施——Firebase身份验证服务和AWS API网关。</p></div><div class="ab cl mb mc hu md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ij ik il im in"><h1 id="d4bd" class="mi mj iq bd mk ml mm mn mo mp mq mr ms jw mt jx mu jz mv ka mw kc mx kd my mz bi translated">API安全性一览</h1><p id="730f" class="pw-post-body-paragraph kw kx iq ky b kz na jr lb lc nb ju le lf nc lh li lj nd ll lm ln ne lp lq lr ij bi translated">策略是应用多层保护—网络/ HTTP协议层、端点保护以及身份验证和授权。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/8bc58ceac3b48dd7b3d0c02489a66a53.png" data-original-src="https://miro.medium.com/v2/resize:fit:928/format:webp/1*Gy7vrtSksCBu3L9NWtF0Aw.png"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">API安全性一览</figcaption></figure><ul class=""><li id="68eb" class="ng nh iq ky b kz la lc ld lf ni lj nj ln nk lr nl nm nn no bi translated"><strong class="ky ir">加密</strong> —所有流量都在安全的HTTPS通道中传输</li><li id="bc7a" class="ng nh iq ky b kz np lc nq lf nr lj ns ln nt lr nl nm nn no bi translated"><strong class="ky ir"> Web应用防火墙</strong> —对Web端点的全面保护</li><li id="c0b7" class="ng nh iq ky b kz np lc nq lf nr lj ns ln nt lr nl nm nn no bi translated"><strong class="ky ir">端点保护</strong> —使用API密钥作为标识符的节流和使用配额</li><li id="2865" class="ng nh iq ky b kz np lc nq lf nr lj ns ln nt lr nl nm nn no bi translated"><strong class="ky ir">身份执行</strong> —基于访问令牌验证身份</li><li id="75c8" class="ng nh iq ky b kz np lc nq lf nr lj ns ln nt lr nl nm nn no bi translated"><strong class="ky ir">授权</strong> —根据请求细节和访问令牌，检查作为API逻辑一部分的访问权限</li></ul><p id="6dbf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">可以对私有API应用额外的安全控制:</p><ul class=""><li id="8732" class="ng nh iq ky b kz la lc ld lf ni lj nj ln nk lr nl nm nn no bi translated">IP白名单</li><li id="6a98" class="ng nh iq ky b kz np lc nq lf nr lj ns ln nt lr nl nm nn no bi translated">相互证书认证</li></ul></div><div class="ab cl mb mc hu md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ij ik il im in"><h1 id="debc" class="mi mj iq bd mk ml mm mn mo mp mq mr ms jw mt jx mu jz mv ka mw kc mx kd my mz bi translated">端点保护</h1><p id="9e76" class="pw-post-body-paragraph kw kx iq ky b kz na jr lb lc nb ju le lf nc lh li lj nd ll lm ln ne lp lq lr ij bi translated">由于每个业务逻辑都可以作为一个API公开，所以一个应用程序可以有20多个API。随着API数量的快速增长，如果没有适当的策略，API管理可能是一场噩梦。这是因为在单个API上重复手动设置访问控制绝对是一种低效且容易出错的方法。因此，API网关应运而生，集中管理API。</p><p id="f5a2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">API gateway提供了广泛的服务，如速率限制、使用控制和身份执行。</p><h2 id="83a7" class="nu mj iq bd mk nv nw dn mo nx ny dp ms lf nz oa mu lj ob oc mw ln od oe my of bi translated">节流</h2><p id="8a43" class="pw-post-body-paragraph kw kx iq ky b kz na jr lb lc nb ju le lf nc lh li lj nd ll lm ln ne lp lq lr ij bi translated">为了保护您的API免受大量传入请求的冲击，强烈建议限制速率。您可以定义每秒允许的最大请求数。如果请求速率超过最大值，API网关拒绝请求。</p><h2 id="a976" class="nu mj iq bd mk nv nw dn mo nx ny dp ms lf nz oa mu lj ob oc mw ln od oe my of bi translated"><strong class="ak">爆裂</strong></h2><p id="aa29" class="pw-post-body-paragraph kw kx iq ky b kz na jr lb lc nb ju le lf nc lh li lj nd ll lm ln ne lp lq lr ij bi translated">尽管您允许每秒最多5，000个请求，但您可能不希望在10毫秒内涌入所有5，000个请求。如此巨大的流量可能会使您的底层API和数据存储陷入瘫痪，在更糟糕的情况下会导致服务中断。API gateway提供了名为<strong class="ky ir">突发</strong>的特性，这样你就可以控制API gateway在短时间内将多少请求路由到你的后端资源。</p><p id="3886" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">可以在下面的AWS API网关配置中设置限制和突发设置:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi og"><img src="../Images/5f9fb5f93b93d1e637ea7e2cee210047.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QtKYwjNJ2u1RL8k8ktVm0w.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">AWS API网关—默认节流配置</figcaption></figure><h2 id="73a5" class="nu mj iq bd mk nv nw dn mo nx ny dp ms lf nz oa mu lj ob oc mw ln od oe my of bi translated">API密钥</h2><p id="0141" class="pw-post-body-paragraph kw kx iq ky b kz na jr lb lc nb ju le lf nc lh li lj nd ll lm ln ne lp lq lr ij bi translated">API键是识别请求源的一种常用方法。例如，你同意你的客户使用你的资源。您生成一个唯一API密钥并分发给他们，这样API网关就能够识别来自特定客户端的流量，因为API密钥嵌入在每个请求的报头中。您可以在AWS API网关控制台中生成和管理API密钥。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oh"><img src="../Images/8e50f2771f8242e488783f84218fe617.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XIci7cEHxOzKBE4OcZd5aw.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">AWS API网关— API密钥管理</figcaption></figure><h2 id="d88c" class="nu mj iq bd mk nv nw dn mo nx ny dp ms lf nz oa mu lj ob oc mw ln od oe my of bi translated">使用计划</h2><p id="de5e" class="pw-post-body-paragraph kw kx iq ky b kz na jr lb lc nb ju le lf nc lh li lj nd ll lm ln ne lp lq lr ij bi translated">通过API密钥设置，可以根据服务协议对每个客户端应用速率限制和使用配额。以下示例显示了API使用计划—最大值。每月5000次呼叫，100次速率限制和50次突发控制。使用计划中指定的速率限制和突发控制会覆盖默认设置。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oi"><img src="../Images/e8a915fe42720a2963d2e2475ab81255.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BjcJRqeljXtdtnYsDqnNDA.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">AWS API网关—节流和使用计划</figcaption></figure></div><div class="ab cl mb mc hu md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ij ik il im in"><h1 id="f47a" class="mi mj iq bd mk ml mm mn mo mp mq mr ms jw mt jx mu jz mv ka mw kc mx kd my mz bi translated">身份实施</h1><p id="e30e" class="pw-post-body-paragraph kw kx iq ky b kz na jr lb lc nb ju le lf nc lh li lj nd ll lm ln ne lp lq lr ij bi translated">API密钥是客户端应用程序的标识符，如果不引入额外的安全措施，就无法验证最终用户的身份。建议采用OAuth来进一步保护您的API，因为它提供了用户认证、令牌过期和令牌更新的解决方案。我将解释它是如何工作的，以及使用Firebase作为认证服务在AWS API gateway上的实现。</p><p id="c7f0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">OAuth是一种流行的开放式授权标准协议，下面的参考资料有助于您理解它是如何工作的。</p><div class="oj ok gp gr ol om"><a href="https://www.digitalocean.com/community/tutorials/an-introduction-to-oauth-2" rel="noopener  ugc nofollow" target="_blank"><div class="on ab fo"><div class="oo ab op cl cj oq"><h2 class="bd ir gy z fp or fr fs os fu fw ip bi translated">OAuth 2 |数字海洋简介</h2><div class="ot l"><h3 class="bd b gy z fp or fr fs os fu fw dk translated">OAuth 2是一个授权框架，它使应用程序能够在HTTP…</h3></div><div class="ou l"><p class="bd b dl z fp or fr fs os fu fw dk translated">www.digitalocean.com</p></div></div><div class="ov l"><div class="ow l ox oy oz ov pa kp om"/></div></div></a></div></div><div class="ab cl mb mc hu md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ij ik il im in"><p id="909a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">OAuth中的一个关键组件是认证服务，它验证用户的身份并颁发一个令牌作为身份证明。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi pb"><img src="../Images/abddb6b5665da0de037f65d372c48458.png" data-original-src="https://miro.medium.com/v2/resize:fit:1230/format:webp/1*TJBXDOOD1uKT9oyMuyi0Zw.png"/></div></figure><h2 id="e983" class="nu mj iq bd mk nv nw dn mo nx ny dp ms lf nz oa mu lj ob oc mw ln od oe my of bi translated">Firebase认证</h2><p id="f8e0" class="pw-post-body-paragraph kw kx iq ky b kz na jr lb lc nb ju le lf nc lh li lj nd ll lm ln ne lp lq lr ij bi translated">Firebase是一个基于云的服务，提供一整套有利于应用程序开发的服务。认证服务是其强大的功能之一。</p><p id="d9c0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要实现登录功能，您可以设置登录ID和密码，或使用众所周知的第三方服务登录，如谷歌，脸书。请参考本文的详细内容和示例代码。</p><div class="oj ok gp gr ol om"><a href="https://medium.com/dev-genius/firebase-the-way-to-fast-track-authentication-implementation-of-your-app-2e93f42002b" rel="noopener follow" target="_blank"><div class="on ab fo"><div class="oo ab op cl cj oq"><h2 class="bd ir gy z fp or fr fs os fu fw ip bi translated">Firebase —快速跟踪应用程序身份验证实施的方法</h2><div class="ot l"><h3 class="bd b gy z fp or fr fs os fu fw dk translated">Firebase身份验证实现的演练</h3></div><div class="ou l"><p class="bd b dl z fp or fr fs os fu fw dk translated">medium.com</p></div></div><div class="ov l"><div class="pc l ox oy oz ov pa kp om"/></div></div></a></div><p id="025b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一旦用户成功登录，Firebase就会生成一对令牌:</p><ul class=""><li id="d0ce" class="ng nh iq ky b kz la lc ld lf ni lj nj ln nk lr nl nm nn no bi translated"><strong class="ky ir">访问令牌</strong>—一种短期令牌，用作同意资源访问的证明。(通常有效期为15分钟至1小时)</li><li id="ff52" class="ng nh iq ky b kz np lc nq lf nr lj ns ln nt lr nl nm nn no bi translated"><strong class="ky ir">刷新令牌</strong> —用于在访问令牌过期或即将过期时，重新生成一对新的访问令牌和刷新令牌。</li></ul></div><div class="ab cl mb mc hu md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ij ik il im in"><h2 id="a159" class="nu mj iq bd mk nv nw dn mo nx ny dp ms lf nz oa mu lj ob oc mw ln od oe my of bi translated">API请求中的安全令牌</h2><p id="0693" class="pw-post-body-paragraph kw kx iq ky b kz na jr lb lc nb ju le lf nc lh li lj nd ll lm ln ne lp lq lr ij bi translated">当向API提交请求时，您将在HTTP头中放入两个令牌——API密钥和访问令牌。API密钥是关于节流和配额的第一级访问控制的标识符，而访问令牌是第二级控制，因此API网关确保请求是由经过身份验证的用户提交的。</p><p id="0fcb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下面的示例代码演示了一个javascript函数如何使用Firebase SDK生成访问令牌，并提交给一个API，在HTTP头中包含API密钥和访问令牌</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="pd pe l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">使用API密钥+访问令牌消费API</figcaption></figure></div><div class="ab cl mb mc hu md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ij ik il im in"><h1 id="e8a9" class="mi mj iq bd mk ml mm mn mo mp mq mr ms jw mt jx mu jz mv ka mw kc mx kd my mz bi translated">API网关如何验证访问令牌？</h1><p id="7b53" class="pw-post-body-paragraph kw kx iq ky b kz na jr lb lc nb ju le lf nc lh li lj nd ll lm ln ne lp lq lr ij bi translated">在进入令牌验证之前，请花点时间了解访问令牌的基本知识。</p><h2 id="450d" class="nu mj iq bd mk nv nw dn mo nx ny dp ms lf nz oa mu lj ob oc mw ln od oe my of bi translated">JSON Web令牌(JWT)</h2><p id="11ed" class="pw-post-body-paragraph kw kx iq ky b kz na jr lb lc nb ju le lf nc lh li lj nd ll lm ln ne lp lq lr ij bi translated">访问令牌不仅仅是一个简单的代码，它还包括数据字段，如身份信息、有效性、完整性证明和其他用于授权检查的信息。JSON Web Token (JWT)是一个开放的标准，定义了身份信息的表示格式，支持数字签名。认证成功后，认证服务生成并签署JWT令牌，客户端应用程序将JWT令牌作为身份证明嵌入到HTTP请求中，以使用API。</p><p id="046b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你想深入了解更多细节，这里有JWT规范的链接</p><div class="oj ok gp gr ol om"><a href="https://tools.ietf.org/html/rfc7519" rel="noopener  ugc nofollow" target="_blank"><div class="on ab fo"><div class="oo ab op cl cj oq"><h2 class="bd ir gy z fp or fr fs os fu fw ip bi translated">RFC 7519 - JSON Web令牌(JWT)</h2><div class="ot l"><h3 class="bd b gy z fp or fr fs os fu fw dk translated">互联网工程任务组(IETF) M. Jones请求评论:7519微软类别:标准跟踪J…</h3></div><div class="ou l"><p class="bd b dl z fp or fr fs os fu fw dk translated">tools.ietf.org</p></div></div></div></a></div><p id="f161" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">简而言之，JWT包含3个部分BASE64编码的报头、有效载荷和签名，由点( .)</p><pre class="kg kh ki kj gt pf pg ph pi aw pj bi"><span id="d49f" class="nu mj iq pg b gy pk pl l pm pn"><strong class="pg ir"><em class="po">[header].[payload].[signature]</em></strong></span></pre><p id="e709" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你解码头部和有效载荷部分，你会发现它们实际上是JSON格式的。下面的截图显示了解码后的内容</p><ul class=""><li id="0507" class="ng nh iq ky b kz la lc ld lf ni lj nj ln nk lr nl nm nn no bi translated"><strong class="ky ir">头</strong> —描述应用于令牌的加密操作，如密钥id和算法</li><li id="78fc" class="ng nh iq ky b kz np lc nq lf nr lj ns ln nt lr nl nm nn no bi translated"><strong class="ky ir">有效载荷</strong> — <strong class="ky ir"> </strong>包含<strong class="ky ir"> </strong>身份和有效性，例如，发行人id、到期时间、发行时间等。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pp"><img src="../Images/8ffe9c971fe1c44f91b7c28b66f785ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PO0ayoVqFctE8dA16XHsig.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">JWT令牌—编码和解码的内容</figcaption></figure><h2 id="7638" class="nu mj iq bd mk nv nw dn mo nx ny dp ms lf nz oa mu lj ob oc mw ln od oe my of bi translated">访问令牌验证逻辑</h2><p id="c85e" class="pw-post-body-paragraph kw kx iq ky b kz na jr lb lc nb ju le lf nc lh li lj nd ll lm ln ne lp lq lr ij bi translated">记住了JWT结构，您就理解了令牌验证。下面是确定访问令牌是否有效的步骤:</p><ol class=""><li id="9b8c" class="ng nh iq ky b kz la lc ld lf ni lj nj ln nk lr pq nm nn no bi translated">使用发行者的公钥验证签名以检查完整性</li><li id="1ee5" class="ng nh iq ky b kz np lc nq lf nr lj ns ln nt lr pq nm nn no bi translated">解码令牌并检查有效负载，如到期时间，以验证令牌状态</li></ol><p id="f9b8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">别担心，你不需要从头开始写程序。由于JWT是一个开放标准并被广泛采用，因此我们可以使用大量的开源库来进行令牌签名和验证。只需访问https://jwt.io/,，它会向您显示30多种编程语言的可用库列表。</p><p id="01ee" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">例如，<strong class="ky ir"> jsonwebtoken </strong>和<strong class="ky ir"> jose </strong>是节点，js库支持JWT令牌的签名和验证。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pr"><img src="../Images/f69f2822f74e87727b5d7c93304a93eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Gc4jGPmj2cttDgvl-JbLYg.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">节点JS JWT库</figcaption></figure><p id="7405" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下面的示例代码片段展示了如何使用<strong class="ky ir"> jose </strong>库进行JWT验证。这是一个Node.js lambda函数，它首先从firebase公共端点获取公钥，然后验证JWT。为了与AWS API gateway集成，它在AWS IAM策略JSON结构中构建并返回结果，该结构带有用户id和指示符“Allow”或“Deny”。</p><p id="249a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">添加公钥缓存可以进一步改进这个示例实现，由于消除了实时依赖性Firebase端点，它增强了稳定性和性能。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ps"><img src="../Images/27ea56a80962fe966d0775deaad5d8bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:920/format:webp/1*5OHMTh1n0MvVptFxFc_a5w.png"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">JWT验证设计</figcaption></figure><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="pd pe l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">JWT验证Lambda示例代码</figcaption></figure><h2 id="f7c7" class="nu mj iq bd mk nv nw dn mo nx ny dp ms lf nz oa mu lj ob oc mw ln od oe my of bi translated">授权人(λ函数)</h2><p id="c15f" class="pw-post-body-paragraph kw kx iq ky b kz na jr lb lc nb ju le lf nc lh li lj nd ll lm ln ne lp lq lr ij bi translated">我们已经准备好了令牌验证逻辑，现在是时候启用对API gateway的检查了。AWS API gateway让我们可以灵活地在授权器中定义自己的验证逻辑，这是一个无服务器的lambda函数。API gateway调用授权器来验证所有传入的请求，lambda函数返回检查结果。由于lambda函数的可伸缩性，这绝对是一个非常棒的设计，能够处理大量的请求。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi pt"><img src="../Images/db903f0055516c985ee5245b20e29506.png" data-original-src="https://miro.medium.com/v2/resize:fit:1198/format:webp/1*ZQO6gZ9ZM2rQ9354sjb1mA.png"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">AWS API网关-授权人</figcaption></figure><p id="2d69" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">假设我们已经部署了lambda函数，下面是定义新授权者并将其链接到lambda函数的步骤:</p><ol class=""><li id="2782" class="ng nh iq ky b kz la lc ld lf ni lj nj ln nk lr pq nm nn no bi translated">转到AWS API网关控制台中的菜单项“授权者”,并单击按钮创建新的授权者。</li><li id="eb69" class="ng nh iq ky b kz np lc nq lf nr lj ns ln nt lr pq nm nn no bi translated">将<strong class="ky ir"> Lambda函数</strong>设置为您新创建的用于令牌验证的Lambda函数。</li><li id="3b36" class="ng nh iq ky b kz np lc nq lf nr lj ns ln nt lr pq nm nn no bi translated">告诉授权者从<strong class="ky ir">令牌源</strong>中提取访问令牌的HTTP头名称</li></ol><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pu"><img src="../Images/621ca08cb33b82790c6c176b29c79e01.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8imNUOfc6flvHyowUxZnpA.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">AWS API网关-授权者定义</figcaption></figure><p id="80d4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">授权者配置是每个端点级别的，这意味着您可以为每个端点配置不同的验证逻辑。下面的例子显示了我们如何将authorizer应用到API端点。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pv"><img src="../Images/b46a099992b53cd0b6eaf3e60dfac4ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6xFLU1kP9zzfMzDfT4z1rA.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">AWS API网关—带授权器的API端点</figcaption></figure></div><div class="ab cl mb mc hu md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ij ik il im in"><h1 id="4eeb" class="mi mj iq bd mk ml mm mn mo mp mq mr ms jw mt jx mu jz mv ka mw kc mx kd my mz bi translated">批准</h1><p id="f696" class="pw-post-body-paragraph kw kx iq ky b kz na jr lb lc nb ju le lf nc lh li lj nd ll lm ln ne lp lq lr ij bi translated">确定动作和数据类型的访问权限的逻辑与应用程序逻辑更相关，因此建议的方法是将其作为API逻辑的一部分来实现。当访问令牌从API网关传递到底层API时，API逻辑可以从访问令牌中提取用户信息并执行授权规则。</p></div><div class="ab cl mb mc hu md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ij ik il im in"><h1 id="64c2" class="mi mj iq bd mk ml mm mn mo mp mq mr ms jw mt jx mu jz mv ka mw kc mx kd my mz bi translated">网络应用防火墙(WAF)</h1><p id="e742" class="pw-post-body-paragraph kw kx iq ky b kz na jr lb lc nb ju le lf nc lh li lj nd ll lm ln ne lp lq lr ij bi translated">最后但同样重要的是，如果您的目标是企业级保护，WAF是必不可少的组件。它是位于API网关和所有其他API组件前面的第一道防线。您可能听说过许多已知的漏洞和攻击，如SQL注入、bot攻击、DDoS、OWASP top 10等，防火墙是防范这些风险的完美解决方案。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi pw"><img src="../Images/9dffe3e89d148bf14775b78c68fcb2ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1214/format:webp/1*24mVFT89LAgp7nIqQBy81A.png"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">Web应用防火墙</figcaption></figure><p id="ecb0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">与传统防火墙类似，WAF基于安全规则列表过滤流量。它不是在TCP/IP层过滤流量，而是专门查看HTTP协议中的流量，这意味着您可以根据HTTP报头、URI路径、HTTP正文等来确定是允许还是阻止流量。AWS提供友好的用户界面，让您设置自己的安全规则。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi px"><img src="../Images/0d8ae5295e5ab6f382dceec3b7fd3a51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nSGB8njqQIf3Fh3EwrXJUw.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">AWS Web应用程序防火墙—规则配置</figcaption></figure><h2 id="13c6" class="nu mj iq bd mk nv nw dn mo nx ny dp ms lf nz oa mu lj ob oc mw ln od oe my of bi translated">服务提供商的托管规则</h2><p id="b957" class="pw-post-body-paragraph kw kx iq ky b kz na jr lb lc nb ju le lf nc lh li lj nd ll lm ln ne lp lq lr ij bi translated">与自己创建规则不同，订阅托管规则可以快速让您的WAF做好准备。许多著名的WAF服务提供商，如F5、Fortinet和Imperva，都按月收费(20-30美元)提供托管安全规则。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi py"><img src="../Images/db80949b5aa694a7380c787ea95c1ab7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pZXrnbTqhHIuXvLGoHtj8w.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">AWS Web应用程序防火墙—受管规则</figcaption></figure></div><div class="ab cl mb mc hu md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ij ik il im in"><h1 id="03cb" class="mi mj iq bd mk ml mm mn mo mp mq mr ms jw mt jx mu jz mv ka mw kc mx kd my mz bi translated">最后的想法</h1><p id="9060" class="pw-post-body-paragraph kw kx iq ky b kz na jr lb lc nb ju le lf nc lh li lj nd ll lm ln ne lp lq lr ij bi translated">API保护至关重要，应该作为API开发的一部分给予高度重视。强烈建议采用API网关架构模式和OAuth与JWT的开放标准等最佳实践。然而，如果我们从头开始构建一切，实现可能会很有挑战性。由于AWS和Firebase等基于云的服务，通过在基于云的组件上进行配置和部署lambda功能，可以轻松保护API。</p></div></div>    
</body>
</html>