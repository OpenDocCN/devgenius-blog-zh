<html>
<head>
<title>How not to add captcha to your website</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何不在你的网站上添加验证码</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/how-not-to-add-captcha-to-your-website-b7a358855b3a?source=collection_archive---------16-----------------------#2022-06-26">https://blog.devgenius.io/how-not-to-add-captcha-to-your-website-b7a358855b3a?source=collection_archive---------16-----------------------#2022-06-26</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="69f2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">有一次，我不得不通过互联网做一些官僚程序，由于网页很糟糕，我求助于自动化，所以我必须找到一种绕过验证码的方法，在这样做的同时，我发现了几件事，我将在这篇文章中与你分享。</p><p id="a18e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">下面的建议看起来很明显，但是如果我没有在一个“企业”应用程序中遇到这些错误，我不会写这篇文章。所以我想这些建议可能最终会对某人有所帮助。</p><p id="adef" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">尽管如此，请继续阅读，因为你可能会发现这个帖子很有趣，因为它讨论了计算机视觉、逆向工程、用 Java 处理大文件以及其他主题。</p></div><div class="ab cl ki kj hr kk" role="separator"><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn"/></div><div class="ig ih ii ij ik"><h1 id="0057" class="kp kq in bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">不要使用类似于 v1 的验证码</h1><p id="a59a" class="pw-post-body-paragraph jk jl in jm b jn ln jp jq jr lo jt ju jv lp jx jy jz lq kb kc kd lr kf kg kh ig bi translated">正如你从下面的图片中看到的，我想绕过的验证码非常普通和简单。</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div class="gh gi ls"><img src="../Images/fe04cee2c376d83365dd665090a2ff57.png" data-original-src="https://miro.medium.com/v2/resize:fit:400/format:webp/1*RmdkHafQuW0Iibeoa7hkUA.png"/></div><figcaption class="ma mb gj gh gi mc md bd b be z dk translated">要绕过的验证码示例</figcaption></figure><p id="c6db" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">因此，我首先想到的是使用计算机视觉。然而，事实证明绕过验证码要容易得多，我们将在下一节讨论这一点。现在，让我向你展示计算机视觉是如何帮助我们的。</p><p id="be08" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我首先想到的是:假设字母的厚度为 3，而噪声(随机椭圆)的厚度为 1。因此，如果你移除所有厚度为 1 的图形，你就移除了杂色。</p><p id="0ba0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我认为没有 OpenCV 操作符可以做到这一点。然而，我们可以以不同的方式来考虑它:从图像中的每个几何图形的厚度中减去 1，将得到厚度为 2 的字母和厚度为 0 的噪声。因此，本质上，我们有效地消除了噪声。</p><p id="cf8f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这个操作确实存在于 OpenCV 中，它被称为<a class="ae me" href="https://docs.opencv.org/3.0-beta/doc/py_tutorials/py_imgproc/py_morphological_ops/py_morphological_ops.html#erosion" rel="noopener ugc nofollow" target="_blank">侵蚀</a>。使用它来消除噪声非常简单:</p><figure class="lt lu lv lw gt lx"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="4641" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">(<a class="ae me" href="https://docs.opencv.org/3.0-beta/doc/py_tutorials/py_imgproc/py_morphological_ops/py_morphological_ops.html#opening" rel="noopener ugc nofollow" target="_blank">开口</a>是先用侵蚀再用扩张的操作。我们可以只使用腐蚀操作符，但这会导致字母的厚度为 2。膨胀算子使它们的厚度再次为 3)</p><p id="8298" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">当使用示例 captcha 作为输入运行脚本时，我们得到以下输出。</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi mh"><img src="../Images/c9b5472bb26a7ffa71986df527d6cb2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZDBCeRVXi2xcbObI3Gx1pw.png"/></div></div><figcaption class="ma mb gj gh gi mc md bd b be z dk translated">原始和预处理的验证码比较</figcaption></figure><p id="57e9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">正如你所看到的，图像现在清晰多了，我们可以使用光学字符识别，如<a class="ae me" href="https://github.com/tesseract-ocr/tesseract" rel="noopener ugc nofollow" target="_blank">宇宙魔方</a>来提取字符。</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi mm"><img src="../Images/5db40e799080ca329e85250a563ca894.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G9VLtMzHP2a2Ikb1lOvbmA.png"/></div></div></figure><p id="7c27" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">不错！我们刚刚发现了一种利用计算机视觉绕过这个简单验证码的方法😝。我们可以从中吸取以下教训:</p><p id="bc05" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">不要使用类似验证码 v1 的。谷歌关闭这个版本是有原因的。</p><p id="851b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在我们将看到实际上没有必要使用计算机视觉。</p></div><div class="ab cl ki kj hr kk" role="separator"><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn"/></div><div class="ig ih ii ij ik"><h1 id="5c47" class="kp kq in bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">在后端验证验证码响应</h1><p id="62fc" class="pw-post-body-paragraph jk jl in jm b jn ln jp jq jr lo jt ju jv lp jx jy jz lq kb kc kd lr kf kg kh ig bi translated">为了绕过验证码，我需要知道它的来源。所以，我在 DevTools 中打开了 Network 选项卡，发现了服务器的如下响应。</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/853d1695787eef2b4e5fae192f5f8c3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1314/format:webp/1*7pZTFq3fpdi5RrZyhAD92g.png"/></div></figure><p id="f434" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">属性<code class="fe mo mp mq mr b">Captcha</code>包含 base64 编码的 captcha 图像，属性<code class="fe mo mp mq mr b">a</code>包含一个十六进制字符串，其用途目前未知。</p><p id="302a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">与此同时，我发现了一个不寻常的行为:验证码输入是反应性的，如果验证码是错误的，它会立即向您显示一条消息。我以为在任何输入更改后都会发送验证验证码的请求，但是当我再次查看 DevTools 中的 Network 选项卡时，我注意到没有新的请求。</p><p id="8b93" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这让我认为验证码在我这边是有效的，并且<code class="fe mo mp mq mr b">a</code>属性与此有关。因此，我查看了源代码(在 Debugger 选项卡的 DevTools 中)并搜索了<code class="fe mo mp mq mr b">a</code>属性。这是我发现的。</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi ms"><img src="../Images/5e8d8a30aba6d17849db8b5ed1cbd073.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*89rlAkjJqyfrfez_ByZVgw.png"/></div></div></figure><p id="7fbc" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如您所见，在第 5 行获得了来自用户的验证码响应的 SHA1 散列，在第 6 行将它与来自响应的<code class="fe mo mp mq mr b">a</code>属性进行比较。因此，<code class="fe mo mp mq mr b">a</code>属性实际上是正确的验证码响应的 SHA1 散列。</p><p id="b6c5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">因为 SHA1 是一个单向散列，很难还原它以获得正确的验证码响应，所以除了进行暴力攻击，我们别无选择。本质上很简单，我们只需要尝试所有可能的组合。</p><p id="df9d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">为了获得所有可能的组合，我们需要知道验证码由 5 个小写字母数字英文字符(总共 36 个字符)组成，并且允许重复(我在看到多个验证码后发现了这些约束)。因此，可能性的总数是 60，466，176 (36⁵)</p><p id="4f5a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这看起来有很多可能性，你可能认为尝试每一种可能性几乎是不可能的。但是实际上这样做很简单，不需要花太多时间，正如你将要看到的。</p><h2 id="230f" class="mt kq in bd kr mu mv dn kv mw mx dp kz jv my mz ld jz na nb lh kd nc nd ll ne bi translated">暴力攻击</h2><p id="2f6d" class="pw-post-body-paragraph jk jl in jm b jn ln jp jq jr lo jt ju jv lp jx jy jz lq kb kc kd lr kf kg kh ig bi translated">以下代码生成所有可能的 captcha 值，并执行暴力攻击。由于使用了库，代码非常简单。尽管如此，我还是添加了一些 Javadoc 以方便阅读。</p><figure class="lt lu lv lw gt lx"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="8c7a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">方法<code class="fe mo mp mq mr b">generate(Writer)</code>和<code class="fe mo mp mq mr b">read(Reader): Iterator&lt;Attempt&gt;</code>只是为了方便<strong class="jm io">给我</strong>。在我的例子中，从一个大小约为 2.7GB 的文件中读取所有 60，466，176 个哈希和验证码比动态生成它们更方便。</p><p id="53ea" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">当然，通过流读取 2.7 GB 的文件比读取整个文件并将其保存在列表中要高效得多(这样做可能会抛出 OutOfMemoryError)。</p><p id="10ca" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">注意一些重要的事情:尽管这是一种暴力攻击，即使应用程序有某种<strong class="jm io">速率限制，它也是无用的</strong>(分别检查第 60 行和第 52 行<code class="fe mo mp mq mr b">CaptchaCracker</code>和<code class="fe mo mp mq mr b">ExamplePage</code>)。如果验证是在后端完成的，这就不是真的。</p><p id="3954" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">因此，这里学到的教训是<strong class="jm io">不在前端验证验证码响应，而是在后端</strong>，如果你这样做，<strong class="jm io">添加速率限制</strong>以防止暴力攻击。或者干脆用谷歌的 reCAPTCHA 之类的第三方。</p></div><div class="ab cl ki kj hr kk" role="separator"><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn"/></div><div class="ig ih ii ij ik"><h1 id="9774" class="kp kq in bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">结论</h1><p id="93db" class="pw-post-body-paragraph jk jl in jm b jn ln jp jq jr lo jt ju jv lp jx jy jz lq kb kc kd lr kf kg kh ig bi translated">我认为我在这里给出的建议是显而易见的，没有什么特别的，但是如前所述，如果我没有在一个“企业”应用程序中遇到这些失败，我不会写这篇文章。</p><p id="4d65" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">最后，我想补充一个奇怪而讽刺的事实:负责这个应用程序的企业只雇佣有资格的专业人员。</p><p id="f44a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">也就是说，我除了感谢你阅读这篇文章之外别无选择，一如既往，如果你认为有什么地方错了或者有什么地方可以改进，请告诉我。我喜欢你的反馈。</p></div><div class="ab cl ki kj hr kk" role="separator"><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn"/></div><div class="ig ih ii ij ik"><h1 id="846b" class="kp kq in bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">附录 A:用 Selenium 拦截验证码请求响应</h1><p id="b891" class="pw-post-body-paragraph jk jl in jm b jn ln jp jq jr lo jt ju jv lp jx jy jz lq kb kc kd lr kf kg kh ig bi translated">该网页的工作方式如下:</p><ol class=""><li id="25c3" class="nf ng in jm b jn jo jr js jv nh jz ni kd nj kh nk nl nm nn bi translated">用户被要求在表格中输入一些数据</li><li id="e2b5" class="nf ng in jm b jn no jr np jv nq jz nr kd ns kh nk nl nm nn bi translated">当所有的必填字段都被填充后，一个请求被发送到后端以获取验证码图片和 SHA1 散列(我们在上一节看到的响应)</li><li id="8d9c" class="nf ng in jm b jn no jr np jv nq jz nr kd ns kh nk nl nm nn bi translated">在成功解决验证码之前，您无法进入下一页</li></ol><p id="239e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如您所见，captcha 图像和 hash 并不是从一开始就加载的，所以我们需要拦截异步请求的响应。为此，我使用了以下代码。</p><figure class="lt lu lv lw gt lx"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="cb0c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">代码几乎是不言自明的，但它可能有助于澄清在第 45 行，执行将暂停，直到对象在第 80 行排队(这在从服务器收到响应后异步发生)。</p><p id="f6ae" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我知道这与如何不在网站上添加验证码的建议几乎没有任何关系，但我想把它包括进来，因为它可能会帮助某人，或者可能只是我未来的自己。</p></div></div>    
</body>
</html>