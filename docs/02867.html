<html>
<head>
<title>Node.js Best Practices — Logging and Monitoring</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Node.js最佳实践—日志记录和监控</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/node-js-best-practices-logging-and-monitoring-5d331e808cd4?source=collection_archive---------6-----------------------#2020-09-06">https://blog.devgenius.io/node-js-best-practices-logging-and-monitoring-5d331e808cd4?source=collection_archive---------6-----------------------#2020-09-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/3a02f99cdae3ca6e3ba7f14bc790671f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*08h4ERBtzym3Hpx7"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">安东尼奥·格罗斯在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="13e6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">像任何类型的应用程序一样，JavaScript应用程序也必须写得很好。</p><p id="9a1d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">否则，我们以后会遇到各种各样的问题。</p><p id="96a1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将看看在编写节点应用程序时应该遵循的一些最佳实践。</p><h1 id="99a2" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">集中处理错误</h1><p id="5515" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们应该在节点应用程序中集中处理错误。</p><p id="db94" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以在一个中间件中调用<code class="fe me mf mg mh b">next</code>来调用在它之后添加的错误处理中间件。</p><p id="14d3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="8e1e" class="mq lc iq mh b gy mr ms l mt mu">try {<br/>  User.addNew(req.body).then((result) =&gt; {<br/>    res.status(200).json(result);<br/>  }).catch((error) =&gt; {<br/>    next(error)<br/>  });<br/>} catch (error) {<br/>  next(error);<br/>}</span></pre><p id="22bc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">用<code class="fe me mf mg mh b">catch</code>方法捕捉承诺链中的错误。</p><p id="ea1e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通过try-catch块，我们可以捕获同步代码中的错误。</p><p id="d2f1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，我们可以通过编写以下代码在该代码之后添加一个错误处理程序中间件:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="9220" class="mq lc iq mh b gy mr ms l mt mu">app.use((err, req, res, next) =&gt; {<br/>  errorHandler.handleError(err).then((isOperationalError) =&gt; {<br/>    if (!isOperationalError)<br/>      next(err);<br/>  });<br/>});</span></pre><p id="47c6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们调用另一个承诺链来处理任何操作错误。</p><p id="560b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这些是我们可以预见并妥善处理的错误。</p><h1 id="1a13" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">使用Swagger记录API错误</h1><p id="4c1d" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">API错误应该以某种方式记录下来，以便处理。</p><p id="b19d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们不希望我们的应用程序崩溃。</p><p id="2359" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Swagger让我们以自动化的方式记录我们的API。</p><p id="fdcf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果我们不处理错误，应用程序就会崩溃。</p><h1 id="032c" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">遇到未知错误时，正常关闭进程</h1><p id="ef28" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">如果我们的应用程序遇到一些没有处理的错误，那么我们应该优雅地关闭应用程序，然后重新启动它。</p><p id="136c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一种常见的方法是使用像PM2这样的流程管理器来完成这项工作。</p><p id="879c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们不希望任何错误使我们的应用程序崩溃并停机。</p><p id="e1ca" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果我们没有进程管理器，那么我们每次都必须自己重启它。</p><p id="bca5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这肯定是不可接受的，因为它可能在一天中的任何时候发生多次。</p><p id="3b31" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以通过编写以下代码来创建自己的错误处理程序:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="460d" class="mq lc iq mh b gy mr ms l mt mu">function errorHandler() {<br/>  this.handleError = function(error) {<br/>    return logger.logError(err));<br/>  }</span><span id="76b1" class="mq lc iq mh b gy mv ms l mt mu">  this.isTrustedError = function(error) {<br/>    return error.isOperational;<br/>  }<br/>}</span></pre><p id="7b87" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们有一个错误处理构造函数，它有一些处理错误的方法。</p><h1 id="7fd7" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">使用成熟的记录器</h1><p id="747e" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">如果一个节点应用程序在生产中，那么除非我们在某个地方记录错误，否则错误是不可见的。</p><p id="4e3f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有许多针对节点应用的日志解决方案，包括Winston、Bunyan和Log4js。</p><p id="3a01" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它们将帮助我们更快地发现错误。</p><p id="a29e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们不应该使用像<code class="fe me mf mg mh b">console.log</code>这样粗糙的解决方案来记录生产中的错误。</p><p id="ad36" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这些错误应该存在于我们可以搜索的一些云服务或文件中。</p><p id="c47f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以用Winston来写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="660e" class="mq lc iq mh b gy mr ms l mt mu">const logger = new winston.Logger({<br/>  level: 'info',<br/>  transports: [<br/>    new (winston.transports.Console)(),<br/>    new (winston.transports.File)({ filename: 'somefile.log' })<br/>  ]<br/>});</span><span id="e064" class="mq lc iq mh b gy mv ms l mt mu">logger.log('info', 'log: %s', 'something', { anything: 'This is metadata' });</span></pre><p id="72c2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们使用<code class="fe me mf mg mh b">winston.Logger</code>构造函数来创建记录器。</p><p id="a307" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们调用<code class="fe me mf mg mh b">log</code>以我们想要的格式记录我们想要的东西。</p><h1 id="8174" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">使用APM产品发现错误和停机时间</h1><p id="1dd8" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">APM产品应记录错误和停机时间。</p><p id="61bc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这样，我们可以很容易地在一个地方找到它们。</p><p id="5a5d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它们提供网站或API监控等功能。</p><p id="b962" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">每个请求都记录了它们的性能指标。</p><p id="09f2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果有慢代码，它会记录慢发生在哪里。</p><p id="a212" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，他们将汇总数据，然后将它们一起显示在一个仪表板上。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mw"><img src="../Images/4d26dccabc63424b5766692b4ba72dde.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jbKxfMA0HGwx8wti"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">照片由<a class="ae kc" href="https://unsplash.com/@prasunjit?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Prasunjit Dey </a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><h1 id="ea89" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="84bb" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">错误应该集中处理。</p><p id="7e70" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，日志记录和监控应该使用各种库和服务来完成。</p></div></div>    
</body>
</html>