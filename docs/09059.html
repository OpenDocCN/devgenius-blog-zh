<html>
<head>
<title>Customizing Exoplayer &amp; PIP mode</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">自定义 Exoplayer 和画中画模式</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/customizing-exoplayer-pip-mode-47c4ecd420b6?source=collection_archive---------6-----------------------#2022-07-27">https://blog.devgenius.io/customizing-exoplayer-pip-mode-47c4ecd420b6?source=collection_archive---------6-----------------------#2022-07-27</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="63c7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">安卓克斯|科特林</p></div><div class="ab cl ki kj hr kk" role="separator"><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn"/></div><div class="ig ih ii ij ik"><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi kp"><img src="../Images/6ea42e590514d58fe438c8bdbb3c2f43.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OsqdbxJS9Juc4lplmc0lIA.jpeg"/></div></div></figure><h1 id="c817" class="lb lc in bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated"><strong class="ak">简介</strong></h1><p id="432c" class="pw-post-body-paragraph jk jl in jm b jn lz jp jq jr ma jt ju jv mb jx jy jz mc kb kc kd md kf kg kh ig bi translated">一个视频播放器集成到 android 应用程序中，以简单高效的方式播放视频。</p><p id="949d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这是一个来自谷歌的开源可定制视频播放器。它支持几乎所有的网址格式，如 FMPG，WebM，MPEG-TS，FMP4，ADTS，MP3 等。</p><p id="b8cc" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">Exoplayer 支持 android 版本<strong class="jm io"> 4.1 </strong>也就是 API 级别<strong class="jm io"> 16。</strong>我还在 YouTube 上发布了一段视频。看一看！</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="me mf l"/></div></figure><p id="03a3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">我们将在这个博客中看到什么</strong></p><ol class=""><li id="5001" class="mg mh in jm b jn jo jr js jv mi jz mj kd mk kh ml mm mn mo bi translated">如何用我们自己的 UI 定制一个播放器？</li><li id="beca" class="mg mh in jm b jn mp jr mq jv mr jz ms kd mt kh ml mm mn mo bi translated">一个播放视频的 exoplayer 实现。</li><li id="1173" class="mg mh in jm b jn mp jr mq jv mr jz ms kd mt kh ml mm mn mo bi translated">为视频播放器集成画中画模式。</li></ol></div><div class="ab cl ki kj hr kk" role="separator"><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn"/></div><div class="ig ih ii ij ik"><p id="ecd1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">事不宜迟，让我们直接进入代码。</p><h2 id="a292" class="mu lc in bd ld mv mw dn lh mx my dp ll jv mz na lp jz nb nc lt kd nd ne lx nf bi translated"><strong class="ak">实现 Exoplayer </strong></h2><p id="7132" class="pw-post-body-paragraph jk jl in jm b jn lz jp jq jr ma jt ju jv mb jx jy jz mc kb kc kd md kf kg kh ig bi translated">首先，我们需要在 build.gradle 文件中集成 exoplayer 库</p><pre class="kq kr ks kt gt ng nh ni nj aw nk bi"><span id="d864" class="mu lc in nh b gy nl nm l nn no"><em class="np">//Exoplayer<br/></em>implementation 'com.google.android.exoplayer:exoplayer:2.17.0'</span></pre><p id="6b87" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在让我们开始创建自定义 UI (activity_main.xml)</p><pre class="kq kr ks kt gt ng nh ni nj aw nk bi"><span id="7aa3" class="mu lc in nh b gy nl nm l nn no"><em class="np">&lt;?</em>xml version="1.0" encoding="utf-8"<em class="np">?&gt;<br/></em>&lt;androidx.constraintlayout.widget.ConstraintLayout xmlns:android="http://schemas.android.com/apk/res/android"<br/>    xmlns:app="http://schemas.android.com/apk/res-auto"<br/>    xmlns:tools="http://schemas.android.com/tools"<br/>    android:layout_width="match_parent"<br/>    android:layout_height="match_parent"<br/>    tools:context=".MainActivity"&gt;<br/><br/>    &lt;com.google.android.exoplayer2.ui.PlayerView<br/>        android:id="@+id/exoPlayer"<br/>        android:layout_width="match_parent"<br/>        android:layout_height="match_parent"<br/>        app:layout_constraintLeft_toLeftOf="parent"<br/>        app:layout_constraintRight_toRightOf="parent"<br/>        app:layout_constraintTop_toTopOf="parent"<br/>        app:layout_constraintBottom_toBottomOf="parent"<br/>        app:controller_layout_id="@layout/custom_exo_layout"/&gt;<br/><br/>&lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;</span></pre><p id="fa1d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">以下代码帮助我们为我们的 exoplayer 创建一个自定义布局，该布局必须作为 controller_layout_id 集成到 exoplayer 播放器 xml 文件中。</p><pre class="kq kr ks kt gt ng nh ni nj aw nk bi"><span id="622c" class="mu lc in nh b gy nl nm l nn no">app:controller_layout_id="@layout/custom_exo_layout"</span></pre><p id="c489" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">自定义 exoplayer 布局</p><pre class="kq kr ks kt gt ng nh ni nj aw nk bi"><span id="2a42" class="mu lc in nh b gy nl nm l nn no"><em class="np">&lt;?</em>xml version="1.0" encoding="utf-8"<em class="np">?&gt;<br/></em>&lt;FrameLayout xmlns:android="http://schemas.android.com/apk/res/android"<br/>    android:layout_width="match_parent"<br/>    android:layout_height="match_parent"<br/>    xmlns:app="http://schemas.android.com/apk/res-auto"&gt;<br/><br/>    &lt;View<br/>        android:layout_width="match_parent"<br/>        android:layout_height="match_parent"<br/>        android:background="@color/black"<br/>        android:id="@+id/viewShown"<br/>        android:alpha="0.5"/&gt;<br/><br/>    &lt;FrameLayout<br/>        android:layout_width="wrap_content"<br/>        android:layout_height="wrap_content"<br/>        android:layout_gravity="center"&gt;<br/><br/>    &lt;ImageButton android:id="@id/exo_play"<br/>        android:layout_width="80dp"<br/>        android:layout_height="80dp"<br/>        android:layout_gravity="center"<br/>        android:background="@drawable/play"/&gt;<br/><br/>    &lt;ImageButton android:id="@id/exo_pause"<br/>        android:layout_width="80dp"<br/>        android:layout_height="80dp"<br/>        android:layout_gravity="center"<br/>        android:background="@drawable/pause"/&gt;<br/><br/>    &lt;ImageButton android:id="@id/exo_rew"<br/>        android:layout_width="60dp"<br/>        android:layout_height="60dp"<br/>        android:layout_gravity="left|center"<br/>        android:layout_marginRight="300dp"<br/>        android:background="@drawable/rewind"/&gt;<br/><br/>    &lt;ImageButton android:id="@id/exo_ffwd"<br/>        android:layout_width="60dp"<br/>        android:layout_height="60dp"<br/>        android:layout_gravity="right|center"<br/>        android:layout_marginLeft="300dp"<br/>        android:background="@drawable/fast_forward"/&gt;<br/><br/>    &lt;/FrameLayout&gt;<br/><br/>    &lt;LinearLayout<br/>        android:layout_width="match_parent"<br/>        android:layout_height="wrap_content"<br/>        android:layout_marginTop="4dp"<br/>        android:gravity="center_vertical"<br/>        android:layout_gravity="bottom"<br/>        android:layout_marginBottom="20dp"<br/>        android:orientation="horizontal"&gt;<br/><br/>        &lt;TextView<br/>            android:id="@id/exo_position"<br/>            android:layout_width="wrap_content"<br/>            android:layout_height="wrap_content"<br/>            android:includeFontPadding="false"<br/>            android:paddingLeft="4dp"<br/>            android:paddingRight="4dp"<br/>            android:textColor="@color/white"<br/>            android:textSize="14sp"<br/>            android:layout_marginLeft="10dp"<br/>            android:textStyle="bold" /&gt;<br/><br/>        &lt;com.google.android.exoplayer2.ui.DefaultTimeBar<br/>            android:id="@id/exo_progress"<br/>            android:layout_width="0dp"<br/>            android:layout_height="26dp"<br/>            android:layout_weight="1"<br/>            android:layout_marginLeft="10dp"<br/>            android:layout_marginRight="10dp"<br/>            app:played_color="@color/black"<br/>            app:unplayed_color="@color/white" /&gt;<br/><br/>        &lt;TextView<br/>            android:id="@id/exo_duration"<br/>            android:layout_width="wrap_content"<br/>            android:layout_height="wrap_content"<br/>            android:includeFontPadding="false"<br/>            android:paddingLeft="4dp"<br/>            android:paddingRight="4dp"<br/>            android:textColor="@color/white"<br/>            android:textSize="14sp"<br/>            android:layout_marginRight="10dp"<br/>            android:textStyle="bold" /&gt;<br/><br/>    &lt;/LinearLayout&gt;<br/><br/>&lt;/FrameLayout&gt;</span></pre><p id="c4fe" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这是自定义布局，我有我的自定义播放和暂停按钮，自定义快进和快退按钮，自定义进度条和计时器。为了映射我们用 exo 功能创建的所有 UI，我们需要确保 id 与 exoplayer ids 相同，它引导您使用我们的自定义视图来执行功能和覆盖操作。</p><h2 id="bf5d" class="mu lc in bd ld mv mw dn lh mx my dp ll jv mz na lp jz nb nc lt kd nd ne lx nf bi translated">播放视频</h2><p id="9bc7" class="pw-post-body-paragraph jk jl in jm b jn lz jp jq jr ma jt ju jv mb jx jy jz mc kb kc kd md kf kg kh ig bi translated">为了初始化 exoplayer，我们需要首先创建一个名为 initializePlayer 的函数</p><pre class="kq kr ks kt gt ng nh ni nj aw nk bi"><span id="c8fd" class="mu lc in nh b gy nl nm l nn no">private fun initializePlayer() {<br/>    player = ExoPlayer.Builder(<em class="np">applicationContext</em>).build()<br/>    exoPlayer.<em class="np">player </em>= player<br/>    exoPlayer.<em class="np">resizeMode </em>= AspectRatioFrameLayout.<em class="np">RESIZE_MODE_FILL<br/><br/>    </em>val mediaItem: MediaItem = MediaItem.fromUri("http://clips.vorwaerts-gmbh.de/VfE_html5.mp4")<br/>    player!!.setMediaItem(mediaItem)<br/>    player!!.prepare()<br/>    player!!.play()<br/>}</span></pre><p id="8ce7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">上面的代码显示了我们如何初始化播放器并向其添加视频。</p><pre class="kq kr ks kt gt ng nh ni nj aw nk bi"><span id="fa07" class="mu lc in nh b gy nl nm l nn no">val mediaItem: MediaItem = MediaItem.fromUri("http://clips.vorwaerts-gmbh.de/VfE_html5.mp4")</span></pre><p id="d303" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这是创建媒体项目时的视频 url，我们可以添加该 url，该视频将在 videoplayer 中播放</p><pre class="kq kr ks kt gt ng nh ni nj aw nk bi"><span id="6d2a" class="mu lc in nh b gy nl nm l nn no">player!!.setMediaItem(mediaItem)</span></pre><p id="d8a3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们需要将 mediaItem 添加到播放器中，最后准备并播放视频</p><pre class="kq kr ks kt gt ng nh ni nj aw nk bi"><span id="9614" class="mu lc in nh b gy nl nm l nn no">player!!.prepare()<br/>player!!.play()</span></pre><p id="e4a6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在 onStart 方法中调用 initializePlayer 函数</p><pre class="kq kr ks kt gt ng nh ni nj aw nk bi"><span id="847a" class="mu lc in nh b gy nl nm l nn no">override fun onStart() {<br/>    super.onStart()<br/>    initializePlayer()<br/>}</span></pre><h2 id="bdb3" class="mu lc in bd ld mv mw dn lh mx my dp ll jv mz na lp jz nb nc lt kd nd ne lx nf bi translated">画中画模式(画中画)</h2><p id="718f" class="pw-post-body-paragraph jk jl in jm b jn lz jp jq jr ma jt ju jv mb jx jy jz mc kb kc kd md kf kg kh ig bi translated">实现画中画模式是非常简单的，我们需要调用一个内置函数来进入画中画模式，但它总是在我们决定调用函数的基础上进入画中画模式的要求。画中画模式只不过是将更大的显示屏变成一个小屏幕，这将帮助我们在使用手机中的其他应用程序的同时进行多任务处理和观看视频。</p><pre class="kq kr ks kt gt ng nh ni nj aw nk bi"><span id="5142" class="mu lc in nh b gy nl nm l nn no">@RequiresApi(Build.VERSION_CODES.<em class="np">N</em>)<br/>override fun onBackPressed() {<br/>    if(!isPipMode!!) {<br/>        enterPictureInPictureMode()<br/>        isPipMode = true<br/>    } else {<br/>        super.onBackPressed()<br/>    }<br/>}</span></pre><p id="bd93" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我在使用 enterPictureInPictureMode()函数点击后退按钮时进入 PIP 模式。</p><h2 id="86ab" class="mu lc in bd ld mv mw dn lh mx my dp ll jv mz na lp jz nb nc lt kd nd ne lx nf bi translated"><strong class="ak">粘贴整个 MainActivity 类</strong></h2><pre class="kq kr ks kt gt ng nh ni nj aw nk bi"><span id="7bb6" class="mu lc in nh b gy nl nm l nn no">class MainActivity : AppCompatActivity(), Player.Listener {<br/><br/>    var player: ExoPlayer ?= null<br/>    var isPipMode: Boolean ?= false<br/><br/>    override fun onCreate(savedInstanceState: Bundle?) {<br/>        super.onCreate(savedInstanceState)<br/>        setContentView(R.layout.<em class="np">activity_main</em>)<br/>        hideSystemUI()<br/><br/>        viewShown.setOnClickListener <strong class="nh io">{<br/>            </strong>Handler().postDelayed(<strong class="nh io">{<br/>                </strong>hideSystemUI()<br/>            <strong class="nh io">}</strong>, 2000)<br/>        <strong class="nh io">}<br/>    </strong>}<br/><br/>    override fun onStart() {<br/>        super.onStart()<br/>        initializePlayer()<br/>    }<br/><br/>    override fun onStop() {<br/>        super.onStop()<br/>        player?.release()<br/>    }<br/><br/>    override fun onResume() {<br/>        super.onResume()<br/>        if(player!!.<em class="np">isPlaying</em>) {<br/>            isPipMode = false<br/>        }<br/>    }<br/><br/>    private fun initializePlayer() {<br/>        player = ExoPlayer.Builder(<em class="np">applicationContext</em>).build()<br/>        exoPlayer.<em class="np">player </em>= player<br/>        exoPlayer.<em class="np">resizeMode </em>= AspectRatioFrameLayout.<em class="np">RESIZE_MODE_FILL<br/><br/>        </em>val mediaItem: MediaItem = MediaItem.fromUri("http://clips.vorwaerts-gmbh.de/VfE_html5.mp4")<br/>        player!!.setMediaItem(mediaItem)<br/>        player!!.prepare()<br/>        player!!.play()<br/>    }<br/><br/>    @RequiresApi(Build.VERSION_CODES.<em class="np">N</em>)<br/>    override fun onBackPressed() {<br/>        if(!isPipMode!!) {<br/>            enterPictureInPictureMode()<br/>            isPipMode = true<br/>        } else {<br/>            super.onBackPressed()<br/>        }<br/>    }<br/>  <br/>    private fun hideSystemUI() {<br/>        <em class="np">// Set the IMMERSIVE flag.<br/>        // Set the content to appear under the system bars so that the content<br/>        // doesn't resize when the system bars hide and show.<br/>        window</em>.<em class="np">decorView</em>.setSystemUiVisibility(<br/>            View.<em class="np">SYSTEM_UI_FLAG_LAYOUT_STABLE<br/>                    </em>or View.<em class="np">SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION<br/>                    </em>or View.<em class="np">SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN<br/>                    </em>or View.<em class="np">SYSTEM_UI_FLAG_HIDE_NAVIGATION // hide nav bar<br/>                    </em>or View.<em class="np">SYSTEM_UI_FLAG_FULLSCREEN // hide status bar<br/>                    </em>or View.<em class="np">SYSTEM_UI_FLAG_IMMERSIVE<br/>        </em>)<br/>    }<br/><br/>}</span></pre><h2 id="f016" class="mu lc in bd ld mv mw dn lh mx my dp ll jv mz na lp jz nb nc lt kd nd ne lx nf bi translated">输出</h2><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi nq"><img src="../Images/12c7a0cfb2c9edc0499eab9c4f557a90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X-HozR2t8BF8gWmchQIvqw.jpeg"/></div></div><figcaption class="nr ns gj gh gi nt nu bd b be z dk translated">自定义 exoplayer 布局</figcaption></figure><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi nq"><img src="../Images/0516bbea86ab4b8de530b6c2606ec73e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XH1W993cq-jyWCZYiwhREQ.jpeg"/></div></div></figure><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/208af3f90dc98aef904ed7252987d565.png" data-original-src="https://miro.medium.com/v2/resize:fit:1080/format:webp/1*dMsBqZtfb9vMhYkKFRJopA.jpeg"/></div><figcaption class="nr ns gj gh gi nt nu bd b be z dk translated">画中画模式</figcaption></figure><p id="6557" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">编码快乐！..谢谢你..</p></div></div>    
</body>
</html>