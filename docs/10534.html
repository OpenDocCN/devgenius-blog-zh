<html>
<head>
<title>Kafka with Python Fast-API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Python Fast-API 的 Kafka</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/kafka-with-python-fast-api-b1622eb7f9d0?source=collection_archive---------0-----------------------#2022-11-09">https://blog.devgenius.io/kafka-with-python-fast-api-b1622eb7f9d0?source=collection_archive---------0-----------------------#2022-11-09</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div class="gh gi jk"><img src="../Images/5ba463a5626ae340b0c13e9132bdcaa6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1100/format:webp/0*fr4B7qEbDrw0fnYe.png"/></div></figure><h1 id="77a3" class="jr js in bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">使用 Python 的 Kafka(快速 API)</h1><p id="c6ed" class="pw-post-body-paragraph kp kq in kr b ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">在上一个主题中，我们在 cli 的帮助下创建了 Kafka 主题，在这个博客中，我们将在 python 的帮助下创建 Kafka 主题</p><p id="b3c8" class="pw-post-body-paragraph kp kq in kr b ks ln ku kv kw lo ky kz la lp lc ld le lq lg lh li lr lk ll lm ig bi translated">Github 链接:<a class="ae ls" href="https://github.com/SohaibAnwaar/Kafka-Python-FastAPI-Topic-Creation-" rel="noopener ugc nofollow" target="_blank">https://github . com/SohaibAnwaar/Kafka-Python-FastAPI-Topic-Creation-</a></p><h1 id="4aef" class="jr js in bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">用 docker 安装 Kafka</h1><blockquote class="lt lu lv"><p id="1b08" class="kp kq lw kr b ks ln ku kv kw lo ky kz lx lp lc ld ly lq lg lh lz lr lk ll lm ig bi translated"><em class="in">往期博客链接:</em><a class="ae ls" href="https://medium.com/dev-genius/kafka-installtions-and-kafka-topics-f0b7c81754d8" rel="noopener"><em class="in">https://medium . com/dev-genius/Kafka-installations-and-Kafka-topics-f0b7c 81754 D8</em></a></p></blockquote><h1 id="d5bd" class="jr js in bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">装置</h1><ol class=""><li id="40b2" class="ma mb in kr b ks kt kw kx la mc le md li me lm mf mg mh mi bi translated">安装 python &gt;= 3.6</li><li id="eebe" class="ma mb in kr b ks mj kw mk la ml le mm li mn lm mf mg mh mi bi translated">制作虚拟环境</li><li id="c33a" class="ma mb in kr b ks mj kw mk la ml le mm li mn lm mf mg mh mi bi translated">运行命令<code class="fe mo mp mq mr b">pip install -r requirements.txt</code></li></ol><h1 id="ce38" class="jr js in bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">代码部分</h1><p id="5ee9" class="pw-post-body-paragraph kp kq in kr b ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">安装完所有的东西后，现在让我们深入到代码部分，我们的 Kafka 实例运行在端口<code class="fe mo mp mq mr b">9092, 9093, 9094</code>上，所以让我们把它写在 env 文件中。</p><p id="1299" class="pw-post-body-paragraph kp kq in kr b ks ln ku kv kw lo ky kz la lp lc ld le lq lg lh li lr lk ll lm ig bi translated">环境文件</p><pre class="ms mt mu mv gt mw mr mx my aw mz bi"><span id="b2b0" class="na js in mr b gy nb nc l nd ne">BOOTSTRAP-SERVERS="localhost:9092,localhost:9093,localhost:9094"<br/>TOPIC_PEOPLE_BASIC_NAME="people.basic.python"<br/>TOPIC_PEOPLE_BASIC_PARTITIONS=3<br/>TOPIC_PEOPLE_BASIC_REPLICATION_FACTOR=3</span></pre><h1 id="a100" class="jr js in bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">Python 代码</h1><p id="bd77" class="pw-post-body-paragraph kp kq in kr b ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">进口</p><pre class="ms mt mu mv gt mw mr mx my aw mz bi"><span id="05eb" class="na js in mr b gy nb nc l nd ne">import os<br/># env and Fast api import<br/>from dotenv import load_dotenv<br/>from fastapi import FastApi<br/># Kafka Imports<br/>from kafka import KafkaAdminClient<br/>from kafka.admin import NewTopic<br/>from kafka.errors import TopicAlreadyExistsError</span></pre><p id="1d0b" class="pw-post-body-paragraph kp kq in kr b ks ln ku kv kw lo ky kz la lp lc ld le lq lg lh li lr lk ll lm ig bi translated">设置快速 API</p><pre class="ms mt mu mv gt mw mr mx my aw mz bi"><span id="db80" class="na js in mr b gy nb nc l nd ne"># Load env file<br/>load_dotenv(verbose=True)<br/># Fast API instance<br/>app = FastApi()</span></pre><p id="d32f" class="pw-post-body-paragraph kp kq in kr b ks ln ku kv kw lo ky kz la lp lc ld le lq lg lh li lr lk ll lm ig bi translated">启动事件要添加一个应该在应用程序启动前运行的函数，用事件声明它，让我们创建一个启动事件，在这个事件中，我们用 env 文件中提到的所有代理服务器初始化我们的管理客户端</p><pre class="ms mt mu mv gt mw mr mx my aw mz bi"><span id="4669" class="na js in mr b gy nb nc l nd ne">@app.on_event("startup")<br/>async def startup_event():<br/>    # Kafka Admin Client<br/>    client = KafkaAdminClient(<br/>        bootstrap_servers=os.environ.get("BOOTSTRAP-SERVERS"))<br/>    # Creating topic<br/>    topic = NewTopic(name=os.environ.get("TOPIC_PEOPLE_BASIC_NAME"),<br/>                     num_partitions=int(os.environ.get("TOPIC_PEOPLE_BASIC_PARTITIONS")),<br/>                     replication_factor=int(os.environ.get("TOPIC_PEOPLE_BASIC_REPLICATION_FACTOR")))<br/>    # If topic already exists, it will throw an error<br/>    try:<br/>        # Creating topic<br/>        client.create_topics(new_topics=[topic], validate_only=False)<br/>    except TopicAlreadyExistsError:<br/>        pass<br/>    finally:<br/>        # Close the client<br/>        client.close()</span><span id="bf9d" class="na js in mr b gy nf nc l nd ne">@app.get("/")<br/>async def root():<br/>    return {"message": "Hello World"}</span></pre><p id="9592" class="pw-post-body-paragraph kp kq in kr b ks ln ku kv kw lo ky kz la lp lc ld le lq lg lh li lr lk ll lm ig bi translated">在终端上运行命令</p><pre class="ms mt mu mv gt mw mr mx my aw mz bi"><span id="b190" class="na js in mr b gy nb nc l nd ne">uvicorn app:app --reload</span></pre><p id="123f" class="pw-post-body-paragraph kp kq in kr b ks ln ku kv kw lo ky kz la lp lc ld le lq lg lh li lr lk ll lm ig bi translated">输出</p><pre class="ms mt mu mv gt mw mr mx my aw mz bi"><span id="767c" class="na js in mr b gy nb nc l nd ne">INFO:     Will watch for changes in these directories: ['/home/sohaib/Documents/Kafka/kafka_python']<br/>INFO:     Uvicorn running on <a class="ae ls" href="http://127.0.0.1:8000" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:8000</a> (Press CTRL+C to quit)<br/>INFO:     Started reloader process [25125] using watchgod<br/>INFO:     Started server process [25127]<br/>INFO:     Waiting for application startup.<br/>Creating topic people.basic.python<br/>INFO:     Application startup complete.</span></pre><p id="3a61" class="pw-post-body-paragraph kp kq in kr b ks ln ku kv kw lo ky kz la lp lc ld le lq lg lh li lr lk ll lm ig bi translated">现在我们来验证一下我们的话题是不是建立在卡夫卡身上的</p><p id="4090" class="pw-post-body-paragraph kp kq in kr b ks ln ku kv kw lo ky kz la lp lc ld le lq lg lh li lr lk ll lm ig bi translated">运行命令</p><pre class="ms mt mu mv gt mw mr mx my aw mz bi"><span id="640a" class="na js in mr b gy nb nc l nd ne">docker exec -it cli-tools kafka-topics --list --bootstrap-server broker0:29092,broker1:29093,broker2:29094</span></pre><p id="0046" class="pw-post-body-paragraph kp kq in kr b ks ln ku kv kw lo ky kz la lp lc ld le lq lg lh li lr lk ll lm ig bi translated">输出</p><figure class="ms mt mu mv gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="nh ni di nj bf nk"><div class="gh gi ng"><img src="../Images/4fc70dde76feaef1e0b15ebe3f058571.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*JEPZ1jF5HbAzMrjc.png"/></div></div></figure><p id="d85e" class="pw-post-body-paragraph kp kq in kr b ks ln ku kv kw lo ky kz la lp lc ld le lq lg lh li lr lk ll lm ig bi translated">因此，我们成功地用 python 制作了一个卡夫卡主题</p><h1 id="8c94" class="jr js in bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">创建主题时的高级配置</h1><p id="fea7" class="pw-post-body-paragraph kp kq in kr b ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">通过 python 创建时，要在主题中添加高级配置，你只需要在主题中添加一个参数<code class="fe mo mp mq mr b">topic-config</code></p><p id="c06a" class="pw-post-body-paragraph kp kq in kr b ks ln ku kv kw lo ky kz la lp lc ld le lq lg lh li lr lk ll lm ig bi translated">比如下面的代码</p><pre class="ms mt mu mv gt mw mr mx my aw mz bi"><span id="f038" class="na js in mr b gy nb nc l nd ne">topic = NewTopic(name=os.environ.get("TOPIC_PEOPLE_BASIC_NAME"),<br/>                     num_partitions=int(os.environ.get("TOPIC_PEOPLE_BASIC_PARTITIONS")),<br/>                     replication_factor=int(os.environ.get("TOPIC_PEOPLE_BASIC_REPLICATION_FACTOR")),<br/>                     topic_configs={"cleanup.policy": "compact"})</span></pre><h1 id="c819" class="jr js in bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">更新主题时的高级配置</h1><p id="805d" class="pw-post-body-paragraph kp kq in kr b ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">要更新主题的高级配置，可以使用以下代码。</p><pre class="ms mt mu mv gt mw mr mx my aw mz bi"><span id="ad90" class="na js in mr b gy nb nc l nd ne"># Updating Kafka Config<br/>cfg_resources_update = ConfigResource(<br/>    ConfigResourceType.TOPIC,<br/>    os.environ.get("TOPIC_PEOPLE_BASIC_NAME"),<br/>    configs={"retention.ms": "360"})<br/>client.alter_configs([cfg_resources_update])</span></pre><h1 id="dceb" class="jr js in bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">验证高级配置</h1><p id="2760" class="pw-post-body-paragraph kp kq in kr b ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">要验证高级配置，您可以使用以下命令</p><pre class="ms mt mu mv gt mw mr mx my aw mz bi"><span id="7bf6" class="na js in mr b gy nb nc l nd ne">docker exec -it cli-tools kafka-topics --describe all --bootstrap-server broker0:29092,broker1:29093,broker2:29094 --topic people.basic.python</span></pre><p id="33ab" class="pw-post-body-paragraph kp kq in kr b ks ln ku kv kw lo ky kz la lp lc ld le lq lg lh li lr lk ll lm ig bi translated">输出</p><figure class="ms mt mu mv gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="nh ni di nj bf nk"><div class="gh gi nl"><img src="../Images/9c4d43e8f37c5b304edaecc02d656bba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*d43fFDz0aeBY-iUT.png"/></div></div></figure><h1 id="3a2f" class="jr js in bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">作者</h1><ul class=""><li id="73e6" class="ma mb in kr b ks kt kw kx la mc le md li me lm nm mg mh mi bi translated">索海卜·安瓦尔:<a class="ae ls" href="https://www.sohaibanwaar.com/" rel="noopener ugc nofollow" target="_blank">https://www.sohaibanwaar.com</a></li><li id="be39" class="ma mb in kr b ks mj kw mk la ml le mm li mn lm nm mg mh mi bi translated">Gmail:<a class="ae ls" href="mailto:sohaibanwaar36@gmail.com" rel="noopener ugc nofollow" target="_blank">sohaibanwaar36@gmail.com</a></li><li id="b5ba" class="ma mb in kr b ks mj kw mk la ml le mm li mn lm nm mg mh mi bi translated">LinkedIn : <a class="ae ls" href="https://www.linkedin.com/in/sohaib-anwaar-4b7ba1187/" rel="noopener ugc nofollow" target="_blank">在这里做一些专业的谈话</a></li><li id="7c8d" class="ma mb in kr b ks mj kw mk la ml le mm li mn lm nm mg mh mi bi translated">堆栈溢出:<a class="ae ls" href="https://stackoverflow.com/users/7959545/sohaib-anwaar" rel="noopener ugc nofollow" target="_blank">在这里获得我的帮助</a></li><li id="a744" class="ma mb in kr b ks mj kw mk la ml le mm li mn lm nm mg mh mi bi translated">在这里查看我的杰作</li><li id="da74" class="ma mb in kr b ks mj kw mk la ml le mm li mn lm nm mg mh mi bi translated">GitHub : <a class="ae ls" href="https://github.com/SohaibAnwaar" rel="noopener ugc nofollow" target="_blank">在这里查看我的代码</a></li></ul></div></div>    
</body>
</html>