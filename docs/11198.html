<html>
<head>
<title>Sign JWT Token using a PFX certificate — PowerShell v7.3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 PFX 证书对 JWT 令牌进行签名— PowerShell v7.3</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/sign-jwt-token-using-a-pfx-certificate-powershell-v7-3-69330816bc76?source=collection_archive---------8-----------------------#2022-12-24">https://blog.devgenius.io/sign-jwt-token-using-a-pfx-certificate-powershell-v7-3-69330816bc76?source=collection_archive---------8-----------------------#2022-12-24</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><div class=""/><figure class="gm go jp jq jr js gi gj paragraph-image"><div role="button" tabindex="0" class="jt ju di jv bf jw"><div class="gi gj jo"><img src="../Images/be10ed504dfeb8f396b588d6bbf95ce0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*n4E1h5rYAzji95Jx"/></div></div><figcaption class="jz ka gk gi gj kb kc bd b be z dk translated">照片由<a class="ae kd" href="https://unsplash.com/es/@flyd2069?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">飞:D </a>在<a class="ae kd" href="https://unsplash.com/?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></figcaption></figure><p id="2221" class="pw-post-body-paragraph ke kf ir kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ik bi translated">上一篇文章介绍了使用 PFX 证书签署 JWT 令牌的理论概念。在本文中，我将编写一个 PowerShell 脚本，使用 pfx 证书和密码对 JWT 令牌进行签名。</p><p id="f913" class="pw-post-body-paragraph ke kf ir kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ik bi translated">我已经在 PowerShell 7.3 中编写了这个脚本，但是您将无法在 Windows PowerShell 中执行它。Windows Powershell 的最新版本是 5.1，不支持某些 dll。我通过用<a class="ae kd" rel="noopener ugc nofollow" target="_blank" href="/sign-jwt-token-using-a-pfx-certificate-net-6-0-c9e07807e180?sk=238ae592c45ac073e560e30c51e6d8ac">转换我的代码创建了这篇文章。Net 6.0 </a>。Windows PowerShell 不支持将库作为的一部分。Net 6.0。</p><p id="14d9" class="pw-post-body-paragraph ke kf ir kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ik bi translated">阅读这篇<a class="ae kd" href="https://learn.microsoft.com/en-us/powershell/scripting/whats-new/differences-from-windows-powershell?view=powershell-7.3" rel="noopener ugc nofollow" target="_blank">文章</a>了解 PowerShell&amp;Windows PowerShell 的区别。</p><p id="f158" class="pw-post-body-paragraph ke kf ir kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ik bi translated">要创建和签名 JWT 令牌，我们需要执行以下步骤:</p></div><div class="ab cl lc ld hv le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ik il im in io"><h2 id="114a" class="lj lk ir bd ll lm ln dn lo lp lq dp lr kp ls lt lu kt lv lw lx kx ly lz ma mb bi translated">步骤 1 —添加库</h2><p id="b07b" class="pw-post-body-paragraph ke kf ir kg b kh mc kj kk kl md kn ko kp me kr ks kt mf kv kw kx mg kz la lb ik bi translated">请添加以下库来支持 PowerShell 脚本:</p><ol class=""><li id="1a4f" class="mh mi ir kg b kh ki kl km kp mj kt mk kx ml lb mm mn mo mp bi translated">微软。IdentityModel.Logging.dll</li><li id="0615" class="mh mi ir kg b kh mq kl mr kp ms kt mt kx mu lb mm mn mo mp bi translated">微软。IdentityModel.Tokens.dll</li><li id="04ef" class="mh mi ir kg b kh mq kl mr kp ms kt mt kx mu lb mm mn mo mp bi translated">微软。IdentityModel.JsonWebTokens.dll</li><li id="5c52" class="mh mi ir kg b kh mq kl mr kp ms kt mt kx mu lb mm mn mo mp bi translated">微软。IdentityModel.Abstractions.dll</li></ol><pre class="mv mw mx my gu mz na nb bn nc nd bi"><span id="e2e1" class="ne lk ir na b be nf ng l nh ni">Add-Type -Path ‘C:\Users\tarunb\\.nuget\packages\microsoft.identitymodel.logging\6.25.1\lib\net6.0\Microsoft.IdentityModel.Logging.dll’<br/>Add-Type -Path ‘C:\\Users\\tarunb\\.nuget\\packages\\microsoft.identitymodel.tokens\\6.25.1\lib\\net6.0\\Microsoft.IdentityModel.Tokens.dll’<br/>Add-Type -Path ‘C:\\Users\\tarunb\\.nuget\\packages\\microsoft.identitymodel.jsonwebtokens\\6.25.1\lib\\net6.0\\Microsoft.IdentityModel.JsonWebTokens.dll’<br/>Add-Type -Path ‘C:\\Users\\tarunb\\.nuget\\packages\\microsoft.identitymodel.abstractions\\6.25.1\lib\\net6.0\\Microsoft.IdentityModel.Abstractions.dll’</span></pre><p id="6b0a" class="pw-post-body-paragraph ke kf ir kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ik bi translated">所有这四个库都是。Net 6.0。</p><h2 id="9308" class="lj lk ir bd ll lm ln dn lo lp lq dp lr kp ls lt lu kt lv lw lx kx ly lz ma mb bi translated">步骤 2—创建 X509Certificate2Collection 类型的实例</h2><p id="9010" class="pw-post-body-paragraph ke kf ir kg b kh mc kj kk kl md kn ko kp me kr ks kt mf kv kw kx mg kz la lb ik bi translated">创建 X509Certificate2Collection 类型的实例。</p><blockquote class="nj"><p id="0090" class="nk nl ir bd nm nn no np nq nr ns lb dk translated"><a class="ae kd" href="https://learn.microsoft.com/en-us/dotnet/api/system.security.cryptography.x509certificates.x509certificate2collection?view=net-7.0" rel="noopener ugc nofollow" target="_blank"> X509Certificate2Collection 表示 X509Certificate2 对象的集合。该类不能被继承。</a></p></blockquote><pre class="nt nu nv nw nx mz na nb bn nc nd bi"><span id="915d" class="ne lk ir na b be nf ng l nh ni">$certCollection = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2Collection</span></pre><h2 id="bc11" class="lj lk ir bd ll lm ln dn lo lp lq dp lr kp ls lt lu kt lv lw lx kx ly lz ma mb bi translated">步骤 3-将 PFX 文件导入集合</h2><p id="1071" class="pw-post-body-paragraph ke kf ir kg b kh mc kj kk kl md kn ko kp me kr ks kt mf kv kw kx mg kz la lb ik bi translated">使用类 X509Certificate2Collection 的实例来<a class="ae kd" href="https://learn.microsoft.com/en-us/dotnet/api/system.security.cryptography.x509certificates.x509certificate2collection.import?view=net-7.0#system-security-cryptography-x509certificates-x509certificate2collection-import(system-string-system-readonlyspan((system-char))-system-security-cryptography-x509certificates-x509keystorageflags)" rel="noopener ugc nofollow" target="_blank">导入一个需要密码</a>才能查看证书详细信息的证书文件。</p><pre class="mv mw mx my gu mz na nb bn nc nd bi"><span id="6d40" class="ne lk ir na b be nf ng l nh ni">$certFilePath = "C:\\Users\\tarun\\OneDrive - TAL Limited\\Claims\\CRE\\test-services-tal.firstsolutions.com.au (1).pfx";<br/>$certPassword = "password"<br/>$certCollection.Import($certFilePath, $certPassword, [System.Security.Cryptography.X509Certificates.X509KeyStorageFlags]::PersistKeySet)</span></pre><p id="aa63" class="pw-post-body-paragraph ke kf ir kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ik bi translated">使用参数 X509KeyStorageFlags 的原因。PersistKeySet 是为了避免下面的异常</p><pre class="mv mw mx my gu mz na nb bn nc nd bi"><span id="fb7f" class="ne lk ir na b be nf ng l nh ni">System.Security.Cryptography.CryptographicException: Keyset does not exist.</span></pre><p id="d326" class="pw-post-body-paragraph ke kf ir kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ik bi translated">在这里阅读其背后的原因<a class="ae kd" href="https://learn.microsoft.com/en-us/troubleshoot/developer/dotnet/framework/general/install-pfx-file-using-x509certificate" rel="noopener ugc nofollow" target="_blank">。</a></p><h2 id="7f94" class="lj lk ir bd ll lm ln dn lo lp lq dp lr kp ls lt lu kt lv lw lx kx ly lz ma mb bi translated">步骤 4—获取 X509Certificate2 的实例</h2><p id="d9f1" class="pw-post-body-paragraph ke kf ir kg b kh mc kj kk kl md kn ko kp me kr ks kt mf kv kw kx mg kz la lb ik bi translated">因为集合中只有一个证书，所以我们可以通过获取第一个条目来获得 X509 证书的实例。</p><pre class="mv mw mx my gu mz na nb bn nc nd bi"><span id="d343" class="ne lk ir na b be nf ng l nh ni">$certificate = $certCollection[0]</span></pre><h2 id="538c" class="lj lk ir bd ll lm ln dn lo lp lq dp lr kp ls lt lu kt lv lw lx kx ly lz ma mb bi translated">步骤 5—创建 RsaSecurityKey 类的实例</h2><p id="42d3" class="pw-post-body-paragraph ke kf ir kg b kh mc kj kk kl md kn ko kp me kr ks kt mf kv kw kx mg kz la lb ik bi translated"><a class="ae kd" href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.identitymodel.tokens.rsasecuritykey?view=azure-dotnet" rel="noopener ugc nofollow" target="_blank"> RsaSecurityKey </a>类代表一个 Rsa 安全密钥。</p><pre class="mv mw mx my gu mz na nb bn nc nd bi"><span id="8edc" class="ne lk ir na b be nf ng l nh ni">$rsaPrivateKey = $certificate.PrivateKey<br/>$privateSecurityKey = New-Object Microsoft.IdentityModel.Tokens.RsaSecurityKey($rsaPrivateKey)</span></pre><h2 id="2b36" class="lj lk ir bd ll lm ln dn lo lp lq dp lr kp ls lt lu kt lv lw lx kx ly lz ma mb bi translated">步骤 6 —向令牌添加属性</h2><p id="04a1" class="pw-post-body-paragraph ke kf ir kg b kh mc kj kk kl md kn ko kp me kr ks kt mf kv kw kx mg kz la lb ik bi translated">下一步是准备令牌的属性。</p><pre class="mv mw mx my gu mz na nb bn nc nd bi"><span id="5ab0" class="ne lk ir na b be nf ng l nh ni">$descriptor = New-Object Microsoft.IdentityModel.Tokens.SecurityTokenDescriptor<br/>$descriptor.Audience = "Audience"<br/>$descriptor.Issuer = "Issuer"<br/>$descriptor.IssuedAt = Get-Date<br/>$descriptor.NotBefore = Get-Date<br/>$expiryInMinutes = New-TimeSpan -Minutes 55<br/>$descriptor.Expires = (Get-Date) + $expiryInMinutes<br/>$descriptor.Subject = New-Object System.Security.Claims.ClaimsIdentity<br/>$claims = New-Object System.Security.Claims.Claim[] 0<br/>$descriptor.Subject = New-Object System.Security.Claims.ClaimsIdentity($claims)<br/>$SigningCredentials = New-Object Microsoft.IdentityModel.Tokens.SigningCredentials($privateSecurityKey,"http://www.w3.org/2001/04/xmldsig-more#rsa-sha256")<br/>$descriptor.SigningCredentials = $SigningCredentials</span></pre><h2 id="a464" class="lj lk ir bd ll lm ln dn lo lp lq dp lr kp ls lt lu kt lv lw lx kx ly lz ma mb bi translated">步骤 7 —创建 JsonWebTokenHandler 的实例</h2><p id="d835" class="pw-post-body-paragraph ke kf ir kg b kh mc kj kk kl md kn ko kp me kr ks kt mf kv kw kx mg kz la lb ik bi translated"><a class="ae kd" href="https://learn.microsoft.com/en-us/previous-versions/visualstudio/dn464181(v=vs.114)" rel="noopener ugc nofollow" target="_blank"> JsonWebTokenHandler </a>是一个<a class="ae kd" href="https://msdn.microsoft.com/en-us/library/hh193414(v=vs.114)" rel="noopener ugc nofollow" target="_blank"> SecurityTokenHandler </a>用于创建和验证 JSON Web 令牌(JWT)。有关 JWT 规范的更多信息，请参见<a class="ae kd" href="http://tools.ietf.org/html/draft-ietf-oauth-json-web-token-07" rel="noopener ugc nofollow" target="_blank">http://tools . IETF . org/html/draft-IETF-oauth-JSON-we b-token-07</a>。</p><pre class="mv mw mx my gu mz na nb bn nc nd bi"><span id="c1ad" class="ne lk ir na b be nf ng l nh ni">$handler = New-Object Microsoft.IdentityModel.JsonWebTokens.JsonWebTokenHandler</span></pre><h2 id="131e" class="lj lk ir bd ll lm ln dn lo lp lq dp lr kp ls lt lu kt lv lw lx kx ly lz ma mb bi translated">步骤 8-签署 JWT 令牌</h2><p id="9d0b" class="pw-post-body-paragraph ke kf ir kg b kh mc kj kk kl md kn ko kp me kr ks kt mf kv kw kx mg kz la lb ik bi translated">最后一步是通过调用 JsonWebTokenHandler 类上的 CreateToken 方法，使用 RSA 私有安全密钥进行签名来创建 JWT 令牌。</p><pre class="mv mw mx my gu mz na nb bn nc nd bi"><span id="a5c8" class="ne lk ir na b be nf ng l nh ni">$token = $handler.CreateToken($descriptor);<br/>$token</span></pre></div><div class="ab cl lc ld hv le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ik il im in io"><h1 id="3dca" class="ny lk ir bd ll nz oa ob lo oc od oe lr of og oh lu oi oj ok lx ol om on ma oo bi translated">最终版</h1><p id="b445" class="pw-post-body-paragraph ke kf ir kg b kh mc kj kk kl md kn ko kp me kr ks kt mf kv kw kx mg kz la lb ik bi translated">该脚本的最终版本将是这样的</p><figure class="mv mw mx my gu js"><div class="bz fq l di"><div class="op oq l"/></div></figure></div><div class="ab cl lc ld hv le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ik il im in io"><p id="fae1" class="pw-post-body-paragraph ke kf ir kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb ik bi translated">页（page 的缩写）s-Medium 是一个阅读、写作和向其他作者学习的绝佳平台。如果你想加入我的旅程，今天就加入<a class="ae kd" href="https://tarunbhatt9784.medium.com/membership" rel="noopener"> medium </a>。</p></div></div>    
</body>
</html>