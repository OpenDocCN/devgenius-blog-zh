<html>
<head>
<title>How to install Metrics Server on Kubernetes cluster</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在 Kubernetes 集群上安装度量服务器</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/how-to-install-metrics-server-on-kubernetes-cluster-60dd754873c2?source=collection_archive---------5-----------------------#2021-12-22">https://blog.devgenius.io/how-to-install-metrics-server-on-kubernetes-cluster-60dd754873c2?source=collection_archive---------5-----------------------#2021-12-22</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><h1 id="da22" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">背景</h1><p id="2554" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">这篇文章是关于在 Kubernetes 集群上安装度量服务器的。在上一篇文章的<a class="ae lg" href="https://www.handsonarchitect.com/2021/12/how-to-bootstrap-multi-node-kubernetes.html" rel="noopener ugc nofollow" target="_blank">中，我们已经配置了一个 3 节点 Kubernetes 集群。在多节点集群中，工作负载将在不同的节点上进行调度。如果我们想要找出哪些单元消耗了更多的资源或者哪些节点拥有更多的资源，我们需要某种方法来聚合单元级别的指标。这就是</a><a class="ae lg" href="https://github.com/kubernetes-sigs/metrics-server" rel="noopener ugc nofollow" target="_blank">度量服务器</a>的用武之地。</p><h1 id="54da" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">如何在 Kubernetes 集群上安装度量服务器</h1><p id="be15" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">Kubernetes 不提供默认的指标聚合器。我们需要安装度量服务器，它有助于收集容器级别的度量，如 CPU 或 RAM 的使用情况。这些指标可以被其他 Kubernetes APIs 和对象使用，如<strong class="kk io">水平 Pod 自动缩放器(HPA) </strong>或<strong class="kk io">垂直 Pod 自动缩放器(VPA) </strong>。</p><p id="1a4b" class="pw-post-body-paragraph ki kj in kk b kl lh kn ko kp li kr ks kt lj kv kw kx lk kz la lb ll ld le lf ig bi translated">我们将使用一个清单文件将所需的组件安装到我们的 Kubernetes 集群上。清单文件可以在 Metrics Server 项目的 Github repo 中获得。运行以下命令来应用清单</p><p id="4a59" class="pw-post-body-paragraph ki kj in kk b kl lh kn ko kp li kr ks kt lj kv kw kx lk kz la lb ll ld le lf ig bi translated"><strong class="kk io">kubectl apply-f</strong><a class="ae lg" href="https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml" rel="noopener ugc nofollow" target="_blank"><strong class="kk io">https://github . com/kubernetes-sigs/metrics-server/releases/latest/download/components . YAML</strong></a></p><p id="b31f" class="pw-post-body-paragraph ki kj in kk b kl lh kn ko kp li kr ks kt lj kv kw kx lk kz la lb ll ld le lf ig bi translated">这将创建服务帐户、集群角色的 RBAC、集群角色绑定、将度量服务器公开为服务等。通过在 kube-system 名称空间中列出 pod 来验证这些</p><figure class="ln lo lp lq gt lr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi lm"><img src="../Images/1eecf217f4e4bff8ff51973d3ea4f010.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*stF3xcWQMtGmN5Y0"/></div></div></figure><p id="d6f3" class="pw-post-body-paragraph ki kj in kk b kl lh kn ko kp li kr ks kt lj kv kw kx lk kz la lb ll ld le lf ig bi translated">我们可以看到 metrics-server pod 正在运行，但是容器还没有准备好。使用 Kubectl 的 describe 命令来确定原因。</p><p id="f8bd" class="pw-post-body-paragraph ki kj in kk b kl lh kn ko kp li kr ks kt lj kv kw kx lk kz la lb ll ld le lf ig bi translated"><strong class="kk io">kube CTL-n kube-系统描述 pod 指标-服务器- &lt; &lt;动态-名称&gt; &gt; </strong></p><figure class="ln lo lp lq gt lr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi ly"><img src="../Images/e2a4cedf639a0bb6bc3a27302a73fe08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*V0znTJ86hWzau17j"/></div></div></figure><p id="3170" class="pw-post-body-paragraph ki kj in kk b kl lh kn ko kp li kr ks kt lj kv kw kx lk kz la lb ll ld le lf ig bi translated">在 events 部分，我们可以看到一个警告，提示就绪性探测失败。这是因为 pod 无法与 Kube API 服务器建立通信。我们需要覆盖一些默认值来解决这个问题。</p><h1 id="bbb4" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">覆盖度量服务器命令</h1><p id="414c" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们将去编辑指标-服务器部署。使用以下命令编辑部署</p><p id="87b3" class="pw-post-body-paragraph ki kj in kk b kl lh kn ko kp li kr ks kt lj kv kw kx lk kz la lb ll ld le lf ig bi translated"><strong class="kk io">k-n kube-系统编辑部署指标-服务器</strong></p><p id="7eb0" class="pw-post-body-paragraph ki kj in kk b kl lh kn ko kp li kr ks kt lj kv kw kx lk kz la lb ll ld le lf ig bi translated">向下滚动到我们定义容器设置的部分。在图像标签之前添加以下行。</p><p id="aba8" class="pw-post-body-paragraph ki kj in kk b kl lh kn ko kp li kr ks kt lj kv kw kx lk kz la lb ll ld le lf ig bi translated"><strong class="kk io"> <em class="lz">命令:</em> </strong></p><p id="ef8b" class="pw-post-body-paragraph ki kj in kk b kl lh kn ko kp li kr ks kt lj kv kw kx lk kz la lb ll ld le lf ig bi translated"><strong class="kk io"><em class="lz">—/metrics-server</em></strong></p><p id="a678" class="pw-post-body-paragraph ki kj in kk b kl lh kn ko kp li kr ks kt lj kv kw kx lk kz la lb ll ld le lf ig bi translated"><strong class="kk io"><em class="lz">———kube let-unsecure-TLS</em></strong></p><p id="19bc" class="pw-post-body-paragraph ki kj in kk b kl lh kn ko kp li kr ks kt lj kv kw kx lk kz la lb ll ld le lf ig bi translated"><strong class="kk io"><em class="lz">———kube let-preferred-address-types = internal IP</em></strong></p><p id="da68" class="pw-post-body-paragraph ki kj in kk b kl lh kn ko kp li kr ks kt lj kv kw kx lk kz la lb ll ld le lf ig bi translated">保存更改。该部署将终止旧版本的 pod，并为 metrics server 重新创建一个新的 pod。完成上述更改后，我们将能够在 Kubernetes 集群上成功运行 metrics 服务器。</p><h1 id="4c02" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">验证度量服务器功能</h1><p id="69da" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">运行带有 node 和 pods 子命令的 top 命令，分别找出 node 和 pods 级别的资源使用情况。我们还可以通过将— containers 标志传递给<strong class="kk io"><em class="lz">ku bectl top pods—containers</em></strong>来检查单个容器级别的资源使用情况。下面的截图显示了这些命令的输出</p><figure class="ln lo lp lq gt lr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi ma"><img src="../Images/a2d653a7be4d3f3b731c4cb45c35229e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ewYgpga5pDY8oW8Z"/></div></div></figure><figure class="ln lo lp lq gt lr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi mb"><img src="../Images/a023136a16df83da249cc849dda63ea6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*1MEcurm7SaT29KsC"/></div></div></figure><figure class="ln lo lp lq gt lr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi mc"><img src="../Images/f7658f835902ad6b5549659d8cdb0845.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*0MBK0kykd7PqEB9T"/></div></div></figure><h1 id="158a" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">Youtube 视频</h1><p id="bd8c" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">这里提到的所有步骤在 Youtube 视频中都有演示。</p><figure class="ln lo lp lq gt lr"><div class="bz fp l di"><div class="md me l"/></div></figure><h1 id="235b" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">结论</h1><p id="23ca" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">Metrics Server 有助于聚合多节点 Kubernetes 集群中各节点的 CPU 和 RAM 相关指标。希望这篇文章对你有用。需要覆盖默认设置，以允许 kubelet 和 metrics 服务器之间的不安全流量。</p><p id="6e46" class="pw-post-body-paragraph ki kj in kk b kl lh kn ko kp li kr ks kt lj kv kw kx lk kz la lb ll ld le lf ig bi translated">直到下一次，激情编码，追求卓越</p></div><div class="ab cl mf mg hr mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="ig ih ii ij ik"><p id="ec27" class="pw-post-body-paragraph ki kj in kk b kl lh kn ko kp li kr ks kt lj kv kw kx lk kz la lb ll ld le lf ig bi translated"><em class="lz">原载于 2021 年 12 月 22 日 https://www.handsonarchitect.com</em><em class="lz">的</em> <a class="ae lg" href="https://www.handsonarchitect.com/2021/12/how-to-install-metrics-server-on.html" rel="noopener ugc nofollow" target="_blank"> <em class="lz">。</em></a></p></div></div>    
</body>
</html>