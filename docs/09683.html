<html>
<head>
<title>Ktor REST Apis — Exception handling</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Ktor REST Apis 异常处理</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/ktor-rest-apis-exception-handling-1440eac4d06d?source=collection_archive---------5-----------------------#2022-09-05">https://blog.devgenius.io/ktor-rest-apis-exception-handling-1440eac4d06d?source=collection_archive---------5-----------------------#2022-09-05</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><h2 id="e37d" class="il im in bd b dl io ip iq ir is it dk iu translated" aria-label="kicker paragraph">后端教程</h2><div class=""/><div class=""><h2 id="7a47" class="pw-subtitle-paragraph jt iw in bd b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk dk translated">如果可以的话，抓住它！</h2></div><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/3e885b0255f43a79004c8dbdb1f9714a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*sWEbkmrODqlV8v50.jpg"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">来源:<a class="ae lb" href="https://blog.testproject.io/2021/04/21/exception-handling-and-custom-exception-in-test-automation/" rel="noopener ugc nofollow" target="_blank">测试自动化博客</a></figcaption></figure><p id="2f42" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">在这个使用 Ktor 的 Rest Api 系列中，我们之前探索了如何创建 Rest APi。但是对于任何代码库来说，异常都是一个难以言表的现实。非常重要的是，我们的代码已经为任何这种意外的场景做好了准备。因此，在本文中，我们将探索如何在 rest apis 中处理异常。</p><p id="75e3" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">如果你想从头开始，请阅读以下内容，你不会失望。</p><blockquote class="ly lz ma"><p id="9cc0" class="lc ld mb le b lf lg jx lh li lj ka lk mc lm ln lo md lq lr ls me lu lv lw lx ig bi translated"><a class="ae lb" href="https://proandroiddev.com/build-rest-apis-using-ktor-framework-i-dbbf36b332bb" rel="noopener ugc nofollow" target="_blank">Ktor REST API-第 1 部分(项目设置)</a><br/><a class="ae lb" href="https://proandroiddev.com/build-rest-apis-using-ktor-framework-ii-47948e89f1d6" rel="noopener ugc nofollow" target="_blank">Ktor REST API-第 2 部分(创建路线)</a><br/>T8】Ktor REST API<a class="ae lb" href="https://proandroiddev.com/build-rest-apis-using-ktor-framework-ii-47948e89f1d6" rel="noopener ugc nofollow" target="_blank">-</a><a class="ae lb" href="https://proandroiddev.com/build-rest-apis-using-ktor-framework-iii-87e579a7258e" rel="noopener ugc nofollow" target="_blank">第 3 部分(测试路线)</a><br/>T15】Ktor REST API-使用 Ktorm 集成 SQL 数据库</p></blockquote></div><div class="ab cl mf mg hr mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="ig ih ii ij ik"><h1 id="37f4" class="mm mn in bd mo mp mq mr ms mt mu mv mw kc mx kd my kf mz kg na ki nb kj nc nd bi translated">状态空间</h1><p id="e39c" class="pw-post-body-paragraph lc ld in le b lf ne jx lh li nf ka lk ll ng ln lo lp nh lr ls lt ni lv lw lx ig bi translated">在 Ktor 中，异常处理是使用 StatusPages 完成的。这是一个插件，它可以根据抛出的异常或状态代码优雅地处理任何故障状态。这意味着我们可以为</p><ul class=""><li id="d552" class="nj nk in le b lf lg li lj ll nl lp nm lt nn lx no np nq nr bi translated">任何未捕获的异常或可抛出的异常，即在执行过程中从任何地方引发的异常。</li><li id="629c" class="nj nk in le b lf ns li nt ll nu lp nv lt nw lx no np nq nr bi translated">任何数量的特定状态代码</li></ul></div><div class="ab cl mf mg hr mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="ig ih ii ij ik"><h2 id="d40c" class="nx mn in bd mo ny nz dn ms oa ob dp mw ll oc od my lp oe of na lt og oh nc it bi translated">建立</h2><p id="cf06" class="pw-post-body-paragraph lc ld in le b lf ne jx lh li nf ka lk ll ng ln lo lp nh lr ls lt ni lv lw lx ig bi translated">为了使用这个插件，我们需要添加如下依赖项。</p><pre class="km kn ko kp gt oi oj ok ol aw om bi"><span id="6cf5" class="nx mn in oj b gy on oo l op oq">// status pages for exception handling<br/>implementation("io.ktor:ktor-server-status-pages:$ktor_version")</span></pre><p id="c26b" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">然后我们需要像安装其他插件一样安装这个插件，如下所示</p><pre class="km kn ko kp gt oi oj ok ol aw om bi"><span id="e930" class="nx mn in oj b gy on oo l op oq">fun Application.configureExceptions() {<br/>    <em class="mb">install</em>(<em class="mb">StatusPages</em>)<br/>}</span></pre><p id="7beb" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">然后我们可以从应用程序的主模块调用这个配置，我们就可以使用插件了。</p></div><div class="ab cl mf mg hr mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="ig ih ii ij ik"><h2 id="3f4a" class="nx mn in bd mo ny nz dn ms oa ob dp mw ll oc od my lp oe of na lt og oh nc it bi translated">状态使用基于异常的处理</h2><p id="c001" class="pw-post-body-paragraph lc ld in le b lf ne jx lh li nf ka lk ll ng ln lo lp nh lr ls lt ni lv lw lx ig bi translated">一旦我们安装了插件，就在那里，我们可以提供基于引发的异常返回内容的实现。</p><p id="f561" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">现在，为了定义异常处理，我们简单地创建一个<strong class="le ix"> <em class="mb">异常</em> </strong>块，并传递一个<strong class="le ix"> <em class="mb"> &lt;可抛出&gt; </em> </strong>类型。它现在表明，任何可抛出的，如果不处理，应该来到这里，并根据这个块内的定义返回响应。</p><p id="0602" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">我们创建了两个自定义异常，我们假设它们是在运行时从不同的 API 抛出的。这些是简单的可抛出类，如下所示。</p><pre class="km kn ko kp gt oi oj ok ol aw om bi"><span id="8bbd" class="nx mn in oj b gy on oo l op oq">class ValidationException(override val message: String): Throwable()<br/>class ParsingException(override val message: String): Throwable()</span></pre><p id="d19a" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">我们覆盖了消息字段，这样我们就可以传递自定义消息，现在完整的处理如下所示。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="or os l"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">基于引发的异常的内容</figcaption></figure><p id="0ffd" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">我们只是检查我们收到了哪种未处理的异常，并相应地返回一个响应。这里<strong class="le ix"><em class="mb">exception response</em></strong>是用于提供 json 响应格式的数据类。</p><pre class="km kn ko kp gt oi oj ok ol aw om bi"><span id="2091" class="nx mn in oj b gy on oo l op oq">@Serializable<br/>data class ExceptionResponse(<br/>    val message: String,<br/>    val code: Int<br/>)</span></pre><p id="8295" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">我们将在本文的<strong class="le ix"> <em class="mb">动作</em> </strong>部分中看到 API 的运行。</p></div><div class="ab cl mf mg hr mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="ig ih ii ij ik"><h2 id="5211" class="nx mn in bd mo ny nz dn ms oa ob dp mw ll oc od my lp oe of na lt og oh nc it bi translated">使用基于状态代码的处理的状态页面</h2><p id="36d9" class="pw-post-body-paragraph lc ld in le b lf ne jx lh li nf ka lk ll ng ln lo lp nh lr ls lt ni lv lw lx ig bi translated">类似于<strong class="le ix"> <em class="mb">异常</em> </strong>块下基于异常的处理，我们可以如下定义<strong class="le ix"> <em class="mb">状态</em> </strong>块下基于状态码的处理。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="or os l"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">基于状态代码的内容</figcaption></figure><p id="b0fb" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">在这种情况下，如果 api 将返回此<strong class="le ix"> <em class="mb">状态</em> </strong>块下定义的任何 http 状态，则控制进入 StatusPages。例如，我们提到了内部服务器和坏网关错误。因此，每当我们的 API 返回这些代码时，执行控制就会来到这里，我们就能够用定义好的响应进行响应。</p><p id="511a" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">好吧！设置够了！现在是时候来看看以上所有内容的实际应用了。</p></div><div class="ab cl mf mg hr mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="ig ih ii ij ik"><h1 id="116c" class="mm mn in bd mo mp mq mr ms mt mu mv mw kc mx kd my kf mz kg na ki nb kj nc nd bi translated">行动</h1><p id="3d84" class="pw-post-body-paragraph lc ld in le b lf ne jx lh li nf ka lk ll ng ln lo lp nh lr ls lt ni lv lw lx ig bi translated">我们将创建 4 个 api 端点，它们都将抛出 4 种不同类型的异常。其中两个将是未捕获的异常，其余两个将基于状态代码。</p><pre class="km kn ko kp gt oi oj ok ol aw om bi"><span id="a5a4" class="nx mn in oj b gy on oo l op oq">exception/validation      // exception based<br/>exception/parsing         // exception based<br/>exception/internal-error  // status based<br/>exception/bad-gateway     // status based</span></pre><p id="0370" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">对于这些 API，我们将如下设置一个路由。</p><pre class="km kn ko kp gt oi oj ok ol aw om bi"><span id="fa3d" class="nx mn in oj b gy on oo l op oq">fun Application.configureExceptionRoutes() {<br/>    routing <strong class="oj ix">{<br/>        </strong>route("/exception") <strong class="oj ix">{<br/>            </strong><em class="mb">exceptionRoutes</em>()<br/>            <em class="mb">statusRoutes</em>()<br/>        <strong class="oj ix">}<br/>    }<br/></strong>}</span></pre><p id="411f" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">异常路由将包含基于异常的路由，即验证和解析。</p><p id="e36a" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">状态路由将包含基于状态的路由，即内部错误和坏网关。</p></div><div class="ab cl mf mg hr mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="ig ih ii ij ik"><h2 id="8f52" class="nx mn in bd mo ny nz dn ms oa ob dp mw ll oc od my lp oe of na lt og oh nc it bi translated">API:例外/验证</h2><p id="fecb" class="pw-post-body-paragraph lc ld in le b lf ne jx lh li nf ka lk ll ng ln lo lp nh lr ls lt ni lv lw lx ig bi translated">我们简单地定义一个端点并抛出一个验证异常。</p><pre class="km kn ko kp gt oi oj ok ol aw om bi"><span id="19e6" class="nx mn in oj b gy on oo l op oq">get("/validation") <strong class="oj ix">{<br/>    </strong>throw ValidationException("this is a validation exception")<br/><strong class="oj ix">}</strong></span></pre><p id="30a7" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">到达这个端点时，我们得到如下结果。</p><pre class="km kn ko kp gt oi oj ok ol aw om bi"><span id="ae5a" class="nx mn in oj b gy on oo l op oq">{<br/>    "message": "this is a validation exception",<br/>    "code": 400<br/>}</span></pre><p id="f145" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">喔！说到点子上。让我们也测试一下其他人。</p></div><div class="ab cl mf mg hr mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="ig ih ii ij ik"><h2 id="0c64" class="nx mn in bd mo ny nz dn ms oa ob dp mw ll oc od my lp oe of na lt og oh nc it bi translated">API:异常/解析</h2><p id="4202" class="pw-post-body-paragraph lc ld in le b lf ne jx lh li nf ka lk ll ng ln lo lp nh lr ls lt ni lv lw lx ig bi translated">我们简单地定义一个端点并抛出一个解析异常。</p><pre class="km kn ko kp gt oi oj ok ol aw om bi"><span id="40f9" class="nx mn in oj b gy on oo l op oq">get("/parsing") <strong class="oj ix">{<br/>    </strong>throw ParsingException("this is a parsing exception")<br/><strong class="oj ix">}</strong></span></pre><p id="8e9a" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">到达这个端点时，我们得到如下结果。</p><pre class="km kn ko kp gt oi oj ok ol aw om bi"><span id="f4c0" class="nx mn in oj b gy on oo l op oq">{<br/>    "message": "this is a parsing exception",<br/>    "code": 417<br/>}</span></pre></div><div class="ab cl mf mg hr mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="ig ih ii ij ik"><h2 id="3012" class="nx mn in bd mo ny nz dn ms oa ob dp mw ll oc od my lp oe of na lt og oh nc it bi translated">API:异常/内部错误</h2><p id="6ddd" class="pw-post-body-paragraph lc ld in le b lf ne jx lh li nf ka lk ll ng ln lo lp nh lr ls lt ni lv lw lx ig bi translated">我们简单地定义一个端点并返回内部服务器错误状态。</p><pre class="km kn ko kp gt oi oj ok ol aw om bi"><span id="2d5e" class="nx mn in oj b gy on oo l op oq">get("/internal-error") <strong class="oj ix">{<br/>    </strong><em class="mb">call</em>.respond(<br/>        HttpStatusCode.InternalServerError<br/>    )<br/><strong class="oj ix">}</strong></span></pre><p id="38bc" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">到达这个端点时，我们得到如下结果。</p><pre class="km kn ko kp gt oi oj ok ol aw om bi"><span id="f052" class="nx mn in oj b gy on oo l op oq">{<br/>    "message": "Oops! internal server error at our end",<br/>    "code": 500<br/>}</span></pre></div><div class="ab cl mf mg hr mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="ig ih ii ij ik"><h2 id="5b46" class="nx mn in bd mo ny nz dn ms oa ob dp mw ll oc od my lp oe of na lt og oh nc it bi translated">API:异常/错误-网关</h2><p id="d641" class="pw-post-body-paragraph lc ld in le b lf ne jx lh li nf ka lk ll ng ln lo lp nh lr ls lt ni lv lw lx ig bi translated">我们简单地定义一个端点并返回内部服务器错误状态。</p><pre class="km kn ko kp gt oi oj ok ol aw om bi"><span id="a63d" class="nx mn in oj b gy on oo l op oq">get("/bad-gateway") <strong class="oj ix">{<br/>    </strong><em class="mb">call</em>.respond(<br/>        HttpStatusCode.BadGateway<br/>    )<br/><strong class="oj ix">}</strong></span></pre><p id="c72e" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">到达这个端点时，我们得到如下结果。</p><pre class="km kn ko kp gt oi oj ok ol aw om bi"><span id="877f" class="nx mn in oj b gy on oo l op oq">{<br/>    "message": "Oops! We got a bad gateway. Fixing it. Hold on!",<br/>    "code": 502<br/>}</span></pre></div><div class="ab cl mf mg hr mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="ig ih ii ij ik"><h1 id="25f3" class="mm mn in bd mo mp mq mr ms mt mu mv mw kc mx kd my kf mz kg na ki nb kj nc nd bi translated">优势</h1><p id="4b6a" class="pw-post-body-paragraph lc ld in le b lf ne jx lh li nf ka lk ll ng ln lo lp nh lr ls lt ni lv lw lx ig bi translated">使用 StatusPages 为我们提供了一些优势:</p><ul class=""><li id="cb80" class="nj nk in le b lf lg li lj ll nl lp nm lt nn lx no np nq nr bi translated">我们可以为未捕获的异常提供一致的实现。从代码维护的角度来看，这也是有益的。</li><li id="1865" class="nj nk in le b lf ns li nt ll nu lp nv lt nw lx no np nq nr bi translated">我们可以为特定的异常提供特定的实现，同时仍然与其余的异常保持一致。</li><li id="2f5e" class="nj nk in le b lf ns li nt ll nu lp nv lt nw lx no np nq nr bi translated">我们可以处理不同的状态代码，为用户提供一致的响应。</li></ul></div><div class="ab cl mf mg hr mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="ig ih ii ij ik"><p id="d5ff" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">这足以让我们开始处理 API 中的异常。尝试不同场景并在现实中体验它们。作为参考，您可以在下面查看完整的代码。希望会有用。</p><div class="ot ou gp gr ov ow"><a href="https://github.com/aqua30/Apis-using-Ktor/tree/exception-handling" rel="noopener  ugc nofollow" target="_blank"><div class="ox ab fo"><div class="oy ab oz cl cj pa"><h2 class="bd ix gy z fp pb fr fs pc fu fw iw bi translated">GitHub-aqua 30/Apis-在异常处理时使用-Ktor</h2><div class="pd l"><h3 class="bd b gy z fp pb fr fs pc fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="pe l"><p class="bd b dl z fp pb fr fs pc fu fw dk translated">github.com</p></div></div><div class="pf l"><div class="pg l ph pi pj pf pk kv ow"/></div></div></a></div></div><div class="ab cl mf mg hr mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="ig ih ii ij ik"><h1 id="d66b" class="mm mn in bd mo mp mq mr ms mt mu mv mw kc mx kd my kf mz kg na ki nb kj nc nd bi translated">目前就这些了！敬请期待！</h1><p id="5a96" class="pw-post-body-paragraph lc ld in le b lf ne jx lh li nf ka lk ll ng ln lo lp nh lr ls lt ni lv lw lx ig bi translated">与我联系(如果内容对您有帮助),请访问</p><ul class=""><li id="9463" class="nj nk in le b lf lg li lj ll nl lp nm lt nn lx no np nq nr bi translated"><a class="ae lb" href="https://saurabhpant.medium.com/" rel="noopener">中等</a></li><li id="e7ef" class="nj nk in le b lf ns li nt ll nu lp nv lt nw lx no np nq nr bi translated"><a class="ae lb" href="https://github.com/aqua30" rel="noopener ugc nofollow" target="_blank"> GitHub </a></li><li id="4faa" class="nj nk in le b lf ns li nt ll nu lp nv lt nw lx no np nq nr bi translated"><a class="ae lb" href="https://twitter.com/saurabh30pant" rel="noopener ugc nofollow" target="_blank">推特</a></li><li id="e8c6" class="nj nk in le b lf ns li nt ll nu lp nv lt nw lx no np nq nr bi translated"><a class="ae lb" href="https://www.linkedin.com/in/saurabh-pant-44619057/" rel="noopener ugc nofollow" target="_blank">领英</a></li></ul><p id="e799" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">订阅电子邮件，同步了解更多关于 Android/IOS/Backend/Web 的有趣话题。</p><p id="c5e3" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">直到下一次…</p><p id="b3e7" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">干杯！</p></div></div>    
</body>
</html>