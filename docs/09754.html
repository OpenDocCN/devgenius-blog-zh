<html>
<head>
<title>Building a data pipeline with Apache Airflow, Snowflake, AWS S3 and Slack Alerts (part 2)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用 Apache Airflow、雪花、AWS S3 和 Slack Alerts 构建数据管道(第 2 部分)</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/building-a-data-pipeline-with-apache-airflow-snowflake-aws-s3-and-slack-alerts-part-2-f97403ceac1f?source=collection_archive---------5-----------------------#2022-09-10">https://blog.devgenius.io/building-a-data-pipeline-with-apache-airflow-snowflake-aws-s3-and-slack-alerts-part-2-f97403ceac1f?source=collection_archive---------5-----------------------#2022-09-10</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="dbe7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><em class="ki">这是</em> <a class="ae kj" href="https://medium.com/@kevin.pereda26/building-a-data-pipeline-with-apache-airflow-snowflake-aws-s3-and-slack-alerts-part-1-e4c428d1c620" rel="noopener"> <em class="ki">第一篇文章</em> </a> <em class="ki">的延续，在第一篇文章中，我们讨论了涉及业务问题和雪花设置的前两个目标。目前的职位涵盖了关于运行我们的最终管道的其余目标。</em></p><figure class="kl km kn ko gt kp gh gi paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="gh gi kk"><img src="../Images/2cb8793501b7e06b98c4abbf1ead2a8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rKmNQp5eXDdom9mFgp7aHA.png"/></div></div><figcaption class="kw kx gj gh gi ky kz bd b be z dk translated">由作者创建</figcaption></figure></div><div class="ab cl la lb hr lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ig ih ii ij ik"><p id="aef7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">使用 Docker 在本地运行 Apache air flow</strong></p><p id="c812" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">Apache Airflow 允许我们编排可伸缩的、动态的、可扩展的和优雅的管道。毕竟它的核心使用了 Python。</p><p id="3b8f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在本教程中，我们将使用 Airflow 创建一个 dag 来查询我们的雪花数据，在雪花中创建一个表，将数据插入到雪花中，并将处理后的数据保存到亚马逊 S3，同时通知任何有关 Slack 警报的错误。</p><p id="5ee1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">教程的这一部分假设你有基本的 Docker 知识，有一个带有访问密钥和秘密密钥的 AWS 帐户和一个已经设置好的 Slack workspace。</p><p id="e6f1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让气流运行的方法不止一种，但是这一次，我将向您展示如何使用 Docker 来运行它。如果你想跳过这个本地设置，请随意使用亚马逊管理的 Apache Airflow (MWAA)工作流、谷歌的 Cloud Composer 或天文学家解决方案。</p><p id="ed3d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">此项目文件的源代码可以在以下位置找到:</p><div class="lh li gp gr lj lk"><a href="https://github.com/kvin007/Airflow-Snowflake-S3-SlackAlerts" rel="noopener  ugc nofollow" target="_blank"><div class="ll ab fo"><div class="lm ab ln cl cj lo"><h2 class="bd io gy z fp lp fr fs lq fu fw im bi translated">GitHub-kvin 007/Airflow-snow flake-S3-slack alerts:这展示了如何使用 air flow 和 snow flake…</h2><div class="lr l"><h3 class="bd b gy z fp lp fr fs lq fu fw dk translated">这显示了如何使用雪花和 S3 气流。另外，在任务失败的情况下发送时差警报，我首先上传…</h3></div><div class="ls l"><p class="bd b dl z fp lp fr fs lq fu fw dk translated">github.com</p></div></div><div class="lt l"><div class="lu l lv lw lx lt ly ku lk"/></div></div></a></div><p id="7f53" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我使用<a class="ae kj" href="https://airflow.apache.org/docs/apache-airflow/stable/start/docker.html" rel="noopener ugc nofollow" target="_blank">官方网站文档</a>运行 Airflow，但是对我希望它拥有的项目结构做了一些调整(涉及<em class="ki">air flow _ _ CORE _ _ DAGS _ 文件夹</em>、<em class="ki">air flow _ _ CORE _ _ 插件 _ 文件夹</em>和<em class="ki">air flow _ _ 日志 _ _ BASE _ LOG _ 文件夹</em>环境变量)。</p><p id="91e3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">请随意检查我所做的更改，因为最初的<em class="ki"> docker-compose.yaml </em>文件如下:</p><p id="52b4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><a class="ae kj" href="https://airflow.apache.org/docs/apache-airflow/2.3.4/docker-compose.yaml" rel="noopener ugc nofollow" target="_blank">https://air flow . Apache . org/docs/Apache-air flow/2 . 3 . 4/docker-compose . YAML</a></p><p id="8a5f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果您克隆 repo 并顺序执行<em class="ki"> docker-compose build </em>和<em class="ki"> docker-compose up </em>，我们将会在我们的计算机上运行<a class="ae kj" href="http://localhost:8080/" rel="noopener ugc nofollow" target="_blank"> http://localhost:8080/ </a>上的气流！耶</p><figure class="kl km kn ko gt kp gh gi paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="gh gi lz"><img src="../Images/989011601227dffb123dffb1ecbbabb3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*UKHrDQIN6Afls5jl"/></div></div><figcaption class="kw kx gj gh gi ky kz bd b be z dk translated">图 7。Docker 上运行的气流</figcaption></figure><p id="5819" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在我们运行 Dag<strong class="jm io">update _ reports _ snow flake</strong>之前，我们需要为气流中的 S3、雪花和 Slack 设置连接。在 Airflow UI 中，转到“管理”、“连接”,然后按照以下说明操作:</p><p id="34c9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">a) <strong class="jm io">对于 S3 存储桶</strong>，我们需要一个 AWS 帐户，其中包含已经创建的访问密钥、密钥和存储桶。<strong class="jm io">请修改 dag 中的桶本身，否则，最后一步会失败。</strong></p><figure class="kl km kn ko gt kp gh gi paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="gh gi ma"><img src="../Images/4e48a252bb04261a2bcc2caa0278ea3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*gWfoMoz5G4Icnrj0"/></div></div><figcaption class="kw kx gj gh gi ky kz bd b be z dk translated"><em class="mb">图 8。气流中的自动气象站 S3 连接</em></figcaption></figure><blockquote class="mc md me"><p id="92a4" class="jk jl ki jm b jn jo jp jq jr js jt ju mf jw jx jy mg ka kb kc mh ke kf kg kh ig bi translated"><em class="in">连接 Id:AWS _ S3 _ conn _ Id<br/>Extra:</em>{ " AWS _ access _ key _ Id ":" XXXXX "，" AWS _ secret _ access _ key ":" XXXXX " }</p></blockquote><p id="cf3a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">b) <strong class="jm io">对于 Slack 连接</strong>，我们需要一个工作空间、一个应用程序和一个与 Slack 通道相关联的 webhook。为此，我跟踪了<a class="ae kj" href="https://medium.com/datareply/integrating-slack-alerts-in-airflow-c9dcd155105" rel="noopener">卡西尔在 Medium </a>上的帖子(仅限步骤 2)</p><p id="273b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">您可以看到这个过程的一些截图，以及 Slack 的更新视图。</p><figure class="kl km kn ko gt kp gh gi paragraph-image"><div class="gh gi mi"><img src="../Images/2e57ef753793d8761b123f03e0c8673b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1044/0*F7S5Mwavk-AXiMUW"/></div><figcaption class="kw kx gj gh gi ky kz bd b be z dk translated"><em class="mb">图 9。松弛状态下的应用创建</em></figcaption></figure><figure class="kl km kn ko gt kp gh gi paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="gh gi mj"><img src="../Images/8f7fb3ed92b40f577d9394a2c2e720ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*wBFoqdO_AtJr7u2U"/></div></div><figcaption class="kw kx gj gh gi ky kz bd b be z dk translated"><em class="mb">图 10。启用应用程序的 webhook 功能</em></figcaption></figure><figure class="kl km kn ko gt kp gh gi paragraph-image"><div class="gh gi mk"><img src="../Images/bdef48442764d39fc4e4dfb233d0a9c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1348/0*bt5BnmL_H-__UuUF"/></div><figcaption class="kw kx gj gh gi ky kz bd b be z dk translated"><em class="mb">图 11。Webhook URL 的检索</em></figcaption></figure><p id="f66c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">一旦你的 Slack 应用准备好了，我们需要在 Airflow 中创建连接，以下面的截图为例。</p><figure class="kl km kn ko gt kp gh gi paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="gh gi ml"><img src="../Images/16b96cb736fe003ea0976eca452f7309.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qeq0UGZTWdn8i3AF"/></div></div><figcaption class="kw kx gj gh gi ky kz bd b be z dk translated"><em class="mb">图 12。气流中的松弛连接</em></figcaption></figure><blockquote class="mc md me"><p id="a8c0" class="jk jl ki jm b jn jo jp jq jr js jt ju mf jw jx jy mg ka kb kc mh ke kf kg kh ig bi translated"><em class="in">连接 Id: slack_conn_id <br/>主机:</em><a class="ae kj" href="https://hooks.slack.com/services" rel="noopener ugc nofollow" target="_blank"><em class="in">https://hooks.slack.com/services</em></a><em class="in"><br/>密码:</em>{所有字符串之后/服务/}</p></blockquote><p id="00ae" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">c)对于雪花连接，我们需要我们的帐户 id、与之相关的区域、仓库、模式、用户名和密码。以这些截图为例:</p><figure class="kl km kn ko gt kp gh gi paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="gh gi mm"><img src="../Images/ab145161f20a38f8e5229bf5db8d7d49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*x51gfW2wRO05I76q"/></div></div><figcaption class="kw kx gj gh gi ky kz bd b be z dk translated"><em class="mb">图 13。气流中的雪花连接</em></figcaption></figure><blockquote class="mc md me"><p id="fd05" class="jk jl ki jm b jn jo jp jq jr js jt ju mf jw jx jy mg ka kb kc mh ke kf kg kh ig bi translated"><em class="in">连接 Id: snowflake_conn_id <br/>主机:</em>ACCOUNTID.REGION.snowflakecomputing.com<br/><em class="in">模式:MEETUP <br/>数据库:YOUR_DATABASE <br/>地区:us-east-1 <br/>角色:ACCOUNTADMIN <br/>仓库:COMPUTE_WH </em></p></blockquote><p id="e192" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">一旦我们准备好了所有的连接，我们就可以执行我们的 dag，它包括以下内容:</p><ol class=""><li id="0f7d" class="mn mo in jm b jn jo jr js jv mp jz mq kd mr kh ms mt mu mv bi translated">第一个任务(<em class="ki">verify _ destination _ created</em>)检查我们的目标表是否已经创建。</li><li id="614e" class="mn mo in jm b jn mw jr mx jv my jz mz kd na kh ms mt mu mv bi translated">第二个任务(<em class="ki"> check_need_to_create </em>)是一个分支操作符，它基于前一个任务的结果，或者在任务<em class="ki">create _ daily _ joined _ table</em>中创建新表，或者只是在任务<em class="ki"> insert_members_joined </em>中插入新记录</li><li id="c5df" class="mn mo in jm b jn mw jr mx jv my jz mz kd na kh ms mt mu mv bi translated">最后，最后一个任务上传结果到我们的 S3 桶！</li></ol><figure class="kl km kn ko gt kp gh gi paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="gh gi lz"><img src="../Images/bc0118b851bf8e9de59e62519f950922.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*6RzoYOCoDttiiKhO"/></div></div><figcaption class="kw kx gj gh gi ky kz bd b be z dk translated"><em class="mb">图 14。更新 _ 报告 _ 雪花的 DAG 执行</em></figcaption></figure><p id="7a59" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">您可以在雪花和 S3 中查看您的表格和结果:</p><figure class="kl km kn ko gt kp gh gi paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="gh gi nb"><img src="../Images/389cebfb306c39f75b0e07a422030a36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*i6C6K8M7RW_5vFvG"/></div></div><figcaption class="kw kx gj gh gi ky kz bd b be z dk translated"><em class="mb">图 15。雪花状的表格结果</em></figcaption></figure><figure class="kl km kn ko gt kp gh gi paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="gh gi nc"><img src="../Images/9772048ea7bc485cfbb35a6cb27e66e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Fy0eYwVItG4OIPw_"/></div></div><figcaption class="kw kx gj gh gi ky kz bd b be z dk translated"><em class="mb">图 16。数据加载到 AWS S3 存储桶</em></figcaption></figure><p id="ca84" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">顺便说一下，在写这个博客的时候，我遇到了一些发布在我的 Slack 频道上的问题。至少他们不会在凌晨 1 点打电话给我，对吧？</p><figure class="kl km kn ko gt kp gh gi paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="gh gi nd"><img src="../Images/561fd6217ce7893a83eb2e92f46e5e2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*G3t9tfhEcbGhuBDm"/></div></div><figcaption class="kw kx gj gh gi ky kz bd b be z dk translated"><em class="mb">图 17。处理问题时的松弛警报</em></figcaption></figure><p id="1bdc" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我希望这个端到端解决方案对您有用。虽然这是一种快速的方法，但它向您展示了如何使用雪花、气流和 AWS S3，它们是现代数据堆栈中的一些热门工具。</p><p id="0f4f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果你对这篇文章有任何反馈或疑问，我很乐意听到，这样我就可以继续学习和改进我的工作。期待啊！</p></div></div>    
</body>
</html>