<html>
<head>
<title>Send information from Airflow to Databricks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将信息从气流发送到数据块</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/send-information-from-airflow-to-databricks-bbcbbd827120?source=collection_archive---------9-----------------------#2022-12-12">https://blog.devgenius.io/send-information-from-airflow-to-databricks-bbcbbd827120?source=collection_archive---------9-----------------------#2022-12-12</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/79e108b1577de3a030241aaa772bcbd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dW5sx2mUzLJAZBWOfrU4Aw.png"/></div></div></figure><p id="8e58" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">是的。我对此有些纠结。所以我写在这里是为了节省你寻找它的时间。如果你正在寻找逆流(最困难的)点击<a class="ae kt" href="https://minhadona.medium.com/send-information-from-databricks-to-airflow-810a7d49ff81" rel="noopener">这里</a>阅读。</p><h1 id="b7ba" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">从气流到数据块</h1><h2 id="07fb" class="ls kv in bd kw lt lu dn la lv lw dp le kg lx ly li kk lz ma lm ko mb mc lq md bi translated"><strong class="ak">最简单的</strong></h2><p id="40b5" class="pw-post-body-paragraph jv jw in jx b jy me ka kb kc mf ke kf kg mg ki kj kk mh km kn ko mi kq kr ks ig bi translated">还记得您用来从气流任务中触发数据块作业的数据块操作符吗？为了将信息从 Airflow 传递到 Databricks 作业，有一个参数可以帮您做到这一点。是 notebook_task 的 json 参数里面的 base_parameters。</p><p id="976b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">还记得 D <a class="ae kt" href="https://airflow.apache.org/docs/apache-airflow-providers-databricks/2.5.0/_api/airflow/providers/databricks/operators/databricks/index.html" rel="noopener ugc nofollow" target="_blank"> atabricks 操作符</a>吗？您用它来触发气流任务中的数据块任务？为了将信息从 Airflow 传递到 Databricks 作业，有一个参数可以帮您做到这一点。是<code class="fe mj mk ml mm b">notebook_task</code>的 json 参数里面的<code class="fe mj mk ml mm b">base_parameters</code>。</p><p id="13ba" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">为了举例说明这个动作，<strong class="jx io">记住</strong>:</p><p id="ea16" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">—此任务触发笔记本(即<strong class="jx io"> ipynb </strong>和<strong class="jx io">不是</strong> a . <strong class="jx io"> py </strong>文件)，所以要记住你设置的任何参数和配置都必须引用一个笔记本作业，而不是 Python 作业(大部分参数区分两者，只是一个提示)。</p><p id="1623" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">—此任务将触发一个将在现有集群上运行的笔记本。</p><p id="cd22" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">—收到的参数/信息将作为 json 存储在 data brick 上，就像您通过 UI 在 data brick 工作流部分创建作业时在高级设置中设置的 json 参数一样。</p><p id="4714" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">使用 SubmitRunOperator 的代码段:</p><pre class="mn mo mp mq gt mr mm ms bn mt mu bi"><span id="78c7" class="mv kv in mm b be mw mx l my mz">variable_validation = { <br/>    "pix": {<br/>        "identification": "pix",<br/>        "query_from": "table_name",<br/>        "query_where": "where accountId in ('blabla')",<br/>        "retroactive_time_in_hours": 24,<br/>        "timestamp_column_name": "date"},<br/>    <br/>    "boleto": {<br/>        "identification": "boleto",<br/>        "query_from": "table_name",<br/>        "query_where": "where accountId in ('blabla')",<br/>        "retroactive_time_in_hours": 24,<br/>        "timestamp_column_name": "date"}<br/>    }<br/><br/># --------------------<br/>run_validation_for_boleto = DatabricksSubmitRunOperator(<br/>        task_id=f'validation_boleto', <br/>        existing_cluster_id=DATABRICKS_DEFAULT_CLUSTER_ID,<br/>        databricks_conn_id="CONNECTION_ID_TO_YOUR_DATABRICKS",<br/>        notebook_task = {<br/>            'notebook_path': '/Users/minhadona/GDP-2073',<br/>            'base_parameters': variable_validation['boleto'] # dictionary<br/>                                },<br/>        do_xcom_push = True<br/>        )</span></pre><p id="571a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">收到的参数显示在执行界面的“参数”部分。</p><figure class="mn mo mp mq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi na"><img src="../Images/0067e17b26ec85b319a0fc6f3ff74a67.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZYRbgXUiAUAEfsPSoLlTkA.png"/></div></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated">实例化 DatabricksSubmit 运算符时 base_parameters 参数收到的运行 ID 和参数</figcaption></figure><p id="d9ca" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在 Airflow 中触发作业后，接收到的值(在数据块上)可用于数据处理/转换，语法如下:</p><figure class="mn mo mp mq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nf"><img src="../Images/2733c5527122c8e27f3521dc05438573.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RhJq3UI_suU-5Ij8lMRRyA.png"/></div></div></figure><p id="5a24" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">因此，要检索数据，使用 dbutils 库并获取值，就好像它们是分配给一个键的环境变量一样(dbutils.widgets.get)。您可以使用完全相同的方法从<a class="ae kt" href="https://docs.databricks.com/dev-tools/databricks-utils.html" rel="noopener ugc nofollow" target="_blank"> widgets </a>、<strong class="jx io">中手动检索数据，但是请记住:出于这个目的，您不能使用从 AIRFLOW 接收的相同密钥来创建 WIDGET！否则收到的值会被 WIDGET 值覆盖！这一点很重要！</strong></p><p id="d72a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">所以请记住，您不能在笔记本中创建与接收到的 json 中包含的键相同的小部件(在这种情况下，您不能创建 id 为‘identificati on’，‘query _ from’，‘query _ where’等的小部件。)，否则小部件的默认值将覆盖从 json 接收的所有值。您只能对这些键使用“get”方法。不要用 json 中的相同键创建“测试”小部件。</p><blockquote class="ng nh ni"><p id="606c" class="jv jw nj jx b jy jz ka kb kc kd ke kf nk kh ki kj nl kl km kn nm kp kq kr ks ig bi translated"><em class="in">如果你需要创建小部件只是为了</em>测试<em class="in">你的笔记本，不要忘记使用</em>dbutils . widgets . remove all()<em class="in">删除它们，并在触发 Airflow 上的这个笔记本之前删除/注释这个 remove 语句。</em></p></blockquote><p id="ab52" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如果您想在 Airflow 作业中进行不同的调用，迭代一个字典或做其他事情，您只需要传递不同的参数(在 for 循环中)。然后，每个调用再次为该笔记本触发一个新的数据块作业，该作业处理通过 Airflow 的 base_parameters 接收的新数据/json！</p><p id="16cf" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">要将笔记本的结果/输出返回到 Airflow，请参见我的文章<a class="ae kt" href="https://minhadona.medium.com/send-information-from-databricks-to-airflow-810a7d49ff81" rel="noopener"> <strong class="jx io">将信息从数据块发送到 Airflow </strong> </a> <strong class="jx io">。</strong></p></div></div>    
</body>
</html>