<html>
<head>
<title>Testing Room database with Coroutines and Flows — Testing Fundamentals</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用协程和流程测试房间数据库—测试基础</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/testing-room-database-with-coroutines-and-flows-testing-fundamentals-iii-5f6c3b9e4c94?source=collection_archive---------2-----------------------#2022-08-15">https://blog.devgenius.io/testing-room-database-with-coroutines-and-flows-testing-fundamentals-iii-5f6c3b9e4c94?source=collection_archive---------2-----------------------#2022-08-15</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><h2 id="3a09" class="il im in bd b dl io ip iq ir is it dk iu translated" aria-label="kicker paragraph">Android 测试教程</h2><div class=""/><div class=""><h2 id="e232" class="pw-subtitle-paragraph jt iw in bd b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk dk translated">永远为流动的变化留有空间！</h2></div><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/fe4330cc7ca5ff4cbb94b2f5ff44f2d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Fx19B6YkvWBvo07_.jpg"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">来源:https://testinggenez.com/</figcaption></figure><p id="e378" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">我们大部分时间处理的一个常见用例是在我们的应用程序中使用本地数据库来支持缓存，为此使用空间是众所周知的。因此，为我们的数据库编写测试变得非常重要，因为在许多情况下，本地数据库是应用程序的唯一数据源。</p><p id="f9e5" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">使用数据库最常见的操作是 CRUD 操作。因此，在本文中，我们将探索如何为这样的操作编写测试，以及当它们返回给我们一个流时。</p><p id="4870" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">我们将有一个简单的应用程序，以名称的项目，并将其保存在数据库中。让我们开始吧。</p></div><div class="ab cl ly lz hr ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="ig ih ii ij ik"><h1 id="9f2d" class="mf mg in bd mh mi mj mk ml mm mn mo mp kc mq kd mr kf ms kg mt ki mu kj mv mw bi translated">房间布置</h1><p id="18a3" class="pw-post-body-paragraph lc ld in le b lf mx jx lh li my ka lk ll mz ln lo lp na lr ls lt nb lv lw lx ig bi translated">首先，我们需要在应用程序中设置房间数据库。所以让我们快速地做那件事。如下所示添加依赖项。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="c9c3" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">现在创建一个表实体，如下所示。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="4627" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">然后如下定义 Dao 接口。这是我们定义数据库 API 的类。我们的添加和删除功能被暂停。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="e01f" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">然后创建数据库实体，如下所示。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="66a1" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">就是这样。设置完成了。现在，我们可以快速浏览一下刚刚设置的内容。因此，我们为数据库定义了三个简单的 API，分别是添加/更新项目、删除项目和获取所有项目。</p></div><div class="ab cl ly lz hr ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="ig ih ii ij ik"><h1 id="b41c" class="mf mg in bd mh mi mj mk ml mm mn mo mp kc mq kd mr kf ms kg mt ki mu kj mv mw bi translated">测试设置</h1><p id="419f" class="pw-post-body-paragraph lc ld in le b lf mx jx lh li my ka lk ll mz ln lo lp na lr ls lt nb lv lw lx ig bi translated">为了测试我们的数据库设置，我们需要事先了解以下几点</p><ul class=""><li id="20b5" class="ne nf in le b lf lg li lj ll ng lp nh lt ni lx nj nk nl nm bi translated">在测试环境中，我们不是在设备存储中拥有真实的数据库，而是在内存中创建一个数据库，或者你可以说是一个临时数据库，以便我们可以快速测试它，并且它不会给我们的设备或应用程序增加任何额外的负载。一旦测试完成，它就会被移除。</li><li id="c198" class="ne nf in le b lf nn li no ll np lp nq lt nr lx nj nk nl nm bi translated">因为我们使用流来观察任何数据库变化，所以在测试环境中观察流是很棘手的。所以我们将使用一个名为<a class="ae lb" href="https://github.com/cashapp/turbine" rel="noopener ugc nofollow" target="_blank">涡轮机</a>的库。它使得测试流程变得容易。我们需要在 androidTestImplementation 下添加它的依赖项，如下所示</li></ul><pre class="km kn ko kp gt ns nt nu nv aw nw bi"><span id="00c3" class="nx mg in nt b gy ny nz l oa ob">androidTestImplementation 'app.cash.turbine:turbine:0.9.0'</span></pre><ul class=""><li id="2af5" class="ne nf in le b lf lg li lj ll ng lp nh lt ni lx nj nk nl nm bi translated">由于 Room 是一个 android 库，我们将在 androidTest 目录中编写测试。</li></ul><p id="1bff" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">让我们为 ItemDao 创建测试类。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="d4ec" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">我们在这个类上添加了两个注释。@ <strong class="le ix"> <em class="oc"> RunWith </em> </strong>注释告诉编译器用 AndroidJUnit4 而不是 JUnit apis 运行这个类。</p><p id="e88e" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">@ <strong class="le ix"> <em class="oc"> SmallTest </em> </strong>注释告诉编译器，它正在频繁地测试运行，它的执行时间应该小于 200ms。测试大小限定符是构建测试代码的一种很好的方式，用于将一个测试分配给一个运行时间相似的测试套件。</p><p id="0d03" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">现在我们需要将我们的协程调度程序从 main 改为 test dispatcher，否则我们的测试将会异常失败。为此，我们创建一个规则，简单地将主调度程序设置为测试调度程序，并在完成时重置它。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="865b" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">我们将这个规则添加到 ItemDaoTest.kt 中。</p><pre class="km kn ko kp gt ns nt nu nv aw nw bi"><span id="0ada" class="nx mg in nt b gy ny nz l oa ob">@get: Rule<br/><em class="oc">val </em>dispatcherRule = TestDispatcherRule()</span></pre><p id="f2b1" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">现在让我们为测试创建数据库和 dao 实例。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="c469" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">如前所述，我们在注释前的<strong class="le ix">下创建了一个内存中的数据库实例，并在</strong>注释后关闭了<strong class="le ix">中的数据库。</strong></p><p id="36bd" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">好吧！终于到了写测试的时候了。我们将编写以下测试用例</p><ul class=""><li id="3daf" class="ne nf in le b lf lg li lj ll ng lp nh lt ni lx nj nk nl nm bi translated">在数据库中添加两个项目并获取所有项目流应该返回这两个项目。</li><li id="fc77" class="ne nf in le b lf nn li no ll np lp nq lt nr lx nj nk nl nm bi translated">添加两个项目并删除其中任何一个。我们的获取所有项目流应该只返回未删除的项目。</li><li id="9f45" class="ne nf in le b lf nn li no ll np lp nq lt nr lx nj nk nl nm bi translated">添加两项并更新其中任何一项。我们的 get all items 流应该返回更新的项目。</li></ul></div><div class="ab cl ly lz hr ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="ig ih ii ij ik"><h1 id="5455" class="mf mg in bd mh mi mj mk ml mm mn mo mp kc mq kd mr kf ms kg mt ki mu kj mv mw bi translated">编写测试用例</h1><h2 id="2f6e" class="nx mg in bd mh od oe dn ml of og dp mp ll oh oi mr lp oj ok mt lt ol om mv it bi translated">测试案例 1</h2><p id="e3a7" class="pw-post-body-paragraph lc ld in le b lf mx jx lh li my ka lk ll mz ln lo lp na lr ls lt nb lv lw lx ig bi translated">在数据库中添加一个项目，应该在我们的流程中返回。</p><pre class="km kn ko kp gt ns nt nu nv aw nw bi"><span id="621e" class="nx mg in nt b gy ny nz l oa ob">@Test<br/><em class="oc">fun </em>addItem_shouldReturn_theItem_inFlow() = <em class="oc">runTest </em><strong class="nt ix">{ }</strong></span></pre><p id="b51c" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">因为我们的 add 函数是一个 suspend 函数，我们需要在测试协程生成器<strong class="le ix"> <em class="oc"> runTest 下运行它。</em> </strong></p><p id="433f" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">然后，我们创建我们的项目，并将它们添加到数据库中。</p><pre class="km kn ko kp gt ns nt nu nv aw nw bi"><span id="d58a" class="nx mg in nt b gy ny nz l oa ob"><em class="oc">val </em>item1 = Item(uid = 1, itemName = "item 1")<br/><em class="oc">val </em>item2 = Item(uid = 2, itemName = "item 2")<br/>itemDao.addItem(item1)<br/>itemDao.addItem(item2)</span></pre><p id="105d" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">现在我们使用扩展函数<strong class="le ix"> <em class="oc"> test 来测试我们的流。</em> </strong>我们使用汽轮机的<strong class="le ix"> <em class="oc"> awaitItem() </em> </strong>函数观察发射项列表。</p><pre class="km kn ko kp gt ns nt nu nv aw nw bi"><span id="b00b" class="nx mg in nt b gy ny nz l oa ob">itemDao.getAllItems().test <strong class="nt ix">{<br/>    </strong><em class="oc">val </em>list = awaitItem()<br/>    <em class="oc">assert</em>(list.contains(item1))<br/>    <em class="oc">assert</em>(list.contains(item2))<br/>    cancel()<br/><strong class="nt ix">}</strong></span></pre><p id="ac8a" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">一旦我们有了列表，我们就断言这两个项目是否都在列表中。如果是，那么测试将通过，否则将失败。</p><p id="e1a0" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">最后我们调用<strong class="le ix"> <em class="oc"> cancel() </em> </strong>函数，再次从涡轮库中取出。</p><blockquote class="on oo op"><p id="d4b3" class="lc ld oc le b lf lg jx lh li lj ka lk oq lm ln lo or lq lr ls os lu lv lw lx ig bi translated">这是一个重要的捕捉，因为如果我们不进行这个调用，那么我们的流将永远不会完成，测试将永远运行下去。在测试环境中，流应该是有限的，只有这样它才能完成，我们才能在发出的值上测试我们的断言。</p></blockquote><p id="b258" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">运行上述测试的结果将是</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ot"><img src="../Images/fce5e1eb52619fb00b97ee1ff3312137.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o1Mig5osiZKWWVYiRRvAaA.png"/></div></div></figure><p id="5ab4" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">太好了！因此，我们已经成功地执行并测试了我们的第一个测试。现在让我们测试从数据库中删除项目。</p><h2 id="faaf" class="nx mg in bd mh od oe dn ml of og dp mp ll oh oi mr lp oj ok mt lt ol om mv it bi translated">测试案例 2</h2><p id="b231" class="pw-post-body-paragraph lc ld in le b lf mx jx lh li my ka lk ll mz ln lo lp na lr ls lt nb lv lw lx ig bi translated">在数据库中删除一个项目，应该在我们的流程中返回。</p><pre class="km kn ko kp gt ns nt nu nv aw nw bi"><span id="7813" class="nx mg in nt b gy ny nz l oa ob">@Test<br/><em class="oc">fun </em>deletedItem_shouldNot_be_present_inFlow() = <em class="oc">runTest </em><strong class="nt ix">{ }</strong></span></pre><p id="e66f" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">为了执行这个测试，我们将首先在数据库中添加两个项目，如下所示</p><pre class="km kn ko kp gt ns nt nu nv aw nw bi"><span id="335e" class="nx mg in nt b gy ny nz l oa ob"><em class="oc">val </em>item1 = Item(uid = 1, itemName = "item 1")<br/><em class="oc">val </em>item2 = Item(uid = 2, itemName = "item 2")<br/>itemDao.addItem(item1)<br/>itemDao.addItem(item2)</span></pre><p id="324d" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">然后，我们将对第二个项目执行删除操作(两者都可以)。</p><pre class="km kn ko kp gt ns nt nu nv aw nw bi"><span id="3bfd" class="nx mg in nt b gy ny nz l oa ob">itemDao.removeItem(item2)</span></pre><p id="5f11" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">现在，我们观察这个流，并检查被删除的条目是否不在返回的条目列表中，如下所示</p><pre class="km kn ko kp gt ns nt nu nv aw nw bi"><span id="dec0" class="nx mg in nt b gy ny nz l oa ob">itemDao.getAllItems().test <strong class="nt ix">{<br/>    </strong><em class="oc">val </em>list = awaitItem()<br/>    <em class="oc">assert</em>(list.size == 1)<br/>    <em class="oc">assert</em>(list.contains(item1))<br/>    cancel()<br/><strong class="nt ix">}</strong></span></pre><p id="1300" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">一旦我们完成断言，请确保调用 cancel。</p><p id="6e50" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">运行测试，结果如下</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ou"><img src="../Images/5934496ae096ed7fed562ac55c18c9ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EFWKupDjSBsM-zhBITo6og.png"/></div></div></figure><p id="1815" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">还有 Bamn！我们成功地测试了删除数据库中的项目。</p><h2 id="9b30" class="nx mg in bd mh od oe dn ml of og dp mp ll oh oi mr lp oj ok mt lt ol om mv it bi translated">测试案例 3</h2><p id="b92b" class="pw-post-body-paragraph lc ld in le b lf mx jx lh li my ka lk ll mz ln lo lp na lr ls lt nb lv lw lx ig bi translated">更新数据库中的项目，应该在我们的流程中返回。</p><pre class="km kn ko kp gt ns nt nu nv aw nw bi"><span id="1640" class="nx mg in nt b gy ny nz l oa ob">@Test<br/><em class="oc">fun </em>updateItem_shouldReturn_theItem_inFlow() = <em class="oc">runTest </em><strong class="nt ix">{ }</strong></span></pre><blockquote class="on oo op"><p id="8b42" class="lc ld oc le b lf lg jx lh li lj ka lk oq lm ln lo or lq lr ls os lu lv lw lx ig bi translated">如果您已经了解了这么多，那么您一定已经对如何测试我们的数据库以及测试什么有了足够的了解。所以现在您可以自己编写更新项目测试用例并断言条件。</p><p id="5385" class="lc ld oc le b lf lg jx lh li lj ka lk oq lm ln lo or lq lr ls os lu lv lw lx ig bi translated">请发表评论，让我知道你是否能够成功地做到这一点，即使没有。🤘</p></blockquote><p id="805e" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">哇哦。我们已经为我们的房间数据库编写了测试用例，并测试了我们的流程。这将足以开始测试，并使您的代码更加防错。现在进行设置，并尝试不同的场景。</p><p id="8cca" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">您可以查看下面的完整要点以供参考。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="nc nd l"/></div></figure></div><div class="ab cl ly lz hr ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="ig ih ii ij ik"><h1 id="0628" class="mf mg in bd mh mi mj mk ml mm mn mo mp kc mq kd mr kf ms kg mt ki mu kj mv mw bi translated">有奖阅读</h1><ul class=""><li id="b08b" class="ne nf in le b lf mx li my ll ov lp ow lt ox lx nj nk nl nm bi translated"><a class="ae lb" rel="noopener ugc nofollow" target="_blank" href="/writing-viewmodel-tests-in-android-testing-fundamentals-ii-5bc44efa4a39">视图模型测试</a></li><li id="98e4" class="ne nf in le b lf nn li no ll np lp nq lt nr lx nj nk nl nm bi translated"><a class="ae lb" rel="noopener ugc nofollow" target="_blank" href="/writing-viewmodel-tests-in-android-testing-fundamentals-ii-5bc44efa4a39">如何在 Android 中编写本地测试</a></li></ul><h1 id="8c74" class="mf mg in bd mh mi oy mk ml mm oz mo mp kc pa kd mr kf pb kg mt ki pc kj mv mw bi translated">目前就这些了！敬请期待！</h1><p id="e532" class="pw-post-body-paragraph lc ld in le b lf mx jx lh li my ka lk ll mz ln lo lp na lr ls lt nb lv lw lx ig bi translated">与我联系(如果内容对您有帮助),请访问</p><ul class=""><li id="e385" class="ne nf in le b lf lg li lj ll ng lp nh lt ni lx nj nk nl nm bi translated"><a class="ae lb" href="https://saurabhpant.medium.com/" rel="noopener">中等</a></li><li id="f045" class="ne nf in le b lf nn li no ll np lp nq lt nr lx nj nk nl nm bi translated"><a class="ae lb" href="https://github.com/aqua30" rel="noopener ugc nofollow" target="_blank"> GitHub </a></li><li id="2497" class="ne nf in le b lf nn li no ll np lp nq lt nr lx nj nk nl nm bi translated"><a class="ae lb" href="https://twitter.com/saurabh30pant" rel="noopener ugc nofollow" target="_blank">推特</a></li><li id="2b30" class="ne nf in le b lf nn li no ll np lp nq lt nr lx nj nk nl nm bi translated"><a class="ae lb" href="https://www.linkedin.com/in/saurabh-pant-44619057/" rel="noopener ugc nofollow" target="_blank">领英</a></li></ul><p id="9f76" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">订阅电子邮件，同步了解更多关于 Android/IOS/Backend/Web 的有趣话题。</p><p id="8433" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">直到下一次…</p><p id="81b2" class="pw-post-body-paragraph lc ld in le b lf lg jx lh li lj ka lk ll lm ln lo lp lq lr ls lt lu lv lw lx ig bi translated">干杯！</p></div></div>    
</body>
</html>