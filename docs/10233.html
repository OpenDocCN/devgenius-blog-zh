<html>
<head>
<title>Playing PyFlink from Scratch</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从头开始玩 PyFlink</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/playing-pyflink-from-scratch-65c18908c366?source=collection_archive---------7-----------------------#2022-10-17">https://blog.devgenius.io/playing-pyflink-from-scratch-65c18908c366?source=collection_archive---------7-----------------------#2022-10-17</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="46f3" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">了解 Kubernetes 上的 PyFlink 1.15.2</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/15fe318e42b0a1076955bc97a4c6169c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*rV-9-Gx4yDrGNssM"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk translated">照片由<a class="ae ks" href="https://unsplash.com/@kel_foto" rel="noopener ugc nofollow" target="_blank">汉斯约格·凯勒</a>在<a class="ae ks" href="https://unsplash.com/photos/xy6r-F-w70c" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</figcaption></figure><p id="4cf2" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">最近在尝试玩 PyFlink，但是网上能找到的资料不多，大部分资料都有点过时了。因此，我将记录我是如何设置环境并实际使用 PyFlink 进行实验的。</p><p id="0bd3" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">开始之前，让我们设定实验目标。</p><ol class=""><li id="b2d9" class="lp lq in kv b kw kx kz la lc lr lg ls lk lt lo lu lv lw lx bi translated">来运行 PyFlink 而不是 Flink，因为我不会用 JAVA 编码。</li><li id="888c" class="lp lq in kv b kw ly kz lz lc ma lg mb lk mc lo lu lv lw lx bi translated">要在 K8s 上运行，而不是 docker 或单机。</li><li id="cd97" class="lp lq in kv b kw ly kz lz lc ma lg mb lk mc lo lu lv lw lx bi translated">使用 Flink 的最新版本 1.15.2。</li></ol><p id="7cc5" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">我简单描述一下整个实验过程。</p><ol class=""><li id="5a4e" class="lp lq in kv b kw kx kz la lc lr lg ls lk lt lo lu lv lw lx bi translated">创建一个 K8s 集群。</li><li id="4be4" class="lp lq in kv b kw ly kz lz lc ma lg mb lk mc lo lu lv lw lx bi translated">部署 PyFlink 集群。</li><li id="7249" class="lp lq in kv b kw ly kz lz lc ma lg mb lk mc lo lu lv lw lx bi translated">从本地机器上传作业。</li><li id="2715" class="lp lq in kv b kw ly kz lz lc ma lg mb lk mc lo lu lv lw lx bi translated">在仪表板中检查作业状态。</li></ol><p id="ed69" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">现在，相信你们都明白实验过程了，那就开始准备前提条件吧。</p><ul class=""><li id="e7a5" class="lp lq in kv b kw kx kz la lc lr lg ls lk lt lo md lv lw lx bi translated">不要使用 M1 芯片。<a class="ae ks" href="https://issues.apache.org/jira/browse/FLINK-25188" rel="noopener ugc nofollow" target="_blank">目前稳定的版本 1.15.2 不支持 M1 芯片</a>，所以在 M1 上安装 PyFlink 会很痛苦。</li><li id="76d1" class="lp lq in kv b kw ly kz lz lc ma lg mb lk mc lo md lv lw lx bi translated">JAVA 11</li><li id="98ac" class="lp lq in kv b kw ly kz lz lc ma lg mb lk mc lo md lv lw lx bi translated">python 3.6–3.8</li></ul><p id="6ade" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">一切准备就绪后，让我们开始吧！</p><h1 id="f61d" class="me mf in bd mg mh mi mj mk ml mm mn mo jt mp ju mq jw mr jx ms jz mt ka mu mv bi translated">创建 K8s 集群</h1><p id="4a94" class="pw-post-body-paragraph kt ku in kv b kw mw jo ky kz mx jr lb lc my le lf lg mz li lj lk na lm ln lo ig bi translated">我个人的偏好是用<a class="ae ks" href="https://k3s.io/" rel="noopener ugc nofollow" target="_blank"> K3s </a>创建集群而不是 minikube。</p><p id="db76" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">有几个原因。</p><ol class=""><li id="b70a" class="lp lq in kv b kw kx kz la lc lr lg ls lk lt lo lu lv lw lx bi translated">更容易共享环境。我的实验环境在 EC2 上，所以知道位置的人都可以用。</li><li id="d9f9" class="lp lq in kv b kw ly kz lz lc ma lg mb lk mc lo lu lv lw lx bi translated">它更节省资源。minikube 对系统要求高，而 K3s 本身是为物联网设备设计的，相对来说资源效率较高。</li><li id="d5d3" class="lp lq in kv b kw ly kz lz lc ma lg mb lk mc lo lu lv lw lx bi translated">K3s 是普通 K8s，没有什么特别之处。</li></ol><p id="7e0e" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">根据<a class="ae ks" href="https://docs.k3s.io/quick-start" rel="noopener ugc nofollow" target="_blank">官方文件</a>设置集群后，需要进行一些额外的设置。</p><p id="bb51" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">创建一个命名空间。</p><ul class=""><li id="a395" class="lp lq in kv b kw kx kz la lc lr lg ls lk lt lo md lv lw lx bi translated"><code class="fe nb nc nd ne b">kubectl create ns flink</code></li></ul><p id="3d17" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">创建服务帐户。</p><ul class=""><li id="b1c7" class="lp lq in kv b kw kx kz la lc lr lg ls lk lt lo md lv lw lx bi translated"><code class="fe nb nc nd ne b">kubectl create serviceaccount flink -n flink</code></li></ul><p id="3474" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">授予对服务帐户的授权。</p><ul class=""><li id="0551" class="lp lq in kv b kw kx kz la lc lr lg ls lk lt lo md lv lw lx bi translated"><code class="fe nb nc nd ne b">kubectl create clusterrolebinding flink-role-bind --clusterrole=edit --serviceaccount=flink:flink</code></li></ul><h1 id="7ff2" class="me mf in bd mg mh mi mj mk ml mm mn mo jt mp ju mq jw mr jx ms jz mt ka mu mv bi translated">构建 PyFlink 集群</h1><p id="3a45" class="pw-post-body-paragraph kt ku in kv b kw mw jo ky kz mx jr lb lc my le lf lg mz li lj lk na lm ln lo ig bi translated">要构建 PyFlink 集群，我们需要准备容器映像来首先支持 PyFlink，如下所示。</p><p id="cceb" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><a class="ae ks" href="https://hub.docker.com/r/wirelessr/pyflink" rel="noopener ugc nofollow" target="_blank">https://hub.docker.com/r/wirelessr/pyflink</a></p><p id="2208" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">构建容器的<code class="fe nb nc nd ne b">Dockerfile</code>也可以在 Dockerhub 中获得。</p><p id="40a3" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">接下来在本地下载 flink 神器的最新稳定版。</p><p id="bef8" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><a class="ae ks" href="https://www.apache.org/dyn/closer.lua/flink/flink-1.15.2/flink-1.15.2-bin-scala_2.12.tgz" rel="noopener ugc nofollow" target="_blank">https://www . Apache . org/dyn/closer . Lua/flink/flink-1 . 15 . 2/flink-1 . 15 . 2-bin-Scala _ 2.12 . tgz</a></p><p id="9beb" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">解压缩后，我们必须添加<a class="ae ks" href="https://stackoverflow.com/questions/68761409/jcapemkeyconverter-is-provided-by-bouncycastle-an-optional-dependency-to-use-s" rel="noopener ugc nofollow" target="_blank">一些需要的</a>但没有打包到其中的脂肪罐。</p><p id="cf82" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">从以下网址下载 bcprov-jdk15on 和 bcpkix-jdk15on jar 文件</p><ul class=""><li id="ecb6" class="lp lq in kv b kw kx kz la lc lr lg ls lk lt lo md lv lw lx bi translated"><a class="ae ks" href="https://mvnrepository.com/artifact/org.bouncycastle/bcprov-jdk15on" rel="noopener ugc nofollow" target="_blank">https://mvn repository . com/artifact/org . bouncy castle/BC prov-JDK 15 on</a></li><li id="29dc" class="lp lq in kv b kw ly kz lz lc ma lg mb lk mc lo md lv lw lx bi translated"><a class="ae ks" href="https://mvnrepository.com/artifact/org.bouncycastle/bcpkix-jdk15on" rel="noopener ugc nofollow" target="_blank">https://mvn repository . com/artifact/org . bouncy castle/bcp kix-JDK 15 on</a></li></ul><p id="027a" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">然后将它们移动到文件夹中</p><blockquote class="nf ng nh"><p id="dbf2" class="kt ku ni kv b kw kx jo ky kz la jr lb nj ld le lf nk lh li lj nl ll lm ln lo ig bi translated"><em class="in">。/flink-1.15.2/lib </em></p></blockquote><p id="92d5" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">一切准备就绪后，我们就可以在 K8s 上运行 PyFlink 集群了。</p><pre class="kd ke kf kg gt nm ne nn no aw np bi"><span id="bc1f" class="nq mf in ne b gy nr ns l nt nu">./bin/kubernetes-session.sh \<br/> -Dkubernetes.namespace=flink \<br/> -Dkubernetes.jobmanager.service-account=flink \<br/> -Dkubernetes.rest-service.exposed.type=NodePort \<br/> -Dkubernetes.cluster-id=flink-cluster \<br/> -Dkubernetes.jobmanager.cpu=0.2 \<br/> -Djobmanager.memory.process.size=1024m \<br/> -Dresourcemanager.taskmanager-timeout=3600000 \<br/> -Dkubernetes.taskmanager.cpu=0.2 \<br/> -Dtaskmanager.memory.process.size=1024m \<br/> -Dtaskmanager.numberOfTaskSlots=1 \<br/> -Dkubernetes.container.image=wirelessr/pyflink:1.15.2-scala_2.12-python_3.7</span></pre><p id="c497" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">有两个关键点值得注意。</p><ol class=""><li id="8f05" class="lp lq in kv b kw kx kz la lc lr lg ls lk lt lo lu lv lw lx bi translated"><code class="fe nb nc nd ne b">rest-service.exposed.type=NodePort</code>。为了允许用户访问 PyFlink 集群，并简化实验过程，我们选择使用<code class="fe nb nc nd ne b">NodePort</code>作为外部接口。</li><li id="275b" class="lp lq in kv b kw ly kz lz lc ma lg mb lk mc lo lu lv lw lx bi translated">我们必须指定能够支持 PyFlink 的<code class="fe nb nc nd ne b">container.image</code>，在本例中，就是前面提到的<a class="ae ks" href="https://hub.docker.com/r/wirelessr/pyflink" rel="noopener ugc nofollow" target="_blank"> Dockerhub </a>。</li></ol><p id="90cc" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">通过使用<code class="fe nb nc nd ne b">kubectl get svc -n flink</code>，我们可以知道仪表板(flink-cluster-rest)正在哪个端口上运行。这个仪表板位置也将是我们稍后要提交的作业的入口点。</p><h1 id="4f65" class="me mf in bd mg mh mi mj mk ml mm mn mo jt mp ju mq jw mr jx ms jz mt ka mu mv bi translated">提交工作</h1><p id="f5e0" class="pw-post-body-paragraph kt ku in kv b kw mw jo ky kz mx jr lb lc my le lf lg mz li lj lk na lm ln lo ig bi translated">大多数 Flink 示例将使用<code class="fe nb nc nd ne b">examples/batch/WordCount.jar</code>作为第一个 Hello World。</p><p id="e64c" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">所以我们也可以用这个 Jar 文件来测试 Flink 是否能正确运行。</p><pre class="kd ke kf kg gt nm ne nn no aw np bi"><span id="082b" class="nq mf in ne b gy nr ns l nt nu">./bin/flink run \<br/>  -m ${flink-cluster-rest}:${port} \<br/>  examples/batch/WordCount.jar</span></pre><p id="9162" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">提交后，我们可以在仪表板中查看结果，通常情况下，它会被成功执行。但是这个例子是基于 JAVA 的，所以我们将使用一个基于 Python 的例子来验证 PyFlink。</p><p id="1357" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">在开始之前，我们需要在本地安装 PyFlink 包。</p><blockquote class="nf ng nh"><p id="b55f" class="kt ku ni kv b kw kx jo ky kz la jr lb nj ld le lf nk lh li lj nl ll lm ln lo ig bi translated"><em class="in"> pip3 安装 apache-flink==1.15.2 </em></p></blockquote><p id="7688" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">如果我们没有使用 M1 芯片，这个命令应该安装成功，没有任何问题。</p><p id="02fe" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">与 WordCount 示例相同，Python 在<code class="fe nb nc nd ne b">examples/python/table/word_count.py</code>中也有相应的 WordCount 示例。</p><p id="f1fa" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">然而，Python 示例需要稍加修改才能正常工作。找到这个注释行:</p><blockquote class="nf ng nh"><p id="3cc9" class="kt ku ni kv b kw kx jo ky kz la jr lb nj ld le lf nk lh li lj nl ll lm ln lo ig bi translated"><em class="in">除去。如果提交到远程集群，请等待</em></p></blockquote><p id="ef10" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">按照说明移除上面的<code class="fe nb nc nd ne b">.wait</code>，然后我们尝试提交 Python 作业。</p><pre class="kd ke kf kg gt nm ne nn no aw np bi"><span id="747d" class="nq mf in ne b gy nr ns l nt nu">./bin/flink run \<br/>  -m ${flink-cluster-rest}:${port} \<br/>  -py ./examples/python/table/word_count.py</span></pre><p id="a278" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">返回控制面板应该会显示作业也在正常执行。</p><h1 id="8d38" class="me mf in bd mg mh mi mj mk ml mm mn mo jt mp ju mq jw mr jx ms jz mt ka mu mv bi translated">结论</h1><p id="8275" class="pw-post-body-paragraph kt ku in kv b kw mw jo ky kz mx jr lb lc my le lf lg mz li lj lk na lm ln lo ig bi translated">关于 PyFLink 的资料很少，无论是环境安装还是编码参考，希望这篇文章对你有帮助。</p><p id="210e" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">然而，本文并没有详细解释 Flink 集群的细节以及如何开发 PyFlink，我将把这些细节留给以后的文章。</p></div></div>    
</body>
</html>