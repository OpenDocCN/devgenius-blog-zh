<html>
<head>
<title>Simple GCP Authentication with Service Accounts</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用服务帐户的简单GCP身份验证</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/simple-gcp-authentication-with-service-accounts-6b877c2e2649?source=collection_archive---------1-----------------------#2020-09-02">https://blog.devgenius.io/simple-gcp-authentication-with-service-accounts-6b877c2e2649?source=collection_archive---------1-----------------------#2020-09-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="5619" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用GCP服务帐户轻松安全地认证和使用Google Cloud APIs的实用指南。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/e55e87dc282041d4fcb5ad52a3cc8a87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*tPMcwDLT-GoqNTsl"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">照片由<a class="ae lb" href="https://unsplash.com/@morningbrew?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">晨酿</a>在<a class="ae lb" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="3f42" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了使用Google Cloud产品，应用程序必须首先向Google认证并检查IAM权限。虽然<a class="ae lb" href="https://cloud.google.com/iam/docs" rel="noopener ugc nofollow" target="_blank"> Google的IAM文档</a>页面详细介绍了安全最佳实践，但作为一名非安全工程师，很难解析所有文本并为每个用例应用Google的建议。我知道我应该对我的服务帐户执行最小特权，但是在本地开发和在GKE上提供访问权限时，用Google SDKs进行身份验证的最佳方式是什么？在这篇文章中，我将总结与谷歌云交互时常见用例的建议。</p><h1 id="fbc1" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">使用CLI (gcloud、terraform)</h1><p id="f7e1" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">如果您主要通过CLI与GCP交互(或者调用<code class="fe mf mg mh mi b">gsutil</code>、<code class="fe mf mg mh mi b">gcloud</code>，或者通过<code class="fe mf mg mh mi b">terraform</code>创建GCP组件)，创建一个具有各自角色的服务帐户，<strong class="jp ir">使用服务帐户模拟特性</strong>。直到最近，GCP控制台还为用户提供了在创建服务帐户时创建和下载密钥的选项。现在，该选项隐藏在默认创建工作流中，用户必须单击服务帐户选项来手动创建密钥。</p><p id="4ff8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所有Google Cloud APIs都使用OAuth2进行认证。当您生成服务帐户密钥时，它会创建一个公钥/私钥对，用于将JWT令牌签名为真正的GCP凭据。虽然这很方便，但下载密钥被认为是危险的，因为它可能会被意外地签入版本控制，并且不会过期(默认的过期日期是9999年12月31日)。GCP支持密钥轮换，但是集中执行这一点非常困难，除非你有像<a class="ae lb" href="https://medium.com/techking/key-rotation-in-google-cloud-3ee8ff0a7828" rel="noopener"> Vault这样的工具来自动执行这个过程</a>。</p><p id="e8a3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好消息是，您可以模拟服务帐户进行身份验证，而无需下载密钥。首先，您需要<code class="fe mf mg mh mi b">serviceAccountTokenCreator</code>角色并用常规的<code class="fe mf mg mh mi b">gcloud</code>命令运行<code class="fe mf mg mh mi b">--impersonate-service-accouunt=&lt;sa-name&gt;@project.iam.gservicaccount.com</code>。您还可以设置您的配置，以避免每次都传入命令:</p><pre class="km kn ko kp gt mj mi mk ml aw mm bi"><span id="0a45" class="mn ld iq mi b gy mo mp l mq mr">gcloud config set auth/impersonate_service_account \<br/>  &lt;sa-name&gt;@project.iam.gserviceaccount.com</span></pre><p id="4417" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于Terraform，设置<code class="fe mf mg mh mi b">GOOGLE_OAUTH_ACCESS_TOKEN</code>变量来传递OAuth2令牌:</p><pre class="km kn ko kp gt mj mi mk ml aw mm bi"><span id="1e63" class="mn ld iq mi b gy mo mp l mq mr">export GOOGLE_OAUTH_ACCESS_TOKEN=$(gcloud auth print-access-token)</span></pre><p id="b8db" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，您可以使用一个短期令牌运行<code class="fe mf mg mh mi b">terraform</code>命令，而不是下载您必须安全管理的密钥。来自Google的Ryan Canty 写了一篇关于这个主题的好文章，其中有在多个服务帐户之间切换的bash脚本示例:</p><div class="mu mv gp gr mw mx"><a href="https://medium.com/@jryancanty/stop-downloading-google-cloud-service-account-keys-1811d44a97d9" rel="noopener follow" target="_blank"><div class="my ab fo"><div class="mz ab na cl cj nb"><h2 class="bd ir gy z fp nc fr fs nd fu fw ip bi translated">停止下载谷歌云服务账户密钥！</h2><div class="ne l"><h3 class="bd b gy z fp nc fr fs nd fu fw dk translated">TL；DR:下载服务帐户密钥会给你的组织带来严重的安全风险，因为它们的寿命很长…</h3></div><div class="nf l"><p class="bd b dl z fp nc fr fs nd fu fw dk translated">medium.com</p></div></div><div class="ng l"><div class="nh l ni nj nk ng nl kv mx"/></div></div></a></div><h1 id="9f24" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">当地/非GCP发展</h1><p id="4982" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">所有Google Cloud客户端库都使用一个名为应用默认凭证(ADC)的底层认证库来自动查找和设置服务帐户凭证。它按以下顺序查找凭据:</p><ol class=""><li id="080b" class="nm nn iq jp b jq jr ju jv jy no kc np kg nq kk nr ns nt nu bi translated">它检查环境变量<code class="fe mf mg mh mi b">GOOGLE_APPLICATION_CREDENTIALS</code>是否被设置。如果是，它使用env指向的服务帐户文件。</li><li id="3477" class="nm nn iq jp b jq nv ju nw jy nx kc ny kg nz kk nr ns nt nu bi translated">如果未设置该变量，则它使用默认的服务帐户。</li><li id="3557" class="nm nn iq jp b jq nv ju nw jy nx kc ny kg nz kk nr ns nt nu bi translated">如果ADC不能使用上述任何一项，它就会出错。</li></ol><p id="d756" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这为开发人员提供了两种身份验证选择:</p><ol class=""><li id="3bc8" class="nm nn iq jp b jq jr ju jv jy no kc np kg nq kk nr ns nt nu bi translated">创建一个服务帐户，将密钥下载到一个安全的位置，并设置<code class="fe mf mg mh mi b">GOOGLE_APPLICATION_CREDENTIALS</code></li><li id="5000" class="nm nn iq jp b jq nv ju nw jy nx kc ny kg nz kk nr ns nt nu bi translated">使用<code class="fe mf mg mh mi b">gcloud auth application-default login</code>将您的用户凭证设置为<code class="fe mf mg mh mi b">~/.config/gcloud/application_default_credentials.json</code></li></ol><p id="44bf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">虽然第二种方法对于初始测试更方便，但不推荐使用这种方法，因为它使用的是您的用户凭据，而不是服务帐户的权限范围，后者很可能受到更多限制。此外，一些SDK特性，如<a class="ae lb" href="https://firebase.google.com/docs/auth/admin/create-custom-tokens" rel="noopener ugc nofollow" target="_blank"> Firebase定制令牌</a>和<a class="ae lb" href="https://cloud.google.com/storage/docs/access-control/signed-urls" rel="noopener ugc nofollow" target="_blank"> GCS签名URL</a>需要client_email字段，这不是应用程序默认登录凭证的一部分。</p><p id="3074" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">Google团队的一般建议是创建并下载JSON凭证文件，并将路径设置为</strong> <code class="fe mf mg mh mi b"><strong class="jp ir">GOOGLE_APPLICATION_CREDENTIALS</strong></code>。考虑到上面列出的关于这些持久密钥的安全问题，请确保将其存储在安全的地方，并在开发GCP项目上进行测试。欲了解更多信息，请查看Theodore Siu 关于GCP地方发展的文章:</p><div class="mu mv gp gr mw mx"><a href="https://medium.com/google-cloud/local-remote-authentication-with-google-cloud-platform-afe3aa017b95" rel="noopener follow" target="_blank"><div class="my ab fo"><div class="mz ab na cl cj nb"><h2 class="bd ir gy z fp nc fr fs nd fu fw ip bi translated">使用Google云平台进行本地/远程身份验证</h2><div class="ne l"><h3 class="bd b gy z fp nc fr fs nd fu fw dk translated">在本地或远程机器上设置谷歌云平台认证可能是一项令人困惑的任务。</h3></div><div class="nf l"><p class="bd b dl z fp nc fr fs nd fu fw dk translated">medium.com</p></div></div><div class="ng l"><div class="oa l ni nj nk ng nl kv mx"/></div></div></a></div><p id="7825" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="ob">注意:这一部分也适用于在混合云架构上调用GCP API。例如，您可能使用来自AWS的Google ML API或使用Firebase进行移动开发，同时将其他计算工作负载放在不同的云上。</em></p><h1 id="fbc9" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">谷歌云上的应用</h1><p id="753e" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">在Google Cloud上，ADC在Compute Engine、App Engine、Kubernetes Engine、Cloud Run和Cloud Functions上运行时，会自动搜索默认服务帐户。默认服务帐户具有编辑者角色，并为各种GCP产品设置默认授权范围。例如，使用默认服务帐户创建的GKE群集授予对存储的只读访问权限，以及对堆栈驱动程序日志记录和监视的写访问权限。如果需要更细粒度的访问，可以创建一个新的服务帐户，并附加它以使用其IAM角色，而不是默认的服务帐户。</p><p id="5f0b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">至于让容器访问Google云资源，推荐的做法是使用</strong> <a class="ae lb" href="https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir">工作负载标识</strong> </a>。工作负载身份类似于亚马逊EKS IAM服务帐户角色(IRSA ),因为它使Kubernetes服务帐户(KSA)能够在访问Google Cloud APIs时充当Google服务帐户(GSA)。一旦在GKE上启用了工作负载标识，就会创建一个名为<code class="fe mf mg mh mi b">&lt;project-id&gt;.svc.id.goog</code>的标识池。</p><p id="94bc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要在KSA和GSA之间建立连接，首先创建两个服务帐户:</p><pre class="km kn ko kp gt mj mi mk ml aw mm bi"><span id="2b59" class="mn ld iq mi b gy mo mp l mq mr">$ kubectl create sa &lt;ksa_name&gt; -n <!-- -->&lt;k8s_namespace&gt;<br/>$ gcloud iam service-accounts create &lt;gsa-name&gt;</span></pre><p id="e6d3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将IAM策略与<code class="fe mf mg mh mi b">roles/iam.workloadIdentityUser</code>角色绑定:</p><pre class="km kn ko kp gt mj mi mk ml aw mm bi"><span id="8cdd" class="mn ld iq mi b gy mo mp l mq mr">$ <!-- -->gcloud iam service-accounts add-iam-policy-binding \<br/>  --role roles/iam.workloadIdentityUser \<br/>  --member "serviceAccount:&lt;project_id&gt;.svc.id.goog[k8s_namespace/ksa_name]" \<br/>  &lt;gsa_name&gt;@&lt;project_id&gt;.iam.gserviceaccount.com</span></pre><p id="729a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，给KSA加一个注解:</p><pre class="km kn ko kp gt mj mi mk ml aw mm bi"><span id="f563" class="mn ld iq mi b gy mo mp l mq mr">$ <!-- -->kubectl annotate serviceaccount \<br/>  --namespace &lt;k8s_namespace&gt; \<br/>   &lt;ksa_name&gt; \<br/>   iam.gke.io/gcp-service-account=&lt;gsa_name&gt;@&lt;project_id&gt;.iam.gserviceaccount.com</span></pre><p id="8e02" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">工作负载身份确实有一些限制<a class="ae lb" href="https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity" rel="noopener ugc nofollow" target="_blank"/>，比如不支持GKE本地和Windows节点。在这种情况下，您可以从secret安装服务帐户密钥并设置<code class="fe mf mg mh mi b">GOOGLE_APPLICATION_CREDENTIALS</code>，或者使用类似<a class="ae lb" href="https://www.hashicorp.com/blog/injecting-vault-secrets-into-kubernetes-pods-via-a-sidecar/" rel="noopener ugc nofollow" target="_blank">保险库秘密注入器</a>的工具。</p><h1 id="64ce" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">最后的话</h1><p id="2990" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">我绝不是安全专家，但你可以遵循这些简单的服务帐户建议来安全地访问Google Cloud APIs，即使没有复杂的秘密管理设置。在接下来的步骤中，您还可以查看<a class="ae lb" href="https://github.com/GoogleCloudPlatform/inspec-gcp-cis-benchmark" rel="noopener ugc nofollow" target="_blank"> GCP CIS基准Inspec Profile工具</a>，以确保您的项目涵盖了适当的IAM部分。</p></div></div>    
</body>
</html>