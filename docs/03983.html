<html>
<head>
<title>Validate Objects with Joi — Annotations and Failover Values</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Joi验证对象—注释和故障转移值</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/validate-objects-with-joi-annotations-and-failover-values-8a41f13cb0d0?source=collection_archive---------2-----------------------#2021-01-11">https://blog.devgenius.io/validate-objects-with-joi-annotations-and-failover-values-8a41f13cb0d0?source=collection_archive---------2-----------------------#2021-01-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/6292a90f12bb4f847bcdf2f34fc40a13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*USQzo1xPX5x1n7DA"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated"><a class="ae kc" href="https://unsplash.com/@phammi?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">米PHAM </a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</figcaption></figure><p id="3d81" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Joi是一个让我们轻松验证对象结构的库。</p><p id="71c7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将看看如何用Joi验证对象。</p><h1 id="5fb0" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated"><code class="fe lz ma mb mc b">any</code></h1><p id="dab3" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated"><code class="fe lz ma mb mc b">any</code>创建匹配任何数据类型的模式:</p><pre class="mi mj mk ml gt mm mc mn mo aw mp bi"><span id="36e9" class="mq lc iq mc b gy mr ms l mt mu">const any = Joi.any();<br/>await any.validateAsync('a');</span></pre><h2 id="3702" class="mq lc iq bd ld mv mw dn lh mx my dp ll ko mz na lp ks nb nc lt kw nd ne lx nf bi translated"><code class="fe lz ma mb mc b">failover</code></h2><p id="976d" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">如果模式验证通过<code class="fe lz ma mb mc b">failover</code>失败，我们可以设置一个故障转移值。</p><h2 id="621f" class="mq lc iq bd ld mv mw dn lh mx my dp ll ko mz na lp ks nb nc lt kw nd ne lx nf bi translated"><code class="fe lz ma mb mc b">forbidden</code></h2><p id="aa38" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated"><code class="fe lz ma mb mc b">forbidden</code>让我们将某个键标记为禁止:</p><pre class="mi mj mk ml gt mm mc mn mo aw mp bi"><span id="1085" class="mq lc iq mc b gy mr ms l mt mu">const schema = {<br/>  a: Joi.any().forbidden()<br/>};</span></pre><p id="7b65" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，如果<code class="fe lz ma mb mc b">a</code>在我们的对象中，验证就会失败。</p><h2 id="34bf" class="mq lc iq bd ld mv mw dn lh mx my dp ll ko mz na lp ks nb nc lt kw nd ne lx nf bi translated"><code class="fe lz ma mb mc b">id</code></h2><p id="7e0c" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated"><code class="fe lz ma mb mc b">id</code>方法让我们设置获取模式的模式ID。</p><h2 id="82ca" class="mq lc iq bd ld mv mw dn lh mx my dp ll ko mz na lp ks nb nc lt kw nd ne lx nf bi translated"><code class="fe lz ma mb mc b">invalid</code></h2><p id="bad5" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated"><code class="fe lz ma mb mc b">invalid</code>让我们标记无效值:</p><pre class="mi mj mk ml gt mm mc mn mo aw mp bi"><span id="6e60" class="mq lc iq mc b gy mr ms l mt mu">const schema = {<br/>  a: Joi.any().invalid("a"),<br/>  b: Joi.any().invalid("b", "B")<br/>};</span></pre><h2 id="f2af" class="mq lc iq bd ld mv mw dn lh mx my dp ll ko mz na lp ks nb nc lt kw nd ne lx nf bi translated"><code class="fe lz ma mb mc b">label</code></h2><p id="d2b1" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated"><code class="fe lz ma mb mc b">label</code>让我们覆盖错误消息中的键名:</p><pre class="mi mj mk ml gt mm mc mn mo aw mp bi"><span id="5159" class="mq lc iq mc b gy mr ms l mt mu">const schema = {<br/>  name: Joi.string().label("Name")<br/>};</span></pre><h2 id="3f57" class="mq lc iq bd ld mv mw dn lh mx my dp ll ko mz na lp ks nb nc lt kw nd ne lx nf bi translated"><code class="fe lz ma mb mc b">meta</code></h2><p id="6ee3" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated"><code class="fe lz ma mb mc b">meta</code>让我们向关键字添加元数据:</p><pre class="mi mj mk ml gt mm mc mn mo aw mp bi"><span id="32e1" class="mq lc iq mc b gy mr ms l mt mu">const schema = Joi.any().meta({ index: true });</span></pre><h2 id="d16c" class="mq lc iq bd ld mv mw dn lh mx my dp ll ko mz na lp ks nb nc lt kw nd ne lx nf bi translated"><code class="fe lz ma mb mc b">note</code></h2><p id="6c22" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated"><code class="fe lz ma mb mc b">note</code>添加注释作为单独的参数对其进行注释:</p><pre class="mi mj mk ml gt mm mc mn mo aw mp bi"><span id="a670" class="mq lc iq mc b gy mr ms l mt mu">const schema = Joi.any().note('this is special', 'this is important');</span></pre><h2 id="f2e3" class="mq lc iq bd ld mv mw dn lh mx my dp ll ko mz na lp ks nb nc lt kw nd ne lx nf bi translated"><code class="fe lz ma mb mc b">optional</code></h2><p id="ac94" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated"><code class="fe lz ma mb mc b">optional</code>将一个键标记为可选:</p><pre class="mi mj mk ml gt mm mc mn mo aw mp bi"><span id="4a99" class="mq lc iq mc b gy mr ms l mt mu">const schema = Joi.any().optional();</span></pre><h2 id="c1a2" class="mq lc iq bd ld mv mw dn lh mx my dp ll ko mz na lp ks nb nc lt kw nd ne lx nf bi translated"><code class="fe lz ma mb mc b">prefs</code></h2><p id="2212" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated"><code class="fe lz ma mb mc b">prefs</code>让我们设置验证选项。</p><h2 id="2a14" class="mq lc iq bd ld mv mw dn lh mx my dp ll ko mz na lp ks nb nc lt kw nd ne lx nf bi translated"><code class="fe lz ma mb mc b">raw</code></h2><p id="e98d" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated"><code class="fe lz ma mb mc b">raw</code>输出原始未接触值，而不是铸造值。</p><p id="b50d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所以如果我们有:</p><pre class="mi mj mk ml gt mm mc mn mo aw mp bi"><span id="6011" class="mq lc iq mc b gy mr ms l mt mu">const rawTimestampSchema = Joi.date().timestamp().raw();<br/>rawTimestampSchema.validate('12376834097810');</span></pre><p id="df5e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们验证字符串，而不是将它转换成一个<code class="fe lz ma mb mc b">Date</code>对象。</p><h2 id="5ebf" class="mq lc iq bd ld mv mw dn lh mx my dp ll ko mz na lp ks nb nc lt kw nd ne lx nf bi translated"><code class="fe lz ma mb mc b">required</code></h2><p id="8530" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated"><code class="fe lz ma mb mc b">required</code>按要求制作钥匙:</p><pre class="mi mj mk ml gt mm mc mn mo aw mp bi"><span id="bb1e" class="mq lc iq mc b gy mr ms l mt mu">const schema = Joi.any().required();</span></pre><h2 id="8cad" class="mq lc iq bd ld mv mw dn lh mx my dp ll ko mz na lp ks nb nc lt kw nd ne lx nf bi translated"><code class="fe lz ma mb mc b">ruleset</code></h2><p id="608f" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated"><code class="fe lz ma mb mc b">ruleset</code>让我们应用多个规则选项:</p><pre class="mi mj mk ml gt mm mc mn mo aw mp bi"><span id="10c2" class="mq lc iq mc b gy mr ms l mt mu">const schema = Joi.number().ruleset.min(1).max(20).rule({ message: 'Number must be between 1 and 20' });</span></pre><h2 id="826f" class="mq lc iq bd ld mv mw dn lh mx my dp ll ko mz na lp ks nb nc lt kw nd ne lx nf bi translated"><code class="fe lz ma mb mc b">shared</code></h2><p id="9d05" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated"><code class="fe lz ma mb mc b">shared</code>注册一个模式，供链接引用中该模式的后代使用。</p><p id="bb8b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果我们有:</p><pre class="mi mj mk ml gt mm mc mn mo aw mp bi"><span id="29ea" class="mq lc iq mc b gy mr ms l mt mu">const schema = Joi.object({<br/>  a: [Joi.string(), Joi.link("#x")],<br/>  b: Joi.link("#type.a")<br/>})<br/>  .shared(Joi.number().id("x"))<br/>  .id("type");</span></pre><p id="6dbe" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后用来自<code class="fe lz ma mb mc b">a</code>的规则验证<code class="fe lz ma mb mc b">b</code>和<code class="fe lz ma mb mc b">x</code></p><h2 id="cbb9" class="mq lc iq bd ld mv mw dn lh mx my dp ll ko mz na lp ks nb nc lt kw nd ne lx nf bi translated"><code class="fe lz ma mb mc b">strip</code></h2><p id="bf51" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated"><code class="fe lz ma mb mc b">strip</code>标记验证后要从对象或数组中移除的键，以整理输出:</p><pre class="mi mj mk ml gt mm mc mn mo aw mp bi"><span id="1f9b" class="mq lc iq mc b gy mr ms l mt mu">const schema = Joi.object({<br/>  username: Joi.string(),<br/>  password: Joi.string().strip()<br/>});</span></pre><p id="2672" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果我们根据此模式进行验证，<code class="fe lz ma mb mc b">password</code>将从输出中删除。</p><h2 id="a90e" class="mq lc iq bd ld mv mw dn lh mx my dp ll ko mz na lp ks nb nc lt kw nd ne lx nf bi translated"><code class="fe lz ma mb mc b">tag</code></h2><p id="cdf5" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated"><code class="fe lz ma mb mc b">tag</code>方法用标签注释了键:</p><pre class="mi mj mk ml gt mm mc mn mo aw mp bi"><span id="af37" class="mq lc iq mc b gy mr ms l mt mu">const schema = Joi.any().tag('foo', 'bar');</span></pre><h2 id="28c8" class="mq lc iq bd ld mv mw dn lh mx my dp ll ko mz na lp ks nb nc lt kw nd ne lx nf bi translated"><code class="fe lz ma mb mc b">tailor</code></h2><p id="dfe3" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated"><code class="fe lz ma mb mc b">tailor</code>返回一个由<code class="fe lz ma mb mc b">alter</code>创建的模式:</p><pre class="mi mj mk ml gt mm mc mn mo aw mp bi"><span id="1b25" class="mq lc iq mc b gy mr ms l mt mu">const schema = Joi.object({<br/>  key: Joi.string().alter({<br/>    get: (schema) =&gt; schema.required(),<br/>    post: (schema) =&gt; schema.forbidden()<br/>  })<br/>});</span><span id="c62c" class="mq lc iq mc b gy ng ms l mt mu">const getSchema = schema.tailor("get");</span></pre><p id="7d3c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe lz ma mb mc b">getSchema</code>将是<code class="fe lz ma mb mc b">get</code>属性的值。</p><h2 id="3342" class="mq lc iq bd ld mv mw dn lh mx my dp ll ko mz na lp ks nb nc lt kw nd ne lx nf bi translated"><code class="fe lz ma mb mc b">unit</code></h2><p id="38f2" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated"><code class="fe lz ma mb mc b">unit</code>标注单位:</p><pre class="mi mj mk ml gt mm mc mn mo aw mp bi"><span id="7c2a" class="mq lc iq mc b gy mr ms l mt mu">const schema = Joi.number().unit('milliseconds');</span></pre><h2 id="f319" class="mq lc iq bd ld mv mw dn lh mx my dp ll ko mz na lp ks nb nc lt kw nd ne lx nf bi translated"><code class="fe lz ma mb mc b">valid</code></h2><p id="b5ab" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated"><code class="fe lz ma mb mc b">valid</code>标记有效值:</p><pre class="mi mj mk ml gt mm mc mn mo aw mp bi"><span id="4eb7" class="mq lc iq mc b gy mr ms l mt mu">const schema = {<br/>  a: Joi.any().valid("a")  <br/>};</span></pre><p id="58ee" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe lz ma mb mc b">'a'</code>是<code class="fe lz ma mb mc b">a</code>的有效值。</p><h2 id="bddf" class="mq lc iq bd ld mv mw dn lh mx my dp ll ko mz na lp ks nb nc lt kw nd ne lx nf bi translated"><code class="fe lz ma mb mc b">validate</code></h2><p id="5240" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated"><code class="fe lz ma mb mc b">validate</code>使用模式验证数据:</p><pre class="mi mj mk ml gt mm mc mn mo aw mp bi"><span id="27f4" class="mq lc iq mc b gy mr ms l mt mu">const schema = Joi.object({<br/>  a: Joi.number()<br/>});</span><span id="4f69" class="mq lc iq mc b gy ng ms l mt mu">const value = {<br/>  a: "123"<br/>};</span><span id="ef1e" class="mq lc iq mc b gy ng ms l mt mu">const result = schema.validate(value);</span></pre><p id="30a1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe lz ma mb mc b">result</code>应该是<code class="fe lz ma mb mc b">true</code>，因为<code class="fe lz ma mb mc b">value.a</code>是一个数字。</p><h2 id="61be" class="mq lc iq bd ld mv mw dn lh mx my dp ll ko mz na lp ks nb nc lt kw nd ne lx nf bi translated"><code class="fe lz ma mb mc b">validateAsync</code></h2><p id="5d56" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated"><code class="fe lz ma mb mc b">validateAsync</code>异步进行验证。</p><p id="4ed7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它返回一个解析为验证结果的承诺。</p><h2 id="1622" class="mq lc iq bd ld mv mw dn lh mx my dp ll ko mz na lp ks nb nc lt kw nd ne lx nf bi translated"><code class="fe lz ma mb mc b">warning</code></h2><p id="b024" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated"><code class="fe lz ma mb mc b">warning</code>设置警告:</p><pre class="mi mj mk ml gt mm mc mn mo aw mp bi"><span id="91aa" class="mq lc iq mc b gy mr ms l mt mu">const schema = Joi.any()<br/>    .warning('custom.x', { w: 'world' })<br/>    .message({ 'custom.x': 'hello {#w}!' });</span><span id="eec8" class="mq lc iq mc b gy ng ms l mt mu">const { value, error, warning } = schema.validate('anything');</span></pre><p id="2e02" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe lz ma mb mc b">#w</code>在我们传入的对象中有<code class="fe lz ma mb mc b">w</code>的值。</p><h1 id="38ed" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="2fd3" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">我们可以用警告、引用和其他注释来定制我们的验证。</p></div></div>    
</body>
</html>