<html>
<head>
<title>Elasticsearch : Ingest Pipelines</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">弹性搜索:摄取管道</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/elasticsearch-ingest-pipelines-6335d349a0a?source=collection_archive---------3-----------------------#2022-08-30">https://blog.devgenius.io/elasticsearch-ingest-pipelines-6335d349a0a?source=collection_archive---------3-----------------------#2022-08-30</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/89705072cd0531af4cf52367fd402b79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dwAzdScwyFi0RCm5J1vcew.jpeg"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk translated">照片由<a class="ae jz" href="https://unsplash.com/@jjying?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> JJ 英</a>在<a class="ae jz" href="https://unsplash.com/s/photos/pipelines?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></figcaption></figure><p id="bb9d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">什么是好人？很高兴在这个系列中再次见到你😁！今天我们来看看<strong class="kc io">摄取管道。</strong></p><p id="0653" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">摄取管道允许我们应用转换，例如<em class="ky">删除字段</em>、<em class="ky">提取信息</em>，甚至<em class="ky">在索引文档之前丰富我们的数据</em>。</p><figure class="la lb lc ld gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi kz"><img src="../Images/059ad292991ba367aa7e95b7fbba776b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U-XK3k_0RnQgGxlNIOqTQA.png"/></div></div></figure><p id="edff" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如果我们有一个文档，并且我们想要提取有意义的信息，我们通过摄取管道运行该文档，并且应用不同的处理器，例如<em class="ky">剖析处理器</em>来提取时间戳，或者<em class="ky">移除处理器</em>来删除字段，等等。</p><p id="4d89" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">转换完成后，生成的文档将被索引。一个流水线由几个可配置的任务组成，这些任务被称为<a class="ae jz" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/processors.html" rel="noopener ugc nofollow" target="_blank">处理器</a>。随着每个处理器相继运行，传入的文档会进行某些修改。Elasticsearch 包括几个可配置的处理器。<br/>我们可以使用节点信息 API 来获取可用处理器的列表。</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="7bb0" class="lj lk in lf b gy ll lm l ln lo">GET _nodes/ingest?filter_path=nodes.*.ingest.processors</span></pre><p id="15a2" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">使用摄取 API 或 Kibana 的摄取管道功能，我们可以构建和管理摄取管道。管道由 Elasticsearch 存储在<a class="ae jz" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-state.html" rel="noopener ugc nofollow" target="_blank">集群状态</a>中，这是一种内部数据结构，记录了每个节点所需的各种数据。</p><p id="570e" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">让我们使用<a class="ae jz" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/ingest-apis.html" rel="noopener ugc nofollow" target="_blank">摄取 API</a>来创建我们的第一个管道。</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="b316" class="lj lk in lf b gy ll lm l ln lo">PUT _ingest/pipeline/my-first-pipeline<br/>{<br/>  "version": 1,<br/>  "description": "My very first pipeline",<br/>  "processors": [<br/>    {<br/>      "set": {<br/>        "description": "Set default value of balance",<br/>        "field": "balance",<br/>        "value": 0<br/>      }<br/>    },<br/>    {<br/>      "set": {<br/>        "description": "Set default value of status field",<br/>        "field": "status",<br/>        "value": true<br/>      }<br/>    },<br/>    {<br/>      "lowercase": {<br/>        "field": "name"<br/>      }<br/>    },<br/>    {<br/>      "remove": {<br/>        "field": "unnecessary field"<br/>      }<br/>    }<br/>  ]<br/>}</span></pre><p id="7e4d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们知道，当我们在<em class="ky">真</em>时得到<em class="ky">确认</em>时，我们的管道就创建好了。现在，让我们通过使用<a class="ae jz" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/simulate-pipeline-api.html" rel="noopener ugc nofollow" target="_blank">模拟管道 API </a>来测试我们的管道。</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="1fd2" class="lj lk in lf b gy ll lm l ln lo">POST _ingest/pipeline/my-first-pipeline/_simulate<br/>{<br/>  "docs": [<br/>    {<br/>      "_source": {<br/>        "name": "Abdoul-Bagui",<br/>        "unnecessary field": "Field to remove"<br/>      }<br/>    }<br/>  ]<br/>}</span></pre><p id="8eea" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">启动时，我们得到以下输出:</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="482d" class="lj lk in lf b gy ll lm l ln lo">{<br/>  "docs": [<br/>    {<br/>      "doc": {<br/>        "_index": "_index",<br/>        "_id": "_id",<br/>        "_version": "-3",<br/>        "_source": {<br/>          "name": "abdoul-bagui",<br/>          "balance": 0,<br/>          "status": true<br/>        },<br/>        "_ingest": {<br/>          "timestamp": "2022-08-30T21:11:25.3094683Z"<br/>        }<br/>      }<br/>    }<br/>  ]<br/>}</span></pre><p id="eedd" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如您所见，我们的文档已经过转换。<em class="ky">名称</em>字段全部改为小写，添加了两个字段(<em class="ky">状态</em>和<em class="ky">余额</em>)为默认值，删除的字段(<em class="ky">不需要的字段</em>)不再保留。</p><p id="24f2" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们的管道已创建并正常工作，我们可以通过执行以下操作将其添加到索引请求中:</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="51f8" class="lj lk in lf b gy ll lm l ln lo">POST users/_doc?pipeline=my-first-pipeline<br/>{<br/>  "name": "Trevor Noah",<br/>  "unnecessary field": "to remove"<br/>}</span></pre><p id="3b08" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如果您已经有了一个索引，并且想要给它附加一个管道，那么您可以使用<a class="ae jz" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-reindex.html" rel="noopener ugc nofollow" target="_blank"> reindex </a>。例如，让我们创建一个填充了<em class="ky">用户</em>的<em class="ky">账户</em>索引:</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="0c29" class="lj lk in lf b gy ll lm l ln lo">PUT accounts/_bulk<br/>{ "create":{ } }<br/>{"name": "Bill Gates"}<br/>{ "create":{ } }<br/>{"name": "Elon Musk"}<br/>{ "create":{ } }<br/>{"name": "Tony Stark"}</span></pre><p id="e242" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在让我们在索引上使用<em class="ky"> reindex </em>并指定上面创建的管道。</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="4c04" class="lj lk in lf b gy ll lm l ln lo">POST _reindex<br/>{<br/>  "source": {<br/>    "index": "accounts"<br/>  },<br/>  "dest": {<br/>    "index": "new_accounts",<br/>    "op_type": "create",<br/>    "pipeline": "my-first-pipeline"<br/>  }<br/>}</span></pre><p id="e01c" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><em class="ky"> new_accounts </em>索引是用我们转换后的值创建的。您可以通过运行<em class="ky"> GET new_accounts/_search 来检查它。</em></p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="e545" class="lj lk in lf b gy ll lm l ln lo">{<br/> ...<br/> "hits": [<br/>      {<br/>        "_index": "new_accounts",<br/>        "_id": "eVqp8IIBqJSo_EdApqQO",<br/>        "_score": 1,<br/>        "_source": {<br/>          "name": "bill gates",<br/>          "balance": 0,<br/>          "status": true<br/>        }<br/>      },<br/>      {<br/>        "_index": "new_accounts",<br/>        "_id": "elqp8IIBqJSo_EdApqQO",<br/>        "_score": 1,<br/>        "_source": {<br/>          "name": "elon musk",<br/>          "balance": 0,<br/>          "status": true<br/>        }<br/>      },<br/>      {<br/>        "_index": "new_accounts",<br/>        "_id": "e1qp8IIBqJSo_EdApqQO",<br/>        "_score": 1,<br/>        "_source": {<br/>          "name": "tony stark",<br/>          "balance": 0,<br/>          "status": true<br/>        }<br/>      }<br/>    ]<br/> ...<br/>}</span></pre><p id="7828" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在我推荐您阅读的<a class="ae jz" href="https://medium.com/@mhdabdel151/metricbeat-with-local-elasticsearch-and-kibana-c330c902e473" rel="noopener">上一篇文章</a>中，我们看到了如何配置 Metricbeat，我们只需在 Metricbeat 配置文件(<em class="ky"> metricbeat.yml) </em>中提到管道，就可以将管道添加到这个 beat，因此看起来像这样:</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="76aa" class="lj lk in lf b gy ll lm l ln lo">output.elasticsearch:<br/>  hosts: ["localhost:9200"]<br/>  protocol: "https"<br/>  username: "elastic"<br/>  password: "your-password"<br/>  pipeline: my-first-pipeline<br/>  ssl:<br/>    enabled: true<br/>    ca_trusted_fingerprint: "your_fingerprint"</span></pre><p id="1bf4" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">管道有更多的用途，您可以有条件地应用管道，处理管道故障，甚至获得管道使用统计信息。请随意查看关于该主题的官方文档<a class="ae jz" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/ingest.html#ingest" rel="noopener ugc nofollow" target="_blank">以获取更多信息。</a></p><p id="85a9" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">今天到此为止。感谢您的阅读，如果您对本文有任何问题或评论，请在下面留下您的评论。</p><p id="099f" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们下次再见，看更多的帖子🚀。</p><p id="8168" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">阿卜杜尔-巴吉</p></div></div>    
</body>
</html>