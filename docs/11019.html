<html>
<head>
<title>How to Get Stripe Subscription Status Using User Email Address</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用用户电子邮件地址获取条带订阅状态</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/how-to-get-stripe-subscription-status-using-user-email-address-61f1c5e44bd0?source=collection_archive---------9-----------------------#2022-12-13">https://blog.devgenius.io/how-to-get-stripe-subscription-status-using-user-email-address-61f1c5e44bd0?source=collection_archive---------9-----------------------#2022-12-13</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><div class=""/><div class=""><h2 id="e24f" class="pw-subtitle-paragraph jo iq ir bd b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dk translated">Stripe 没有任何直接的方法可以做到这一点，但是有一个方法。</h2></div><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj kg"><img src="../Images/6e2df2029e198b6fdc53fdadefad3f6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1OXlfheJrDhSVt5xFSpRPQ.jpeg"/></div></div><figcaption class="ks kt gk gi gj ku kv bd b be z dk translated">孟山都的照片:<a class="ae kw" href="https://www.pexels.com/photo/surface-of-crumpled-brown-thick-paper-7794422/" rel="noopener ugc nofollow" target="_blank">https://www . pexels . com/photo/surface-of-rugged-brown-thick-paper-7794422/</a></figcaption></figure><p id="4ee7" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">在上一篇文章中，我们讨论了在 ReactJS 应用程序中创建条带订阅。</p><div class="lt lu gq gs lv lw"><a href="https://www.mohammadfaisal.dev/blog/how-to-create-a-stripe-subscription-with-reactjs-and-nodejs" rel="noopener  ugc nofollow" target="_blank"><div class="lx ab fp"><div class="ly ab lz cl cj ma"><h2 class="bd is gz z fq mb fs ft mc fv fx iq bi translated">如何使用 ReactJS 和 NodeJS 创建条带订阅| Mohammad Faisal</h2><div class="md l"><h3 class="bd b gz z fq mb fs ft mc fv fx dk translated">Stripe 是收集客户付款的最受欢迎的方法之一。使用起来很简单，而且…</h3></div><div class="me l"><p class="bd b dl z fq mb fs ft mc fv fx dk translated">www.mohammadfaisal.dev</p></div></div><div class="mf l"><div class="mg l mh mi mj mf mk kq lw"/></div></div></a></div><p id="f3fb" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">使用 stripe 创建订阅后，您会希望使用用户的电子邮件地址来获取他们的订阅状态，对吗？</p><blockquote class="ml"><p id="b700" class="mm mn ir bd mo mp mq mr ms mt mu ls dk translated">不幸的是，Stripe 无法通过电子邮件直接获取用户的订阅状态</p></blockquote><p id="4b88" class="pw-post-body-paragraph kx ky ir kz b la mv js lc ld mw jv lf lg mx li lj lk my lm ln lo mz lq lr ls ik bi translated">原因是有可能使用同一个电子邮件地址创建多个客户，这使得使用该电子邮件地址检查订阅变得很棘手。</p><h1 id="9b75" class="na nb ir bd nc nd ne nf ng nh ni nj nk jx nl jy nm ka nn kb no kd np ke nq nr bi translated">旧解决方案</h1><p id="2b5a" class="pw-post-body-paragraph kx ky ir kz b la ns js lc ld nt jv lf lg nu li lj lk nv lm ln lo nw lq lr ls ik bi translated">这个问题有一些老派的解决方法。我找到最接近的是这里的<a class="ae kw" href="https://stackoverflow.com/questions/70509786/can-i-find-if-a-user-subscription-is-active-or-not-with-their-email-in-stripe" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="d2cb" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">它的作用是。</p><ol class=""><li id="ef0c" class="nx ny ir kz b la lb ld le lg nz lk oa lo ob ls oc od oe of bi translated">列出所有<code class="fe og oh oi oj b">customers</code>。</li><li id="ea4c" class="nx ny ir kz b la ok ld ol lg om lk on lo oo ls oc od oe of bi translated">使用<code class="fe og oh oi oj b">email</code>地址过滤客户</li><li id="7003" class="nx ny ir kz b la ok ld ol lg om lk on lo oo ls oc od oe of bi translated">使用<code class="fe og oh oi oj b">customer</code>参数获取所有订阅。</li><li id="3456" class="nx ny ir kz b la ok ld ol lg om lk on lo oo ls oc od oe of bi translated">过滤<code class="fe og oh oi oj b">subscriptions</code>。</li></ol><p id="5fbd" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">没那么简单，哈？</p><p id="ce2c" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">让我告诉你一个更好的方法。</p><h1 id="1897" class="na nb ir bd nc nd ne nf ng nh ni nj nk jx nl jy nm ka nn kb no kd np ke nq nr bi translated">可能的解决方案</h1><p id="c5a0" class="pw-post-body-paragraph kx ky ir kz b la ns js lc ld nt jv lf lg nu li lj lk nv lm ln lo nw lq lr ls ik bi translated">解决这个问题的一个有趣的方法是利用 stripe 提供的<code class="fe og oh oi oj b">metadata</code>字段。</p><p id="5664" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">您可以在<code class="fe og oh oi oj b">metadata</code>字段中存储任何内容，并在以后进行查询。</p><p id="01b6" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">我们将利用这一点。</p><h1 id="0137" class="na nb ir bd nc nd ne nf ng nh ni nj nk jx nl jy nm ka nn kb no kd np ke nq nr bi translated">怎么办？</h1><p id="3e52" class="pw-post-body-paragraph kx ky ir kz b la ns js lc ld nt jv lf lg nu li lj lk nv lm ln lo nw lq lr ls ik bi translated">为了解决这个问题，我们可以做两件事。</p><ol class=""><li id="6f75" class="nx ny ir kz b la lb ld le lg nz lk oa lo ob ls oc od oe of bi translated">确保每个电子邮件地址只创建一个用户。</li><li id="7e40" class="nx ny ir kz b la ok ld ol lg om lk on lo oo ls oc od oe of bi translated">存储一些元数据</li></ol><p id="d217" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">让我们开始编码吧。</p><h1 id="35c0" class="na nb ir bd nc nd ne nf ng nh ni nj nk jx nl jy nm ka nn kb no kd np ke nq nr bi translated">确保每个电子邮件只创建一个客户。</h1><p id="95ec" class="pw-post-body-paragraph kx ky ir kz b la ns js lc ld nt jv lf lg nu li lj lk nv lm ln lo nw lq lr ls ik bi translated">在创建客户之前，我们可以做以下检查。</p><pre class="kh ki kj kk gu op oj oq bn or os bi"><span id="ef58" class="ot nb ir oj b be ou ov l ow ox">  let customer = await this.stripe.customers.search({<br/>   query: `email:'${createSubscriptionDto.email}'`,<br/>  });<br/><br/>  if (customer.data.length == 0) {<br/>      console.log(' No Custoemr is found. Let us create one!');<br/>      customer = await this.stripe.customers.create({<br/>        name: createSubscriptionDto.name,<br/>        email: createSubscriptionDto.email,<br/>        payment_method: createSubscriptionDto.paymentMethod,<br/>        invoice_settings: {<br/>          default_payment_method: createSubscriptionDto.paymentMethod,<br/>        },<br/>      });<br/>  }</span></pre><h1 id="a655" class="na nb ir bd nc nd ne nf ng nh ni nj nk jx nl jy nm ka nn kb no kd np ke nq nr bi translated">创建订阅并存储元数据</h1><p id="f921" class="pw-post-body-paragraph kx ky ir kz b la ns js lc ld nt jv lf lg nu li lj lk nv lm ln lo nw lq lr ls ik bi translated">下一步，我们需要将客户的电子邮件地址存储在订阅的元数据中。</p><pre class="kh ki kj kk gu op oj oq bn or os bi"><span id="617c" class="ot nb ir oj b be ou ov l ow ox">const subscription = await this.stripe.subscriptions.create({<br/>      customer: customer.id,<br/>      items: [{ price: priceId }],<br/>      payment_settings: {<br/>        payment_method_options: {<br/>          card: {<br/>            request_three_d_secure: 'any',<br/>          },<br/>        },<br/>        payment_method_types: ['card'],<br/>        save_default_payment_method: 'on_subscription',<br/>      },<br/>      expand: ['latest_invoice.payment_intent'],<br/>      metadata: { customerEmail: createSubscriptionDto.email }, // NOTICE HERE!<br/>});</span></pre><p id="d753" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">注意<code class="fe og oh oi oj b">metadata</code>字段。我们将客户的电子邮件存储为<code class="fe og oh oi oj b">customerEmail</code>字段。</p><h1 id="0522" class="na nb ir bd nc nd ne nf ng nh ni nj nk jx nl jy nm ka nn kb no kd np ke nq nr bi translated">最后，获取订阅</h1><p id="1f6c" class="pw-post-body-paragraph kx ky ir kz b la ns js lc ld nt jv lf lg nu li lj lk nv lm ln lo nw lq lr ls ik bi translated">现在有趣的部分来了。让我们使用元数据字段搜索订阅。</p><pre class="kh ki kj kk gu op oj oq bn or os bi"><span id="f5f0" class="ot nb ir oj b be ou ov l ow ox">const subscription = await this.stripe.subscriptions.search({<br/>      query: `status:'active' AND metadata['customerEmail']:'${email}'`,<br/>});</span></pre><p id="9010" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">这个查询应该会为您返回该特定电子邮件地址的有效订阅列表。</p><h1 id="107e" class="na nb ir bd nc nd ne nf ng nh ni nj nk jx nl jy nm ka nn kb no kd np ke nq nr bi translated">最后的话</h1><p id="e76d" class="pw-post-body-paragraph kx ky ir kz b la ns js lc ld nt jv lf lg nu li lj lk nv lm ln lo nw lq lr ls ik bi translated">这不是最干净的解决方案，但它是最好的解决方案之一，因为它很好地解决了这个问题。</p><p id="60e4" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">除非 stripe 给我们提供了更简单的做事方式，否则这就是我们得到的。</p><p id="d01b" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">希望你今天学到了新东西。祝你有美好的一天！</p><p id="766f" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated"><strong class="kz is">可以通过</strong> <a class="ae kw" href="https://www.linkedin.com/in/56faisal/" rel="noopener ugc nofollow" target="_blank"> <strong class="kz is"> LinkedIn </strong> </a> <strong class="kz is">或者我的</strong> <a class="ae kw" href="https://www.mohammadfaisal.dev/" rel="noopener ugc nofollow" target="_blank"> <strong class="kz is">网站</strong> </a>联系我。</p></div></div>    
</body>
</html>