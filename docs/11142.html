<html>
<head>
<title>MLflow for model monitoring</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">模型监控的 MLflow</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/mlflow-for-model-monitoring-cb8b2177b67a?source=collection_archive---------18-----------------------#2022-12-20">https://blog.devgenius.io/mlflow-for-model-monitoring-cb8b2177b67a?source=collection_archive---------18-----------------------#2022-12-20</a></blockquote><div><div class="fc ic id ie if ig"/><div class="ih ii ij ik il"><div class=""/><p id="b4ae" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated"><strong class="jn ip">简介</strong></p><p id="8013" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated"><strong class="jn ip"> MLOps </strong>是数据科学家和运营专业人员之间协作和沟通的一套实践。换句话说，当 Data Scientist 用数据解决问题，回答和理解业务问题时，当模型足够好并准备好投入生产时，就有了一套如何部署和监控它的程序。</p><p id="5ee2" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated">应用这些实践可以提高质量，简化管理流程，并在大规模生产环境中自动部署机器学习和深度学习模型。</p><p id="50f6" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated">因此，在设计阶段完成大量数据工程后，当模型经过测试和验证后，就应该将模型投入生产。应根据新要求开发 CI/CD 管道，并确保质量检查流程，还应监控模型。但是为什么呢？通常情况下，现实中的模型行为与测试数据之间存在一些偏差。有各种各样的原因。与真实情况相比，用于模型训练的数据可能会有一些<em class="kj">无法预见的偏差</em>。还有就是<em class="kj">数据漂移</em>的情况。一段时间后，由于现实中可能发生的变化和熵过程，模型开始恶化，预测精度下降。因此，对模型的监控至关重要。</p><p id="7b73" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated">MLflow 是用于模型监控、模型生命周期的开源平台，包括实验、可复制、部署和注册。下面我们就来说说。</p><p id="27a0" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated"><strong class="jn ip">核心</strong></p><p id="8e19" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated">当 data scientist 完成模型训练阶段并且模型以 pickle 格式保存时，它可以通过 MLFlow 上传，投入生产和监控。假设我们的应用程序收到了一些新的数据请求:</p><pre class="kk kl km kn gu ko kp kq bn kr ks bi"><span id="0766" class="kt ku io kp b be kv kw l kx ky">import mlflow<br/>logged_model = 'runs:/8996b5cec1324f00a1b721a3d5b51c59/model'<br/><br/># Load model as a PyFuncModel.<br/>loaded_model = mlflow.pyfunc.load_model(logged_model)<br/><br/># Predict on a Pandas DataFrame.<br/>import pandas as pd<br/>loaded_model.predict(pd.DataFrame(data))</span></pre><p id="d254" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated">如果我们希望将特定指标作为日志，那么我们必须使用 mlflow.log 函数来指定它们:</p><pre class="kk kl km kn gu ko kp kq bn kr ks bi"><span id="b30e" class="kt ku io kp b be kv kw l kx ky">with mlflow.start_run():<br/>        <br/>        lr = ElasticNet(alpha=alpha, l1_ratio=l1_ratio, random_state=42)<br/>        lr.fit(train_x, train_y)<br/><br/>        predicted_qualities = lr.predict(test_x)<br/><br/>        (rmse, mae, r2) = eval_metrics(test_y, predicted_qualities)<br/><br/>        print("Elasticnet model (alpha=%f, l1_ratio=%f):" % (alpha, l1_ratio))<br/>        print("  RMSE: %s" % rmse)<br/>        print("  MAE: %s" % mae)<br/>        print("  R2: %s" % r2)<br/><br/>        mlflow.log_param("alpha", alpha)<br/>        mlflow.log_param("l1_ratio", l1_ratio)<br/>        mlflow.log_metric("rmse", rmse)<br/>        mlflow.log_metric("r2", r2)<br/>        mlflow.log_metric("mae", mae)<br/><br/>        tracking_url_type_store = urlparse(mlflow.get_tracking_uri()).scheme<br/><br/>        # Model registry does not work with file store<br/>        if tracking_url_type_store != "file":<br/><br/>            # Register the model<br/>            # There are other ways to use the Model Registry, which depends on the use case,<br/>            # please refer to the doc for more information:<br/>            # https://mlflow.org/docs/latest/model-registry.html#api-workflow<br/>            mlflow.sklearn.log_model(lr, "model", registered_model_name="ElasticnetWineModel")<br/>        else:<br/>            mlflow.sklearn.log_model(lr, "model")</span></pre><p id="a89e" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated">让我们深入研究一下代码。首先，我们对预测运行模型，并将它们保存为<em class="kj">预测质量</em>。然后我们收集评价指标，均方根误差，平均绝对误差和决定系数(R2)。然后，我们通过其<em class="kj"> log_param </em>和<em class="kj"> log_metric </em>函数为 MLflow 跟踪分配特定的超参数和度量。</p><p id="aac8" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated">代码的另一部分是处理模型到 MLFlow 注册表的注册。然后你可以通过浏览器的 API 来监控所有的模型。这应该是这样的:</p><figure class="kk kl km kn gu la gi gj paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="gi gj kz"><img src="../Images/c432cc436aa9ca4639a1b24ef977ad0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5Ji30hY-VbJRgHKgU9CUJw.png"/></div></div><figcaption class="lh li gk gi gj lj lk bd b be z dk translated">MLflow API</figcaption></figure><p id="c5b3" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated">每次新运行时，模型的新版本都会按照上图中的分配进行保存和记录。</p><p id="1e0a" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated">需要以 pickle 格式发布模型，requirement.txt 用于环境，可选工件用于在 MLflow 平台中运行的模型。您可以在注册表中存储几个模型，并并行监视它们。在这里你可以看到。</p><p id="2138" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated"><strong class="jn ip">结论</strong></p><p id="abd6" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated">如果你已经非常熟悉 ML 模型训练的步骤，MLflow 很容易学习。它兼容多种云平台，包括 Spark、GCP、Azure。缺点是，当我们希望我们的平台上有不同的用户组时，很难处理认证需求。</p><p id="d11c" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated">希望这是有用的文章。享受吧。</p></div></div>    
</body>
</html>