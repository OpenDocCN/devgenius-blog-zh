<html>
<head>
<title>A hook for data fetching in React</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">React中用于数据获取的钩子</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/a-hook-for-data-fetching-in-react-7a3f6bedd20?source=collection_archive---------42-----------------------#2020-07-13">https://blog.devgenius.io/a-hook-for-data-fetching-in-react-7a3f6bedd20?source=collection_archive---------42-----------------------#2020-07-13</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><figure class="im in gp gr io ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi il"><img src="../Images/0b1524644588c08d2c5022a6ebcb93e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Cp5-3paMcULKRt_Eb6AFEw.png"/></div></div></figure><div class=""/><h1 id="57d6" class="jv jw iy bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">介绍</h1><p id="f772" class="pw-post-body-paragraph kt ku iy kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">在这篇文章中，我将介绍为React中的数据获取创建一个<a class="ae lr" href="https://reactjs.org/docs/hooks-custom.html" rel="noopener ugc nofollow" target="_blank">自定义钩子</a>的过程。</p><p id="b34e" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">我希望你熟悉React和hook API，特别是<a class="ae lr" href="https://reactjs.org/docs/hooks-state.html" rel="noopener ugc nofollow" target="_blank"> useState </a>、<a class="ae lr" href="https://reactjs.org/docs/hooks-effect.html" rel="noopener ugc nofollow" target="_blank"> useEffect </a>和<a class="ae lr" href="https://reactjs.org/docs/hooks-reference.html#usereducer" rel="noopener ugc nofollow" target="_blank"> useReducer </a>。</p><p id="84d4" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">如果没有，你必须先检查<a class="ae lr" href="https://reactjs.org/docs/hooks-intro.html" rel="noopener ugc nofollow" target="_blank">文件</a>。</p><p id="4f4e" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">此外，我们将构建的挂钩是一种锻炼和获取灵感的手段，而不是针对您在现实项目中可能遇到的特定问题的改编版本。</p></div><div class="ab cl lx ly hr lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ig ih ii ij ik"><h1 id="33d3" class="jv jw iy bd jx jy me ka kb kc mf ke kf kg mg ki kj kk mh km kn ko mi kq kr ks bi translated">构建自定义挂钩</h1><p id="d37f" class="pw-post-body-paragraph kt ku iy kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">我们将构建的钩子解决了我们在web应用程序中经常要做的一项任务:获取数据。</p><p id="167c" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">在这个例子中，我们将从PokéAPI获取数据，并在屏幕上呈现一些关于特定口袋妖怪的信息。</p><p id="36be" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">在本教程结束时，我们将会看到如下内容:</p><p id="3d9b" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">让我们快速设置我们的应用程序和它将呈现的JSX。</p><p id="4805" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">别太在意，那不是有趣的部分。我把它放在这里只是为了给出上下文:</p><figure class="mj mk ml mm gt ip"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="0c49" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">来自用户的数据的入口点是输入。</p><p id="01d8" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">它将收到一个口袋妖怪名称，这将是我们要请求的PokeAPI url的端点。</p><p id="29f2" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">正如您可能已经看到的，输入的形式有一个我称为<code class="fe mp mq mr ms b">handleSubmit</code>的<code class="fe mp mq mr ms b">onSubmit</code>处理程序。</p><p id="c6b8" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">为了在<code class="fe mp mq mr ms b">handleSubmit</code>中获得输入值，我使用了一个名为<code class="fe mp mq mr ms b">ref</code>的React特性。</p><p id="4922" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">它允许我保存一个输入的引用，而不需要用经典的<code class="fe mp mq mr ms b">document.querySelector(selector)</code>访问DOM</p><p id="d858" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">因为这是一个副作用，我需要把它放到一个<code class="fe mp mq mr ms b">useEffect</code>钩子中。</p><p id="a60d" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">(点击了解更多<code class="fe mp mq mr ms b">refs</code>T19】。)</p><p id="e1d9" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">让我们添加代码:</p><figure class="mj mk ml mm gt ip"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="d499" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">在这里，我用<code class="fe mp mq mr ms b">useState</code>将<code class="fe mp mq mr ms b">endPoint</code>定义为一个状态变量。</p><p id="780d" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">然后，当用户提交表单时，也就是当他单击按钮“Search”时，我们用输入值更新它。</p><p id="0749" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">好的。既然已经建立了与用户的交互，我们就必须从API中获取我们想要的数据。</p><p id="635b" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">因为这个任务是异步的，因此可能需要时间，我们必须在一个<code class="fe mp mq mr ms b">useEffect</code>钩子中完成它，以便让浏览器在数据还不存在的情况下进行绘制。</p><p id="b99d" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">让我们使用<a class="ae lr" href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API" rel="noopener ugc nofollow" target="_blank">获取API </a>来完成:</p><figure class="mj mk ml mm gt ip"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="660a" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">我引入了一个名为<code class="fe mp mq mr ms b">data</code>的新状态变量来存储我们从API收到的内容，并在应用程序呈现的JSX中使用它。</p><p id="c04c" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">但是我们忽略了一些东西。</p><p id="e335" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">当数据不存在时，我们向用户显示什么？</p><p id="772a" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">如果请求失败会发生什么？</p><p id="d88d" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">将会抛出一个错误，用户对此没有任何反馈。</p><p id="0fde" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">因此，我们需要捕捉错误，并将其放入状态变量中，以便调整我们给用户的响应。</p><p id="0bd9" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">此外，我们将使用一个状态变量来跟踪加载状态:</p><figure class="mj mk ml mm gt ip"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="19c0" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">到目前为止，我们做得很好！</p><p id="944f" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">但是仍然有一个bug可能发生。你看到了吗？</p><p id="9774" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">这个不好找。</p><p id="0135" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">假设组件在数据到达之前被卸载或重新呈现。</p><p id="beb1" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">在浏览器控制台中，您会看到类似这样的内容:</p><p id="ea16" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">但是我们怎么做呢？</p><p id="4ded" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">嗯，<code class="fe mp mq mr ms b">useEffect</code>回调可以返回一个在组件卸载后调用的函数。在重新渲染的情况下，该函数在下一次渲染之后，但在新的<code class="fe mp mq mr ms b">useEffect</code>版本运行之前被调用。</p><p id="077c" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">因此，我们可以使用一个标志(<code class="fe mp mq mr ms b">didCancel</code>)，我们将通过调用返回的函数来反转它，当调用<code class="fe mp mq mr ms b">useEffect</code>时，它将通知我们组件是否已被卸载或重新呈现:</p><figure class="mj mk ml mm gt ip"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="76b0" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">最后，我们可以通过将<code class="fe mp mq mr ms b">err</code>和<code class="fe mp mq mr ms b">isLoading</code>状态合并到一个对象中来做最后一点改进，我们将用一个缩减器来更新这个对象。</p><p id="2c71" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">但是为什么会是一种进步呢？</p><p id="a6f7" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">在你发现自己同时写了多个<code class="fe mp mq mr ms b">setSomething</code>的情况下，这可能是这些状态相关的迹象。因此，对它们进行分组是有意义的，这样可以降低复杂性。</p><p id="925e" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">所以让我们用<code class="fe mp mq mr ms b">useReducer</code>来实现它:</p><figure class="mj mk ml mm gt ip"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="7f4f" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">在上面的代码片段中，我添加了一个名为<code class="fe mp mq mr ms b">fetchReducer</code>的缩减器和一个<code class="fe mp mq mr ms b">initialState</code>。</p><p id="8d52" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">我把它们放在App组件之外，因为它们不依赖于任何道具或状态，所以每次组件重新呈现时都没有必要重新计算它们。</p><p id="366d" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">现在，我们不再调用<code class="fe mp mq mr ms b">setErr</code>和<code class="fe mp mq mr ms b">setIsLoading</code>，而是分派一个具有特定类型属性的action对象和一个可选的有效负载，该有效负载包含可能与更新状态相关的信息。</p><p id="3c61" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">花时间阅读代码，以便理解发生了什么。</p><p id="f941" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">酷，我们完成了！</p><blockquote class="mt mu mv"><p id="697d" class="kt ku mw kv b kw ls ky kz la lt lc ld mx lu lg lh my lv lk ll mz lw lo lp lq ig bi translated"><em class="iy">什么？但是定制的钩子在哪里呢？我没有看到任何</em> <code class="fe mp mq mr ms b"><em class="iy">useFetch</em></code> <em class="iy">的东西...</em></p></blockquote><p id="4e2a" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">呵呵😏，我开玩笑的…</p><p id="794c" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">最后一步相当简单。我们有了所有的状态逻辑，所以现在，我们只需要把它放入它自己的函数中，这将是我们的自定义钩子。</p><p id="798d" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">以下是完整的代码:</p><figure class="mj mk ml mm gt ip"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="d713" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">现在我们完成了！😄</p><p id="e4c5" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">点击查看最终版本运行<a class="ae lr" href="https://codesandbox.io/s/usefetch-11sps" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="6d43" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">对于那些喜欢打字的人，我已经做了一个<a class="ae lr" href="https://codesandbox.io/s/usefetch-with-typescript-14llq" rel="noopener ugc nofollow" target="_blank">打字版本</a>。但是我鼓励你自己去练习。</p></div><div class="ab cl lx ly hr lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ig ih ii ij ik"><h1 id="79bc" class="jv jw iy bd jx jy me ka kb kc mf ke kf kg mg ki kj kk mh km kn ko mi kq kr ks bi translated">结论</h1><p id="727b" class="pw-post-body-paragraph kt ku iy kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">正如我在介绍中所说的，您可能需要调整该钩子的API，以适应您的特定用例和您的偏好。</p><p id="0553" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">无论如何，我希望它能让你了解你认为可以用定制钩子做的事情。</p><p id="6cc8" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">作为一个自定义钩子的中级用户，我总是被它们所赋予的巨大力量所淹没。</p><p id="0dc5" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">当然，它们提供了一个吸引人的抽象领域，但最终，我认为人们必须努力找到针对特定问题的最佳和最简单的解决方案，而不是强制使用定制挂钩。</p><p id="1a7c" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">我的意思是，如果有状态逻辑块没有那么大或复杂，并且只在一两个组件中使用，就不要费心为它创建一个定制的钩子。</p><p id="83b8" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">就我个人而言，我对它们感到非常兴奋，以至于我会直接尝试去想一个定制的钩子来解决我的问题。</p><p id="b793" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">但是我改变了我的方法，一步一步地做事情，首先使用内置的钩子，然后如果需要的话提取一个有状态逻辑块，就像我们在这篇文章中做的那样。</p><p id="ca3b" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">就是这样！我渴望阅读您的评论，并看到您可能已经建立了自己的调整版本！</p><h1 id="c1d3" class="jv jw iy bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">灵感和更多资源</h1><p id="ab13" class="pw-post-body-paragraph kt ku iy kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">这篇文章的灵感来自Robin Wieruch的这篇文章。</p><p id="d3d7" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">如果你想更深入地了解React，我强烈推荐他的博客和React团队的核心开发者Dan Abramov的博客。</p><p id="aadc" class="pw-post-body-paragraph kt ku iy kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">无论如何，我相信事实的唯一来源是文档(除非它很烂…)，它一定会问你是否应该使用相关的工具。不过不用担心，React doc真的很棒。生态系统真的很成熟，你会毫无问题的找到你需要的东西。).所以检查<a class="ae lr" href="https://reactjs.org/" rel="noopener ugc nofollow" target="_blank">它</a>出来。</p></div></div>    
</body>
</html>