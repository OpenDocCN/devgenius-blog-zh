<html>
<head>
<title>How To Use CORS in NestJS Application</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在 NestJS 应用程序中使用 CORS</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/how-to-use-cors-in-nestjs-application-1e18fddf7303?source=collection_archive---------8-----------------------#2022-03-07">https://blog.devgenius.io/how-to-use-cors-in-nestjs-application-1e18fddf7303?source=collection_archive---------8-----------------------#2022-03-07</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="dd69" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在这篇文章中，我们将讨论如何在一个<a class="ae ki" href="https://docs.nestjs.com/" rel="noopener ugc nofollow" target="_blank"> NestJS </a>应用程序中使用 CORS(跨源资源共享)。在展示启用 CORS 有多容易之前，我们将在本帖中介绍一些基础知识。</p><ul class=""><li id="6d4a" class="kj kk in jm b jn jo jr js jv kl jz km kd kn kh ko kp kq kr bi translated">什么是 CORS？</li><li id="e2d6" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated">什么是 NestJS 框架？</li><li id="614b" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated">如何使用 CORS？</li></ul><h1 id="ff74" class="kx ky in bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">什么是 CORS？</h1><p id="409f" class="pw-post-body-paragraph jk jl in jm b jn lv jp jq jr lw jt ju jv lx jx jy jz ly kb kc kd lz kf kg kh ig bi translated">在一个常见的基于 REST API 的应用程序中，有一个客户端调用由服务器提供的 API。当访问这些 API 时，客户端可以请求不同的资源，这包括图像、视频、iframes 或脚本。与资源的域相比，请求资源的网站可以在不同的域中。默认情况下，获取资源的请求可能会失败。这就是 CORS 出现的原因。</p><p id="4672" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如前所述，CORS 主张跨原产地资源共享。默认情况下，CORS 使从客户端到服务器的呼叫更加安全。在许多情况下，我们知道客户是谁，以及它将位于哪个域。在这种情况下，我们希望放松调用 API 的客户端的安全性。我们通过客户端发送请求头<code class="fe ma mb mc md b">Access-Control-Allow-Origin</code>来做到这一点。这些头指示哪些源可以访问 API。</p><p id="2d24" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><em class="me"> CORS 是一种基于 HTTP 报头的机制，它允许服务器指示除其自身之外的任何来源(域、方案或端口),浏览器应该允许从这些来源加载资源。—</em><a class="ae ki" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS" rel="noopener ugc nofollow" target="_blank"><em class="me">Mozilla Firefox</em></a></p><p id="0795" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让我们看看下面的图表</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div class="gh gi mf"><img src="../Images/ecfd2c89c71d3389fcb858a2cb1eea29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1250/0*ZlhCbwnEbEXYPV8S"/></div></figure><p id="f2aa" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">来自<code class="fe ma mb mc md b">abccompany.com</code>的客户端向<code class="fe ma mb mc md b">s3.amazon.com</code>发送请求，以访问来自<a class="ae ki" href="https://aws.amazon.com/s3/" rel="noopener ugc nofollow" target="_blank"> S3 </a>的资源。在这种情况下，客户端和服务器有不同的来源。通常，这个请求会因为跨源而失败。这是浏览器的安全问题。与来自的请求相比，CORS 允许从不同来源的服务器访问资源。CORS 将在请求中添加<code class="fe ma mb mc md b">Access-Control-Allow-Origin</code>报头。</p><h1 id="2dc3" class="kx ky in bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">什么是 NestJS 框架？</h1><p id="c1ee" class="pw-post-body-paragraph jk jl in jm b jn lv jp jq jr lw jt ju jv lx jx jy jz ly kb kc kd lz kf kg kh ig bi translated">NestJS 是一个构建可伸缩 NodeJS 服务器端应用程序的框架。在后台，NestJS 使用像 Express 这样的 HTTP 服务器框架。</p><p id="3dea" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">为了开始，</p><p id="57f1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><code class="fe ma mb mc md b">npm i -g @nestjs/cli</code> <em class="me"> Nest 提供了一个开箱即用的应用架构，允许开发者和团队创建高度可测试、可伸缩、松散耦合、易于维护的应用-</em><a class="ae ki" href="https://docs.nestjs.com/" rel="noopener ugc nofollow" target="_blank"><em class="me">NestJS</em></a></p><p id="fe03" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">用 Nest 创建一个新项目</p><p id="451d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><code class="fe ma mb mc md b">nest new project-name</code>。</p><h1 id="9bfb" class="kx ky in bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">如何使用 CORS？</h1><p id="455c" class="pw-post-body-paragraph jk jl in jm b jn lv jp jq jr lw jt ju jv lx jx jy jz ly kb kc kd lz kf kg kh ig bi translated">为了展示如何使用 CORS，我们将创建一个 nestjs 应用程序。</p><p id="c339" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><code class="fe ma mb mc md b">nest new corsdemoapp</code> -将为<code class="fe ma mb mc md b">corsdemoapp</code>创建一个新文件夹。</p><p id="d21f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在，如果我运行<code class="fe ma mb mc md b">npm start</code>，它将在<code class="fe ma mb mc md b"><a class="ae ki" href="http://localhost:3000." rel="noopener ugc nofollow" target="_blank">http://localhost:3000</a></code> <a class="ae ki" href="http://localhost:3000." rel="noopener ugc nofollow" target="_blank">启动我们默认的 nestjs 应用程序。</a></p><p id="1fea" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">NestJs 通过提供一个方法<code class="fe ma mb mc md b">enableCors()</code>使这变得更加容易。这将如下所示:</p><pre class="mg mh mi mj gt mn md mo mp aw mq bi"><span id="122d" class="mr ky in md b gy ms mt l mu mv">async function bootstrap() { const app = await NestFactory.create(AppModule); app.enableCors(); await app.listen(3000); } bootstrap();</span></pre><p id="64f6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">还有另一种方法来启用 CORS。通过在<code class="fe ma mb mc md b">NestFactory.create()</code>方法中将 cors 作为对象传递。</p><pre class="mg mh mi mj gt mn md mo mp aw mq bi"><span id="7a2d" class="mr ky in md b gy ms mt l mu mv">async function bootstrap() {<br/>  const app = await NestFactory.create(AppModule);<br/>  app.enableCors();<br/>  await app.listen(3000);<br/>}<br/>bootstrap();</span></pre><p id="3fda" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果我们想查看对<code class="fe ma mb mc md b">http://localhost:3000</code>的请求的响应头，它们将如下所示:</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div class="gh gi mf"><img src="../Images/bfd72550fff20eb5e02920ea037b9d9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1250/0*cTTPKuzblzEZTFrm"/></div></figure><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div class="gh gi mf"><img src="../Images/e697a9eb17c509bed620577e496a6c20.png" data-original-src="https://miro.medium.com/v2/resize:fit:1250/0*AiqGmKM_Z8NaCpcf"/></div></figure><p id="bd3f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">第二个截图显示了带有值<code class="fe ma mb mc md b">*</code>的标题<code class="fe ma mb mc md b">Access-Control-Allow-Origin</code>。这意味着来自任何来源的请求都可以访问服务器以获得来自<code class="fe ma mb mc md b"><a class="ae ki" href="http://localhost:3000." rel="noopener ugc nofollow" target="_blank">http://localhost:3000</a></code> <a class="ae ki" href="http://localhost:3000." rel="noopener ugc nofollow" target="_blank">的响应。</a></p><h1 id="2c1b" class="kx ky in bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">我们还能为 CORS 增加哪些选择？</h1><p id="87c1" class="pw-post-body-paragraph jk jl in jm b jn lv jp jq jr lw jt ju jv lx jx jy jz ly kb kc kd lz kf kg kh ig bi translated">在通过<code class="fe ma mb mc md b">enableCors()</code>启用时，我们可以用 CORS 设置一些其他选项。如果我们知道还有哪些域将访问我们的 API，我们就可以设置那个域。有时，API 可以是公共的。在这种情况下，我们可以使用通配符<code class="fe ma mb mc md b">*</code>作为<code class="fe ma mb mc md b">Access-Control-Allow-Origin</code>。</p><pre class="mg mh mi mj gt mn md mo mp aw mq bi"><span id="3c33" class="mr ky in md b gy ms mt l mu mv">app.enableCors(<br/>    { <br/>      origin: ['https://betterjavacode.com', 'https://www.google.com'],<br/>    }<br/>  );</span></pre><p id="ccc2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">此外，我们只能允许 API 调用一组方法。</p><pre class="mg mh mi mj gt mn md mo mp aw mq bi"><span id="7b47" class="mr ky in md b gy ms mt l mu mv">app.enableCors(<br/>    { <br/>      origin: ['https://betterjavacode.com', 'https://www.google.com'],<br/>      methods: ['POST', 'PUT', 'DELETE', 'GET']<br/>    }<br/>  );</span></pre><p id="14aa" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">CORS 最常见的用例是在后端构建 RESTful APIS 并通过前端调用它们。</p><h1 id="926f" class="kx ky in bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">结论</h1><p id="7305" class="pw-post-body-paragraph jk jl in jm b jn lv jp jq jr lw jt ju jv lx jx jy jz ly kb kc kd lz kf kg kh ig bi translated">当在服务器上构建和部署应用程序时，知道谁在调用您的 API 是很重要的。CORS 提供了一个安全特性。接受来自每个域的请求会带来安全风险。NestJS 提供了一种简单的方法来启用 CORS 和选项，以添加服务器可以接受请求的域。CORS 允许我们避免跨站点请求伪造攻击(CSRF)。我在我的书<a class="ae ki" href="https://betterjavacode.com/programming/simplifying-spring-security" rel="noopener ugc nofollow" target="_blank">简化 Spring 安全</a>中介绍了一些常见的漏洞。</p></div><div class="ab cl mw mx hr my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="ig ih ii ij ik"><p id="4308" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><em class="me">原载于 2022 年 3 月 7 日 https://betterjavacode.com</em><em class="me">的</em> <a class="ae ki" href="https://betterjavacode.com/programming/how-to-use-cors-in-nestjs-application" rel="noopener ugc nofollow" target="_blank"> <em class="me">。</em></a></p></div></div>    
</body>
</html>