<html>
<head>
<title>Spring Boot Application With Multiple Data sources</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">具有多个数据源的Spring Boot应用程序</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/spring-boot-application-with-multiple-data-sources-9ccfbd6a0085?source=collection_archive---------2-----------------------#2022-01-06">https://blog.devgenius.io/spring-boot-application-with-multiple-data-sources-9ccfbd6a0085?source=collection_archive---------2-----------------------#2022-01-06</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="0016" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">要使spring boot应用程序能够与多个数据库通信，您需要定义一些配置，让spring在执行每个源代码时启动。</p><p id="db95" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让我们首先同意，你的/ <strong class="jm io">模型</strong>和/ <strong class="jm io">储存库</strong>和/ <strong class="jm io">控制器</strong>已经像你一直做的那样被定义了。</p><p id="d4ad" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在让我们浏览一下<strong class="jm io"> application.properties </strong>文件</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/2a73e96695c2681966259c840de214f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*11y4NOW9bBI5VUR8-jlr5A.png"/></div></div></figure><p id="4b51" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如您所见，我已经为两个数据库设置了配置。第一个是给<strong class="jm io">歌</strong>的，第二个是给<strong class="jm io">歌词</strong>的。请注意，以<strong class="jm io"> (spring.datasource.*) </strong>为前缀的歌曲配置和以<strong class="jm io">(spring . Lyrics . data source . *)</strong>为前缀的歌词配置，使歌曲以(spring.song.datasource)为前缀将会由于未提供(spring.datasource.*)而导致错误，因此至少有一个数据库应该像默认数据库一样工作。</p></div><div class="ab cl ku kv hr kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="ig ih ii ij ik"><p id="93b8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">您应该像这样组织您的模型和存储库目录；以便让配置代码知道将数据源应用到哪个模型和repo。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi lb"><img src="../Images/a76f985a033db6faa0a5089c4c777043.png" data-original-src="https://miro.medium.com/v2/resize:fit:716/format:webp/1*K4Vn4iiI7rkT0GTf5O1CSg.png"/></div></figure></div><div class="ab cl ku kv hr kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="ig ih ii ij ik"><p id="db12" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在我们已经组织好了目录，并在application.properties中提交了数据库配置，剩下的是数据源的spring boot配置代码。</p><p id="3f74" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">首先，创建一个目录/ <strong class="jm io"> config </strong>，并为每个数据源创建两个java文件。我的将是<strong class="jm io">SongDBConfig.java</strong>和<strong class="jm io">LyricsDBConfig.java</strong></p><p id="2ab4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让我们从SongDBConfig.java开始</p><pre class="kj kk kl km gt lc ld le lf aw lg bi"><span id="0727" class="lh li in ld b gy lj lk l ll lm">@Primary<br/>@Bean(name="songProps")<br/>@ConfigurationProperties("spring.datasource")<br/>public DataSourceProperties dataSourceProperties() {<br/>    return new DataSourceProperties();<br/>}<br/><br/>@Primary<br/>@Bean(name="datasource")<br/>@ConfigurationProperties(prefix = "spring.datasource")<br/>public DataSource datasource(@Qualifier("songProps") DataSourceProperties properties){<br/>    return properties.initializeDataSourceBuilder().build();<br/>}<br/><br/>@Primary<br/>@Bean(name="entityManagerFactory")<br/>public LocalContainerEntityManagerFactoryBean entityManagerFactoryBean<br/>        (EntityManagerFactoryBuilder builder,<br/>         @Qualifier("datasource") DataSource dataSource){<br/>    return builder.dataSource(dataSource)<br/>            .packages("com.example.multipledb.models.song")<br/>            .persistenceUnit("Song").build();<br/>}<br/><br/>@Primary<br/>@Bean(name = "transactionManager")<br/>@ConfigurationProperties("spring.jpa")<br/>public PlatformTransactionManager transactionManager(<br/>        @Qualifier("entityManagerFactory") EntityManagerFactory entityManagerFactory) {<br/>    return new JpaTransactionManager(entityManagerFactory);<br/>}</span></pre><p id="6695" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">因为Song db是我们的<strong class="jm io">默认</strong>数据源，所以必须包含“<strong class="jm io"> Primary </strong>”注释，该注释定义了这个bean将被注册多次，但是我希望这个版本是主版本。所以，在LyricsDBConfig.java的另一类豆子中<strong class="jm io">不会</strong>有“初级”的注解。</p><p id="8c03" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">对于“ConfigurationProperties”注释，我们使用它来让spring boot知道应该使用application.properties中的哪个配置。</p><p id="0745" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让我们不要忘记用这些注释来注释我们的类</p><pre class="kj kk kl km gt lc ld le lf aw lg bi"><span id="5693" class="lh li in ld b gy lj lk l ll lm">@Configuration<br/>@EnableTransactionManagement<br/>@EnableJpaRepositories(<br/>        entityManagerFactoryRef = "entityManagerFactory",<br/>        transactionManagerRef = "transactionManager",<br/>        basePackages = { "com.example.multipledb.repositories.song" })<br/>public class SongDBConfig {<br/><br/>    @Primary<br/>    @Bean(name="songProps")<br/>    @ConfigurationProperties("spring.datasource")<br/>    public DataSourceProperties dataSourceProperties() {<br/>        return new DataSourceProperties();<br/>    }<br/><br/>    @Primary<br/>    @Bean(name="datasource")<br/>    @ConfigurationProperties(prefix = "spring.datasource")<br/>    public DataSource datasource(@Qualifier("songProps") DataSourceProperties properties){<br/>        return properties.initializeDataSourceBuilder().build();<br/>    }<br/><br/>    @Primary<br/>    @Bean(name="entityManagerFactory")<br/>    public LocalContainerEntityManagerFactoryBean entityManagerFactoryBean<br/>            (EntityManagerFactoryBuilder builder,<br/>             @Qualifier("datasource") DataSource dataSource){<br/>        return builder.dataSource(dataSource)<br/>                .packages("com.example.multipledb.models.song")<br/>                .persistenceUnit("Song").build();<br/>    }<br/><br/>    @Primary<br/>    @Bean(name = "transactionManager")<br/>    @ConfigurationProperties("spring.jpa")<br/>    public PlatformTransactionManager transactionManager(<br/>            @Qualifier("entityManagerFactory") EntityManagerFactory entityManagerFactory) {<br/>        return new JpaTransactionManager(entityManagerFactory);<br/>    }<br/>}</span></pre><p id="b51f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">对于LyricsDBConfig.java，它将与SongDBConfig.java相同，但我们将在entityManagerFactory和transactionManager前面加上“<strong class="jm io">歌词</strong>”前缀，因为它们已经被SongDBConfig.java占用</p><pre class="kj kk kl km gt lc ld le lf aw lg bi"><span id="51e0" class="lh li in ld b gy lj lk l ll lm">@Configuration<br/>@EnableTransactionManagement<br/>@EnableJpaRepositories(<br/>        entityManagerFactoryRef = "lyricsEntityManagerFactory",<br/>        transactionManagerRef = "lyricsTransactionManager",<br/>        basePackages = { "com.example.multipledb.repositories.lyrics" })<br/>public class LyricsDBConfig {<br/><br/>    @Bean(name="lyricsProps")<br/>    @ConfigurationProperties("spring.lyrics.datasource")<br/>    public DataSourceProperties dataSourceProperties() {<br/>        return new DataSourceProperties();<br/>    }<br/><br/><br/>    @Bean(name="lyricsDatasource")<br/>    @ConfigurationProperties(prefix = "spring.lyrics.datasource")<br/>    public DataSource datasource(@Qualifier("lyricsProps") DataSourceProperties properties){<br/>        return properties.initializeDataSourceBuilder().build();<br/>    }<br/><br/><br/>    @Bean(name="lyricsEntityManagerFactory")<br/>    public LocalContainerEntityManagerFactoryBean entityManagerFactoryBean<br/>            (EntityManagerFactoryBuilder builder,<br/>             @Qualifier("lyricsDatasource") DataSource dataSource){<br/>        return builder.dataSource(dataSource)<br/>                .packages("com.example.multipledb.models.lyrics")<br/>                .persistenceUnit("Lyrics").build();<br/>    }<br/><br/><br/>    @Bean(name = "lyricsTransactionManager")<br/>    @ConfigurationProperties("spring.jpa")<br/>    public PlatformTransactionManager transactionManager(<br/>            @Qualifier("lyricsEntityManagerFactory") EntityManagerFactory entityManagerFactory) {<br/>        return new JpaTransactionManager(entityManagerFactory);<br/>    }<br/>}</span></pre></div><div class="ab cl ku kv hr kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="ig ih ii ij ik"><p id="3418" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在，控制器将调用每个回购协议，并依次传达选定的数据库。</p><pre class="kj kk kl km gt lc ld le lf aw lg bi"><span id="fe0f" class="lh li in ld b gy lj lk l ll lm">@RestController<br/>public class Controller {<br/>    @Autowired<br/>    LyricsRepo lyricsRepo;<br/>    @Autowired<br/>    SongRepo songRepo;<br/><br/>    @PostMapping<br/>    public ResponseEntity add(@RequestBody request body){<br/>        SongModel songModel = new SongModel();<br/>        LyricsModel lyricsModel = new LyricsModel();<br/>        songModel.setName(body.getSong());<br/>        lyricsModel.setContent(body.getContent());<br/><br/>//        will insert in Song DB<br/>        songRepo.save(songModel);<br/>//        will insert in Lyrics DB<br/>        lyricsRepo.save(lyricsModel);<br/><br/>        return ResponseEntity.<em class="ln">ok</em>(body);<br/>    }<br/>}</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lo"><img src="../Images/753e5f247755c2517b6190cfe5500275.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YF5CO0nluIyTc_yWXK0rkQ.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi lp"><img src="../Images/26e3c3b94a8c36c6aedb79007b15c8b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:888/format:webp/1*49hPMcRju_yygePIa_2i0w.png"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lq"><img src="../Images/79ac79c8d044c5c697fa0bbbb2f3c768.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Gj51qgAXP-jRr9zRvCkGyQ.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lr"><img src="../Images/5fbd46b049649010588765b3a92bd744.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VCLb5gIoS5Icshe4nk4oVA.png"/></div></div></figure><p id="4551" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">源代码:<a class="ae ls" href="https://gitlab.com/lamoboos223/spring-boot-multiple-datasource-song-project" rel="noopener ugc nofollow" target="_blank">https://git lab . com/lamo boos 223/spring-boot-multiple-data source-song-project</a></p></div></div>    
</body>
</html>