<html>
<head>
<title>Tooling Go Microservices With Consul Service Discovery and KV Store</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">工具使用咨询服务发现和 KV 存储进行微服务</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/tooling-go-microservices-with-consul-service-discovery-and-kv-store-2c52bcdf4fd4?source=collection_archive---------4-----------------------#2022-10-08">https://blog.devgenius.io/tooling-go-microservices-with-consul-service-discovery-and-kv-store-2c52bcdf4fd4?source=collection_archive---------4-----------------------#2022-10-08</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="5130" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">Consul 的核心是一个服务网络解决方案。它提供了服务网格解决方案、网络配置自动化、服务发现、简单的键值存储等。在本文中，我们将关注服务配置的键值存储(KV store ),以及 consul 的核心特性之一，服务发现。总之，我们正在用 Consul 覆盖一个必不可少的微服务工具。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ki"><img src="../Images/31c192f03ef5030d8d393e8296e887ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1194/format:webp/1*7bqii49IFfiO0jpGYIcyAA.png"/></div><figcaption class="kq kr gj gh gi ks kt bd b be z dk translated">服务注册和分布式配置/咨询和运行</figcaption></figure><h1 id="358b" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">TL；速度三角形定位法(dead reckoning)</h1><div class="ls lt gp gr lu lv"><a href="https://github.com/by-sabbir/consul-kv-discovery" rel="noopener  ugc nofollow" target="_blank"><div class="lw ab fo"><div class="lx ab ly cl cj lz"><h2 class="bd io gy z fp ma fr fs mb fu fw im bi translated">GitHub-by-sab Bir/consul-kv-discovery</h2><div class="mc l"><h3 class="bd b gy z fp ma fr fs mb fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="md l"><p class="bd b dl z fp ma fr fs mb fu fw dk translated">github.com</p></div></div><div class="me l"><div class="mf l mg mh mi me mj ko lv"/></div></div></a></div><p id="46e6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">拿到密码就跑</p><pre class="kj kk kl km gt mk ml mm mn aw mo bi"><span id="6aef" class="mp kv in ml b gy mq mr l ms mt">❯ docker compose up -d --build</span></pre><p id="c896" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这应该会在<code class="fe mu mv mw ml b">localhost:8500</code>处显示 Consul UI，如果您浏览<a class="ae mx" href="http://localhost:8500/ui/dc1/services/go-service_ms/instances/consul/go-service/health-checks" rel="noopener ugc nofollow" target="_blank">此链接</a>，该 UI 应该如下所示。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi my"><img src="../Images/6f9e11873e82eddd32a3a132c9525464.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ztp2fWqsDhuNsGZDwUCEDQ.png"/></div></div><figcaption class="kq kr gj gh gi ks kt bd b be z dk translated">使用健康检查咨询服务发现</figcaption></figure><p id="8e93" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果您对如何构建您的代码并使其为生产做好准备更感兴趣，让我们深入…</p></div><div class="ab cl nd ne hr nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="ig ih ii ij ik"><p id="a769" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们将首先从一个整体的<code class="fe mu mv mw ml b">main.go</code>文件开始，然后将它分解成几个部分来创建一个惯用的 go 项目。首先，我们需要启动咨询服务。让我们为此创建一个<code class="fe mu mv mw ml b">docker-compose.yml</code>文件，</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="83c7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">此外，我们需要添加服务器配置，从<code class="fe mu mv mw ml b"><a class="ae mx" href="https://github.com/by-sabbir/consul-kv-discovery/blob/master/conf/server.json" rel="noopener ugc nofollow" target="_blank">conf/server.json</a></code></p><pre class="kj kk kl km gt mk ml mm mn aw mo bi"><span id="76b2" class="mp kv in ml b gy mq mr l ms mt">❯ mkdir conf/ &amp;&amp; curl -o conf/server.json <a class="ae mx" href="https://raw.githubusercontent.com/by-sabbir/consul-kv-discovery/master/conf/server.json" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/by-sabbir/consul-kv-discovery/master/conf/server.json</a></span></pre><p id="54f4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在，我们准备启动 consul 服务器，</p><pre class="kj kk kl km gt mk ml mm mn aw mo bi"><span id="bbfd" class="mp kv in ml b gy mq mr l ms mt">❯ docker compose up -d consul</span></pre><p id="0b3c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让我们专注于应用程序，我们将做出一些设计决策-</p><ul class=""><li id="d386" class="nm nn in jm b jn jo jr js jv no jz np kd nq kh nr ns nt nu bi translated">首先，我们希望这个包能被所有的微服务使用。</li><li id="5626" class="nm nn in jm b jn nv jr nw jv nx jz ny kd nz kh nr ns nt nu bi translated">应用程序启动时应该注册服务。(应该首先失败，但为了简单起见，我们忽略这一点)</li><li id="b8f2" class="nm nn in jm b jn nv jr nw jv nx jz ny kd nz kh nr ns nt nu bi translated">我们希望使用 KV store 作为外部依赖管理器，如服务主机和端口、API 版本，而不是安全配置 ie、密码管理器、API 密钥、客户端机密等。</li></ul><p id="fc23" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们的项目结构应该是这样的，</p><pre class="kj kk kl km gt mk ml mm mn aw mo bi"><span id="11df" class="mp kv in ml b gy mq mr l ms mt">.<br/>├── cmd<br/>│   └── server<br/>├── conf<br/>├── internal<br/>|   └── api<br/>└── pkg<br/>    └── consul</span></pre><p id="2533" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">对于咨询服务交互，我们将使用<code class="fe mu mv mw ml b">pkg</code>目录而不是<code class="fe mu mv mw ml b">internal</code>，因为我们希望这可以作为<a class="ae mx" href="https://github.com/golang-standards/project-layout" rel="noopener ugc nofollow" target="_blank"> go 标准项目布局</a>的一部分，供其他开发者和服务重用。</p><p id="d000" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在，创建一个新文件<code class="fe mu mv mw ml b">pkg/consul/service-discovery.go</code></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="95c6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这是一个相当简单的代码，只包含两个函数</p><ul class=""><li id="3206" class="nm nn in jm b jn jo jr js jv no jz np kd nq kh nr ns nt nu bi translated"><code class="fe mu mv mw ml b">NewClient</code> —为给定地址启动新的 consul API 客户端</li><li id="3dd4" class="nm nn in jm b jn nv jr nw jv nx jz ny kd nz kh nr ns nt nu bi translated"><code class="fe mu mv mw ml b">Register</code> —使用给定的名称和预定义的标签注册服务以咨询服务发现。</li></ul><p id="5639" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">对于产品，标签对于在 Consul UI 中快速搜索服务非常重要。一旦服务被注册，监控服务健康将是 consul 服务器的工作，行<code class="fe mu mv mw ml b">30-34</code>表示 consul 服务器将每 30 秒检查一次服务的健康。</p><p id="72e3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们已经完成了服务发现。现在跟领事 KV Store 讨论一些动态配置。</p></div><div class="ab cl nd ne hr nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="ig ih ii ij ik"><p id="3eb4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">为了整合 Consul KV，让我们稍微查看一下<a class="ae mx" href="https://pkg.go.dev/github.com/hashicorp/consul/api#Client.KV" rel="noopener ugc nofollow" target="_blank">文档</a>，以便更好地了解情况。从文档中，我们可以看到，</p><pre class="kj kk kl km gt mk ml mm mn aw mo bi"><span id="9492" class="mp kv in ml b gy mq mr l ms mt">func (c *<a class="ae mx" href="https://pkg.go.dev/github.com/hashicorp/consul/api#Client" rel="noopener ugc nofollow" target="_blank">Client</a>) KV() *<a class="ae mx" href="https://pkg.go.dev/github.com/hashicorp/consul/api#KV" rel="noopener ugc nofollow" target="_blank">KV</a></span></pre><p id="3423" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">因此，<code class="fe mu mv mw ml b">KV</code>是一个指向<code class="fe mu mv mw ml b">*api.Client</code>结构的指针接收器。我们已经有了一个返回<code class="fe mu mv mw ml b">*api.Client</code>的方法<code class="fe mu mv mw ml b">NewClient</code>，并且我们已经从该方法启动了一个客户端，如果我们为 KV Store 创建一个单独的存储库，我们可以重用该客户端。让我们这样做…创建一个文件<code class="fe mu mv mw ml b">pkg/consul/kv-store.go</code>并粘贴以下行—</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="fe33" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">函数<code class="fe mu mv mw ml b">NewKVClient</code>重用我们的<code class="fe mu mv mw ml b">ConsulClient</code>并返回一个 KV 客户端。对于我们的用例，我们只创建了 Get 和 Put 功能，假设商店的所有键和值都是<code class="fe mu mv mw ml b">string</code>。因为我们将只读取现有配置并创建/更新一个。</p><p id="85d5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">最后是集成解决方案的时候了，Go 提供了一个非常强大的函数来实例化<code class="fe mu mv mw ml b">init()</code>，这个函数只运行一次，在包内任何其他函数之前运行。我们可以定义多个<code class="fe mu mv mw ml b">init()</code>,但它们都将按顺序运行一次，且只运行一次。我们将利用这一特性，因为 Consul 服务器将定期进行服务健康检查。</p><p id="5e0e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让我们编写足够的代码在 Consul 中注册服务，</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="d3e5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果您运行<code class="fe mu mv mw ml b">main.go</code>并进入控制台，粘贴以下内容—</p><pre class="kj kk kl km gt mk ml mm mn aw mo bi"><span id="8800" class="mp kv in ml b gy mq mr l ms mt">❯ curl -X GET <a class="ae mx" href="http://127.0.0.1:8500/v1/catalog/services" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:8500/v1/catalog/services</a></span></pre><p id="7846" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">它应该会输出类似这样的内容—</p><pre class="kj kk kl km gt mk ml mm mn aw mo bi"><span id="f1ad" class="mp kv in ml b gy mq mr l ms mt">{“consul”:[],”go-service_ms”:[“golang”,”microservice”]}</span></pre><p id="14c0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让我们清理一下<code class="fe mu mv mw ml b">main.go</code>文件。我们希望设计尽可能可重用的 consul 功能，我们通过使用 go 约定成功做到了这一点。但是实例化服务会因人而异。例如，一个人可能需要使用 AWS S3 服务，另一个人可能需要使用 AWS 密钥空间。因此配置可能因服务而异。在这种情况下，我们需要一个目录来实例化 consul 集成。让我们创建一个文件<code class="fe mu mv mw ml b">pkg/consul/kv-store.go</code>并粘贴以下内容</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nk nl l"/></div></figure><blockquote class="oa ob oc"><p id="5fcf" class="jk jl od jm b jn jo jp jq jr js jt ju oe jw jx jy of ka kb kc og ke kf kg kh ig bi translated">注意:结构<code class="fe mu mv mw ml b">ServiceDefinition</code>应该由<code class="fe mu mv mw ml b">viper</code>或任何<code class="fe mu mv mw ml b">os</code>环境变量解析器填充。</p></blockquote><p id="5267" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">因此，我们的<code class="fe mu mv mw ml b">main.go</code>文件变得更清晰，代码库也更易于管理。但是不要忘记在前面输入包装“<code class="fe mu mv mw ml b">_</code>”作为<a class="ae mx" href="https://go.dev/ref/spec#Blank_identifier" rel="noopener ugc nofollow" target="_blank">匿名占位符</a>。确保<code class="fe mu mv mw ml b">init()</code>功能运行一次。</p><pre class="kj kk kl km gt mk ml mm mn aw mo bi"><span id="d218" class="mp kv in ml b gy mq mr l ms mt">_ “github.com/by-sabbir/consul-kv-discovery/internal/consul”</span></pre><p id="ca04" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在，如果我们运行整个码头工人作曲，它应该像这样输出——</p><pre class="kj kk kl km gt mk ml mm mn aw mo bi"><span id="672c" class="mp kv in ml b gy mq mr l ms mt">❯ docker compose logs -f app</span><span id="8e5d" class="mp kv in ml b gy oh mr l ms mt">application  | 2022/10/08 21:07:40 service registered:  go-service<br/>application  | 2022/10/08 21:07:40 apigw baseUrl:  <strong class="ml io">apigw.example.com</strong></span></pre><p id="9a40" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们已经成功地从 KV 商店获得了信息，让我们来看看新的钥匙——</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi oi"><img src="../Images/bd374aa95c5a901cf35dc515bf8e01ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kkZ4hoeYGZ2W6JsfqeRYSg.png"/></div></div><figcaption class="kq kr gj gh gi ks kt bd b be z dk translated">获得并赋予咨询公司关键价值</figcaption></figure><p id="d336" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">要获取新创建的密钥，请<code class="fe mu mv mw ml b">go-service</code>提出以下请求——</p><pre class="kj kk kl km gt mk ml mm mn aw mo bi"><span id="19b3" class="mp kv in ml b gy mq mr l ms mt">❯ curl -X GET <a class="ae mx" href="http://127.0.0.1:8500/v1/kv/go-service" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:8500/v1/kv/go-service</a></span></pre><p id="d3e0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">它应该像这样输出查询——</p><pre class="kj kk kl km gt mk ml mm mn aw mo bi"><span id="bae4" class="mp kv in ml b gy mq mr l ms mt">[<br/>   {<br/>      "CreateIndex" : 17,<br/>      "Flags" : 0,<br/>      "Key" : "go-service",<br/>      "LockIndex" : 0,<br/>      "ModifyIndex" : 17,<br/>      "Value" : "MC4wLjAuMDo4MDAw"<br/>   }<br/>]</span></pre><p id="c6f3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">该值是原始消息的<code class="fe mu mv mw ml b">base64</code>编码版本。</p><p id="04a6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们现在能够发现领事的 go 服务。此外，配备必要的工具，以读取和写入领事千伏商店。</p></div></div>    
</body>
</html>