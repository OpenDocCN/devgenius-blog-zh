<html>
<head>
<title>Workflow as code+SageMaker, New gameplay with DolphinScheduler’s machine learning stock selection system</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">工作流 as code+SageMaker，新玩法搭配 DolphinScheduler 的机器学习选股系统</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/workflow-as-code-sagemaker-new-gameplay-with-dolphinschedulers-machine-learning-stock-selection-ad0422e8aae5?source=collection_archive---------7-----------------------#2022-11-07">https://blog.devgenius.io/workflow-as-code-sagemaker-new-gameplay-with-dolphinschedulers-machine-learning-stock-selection-ad0422e8aae5?source=collection_archive---------7-----------------------#2022-11-07</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/2745f0d26a2f98124cb40cc528c5e571.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xo-7Wd75B_FjJ2OfkUZpGg.png"/></div></div></figure><blockquote class="jv jw jx"><p id="9c37" class="jy jz ka kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">作者:Apache DolphinScheduler 委员会委员周杰光</p></blockquote><p id="cc4c" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated"><strong class="kb io">总结</strong></p><p id="9b91" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">Apache DolphinScheduler 在 DataOps 中提供了强大的分布式和可视化工作流调度功能。最新版本 3.1.0 引入了机器学习任务调度能力，并逐渐支持主流的 MLOps 项目/服务提供商。MLflow、DVC、Jupyter、OpenMLDB、SageMaker 和其他任务组件已经允许用户低成本、更高效地开发机器学习系统。</p><p id="3bac" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">这次我们介绍基于 YAML 文件的机器学习工作流的创建。我们还使用 DolphinScheduler 调用 Amazon SageMaker 进行股票训练和预测系统。</p><h1 id="45b8" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">PyDolphinScheduler 3.1.0</h1><p id="1cf9" class="pw-post-body-paragraph jy jz in kb b kc ly ke kf kg lz ki kj kx ma km kn ky mb kq kr kz mc ku kv kw ig bi translated">PyDolphinScheduler 3 . 1 . 0 版本发布后，用户现在可以使用 YAML 文件和 Python 脚本来定义工作流。</p><h1 id="01ba" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">计算机编程语言</h1><p id="0f43" class="pw-post-body-paragraph jy jz in kb b kc ly ke kf kg lz ki kj kx ma km kn ky mb kq kr kz mc ku kv kw ig bi translated">执行 python tutorial.py 将工作流传输到 DolphinScheduler。</p><figure class="md me mf mg gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/3539e185fff673d558bbe9afda2027f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yRhZ8ygeU-F7xK26fhruDA.png"/></div></div></figure><h1 id="f961" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">YAML</h1><figure class="md me mf mg gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/b87a1e89aacd919314daaf703a321cad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CEpzvscLu7Lqq-_CsDpw6A.png"/></div></div></figure><p id="3aae" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">执行 pydolphinscheduler YAML-f tutorial . YAML 将工作流转移到 dolphinscheduler。</p><p id="5f9f" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">对于希望以代码形式使用工作流的用户，可以直接使用上述两种方法来定义管理工作流。或者，您可以使用 git 来管理工作流，执行 CICD 等。</p><h1 id="160b" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">系统介绍</h1><p id="625f" class="pw-post-body-paragraph jy jz in kb b kc ly ke kf kg lz ki kj kx ma km kn ky mb kq kr kz mc ku kv kw ig bi translated">回顾:<a class="ae mh" href="https://medium.com/@ApacheDolphinScheduler/how-to-build-a-machine-learning-intelligent-stock-selection-system-based-on-apache-dolphinschedule-55260edaf42a" rel="noopener"> <strong class="kb io"> <em class="ka">选股模型自动更新，实时监控，基于 Apache DolphinScheduler 的机器学习智能选股系统。</em> </strong> </a></p><p id="9f58" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">这个机器学习选股系统主要有两种新的使用方法:</p><ol class=""><li id="fa2e" class="mi mj in kb b kc kd kg kh kx mk ky ml kz mm kw mn mo mp mq bi translated">使用 PyDolphinScheduler 以代码形式构建工作流。您可以快速创建和运行工作流，而无需单击页面并运行一行命令。</li><li id="2c66" class="mi mj in kb b kc mr kg ms kx mt ky mu kz mv kw mn mo mp mq bi translated">在下载和处理股票数据之后，将数据发送到 Amazon SageMaker，并使用 SageMaker 管道来执行数据集处理、训练、评估和批量推断。</li></ol><h1 id="1686" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">系统概况</h1><p id="1dea" class="pw-post-body-paragraph jy jz in kb b kc ly ke kf kg lz ki kj kx ma km kn ky mb kq kr kz mc ku kv kw ig bi translated">关于系统前后台更详细的介绍，可以参考前面介绍的<strong class="kb io"> A </strong> <a class="ae mh" href="https://medium.com/@ApacheDolphinScheduler/how-to-build-a-machine-learning-intelligent-stock-selection-system-based-on-apache-dolphinschedule-55260edaf42a" rel="noopener"> <strong class="kb io"> <em class="ka">自动更新选股模型，</em>实时监控，构建基于 Apache DolphinSchedule 的机器学习智能选股系统。</strong>T15】</a></p><p id="def9" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">我们现在将简要回顾一下这个系统，并关注如何通过配置文件创建一个工作流，并在 DS 上调用 SageMaker。</p><ol class=""><li id="85b7" class="mi mj in kb b kc kd kg kh kx mk ky ml kz mm kw mn mo mp mq bi translated">系统显示</li><li id="5543" class="mi mj in kb b kc mr kg ms kx mt ky mu kz mv kw mn mo mp mq bi translated">这个系统是如何运作的</li></ol><ul class=""><li id="0db5" class="mi mj in kb b kc kd kg kh kx mk ky ml kz mm kw mw mo mp mq bi translated">选股逻辑计算整个市场中符合 5 日均线高于 10 日均线信号的所有股票作为目标池。然后为上述股票池中的每只股票创建以下特征来训练模型。</li></ul><ol class=""><li id="1752" class="mi mj in kb b kc kd kg kh kx mk ky ml kz mm kw mn mo mp mq bi translated">股价与布林线三轨的相对价值。</li><li id="eb77" class="mi mj in kb b kc mr kg ms kx mt ky mu kz mv kw mn mo mp mq bi translated">股价与多条移动平均线的相对值。各种均线的多个区间的倾斜。</li><li id="79b8" class="mi mj in kb b kc mr kg ms kx mt ky mu kz mv kw mn mo mp mq bi translated">talib 模式计算当前 k 线的形状。如果是三只乌鸦如果是道吉烛台等等。详情请参考(https://www.jianshu.com/p/fd5c7f49db33)的 k 线形态识别</li></ol><p id="eaf4" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">注意:您可以添加任何您认为有用的信息作为附加功能。</p><p id="6786" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">模特培训</p><p id="1720" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">第二个分类是基于第二天的倾斜是否被执行。如果使用 SageMaker 管道中的训练节点进行训练。最后，如果每天构建一个 120 天的数据集，则最后七天用于评估。</p><p id="fb54" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">任务调度</p><p id="7e07" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">DolphinScheduler 完成所有的任务调度。DolphinScheduler 可以每天晚上自动更新模型，并上线进行预测。当模型当天表现不佳时，您可以调整参数和功能来重新训练新模型并在线评估它。它还具有任务容错机制，确保了系统的稳定性。</p><p id="d368" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">前端显示器</p><p id="286a" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">前端接口是使用 Observable 实现的。由于其笔记本丰富且易于使用的可视化数据分析功能，它构建了有效的实时股票选择监控系统。</p><p id="19da" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated"><em class="ka">项目地址</em></p><p id="3410" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">这个项目中工作流任务的实现可以在这里找到 GitHub—<a class="ae mh" href="https://github.com/jieguangzhou/DolphinScheduler-MLOps-Stock-Analysis/tree/sagemaker" rel="noopener ugc nofollow" target="_blank">dolphin scheduler—MLOps—Stock—Analysis</a>，切换到 SageMaker 分支。</p><pre class="md me mf mg gt mx my mz na aw nb bi"><span id="1cbe" class="nc lb in my b gy nd ne l nf ng">git clone https://github.com/jieguangzhou/DolphinScheduler-MLOps-Stock-Analysis<br/>cd DolphinScheduler-MLOps-Stock-Analysis<br/>git checkout sagemaker</span></pre><p id="ee7e" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">由于前端界面还是和以前一样方便，所以主要介绍选股系统的工作流程。</p><h1 id="ada4" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">介绍选股系统的工作流程</h1><p id="9915" class="pw-post-body-paragraph jy jz in kb b kc ly ke kf kg lz ki kj kx ma km kn ky mb kq kr kz mc ku kv kw ig bi translated">它主要包括三个子工作流:</p><p id="be0d" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">prepare_datas:下载每日数据、信号计算、特征(定量交易中的因子)计算</p><p id="49cd" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">train_model:生成训练数据，调用 SageMaker Pipeline 来更新模型，评估模型，并对批处理数据进行推理</p><p id="2463" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">recommend_stock:下载 SageMaker Pipeline 推断的数据，输入数据库进行股票推荐。</p><p id="e9de" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">以下是对各个子工作流的介绍:</p><p id="ee08" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated"><em class="ka">准备数据</em></p><p id="c2d2" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">下图展示了数据准备工作流程 prepare_datas，该流程下载股票数据并执行信号和特征计算。</p><p id="d7a4" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated"><code class="fe nh ni nj my b">download_data</code>:下载整个市场的每日股票数据</p><ul class=""><li id="298a" class="mi mj in kb b kc kd kg kh kx mk ky ml kz mm kw mw mo mp mq bi translated"><code class="fe nh ni nj my b">calc_signals:</code>用于进行信号计算(计算每天哪些股票满足信号条件，如 5 日均线和 10 日均线或金叉的股票)</li><li id="f800" class="mi mj in kb b kc mr kg ms kx mt ky mu kz mv kw mw mo mp mq bi translated"><code class="fe nh ni nj my b">calc_features:</code>特征计算(在量化交易中称为因子)。要计算每只股票每天的特征值，比如收盘价和 5 日均线的相对值，股票是否是 doji 形态等。</li></ul><figure class="md me mf mg gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/f005c60dbb4ba8db86a0cd0e8b49476f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o7bqHqmIBYCm3E_1lJ1q2w.png"/></div></div></figure><p id="421d" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">上面的 prepare_datas 工作流包含三个任务。</p><p id="5692" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated"><em class="ka">培训 _ 模式</em></p><p id="88da" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">下图显示了执行这些任务的工作流<code class="fe nh ni nj my b">training_model</code>的每个任务的 DAG 图:</p><p id="533e" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated"><code class="fe nh ni nj my b">prepare_training_data:</code>准备模型训练数据，并上传到亚马逊 S3(亚马逊 S3 将把它交给 SageMaker，将数据转换成训练集、验证集和测试集)</p><p id="050e" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated"><code class="fe nh ni nj my b">prepare_inference_data</code>:准备好要预测的股票数据，上传到亚马逊 S3</p><p id="368f" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated"><code class="fe nh ni nj my b">sagemaker</code>:执行 SageMaker 管道</p><figure class="md me mf mg gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/6669a8520bc15f929fffa8842f2eac92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pROGfEHBfR_FOVVb0YRZzA.png"/></div></div></figure><p id="fcc7" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated"><em class="ka"> SageMaker </em></p><p id="1312" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">SageMaker 组件任务定义如下。JSON 数据与 AWS SageMaker 管道启动数据的格式相同，包括管道名称和所有输入参数。</p><figure class="md me mf mg gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/625bb4938986e3c4940af4f950cf2ec6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9HeSrorGTRBmH9yYVTQxNg.png"/></div></div></figure><p id="3ef6" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">这个任务执行一个 SageMaker 管道，执行过程被持续监控，直到完成。</p><p id="654c" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">您可以在<a class="ae mh" href="https://dolphinscheduler.apache.org/zh-cn/docs/dev/user_doc/guide/task/sagemaker.html" rel="noopener ugc nofollow" target="_blank"><strong class="kb io">dolphin scheduler SageMaker 组件文档</strong> </a> <strong class="kb io">中找到更多信息。</strong></p><p id="0e80" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">每个管道有四个主要步骤:</p><p id="36e0" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">StrockProcess:将数据集处理成适合 SageMaker 内置算法的格式。然后将其分为训练集、验证集和测试集</p><p id="4df6" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">StockTrain:训练模型</p><p id="a171" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">StockEval:模型评估</p><p id="1aac" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">股票推断:使用模型进行批量股票预测</p><p id="10bf" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">Pipeline 定义的笔记本可以在 sage maker<a class="ae mh" href="https://github.com/jieguangzhou/DolphinScheduler-MLOps-Stock-Analysis/blob/sagemaker/pipeline_stock.ipynb" rel="noopener ugc nofollow" target="_blank"><strong class="kb io">的 dolphin scheduler-MLOps-Stock-Analysis/Pipeline _ Stock . ipynb 中看到</strong></a></p><p id="a4a2" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">可以在亚马逊 SageMaker 工作室看到:</p><figure class="md me mf mg gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/72b41ebfffa6bef9c71f04705cb2d4eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qdp0oLT-bGcF-p1zb1MZRw.png"/></div></div></figure><p id="283d" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated"><em class="ka">推荐 _ 股票</em></p><p id="aa5b" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">YAML 文件定义如下:</p><figure class="md me mf mg gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/9b5f9afebe9bc41afec041981c23b7ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ocigyPiELNs1mF3ZNF467w.png"/></div></div></figure><p id="a80b" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">工作流目前只有一个任务，在 DS 中显示如下:</p><figure class="md me mf mg gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/1a4229d3e162cd152cf53676b52fe013.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lM2-STxFNMbnyZ316d2dig.png"/></div></div></figure><p id="8109" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated"><em class="ka">运行 _ 系统</em></p><p id="9d3d" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">我们现在将这三个工作流合并成一个名为 run_system 的工作流。例如，我们展示了:</p><figure class="md me mf mg gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/7a14d4bd3b71b64050b2332536838263.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rR9xjk_8pQJahPlodi7YRA.png"/></div></div></figure><p id="77e5" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">定义 YAML 文件:</p><p id="22f7" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">$ENV{STOCK_PROJECT}语法表示将填充环境变量 STOCK_PROJECT</p><p id="3859" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">＄WORKFLOW { " prepare_datas.yaml " }语法在 prepare _ datas . YAML 中创建工作流，引用其名称并将其作为子工作流填充。</p><p id="401b" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated"><em class="ka">创建和执行工作流程</em></p><p id="3da6" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">我们如下创建一个 sh 文件<code class="fe nh ni nj my b">pydolphin_init.sh </code>:</p><pre class="md me mf mg gt mx my mz na aw nb bi"><span id="c80b" class="nc lb in my b gy nd ne l nf ng"><em class="ka"># /bin/bash</em><br/><br/><em class="ka"># init config</em><br/>user=Stock-Analysis<br/>password=123456<br/>tenant=$USER<br/>project_name=pydolphin<br/>api_address=127.0.0.1<br/>api_port=25333<br/><br/>pydolphinscheduler config --set java_gateway.address $api_address<br/>pydolphinscheduler config --set java_gateway.port $api_port<br/><br/>pydolphinscheduler config --set default.user.name $user<br/>pydolphinscheduler config --set default.user.password $password<br/>pydolphinscheduler config --set default.user.tenant $tenant<br/><br/>pydolphinscheduler config --set default.workflow.user $user<br/>pydolphinscheduler config --set default.workflow.tenant $tenant<br/>pydolphinscheduler config --set default.workflow.project $project_name<br/>pydolphinscheduler config --set default.workflow.queue default<br/><br/># The above is the related configuration for pydolphinscheduler, including ds address, port configuration, creation of the tenant, the user, and project (if it does not exist)</span><span id="503d" class="nc lb in my b gy nk ne l nf ng"># The following is the command to create the workflow</span><span id="b560" class="nc lb in my b gy nk ne l nf ng"># Configure the environment variables, which will be referenced in yaml</span><span id="788b" class="nc lb in my b gy nk ne l nf ng">export STOCK_PROJECT=$(pwd)</span><span id="1966" class="nc lb in my b gy nk ne l nf ng"># Creating the workflow<br/>pydolphinscheduler yaml -f pyds/run_system.yaml</span></pre><p id="92ea" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">然后，我们可以运行脚本来启动选股系统。</p><h1 id="cc89" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">项目实践</h1><p id="5ce2" class="pw-post-body-paragraph jy jz in kb b kc ly ke kf kg lz ki kj kx ma km kn ky mb kq kr kz mc ku kv kw ig bi translated"><strong class="kb io"> DolphinScheduler 安装和启动</strong></p><ul class=""><li id="04c4" class="mi mj in kb b kc kd kg kh kx mk ky ml kz mm kw mw mo mp mq bi translated">安装 dolphinscheduler</li></ul><p id="7168" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">下载<a class="ae mh" href="apache-dolphinscheduler-3.1.0-bin.tar.gz%EF%BC%88https://www.apache.org/dyn/closer.lua/dolphinscheduler/3.1.0/apache-dolphinscheduler-3.1.0-bin.tar.gz%EF%BC%89" rel="noopener ugc nofollow" target="_blank"> <strong class="kb io">安装包</strong> </a></p><p id="c6b4" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">单机启动<a class="ae mh" href="https://dolphinscheduler.apache.org/zh-cn/docs/latest/user_doc/guide/installation/standalone.html" rel="noopener ugc nofollow" target="_blank"> <strong class="kb io">详情可参见</strong> </a>。</p><p id="2b4c" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">解压缩:</p><pre class="md me mf mg gt mx my mz na aw nb bi"><span id="ef4c" class="nc lb in my b gy nd ne l nf ng">tar -zxvf apache-dolphinscheduler-3.1.0-bin.tar.gz<br/>cd apache-dolphinscheduler-3.1.0-bin</span></pre><p id="7a79" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">调整配置<code class="fe nh ni nj my b">standalone-server/conf/common.properties </code>中的以下字段，以添加用于 SageMaker 组件认证的 aws 密钥</p><pre class="md me mf mg gt mx my mz na aw nb bi"><span id="1b61" class="nc lb in my b gy nd ne l nf ng"><em class="ka"># The AWS access key. if resource.storage.type=S3 or use EMR-Task, This configuration is required </em><br/>resource.aws.access.key.id=&lt;YOUR AWS ACCESS KEY&gt; <br/><em class="ka"># The AWS secret access key. if resource.storage.type=S3 or use EMR-Task, This configuration is required </em><br/>resource.aws.secret.access.key=&lt;YOUR AWS SECRET KEY&gt;<br/><em class="ka"># The AWS Region to use. if resource.storage.type=S3 or use EMR-Task, This configuration is required </em><br/>resource.aws.region=&lt;AWS REGION&gt;</span></pre><ul class=""><li id="2f84" class="mi mj in kb b kc kd kg kh kx mk ky ml kz mm kw mw mo mp mq bi translated">启动海豚调度程序</li></ul><pre class="md me mf mg gt mx my mz na aw nb bi"><span id="e48e" class="nc lb in my b gy nd ne l nf ng">bash bin/dolphinscheduler-daemon.sh start standalone-server</span></pre><ul class=""><li id="b03c" class="mi mj in kb b kc kd kg kh kx mk ky ml kz mm kw mw mo mp mq bi translated">登录 DolphinScheduler</li></ul><p id="f0f3" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">浏览器网址<a class="ae mh" href="http://localhost:12345/dolphinscheduler/ui." rel="noopener ugc nofollow" target="_blank">http://localhost:12345/dolphin scheduler/ui。</a>您可以登录系统界面。默认的<strong class="kb io">用户名和密码是 admin/dolphinscheduler123 </strong></p><p id="eda6" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated"><strong class="kb io">海豚调度-MLOps-股票-分析</strong></p><p id="33c6" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">现在我们拉选股系统的代码，换到 sagemaker 分支。</p><pre class="md me mf mg gt mx my mz na aw nb bi"><span id="d875" class="nc lb in my b gy nd ne l nf ng">git clone https://github.com/jieguangzhou/DolphinScheduler-MLOps-Stock-Analysis<br/>cd DolphinScheduler-MLOps-Stock-Analysis<br/>git checkout sagemaker</span></pre><p id="8ad4" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">在<code class="fe nh ni nj my b">dmsa/db.py </code>中修改 MySQL 配置，保存信号特征和股票推荐结果。</p><pre class="md me mf mg gt mx my mz na aw nb bi"><span id="bb63" class="nc lb in my b gy nd ne l nf ng">class CONFIG:<br/>    MYSQL_USER = 'root'<br/>    MYSQL_PASSWORD = '123456'<br/>    MYSQL_HOST = 'xxxxxxxxxxxxxxxx'<br/>    MYSQL_PORT = 3306<br/>    MYSQL_DATABASE = 'dolphinscheduler_mlops_stock'</span></pre><p id="f04a" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">因为您需要将数据上传到 AWS S3，所以您必须配置文件<code class="fe nh ni nj my b">~/.aws/config</code></p><pre class="md me mf mg gt mx my mz na aw nb bi"><span id="3e52" class="nc lb in my b gy nd ne l nf ng">[default]<br/>aws_access_key_id = &lt;YOUR AWS ACCESS KEY&gt; <br/>aws_secret_access_key = &lt;YOUR AWS SECRET KEY&gt;<br/>region = &lt;YOUR AWS SECRET KEY&gt;</span></pre><p id="0c30" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated"><strong class="kb io">准备 Python 环境</strong></p><pre class="md me mf mg gt mx my mz na aw nb bi"><span id="ad9f" class="nc lb in my b gy nd ne l nf ng">virtualenv -p /usr/bin/python3 env<br/>source env/bin/activate<br/>pip install -r requirements.txt</span></pre><p id="57cd" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated"><strong class="kb io">安装 PyDolphinScheduler: </strong></p><p id="e59e" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated"><code class="fe nh ni nj my b">Python -m pip install apache-dolphinscheduler</code>可以安装在任何 python 环境中。实际的任务执行不需要 pydolphinscheduler。pydolphinscheduler 用于快速传递代码形式的工作流。</p><p id="3760" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">然后执行命令<code class="fe nh ni nj my b">bash pydolphin_init.sh</code>。</p><p id="0c91" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">如果你想让它运行得更快，你可以在<code class="fe nh ni nj my b">pyds/prepare_datas.yaml</code>中的<code class="fe nh ni nj my b">python -m dmsa.data.download ${data_path} </code>后加 200，这意味着只有 200 只股票会被用于流水线执行</p><figure class="md me mf mg gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nl"><img src="../Images/c36feeb628337de2b58dadae51d67eaa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M9uxZPmQctWF5N3QOE-KfQ.png"/></div></div></figure><h1 id="eade" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">摘要</h1><p id="ab86" class="pw-post-body-paragraph jy jz in kb b kc ly ke kf kg lz ki kj kx ma km kn ky mb kq kr kz mc ku kv kw ig bi translated">本文展示了如何使用 YAML 配置文件在 DolphinScheduler 中构建和执行工作流。然后调用亚马逊 SageMaker 管道提供机器学习能力，建立机器学习选股系统。</p><p id="964b" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">希望这能给你带来以下好处:</p><ol class=""><li id="45fa" class="mi mj in kb b kc kd kg kh kx mk ky ml kz mm kw mn mo mp mq bi translated">学习如何使用 DolphinScheduler 建立一个选股系统。</li><li id="80af" class="mi mj in kb b kc mr kg ms kx mt ky mu kz mv kw mn mo mp mq bi translated">学习如何使用 DolphinScheduler 连接到 MLOps 系统及其上游和下游任务。</li><li id="ad53" class="mi mj in kb b kc mr kg ms kx mt ky mu kz mv kw mn mo mp mq bi translated">了解 DolphinScheduler SageMaker 组件的使用。</li><li id="e5fa" class="mi mj in kb b kc mr kg ms kx mt ky mu kz mv kw mn mo mp mq bi translated">理解 DolphinScheduler 通过配置文件管理工作流的实践。</li></ol><ul class=""><li id="f067" class="mi mj in kb b kc kd kg kh kx mk ky ml kz mm kw mw mo mp mq bi translated">广告:</li><li id="c381" class="mi mj in kb b kc mr kg ms kx mt ky mu kz mv kw mw mo mp mq bi translated">如果你对用 DolphinScheduler 构建机器学习系统感兴趣，可以加入社区，参与讨论。</li><li id="78d5" class="mi mj in kb b kc mr kg ms kx mt ky mu kz mv kw mw mo mp mq bi translated">如果你有 DolphinScheduler，欢迎有构建机器学习系统或调度机器学习任务经验的学生投稿。</li></ul><h1 id="44ba" class="la lb in bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">加入社区</h1><p id="6395" class="pw-post-body-paragraph jy jz in kb b kc ly ke kf kg lz ki kj kx ma km kn ky mb kq kr kz mc ku kv kw ig bi translated">参与 DolphinScheduler 社区并为其做出贡献的方式有很多，包括:</p><p id="fce1" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">文件、翻译、问答、测试、代码、文章、主题演讲等。</p><p id="5a15" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">我们假设第一个 PR(文档、代码)是简单的，应该用来熟悉提交过程和社区协作风格。</p><p id="4f8f" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">所以社区整理了以下适合新手的问题列表:【https://github.com/apache/dolphinscheduler/issues/5689T2】</p><p id="4f4f" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">https://github.com/apache/dolphinscheduler/issues?<strong class="kb io">非新手问题列表:</strong> <a class="ae mh" href="https://github.com/apache/dolphinscheduler/issues?q=is%3Aopen+is%3Aissue+label%3A%22volunteer+wanted%22" rel="noopener ugc nofollow" target="_blank">q = is % 3A open+is % 3A issue+label % 3A % 22 volunteer+wanted % 22</a></p><p id="507a" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated"><strong class="kb io">如何投稿:</strong></p><p id="f4a9" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated"><a class="ae mh" href="https://dolphinscheduler.apache.org/en-us/docs/dev/user_doc/contribute/join/contribute.html" rel="noopener ugc nofollow" target="_blank">https://dolphin scheduler . Apache . org/en-us/docs/dev/user _ doc/contribute/join/contribute . html</a></p><p id="80d8" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated"><strong class="kb io"> GitHub 代码库:</strong><a class="ae mh" href="https://github.com/apache/dolphinscheduler" rel="noopener ugc nofollow" target="_blank">https://github.com/apache/dolphinscheduler</a></p><p id="d049" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated"><strong class="kb io">官方网站:</strong>https://dolphinscheduler.apache.org/</p><p id="90d0" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">邮件列表:dev@dolphinscheduler@apache.org</p><p id="33be" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated"><strong class="kb io">推特:</strong>@海豚时间表</p><p id="dd0c" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">https://www.youtube.com/channel/UCmrPmeE7dVqo8DYhSLHa0vA</p><p id="05b0" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated"><strong class="kb io">懈怠:</strong>T26】https://s.apache.org/dolphinscheduler-slack</p><p id="46f1" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated"><strong class="kb io">投稿指南:</strong>https://dolphin scheduler . Apache . org/en-us/community/index . html</p><p id="b87e" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">你的项目之星很重要，不要犹豫，点亮阿帕奇海豚调度❤️之星</p></div></div>    
</body>
</html>