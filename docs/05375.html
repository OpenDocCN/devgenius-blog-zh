<html>
<head>
<title>Grafana + Influxdb as SQL data visualization</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Grafana + Influxdb 作为 SQL 数据可视化</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/grafana-influxdb-as-sql-data-visualization-561e89b207?source=collection_archive---------0-----------------------#2021-07-30">https://blog.devgenius.io/grafana-influxdb-as-sql-data-visualization-561e89b207?source=collection_archive---------0-----------------------#2021-07-30</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="2744" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">有用和好看的外部工具来扩展我们的视野。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ki"><img src="../Images/6186e3bc8f85aafe64a686e392724a29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1202/format:webp/1*M485LmMC89hZzmtxDhrGTg.png"/></div></figure><p id="e7c2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">原则上，每个开发人员都熟悉 SQL 语言。我们以某种方式从 API 请求中收集数据，并将其保存到数据库中。并且希望以可视化的方式看到查询结果。这个故事基于 InfluxQL 语言和它的后继者——Flux 语言，它在函数式编程范例中工作。</p><p id="3970" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让我们想象一下，我们有一个不时保存一些统计测量数据的系统。偶尔会异步写入度量值。但我们希望看到基于这些数据的图表和图形。</p><p id="89fe" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">实际上，InfluxDB 可以与 InfluxQL 和 Flux 语言一起工作，它们非常相似。这取决于 InfluxDB 版本:1 或 2。</p><p id="51ef" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">Grafana 提供了借助不同图形可视化 SQL 数据的能力:饼图、仪表图、条形图、表格等等</p><p id="6c56" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">InfluxDB 编辑器中的一个流量查询示例:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kq"><img src="../Images/084b8a8764609f02ad11a5762c92fe6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3fn6eoepJBWtScU6WK_zEA.png"/></div></div><figcaption class="kv kw gj gh gi kx ky bd b be z dk translated">Grafana 和 InfluxDB 的著名紫罗兰风格</figcaption></figure><p id="5d88" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让我们在 InfluxDB 数据浏览器中编写一些查询。</p><p id="2bc1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> From </strong>关键字:我们可以定义某个桶，也可以使用默认值。</p><pre class="kj kk kl km gt kz la lb lc aw ld bi"><span id="1493" class="le lf in la b gy lg lh l li lj">from(bucket: "developerBucket")<br/>from(bucket: v.defaultBucket)</span></pre><p id="456d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">时间范围:</strong>可以是从今天开始的某段时间。</p><pre class="kj kk kl km gt kz la lb lc aw ld bi"><span id="b821" class="le lf in la b gy lg lh l li lj">from(bucket: v.defaultBucket)<br/>|&gt; range(start: 2021-29-07T00:00:00Z,<br/>           stop: 2021-29-07T23:59:00Z)<br/>|&gt; range(start: -1d)<br/>|&gt; range(start: v.timeRangeStart, stop: v.timeRangeStop)</span></pre><p id="e663" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> Sum </strong>关键字是聚合函数，就像 count、min、max 等。</p><pre class="kj kk kl km gt kz la lb lc aw ld bi"><span id="af99" class="le lf in la b gy lg lh l li lj">from(bucket: v.defaultBucket)<br/>|&gt; range(start: v.timeRangeStart, stop: v.timeRangeStop)<br/>|&gt; filter(fn: (r) =&gt; r._measurement == "charge" and r.type == "AAA")<br/>|&gt; sum()</span></pre><p id="c5c2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">或者用<strong class="jm io">Union</strong>关键字组合两个查询得到相同的结果:</p><pre class="kj kk kl km gt kz la lb lc aw ld bi"><span id="a513" class="le lf in la b gy lg lh l li lj">bucket1 = from(bucket: v.defaultBucket)<br/>|&gt; range(start: v.timeRangeStart, stop: v.timeRangeStop)<br/>|&gt; filter(fn: (r) =&gt; r._measurement == "charge" and r.type == "AAA")<br/>|&gt; filter(fn: (r) =&gt; r["status"] == "false")</span><span id="eb49" class="le lf in la b gy lk lh l li lj">bucket2 = from(bucket: v.defaultBucket)<br/>|&gt; range(start: v.timeRangeStart, stop: v.timeRangeStop)<br/>|&gt; filter(fn: (r) =&gt; r._measurement == "charge" and r.type == "AAA")<br/>|&gt; filter(fn: (r) =&gt; r["status"] == "true")</span><span id="9458" class="le lf in la b gy lk lh l li lj">union(tables: [bucket1, bucket2])<br/>|&gt; sum()</span></pre><p id="3114" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">保留</strong>关键字:在表格视图中显示某些列的情况下。还有<strong class="jm io"> drop() </strong>，<strong class="jm io"> rename() </strong>有非常直白的逻辑。</p><pre class="kj kk kl km gt kz la lb lc aw ld bi"><span id="40e2" class="le lf in la b gy lg lh l li lj">|&gt; keep(columns: ["type", "status", "_value])<br/>|&gt; rename(columns: {"_value": "amount"})</span></pre><p id="e966" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> Group </strong>关键字:聚合行，计算总和，正确映射名称。</p><pre class="kj kk kl km gt kz la lb lc aw ld bi"><span id="81bc" class="le lf in la b gy lg lh l li lj">from(bucket: v.defaultBucket)<br/>  |&gt; range(start: v.timeRangeStart, stop: v.timeRangeStop)<br/>  |&gt; filter(fn: (r) =&gt; r._measurement== "charge" and r.type== "AAA")<br/>  |&gt; group(columns: ["status"])<br/>  |&gt; sum()<br/>  |&gt; map(fn: (r) =&gt;  ({<br/>     r with status:<br/>       if r.status== "true" then "Enabled"<br/>       else "Disabled"<br/>     })<br/>   )</span></pre><p id="c7ec" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> Yield </strong>关键字—获得带有字段名称的结果。Yield 表示接收到的输入表应该作为查询的结果进行传递。在这里，我们计算“平均”值，并显示在图表上。</p><pre class="kj kk kl km gt kz la lb lc aw ld bi"><span id="cf31" class="le lf in la b gy lg lh l li lj">from(bucket: v.defaultBucket)<br/>|&gt; range(start: v.timeRangeStart, stop: v.timeRangeStop)<br/>|&gt; filter(fn: (r) =&gt; r._measurement == "charge" and r.type== "AAA")<br/>|&gt; group(columns: ["status"])<br/>|&gt; aggregateWindow(every: v.windowPeriod, fn: mean, createEmpty: false)<br/>|&gt; yield(name: "mean")</span></pre><p id="e3a3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">语法</strong>。可以借助点号或括号调用字段:</p><pre class="kj kk kl km gt kz la lb lc aw ld bi"><span id="21dc" class="le lf in la b gy lg lh l li lj">|&gt; filter(fn: (r) =&gt; r._measurement == "charge")<br/>or the same:<br/>|&gt; filter(fn: (r) =&gt; r["_measurement"] == "charge")</span></pre><p id="8fa6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">其他一些实际任务。</p><p id="f447" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">任务 1 </strong>:用关键字<strong class="jm io">集合</strong>在表格中动态添加一个新列</p><pre class="kj kk kl km gt kz la lb lc aw ld bi"><span id="0797" class="le lf in la b gy lg lh l li lj">from(bucket: v.defaultBucket)<br/>|&gt; range(start: v.timeRangeStart, stop: v.timeRangeStop)<br/>|&gt; filter(fn: (r) =&gt; r._measurement == "charge" and r.type== "AAA")<br/>|&gt; sum()<br/>|&gt; set(key: "name_field", value: "Total")</span></pre><p id="e605" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">设置</strong>关键字也可以作为数据源:</p><pre class="kj kk kl km gt kz la lb lc aw ld bi"><span id="4807" class="le lf in la b gy lg lh l li lj">from(bucket: v.defaultBucket)<br/>  |&gt; range(start: v.timeRangeStart, stop: v.timeRangeStop)<br/>  |&gt; filter(fn: (r) =&gt; contains(value: r["_field"], set: ${devices:json}))<br/>  |&gt; aggregateWindow(every: v.windowPeriod, fn: last)</span></pre><p id="c1b7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">任务 2 </strong>:将字段值映射到另一个字段值。<strong class="jm io"> Map </strong>关键字帮助我们进行不同的转换。例如，从布尔值到字符串:</p><pre class="kj kk kl km gt kz la lb lc aw ld bi"><span id="977d" class="le lf in la b gy lg lh l li lj">from(bucket: v.defaultBucket)<br/>  |&gt; range(start: v.timeRangeStart, stop: v.timeRangeStop)<br/>  |&gt; filter(fn: (r) =&gt; r._measurement== "charge" and r.type== "AAA")<br/>  |&gt; sum()<br/>  |&gt; map(fn: (r) =&gt;  ({<br/>     r with name:<br/>       if r.status == "true" then "Enabled"<br/>       else "Disabled"<br/>     })<br/>   )<br/>  |&gt; map(fn: (r) =&gt; ({<br/>     r with type: ""<br/>     })<br/>   )</span></pre><p id="0146" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">任务 3。用<strong class="jm io">聚集窗口</strong>功能在图形上显示记录的数据:</p><p id="9175" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> aggregateWindow </strong>支持按日历开窗数据:1h、1d、1mo、1yr。</p><pre class="kj kk kl km gt kz la lb lc aw ld bi"><span id="1889" class="le lf in la b gy lg lh l li lj">from(bucket: "myBucketForTest")<br/>  |&gt; range(start: v.timeRangeStart, stop: v.timeRangeStop)<br/>  |&gt; filter(fn: (r) =&gt; r._measurement== "charge" and r.type== "AAA")<br/>  |&gt; aggregateWindow(every: 1h, fn: count)<br/>  |&gt; yield(name: "count")</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ll"><img src="../Images/e226639edfc743b0ae4f304ea663f86a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Eq1RQbCBvT_lSyQqOmGtOg.jpeg"/></div></div></figure><p id="80f5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">任务四</strong>“_value”字段的棘手问题。</p><p id="410b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">InfluxDB/Grafana 需要实际数据来可视化。因此它有一些默认字段，如“_ 开始”、“停止”、“时间”、“测量”、“值”等。如果你能创建自己的字段并将数据收集到其中，那就太好了。</p><pre class="kj kk kl km gt kz la lb lc aw ld bi"><span id="1f8d" class="le lf in la b gy lg lh l li lj">|&gt; filter(fn: (r) =&gt; r["_field"] == "my_counter")</span></pre><p id="deb0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">无论如何，InfluxDB 至少需要 1 个字段来度量，我们总是可以使用“_value”来度量。</p><p id="b7f9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">所以，让我们得到<strong class="jm io"> max </strong>函数的聚合值；这里没有提到“_value”字段，但它在幕后。</p><pre class="kj kk kl km gt kz la lb lc aw ld bi"><span id="1d0e" class="le lf in la b gy lg lh l li lj">from(bucket: "MyBucket")<br/>  |&gt; range(start: v.timeRangeStart, stop: v.timeRangeStop)<br/>  |&gt; filter(fn: (r) =&gt; r._measurement== "charge" and r.type== "AAA")<br/>  |&gt; aggregateWindow(every: 1h, fn: max)<br/>  |&gt; max()</span></pre><p id="0bc3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">任务五</strong>。用<strong class="jm io"> pivot </strong>关键字重组数据。我们需要确保每个字段都有自己的列。适用于表格视图:</p><pre class="kj kk kl km gt kz la lb lc aw ld bi"><span id="e878" class="le lf in la b gy lg lh l li lj">from(bucket: "devtest")<br/>  |&gt; range(start: v.timeRangeStart, stop: v.timeRangeStop)<br/>  |&gt; filter(fn: (r) =&gt; r._measurement== "charge" and r.type== "BBB")<br/>  |&gt; group(columns: ["type"])  <br/>  |&gt; pivot(rowKey: ["_time", "_measurement"], columnKey: ["_field"], valueColumn: "_value")<br/>  |&gt; drop(columns: ["_time", "_start", "_stop"])<br/>  |&gt; group()</span></pre><p id="8e74" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">任务六。添加别名而不是字段名。<strong class="jm io">地图</strong>功能帮助我们:</p><pre class="kj kk kl km gt kz la lb lc aw ld bi"><span id="fafa" class="le lf in la b gy lg lh l li lj">from(bucket: "myBucket")<br/>  |&gt; range(start: v.timeRangeStart, stop: v.timeRangeStop)<br/>  |&gt; filter(fn: (r) =&gt; r._measurement== "charge" and r.type== "VVV")<br/>  |&gt; map(fn: (r) =&gt; ({_value:r._value, _time:r._time, _field:"MyAmount"}))<br/>  |&gt; keep(columns: ["_field", "_time", "_value"])<br/>  |&gt; yield()</span></pre><p id="676b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">任务 7 </strong>获取上次保存的值。</p><pre class="kj kk kl km gt kz la lb lc aw ld bi"><span id="930a" class="le lf in la b gy lg lh l li lj">from(bucket: "myBucket")<br/>  |&gt; range(start: v.timeRangeStart, stop: v.timeRangeStop)<br/>  |&gt; filter(fn: (r) =&gt; r._measurement== "charge" and r.type== "BBB")<br/>  |&gt; last()<br/>  |&gt; yield(name: "last")</span></pre><p id="c089" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">结论</strong></p><p id="ca97" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">Grafana 有一个很好的社区，我们可以在那里找到如何创建复杂流量查询的正确答案。我喜欢玩这样的东西。系统将数据以 SQL 形式存储到 InfluxDB，数据可以可视化以实时显示更新的统计数据。这些链接非常有助于找到您需要的内容:</p><p id="0eab" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">链接</strong></p><div class="lm ln gp gr lo lp"><a href="https://docs.influxdata.com/influxdb/cloud/query-data/get-started/" rel="noopener  ugc nofollow" target="_blank"><div class="lq ab fo"><div class="lr ab ls cl cj lt"><h2 class="bd io gy z fp lu fr fs lv fu fw im bi translated">开始使用 Flux</h2><div class="lw l"><h3 class="bd b gy z fp lu fr fs lv fu fw dk translated">Flux 是 InfluxData 的函数式数据脚本语言，设计用于查询、分析和处理数据。这个…</h3></div><div class="lx l"><p class="bd b dl z fp lu fr fs lv fu fw dk translated">docs.influxdata.com</p></div></div></div></a></div><div class="lm ln gp gr lo lp"><a href="https://www.sqlpac.com/en/documents/influxdb-moving-from-influxql-language-to-flux-language.html" rel="noopener  ugc nofollow" target="_blank"><div class="lq ab fo"><div class="lr ab ls cl cj lt"><h2 class="bd io gy z fp lu fr fs lv fu fw im bi translated">influx db——从 InfluxQL 转向 Flux 语言</h2><div class="lw l"><h3 class="bd b gy z fp lu fr fs lv fu fw dk translated">时序数据库 InfluxDB v2 已于 2020 年 11 月发布。已经发表了一篇关于如何…</h3></div><div class="lx l"><p class="bd b dl z fp lu fr fs lv fu fw dk translated">www.sqlpac.com</p></div></div><div class="ly l"><div class="lz l ma mb mc ly md ko lp"/></div></div></a></div><div class="lm ln gp gr lo lp"><a href="https://community.grafana.com/t/no-alias-by-when-using-flux/15575/7" rel="noopener  ugc nofollow" target="_blank"><div class="lq ab fo"><div class="lr ab ls cl cj lt"><h2 class="bd io gy z fp lu fr fs lv fu fw im bi translated">使用 flux 时没有“别名 BY”？</h2><div class="lw l"><h3 class="bd b gy z fp lu fr fs lv fu fw dk translated">大家好。我正在尝试使用 flux lang 设置一个“别名”。然而，我看不到这样做的选择。这个选项是…</h3></div><div class="lx l"><p class="bd b dl z fp lu fr fs lv fu fw dk translated">community.grafana.com</p></div></div><div class="ly l"><div class="me l ma mb mc ly md ko lp"/></div></div></a></div><div class="lm ln gp gr lo lp"><a href="https://www.influxdata.com/" rel="noopener  ugc nofollow" target="_blank"><div class="lq ab fo"><div class="lr ab ls cl cj lt"><h2 class="bd io gy z fp lu fr fs lv fu fw im bi translated">InfluxDB:专门构建的开源时间序列数据库| InfluxData</h2><div class="lw l"><h3 class="bd b gy z fp lu fr fs lv fu fw dk translated">InfluxDB 开源时间序列数据库，由 InfluxData 专门构建，用于监控指标和事件，提供…</h3></div><div class="lx l"><p class="bd b dl z fp lu fr fs lv fu fw dk translated">www.influxdata.com</p></div></div><div class="ly l"><div class="mf l ma mb mc ly md ko lp"/></div></div></a></div><div class="lm ln gp gr lo lp"><a href="https://www.sqlpac.com/en/documents/influxdb-flux-language-advanced-features.html" rel="noopener  ugc nofollow" target="_blank"><div class="lq ab fo"><div class="lr ab ls cl cj lt"><h2 class="bd io gy z fp lu fr fs lv fu fw im bi translated">InfluxDB - Flux 语言，高级功能</h2><div class="lw l"><h3 class="bd b gy z fp lu fr fs lv fu fw dk translated">InfluxDB - Flux 语言，高级特性。联接、透视、直方图、计算列(映射)、自定义聚合…</h3></div><div class="lx l"><p class="bd b dl z fp lu fr fs lv fu fw dk translated">www.sqlpac.com</p></div></div><div class="ly l"><div class="mg l ma mb mc ly md ko lp"/></div></div></a></div></div></div>    
</body>
</html>