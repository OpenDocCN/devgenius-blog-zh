<html>
<head>
<title>TIL: Python sqlite3 — using placeholders to bind values in SQL statements</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">TIL: Python sqlite3 —使用占位符绑定 SQL 语句中的值</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/til-python-sqlite3-using-placeholders-to-bind-values-in-sql-statement-62d10338cb6b?source=collection_archive---------5-----------------------#2022-08-25">https://blog.devgenius.io/til-python-sqlite3-using-placeholders-to-bind-values-in-sql-statement-62d10338cb6b?source=collection_archive---------5-----------------------#2022-08-25</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/></div><div class="ab cl jk jl hr jm" role="separator"><span class="jn bw bk jo jp jq"/><span class="jn bw bk jo jp jq"/><span class="jn bw bk jo jp"/></div><div class="ig ih ii ij ik"><p id="0c7a" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated"><em class="kp"> TIL(“今天我学到了”)是一些更短、研究更少的帖子，我通常会写这些帖子来帮助组织我的想法，巩固我在工作中学到的东西。我把它们贴在这里作为个人档案，当然也让其他人可能从中受益。</em></p></div><div class="ab cl jk jl hr jm" role="separator"><span class="jn bw bk jo jp jq"/><span class="jn bw bk jo jp jq"/><span class="jn bw bk jo jp"/></div><div class="ig ih ii ij ik"><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi kq"><img src="../Images/48c20b07971beabf995411ed385fa708.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vZ8aVhHbwaYFtmdj"/></div></div><figcaption class="lc ld gj gh gi le lf bd b be z dk translated"><a class="ae lg" href="https://unsplash.com/@davidclode?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">大卫·克洛德</a>在<a class="ae lg" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><h1 id="7ee9" class="lh li in bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">SQL 语句中的占位符</h1><p id="6c5b" class="pw-post-body-paragraph jr js in jt b ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk mj km kn ko ig bi translated">正如<a class="ae lg" href="https://docs.python.org/3/library/sqlite3.html#using-placeholders-to-bind-values-in-sql-queries" rel="noopener ugc nofollow" target="_blank"> Python sqlite3 文档</a>所解释的:</p><blockquote class="mk ml mm"><p id="44d8" class="jr js kp jt b ju jv jw jx jy jz ka kb mn kd ke kf mo kh ki kj mp kl km kn ko ig bi translated">SQL 操作通常需要使用 Python 变量的值。然而，要小心使用 Python 的字符串操作来组装查询，因为它们容易受到<a class="ae lg" href="https://en.wikipedia.org/wiki/SQL_injection" rel="noopener ugc nofollow" target="_blank"> SQL 注入攻击</a></p></blockquote><p id="ae8a" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">像这样组装字符串时会发生这种情况:</p><pre class="kr ks kt ku gt mq mr ms mt aw mu bi"><span id="59e4" class="mv li in mr b gy mw mx l my mz"><em class="kp"># Never do this -- insecure!</em><br/>symbol = 'RHAT'<br/>cur.execute("SELECT * FROM stocks WHERE symbol = '<strong class="mr io">%s</strong>'" % symbol)</span></pre><p id="71a3" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">或者用 f 弦。</p><p id="384d" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">文档建议使用<em class="kp">问号</em>或<em class="kp">命名的</em>样式:</p><pre class="kr ks kt ku gt mq mr ms mt aw mu bi"><span id="89f1" class="mv li in mr b gy mw mx l my mz"><em class="kp"># This is the qmark style:</em><br/>cur.execute("insert into lang values (?, ?)", ("C", 1972))<br/><br/><em class="kp"># And this is the named style:</em><br/>cur.execute("select * from lang where date=:year", {"year": 1972})</span></pre><h1 id="b282" class="lh li in bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">问题</h1><p id="006b" class="pw-post-body-paragraph jr js in jt b ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk mj km kn ko ig bi translated">然而，当我尝试后者时，我遇到了麻烦:</p><pre class="kr ks kt ku gt mq mr ms mt aw mu bi"><span id="3064" class="mv li in mr b gy mw mx l my mz">params = {"table": table, "identifier": identifier}<br/>query = "select * from :table where identifier=:identifier"<br/>cur.execute("query")</span></pre><p id="1150" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">一个小时的散弹枪调试之后，我意识到这不起作用，因为 DB-API 的参数替换只适用于表达式，而不适用于表名或 SQL 语法的其他部分。</p><p id="da1a" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">另一方面，这样做很好:</p><pre class="kr ks kt ku gt mq mr ms mt aw mu bi"><span id="a570" class="mv li in mr b gy mw mx l my mz">params = {"table": table, "identifier": identifier}<br/>query = f"select * from {table} where identifier=:identifier"<br/>cur.execute("query")</span></pre><p id="9474" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">然而，这个 f 弦对 SQL 注入来说仍然是不安全的:</p><pre class="kr ks kt ku gt mq mr ms mt aw mu bi"><span id="3551" class="mv li in mr b gy mw mx l my mz">table = "users; DROP TABLE users;"<br/>params = {"table": table, "identifier": identifier}<br/>query = f"select * from {table} where identifier=:identifier"<br/>cur.execute("query")</span></pre><p id="8f30" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">我看到有人声称(例如在<a class="ae lg" href="https://stackoverflow.com/questions/31277027/how-to-use-placeholders-for-the-column-and-table-names-in-sqlite3-statements-wh" rel="noopener ugc nofollow" target="_blank"> StackOverflow </a>上)API 会净化这样的输入，但是它没有。果然，您得到一个错误:</p><pre class="kr ks kt ku gt mq mr ms mt aw mu bi"><span id="f5b5" class="mv li in mr b gy mw mx l my mz">Traceback (most recent call last):<br/>  File "test.py", line 11, in &lt;module&gt;<br/>    cur.execute(f"select * from {table} where identifier=:identifier", params)<br/>sqlite3.OperationalError: no such table: users</span></pre><p id="b912" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">但这是因为表<code class="fe na nb nc mr b">users</code>实际上已经在执行语句的过程中被删除了。</p><h1 id="6a09" class="lh li in bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">解决办法</h1><p id="86c9" class="pw-post-body-paragraph jr js in jt b ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk mj km kn ko ig bi translated">就我所见，对此没有明确的解决方案。因此，如果表名可能来自用户输入，那么唯一要做的就是在将用户输入集成到 SQL 语句之前测试其安全性:</p><pre class="kr ks kt ku gt mq mr ms mt aw mu bi"><span id="a92e" class="mv li in mr b gy mw mx l my mz">table = input("Please enter a table")<br/>identifier = input("Please enter an identifier")<br/>if table in ["users", "admins", "groups"]: # specify tables<br/>    params = {"table": table, "identifier": identifier}<br/>    query = f"select * from {table} where identifier=:identifier"<br/>    cur.execute("query")</span></pre><p id="5f93" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">更好的办法是重写应用程序逻辑，避免使用动态表名或显式用户输入…</p><p id="6ae4" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">这似乎是一个代码气味肯定！</p></div><div class="ab cl jk jl hr jm" role="separator"><span class="jn bw bk jo jp jq"/><span class="jn bw bk jo jp jq"/><span class="jn bw bk jo jp"/></div><div class="ig ih ii ij ik"><p id="c51e" class="pw-post-body-paragraph jr js in jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ig bi translated">你好！👋<em class="kp">我是汤姆。我是一名软件工程师、技术作家和 IT 倦怠教练。如果想取得联系，可以查看</em><a class="ae lg" href="https://tomdeneire.github.io/" rel="noopener ugc nofollow" target="_blank"><em class="kp">https://tomdeneire . github . io</em></a></p></div></div>    
</body>
</html>