<html>
<head>
<title>Loading data from Google Cloud Storage into BigQuery using Cloud Workflows</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用云工作流将数据从 Google 云存储加载到 BigQuery</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/loading-data-from-google-cloud-storage-into-bigquery-using-cloud-workflows-679761d18998?source=collection_archive---------1-----------------------#2022-10-04">https://blog.devgenius.io/loading-data-from-google-cloud-storage-into-bigquery-using-cloud-workflows-679761d18998?source=collection_archive---------1-----------------------#2022-10-04</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="36bc" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><a class="ae ki" href="https://cloud.google.com/workflows/docs/overview" rel="noopener ugc nofollow" target="_blank"> Google Cloud Workflows </a>是一个无服务器的编排平台，允许我们将服务组合成可重复和可观察的动作集，通常连接其他 GCP 服务。你猜对了，这些工作流叫做<strong class="jm io"/>。</p><p id="fb4f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">作为一名数据工程师，我广泛使用 Apache Airflow(以及它在 GCP 的实现 Composer ),起初我对它提供的功能有点怀疑，但后来逐渐喜欢上了它的直接和简单。</p><p id="e527" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在这个快速练习中，我们将展示一个简单的用例——将一个 CSV 文件从 Google 云存储加载到 BigQuery。</p><h2 id="36bb" class="kj kk in bd kl km kn dn ko kp kq dp kr jv ks kt ku jz kv kw kx kd ky kz la lb bi translated">准备工作</h2><p id="11fe" class="pw-post-body-paragraph jk jl in jm b jn lc jp jq jr ld jt ju jv le jx jy jz lf kb kc kd lg kf kg kh ig bi translated">让我们设置适当的帐户和权限。对于这个作业，我们已经创建了一个服务帐户，并为其分配了角色“大查询作业用户”</p><figure class="li lj lk ll gt lm gh gi paragraph-image"><div class="gh gi lh"><img src="../Images/4ec13693287a6452d1cac17bf195414e.png" data-original-src="https://miro.medium.com/v2/resize:fit:894/format:webp/1*pDxB58TcU-pW4MzbZLt9Jw.png"/></div><figcaption class="lp lq gj gh gi lr ls bd b be z dk translated">我们服务客户的项目角色</figcaption></figure><p id="be00" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们还被授予了同一个服务帐户访问 Google 云存储桶的权限，我们打算从这个存储桶加载数据。</p><figure class="li lj lk ll gt lm gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi lt"><img src="../Images/a20c60854a36d9dc2ecbefa68701b5a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sTRPLUl_vgStLH60cj_IjQ.png"/></div></div><figcaption class="lp lq gj gh gi lr ls bd b be z dk translated">服务帐户的存储桶权限</figcaption></figure><p id="8f15" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">接下来，我们需要创建一个目标 BigQuery 数据集，并在其上提供服务帐户“Big Query Data Editor”角色。请注意，数据集需要与数据加载到的存储桶位于同一个 GCP 区域(或多区域)。</p><figure class="li lj lk ll gt lm gh gi paragraph-image"><div class="gh gi ly"><img src="../Images/f9d45a05db3af0233e602da80a256894.png" data-original-src="https://miro.medium.com/v2/resize:fit:1114/format:webp/1*oXwKEy1a-i7velMd552u8g.png"/></div><figcaption class="lp lq gj gh gi lr ls bd b be z dk translated">BigQuery 目标数据集权限</figcaption></figure><p id="ae38" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在，让我们看看我们的文件——一个普通的逗号分隔的 CSV 文件，第一行是标题行。</p><figure class="li lj lk ll gt lm gh gi paragraph-image"><div class="gh gi lz"><img src="../Images/0ace4ab8ab8eae3036de3c2254ab3d1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:958/format:webp/1*PDaOWZBOQE2C8HOWMz3l2g.png"/></div></figure><figure class="li lj lk ll gt lm gh gi paragraph-image"><div class="gh gi ma"><img src="../Images/221362a5d0513c127dfa987a84b9e87d.png" data-original-src="https://miro.medium.com/v2/resize:fit:814/format:webp/1*fLFylzRnqmQME__O_k8WIw.png"/></div></figure><p id="65b9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">根据我们的图例，该文件遵循以下命名约定，第一部分是销售日期。</p><figure class="li lj lk ll gt lm gh gi paragraph-image"><div class="gh gi mb"><img src="../Images/99c007acc88952d25b1c6f6c8dd99795.png" data-original-src="https://miro.medium.com/v2/resize:fit:572/format:webp/1*CTNjcdpGaqDJNE5x_XmPFg.png"/></div></figure><p id="76cc" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">好了，现在让我们来看看工作流程本身。</p><h2 id="f4a6" class="kj kk in bd kl km kn dn ko kp kq dp kr jv ks kt ku jz kv kw kx kd ky kz la lb bi translated">创建工作流</h2><figure class="li lj lk ll gt lm gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi mc"><img src="../Images/aa869f542e7c1b3a16cb247d10a90bbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eYcPDdZMUmJMXbJwQcIsxA.png"/></div></div></figure><p id="8d3a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在出现的对话框中，我们为工作流命名，选择区域和服务帐户(与上面我们授予权限的帐户相同)来运行工作流。</p><figure class="li lj lk ll gt lm gh gi paragraph-image"><div class="gh gi md"><img src="../Images/f9c45977e999646c6f3f4ae7a757194e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1190/format:webp/1*xK63aOotGLqcOx9eNhQm-A.png"/></div></figure><p id="6f40" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">比方说，如果我们希望每天都读取文件，也就是说，按照特定的时间表运行工作流，我们可以创建一个云调度程序触发器。这将自动以给定的节奏运行工作流。</p><p id="6b15" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">请注意，项目级角色“工作流调用者”需要附加到触发工作流的服务帐户。</p><figure class="li lj lk ll gt lm gh gi paragraph-image"><div class="gh gi me"><img src="../Images/1df2c07d5fea9aa13cb674c48dc290d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1140/format:webp/1*oSzVGfToDDuUFQNqagxxgg.png"/></div></figure><p id="bb97" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">带有触发器的工作流如下所示</p><figure class="li lj lk ll gt lm gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi mf"><img src="../Images/fb7663df2efc32c827745d97986dabd2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1272/format:webp/1*ZhIZOWdlTeV4mJ-Wz5Q7fg.png"/></div></div></figure><h2 id="729d" class="kj kk in bd kl km kn dn ko kp kq dp kr jv ks kt ku jz kv kw kx kd ky kz la lb bi translated">创建步骤</h2><p id="fc0a" class="pw-post-body-paragraph jk jl in jm b jn lc jp jq jr ld jt ju jv le jx jy jz lf kb kc kd lg kf kg kh ig bi translated">现在我们看到了工作流开发窗口，在这里我们可以用 YAML 式的语法为我们的工作流编写定义。如果你不熟悉工作流语法，一个好的起点是<a class="ae ki" href="https://cloud.google.com/functions/docs/tutorials" rel="noopener ugc nofollow" target="_blank">工作流教程页面</a>。另外，请注意右侧的窗格，它展示了我们的控制流</p><figure class="li lj lk ll gt lm gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi mg"><img src="../Images/8ebd70128a078b3ab4d5fb9e61e5a2e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5aDEJrHvKqpy2duK_HCePA.png"/></div></div></figure><p id="b681" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们现在需要构建工作流逻辑。在本练习中，我们需要检查可以为 BigQuery 作业设置的配置选项，这些选项记录在以下链接中</p><div class="mh mi gp gr mj mk"><a href="https://cloud.google.com/workflows/docs/reference/googleapis/bigquery/v2/jobs/insert" rel="noopener  ugc nofollow" target="_blank"><div class="ml ab fo"><div class="mm ab mn cl cj mo"><h2 class="bd io gy z fp mp fr fs mq fu fw im bi translated">方法:Google APIs . big query . v2 . jobs . insert | Workflows | Google Cloud</h2><div class="mr l"><h3 class="bd b gy z fp mp fr fs mq fu fw dk translated">无论您的企业正处于数字化转型的早期阶段，谷歌云都可以帮助您解决…</h3></div><div class="ms l"><p class="bd b dl z fp mp fr fs mq fu fw dk translated">cloud.google.com</p></div></div><div class="mt l"><div class="mu l mv mw mx mt my ln mk"/></div></div></a></div><p id="ca1e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">最简单的方法是在使用模式自动检测的同时尝试加载数据。注意负载配置中的<code class="fe mz na nb nc b">autodetect: true</code>部分。</p><p id="a49b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">以下代码将:</p><ul class=""><li id="9de8" class="nd ne in jm b jn jo jr js jv nf jz ng kd nh kh ni nj nk nl bi translated">声明一个结果列表，我们将在其中累积作业结果</li><li id="c378" class="nd ne in jm b jn nm jr nn jv no jz np kd nq kh ni nj nk nl bi translated">使用一组提供的参数创建 BigQuery 插入作业</li><li id="94a1" class="nd ne in jm b jn nm jr nn jv no jz np kd nq kh ni nj nk nl bi translated">将插入作业的结束状态附加到先前创建的列表中</li><li id="73ef" class="nd ne in jm b jn nm jr nn jv no jz np kd nq kh ni nj nk nl bi translated">工作流程完成后打印作业状态列表</li></ul><figure class="li lj lk ll gt lm"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="0ea1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">BigQuery 已经自动检测了列类型并加载了数据。</p><figure class="li lj lk ll gt lm gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/50810e3552489cbe9cd81cb46fe571dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:910/format:webp/1*JYzo7PdCzxsBfKgBsl7TGA.png"/></div></figure><figure class="li lj lk ll gt lm gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/7bedeb64bf49424f97bea19ed6d9419c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1328/format:webp/1*NpGUXHF_6DHY00_wsXpi5Q.png"/></div></figure><p id="1912" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果我们选择为作业提供模式，我们可以执行以下操作:</p><figure class="li lj lk ll gt lm"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="b89d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在执行时，这会产生以下结果。</p><figure class="li lj lk ll gt lm gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/9f5862d7198189c498b59db67a4e4e97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1334/format:webp/1*JTCL3431ki7vn0s2o9QpFw.png"/></div></figure><p id="6d28" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果我们有一个稍微高级一点的用例，并且想要将数百个文件(可能相当大)读入一个分区表，该怎么办？代码可能看起来像下面这样。</p><p id="b36f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">请注意以下事项:</p><ul class=""><li id="b29b" class="nd ne in jm b jn jo jr js jv nf jz ng kd nh kh ni nj nk nl bi translated">基于字段<strong class="jm io">日期</strong>按“天”进行时间划分</li><li id="ec04" class="nd ne in jm b jn nm jr nn jv no jz np kd nq kh ni nj nk nl bi translated">sourceUris 现在有一个通配符“*”来捕获所有以“_orders.csv”结尾的文件。</li></ul><figure class="li lj lk ll gt lm"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="7772" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们现在有了一个分区表</p><figure class="li lj lk ll gt lm gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi nw"><img src="../Images/97e9fbc8c203f1a0ed0b28af1997e067.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hVPy8ELoeALUiLovEQG8Hw.png"/></div></div></figure><figure class="li lj lk ll gt lm gh gi paragraph-image"><div class="gh gi nx"><img src="../Images/b3ea2ebfa15aae273c4146210c9d2a96.png" data-original-src="https://miro.medium.com/v2/resize:fit:760/format:webp/1*qIFEr-F-3JKFjAUDWX9iJA.png"/></div></figure><h2 id="950e" class="kj kk in bd kl km kn dn ko kp kq dp kr jv ks kt ku jz kv kw kx kd ky kz la lb bi translated">结论</h2><p id="1667" class="pw-post-body-paragraph jk jl in jm b jn lc jp jq jr ld jt ju jv le jx jy jz lf kb kc kd lg kf kg kh ig bi translated">正如我们在这个练习中看到的，使用云工作流将数据从 Google 云存储加载到 BigQuery 非常简单，并且允许我们利用 BQ API 在 Google Cloud 中构建可重复的低开销数据管道。感谢阅读！</p></div></div>    
</body>
</html>