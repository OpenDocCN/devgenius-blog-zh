<html>
<head>
<title>GraphQL, Apollo Studio, and Cookies</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GraphQL、Apollo Studio和Cookies</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/graphql-apollo-studio-and-cookies-5d8519d0ca7e?source=collection_archive---------2-----------------------#2021-12-22">https://blog.devgenius.io/graphql-apollo-studio-and-cookies-5d8519d0ca7e?source=collection_archive---------2-----------------------#2021-12-22</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><h1 id="7ed5" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">我们将涵盖的内容</h1><p id="1893" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated"><a class="ae lg" href="https://www.apollographql.com/" rel="noopener ugc nofollow" target="_blank"> Apollo GraphQL </a>是一个很棒的工具，但是有时它的文档很缺乏。快速的Google搜索会发现，人们努力解决的事情之一(通常不成功)是在Apollo Studio和NodeJS GraphQL服务器之间启用cookies。</p><p id="1bac" class="pw-post-body-paragraph ki kj in kk b kl lh kn ko kp li kr ks kt lj kv kw kx lk kz la lb ll ld le lf ig bi translated">在本文中，我们将:</p><ol class=""><li id="0ffa" class="lm ln in kk b kl lh kp li kt lo kx lp lb lq lf lr ls lt lu bi translated">描述问题(如果你很急，可以略读/跳过——参见TL；部分底部的博士)</li><li id="88d3" class="lm ln in kk b kl lv kp lw kt lx kx ly lb lz lf lr ls lt lu bi translated">确定我们在实施过程中的常见陷阱</li><li id="06d8" class="lm ln in kk b kl lv kp lw kt lx kx ly lb lz lf lr ls lt lu bi translated">提供可行的最终解决方案</li></ol><h1 id="2ded" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">问题是</h1><p id="bb35" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">因此，您已经使用<code class="fe ma mb mc md b"><a class="ae lg" href="https://www.npmjs.com/package/apollo-server-express" rel="noopener ugc nofollow" target="_blank">apollo-server-express</a></code>设置了GraphQL服务器，编写了一些查询，并决定了实现应用程序认证策略的时间。您选择基于cookie的会话方法，并使用熟悉的工具，如<code class="fe ma mb mc md b"><a class="ae lg" href="https://www.npmjs.com/package/express-session" rel="noopener ugc nofollow" target="_blank">express-session</a></code>、<code class="fe ma mb mc md b"><a class="ae lg" href="https://www.npmjs.com/package/redis" rel="noopener ugc nofollow" target="_blank">redis</a></code>和<code class="fe ma mb mc md b"><a class="ae lg" href="https://www.npmjs.com/package/connect-redis" rel="noopener ugc nofollow" target="_blank">connect-redis</a></code>。在代码中设置好会话逻辑之后，您前往Apollo Studio，看看您必须做些什么来让事情运转起来。你在屏幕左上角找到cog图标，打开对话框，在上切换<strong class="kk io">包含Cookies </strong>到<strong class="kk io">，看到类似于<strong class="kk io">图1 </strong>的东西。</strong></p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi me"><img src="../Images/0c8a21e888335878a140dd012703de1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eU3W7sv_geamQiOSjA20kw.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk translated"><strong class="bd jm">图1: </strong>阿波罗工作室连接设置对话框</figcaption></figure><p id="d16e" class="pw-post-body-paragraph ki kj in kk b kl lh kn ko kp li kr ks kt lj kv kw kx lk kz la lb ll ld le lf ig bi translated">没问题，你自己想吧。您是一名经验丰富的软件工程师——CORS、cookie、头文件——所有这些您都很熟悉，并且您非常有信心在几秒钟内就能在Apollo Studio和您的服务器之间传递cookie。将指定的URL添加到CORS源标头，启用凭据，然后保存项目。接下来，你去阿波罗工作室验证你的天才。可悲的是，你可能会遇到以下两种情况之一:</p><p id="2d13" class="pw-post-body-paragraph ki kj in kk b kl lh kn ko kp li kr ks kt lj kv kw kx lk kz la lb ll ld le lf ig bi translated">1) Apollo Studio连接到您的服务器没有问题，但是cookies仍然不工作，或者；</p><p id="4ab8" class="pw-post-body-paragraph ki kj in kk b kl lh kn ko kp li kr ks kt lj kv kw kx lk kz la lb ll ld le lf ig bi translated">2)你的浏览器控制台散落着CORS错误(<strong class="kk io">图2 </strong>，你在右下角看到一个类似于<strong class="kk io">图3 </strong>所示的弹出窗口(这个小对话框很可能即将成为你存在的祸根)。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mv"><img src="../Images/41cb5d9294a134f0969b56b3eb8416a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r9XGBBxpMJplxWIaDtKffQ.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk translated"><strong class="bd jm">图2 </strong> : CORS错误信息</figcaption></figure><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mw"><img src="../Images/3ca9b9ed4e454db0fee8dc9c53857f6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tMk4cuPRjMGE8pGmO8LGPA.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk translated"><strong class="bd jm">图3: </strong>阿波罗工作室连接错误对话框</figcaption></figure><p id="5b93" class="pw-post-body-paragraph ki kj in kk b kl lh kn ko kp li kr ks kt lj kv kw kx lk kz la lb ll ld le lf ig bi translated">如果你像许多在Reddit上发布这个问题的人一样，你会花几个小时试图找出问题所在，然后得出结论，Apollo Studio坏了，cookies不太可能出现。您选择使用GraphQL Playground(这是一个不错的选择！)并永远与阿波罗工作室断绝关系。</p><p id="da77" class="pw-post-body-paragraph ki kj in kk b kl lh kn ko kp li kr ks kt lj kv kw kx lk kz la lb ll ld le lf ig bi translated">快进几个月:你开始了一个新的项目，并决定也许你在最终拒绝阿波罗工作室时过于草率。你不仅记得它非常漂亮，而且你比许多个月前更有经验。长话短说，你会遇到同样的问题。你试试。你热血沸腾。你辞职了。这个循环在接下来的几个项目中重复，直到最后，你偶然发现了这篇文章，给了你希望<em class="mu">事情不一定是这样的</em>。</p><h2 id="7dc8" class="mx jl in bd jm my mz dn jq na nb dp ju kt nc nd jy kx ne nf kc lb ng nh kg ni bi translated"><strong class="ak">TL；博士</strong></h2><p id="d9b0" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated"><strong class="kk io">场景#1 </strong> : Apollo Studio连接到你的NodeJS GraphQL服务器，但是cookies没有通过。</p><p id="1496" class="pw-post-body-paragraph ki kj in kk b kl lh kn ko kp li kr ks kt lj kv kw kx lk kz la lb ll ld le lf ig bi translated"><strong class="kk io">场景#2 </strong> : Apollo Studio拒绝连接你的服务器。</p><p id="e89e" class="pw-post-body-paragraph ki kj in kk b kl lh kn ko kp li kr ks kt lj kv kw kx lk kz la lb ll ld le lf ig bi translated">注意:尽管错误对话框(<strong class="kk io">图3 </strong>)和Apollo Studio显示“获取失败”作为其错误响应消息，您仍然可以观察到您的服务器正在接收请求。</p><p id="c287" class="pw-post-body-paragraph ki kj in kk b kl lh kn ko kp li kr ks kt lj kv kw kx lk kz la lb ll ld le lf ig bi translated">我们实际上将从<strong class="kk io">场景#2 </strong>开始，因为修复它将把我们带到<strong class="kk io">场景#1 </strong>，在这一点上我们可以继续我们的最终解决方案。</p><h1 id="0062" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">识别潜在原因</h1><h2 id="2517" class="mx jl in bd jm my mz dn jq na nb dp ju kt nc nd jy kx ne nf kc lb ng nh kg ni bi translated">起始代码</h2><p id="f0e4" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">如上所述，我们将从一个导致<strong class="kk io">场景#2 </strong>的例子开始，并逐步找到一个完整的解决方案。很有可能您的代码看起来像这样:</p><figure class="mf mg mh mi gt mj"><div class="bz fp l di"><div class="nj nk l"/></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk translated"><strong class="ak"> server.ts </strong> : GraphQL服务器<strong class="ak">有问题</strong>要修复</figcaption></figure><figure class="mf mg mh mi gt mj"><div class="bz fp l di"><div class="nj nk l"/></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk translated"><strong class="ak"> appSession.ts </strong>:利用redis的会话设置。</figcaption></figure><p id="ba74" class="pw-post-body-paragraph ki kj in kk b kl lh kn ko kp li kr ks kt lj kv kw kx lk kz la lb ll ld le lf ig bi translated">希望跟踪这些文件的流程不会太难。<strong class="kk io"> server.ts </strong>展示了一个<code class="fe ma mb mc md b">apollo-server-express</code>应用程序的非常标准的实现，而<strong class="kk io"> appSession.ts </strong>展示了一个使用<code class="fe ma mb mc md b">redis</code>作为其会话存储的<code class="fe ma mb mc md b">express-session</code>实现。<strong class="kk io"> appSession.ts </strong>已经按照需要的方式设置好了——请注意第13行和第14行的<code class="fe ma mb mc md b">sameSite</code>和<code class="fe ma mb mc md b">secure</code> cookie属性，因为这些是所需功能所必需的。</p><p id="38ab" class="pw-post-body-paragraph ki kj in kk b kl lh kn ko kp li kr ks kt lj kv kw kx lk kz la lb ll ld le lf ig bi translated"><em class="mu">从这里开始，每当我们提到代码行时，我们都特指</em><strong class="kk io"><em class="mu">server . ts</em></strong><em class="mu">文件。</em></p><h2 id="a12b" class="mx jl in bd jm my mz dn jq na nb dp ju kt nc nd jy kx ne nf kc lb ng nh kg ni bi translated">摆脱“cors”包</h2><p id="73e8" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">如果你正在经历<strong class="kk io">场景#2 </strong>，但是当cookies被切换到<strong class="kk io">关闭</strong>时，应用程序似乎与Apollo Studio完美集成，那么很有可能你正在尝试使用<code class="fe ma mb mc md b"><a class="ae lg" href="https://www.npmjs.com/package/cors" rel="noopener ugc nofollow" target="_blank">cors</a></code>包设置你的CORS头(如第41–44行所示)。</p><p id="7230" class="pw-post-body-paragraph ki kj in kk b kl lh kn ko kp li kr ks kt lj kv kw kx lk kz la lb ll ld le lf ig bi translated">虽然我可能是唯一一个这样做的人，但我觉得这是值得解决的，因为当我第一次解决这个问题时，我花了很长时间才发现这是问题的一部分。</p><p id="246e" class="pw-post-body-paragraph ki kj in kk b kl lh kn ko kp li kr ks kt lj kv kw kx lk kz la lb ll ld le lf ig bi translated">为了实施cors头和规则，将对象作为输入传递给<code class="fe ma mb mc md b">cors</code>,并将其传递给第46行的<code class="fe ma mb mc md b">server.applyMiddleware</code>输入的CORS属性。它应该是这样的:</p><pre class="mf mg mh mi gt nl md nm nn aw no bi"><span id="b82e" class="mx jl in md b gy np nq l nr ns">server.applyMiddleware({<br/>    app,<br/>    cors: { <br/>       origin: ['https://studio.apollographql.com'],               <br/>       credentials: true,<br/>    }<br/>});</span></pre><p id="0c68" class="pw-post-body-paragraph ki kj in kk b kl lh kn ko kp li kr ks kt lj kv kw kx lk kz la lb ll ld le lf ig bi translated">删除<code class="fe ma mb mc md b">app.use(cors(//...))</code>，保存文件，并前往Apollo Studio——您现在应该看到，讨厌的对话框已经消失，Apollo Studio成功连接到您的服务器。</p><p id="7144" class="pw-post-body-paragraph ki kj in kk b kl lh kn ko kp li kr ks kt lj kv kw kx lk kz la lb ll ld le lf ig bi translated">太好了！第一个主要障碍已经清除，我们现在进入了场景#1 。</p><h2 id="0700" class="mx jl in bd jm my mz dn jq na nb dp ju kt nc nd jy kx ne nf kc lb ng nh kg ni bi translated">代理中到底有什么？</h2><p id="4610" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我们必须添加到服务器的下一行代码是:</p><pre class="mf mg mh mi gt nl md nm nn aw no bi"><span id="6f41" class="mx jl in md b gy np nq l nr ns">app.set('trust proxy', 1);</span></pre><p id="0188" class="pw-post-body-paragraph ki kj in kk b kl lh kn ko kp li kr ks kt lj kv kw kx lk kz la lb ll ld le lf ig bi translated">我知道这一节的标题暗示了某种解释，但是相反，我将只让您参考<a class="ae lg" href="https://expressjs.com/en/guide/behind-proxies.html" rel="noopener ugc nofollow" target="_blank"> Express文档</a>，让您自己去钻研它。</p><p id="08a7" class="pw-post-body-paragraph ki kj in kk b kl lh kn ko kp li kr ks kt lj kv kw kx lk kz la lb ll ld le lf ig bi translated">你实际上不需要理解这行代码在做什么，因为我们不会以任何其他方式使用它(尽管我鼓励你向上阅读！).也就是说，如果您不知道什么是代理以及设置此选项的含义，我建议您进行以下修改:</p><pre class="mf mg mh mi gt nl md nm nn aw no bi"><span id="8c8d" class="mx jl in md b gy np nq l nr ns">process.env.__dev__ &amp;&amp; app.set('trust proxy', 1);</span></pre><p id="9544" class="pw-post-body-paragraph ki kj in kk b kl lh kn ko kp li kr ks kt lj kv kw kx lk kz la lb ll ld le lf ig bi translated">基本上，除非您已经在使用反向代理，并且知道您在做什么，否则在生产中包含这个选项会使您的服务器易受攻击。包含这个一行程序可以让您在本地开发中随心所欲地使用Apollo Studio上的cookies，但也可以防止您的服务器在发布后受到损害。</p><h2 id="f707" class="mx jl in bd jm my mz dn jq na nb dp ju kt nc nd jy kx ne nf kc lb ng nh kg ni bi translated">设置“x-Forwarded-proto”Apollo Studio标题</h2><p id="f3ef" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">如果您查看<strong class="kk io">图1 </strong>，您会在对话框底部看到<strong class="kk io">默认标题</strong>部分。我们需要做的最后一件事是设置一个名为<code class="fe ma mb mc md b">x-forwarded-proto</code>的头，并给它赋值<code class="fe ma mb mc md b">https</code>。这很简单，但我还是加入了图4以防万一:</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi nt"><img src="../Images/3ef46ff6f62476bdf5b31d007a645cf1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NBdkOdjN0pGuhbqoqaPzJA.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk translated"><strong class="bd jm">图4</strong>:X-Forwarded-Proto头</figcaption></figure><p id="9913" class="pw-post-body-paragraph ki kj in kk b kl lh kn ko kp li kr ks kt lj kv kw kx lk kz la lb ll ld le lf ig bi translated">这个标题与我们几乎没有谈到的代理主题直接相关，所以我不会在这里详细讨论，但是请在阅读中留意这个标题的参考资料！</p><p id="192f" class="pw-post-body-paragraph ki kj in kk b kl lh kn ko kp li kr ks kt lj kv kw kx lk kz la lb ll ld le lf ig bi translated">如果一切顺利，这是最后一步，您的应用程序应该能够与Apollo Studio交换cookies了！</p><h1 id="23f4" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">最终解决方案</h1><p id="1abc" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">正如所承诺的，这里有一个文件片段，包含了我们讨论过的所有更改:</p><figure class="mf mg mh mi gt mj"><div class="bz fp l di"><div class="nj nk l"/></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk translated"><strong class="ak"> server.ts </strong> : GraphQL服务器配置为与Apollo Studio交换cookies</figcaption></figure><h1 id="f915" class="jk jl in bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">结论</h1><p id="dc89" class="pw-post-body-paragraph ki kj in kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">我希望这有所帮助！我花了很长时间才弄明白这一点(第一部分描述的叙述非常符合我的经历！)，所以我想分享我所学到的好处。</p><p id="72c5" class="pw-post-body-paragraph ki kj in kk b kl lh kn ko kp li kr ks kt lj kv kw kx lk kz la lb ll ld le lf ig bi translated">如果这篇文章为你节省了一些时间和挫折，请考虑通过<a class="ae lg" href="https://www.buymeacoffee.com/dannyibrahim" rel="noopener ugc nofollow" target="_blank">请我喝咖啡</a>来提供支持！如果有任何关于这篇文章的澄清或问题，或者如果有我提到的东西，你想进一步解释，请在下面联系或评论！</p></div></div>    
</body>
</html>