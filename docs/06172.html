<html>
<head>
<title>Automatic versioning V2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">自动版本控制 V2</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/automatic-versioning-v-2-f45f00c26b66?source=collection_archive---------4-----------------------#2021-12-19">https://blog.devgenius.io/automatic-versioning-v-2-f45f00c26b66?source=collection_archive---------4-----------------------#2021-12-19</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><figure class="im in gp gr io ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi il"><img src="../Images/34d3f90c615096ab3a1d53d6e10c94dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7WEMcAK9AuyayemZ"/></div></div><figcaption class="iw ix gj gh gi iy iz bd b be z dk translated">在<a class="ae ja" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae ja" href="https://unsplash.com/@carlosirineu?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Carlos Irineu da Costa </a>拍摄的照片</figcaption></figure><div class=""/><p id="b9e6" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">前段时间我发表了关于这个话题的<a class="ae ja" href="http://Automatic versioning" rel="noopener ugc nofollow" target="_blank">第一篇故事</a>。从那以后有了一些变化。</p><h1 id="ee2e" class="ky kz jd bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">TL；博士；医生</h1><ul class=""><li id="0dec" class="lw lx jd kc b kd ly kh lz kl ma kp mb kt mc kx md me mf mg bi translated">自动版本化是软件开发中的最佳实践之一，它带来了一些<a class="ae ja" href="https://gitversion.net/docs/learn/why" rel="noopener ugc nofollow" target="_blank">好处</a>；</li><li id="6035" class="lw lx jd kc b kd mh kh mi kl mj kp mk kt ml kx md me mf mg bi translated">本文描述了其中的一个具体案例，你需要对一个<strong class="kc je"> blazor web assembly 解决方案</strong>(客户端和服务器)，使用 Azure DevOps 作为 CI/CD；</li><li id="6da4" class="lw lx jd kc b kd mh kh mi kl mj kp mk kt ml kx md me mf mg bi translated">目标是在应用程序、CI/CD 管道中显示相同的版本信息，同时处理源存储库；</li><li id="95c0" class="lw lx jd kc b kd mh kh mi kl mj kp mk kt ml kx md me mf mg bi translated">工具和技术有<a class="ae ja" href="https://gitversion.net/docs/" rel="noopener ugc nofollow" target="_blank"> gitversion </a>、<a class="ae ja" href="https://semver.org" rel="noopener ugc nofollow" target="_blank">语义</a>版本化、<a class="ae ja" href="https://www.conventionalcommits.org/en/v1.0.0/#summary" rel="noopener ugc nofollow" target="_blank">常规提交</a>和<a class="ae ja" href="https://github.com/GitTools/actions" rel="noopener ugc nofollow" target="_blank"> gittools </a></li></ul><h1 id="5879" class="ky kz jd bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">先决条件</h1><ul class=""><li id="5c93" class="lw lx jd kc b kd ly kh lz kl ma kp mb kt mc kx md me mf mg bi translated">安装 gittools ( <a class="ae ja" href="https://gitversion.net/docs/usage/cli/installation" rel="noopener ugc nofollow" target="_blank">本地</a>并作为<a class="ae ja" href="https://marketplace.visualstudio.com/items?itemName=gittools.gittools" rel="noopener ugc nofollow" target="_blank">扩展</a>到你的 Azure DevOps 组织)</li><li id="e153" class="lw lx jd kc b kd mh kh mi kl mj kp mk kt ml kx md me mf mg bi translated">该解决方案应该有 3 个项目:客户端(blazor web 程序集)、服务器和共享(可选)。</li></ul><h1 id="42e4" class="ky kz jd bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">配置</h1><p id="6ff2" class="pw-post-body-paragraph ka kb jd kc b kd ly kf kg kh lz kj kk kl mm kn ko kp mn kr ks kt mo kv kw kx ig bi translated">在这种情况下，我们将使用<a class="ae ja" href="https://www.conventionalcommits.org/en/v1.0.0/#summary" rel="noopener ugc nofollow" target="_blank">常规提交</a>。</p></div><div class="ab cl mp mq hr mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="ig ih ii ij ik"><p id="aa2f" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">常规提交规范是提交消息之上的轻量级约定。它为创建显式提交历史提供了一组简单的规则；这使得在之上编写自动化工具变得更加容易。通过描述提交消息中的特性、修复和重大更改，该约定与<a class="ae ja" href="http://semver.org/" rel="noopener ugc nofollow" target="_blank"><strong class="kc je"><em class="mw">SemVer</em></strong></a><em class="mw">相吻合。</em></p></div><div class="ab cl mp mq hr mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="ig ih ii ij ik"><h2 id="5b0c" class="mx kz jd bd la my mz dn le na nb dp li kl nc nd lm kp ne nf lq kt ng nh lu ni bi translated"><strong class="ak"> <em class="nj"> GitVersion </em> </strong></h2><p id="dc39" class="pw-post-body-paragraph ka kb jd kc b kd ly kf kg kh lz kj kk kl mm kn ko kp mn kr ks kt mo kv kw kx ig bi translated">在你的解决方案的根目录下创建<strong class="kc je"><em class="mw">git version . yml</em></strong>，内容如下:</p><pre class="nk nl nm nn gt no np nq nr aw ns bi"><span id="e621" class="mx kz jd np b gy nt nu l nv nw">assembly-versioning-scheme: MajorMinorPatch</span><span id="1993" class="mx kz jd np b gy nx nu l nv nw">next-version: 0.0.1</span><span id="f3e0" class="mx kz jd np b gy nx nu l nv nw">mode: MainLine # Only add this if you want every version to be created automatically on your main branch.</span><span id="fcf9" class="mx kz jd np b gy nx nu l nv nw">major-version-bump-message: "^(build|chore|ci|docs|feat|fix|perf|refactor|revert|style|test)(\\([\\w\\s-]*\\))?(!:|:.*\\n\\n((.+\\n)+\\n)?BREAKING CHANGE:\\s.+)"</span><span id="c581" class="mx kz jd np b gy nx nu l nv nw">minor-version-bump-message: "^(feat)(\\([\\w\\s-]*\\))?:"</span><span id="a6c3" class="mx kz jd np b gy nx nu l nv nw">patch-version-bump-message: "^(build|chore|ci|docs|fix|perf|refactor|revert|style|test)(\\([\\w\\s-]*\\))?:"</span></pre><h2 id="4add" class="mx kz jd bd la my mz dn le na nb dp li kl nc nd lm kp ne nf lq kt ng nh lu ni bi translated">密码</h2><p id="fc9a" class="pw-post-body-paragraph ka kb jd kc b kd ly kf kg kh lz kj kk kl mm kn ko kp mn kr ks kt mo kv kw kx ig bi translated"><strong class="kc je">步骤 1 </strong>将在 web assembly app 中显示的 assembly 版本属于客户端，而不是服务器，项目。因此，它必须在每次添加适当的提交时进行更新。</p><p id="799b" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在您的两个项目文件中(顺便说一下，这对于客户端项目是必需的)添加以下行:</p><pre class="nk nl nm nn gt no np nq nr aw ns bi"><span id="c24a" class="mx kz jd np b gy nt nu l nv nw">&lt;GenerateAssemblyVersionAttribute&gt;false&lt;/GenerateAssemblyVersionAttribute&gt;<br/>    &lt;GenerateAssemblyFileVersionAttribute&gt;false&lt;/GenerateAssemblyFileVersionAttribute&gt;<br/>    &lt;GenerateAssemblyInformationalVersionAttribute&gt;false&lt;/GenerateAssemblyInformationalVersionAttribute&gt;</span></pre><p id="6a6b" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc je">第二步</strong>可以使用下面的代码显示 app 版本:</p><pre class="nk nl nm nn gt no np nq nr aw ns bi"><span id="e2ca" class="mx kz jd np b gy nt nu l nv nw">typeof(Program).Assembly.GetName().Version</span></pre><p id="b6e9" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc je">第三步</strong>假设 GitVersion.yaml 位于以上级别，从客户端项目文件夹中生成带有更新版本信息的组装文件:</p><pre class="nk nl nm nn gt no np nq nr aw ns bi"><span id="6d1a" class="mx kz jd np b gy nt nu l nv nw">gitversion /updateassemblyinfo Properties/AssemblyInfo.cs /ensureassemblyinfo /config ../../GitVersion.yml</span></pre><p id="e983" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这一步将创建如下内容:</p><pre class="nk nl nm nn gt no np nq nr aw ns bi"><span id="ce00" class="mx kz jd np b gy nt nu l nv nw">using System.Reflection;</span><span id="29fa" class="mx kz jd np b gy nx nu l nv nw">[assembly: AssemblyFileVersion("0.0.1.0")]</span><span id="4f4a" class="mx kz jd np b gy nx nu l nv nw">[assembly: AssemblyVersion("0.0.1.0")]</span><span id="a72c" class="mx kz jd np b gy nx nu l nv nw">[assembly: AssemblyInformationalVersion("0.0.1-beta.......")]</span></pre><h1 id="9c0e" class="ky kz jd bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">建设</h1><p id="c25b" class="pw-post-body-paragraph ka kb jd kc b kd ly kf kg kh lz kj kk kl mm kn ko kp mn kr ks kt mo kv kw kx ig bi translated">在 CI 阶段，在构建项目之前，您必须从客户端/属性文件夹执行:</p><pre class="nk nl nm nn gt no np nq nr aw ns bi"><span id="0496" class="mx kz jd np b gy nt nu l nv nw">dotnet-gitversion /updateassemblyinfo AssemblyInfo.cs /ensureassemblyinfo /config ../../GitVersion.yml</span></pre><h1 id="2630" class="ky kz jd bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">例子</h1><h2 id="b529" class="mx kz jd bd la my mz dn le na nb dp li kl nc nd lm kp ne nf lq kt ng nh lu ni bi translated">Azure DevOps 管道</h2><pre class="nk nl nm nn gt no np nq nr aw ns bi"><span id="57b4" class="mx kz jd np b gy nt nu l nv nw">- task: gitversion/setup@0</span><span id="e926" class="mx kz jd np b gy nx nu l nv nw">  displayName: Install GitVersion</span><span id="1a1d" class="mx kz jd np b gy nx nu l nv nw">  inputs:</span><span id="6e85" class="mx kz jd np b gy nx nu l nv nw">    versionSpec: '5.x'</span><span id="475f" class="mx kz jd np b gy nx nu l nv nw">- task: gitversion/execute@0</span><span id="9477" class="mx kz jd np b gy nx nu l nv nw">  inputs:</span><span id="d826" class="mx kz jd np b gy nx nu l nv nw">    useConfigFile: true</span><span id="dbc6" class="mx kz jd np b gy nx nu l nv nw">    configFilePath: '$(Build.SourcesDirectory)/SolutionFolder/GitVersion.yml'</span><span id="e225" class="mx kz jd np b gy nx nu l nv nw">- task: Bash@3</span><span id="f794" class="mx kz jd np b gy nx nu l nv nw">  inputs:</span><span id="b1ee" class="mx kz jd np b gy nx nu l nv nw">    targetType: 'inline'</span><span id="24b9" class="mx kz jd np b gy nx nu l nv nw">     script: |</span><span id="ebc4" class="mx kz jd np b gy nx nu l nv nw">      cd '$(Build.SourcesDirectory)/SolutionFolder/Client/Properties'</span><span id="da8f" class="mx kz jd np b gy nx nu l nv nw">      dotnet-gitversion /updateassemblyinfo AssemblyInfo.cs /ensureassemblyinfo /config ../../GitVersion.yml</span></pre></div></div>    
</body>
</html>