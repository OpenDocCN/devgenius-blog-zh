<html>
<head>
<title>Create an Amazon EKS Cluster with Managed Node Group using Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ä½¿ç”¨ Terraform åˆ›å»ºä¸€ä¸ªåŒ…å«å—ç®¡èŠ‚ç‚¹ç»„çš„äºšé©¬é€Š EKS é›†ç¾¤</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://blog.devgenius.io/create-an-amazon-eks-cluster-with-managed-node-group-using-terraform-a3b50d276b13?source=collection_archive---------0-----------------------#2020-07-11">https://blog.devgenius.io/create-an-amazon-eks-cluster-with-managed-node-group-using-terraform-a3b50d276b13?source=collection_archive---------0-----------------------#2020-07-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="eecb" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">åœ¨ AWS VPC ä¸­è®¾ç½® Kubernetes é›†ç¾¤ï¼Œå°†åº”ç”¨æœåŠ¡å™¨éƒ¨ç½²åˆ°ä¸“ç”¨å­ç½‘ä¸­çš„èŠ‚ç‚¹ç»„ï¼Œå¹¶é€šè¿‡ LB æœåŠ¡è®¿é—®å®ƒ</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/14718aee0a6c263a6daf91d656b84ed4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*COfqAsVnpDijYcVyEurBLQ.png"/></div></div></figure><p id="769c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">åœ¨æˆ‘æœ€è¿‘çš„æ–‡ç« ä¸­ï¼Œæˆ‘å±•ç¤ºäº†å¦‚ä½•åœ¨ VPC çš„ç§æœ‰å­ç½‘ä¸­çš„ ECS Fargate ä¸Šéƒ¨ç½²ä¸€ä¸ªå®¹å™¨åŒ–çš„åº”ç”¨ç¨‹åºï¼Œä»¥åŠå¦‚ä½•é€šè¿‡ API Gateway å®‰å…¨åœ°å…¬å¼€éƒ¨ç½²çš„åº”ç”¨ç¨‹åºã€‚è¿™ä¸€æ¬¡ï¼Œæˆ‘æƒ³æ¢ç´¢ AWS å¿…é¡»æä¾›çš„å¦ä¸€ä¸ª COE(å®¹å™¨ç¼–æ’å¼•æ“),äºšé©¬é€Š EKSã€‚ä¸¤è€…éƒ½æ˜¯å¯ç®¡ç†çš„ã€é«˜åº¦å¯ç”¨å’Œé«˜åº¦å¯æ‰©å±•çš„å®¹å™¨å¹³å°ã€‚ç„¶è€Œï¼ŒEKS æœ¬è´¨ä¸Šæ˜¯ Kubernetes å³æœåŠ¡ï¼Œå› æ­¤éœ€è¦äº†è§£å¼ºå¤§çš„å¼•æ“åŠå…¶ç»„ä»¶ï¼Œä»¥ä¾¿å……åˆ†åˆ©ç”¨å®ƒã€‚å°½ç®¡æœ‰ä¸€äº›ç›¸ä¼¼ä¹‹å¤„ï¼Œä½†å®ƒæ¯”å…·æœ‰æ›´å¤æ‚ä½“ç³»ç»“æ„çš„ ECS å…·æœ‰æ›´é™¡å³­çš„å­¦ä¹ æ›²çº¿ã€‚ECS çš„å¯æ‰©å±•æ€§æœ‰é™ï¼Œè€Œ EKS æœ‰å„ç§å„æ ·çš„ç¬¬ä¸‰æ–¹å’Œç¤¾åŒºé™„åŠ ç»„ä»¶ã€‚</p><p id="877a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†ä½¿ç”¨ Terraform åˆ›å»ºä¸€ä¸ªå…·æœ‰å…¬å…±å’Œç§æœ‰ç½‘ç»œæ¨¡å¼çš„é›†ç¾¤ï¼Œä¸€ç›´åˆ°åœ¨é›†ç¾¤ä¸­éƒ¨ç½²ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œå¹¶é€šè¿‡ä¸€ä¸ªè´Ÿè½½å‡è¡¡å™¨å…¬å¼€è®¿é—®å®ƒã€‚</p><p id="4ce2" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">è¿™ç¯‡æ–‡ç« ä¸­çš„ä»£ç ç‰‡æ®µå°†åªåŒ…å«ä¸»è¦çš„èµ„æºã€‚ä¸ºäº†æ›´å¥½åœ°ç†è§£æ‰€æœ‰ä¸œè¥¿æ˜¯å¦‚ä½•ç»„åˆåœ¨ä¸€èµ·çš„ï¼Œè¯·ä»<a class="ae ln" href="https://github.com/LukeMwila/aws-eks-platform" rel="noopener ugc nofollow" target="_blank">è¿™é‡Œ</a>å…‹éš†æºä»£ç åº“ã€‚</p><p id="fbce" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">å¦‚æœä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Œè¯·åœ¨è¿™é‡Œç»™æˆ‘ä¹°æ¯å’–å•¡<a class="ae ln" href="https://www.buymeacoffee.com/lukemwila" rel="noopener ugc nofollow" target="_blank">â˜•ï¸</a>ğŸ˜ƒã€‚</p><p id="0fd7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">ä¸‹é¢æ˜¯æˆ‘åœ¨ AWS æ¯”å‹’é™€åˆ©äºšä¼šè®®ä¸Šå…³äºåŒä¸€ä¸»é¢˜çš„æ¼”è®²çš„è§†é¢‘è®°å½•ã€‚</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="lo lp l"/></div></figure><h1 id="ec7b" class="lq lr iq bd ls lt lu lv lw lx ly lz ma jw mb jx mc jz md ka me kc mf kd mg mh bi translated">é¸Ÿç°å›¾</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mi"><img src="../Images/348a37b9d130379a810792513bfccee1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*70nXM3UsoTGjeEfMvGaAkA.png"/></div></div><figcaption class="mj mk gj gh gi ml mm bd b be z dk translated">æˆ‘ä»¬çš„ EKS é›†ç¾¤è®¾ç½®</figcaption></figure><h1 id="3ab2" class="lq lr iq bd ls lt lu lv lw lx ly lz ma jw mb jx mc jz md ka me kc mf kd mg mh bi translated">å…ˆå†³æ¡ä»¶</h1><p id="403c" class="pw-post-body-paragraph kr ks iq kt b ku mn jr kw kx mo ju kz la mp lc ld le mq lg lh li mr lk ll lm ij bi translated">æˆ‘è®¤ä¸ºï¼Œå¦‚æœä½ é‡‡å–äº²èº«å®è·µçš„æ–¹æ³•ï¼Œè¿™ç¯‡æ–‡ç« å°†å¯¹ä½ æœ€æœ‰ç›Šã€‚ä¸ºæ­¤ï¼Œè¯·ç¡®ä¿æ‚¨å…·å¤‡ä»¥ä¸‹æ¡ä»¶:</p><ul class=""><li id="c222" class="ms mt iq kt b ku kv kx ky la mu le mv li mw lm mx my mz na bi translated">Kubernetes å’Œ<a class="ae ln" href="https://kubernetes.io/docs/concepts/overview/components/" rel="noopener ugc nofollow" target="_blank"> Kubernetes é›†ç¾¤æ¶æ„</a>çš„åŸºç¡€çŸ¥è¯†</li><li id="f375" class="ms mt iq kt b ku nb kx nc la nd le ne li nf lm mx my mz na bi translated"><a class="ae ln" href="https://aws.amazon.com/premiumsupport/knowledge-center/create-and-activate-aws-account/" rel="noopener ugc nofollow" target="_blank"> AWS è´¦æˆ·</a></li><li id="eaf6" class="ms mt iq kt b ku nb kx nc la nd le ne li nf lm mx my mz na bi translated">å®‰è£…äº† AWS CLI å·¥å…·(<a class="ae ln" href="https://docs.aws.amazon.com/cli/latest/userguide/install-linux.html" rel="noopener ugc nofollow" target="_blank"> Linux </a>ã€<a class="ae ln" href="https://docs.aws.amazon.com/cli/latest/userguide/install-macos.html" rel="noopener ugc nofollow" target="_blank"> macOS </a>ã€<a class="ae ln" href="https://docs.aws.amazon.com/cli/latest/userguide/install-windows.html" rel="noopener ugc nofollow" target="_blank"> Windows </a>)</li><li id="a804" class="ms mt iq kt b ku nb kx nc la nd le ne li nf lm mx my mz na bi translated"><a class="ae ln" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html" rel="noopener ugc nofollow" target="_blank">ä½¿ç”¨ CLI é…ç½® AWS é…ç½®æ–‡ä»¶</a></li><li id="3305" class="ms mt iq kt b ku nb kx nc la nd le ne li nf lm mx my mz na bi translated">å®‰è£…äº† Docker CLI (å¦‚æœæ‚¨åœ¨ ECR ä¸­å·²ç»æœ‰äº†ä¸€ä¸ªå®¹å™¨æ˜ åƒï¼Œåˆ™ä¸ç›¸å…³)</li><li id="39f8" class="ms mt iq kt b ku nb kx nc la nd le ne li nf lm mx my mz na bi translated"><a class="ae ln" href="https://www.terraform.io/downloads.html" rel="noopener ugc nofollow" target="_blank">å®‰è£…åœ°å½¢</a>å’Œ<a class="ae ln" href="https://terragrunt.gruntwork.io/docs/getting-started/install/" rel="noopener ugc nofollow" target="_blank">åœ°å½¢</a></li><li id="3101" class="ms mt iq kt b ku nb kx nc la nd le ne li nf lm mx my mz na bi translated">Kubernetes å‘½ä»¤è¡Œå·¥å…·(<a class="ae ln" href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" rel="noopener ugc nofollow" target="_blank"> kubectl </a>)</li></ul><h1 id="e316" class="lq lr iq bd ls lt lu lv lw lx ly lz ma jw mb jx mc jz md ka me kc mf kd mg mh bi translated">äºšé©¬é€Š EKS å’Œé›†ç¾¤è®¾ç½®æ¦‚è¿°</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ng"><img src="../Images/44e2addae3565575a2184d88fe4f3ccd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gz-Ky-E8D2dW7ksvLQjueg.png"/></div></div></figure><p id="7820" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">äºšé©¬é€Š EKS(ç”¨äº Kubernetes çš„äºšé©¬é€Šå¼¹æ€§å®¹å™¨æœåŠ¡)æ˜¯ä¸€é¡¹æ‰˜ç®¡æœåŠ¡ï¼Œä½¿æ‚¨å¯ä»¥è½»æ¾åœ°åœ¨ AWS ä¸Šè¿è¡Œ Kubernetesï¼Œè€Œæ— éœ€è®¾ç½®ã€ä¾›åº”æˆ–ç»´æŠ¤æ‚¨è‡ªå·±çš„æ§åˆ¶å¹³é¢ã€‚å®ƒç¬¦åˆ Kubernetes æ ‡å‡†ï¼Œå¹¶æœ‰ä¸€ä¸ªå—ç®¡ç†çš„æ§åˆ¶å¹³é¢ã€‚<br/> <br/> AWS è´Ÿè´£è·¨å¤šä¸ª AWS AZs(å¯ç”¨æ€§åŒºåŸŸ)ä¾›åº”ã€è¿è¡Œã€ç®¡ç†å’Œè‡ªåŠ¨æ‰©å±• K8s ä¸»èŠ‚ç‚¹å’Œ etcd èŠ‚ç‚¹ï¼Œä»¥å®ç°é«˜å¯ç”¨æ€§ã€‚<br/>å®¢æˆ·è´Ÿè´£æ·»åŠ å’Œç®¡ç† EC2 å·¥ä½œèŠ‚ç‚¹ã€‚<br/>äºšé©¬é€Š EKS é›†ç¾¤åœ¨äºšé©¬é€Š VPCs å†…è¿è¡Œã€‚ä¸ºäº†ä¸ç¾¤é›†é€šä¿¡ï¼Œæ‚¨å¿…é¡»å°†å…¶é…ç½®ä¸ºå…·æœ‰å…¬å…±ç«¯ç‚¹è®¿é—®æ§åˆ¶å’Œ/æˆ–ç§æœ‰ç«¯ç‚¹è®¿é—®æ§åˆ¶ã€‚æˆ‘ä»¬ç¨åå°†æ›´è¯¦ç»†åœ°è®¨è®ºè¿™ä¸ªé—®é¢˜ã€‚</p><h1 id="dd90" class="lq lr iq bd ls lt lu lv lw lx ly lz ma jw mb jx mc jz md ka me kc mf kd mg mh bi translated">å®šä»·</h1><p id="ec32" class="pw-post-body-paragraph kr ks iq kt b ku mn jr kw kx mo ju kz la mp lc ld le mq lg lh li mr lk ll lm ij bi translated">åœ¨å¼€å§‹åˆ›å»º EKS é›†ç¾¤ä¹‹å‰ï¼Œæ‚¨åº”è¯¥äº†è§£ AWS æä¾›çš„ä¸€ä¸ªå…è´¹å±‚æ²¡æœ‰æ¶µç›–çš„ä»·æ ¼ã€‚åœ¨æˆ‘å†™è¿™ç¯‡æ–‡ç« çš„æ—¶å€™ï¼Œäºšé©¬é€Š EKS é›†ç¾¤çš„ä»·æ ¼æ˜¯æ¯å°æ—¶ 0.10 ç¾å…ƒã€‚æ­¤å¤–ï¼Œæ‚¨è¿˜è´Ÿè´£å…¶ä»–èµ„æºæˆæœ¬ï¼Œå¦‚ EC2ã€EBS ç­‰ã€‚è¯·åŠ¡å¿…<a class="ae ln" href="https://aws.amazon.com/eks/pricing/" rel="noopener ugc nofollow" target="_blank">æŸ¥çœ‹æœ¬é¡µ</a>äº†è§£è¯¥æœåŠ¡çš„æœ€æ–°ä»·æ ¼ã€‚</p><h1 id="b490" class="lq lr iq bd ls lt lu lv lw lx ly lz ma jw mb jx mc jz md ka me kc mf kd mg mh bi translated">å°†å®¹å™¨å›¾åƒæ¨é€åˆ° ECR</h1><p id="020b" class="pw-post-body-paragraph kr ks iq kt b ku mn jr kw kx mo ju kz la mp lc ld le mq lg lh li mr lk ll lm ij bi translated">æˆ‘ä¸æ‰“ç®—è¯¦ç»†ä»‹ç»è¿™ä¸€æ­¥ï¼Œå› ä¸ºæˆ‘å·²ç»åœ¨å¦ä¸€ç¯‡æ–‡ç« ä¸­ä»‹ç»è¿‡äº†ï¼Œä½ å¯ä»¥å‚è€ƒåŒä¸€å‰¯æ ‡é¢˜ä¸‹çš„<a class="ae ln" href="https://medium.com/swlh/deploy-container-in-ecs-fargate-behind-api-gateway-nlb-for-secure-optimal-accessibility-with-95542d5867c3" rel="noopener">è¿™é‡Œçš„</a>ã€‚è¿™ä»ç„¶æ˜¯é‡è¦çš„ä¸€æ­¥ï¼Œå› ä¸ºå®ƒè¯¦ç»†æè¿°äº†æˆ‘å°†ä»ç§æœ‰å­ç½‘èŠ‚ç‚¹ç»„ä¸­çš„ pod ä¸­æå–çš„æ˜ åƒã€‚</p><p id="f2da" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">æˆ‘æ‰€åšçš„åªæ˜¯ä¸º NodeJS åº”ç”¨æœåŠ¡å™¨åˆ›å»ºä¸€ä¸ª Docker æ˜ åƒï¼Œå®ƒåªæœ‰ä¸€æ¡è·¯ç”±<code class="fe nh ni nj nk b">/test</code>ï¼Œè¿”å›ä¸€ä¸ªå¸¦æœ‰æ–‡æœ¬<em class="nl">çš„å“åº”â€œæ­£åœ¨å·¥ä½œï¼â€</em>ã€‚</p><p id="f2aa" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">å¦‚æœæ‚¨åœ¨ ECR ä¸­å·²ç»æœ‰ä¸€ä¸ªå›¾åƒï¼Œé‚£ä¹ˆæ‚¨å¯ä»¥è·³è¿‡è¿™ä¸€æ­¥ã€‚</p><h1 id="8e1f" class="lq lr iq bd ls lt lu lv lw lx ly lz ma jw mb jx mc jz md ka me kc mf kd mg mh bi translated">è®¾ç½®æˆ‘ä»¬çš„ VPC ç½‘ç»œé…ç½®</h1><p id="b38b" class="pw-post-body-paragraph kr ks iq kt b ku mn jr kw kx mo ju kz la mp lc ld le mq lg lh li mr lk ll lm ij bi translated">å½“æ‚¨åˆ›å»ºä¸€ä¸ª Amazon EKS é›†ç¾¤æ—¶ï¼Œæ‚¨å¿…é¡»ä¸ºæ‚¨çš„é›†ç¾¤æŒ‡å®šè¦ä½¿ç”¨çš„ VPC å’Œå­ç½‘ã€‚äºšé©¬é€Š EKS éœ€è¦è‡³å°‘ä¸¤ä¸ª az ä¸­çš„å­ç½‘ã€‚åœ¨æ­¤è®¾ç½®ä¸­ï¼Œæˆ‘ä»¬å°†åŒæ—¶æ‹¥æœ‰å…¬å…±å­ç½‘å’Œç§æœ‰å­ç½‘ã€‚å…¬å…±å­ç½‘å°†ç”¨äºåˆ›å»ºå…¬å…±è´Ÿè½½å¹³è¡¡å™¨ï¼Œå°†æµé‡å¯¼å‘è¿è¡Œåœ¨ç§æœ‰å­ç½‘ä¸­å·¥ä½œèŠ‚ç‚¹ä¸Šçš„ podã€‚æ ¹æ®å­ç½‘å†…çš„æµé‡æ˜¯å¦é€šè¿‡<a class="ae ln" href="https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Internet_Gateway.html" rel="noopener ugc nofollow" target="_blank">äº’è”ç½‘ç½‘å…³</a>è·¯ç”±ï¼Œå­ç½‘æ˜¯å…¬å…±çš„è¿˜æ˜¯ç§æœ‰çš„ã€‚å¦‚æœå­ç½‘çš„æµé‡æ²¡æœ‰é€šè¿‡äº’è”ç½‘ç½‘å…³çš„é»˜è®¤è·¯ç”±ï¼Œåˆ™è¯¥å­ç½‘è¢«è§†ä¸ºä¸“ç”¨å­ç½‘ã€‚</p><p id="84cb" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">åœ¨é…ç½®æœ‰äº’è”ç½‘ç½‘å…³çš„å­ç½‘å†…ï¼Œå…·æœ‰å…¬å…±æˆ–å¼¹æ€§ IP åœ°å€çš„èŠ‚ç‚¹å…è®¸æ¥è‡ª VPC å¤–éƒ¨çš„è¿›å…¥ã€‚æ‚¨çš„ VPC å¿…é¡»æ”¯æŒ DNS ä¸»æœºåå’Œ DNS è§£æã€‚å¦åˆ™ï¼Œæ‚¨çš„å·¥ä½œèŠ‚ç‚¹å°†æ— æ³•å‘æ‚¨çš„ç¾¤é›†æ³¨å†Œã€‚</p><p id="08b8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">åˆ›å»ºäºšé©¬é€Š EKS é›†ç¾¤(1.15 ç‰ˆä¹‹å‰)æ—¶ï¼Œäºšé©¬é€Š EKS ä¼šæ ‡è®°åŒ…å«æ‚¨æŒ‡å®šçš„å­ç½‘çš„ VPCï¼Œä»¥ä¾¿ Kubernetes å¯ä»¥å‘ç°å®ƒã€‚æˆ‘ä»¬å°†åœ¨æˆ‘ä»¬çš„ Terraform ä»£ç ä¸­æ·»åŠ è¿™ä¸ªæ ‡ç­¾ï¼Œå¹¶ä½¿ç”¨ä»¥ä¸‹é”®å’Œå€¼:</p><ul class=""><li id="d809" class="ms mt iq kt b ku kv kx ky la mu le mv li mw lm mx my mz na bi translated">keyâ€”â€”å…¶ä¸­<em class="nl"> cluster-name </em>å€¼ä¸æ‚¨çš„äºšé©¬é€Š EKS é›†ç¾¤çš„åç§°ç›¸åŒ¹é…çš„<code class="fe nh ni nj nk b">kubernetes.io/&lt;cluster-name&gt;</code>ã€‚</li><li id="8e72" class="ms mt iq kt b ku nb kx nc la nd le ne li nf lm mx my mz na bi translated">valueâ€”<code class="fe nh ni nj nk b">shared</code>å€¼å…è®¸å¤šä¸ªé›†ç¾¤ä½¿ç”¨è¯¥ VPCã€‚</li></ul><p id="33f1" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">æ­¤å¤–ï¼ŒVPC å­ç½‘ä¹Ÿæœ‰æ ‡è®°è¦æ±‚ã€‚æ‚¨çš„ç¾¤é›†ç”¨äºèµ„æºçš„æ‰€æœ‰å­ç½‘(å…¬å…±å’Œä¸“ç”¨)ä¹Ÿåº”è¯¥å…·æœ‰ä¸Šè¿°æ ‡è®°ã€‚æ­¤å¤–ï¼Œå…¬å…±å’Œç§æœ‰å­ç½‘éƒ½åº”è¯¥æœ‰ç‰¹å®šçš„æ ‡ç­¾ï¼Œå‘Šè¯‰ Kubernetes åœ¨å“ªé‡Œéƒ¨ç½²å†…éƒ¨(ç§æœ‰)å’Œå¤–éƒ¨è´Ÿè½½å¹³è¡¡å™¨(å…¬å…±)ã€‚</p><p id="3696" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">å…¬å…±å­ç½‘æ ‡ç­¾:</p><ul class=""><li id="aea0" class="ms mt iq kt b ku kv kx ky la mu le mv li mw lm mx my mz na bi translated">å…³é”®â€” <code class="fe nh ni nj nk b">kubernetes.io/role/elb</code></li><li id="ce51" class="ms mt iq kt b ku nb kx nc la nd le ne li nf lm mx my mz na bi translated">å€¼â€” <code class="fe nh ni nj nk b">1</code></li></ul><p id="30cd" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">ä¸“ç”¨å­ç½‘æ ‡è®°:</p><ul class=""><li id="9a34" class="ms mt iq kt b ku kv kx ky la mu le mv li mw lm mx my mz na bi translated">å…³é”®â€” <code class="fe nh ni nj nk b">kubernetes.io/role/internal-elb</code></li><li id="5c51" class="ms mt iq kt b ku nb kx nc la nd le ne li nf lm mx my mz na bi translated">å€¼â€” <code class="fe nh ni nj nk b">1</code></li></ul><pre class="kg kh ki kj gt nm nk nn no aw np bi"><span id="064c" class="nq lr iq nk b gy nr ns l nt nu">resource "aws_vpc" "custom_vpc" {<br/>  cidr_block       = var.vpc_cidr_block<br/>  # Your VPC must have DNS hostname and DNS resolution support. <br/>  # Otherwise, your worker nodes cannot register with your cluster. <br/>  enable_dns_support = true<br/>  enable_dns_hostnames = true</span><span id="b5c4" class="nq lr iq nk b gy nv ns l nt nu">tags = {<br/>    Name = "${var.vpc_tag_name}-${var.environment}"<br/>    <strong class="nk ir">"kubernetes.io/cluster/${var.eks_cluster_name}" = "shared"</strong><br/>  }<br/>}</span><span id="3c24" class="nq lr iq nk b gy nv ns l nt nu">### VPC Network Setup</span><span id="9df4" class="nq lr iq nk b gy nv ns l nt nu"># Create the private subnet<br/>resource "aws_subnet" "private_subnet" {<br/>  vpc_id            = "${aws_vpc.custom_vpc.id}"<br/>  cidr_block = var.private_subnet_cidr_block</span><span id="cbd1" class="nq lr iq nk b gy nv ns l nt nu">tags = {<br/>    <strong class="nk ir">"kubernetes.io/cluster/${var.eks_cluster_name}" = "shared"<br/>    "kubernetes.io/role/internal-elb" = 1</strong><br/>  }<br/>}</span><span id="1372" class="nq lr iq nk b gy nv ns l nt nu"># Create the public subnet<br/>resource "aws_subnet" "public_subnet" {<br/>  count = length(var.availability_zones)<br/>  vpc_id            = "${aws_vpc.custom_vpc.id}"<br/>  cidr_block = "${element(var.public_subnet_cidr_blocks, count.index)}"<br/>  availability_zone = "${element(var.availability_zones, count.index)}"</span><span id="4c3a" class="nq lr iq nk b gy nv ns l nt nu">  tags = {<br/>    <strong class="nk ir">"kubernetes.io/cluster/${var.eks_cluster_name}" = "shared"<br/>    "kubernetes.io/role/elb" = 1</strong><br/>  }</span><span id="8753" class="nq lr iq nk b gy nv ns l nt nu">  map_public_ip_on_launch = true<br/>}</span><span id="5e80" class="nq lr iq nk b gy nv ns l nt nu"># Create IGW for the public subnets<br/>resource "aws_internet_gateway" "igw" {<br/>  vpc_id = "${aws_vpc.custom_vpc.id}"<br/>}</span><span id="8982" class="nq lr iq nk b gy nv ns l nt nu"># Route the public subnet traffic through the IGW<br/>resource "aws_route_table" "main" {<br/>  vpc_id = "${aws_vpc.custom_vpc.id}"</span><span id="bbd9" class="nq lr iq nk b gy nv ns l nt nu">route {<br/>    cidr_block = "0.0.0.0/0"<br/>    gateway_id = "${aws_internet_gateway.igw.id}"<br/>  }</span><span id="f56a" class="nq lr iq nk b gy nv ns l nt nu">tags = {<br/>    Name = "${var.route_table_tag_name}-${var.environment}"<br/>  }<br/>}</span><span id="3e91" class="nq lr iq nk b gy nv ns l nt nu"># Route table and subnet associations<br/>resource "aws_route_table_association" "internet_access" {<br/>  count = length(var.availability_zones)<br/>  subnet_id      = "${aws_subnet.public_subnet[count.index].id}"<br/>  route_table_id = "${aws_route_table.main.id}"<br/>}</span></pre><h1 id="fcdb" class="lq lr iq bd ls lt lu lv lw lx ly lz ma jw mb jx mc jz md ka me kc mf kd mg mh bi translated">ç½‘ç»œæ¨¡å¼é…ç½®</h1><p id="b52e" class="pw-post-body-paragraph kr ks iq kt b ku mn jr kw kx mo ju kz la mp lc ld le mq lg lh li mr lk ll lm ij bi translated">åœ¨åˆ›å»ºé›†ç¾¤ä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»è€ƒè™‘çš„å¦ä¸€ä¸ªé‡è¦çš„åˆæ­¥æ­¥éª¤æ˜¯å†³å®šç½‘ç»œæ¨¡å¼æˆ–ç«¯ç‚¹è®¿é—®æ§åˆ¶ã€‚æ‚¨å¯ä»¥é…ç½®ç«¯ç‚¹è®¿é—®æ§åˆ¶ï¼Œä»¥ç¡®å®šæ˜¯å¦å¯ä»¥é€šè¿‡äº’è”ç½‘(å…¬å…±è®¿é—®)ã€VPC(ç§æœ‰è®¿é—®)æˆ–ä¸¤è€…(å…¬å…±å’Œç§æœ‰è®¿é—®)è®¿é—®æ‚¨çš„ç¾¤é›†ã€‚å·¥ä½œèŠ‚ç‚¹å’Œè¢«ç®¡ç†çš„ Kubernetes æ§åˆ¶å¹³é¢ä¹‹é—´çš„é€šä¿¡ç”±ç½‘ç»œæ¨¡å¼é…ç½®å†³å®šã€‚é˜…è¯»<a class="ae ln" href="https://aws.amazon.com/blogs/containers/de-mystifying-cluster-networking-for-amazon-eks-worker-nodes/" rel="noopener ugc nofollow" target="_blank">è¿™ç¯‡æ–‡ç« </a>äº†è§£æ›´å¤šç»†èŠ‚ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°†é…ç½®æˆ‘ä»¬çš„é›†ç¾¤ç½‘ç»œï¼Œä½¿å…¶å…·æœ‰å…¬å…±å’Œç§æœ‰ç«¯ç‚¹è®¿é—®æ§åˆ¶ã€‚</p><p id="c63f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">äºšé©¬é€Š EKS ä»£è¡¨æ‚¨åˆ›å»ºäº†ä¸€ä¸ªäºšé©¬é€Š Route 53 <a class="ae ln" href="https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/hosted-zones-private.html" rel="noopener ugc nofollow" target="_blank">ç§æœ‰æ‰˜ç®¡åŒºåŸŸ</a>ï¼Œç„¶åä»…å°†è¯¥ç§æœ‰æ‰˜ç®¡åŒºåŸŸä¸æ‚¨é›†ç¾¤çš„ VPC ç›¸å…³è”ã€‚ç§äººæ‰˜ç®¡åŒºåŸŸç”±äºšé©¬é€Š EKS ç®¡ç†ï¼Œè¯¥åŒºåŸŸä¸ä¼šå‡ºç°åœ¨æ‚¨å¸æˆ·çš„ Route 53 èµ„æºä¸­ã€‚å› æ­¤ï¼Œè¯¥é…ç½®å°†å®ç°ä»¥ä¸‹åŠŸèƒ½:</p><ul class=""><li id="be8c" class="ms mt iq kt b ku kv kx ky la mu le mv li mw lm mx my mz na bi translated">é›†ç¾¤çš„ VPC ä¸­çš„ Kubernetes API è¯·æ±‚(æ¯”å¦‚ worker èŠ‚ç‚¹åˆ°æ§åˆ¶å¹³é¢çš„é€šä¿¡)ä½¿ç”¨ç§æœ‰çš„ VPC ç«¯ç‚¹ã€‚</li><li id="bcf3" class="ms mt iq kt b ku nb kx nc la nd le ne li nf lm mx my mz na bi translated">é›†ç¾¤ API æœåŠ¡å™¨å¯ä»¥é€šè¿‡äº’è”ç½‘è®¿é—®ã€‚</li></ul><h1 id="44c5" class="lq lr iq bd ls lt lu lv lw lx ly lz ma jw mb jx mc jz md ka me kc mf kd mg mh bi translated">VPC ç«¯ç‚¹</h1><p id="4bdb" class="pw-post-body-paragraph kr ks iq kt b ku mn jr kw kx mo ju kz la mp lc ld le mq lg lh li mr lk ll lm ij bi translated">ç”±äºæˆ‘ä»¬é€‰æ‹©äº†å…¬å…±å’Œç§æœ‰ç½‘ç»œæ¨¡å¼ï¼Œæˆ‘ä»¬çš„å·¥ä½œèŠ‚ç‚¹ä¸éœ€è¦å‡ºç«™äº’è”ç½‘è®¿é—®æ¥è¿›è¡Œé›†ç¾¤è‡ªæ£€æˆ–èŠ‚ç‚¹æ³¨å†Œã€‚é€šä¿¡é€šè¿‡æ‰˜ç®¡ EKS VPC æ¥å£ç«¯ç‚¹è¿›è¡Œã€‚ä¸€ä¸ª<a class="ae ln" href="https://docs.aws.amazon.com/vpc/latest/userguide/vpce-interface.html" rel="noopener ugc nofollow" target="_blank">æ¥å£ç«¯ç‚¹</a>æ˜¯ä¸€ä¸ªå¼¹æ€§ç½‘ç»œæ¥å£ï¼Œå…·æœ‰æ¥è‡ªæ‚¨çš„å­ç½‘ IP åœ°å€èŒƒå›´çš„ç§æœ‰ IP åœ°å€ï¼Œä½œä¸ºå»å¾€å—æ”¯æŒæœåŠ¡çš„æµé‡çš„å…¥å£ç‚¹ã€‚</p><p id="83fc" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">VPC ç«¯ç‚¹å…è®¸æ‚¨çš„ VPC å’Œ AWS æœåŠ¡ä¸­çš„å®ä¾‹ä¹‹é—´çš„é€šä¿¡ï¼Œè€Œä¸ä¼šå¯¹æ‚¨çš„ç½‘ç»œæµé‡å¸¦æ¥å¯ç”¨æ€§é£é™©æˆ–å¸¦å®½é™åˆ¶ã€‚åœ¨è¿™ç§è®¾ç½®ä¸‹ï¼Œè¿è¡Œåœ¨ç§æœ‰å­ç½‘ä¸­çš„å·¥ä½œèŠ‚ç‚¹è¿˜éœ€è¦è®¿é—®é™¤å—ç®¡ EKS æ§åˆ¶å¹³é¢ä¹‹å¤–çš„å…¶ä»– AWS æœåŠ¡ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ VPC ç«¯ç‚¹å°†æˆ‘ä»¬çš„ VPC ç§ä¸‹è¿æ¥åˆ°å…¶ä»– AWS æœåŠ¡ï¼Œå³ ECRã€EC2 å’Œ S3ã€‚</p><p id="8ff8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">æˆ‘ä»¬å°†ä¸ºä»¥ä¸‹æœåŠ¡è®¾ç½® VPC ç«¯ç‚¹:</p><ul class=""><li id="0cb1" class="ms mt iq kt b ku kv kx ky la mu le mv li mw lm mx my mz na bi translated">AWS PrivateLink endpoint for ECR â€”è¿™å…è®¸ VPC ä¸­çš„å®ä¾‹è¿›è¡Œèº«ä»½éªŒè¯å¹¶ä¸ ECR é€šä¿¡ï¼Œä»¥ä¸‹è½½æ˜ åƒæ¸…å•</li><li id="d842" class="ms mt iq kt b ku nb kx nc la nd le ne li nf lm mx my mz na bi translated">äºšé©¬é€Š S3 çš„ç½‘å…³ VPC ç«¯ç‚¹-è¿™å…è®¸å®ä¾‹ä»æ‰˜ç®¡å®ƒä»¬çš„åº•å±‚ç§æœ‰<a class="ae ln" href="https://aws.amazon.com/s3/" rel="noopener ugc nofollow" target="_blank">äºšé©¬é€Š S3 </a>æ¡¶ä¸‹è½½å›¾åƒå±‚ã€‚</li><li id="407f" class="ms mt iq kt b ku nb kx nc la nd le ne li nf lm mx my mz na bi translated">EC2 çš„ AWS ä¸“ç”¨é“¾æ¥ç«¯ç‚¹</li></ul><pre class="kg kh ki kj gt nm nk nn no aw np bi"><span id="38c6" class="nq lr iq nk b gy nr ns l nt nu"># ECR<br/>resource "aws_vpc_endpoint" "ecr_dkr" {<br/>  vpc_id       = "${aws_vpc.custom_vpc.id}"<br/>  service_name = "com.amazonaws.${var.region}.ecr.dkr"<br/>  vpc_endpoint_type = "Interface"<br/>  private_dns_enabled = true<br/>  subnet_ids          = flatten([["${aws_subnet.private_subnet.id}"], aws_subnet.public_subnet.*.id])</span><span id="1ae0" class="nq lr iq nk b gy nv ns l nt nu">security_group_ids = [aws_security_group.endpoint_ecr.id]</span><span id="fc19" class="nq lr iq nk b gy nv ns l nt nu">tags = {<br/>    Name = "ECR Docker VPC Endpoint Interface - ${var.environment}"<br/>    Environment = var.environment<br/>  }<br/>}</span><span id="8201" class="nq lr iq nk b gy nv ns l nt nu">resource "aws_vpc_endpoint" "ecr_api" {<br/>  vpc_id       = "${aws_vpc.custom_vpc.id}"<br/>  service_name = "com.amazonaws.${var.region}.ecr.api"<br/>  vpc_endpoint_type = "Interface"<br/>  private_dns_enabled = true<br/>  subnet_ids          = flatten([["${aws_subnet.private_subnet.id}"], aws_subnet.public_subnet.*.id])</span><span id="6e62" class="nq lr iq nk b gy nv ns l nt nu">security_group_ids = [aws_security_group.endpoint_ecr.id]</span><span id="8c47" class="nq lr iq nk b gy nv ns l nt nu">tags = {<br/>    Name = "ECR API VPC Endpoint Interface - ${var.environment}"<br/>    Environment = var.environment<br/>  }<br/>}</span><span id="a5da" class="nq lr iq nk b gy nv ns l nt nu"># EC2<br/>resource "aws_vpc_endpoint" "ec2" {<br/>  vpc_id       = "${aws_vpc.custom_vpc.id}"<br/>  service_name = "com.amazonaws.${var.region}.ec2"<br/>  vpc_endpoint_type = "Interface"<br/>  private_dns_enabled = true<br/>  subnet_ids          = flatten([["${aws_subnet.private_subnet.id}"], aws_subnet.public_subnet.*.id])</span><span id="161c" class="nq lr iq nk b gy nv ns l nt nu">security_group_ids = [aws_security_group.endpoint_ec2.id]</span><span id="b367" class="nq lr iq nk b gy nv ns l nt nu">tags = {<br/>    Name = "EC2 VPC Endpoint Interface - ${var.environment}"<br/>    Environment = var.environment<br/>  }<br/>}</span><span id="1a9b" class="nq lr iq nk b gy nv ns l nt nu"># S3<br/>resource "aws_vpc_endpoint" "s3" {<br/>  vpc_id       = "${aws_vpc.custom_vpc.id}"<br/>  service_name = "com.amazonaws.${var.region}.s3"<br/>  vpc_endpoint_type = "Gateway"<br/>  route_table_ids = [var.main_pvt_route_table_id]</span><span id="d7d4" class="nq lr iq nk b gy nv ns l nt nu">tags = {<br/>    Name = "S3 VPC Endpoint Gateway - ${var.environment}"<br/>    Environment = var.environment<br/>  }<br/>}</span></pre><h1 id="3352" class="lq lr iq bd ls lt lu lv lw lx ly lz ma jw mb jx mc jz md ka me kc mf kd mg mh bi translated">VPC ç«¯ç‚¹å®‰å…¨ç»„</h1><p id="f50c" class="pw-post-body-paragraph kr ks iq kt b ku mn jr kw kx mo ju kz la mp lc ld le mq lg lh li mr lk ll lm ij bi translated">æˆ‘ä»¬è¿˜æƒ³åˆ›å»ºå®‰å…¨ç»„ï¼Œå¹¶å°†å®ƒä»¬é™„åŠ åˆ°æˆ‘ä»¬çš„ VPC ç«¯ç‚¹æ¥å£ç»„ä»¶ã€‚æˆ‘ä»¬å¸Œæœ›å…è®¸ VPC ç«¯ç‚¹ç½‘ç»œæ¥å£å’Œ VPC ä¸­ä¸å…¶ä»– AWS æœåŠ¡é€šä¿¡çš„èµ„æºä¹‹é—´çš„é€šä¿¡ã€‚</p><pre class="kg kh ki kj gt nm nk nn no aw np bi"><span id="b796" class="nq lr iq nk b gy nr ns l nt nu"># EC2 VPC Endpoint security groups<br/>resource "aws_security_group" "endpoint_ec2" {<br/>  name   = "endpoint-ec2-sg"<br/>  vpc_id = aws_vpc.custom_vpc.id<br/>}</span><span id="c80f" class="nq lr iq nk b gy nv ns l nt nu">resource "aws_security_group_rule" "endpoint_ec2_443" {<br/>  security_group_id = aws_security_group.endpoint_ec2.id<br/>  type              = "ingress"<br/>  from_port         = 443<br/>  to_port           = 443<br/>  protocol          = "tcp"<br/>  cidr_blocks = flatten([[var.private_subnet_cidr_block], var.public_subnet_cidr_blocks])<br/>}</span><span id="cd4f" class="nq lr iq nk b gy nv ns l nt nu"># ECR VPC Endpoint security groups<br/>resource "aws_security_group" "endpoint_ecr" {<br/>  name   = "endpoint-ecr-sg"<br/>  vpc_id = aws_vpc.custom_vpc.id<br/>}</span><span id="c014" class="nq lr iq nk b gy nv ns l nt nu">resource "aws_security_group_rule" "endpoint_ecr_443" {<br/>  security_group_id = aws_security_group.endpoint_ecr.id<br/>  type              = "ingress"<br/>  from_port         = 443<br/>  to_port           = 443<br/>  protocol          = "tcp"<br/>  cidr_blocks = flatten([[var.private_subnet_cidr_block], var.public_subnet_cidr_blocks])<br/>}</span></pre><h1 id="d904" class="lq lr iq bd ls lt lu lv lw lx ly lz ma jw mb jx mc jz md ka me kc mf kd mg mh bi translated">åˆ›å»º EKS é›†ç¾¤</h1><p id="43f0" class="pw-post-body-paragraph kr ks iq kt b ku mn jr kw kx mo ju kz la mp lc ld le mq lg lh li mr lk ll lm ij bi translated">æˆ‘ä»¬æ­£è¿›å…¥æˆ‘ä»¬è®¡åˆ’è¦åšçš„æ ¸å¿ƒé˜¶æ®µã€‚åœ¨åˆ›å»ºé›†ç¾¤ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªå…·æœ‰ç‰¹å®š IAM ç­–ç•¥çš„ IAM è§’è‰²ï¼Œå› ä¸ºç”± Amazon EKS ç®¡ç†çš„ Kubernetes é›†ç¾¤ä»£è¡¨æˆ‘ä»¬è°ƒç”¨å…¶ä»– AWS æœåŠ¡æ¥ç®¡ç†æœåŠ¡ä½¿ç”¨çš„èµ„æºã€‚å› æ­¤å®ƒéœ€è¦æ­£ç¡®çš„æƒé™æ¥æˆåŠŸæ‰§è¡Œè¿™äº›è°ƒç”¨ã€‚</p><p id="9c34" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">ä¹‹åï¼Œä¸€æ—¦åˆ›å»ºäº†è§’è‰²ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç»§ç»­åˆ›å»ºé›†ç¾¤ã€‚ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦ä¸ºæ§åˆ¶å¹³é¢å’Œå·¥ä½œèŠ‚ç‚¹ç»„åˆ›å»ºå®‰å…¨ç»„ï¼Œä»¥å…è®¸é›†ç¾¤çš„ Kubernetes æ§åˆ¶å¹³é¢å’Œå·¥ä½œèŠ‚ç‚¹ç»„ä¹‹é—´çš„é€šä¿¡ã€‚</p><p id="7a76" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">äºšé©¬é€Š EKS <a class="ae ln" href="https://docs.aws.amazon.com/eks/latest/userguide/managed-node-groups.html" rel="noopener ugc nofollow" target="_blank">æ‰˜ç®¡èŠ‚ç‚¹ç»„</a>è‡ªåŠ¨é…ç½®ä¸ºä½¿ç”¨é›†ç¾¤å®‰å…¨ç»„ï¼Œä½†æ‚¨å¯ä»¥é™åˆ¶é›†ç¾¤æµé‡ï¼Œå¹¶é™åˆ¶æ§åˆ¶å¹³é¢å’Œå·¥ä½œèŠ‚ç‚¹ä¹‹é—´çš„å¼€æ”¾ç«¯å£ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬å°†è¦åšçš„ã€‚</p><p id="d4b9" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">å› æ­¤ï¼Œåœ¨è¿™ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä»¥ä¸‹å†…å®¹:</p><ul class=""><li id="0f8f" class="ms mt iq kt b ku kv kx ky la mu le mv li mw lm mx my mz na bi translated">EKS é›†ç¾¤ IAM è§’è‰²</li><li id="7aef" class="ms mt iq kt b ku nb kx nc la nd le ne li nf lm mx my mz na bi translated">EKS é›†ç¾¤</li><li id="2148" class="ms mt iq kt b ku nb kx nc la nd le ne li nf lm mx my mz na bi translated">EKS é›†ç¾¤å’Œå·¥ä½œèŠ‚ç‚¹å®‰å…¨ç»„</li></ul><h2 id="8f3a" class="nq lr iq bd ls nw nx dn lw ny nz dp ma la oa ob mc le oc od me li oe of mg og bi translated">EKS é›†ç¾¤ IAM è§’è‰²</h2><pre class="kg kh ki kj gt nm nk nn no aw np bi"><span id="4c16" class="nq lr iq nk b gy nr ns l nt nu">resource "aws_iam_role" "eks_cluster" {<br/>  name = "${var.eks_cluster_name}-cluster-${var.environment}"</span><span id="b17f" class="nq lr iq nk b gy nv ns l nt nu">assume_role_policy = &lt;&lt;POLICY<br/>{<br/>  "Version": "2012-10-17",<br/>  "Statement": [<br/>    {<br/>      "Effect": "Allow",<br/>      "Principal": {<br/>        "Service": "eks.amazonaws.com"<br/>      },<br/>      "Action": "sts:AssumeRole"<br/>    }<br/>  ]<br/>}<br/>POLICY<br/>}</span><span id="0d5a" class="nq lr iq nk b gy nv ns l nt nu">resource "aws_iam_role_policy_attachment" "aws_eks_cluster_policy" {<br/>  policy_arn = "arn:aws:iam::aws:policy/AmazonEKSClusterPolicy"<br/>  role       = "${aws_iam_role.eks_cluster.name}"<br/>}</span><span id="aec7" class="nq lr iq nk b gy nv ns l nt nu">resource "aws_iam_role_policy_attachment" "aws_eks_service_policy" {<br/>  policy_arn = "arn:aws:iam::aws:policy/AmazonEKSServicePolicy"<br/>  role       = "${aws_iam_role.eks_cluster.name}"<br/>}</span></pre><h2 id="f81c" class="nq lr iq bd ls nw nx dn lw ny nz dp ma la oa ob mc le oc od me li oe of mg og bi translated">EKS é›†ç¾¤</h2><pre class="kg kh ki kj gt nm nk nn no aw np bi"><span id="ec82" class="nq lr iq nk b gy nr ns l nt nu">resource "aws_eks_cluster" "main" {<br/>  name     = var.eks_cluster_name<br/>  role_arn = "${aws_iam_role.eks_cluster.arn}"</span><span id="c391" class="nq lr iq nk b gy nv ns l nt nu">vpc_config {<br/>    security_group_ids      = [aws_security_group.eks_cluster.id, aws_security_group.eks_nodes.id]<br/>    endpoint_private_access = var.endpoint_private_access<br/>    endpoint_public_access  = var.endpoint_public_access<br/>    subnet_ids = var.eks_cluster_subnet_ids<br/>  }</span><span id="8314" class="nq lr iq nk b gy nv ns l nt nu"># Ensure that IAM Role permissions are created before and deleted after EKS Cluster handling.<br/>  # Otherwise, EKS will not be able to properly delete EKS managed EC2 infrastructure such as Security Groups.<br/>  depends_on = [<br/>    "aws_iam_role_policy_attachment.aws_eks_cluster_policy",<br/>    "aws_iam_role_policy_attachment.aws_eks_service_policy"<br/>  ]<br/>}</span></pre><h2 id="7203" class="nq lr iq bd ls nw nx dn lw ny nz dp ma la oa ob mc le oc od me li oe of mg og bi translated">EKS é›†ç¾¤å®‰å…¨ç»„</h2><pre class="kg kh ki kj gt nm nk nn no aw np bi"><span id="2f90" class="nq lr iq nk b gy nr ns l nt nu">resource "aws_security_group" "eks_cluster" {<br/>  name        = var.cluster_sg_name<br/>  description = "Cluster communication with worker nodes"<br/>  vpc_id      = var.vpc_id</span><span id="f952" class="nq lr iq nk b gy nv ns l nt nu">tags = {<br/>    Name = var.cluster_sg_name<br/>  }<br/>}</span><span id="e3f8" class="nq lr iq nk b gy nv ns l nt nu">resource "aws_security_group_rule" "cluster_inbound" {<br/>  description              = "Allow worker nodes to communicate with the cluster API Server"<br/>  from_port                = 443<br/>  protocol                 = "tcp"<br/>  security_group_id        = aws_security_group.eks_cluster.id<br/>  source_security_group_id = aws_security_group.eks_nodes.id<br/>  to_port                  = 443<br/>  type                     = "ingress"<br/>}</span><span id="2a51" class="nq lr iq nk b gy nv ns l nt nu">resource "aws_security_group_rule" "cluster_outbound" {<br/>  description              = "Allow cluster API Server to communicate with the worker nodes"<br/>  from_port                = 1024<br/>  protocol                 = "tcp"<br/>  security_group_id        = aws_security_group.eks_cluster.id<br/>  source_security_group_id = aws_security_group.eks_nodes.id<br/>  to_port                  = 65535<br/>  type                     = "egress"<br/>}</span></pre><h2 id="b7eb" class="nq lr iq bd ls nw nx dn lw ny nz dp ma la oa ob mc le oc od me li oe of mg og bi translated">EKS å·¥ä½œèŠ‚ç‚¹ç»„å®‰å…¨ç»„</h2><pre class="kg kh ki kj gt nm nk nn no aw np bi"><span id="7734" class="nq lr iq nk b gy nr ns l nt nu">resource "aws_security_group" "eks_nodes" {<br/>  name        = var.nodes_sg_name<br/>  description = "Security group for all nodes in the cluster"<br/>  vpc_id      = var.vpc_id</span><span id="1614" class="nq lr iq nk b gy nv ns l nt nu">egress {<br/>    from_port   = 0<br/>    to_port     = 0<br/>    protocol    = "-1"<br/>    cidr_blocks = ["0.0.0.0/0"]<br/>  }</span><span id="a0b7" class="nq lr iq nk b gy nv ns l nt nu">tags = {<br/>    Name                                        = var.nodes_sg_name<br/>    "kubernetes.io/cluster/${var.eks_cluster_name}" = "owned"<br/>  }<br/>}</span><span id="3bbf" class="nq lr iq nk b gy nv ns l nt nu">resource "aws_security_group_rule" "nodes" {<br/>  description              = "Allow nodes to communicate with each other"<br/>  from_port                = 0<br/>  protocol                 = "-1"<br/>  security_group_id        = aws_security_group.eks_nodes.id<br/>  source_security_group_id = aws_security_group.eks_nodes.id<br/>  to_port                  = 65535<br/>  type                     = "ingress"<br/>}</span><span id="3342" class="nq lr iq nk b gy nv ns l nt nu">resource "aws_security_group_rule" "nodes_inbound" {<br/>  description              = "Allow worker Kubelets and pods to receive communication from the cluster control plane"<br/>  from_port                = 1025<br/>  protocol                 = "tcp"<br/>  security_group_id        = aws_security_group.eks_nodes.id<br/>  source_security_group_id = aws_security_group.eks_cluster.id<br/>  to_port                  = 65535<br/>  type                     = "ingress"<br/>}</span></pre><h1 id="959b" class="lq lr iq bd ls lt lu lv lw lx ly lz ma jw mb jx mc jz md ka me kc mf kd mg mh bi translated">åˆ›å»ºå·¥ä½œèŠ‚ç‚¹ç»„</h1><p id="98b1" class="pw-post-body-paragraph kr ks iq kt b ku mn jr kw kx mo ju kz la mp lc ld le mq lg lh li mr lk ll lm ij bi translated">ä¸åˆ›å»ºé›†ç¾¤ç±»ä¼¼ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦ä¸ºé™„åŠ äº†ç‰¹å®š IAM ç­–ç•¥çš„å·¥ä½œèŠ‚ç‚¹åˆ›å»ºä¸€ä¸ª IAM è§’è‰²ï¼Œç„¶åæ‰èƒ½å¯åŠ¨ä½¿ç”¨å®ƒä»¬ã€‚è¿™ç§ç‰¹æ®Šæƒ…å†µä¸‹çš„åŸå› æ˜¯ä»€ä¹ˆï¼Ÿworker èŠ‚ç‚¹ä¸Šçš„å®ˆæŠ¤è¿›ç¨‹ kubelet ä»£è¡¨æˆ‘ä»¬è°ƒç”¨ AWS APIsï¼ŒèŠ‚ç‚¹éœ€è¦è¿™ä¸ªè§’è‰²å’Œå¿…è¦çš„ç­–ç•¥æ¥æ‹¥æœ‰è¿™äº› API è°ƒç”¨çš„æ­£ç¡®æƒé™ã€‚</p><p id="4373" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä»¥ä¸‹å†…å®¹:</p><ul class=""><li id="0c9d" class="ms mt iq kt b ku kv kx ky la mu le mv li mw lm mx my mz na bi translated">å·¥ä½œèŠ‚ç‚¹ç»„ IAM è§’è‰²</li><li id="6956" class="ms mt iq kt b ku nb kx nc la nd le ne li nf lm mx my mz na bi translated">å…¬å…±å’Œç§æœ‰å­ç½‘çš„å·¥ä½œèŠ‚ç‚¹ç»„</li></ul><h2 id="cec4" class="nq lr iq bd ls nw nx dn lw ny nz dp ma la oa ob mc le oc od me li oe of mg og bi translated">å·¥ä½œèŠ‚ç‚¹ç»„ IAM è§’è‰²</h2><pre class="kg kh ki kj gt nm nk nn no aw np bi"><span id="d51e" class="nq lr iq nk b gy nr ns l nt nu">resource "aws_iam_role" "eks_nodes" {<br/>  name                 = "${var.eks_cluster_name}-worker-${var.environment}"</span><span id="eb6c" class="nq lr iq nk b gy nv ns l nt nu">assume_role_policy = data.aws_iam_policy_document.assume_workers.json<br/>}</span><span id="3390" class="nq lr iq nk b gy nv ns l nt nu">data "aws_iam_policy_document" "assume_workers" {<br/>  statement {<br/>    effect = "Allow"</span><span id="fe6f" class="nq lr iq nk b gy nv ns l nt nu">actions = ["sts:AssumeRole"]</span><span id="e327" class="nq lr iq nk b gy nv ns l nt nu">principals {<br/>      type        = "Service"<br/>      identifiers = ["ec2.amazonaws.com"]<br/>    }<br/>  }<br/>}</span><span id="e0be" class="nq lr iq nk b gy nv ns l nt nu">resource "aws_iam_role_policy_attachment" "aws_eks_worker_node_policy" {<br/>  policy_arn = "arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy"<br/>  role       = aws_iam_role.eks_nodes.name<br/>}</span><span id="a6b5" class="nq lr iq nk b gy nv ns l nt nu">resource "aws_iam_role_policy_attachment" "aws_eks_cni_policy" {<br/>  policy_arn = "arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy"<br/>  role       = aws_iam_role.eks_nodes.name<br/>}</span><span id="dfc5" class="nq lr iq nk b gy nv ns l nt nu">resource "aws_iam_role_policy_attachment" "ec2_read_only" {<br/>  policy_arn = "arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly"<br/>  role       = aws_iam_role.eks_nodes.name<br/>}</span><span id="58ca" class="nq lr iq nk b gy nv ns l nt nu">resource "aws_iam_role_policy_attachment" "cluster_autoscaler" {<br/>  policy_arn = aws_iam_policy.cluster_autoscaler_policy.arn<br/>  role = aws_iam_role.eks_nodes.name<br/>}</span><span id="a870" class="nq lr iq nk b gy nv ns l nt nu">resource "aws_iam_policy" "cluster_autoscaler_policy" {<br/>  name        = "ClusterAutoScaler"<br/>  description = "Give the worker node running the Cluster Autoscaler access to required resources and actions"</span><span id="d53c" class="nq lr iq nk b gy nv ns l nt nu">policy = &lt;&lt;EOF<br/>{<br/>    "Version": "2012-10-17",<br/>    "Statement": [<br/>        {<br/>            "Effect": "Allow",<br/>            "Action": [<br/>                "autoscaling:DescribeAutoScalingGroups",<br/>                "autoscaling:DescribeAutoScalingInstances",<br/>                "autoscaling:DescribeLaunchConfigurations",<br/>                "autoscaling:DescribeTags",<br/>                "autoscaling:SetDesiredCapacity",<br/>                "autoscaling:TerminateInstanceInAutoScalingGroup"<br/>            ],<br/>            "Resource": "*"<br/>        }<br/>    ]<br/>}<br/>EOF<br/>}</span></pre><h2 id="4b9b" class="nq lr iq bd ls nw nx dn lw ny nz dp ma la oa ob mc le oc od me li oe of mg og bi translated">å…¬å…±å’Œç§æœ‰å­ç½‘çš„å·¥ä½œèŠ‚ç‚¹ç»„</h2><pre class="kg kh ki kj gt nm nk nn no aw np bi"><span id="e31d" class="nq lr iq nk b gy nr ns l nt nu"># Nodes in private subnets<br/>resource "aws_eks_node_group" "main" {<br/>  cluster_name    = aws_eks_cluster.main.name<br/>  node_group_name = var.node_group_name<br/>  node_role_arn   = aws_iam_role.eks_nodes.arn<br/>  subnet_ids      = var.private_subnet_ids</span><span id="f10a" class="nq lr iq nk b gy nv ns l nt nu">ami_type       = var.ami_type<br/>  disk_size      = var.disk_size<br/>  instance_types = var.instance_types</span><span id="12a7" class="nq lr iq nk b gy nv ns l nt nu">scaling_config {<br/>    desired_size = var.pvt_desired_size<br/>    max_size     = var.pvt_max_size<br/>    min_size     = var.pvt_min_size<br/>  }</span><span id="10b4" class="nq lr iq nk b gy nv ns l nt nu">tags = {<br/>    Name = var.node_group_name<br/>  }</span><span id="988d" class="nq lr iq nk b gy nv ns l nt nu"># Ensure that IAM Role permissions are created before and deleted after EKS Node Group handling.<br/>  # Otherwise, EKS will not be able to properly delete EC2 Instances and Elastic Network Interfaces.<br/>  depends_on = [<br/>    aws_iam_role_policy_attachment.aws_eks_worker_node_policy,<br/>    aws_iam_role_policy_attachment.aws_eks_cni_policy,<br/>    aws_iam_role_policy_attachment.ec2_read_only,<br/>  ]<br/>}</span><span id="4a7a" class="nq lr iq nk b gy nv ns l nt nu"># Nodes in public subnet<br/>resource "aws_eks_node_group" "public" {<br/>  cluster_name    = aws_eks_cluster.main.name<br/>  node_group_name = "${var.node_group_name}-public"<br/>  node_role_arn   = aws_iam_role.eks_nodes.arn<br/>  subnet_ids      = var.public_subnet_ids</span><span id="f2bd" class="nq lr iq nk b gy nv ns l nt nu">ami_type       = var.ami_type<br/>  disk_size      = var.disk_size<br/>  instance_types = var.instance_types</span><span id="0a7e" class="nq lr iq nk b gy nv ns l nt nu">scaling_config {<br/>    desired_size = var.pblc_desired_size<br/>    max_size     = var.pblc_max_size<br/>    min_size     = var.pblc_min_size<br/>  }</span><span id="75e9" class="nq lr iq nk b gy nv ns l nt nu">tags = {<br/>    Name = "${var.node_group_name}-public"<br/>  }</span><span id="360f" class="nq lr iq nk b gy nv ns l nt nu"># Ensure that IAM Role permissions are created before and deleted after EKS Node Group handling.<br/>  # Otherwise, EKS will not be able to properly delete EC2 Instances and Elastic Network Interfaces.<br/>  depends_on = [<br/>    aws_iam_role_policy_attachment.aws_eks_worker_node_policy,<br/>    aws_iam_role_policy_attachment.aws_eks_cni_policy,<br/>    aws_iam_role_policy_attachment.ec2_read_only,<br/>  ]<br/>}</span></pre><h1 id="3676" class="lq lr iq bd ls lt lu lv lw lx ly lz ma jw mb jx mc jz md ka me kc mf kd mg mh bi translated">éƒ¨ç½²å’Œå±•ç¤º Pod</h1><p id="7e2e" class="pw-post-body-paragraph kr ks iq kt b ku mn jr kw kx mo ju kz la mp lc ld le mq lg lh li mr lk ll lm ij bi translated">å‡è®¾æ‚¨å·²ç»è¿è¡Œäº†<code class="fe nh ni nj nk b">terragrunt apply</code>æˆ–<code class="fe nh ni nj nk b">terraform apply</code>,å¹¶ä¸”æ‚¨çš„é›†ç¾¤å·²æˆåŠŸåˆ›å»ºï¼ŒèŠ‚ç‚¹ç»„ä¹Ÿå·²æ³¨å†Œåˆ°é›†ç¾¤ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç°åœ¨å¯ä»¥è¿›å…¥ä¸‹ä¸€æ­¥ï¼Œåœ¨é›†ç¾¤ä¸Šæµ‹è¯•åº”ç”¨ç¨‹åºã€‚ä¸ºäº†ä¸æˆ‘çš„é›†ç¾¤é€šä¿¡ï¼Œæˆ‘å°†ä½¿ç”¨ kubectlã€‚ç¬¬ä¸€æ­¥æ˜¯ä¸ºæˆ‘ä»¬çš„å®¹å™¨åˆ›å»ºä¸€ä¸ª Pod æ¥è¿è¡Œï¼Œç„¶åä½¿ç”¨ä¸€ä¸ªæœåŠ¡æ¥å…¬å¼€(è®©å…¬ä¼—å¯ä»¥è®¿é—®)è¿™ä¸ªå®¹å™¨åŒ–çš„åº”ç”¨ç¨‹åºã€‚</p><p id="234e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">åŠèˆ±â€”â€”éƒ¨ç½²çš„åŸºæœ¬å•ä½ï¼›å®ƒä»£è¡¨ä¸€ä¸ªè®¡åˆ’å•å…ƒçš„è¿è¡Œè¿›ç¨‹ï¼Œæ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªç»„åˆåœ¨ä¸€èµ·çš„å®¹å™¨çš„åŒ…è£…ã€‚æ¯ä¸ª pod éƒ½åˆ†é…æœ‰ä¸€ä¸ªå”¯ä¸€çš„ IP åœ°å€ï¼Œå¹¶ä¸”å¯ä»¥å…¬å¼€ç«¯å£ã€‚æ ‡ç­¾ç”¨äºä»é€»è¾‘ä¸Šè¯†åˆ«ç¬¦åˆæ ‡å‡†çš„ pod</p><p id="55e4" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">æœåŠ¡â€”â€”æœåŠ¡æ˜¯ä¸€ç»„ pod ä¹‹ä¸Šçš„æŠ½è±¡å¯¹è±¡ï¼Œå°±åƒè´Ÿè½½å¹³è¡¡å™¨ä¸€æ ·ã€‚å®ƒä»¬ä»¥å¾ªç¯æ–¹å¼å°†æµé‡è·¯ç”±åˆ° podã€‚æœ‰ä¸‰ç§ç±»å‹çš„æœåŠ¡:</p><ul class=""><li id="2975" class="ms mt iq kt b ku kv kx ky la mu le mv li mw lm mx my mz na bi translated">ClusterIP â€”åªèƒ½ä»é›†ç¾¤å†…éƒ¨è®¿é—®ã€‚</li><li id="f773" class="ms mt iq kt b ku nb kx nc la nd le ne li nf lm mx my mz na bi translated">è´Ÿè½½å¹³è¡¡å™¨â€”å°† pod æš´éœ²ç»™å¤–éƒ¨å®¢æˆ·ç«¯æµé‡ã€‚æš´éœ²åœ¨å¤–éƒ¨è´Ÿè½½å¹³è¡¡å™¨ä¸Šã€‚</li><li id="cffc" class="ms mt iq kt b ku nb kx nc la nd le ne li nf lm mx my mz na bi translated">èŠ‚ç‚¹ç«¯å£â€”å¯ä»å…¬å¼€çš„èŠ‚ç‚¹ç«¯å£è®¿é—®ã€‚</li></ul><h2 id="08bd" class="nq lr iq bd ls nw nx dn lw ny nz dp ma la oa ob mc le oc od me li oe of mg og bi translated">è¿æ¥åˆ° EKS é›†ç¾¤</h2><p id="4eb0" class="pw-post-body-paragraph kr ks iq kt b ku mn jr kw kx mo ju kz la mp lc ld le mq lg lh li mr lk ll lm ij bi translated">ç¡®ä¿æ‚¨å·²ç»å®‰è£…äº†æ­£ç¡®ç‰ˆæœ¬çš„ AWS CLIã€‚æ‚¨å¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤è¿›è¡Œæ£€æŸ¥:</p><pre class="kg kh ki kj gt nm nk nn no aw np bi"><span id="e368" class="nq lr iq nk b gy nr ns l nt nu">aws --version</span></pre><p id="0ab2" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">å‡è®¾æ‚¨å·²ç»å®‰è£…äº† AWS CLI å’Œ kubectlï¼Œé‚£ä¹ˆæ‚¨å¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥ç¡®ä¿æ‚¨å·²ç»è·å¾—äº†æ­£ç¡®çš„ AWS æ¦‚è¦æ–‡ä»¶ï¼Œå¹¶é…ç½®äº†å¿…è¦çš„æƒé™:</p><pre class="kg kh ki kj gt nm nk nn no aw np bi"><span id="4c50" class="nq lr iq nk b gy nr ns l nt nu"> aws sts get-caller-identity</span></pre><p id="60ac" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">è¦ä¸ºé›†ç¾¤åˆ›å»ºæˆ–æ›´æ–° kubeconfig æ–‡ä»¶ï¼Œè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤:</p><pre class="kg kh ki kj gt nm nk nn no aw np bi"><span id="2524" class="nq lr iq nk b gy nr ns l nt nu">aws eks --region region update-kubeconfig --name <strong class="nk ir">your-cluster-name</strong></span></pre><p id="f38a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">æ‚¨åº”è¯¥å·²ç»å‡†å¤‡å¥½è°ƒç”¨é›†ç¾¤çš„å…¬å…± API ç«¯ç‚¹äº†ã€‚å¦‚æœä½ æ„¿æ„ï¼Œä½ å¯ä»¥åœ¨è¿™é‡Œé˜…è¯»æ›´å¤šå…³äºç®¡ç†é›†ç¾¤è®¤è¯<a class="ae ln" href="https://docs.aws.amazon.com/eks/latest/userguide/managing-auth.html" rel="noopener ugc nofollow" target="_blank">çš„ä¿¡æ¯ã€‚è¿è¡Œä»¥ä¸‹å‘½ä»¤æ£€æŸ¥å½“å‰æ­£åœ¨è¿è¡Œçš„å·¥ä½œèŠ‚ç‚¹:</a></p><pre class="kg kh ki kj gt nm nk nn no aw np bi"><span id="1ff8" class="nq lr iq nk b gy nr ns l nt nu">kubectl get nodes</span></pre><h2 id="90f2" class="nq lr iq bd ls nw nx dn lw ny nz dp ma la oa ob mc le oc od me li oe of mg og bi translated">æ ‡ç­¾èŠ‚ç‚¹</h2><p id="de53" class="pw-post-body-paragraph kr ks iq kt b ku mn jr kw kx mo ju kz la mp lc ld le mq lg lh li mr lk ll lm ij bi translated">æˆ‘æƒ³å°†æˆ‘çš„ Pod ä¸“é—¨åˆ†é…ç»™åœ¨ä¸“ç”¨å­ç½‘ä¸­è¿è¡Œçš„èŠ‚ç‚¹ã€‚æ ‡ç­¾åªæ˜¯ä¸€ä¸ªé”®/å€¼å¯¹ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ ‡è®°èŠ‚ç‚¹:</p><pre class="kg kh ki kj gt nm nk nn no aw np bi"><span id="83ab" class="nq lr iq nk b gy nr ns l nt nu">kubectl label nodes <strong class="nk ir">&lt;your-node-name&gt;</strong> nodeType=privateNode</span></pre><p id="6943" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">ä¸ºç¡®ä¿æˆåŠŸæ ‡è®°èŠ‚ç‚¹ï¼Œæ‚¨å¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥æ£€æŸ¥æ¯ä¸ªèŠ‚ç‚¹çš„æ ‡ç­¾:</p><pre class="kg kh ki kj gt nm nk nn no aw np bi"><span id="9c5e" class="nq lr iq nk b gy nr ns l nt nu">kubectl get nodes --show-labels</span></pre><p id="bbce" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">æˆ–è€…ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹æ‚¨æ ‡è®°çš„ç‰¹å®šèŠ‚ç‚¹çš„è¯¦ç»†ä¿¡æ¯:</p><pre class="kg kh ki kj gt nm nk nn no aw np bi"><span id="4f54" class="nq lr iq nk b gy nr ns l nt nu">kubectl describe node <strong class="nk ir">&lt;your-node-name&gt;</strong></span></pre><p id="9f96" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">ä¸ºäº†ç»‘å®šåˆ°è¿™äº›èŠ‚ç‚¹ï¼Œæˆ‘ä»¬å°†åˆ©ç”¨<code class="fe nh ni nj nk b">nodeSelector</code>ï¼Œè¿™æ˜¯æ¨èçš„æœ€ç®€å•çš„èŠ‚ç‚¹é€‰æ‹©çº¦æŸå½¢å¼ã€‚<code class="fe nh ni nj nk b">nodeSelector</code>æ˜¯ PodSpec çš„ä¸€ä¸ªå­—æ®µã€‚</p><h2 id="fafb" class="nq lr iq bd ls nw nx dn lw ny nz dp ma la oa ob mc le oc od me li oe of mg og bi translated">åˆ›å»º Pod å’ŒæœåŠ¡</h2><p id="4166" class="pw-post-body-paragraph kr ks iq kt b ku mn jr kw kx mo ju kz la mp lc ld le mq lg lh li mr lk ll lm ij bi translated">æ¥ä¸‹æ¥ï¼Œæˆ‘å°†ä½¿ç”¨ä» ECR å­˜å‚¨åº“ä¸­çš„æ˜ åƒæ„å»ºçš„å®¹å™¨åˆ›å»ºä¸€ä¸ª podã€‚ä¸‹é¢æ˜¯æ­£åœ¨åˆ›å»ºçš„ pod çš„æ¸…å•æ–‡ä»¶ï¼Œä»¥åŠå°†å…¬å¼€å®ƒçš„æœåŠ¡ã€‚</p><p id="eedf" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">åŠèˆ±</strong></p><pre class="kg kh ki kj gt nm nk nn no aw np bi"><span id="f992" class="nq lr iq nk b gy nr ns l nt nu">apiVersion: v1<br/>kind: Pod<br/>metadata:<br/>  name: nodejs-express-pod<br/>  labels:<br/>    app: nodejs-express<br/>spec:<br/>  containers:<br/>  - name: nodejs-express-container<br/>    image: <strong class="nk ir">&lt;image&gt;</strong><br/>    ports:<br/>      - containerPort: 8080<br/>  nodeSelector:<br/>    nodeType: privateNode # specify the node constraint which the pod should run on</span></pre><p id="692f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">æœåŠ¡</strong></p><pre class="kg kh ki kj gt nm nk nn no aw np bi"><span id="354e" class="nq lr iq nk b gy nr ns l nt nu">apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: nodejs-service<br/>spec:<br/>  selector:<br/>    app: nodejs-express<br/>  type: LoadBalancer<br/>  ports:<br/>  - protocol: TCP<br/>    port: 8080<br/>    targetPort: 8080</span></pre><p id="5628" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">ä¸€æ—¦ä¿å­˜äº†æ¸…å•æ–‡ä»¶ï¼Œå°±å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ä¸€æ¬¡åˆ›å»ºä¸€ä¸ªæ–‡ä»¶:</p><pre class="kg kh ki kj gt nm nk nn no aw np bi"><span id="7e65" class="nq lr iq nk b gy nr ns l nt nu">kubectl apply -f <strong class="nk ir">&lt;manifest-file-name&gt;.yml</strong></span></pre><p id="fc58" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">è¦æµ‹è¯• pod å’ŒæœåŠ¡æ˜¯å¦éƒ½æ­£å¸¸è¿è¡Œï¼Œæ‚¨å¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤:</p><pre class="kg kh ki kj gt nm nk nn no aw np bi"><span id="2017" class="nq lr iq nk b gy nr ns l nt nu">kubectl get pods<br/>kubectl get services</span></pre><p id="a760" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">ç”±äºæˆ‘ä»¬å°†æœåŠ¡åˆ›å»ºä¸º LoadBalancer ç±»å‹ï¼Œå› æ­¤å°†åœ¨æ‚¨çš„ AWS å¸æˆ·ä¸­åˆ›å»ºä¸€ä¸ªç»å…¸è´Ÿè½½å¹³è¡¡å™¨ï¼Œå®ƒå°†å…·æœ‰ä¸€ä¸ªå¤–éƒ¨æˆ–å…¬å…± IP åœ°å€å’Œä¸€ä¸ª DNS åç§°ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å®ƒåœ¨æŒ‡å®šçš„æœåŠ¡ç«¯å£ä¸Šè®¿é—®æ‚¨çš„åº”ç”¨ç¨‹åºã€‚åœ¨æˆ‘çš„ä¾‹å­ä¸­ï¼ŒAPI è¯·æ±‚å°†è¢«å‘é€åˆ°ä»¥ä¸‹åœ°å€:</p><pre class="kg kh ki kj gt nm nk nn no aw np bi"><span id="6a5a" class="nq lr iq nk b gy nr ns l nt nu">&lt;prefix-characters-for-domain-name&gt;.&lt;aws-region&gt;.elb.amazonaws.com:8080/test</span></pre></div><div class="ab cl oh oi hu oj" role="separator"><span class="ok bw bk ol om on"/><span class="ok bw bk ol om on"/><span class="ok bw bk ol om"/></div><div class="ij ik il im in"><p id="6cac" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">æ­£å¦‚æˆ‘åœ¨å¼€å§‹æåˆ°çš„ï¼Œè¿™ç¯‡æ–‡ç« çš„æ‰€æœ‰æºä»£ç éƒ½å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ã€‚æˆ‘å¸Œæœ›è¿™ç¯‡æ–‡ç« å·²ç»ä¸ºä½ æä¾›äº†è¶³å¤Ÿçš„çŸ¥è¯†ï¼Œå½“ä½ å¯»æ‰¾ä¸€ä¸ªå¼•æ“æ¥æ»¡è¶³ä¸€ä¸ªç‰¹å®šçš„ç”¨ä¾‹æ—¶ï¼Œä¸è¿™é‡Œçš„<a class="ae ln" href="https://github.com/LukeMwila/aws-eks-platform" rel="noopener ugc nofollow" target="_blank">ç›¸æ¯”</a>ã€‚</p><p id="e1d9" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">åƒå¾€å¸¸ä¸€æ ·ï¼Œå¿«ä¹ç¼–ç ğŸ’»ï¼</p></div></div>    
</body>
</html>