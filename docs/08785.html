<html>
<head>
<title>How to add Google Sign In (SSO) with Devise to a Ruby on Rails 7 App</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何将 Google Sign In(SSO)with device 添加到 Ruby on Rails 7 应用程序中</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/how-to-add-google-sign-in-sso-with-devise-to-a-ruby-on-rails-7-app-6d8c5ef7641b?source=collection_archive---------0-----------------------#2022-07-11">https://blog.devgenius.io/how-to-add-google-sign-in-sso-with-devise-to-a-ruby-on-rails-7-app-6d8c5ef7641b?source=collection_archive---------0-----------------------#2022-07-11</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/6a27f766c6867810fa8457368357754b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aqcM8HcRwgYuWEoQ8DVTtg.jpeg"/></div></div></figure><h1 id="784b" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">开始之前</h1><p id="4f11" class="pw-post-body-paragraph kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">Youtube 上<a class="ae lr" href="https://www.youtube.com/c/deanin" rel="noopener ugc nofollow" target="_blank"> Deanin 的所有功劳</a>。这篇文章基于他的教程，并做了一些我自己的调整。关注他的帐户，访问他丰富的现代 Rails 资源！</p><p id="e8bf" class="pw-post-body-paragraph kt ku in kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">本文涵盖了使用 Devise 安装 Google SSO 的最低要求。它并没有涵盖其他好的实践。例如，在运行 install Devise 之后，它会提示您在应用程序布局中包含 flash 消息——我不会讨论这些方面。</p><p id="4969" class="pw-post-body-paragraph kt ku in kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">确保您安装了 Rails 7 和兼容的 Ruby 版本。以下是我在 MacOS Monterey 上运行的版本:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="7729" class="mg jw in mc b gy mh mi l mj mk">$ rails --version &amp;&amp; ruby --version<br/>Rails 7.0.3<br/>ruby 3.1.2p20 (2022-04-12 revision 4491bb740a) [arm64-darwin21]</span></pre><h1 id="7408" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">初始 gem 安装和配置</h1><p id="f81b" class="pw-post-body-paragraph kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">将以下宝石添加到您的<code class="fe ml mm mn mc b">Gemfile</code>中:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="1cce" class="mg jw in mc b gy mh mi l mj mk">gem "dotenv-rails"<br/>gem "devise"<br/>gem "omniauth"<br/>gem "omniauth-google-oauth2"<br/>gem "omniauth-rails_csrf_protection"</span></pre><p id="08be" class="pw-post-body-paragraph kt ku in kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">安装这些宝石:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="32d6" class="mg jw in mc b gy mh mi l mj mk">$ bundle install</span></pre><p id="0496" class="pw-post-body-paragraph kt ku in kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">安装设备:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="25dd" class="mg jw in mc b gy mh mi l mj mk">$ rails g devise:install</span></pre><p id="c943" class="pw-post-body-paragraph kt ku in kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">在<code class="fe ml mm mn mc b">config/initializers/devise.rb</code>中，添加以下配置并传递您的凭证(我们将在后面介绍如何获取这些凭证):</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="5871" class="mg jw in mc b gy mh mi l mj mk">config.omniauth :google_oauth2, ENV[‘GOOGLE_OAUTH_CLIENT_ID’], ENV[‘GOOGLE_OAUTH_CLIENT_SECRET’]</span></pre><h1 id="6774" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">设置设备的用户模型</h1><p id="0b0c" class="pw-post-body-paragraph kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">创建用户模型:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="ea1f" class="mg jw in mc b gy mh mi l mj mk">$ rails g devise user</span></pre><p id="5e56" class="pw-post-body-paragraph kt ku in kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">暂停运行迁移。我们将首先添加一些调整。</p><p id="4005" class="pw-post-body-paragraph kt ku in kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">将<code class="fe ml mm mn mc b">omniauth</code>模块添加到<code class="fe ml mm mn mc b">app/models/user.rb</code>:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="cc01" class="mg jw in mc b gy mh mi l mj mk">class User &lt; ApplicationRecord<br/>  devise :database_authenticatable, :registerable,<br/>  :recoverable, :rememberable, :validatable,<br/>  <strong class="mc io"># for Google OmniAuth<br/>  :omniauthable, omniauth_providers: [:google_oauth2]</strong><br/>end</span></pre><p id="517a" class="pw-post-body-paragraph kt ku in kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">转到<code class="fe ml mm mn mc b">db/migrate/</code>目录中的迁移文件(我的名为<code class="fe ml mm mn mc b">20220709132706_devise_create_users.rb</code>，但你的名字会稍有不同)。向用户数据库添加其他列:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="6496" class="mg jw in mc b gy mh mi l mj mk">class DeviseCreateUsers &lt; ActiveRecord::Migration[7.0]<br/>  def change<br/>    create_table :users do |t|</span><span id="601e" class="mg jw in mc b gy mo mi l mj mk"><strong class="mc io">      ## Custom columns</strong><br/>      <strong class="mc io">t.string :full_name<br/>      t.string :uid<br/>      t.string :avatar_url<br/>      t.string :provider</strong></span><span id="8288" class="mg jw in mc b gy mo mi l mj mk">      ## Database authenticatable<br/>      t.string :email,              null: false, default: ""         <br/>      t.string :encrypted_password, null: false, default: ""</span><span id="fe40" class="mg jw in mc b gy mo mi l mj mk">      ...</span></pre><p id="3b13" class="pw-post-body-paragraph kt ku in kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">迁移数据库:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="1494" class="mg jw in mc b gy mh mi l mj mk">$ rails db:migrate</span></pre><h1 id="e72a" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">设置设备的控制器</h1><p id="4cf4" class="pw-post-body-paragraph kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">为设备用户创建控制器:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="72d9" class="mg jw in mc b gy mh mi l mj mk">$ rails g devise:controllers users</span></pre><p id="d5b8" class="pw-post-body-paragraph kt ku in kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">在<code class="fe ml mm mn mc b">routes.rb</code>的设备配置中指定这些控制器:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="7157" class="mg jw in mc b gy mh mi l mj mk">Rails.application.routes.draw do<br/>  devise_for :users<strong class="mc io">, controllers: {<br/>    omniauth_callbacks: 'users/omniauth_callbacks',<br/>    sessions: 'users/sessions',<br/>    registrations: 'users/registrations'</strong><br/>  }</span><span id="b03e" class="mg jw in mc b gy mo mi l mj mk">  ...</span></pre><h2 id="9b0e" class="mg jw in bd jx mp mq dn kb mr ms dp kf le mt mu kj li mv mw kn lm mx my kr mz bi translated">在设计控制器中设置方法</h2><p id="7ffb" class="pw-post-body-paragraph kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">在<code class="fe ml mm mn mc b">app/controllers/users/registrations_controller.rb</code>文件中:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="963a" class="mg jw in mc b gy mh mi l mj mk">class Users::RegistrationsController &lt; Devise::RegistrationsController</span><span id="d0b9" class="mg jw in mc b gy mo mi l mj mk"><strong class="mc io">  def update_resource(resource, params)<br/>    if resource.provider == 'google_oauth2'<br/>      params.delete('current_password')<br/>      resource.password = params['password']<br/>      resource.update_without_password(params)<br/>    else<br/>      resource.update_with_password(params)<br/>    end<br/>  end</strong></span><span id="ffbe" class="mg jw in mc b gy mo mi l mj mk">end</span></pre><p id="f4de" class="pw-post-body-paragraph kt ku in kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">在<code class="fe ml mm mn mc b">app/controllers/users/sessions_controller.rb</code>文件中:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="8b64" class="mg jw in mc b gy mh mi l mj mk">class Users::SessionsController &lt; Devise::SessionsController<br/><strong class="mc io">  def after_sign_out_path_for(_resource_or_scope)<br/>    new_user_session_path<br/>  end</strong></span><span id="6686" class="mg jw in mc b gy mo mi l mj mk"><strong class="mc io">  def after_sign_in_path_for(resource_or_scope)<br/>    stored_location_for(resource_or_scope) || root_path<br/>  end</strong><br/>end</span></pre><p id="ad70" class="pw-post-body-paragraph kt ku in kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">在<code class="fe ml mm mn mc b">app/controllers/users/omniauth_callbacks_controller.rb</code>文件中:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="9ff4" class="mg jw in mc b gy mh mi l mj mk">class Users::OmniauthCallbacksController &lt; Devise::OmniauthCallbacksController</span><span id="10d6" class="mg jw in mc b gy mo mi l mj mk"><strong class="mc io">  def google_oauth2<br/>    user = User.from_omniauth(auth)</strong></span><span id="4cae" class="mg jw in mc b gy mo mi l mj mk"><strong class="mc io">    if user.present?<br/>      sign_out_all_scopes<br/>      flash[:success] = t 'devise.omniauth_callbacks.success', kind: 'Google'<br/>      sign_in_and_redirect user, event: :authentication<br/>    else<br/>      flash[:alert] =<br/>        t 'devise.omniauth_callbacks.failure', kind: 'Google', reason: "#{auth.info.email} is not authorized."<br/>      redirect_to new_user_session_path<br/>    end<br/>  end</strong></span><span id="b1b8" class="mg jw in mc b gy mo mi l mj mk"><strong class="mc io">  protected</strong></span><span id="7e88" class="mg jw in mc b gy mo mi l mj mk"><strong class="mc io">  def after_omniauth_failure_path_for(_scope)<br/>    new_user_session_path<br/>  end</strong></span><span id="1cea" class="mg jw in mc b gy mo mi l mj mk"><strong class="mc io">  def after_sign_in_path_for(resource_or_scope)<br/>    stored_location_for(resource_or_scope) || root_path<br/>  end</strong></span><span id="be14" class="mg jw in mc b gy mo mi l mj mk"><strong class="mc io">  private</strong></span><span id="abd9" class="mg jw in mc b gy mo mi l mj mk"><strong class="mc io">  def auth<br/>    </strong><a class="ae lr" href="http://twitter.com/auth" rel="noopener ugc nofollow" target="_blank"><strong class="mc io">@</strong></a><strong class="mc io">auth ||= request.env['omniauth.auth']<br/>  end</strong><br/>end</span></pre><p id="a6aa" class="pw-post-body-paragraph kt ku in kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">看到上面文件中调用的<code class="fe ml mm mn mc b">from_omniauth</code>方法了吗？我们将在<code class="fe ml mm mn mc b">app/models/user.rb</code>的用户模型中定义它。该方法获取从身份验证请求中获得的用户数据，并在用户模型中创建新记录(如果不存在的话):</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="7f12" class="mg jw in mc b gy mh mi l mj mk">class User &lt; ApplicationRecord<br/>  devise :database_authenticatable, :registerable,<br/>         :recoverable, :rememberable, :validatable,<br/>         # for Google OmniAuth<br/>         :omniauthable, omniauth_providers: [:google_oauth2]<br/>  <strong class="mc io"><br/>  def self.from_omniauth(auth)<br/>    where(provider: auth.provider, uid: auth.uid).first_or_create do |user|<br/>      user.email = auth.info.email<br/>      user.password = Devise.friendly_token[0, 20]<br/>      user.full_name = auth.info.name # assuming the user model has a name<br/>      user.avatar_url = auth.info.image # assuming the user model has an image<br/>    end<br/>  end</strong><br/>end</span></pre><h1 id="f4b4" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">获取 Google 登录凭据</h1><p id="92bb" class="pw-post-body-paragraph kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">进入<a class="ae lr" href="https://console.cloud.google.com/" rel="noopener ugc nofollow" target="_blank"> Google Cloud Console 网站</a>，新建一个项目，然后选择/打开新建的项目。</p><p id="b3f5" class="pw-post-body-paragraph kt ku in kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">导航到 OAuth 同意屏幕页面。选择<code class="fe ml mm mn mc b">External</code>用户类型。在下一个窗口中，输入您的应用程序的名称、用户支持电子邮件和开发者联系信息。对于我的业余爱好项目，我在两个电子邮件栏都输入了我的个人电子邮件地址。点击至末尾，完成 OAuth 同意屏幕的设置。</p><p id="9ec3" class="pw-post-body-paragraph kt ku in kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">导航到“凭据”页面。点击<code class="fe ml mm mn mc b">+ Create Credentials</code>并选择<code class="fe ml mm mn mc b">OAuth client ID</code>。选择<code class="fe ml mm mn mc b">Web application</code>作为“应用类型”。输入你的应用名称。在“授权重定向 URIs”下，添加以下 URI:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="f1ef" class="mg jw in mc b gy mh mi l mj mk"><a class="ae lr" href="http://localhost:3000/users/auth/google_oauth2/callback" rel="noopener ugc nofollow" target="_blank">http://localhost:3000/users/auth/google_oauth2/callback</a></span></pre><p id="fa59" class="pw-post-body-paragraph kt ku in kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">如果/当您已将应用程序部署到生产环境中时，请返回此页面，将您的应用程序的域添加为另一个具有相同格式的 URI:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="9ee4" class="mg jw in mc b gy mh mi l mj mk"><a class="ae lr" href="http://localhost:3000/users/auth/google_oauth2/callback" rel="noopener ugc nofollow" target="_blank">http://<strong class="mc io">yourwebsite.com</strong>/users/auth/google_oauth2/callback</a></span></pre><p id="d2f5" class="pw-post-body-paragraph kt ku in kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">瞧。您应该会看到一个弹出窗口，显示您的 Google 客户端 ID 和客户端密码。</p><p id="3f6a" class="pw-post-body-paragraph kt ku in kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">在应用程序的根目录下创建一个名为<code class="fe ml mm mn mc b">.env</code>的文件，并将你的谷歌客户端 ID 和密码放入其中:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="2e0d" class="mg jw in mc b gy mh mi l mj mk">GOOGLE_OAUTH_CLIENT_ID=Your client id<br/>GOOGLE_OAUTH_CLIENT_SECRET=Your client secret</span></pre><p id="65d9" class="pw-post-body-paragraph kt ku in kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">将<code class="fe ml mm mn mc b">/.env</code>添加到您的<code class="fe ml mm mn mc b">.gitignore</code>文件中，这样您就不会将这些凭证暴露给坏人。</p><h1 id="5d39" class="jv jw in bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">设置 Google 登录按钮</h1><p id="04c7" class="pw-post-body-paragraph kt ku in kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">创建设备视图:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="afa2" class="mg jw in mc b gy mh mi l mj mk">$ rails g devise:views</span></pre><p id="7833" class="pw-post-body-paragraph kt ku in kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">将 Google 登录按钮图像文件下载到您的<code class="fe ml mm mn mc b">app/assets/images/</code>目录中。我推荐下载<a class="ae lr" href="https://developers.google.com/identity/branding-guidelines" rel="noopener ugc nofollow" target="_blank">谷歌的登录品牌指南页面</a>上提供的文件——我最喜欢的是这个，因为它在亮暗两种模式下都能工作:<code class="fe ml mm mn mc b">/google_signin_buttons/web/1x/btn_google_signin_dark_normal_web.png</code></p><figure class="lx ly lz ma gt jo gh gi paragraph-image"><div class="gh gi na"><img src="../Images/08785f4f76d63c70875bf6b837004a9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:382/format:webp/1*aWwIGuVqXUZ01dok54EKtw.png"/></div></figure><p id="6349" class="pw-post-body-paragraph kt ku in kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">更新<code class="fe ml mm mn mc b">app/views/devise/shared/_links.html.erb</code>中的登录链接，使用 Google OmniAuth 对其进行正确配置，并将其变成一个可点击的按钮:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="6bd2" class="mg jw in mc b gy mh mi l mj mk">...</span><span id="5e25" class="mg jw in mc b gy mo mi l mj mk">&lt;%- if devise_mapping.omniauthable? %&gt;<br/>  &lt;%- resource_class.omniauth_providers.each do |provider| %&gt;<br/><strong class="mc io">    &lt;%= form_for "Login",<br/>      url: omniauth_authorize_path(resource_name, provider),<br/>      method: :post,<br/>      data: {turbo: "false"} do |f| %&gt;<br/>        &lt;%= f.submit "Login", type: "image", src: url_for("/assets/btn_google_signin_dark_normal_web.png") %&gt;<br/>    &lt;% end %&gt;  </strong><br/>  &lt;% end %&gt;<br/>&lt;% end %&gt;</span><span id="e589" class="mg jw in mc b gy mo mi l mj mk">...</span></pre><p id="c4dd" class="pw-post-body-paragraph kt ku in kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated"><em class="nb">更新上面的图像路径(</em> <code class="fe ml mm mn mc b"><em class="nb">/assets/btn_google_signin_dark_normal_web.png</em></code> <em class="nb">)，以匹配您最终选择的按钮图像的路径。</em></p><p id="6ca3" class="pw-post-body-paragraph kt ku in kv b kw ls ky kz la lt lc ld le lu lg lh li lv lk ll lm lw lo lp lq ig bi translated">最后，将下面的代码暂时放在你的主页视图上，或者你想显示这些链接的任何地方，以测试你新添加的 Google 登录/注销功能:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="a1ce" class="mg jw in mc b gy mh mi l mj mk">&lt;% if current_user %&gt;<br/>  &lt;h2&gt;&lt;%= current_user.email %&gt;&lt;/h2&gt;<br/>    &lt;%= image_tag(current_user.avatar_url) %&gt;<br/>    &lt;%= link_to "Edit Account", edit_user_registration_path %&gt;<br/>    &lt;%= button_to "Logout", destroy_user_session_path, data: {turbo: "false"}, method: :delete %&gt;<br/>  &lt;% else %&gt;<br/>    &lt;%= link_to "Login", new_user_session_path %&gt;<br/>  &lt;% end %&gt;</span></pre></div></div>    
</body>
</html>