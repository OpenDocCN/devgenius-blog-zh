<html>
<head>
<title>Deploy Images To DockerHub With CircleCI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 CircleCI 将映像部署到 DockerHub</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/deploy-images-to-dockerhub-with-circleci-3f5b716cfe1e?source=collection_archive---------4-----------------------#2021-04-05">https://blog.devgenius.io/deploy-images-to-dockerhub-with-circleci-3f5b716cfe1e?source=collection_archive---------4-----------------------#2021-04-05</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/c675997a0b576c292e2653d5a03a8b8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z-iALiU8xDV_FI4YAwxmZA.png"/></div></div></figure><p id="e034" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">容器、图像、云、docker、Kubernetes 等。都是我们从 DevOps 工程师和高级后端工程师或云架构师那里听到的常用术语。构建应用或服务器非常好，但更重要的是托管、部署、维护和扩展它们。</p><p id="a225" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><a class="ae kt" href="https://circleci.com/docs/2.0/about-circleci/" rel="noopener ugc nofollow" target="_blank"> CirclCI </a>使工程团队能够自动化您的软件构建、测试和部署。</p><p id="d91d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">Docker 是一个轻量级的操作系统级虚拟化工具，它使我们能够在称为容器的包中交付软件。</p><p id="96e2" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在您的操作系统上本地构建您的容器可能需要一点时间，这取决于您的系统有多复杂，有时可能无法运行 docker。此外，手动构建容器化的应用并将其推送到<a class="ae kt" href="http://hub.docker.com" rel="noopener ugc nofollow" target="_blank"> docker-hub </a>可能会有压力，或者不是最佳实践。<br/>你可以使用 GitHub 和 CircleCi 来自动化这个过程。</p><p id="58c7" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">对于这个项目，我将开发一个简单的 express 服务器，并为它构建一个 docker 映像，然后使用 circleci 将其推送到 docker hub。</p><p id="538b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在您进一步阅读之前，请确保您拥有 github、circleci 和 docker hub 的帐户。</p><h2 id="62ed" class="ku kv in bd kw kx ky dn kz la lb dp lc kg ld le lf kk lg lh li ko lj lk ll lm bi translated">项目设置</h2><p id="984a" class="pw-post-body-paragraph jv jw in jx b jy ln ka kb kc lo ke kf kg lp ki kj kk lq km kn ko lr kq kr ks ig bi translated">打开你的 github 并创建一个公共 repo，姑且称之为*my-first-dockerhub*，你现在可以在你喜欢的编辑器上克隆这个项目了。</p><p id="dcfa" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在根目录下创建以下文件——index . js docker file。dockerignore。gitignore</p><blockquote class="ls lt lu"><p id="bc1e" class="jv jw lv jx b jy jz ka kb kc kd ke kf lw kh ki kj lx kl km kn ly kp kq kr ks ig bi translated">触摸 index.js Dockerfile。dockerignore。gitignore</p></blockquote><p id="9a01" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在 index.js 文件中添加以下代码</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="dc0c" class="ku kv in me b gy mi mj l mk ml"><br/>require(“dotenv”);<br/>const express = require(“express”);</span><span id="2a4f" class="ku kv in me b gy mm mj l mk ml">const app = express();</span><span id="720e" class="ku kv in me b gy mm mj l mk ml">const { log } = console;</span><span id="bbf0" class="ku kv in me b gy mm mj l mk ml">app.get(“/user”, (req, res) =&gt; {<br/> res.send({<br/> result: [<br/> {<br/> name: “armstrong”,<br/> status: “developer”,<br/> },<br/> ],<br/> });<br/>});</span><span id="8349" class="ku kv in me b gy mm mj l mk ml">const port = process.env.PORT || 5000;</span><span id="5ace" class="ku kv in me b gy mm mj l mk ml">app.listen(port, () =&gt; log(`Server running on port ${port} 🔥`));</span></pre><h2 id="a5f9" class="ku kv in bd kw kx ky dn kz la lb dp lc kg ld le lf kk lg lh li ko lj lk ll lm bi translated">Docker 的设置</h2><p id="ce06" class="pw-post-body-paragraph jv jw in jx b jy ln ka kb kc lo ke kf kg lp ki kj kk lq km kn ko lr kq kr ks ig bi translated">让你的应用成为 docker 镜像的魔法实际上是在你刚刚创建的*Dockerfile*里面完成的。</p><p id="d430" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在 docker 文件中添加以下代码:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="280e" class="ku kv in me b gy mi mj l mk ml"><br/>FROM node:14</span><span id="de08" class="ku kv in me b gy mm mj l mk ml">WORKDIR /project</span><span id="53c9" class="ku kv in me b gy mm mj l mk ml">COPY package*.json ./</span><span id="0cab" class="ku kv in me b gy mm mj l mk ml">RUN npm ci</span><span id="a9b2" class="ku kv in me b gy mm mj l mk ml">COPY . .</span><span id="919a" class="ku kv in me b gy mm mj l mk ml">EXPOSE 8081</span><span id="1721" class="ku kv in me b gy mm mj l mk ml">CMD [“node”, “index.js”]</span></pre><p id="989d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">*FROM node:14*谈到我们希望在其上运行应用程序的环境，当然是 node 应用程序，因此我们选择 node 版本 14</p><p id="3c21" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">你可以在官方<a class="ae kt" href="https://nodejs.org/en/docs/guides/nodejs-docker-webapp/" rel="noopener ugc nofollow" target="_blank">文档</a>上阅读更多关于其他声明的含义</p><p id="a254" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这样，我们的应用程序依赖项将通过 RUN 命令安装，并在 docker 容器的 8081 端口上运行</p><h2 id="0ef0" class="ku kv in bd kw kx ky dn kz la lb dp lc kg ld le lf kk lg lh li ko lj lk ll lm bi translated">Circleci 的设置</h2><p id="0a4c" class="pw-post-body-paragraph jv jw in jx b jy ln ka kb kc lo ke kf kg lp ki kj kk lq km kn ko lr kq kr ks ig bi translated">这是这篇文章对我来说最有趣的部分。上一步之后的下一步是构建 docker 映像，使用命令- <br/> <br/> docker build <br/> <br/>现在，我们将使用 circleci 丰富的基础设施，而不是使用本地操作系统。</p><h2 id="4ddf" class="ku kv in bd kw kx ky dn kz la lb dp lc kg ld le lf kk lg lh li ko lj lk ll lm bi translated">将 Git Repo 连接到 Circleci</h2><p id="ccc7" class="pw-post-body-paragraph jv jw in jx b jy ln ka kb kc lo ke kf kg lp ki kj kk lq km kn ko lr kq kr ks ig bi translated">打开你的 circleci 仪表盘，找到你的 github repo，点击*设置项目*按钮，这可能会要求你提供*。circleci*目录，暂时可以忽略。</p><h2 id="1e64" class="ku kv in bd kw kx ky dn kz la lb dp lc kg ld le lf kk lg lh li ko lj lk ll lm bi translated">圆形构型</h2><p id="d0f1" class="pw-post-body-paragraph jv jw in jx b jy ln ka kb kc lo ke kf kg lp ki kj kk lq km kn ko lr kq kr ks ig bi translated">在根目录下创建一个新目录— *。circleci*，在目录中创建一个文件*config.yml*</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="613f" class="ku kv in me b gy mi mj l mk ml"><br/>touch .circleci/config.yml<br/></span></pre><p id="1ed9" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在 config.yml 中，添加以下代码</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="b9ab" class="ku kv in me b gy mi mj l mk ml"><br/>orbs:<br/> docker: circleci/docker@1.5.0<br/>version: 2.1<br/>executors:<br/> docker-publisher: <br/> environment:<br/> IMAGE_NAME: ndukwearm19docker/docker-node-app<br/> docker: # Each job requires specifying an executor<br/> # (either docker, macos, or machine), see<br/> — image: circleci/node:latest<br/> auth:<br/> username: $DOCKERHUB_USERNAME<br/> password: $DOCKERHUB_PASSWORD</span><span id="501d" class="ku kv in me b gy mm mj l mk ml">jobs:<br/> publishLatestToHub: <br/> executor: docker-publisher<br/> <br/> steps: <br/> — checkout<br/> — setup_remote_docker<br/> — run: <br/> name: Publish Docker Image to Docker Hub<br/> command: |<br/> echo “$DOCKERHUB_PASSWORD” | docker login -u “$DOCKERHUB_USERNAME” — password-stdin<br/> docker build -t $IMAGE_NAME .<br/> docker push $IMAGE_NAME:latest<br/>workflows:<br/> version: 2<br/> build-master:<br/> jobs:<br/> — publishLatestToHub<br/><br/>The config.yml is the magic that tells circleci what to do with our app, for this demo we want it to build a docker image.<br/>In circleci *workflows* are simply orchestrators, they order how things should be done, *executors* defines or groups up task, *jobs* define the basic steps and commands to run.</span></pre><p id="6899" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">因此，我有一个名为*build-master*的工作流，它通过运行一个名为*docker-publisher*的执行器开始工作，该执行器设置一个名为 IMAGE_NAME 的环境变量，并运行一个 docker 环境，该环境应该运行最新版本的 node。</p><p id="2b97" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">接下来的几行代码是</p><ul class=""><li id="15ef" class="mn mo in jx b jy jz kc kd kg mp kk mq ko mr ks ms mt mu mv bi translated">checkout —这要求 circleci 查看我们的存储库或考虑我们在回购上拥有的整个目录和文件，</li><li id="8610" class="mn mo in jx b jy mw kc mx kg my kk mz ko na ks ms mt mu mv bi translated">setup_remote_docker —这告诉 docker 在一个隔离的 docker 环境中构建映像，在这里阅读更多<a class="ae kt" href="https://circleci.com/docs/2.0/building-docker-images/" rel="noopener ugc nofollow" target="_blank"/>，</li><li id="e4c8" class="mn mo in jx b jy mw kc mx kg my kk mz ko na ks ms mt mu mv bi translated">run——run 命令就像您的常规 cmd 或 shell，所以在这里键入 docker 命令来构建您的映像并推送到 docker hub。</li></ul><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="2433" class="ku kv in me b gy mi mj l mk ml"><br/> echo “$DOCKERHUB_PASSWORD” | docker login -u “$DOCKERHUB_USERNAME” — password-stdin<br/> docker build -t $IMAGE_NAME .<br/> docker push $IMAGE_NAME:latest</span></pre><p id="6384" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">DOCKERHUB_PASSWORD 和 DOCKERHUB_USERNAME 应该在你的 circleci 仪表板中设置为一个环境变量</p><h2 id="d080" class="ku kv in bd kw kx ky dn kz la lb dp lc kg ld le lf kk lg lh li ko lj lk ll lm bi translated">终于！</h2><p id="a05c" class="pw-post-body-paragraph jv jw in jx b jy ln ka kb kc lo ke kf kg lp ki kj kk lq km kn ko lr kq kr ks ig bi translated">你现在可以提交和推送 github，回到你的 circleci 仪表盘，看你的图片被推送到 docker hub。</p><p id="b012" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">感谢您花时间通读，关注我的更多文章，您可以在<a class="ae kt" href="https://twitter.com/AI_Lift" rel="noopener ugc nofollow" target="_blank"> Twitter </a>上关注我，在<a class="ae kt" href="https://www.linkedin.com/in/ndukwearmstrong/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上邀请我参与您的下一个项目。</p><p id="ced8" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">记得继续编码，阅读，正确的生活。</p><p id="6c51" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><a class="ae kt" href="https://github.com/armstrong99/circleci-docker-CICD-pipeline-NodeJS" rel="noopener ugc nofollow" target="_blank">链接至回购</a></p></div></div>    
</body>
</html>