<html>
<head>
<title>Azure Cosmos DB— RBAC Authentication using a Java Client</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Azure Cosmos DB—使用 Java 客户端的 RBAC 身份验证</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/azure-cosmos-db-rbac-authentication-using-a-java-client-720b20c637fe?source=collection_archive---------7-----------------------#2022-02-03">https://blog.devgenius.io/azure-cosmos-db-rbac-authentication-using-a-java-client-720b20c637fe?source=collection_archive---------7-----------------------#2022-02-03</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="8eb9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这篇博客是我们从零开始讨论<strong class="jm io">云</strong>概念的系列文章的一部分，面向的是入门知识有限的读者。这篇文章属于<em class="ki">中级</em>系列，因为它涉及到理解 Azure Cosmos   <strong class="jm io">的<a class="ae kj" href="https://docs.microsoft.com/en-us/azure/cosmos-db/role-based-access-control" rel="noopener ugc nofollow" target="_blank"> <strong class="jm io"> RBAC 认证的工作原理。</strong></a></strong></p><p id="9743" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">云系列中的一些早期博客如下。</p><p id="bffe" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><a class="ae kj" rel="noopener ugc nofollow" target="_blank" href="/gcp-big-query-writing-my-first-python-connector-1140b022b88a"> <strong class="jm io"> GCP 大查询第一 Python 连接器</strong></a><strong class="jm io"><br/></strong><a class="ae kj" rel="noopener ugc nofollow" target="_blank" href="/automating-your-monthly-azure-cloud-cost-spends-a51257a6564f"><strong class="jm io">Azure 造价自动化</strong></a><strong class="jm io"><br/></strong><a class="ae kj" rel="noopener ugc nofollow" target="_blank" href="/custom-docker-bridge-networks-how-to-run-containers-b8d40c51bab2"><strong class="jm io">自定义 Docker 桥接网络</strong> </a></p><figure class="kl km kn ko gt kp gh gi paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="gh gi kk"><img src="../Images/ffcb8b25bc3ad8faef3b8954b17f0bb3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sHogRc4zTbyptHalnv4KCA.png"/></div></div></figure><h2 id="dfa9" class="kw kx in bd ky kz la dn lb lc ld dp le jv lf lg lh jz li lj lk kd ll lm ln lo bi translated">azure Cosmos DB—概述</h2><p id="ebaa" class="pw-post-body-paragraph jk jl in jm b jn lp jp jq jr lq jt ju jv lr jx jy jz ls kb kc kd lt kf kg kh ig bi translated">Cosmos DB 是一个完全托管的 Azure 本地非 SQL 数据库，它分布在全球各地，以满足最低<strong class="jm io">恢复时间目标(RTO) </strong>和<strong class="jm io">恢复点目标(RPO) </strong>的<a class="ae kj" href="https://docs.automationanywhere.com/bundle/enterprise-v11.3/page/enterprise/topics/control-room/ha-dr/ha-dr-overview.html" rel="noopener ugc nofollow" target="_blank"><strong class="jm io">【HADR】</strong></a>需求。作为一项完全托管的服务，Cosmos 通过内置功能自动满足开发运维/基础架构团队的大量数据管理和运营需求。Cosmos 使用各种认证机制提供了对 SQL、Mongo、Cassandra 和 Gremlin 的 API 支持。</p><p id="c4f6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">Cosmos 中的认证方法有三种不同的类型- <br/> i)使用永久的一级和二级密钥<br/> ii)使用资源令牌<br/> iii)使用基于角色的访问控制(RBAC)。</p><p id="e2d0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">认证方法的详细说明可以在<a class="ae kj" href="https://docs.microsoft.com/en-us/azure/cosmos-db/secure-access-to-data?tabs=using-primary-key" rel="noopener ugc nofollow" target="_blank"> <strong class="jm io">这里</strong> </a>找到。出于这个博客的目的，我们将使用 RBAC 和短期令牌构建一个简单的 java 客户端。在进入代码之前，先看一下 Cosmos API 提供的许可模型。</p><h2 id="642e" class="kw kx in bd ky kz la dn lb lc ld dp le jv lf lg lh jz li lj lk kd ll lm ln lo bi translated">Azure Cosmos DB —权限模型</h2><p id="33d3" class="pw-post-body-paragraph jk jl in jm b jn lp jp jq jr lq jt ju jv lr jx jy jz ls kb kc kd lt kf kg kh ig bi translated"><strong class="jm io">控制平面</strong></p><p id="f9e9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">控制平面权限用于对 Azure Cosmos 帐户执行管理操作，例如创建/替换/删除 DB 帐户/数据库/容器。本机数据平面 SDK 不能用于<a class="ae kj" href="https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview" rel="noopener ugc nofollow" target="_blank"> <strong class="jm io">托管身份</strong> </a>，这些身份已被分配了仅具有控制平面权限的角色。这些可以直接从 Azure 门户分配。</p><p id="c88f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">数据平面</strong></p><p id="7764" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">数据平面权限用于对这些容器中的数据存储执行数据库操作，例如读/写/附加操作。这些权限以<a class="ae kj" href="https://docs.microsoft.com/en-us/azure/cosmos-db/how-to-setup-rbac#role-definitions" rel="noopener ugc nofollow" target="_blank"> <strong class="jm io">内置或自定义角色定义</strong> </a> <strong class="jm io">的形式提供。</strong>这些定义只能通过<em class="ki"> Azure Cli/Power-Shell 或 ARM 模板</em>进行分配。</p><figure class="kl km kn ko gt kp gh gi paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="gh gi lu"><img src="../Images/5da0cb4d7c1ee63eda4fdadb37a5c08f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tOuRm3TSREe9sY99QAM8_g.png"/></div></div><figcaption class="lv lw gj gh gi lx ly bd b be z dk translated"><strong class="bd ky">角色定义和分配示例</strong></figcaption></figure><h2 id="279e" class="kw kx in bd ky kz la dn lb lc ld dp le jv lf lg lh jz li lj lk kd ll lm ln lo bi translated">创建一个简单的 RBAC 身份验证模块。</h2><p id="b628" class="pw-post-body-paragraph jk jl in jm b jn lp jp jq jr lq jt ju jv lr jx jy jz ls kb kc kd lt kf kg kh ig bi translated"><strong class="jm io">设置广告应用</strong></p><ul class=""><li id="8fc4" class="lz ma in jm b jn jo jr js jv mb jz mc kd md kh me mf mg mh bi translated">为了设置广告应用程序，请在 Azure <strong class="jm io"> </strong>门户的搜索栏中进入<strong class="jm io"> Azure Active Directory </strong>。</li><li id="ad7e" class="lz ma in jm b jn mi jr mj jv mk jz ml kd mm kh me mf mg mh bi translated">在左侧选项卡中，点击<strong class="jm io">应用程序注册</strong>并创建一个具有用户友好名称的新应用程序。</li><li id="02e4" class="lz ma in jm b jn mi jr mj jv mk jz ml kd mm kh me mf mg mh bi translated">需要<strong class="jm io"> <em class="ki">租户 ID、应用 ID 和客户端凭证</em> </strong>(仅一次查看)来验证客户端并生成临时令牌。</li></ul><figure class="kl km kn ko gt kp gh gi paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="gh gi mn"><img src="../Images/a2469e19c68d4ec6c2f10fda65903f7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HgfallwdwmYCxTA8IIIbDA.png"/></div></div></figure><h2 id="2168" class="kw kx in bd ky kz la dn lb lc ld dp le jv lf lg lh jz li lj lk kd ll lm ln lo bi translated"><strong class="ak">分配数据平面权限</strong></h2><p id="f8ac" class="pw-post-body-paragraph jk jl in jm b jn lp jp jq jr lq jt ju jv lr jx jy jz ls kb kc kd lt kf kg kh ig bi translated">为了创建和分配角色定义，我们将使用 Azure Cli 来执行 API 操作。可以使用给定的<a class="ae kj" href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli" rel="noopener ugc nofollow" target="_blank">指南</a>中的步骤安装 Cli。</p><p id="0723" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">登录 Azure </strong></p><pre class="kl km kn ko gt mo mp mq mr aw ms bi"><span id="c937" class="kw kx in mp b gy mt mu l mv mw">az login</span></pre><p id="0370" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">创建角色定义</strong></p><pre class="kl km kn ko gt mo mp mq mr aw ms bi"><span id="c347" class="kw kx in mp b gy mt mu l mv mw">az cosmosdb sql role definition create --account-name medium-blog --resource-group medium-blog  --body role.json</span></pre><figure class="kl km kn ko gt kp"><div class="bz fp l di"><div class="mx my l"/></div><figcaption class="lv lw gj gh gi lx ly bd b be z dk translated"><strong class="ak">角色。具有自定义权限的 JSON</strong></figcaption></figure><p id="99b1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">分配角色定义</strong></p><pre class="kl km kn ko gt mo mp mq mr aw ms bi"><span id="bd10" class="kw kx in mp b gy mt mu l mv mw">az cosmosdb sql role assignment create --account-name  medium-blog --resource-group medium-blog  --role-definition-id a64316d1-4aaf-4c74-a5a6-5104f766cfc0</span><span id="a65b" class="kw kx in mp b gy mz mu l mv mw">--scope "/dbs/"  --principal-id 4d9da8da-823b-4dc2-b9d3-fd7603d634df</span></pre><p id="a729" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">为了获得上面创建的应用程序的主体 id，可以使用下面的命令，其中命令结果中的<strong class="jm io"> <em class="ki">主体 id ==对象 id </em> </strong></p><pre class="kl km kn ko gt mo mp mq mr aw ms bi"><span id="7564" class="kw kx in mp b gy mt mu l mv mw">az ad sp list — display-name test-app</span></pre><p id="608e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> Java 认证功能。</strong></p><p id="d4be" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">身份验证功能包括对 Azure Java SDK 的两个主要同步调用，如下所示</p><ul class=""><li id="b340" class="lz ma in jm b jn jo jr js jv mb jz mc kd md kh me mf mg mh bi translated">调用 Azure AD 并获取<strong class="jm io"> TokenCredential </strong>对象。</li><li id="187c" class="lz ma in jm b jn mi jr mj jv mk jz ml kd mm kh me mf mg mh bi translated">在构建<strong class="jm io">CosmosClientBuilderObject</strong>时，重用<strong class="jm io"> TokenCredential </strong>对象以及 Cosmos DB 帐户的其他元数据信息，如<strong class="jm io"> <em class="ki">端点、一致性级别</em> </strong>等。</li></ul><figure class="kl km kn ko gt kp"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="dfd5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">为了获得其他 SDK 依赖项，pom.xml 和其他属性文件可以从 GitHub 位置的<strong class="jm io">附加资源中克隆。</strong></p><p id="662a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">一旦客户端使用来自 Azure AD 的临时令牌成功通过身份验证，就可以使用文档和<strong class="jm io"> V4 SDK 来执行其他数据库操作。</strong>SDK 支持同步和异步操作，具体取决于应用需求和流程。</p><h2 id="fead" class="kw kx in bd ky kz la dn lb lc ld dp le jv lf lg lh jz li lj lk kd ll lm ln lo bi translated">额外资源</h2><div class="na nb gp gr nc nd"><a href="https://github.com/amit894/java-cosmos-client" rel="noopener  ugc nofollow" target="_blank"><div class="ne ab fo"><div class="nf ab ng cl cj nh"><h2 class="bd io gy z fp ni fr fs nj fu fw im bi translated">GitHub-Amit 894/Java-Cosmos-Client:Java Cosmos 客户端</h2><div class="nk l"><h3 class="bd b gy z fp ni fr fs nj fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="nl l"><p class="bd b dl z fp ni fr fs nj fu fw dk translated">github.com</p></div></div><div class="nm l"><div class="nn l no np nq nm nr ku nd"/></div></div></a></div><p id="27aa" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><em class="ki">如需反馈，请留言至</em><strong class="jm io"><em class="ki">Amit[dot]894[at]Gmail[dot]com</em></strong><em class="ki">或联系 https://about.me/amit_raj</em><a class="ae kj" href="https://about.me/amit_raj" rel="noopener ugc nofollow" target="_blank"><em class="ki">的任何一个链接。</em></a></p></div></div>    
</body>
</html>