<html>
<head>
<title>On Clojars persistent XSS and external resources</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">论克罗夫特的持续XSS和外部资源</h1>
<blockquote>原文：<a href="https://blog.devgenius.io/on-clojars-persistent-xss-and-external-resources-74746baabe97?source=collection_archive---------10-----------------------#2020-07-05">https://blog.devgenius.io/on-clojars-persistent-xss-and-external-resources-74746baabe97?source=collection_archive---------10-----------------------#2020-07-05</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="e891" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">永远不要相信任何东西，甚至是你的数据库。或者我如何在Clojure社区的一个最关键的软件上发现一个漏洞。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/7989c8e2d4d1c659446ad64a64b5d0d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KGJzt9ppvox08ed7JbiXuA.jpeg"/></div></div></figure><p id="0f2a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">自从我开始学习网络安全以来，我注意到几乎每一个漏洞都是基于信任作为系统或应用程序实例的一部分的某物或某人。SQL注入、缓冲区溢出和XSS信任用户输入，CSRF基于信任用户的浏览器，我们存储用户凭证的哈希，因为我们不相信我们的数据库总是安全的。</p><blockquote class="ku"><p id="9cdf" class="kv kw in bd kx ky kz la lb lc ld kh dk translated">这个程序，它们不是自己坐，而是和其他程序对话。现在我们有三个或更多这样的东西。而且现在可能不是用同一种编程语言写的，都有自己的世界观。— Rich Hickey谈<a class="ae le" href="https://www.youtube.com/watch?v=2V1FtfBDsLU" rel="noopener ugc nofollow" target="_blank">有效计划Clojure的10年</a>。</p></blockquote><p id="88e3" class="pw-post-body-paragraph jk jl in jm b jn lf jp jq jr lg jt ju jv lh jx jy jz li kb kc kd lj kf kg kh ig bi translated">作为子系统(如数据库)一部分的第三方应用程序等资源是由不同的人构建的，他们有自己的世界观，像每个人一样，<strong class="jm io">他们也会犯错误</strong>。它可能存在漏洞，泄露凭证，甚至遭受某种类型的注入攻击。</p><h1 id="6f6d" class="lk ll in bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">edn是什么？</h1><p id="350b" class="pw-post-body-paragraph jk jl in jm b jn mi jp jq jr mj jt ju jv mk jx jy jz ml kb kc kd mm kf kg kh ig bi translated">与任何类似Lisp的语言一样，Clojure使用了代码是数据的强大概念，反之亦然，这意味着Clojure程序是使用自己的数据结构表示编写的。edn扩展为<a class="ae le" href="https://github.com/edn-format/edn" rel="noopener ugc nofollow" target="_blank"> <strong class="jm io">可扩展数据表示法</strong> </a>，是Clojure的数据表示语法的子集。一些Clojure应用程序甚至用它作为数据传输格式。</p><p id="f08c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">通过Clojure使用edn存储非结构化数据很简单，因为使用Clojure的核心库可以很容易地读取这些数据。它实际上非常安全，因为它没有实际的代码，只有数据。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/f2e14829225adbac2a4e882962f2f94b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1104/format:webp/1*NKOVgIkJ29cZ6xvWjEEOMw.png"/></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">Clojars使用edn来存储配置。</figcaption></figure><h1 id="7dbb" class="lk ll in bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">打嗝</h1><p id="1f5c" class="pw-post-body-paragraph jk jl in jm b jn mi jp jq jr mj jt ju jv mk jx jy jz ml kb kc kd mm kf kg kh ig bi translated"><a class="ae le" href="https://github.com/weavejester/hiccup" rel="noopener ugc nofollow" target="_blank"> Hiccup </a>是Clojure库，能够从Clojure数据结构呈现HTML。正如自己的库所承诺的，可以用向量来表示元素，用映射来表示元素属性。所以在代码上保持布局是非常简单的，事实证明它可以非常快，因为在代码被编译成Java字节码之后，它不需要解析，它现在就是数据了。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ms"><img src="../Images/6bd35ede60a8a4994dabc1d35bc70b35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vKxHX0ahYC4k101K6X-4JQ.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">Clojars源代码中的Hiccup布局</figcaption></figure><h1 id="c57d" class="lk ll in bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">有时候你不需要HTML来XSS</h1><p id="8126" class="pw-post-body-paragraph jk jl in jm b jn mi jp jq jr mj jt ju jv mk jx jy jz ml kb kc kd mm kf kg kh ig bi translated">我注意到从数据库中提取的一些字段被视为数据结构，更确切地说，是包含字段<em class="mt">名称</em>和<em class="mt"> url的地图集合。</em>这个名字是和Hiccup布局一起添加的，所以我马上想到:<strong class="jm io">“如果名字是一些Hiccup数据结构会怎么样？”</strong>。这里的假设非常简单，因为Hiccup将数据结构直接呈现在HTML中，您甚至不需要将HTML直接放在值上，只需要数据。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mu"><img src="../Images/6dd9139093f91ca9075d17199f98a2ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/format:webp/1*Bt6w7OqvgH19xSYQaiwmUQ.png"/></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">名称直接用于链接中。</figcaption></figure><p id="ad2b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">然后，我需要了解如何从数据库中提取数据，如这将最终成为地图的集合。发生的情况是，一些特定字段在从数据库中提取后被解析为edn数据。直接在jar获取函数上，密钥被限制为<em class="mt">许可证</em>和<em class="mt">单片机</em>。我没有注意到<em class="mt"> scm </em>字段的任何代码没有经过任何消毒就被使用。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mv"><img src="../Images/202cffc6b3b8f89eeaa222c9ab1218c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dsBVz5J_KV9jlXCKbpiKeg.png"/></div></div></figure><h2 id="56a4" class="mw ll in bd lm mx my dn lq mz na dp lu jv nb nc ly jz nd ne mc kd nf ng mg nh bi translated">坚持攻击</h2><p id="7e70" class="pw-post-body-paragraph jk jl in jm b jn mi jp jq jr mj jt ju jv mk jx jy jz ml kb kc kd mm kf kg kh ig bi translated">情况很简单，如果攻击者对数据库有足够的访问权限，他可以直接在数据库上将数据添加到jar的license字段中，这样就可以直接呈现数据，而无需进行清理。PoC只是一个简单、直接的SQL查询。出于某种原因，单引号在HTML中被转义了，所以我需要用反引号来代替。在这一点上，我必须感谢<a class="ae le" href="https://heitorgouvea.me" rel="noopener ugc nofollow" target="_blank">海托尔·古维亚</a>，他在几周前发布了一个关于绕过XSS过滤器的挑战，其中一个可能的有效载荷是<code class="fe ni nj nk nl b">prompt`hello world`</code>，这给了一个提示。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nm"><img src="../Images/b21e2732b35ada5005a4222e68a20838.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2RsBo1HCIFfmUpzyM2ba4A.png"/></div></div></figure><h1 id="0682" class="lk ll in bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">瞧</h1><p id="b070" class="pw-post-body-paragraph jk jl in jm b jn mi jp jq jr mj jt ju jv mk jx jy jz ml kb kc kd mm kf kg kh ig bi translated">现在，这会呈现一个包含警报调用的脚本标记，而不是许可证的名称。也可以向<em class="mt"> src </em>字段中注入一些东西来加载远程代码，这样就可以用它来处理牛肉之类的东西。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nn"><img src="../Images/457d45ae007e8dad4134691b876c6ab4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UP0tSxtxosNa4NAZFVX8ww.png"/></div></div></figure><h1 id="8ba3" class="lk ll in bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">结论</h1><p id="c130" class="pw-post-body-paragraph jk jl in jm b jn mi jp jq jr mj jt ju jv mk jx jy jz ml kb kc kd mm kf kg kh ig bi translated">我把漏洞报告给了<em class="mt">contact@clojars.org</em>，也就是<a class="ae le" href="https://clojars.org/security" rel="noopener ugc nofollow" target="_blank">官方漏洞报告渠道</a>。我与项目维护者Tobias Crawley就Clojurians Slack进行了交谈，我想感谢他公开交流这个问题。</p><p id="c471" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">除了数据库之外，我还试图使用其他攻击媒介，比如试图发布一个带有精心制作的pom文件的包，但由于它的实现方式，这不是一个可行的媒介。</p><p id="979a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">注意到这个漏洞不被普通用户利用是非常重要的，因为你必须直接访问数据库才能达到这个目的。</p><h1 id="0015" class="lk ll in bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">时间表</h1><ul class=""><li id="490b" class="no np in jm b jn mi jr mj jv nq jz nr kd ns kh nt nu nv nw bi translated">6月28日:克隆了回购协议，以便探索它并看看它是如何工作的，当天就发现了漏洞；</li><li id="400b" class="no np in jm b jn nx jr ny jv nz jz oa kd ob kh nt nu nv nw bi translated">6月29日:报告了该漏洞，并在Slack上与Tobias Crawley讨论了该漏洞，他在当天立即回答并承认了该问题；</li><li id="ff8c" class="no np in jm b jn nx jr ny jv nz jz oa kd ob kh nt nu nv nw bi translated">7月4日:托拜厄斯修复了这个问题，并提出了一个解决方案，作为对<a class="ae le" href="https://github.com/clojars/clojars-web/pull/763" rel="noopener ugc nofollow" target="_blank">https://github.com/clojars/clojars-web/pull/763</a>的拉动式请求，我审阅了这个问题，我们讨论了这个解决方案；</li><li id="5e5c" class="no np in jm b jn nx jr ny jv nz jz oa kd ob kh nt nu nv nw bi translated">7月5日:补丁已部署，我已被添加到安全感谢列表中。</li></ul><p id="48b6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><em class="mt">我也请托拜厄斯审阅了这篇文章，以确保他对我在这里所说的内容感到满意。</em></p></div></div>    
</body>
</html>